<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>399</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    399
                    <a href="398.html">prev</a>
                    <a href="400.html">next</a>
                    <a href="399_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_b63656500d9b073f921794c2cc40b27527832032_rdb/rdb-sink/src/main/java/com/dtstack/flink/sql/sink/rdb/format/RetractJDBCOutputFormat.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b63656500d9b073f921794c2cc40b27527832032:rdb/rdb-sink/src/main/java/com/dtstack/flink/sql/sink/rdb/format/RetractJDBCOutputFormat.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b63656500d9b073f921794c2cc40b27527832032^1:rdb/rdb-sink/src/main/java/com/dtstack/flink/sql/sink/rdb/format/RetractJDBCOutputFormat.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b63656500d9b073f921794c2cc40b27527832032^2:rdb/rdb-sink/src/main/java/com/dtstack/flink/sql/sink/rdb/format/RetractJDBCOutputFormat.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;260ddcdf26b6c427016a191901ba6a9a4541a426:rdb/rdb-sink/src/main/java/com/dtstack/flink/sql/sink/rdb/format/RetractJDBCOutputFormat.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   2 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.sink.rdb.format;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.sink.rdb.RdbSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.dtstack.flink.sql.util.JDBCUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import java.sql.Connection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import java.sql.DriverManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import java.sql.PreparedStatement;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import java.sql.SQLException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import java.util.concurrent.ScheduledThreadPoolExecutor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import java.util.concurrent.TimeUnit;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import com.dtstack.flink.sql.outputformat.DtRichOutputFormat;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48  * OutputFormat to write tuples into a database.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49  * The OutputFormat has to be configured using the supplied OutputFormatBuilder.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 public class RetractJDBCOutputFormat extends DtRichOutputFormat {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53     private static final long serialVersionUID = 1L;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55     private static final Logger LOG = LoggerFactory.getLogger(RetractJDBCOutputFormat.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57     private String username;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58     private String password;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59     private String drivername;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60     private String dbURL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     private String tableName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62     private String dbType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63     private String schema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64     private RdbSink dbSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65     // trigger preparedStatement execute batch interval</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66     private long batchWaitInterval = 10000l;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67     // PreparedStatement execute batch num</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68     private int batchNum = 100;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69     private String insertQuery;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70     public int[] typesArray;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72     /** 存储用于批量写入的数据 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73     protected List&lt;Row&gt; rows = new ArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75     private Connection dbConn;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76     private PreparedStatement upload;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77     private transient ScheduledThreadPoolExecutor timerService;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80     //index field</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81     private Map&lt;String, List&lt;String&gt;&gt; realIndexes = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82     //full field</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83     private List&lt;String&gt; fullField = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85     public RetractJDBCOutputFormat() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89     public void configure(Configuration parameters) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93      * Connects to the target database and initializes the prepared statement.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95      * @param taskNumber The number of the parallel instance.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96      * @throws IOException Thrown, if the output could not be opened due to an</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97      *                     I/O problem.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100     public void open(int taskNumber, int numTasks) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102             LOG.info(&quot;PreparedStatement execute batch num is {}&quot;, batchNum);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103             dbConn = establishConnection();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104             initMetric();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106             if (existTabname()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107                 if (isReplaceInsertQuery()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 108                     insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getFieldNames()), realIndexes, fullField);"> 108                     insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getField🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110                 upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112                 throw new SQLException(&quot;Table &quot; + tableName + &quot; doesn&#x27;t exist&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115             if (batchWaitInterval &gt; 0 &amp;&amp; batchNum &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116                 LOG.info(&quot;open batch wait interval scheduled, interval is {} ms&quot;, batchWaitInterval);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118                 timerService = new ScheduledThreadPoolExecutor(1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119                 timerService.scheduleAtFixedRate(() -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120                     submitExecuteBatch();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121                 }, 0, batchWaitInterval, TimeUnit.MILLISECONDS);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         } catch (SQLException sqe) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126             LOG.error(&quot;&quot;, sqe);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127             throw new IllegalArgumentException(&quot;open() failed.&quot;, sqe);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         } catch (ClassNotFoundException cnfe) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129             LOG.error(&quot;&quot;, cnfe);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130             throw new IllegalArgumentException(&quot;JDBC driver class not found.&quot;, cnfe);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135     public Connection establishConnection() throws SQLException, ClassNotFoundException, IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         Connection connection ;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         JDBCUtils.forName(drivername, getClass().getClassLoader());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         if (username == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139             connection = DriverManager.getConnection(dbURL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141             connection = DriverManager.getConnection(dbURL, username, password);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         connection.setAutoCommit(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         return connection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148      * Adds a record to the prepared statement.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149      * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150      * When this method is called, the output format is guaranteed to be opened.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152      * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 153      * WARNING: this may fail when no column types specified (because a best effort approach is attempted in order to"> 153      * WARNING: this may fail when no column types specified (because a best effort approach is attempted🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 154      * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObject(pos, null))"> 154      * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObje🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156      * @param tuple2 The records to add to the output.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157      * @throws IOException Thrown, if the records could not be added due to an I/O problem.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158      * @see PreparedStatement</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161     public void writeRecord(Tuple2 tuple2)  {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163         Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164         Boolean retract = tupleTrans.getField(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         Row row = tupleTrans.getField(1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         if (typesArray != null &amp;&amp; typesArray.length &gt; 0 &amp;&amp; typesArray.length != row.getArity()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 168             LOG.warn(&quot;Column SQL types array doesn&#x27;t match arity of passed Row! Check the passed array...&quot;);"> 168             LOG.warn(&quot;Column SQL types array doesn&#x27;t match arity of passed Row! Check the passed array...🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         if (retract) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                 LOG.info(&quot;Receive data : {}&quot;, row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             outRecords.inc();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             insertWrite(row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             //do nothing</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185     private void insertWrite(Row row) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186         checkConnectionOpen(dbConn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188             if (batchNum == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                 writeSingleRecord(row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                 updatePreparedStmt(row, upload);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                 rows.add(row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 upload.addBatch();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                 if (rows.size() &gt;= batchNum) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195                     submitExecuteBatch();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200                 outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 201                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 201                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.get🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202                 LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                 outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212     private void writeSingleRecord(Row row) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214             updatePreparedStmt(row, upload);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215             upload.executeUpdate();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216             dbConn.commit();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 220                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 220                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.get🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221                 LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224             outDirtyRecords.inc();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228     private void updatePreparedStmt(Row row, PreparedStatement pstmt) throws SQLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229         if (typesArray == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230             // no types provided</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231             for (int index = 0; index &lt; row.getArity(); index++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 232                 LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;, index + 1, row.getField(index));"> 232                 LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233                 pstmt.setObject(index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236             // types provided</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237             for (int index = 0; index &lt; row.getArity(); index++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239                 if (row.getField(index) == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240                     pstmt.setNull(index + 1, typesArray[index]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 242                     // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc/getstart/mapping.html"> 242                     // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243                     switch (typesArray[index]) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244                         case java.sql.Types.NULL:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245                             pstmt.setNull(index + 1, typesArray[index]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247                         case java.sql.Types.BOOLEAN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248                         case java.sql.Types.BIT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249                             pstmt.setBoolean(index + 1, (boolean) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251                         case java.sql.Types.CHAR:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252                         case java.sql.Types.NCHAR:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253                         case java.sql.Types.VARCHAR:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254                         case java.sql.Types.LONGVARCHAR:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255                         case java.sql.Types.LONGNVARCHAR:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256                             pstmt.setString(index + 1, (String) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258                         case java.sql.Types.TINYINT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259                             pstmt.setByte(index + 1, (byte) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261                         case java.sql.Types.SMALLINT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262                             pstmt.setShort(index + 1, (short) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264                         case java.sql.Types.INTEGER:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265                             pstmt.setInt(index + 1, (int) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267                         case java.sql.Types.BIGINT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268                             pstmt.setLong(index + 1, (long) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270                         case java.sql.Types.REAL:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271                         case java.sql.Types.FLOAT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272                             pstmt.setFloat(index + 1, (float) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274                         case java.sql.Types.DOUBLE:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275                             pstmt.setDouble(index + 1, (double) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277                         case java.sql.Types.DECIMAL:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278                         case java.sql.Types.NUMERIC:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279                             pstmt.setBigDecimal(index + 1, (java.math.BigDecimal) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281                         case java.sql.Types.DATE:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282                             pstmt.setDate(index + 1, (java.sql.Date) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284                         case java.sql.Types.TIME:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285                             pstmt.setTime(index + 1, (java.sql.Time) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287                         case java.sql.Types.TIMESTAMP:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288                             pstmt.setTimestamp(index + 1, (java.sql.Timestamp) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290                         case java.sql.Types.BINARY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291                         case java.sql.Types.VARBINARY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292                         case java.sql.Types.LONGVARBINARY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293                             pstmt.setBytes(index + 1, (byte[]) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295                         default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296                             pstmt.setObject(index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 297                             LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set its value: %s.&quot;,"> 297                             LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298                                     typesArray[index], index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299                             // case java.sql.Types.SQLXML</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300                             // case java.sql.Types.ARRAY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301                             // case java.sql.Types.JAVA_OBJECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302                             // case java.sql.Types.BLOB:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303                             // case java.sql.Types.CLOB:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304                             // case java.sql.Types.NCLOB:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305                             // case java.sql.Types.DATALINK:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306                             // case java.sql.Types.DISTINCT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307                             // case java.sql.Types.OTHER:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308                             // case java.sql.Types.REF:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309                             // case java.sql.Types.ROWID:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310                             // case java.sql.Types.STRUC</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318     private synchronized void submitExecuteBatch() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320             this.upload.executeBatch();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321             dbConn.commit();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324                 dbConn.rollback();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325             } catch (SQLException e1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326                 LOG.error(&quot;rollback  data error !&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329             rows.forEach(this::writeSingleRecord);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330         } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331             rows.clear();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335     private void checkConnectionOpen(Connection dbConn) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337             if (dbConn.isClosed()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338                 LOG.info(&quot;db connection reconnect..&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339                 dbConn= establishConnection();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340                 upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341                 this.dbConn = dbConn;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344             LOG.error(&quot;check connection open failed..&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345         } catch (ClassNotFoundException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346             LOG.error(&quot;load jdbc class error when reconnect db..&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347         } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348             LOG.error(&quot;kerberos authentication failed..&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353      * Executes prepared statement and closes all resources of this instance.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355      * @throws IOException Thrown, if the input could not be closed properly.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358     public void close() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360             if (upload != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361                 upload.executeBatch();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362                 upload.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364             if (null != timerService) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365                 timerService.shutdown();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366                 LOG.info(&quot;batch wait interval scheduled service  closed &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368         } catch (SQLException se) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369             LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370         } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371             upload = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372             rows.clear();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376             if (dbConn != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377                 dbConn.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379         } catch (SQLException se) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380             LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381         } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382             dbConn = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387     public boolean isReplaceInsertQuery() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388         return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391     public void verifyField() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392         if (StringUtils.isBlank(username)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393             LOG.warn(&quot;Username was not supplied separately.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395         if (StringUtils.isBlank(password)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396             LOG.warn(&quot;Username was not supplied separately.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398         if (StringUtils.isBlank(dbURL)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399             throw new IllegalArgumentException(&quot;No dababase URL supplied.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401         if (StringUtils.isBlank(insertQuery)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402             throw new IllegalArgumentException(&quot;No insertQuery supplied&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404         if (StringUtils.isBlank(drivername)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405             throw new IllegalArgumentException(&quot;No driver supplied&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410     public void setUsername(String username) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411         this.username = username;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414     public String getSchema() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415         if (StringUtils.isNotEmpty(schema)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416             return schema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421     public void setSchema(String schema) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422         this.schema = schema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425     public boolean existTabname() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426         return dbConn.getMetaData().getTables(null, getSchema(), tableName, null).next();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429     public void setPassword(String password) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430         this.password = password;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433     public void setDrivername(String drivername) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434         this.drivername = drivername;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437     public String getDrivername() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438         return this.drivername;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441     public void setDbURL(String dbURL) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442         this.dbURL = dbURL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445     public void setTableName(String tableName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446         this.tableName = tableName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449     public void setDbType(String dbType) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450         this.dbType = dbType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453     public void setDbSink(RdbSink dbSink) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454         this.dbSink = dbSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457     public void setBatchNum(int batchNum) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458         this.batchNum = batchNum;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461     public void setInsertQuery(String insertQuery) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462         this.insertQuery = insertQuery;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465     public void setTypesArray(int[] typesArray) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466         this.typesArray = typesArray;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469     public String getDbType() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470         return dbType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473     public RdbSink getDbSink() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474         return dbSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477     public Connection getDbConn() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478         return dbConn;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481     public String getTableName() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482         return tableName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485     public void realIndexesAdd(String index, List&lt;String&gt; fieldes) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486         this.realIndexes.put(index, fieldes);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489     public Map&lt;String,List&lt;String&gt;&gt; getRealIndexes() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490         return realIndexes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494     public void setBatchWaitInterval(long batchWaitInterval) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495         this.batchWaitInterval = batchWaitInterval;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498     public List&lt;String&gt; getFullField() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499         return fullField;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502     public void fullFieldAdd(String colName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503         this.fullField.add(colName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505 }</span>
 506 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525 package com.dtstack.flink.sql.sink.rdb.format;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527 import com.dtstack.flink.sql.enums.EConnectionErrorCode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528 import com.dtstack.flink.sql.sink.rdb.RdbSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529 import com.dtstack.flink.sql.util.JDBCUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539 import java.sql.Connection;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540 import java.sql.DriverManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541 import java.sql.PreparedStatement;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542 import java.sql.SQLException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547 import java.util.concurrent.ScheduledThreadPoolExecutor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548 import java.util.concurrent.TimeUnit;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550 import com.dtstack.flink.sql.outputformat.DtRichOutputFormat;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553  * OutputFormat to write tuples into a database.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554  * The OutputFormat has to be configured using the supplied OutputFormatBuilder.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557 public class RetractJDBCOutputFormat extends DtRichOutputFormat {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558     private static final long serialVersionUID = 1L;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560     private static final Logger LOG = LoggerFactory.getLogger(RetractJDBCOutputFormat.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561     private static final int CONNECTION_CHECK_FREQUENCY = 100;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562     private int checkTimes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563     private String username;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564     private String password;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565     private String drivername;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566     private String dbURL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567     private String tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568     private String dbType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569     private String schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570     private RdbSink dbSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571     // trigger preparedStatement execute batch interval</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572     private long batchWaitInterval = 10000l;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573     // PreparedStatement execute batch num</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574     private int batchNum = 100;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575     private String insertQuery;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576     public int[] typesArray;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578     /** 存储用于批量写入的数据 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579     protected List&lt;Row&gt; rows = new ArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581     private Connection dbConn;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582     private PreparedStatement upload;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583     private transient ScheduledThreadPoolExecutor timerService;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586     //index field</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587     private Map&lt;String, List&lt;String&gt;&gt; realIndexes = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588     //full field</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589     private List&lt;String&gt; fullField = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591     public RetractJDBCOutputFormat() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595     public void configure(Configuration parameters) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599      * Connects to the target database and initializes the prepared statement.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601      * @param taskNumber The number of the parallel instance.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602      * @throws IOException Thrown, if the output could not be opened due to an</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603      *                     I/O problem.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606     public void open(int taskNumber, int numTasks) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608             LOG.info(&quot;PreparedStatement execute batch num is {}&quot;, batchNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609             dbConn = establishConnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610             initMetric();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612             if (existTabname()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613                 if (isReplaceInsertQuery()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 614                     insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getFieldNames()), realIndexes, fullField);"> 614                     insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getField🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616                 upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618                 throw new SQLException(&quot;Table &quot; + tableName + &quot; doesn&#x27;t exist&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621             if (batchWaitInterval &gt; 0 &amp;&amp; batchNum &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622                 LOG.info(&quot;open batch wait interval scheduled, interval is {} ms&quot;, batchWaitInterval);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624                 timerService = new ScheduledThreadPoolExecutor(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625                 timerService.scheduleAtFixedRate(() -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626                     submitExecuteBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627                 }, 0, batchWaitInterval, TimeUnit.MILLISECONDS);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631         } catch (SQLException sqe) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632             LOG.error(&quot;&quot;, sqe);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633             throw new IllegalArgumentException(&quot;open() failed.&quot;, sqe);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634         } catch (ClassNotFoundException cnfe) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635             LOG.error(&quot;&quot;, cnfe);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636             throw new IllegalArgumentException(&quot;JDBC driver class not found.&quot;, cnfe);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641     public Connection establishConnection() throws SQLException, ClassNotFoundException, IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642         Connection connection ;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643         JDBCUtils.forName(drivername, getClass().getClassLoader());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644         if (username == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645             connection = DriverManager.getConnection(dbURL);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647             connection = DriverManager.getConnection(dbURL, username, password);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649         connection.setAutoCommit(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650         return connection;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654      * Adds a record to the prepared statement.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655      * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656      * When this method is called, the output format is guaranteed to be opened.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658      * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 659      * WARNING: this may fail when no column types specified (because a best effort approach is attempted in order to"> 659      * WARNING: this may fail when no column types specified (because a best effort approach is attempted🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 660      * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObject(pos, null))"> 660      * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObje🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662      * @param tuple2 The records to add to the output.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663      * @throws IOException Thrown, if the records could not be added due to an I/O problem.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664      * @see PreparedStatement</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667     public void writeRecord(Tuple2 tuple2)  {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669         Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670         Boolean retract = tupleTrans.getField(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671         Row row = tupleTrans.getField(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673         if (typesArray != null &amp;&amp; typesArray.length &gt; 0 &amp;&amp; typesArray.length != row.getArity()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 674             LOG.warn(&quot;Column SQL types array doesn&#x27;t match arity of passed Row! Check the passed array...&quot;);"> 674             LOG.warn(&quot;Column SQL types array doesn&#x27;t match arity of passed Row! Check the passed array...🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677         if (retract) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680                 LOG.info(&quot;Receive data : {}&quot;, row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683             outRecords.inc();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684             insertWrite(row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686             //do nothing</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691     private void insertWrite(Row row)  {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693             if (batchNum == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694                 writeSingleRecord(row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696                 updatePreparedStmt(row, upload);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697                 rows.add(row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698                 upload.addBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699                 if (rows.size() &gt;= batchNum) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700                     submitExecuteBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705                 outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 706                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 706                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.get🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707                 LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709                 outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715     private void writeSingleRecord(Row row) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717             updatePreparedStmt(row, upload);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718             upload.executeUpdate();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719             dbConn.commit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721             dealSQLException(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 723                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 723                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.get🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724                 LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727             outDirtyRecords.inc();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731     private void updatePreparedStmt(Row row, PreparedStatement pstmt) throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732         if (typesArray == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733             // no types provided</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734             for (int index = 0; index &lt; row.getArity(); index++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 735                 LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;, index + 1, row.getField(index));"> 735                 LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736                 pstmt.setObject(index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 738         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 739             // types provided</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 740             for (int index = 0; index &lt; row.getArity(); index++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 741 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 742                 if (row.getField(index) == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 743                     pstmt.setNull(index + 1, typesArray[index]);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 744                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 745                     // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc/getstart/mapping.html"> 745                     // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 746                     switch (typesArray[index]) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 747                         case java.sql.Types.NULL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 748                             pstmt.setNull(index + 1, typesArray[index]);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 749                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 750                         case java.sql.Types.BOOLEAN:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 751                         case java.sql.Types.BIT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 752                             pstmt.setBoolean(index + 1, (boolean) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 753                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 754                         case java.sql.Types.CHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 755                         case java.sql.Types.NCHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 756                         case java.sql.Types.VARCHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 757                         case java.sql.Types.LONGVARCHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 758                         case java.sql.Types.LONGNVARCHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 759                             pstmt.setString(index + 1, (String) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 760                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 761                         case java.sql.Types.TINYINT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 762                             pstmt.setByte(index + 1, (byte) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 763                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 764                         case java.sql.Types.SMALLINT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 765                             pstmt.setShort(index + 1, (short) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 766                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 767                         case java.sql.Types.INTEGER:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 768                             pstmt.setInt(index + 1, (int) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 769                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 770                         case java.sql.Types.BIGINT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 771                             pstmt.setLong(index + 1, (long) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 772                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 773                         case java.sql.Types.REAL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 774                         case java.sql.Types.FLOAT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 775                             pstmt.setFloat(index + 1, (float) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 776                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 777                         case java.sql.Types.DOUBLE:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 778                             pstmt.setDouble(index + 1, (double) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 779                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 780                         case java.sql.Types.DECIMAL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 781                         case java.sql.Types.NUMERIC:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 782                             pstmt.setBigDecimal(index + 1, (java.math.BigDecimal) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 783                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 784                         case java.sql.Types.DATE:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 785                             pstmt.setDate(index + 1, (java.sql.Date) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 786                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 787                         case java.sql.Types.TIME:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 788                             pstmt.setTime(index + 1, (java.sql.Time) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 789                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 790                         case java.sql.Types.TIMESTAMP:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 791                             pstmt.setTimestamp(index + 1, (java.sql.Timestamp) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 792                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 793                         case java.sql.Types.BINARY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 794                         case java.sql.Types.VARBINARY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 795                         case java.sql.Types.LONGVARBINARY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 796                             pstmt.setBytes(index + 1, (byte[]) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 797                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 798                         default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 799                             pstmt.setObject(index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 800                             LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set its value: %s.&quot;,"> 800                             LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 801                                     typesArray[index], index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 802                             // case java.sql.Types.SQLXML</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 803                             // case java.sql.Types.ARRAY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 804                             // case java.sql.Types.JAVA_OBJECT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 805                             // case java.sql.Types.BLOB:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 806                             // case java.sql.Types.CLOB:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 807                             // case java.sql.Types.NCLOB:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 808                             // case java.sql.Types.DATALINK:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 809                             // case java.sql.Types.DISTINCT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 810                             // case java.sql.Types.OTHER:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 811                             // case java.sql.Types.REF:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 812                             // case java.sql.Types.ROWID:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 813                             // case java.sql.Types.STRUC</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 814                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 815                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 816             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 817         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 818     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 819 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 820 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 821     private synchronized void submitExecuteBatch() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 822         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 823             regularlyCheckConnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 824             this.upload.executeBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 825             dbConn.commit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 826         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 827             LOG.warn(&quot;submitExecuteBatch error {}&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 828             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 829                 dbConn.rollback();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 830             } catch (SQLException e1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 831                 dealSQLException(e1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 832             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 833             rows.forEach(this::writeSingleRecord);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 834         } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 835             rows.clear();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 836         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 837     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 838 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 839     private void dealSQLException(Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 840         EConnectionErrorCode errorCode = EConnectionErrorCode.resolveErrorCodeFromException(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 841         switch (errorCode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 842             case CONN_DB_INVALID:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 843                 reconnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 844                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 845             case CONN_DB_FAILED:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 846             case DB_TABLE_NOT_EXIST:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 847                 throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 848             default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 849         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 850     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 851 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 852 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 853     private void regularlyCheckConnection() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 854         checkTimes++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 855         if (checkTimes % CONNECTION_CHECK_FREQUENCY != 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 856             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 857         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 858         LOG.warn(&quot;db connection Valid check !&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 859         if (dbConn.isClosed() || !dbConn.isValid(100)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 860             reconnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 861         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 862         checkTimes = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 863     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 864 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 865     public void reconnection() throws RuntimeException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 866         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 867             LOG.info(&quot;db connection reconnect..&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 868             dbConn = establishConnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 869             upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 870             this.dbConn = dbConn;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 871         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 872             throw new RuntimeException(&quot;connection open failed..&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 873         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 874     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 875 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 876     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 877      * Executes prepared statement and closes all resources of this instance.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 878      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 879      * @throws IOException Thrown, if the input could not be closed properly.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 880      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 881     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 882     public void close() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 883         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 884             if (upload != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 885                 upload.executeBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 886                 upload.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 887             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 888             if (null != timerService) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 889                 timerService.shutdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 890                 LOG.info(&quot;batch wait interval scheduled service  closed &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 891             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 892         } catch (SQLException se) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 893             LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 894         } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 895             upload = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 896             rows.clear();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 897         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 898 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 899         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 900             if (dbConn != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 901                 dbConn.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 902             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 903         } catch (SQLException se) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 904             LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 905         } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 906             dbConn = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 907         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 908     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 909 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 910 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 911     public boolean isReplaceInsertQuery() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 912         return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 913     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 914 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 915     public void verifyField() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 916         if (StringUtils.isBlank(username)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 917             LOG.warn(&quot;Username was not supplied separately.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 918         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 919         if (StringUtils.isBlank(password)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 920             LOG.warn(&quot;Username was not supplied separately.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 921         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 922         if (StringUtils.isBlank(dbURL)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 923             throw new IllegalArgumentException(&quot;No dababase URL supplied.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 924         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 925         if (StringUtils.isBlank(insertQuery)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 926             throw new IllegalArgumentException(&quot;No insertQuery supplied&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 927         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 928         if (StringUtils.isBlank(drivername)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 929             throw new IllegalArgumentException(&quot;No driver supplied&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 930         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 931     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 932 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 933 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 934     public void setUsername(String username) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 935         this.username = username;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 936     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 937 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 938     public String getSchema() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 939         if (StringUtils.isNotEmpty(schema)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 940             return schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 941         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 942         return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 943     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 944 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 945     public void setSchema(String schema) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 946         this.schema = schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 947     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 948 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 949     public boolean existTabname() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 950         return dbConn.getMetaData().getTables(null, getSchema(), tableName, null).next();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 951     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 952 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 953     public void setPassword(String password) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 954         this.password = password;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 955     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 956 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 957     public void setDrivername(String drivername) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 958         this.drivername = drivername;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 959     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 960 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 961     public String getDrivername() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 962         return this.drivername;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 963     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 964 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 965     public void setDbURL(String dbURL) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 966         this.dbURL = dbURL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 967     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 968 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 969     public void setTableName(String tableName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 970         this.tableName = tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 971     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 972 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 973     public void setDbType(String dbType) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 974         this.dbType = dbType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 975     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 976 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 977     public void setDbSink(RdbSink dbSink) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 978         this.dbSink = dbSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 979     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 980 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 981     public void setBatchNum(int batchNum) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 982         this.batchNum = batchNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 983     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 984 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 985     public void setInsertQuery(String insertQuery) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 986         this.insertQuery = insertQuery;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 987     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 988 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 989     public void setTypesArray(int[] typesArray) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 990         this.typesArray = typesArray;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 991     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 992 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 993     public String getDbType() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 994         return dbType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 995     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 996 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 997     public RdbSink getDbSink() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 998         return dbSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 999     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1000 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1001     public Connection getDbConn() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1002         return dbConn;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1003     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1004 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1005     public String getTableName() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1006         return tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1007     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1008 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1009     public void realIndexesAdd(String index, List&lt;String&gt; fieldes) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1010         this.realIndexes.put(index, fieldes);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1011     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1012 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1013     public Map&lt;String,List&lt;String&gt;&gt; getRealIndexes() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1014         return realIndexes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1015     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1016 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1017 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1018     public void setBatchWaitInterval(long batchWaitInterval) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1019         this.batchWaitInterval = batchWaitInterval;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1020     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1021 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1022     public List&lt;String&gt; getFullField() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1023         return fullField;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1024     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1025 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1026     public void fullFieldAdd(String colName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1027         this.fullField.add(colName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1028     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1029 }</span>
1030 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.sink.rdb.format;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.sink.rdb.RdbSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.dtstack.flink.sql.util.JDBCUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import java.sql.Connection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import java.sql.DriverManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import java.sql.PreparedStatement;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import java.sql.SQLException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import java.util.concurrent.ScheduledThreadPoolExecutor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import java.util.concurrent.TimeUnit;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import com.dtstack.flink.sql.outputformat.DtRichOutputFormat;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48  * OutputFormat to write tuples into a database.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49  * The OutputFormat has to be configured using the supplied OutputFormatBuilder.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 public class RetractJDBCOutputFormat extends DtRichOutputFormat {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53     private static final long serialVersionUID = 1L;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55     private static final Logger LOG = LoggerFactory.getLogger(RetractJDBCOutputFormat.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57     private String username;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58     private String password;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59     private String drivername;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60     private String dbURL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     private String tableName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62     private String dbType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63     private String schema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64     private RdbSink dbSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65     // trigger preparedStatement execute batch interval</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66     private long batchWaitInterval = 10000l;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67     // PreparedStatement execute batch num</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68     private int batchNum = 100;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69     private String insertQuery;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70     public int[] typesArray;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72     /** 存储用于批量写入的数据 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73     protected List&lt;Row&gt; rows = new ArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75     private Connection dbConn;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76     private PreparedStatement upload;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77     private transient ScheduledThreadPoolExecutor timerService;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80     //index field</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81     private Map&lt;String, List&lt;String&gt;&gt; realIndexes = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82     //full field</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83     private List&lt;String&gt; fullField = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85     public RetractJDBCOutputFormat() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89     public void configure(Configuration parameters) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93      * Connects to the target database and initializes the prepared statement.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95      * @param taskNumber The number of the parallel instance.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96      * @throws IOException Thrown, if the output could not be opened due to an</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97      *                     I/O problem.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100     public void open(int taskNumber, int numTasks) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102             LOG.info(&quot;PreparedStatement execute batch num is {}&quot;, batchNum);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103             dbConn = establishConnection();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104             initMetric();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106             if (existTabname()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107                 if (isReplaceInsertQuery()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 108                     insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getFieldNames()), realIndexes, fullField);"> 108                     insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getField🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110                 upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112                 throw new SQLException(&quot;Table &quot; + tableName + &quot; doesn&#x27;t exist&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115             if (batchWaitInterval &gt; 0 &amp;&amp; batchNum &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116                 LOG.info(&quot;open batch wait interval scheduled, interval is {} ms&quot;, batchWaitInterval);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118                 timerService = new ScheduledThreadPoolExecutor(1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119                 timerService.scheduleAtFixedRate(() -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120                     submitExecuteBatch();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121                 }, 0, batchWaitInterval, TimeUnit.MILLISECONDS);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         } catch (SQLException sqe) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126             LOG.error(&quot;&quot;, sqe);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127             throw new IllegalArgumentException(&quot;open() failed.&quot;, sqe);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         } catch (ClassNotFoundException cnfe) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129             LOG.error(&quot;&quot;, cnfe);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130             throw new IllegalArgumentException(&quot;JDBC driver class not found.&quot;, cnfe);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135     public Connection establishConnection() throws SQLException, ClassNotFoundException, IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         Connection connection ;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         JDBCUtils.forName(drivername, getClass().getClassLoader());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         if (username == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139             connection = DriverManager.getConnection(dbURL);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141             connection = DriverManager.getConnection(dbURL, username, password);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         connection.setAutoCommit(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         return connection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148      * Adds a record to the prepared statement.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149      * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150      * When this method is called, the output format is guaranteed to be opened.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152      * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 153      * WARNING: this may fail when no column types specified (because a best effort approach is attempted in order to"> 153      * WARNING: this may fail when no column types specified (because a best effort approach is attempted🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 154      * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObject(pos, null))"> 154      * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObje🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156      * @param tuple2 The records to add to the output.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157      * @throws IOException Thrown, if the records could not be added due to an I/O problem.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158      * @see PreparedStatement</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161     public void writeRecord(Tuple2 tuple2)  {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163         Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164         Boolean retract = tupleTrans.getField(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         Row row = tupleTrans.getField(1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         if (typesArray != null &amp;&amp; typesArray.length &gt; 0 &amp;&amp; typesArray.length != row.getArity()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 168             LOG.warn(&quot;Column SQL types array doesn&#x27;t match arity of passed Row! Check the passed array...&quot;);"> 168             LOG.warn(&quot;Column SQL types array doesn&#x27;t match arity of passed Row! Check the passed array...🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         if (retract) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                 LOG.info(&quot;Receive data : {}&quot;, row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             outRecords.inc();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             insertWrite(row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             //do nothing</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185     private void insertWrite(Row row) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186         checkConnectionOpen(dbConn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188             if (batchNum == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                 writeSingleRecord(row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                 updatePreparedStmt(row, upload);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                 rows.add(row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 upload.addBatch();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                 if (rows.size() &gt;= batchNum) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195                     submitExecuteBatch();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200                 outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 201                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 201                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.get🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202                 LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                 outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212     private void writeSingleRecord(Row row) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214             updatePreparedStmt(row, upload);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215             upload.executeUpdate();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216             dbConn.commit();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 220                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 220                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.get🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221                 LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224             outDirtyRecords.inc();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228     private void updatePreparedStmt(Row row, PreparedStatement pstmt) throws SQLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229         if (typesArray == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230             // no types provided</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231             for (int index = 0; index &lt; row.getArity(); index++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 232                 LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;, index + 1, row.getField(index));"> 232                 LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233                 pstmt.setObject(index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236             // types provided</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237             for (int index = 0; index &lt; row.getArity(); index++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239                 if (row.getField(index) == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240                     pstmt.setNull(index + 1, typesArray[index]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 242                     // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc/getstart/mapping.html"> 242                     // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243                     switch (typesArray[index]) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244                         case java.sql.Types.NULL:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245                             pstmt.setNull(index + 1, typesArray[index]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247                         case java.sql.Types.BOOLEAN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248                         case java.sql.Types.BIT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249                             pstmt.setBoolean(index + 1, (boolean) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251                         case java.sql.Types.CHAR:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252                         case java.sql.Types.NCHAR:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253                         case java.sql.Types.VARCHAR:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254                         case java.sql.Types.LONGVARCHAR:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255                         case java.sql.Types.LONGNVARCHAR:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256                             pstmt.setString(index + 1, (String) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258                         case java.sql.Types.TINYINT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259                             pstmt.setByte(index + 1, (byte) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261                         case java.sql.Types.SMALLINT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262                             pstmt.setShort(index + 1, (short) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264                         case java.sql.Types.INTEGER:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265                             pstmt.setInt(index + 1, (int) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267                         case java.sql.Types.BIGINT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268                             pstmt.setLong(index + 1, (long) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270                         case java.sql.Types.REAL:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271                         case java.sql.Types.FLOAT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272                             pstmt.setFloat(index + 1, (float) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274                         case java.sql.Types.DOUBLE:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275                             pstmt.setDouble(index + 1, (double) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277                         case java.sql.Types.DECIMAL:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278                         case java.sql.Types.NUMERIC:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279                             pstmt.setBigDecimal(index + 1, (java.math.BigDecimal) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281                         case java.sql.Types.DATE:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282                             pstmt.setDate(index + 1, (java.sql.Date) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284                         case java.sql.Types.TIME:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285                             pstmt.setTime(index + 1, (java.sql.Time) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287                         case java.sql.Types.TIMESTAMP:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288                             pstmt.setTimestamp(index + 1, (java.sql.Timestamp) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290                         case java.sql.Types.BINARY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291                         case java.sql.Types.VARBINARY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292                         case java.sql.Types.LONGVARBINARY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293                             pstmt.setBytes(index + 1, (byte[]) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294                             break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295                         default:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296                             pstmt.setObject(index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 297                             LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set its value: %s.&quot;,"> 297                             LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298                                     typesArray[index], index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299                             // case java.sql.Types.SQLXML</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300                             // case java.sql.Types.ARRAY:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301                             // case java.sql.Types.JAVA_OBJECT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302                             // case java.sql.Types.BLOB:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303                             // case java.sql.Types.CLOB:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304                             // case java.sql.Types.NCLOB:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305                             // case java.sql.Types.DATALINK:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306                             // case java.sql.Types.DISTINCT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307                             // case java.sql.Types.OTHER:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308                             // case java.sql.Types.REF:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309                             // case java.sql.Types.ROWID:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310                             // case java.sql.Types.STRUC</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318     private synchronized void submitExecuteBatch() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320             this.upload.executeBatch();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321             dbConn.commit();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323             try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324                 dbConn.rollback();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325             } catch (SQLException e1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326                 LOG.error(&quot;rollback  data error !&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329             rows.forEach(this::writeSingleRecord);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330         } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331             rows.clear();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335     private void checkConnectionOpen(Connection dbConn) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337             if (dbConn.isClosed()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338                 LOG.info(&quot;db connection reconnect..&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339                 dbConn= establishConnection();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340                 upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341                 this.dbConn = dbConn;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344             LOG.error(&quot;check connection open failed..&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345         } catch (ClassNotFoundException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346             LOG.error(&quot;load jdbc class error when reconnect db..&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347         } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348             LOG.error(&quot;kerberos authentication failed..&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353      * Executes prepared statement and closes all resources of this instance.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355      * @throws IOException Thrown, if the input could not be closed properly.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358     public void close() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360             if (upload != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361                 upload.executeBatch();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362                 upload.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364             if (null != timerService) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365                 timerService.shutdown();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366                 LOG.info(&quot;batch wait interval scheduled service  closed &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368         } catch (SQLException se) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369             LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370         } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371             upload = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372             rows.clear();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376             if (dbConn != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377                 dbConn.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379         } catch (SQLException se) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380             LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381         } finally {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382             dbConn = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387     public boolean isReplaceInsertQuery() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388         return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391     public void verifyField() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392         if (StringUtils.isBlank(username)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393             LOG.warn(&quot;Username was not supplied separately.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395         if (StringUtils.isBlank(password)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396             LOG.warn(&quot;Username was not supplied separately.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398         if (StringUtils.isBlank(dbURL)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399             throw new IllegalArgumentException(&quot;No dababase URL supplied.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401         if (StringUtils.isBlank(insertQuery)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402             throw new IllegalArgumentException(&quot;No insertQuery supplied&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404         if (StringUtils.isBlank(drivername)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405             throw new IllegalArgumentException(&quot;No driver supplied&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410     public void setUsername(String username) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411         this.username = username;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414     public String getSchema() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415         if (StringUtils.isNotEmpty(schema)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416             return schema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418         return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421     public void setSchema(String schema) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422         this.schema = schema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425     public boolean existTabname() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426         return dbConn.getMetaData().getTables(null, getSchema(), tableName, null).next();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429     public void setPassword(String password) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430         this.password = password;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433     public void setDrivername(String drivername) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434         this.drivername = drivername;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437     public String getDrivername() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438         return this.drivername;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441     public void setDbURL(String dbURL) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442         this.dbURL = dbURL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445     public void setTableName(String tableName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446         this.tableName = tableName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449     public void setDbType(String dbType) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450         this.dbType = dbType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453     public void setDbSink(RdbSink dbSink) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454         this.dbSink = dbSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457     public void setBatchNum(int batchNum) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458         this.batchNum = batchNum;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461     public void setInsertQuery(String insertQuery) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462         this.insertQuery = insertQuery;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465     public void setTypesArray(int[] typesArray) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466         this.typesArray = typesArray;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469     public String getDbType() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470         return dbType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473     public RdbSink getDbSink() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474         return dbSink;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477     public Connection getDbConn() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478         return dbConn;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481     public String getTableName() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482         return tableName;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485     public void realIndexesAdd(String index, List&lt;String&gt; fieldes) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486         this.realIndexes.put(index, fieldes);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489     public Map&lt;String,List&lt;String&gt;&gt; getRealIndexes() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490         return realIndexes;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494     public void setBatchWaitInterval(long batchWaitInterval) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495         this.batchWaitInterval = batchWaitInterval;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498     public List&lt;String&gt; getFullField() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499         return fullField;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502     public void fullFieldAdd(String colName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503         this.fullField.add(colName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505 }</span>
 506 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525 package com.dtstack.flink.sql.sink.rdb.format;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527 import com.dtstack.flink.sql.enums.EConnectionErrorCode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528 import com.dtstack.flink.sql.sink.rdb.RdbSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529 import com.dtstack.flink.sql.util.JDBCUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539 import java.sql.Connection;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540 import java.sql.DriverManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541 import java.sql.PreparedStatement;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542 import java.sql.SQLException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547 import java.util.concurrent.ScheduledThreadPoolExecutor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548 import java.util.concurrent.TimeUnit;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550 import com.dtstack.flink.sql.outputformat.DtRichOutputFormat;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553  * OutputFormat to write tuples into a database.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554  * The OutputFormat has to be configured using the supplied OutputFormatBuilder.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557 public class RetractJDBCOutputFormat extends DtRichOutputFormat {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558     private static final long serialVersionUID = 1L;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560     private static final Logger LOG = LoggerFactory.getLogger(RetractJDBCOutputFormat.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561     private static final int CONNECTION_CHECK_FREQUENCY = 100;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562     private int checkTimes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563     private String username;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564     private String password;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565     private String drivername;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566     private String dbURL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567     private String tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568     private String dbType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569     private String schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570     private RdbSink dbSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571     // trigger preparedStatement execute batch interval</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572     private long batchWaitInterval = 10000l;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573     // PreparedStatement execute batch num</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574     private int batchNum = 100;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575     private String insertQuery;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576     public int[] typesArray;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578     /** 存储用于批量写入的数据 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579     protected List&lt;Row&gt; rows = new ArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581     private Connection dbConn;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582     private PreparedStatement upload;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583     private transient ScheduledThreadPoolExecutor timerService;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586     //index field</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587     private Map&lt;String, List&lt;String&gt;&gt; realIndexes = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588     //full field</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589     private List&lt;String&gt; fullField = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591     public RetractJDBCOutputFormat() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595     public void configure(Configuration parameters) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599      * Connects to the target database and initializes the prepared statement.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601      * @param taskNumber The number of the parallel instance.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602      * @throws IOException Thrown, if the output could not be opened due to an</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603      *                     I/O problem.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606     public void open(int taskNumber, int numTasks) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608             LOG.info(&quot;PreparedStatement execute batch num is {}&quot;, batchNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609             dbConn = establishConnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610             initMetric();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612             if (existTabname()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613                 if (isReplaceInsertQuery()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 614                     insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getFieldNames()), realIndexes, fullField);"> 614                     insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getField🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616                 upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618                 throw new SQLException(&quot;Table &quot; + tableName + &quot; doesn&#x27;t exist&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621             if (batchWaitInterval &gt; 0 &amp;&amp; batchNum &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622                 LOG.info(&quot;open batch wait interval scheduled, interval is {} ms&quot;, batchWaitInterval);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624                 timerService = new ScheduledThreadPoolExecutor(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625                 timerService.scheduleAtFixedRate(() -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626                     submitExecuteBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627                 }, 0, batchWaitInterval, TimeUnit.MILLISECONDS);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631         } catch (SQLException sqe) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632             LOG.error(&quot;&quot;, sqe);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633             throw new IllegalArgumentException(&quot;open() failed.&quot;, sqe);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634         } catch (ClassNotFoundException cnfe) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635             LOG.error(&quot;&quot;, cnfe);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636             throw new IllegalArgumentException(&quot;JDBC driver class not found.&quot;, cnfe);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641     public Connection establishConnection() throws SQLException, ClassNotFoundException, IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642         Connection connection ;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643         JDBCUtils.forName(drivername, getClass().getClassLoader());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644         if (username == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645             connection = DriverManager.getConnection(dbURL);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647             connection = DriverManager.getConnection(dbURL, username, password);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649         connection.setAutoCommit(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650         return connection;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654      * Adds a record to the prepared statement.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655      * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656      * When this method is called, the output format is guaranteed to be opened.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658      * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 659      * WARNING: this may fail when no column types specified (because a best effort approach is attempted in order to"> 659      * WARNING: this may fail when no column types specified (because a best effort approach is attempted🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 660      * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObject(pos, null))"> 660      * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObje🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662      * @param tuple2 The records to add to the output.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663      * @throws IOException Thrown, if the records could not be added due to an I/O problem.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664      * @see PreparedStatement</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667     public void writeRecord(Tuple2 tuple2)  {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669         Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670         Boolean retract = tupleTrans.getField(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671         Row row = tupleTrans.getField(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673         if (typesArray != null &amp;&amp; typesArray.length &gt; 0 &amp;&amp; typesArray.length != row.getArity()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 674             LOG.warn(&quot;Column SQL types array doesn&#x27;t match arity of passed Row! Check the passed array...&quot;);"> 674             LOG.warn(&quot;Column SQL types array doesn&#x27;t match arity of passed Row! Check the passed array...🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677         if (retract) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680                 LOG.info(&quot;Receive data : {}&quot;, row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683             outRecords.inc();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684             insertWrite(row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686             //do nothing</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691     private void insertWrite(Row row)  {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693             if (batchNum == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694                 writeSingleRecord(row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696                 updatePreparedStmt(row, upload);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697                 rows.add(row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698                 upload.addBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699                 if (rows.size() &gt;= batchNum) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700                     submitExecuteBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705                 outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 706                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 706                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.get🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707                 LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709                 outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715     private void writeSingleRecord(Row row) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717             updatePreparedStmt(row, upload);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718             upload.executeUpdate();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719             dbConn.commit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721             dealSQLException(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 723                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 723                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.get🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724                 LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727             outDirtyRecords.inc();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731     private void updatePreparedStmt(Row row, PreparedStatement pstmt) throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732         if (typesArray == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733             // no types provided</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734             for (int index = 0; index &lt; row.getArity(); index++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 735                 LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;, index + 1, row.getField(index));"> 735                 LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736                 pstmt.setObject(index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 738         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 739             // types provided</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 740             for (int index = 0; index &lt; row.getArity(); index++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 741 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 742                 if (row.getField(index) == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 743                     pstmt.setNull(index + 1, typesArray[index]);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 744                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 745                     // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc/getstart/mapping.html"> 745                     // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 746                     switch (typesArray[index]) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 747                         case java.sql.Types.NULL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 748                             pstmt.setNull(index + 1, typesArray[index]);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 749                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 750                         case java.sql.Types.BOOLEAN:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 751                         case java.sql.Types.BIT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 752                             pstmt.setBoolean(index + 1, (boolean) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 753                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 754                         case java.sql.Types.CHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 755                         case java.sql.Types.NCHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 756                         case java.sql.Types.VARCHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 757                         case java.sql.Types.LONGVARCHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 758                         case java.sql.Types.LONGNVARCHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 759                             pstmt.setString(index + 1, (String) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 760                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 761                         case java.sql.Types.TINYINT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 762                             pstmt.setByte(index + 1, (byte) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 763                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 764                         case java.sql.Types.SMALLINT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 765                             pstmt.setShort(index + 1, (short) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 766                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 767                         case java.sql.Types.INTEGER:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 768                             pstmt.setInt(index + 1, (int) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 769                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 770                         case java.sql.Types.BIGINT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 771                             pstmt.setLong(index + 1, (long) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 772                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 773                         case java.sql.Types.REAL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 774                         case java.sql.Types.FLOAT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 775                             pstmt.setFloat(index + 1, (float) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 776                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 777                         case java.sql.Types.DOUBLE:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 778                             pstmt.setDouble(index + 1, (double) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 779                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 780                         case java.sql.Types.DECIMAL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 781                         case java.sql.Types.NUMERIC:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 782                             pstmt.setBigDecimal(index + 1, (java.math.BigDecimal) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 783                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 784                         case java.sql.Types.DATE:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 785                             pstmt.setDate(index + 1, (java.sql.Date) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 786                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 787                         case java.sql.Types.TIME:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 788                             pstmt.setTime(index + 1, (java.sql.Time) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 789                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 790                         case java.sql.Types.TIMESTAMP:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 791                             pstmt.setTimestamp(index + 1, (java.sql.Timestamp) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 792                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 793                         case java.sql.Types.BINARY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 794                         case java.sql.Types.VARBINARY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 795                         case java.sql.Types.LONGVARBINARY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 796                             pstmt.setBytes(index + 1, (byte[]) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 797                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 798                         default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 799                             pstmt.setObject(index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 800                             LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set its value: %s.&quot;,"> 800                             LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 801                                     typesArray[index], index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 802                             // case java.sql.Types.SQLXML</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 803                             // case java.sql.Types.ARRAY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 804                             // case java.sql.Types.JAVA_OBJECT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 805                             // case java.sql.Types.BLOB:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 806                             // case java.sql.Types.CLOB:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 807                             // case java.sql.Types.NCLOB:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 808                             // case java.sql.Types.DATALINK:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 809                             // case java.sql.Types.DISTINCT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 810                             // case java.sql.Types.OTHER:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 811                             // case java.sql.Types.REF:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 812                             // case java.sql.Types.ROWID:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 813                             // case java.sql.Types.STRUC</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 814                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 815                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 816             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 817         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 818     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 819 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 820 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 821     private synchronized void submitExecuteBatch() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 822         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 823             regularlyCheckConnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 824             this.upload.executeBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 825             dbConn.commit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 826         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 827             LOG.warn(&quot;submitExecuteBatch error {}&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 828             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 829                 dbConn.rollback();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 830             } catch (SQLException e1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 831                 dealSQLException(e1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 832             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 833             rows.forEach(this::writeSingleRecord);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 834         } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 835             rows.clear();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 836         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 837     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 838 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 839     private void dealSQLException(Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 840         EConnectionErrorCode errorCode = EConnectionErrorCode.resolveErrorCodeFromException(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 841         switch (errorCode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 842             case CONN_DB_INVALID:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 843                 reconnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 844                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 845             case CONN_DB_FAILED:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 846             case DB_TABLE_NOT_EXIST:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 847                 throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 848             default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 849         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 850     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 851 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 852 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 853     private void regularlyCheckConnection() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 854         checkTimes++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 855         if (checkTimes % CONNECTION_CHECK_FREQUENCY != 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 856             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 857         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 858         LOG.warn(&quot;db connection Valid check !&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 859         if (dbConn.isClosed() || !dbConn.isValid(100)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 860             reconnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 861         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 862         checkTimes = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 863     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 864 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 865     public void reconnection() throws RuntimeException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 866         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 867             LOG.info(&quot;db connection reconnect..&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 868             dbConn = establishConnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 869             upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 870             this.dbConn = dbConn;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 871         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 872             throw new RuntimeException(&quot;connection open failed..&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 873         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 874     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 875 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 876     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 877      * Executes prepared statement and closes all resources of this instance.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 878      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 879      * @throws IOException Thrown, if the input could not be closed properly.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 880      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 881     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 882     public void close() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 883         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 884             if (upload != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 885                 upload.executeBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 886                 upload.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 887             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 888             if (null != timerService) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 889                 timerService.shutdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 890                 LOG.info(&quot;batch wait interval scheduled service  closed &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 891             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 892         } catch (SQLException se) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 893             LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 894         } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 895             upload = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 896             rows.clear();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 897         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 898 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 899         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 900             if (dbConn != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 901                 dbConn.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 902             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 903         } catch (SQLException se) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 904             LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 905         } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 906             dbConn = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 907         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 908     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 909 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 910 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 911     public boolean isReplaceInsertQuery() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 912         return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 913     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 914 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 915     public void verifyField() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 916         if (StringUtils.isBlank(username)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 917             LOG.warn(&quot;Username was not supplied separately.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 918         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 919         if (StringUtils.isBlank(password)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 920             LOG.warn(&quot;Username was not supplied separately.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 921         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 922         if (StringUtils.isBlank(dbURL)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 923             throw new IllegalArgumentException(&quot;No dababase URL supplied.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 924         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 925         if (StringUtils.isBlank(insertQuery)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 926             throw new IllegalArgumentException(&quot;No insertQuery supplied&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 927         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 928         if (StringUtils.isBlank(drivername)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 929             throw new IllegalArgumentException(&quot;No driver supplied&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 930         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 931     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 932 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 933 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 934     public void setUsername(String username) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 935         this.username = username;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 936     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 937 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 938     public String getSchema() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 939         if (StringUtils.isNotEmpty(schema)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 940             return schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 941         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 942         return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 943     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 944 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 945     public void setSchema(String schema) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 946         this.schema = schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 947     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 948 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 949     public boolean existTabname() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 950         return dbConn.getMetaData().getTables(null, getSchema(), tableName, null).next();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 951     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 952 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 953     public void setPassword(String password) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 954         this.password = password;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 955     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 956 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 957     public void setDrivername(String drivername) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 958         this.drivername = drivername;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 959     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 960 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 961     public String getDrivername() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 962         return this.drivername;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 963     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 964 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 965     public void setDbURL(String dbURL) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 966         this.dbURL = dbURL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 967     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 968 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 969     public void setTableName(String tableName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 970         this.tableName = tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 971     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 972 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 973     public void setDbType(String dbType) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 974         this.dbType = dbType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 975     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 976 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 977     public void setDbSink(RdbSink dbSink) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 978         this.dbSink = dbSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 979     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 980 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 981     public void setBatchNum(int batchNum) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 982         this.batchNum = batchNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 983     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 984 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 985     public void setInsertQuery(String insertQuery) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 986         this.insertQuery = insertQuery;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 987     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 988 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 989     public void setTypesArray(int[] typesArray) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 990         this.typesArray = typesArray;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 991     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 992 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 993     public String getDbType() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 994         return dbType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 995     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 996 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 997     public RdbSink getDbSink() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 998         return dbSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 999     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1000 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1001     public Connection getDbConn() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1002         return dbConn;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1003     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1004 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1005     public String getTableName() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1006         return tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1007     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1008 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1009     public void realIndexesAdd(String index, List&lt;String&gt; fieldes) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1010         this.realIndexes.put(index, fieldes);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1011     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1012 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1013     public Map&lt;String,List&lt;String&gt;&gt; getRealIndexes() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1014         return realIndexes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1015     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1016 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1017 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1018     public void setBatchWaitInterval(long batchWaitInterval) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1019         this.batchWaitInterval = batchWaitInterval;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1020     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1021 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1022     public List&lt;String&gt; getFullField() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1023         return fullField;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1024     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1025 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1026     public void fullFieldAdd(String colName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1027         this.fullField.add(colName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1028     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1029 }</span>
1030 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
   4 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  19  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  20  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 package com.dtstack.flink.sql.sink.rdb.format;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import com.dtstack.flink.sql.enums.EConnectionErrorCode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import com.dtstack.flink.sql.sink.rdb.RdbSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import com.dtstack.flink.sql.util.JDBCUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import java.sql.Connection;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import java.sql.DriverManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 import java.sql.PreparedStatement;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 import java.sql.SQLException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 import java.util.concurrent.ScheduledThreadPoolExecutor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 import java.util.concurrent.TimeUnit;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49 import com.dtstack.flink.sql.outputformat.DtRichOutputFormat;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52  * OutputFormat to write tuples into a database.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53  * The OutputFormat has to be configured using the supplied OutputFormatBuilder.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56 public class RetractJDBCOutputFormat extends DtRichOutputFormat {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57     private static final long serialVersionUID = 1L;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59     private static final Logger LOG = LoggerFactory.getLogger(RetractJDBCOutputFormat.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60     private static final int CONNECTION_CHECK_FREQUENCY = 100;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61     private int checkTimes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62     private String username;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63     private String password;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64     private String drivername;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65     private String dbURL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66     private String tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67     private String dbType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68     private String schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69     private RdbSink dbSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70     // trigger preparedStatement execute batch interval</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71     private long batchWaitInterval = 10000l;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72     // PreparedStatement execute batch num</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73     private int batchNum = 100;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74     private String insertQuery;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75     public int[] typesArray;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77     /** 存储用于批量写入的数据 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78     protected List&lt;Row&gt; rows = new ArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80     private Connection dbConn;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81     private PreparedStatement upload;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82     private transient ScheduledThreadPoolExecutor timerService;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85     //index field</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86     private Map&lt;String, List&lt;String&gt;&gt; realIndexes = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87     //full field</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88     private List&lt;String&gt; fullField = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90     public RetractJDBCOutputFormat() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94     public void configure(Configuration parameters) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98      * Connects to the target database and initializes the prepared statement.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100      * @param taskNumber The number of the parallel instance.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101      * @throws IOException Thrown, if the output could not be opened due to an</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102      *                     I/O problem.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105     public void open(int taskNumber, int numTasks) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107             LOG.info(&quot;PreparedStatement execute batch num is {}&quot;, batchNum);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108             dbConn = establishConnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109             initMetric();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111             if (existTabname()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112                 if (isReplaceInsertQuery()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 113                     insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getFieldNames()), realIndexes, fullField);"> 113                     insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getField🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115                 upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117                 throw new SQLException(&quot;Table &quot; + tableName + &quot; doesn&#x27;t exist&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120             if (batchWaitInterval &gt; 0 &amp;&amp; batchNum &gt; 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121                 LOG.info(&quot;open batch wait interval scheduled, interval is {} ms&quot;, batchWaitInterval);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123                 timerService = new ScheduledThreadPoolExecutor(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124                 timerService.scheduleAtFixedRate(() -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125                     submitExecuteBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126                 }, 0, batchWaitInterval, TimeUnit.MILLISECONDS);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130         } catch (SQLException sqe) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131             LOG.error(&quot;&quot;, sqe);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132             throw new IllegalArgumentException(&quot;open() failed.&quot;, sqe);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133         } catch (ClassNotFoundException cnfe) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134             LOG.error(&quot;&quot;, cnfe);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135             throw new IllegalArgumentException(&quot;JDBC driver class not found.&quot;, cnfe);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140     public Connection establishConnection() throws SQLException, ClassNotFoundException, IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141         Connection connection ;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142         JDBCUtils.forName(drivername, getClass().getClassLoader());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143         if (username == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144             connection = DriverManager.getConnection(dbURL);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146             connection = DriverManager.getConnection(dbURL, username, password);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148         connection.setAutoCommit(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149         return connection;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153      * Adds a record to the prepared statement.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154      * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155      * When this method is called, the output format is guaranteed to be opened.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157      * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 158      * WARNING: this may fail when no column types specified (because a best effort approach is attempted in order to"> 158      * WARNING: this may fail when no column types specified (because a best effort approach is attempted🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 159      * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObject(pos, null))"> 159      * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObje🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161      * @param tuple2 The records to add to the output.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162      * @throws IOException Thrown, if the records could not be added due to an I/O problem.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163      * @see PreparedStatement</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166     public void writeRecord(Tuple2 tuple2)  {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168         Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169         Boolean retract = tupleTrans.getField(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170         Row row = tupleTrans.getField(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172         if (typesArray != null &amp;&amp; typesArray.length &gt; 0 &amp;&amp; typesArray.length != row.getArity()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 173             LOG.warn(&quot;Column SQL types array doesn&#x27;t match arity of passed Row! Check the passed array...&quot;);"> 173             LOG.warn(&quot;Column SQL types array doesn&#x27;t match arity of passed Row! Check the passed array...🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176         if (retract) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179                 LOG.info(&quot;Receive data : {}&quot;, row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182             outRecords.inc();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183             insertWrite(row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185             //do nothing</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190     private void insertWrite(Row row)  {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192             if (batchNum == 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193                 writeSingleRecord(row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195                 updatePreparedStmt(row, upload);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196                 rows.add(row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197                 upload.addBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198                 if (rows.size() &gt;= batchNum) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199                     submitExecuteBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204                 outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 205                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 205                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.get🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206                 LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208                 outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214     private void writeSingleRecord(Row row) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216             updatePreparedStmt(row, upload);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217             upload.executeUpdate();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218             dbConn.commit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220             dealSQLException(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 222                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 222                 LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.get🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223                 LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226             outDirtyRecords.inc();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230     private void updatePreparedStmt(Row row, PreparedStatement pstmt) throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231         if (typesArray == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232             // no types provided</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233             for (int index = 0; index &lt; row.getArity(); index++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 234                 LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;, index + 1, row.getField(index));"> 234                 LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;,🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235                 pstmt.setObject(index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238             // types provided</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239             for (int index = 0; index &lt; row.getArity(); index++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241                 if (row.getField(index) == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242                     pstmt.setNull(index + 1, typesArray[index]);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 244                     // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc/getstart/mapping.html"> 244                     // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245                     switch (typesArray[index]) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246                         case java.sql.Types.NULL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247                             pstmt.setNull(index + 1, typesArray[index]);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249                         case java.sql.Types.BOOLEAN:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250                         case java.sql.Types.BIT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251                             pstmt.setBoolean(index + 1, (boolean) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253                         case java.sql.Types.CHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254                         case java.sql.Types.NCHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255                         case java.sql.Types.VARCHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256                         case java.sql.Types.LONGVARCHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257                         case java.sql.Types.LONGNVARCHAR:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258                             pstmt.setString(index + 1, (String) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260                         case java.sql.Types.TINYINT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261                             pstmt.setByte(index + 1, (byte) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263                         case java.sql.Types.SMALLINT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264                             pstmt.setShort(index + 1, (short) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266                         case java.sql.Types.INTEGER:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267                             pstmt.setInt(index + 1, (int) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269                         case java.sql.Types.BIGINT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270                             pstmt.setLong(index + 1, (long) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272                         case java.sql.Types.REAL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273                         case java.sql.Types.FLOAT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274                             pstmt.setFloat(index + 1, (float) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276                         case java.sql.Types.DOUBLE:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277                             pstmt.setDouble(index + 1, (double) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279                         case java.sql.Types.DECIMAL:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280                         case java.sql.Types.NUMERIC:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281                             pstmt.setBigDecimal(index + 1, (java.math.BigDecimal) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283                         case java.sql.Types.DATE:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284                             pstmt.setDate(index + 1, (java.sql.Date) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286                         case java.sql.Types.TIME:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287                             pstmt.setTime(index + 1, (java.sql.Time) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289                         case java.sql.Types.TIMESTAMP:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290                             pstmt.setTimestamp(index + 1, (java.sql.Timestamp) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292                         case java.sql.Types.BINARY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293                         case java.sql.Types.VARBINARY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294                         case java.sql.Types.LONGVARBINARY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295                             pstmt.setBytes(index + 1, (byte[]) row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296                             break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297                         default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298                             pstmt.setObject(index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 299                             LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set its value: %s.&quot;,"> 299                             LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set 🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300                                     typesArray[index], index + 1, row.getField(index));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301                             // case java.sql.Types.SQLXML</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302                             // case java.sql.Types.ARRAY:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303                             // case java.sql.Types.JAVA_OBJECT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304                             // case java.sql.Types.BLOB:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305                             // case java.sql.Types.CLOB:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306                             // case java.sql.Types.NCLOB:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307                             // case java.sql.Types.DATALINK:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308                             // case java.sql.Types.DISTINCT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309                             // case java.sql.Types.OTHER:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310                             // case java.sql.Types.REF:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311                             // case java.sql.Types.ROWID:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312                             // case java.sql.Types.STRUC</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320     private synchronized void submitExecuteBatch() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322             regularlyCheckConnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323             this.upload.executeBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324             dbConn.commit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325         } catch (SQLException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326             LOG.warn(&quot;submitExecuteBatch error {}&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328                 dbConn.rollback();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329             } catch (SQLException e1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330                 dealSQLException(e1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332             rows.forEach(this::writeSingleRecord);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333         } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334             rows.clear();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338     private void dealSQLException(Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339         EConnectionErrorCode errorCode = EConnectionErrorCode.resolveErrorCodeFromException(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340         switch (errorCode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341             case CONN_DB_INVALID:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342                 reconnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344             case CONN_DB_FAILED:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345             case DB_TABLE_NOT_EXIST:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346                 throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347             default:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352     private void regularlyCheckConnection() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353         checkTimes++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354         if (checkTimes % CONNECTION_CHECK_FREQUENCY != 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357         LOG.warn(&quot;db connection Valid check !&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358         if (dbConn.isClosed() || !dbConn.isValid(100)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359             reconnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361         checkTimes = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364     public void reconnection() throws RuntimeException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366             LOG.info(&quot;db connection reconnect..&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367             dbConn = establishConnection();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368             upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369             this.dbConn = dbConn;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371             throw new RuntimeException(&quot;connection open failed..&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376      * Executes prepared statement and closes all resources of this instance.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378      * @throws IOException Thrown, if the input could not be closed properly.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381     public void close() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383             if (upload != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384                 upload.executeBatch();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385                 upload.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387             if (null != timerService) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388                 timerService.shutdown();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389                 LOG.info(&quot;batch wait interval scheduled service  closed &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391         } catch (SQLException se) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392             LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393         } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394             upload = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395             rows.clear();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399             if (dbConn != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400                 dbConn.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402         } catch (SQLException se) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403             LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404         } finally {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405             dbConn = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410     public boolean isReplaceInsertQuery() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411         return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414     public void verifyField() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415         if (StringUtils.isBlank(username)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416             LOG.warn(&quot;Username was not supplied separately.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418         if (StringUtils.isBlank(password)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419             LOG.warn(&quot;Username was not supplied separately.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421         if (StringUtils.isBlank(dbURL)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422             throw new IllegalArgumentException(&quot;No dababase URL supplied.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424         if (StringUtils.isBlank(insertQuery)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425             throw new IllegalArgumentException(&quot;No insertQuery supplied&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427         if (StringUtils.isBlank(drivername)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428             throw new IllegalArgumentException(&quot;No driver supplied&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433     public void setUsername(String username) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434         this.username = username;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437     public String getSchema() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438         if (StringUtils.isNotEmpty(schema)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439             return schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441         return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444     public void setSchema(String schema) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445         this.schema = schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448     public boolean existTabname() throws SQLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449         return dbConn.getMetaData().getTables(null, getSchema(), tableName, null).next();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452     public void setPassword(String password) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453         this.password = password;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456     public void setDrivername(String drivername) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457         this.drivername = drivername;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460     public String getDrivername() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461         return this.drivername;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464     public void setDbURL(String dbURL) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465         this.dbURL = dbURL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468     public void setTableName(String tableName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469         this.tableName = tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472     public void setDbType(String dbType) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473         this.dbType = dbType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476     public void setDbSink(RdbSink dbSink) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477         this.dbSink = dbSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480     public void setBatchNum(int batchNum) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481         this.batchNum = batchNum;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484     public void setInsertQuery(String insertQuery) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485         this.insertQuery = insertQuery;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488     public void setTypesArray(int[] typesArray) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489         this.typesArray = typesArray;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492     public String getDbType() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493         return dbType;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496     public RdbSink getDbSink() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497         return dbSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500     public Connection getDbConn() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501         return dbConn;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504     public String getTableName() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505         return tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508     public void realIndexesAdd(String index, List&lt;String&gt; fieldes) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509         this.realIndexes.put(index, fieldes);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512     public Map&lt;String,List&lt;String&gt;&gt; getRealIndexes() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513         return realIndexes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517     public void setBatchWaitInterval(long batchWaitInterval) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518         this.batchWaitInterval = batchWaitInterval;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521     public List&lt;String&gt; getFullField() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522         return fullField;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525     public void fullFieldAdd(String colName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526         this.fullField.add(colName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528 }</span>
 529 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * distributed with this work for additional information</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 - * limitations under the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -package com.dtstack.flink.sql.sink.rdb.format;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import com.dtstack.flink.sql.sink.rdb.RdbSink;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.util.JDBCUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import com.google.common.collect.Maps;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.slf4j.Logger;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import java.io.IOException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import java.sql.Connection;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import java.sql.DriverManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import java.sql.PreparedStatement;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import java.sql.SQLException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import java.util.ArrayList;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import java.util.Arrays;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import java.util.concurrent.ScheduledThreadPoolExecutor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import java.util.concurrent.TimeUnit;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import com.dtstack.flink.sql.outputformat.DtRichOutputFormat;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 - * OutputFormat to write tuples into a database.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 - * The OutputFormat has to be configured using the supplied OutputFormatBuilder.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -public class RetractJDBCOutputFormat extends DtRichOutputFormat {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -    private static final long serialVersionUID = 1L;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -    private static final Logger LOG = LoggerFactory.getLogger(RetractJDBCOutputFormat.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -    private String username;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -    private String password;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -    private String drivername;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -    private String dbURL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -    private String tableName;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -    private String dbType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -    private String schema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -    private RdbSink dbSink;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -    // trigger preparedStatement execute batch interval</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -    private long batchWaitInterval = 10000l;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -    // PreparedStatement execute batch num</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -    private int batchNum = 100;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -    private String insertQuery;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -    public int[] typesArray;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -    /** 存储用于批量写入的数据 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -    protected List&lt;Row&gt; rows = new ArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -    private Connection dbConn;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -    private PreparedStatement upload;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -    private transient ScheduledThreadPoolExecutor timerService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -    //index field</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -    private Map&lt;String, List&lt;String&gt;&gt; realIndexes = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -    //full field</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -    private List&lt;String&gt; fullField = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -    public RetractJDBCOutputFormat() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -    public void configure(Configuration parameters) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -     * Connects to the target database and initializes the prepared statement.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -     * @param taskNumber The number of the parallel instance.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -     * @throws IOException Thrown, if the output could not be opened due to an</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -     *                     I/O problem.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -    public void open(int taskNumber, int numTasks) throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -            LOG.info(&quot;PreparedStatement execute batch num is {}&quot;, batchNum);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -            dbConn = establishConnection();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -            initMetric();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -            if (existTabname()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -                if (isReplaceInsertQuery()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 106 -                    insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getFieldNames()), realIndexes, fullField);"> 106 -                    insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getFieldNames()),🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -                upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -                throw new SQLException(&quot;Table &quot; + tableName + &quot; doesn&#x27;t exist&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -            if (batchWaitInterval &gt; 0 &amp;&amp; batchNum &gt; 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -                LOG.info(&quot;open batch wait interval scheduled, interval is {} ms&quot;, batchWaitInterval);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -                timerService = new ScheduledThreadPoolExecutor(1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -                timerService.scheduleAtFixedRate(() -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -                    submitExecuteBatch();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -                }, 0, batchWaitInterval, TimeUnit.MILLISECONDS);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        } catch (SQLException sqe) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -            LOG.error(&quot;&quot;, sqe);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -            throw new IllegalArgumentException(&quot;open() failed.&quot;, sqe);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -        } catch (ClassNotFoundException cnfe) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -            LOG.error(&quot;&quot;, cnfe);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -            throw new IllegalArgumentException(&quot;JDBC driver class not found.&quot;, cnfe);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -    public Connection establishConnection() throws SQLException, ClassNotFoundException, IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        Connection connection ;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        JDBCUtils.forName(drivername, getClass().getClassLoader());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -        if (username == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -            connection = DriverManager.getConnection(dbURL);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -            connection = DriverManager.getConnection(dbURL, username, password);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -        connection.setAutoCommit(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        return connection;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -     * Adds a record to the prepared statement.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -     * &lt;p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -     * When this method is called, the output format is guaranteed to be opened.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -     * &lt;/p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -     * &lt;p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 151 -     * WARNING: this may fail when no column types specified (because a best effort approach is attempted in order to"> 151 -     * WARNING: this may fail when no column types specified (because a best effort approach is attempted in order🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 152 -     * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObject(pos, null))"> 152 -     * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObject(pos, n🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -     * @param tuple2 The records to add to the output.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -     * @throws IOException Thrown, if the records could not be added due to an I/O problem.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -     * @see PreparedStatement</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -    public void writeRecord(Tuple2 tuple2)  {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -        Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -        Boolean retract = tupleTrans.getField(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -        Row row = tupleTrans.getField(1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -        if (typesArray != null &amp;&amp; typesArray.length &gt; 0 &amp;&amp; typesArray.length != row.getArity()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -            LOG.warn(&quot;Column SQL types array doesn&#x27;t match arity of passed Row! Check the passed array...&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -        if (retract) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -            if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -                LOG.info(&quot;Receive data : {}&quot;, row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -            outRecords.inc();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -            insertWrite(row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -            //do nothing</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -    private void insertWrite(Row row) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -        checkConnectionOpen(dbConn);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -            if (batchNum == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -                writeSingleRecord(row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -                updatePreparedStmt(row, upload);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -                rows.add(row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -                upload.addBatch();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -                if (rows.size() &gt;= batchNum) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -                    submitExecuteBatch();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -        } catch (SQLException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -            if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -                outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 199 -                LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 199 -                LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), 🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -                LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -                outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -    private void writeSingleRecord(Row row) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -            updatePreparedStmt(row, upload);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -            upload.executeUpdate();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -            dbConn.commit();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -        } catch (SQLException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -            if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 218 -                LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 218 -                LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), 🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -                LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -            outDirtyRecords.inc();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -    private void updatePreparedStmt(Row row, PreparedStatement pstmt) throws SQLException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -        if (typesArray == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -            // no types provided</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -            for (int index = 0; index &lt; row.getArity(); index++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 230 -                LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;, index + 1, row.getField(index));"> 230 -                LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;, index + 🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -                pstmt.setObject(index + 1, row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -            // types provided</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -            for (int index = 0; index &lt; row.getArity(); index++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -                if (row.getField(index) == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -                    pstmt.setNull(index + 1, typesArray[index]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 240 -                    // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc/getstart/mapping.html"> 240 -                    // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc/getstart🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -                    switch (typesArray[index]) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -                        case java.sql.Types.NULL:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -                            pstmt.setNull(index + 1, typesArray[index]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -                        case java.sql.Types.BOOLEAN:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -                        case java.sql.Types.BIT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -                            pstmt.setBoolean(index + 1, (boolean) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -                        case java.sql.Types.CHAR:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -                        case java.sql.Types.NCHAR:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -                        case java.sql.Types.VARCHAR:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -                        case java.sql.Types.LONGVARCHAR:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -                        case java.sql.Types.LONGNVARCHAR:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -                            pstmt.setString(index + 1, (String) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -                        case java.sql.Types.TINYINT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -                            pstmt.setByte(index + 1, (byte) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -                        case java.sql.Types.SMALLINT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -                            pstmt.setShort(index + 1, (short) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -                        case java.sql.Types.INTEGER:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -                            pstmt.setInt(index + 1, (int) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -                        case java.sql.Types.BIGINT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -                            pstmt.setLong(index + 1, (long) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -                        case java.sql.Types.REAL:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -                        case java.sql.Types.FLOAT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -                            pstmt.setFloat(index + 1, (float) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -                        case java.sql.Types.DOUBLE:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -                            pstmt.setDouble(index + 1, (double) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -                        case java.sql.Types.DECIMAL:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -                        case java.sql.Types.NUMERIC:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -                            pstmt.setBigDecimal(index + 1, (java.math.BigDecimal) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -                        case java.sql.Types.DATE:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -                            pstmt.setDate(index + 1, (java.sql.Date) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -                        case java.sql.Types.TIME:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -                            pstmt.setTime(index + 1, (java.sql.Time) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -                        case java.sql.Types.TIMESTAMP:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -                            pstmt.setTimestamp(index + 1, (java.sql.Timestamp) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -                        case java.sql.Types.BINARY:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -                        case java.sql.Types.VARBINARY:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -                        case java.sql.Types.LONGVARBINARY:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -                            pstmt.setBytes(index + 1, (byte[]) row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -                            break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -                        default:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -                            pstmt.setObject(index + 1, row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 295 -                            LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set its value: %s.&quot;,"> 295 -                            LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set its value🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -                                    typesArray[index], index + 1, row.getField(index));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -                            // case java.sql.Types.SQLXML</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -                            // case java.sql.Types.ARRAY:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -                            // case java.sql.Types.JAVA_OBJECT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -                            // case java.sql.Types.BLOB:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -                            // case java.sql.Types.CLOB:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -                            // case java.sql.Types.NCLOB:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -                            // case java.sql.Types.DATALINK:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -                            // case java.sql.Types.DISTINCT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -                            // case java.sql.Types.OTHER:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -                            // case java.sql.Types.REF:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -                            // case java.sql.Types.ROWID:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -                            // case java.sql.Types.STRUC</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -    private synchronized void submitExecuteBatch() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 317 -        try {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -            this.upload.executeBatch();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -            dbConn.commit();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -        } catch (SQLException e) {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 321 -            try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -                dbConn.rollback();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -            } catch (SQLException e1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -                LOG.error(&quot;rollback  data error !&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 326 -</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 327 -            rows.forEach(this::writeSingleRecord);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -        } finally {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 329 -            rows.clear();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 330 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 333 -    private void checkConnectionOpen(Connection dbConn) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -            if (dbConn.isClosed()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -                LOG.info(&quot;db connection reconnect..&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -                dbConn= establishConnection();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -                upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -                this.dbConn = dbConn;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -        } catch (SQLException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -            LOG.error(&quot;check connection open failed..&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 343 -        } catch (ClassNotFoundException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 344 -            LOG.error(&quot;load jdbc class error when reconnect db..&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 345 -        } catch (IOException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -            LOG.error(&quot;kerberos authentication failed..&quot;, e);</span>


































<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 349 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -     * Executes prepared statement and closes all resources of this instance.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 352 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -     * @throws IOException Thrown, if the input could not be closed properly.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 356 -    public void close() throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 357 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 358 -            if (upload != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -                upload.executeBatch();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -                upload.close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -            if (null != timerService) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -                timerService.shutdown();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -                LOG.info(&quot;batch wait interval scheduled service  closed &quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -        } catch (SQLException se) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -            LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -        } finally {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -            upload = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -            rows.clear();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -            if (dbConn != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -                dbConn.close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -        } catch (SQLException se) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -            LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 379 -        } finally {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 380 -            dbConn = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 381 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 382 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 383 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 384 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 385 -    public boolean isReplaceInsertQuery() throws SQLException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 386 -        return false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 387 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 388 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 389 -    public void verifyField() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 390 -        if (StringUtils.isBlank(username)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 391 -            LOG.warn(&quot;Username was not supplied separately.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 392 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 393 -        if (StringUtils.isBlank(password)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -            LOG.warn(&quot;Username was not supplied separately.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -        if (StringUtils.isBlank(dbURL)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -            throw new IllegalArgumentException(&quot;No dababase URL supplied.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -        if (StringUtils.isBlank(insertQuery)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -            throw new IllegalArgumentException(&quot;No insertQuery supplied&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -        if (StringUtils.isBlank(drivername)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -            throw new IllegalArgumentException(&quot;No driver supplied&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -    public void setUsername(String username) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -        this.username = username;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -    public String getSchema() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -        if (StringUtils.isNotEmpty(schema)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -            return schema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -        return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -    public void setSchema(String schema) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 420 -        this.schema = schema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 421 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 422 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 423 -    public boolean existTabname() throws SQLException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 424 -        return dbConn.getMetaData().getTables(null, getSchema(), tableName, null).next();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 425 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 426 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 427 -    public void setPassword(String password) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 428 -        this.password = password;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 429 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 430 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 431 -    public void setDrivername(String drivername) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 432 -        this.drivername = drivername;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 433 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 434 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 435 -    public String getDrivername() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 436 -        return this.drivername;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 437 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 438 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 439 -    public void setDbURL(String dbURL) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 440 -        this.dbURL = dbURL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 441 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 442 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -    public void setTableName(String tableName) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 444 -        this.tableName = tableName;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 445 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 447 -    public void setDbType(String dbType) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 448 -        this.dbType = dbType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 449 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 450 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 451 -    public void setDbSink(RdbSink dbSink) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 452 -        this.dbSink = dbSink;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 453 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 454 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 455 -    public void setBatchNum(int batchNum) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 456 -        this.batchNum = batchNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 457 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 458 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 459 -    public void setInsertQuery(String insertQuery) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 460 -        this.insertQuery = insertQuery;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 462 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 463 -    public void setTypesArray(int[] typesArray) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 464 -        this.typesArray = typesArray;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 465 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 466 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 467 -    public String getDbType() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 468 -        return dbType;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 469 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 470 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 471 -    public RdbSink getDbSink() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -        return dbSink;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -    public Connection getDbConn() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 476 -        return dbConn;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 477 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 478 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 479 -    public String getTableName() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 480 -        return tableName;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 481 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 482 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 483 -    public void realIndexesAdd(String index, List&lt;String&gt; fieldes) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 484 -        this.realIndexes.put(index, fieldes);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 485 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 486 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 487 -    public Map&lt;String,List&lt;String&gt;&gt; getRealIndexes() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 488 -        return realIndexes;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 489 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 490 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 491 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 492 -    public void setBatchWaitInterval(long batchWaitInterval) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 493 -        this.batchWaitInterval = batchWaitInterval;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 494 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 495 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 496 -    public List&lt;String&gt; getFullField() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 497 -        return fullField;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 498 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 499 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 500 -    public void fullFieldAdd(String colName) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 501 -        this.fullField.add(colName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 502 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 503 -}</span></pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.sink.rdb.format;
  20  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import com.dtstack.flink.sql.enums.EConnectionErrorCode;</span>
  22  import com.dtstack.flink.sql.sink.rdb.RdbSink;
  23  import com.dtstack.flink.sql.util.JDBCUtils;
  24  import org.apache.commons.lang3.StringUtils;
  25  import org.apache.flink.api.java.tuple.Tuple2;
  26  import org.apache.flink.configuration.Configuration;
  27  import com.google.common.collect.Lists;
  28  import com.google.common.collect.Maps;
  29  import org.apache.flink.types.Row;
  30  import org.slf4j.Logger;
  31  import org.slf4j.LoggerFactory;
  32  import java.io.IOException;
  33  import java.sql.Connection;
  34  import java.sql.DriverManager;
  35  import java.sql.PreparedStatement;
  36  import java.sql.SQLException;
  37  import java.util.ArrayList;
  38  import java.util.Arrays;
  39  import java.util.List;
  40  import java.util.Map;
  41  import java.util.concurrent.ScheduledThreadPoolExecutor;
  42  import java.util.concurrent.TimeUnit;
  43  
  44  import com.dtstack.flink.sql.outputformat.DtRichOutputFormat;
  45  
  46  /**
  47   * OutputFormat to write tuples into a database.
  48   * The OutputFormat has to be configured using the supplied OutputFormatBuilder.
  49   *
  50   */
  51  public class RetractJDBCOutputFormat extends DtRichOutputFormat {
  52      private static final long serialVersionUID = 1L;
  53  
  54      private static final Logger LOG = LoggerFactory.getLogger(RetractJDBCOutputFormat.class);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +    private static final int CONNECTION_CHECK_FREQUENCY = 100;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +    private int checkTimes;</span>
  58      private String username;
  59      private String password;
  60      private String drivername;
  61      private String dbURL;
  62      private String tableName;
  63      private String dbType;
  64      private String schema;
  65      private RdbSink dbSink;
  66      // trigger preparedStatement execute batch interval
  67      private long batchWaitInterval = 10000l;
  68      // PreparedStatement execute batch num
  69      private int batchNum = 100;
  70      private String insertQuery;
  71      public int[] typesArray;
  72  
  73      /** 存储用于批量写入的数据 */
  74      protected List&lt;Row&gt; rows = new ArrayList();
  75  
  76      private Connection dbConn;
  77      private PreparedStatement upload;
  78      private transient ScheduledThreadPoolExecutor timerService;
  79  
  80  
  81      //index field
  82      private Map&lt;String, List&lt;String&gt;&gt; realIndexes = Maps.newHashMap();
  83      //full field
  84      private List&lt;String&gt; fullField = Lists.newArrayList();
  85  
  86      public RetractJDBCOutputFormat() {
  87      }
  88  
  89      @Override
  90      public void configure(Configuration parameters) {
  91      }
  92  
  93      /**
  94       * Connects to the target database and initializes the prepared statement.
  95       *
  96       * @param taskNumber The number of the parallel instance.
  97       * @throws IOException Thrown, if the output could not be opened due to an
  98       *                     I/O problem.
  99       */
 100      @Override
 101      public void open(int taskNumber, int numTasks) throws IOException {
 102          try {
 103              LOG.info(&quot;PreparedStatement execute batch num is {}&quot;, batchNum);
 104              dbConn = establishConnection();
 105              initMetric();
 106  
 107              if (existTabname()) {
 108                  if (isReplaceInsertQuery()) {
<abbr title=" 109                      insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getFieldNames()), realIndexes, fullField);"> 109                      insertQuery = dbSink.buildUpdateSql(schema , tableName, Arrays.asList(dbSink.getFieldNames()),🔵</abbr>
 110                  }
 111                  upload = dbConn.prepareStatement(insertQuery);
 112              } else {
 113                  throw new SQLException(&quot;Table &quot; + tableName + &quot; doesn&#x27;t exist&quot;);
 114              }
 115  
 116              if (batchWaitInterval &gt; 0 &amp;&amp; batchNum &gt; 1) {
 117                  LOG.info(&quot;open batch wait interval scheduled, interval is {} ms&quot;, batchWaitInterval);
 118  
 119                  timerService = new ScheduledThreadPoolExecutor(1);
 120                  timerService.scheduleAtFixedRate(() -&gt; {
 121                      submitExecuteBatch();
 122                  }, 0, batchWaitInterval, TimeUnit.MILLISECONDS);
 123  
 124              }
 125  
 126          } catch (SQLException sqe) {
 127              LOG.error(&quot;&quot;, sqe);
 128              throw new IllegalArgumentException(&quot;open() failed.&quot;, sqe);
 129          } catch (ClassNotFoundException cnfe) {
 130              LOG.error(&quot;&quot;, cnfe);
 131              throw new IllegalArgumentException(&quot;JDBC driver class not found.&quot;, cnfe);
 132          }
 133      }
 134  
 135  
 136      public Connection establishConnection() throws SQLException, ClassNotFoundException, IOException {
 137          Connection connection ;
 138          JDBCUtils.forName(drivername, getClass().getClassLoader());
 139          if (username == null) {
 140              connection = DriverManager.getConnection(dbURL);
 141          } else {
 142              connection = DriverManager.getConnection(dbURL, username, password);
 143          }
 144          connection.setAutoCommit(false);
 145          return connection;
 146      }
 147  
 148      /**
 149       * Adds a record to the prepared statement.
 150       * &lt;p&gt;
 151       * When this method is called, the output format is guaranteed to be opened.
 152       * &lt;/p&gt;
 153       * &lt;p&gt;
<abbr title=" 154       * WARNING: this may fail when no column types specified (because a best effort approach is attempted in order to"> 154       * WARNING: this may fail when no column types specified (because a best effort approach is attempted in order🔵</abbr>
<abbr title=" 155       * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObject(pos, null))"> 155       * insert a null value but it&#x27;s not guaranteed that the JDBC driver handles PreparedStatement.setObject(pos, n🔵</abbr>
 156       *
 157       * @param tuple2 The records to add to the output.
 158       * @throws IOException Thrown, if the records could not be added due to an I/O problem.
 159       * @see PreparedStatement
 160       */
 161      @Override
 162      public void writeRecord(Tuple2 tuple2)  {
 163  
 164          Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;
 165          Boolean retract = tupleTrans.getField(0);
 166          Row row = tupleTrans.getField(1);
 167  
 168          if (typesArray != null &amp;&amp; typesArray.length &gt; 0 &amp;&amp; typesArray.length != row.getArity()) {
 169              LOG.warn(&quot;Column SQL types array doesn&#x27;t match arity of passed Row! Check the passed array...&quot;);
 170          }
 171  
 172          if (retract) {
 173  
 174              if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 175                  LOG.info(&quot;Receive data : {}&quot;, row);
 176              }
 177  
 178              outRecords.inc();
 179              insertWrite(row);
 180          } else {
 181              //do nothing
 182          }
 183      }
 184  
 185  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -    private void insertWrite(Row row) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -        checkConnectionOpen(dbConn);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +    private void insertWrite(Row row)  {</span>
 189          try {
 190              if (batchNum == 1) {
 191                  writeSingleRecord(row);
 192              } else {
 193                  updatePreparedStmt(row, upload);
 194                  rows.add(row);
 195                  upload.addBatch();
 196                  if (rows.size() &gt;= batchNum) {
 197                      submitExecuteBatch();
 198                  }
 199              }
 200          } catch (SQLException e) {
 201              if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {
 202                  outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());
<abbr title=" 203                  LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 203                  LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), 🔵</abbr>
 204                  LOG.error(&quot;&quot;, e);
 205              } else {
 206                  outDirtyRecords.inc(batchNum == 1 ? batchNum : rows.size());
 207              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -</span>
 210          }
 211  
 212      }
 213  
 214      private void writeSingleRecord(Row row) {
 215          try {
 216              updatePreparedStmt(row, upload);
 217              upload.executeUpdate();
 218              dbConn.commit();
 219          } catch (SQLException e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +            dealSQLException(e);</span>
 222              if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {
<abbr title=" 223                  LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), row.toString());"> 223                  LOG.error(&quot;record insert failed,dirty record num:{}, current row:{}&quot;, outDirtyRecords.getCount(), 🔵</abbr>
 224                  LOG.error(&quot;&quot;, e);
 225              }
 226  
 227              outDirtyRecords.inc();
 228          }
 229      }
 230  
 231      private void updatePreparedStmt(Row row, PreparedStatement pstmt) throws SQLException {
 232          if (typesArray == null) {
 233              // no types provided
 234              for (int index = 0; index &lt; row.getArity(); index++) {
<abbr title=" 235                  LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;, index + 1, row.getField(index));"> 235                  LOG.warn(&quot;Unknown column type for column %s. Best effort approach to set its value: %s.&quot;, index + 🔵</abbr>
 236                  pstmt.setObject(index + 1, row.getField(index));
 237              }
 238          } else {
 239              // types provided
 240              for (int index = 0; index &lt; row.getArity(); index++) {
 241  
 242                  if (row.getField(index) == null) {
 243                      pstmt.setNull(index + 1, typesArray[index]);
 244                  } else {
<abbr title=" 245                      // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc/getstart/mapping.html"> 245                      // casting values as suggested by http://docs.oracle.com/javase/1.5.0/docs/guide/jdbc/getstart🔵</abbr>
 246                      switch (typesArray[index]) {
 247                          case java.sql.Types.NULL:
 248                              pstmt.setNull(index + 1, typesArray[index]);
 249                              break;
 250                          case java.sql.Types.BOOLEAN:
 251                          case java.sql.Types.BIT:
 252                              pstmt.setBoolean(index + 1, (boolean) row.getField(index));
 253                              break;
 254                          case java.sql.Types.CHAR:
 255                          case java.sql.Types.NCHAR:
 256                          case java.sql.Types.VARCHAR:
 257                          case java.sql.Types.LONGVARCHAR:
 258                          case java.sql.Types.LONGNVARCHAR:
 259                              pstmt.setString(index + 1, (String) row.getField(index));
 260                              break;
 261                          case java.sql.Types.TINYINT:
 262                              pstmt.setByte(index + 1, (byte) row.getField(index));
 263                              break;
 264                          case java.sql.Types.SMALLINT:
 265                              pstmt.setShort(index + 1, (short) row.getField(index));
 266                              break;
 267                          case java.sql.Types.INTEGER:
 268                              pstmt.setInt(index + 1, (int) row.getField(index));
 269                              break;
 270                          case java.sql.Types.BIGINT:
 271                              pstmt.setLong(index + 1, (long) row.getField(index));
 272                              break;
 273                          case java.sql.Types.REAL:
 274                          case java.sql.Types.FLOAT:
 275                              pstmt.setFloat(index + 1, (float) row.getField(index));
 276                              break;
 277                          case java.sql.Types.DOUBLE:
 278                              pstmt.setDouble(index + 1, (double) row.getField(index));
 279                              break;
 280                          case java.sql.Types.DECIMAL:
 281                          case java.sql.Types.NUMERIC:
 282                              pstmt.setBigDecimal(index + 1, (java.math.BigDecimal) row.getField(index));
 283                              break;
 284                          case java.sql.Types.DATE:
 285                              pstmt.setDate(index + 1, (java.sql.Date) row.getField(index));
 286                              break;
 287                          case java.sql.Types.TIME:
 288                              pstmt.setTime(index + 1, (java.sql.Time) row.getField(index));
 289                              break;
 290                          case java.sql.Types.TIMESTAMP:
 291                              pstmt.setTimestamp(index + 1, (java.sql.Timestamp) row.getField(index));
 292                              break;
 293                          case java.sql.Types.BINARY:
 294                          case java.sql.Types.VARBINARY:
 295                          case java.sql.Types.LONGVARBINARY:
 296                              pstmt.setBytes(index + 1, (byte[]) row.getField(index));
 297                              break;
 298                          default:
 299                              pstmt.setObject(index + 1, row.getField(index));
<abbr title=" 300                              LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set its value: %s.&quot;,"> 300                              LOG.warn(&quot;Unmanaged sql type (%s) for column %s. Best effort approach to set its value🔵</abbr>
 301                                      typesArray[index], index + 1, row.getField(index));
 302                              // case java.sql.Types.SQLXML
 303                              // case java.sql.Types.ARRAY:
 304                              // case java.sql.Types.JAVA_OBJECT:
 305                              // case java.sql.Types.BLOB:
 306                              // case java.sql.Types.CLOB:
 307                              // case java.sql.Types.NCLOB:
 308                              // case java.sql.Types.DATALINK:
 309                              // case java.sql.Types.DISTINCT:
 310                              // case java.sql.Types.OTHER:
 311                              // case java.sql.Types.REF:
 312                              // case java.sql.Types.ROWID:
 313                              // case java.sql.Types.STRUC
 314                      }
 315                  }
 316              }
 317          }
 318      }
 319  
 320  
 321      private synchronized void submitExecuteBatch() {
 322          try {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +            regularlyCheckConnection();</span>
 324              this.upload.executeBatch();
 325              dbConn.commit();
 326          } catch (SQLException e) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +            LOG.warn(&quot;submitExecuteBatch error {}&quot;, e);</span>
 328              try {
 329                  dbConn.rollback();
 330              } catch (SQLException e1) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -                LOG.error(&quot;rollback  data error !&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 333 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +                dealSQLException(e1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +            }</span>
 336              rows.forEach(this::writeSingleRecord);
 337          } finally {
 338              rows.clear();
 339          }
 340      }
 341  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -    private void checkConnectionOpen(Connection dbConn) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 343 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 344 -            if (dbConn.isClosed()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 345 -                LOG.info(&quot;db connection reconnect..&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -                dbConn= establishConnection();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -                upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -                this.dbConn = dbConn;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 349 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -        } catch (SQLException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -            LOG.error(&quot;check connection open failed..&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 352 -        } catch (ClassNotFoundException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -            LOG.error(&quot;load jdbc class error when reconnect db..&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -        } catch (IOException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -            LOG.error(&quot;kerberos authentication failed..&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +    private void dealSQLException(Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +        EConnectionErrorCode errorCode = EConnectionErrorCode.resolveErrorCodeFromException(e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +        switch (errorCode) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +            case CONN_DB_INVALID:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +                reconnection();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +            case CONN_DB_FAILED:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +            case DB_TABLE_NOT_EXIST:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +                throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +            default:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 370 +    private void regularlyCheckConnection() throws SQLException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 371 +        checkTimes++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 372 +        if (checkTimes % CONNECTION_CHECK_FREQUENCY != 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 373 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 374 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +        LOG.warn(&quot;db connection Valid check !&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 376 +        if (dbConn.isClosed() || !dbConn.isValid(100)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +            reconnection();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +        checkTimes = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +    public void reconnection() throws RuntimeException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +            LOG.info(&quot;db connection reconnect..&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +            dbConn = establishConnection();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +            upload = dbConn.prepareStatement(insertQuery);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +            this.dbConn = dbConn;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +        } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +            throw new RuntimeException(&quot;connection open failed..&quot;, e);</span>
 390          }
 391      }
 392  
 393      /**
 394       * Executes prepared statement and closes all resources of this instance.
 395       *
 396       * @throws IOException Thrown, if the input could not be closed properly.
 397       */
 398      @Override
 399      public void close() throws IOException {
 400          try {
 401              if (upload != null) {
 402                  upload.executeBatch();
 403                  upload.close();
 404              }
 405              if (null != timerService) {
 406                  timerService.shutdown();
 407                  LOG.info(&quot;batch wait interval scheduled service  closed &quot;);
 408              }
 409          } catch (SQLException se) {
 410              LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);
 411          } finally {
 412              upload = null;
 413              rows.clear();
 414          }
 415  
 416          try {
 417              if (dbConn != null) {
 418                  dbConn.close();
 419              }
 420          } catch (SQLException se) {
 421              LOG.info(&quot;Inputformat couldn&#x27;t be closed - &quot;, se);
 422          } finally {
 423              dbConn = null;
 424          }
 425      }
 426  
 427  
 428      public boolean isReplaceInsertQuery() throws SQLException {
 429          return false;
 430      }
 431  
 432      public void verifyField() {
 433          if (StringUtils.isBlank(username)) {
 434              LOG.warn(&quot;Username was not supplied separately.&quot;);
 435          }
 436          if (StringUtils.isBlank(password)) {
 437              LOG.warn(&quot;Username was not supplied separately.&quot;);
 438          }
 439          if (StringUtils.isBlank(dbURL)) {
 440              throw new IllegalArgumentException(&quot;No dababase URL supplied.&quot;);
 441          }
 442          if (StringUtils.isBlank(insertQuery)) {
 443              throw new IllegalArgumentException(&quot;No insertQuery supplied&quot;);
 444          }
 445          if (StringUtils.isBlank(drivername)) {
 446              throw new IllegalArgumentException(&quot;No driver supplied&quot;);
 447          }
 448      }
 449  
 450  
 451      public void setUsername(String username) {
 452          this.username = username;
 453      }
 454  
 455      public String getSchema() {
 456          if (StringUtils.isNotEmpty(schema)) {
 457              return schema;
 458          }
 459          return null;
 460      }
 461  
 462      public void setSchema(String schema) {
 463          this.schema = schema;
 464      }
 465  
 466      public boolean existTabname() throws SQLException {
 467          return dbConn.getMetaData().getTables(null, getSchema(), tableName, null).next();
 468      }
 469  
 470      public void setPassword(String password) {
 471          this.password = password;
 472      }
 473  
 474      public void setDrivername(String drivername) {
 475          this.drivername = drivername;
 476      }
 477  
 478      public String getDrivername() {
 479          return this.drivername;
 480      }
 481  
 482      public void setDbURL(String dbURL) {
 483          this.dbURL = dbURL;
 484      }
 485  
 486      public void setTableName(String tableName) {
 487          this.tableName = tableName;
 488      }
 489  
 490      public void setDbType(String dbType) {
 491          this.dbType = dbType;
 492      }
 493  
 494      public void setDbSink(RdbSink dbSink) {
 495          this.dbSink = dbSink;
 496      }
 497  
 498      public void setBatchNum(int batchNum) {
 499          this.batchNum = batchNum;
 500      }
 501  
 502      public void setInsertQuery(String insertQuery) {
 503          this.insertQuery = insertQuery;
 504      }
 505  
 506      public void setTypesArray(int[] typesArray) {
 507          this.typesArray = typesArray;
 508      }
 509  
 510      public String getDbType() {
 511          return dbType;
 512      }
 513  
 514      public RdbSink getDbSink() {
 515          return dbSink;
 516      }
 517  
 518      public Connection getDbConn() {
 519          return dbConn;
 520      }
 521  
 522      public String getTableName() {
 523          return tableName;
 524      }
 525  
 526      public void realIndexesAdd(String index, List&lt;String&gt; fieldes) {
 527          this.realIndexes.put(index, fieldes);
 528      }
 529  
 530      public Map&lt;String,List&lt;String&gt;&gt; getRealIndexes() {
 531          return realIndexes;
 532      }
 533  
 534  
 535      public void setBatchWaitInterval(long batchWaitInterval) {
 536          this.batchWaitInterval = batchWaitInterval;
 537      }
 538  
 539      public List&lt;String&gt; getFullField() {
 540          return fullField;
 541      }
 542  
 543      public void fullFieldAdd(String colName) {
 544          this.fullField.add(colName);
 545      }
 546  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            