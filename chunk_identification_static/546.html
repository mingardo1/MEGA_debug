<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>546</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    546
                    <a href="545.html">prev</a>
                    <a href="547.html">next</a>
                    <a href="546_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_37844f41df13ae43fdf96bea35193ae6991feb67_kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/AbstractKafkaSink.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;37844f41df13ae43fdf96bea35193ae6991feb67:kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/AbstractKafkaSink.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;37844f41df13ae43fdf96bea35193ae6991feb67^1:kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/AbstractKafkaSink.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;37844f41df13ae43fdf96bea35193ae6991feb67^2:kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/AbstractKafkaSink.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;19d27b4360c0ec7e7da465cf964780cc5dcf0c67:kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/AbstractKafkaSink.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.sink.kafka;
  20 
  21 import com.dtstack.flink.sql.sink.IStreamSinkGener;
  22 import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  23 import org.apache.commons.lang3.StringUtils;
  24 import org.apache.flink.api.common.typeinfo.TypeInformation;
  25 import org.apache.flink.api.java.tuple.Tuple2;
  26 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  27 import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  28 import org.apache.flink.streaming.api.datastream.DataStream;
  29 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import org.apache.flink.streaming.api.datastream.DataStreamSink;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import org.apache.flink.streaming.api.functions.sink.SinkFunction;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkKafkaPartitioner;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import org.apache.flink.table.api.TableSchema;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 import org.apache.flink.table.sinks.RetractStreamTableSink;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 import org.apache.flink.table.types.DataType;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39 import org.apache.kafka.clients.consumer.ConsumerConfig;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 import java.util.Optional;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43 import java.util.stream.IntStream;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45 import static org.apache.flink.table.types.utils.TypeConversions.fromLegacyInfoToDataType;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48  * Date: 2020/3/30</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49  * Company: www.dtstack.com</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50  * @author maqi</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52 public abstract class AbstractKafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53     public static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55     protected String[] fieldNames;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56     protected TypeInformation&lt;?&gt;[] fieldTypes;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58     protected String[] partitionKeys;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59     protected String sinkOperatorName;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60     protected Properties properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61     protected int parallelism;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62     protected String topic;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63     protected String tableName;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65     protected TableSchema schema;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66     protected SinkFunction&lt;Tuple2&lt;Boolean,Row&gt;&gt; kafkaProducer011;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68     protected Optional&lt;FlinkKafkaPartitioner&lt;Tuple2&lt;Boolean,Row&gt;&gt;&gt; partitioner;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70     protected Properties getKafkaProperties(KafkaSinkTableInfo KafkaSinkTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71         Properties props = new Properties();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  72         props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaSinkTableInfo.getBootstrapServers());">  72         props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaSinkTableInfo.getBootstrapServersðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74         for (String key : KafkaSinkTableInfo.getKafkaParamKeys()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75             props.setProperty(key, KafkaSinkTableInfo.getKafkaParam(key));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77         return props;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80     protected TypeInformation[] getTypeInformations(KafkaSinkTableInfo kafka11SinkTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81         Class&lt;?&gt;[] fieldClasses = kafka11SinkTableInfo.getFieldClasses();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82         TypeInformation[] types = IntStream.range(0, fieldClasses.length)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83                 .mapToObj(i -&gt; TypeInformation.of(fieldClasses[i]))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84                 .toArray(TypeInformation[]::new);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85         return types;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89     protected TableSchema buildTableSchema(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  90         Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equals fieldTypes length !&quot;);">  90         Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equalðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92         DataType[] dataTypes = IntStream.range(0, fieldTypes.length)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93                 .mapToObj(i -&gt; fromLegacyInfoToDataType(fieldTypes[i]))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94                 .toArray(DataType[]::new);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96         TableSchema tableSchema = TableSchema.builder()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97                 .fields(fieldNames, dataTypes)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98                 .build();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99         return tableSchema;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102     protected String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         if (StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104             return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106         return null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 110     public DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {"> 110     public DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 111         DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStreamSink = dataStream.addSink(kafkaProducer011).name(sinkOperatorName);"> 111         DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStreamSink = dataStream.addSink(kafkaProducer011).name(sðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112         if (parallelism &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113             dataStreamSink.setParallelism(parallelism);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115         return dataStreamSink;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119     public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120         consumeDataStream(dataStream);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 124     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {"> 124     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypesðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125         this.fieldNames = fieldNames;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126         this.fieldTypes = fieldTypes;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127         return this;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131     public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 132         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 132         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136     public TableSchema getTableSchema() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137         return schema;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141     public TypeInformation&lt;Row&gt; getRecordType() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142         return new RowTypeInfo(fieldTypes, fieldNames);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143     }</span>
 144 ||||||| GitAnalyzerPlus_base
 145 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146 import org.apache.flink.streaming.api.functions.sink.SinkFunction;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147 import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkKafkaPartitioner;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148 import org.apache.flink.table.api.TableSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150 import org.apache.flink.table.runtime.types.CRowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151 import org.apache.flink.table.sinks.RetractStreamTableSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155 import org.apache.kafka.clients.consumer.ConsumerConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157 import java.util.Optional;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159 import java.util.stream.IntStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162  * Date: 2020/4/1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164  * @author maqi</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166 public abstract class AbstractKafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168     public static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170     protected String[] fieldNames;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171     protected TypeInformation&lt;?&gt;[] fieldTypes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173     protected String[] partitionKeys;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174     protected String sinkOperatorName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175     protected Properties properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176     protected int parallelism;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177     protected String topic;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178     protected String tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180     protected TableSchema schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181     protected SinkFunction&lt;CRow&gt; kafkaProducer;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184     protected Optional&lt;FlinkKafkaPartitioner&lt;CRow&gt;&gt; partitioner;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186     protected Properties getKafkaProperties(KafkaSinkTableInfo KafkaSinkTableInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187         Properties props = new Properties();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 188         props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaSinkTableInfo.getBootstrapServers());"> 188         props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaSinkTableInfo.getBootstrapServersðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190         for (String key : KafkaSinkTableInfo.getKafkaParamKeys()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191             props.setProperty(key, KafkaSinkTableInfo.getKafkaParam(key));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193         return props;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196     protected TypeInformation[] getTypeInformations(KafkaSinkTableInfo kafka11SinkTableInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197         Class&lt;?&gt;[] fieldClasses = kafka11SinkTableInfo.getFieldClasses();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198         TypeInformation[] types = IntStream.range(0, fieldClasses.length)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199                 .mapToObj(i -&gt; TypeInformation.of(fieldClasses[i]))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200                 .toArray(TypeInformation[]::new);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201         return types;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205     protected TableSchema buildTableSchema(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 206         Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equals fieldTypes length !&quot;);"> 206         Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equalðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208         TableSchema.Builder builder = TableSchema.builder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209         IntStream.range(0, fieldTypes.length)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210                 .forEach(i -&gt; builder.field(fieldNames[i], fieldTypes[i]));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212         return builder.build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217     public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218         DataStream&lt;CRow&gt; mapDataStream = dataStream</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219                 .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; new CRow(record.f1, record.f0))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220                 .returns(getRowTypeInfo())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221                 .setParallelism(parallelism);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223         mapDataStream.addSink(kafkaProducer).name(sinkOperatorName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226     public CRowTypeInfo getRowTypeInfo() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227         return new CRowTypeInfo(new RowTypeInfo(fieldTypes, fieldNames));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230     protected String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231         if (StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232             return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234         return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238     public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 239         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 239         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243     public String[] getFieldNames() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244         return fieldNames;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248     public TypeInformation&lt;?&gt;[] getFieldTypes() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249         return fieldTypes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 253     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {"> 253     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypesðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254         this.fieldNames = fieldNames;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255         this.fieldTypes = fieldTypes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256         return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260     public TypeInformation&lt;Row&gt; getRecordType() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261         return new RowTypeInfo(fieldTypes, fieldNames);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264 </span>
 265 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 266 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.sink.kafka;
  20 
  21 import com.dtstack.flink.sql.sink.IStreamSinkGener;
  22 import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  23 import org.apache.commons.lang3.StringUtils;
  24 import org.apache.flink.api.common.typeinfo.TypeInformation;
  25 import org.apache.flink.api.java.tuple.Tuple2;
  26 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  27 import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  28 import org.apache.flink.streaming.api.datastream.DataStream;
  29 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import org.apache.flink.streaming.api.datastream.DataStreamSink;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import org.apache.flink.streaming.api.functions.sink.SinkFunction;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkKafkaPartitioner;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import org.apache.flink.table.api.TableSchema;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 import org.apache.flink.table.sinks.RetractStreamTableSink;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 import org.apache.flink.table.types.DataType;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39 import org.apache.kafka.clients.consumer.ConsumerConfig;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41 import java.util.Optional;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43 import java.util.stream.IntStream;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45 import static org.apache.flink.table.types.utils.TypeConversions.fromLegacyInfoToDataType;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48  * Date: 2020/3/30</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49  * Company: www.dtstack.com</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50  * @author maqi</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52 public abstract class AbstractKafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53     public static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55     protected String[] fieldNames;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56     protected TypeInformation&lt;?&gt;[] fieldTypes;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58     protected String[] partitionKeys;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59     protected String sinkOperatorName;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60     protected Properties properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61     protected int parallelism;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62     protected String topic;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63     protected String tableName;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65     protected TableSchema schema;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66     protected SinkFunction&lt;Tuple2&lt;Boolean,Row&gt;&gt; kafkaProducer011;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68     protected Optional&lt;FlinkKafkaPartitioner&lt;Tuple2&lt;Boolean,Row&gt;&gt;&gt; partitioner;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70     protected Properties getKafkaProperties(KafkaSinkTableInfo KafkaSinkTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71         Properties props = new Properties();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  72         props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaSinkTableInfo.getBootstrapServers());">  72         props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaSinkTableInfo.getBootstrapServersðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74         for (String key : KafkaSinkTableInfo.getKafkaParamKeys()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75             props.setProperty(key, KafkaSinkTableInfo.getKafkaParam(key));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77         return props;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80     protected TypeInformation[] getTypeInformations(KafkaSinkTableInfo kafka11SinkTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81         Class&lt;?&gt;[] fieldClasses = kafka11SinkTableInfo.getFieldClasses();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82         TypeInformation[] types = IntStream.range(0, fieldClasses.length)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83                 .mapToObj(i -&gt; TypeInformation.of(fieldClasses[i]))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84                 .toArray(TypeInformation[]::new);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85         return types;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89     protected TableSchema buildTableSchema(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  90         Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equals fieldTypes length !&quot;);">  90         Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equalðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92         DataType[] dataTypes = IntStream.range(0, fieldTypes.length)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93                 .mapToObj(i -&gt; fromLegacyInfoToDataType(fieldTypes[i]))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94                 .toArray(DataType[]::new);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96         TableSchema tableSchema = TableSchema.builder()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97                 .fields(fieldNames, dataTypes)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98                 .build();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99         return tableSchema;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102     protected String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         if (StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104             return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106         return null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 110     public DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {"> 110     public DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 111         DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStreamSink = dataStream.addSink(kafkaProducer011).name(sinkOperatorName);"> 111         DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStreamSink = dataStream.addSink(kafkaProducer011).name(sðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112         if (parallelism &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113             dataStreamSink.setParallelism(parallelism);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115         return dataStreamSink;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119     public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120         consumeDataStream(dataStream);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 124     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {"> 124     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypesðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125         this.fieldNames = fieldNames;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126         this.fieldTypes = fieldTypes;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127         return this;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131     public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 132         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 132         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136     public TableSchema getTableSchema() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137         return schema;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141     public TypeInformation&lt;Row&gt; getRecordType() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142         return new RowTypeInfo(fieldTypes, fieldNames);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143     }</span>
 144 ||||||| BASE
 145 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146 import org.apache.flink.streaming.api.functions.sink.SinkFunction;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147 import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkKafkaPartitioner;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148 import org.apache.flink.table.api.TableSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150 import org.apache.flink.table.runtime.types.CRowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151 import org.apache.flink.table.sinks.RetractStreamTableSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152 import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155 import org.apache.kafka.clients.consumer.ConsumerConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157 import java.util.Optional;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159 import java.util.stream.IntStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162  * Date: 2020/4/1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164  * @author maqi</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166 public abstract class AbstractKafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168     public static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170     protected String[] fieldNames;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171     protected TypeInformation&lt;?&gt;[] fieldTypes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173     protected String[] partitionKeys;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174     protected String sinkOperatorName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175     protected Properties properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176     protected int parallelism;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177     protected String topic;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178     protected String tableName;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180     protected TableSchema schema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181     protected SinkFunction&lt;CRow&gt; kafkaProducer;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184     protected Optional&lt;FlinkKafkaPartitioner&lt;CRow&gt;&gt; partitioner;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186     protected Properties getKafkaProperties(KafkaSinkTableInfo KafkaSinkTableInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187         Properties props = new Properties();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 188         props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaSinkTableInfo.getBootstrapServers());"> 188         props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaSinkTableInfo.getBootstrapServersðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190         for (String key : KafkaSinkTableInfo.getKafkaParamKeys()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191             props.setProperty(key, KafkaSinkTableInfo.getKafkaParam(key));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193         return props;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196     protected TypeInformation[] getTypeInformations(KafkaSinkTableInfo kafka11SinkTableInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197         Class&lt;?&gt;[] fieldClasses = kafka11SinkTableInfo.getFieldClasses();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198         TypeInformation[] types = IntStream.range(0, fieldClasses.length)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199                 .mapToObj(i -&gt; TypeInformation.of(fieldClasses[i]))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200                 .toArray(TypeInformation[]::new);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201         return types;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205     protected TableSchema buildTableSchema(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 206         Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equals fieldTypes length !&quot;);"> 206         Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equalðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208         TableSchema.Builder builder = TableSchema.builder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209         IntStream.range(0, fieldTypes.length)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210                 .forEach(i -&gt; builder.field(fieldNames[i], fieldTypes[i]));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212         return builder.build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217     public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218         DataStream&lt;CRow&gt; mapDataStream = dataStream</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219                 .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; new CRow(record.f1, record.f0))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220                 .returns(getRowTypeInfo())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221                 .setParallelism(parallelism);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223         mapDataStream.addSink(kafkaProducer).name(sinkOperatorName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226     public CRowTypeInfo getRowTypeInfo() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227         return new CRowTypeInfo(new RowTypeInfo(fieldTypes, fieldNames));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230     protected String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231         if (StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232             return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234         return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238     public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 239         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 239         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243     public String[] getFieldNames() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244         return fieldNames;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248     public TypeInformation&lt;?&gt;[] getFieldTypes() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249         return fieldTypes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 253     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {"> 253     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypesðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254         this.fieldNames = fieldNames;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255         this.fieldTypes = fieldTypes;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256         return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260     public TypeInformation&lt;Row&gt; getRecordType() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261         return new RowTypeInfo(fieldTypes, fieldNames);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264 </span>
 265 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 266 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.sink.kafka;
  19 
  20 import com.dtstack.flink.sql.sink.IStreamSinkGener;
  21 import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  22 import java.util.Optional;
  23 import java.util.Properties;
  24 import java.util.stream.IntStream;
  25 import org.apache.commons.lang3.StringUtils;
  26 import org.apache.flink.api.common.typeinfo.TypeInformation;
  27 import org.apache.flink.api.java.tuple.Tuple2;
  28 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  29 import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  30 import org.apache.flink.streaming.api.datastream.DataStream;
  31 import org.apache.flink.streaming.api.datastream.DataStreamSink;
  32 import org.apache.flink.streaming.api.functions.sink.SinkFunction;
  33 import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkKafkaPartitioner;
  34 import org.apache.flink.table.api.TableSchema;
  35 import org.apache.flink.table.runtime.types.CRow;
  36 import org.apache.flink.table.runtime.types.CRowTypeInfo;
  37 import org.apache.flink.table.sinks.RetractStreamTableSink;
  38 import org.apache.flink.table.sinks.TableSink;
  39 import org.apache.flink.table.types.DataType;
  40 import org.apache.flink.types.Row;
  41 import org.apache.flink.util.Preconditions;
  42 import org.apache.kafka.clients.consumer.ConsumerConfig;
  43 import static org.apache.flink.table.types.utils.TypeConversions.fromLegacyInfoToDataType;
  44 
  45 
  46 /**
  47  * Date: 2020/3/30
  48  * Company: www.dtstack.com
  49  *
  50  * @author maqi
  51  */
  52 public abstract class AbstractKafkaSink implements RetractStreamTableSink&lt;Row&gt; , IStreamSinkGener {
  53     public static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;
  54 
  55     protected String[] fieldNames;
  56 
  57     protected TypeInformation&lt;?&gt;[] fieldTypes;
  58 
  59     protected String[] partitionKeys;
  60 
  61     protected String sinkOperatorName;
  62 
  63     protected Properties properties;
  64 
  65     protected int parallelism;
  66 
  67     protected String topic;
  68 
  69     protected String tableName;
  70 
  71     protected TableSchema schema;
  72 
  73     protected SinkFunction&lt;Tuple2&lt;Boolean, Row&gt;&gt; kafkaProducer011;
  74 
  75     protected Optional&lt;FlinkKafkaPartitioner&lt;Tuple2&lt;Boolean, Row&gt;&gt;&gt; partitioner;
  76 
  77     protected Properties getKafkaProperties(KafkaSinkTableInfo KafkaSinkTableInfo) {
  78         Properties props = new Properties();
<abbr title="  79         props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaSinkTableInfo.getBootstrapServers());">  79         props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaSinkTableInfo.getBootstrapServersðŸ”µ</abbr>
  80         for (String key : KafkaSinkTableInfo.getKafkaParamKeys()) {
  81             props.setProperty(key, KafkaSinkTableInfo.getKafkaParam(key));
  82         }
  83         return props;
  84     }
  85 
  86     protected TypeInformation[] getTypeInformations(KafkaSinkTableInfo kafka11SinkTableInfo) {
  87         Class&lt;?&gt;[] fieldClasses = kafka11SinkTableInfo.getFieldClasses();
<abbr title="  88         TypeInformation[] types = IntStream.range(0, fieldClasses.length).mapToObj(( i) -&gt; TypeInformation.of(fieldClasses[i])).toArray(TypeInformation[]::new);">  88         TypeInformation[] types = IntStream.range(0, fieldClasses.length).mapToObj(( i) -&gt; TypeInformatioðŸ”µ</abbr>
  89         return types;
  90     }
  91 
  92     protected TableSchema buildTableSchema(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {
<abbr title="  93         Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equals fieldTypes length !&quot;);">  93         Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equalðŸ”µ</abbr>
<abbr title="  94         DataType[] dataTypes = IntStream.range(0, fieldTypes.length).mapToObj(( i) -&gt; fromLegacyInfoToDataType(fieldTypes[i])).toArray(DataType[]::new);">  94         DataType[] dataTypes = IntStream.range(0, fieldTypes.length).mapToObj(( i) -&gt; fromLegacyInfoToDatðŸ”µ</abbr>
  95         TableSchema tableSchema = TableSchema.builder().fields(fieldNames, dataTypes).build();
  96         return tableSchema;
  97     }
  98 
  99     protected String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo) {
 100         if (StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())) {
 101             return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);
 102         }
 103         return null;
 104     }
 105 
 106     @Override
<abbr title=" 107     public DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {"> 107     public DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStðŸ”µ</abbr>
<abbr title=" 108         DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStreamSink = dataStream.addSink(kafkaProducer011).name(sinkOperatorName);"> 108         DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStreamSink = dataStream.addSink(kafkaProducer011).name(sðŸ”µ</abbr>
 109         if (parallelism &gt; 0) {
 110             dataStreamSink.setParallelism(parallelism);
 111         }
 112         return dataStreamSink;
 113     }
 114 
 115     @Override
 116     public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {
 117         consumeDataStream(dataStream);
 118     }
 119 
 120     @Override
<abbr title=" 121     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {"> 121     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypesðŸ”µ</abbr>
 122         this.fieldNames = fieldNames;
 123         this.fieldTypes = fieldTypes;
 124         return this;
 125     }
 126 
 127     @Override
 128     public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {
<abbr title=" 129         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 129         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, ðŸ”µ</abbr>
 130     }
 131 
 132     @Override
 133     public TableSchema getTableSchema() {
 134         return schema;
 135     }
 136 
 137     @Override
 138     public TypeInformation&lt;Row&gt; getRecordType() {
 139         return new RowTypeInfo(fieldTypes, fieldNames);
 140     }
 141 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 + * limitations under the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +package com.dtstack.flink.sql.sink.kafka;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import com.dtstack.flink.sql.sink.IStreamSinkGener;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import org.apache.flink.api.java.typeutils.TupleTypeInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import org.apache.flink.streaming.api.datastream.DataStreamSink;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import org.apache.flink.streaming.api.functions.sink.SinkFunction;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkKafkaPartitioner;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import org.apache.flink.table.api.TableSchema;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.apache.flink.table.sinks.RetractStreamTableSink;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import org.apache.flink.table.types.DataType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import org.apache.kafka.clients.consumer.ConsumerConfig;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import java.util.Optional;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import java.util.Properties;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +import java.util.stream.IntStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +import static org.apache.flink.table.types.utils.TypeConversions.fromLegacyInfoToDataType;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +/**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 + * Date: 2020/3/30</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 + * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 + * @author maqi</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +public abstract class AbstractKafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +    public static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +    protected String[] fieldNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +    protected TypeInformation&lt;?&gt;[] fieldTypes;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +    protected String[] partitionKeys;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +    protected String sinkOperatorName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +    protected Properties properties;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +    protected int parallelism;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +    protected String topic;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +    protected String tableName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +    protected TableSchema schema;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +    protected SinkFunction&lt;Tuple2&lt;Boolean,Row&gt;&gt; kafkaProducer011;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +    protected Optional&lt;FlinkKafkaPartitioner&lt;Tuple2&lt;Boolean,Row&gt;&gt;&gt; partitioner;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    protected Properties getKafkaProperties(KafkaSinkTableInfo KafkaSinkTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +        Properties props = new Properties();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +        props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaSinkTableInfo.getBootstrapServers());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +        for (String key : KafkaSinkTableInfo.getKafkaParamKeys()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +            props.setProperty(key, KafkaSinkTableInfo.getKafkaParam(key));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +        return props;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +    protected TypeInformation[] getTypeInformations(KafkaSinkTableInfo kafka11SinkTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +        Class&lt;?&gt;[] fieldClasses = kafka11SinkTableInfo.getFieldClasses();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +        TypeInformation[] types = IntStream.range(0, fieldClasses.length)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +                .mapToObj(i -&gt; TypeInformation.of(fieldClasses[i]))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +                .toArray(TypeInformation[]::new);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +        return types;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +    protected TableSchema buildTableSchema(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  89 +        Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equals fieldTypes length !&quot;);">  89 +        Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equals fieldTyðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +        DataType[] dataTypes = IntStream.range(0, fieldTypes.length)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +                .mapToObj(i -&gt; fromLegacyInfoToDataType(fieldTypes[i]))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +                .toArray(DataType[]::new);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +        TableSchema tableSchema = TableSchema.builder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +                .fields(fieldNames, dataTypes)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +                .build();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +        return tableSchema;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +    protected String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +        if (StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +            return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +        return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +    public DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 110 +        DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStreamSink = dataStream.addSink(kafkaProducer011).name(sinkOperatorName);"> 110 +        DataStreamSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStreamSink = dataStream.addSink(kafkaProducer011).name(sinkOperatðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +        if (parallelism &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +            dataStreamSink.setParallelism(parallelism);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +        return dataStreamSink;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +    public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        consumeDataStream(dataStream);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +    public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +        this.fieldNames = fieldNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        this.fieldTypes = fieldTypes;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +    public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 131 +        return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 131 +        return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNameðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +    public TableSchema getTableSchema() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +        return schema;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +    public TypeInformation&lt;Row&gt; getRecordType() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +        return new RowTypeInfo(fieldTypes, fieldNames);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +}</span></pre></td>
                            <td><pre><span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   1 +/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 + * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   4 + * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 + * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 + * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 + * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   9 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  11 + *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  12 + * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 + * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 + * limitations under the License.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  19 +package com.dtstack.flink.sql.sink.kafka;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import com.dtstack.flink.sql.sink.IStreamSinkGener;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import org.apache.flink.api.java.typeutils.TupleTypeInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import org.apache.flink.streaming.api.datastream.DataStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import org.apache.flink.streaming.api.functions.sink.SinkFunction;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import org.apache.flink.streaming.connectors.kafka.partitioner.FlinkKafkaPartitioner;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import org.apache.flink.table.api.TableSchema;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.apache.flink.table.runtime.types.CRowTypeInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import org.apache.flink.table.sinks.RetractStreamTableSink;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import org.apache.flink.table.sinks.TableSink;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import org.apache.kafka.clients.consumer.ConsumerConfig;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import java.util.Optional;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import java.util.Properties;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +import java.util.stream.IntStream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +/**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 + * Date: 2020/4/1</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 + * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 + * @author maqi</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 + */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  49 +public abstract class AbstractKafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +    public static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +    protected String[] fieldNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +    protected TypeInformation&lt;?&gt;[] fieldTypes;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +    protected String[] partitionKeys;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +    protected String sinkOperatorName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +    protected Properties properties;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +    protected int parallelism;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +    protected String topic;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +    protected String tableName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +    protected TableSchema schema;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +    protected SinkFunction&lt;CRow&gt; kafkaProducer;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +    protected Optional&lt;FlinkKafkaPartitioner&lt;CRow&gt;&gt; partitioner;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    protected Properties getKafkaProperties(KafkaSinkTableInfo KafkaSinkTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +        Properties props = new Properties();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +        props.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaSinkTableInfo.getBootstrapServers());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +        for (String key : KafkaSinkTableInfo.getKafkaParamKeys()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +            props.setProperty(key, KafkaSinkTableInfo.getKafkaParam(key));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +        return props;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +    protected TypeInformation[] getTypeInformations(KafkaSinkTableInfo kafka11SinkTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +        Class&lt;?&gt;[] fieldClasses = kafka11SinkTableInfo.getFieldClasses();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +        TypeInformation[] types = IntStream.range(0, fieldClasses.length)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +                .mapToObj(i -&gt; TypeInformation.of(fieldClasses[i]))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +                .toArray(TypeInformation[]::new);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +        return types;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +    protected TableSchema buildTableSchema(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  89 +        Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equals fieldTypes length !&quot;);">  89 +        Preconditions.checkArgument(fieldNames.length == fieldTypes.length, &quot;fieldNames length must equals fieldTyðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +        TableSchema.Builder builder = TableSchema.builder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +        IntStream.range(0, fieldTypes.length)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +                .forEach(i -&gt; builder.field(fieldNames[i], fieldTypes[i]));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +        return builder.build();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +    public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +        DataStream&lt;CRow&gt; mapDataStream = dataStream</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +                .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; new CRow(record.f1, record.f0))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +                .returns(getRowTypeInfo())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +                .setParallelism(parallelism);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +        mapDataStream.addSink(kafkaProducer).name(sinkOperatorName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +    public CRowTypeInfo getRowTypeInfo() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +        return new CRowTypeInfo(new RowTypeInfo(fieldTypes, fieldNames));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +    protected String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +        if (StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +            return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +        return null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +    public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 122 +        return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 122 +        return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNameðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +    public String[] getFieldNames() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +        return fieldNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +    public TypeInformation&lt;?&gt;[] getFieldTypes() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +        return fieldTypes;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +    public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +        this.fieldNames = fieldNames;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +        this.fieldTypes = fieldTypes;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +        return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +    public TypeInformation&lt;Row&gt; getRecordType() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +        return new RowTypeInfo(fieldTypes, fieldNames);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +}</span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            