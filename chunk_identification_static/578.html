<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>578</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    578
                    <a href="577.html">prev</a>
                    <a href="579.html">next</a>
                    <a href="578_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_3f89d1e66187447b56be7b8b76e9b09af9b9850d_launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;3f89d1e66187447b56be7b8b76e9b09af9b9850d:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;3f89d1e66187447b56be7b8b76e9b09af9b9850d^1:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;3f89d1e66187447b56be7b8b76e9b09af9b9850d^2:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;b2e4085e6d35798d51707eb23aa215e0e694591e:launcher/src/main/java/com/dtstack/flink/sql/launcher/ClusterClientFactory.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /**
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  * http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.launcher;
  20 
  21 import com.dtstack.flink.sql.enums.ClusterMode;
  22 import com.dtstack.flink.sql.option.Options;
  23 import com.dtstack.flink.sql.util.PluginUtil;
  24 import org.apache.commons.io.Charsets;
  25 import org.apache.commons.lang.StringUtils;
  26 import org.apache.flink.client.program.ClusterClient;
  27 import org.apache.flink.client.program.MiniClusterClient;
  28 import org.apache.flink.configuration.ConfigConstants;
  29 import org.apache.flink.configuration.Configuration;
  30 import org.apache.flink.configuration.GlobalConfiguration;
  31 import org.apache.flink.configuration.JobManagerOptions;
  32 import org.apache.flink.core.fs.FileSystem;
  33 import org.apache.flink.runtime.akka.AkkaUtils;
  34 import org.apache.flink.runtime.minicluster.MiniCluster;
  35 import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;
  36 import org.apache.flink.runtime.util.LeaderConnectionInfo;
  37 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  38 import org.apache.flink.yarn.YarnClusterDescriptor;
  39 import org.apache.hadoop.yarn.api.records.ApplicationId;
  40 import org.apache.hadoop.yarn.api.records.ApplicationReport;
  41 import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  42 import org.apache.hadoop.yarn.client.api.YarnClient;
  43 import org.apache.hadoop.yarn.conf.YarnConfiguration;
  44 import org.apache.hadoop.yarn.util.StringHelper;
  45 
  46 import java.net.InetSocketAddress;
  47 import java.net.URLDecoder;
  48 import java.util.EnumSet;
  49 import java.util.HashSet;
  50 import java.util.Iterator;
  51 import java.util.List;
  52 import java.util.Properties;
  53 import java.util.Set;
  54 
  55 /**
  56  * @author sishu.yss
  57  */
  58 public class ClusterClientFactory {
  59 
  60     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  61         String mode = launcherOptions.getMode();
  62         if (mode.equals(ClusterMode.standalone.name())) {
  63             return createStandaloneClient(launcherOptions);
  64         } else if (mode.equals(ClusterMode.yarn.name())) {
  65             return createYarnSessionClient(launcherOptions);
  66         }
  67         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  68     }
  69 
  70     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  71         String flinkConfDir = launcherOptions.getFlinkconf();
  72         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  73         MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();
  74         configBuilder.setConfiguration(config);
  75         MiniCluster miniCluster = new MiniCluster(configBuilder.build());
  76         MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);
  77         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
<abbr title="  78         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());">  78         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr>
  79         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  80         config.setInteger(JobManagerOptions.PORT, address.getPort());
  81         clusterClient.setDetached(true);
  82         return clusterClient;
  83     }
  84 
  85     public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title="  86         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  86         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.ðŸ”µ</abbr>
<abbr title="  87         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  87         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguratðŸ”µ</abbr>
  88         String yarnConfDir = launcherOptions.getYarnconf();
  89 
  90         if (StringUtils.isNotBlank(yarnConfDir)) {
  91             try {
  92 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93                 config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94                 FileSystem.initialize(config, null);</span>
  95 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96                 config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97                 FileSystem.initialize(config);</span>
  98 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99                 config.setString(&quot;fs.hdfs.hadoopconf&quot;, yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100                 FileSystem.initialize(config);</span>
 101 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 102 
 103                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
 104                 YarnClient yarnClient = YarnClient.createYarnClient();
 105                 yarnClient.init(yarnConf);
 106                 yarnClient.start();
 107                 ApplicationId applicationId = null;
 108 
 109                 String yarnSessionConf = launcherOptions.getYarnSessionConf();
 110                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 111                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 111                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr>
 112                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 113 
 114                 if (null != yid) {
 115                     applicationId = toApplicationId(yid.toString());
 116                 } else {
 117                     applicationId = getYarnClusterApplicationId(yarnClient);
 118                 }
 119 
 120                 System.out.println(&quot;applicationId=&quot; + applicationId.toString());
 121 
 122                 if (StringUtils.isEmpty(applicationId.toString())) {
 123                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 124                 }
 125 
<abbr title=" 126                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 126                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr>
 127                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 128                 clusterClient.setDetached(true);
 129                 return clusterClient;
 130             } catch (Exception e) {
 131                 throw new RuntimeException(e);
 132             }
 133         }else{
 134             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 135         }
 136     }
 137 
 138 
 139     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 140         ApplicationId applicationId = null;
 141 
 142         Set&lt;String&gt; set = new HashSet&lt;&gt;();
 143         set.add(&quot;Apache Flink&quot;);
 144         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 145         enumSet.add(YarnApplicationState.RUNNING);
 146         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 147 
 148         int maxMemory = -1;
 149         int maxCores = -1;
 150         for (ApplicationReport report : reportList) {
 151             if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 152                 continue;
 153             }
 154 
 155             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 156                 continue;
 157             }
 158 
 159             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
<abbr title=" 160             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 160             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr>
 161             if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 162                 maxMemory = thisMemory;
 163                 maxCores = thisCores;
 164                 applicationId = report.getApplicationId();
 165             }
 166 
 167         }
 168 
 169         if (StringUtils.isEmpty(applicationId.toString())) {
 170             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 171         }
 172         return applicationId;
 173     }
 174 
 175     private static ApplicationId toApplicationId(String appIdStr) {
 176         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 177         if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 178             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 178             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr>
 179         } else {
 180             try {
 181                 return toApplicationId(it);
 182             } catch (NumberFormatException e) {
 183                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 184             }
 185         }
 186     }
 187 
 188     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 189         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 190     }
 191 
 192 }</pre></td>
                            <td><pre>   1 /**
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  * http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.launcher;
  20 
  21 import com.dtstack.flink.sql.enums.ClusterMode;
  22 import com.dtstack.flink.sql.option.Options;
  23 import com.dtstack.flink.sql.util.PluginUtil;
  24 import org.apache.commons.io.Charsets;
  25 import org.apache.commons.lang.StringUtils;
  26 import org.apache.flink.client.program.ClusterClient;
  27 import org.apache.flink.client.program.MiniClusterClient;
  28 import org.apache.flink.configuration.ConfigConstants;
  29 import org.apache.flink.configuration.Configuration;
  30 import org.apache.flink.configuration.GlobalConfiguration;
  31 import org.apache.flink.configuration.JobManagerOptions;
  32 import org.apache.flink.core.fs.FileSystem;
  33 import org.apache.flink.runtime.akka.AkkaUtils;
  34 import org.apache.flink.runtime.minicluster.MiniCluster;
  35 import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;
  36 import org.apache.flink.runtime.util.LeaderConnectionInfo;
  37 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  38 import org.apache.flink.yarn.YarnClusterDescriptor;
  39 import org.apache.hadoop.yarn.api.records.ApplicationId;
  40 import org.apache.hadoop.yarn.api.records.ApplicationReport;
  41 import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  42 import org.apache.hadoop.yarn.client.api.YarnClient;
  43 import org.apache.hadoop.yarn.conf.YarnConfiguration;
  44 import org.apache.hadoop.yarn.util.StringHelper;
  45 
  46 import java.net.InetSocketAddress;
  47 import java.net.URLDecoder;
  48 import java.util.EnumSet;
  49 import java.util.HashSet;
  50 import java.util.Iterator;
  51 import java.util.List;
  52 import java.util.Properties;
  53 import java.util.Set;
  54 
  55 /**
  56  * @author sishu.yss
  57  */
  58 public class ClusterClientFactory {
  59 
  60     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  61         String mode = launcherOptions.getMode();
  62         if (mode.equals(ClusterMode.standalone.name())) {
  63             return createStandaloneClient(launcherOptions);
  64         } else if (mode.equals(ClusterMode.yarn.name())) {
  65             return createYarnSessionClient(launcherOptions);
  66         }
  67         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  68     }
  69 
  70     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  71         String flinkConfDir = launcherOptions.getFlinkconf();
  72         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  73         MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();
  74         configBuilder.setConfiguration(config);
  75         MiniCluster miniCluster = new MiniCluster(configBuilder.build());
  76         MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);
  77         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
<abbr title="  78         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());">  78         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr>
  79         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  80         config.setInteger(JobManagerOptions.PORT, address.getPort());
  81         clusterClient.setDetached(true);
  82         return clusterClient;
  83     }
  84 
  85     public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title="  86         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  86         String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.ðŸ”µ</abbr>
<abbr title="  87         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  87         Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguratðŸ”µ</abbr>
  88         String yarnConfDir = launcherOptions.getYarnconf();
  89 
  90         if (StringUtils.isNotBlank(yarnConfDir)) {
  91             try {
  92 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93                 config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94                 FileSystem.initialize(config, null);</span>
  95 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96                 config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97                 FileSystem.initialize(config);</span>
  98 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99                 config.setString(&quot;fs.hdfs.hadoopconf&quot;, yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100                 FileSystem.initialize(config);</span>
 101 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 102 
 103                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
 104                 YarnClient yarnClient = YarnClient.createYarnClient();
 105                 yarnClient.init(yarnConf);
 106                 yarnClient.start();
 107                 ApplicationId applicationId = null;
 108 
 109                 String yarnSessionConf = launcherOptions.getYarnSessionConf();
 110                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 111                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 111                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr>
 112                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 113 
 114                 if (null != yid) {
 115                     applicationId = toApplicationId(yid.toString());
 116                 } else {
 117                     applicationId = getYarnClusterApplicationId(yarnClient);
 118                 }
 119 
 120                 System.out.println(&quot;applicationId=&quot; + applicationId.toString());
 121 
 122                 if (StringUtils.isEmpty(applicationId.toString())) {
 123                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 124                 }
 125 
<abbr title=" 126                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 126                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr>
 127                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 128                 clusterClient.setDetached(true);
 129                 return clusterClient;
 130             } catch (Exception e) {
 131                 throw new RuntimeException(e);
 132             }
 133         }else{
 134             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 135         }
 136     }
 137 
 138 
 139     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 140         ApplicationId applicationId = null;
 141 
 142         Set&lt;String&gt; set = new HashSet&lt;&gt;();
 143         set.add(&quot;Apache Flink&quot;);
 144         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 145         enumSet.add(YarnApplicationState.RUNNING);
 146         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 147 
 148         int maxMemory = -1;
 149         int maxCores = -1;
 150         for (ApplicationReport report : reportList) {
 151             if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 152                 continue;
 153             }
 154 
 155             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 156                 continue;
 157             }
 158 
 159             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
<abbr title=" 160             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 160             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr>
 161             if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 162                 maxMemory = thisMemory;
 163                 maxCores = thisCores;
 164                 applicationId = report.getApplicationId();
 165             }
 166 
 167         }
 168 
 169         if (StringUtils.isEmpty(applicationId.toString())) {
 170             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 171         }
 172         return applicationId;
 173     }
 174 
 175     private static ApplicationId toApplicationId(String appIdStr) {
 176         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 177         if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 178             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 178             throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The validðŸ”µ</abbr>
 179         } else {
 180             try {
 181                 return toApplicationId(it);
 182             } catch (NumberFormatException e) {
 183                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 184             }
 185         }
 186     }
 187 
 188     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 189         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 190     }
 191 
 192 }</pre></td>
                            <td><pre>   1 /**
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  * http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.launcher;
  19 
  20 import com.dtstack.flink.sql.enums.ClusterMode;
  21 import com.dtstack.flink.sql.option.Options;
  22 import com.dtstack.flink.sql.util.PluginUtil;
  23 import java.net.InetSocketAddress;
  24 import java.net.URLDecoder;
  25 import java.util.EnumSet;
  26 import java.util.HashSet;
  27 import java.util.Iterator;
  28 import java.util.List;
  29 import java.util.Properties;
  30 import java.util.Set;
  31 import org.apache.commons.io.Charsets;
  32 import org.apache.commons.lang.StringUtils;
  33 import org.apache.flink.client.program.ClusterClient;
  34 import org.apache.flink.client.program.MiniClusterClient;
  35 import org.apache.flink.configuration.ConfigConstants;
  36 import org.apache.flink.configuration.Configuration;
  37 import org.apache.flink.configuration.GlobalConfiguration;
  38 import org.apache.flink.configuration.JobManagerOptions;
  39 import org.apache.flink.core.fs.FileSystem;
  40 import org.apache.flink.runtime.akka.AkkaUtils;
  41 import org.apache.flink.runtime.minicluster.MiniCluster;
  42 import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;
  43 import org.apache.flink.runtime.util.LeaderConnectionInfo;
  44 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  45 import org.apache.flink.yarn.YarnClusterDescriptor;
  46 import org.apache.hadoop.yarn.api.records.ApplicationId;
  47 import org.apache.hadoop.yarn.api.records.ApplicationReport;
  48 import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  49 import org.apache.hadoop.yarn.client.api.YarnClient;
  50 import org.apache.hadoop.yarn.conf.YarnConfiguration;
  51 import org.apache.hadoop.yarn.util.StringHelper;
  52 
  53 
  54 /**
  55  * @author sishu.yss
  56  */
  57 public class ClusterClientFactory {
  58     public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  59         String mode = launcherOptions.getMode();
  60         if (mode.equals(ClusterMode.standalone.name())) {
  61             return createStandaloneClient(launcherOptions);
  62         } else if (mode.equals(ClusterMode.yarn.name())) {
  63             return createYarnSessionClient(launcherOptions);
  64         }
  65         throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  66     }
  67 
  68     public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  69         String flinkConfDir = launcherOptions.getFlinkconf();
  70         Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  71         MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();
  72         configBuilder.setConfiguration(config);
  73         MiniCluster miniCluster = new MiniCluster(configBuilder.build());
  74         MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);
  75         LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
<abbr title="  76         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());">  76         InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress()ðŸ”µ</abbr>
  77         config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  78         config.setInteger(JobManagerOptions.PORT, address.getPort());
  79         clusterClient.setDetached(true);
  80         return clusterClient;
  81     }
  82 
  83     public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title="  84         String flinkConfDir = (StringUtils.isEmpty(launcherOptions.getFlinkconf())) ? &quot;&quot; : launcherOptions.getFlinkconf();">  84         String flinkConfDir = (StringUtils.isEmpty(launcherOptions.getFlinkconf())) ? &quot;&quot; : launcherOptionðŸ”µ</abbr>
<abbr title="  85         Configuration config = (StringUtils.isEmpty(flinkConfDir)) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  85         Configuration config = (StringUtils.isEmpty(flinkConfDir)) ? new Configuration() : GlobalConfigurðŸ”µ</abbr>
  86         String yarnConfDir = launcherOptions.getYarnconf();
  87         if (StringUtils.isNotBlank(yarnConfDir)) {
  88             try {
  89                 config.setString(&quot;fs.hdfs.hadoopconf&quot;, yarnConfDir);
  90                 FileSystem.initialize(config, null);
  91                 YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
  92                 YarnClient yarnClient = YarnClient.createYarnClient();
  93                 yarnClient.init(yarnConf);
  94                 yarnClient.start();
  95                 ApplicationId applicationId = null;
  96                 String yarnSessionConf = launcherOptions.getYarnSessionConf();
  97                 yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title="  98                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);">  98                 Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, ProperðŸ”µ</abbr>
  99                 Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 100                 if (null != yid) {
 101                     applicationId = toApplicationId(yid.toString());
 102                 } else {
 103                     applicationId = getYarnClusterApplicationId(yarnClient);
 104                 }
 105                 System.out.println(&quot;applicationId=&quot; + applicationId.toString());
 106                 if (StringUtils.isEmpty(applicationId.toString())) {
 107                     throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 108                 }
<abbr title=" 109                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 109                 AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnCðŸ”µ</abbr>
 110                 ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 111                 clusterClient.setDetached(true);
 112                 return clusterClient;
 113             } catch (java.lang.Exception e) {
 114                 throw new RuntimeException(e);
 115             }
 116         } else {
 117             throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 118         }
 119     }
 120 
 121     private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 122         ApplicationId applicationId = null;
 123 
 124         Set&lt;String&gt; set = new HashSet&lt;&gt;();
 125         set.add(&quot;Apache Flink&quot;);
 126         EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 127         enumSet.add(YarnApplicationState.RUNNING);
 128         List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 129 
 130         int maxMemory = -1;
 131         int maxCores = -1;
 132         for (ApplicationReport report : reportList) {
 133             if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 134                 continue;
 135             }
 136 
 137             if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 138                 continue;
 139             }
 140 
 141             int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
<abbr title=" 142             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();"> 142             int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCorðŸ”µ</abbr>
 143             if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 144                 maxMemory = thisMemory;
 145                 maxCores = thisCores;
 146                 applicationId = report.getApplicationId();
 147             }
 148 
 149         }
 150 
 151         if (StringUtils.isEmpty(applicationId.toString())) {
 152             throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 153         }
 154         return applicationId;
 155     }
 156 
 157     private static ApplicationId toApplicationId(String appIdStr) {
 158         Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 159         if (!&quot;application&quot;.equals(it.next())) {
<abbr title=" 160             throw new IllegalArgumentException(((&quot;Invalid ApplicationId prefix: &quot; + appIdStr) + &quot;. The valid ApplicationId should start with prefix &quot;) + &quot;application&quot;);"> 160             throw new IllegalArgumentException(((&quot;Invalid ApplicationId prefix: &quot; + appIdStr) + &quot;. The vaðŸ”µ</abbr>
 161         } else {
 162             try {
 163                 return toApplicationId(it);
 164             } catch (java.lang.NumberFormatException e) {
 165                 throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 166             }
 167         }
 168     }
 169 
 170     private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 171         return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 172     }
 173 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /**
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   * http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.launcher;
  20  
  21  import com.dtstack.flink.sql.enums.ClusterMode;
  22  import com.dtstack.flink.sql.option.Options;
  23  import com.dtstack.flink.sql.util.PluginUtil;
  24  import org.apache.commons.io.Charsets;
  25  import org.apache.commons.lang.StringUtils;
  26  import org.apache.flink.client.program.ClusterClient;
  27  import org.apache.flink.client.program.MiniClusterClient;
  28  import org.apache.flink.configuration.ConfigConstants;
  29  import org.apache.flink.configuration.Configuration;
  30  import org.apache.flink.configuration.GlobalConfiguration;
  31  import org.apache.flink.configuration.JobManagerOptions;
  32  import org.apache.flink.core.fs.FileSystem;
  33  import org.apache.flink.runtime.akka.AkkaUtils;
  34  import org.apache.flink.runtime.minicluster.MiniCluster;
  35  import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;
  36  import org.apache.flink.runtime.util.LeaderConnectionInfo;
  37  import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  38  import org.apache.flink.yarn.YarnClusterDescriptor;
  39  import org.apache.hadoop.yarn.api.records.ApplicationId;
  40  import org.apache.hadoop.yarn.api.records.ApplicationReport;
  41  import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  42  import org.apache.hadoop.yarn.client.api.YarnClient;
  43  import org.apache.hadoop.yarn.conf.YarnConfiguration;
  44  import org.apache.hadoop.yarn.util.StringHelper;
  45  
  46  import java.net.InetSocketAddress;
  47  import java.net.URLDecoder;
  48  import java.util.EnumSet;
  49  import java.util.HashSet;
  50  import java.util.Iterator;
  51  import java.util.List;
  52  import java.util.Properties;
  53  import java.util.Set;
  54  
  55  /**
  56   * @author sishu.yss
  57   */
  58  public class ClusterClientFactory {
  59  
  60      public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  61          String mode = launcherOptions.getMode();
  62          if (mode.equals(ClusterMode.standalone.name())) {
  63              return createStandaloneClient(launcherOptions);
  64          } else if (mode.equals(ClusterMode.yarn.name())) {
  65              return createYarnSessionClient(launcherOptions);
  66          }
  67          throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  68      }
  69  
  70      public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  71          String flinkConfDir = launcherOptions.getFlinkconf();
  72          Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  73          MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();
  74          configBuilder.setConfiguration(config);
  75          MiniCluster miniCluster = new MiniCluster(configBuilder.build());
  76          MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);
  77          LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
  78          InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());
  79          config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  80          config.setInteger(JobManagerOptions.PORT, address.getPort());
  81          clusterClient.setDetached(true);
  82          return clusterClient;
  83      }
  84  
  85      public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title="  86          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  86          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkcðŸ”µ</abbr>
<abbr title="  87          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  87          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadCðŸ”µ</abbr>
  88          String yarnConfDir = launcherOptions.getYarnconf();
  89  
  90          if (StringUtils.isNotBlank(yarnConfDir)) {
  91              try {
  92                  config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -                FileSystem.initialize(config);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +                FileSystem.initialize(config, null);</span>
  95  
  96                  YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
  97                  YarnClient yarnClient = YarnClient.createYarnClient();
  98                  yarnClient.init(yarnConf);
  99                  yarnClient.start();
 100                  ApplicationId applicationId = null;
 101  
 102                  String yarnSessionConf = launcherOptions.getYarnSessionConf();
 103                  yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 104                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 104                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.clasðŸ”µ</abbr>
 105                  Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 106  
 107                  if (null != yid) {
 108                      applicationId = toApplicationId(yid.toString());
 109                  } else {
 110                      applicationId = getYarnClusterApplicationId(yarnClient);
 111                  }
 112  
 113                  System.out.println(&quot;applicationId=&quot; + applicationId.toString());
 114  
 115                  if (StringUtils.isEmpty(applicationId.toString())) {
 116                      throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 117                  }
 118  
<abbr title=" 119                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 119                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinðŸ”µ</abbr>
 120                  ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 121                  clusterClient.setDetached(true);
 122                  return clusterClient;
 123              } catch (Exception e) {
 124                  throw new RuntimeException(e);
 125              }
 126          }else{
 127              throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 128          }
 129      }
 130  
 131  
 132      private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 133          ApplicationId applicationId = null;
 134  
 135          Set&lt;String&gt; set = new HashSet&lt;&gt;();
 136          set.add(&quot;Apache Flink&quot;);
 137          EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 138          enumSet.add(YarnApplicationState.RUNNING);
 139          List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 140  
 141          int maxMemory = -1;
 142          int maxCores = -1;
 143          for (ApplicationReport report : reportList) {
 144              if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 145                  continue;
 146              }
 147  
 148              if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 149                  continue;
 150              }
 151  
 152              int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
 153              int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();
 154              if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 155                  maxMemory = thisMemory;
 156                  maxCores = thisCores;
 157                  applicationId = report.getApplicationId();
 158              }
 159  
 160          }
 161  
 162          if (StringUtils.isEmpty(applicationId.toString())) {
 163              throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 164          }
 165          return applicationId;
 166      }
 167  
 168      private static ApplicationId toApplicationId(String appIdStr) {
 169          Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
 170          if (!(it.next()).equals(&quot;application&quot;)) {

<abbr title=" 171              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 171              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicatðŸ”µ</abbr>
 172          } else {
 173              try {
 174                  return toApplicationId(it);
 175              } catch (NumberFormatException e) {
 176                  throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 177              }
 178          }
 179      }
 180  
 181      private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 182          return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 183      }
 184  
 185  }</pre></td>
                            <td><pre>   1  /**
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   * http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.launcher;
  20  
  21  import com.dtstack.flink.sql.enums.ClusterMode;
  22  import com.dtstack.flink.sql.option.Options;
  23  import com.dtstack.flink.sql.util.PluginUtil;
  24  import org.apache.commons.io.Charsets;
  25  import org.apache.commons.lang.StringUtils;
  26  import org.apache.flink.client.program.ClusterClient;
  27  import org.apache.flink.client.program.MiniClusterClient;
  28  import org.apache.flink.configuration.ConfigConstants;
  29  import org.apache.flink.configuration.Configuration;
  30  import org.apache.flink.configuration.GlobalConfiguration;
  31  import org.apache.flink.configuration.JobManagerOptions;
  32  import org.apache.flink.core.fs.FileSystem;
  33  import org.apache.flink.runtime.akka.AkkaUtils;
  34  import org.apache.flink.runtime.minicluster.MiniCluster;
  35  import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;
  36  import org.apache.flink.runtime.util.LeaderConnectionInfo;
  37  import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  38  import org.apache.flink.yarn.YarnClusterDescriptor;
  39  import org.apache.hadoop.yarn.api.records.ApplicationId;
  40  import org.apache.hadoop.yarn.api.records.ApplicationReport;
  41  import org.apache.hadoop.yarn.api.records.YarnApplicationState;
  42  import org.apache.hadoop.yarn.client.api.YarnClient;
  43  import org.apache.hadoop.yarn.conf.YarnConfiguration;
  44  import org.apache.hadoop.yarn.util.StringHelper;
  45  
  46  import java.net.InetSocketAddress;
  47  import java.net.URLDecoder;
  48  import java.util.EnumSet;
  49  import java.util.HashSet;
  50  import java.util.Iterator;
  51  import java.util.List;
  52  import java.util.Properties;
  53  import java.util.Set;
  54  
  55  /**
  56   * @author sishu.yss
  57   */
  58  public class ClusterClientFactory {
  59  
  60      public static ClusterClient createClusterClient(Options launcherOptions) throws Exception {
  61          String mode = launcherOptions.getMode();
  62          if (mode.equals(ClusterMode.standalone.name())) {
  63              return createStandaloneClient(launcherOptions);
  64          } else if (mode.equals(ClusterMode.yarn.name())) {
  65              return createYarnSessionClient(launcherOptions);
  66          }
  67          throw new IllegalArgumentException(&quot;Unsupported cluster client type: &quot;);
  68      }
  69  
  70      public static ClusterClient createStandaloneClient(Options launcherOptions) throws Exception {
  71          String flinkConfDir = launcherOptions.getFlinkconf();
  72          Configuration config = GlobalConfiguration.loadConfiguration(flinkConfDir);
  73          MiniClusterConfiguration.Builder configBuilder = new MiniClusterConfiguration.Builder();
  74          configBuilder.setConfiguration(config);
  75          MiniCluster miniCluster = new MiniCluster(configBuilder.build());
  76          MiniClusterClient clusterClient = new MiniClusterClient(config, miniCluster);
  77          LeaderConnectionInfo connectionInfo = clusterClient.getClusterConnectionInfo();
  78          InetSocketAddress address = AkkaUtils.getInetSocketAddressFromAkkaURL(connectionInfo.getAddress());
  79          config.setString(JobManagerOptions.ADDRESS, address.getAddress().getHostName());
  80          config.setInteger(JobManagerOptions.PORT, address.getPort());
  81          clusterClient.setDetached(true);
  82          return clusterClient;
  83      }
  84  
  85      public static ClusterClient createYarnSessionClient(Options launcherOptions) {
<abbr title="  86          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkconf();">  86          String flinkConfDir = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? &quot;&quot; : launcherOptions.getFlinkcðŸ”µ</abbr>
<abbr title="  87          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadConfiguration(flinkConfDir);">  87          Configuration config = StringUtils.isEmpty(flinkConfDir) ? new Configuration() : GlobalConfiguration.loadCðŸ”µ</abbr>
  88          String yarnConfDir = launcherOptions.getYarnconf();
  89  
  90          if (StringUtils.isNotBlank(yarnConfDir)) {
  91              try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -                config.setString(ConfigConstants.PATH_HADOOP_CONFIG, yarnConfDir);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +                config.setString(&quot;fs.hdfs.hadoopconf&quot;, yarnConfDir);</span>
  94                  FileSystem.initialize(config);

  95  
  96                  YarnConfiguration yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
  97                  YarnClient yarnClient = YarnClient.createYarnClient();
  98                  yarnClient.init(yarnConf);
  99                  yarnClient.start();
 100                  ApplicationId applicationId = null;
 101  
 102                  String yarnSessionConf = launcherOptions.getYarnSessionConf();
 103                  yarnSessionConf = URLDecoder.decode(yarnSessionConf, Charsets.UTF_8.toString());
<abbr title=" 104                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.class);"> 104                  Properties yarnSessionConfProperties = PluginUtil.jsonStrToObject(yarnSessionConf, Properties.clasðŸ”µ</abbr>
 105                  Object yid = yarnSessionConfProperties.get(&quot;yid&quot;);
 106  
 107                  if (null != yid) {
 108                      applicationId = toApplicationId(yid.toString());
 109                  } else {
 110                      applicationId = getYarnClusterApplicationId(yarnClient);
 111                  }
 112  
 113                  System.out.println(&quot;applicationId=&quot; + applicationId.toString());
 114  
 115                  if (StringUtils.isEmpty(applicationId.toString())) {
 116                      throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 117                  }
 118  
<abbr title=" 119                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinkConfDir, yarnClient, false);"> 119                  AbstractYarnClusterDescriptor clusterDescriptor = new YarnClusterDescriptor(config, yarnConf, flinðŸ”µ</abbr>
 120                  ClusterClient clusterClient = clusterDescriptor.retrieve(applicationId);
 121                  clusterClient.setDetached(true);
 122                  return clusterClient;
 123              } catch (Exception e) {
 124                  throw new RuntimeException(e);
 125              }
 126          }else{
 127              throw new RuntimeException(&quot;yarn mode must set param of &#x27;yarnconf&#x27;!!!&quot;);
 128          }
 129      }
 130  
 131  
 132      private static ApplicationId getYarnClusterApplicationId(YarnClient yarnClient) throws Exception {
 133          ApplicationId applicationId = null;
 134  
 135          Set&lt;String&gt; set = new HashSet&lt;&gt;();
 136          set.add(&quot;Apache Flink&quot;);
 137          EnumSet&lt;YarnApplicationState&gt; enumSet = EnumSet.noneOf(YarnApplicationState.class);
 138          enumSet.add(YarnApplicationState.RUNNING);
 139          List&lt;ApplicationReport&gt; reportList = yarnClient.getApplications(set, enumSet);
 140  
 141          int maxMemory = -1;
 142          int maxCores = -1;
 143          for (ApplicationReport report : reportList) {
 144              if (!report.getName().startsWith(&quot;Flink session&quot;)) {
 145                  continue;
 146              }
 147  
 148              if (!report.getYarnApplicationState().equals(YarnApplicationState.RUNNING)) {
 149                  continue;
 150              }
 151  
 152              int thisMemory = report.getApplicationResourceUsageReport().getNeededResources().getMemory();
 153              int thisCores = report.getApplicationResourceUsageReport().getNeededResources().getVirtualCores();
 154              if (thisMemory &gt; maxMemory || thisMemory == maxMemory &amp;&amp; thisCores &gt; maxCores) {
 155                  maxMemory = thisMemory;
 156                  maxCores = thisCores;
 157                  applicationId = report.getApplicationId();
 158              }
 159  
 160          }
 161  
 162          if (StringUtils.isEmpty(applicationId.toString())) {
 163              throw new RuntimeException(&quot;No flink session found on yarn cluster.&quot;);
 164          }
 165          return applicationId;
 166      }
 167  
 168      private static ApplicationId toApplicationId(String appIdStr) {
 169          Iterator&lt;String&gt; it = StringHelper._split(appIdStr).iterator();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -        if (!(it.next()).equals(&quot;application&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +        if (!&quot;application&quot;.equals(it.next())) {</span>
<abbr title=" 172              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicationId should start with prefix &quot; + &quot;application&quot;);"> 172              throw new IllegalArgumentException(&quot;Invalid ApplicationId prefix: &quot; + appIdStr + &quot;. The valid ApplicatðŸ”µ</abbr>
 173          } else {
 174              try {
 175                  return toApplicationId(it);
 176              } catch (NumberFormatException e) {
 177                  throw new IllegalArgumentException(&quot;Invalid AppAttemptId: &quot; + appIdStr, e);
 178              }
 179          }
 180      }
 181  
 182      private static ApplicationId toApplicationId(Iterator&lt;String&gt; it) throws NumberFormatException {
 183          return ApplicationId.newInstance(Long.parseLong(it.next()), Integer.parseInt(it.next()));
 184      }
 185  
 186  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            