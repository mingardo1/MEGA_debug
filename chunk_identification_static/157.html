<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>157</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    157
                    <a href="156.html">prev</a>
                    <a href="158.html">next</a>
                    <a href="157_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_eb9f6cb33a94b081f79e2544a1b66941dd4c92ad_common/src/main/java/org/broadleafcommerce/common/config/RuntimeEnvironmentPropertiesConfigurer.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;eb9f6cb33a94b081f79e2544a1b66941dd4c92ad:common/src/main/java/org/broadleafcommerce/common/config/RuntimeEnvironmentPropertiesConfigurer.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;eb9f6cb33a94b081f79e2544a1b66941dd4c92ad^1:common/src/main/java/org/broadleafcommerce/common/config/RuntimeEnvironmentPropertiesConfigurer.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;eb9f6cb33a94b081f79e2544a1b66941dd4c92ad^2:common/src/main/java/org/broadleafcommerce/common/config/RuntimeEnvironmentPropertiesConfigurer.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;d09b9b2a8021c50bc75b33a8d780992ffde6095a:common/src/main/java/org/broadleafcommerce/common/config/RuntimeEnvironmentPropertiesConfigurer.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   2 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * #%L</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * %%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * %%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * shall apply.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  16  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  16  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  17  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  17  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * #L%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 package org.broadleafcommerce.common.config;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.broadleafcommerce.common.logging.SupportLogManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.broadleafcommerce.common.logging.SupportLogger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.springframework.beans.BeansException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.springframework.beans.factory.InitializingBean;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.springframework.beans.factory.annotation.Autowired;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.springframework.beans.factory.config.PropertyPlaceholderConfigurer;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.springframework.beans.factory.support.BeanDefinitionRegistry;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.springframework.context.ApplicationContext;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.springframework.core.io.ClassPathResource;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.springframework.core.io.FileSystemResource;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.springframework.core.io.Resource;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.springframework.util.PropertyPlaceholderHelper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.springframework.util.StringValueResolver;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import java.util.Collections;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import java.util.LinkedHashSet;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.util.Map.Entry;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import javax.annotation.PostConstruct;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52  * A property resource configurer that chooses the property file at runtime</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53  * based on the runtime environment.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55  * Used for choosing properties files based on the current runtime environment,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56  * allowing for movement of the same application between multiple runtime</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57  * environments without rebuilding.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59  * The property replacement semantics of this implementation are identical to</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60  * PropertyPlaceholderConfigurer, from which this class inherits. &lt;code&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61  * &lt;pre&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  62  * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiesConfigurer&amp;quot;&amp;gt;">  62  * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  63  *        &amp;lt;property name=&amp;quot;propertyLocation&amp;quot; value=&amp;quot;/WEB-INF/runtime-properties/&amp;quot; /&amp;gt;">  63  *        &amp;lt;property name=&amp;quot;propertyLocation&amp;quot; value=&amp;quot;/WEB-INF/runtime-properties/&amp;quot; /ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64  *        &amp;lt;property name=&amp;quot;environments&amp;quot;&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65  *        &amp;lt;set&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66  *            &amp;lt;value&amp;gt;production&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67  *            &amp;lt;value&amp;gt;staging&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68  *            &amp;lt;value&amp;gt;integration&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69  *            &amp;lt;value&amp;gt;development&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70  *        &amp;lt;/set&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71  *        &amp;lt;/property&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72  *        &amp;lt;property name=&amp;quot;defaultEnvironment&amp;quot; value=&amp;quot;development&amp;quot;/&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73  * &amp;lt;/bean&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74  * &lt;/code&gt; &lt;/pre&gt; The keys of the environment specific properties files are</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75  * compared to ensure that each property file defines the complete set of keys,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76  * in order to avoid environment-specific failures.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78  * An optional RuntimeEnvironmentKeyResolver implementation can be provided,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79  * allowing for customization of how the runtime environment is determined. If</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80  * no implementation is provided, a default of</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81  * SystemPropertyRuntimeEnvironmentKeyResolver is used (which uses the system</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82  * property &#x27;runtime.environment&#x27;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83  * @author &lt;a href=&quot;mailto:chris.lee.9@gmail.com&quot;&gt;Chris Lee&lt;/a&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  84  * @deprecated Instead of using anything around the -Druntime-environment values, you should be using Spring profiles">  84  * @deprecated Instead of using anything around the -Druntime-environment values, you should be using SprðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85  * and properties activated with that via {@link BroadleafEnvironmentConfiguringApplicationListener}.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  88 public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitializingBean {">  88 public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90     private static final Log LOG = LogFactory.getLog(RuntimeEnvironmentPropertiesConfigurer.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91     protected SupportLogger logger = SupportLogManager.getLogger(&quot;UserOverride&quot;, this.getClass());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93     protected static final String SHARED_PROPERTY_OVERRIDE = &quot;property-shared-override&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94     protected static final String PROPERTY_OVERRIDE = &quot;property-override&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96     protected static Set&lt;String&gt; defaultEnvironments = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97     protected static Set&lt;Resource&gt; blcPropertyLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98     protected static Set&lt;Resource&gt; defaultPropertyLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100     static {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101         defaultEnvironments.add(&quot;production&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102         defaultEnvironments.add(&quot;staging&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103         defaultEnvironments.add(&quot;integrationqa&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104         defaultEnvironments.add(&quot;integrationdev&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105         defaultEnvironments.add(&quot;development&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/admin/&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/cms/&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/web/&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/fw/&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         defaultPropertyLocations.add(new ClassPathResource(&quot;runtime-properties/&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116     protected String defaultEnvironment = &quot;development&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117     protected String determinedEnvironment = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118     protected RuntimeEnvironmentKeyResolver keyResolver;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119     protected Set&lt;String&gt; environments = Collections.emptySet();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120     protected Set&lt;Resource&gt; propertyLocations;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121     protected Set&lt;Resource&gt; overridableProperyLocations;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122     protected StringValueResolver stringValueResolver;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124     @Autowired</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125     protected ApplicationContext applicationContext;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127     @PostConstruct</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128     public void init() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 129         String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactory()).getBeanDefinition(&quot;blConfiguration&quot;).getResourceDescription();"> 129         String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 130         LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguration and the RuntimeEnvironmentProperitesConfigurer is deprecated and has unknown side-effects. Remove &quot;"> 130         LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguraðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 131             + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworkCommonPropertySource, ProfileAwarePropertySource or a @PropertySource annotation on an @Configuration class&quot;);"> 131             + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135     public void afterPropertiesSet() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 136         setIgnoreUnresolvablePlaceholders(true); // This default will get overriden by user options if present"> 136         setIgnoreUnresolvablePlaceholders(true); // This default will get overriden by user options if prðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         setNullValue(&quot;@null&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         // If no environment override has been specified, used the default environments</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         if (environments == null || environments.size() == 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141             environments = defaultEnvironments;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         // Prepend the default property locations to the specified property locations (if any)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145         Set&lt;Resource&gt; combinedLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146         if (!CollectionUtils.isEmpty(overridableProperyLocations)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             combinedLocations.addAll(overridableProperyLocations);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150         if (!CollectionUtils.isEmpty(propertyLocations)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             combinedLocations.addAll(propertyLocations);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153         propertyLocations = combinedLocations;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155         if (!environments.contains(defaultEnvironment)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 156             throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in environment list&quot;);"> 156             throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in enviðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159         if (keyResolver == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160             keyResolver = new SystemPropertyRuntimeEnvironmentKeyResolver();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163         String environment = determineEnvironment();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164         ArrayList&lt;Resource&gt; allLocations = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         /* Process configuration in the following order (later files override earlier files</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167          * common-shared.properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168          * [environment]-shared.properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169          * common.properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170          * [environment].properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171          * -Dproperty-override-shared specified value, if any</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172          * -Dproperty-override specified value, if any  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         Set&lt;Set&lt;Resource&gt;&gt; testLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174         testLocations.add(propertyLocations);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175         testLocations.add(defaultPropertyLocations);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         for (Resource resource : createBroadleafResource()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179                 allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183         for (Set&lt;Resource&gt; locations : testLocations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184             for (Resource resource : createSharedCommonResource(locations)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190             for (Resource resource : createSharedPropertiesResource(environment, locations)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196             for (Resource resource : createCommonResource(locations)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202             for (Resource resource : createPropertiesResource(environment, locations)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209         Resource sharedPropertyOverride = createSharedOverrideResource();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210         if (sharedPropertyOverride != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211             allLocations.add(sharedPropertyOverride);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214         Resource propertyOverride = createOverrideResource();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215         if (propertyOverride != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216             allLocations.add(propertyOverride);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219         Properties props = new Properties();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220         for (Resource resource : allLocations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221             if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222                 // We will log source-control managed properties with trace and overrides with info</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223                 if (((resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224                         || LOG.isTraceEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225                     props = new Properties(props);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226                     props.load(resource.getInputStream());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227                     for (Entry&lt;Object, Object&gt; entry : props.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 228                         if (resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)) {"> 228                         if (resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride))ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229                             logger.support(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230                         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231                             LOG.trace(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236                 LOG.debug(&quot;Unable to locate resource: &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240         setLocations(allLocations.toArray(new Resource[] {}));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 243     protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 243     protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244         String fileName = environment.toString().toLowerCase() + &quot;-shared.properties&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246         int index = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248             resources[index] = resource.createRelative(fileName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249             index++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251         return resources;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254     protected Resource[] createBroadleafResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255         Resource[] resources = new Resource[blcPropertyLocations.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256         int index = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257         for (Resource resource : blcPropertyLocations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258             resources[index] = resource.createRelative(&quot;common.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259             index++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261         return resources;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264     protected Resource[] createSharedCommonResource(Set&lt;Resource&gt; locations) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266         int index = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268             resources[index] = resource.createRelative(&quot;common-shared.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269             index++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271         return resources;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 274     protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 274     protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOEðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275         String fileName = environment.toString().toLowerCase() + &quot;.properties&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277         int index = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279             resources[index] = resource.createRelative(fileName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280             index++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282         return resources;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285     protected Resource[] createCommonResource(Set&lt;Resource&gt; locations) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287         int index = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289             resources[index] = resource.createRelative(&quot;common.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290             index++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292         return resources;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295     protected Resource createSharedOverrideResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296         String path = System.getProperty(SHARED_PROPERTY_OVERRIDE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297         return StringUtils.isBlank(path) ? null : new FileSystemResource(path);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300     protected Resource createOverrideResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301         String path = System.getProperty(PROPERTY_OVERRIDE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302         return StringUtils.isBlank(path) ? null : new FileSystemResource(path);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305     public String determineEnvironment() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306         if (determinedEnvironment != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307             return determinedEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309         determinedEnvironment = keyResolver.resolveRuntimeEnvironmentKey();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311         if (determinedEnvironment == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 312             LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27;&quot;);"> 312             LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnviðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313             determinedEnvironment = defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316         return determinedEnvironment.toLowerCase();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 320     protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties props) throws BeansException {"> 320     protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties proðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321         super.processProperties(beanFactoryToProcess, props);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322         stringValueResolver = new PlaceholderResolvingStringValueResolver(props);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326      * Sets the default environment name, used when the runtime environment</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327      * cannot be determined.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329     public void setDefaultEnvironment(String defaultEnvironment) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330         this.defaultEnvironment = defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333     public String getDefaultEnvironment() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334         return defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337     public void setKeyResolver(RuntimeEnvironmentKeyResolver keyResolver) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338         this.keyResolver = keyResolver;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342      * Sets the allowed list of runtime environments</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344     public void setEnvironments(Set&lt;String&gt; environments) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345         this.environments = environments;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349      * Sets the directory from which to read environment-specific properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350      * files; note that it must end with a &#x27;/&#x27;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352     public void setPropertyLocations(Set&lt;Resource&gt; propertyLocations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353         this.propertyLocations = propertyLocations;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357      * Sets the directory from which to read environment-specific properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358      * files; note that it must end with a &#x27;/&#x27;. Note, these properties may be</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359      * overridden by those defined in propertyLocations and any &quot;runtime-properties&quot; directories</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361      * @param overridableProperyLocations location containing overridable environment properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363     public void setOverridableProperyLocations(Set&lt;Resource&gt; overridableProperyLocations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364         this.overridableProperyLocations = overridableProperyLocations;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367     private class PlaceholderResolvingStringValueResolver implements StringValueResolver {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369         private final PropertyPlaceholderHelper helper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371         private final PropertyPlaceholderHelper.PlaceholderResolver resolver;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373         public PlaceholderResolvingStringValueResolver(Properties props) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374             this.helper = new PropertyPlaceholderHelper(&quot;${&quot;, &quot;}&quot;, &quot;:&quot;, true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375             this.resolver = new PropertyPlaceholderConfigurerResolver(props);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379         public String resolveStringValue(String strVal) throws BeansException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380             String value = this.helper.replacePlaceholders(strVal, this.resolver);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381             return (value.equals(&quot;&quot;) ? null : value);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 385     private class PropertyPlaceholderConfigurerResolver implements PropertyPlaceholderHelper.PlaceholderResolver {"> 385     private class PropertyPlaceholderConfigurerResolver implements PropertyPlaceholderHelper.PlaceholderRðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387         private final Properties props;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389         private PropertyPlaceholderConfigurerResolver(Properties props) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390             this.props = props;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394         public String resolvePlaceholder(String placeholderName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 395             return RuntimeEnvironmentPropertiesConfigurer.this.resolvePlaceholder(placeholderName, props, 1);"> 395             return RuntimeEnvironmentPropertiesConfigurer.this.resolvePlaceholder(placeholderName, props,ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399     public StringValueResolver getStringValueResolver() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400         return stringValueResolver;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402 }</span>
 403 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404 /*-</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405  * #%L</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408  * Copyright (C) 2009 - 2022 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415  * shall apply.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416  * </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 417  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)"> 417  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 418  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license."> 418  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419  * #L%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 package org.broadleafcommerce.common.config;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427 import org.broadleafcommerce.common.logging.SupportLogManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 import org.broadleafcommerce.common.logging.SupportLogger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429 import org.springframework.beans.BeansException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430 import org.springframework.beans.factory.InitializingBean;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431 import org.springframework.beans.factory.annotation.Autowired;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432 import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433 import org.springframework.beans.factory.config.PropertyPlaceholderConfigurer;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434 import org.springframework.beans.factory.support.BeanDefinitionRegistry;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435 import org.springframework.context.ApplicationContext;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436 import org.springframework.core.io.ClassPathResource;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437 import org.springframework.core.io.FileSystemResource;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438 import org.springframework.core.io.Resource;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439 import org.springframework.util.PropertyPlaceholderHelper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440 import org.springframework.util.StringValueResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444 import java.util.Collections;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445 import java.util.LinkedHashSet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446 import java.util.Map.Entry;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450 import javax.annotation.PostConstruct;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453  * A property resource configurer that chooses the property file at runtime</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454  * based on the runtime environment.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456  * Used for choosing properties files based on the current runtime environment,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457  * allowing for movement of the same application between multiple runtime</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458  * environments without rebuilding.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460  * The property replacement semantics of this implementation are identical to</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461  * PropertyPlaceholderConfigurer, from which this class inherits. &lt;code&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462  * &lt;pre&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 463  * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiesConfigurer&amp;quot;&amp;gt;"> 463  * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 464  *        &amp;lt;property name=&amp;quot;propertyLocation&amp;quot; value=&amp;quot;/WEB-INF/runtime-properties/&amp;quot; /&amp;gt;"> 464  *        &amp;lt;property name=&amp;quot;propertyLocation&amp;quot; value=&amp;quot;/WEB-INF/runtime-properties/&amp;quot; /ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465  *        &amp;lt;property name=&amp;quot;environments&amp;quot;&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466  *        &amp;lt;set&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467  *            &amp;lt;value&amp;gt;production&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468  *            &amp;lt;value&amp;gt;staging&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469  *            &amp;lt;value&amp;gt;integration&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470  *            &amp;lt;value&amp;gt;development&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471  *        &amp;lt;/set&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472  *        &amp;lt;/property&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473  *        &amp;lt;property name=&amp;quot;defaultEnvironment&amp;quot; value=&amp;quot;development&amp;quot;/&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474  * &amp;lt;/bean&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475  * &lt;/code&gt; &lt;/pre&gt; The keys of the environment specific properties files are</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476  * compared to ensure that each property file defines the complete set of keys,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477  * in order to avoid environment-specific failures.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479  * An optional RuntimeEnvironmentKeyResolver implementation can be provided,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480  * allowing for customization of how the runtime environment is determined. If</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481  * no implementation is provided, a default of</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482  * SystemPropertyRuntimeEnvironmentKeyResolver is used (which uses the system</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483  * property &#x27;runtime.environment&#x27;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484  * @author &lt;a href=&quot;mailto:chris.lee.9@gmail.com&quot;&gt;Chris Lee&lt;/a&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 485  * @deprecated Instead of using anything around the -Druntime-environment values, you should be using Spring profiles"> 485  * @deprecated Instead of using anything around the -Druntime-environment values, you should be using SprðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486  * and properties activated with that via {@link BroadleafEnvironmentConfiguringApplicationListener}.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488 @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 489 public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitializingBean {"> 489 public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491     private static final Log LOG = LogFactory.getLog(RuntimeEnvironmentPropertiesConfigurer.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492     protected SupportLogger logger = SupportLogManager.getLogger(&quot;UserOverride&quot;, this.getClass());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494     protected static final String SHARED_PROPERTY_OVERRIDE = &quot;property-shared-override&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495     protected static final String PROPERTY_OVERRIDE = &quot;property-override&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497     protected static Set&lt;String&gt; defaultEnvironments = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498     protected static Set&lt;Resource&gt; blcPropertyLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499     protected static Set&lt;Resource&gt; defaultPropertyLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501     static {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502         defaultEnvironments.add(&quot;production&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503         defaultEnvironments.add(&quot;staging&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504         defaultEnvironments.add(&quot;integrationqa&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505         defaultEnvironments.add(&quot;integrationdev&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506         defaultEnvironments.add(&quot;development&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507         </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/admin/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/cms/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/web/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/fw/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513         </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514         defaultPropertyLocations.add(new ClassPathResource(&quot;runtime-properties/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517     protected String defaultEnvironment = &quot;development&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518     protected String determinedEnvironment = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519     protected RuntimeEnvironmentKeyResolver keyResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520     protected Set&lt;String&gt; environments = Collections.emptySet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521     protected Set&lt;Resource&gt; propertyLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522     protected Set&lt;Resource&gt; overridableProperyLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523     protected StringValueResolver stringValueResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525     @Autowired</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526     protected ApplicationContext applicationContext;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528     @PostConstruct</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529     public void init() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 530         String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactory()).getBeanDefinition(&quot;blConfiguration&quot;).getResourceDescription();"> 530         String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 531         LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguration and the RuntimeEnvironmentProperitesConfigurer is deprecated and has unknown side-effects. Remove &quot;"> 531         LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguraðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 532             + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworkCommonPropertySource, ProfileAwarePropertySource or a @PropertySource annotation on an @Configuration class&quot;);"> 532             + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536     public void afterPropertiesSet() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 537         setIgnoreUnresolvablePlaceholders(true); // This default will get overriden by user options if present"> 537         setIgnoreUnresolvablePlaceholders(true); // This default will get overriden by user options if prðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538         setNullValue(&quot;@null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539         </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540         // If no environment override has been specified, used the default environments</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541         if (environments == null || environments.size() == 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542             environments = defaultEnvironments;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544         </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545         // Prepend the default property locations to the specified property locations (if any)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546         Set&lt;Resource&gt; combinedLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547         if (!CollectionUtils.isEmpty(overridableProperyLocations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548             combinedLocations.addAll(overridableProperyLocations);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551         if (!CollectionUtils.isEmpty(propertyLocations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552             combinedLocations.addAll(propertyLocations);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554         propertyLocations = combinedLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556         if (!environments.contains(defaultEnvironment)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 557             throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in environment list&quot;);"> 557             throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in enviðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560         if (keyResolver == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561             keyResolver = new SystemPropertyRuntimeEnvironmentKeyResolver();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564         String environment = determineEnvironment();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565         ArrayList&lt;Resource&gt; allLocations = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566         </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567         /* Process configuration in the following order (later files override earlier files</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568          * common-shared.properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569          * [environment]-shared.properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570          * common.properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571          * [environment].properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572          * -Dproperty-override-shared specified value, if any</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573          * -Dproperty-override specified value, if any  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574         Set&lt;Set&lt;Resource&gt;&gt; testLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575         testLocations.add(propertyLocations);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576         testLocations.add(defaultPropertyLocations);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578         for (Resource resource : createBroadleafResource()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579             if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580                 allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584         for (Set&lt;Resource&gt; locations : testLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585             for (Resource resource : createSharedCommonResource(locations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591             for (Resource resource : createSharedPropertiesResource(environment, locations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597             for (Resource resource : createCommonResource(locations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603             for (Resource resource : createPropertiesResource(environment, locations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610         Resource sharedPropertyOverride = createSharedOverrideResource();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611         if (sharedPropertyOverride != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612             allLocations.add(sharedPropertyOverride);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614         </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615         Resource propertyOverride = createOverrideResource();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616         if (propertyOverride != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617             allLocations.add(propertyOverride);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619         </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620         Properties props = new Properties();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621         for (Resource resource : allLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622             if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623                 // We will log source-control managed properties with trace and overrides with info</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624                 if (((resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625                         || LOG.isTraceEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626                     props = new Properties(props);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627                     props.load(resource.getInputStream());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628                     for (Entry&lt;Object, Object&gt; entry : props.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 629                         if (resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)) {"> 629                         if (resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride))ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630                             logger.support(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631                         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632                             LOG.trace(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637                 LOG.debug(&quot;Unable to locate resource: &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641         setLocations(allLocations.toArray(new Resource[] {}));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 644     protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 644     protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645         String fileName = environment.toString().toLowerCase() + &quot;-shared.properties&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649             resources[index] = resource.createRelative(fileName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655     protected Resource[] createBroadleafResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656         Resource[] resources = new Resource[blcPropertyLocations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658         for (Resource resource : blcPropertyLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659             resources[index] = resource.createRelative(&quot;common.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665     protected Resource[] createSharedCommonResource(Set&lt;Resource&gt; locations) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669             resources[index] = resource.createRelative(&quot;common-shared.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 675     protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 675     protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOEðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676         String fileName = environment.toString().toLowerCase() + &quot;.properties&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680             resources[index] = resource.createRelative(fileName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686     protected Resource[] createCommonResource(Set&lt;Resource&gt; locations) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690             resources[index] = resource.createRelative(&quot;common.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696     protected Resource createSharedOverrideResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697         String path = System.getProperty(SHARED_PROPERTY_OVERRIDE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698         return StringUtils.isBlank(path) ? null : new FileSystemResource(path);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701     protected Resource createOverrideResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702         String path = System.getProperty(PROPERTY_OVERRIDE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703         return StringUtils.isBlank(path) ? null : new FileSystemResource(path);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706     public String determineEnvironment() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707         if (determinedEnvironment != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708             return determinedEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710         determinedEnvironment = keyResolver.resolveRuntimeEnvironmentKey();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712         if (determinedEnvironment == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 713             LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27;&quot;);"> 713             LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnviðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714             determinedEnvironment = defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717         return determinedEnvironment.toLowerCase();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 721     protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties props) throws BeansException {"> 721     protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties proðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722         super.processProperties(beanFactoryToProcess, props);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723         stringValueResolver = new PlaceholderResolvingStringValueResolver(props);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727      * Sets the default environment name, used when the runtime environment</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728      * cannot be determined.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730     public void setDefaultEnvironment(String defaultEnvironment) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731         this.defaultEnvironment = defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734     public String getDefaultEnvironment() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735         return defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 738     public void setKeyResolver(RuntimeEnvironmentKeyResolver keyResolver) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 739         this.keyResolver = keyResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 740     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 741 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 742     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 743      * Sets the allowed list of runtime environments</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 744      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 745     public void setEnvironments(Set&lt;String&gt; environments) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 746         this.environments = environments;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 747     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 748 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 749     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 750      * Sets the directory from which to read environment-specific properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 751      * files; note that it must end with a &#x27;/&#x27;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 752      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 753     public void setPropertyLocations(Set&lt;Resource&gt; propertyLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 754         this.propertyLocations = propertyLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 755     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 756 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 757     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 758      * Sets the directory from which to read environment-specific properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 759      * files; note that it must end with a &#x27;/&#x27;. Note, these properties may be</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 760      * overridden by those defined in propertyLocations and any &quot;runtime-properties&quot; directories</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 761      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 762      * @param overridableProperyLocations location containing overridable environment properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 763      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 764     public void setOverridableProperyLocations(Set&lt;Resource&gt; overridableProperyLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 765         this.overridableProperyLocations = overridableProperyLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 766     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 767 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 768     private class PlaceholderResolvingStringValueResolver implements StringValueResolver {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 769 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 770         private final PropertyPlaceholderHelper helper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 771 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 772         private final PropertyPlaceholderHelper.PlaceholderResolver resolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 773 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 774         public PlaceholderResolvingStringValueResolver(Properties props) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 775             this.helper = new PropertyPlaceholderHelper(&quot;${&quot;, &quot;}&quot;, &quot;:&quot;, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 776             this.resolver = new PropertyPlaceholderConfigurerResolver(props);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 777         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 778 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 779         @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 780         public String resolveStringValue(String strVal) throws BeansException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 781             String value = this.helper.replacePlaceholders(strVal, this.resolver);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 782             return (value.equals(&quot;&quot;) ? null : value);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 783         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 784     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 785 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 786     private class PropertyPlaceholderConfigurerResolver implements PropertyPlaceholderHelper.PlaceholderResolver {"> 786     private class PropertyPlaceholderConfigurerResolver implements PropertyPlaceholderHelper.PlaceholderRðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 787 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 788         private final Properties props;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 789 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 790         private PropertyPlaceholderConfigurerResolver(Properties props) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 791             this.props = props;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 792         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 793 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 794         @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 795         public String resolvePlaceholder(String placeholderName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 796             return RuntimeEnvironmentPropertiesConfigurer.this.resolvePlaceholder(placeholderName, props, 1);"> 796             return RuntimeEnvironmentPropertiesConfigurer.this.resolvePlaceholder(placeholderName, props,ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 797         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 798     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 799 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 800     public StringValueResolver getStringValueResolver() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 801         return stringValueResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 802     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 803 }</span>
 804 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * #%L</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * %%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * %%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * shall apply.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  16  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  16  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  17  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  17  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * #L%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 package org.broadleafcommerce.common.config;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.broadleafcommerce.common.logging.SupportLogManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.broadleafcommerce.common.logging.SupportLogger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.springframework.beans.BeansException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.springframework.beans.factory.InitializingBean;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.springframework.beans.factory.annotation.Autowired;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.springframework.beans.factory.config.PropertyPlaceholderConfigurer;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.springframework.beans.factory.support.BeanDefinitionRegistry;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.springframework.context.ApplicationContext;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.springframework.core.io.ClassPathResource;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.springframework.core.io.FileSystemResource;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.springframework.core.io.Resource;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.springframework.util.PropertyPlaceholderHelper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.springframework.util.StringValueResolver;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import java.util.Collections;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import java.util.LinkedHashSet;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.util.Map.Entry;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import javax.annotation.PostConstruct;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52  * A property resource configurer that chooses the property file at runtime</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53  * based on the runtime environment.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55  * Used for choosing properties files based on the current runtime environment,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56  * allowing for movement of the same application between multiple runtime</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57  * environments without rebuilding.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59  * The property replacement semantics of this implementation are identical to</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60  * PropertyPlaceholderConfigurer, from which this class inherits. &lt;code&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61  * &lt;pre&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  62  * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiesConfigurer&amp;quot;&amp;gt;">  62  * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  63  *        &amp;lt;property name=&amp;quot;propertyLocation&amp;quot; value=&amp;quot;/WEB-INF/runtime-properties/&amp;quot; /&amp;gt;">  63  *        &amp;lt;property name=&amp;quot;propertyLocation&amp;quot; value=&amp;quot;/WEB-INF/runtime-properties/&amp;quot; /ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64  *        &amp;lt;property name=&amp;quot;environments&amp;quot;&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65  *        &amp;lt;set&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66  *            &amp;lt;value&amp;gt;production&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67  *            &amp;lt;value&amp;gt;staging&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68  *            &amp;lt;value&amp;gt;integration&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69  *            &amp;lt;value&amp;gt;development&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70  *        &amp;lt;/set&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71  *        &amp;lt;/property&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72  *        &amp;lt;property name=&amp;quot;defaultEnvironment&amp;quot; value=&amp;quot;development&amp;quot;/&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73  * &amp;lt;/bean&amp;gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74  * &lt;/code&gt; &lt;/pre&gt; The keys of the environment specific properties files are</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75  * compared to ensure that each property file defines the complete set of keys,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76  * in order to avoid environment-specific failures.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78  * An optional RuntimeEnvironmentKeyResolver implementation can be provided,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79  * allowing for customization of how the runtime environment is determined. If</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80  * no implementation is provided, a default of</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81  * SystemPropertyRuntimeEnvironmentKeyResolver is used (which uses the system</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82  * property &#x27;runtime.environment&#x27;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83  * @author &lt;a href=&quot;mailto:chris.lee.9@gmail.com&quot;&gt;Chris Lee&lt;/a&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  84  * @deprecated Instead of using anything around the -Druntime-environment values, you should be using Spring profiles">  84  * @deprecated Instead of using anything around the -Druntime-environment values, you should be using SprðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85  * and properties activated with that via {@link BroadleafEnvironmentConfiguringApplicationListener}.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  88 public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitializingBean {">  88 public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90     private static final Log LOG = LogFactory.getLog(RuntimeEnvironmentPropertiesConfigurer.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91     protected SupportLogger logger = SupportLogManager.getLogger(&quot;UserOverride&quot;, this.getClass());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93     protected static final String SHARED_PROPERTY_OVERRIDE = &quot;property-shared-override&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94     protected static final String PROPERTY_OVERRIDE = &quot;property-override&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96     protected static Set&lt;String&gt; defaultEnvironments = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97     protected static Set&lt;Resource&gt; blcPropertyLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98     protected static Set&lt;Resource&gt; defaultPropertyLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100     static {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101         defaultEnvironments.add(&quot;production&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102         defaultEnvironments.add(&quot;staging&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103         defaultEnvironments.add(&quot;integrationqa&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104         defaultEnvironments.add(&quot;integrationdev&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105         defaultEnvironments.add(&quot;development&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/admin/&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/cms/&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/web/&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/fw/&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         defaultPropertyLocations.add(new ClassPathResource(&quot;runtime-properties/&quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116     protected String defaultEnvironment = &quot;development&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117     protected String determinedEnvironment = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118     protected RuntimeEnvironmentKeyResolver keyResolver;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119     protected Set&lt;String&gt; environments = Collections.emptySet();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120     protected Set&lt;Resource&gt; propertyLocations;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121     protected Set&lt;Resource&gt; overridableProperyLocations;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122     protected StringValueResolver stringValueResolver;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124     @Autowired</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125     protected ApplicationContext applicationContext;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127     @PostConstruct</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128     public void init() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 129         String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactory()).getBeanDefinition(&quot;blConfiguration&quot;).getResourceDescription();"> 129         String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 130         LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguration and the RuntimeEnvironmentProperitesConfigurer is deprecated and has unknown side-effects. Remove &quot;"> 130         LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguraðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 131             + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworkCommonPropertySource, ProfileAwarePropertySource or a @PropertySource annotation on an @Configuration class&quot;);"> 131             + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135     public void afterPropertiesSet() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 136         setIgnoreUnresolvablePlaceholders(true); // This default will get overriden by user options if present"> 136         setIgnoreUnresolvablePlaceholders(true); // This default will get overriden by user options if prðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         setNullValue(&quot;@null&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         // If no environment override has been specified, used the default environments</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         if (environments == null || environments.size() == 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141             environments = defaultEnvironments;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         // Prepend the default property locations to the specified property locations (if any)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145         Set&lt;Resource&gt; combinedLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146         if (!CollectionUtils.isEmpty(overridableProperyLocations)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             combinedLocations.addAll(overridableProperyLocations);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150         if (!CollectionUtils.isEmpty(propertyLocations)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             combinedLocations.addAll(propertyLocations);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153         propertyLocations = combinedLocations;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155         if (!environments.contains(defaultEnvironment)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 156             throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in environment list&quot;);"> 156             throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in enviðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159         if (keyResolver == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160             keyResolver = new SystemPropertyRuntimeEnvironmentKeyResolver();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163         String environment = determineEnvironment();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164         ArrayList&lt;Resource&gt; allLocations = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         /* Process configuration in the following order (later files override earlier files</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167          * common-shared.properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168          * [environment]-shared.properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169          * common.properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170          * [environment].properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171          * -Dproperty-override-shared specified value, if any</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172          * -Dproperty-override specified value, if any  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         Set&lt;Set&lt;Resource&gt;&gt; testLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174         testLocations.add(propertyLocations);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175         testLocations.add(defaultPropertyLocations);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         for (Resource resource : createBroadleafResource()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179                 allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183         for (Set&lt;Resource&gt; locations : testLocations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184             for (Resource resource : createSharedCommonResource(locations)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190             for (Resource resource : createSharedPropertiesResource(environment, locations)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196             for (Resource resource : createCommonResource(locations)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202             for (Resource resource : createPropertiesResource(environment, locations)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209         Resource sharedPropertyOverride = createSharedOverrideResource();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210         if (sharedPropertyOverride != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211             allLocations.add(sharedPropertyOverride);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214         Resource propertyOverride = createOverrideResource();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215         if (propertyOverride != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216             allLocations.add(propertyOverride);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219         Properties props = new Properties();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220         for (Resource resource : allLocations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221             if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222                 // We will log source-control managed properties with trace and overrides with info</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223                 if (((resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224                         || LOG.isTraceEnabled()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225                     props = new Properties(props);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226                     props.load(resource.getInputStream());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227                     for (Entry&lt;Object, Object&gt; entry : props.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 228                         if (resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)) {"> 228                         if (resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride))ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229                             logger.support(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230                         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231                             LOG.trace(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236                 LOG.debug(&quot;Unable to locate resource: &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240         setLocations(allLocations.toArray(new Resource[] {}));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 243     protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 243     protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244         String fileName = environment.toString().toLowerCase() + &quot;-shared.properties&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246         int index = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248             resources[index] = resource.createRelative(fileName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249             index++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251         return resources;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254     protected Resource[] createBroadleafResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255         Resource[] resources = new Resource[blcPropertyLocations.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256         int index = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257         for (Resource resource : blcPropertyLocations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258             resources[index] = resource.createRelative(&quot;common.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259             index++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261         return resources;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264     protected Resource[] createSharedCommonResource(Set&lt;Resource&gt; locations) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266         int index = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268             resources[index] = resource.createRelative(&quot;common-shared.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269             index++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271         return resources;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 274     protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 274     protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOEðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275         String fileName = environment.toString().toLowerCase() + &quot;.properties&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277         int index = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279             resources[index] = resource.createRelative(fileName);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280             index++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282         return resources;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285     protected Resource[] createCommonResource(Set&lt;Resource&gt; locations) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287         int index = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289             resources[index] = resource.createRelative(&quot;common.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290             index++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292         return resources;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295     protected Resource createSharedOverrideResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296         String path = System.getProperty(SHARED_PROPERTY_OVERRIDE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297         return StringUtils.isBlank(path) ? null : new FileSystemResource(path);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300     protected Resource createOverrideResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301         String path = System.getProperty(PROPERTY_OVERRIDE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302         return StringUtils.isBlank(path) ? null : new FileSystemResource(path);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305     public String determineEnvironment() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306         if (determinedEnvironment != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307             return determinedEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309         determinedEnvironment = keyResolver.resolveRuntimeEnvironmentKey();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311         if (determinedEnvironment == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 312             LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27;&quot;);"> 312             LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnviðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313             determinedEnvironment = defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316         return determinedEnvironment.toLowerCase();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 320     protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties props) throws BeansException {"> 320     protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties proðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321         super.processProperties(beanFactoryToProcess, props);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322         stringValueResolver = new PlaceholderResolvingStringValueResolver(props);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326      * Sets the default environment name, used when the runtime environment</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327      * cannot be determined.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329     public void setDefaultEnvironment(String defaultEnvironment) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330         this.defaultEnvironment = defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333     public String getDefaultEnvironment() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334         return defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337     public void setKeyResolver(RuntimeEnvironmentKeyResolver keyResolver) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338         this.keyResolver = keyResolver;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342      * Sets the allowed list of runtime environments</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344     public void setEnvironments(Set&lt;String&gt; environments) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345         this.environments = environments;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349      * Sets the directory from which to read environment-specific properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350      * files; note that it must end with a &#x27;/&#x27;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352     public void setPropertyLocations(Set&lt;Resource&gt; propertyLocations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353         this.propertyLocations = propertyLocations;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357      * Sets the directory from which to read environment-specific properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358      * files; note that it must end with a &#x27;/&#x27;. Note, these properties may be</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359      * overridden by those defined in propertyLocations and any &quot;runtime-properties&quot; directories</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361      * @param overridableProperyLocations location containing overridable environment properties</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363     public void setOverridableProperyLocations(Set&lt;Resource&gt; overridableProperyLocations) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364         this.overridableProperyLocations = overridableProperyLocations;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367     private class PlaceholderResolvingStringValueResolver implements StringValueResolver {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369         private final PropertyPlaceholderHelper helper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371         private final PropertyPlaceholderHelper.PlaceholderResolver resolver;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373         public PlaceholderResolvingStringValueResolver(Properties props) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374             this.helper = new PropertyPlaceholderHelper(&quot;${&quot;, &quot;}&quot;, &quot;:&quot;, true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375             this.resolver = new PropertyPlaceholderConfigurerResolver(props);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379         public String resolveStringValue(String strVal) throws BeansException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380             String value = this.helper.replacePlaceholders(strVal, this.resolver);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381             return (value.equals(&quot;&quot;) ? null : value);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 385     private class PropertyPlaceholderConfigurerResolver implements PropertyPlaceholderHelper.PlaceholderResolver {"> 385     private class PropertyPlaceholderConfigurerResolver implements PropertyPlaceholderHelper.PlaceholderRðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387         private final Properties props;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389         private PropertyPlaceholderConfigurerResolver(Properties props) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390             this.props = props;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394         public String resolvePlaceholder(String placeholderName) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 395             return RuntimeEnvironmentPropertiesConfigurer.this.resolvePlaceholder(placeholderName, props, 1);"> 395             return RuntimeEnvironmentPropertiesConfigurer.this.resolvePlaceholder(placeholderName, props,ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399     public StringValueResolver getStringValueResolver() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400         return stringValueResolver;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402 }</span>
 403 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404 /*-</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405  * #%L</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408  * Copyright (C) 2009 - 2022 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415  * shall apply.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 417  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)"> 417  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 418  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license."> 418  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419  * #L%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 package org.broadleafcommerce.common.config;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427 import org.broadleafcommerce.common.logging.SupportLogManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 import org.broadleafcommerce.common.logging.SupportLogger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429 import org.springframework.beans.BeansException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430 import org.springframework.beans.factory.InitializingBean;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431 import org.springframework.beans.factory.annotation.Autowired;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432 import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433 import org.springframework.beans.factory.config.PropertyPlaceholderConfigurer;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434 import org.springframework.beans.factory.support.BeanDefinitionRegistry;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435 import org.springframework.context.ApplicationContext;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436 import org.springframework.core.io.ClassPathResource;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437 import org.springframework.core.io.FileSystemResource;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438 import org.springframework.core.io.Resource;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439 import org.springframework.util.PropertyPlaceholderHelper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440 import org.springframework.util.StringValueResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444 import java.util.Collections;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445 import java.util.LinkedHashSet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446 import java.util.Map.Entry;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450 import javax.annotation.PostConstruct;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453  * A property resource configurer that chooses the property file at runtime</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454  * based on the runtime environment.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456  * Used for choosing properties files based on the current runtime environment,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457  * allowing for movement of the same application between multiple runtime</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458  * environments without rebuilding.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460  * The property replacement semantics of this implementation are identical to</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461  * PropertyPlaceholderConfigurer, from which this class inherits. &lt;code&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462  * &lt;pre&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 463  * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiesConfigurer&amp;quot;&amp;gt;"> 463  * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 464  *        &amp;lt;property name=&amp;quot;propertyLocation&amp;quot; value=&amp;quot;/WEB-INF/runtime-properties/&amp;quot; /&amp;gt;"> 464  *        &amp;lt;property name=&amp;quot;propertyLocation&amp;quot; value=&amp;quot;/WEB-INF/runtime-properties/&amp;quot; /ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465  *        &amp;lt;property name=&amp;quot;environments&amp;quot;&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466  *        &amp;lt;set&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467  *            &amp;lt;value&amp;gt;production&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468  *            &amp;lt;value&amp;gt;staging&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469  *            &amp;lt;value&amp;gt;integration&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470  *            &amp;lt;value&amp;gt;development&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471  *        &amp;lt;/set&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472  *        &amp;lt;/property&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473  *        &amp;lt;property name=&amp;quot;defaultEnvironment&amp;quot; value=&amp;quot;development&amp;quot;/&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474  * &amp;lt;/bean&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475  * &lt;/code&gt; &lt;/pre&gt; The keys of the environment specific properties files are</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476  * compared to ensure that each property file defines the complete set of keys,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477  * in order to avoid environment-specific failures.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479  * An optional RuntimeEnvironmentKeyResolver implementation can be provided,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480  * allowing for customization of how the runtime environment is determined. If</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481  * no implementation is provided, a default of</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482  * SystemPropertyRuntimeEnvironmentKeyResolver is used (which uses the system</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483  * property &#x27;runtime.environment&#x27;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484  * @author &lt;a href=&quot;mailto:chris.lee.9@gmail.com&quot;&gt;Chris Lee&lt;/a&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 485  * @deprecated Instead of using anything around the -Druntime-environment values, you should be using Spring profiles"> 485  * @deprecated Instead of using anything around the -Druntime-environment values, you should be using SprðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486  * and properties activated with that via {@link BroadleafEnvironmentConfiguringApplicationListener}.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488 @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 489 public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitializingBean {"> 489 public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491     private static final Log LOG = LogFactory.getLog(RuntimeEnvironmentPropertiesConfigurer.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492     protected SupportLogger logger = SupportLogManager.getLogger(&quot;UserOverride&quot;, this.getClass());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494     protected static final String SHARED_PROPERTY_OVERRIDE = &quot;property-shared-override&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495     protected static final String PROPERTY_OVERRIDE = &quot;property-override&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497     protected static Set&lt;String&gt; defaultEnvironments = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498     protected static Set&lt;Resource&gt; blcPropertyLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499     protected static Set&lt;Resource&gt; defaultPropertyLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501     static {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502         defaultEnvironments.add(&quot;production&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503         defaultEnvironments.add(&quot;staging&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504         defaultEnvironments.add(&quot;integrationqa&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505         defaultEnvironments.add(&quot;integrationdev&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506         defaultEnvironments.add(&quot;development&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/admin/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/cms/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/web/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/fw/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514         defaultPropertyLocations.add(new ClassPathResource(&quot;runtime-properties/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517     protected String defaultEnvironment = &quot;development&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518     protected String determinedEnvironment = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519     protected RuntimeEnvironmentKeyResolver keyResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520     protected Set&lt;String&gt; environments = Collections.emptySet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521     protected Set&lt;Resource&gt; propertyLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522     protected Set&lt;Resource&gt; overridableProperyLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523     protected StringValueResolver stringValueResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525     @Autowired</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526     protected ApplicationContext applicationContext;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528     @PostConstruct</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529     public void init() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 530         String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactory()).getBeanDefinition(&quot;blConfiguration&quot;).getResourceDescription();"> 530         String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 531         LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguration and the RuntimeEnvironmentProperitesConfigurer is deprecated and has unknown side-effects. Remove &quot;"> 531         LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguraðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 532             + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworkCommonPropertySource, ProfileAwarePropertySource or a @PropertySource annotation on an @Configuration class&quot;);"> 532             + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536     public void afterPropertiesSet() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 537         setIgnoreUnresolvablePlaceholders(true); // This default will get overriden by user options if present"> 537         setIgnoreUnresolvablePlaceholders(true); // This default will get overriden by user options if prðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538         setNullValue(&quot;@null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540         // If no environment override has been specified, used the default environments</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541         if (environments == null || environments.size() == 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542             environments = defaultEnvironments;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545         // Prepend the default property locations to the specified property locations (if any)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546         Set&lt;Resource&gt; combinedLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547         if (!CollectionUtils.isEmpty(overridableProperyLocations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548             combinedLocations.addAll(overridableProperyLocations);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551         if (!CollectionUtils.isEmpty(propertyLocations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552             combinedLocations.addAll(propertyLocations);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554         propertyLocations = combinedLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556         if (!environments.contains(defaultEnvironment)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 557             throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in environment list&quot;);"> 557             throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in enviðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560         if (keyResolver == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561             keyResolver = new SystemPropertyRuntimeEnvironmentKeyResolver();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564         String environment = determineEnvironment();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565         ArrayList&lt;Resource&gt; allLocations = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567         /* Process configuration in the following order (later files override earlier files</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568          * common-shared.properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569          * [environment]-shared.properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570          * common.properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571          * [environment].properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572          * -Dproperty-override-shared specified value, if any</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573          * -Dproperty-override specified value, if any  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574         Set&lt;Set&lt;Resource&gt;&gt; testLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575         testLocations.add(propertyLocations);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576         testLocations.add(defaultPropertyLocations);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578         for (Resource resource : createBroadleafResource()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579             if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580                 allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584         for (Set&lt;Resource&gt; locations : testLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585             for (Resource resource : createSharedCommonResource(locations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591             for (Resource resource : createSharedPropertiesResource(environment, locations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597             for (Resource resource : createCommonResource(locations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603             for (Resource resource : createPropertiesResource(environment, locations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610         Resource sharedPropertyOverride = createSharedOverrideResource();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611         if (sharedPropertyOverride != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612             allLocations.add(sharedPropertyOverride);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615         Resource propertyOverride = createOverrideResource();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616         if (propertyOverride != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617             allLocations.add(propertyOverride);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620         Properties props = new Properties();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621         for (Resource resource : allLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622             if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623                 // We will log source-control managed properties with trace and overrides with info</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624                 if (((resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625                         || LOG.isTraceEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626                     props = new Properties(props);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627                     props.load(resource.getInputStream());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628                     for (Entry&lt;Object, Object&gt; entry : props.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 629                         if (resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)) {"> 629                         if (resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride))ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630                             logger.support(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631                         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632                             LOG.trace(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637                 LOG.debug(&quot;Unable to locate resource: &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641         setLocations(allLocations.toArray(new Resource[] {}));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 644     protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 644     protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645         String fileName = environment.toString().toLowerCase() + &quot;-shared.properties&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649             resources[index] = resource.createRelative(fileName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655     protected Resource[] createBroadleafResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656         Resource[] resources = new Resource[blcPropertyLocations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658         for (Resource resource : blcPropertyLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659             resources[index] = resource.createRelative(&quot;common.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665     protected Resource[] createSharedCommonResource(Set&lt;Resource&gt; locations) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669             resources[index] = resource.createRelative(&quot;common-shared.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 675     protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 675     protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOEðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676         String fileName = environment.toString().toLowerCase() + &quot;.properties&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680             resources[index] = resource.createRelative(fileName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686     protected Resource[] createCommonResource(Set&lt;Resource&gt; locations) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690             resources[index] = resource.createRelative(&quot;common.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696     protected Resource createSharedOverrideResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697         String path = System.getProperty(SHARED_PROPERTY_OVERRIDE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698         return StringUtils.isBlank(path) ? null : new FileSystemResource(path);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701     protected Resource createOverrideResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702         String path = System.getProperty(PROPERTY_OVERRIDE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703         return StringUtils.isBlank(path) ? null : new FileSystemResource(path);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706     public String determineEnvironment() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707         if (determinedEnvironment != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708             return determinedEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710         determinedEnvironment = keyResolver.resolveRuntimeEnvironmentKey();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712         if (determinedEnvironment == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 713             LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27;&quot;);"> 713             LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnviðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714             determinedEnvironment = defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717         return determinedEnvironment.toLowerCase();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 721     protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties props) throws BeansException {"> 721     protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties proðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722         super.processProperties(beanFactoryToProcess, props);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723         stringValueResolver = new PlaceholderResolvingStringValueResolver(props);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727      * Sets the default environment name, used when the runtime environment</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728      * cannot be determined.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730     public void setDefaultEnvironment(String defaultEnvironment) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731         this.defaultEnvironment = defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734     public String getDefaultEnvironment() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735         return defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 738     public void setKeyResolver(RuntimeEnvironmentKeyResolver keyResolver) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 739         this.keyResolver = keyResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 740     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 741 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 742     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 743      * Sets the allowed list of runtime environments</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 744      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 745     public void setEnvironments(Set&lt;String&gt; environments) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 746         this.environments = environments;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 747     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 748 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 749     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 750      * Sets the directory from which to read environment-specific properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 751      * files; note that it must end with a &#x27;/&#x27;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 752      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 753     public void setPropertyLocations(Set&lt;Resource&gt; propertyLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 754         this.propertyLocations = propertyLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 755     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 756 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 757     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 758      * Sets the directory from which to read environment-specific properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 759      * files; note that it must end with a &#x27;/&#x27;. Note, these properties may be</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 760      * overridden by those defined in propertyLocations and any &quot;runtime-properties&quot; directories</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 761      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 762      * @param overridableProperyLocations location containing overridable environment properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 763      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 764     public void setOverridableProperyLocations(Set&lt;Resource&gt; overridableProperyLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 765         this.overridableProperyLocations = overridableProperyLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 766     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 767 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 768     private class PlaceholderResolvingStringValueResolver implements StringValueResolver {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 769 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 770         private final PropertyPlaceholderHelper helper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 771 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 772         private final PropertyPlaceholderHelper.PlaceholderResolver resolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 773 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 774         public PlaceholderResolvingStringValueResolver(Properties props) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 775             this.helper = new PropertyPlaceholderHelper(&quot;${&quot;, &quot;}&quot;, &quot;:&quot;, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 776             this.resolver = new PropertyPlaceholderConfigurerResolver(props);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 777         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 778 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 779         @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 780         public String resolveStringValue(String strVal) throws BeansException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 781             String value = this.helper.replacePlaceholders(strVal, this.resolver);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 782             return (value.equals(&quot;&quot;) ? null : value);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 783         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 784     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 785 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 786     private class PropertyPlaceholderConfigurerResolver implements PropertyPlaceholderHelper.PlaceholderResolver {"> 786     private class PropertyPlaceholderConfigurerResolver implements PropertyPlaceholderHelper.PlaceholderRðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 787 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 788         private final Properties props;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 789 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 790         private PropertyPlaceholderConfigurerResolver(Properties props) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 791             this.props = props;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 792         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 793 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 794         @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 795         public String resolvePlaceholder(String placeholderName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 796             return RuntimeEnvironmentPropertiesConfigurer.this.resolvePlaceholder(placeholderName, props, 1);"> 796             return RuntimeEnvironmentPropertiesConfigurer.this.resolvePlaceholder(placeholderName, props,ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 797         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 798     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 799 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 800     public StringValueResolver getStringValueResolver() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 801         return stringValueResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 802     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 803 }</span>
 804 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
   4 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 /*-</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7  * #%L</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * Copyright (C) 2009 - 2022 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17  * shall apply.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  19  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  19  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  20  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  20  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21  * #L%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 package org.broadleafcommerce.common.config;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import org.broadleafcommerce.common.logging.SupportLogManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import org.broadleafcommerce.common.logging.SupportLogger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.springframework.beans.BeansException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import org.springframework.beans.factory.InitializingBean;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import org.springframework.beans.factory.annotation.Autowired;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import org.springframework.beans.factory.config.PropertyPlaceholderConfigurer;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import org.springframework.beans.factory.support.BeanDefinitionRegistry;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import org.springframework.context.ApplicationContext;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import org.springframework.core.io.ClassPathResource;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import org.springframework.core.io.FileSystemResource;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 import org.springframework.core.io.Resource;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 import org.springframework.util.PropertyPlaceholderHelper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 import org.springframework.util.StringValueResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 import java.util.Collections;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 import java.util.LinkedHashSet;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 import java.util.Map.Entry;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50 import java.util.Set;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 import javax.annotation.PostConstruct;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55  * A property resource configurer that chooses the property file at runtime</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56  * based on the runtime environment.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58  * Used for choosing properties files based on the current runtime environment,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59  * allowing for movement of the same application between multiple runtime</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60  * environments without rebuilding.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62  * The property replacement semantics of this implementation are identical to</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63  * PropertyPlaceholderConfigurer, from which this class inherits. &lt;code&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64  * &lt;pre&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  65  * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiesConfigurer&amp;quot;&amp;gt;">  65  * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  66  *        &amp;lt;property name=&amp;quot;propertyLocation&amp;quot; value=&amp;quot;/WEB-INF/runtime-properties/&amp;quot; /&amp;gt;">  66  *        &amp;lt;property name=&amp;quot;propertyLocation&amp;quot; value=&amp;quot;/WEB-INF/runtime-properties/&amp;quot; /ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67  *        &amp;lt;property name=&amp;quot;environments&amp;quot;&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68  *        &amp;lt;set&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69  *            &amp;lt;value&amp;gt;production&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70  *            &amp;lt;value&amp;gt;staging&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71  *            &amp;lt;value&amp;gt;integration&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72  *            &amp;lt;value&amp;gt;development&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73  *        &amp;lt;/set&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74  *        &amp;lt;/property&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75  *        &amp;lt;property name=&amp;quot;defaultEnvironment&amp;quot; value=&amp;quot;development&amp;quot;/&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76  * &amp;lt;/bean&amp;gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77  * &lt;/code&gt; &lt;/pre&gt; The keys of the environment specific properties files are</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78  * compared to ensure that each property file defines the complete set of keys,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79  * in order to avoid environment-specific failures.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81  * An optional RuntimeEnvironmentKeyResolver implementation can be provided,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82  * allowing for customization of how the runtime environment is determined. If</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83  * no implementation is provided, a default of</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84  * SystemPropertyRuntimeEnvironmentKeyResolver is used (which uses the system</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85  * property &#x27;runtime.environment&#x27;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86  * @author &lt;a href=&quot;mailto:chris.lee.9@gmail.com&quot;&gt;Chris Lee&lt;/a&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  87  * @deprecated Instead of using anything around the -Druntime-environment values, you should be using Spring profiles">  87  * @deprecated Instead of using anything around the -Druntime-environment values, you should be using SprðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88  * and properties activated with that via {@link BroadleafEnvironmentConfiguringApplicationListener}.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90 @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  91 public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitializingBean {">  91 public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93     private static final Log LOG = LogFactory.getLog(RuntimeEnvironmentPropertiesConfigurer.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94     protected SupportLogger logger = SupportLogManager.getLogger(&quot;UserOverride&quot;, this.getClass());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96     protected static final String SHARED_PROPERTY_OVERRIDE = &quot;property-shared-override&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97     protected static final String PROPERTY_OVERRIDE = &quot;property-override&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99     protected static Set&lt;String&gt; defaultEnvironments = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100     protected static Set&lt;Resource&gt; blcPropertyLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101     protected static Set&lt;Resource&gt; defaultPropertyLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103     static {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104         defaultEnvironments.add(&quot;production&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105         defaultEnvironments.add(&quot;staging&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106         defaultEnvironments.add(&quot;integrationqa&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107         defaultEnvironments.add(&quot;integrationdev&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108         defaultEnvironments.add(&quot;development&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/admin/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/cms/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/web/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114         blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/fw/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116         defaultPropertyLocations.add(new ClassPathResource(&quot;runtime-properties/&quot;));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119     protected String defaultEnvironment = &quot;development&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120     protected String determinedEnvironment = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121     protected RuntimeEnvironmentKeyResolver keyResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122     protected Set&lt;String&gt; environments = Collections.emptySet();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123     protected Set&lt;Resource&gt; propertyLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124     protected Set&lt;Resource&gt; overridableProperyLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125     protected StringValueResolver stringValueResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127     @Autowired</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128     protected ApplicationContext applicationContext;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130     @PostConstruct</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131     public void init() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 132         String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactory()).getBeanDefinition(&quot;blConfiguration&quot;).getResourceDescription();"> 132         String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 133         LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguration and the RuntimeEnvironmentProperitesConfigurer is deprecated and has unknown side-effects. Remove &quot;"> 133         LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguraðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 134             + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworkCommonPropertySource, ProfileAwarePropertySource or a @PropertySource annotation on an @Configuration class&quot;);"> 134             + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138     public void afterPropertiesSet() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 139         setIgnoreUnresolvablePlaceholders(true); // This default will get overriden by user options if present"> 139         setIgnoreUnresolvablePlaceholders(true); // This default will get overriden by user options if prðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140         setNullValue(&quot;@null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142         // If no environment override has been specified, used the default environments</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143         if (environments == null || environments.size() == 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144             environments = defaultEnvironments;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147         // Prepend the default property locations to the specified property locations (if any)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148         Set&lt;Resource&gt; combinedLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149         if (!CollectionUtils.isEmpty(overridableProperyLocations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150             combinedLocations.addAll(overridableProperyLocations);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153         if (!CollectionUtils.isEmpty(propertyLocations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154             combinedLocations.addAll(propertyLocations);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156         propertyLocations = combinedLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158         if (!environments.contains(defaultEnvironment)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 159             throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in environment list&quot;);"> 159             throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in enviðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162         if (keyResolver == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163             keyResolver = new SystemPropertyRuntimeEnvironmentKeyResolver();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166         String environment = determineEnvironment();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167         ArrayList&lt;Resource&gt; allLocations = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169         /* Process configuration in the following order (later files override earlier files</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170          * common-shared.properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171          * [environment]-shared.properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172          * common.properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173          * [environment].properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174          * -Dproperty-override-shared specified value, if any</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175          * -Dproperty-override specified value, if any  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176         Set&lt;Set&lt;Resource&gt;&gt; testLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177         testLocations.add(propertyLocations);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178         testLocations.add(defaultPropertyLocations);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180         for (Resource resource : createBroadleafResource()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181             if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182                 allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186         for (Set&lt;Resource&gt; locations : testLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187             for (Resource resource : createSharedCommonResource(locations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193             for (Resource resource : createSharedPropertiesResource(environment, locations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199             for (Resource resource : createCommonResource(locations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205             for (Resource resource : createPropertiesResource(environment, locations)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206                 if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207                     allLocations.add(resource);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212         Resource sharedPropertyOverride = createSharedOverrideResource();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213         if (sharedPropertyOverride != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214             allLocations.add(sharedPropertyOverride);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217         Resource propertyOverride = createOverrideResource();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218         if (propertyOverride != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219             allLocations.add(propertyOverride);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222         Properties props = new Properties();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223         for (Resource resource : allLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224             if (resource.exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225                 // We will log source-control managed properties with trace and overrides with info</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226                 if (((resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227                         || LOG.isTraceEnabled()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228                     props = new Properties(props);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229                     props.load(resource.getInputStream());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230                     for (Entry&lt;Object, Object&gt; entry : props.entrySet()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 231                         if (resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)) {"> 231                         if (resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride))ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232                             logger.support(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233                         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234                             LOG.trace(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239                 LOG.debug(&quot;Unable to locate resource: &quot; + resource.getFilename());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243         setLocations(allLocations.toArray(new Resource[] {}));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 246     protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 246     protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247         String fileName = environment.toString().toLowerCase() + &quot;-shared.properties&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251             resources[index] = resource.createRelative(fileName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257     protected Resource[] createBroadleafResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258         Resource[] resources = new Resource[blcPropertyLocations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         for (Resource resource : blcPropertyLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261             resources[index] = resource.createRelative(&quot;common.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267     protected Resource[] createSharedCommonResource(Set&lt;Resource&gt; locations) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271             resources[index] = resource.createRelative(&quot;common-shared.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 277     protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 277     protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOEðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278         String fileName = environment.toString().toLowerCase() + &quot;.properties&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282             resources[index] = resource.createRelative(fileName);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288     protected Resource[] createCommonResource(Set&lt;Resource&gt; locations) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289         Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290         int index = 0;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291         for (Resource resource : locations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292             resources[index] = resource.createRelative(&quot;common.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293             index++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295         return resources;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298     protected Resource createSharedOverrideResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299         String path = System.getProperty(SHARED_PROPERTY_OVERRIDE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300         return StringUtils.isBlank(path) ? null : new FileSystemResource(path);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303     protected Resource createOverrideResource() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304         String path = System.getProperty(PROPERTY_OVERRIDE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305         return StringUtils.isBlank(path) ? null : new FileSystemResource(path);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308     public String determineEnvironment() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309         if (determinedEnvironment != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310             return determinedEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312         determinedEnvironment = keyResolver.resolveRuntimeEnvironmentKey();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314         if (determinedEnvironment == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 315             LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27;&quot;);"> 315             LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnviðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316             determinedEnvironment = defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319         return determinedEnvironment.toLowerCase();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 323     protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties props) throws BeansException {"> 323     protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties proðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324         super.processProperties(beanFactoryToProcess, props);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325         stringValueResolver = new PlaceholderResolvingStringValueResolver(props);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329      * Sets the default environment name, used when the runtime environment</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330      * cannot be determined.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332     public void setDefaultEnvironment(String defaultEnvironment) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333         this.defaultEnvironment = defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336     public String getDefaultEnvironment() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337         return defaultEnvironment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340     public void setKeyResolver(RuntimeEnvironmentKeyResolver keyResolver) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341         this.keyResolver = keyResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345      * Sets the allowed list of runtime environments</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347     public void setEnvironments(Set&lt;String&gt; environments) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348         this.environments = environments;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352      * Sets the directory from which to read environment-specific properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353      * files; note that it must end with a &#x27;/&#x27;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355     public void setPropertyLocations(Set&lt;Resource&gt; propertyLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356         this.propertyLocations = propertyLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360      * Sets the directory from which to read environment-specific properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361      * files; note that it must end with a &#x27;/&#x27;. Note, these properties may be</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362      * overridden by those defined in propertyLocations and any &quot;runtime-properties&quot; directories</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364      * @param overridableProperyLocations location containing overridable environment properties</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366     public void setOverridableProperyLocations(Set&lt;Resource&gt; overridableProperyLocations) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367         this.overridableProperyLocations = overridableProperyLocations;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370     private class PlaceholderResolvingStringValueResolver implements StringValueResolver {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372         private final PropertyPlaceholderHelper helper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374         private final PropertyPlaceholderHelper.PlaceholderResolver resolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376         public PlaceholderResolvingStringValueResolver(Properties props) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377             this.helper = new PropertyPlaceholderHelper(&quot;${&quot;, &quot;}&quot;, &quot;:&quot;, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378             this.resolver = new PropertyPlaceholderConfigurerResolver(props);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381         @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382         public String resolveStringValue(String strVal) throws BeansException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383             String value = this.helper.replacePlaceholders(strVal, this.resolver);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384             return (value.equals(&quot;&quot;) ? null : value);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 388     private class PropertyPlaceholderConfigurerResolver implements PropertyPlaceholderHelper.PlaceholderResolver {"> 388     private class PropertyPlaceholderConfigurerResolver implements PropertyPlaceholderHelper.PlaceholderRðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390         private final Properties props;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392         private PropertyPlaceholderConfigurerResolver(Properties props) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393             this.props = props;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396         @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397         public String resolvePlaceholder(String placeholderName) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 398             return RuntimeEnvironmentPropertiesConfigurer.this.resolvePlaceholder(placeholderName, props, 1);"> 398             return RuntimeEnvironmentPropertiesConfigurer.this.resolvePlaceholder(placeholderName, props,ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402     public StringValueResolver getStringValueResolver() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403         return stringValueResolver;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405 }</span>
 406 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * #%L</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * %%</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * %%</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * shall apply.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  14 - * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14 - * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 - * #L%</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -package org.broadleafcommerce.common.config;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import org.apache.commons.collections.CollectionUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import org.broadleafcommerce.common.logging.SupportLogManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.broadleafcommerce.common.logging.SupportLogger;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.springframework.beans.BeansException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.springframework.beans.factory.InitializingBean;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import org.springframework.beans.factory.annotation.Autowired;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.springframework.beans.factory.config.PropertyPlaceholderConfigurer;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import org.springframework.beans.factory.support.BeanDefinitionRegistry;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import org.springframework.context.ApplicationContext;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import org.springframework.core.io.ClassPathResource;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import org.springframework.core.io.FileSystemResource;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import org.springframework.core.io.Resource;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import org.springframework.util.PropertyPlaceholderHelper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.springframework.util.StringValueResolver;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import java.io.IOException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import java.util.ArrayList;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import java.util.Collections;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import java.util.LinkedHashSet;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import java.util.Map.Entry;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import java.util.Set;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import javax.annotation.PostConstruct;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 - * A property resource configurer that chooses the property file at runtime</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 - * based on the runtime environment.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 - * &lt;p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 - * Used for choosing properties files based on the current runtime environment,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 - * allowing for movement of the same application between multiple runtime</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 - * environments without rebuilding.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 - * &lt;p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 - * The property replacement semantics of this implementation are identical to</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 - * PropertyPlaceholderConfigurer, from which this class inherits. &lt;code&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 - * &lt;pre&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  60 - * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiesConfigurer&amp;quot;&amp;gt;">  60 - * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiesConfiguðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 - *        &amp;lt;property name=&amp;quot;propertyLocation&amp;quot; value=&amp;quot;/WEB-INF/runtime-properties/&amp;quot; /&amp;gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 - *        &amp;lt;property name=&amp;quot;environments&amp;quot;&amp;gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 - *        &amp;lt;set&amp;gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 - *            &amp;lt;value&amp;gt;production&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 - *            &amp;lt;value&amp;gt;staging&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 - *            &amp;lt;value&amp;gt;integration&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 - *            &amp;lt;value&amp;gt;development&amp;lt;/value&amp;gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 - *        &amp;lt;/set&amp;gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 - *        &amp;lt;/property&amp;gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 - *        &amp;lt;property name=&amp;quot;defaultEnvironment&amp;quot; value=&amp;quot;development&amp;quot;/&amp;gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 - * &amp;lt;/bean&amp;gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 - * &lt;/code&gt; &lt;/pre&gt; The keys of the environment specific properties files are</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 - * compared to ensure that each property file defines the complete set of keys,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 - * in order to avoid environment-specific failures.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 - * &lt;p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 - * An optional RuntimeEnvironmentKeyResolver implementation can be provided,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 - * allowing for customization of how the runtime environment is determined. If</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 - * no implementation is provided, a default of</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 - * SystemPropertyRuntimeEnvironmentKeyResolver is used (which uses the system</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 - * property &#x27;runtime.environment&#x27;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 - * @author &lt;a href=&quot;mailto:chris.lee.9@gmail.com&quot;&gt;Chris Lee&lt;/a&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  82 - * @deprecated Instead of using anything around the -Druntime-environment values, you should be using Spring profiles">  82 - * @deprecated Instead of using anything around the -Druntime-environment values, you should be using Spring profiðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 - * and properties activated with that via {@link BroadleafEnvironmentConfiguringApplicationListener}.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -@Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  86 -public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitializingBean {">  86 -public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitializingBðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -    private static final Log LOG = LogFactory.getLog(RuntimeEnvironmentPropertiesConfigurer.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -    protected SupportLogger logger = SupportLogManager.getLogger(&quot;UserOverride&quot;, this.getClass());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -    protected static final String SHARED_PROPERTY_OVERRIDE = &quot;property-shared-override&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -    protected static final String PROPERTY_OVERRIDE = &quot;property-override&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -    protected static Set&lt;String&gt; defaultEnvironments = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -    protected static Set&lt;Resource&gt; blcPropertyLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -    protected static Set&lt;Resource&gt; defaultPropertyLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -    static {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        defaultEnvironments.add(&quot;production&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -        defaultEnvironments.add(&quot;staging&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -        defaultEnvironments.add(&quot;integrationqa&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -        defaultEnvironments.add(&quot;integrationdev&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        defaultEnvironments.add(&quot;development&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -        blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/&quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -        blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/admin/&quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -        blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/cms/&quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -        blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/web/&quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/fw/&quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        defaultPropertyLocations.add(new ClassPathResource(&quot;runtime-properties/&quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -    protected String defaultEnvironment = &quot;development&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -    protected String determinedEnvironment = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -    protected RuntimeEnvironmentKeyResolver keyResolver;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -    protected Set&lt;String&gt; environments = Collections.emptySet();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -    protected Set&lt;Resource&gt; propertyLocations;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -    protected Set&lt;Resource&gt; overridableProperyLocations;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -    protected StringValueResolver stringValueResolver;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -    @Autowired</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -    protected ApplicationContext applicationContext;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -    @PostConstruct</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -    public void init() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 127 -        String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactory()).getBeanDefinition(&quot;blConfiguration&quot;).getResourceDescription();"> 127 -        String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactory()).getðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 128 -        LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguration and the RuntimeEnvironmentProperitesConfigurer is deprecated and has unknown side-effects. Remove &quot;"> 128 -        LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguration and ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 129 -            + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworkCommonPropertySource, ProfileAwarePropertySource or a @PropertySource annotation on an @Configuration class&quot;);"> 129 -            + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworkCommonPrðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -    public void afterPropertiesSet() throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        setIgnoreUnresolvablePlaceholders(true); // This default will get overriden by user options if present</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        setNullValue(&quot;@null&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -        // If no environment override has been specified, used the default environments</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        if (environments == null || environments.size() == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -            environments = defaultEnvironments;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        // Prepend the default property locations to the specified property locations (if any)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -        Set&lt;Resource&gt; combinedLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        if (!CollectionUtils.isEmpty(overridableProperyLocations)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -            combinedLocations.addAll(overridableProperyLocations);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -        if (!CollectionUtils.isEmpty(propertyLocations)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -            combinedLocations.addAll(propertyLocations);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -        propertyLocations = combinedLocations;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -        if (!environments.contains(defaultEnvironment)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 154 -            throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in environment list&quot;);"> 154 -            throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in environment lðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -        if (keyResolver == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -            keyResolver = new SystemPropertyRuntimeEnvironmentKeyResolver();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -        String environment = determineEnvironment();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -        ArrayList&lt;Resource&gt; allLocations = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -        /* Process configuration in the following order (later files override earlier files</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -         * common-shared.properties</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -         * [environment]-shared.properties</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -         * common.properties</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -         * [environment].properties</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -         * -Dproperty-override-shared specified value, if any</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -         * -Dproperty-override specified value, if any  */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -        Set&lt;Set&lt;Resource&gt;&gt; testLocations = new LinkedHashSet&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -        testLocations.add(propertyLocations);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -        testLocations.add(defaultPropertyLocations);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -        for (Resource resource : createBroadleafResource()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -            if (resource.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -                allLocations.add(resource);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -        for (Set&lt;Resource&gt; locations : testLocations) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -            for (Resource resource : createSharedCommonResource(locations)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -                if (resource.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -                    allLocations.add(resource);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -            for (Resource resource : createSharedPropertiesResource(environment, locations)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -                if (resource.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -                    allLocations.add(resource);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -            for (Resource resource : createCommonResource(locations)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -                if (resource.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -                    allLocations.add(resource);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -            for (Resource resource : createPropertiesResource(environment, locations)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -                if (resource.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -                    allLocations.add(resource);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -        Resource sharedPropertyOverride = createSharedOverrideResource();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -        if (sharedPropertyOverride != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -            allLocations.add(sharedPropertyOverride);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -        Resource propertyOverride = createOverrideResource();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -        if (propertyOverride != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -            allLocations.add(propertyOverride);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -        Properties props = new Properties();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -        for (Resource resource : allLocations) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -            if (resource.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -                // We will log source-control managed properties with trace and overrides with info</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -                if (((resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -                        || LOG.isTraceEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -                    props = new Properties(props);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -                    props.load(resource.getInputStream());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -                    for (Entry&lt;Object, Object&gt; entry : props.entrySet()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -                        if (resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -                            logger.support(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -                        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -                            LOG.trace(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -                LOG.debug(&quot;Unable to locate resource: &quot; + resource.getFilename());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -        setLocations(allLocations.toArray(new Resource[] {}));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 241 -    protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 241 -    protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOExceðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -        String fileName = environment.toString().toLowerCase() + &quot;-shared.properties&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -        Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -        int index = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -        for (Resource resource : locations) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -            resources[index] = resource.createRelative(fileName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -            index++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -        return resources;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -    protected Resource[] createBroadleafResource() throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -        Resource[] resources = new Resource[blcPropertyLocations.size()];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -        int index = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -        for (Resource resource : blcPropertyLocations) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -            resources[index] = resource.createRelative(&quot;common.properties&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -            index++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -        return resources;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -    protected Resource[] createSharedCommonResource(Set&lt;Resource&gt; locations) throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -        Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -        int index = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -        for (Resource resource : locations) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -            resources[index] = resource.createRelative(&quot;common-shared.properties&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -            index++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -        return resources;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 272 -    protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 272 -    protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -        String fileName = environment.toString().toLowerCase() + &quot;.properties&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -        Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -        int index = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -        for (Resource resource : locations) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -            resources[index] = resource.createRelative(fileName);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -            index++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -        return resources;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -    protected Resource[] createCommonResource(Set&lt;Resource&gt; locations) throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -        Resource[] resources = new Resource[locations.size()];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -        int index = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -        for (Resource resource : locations) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -            resources[index] = resource.createRelative(&quot;common.properties&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -            index++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -        return resources;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -    protected Resource createSharedOverrideResource() throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -        String path = System.getProperty(SHARED_PROPERTY_OVERRIDE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -        return StringUtils.isBlank(path) ? null : new FileSystemResource(path);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -    protected Resource createOverrideResource() throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -        String path = System.getProperty(PROPERTY_OVERRIDE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -        return StringUtils.isBlank(path) ? null : new FileSystemResource(path);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -    public String determineEnvironment() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -        if (determinedEnvironment != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -            return determinedEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -        determinedEnvironment = keyResolver.resolveRuntimeEnvironmentKey();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -        if (determinedEnvironment == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 310 -            LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27;&quot;);"> 310 -            LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnvironment +ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -            determinedEnvironment = defaultEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -        return determinedEnvironment.toLowerCase();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 317 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 318 -    protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties props) throws BeansException {"> 318 -    protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties props) throwðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -        super.processProperties(beanFactoryToProcess, props);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -        stringValueResolver = new PlaceholderResolvingStringValueResolver(props);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 321 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -     * Sets the default environment name, used when the runtime environment</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -     * cannot be determined.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 326 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 327 -    public void setDefaultEnvironment(String defaultEnvironment) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -        this.defaultEnvironment = defaultEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 329 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 330 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -    public String getDefaultEnvironment() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -        return defaultEnvironment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 333 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -    public void setKeyResolver(RuntimeEnvironmentKeyResolver keyResolver) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -        this.keyResolver = keyResolver;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -     * Sets the allowed list of runtime environments</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -    public void setEnvironments(Set&lt;String&gt; environments) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 343 -        this.environments = environments;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 344 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 345 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -     * Sets the directory from which to read environment-specific properties</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -     * files; note that it must end with a &#x27;/&#x27;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 349 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -    public void setPropertyLocations(Set&lt;Resource&gt; propertyLocations) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -        this.propertyLocations = propertyLocations;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 352 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -     * Sets the directory from which to read environment-specific properties</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 356 -     * files; note that it must end with a &#x27;/&#x27;. Note, these properties may be</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 357 -     * overridden by those defined in propertyLocations and any &quot;runtime-properties&quot; directories</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 358 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -     * @param overridableProperyLocations location containing overridable environment properties</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -    public void setOverridableProperyLocations(Set&lt;Resource&gt; overridableProperyLocations) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -        this.overridableProperyLocations = overridableProperyLocations;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -    private class PlaceholderResolvingStringValueResolver implements StringValueResolver {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -        private final PropertyPlaceholderHelper helper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -        private final PropertyPlaceholderHelper.PlaceholderResolver resolver;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -        public PlaceholderResolvingStringValueResolver(Properties props) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -            this.helper = new PropertyPlaceholderHelper(&quot;${&quot;, &quot;}&quot;, &quot;:&quot;, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -            this.resolver = new PropertyPlaceholderConfigurerResolver(props);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -        public String resolveStringValue(String strVal) throws BeansException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -            String value = this.helper.replacePlaceholders(strVal, this.resolver);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 379 -            return (value.equals(&quot;&quot;) ? null : value);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 380 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 381 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 382 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 383 -    private class PropertyPlaceholderConfigurerResolver implements PropertyPlaceholderHelper.PlaceholderResolver {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 384 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 385 -        private final Properties props;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 386 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 387 -        private PropertyPlaceholderConfigurerResolver(Properties props) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 388 -            this.props = props;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 389 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 390 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 391 -        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 392 -        public String resolvePlaceholder(String placeholderName) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 393 -            return RuntimeEnvironmentPropertiesConfigurer.this.resolvePlaceholder(placeholderName, props, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -    public StringValueResolver getStringValueResolver() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -        return stringValueResolver;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -}</span></pre></td>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   2 +/*-</span>
   3   * #%L
   4   * BroadleafCommerce Common Libraries
   5   * %%
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   7 + * Copyright (C) 2009 - 2022 Broadleaf Commerce</span>
   8   * %%
   9   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
  10   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
  11   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  12   * the Broadleaf End User License Agreement (EULA), Version 1.1
  13   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  14   * shall apply.
  15   *
<abbr title="  16   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  16   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  17   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  18   * #L%
  19   */
  20  package org.broadleafcommerce.common.config;
  21  
  22  import org.apache.commons.collections.CollectionUtils;
  23  import org.apache.commons.lang3.StringUtils;
  24  import org.apache.commons.logging.Log;
  25  import org.apache.commons.logging.LogFactory;
  26  import org.broadleafcommerce.common.logging.SupportLogManager;
  27  import org.broadleafcommerce.common.logging.SupportLogger;
  28  import org.springframework.beans.BeansException;
  29  import org.springframework.beans.factory.InitializingBean;
  30  import org.springframework.beans.factory.annotation.Autowired;
  31  import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;
  32  import org.springframework.beans.factory.config.PropertyPlaceholderConfigurer;
  33  import org.springframework.beans.factory.support.BeanDefinitionRegistry;
  34  import org.springframework.context.ApplicationContext;
  35  import org.springframework.core.io.ClassPathResource;
  36  import org.springframework.core.io.FileSystemResource;
  37  import org.springframework.core.io.Resource;
  38  import org.springframework.util.PropertyPlaceholderHelper;
  39  import org.springframework.util.StringValueResolver;
  40  
  41  import java.io.IOException;
  42  import java.util.ArrayList;
  43  import java.util.Collections;
  44  import java.util.LinkedHashSet;
  45  import java.util.Map.Entry;
  46  import java.util.Properties;
  47  import java.util.Set;
  48  
  49  import javax.annotation.PostConstruct;
  50  
  51  /**
  52   * A property resource configurer that chooses the property file at runtime
  53   * based on the runtime environment.
  54   * &lt;p&gt;
  55   * Used for choosing properties files based on the current runtime environment,
  56   * allowing for movement of the same application between multiple runtime
  57   * environments without rebuilding.
  58   * &lt;p&gt;
  59   * The property replacement semantics of this implementation are identical to
  60   * PropertyPlaceholderConfigurer, from which this class inherits. &lt;code&gt;
  61   * &lt;pre&gt;
<abbr title="  62   * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiesConfigurer&amp;quot;&amp;gt;">  62   * &amp;lt;bean id=&amp;quot;propertyConfigurator&amp;quot; class=&amp;quot;frilista.framework.RuntimeEnvironmentPropertiesConfiguðŸ”µ</abbr>
  63   *        &amp;lt;property name=&amp;quot;propertyLocation&amp;quot; value=&amp;quot;/WEB-INF/runtime-properties/&amp;quot; /&amp;gt;
  64   *        &amp;lt;property name=&amp;quot;environments&amp;quot;&amp;gt;
  65   *        &amp;lt;set&amp;gt;
  66   *            &amp;lt;value&amp;gt;production&amp;lt;/value&amp;gt;
  67   *            &amp;lt;value&amp;gt;staging&amp;lt;/value&amp;gt;
  68   *            &amp;lt;value&amp;gt;integration&amp;lt;/value&amp;gt;
  69   *            &amp;lt;value&amp;gt;development&amp;lt;/value&amp;gt;
  70   *        &amp;lt;/set&amp;gt;
  71   *        &amp;lt;/property&amp;gt;
  72   *        &amp;lt;property name=&amp;quot;defaultEnvironment&amp;quot; value=&amp;quot;development&amp;quot;/&amp;gt;
  73   * &amp;lt;/bean&amp;gt;
  74   * &lt;/code&gt; &lt;/pre&gt; The keys of the environment specific properties files are
  75   * compared to ensure that each property file defines the complete set of keys,
  76   * in order to avoid environment-specific failures.
  77   * &lt;p&gt;
  78   * An optional RuntimeEnvironmentKeyResolver implementation can be provided,
  79   * allowing for customization of how the runtime environment is determined. If
  80   * no implementation is provided, a default of
  81   * SystemPropertyRuntimeEnvironmentKeyResolver is used (which uses the system
  82   * property &#x27;runtime.environment&#x27;)
  83   * @author &lt;a href=&quot;mailto:chris.lee.9@gmail.com&quot;&gt;Chris Lee&lt;/a&gt;
<abbr title="  84   * @deprecated Instead of using anything around the -Druntime-environment values, you should be using Spring profiles">  84   * @deprecated Instead of using anything around the -Druntime-environment values, you should be using Spring profiðŸ”µ</abbr>
  85   * and properties activated with that via {@link BroadleafEnvironmentConfiguringApplicationListener}.
  86   */
  87  @Deprecated
<abbr title="  88  public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitializingBean {">  88  public class RuntimeEnvironmentPropertiesConfigurer extends PropertyPlaceholderConfigurer implements InitializingBðŸ”µ</abbr>
  89  
  90      private static final Log LOG = LogFactory.getLog(RuntimeEnvironmentPropertiesConfigurer.class);
  91      protected SupportLogger logger = SupportLogManager.getLogger(&quot;UserOverride&quot;, this.getClass());
  92  
  93      protected static final String SHARED_PROPERTY_OVERRIDE = &quot;property-shared-override&quot;;
  94      protected static final String PROPERTY_OVERRIDE = &quot;property-override&quot;;
  95  
  96      protected static Set&lt;String&gt; defaultEnvironments = new LinkedHashSet&lt;&gt;();
  97      protected static Set&lt;Resource&gt; blcPropertyLocations = new LinkedHashSet&lt;&gt;();
  98      protected static Set&lt;Resource&gt; defaultPropertyLocations = new LinkedHashSet&lt;&gt;();
  99  
 100      static {
 101          defaultEnvironments.add(&quot;production&quot;);
 102          defaultEnvironments.add(&quot;staging&quot;);
 103          defaultEnvironments.add(&quot;integrationqa&quot;);
 104          defaultEnvironments.add(&quot;integrationdev&quot;);
 105          defaultEnvironments.add(&quot;development&quot;);
 106  
 107          blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/&quot;));
 108          blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/admin/&quot;));
 109          blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/cms/&quot;));
 110          blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/web/&quot;));
 111          blcPropertyLocations.add(new ClassPathResource(&quot;config/bc/fw/&quot;));
 112  
 113          defaultPropertyLocations.add(new ClassPathResource(&quot;runtime-properties/&quot;));
 114      }
 115  
 116      protected String defaultEnvironment = &quot;development&quot;;
 117      protected String determinedEnvironment = null;
 118      protected RuntimeEnvironmentKeyResolver keyResolver;
 119      protected Set&lt;String&gt; environments = Collections.emptySet();
 120      protected Set&lt;Resource&gt; propertyLocations;
 121      protected Set&lt;Resource&gt; overridableProperyLocations;
 122      protected StringValueResolver stringValueResolver;
 123  
 124      @Autowired
 125      protected ApplicationContext applicationContext;
 126  
 127      @PostConstruct
 128      public void init() {
<abbr title=" 129          String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactory()).getBeanDefinition(&quot;blConfiguration&quot;).getResourceDescription();"> 129          String originatingFile = ((BeanDefinitionRegistry) applicationContext.getAutowireCapableBeanFactory()).getðŸ”µ</abbr>
<abbr title=" 130          LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguration and the RuntimeEnvironmentProperitesConfigurer is deprecated and has unknown side-effects. Remove &quot;"> 130          LOG.error(&quot;A blConfiguration bean was detected in &quot; + originatingFile + &quot;. Any use of blConfiguration and ðŸ”µ</abbr>
<abbr title=" 131              + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworkCommonPropertySource, ProfileAwarePropertySource or a @PropertySource annotation on an @Configuration class&quot;);"> 131              + &quot;all instances blConfiguration from all applicationContext.xml files. Use either a FrameworkCommonPrðŸ”µ</abbr>
 132      }
 133  
 134      @Override
 135      public void afterPropertiesSet() throws IOException {
 136          setIgnoreUnresolvablePlaceholders(true); // This default will get overriden by user options if present
 137          setNullValue(&quot;@null&quot;);
 138  
 139          // If no environment override has been specified, used the default environments
 140          if (environments == null || environments.size() == 0) {
 141              environments = defaultEnvironments;
 142          }
 143  
 144          // Prepend the default property locations to the specified property locations (if any)
 145          Set&lt;Resource&gt; combinedLocations = new LinkedHashSet&lt;&gt;();
 146          if (!CollectionUtils.isEmpty(overridableProperyLocations)) {
 147              combinedLocations.addAll(overridableProperyLocations);
 148          }
 149  
 150          if (!CollectionUtils.isEmpty(propertyLocations)) {
 151              combinedLocations.addAll(propertyLocations);
 152          }
 153          propertyLocations = combinedLocations;
 154  
 155          if (!environments.contains(defaultEnvironment)) {
<abbr title=" 156              throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in environment list&quot;);"> 156              throw new AssertionError(&quot;Default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27; not listed in environment lðŸ”µ</abbr>
 157          }
 158  
 159          if (keyResolver == null) {
 160              keyResolver = new SystemPropertyRuntimeEnvironmentKeyResolver();
 161          }
 162  
 163          String environment = determineEnvironment();
 164          ArrayList&lt;Resource&gt; allLocations = new ArrayList&lt;&gt;();
 165  
 166          /* Process configuration in the following order (later files override earlier files
 167           * common-shared.properties
 168           * [environment]-shared.properties
 169           * common.properties
 170           * [environment].properties
 171           * -Dproperty-override-shared specified value, if any
 172           * -Dproperty-override specified value, if any  */
 173          Set&lt;Set&lt;Resource&gt;&gt; testLocations = new LinkedHashSet&lt;&gt;();
 174          testLocations.add(propertyLocations);
 175          testLocations.add(defaultPropertyLocations);
 176  
 177          for (Resource resource : createBroadleafResource()) {
 178              if (resource.exists()) {
 179                  allLocations.add(resource);
 180              }
 181          }
 182  
 183          for (Set&lt;Resource&gt; locations : testLocations) {
 184              for (Resource resource : createSharedCommonResource(locations)) {
 185                  if (resource.exists()) {
 186                      allLocations.add(resource);
 187                  }
 188              }
 189  
 190              for (Resource resource : createSharedPropertiesResource(environment, locations)) {
 191                  if (resource.exists()) {
 192                      allLocations.add(resource);
 193                  }
 194              }
 195  
 196              for (Resource resource : createCommonResource(locations)) {
 197                  if (resource.exists()) {
 198                      allLocations.add(resource);
 199                  }
 200              }
 201  
 202              for (Resource resource : createPropertiesResource(environment, locations)) {
 203                  if (resource.exists()) {
 204                      allLocations.add(resource);
 205                  }
 206              }
 207          }
 208  
 209          Resource sharedPropertyOverride = createSharedOverrideResource();
 210          if (sharedPropertyOverride != null) {
 211              allLocations.add(sharedPropertyOverride);
 212          }
 213  
 214          Resource propertyOverride = createOverrideResource();
 215          if (propertyOverride != null) {
 216              allLocations.add(propertyOverride);
 217          }
 218  
 219          Properties props = new Properties();
 220          for (Resource resource : allLocations) {
 221              if (resource.exists()) {
 222                  // We will log source-control managed properties with trace and overrides with info
 223                  if (((resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)))
 224                          || LOG.isTraceEnabled()) {
 225                      props = new Properties(props);
 226                      props.load(resource.getInputStream());
 227                      for (Entry&lt;Object, Object&gt; entry : props.entrySet()) {
 228                          if (resource.equals(sharedPropertyOverride) || resource.equals(propertyOverride)) {
 229                              logger.support(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());
 230                          } else {
 231                              LOG.trace(&quot;Read &quot; + entry.getKey() + &quot; from &quot; + resource.getFilename());
 232                          }
 233                      }
 234                  }
 235              } else {
 236                  LOG.debug(&quot;Unable to locate resource: &quot; + resource.getFilename());
 237              }
 238          }
 239  
 240          setLocations(allLocations.toArray(new Resource[] {}));
 241      }
 242  
<abbr title=" 243      protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 243      protected Resource[] createSharedPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOExceðŸ”µ</abbr>
 244          String fileName = environment.toString().toLowerCase() + &quot;-shared.properties&quot;;
 245          Resource[] resources = new Resource[locations.size()];
 246          int index = 0;
 247          for (Resource resource : locations) {
 248              resources[index] = resource.createRelative(fileName);
 249              index++;
 250          }
 251          return resources;
 252      }
 253  
 254      protected Resource[] createBroadleafResource() throws IOException {
 255          Resource[] resources = new Resource[blcPropertyLocations.size()];
 256          int index = 0;
 257          for (Resource resource : blcPropertyLocations) {
 258              resources[index] = resource.createRelative(&quot;common.properties&quot;);
 259              index++;
 260          }
 261          return resources;
 262      }
 263  
 264      protected Resource[] createSharedCommonResource(Set&lt;Resource&gt; locations) throws IOException {
 265          Resource[] resources = new Resource[locations.size()];
 266          int index = 0;
 267          for (Resource resource : locations) {
 268              resources[index] = resource.createRelative(&quot;common-shared.properties&quot;);
 269              index++;
 270          }
 271          return resources;
 272      }
 273  
<abbr title=" 274      protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException {"> 274      protected Resource[] createPropertiesResource(String environment, Set&lt;Resource&gt; locations) throws IOException ðŸ”µ</abbr>
 275          String fileName = environment.toString().toLowerCase() + &quot;.properties&quot;;
 276          Resource[] resources = new Resource[locations.size()];
 277          int index = 0;
 278          for (Resource resource : locations) {
 279              resources[index] = resource.createRelative(fileName);
 280              index++;
 281          }
 282          return resources;
 283      }
 284  
 285      protected Resource[] createCommonResource(Set&lt;Resource&gt; locations) throws IOException {
 286          Resource[] resources = new Resource[locations.size()];
 287          int index = 0;
 288          for (Resource resource : locations) {
 289              resources[index] = resource.createRelative(&quot;common.properties&quot;);
 290              index++;
 291          }
 292          return resources;
 293      }
 294  
 295      protected Resource createSharedOverrideResource() throws IOException {
 296          String path = System.getProperty(SHARED_PROPERTY_OVERRIDE);
 297          return StringUtils.isBlank(path) ? null : new FileSystemResource(path);
 298      }
 299  
 300      protected Resource createOverrideResource() throws IOException {
 301          String path = System.getProperty(PROPERTY_OVERRIDE);
 302          return StringUtils.isBlank(path) ? null : new FileSystemResource(path);
 303      }
 304  
 305      public String determineEnvironment() {
 306          if (determinedEnvironment != null) {
 307              return determinedEnvironment;
 308          }
 309          determinedEnvironment = keyResolver.resolveRuntimeEnvironmentKey();
 310  
 311          if (determinedEnvironment == null) {
<abbr title=" 312              LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnvironment + &quot;&#x27;&quot;);"> 312              LOG.warn(&quot;Unable to determine runtime environment, using default environment &#x27;&quot; + defaultEnvironment +ðŸ”µ</abbr>
 313              determinedEnvironment = defaultEnvironment;
 314          }
 315  
 316          return determinedEnvironment.toLowerCase();
 317      }
 318  
 319      @Override
<abbr title=" 320      protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties props) throws BeansException {"> 320      protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties props) throwðŸ”µ</abbr>
 321          super.processProperties(beanFactoryToProcess, props);
 322          stringValueResolver = new PlaceholderResolvingStringValueResolver(props);
 323      }
 324  
 325      /**
 326       * Sets the default environment name, used when the runtime environment
 327       * cannot be determined.
 328       */
 329      public void setDefaultEnvironment(String defaultEnvironment) {
 330          this.defaultEnvironment = defaultEnvironment;
 331      }
 332  
 333      public String getDefaultEnvironment() {
 334          return defaultEnvironment;
 335      }
 336  
 337      public void setKeyResolver(RuntimeEnvironmentKeyResolver keyResolver) {
 338          this.keyResolver = keyResolver;
 339      }
 340  
 341      /**
 342       * Sets the allowed list of runtime environments
 343       */
 344      public void setEnvironments(Set&lt;String&gt; environments) {
 345          this.environments = environments;
 346      }
 347  
 348      /**
 349       * Sets the directory from which to read environment-specific properties
 350       * files; note that it must end with a &#x27;/&#x27;
 351       */
 352      public void setPropertyLocations(Set&lt;Resource&gt; propertyLocations) {
 353          this.propertyLocations = propertyLocations;
 354      }
 355  
 356      /**
 357       * Sets the directory from which to read environment-specific properties
 358       * files; note that it must end with a &#x27;/&#x27;. Note, these properties may be
 359       * overridden by those defined in propertyLocations and any &quot;runtime-properties&quot; directories
 360       *
 361       * @param overridableProperyLocations location containing overridable environment properties
 362       */
 363      public void setOverridableProperyLocations(Set&lt;Resource&gt; overridableProperyLocations) {
 364          this.overridableProperyLocations = overridableProperyLocations;
 365      }
 366  
 367      private class PlaceholderResolvingStringValueResolver implements StringValueResolver {
 368  
 369          private final PropertyPlaceholderHelper helper;
 370  
 371          private final PropertyPlaceholderHelper.PlaceholderResolver resolver;
 372  
 373          public PlaceholderResolvingStringValueResolver(Properties props) {
 374              this.helper = new PropertyPlaceholderHelper(&quot;${&quot;, &quot;}&quot;, &quot;:&quot;, true);
 375              this.resolver = new PropertyPlaceholderConfigurerResolver(props);
 376          }
 377  
 378          @Override
 379          public String resolveStringValue(String strVal) throws BeansException {
 380              String value = this.helper.replacePlaceholders(strVal, this.resolver);
 381              return (value.equals(&quot;&quot;) ? null : value);
 382          }
 383      }
 384  
 385      private class PropertyPlaceholderConfigurerResolver implements PropertyPlaceholderHelper.PlaceholderResolver {
 386  
 387          private final Properties props;
 388  
 389          private PropertyPlaceholderConfigurerResolver(Properties props) {
 390              this.props = props;
 391          }
 392  
 393          @Override
 394          public String resolvePlaceholder(String placeholderName) {
 395              return RuntimeEnvironmentPropertiesConfigurer.this.resolvePlaceholder(placeholderName, props, 1);
 396          }
 397      }
 398  
 399      public StringValueResolver getStringValueResolver() {
 400          return stringValueResolver;
 401      }
 402  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            