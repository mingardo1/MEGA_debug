<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>71</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    71
                    <a href="70.html">prev</a>
                    <a href="72.html">next</a>
                    <a href="71_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_99d857f3383c60ae4ae008f74e7d2b32afe9c26a_Aria/src/main/java/com/arialyy/aria/core/scheduler/DownloadSchedulers.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;99d857f3383c60ae4ae008f74e7d2b32afe9c26a:Aria/src/main/java/com/arialyy/aria/core/scheduler/DownloadSchedulers.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;99d857f3383c60ae4ae008f74e7d2b32afe9c26a^1:Aria/src/main/java/com/arialyy/aria/core/scheduler/DownloadSchedulers.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;99d857f3383c60ae4ae008f74e7d2b32afe9c26a^2:Aria/src/main/java/com/arialyy/aria/core/scheduler/DownloadSchedulers.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;41154d47fb8664ddca206122d28b50a6a3b8e9a6:Aria/src/main/java/com/arialyy/aria/core/scheduler/DownloadSchedulers.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [bj], [b], [b], [b], [j], [s]], subset: [[b], [bs], [bj], [bj], [b], [b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.arialyy.aria.core.scheduler;
  18 
  19 import android.os.CountDownTimer;
  20 import android.os.Message;
  21 import android.util.Log;
  22 import com.arialyy.aria.core.queue.DownloadTaskQueue;
  23 import com.arialyy.aria.core.download.DownloadEntity;
  24 import com.arialyy.aria.core.download.DownloadTask;
  25 import com.arialyy.aria.util.Configuration;
  26 import java.util.Iterator;
  27 import java.util.Map;
  28 import java.util.Set;
  29 import java.util.concurrent.ConcurrentHashMap;
  30 
  31 /**
  32  * Created by lyy on 2016/8/16.
  33  * 任务下载器，提供抽象的方法供具体的实现类操作
  34  */
  35 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36 public class DownloadSchedulers implements IDownloadSchedulers {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38    * 任务预加载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40   public static final     int                PRE      = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42    * 任务开始</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   public static final     int                START    = 1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46    * 任务停止</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48   public static final     int                STOP     = 2;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50    * 任务失败</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52   public static final     int                FAIL     = 3;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54    * 任务取消</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56   public static final     int                CANCEL   = 4;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58    * 任务完成</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60   public static final     int                COMPLETE = 5;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62    * 下载中</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64   public static final     int                RUNNING  = 6;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66    * 恢复下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68   public static final     int                RESUME   = 7;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69   private static final    String             TAG      = &quot;DownloadSchedulers&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70   private static final    Object             LOCK     = new Object();</span>
  71 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72  * 任务下载器，提供抽象的方法供具体的实现类操作</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 public class DownloadSchedulers implements IDownloadSchedulers {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76    * 任务预加载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78   public static final int PRE = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80    * 任务开始</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82   public static final int START = 1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84    * 任务停止</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86   public static final int STOP = 2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88    * 任务失败</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90   public static final int FAIL = 3;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92    * 任务取消</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94   public static final int CANCEL = 4;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96    * 任务完成</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98   public static final int COMPLETE = 5;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100    * 下载中</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102   public static final int RUNNING = 6;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104    * 恢复下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106   public static final int RESUME = 7;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107   private static final String TAG = &quot;DownloadSchedulers&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108   private static final Object LOCK = new Object();</span>
 109 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110 public class DownloadSchedulers implements ISchedulers&lt;DownloadTask&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112   private static final String TAG = &quot;DownloadSchedulers&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113   private static final Object LOCK = new Object();</span>
 114 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 115   private static volatile DownloadSchedulers INSTANCE = null;
 116 
 117   /**
 118    * 下载器任务监听
 119    */
 120 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121   Map&lt;String, OnSchedulerListener&gt; mSchedulerListeners = new ConcurrentHashMap&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122   DownloadManager                  mManager            = DownloadManager.getInstance();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123   ITaskQueue mQueue;</span>
 124 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126   public static final int START = 1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128    * 任务停止</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130   public static final int STOP = 2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132    * 任务失败</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134   public static final int FAIL = 3;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136    * 任务取消</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138   public static final int CANCEL = 4;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140    * 任务完成</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142   public static final int COMPLETE = 5;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144    * 下载中</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146   public static final int RUNNING = 6;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148    * 恢复下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150   public static final int RESUME = 7;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151   private static final String TAG = &quot;DownloadSchedulers&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152   private static final Object LOCK = new Object();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153   private static volatile DownloadSchedulers INSTANCE = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156    * 下载器任务监听</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158   Map&lt;String, OnSchedulerListener&gt; mSchedulerListeners = new ConcurrentHashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159   DownloadManager mManager = DownloadManager.getInstance();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160   ITaskQueue mQueue;</span>
 161 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162   private Map&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt; mSchedulerListeners =</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163       new ConcurrentHashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164   private DownloadTaskQueue mQueue;</span>
 165 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 166 
 167   private DownloadSchedulers() {
 168     mQueue = DownloadTaskQueue.getInstance();
 169   }
 170 
 171   public static DownloadSchedulers getInstance() {
 172     if (INSTANCE == null) {
 173       synchronized (LOCK) {
 174         INSTANCE = new DownloadSchedulers();
 175       }
 176     }
 177     return INSTANCE;
 178   }
 179 
 180   @Override public void addSchedulerListener(String targetName,
 181       ISchedulerListener&lt;DownloadTask&gt; schedulerListener) {
 182     mSchedulerListeners.put(targetName,
 183         (IDownloadSchedulerListener&lt;DownloadTask&gt;) schedulerListener);
 184   }
 185 
 186   @Override public void removeSchedulerListener(String targetName,
 187       ISchedulerListener&lt;DownloadTask&gt; schedulerListener) {
<abbr title=" 188     //该内存溢出解决方案：http://stackoverflow.com/questions/14585829/how-safe-is-to-delete-already-removed-concurrenthashmap-element"> 188     //该内存溢出解决方案：http://stackoverflow.com/questions/14585829/how-safe-is-to-delete-already-removed-concurr🔵</abbr>
 189     for (Iterator&lt;Map.Entry&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt;&gt; iter =
 190         mSchedulerListeners.entrySet().iterator(); iter.hasNext(); ) {
 191       Map.Entry&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt; entry = iter.next();
 192       if (entry.getKey().equals(targetName)) iter.remove();
 193     }
 194   }
 195 
 196   @Override public boolean handleMessage(Message msg) {
 197     DownloadTask task = (DownloadTask) msg.obj;
 198     if (task == null) {
 199       Log.e(TAG, &quot;请传入下载任务&quot;);
 200       return true;
 201     }
 202     callback(msg.what, task);
 203     DownloadEntity entity = task.getDownloadEntity();
 204     switch (msg.what) {
 205       case STOP:
 206       case CANCEL:
 207         mQueue.removeTask(entity);
 208         if (mQueue.size() &lt; Configuration.getInstance().getDownloadNum()) {
 209           startNextTask();
 210         }
 211         break;
 212       case COMPLETE:
 213         mQueue.removeTask(entity);
 214         startNextTask();
 215         break;
 216       case FAIL:
 217 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 218 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221   @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222   public void removeSchedulerListener(String targetName, OnSchedulerListener schedulerListener) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223     //OnSchedulerListener listener = mSchedulerListeners.get(target.getClass().getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224     //mSchedulerListeners.remove(listener);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 225     //该内存溢出解决方案：http://stackoverflow.com/questions/14585829/how-safe-is-to-delete-already-removed-concurrenthashmap-element"> 225     //该内存溢出解决方案：http://stackoverflow.com/questions/14585829/how-safe-is-to-delete-already-removed-concurr🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226     for (Iterator&lt;Map.Entry&lt;String, OnSchedulerListener&gt;&gt; iter =</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227         mSchedulerListeners.entrySet().iterator(); iter.hasNext(); ) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228       Map.Entry&lt;String, OnSchedulerListener&gt; entry = iter.next();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229       if (entry.getKey().equals(targetName)) iter.remove();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233   @Override public boolean handleMessage(Message msg) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234     Task task = (Task) msg.obj;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235     if (task == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236       Log.e(TAG, &quot;请传入下载任务&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237       return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239     callback(msg.what, task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240     DownloadEntity entity = task.getDownloadEntity();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241     switch (msg.what) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242       case STOP:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243       case CANCEL:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244         mQueue.removeTask(entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245         if (mQueue.size() &lt; Configuration.getInstance().getDownloadNum()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246           startNextTask(entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248         break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249       case COMPLETE:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250         mQueue.removeTask(entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251         startNextTask(entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252         break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253       case FAIL:</span>
 254 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255         //mQueue.removeTask(entity);</span>
 256 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 257         handleFailTask(task);
 258         break;
 259     }
 260     return true;
 261   }
 262 
 263   /**
 264    * 回调
 265    *
 266    * @param state 状态
 267    */
 268   private void callback(int state, DownloadTask task) {
 269     if (mSchedulerListeners.size() &gt; 0) {
 270       //if (!TextUtils.isEmpty(task.getTargetName())) {
 271       //  callback(state, task, mSchedulerListeners.get(task.getTargetName()));
 272       //}
 273       Set&lt;String&gt; keys = mSchedulerListeners.keySet();
 274       for (String key : keys) {
 275         callback(state, task, mSchedulerListeners.get(key));
 276       }
 277     }
 278   }
 279 
 280   private void callback(int state, DownloadTask task,
 281       IDownloadSchedulerListener&lt;DownloadTask&gt; listener) {
 282     if (listener != null) {
 283       if (task == null) {
 284         Log.e(TAG, &quot;TASK 为null，回调失败&quot;);
 285         return;
 286       }
 287       switch (state) {
 288         case RUNNING:
 289           listener.onTaskRunning(task);
 290           break;
 291         case START:
 292           listener.onTaskStart(task);
 293           break;
 294         case STOP:
 295           listener.onTaskStop(task);
 296           break;
 297         case RESUME:
 298           listener.onTaskResume(task);
 299           break;
 300         case PRE:
 301           listener.onTaskPre(task);
 302           break;
 303         case CANCEL:
 304           listener.onTaskCancel(task);
 305           break;
 306         case COMPLETE:
 307           listener.onTaskComplete(task);
 308           break;
 309         case FAIL:
 310           listener.onTaskFail(task);
 311           break;
 312         case SUPPORT_BREAK_POINT:
 313           listener.onNoSupportBreakPoint(task);
 314           break;
 315       }
 316     }
 317   }
 318 
 319   /**
 320    * 处理下载任务下载失败的情形
 321    *
 322    * @param task 下载任务
 323    */
 324 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 325   @Override public void handleFailTask(final Task task) {</span>
 326 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328         case START:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329           listener.onTaskStart(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331         case STOP:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332           listener.onTaskStop(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334         case RESUME:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335           listener.onTaskResume(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337         case PRE:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338           listener.onTaskPre(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340         case CANCEL:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341           listener.onTaskCancel(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343         case COMPLETE:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344           listener.onTaskComplete(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346         case FAIL:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347           listener.onTaskFail(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354    * 处理下载任务下载失败的情形</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355    *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356    * @param entity 失败实体</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357    */</span>
 358 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359   private void handleFailTask(final DownloadTask task) {</span>
 360 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 361     final Configuration config = Configuration.getInstance();
 362     CountDownTimer timer = new CountDownTimer(config.getReTryInterval(), 1000) {
 363       @Override public void onTick(long millisUntilFinished) {
 364 
 365       }
 366 
 367       @Override public void onFinish() {
 368         DownloadEntity entity = task.getDownloadEntity();
 369 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 370         if (entity.getFailNum() &lt;= config.getReTryNum()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 371           Task task = mQueue.getTask(entity);</span>
 372 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374         case PRE:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375           listener.onTaskPre(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377         case CANCEL:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378           listener.onTaskCancel(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380         case COMPLETE:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381           listener.onTaskComplete(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383         case FAIL:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384           listener.onTaskFail(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391    * 处理下载任务下载失败的情形</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392    *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393    * @param entity 失败实体</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395   @Override public void handleFailTask(final DownloadEntity entity) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396     final Configuration config = Configuration.getInstance();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397     CountDownTimer timer = new CountDownTimer(config.getReTryInterval(), 1000) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398       @Override public void onTick(long millisUntilFinished) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402       @Override public void onFinish() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403         if (entity.getFailNum() &lt;= config.getReTryNum()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404           Task task = mQueue.getTask(entity);</span>
 405 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406         if (entity.getFailNum() &lt; config.getReTryNum()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407           DownloadTask task = mQueue.getTask(entity);</span>
 408 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 409           mQueue.reTryStart(task);
 410           try {
 411             Thread.sleep(config.getReTryInterval());
 412           } catch (InterruptedException e) {
 413             e.printStackTrace();
 414           }
 415         } else {
 416           mQueue.removeTask(entity);
 417 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 418           startNextTask(entity);</span>
 419 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420         case FAIL:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421           listener.onTaskFail(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428    * 处理下载任务下载失败的情形</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429    *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430    * @param entity 失败实体</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432   @Override public void handleFailTask(final DownloadEntity entity) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433     final Configuration config = Configuration.getInstance();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434     CountDownTimer timer = new CountDownTimer(config.getReTryInterval(), 1000) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435       @Override public void onTick(long millisUntilFinished) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439       @Override public void onFinish() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440         if (entity.getFailNum() &lt;= config.getReTryNum()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441           Task task = mQueue.getTask(entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442           mQueue.reTryStart(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443           try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444             Thread.sleep(config.getReTryInterval());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445           } catch (InterruptedException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449           startNextTask(entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450         }</span>
 451 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452           startNextTask();</span>
 453 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 454         }
 455       }
 456     };
 457     timer.start();
 458   }
 459 
 460   /**
 461    * 启动下一个任务，条件：任务停止，取消下载，任务完成
 462    */
 463   private void startNextTask() {
 464     DownloadTask newTask = mQueue.getNextTask();
 465     if (newTask == null) {
 466       Log.w(TAG, &quot;没有下一任务&quot;);
 467       return;
 468     }
 469     if (newTask.getDownloadEntity().getState() == DownloadEntity.STATE_WAIT) {
 470       mQueue.startTask(newTask);
 471     }
 472   }
 473 }</pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.arialyy.aria.core.scheduler;
  18 
  19 import android.os.CountDownTimer;
  20 import android.os.Message;
  21 import android.util.Log;
  22 import com.arialyy.aria.core.queue.DownloadTaskQueue;
  23 import com.arialyy.aria.core.download.DownloadEntity;
  24 import com.arialyy.aria.core.download.DownloadTask;
  25 import com.arialyy.aria.util.Configuration;
  26 import java.util.Iterator;
  27 import java.util.Map;
  28 import java.util.Set;
  29 import java.util.concurrent.ConcurrentHashMap;
  30 
  31 /**
  32  * Created by lyy on 2016/8/16.
  33  * 任务下载器，提供抽象的方法供具体的实现类操作
  34  */
  35 public class DownloadSchedulers implements ISchedulers&lt;DownloadTask&gt; {
  36 
  37   private static final String TAG = &quot;DownloadSchedulers&quot;;
  38   private static final Object LOCK = new Object();
  39   private static volatile DownloadSchedulers INSTANCE = null;
  40 
  41   /**
  42    * 下载器任务监听
  43    */
  44   private Map&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt; mSchedulerListeners =
  45       new ConcurrentHashMap&lt;&gt;();
  46   private DownloadTaskQueue mQueue;
  47 
  48   private DownloadSchedulers() {
  49     mQueue = DownloadTaskQueue.getInstance();
  50   }
  51 
  52   public static DownloadSchedulers getInstance() {
  53     if (INSTANCE == null) {
  54       synchronized (LOCK) {
  55         INSTANCE = new DownloadSchedulers();
  56       }
  57     }
  58     return INSTANCE;
  59   }
  60 
  61   @Override public void addSchedulerListener(String targetName,
  62       ISchedulerListener&lt;DownloadTask&gt; schedulerListener) {
  63     mSchedulerListeners.put(targetName,
  64         (IDownloadSchedulerListener&lt;DownloadTask&gt;) schedulerListener);
  65   }
  66 
  67   @Override public void removeSchedulerListener(String targetName,
  68       ISchedulerListener&lt;DownloadTask&gt; schedulerListener) {
<abbr title="  69     //该内存溢出解决方案：http://stackoverflow.com/questions/14585829/how-safe-is-to-delete-already-removed-concurrenthashmap-element">  69     //该内存溢出解决方案：http://stackoverflow.com/questions/14585829/how-safe-is-to-delete-already-removed-concurr🔵</abbr>
  70     for (Iterator&lt;Map.Entry&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt;&gt; iter =
  71         mSchedulerListeners.entrySet().iterator(); iter.hasNext(); ) {
  72       Map.Entry&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt; entry = iter.next();
  73       if (entry.getKey().equals(targetName)) iter.remove();
  74     }
  75   }
  76 
  77   @Override public boolean handleMessage(Message msg) {
  78     DownloadTask task = (DownloadTask) msg.obj;
  79     if (task == null) {
  80       Log.e(TAG, &quot;请传入下载任务&quot;);
  81       return true;
  82     }
  83     callback(msg.what, task);
  84     DownloadEntity entity = task.getDownloadEntity();
  85     switch (msg.what) {
  86       case STOP:
  87       case CANCEL:
  88         mQueue.removeTask(entity);
  89         if (mQueue.size() &lt; Configuration.getInstance().getDownloadNum()) {
  90           startNextTask();
  91         }
  92         break;
  93       case COMPLETE:
  94         mQueue.removeTask(entity);
  95         startNextTask();
  96         break;
  97       case FAIL:
  98 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
  99 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100         mQueue.removeTask(entity);</span>
 101 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102         //mQueue.removeTask(entity);</span>
 103 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 104         handleFailTask(task);
 105         break;
 106     }
 107     return true;
 108   }
 109 
 110   /**
 111    * 回调
 112    *
 113    * @param state 状态
 114    */
 115   private void callback(int state, DownloadTask task) {
 116     if (mSchedulerListeners.size() &gt; 0) {
 117       //if (!TextUtils.isEmpty(task.getTargetName())) {
 118       //  callback(state, task, mSchedulerListeners.get(task.getTargetName()));
 119       //}
 120       Set&lt;String&gt; keys = mSchedulerListeners.keySet();
 121       for (String key : keys) {
 122         callback(state, task, mSchedulerListeners.get(key));
 123       }
 124     }
 125   }
 126 
 127   private void callback(int state, DownloadTask task,
 128       IDownloadSchedulerListener&lt;DownloadTask&gt; listener) {
 129     if (listener != null) {
 130       if (task == null) {
 131         Log.e(TAG, &quot;TASK 为null，回调失败&quot;);
 132         return;
 133       }
 134       switch (state) {
 135         case RUNNING:
 136           listener.onTaskRunning(task);
 137           break;
 138         case START:
 139           listener.onTaskStart(task);
 140           break;
 141         case STOP:
 142           listener.onTaskStop(task);
 143           break;
 144         case RESUME:
 145           listener.onTaskResume(task);
 146           break;
 147         case PRE:
 148           listener.onTaskPre(task);
 149           break;
 150         case CANCEL:
 151           listener.onTaskCancel(task);
 152           break;
 153         case COMPLETE:
 154           listener.onTaskComplete(task);
 155           break;
 156         case FAIL:
 157           listener.onTaskFail(task);
 158           break;
 159         case SUPPORT_BREAK_POINT:
 160           listener.onNoSupportBreakPoint(task);
 161           break;
 162       }
 163     }
 164   }
 165 
 166   /**
 167    * 处理下载任务下载失败的情形
 168    *
 169    * @param task 下载任务
 170    */
 171 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172   @Override public void handleFailTask(final Task task) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173     final Configuration config = Configuration.getInstance();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174     CountDownTimer timer = new CountDownTimer(config.getReTryInterval(), 1000) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175       @Override public void onTick(long millisUntilFinished) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179       @Override public void onFinish() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180         DownloadEntity entity = task.getDownloadEntity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181         if (entity.getFailNum() &lt;= config.getReTryNum()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182           Task task = mQueue.getTask(entity);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183           mQueue.reTryStart(task);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184           try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185             Thread.sleep(config.getReTryInterval());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186           } catch (InterruptedException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187             e.printStackTrace();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190           mQueue.removeTask(entity);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191           startNextTask(entity);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194     };</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195     timer.start();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196   }</span>
 197 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198   @Override public void handleFailTask(final DownloadEntity entity) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199     final Configuration config = Configuration.getInstance();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200     CountDownTimer timer = new CountDownTimer(config.getReTryInterval(), 1000) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201       @Override public void onTick(long millisUntilFinished) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205       @Override public void onFinish() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         if (entity.getFailNum() &lt;= config.getReTryNum()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207           Task task = mQueue.getTask(entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208           mQueue.reTryStart(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209           try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210             Thread.sleep(config.getReTryInterval());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211           } catch (InterruptedException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215           startNextTask(entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218     };</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219     timer.start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220   }</span>
 221 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222   private void handleFailTask(final DownloadTask task) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223     final Configuration config = Configuration.getInstance();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224     CountDownTimer timer = new CountDownTimer(config.getReTryInterval(), 1000) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225       @Override public void onTick(long millisUntilFinished) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229       @Override public void onFinish() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230         DownloadEntity entity = task.getDownloadEntity();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231         if (entity.getFailNum() &lt; config.getReTryNum()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232           DownloadTask task = mQueue.getTask(entity);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233           mQueue.reTryStart(task);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234           try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235             Thread.sleep(config.getReTryInterval());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236           } catch (InterruptedException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238           }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240           mQueue.removeTask(entity);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241           startNextTask();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243       }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244     };</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245     timer.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246   }</span>
 247 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 248 
 249   /**
 250    * 启动下一个任务，条件：任务停止，取消下载，任务完成
 251    */
 252   private void startNextTask() {
 253     DownloadTask newTask = mQueue.getNextTask();
 254     if (newTask == null) {
 255       Log.w(TAG, &quot;没有下一任务&quot;);
 256       return;
 257     }
 258     if (newTask.getDownloadEntity().getState() == DownloadEntity.STATE_WAIT) {
 259       mQueue.startTask(newTask);
 260     }
 261   }
 262 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.arialyy.aria.core.scheduler;
  17 
  18 import android.os.CountDownTimer;
  19 import android.os.Message;
  20 import android.util.Log;
  21 import com.arialyy.aria.core.download.DownloadEntity;
  22 import com.arialyy.aria.core.download.DownloadTask;
  23 import com.arialyy.aria.core.queue.DownloadTaskQueue;
  24 import com.arialyy.aria.util.Configuration;
  25 import java.util.Iterator;
  26 import java.util.Map;
  27 import java.util.Set;
  28 import java.util.concurrent.ConcurrentHashMap;
  29 
  30 
  31 /**
  32  * Created by lyy on 2016/8/16.
  33  * 任务下载器，提供抽象的方法供具体的实现类操作
  34  */
  35 public class DownloadSchedulers implements ISchedulers&lt;DownloadTask&gt; {
  36   private static final String TAG = &quot;DownloadSchedulers&quot;;
  37 
  38   private static final Object LOCK = new Object();
  39 
  40   private static volatile DownloadSchedulers INSTANCE = null;
  41 
  42   /**
  43    * 下载器任务监听
  44    */
<abbr title="  45   private Map&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt; mSchedulerListeners = new ConcurrentHashMap&lt;&gt;();">  45   private Map&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt; mSchedulerListeners = new ConcurrentHashM🔵</abbr>
  46 
  47   private DownloadTaskQueue mQueue;
  48 
  49   private DownloadSchedulers() {
  50     mQueue = DownloadTaskQueue.getInstance();
  51   }
  52 
  53   public static DownloadSchedulers getInstance() {
  54     if (INSTANCE == null) {
  55       synchronized(LOCK) {
  56         INSTANCE = new DownloadSchedulers();
  57       }
  58     }
  59     return INSTANCE;
  60   }
  61 
  62   @Override
<abbr title="  63   public void addSchedulerListener(String targetName, ISchedulerListener&lt;DownloadTask&gt; schedulerListener) {">  63   public void addSchedulerListener(String targetName, ISchedulerListener&lt;DownloadTask&gt; schedulerListener)🔵</abbr>
<abbr title="  64     mSchedulerListeners.put(targetName, ((IDownloadSchedulerListener&lt;DownloadTask&gt;) (schedulerListener)));">  64     mSchedulerListeners.put(targetName, ((IDownloadSchedulerListener&lt;DownloadTask&gt;) (schedulerListener)))🔵</abbr>
  65   }
  66 
  67   @Override
<abbr title="  68   public void removeSchedulerListener(String targetName, ISchedulerListener&lt;DownloadTask&gt; schedulerListener) {">  68   public void removeSchedulerListener(String targetName, ISchedulerListener&lt;DownloadTask&gt; schedulerListen🔵</abbr>
<abbr title="  69     //该内存溢出解决方案：http://stackoverflow.com/questions/14585829/how-safe-is-to-delete-already-removed-concurrenthashmap-element">  69     //该内存溢出解决方案：http://stackoverflow.com/questions/14585829/how-safe-is-to-delete-already-removed-concurr🔵</abbr>
<abbr title="  70     for (Iterator&lt;Map.Entry&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt;&gt; iter = mSchedulerListeners.entrySet().iterator(); iter.hasNext();) {">  70     for (Iterator&lt;Map.Entry&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt;&gt; iter = mSchedulerListeners🔵</abbr>
  71       Map.Entry&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt; entry = iter.next();
  72       if (entry.getKey().equals(targetName)) {
  73         iter.remove();
  74       }
  75     }
  76   }
  77 
  78   @Override
  79   public boolean handleMessage(Message msg) {
  80     DownloadTask task = ((DownloadTask) (msg.obj));
  81     if (task == null) {
  82       Log.e(TAG, &quot;请传入下载任务&quot;);
  83       return true;
  84     }
  85     callback(msg.what, task);
  86     DownloadEntity entity = task.getDownloadEntity();
  87     switch (msg.what) {
  88       case STOP :
  89       case CANCEL :
  90         mQueue.removeTask(entity);
  91         if (mQueue.size() &lt; Configuration.getInstance().getDownloadNum()) {
  92           startNextTask();
  93         }
  94         break;
  95       case COMPLETE :
  96         mQueue.removeTask(entity);
  97         startNextTask();
  98         break;
  99       case FAIL :
 100         //mQueue.removeTask(entity);
 101         handleFailTask(task);
 102         break;
 103     }
 104     return true;
 105   }
 106 
 107   /**
 108    * 回调
 109    *
 110    * @param state 状态
 111    */
 112   private void callback(int state, DownloadTask task) {
 113     if (mSchedulerListeners.size() &gt; 0) {
 114       //if (!TextUtils.isEmpty(task.getTargetName())) {
 115       //  callback(state, task, mSchedulerListeners.get(task.getTargetName()));
 116       //}
 117       Set&lt;String&gt; keys = mSchedulerListeners.keySet();
 118       for (String key : keys) {
 119         callback(state, task, mSchedulerListeners.get(key));
 120       }
 121     }
 122   }
 123 
<abbr title=" 124   private void callback(int state, DownloadTask task, IDownloadSchedulerListener&lt;DownloadTask&gt; listener) {"> 124   private void callback(int state, DownloadTask task, IDownloadSchedulerListener&lt;DownloadTask&gt; listener) 🔵</abbr>
 125     if (listener != null) {
 126       if (task == null) {
 127         Log.e(TAG, &quot;TASK 为null，回调失败&quot;);
 128         return;
 129       }
 130       switch (state) {
 131         case RUNNING :
 132           listener.onTaskRunning(task);
 133           break;
 134         case START :
 135           listener.onTaskStart(task);
 136           break;
 137         case STOP :
 138           listener.onTaskStop(task);
 139           break;
 140         case RESUME :
 141           listener.onTaskResume(task);
 142           break;
 143         case PRE :
 144           listener.onTaskPre(task);
 145           break;
 146         case CANCEL :
 147           listener.onTaskCancel(task);
 148           break;
 149         case COMPLETE :
 150           listener.onTaskComplete(task);
 151           break;
 152         case FAIL :
 153           listener.onTaskFail(task);
 154           break;
 155         case SUPPORT_BREAK_POINT :
 156           listener.onNoSupportBreakPoint(task);
 157           break;
 158       }
 159     }
 160   }
 161 
 162   /**
 163    * 处理下载任务下载失败的情形
 164    *
 165    * @param entity 失败实体
 166    */
 167   private void handleFailTask(final
 168 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169 Task</span>
 170 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 171 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 171 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 172 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174 DownloadTask</span>
 175 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 176    task) {
 177     final Configuration config = Configuration.getInstance();
 178     CountDownTimer timer = new CountDownTimer(config.getReTryInterval(), 1000) {
 179       @Override public void onTick(long millisUntilFinished) {
 180 
 181       }
 182 
 183       @Override
 184       public void onFinish() {
 185         DownloadEntity entity = task.getDownloadEntity();
 186         if (entity.getFailNum() &lt; config.getReTryNum()) {
 187           DownloadTask task = mQueue.getTask(entity);
 188           mQueue.reTryStart(task);
 189           try {
 190             Thread.sleep(config.getReTryInterval());
 191           } catch (java.lang.InterruptedException e) {
 192             e.printStackTrace();
 193           }
 194         } else {
 195           mQueue.removeTask(entity);
 196           startNextTask();
 197         }
 198       }
 199     };
 200     timer.start();
 201   }
 202 
 203   /**
 204    * 启动下一个任务，条件：任务停止，取消下载，任务完成
 205    */
 206   private void startNextTask() {
 207     DownloadTask newTask = mQueue.getNextTask();
 208     if (newTask == null) {
 209       Log.w(TAG, &quot;没有下一任务&quot;);
 210       return;
 211     }
 212     if (newTask.getDownloadEntity().getState() == DownloadEntity.STATE_WAIT) {
 213       mQueue.startTask(newTask);
 214     }
 215   }
 216 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.arialyy.aria.core.scheduler;
  18  
  19  import android.os.CountDownTimer;
  20  import android.os.Message;
  21  import android.text.TextUtils;
  22  import android.util.Log;
  23  import com.arialyy.aria.core.DownloadManager;
  24  import com.arialyy.aria.core.queue.ITaskQueue;
  25  import com.arialyy.aria.core.DownloadEntity;
  26  import com.arialyy.aria.core.task.Task;



  27  import com.arialyy.aria.util.Configuration;
  28  import java.util.Iterator;
  29  import java.util.Map;
  30  import java.util.Set;
  31  import java.util.concurrent.ConcurrentHashMap;
  32  
  33  /**
  34   * Created by lyy on 2016/8/16.
  35   * 任务下载器，提供抽象的方法供具体的实现类操作
  36   */
  37  public class DownloadSchedulers implements IDownloadSchedulers {
  38    /**
  39     * 任务预加载
  40     */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -  public static final int PRE = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +  public static final     int                PRE      = 0;</span>
  43    /**
  44     * 任务开始
  45     */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -  public static final int START = 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +  public static final     int                START    = 1;</span>
  48    /**
  49     * 任务停止
  50     */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -  public static final int STOP = 2;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +  public static final     int                STOP     = 2;</span>
  53    /**
  54     * 任务失败
  55     */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -  public static final int FAIL = 3;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +  public static final     int                FAIL     = 3;</span>
  58    /**
  59     * 任务取消
  60     */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -  public static final int CANCEL = 4;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +  public static final     int                CANCEL   = 4;</span>
  63    /**
  64     * 任务完成
  65     */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -  public static final int COMPLETE = 5;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +  public static final     int                COMPLETE = 5;</span>
  68    /**
  69     * 下载中
  70     */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -  public static final int RUNNING = 6;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +  public static final     int                RUNNING  = 6;</span>
  73    /**
  74     * 恢复下载
  75     */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -  public static final int RESUME = 7;</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -  private static final String TAG = &quot;DownloadSchedulers&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -  private static final Object LOCK = new Object();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +  public static final     int                RESUME   = 7;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +  private static final    String             TAG      = &quot;DownloadSchedulers&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +  private static final    Object             LOCK     = new Object();</span>
  82    private static volatile DownloadSchedulers INSTANCE = null;
  83  
  84    /**
  85     * 下载器任务监听
  86     */
  87    Map&lt;String, OnSchedulerListener&gt; mSchedulerListeners = new ConcurrentHashMap&lt;&gt;();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -  DownloadManager mManager = DownloadManager.getInstance();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +  DownloadManager                  mManager            = DownloadManager.getInstance();</span>
  90    ITaskQueue mQueue;



  91  
  92    private DownloadSchedulers() {
  93      mQueue = mManager.getTaskQueue();

  94    }
  95  
  96    public static DownloadSchedulers getInstance() {
  97      if (INSTANCE == null) {
  98        synchronized (LOCK) {
  99          //INSTANCE = new DownloadSchedulers(queue);
 100          INSTANCE = new DownloadSchedulers();
 101        }
 102      }
 103      return INSTANCE;
 104    }
 105  
 106    @Override
 107    public void addSchedulerListener(String targetName, OnSchedulerListener schedulerListener) {
 108      mSchedulerListeners.put(targetName, schedulerListener);
 109    }
 110  
 111    @Override
 112    public void removeSchedulerListener(String targetName, OnSchedulerListener schedulerListener) {
 113      //OnSchedulerListener listener = mSchedulerListeners.get(target.getClass().getName());
 114      //mSchedulerListeners.remove(listener);








<abbr title=" 115      //该内存溢出解决方案：http://stackoverflow.com/questions/14585829/how-safe-is-to-delete-already-removed-concurrenthashmap-element"> 115      //该内存溢出解决方案：http://stackoverflow.com/questions/14585829/how-safe-is-to-delete-already-removed-concurrenthashma🔵</abbr>
 116      for (Iterator&lt;Map.Entry&lt;String, OnSchedulerListener&gt;&gt; iter =

 117          mSchedulerListeners.entrySet().iterator(); iter.hasNext(); ) {
 118        Map.Entry&lt;String, OnSchedulerListener&gt; entry = iter.next();

 119        if (entry.getKey().equals(targetName)) iter.remove();
 120      }
 121    }
 122  
 123    @Override public boolean handleMessage(Message msg) {
 124      Task task = (Task) msg.obj;

 125      if (task == null) {
 126        Log.e(TAG, &quot;请传入下载任务&quot;);
 127        return true;
 128      }
 129      callback(msg.what, task);
 130      DownloadEntity entity = task.getDownloadEntity();
 131      switch (msg.what) {
 132        case STOP:
 133        case CANCEL:
 134          mQueue.removeTask(entity);
 135          if (mQueue.size() &lt; Configuration.getInstance().getDownloadNum()) {
 136            startNextTask(entity);

 137          }
 138          break;
 139        case COMPLETE:
 140          mQueue.removeTask(entity);
 141          startNextTask(entity);

 142          break;
 143        case FAIL:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        mQueue.removeTask(entity);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -        handleFailTask(entity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +        handleFailTask(task);</span>

 147          break;
 148      }
 149      return true;
 150    }
 151  
 152    /**
 153     * 回调
 154     *
 155     * @param state 状态
 156     */
 157    private void callback(int state, Task task) {

 158      if (mSchedulerListeners.size() &gt; 0) {
 159        //if (!TextUtils.isEmpty(task.getTargetName())) {
 160        //  callback(state, task, mSchedulerListeners.get(task.getTargetName()));
 161        //}
 162        Set&lt;String&gt; keys = mSchedulerListeners.keySet();
 163        for (String key : keys) {
 164          callback(state, task, mSchedulerListeners.get(key));
 165        }
 166      }
 167    }
 168  
 169    private void callback(int state, Task task, OnSchedulerListener listener) {


 170      if (listener != null) {
 171        if (task == null) {
 172          Log.e(TAG, &quot;TASK 为null，回调失败&quot;);
 173          return;
 174        }
 175        switch (state) {
 176          case RUNNING:
 177            listener.onTaskRunning(task);
 178            break;
 179          case START:
 180            listener.onTaskStart(task);
 181            break;
 182          case STOP:
 183            listener.onTaskStop(task);
 184            break;
 185          case RESUME:
 186            listener.onTaskResume(task);
 187            break;
 188          case PRE:
 189            listener.onTaskPre(task);
 190            break;
 191          case CANCEL:
 192            listener.onTaskCancel(task);
 193            break;
 194          case COMPLETE:
 195            listener.onTaskComplete(task);
 196            break;
 197          case FAIL:
 198            listener.onTaskFail(task);
 199            break;



 200        }
 201      }
 202    }
 203  
 204    /**
 205     * 处理下载任务下载失败的情形
 206     *
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -   * @param entity 失败实体</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -  @Override public void handleFailTask(final DownloadEntity entity) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +   * @param task 下载任务</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +  @Override public void handleFailTask(final Task task) {</span>
 213      final Configuration config = Configuration.getInstance();
 214      CountDownTimer timer = new CountDownTimer(config.getReTryInterval(), 1000) {
 215        @Override public void onTick(long millisUntilFinished) {
 216  
 217        }
 218  
 219        @Override public void onFinish() {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +        DownloadEntity entity = task.getDownloadEntity();</span>
 221          if (entity.getFailNum() &lt;= config.getReTryNum()) {
 222            Task task = mQueue.getTask(entity);



 223            mQueue.reTryStart(task);
 224            try {
 225              Thread.sleep(config.getReTryInterval());
 226            } catch (InterruptedException e) {
 227              e.printStackTrace();
 228            }
 229          } else {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +          mQueue.removeTask(entity);</span>
 231            startNextTask(entity);


 232          }
 233        }
 234      };
 235      timer.start();
 236    }
 237  
 238    /**
 239     * 启动下一个任务，条件：任务停止，取消下载，任务完成
 240     *
 241     * @param entity 通过Handler传递的下载实体
 242     */
 243    @Override public void startNextTask(DownloadEntity entity) {
 244      Task newTask = mQueue.getNextTask();



 245      if (newTask == null) {
 246        Log.w(TAG, &quot;没有下一任务&quot;);
 247        return;
 248      }
 249      if (newTask.getDownloadEntity().getState() == DownloadEntity.STATE_WAIT) {
 250        mQueue.startTask(newTask);
 251      }
 252    }
 253  }</pre></td>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.arialyy.aria.core.scheduler;
  18  
  19  import android.os.CountDownTimer;
  20  import android.os.Message;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import android.text.TextUtils;</span>
  22  import android.util.Log;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.arialyy.aria.core.DownloadManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.arialyy.aria.core.queue.ITaskQueue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import com.arialyy.aria.core.DownloadEntity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.arialyy.aria.core.task.Task;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import com.arialyy.aria.core.queue.DownloadTaskQueue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import com.arialyy.aria.core.download.DownloadEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import com.arialyy.aria.core.download.DownloadTask;</span>
  30  import com.arialyy.aria.util.Configuration;
  31  import java.util.Iterator;
  32  import java.util.Map;
  33  import java.util.Set;
  34  import java.util.concurrent.ConcurrentHashMap;
  35  
  36  /**
  37   * Created by lyy on 2016/8/16.
  38   * 任务下载器，提供抽象的方法供具体的实现类操作
  39   */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -public class DownloadSchedulers implements IDownloadSchedulers {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -   * 任务预加载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -  public static final int PRE = 0;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -   * 任务开始</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -  public static final int START = 1;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -   * 任务停止</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -  public static final int STOP = 2;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -   * 任务失败</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -  public static final int FAIL = 3;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -   * 任务取消</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -  public static final int CANCEL = 4;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -   * 任务完成</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -  public static final int COMPLETE = 5;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -   * 下载中</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -  public static final int RUNNING = 6;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -   * 恢复下载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -  public static final int RESUME = 7;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +public class DownloadSchedulers implements ISchedulers&lt;DownloadTask&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +</span>
  75    private static final String TAG = &quot;DownloadSchedulers&quot;;
  76    private static final Object LOCK = new Object();



  77    private static volatile DownloadSchedulers INSTANCE = null;
  78  
  79    /**
  80     * 下载器任务监听
  81     */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -  Map&lt;String, OnSchedulerListener&gt; mSchedulerListeners = new ConcurrentHashMap&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -  DownloadManager mManager = DownloadManager.getInstance();</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -  ITaskQueue mQueue;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +  private Map&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt; mSchedulerListeners =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +      new ConcurrentHashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +  private DownloadTaskQueue mQueue;</span>
  88  
  89    private DownloadSchedulers() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -    mQueue = mManager.getTaskQueue();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +    mQueue = DownloadTaskQueue.getInstance();</span>
  92    }
  93  
  94    public static DownloadSchedulers getInstance() {
  95      if (INSTANCE == null) {
  96        synchronized (LOCK) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -        //INSTANCE = new DownloadSchedulers(queue);</span>
  98          INSTANCE = new DownloadSchedulers();
  99        }
 100      }
 101      return INSTANCE;
 102    }
 103  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -  @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -  public void addSchedulerListener(String targetName, OnSchedulerListener schedulerListener) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -    mSchedulerListeners.put(targetName, schedulerListener);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -  @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -  public void removeSchedulerListener(String targetName, OnSchedulerListener schedulerListener) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -    //OnSchedulerListener listener = mSchedulerListeners.get(target.getClass().getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -    //mSchedulerListeners.remove(listener);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +  @Override public void addSchedulerListener(String targetName,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +      ISchedulerListener&lt;DownloadTask&gt; schedulerListener) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +    mSchedulerListeners.put(targetName,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +        (IDownloadSchedulerListener&lt;DownloadTask&gt;) schedulerListener);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +  }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +  @Override public void removeSchedulerListener(String targetName,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +      ISchedulerListener&lt;DownloadTask&gt; schedulerListener) {</span>
<abbr title=" 121      //该内存溢出解决方案：http://stackoverflow.com/questions/14585829/how-safe-is-to-delete-already-removed-concurrenthashmap-element"> 121      //该内存溢出解决方案：http://stackoverflow.com/questions/14585829/how-safe-is-to-delete-already-removed-concurrenthashma🔵</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -    for (Iterator&lt;Map.Entry&lt;String, OnSchedulerListener&gt;&gt; iter =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +    for (Iterator&lt;Map.Entry&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt;&gt; iter =</span>
 124          mSchedulerListeners.entrySet().iterator(); iter.hasNext(); ) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -      Map.Entry&lt;String, OnSchedulerListener&gt; entry = iter.next();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +      Map.Entry&lt;String, IDownloadSchedulerListener&lt;DownloadTask&gt;&gt; entry = iter.next();</span>
 127        if (entry.getKey().equals(targetName)) iter.remove();
 128      }
 129    }
 130  
 131    @Override public boolean handleMessage(Message msg) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -    Task task = (Task) msg.obj;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +    DownloadTask task = (DownloadTask) msg.obj;</span>
 134      if (task == null) {
 135        Log.e(TAG, &quot;请传入下载任务&quot;);
 136        return true;
 137      }
 138      callback(msg.what, task);
 139      DownloadEntity entity = task.getDownloadEntity();
 140      switch (msg.what) {
 141        case STOP:
 142        case CANCEL:
 143          mQueue.removeTask(entity);
 144          if (mQueue.size() &lt; Configuration.getInstance().getDownloadNum()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -          startNextTask(entity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +          startNextTask();</span>
 147          }
 148          break;
 149        case COMPLETE:
 150          mQueue.removeTask(entity);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -        startNextTask(entity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +        startNextTask();</span>
 153          break;
 154        case FAIL:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -        mQueue.removeTask(entity);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -        handleFailTask(entity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +        //mQueue.removeTask(entity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +        handleFailTask(task);</span>
 159          break;
 160      }
 161      return true;
 162    }
 163  
 164    /**
 165     * 回调
 166     *
 167     * @param state 状态
 168     */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -  private void callback(int state, Task task) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +  private void callback(int state, DownloadTask task) {</span>
 171      if (mSchedulerListeners.size() &gt; 0) {
 172        //if (!TextUtils.isEmpty(task.getTargetName())) {
 173        //  callback(state, task, mSchedulerListeners.get(task.getTargetName()));
 174        //}
 175        Set&lt;String&gt; keys = mSchedulerListeners.keySet();
 176        for (String key : keys) {
 177          callback(state, task, mSchedulerListeners.get(key));
 178        }
 179      }
 180    }
 181  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -  private void callback(int state, Task task, OnSchedulerListener listener) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +  private void callback(int state, DownloadTask task,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +      IDownloadSchedulerListener&lt;DownloadTask&gt; listener) {</span>
 185      if (listener != null) {
 186        if (task == null) {
 187          Log.e(TAG, &quot;TASK 为null，回调失败&quot;);
 188          return;
 189        }
 190        switch (state) {
 191          case RUNNING:
 192            listener.onTaskRunning(task);
 193            break;
 194          case START:
 195            listener.onTaskStart(task);
 196            break;
 197          case STOP:
 198            listener.onTaskStop(task);
 199            break;
 200          case RESUME:
 201            listener.onTaskResume(task);
 202            break;
 203          case PRE:
 204            listener.onTaskPre(task);
 205            break;
 206          case CANCEL:
 207            listener.onTaskCancel(task);
 208            break;
 209          case COMPLETE:
 210            listener.onTaskComplete(task);
 211            break;
 212          case FAIL:
 213            listener.onTaskFail(task);
 214            break;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +        case SUPPORT_BREAK_POINT:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +          listener.onNoSupportBreakPoint(task);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +          break;</span>
 218        }
 219      }
 220    }
 221  
 222    /**
 223     * 处理下载任务下载失败的情形
 224     *
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -   * @param entity 失败实体</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -  @Override public void handleFailTask(final DownloadEntity entity) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +   * @param task 下载任务</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +  private void handleFailTask(final DownloadTask task) {</span>
 231      final Configuration config = Configuration.getInstance();
 232      CountDownTimer timer = new CountDownTimer(config.getReTryInterval(), 1000) {
 233        @Override public void onTick(long millisUntilFinished) {
 234  
 235        }
 236  
 237        @Override public void onFinish() {

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -        if (entity.getFailNum() &lt;= config.getReTryNum()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -          Task task = mQueue.getTask(entity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +        DownloadEntity entity = task.getDownloadEntity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +        if (entity.getFailNum() &lt; config.getReTryNum()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +          DownloadTask task = mQueue.getTask(entity);</span>
 243            mQueue.reTryStart(task);
 244            try {
 245              Thread.sleep(config.getReTryInterval());
 246            } catch (InterruptedException e) {
 247              e.printStackTrace();
 248            }
 249          } else {

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -          startNextTask(entity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +          mQueue.removeTask(entity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +          startNextTask();</span>
 253          }
 254        }
 255      };
 256      timer.start();
 257    }
 258  
 259    /**
 260     * 启动下一个任务，条件：任务停止，取消下载，任务完成
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -   *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -   * @param entity 通过Handler传递的下载实体</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -  @Override public void startNextTask(DownloadEntity entity) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -    Task newTask = mQueue.getNextTask();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +   */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +  private void startNextTask() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +    DownloadTask newTask = mQueue.getNextTask();</span>
 269      if (newTask == null) {
 270        Log.w(TAG, &quot;没有下一任务&quot;);
 271        return;
 272      }
 273      if (newTask.getDownloadEntity().getState() == DownloadEntity.STATE_WAIT) {
 274        mQueue.startTask(newTask);
 275      }
 276    }
 277  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            