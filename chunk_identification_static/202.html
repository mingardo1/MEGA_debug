<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>202</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    202
                    <a href="201.html">prev</a>
                    <a href="203.html">next</a>
                    <a href="202_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_6bb99c2e165c1531f99c2c66b0212e1f0df50635_admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/service/FormBuilderServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;6bb99c2e165c1531f99c2c66b0212e1f0df50635:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/service/FormBuilderServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;6bb99c2e165c1531f99c2c66b0212e1f0df50635^1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/service/FormBuilderServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;6bb99c2e165c1531f99c2c66b0212e1f0df50635^2:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/service/FormBuilderServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;df478ca5d04870811a3cd35fc095ce4923365ab4:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/service/FormBuilderServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.service;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.Predicate;
  22 import org.apache.commons.lang.ArrayUtils;
  23 import org.apache.commons.lang.BooleanUtils;
  24 import org.apache.commons.lang3.StringUtils;
  25 import org.apache.commons.logging.Log;
  26 import org.apache.commons.logging.LogFactory;
  27 import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  28 import org.broadleafcommerce.common.exception.ExceptionHelper;
  29 import org.broadleafcommerce.common.exception.SecurityServiceException;
  30 import org.broadleafcommerce.common.exception.ServiceException;
  31 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  32 import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  33 import org.broadleafcommerce.common.i18n.service.TranslationService;
  34 import org.broadleafcommerce.common.locale.service.LocaleService;
  35 import org.broadleafcommerce.common.media.domain.MediaDto;
  36 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  37 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  38 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  39 import org.broadleafcommerce.common.presentation.client.AdornedTargetAddMethodType;
  40 import org.broadleafcommerce.common.presentation.client.LookupType;
  41 import org.broadleafcommerce.common.presentation.client.PersistencePerspectiveItemType;
  42 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  43 import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  44 import org.broadleafcommerce.common.util.BLCMessageUtils;
  45 import org.broadleafcommerce.common.util.FormatUtil;
  46 import org.broadleafcommerce.common.util.StringUtil;
  47 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  48 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  49 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  50 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  51 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  52 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  53 import org.broadleafcommerce.openadmin.dto.ClassTree;
  54 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  55 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  56 import org.broadleafcommerce.openadmin.dto.Entity;
  57 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  58 import org.broadleafcommerce.openadmin.dto.ForeignKey;
  59 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  60 import org.broadleafcommerce.openadmin.dto.MapStructure;
  61 import org.broadleafcommerce.openadmin.dto.Property;
  62 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  63 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  64 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  65 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  66 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  67 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  68 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  69 import org.broadleafcommerce.openadmin.server.security.remote.SecurityVerifier;
  70 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifier;
  71 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierConfiguration;
  72 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierData;
  73 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierDataPoint;
  74 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierRequest;
  75 import org.broadleafcommerce.openadmin.server.security.service.ExceptionAwareRowLevelSecurityProvider;
  76 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  77 import org.broadleafcommerce.openadmin.server.security.service.navigation.AdminNavigationService;
  78 import org.broadleafcommerce.openadmin.server.service.AdminEntityService;
  79 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManager;
  80 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  81 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  82 import org.broadleafcommerce.openadmin.server.service.persistence.module.FieldManager;
  83 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  84 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  85 import org.broadleafcommerce.openadmin.web.form.component.ListGridAction;
  86 import org.broadleafcommerce.openadmin.web.form.component.ListGridActionGroup;
  87 import org.broadleafcommerce.openadmin.web.form.component.ListGridRecord;
  88 import org.broadleafcommerce.openadmin.web.form.component.MediaField;
  89 import org.broadleafcommerce.openadmin.web.form.component.RuleBuilderField;
  90 import org.broadleafcommerce.openadmin.web.form.entity.CodeField;
  91 import org.broadleafcommerce.openadmin.web.form.entity.ComboField;
  92 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  93 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  94 import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  95 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  96 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  97 import org.broadleafcommerce.openadmin.web.rulebuilder.DataDTODeserializer;
  98 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataDTO;
  99 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataWrapper;
 100 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldDTO;
 101 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldWrapper;
 102 import org.codehaus.jettison.json.JSONObject;
 103 import org.springframework.beans.factory.annotation.Value;
 104 import org.springframework.context.MessageSource;
 105 import org.springframework.context.NoSuchMessageException;
 106 import org.springframework.stereotype.Service;
 107 
 108 import com.fasterxml.jackson.core.Version;
 109 import com.fasterxml.jackson.databind.ObjectMapper;
 110 import com.fasterxml.jackson.databind.module.SimpleModule;
 111 
 112 import java.io.IOException;
 113 import java.math.BigDecimal;
 114 import java.text.DateFormat;
 115 import java.text.DateFormatSymbols;
 116 import java.text.ParseException;
 117 import java.text.SimpleDateFormat;
 118 import java.util.ArrayList;
 119 import java.util.Arrays;
 120 import java.util.Collections;
 121 import java.util.Date;
 122 import java.util.HashMap;
 123 import java.util.List;
 124 import java.util.Locale;
 125 import java.util.Map;
 126 import java.util.Map.Entry;
 127 import java.util.Set;
 128 
 129 import javax.annotation.Resource;
 130 import javax.persistence.ManyToOne;
 131 import javax.persistence.OneToOne;
 132 import javax.servlet.http.HttpServletRequest;
 133 
 134 
 135 /**
 136  * @author Andre Azzolini (apazzolini)
 137  */
 138 @Service(&quot;blFormBuilderService&quot;)
 139 public class FormBuilderServiceImpl implements FormBuilderService {
 140 
 141     private static final Log LOG = LogFactory.getLog(FormBuilderServiceImpl.class);
 142 
 143     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 144 
 145     @Resource(name = &quot;blAdminEntityService&quot;)
 146     protected AdminEntityService adminEntityService;
 147     
 148     @Resource (name = &quot;blAdminNavigationService&quot;)
 149     protected AdminNavigationService navigationService;
 150     
 151     @Resource(name = &quot;blFormBuilderExtensionManager&quot;)
 152     protected FormBuilderExtensionManager extensionManager;
 153     
 154     @Resource(name=&quot;blEntityConfiguration&quot;)
 155     protected EntityConfiguration entityConfiguration;
 156 
 157     @Resource(name=&quot;blAdminSecurityRemoteService&quot;)
 158     protected SecurityVerifier adminRemoteSecurityService;
 159     
 160     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 161     protected RowLevelSecurityService rowLevelSecurityService;
 162 
 163     @Resource(name = &quot;blMediaBuilderService&quot;)
 164     protected MediaBuilderService mediaBuilderService;
 165     
 166     @Resource(name = &quot;blListGridErrorMessageExtensionManager&quot;)
 167     protected ListGridErrorMessageExtensionManager listGridErrorExtensionManager;
 168 
 169     @Resource(name = &quot;blAdminNavigationService&quot;)
 170     protected AdminNavigationService adminNavigationService;
 171 
 172 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173     @Resource(name = &quot;blEntityDuplicator&quot;)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174     protected EntityDuplicator duplicator;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176     @Resource(name = &quot;blDynamicEntityDao&quot;)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177     protected DynamicEntityDao dynamicEntityDao;</span>
 178 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179     protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[] { </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             VisibilityEnum.HIDDEN_ALL, VisibilityEnum.GRID_HIDDEN </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181     };</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 184     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)"> 184     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185             throws ServiceException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 </span>
 187 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188     @Resource(name = &quot;blLocaleService&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189     protected LocaleService localeService;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191     @Resource(name = &quot;blTranslationService&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192     protected TranslationService translationService;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194     @Value(&quot;${use.translation.search:false}&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195     protected boolean useTranslationSearch;</span>
 196 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 197 
 198     protected static final VisibilityEnum[] FORM_HIDDEN_VISIBILITIES = new VisibilityEnum[] { 
 199             VisibilityEnum.HIDDEN_ALL, VisibilityEnum.FORM_HIDDEN
 200     };
 201     
 202     protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[] { 
 203             VisibilityEnum.HIDDEN_ALL, VisibilityEnum.GRID_HIDDEN 
 204     };
 205 
 206     @Override
<abbr title=" 207     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)"> 207     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SeðŸ”µ</abbr>
 208             throws ServiceException {
 209 
 210         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 211         ListGrid.Type type = ListGrid.Type.MAIN;
 212         String idProperty = &quot;id&quot;;
 213 
 214         FieldWrapper wrapper = new FieldWrapper();
 215         ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 216         for (Property p : cmd.getProperties()) {
 217             if (p.getMetadata() instanceof BasicFieldMetadata) {
 218                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
 219                 
 220                 if (SupportedFieldType.ID.equals(fmd.getFieldType())) {
 221                     idProperty = fmd.getName();
 222                 }
 223                 
 224                 if (fmd.isProminent() != null &amp;&amp; fmd.isProminent() 
 225                         &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), fmd.getVisibility())) {
 226                     Field hf = createHeaderField(p, fmd);
 227                     headerFields.add(hf);
 228                     defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, fmd));
 229                 }
 230 
 231                 if (fmd.getIsFilter() != null &amp;&amp; fmd.getIsFilter()) {
<abbr title=" 232                     wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmd));"> 232                     wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmdðŸ”µ</abbr>
 233                 }
 234             }
 235         }
 236 
 237         if (useTranslationSearch) {
 238             getTranslationSearchField(cmd.getCeilingType(), defaultWrapperFields);
 239         }
 240 
<abbr title=" 241         ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idProperty, sectionCrumbs);"> 241         ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, ðŸ”µ</abbr>
 242         
 243         if (CollectionUtils.isNotEmpty(listGrid.getHeaderFields())) {
 244             // Set the first column to be able to link to the main entity
 245             listGrid.getHeaderFields().iterator().next().setMainEntityLink(true);
 246         } else {
<abbr title=" 247             String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType();"> 247             String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeiðŸ”µ</abbr>
 248             message += &quot;Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 249             LOG.error(message);
 250         }
 251 
 252         Date c = new Date();
 253         String friendlyName = &quot;listGrid&quot; + c.getTime();
 254         // Set up the filter builder params
 255         listGrid.setJsonFieldName(friendlyName + &quot;Json&quot;);
 256         listGrid.setFriendlyName(friendlyName);
 257         listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 258         if (CollectionUtils.isEmpty(wrapper.getFields())) {
 259             wrapper.setFields(defaultWrapperFields);
 260         }
 261         listGrid.setFieldWrapper(wrapper);
 262         listGrid.setHideFriendlyName(true);
 263 
 264         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 265         listGrid.setJson(blankJsonString);
 266         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 267         if (dw != null) {
 268             listGrid.setDataWrapper(dw);
 269         }
 270 
 271         listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 272         listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 273 
 274         extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 275 
 276         return listGrid;
 277     }
 278 
<abbr title=" 279     private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFields) {"> 279     private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFieldsðŸ”µ</abbr>
 280 
 281         TranslatedEntity translatedEntity;
 282 
 283         try {
 284             translatedEntity = translationService.getAssignableEntityType(ceilingEntity);
 285 
 286             FieldDTO localeField = new FieldDTO();
 287             localeField.setId(&quot;translationLocale&quot;);
 288             localeField.setLabel(&quot;Translation locale&quot;);
 289             localeField.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 290             localeField.setInput(&quot;select&quot;);
 291             localeField.setType(&quot;string&quot;);
 292 
<abbr title=" 293             List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocales();"> 293             List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocaleðŸ”µ</abbr>
 294 
 295             Map&lt;String, String&gt; localeMap = new HashMap&lt;String, String&gt;();
 296             for (org.broadleafcommerce.common.locale.domain.Locale l : locales) {
 297                 localeMap.put(l.getLocaleCode(), l.getFriendlyName());
 298             }
 299             localeField.setValues((new JSONObject(localeMap)).toString());
 300 
 301             defaultWrapperFields.add(localeField);
 302         } catch (Exception e) {
 303             translatedEntity = null;
 304         }
 305     }
 306 
 307     protected FieldDTO constructFieldDTOFromFieldData(Field field, BasicFieldMetadata fmd) {
 308         FieldDTO fieldDTO = new FieldDTO();
 309         //translate the label to display
 310         String label = field.getFriendlyName();
 311         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 312         MessageSource messages = context.getMessageSource();
 313         if (messages != null) {
 314             label = messages.getMessage(label, null, label, context.getJavaLocale());
 315         }
 316         fieldDTO.setLabel(label);
 317 
 318         fieldDTO.setId(field.getName());
 319         if (field.getFieldType().equals(&quot;STRING&quot;)) {
 320             fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 321         } else if (field.getFieldType().equals(&quot;DATE&quot;)) {
 322             fieldDTO.setOperators(&quot;blcFilterOperators_Date&quot;);
<abbr title=" 323         } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldType().equals(&quot;DECIMAL&quot;)) {"> 323         } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || fieldðŸ”µ</abbr>
 324             fieldDTO.setOperators(&quot;blcFilterOperators_Numeric&quot;);
 325         } else if (field.getFieldType().equals(&quot;BOOLEAN&quot;)) {
 326             fieldDTO.setOperators(&quot;blcFilterOperators_Boolean&quot;);
 327         } else if (field.getFieldType().equals(&quot;BROADLEAF_ENUMERATION&quot;)) {
 328             fieldDTO.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 329             fieldDTO.setInput(&quot;select&quot;);
 330             fieldDTO.setType(&quot;string&quot;);
 331             String[][] enumerationValues = fmd.getEnumerationValues ();
 332             Map&lt;String, String&gt; enumMap = new HashMap&lt;&gt;();
 333             for (int i = 0; i &lt; enumerationValues.length; i++) {
 334                 enumMap.put(enumerationValues[i][0], enumerationValues[i][1]);
 335             }
 336 
 337             fieldDTO.setValues(new JSONObject(enumMap).toString());
 338         } else if (field.getFieldType().equals(&quot;ADDITIONAL_FOREIGN_KEY&quot;)) {
 339             fieldDTO.setOperators(&quot;blcFilterOperators_Selectize&quot;);
 340             fieldDTO.setType(&quot;string&quot;);
 341 
<abbr title=" 342             AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClass(), null);"> 342             AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeðŸ”µ</abbr>
 343             if (section != null) {
 344                 String sectionKey = section.getUrl().substring(1);
 345                 fieldDTO.setSelectizeSectionKey(sectionKey);
 346             } else {
 347                 fieldDTO.setSelectizeSectionKey(fmd.getForeignKeyClass());
 348             }
 349         } else {
 350             fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 351         }
 352 
 353         return fieldDTO;
 354     }
 355     
 356     protected Field createHeaderField(Property p, BasicFieldMetadata fmd) {
 357         Field hf;
 358         if (fmd.getFieldType().equals(SupportedFieldType.EXPLICIT_ENUMERATION) ||
 359                 fmd.getFieldType().equals(SupportedFieldType.BROADLEAF_ENUMERATION) ||
 360                 fmd.getFieldType().equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION) ||
 361                 fmd.getFieldType().equals(SupportedFieldType.EMPTY_ENUMERATION)) {
 362             hf = new ComboField();
 363             ((ComboField) hf).setOptions(fmd.getEnumerationValues());
 364         } else {
 365             hf = new Field();
 366         }
 367         
 368         hf.withName(p.getName())
<abbr title=" 369           .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getName())"> 369           .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getðŸ”µ</abbr>
 370           .withOrder(fmd.getGridOrder())
 371           .withColumnWidth(fmd.getColumnWidth())
 372           .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
 373           .withForeignKeyClass(fmd.getForeignKeyClass())
 374           .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title=" 375           .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClass())"> 375           .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClassðŸ”µ</abbr>
 376           .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity());
 377         String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 378         hf.setFieldType(fieldType);
 379         
 380         return hf;
 381     }
 382 
 383     @Override
<abbr title=" 384     public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property field, "> 384     public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property fieðŸ”µ</abbr>
 385             String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 386             throws ServiceException {
 387         FieldMetadata fmd = field.getMetadata();
 388         // Get the class metadata for this particular field
 389         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 390         if (field != null) {
 391             ppr.setSectionEntityField(field.getName());
 392         }
<abbr title=" 393         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 393         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDaðŸ”µ</abbr>
 394 
 395         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 396         ListGrid.Type type = null;
 397         boolean editable = false;
 398         boolean sortable = false;
 399         boolean readOnly = false;
 400         boolean hideIdColumn = false;
 401         boolean canFilterAndSort = true;
 402         boolean modalSingleSelectable = false;
 403         boolean modalMultiSelectable = false;
 404         boolean selectize = false;
 405         boolean isMedia = false;
 406         boolean isLookup = false;
 407         String sortProperty = null;
 408         FieldWrapper wrapper = new FieldWrapper();
 409         ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 410 
 411 
 412         String idProperty = &quot;id&quot;;
 413         for (Property property : cmd.getProperties()) {
 414             if (property.getMetadata() instanceof BasicFieldMetadata &amp;&amp;
<abbr title=" 415                     SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;&amp;"> 415                     SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;ðŸ”µ</abbr>
 416                     //make sure it&#x27;s a property for this entity - not an association
 417                     !property.getName().contains(&quot;.&quot;)) {
 418                 idProperty = property.getName();
 419                 break;
 420             }
 421         }
<abbr title=" 422         // Get the header fields for this list grid. Note that the header fields are different depending on the"> 422         // Get the header fields for this list grid. Note that the header fields are different depending ðŸ”µ</abbr>
 423         // kind of field this is.
 424         if (fmd instanceof BasicFieldMetadata) {
 425             readOnly = ((BasicFieldMetadata) fmd).getReadOnly();
 426             modalSingleSelectable = true;
 427             for (Property p : cmd.getProperties()) {
 428                 if (p.getMetadata() instanceof BasicFieldMetadata) {
 429                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 430                     
 431                     if (SupportedFieldType.ID.equals(md.getFieldType())) {
 432                         idProperty = md.getName();
 433                     }
 434                     
 435                     if (md.isProminent() != null &amp;&amp; md.isProminent() 
 436                             &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 437                         Field hf = createHeaderField(p, md);
 438                         headerFields.add(hf);
 439                         defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 440                     }
 441 
 442                     if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 443                         Field f = createHeaderField(p, md);
 444                         wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 445                     }
 446                 }
 447             }
 448 
 449             type = ListGrid.Type.TO_ONE;
 450         } else if (fmd instanceof BasicCollectionMetadata) {
 451             BasicCollectionMetadata bcm = (BasicCollectionMetadata) fmd;
 452             readOnly = !bcm.isMutable();
 453 
 454             if(AddMethodType.LOOKUP.equals(bcm.getAddMethodType())) {
 455                 isLookup = true;
 456             }
 457 
 458             if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 459                 Property p = cmd.getPMap().get(bcm.getSelectizeVisibleField());
 460                 if (p != null) {
 461                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 462 
 463                     Field hf = createHeaderField(p, md);
 464                     headerFields.add(hf);
 465                     wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 466                 }
 467             } else {
 468                 for (Property p : cmd.getProperties()) {
 469                     if (p.getMetadata() instanceof BasicFieldMetadata) {
 470                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 471                         if (md.isProminent() != null &amp;&amp; md.isProminent()
<abbr title=" 472                                 &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {"> 472                                 &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility()))ðŸ”µ</abbr>
 473                             Field hf = createHeaderField(p, md);
 474                             headerFields.add(hf);
 475                             defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 476                         }
 477 
 478                         if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 479                             Field f = createHeaderField(p, md);
 480                             wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 481                         }
 482                     }
 483                 }
 484             }
 485 
 486             type = ListGrid.Type.BASIC;
 487             
<abbr title=" 488             if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getAddMethodType())) {"> 488             if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equalðŸ”µ</abbr>
 489                 editable = true;
 490             } else if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 491                 selectize = true;
 492                 modalSingleSelectable = true;
 493             } else {
 494                 modalSingleSelectable = true;
 495             }
 496             sortable = StringUtils.isNotBlank(bcm.getSortProperty());
 497             if (sortable) {
 498                 sortProperty = bcm.getSortProperty();
 499             }
 500         } else if (fmd instanceof AdornedTargetCollectionMetadata) {
 501             modalSingleSelectable = true;
 502             readOnly = !((AdornedTargetCollectionMetadata) fmd).isMutable();
 503             AdornedTargetCollectionMetadata atcmd = (AdornedTargetCollectionMetadata) fmd;
 504 
 505             if(AdornedTargetAddMethodType.LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 506                 isLookup = true;
 507             }
 508 
<abbr title=" 509             if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {"> 509             if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())ðŸ”µ</abbr>
 510                 selectize = true;
 511 
 512                 Property p = cmd.getPMap().get(atcmd.getSelectizeVisibleField());
 513                 if (p != null) {
 514                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 515 
 516                     Field hf = createHeaderField(p, md);
 517                     headerFields.add(hf);
 518                     wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 519                 }
 520             } else {
 521                 for (String fieldName : atcmd.getGridVisibleFields()) {
 522                     Property p = cmd.getPMap().get(fieldName);
 523                     if (p != null) {
 524                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 525 
 526                         Field hf = createHeaderField(p, md);
 527                         headerFields.add(hf);
 528                         wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 529                     }
 530 
 531                 }
 532             }
 533 
 534             type = ListGrid.Type.ADORNED;
 535 
 536             if (atcmd.getMaintainedAdornedTargetFields().length &gt; 0) {
 537                 editable = true;
 538             }
 539             
 540             AdornedTargetList adornedList = (AdornedTargetList) atcmd.getPersistencePerspective()
<abbr title=" 541                     .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);"> 541                     .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLISðŸ”µ</abbr>
 542             sortable = StringUtils.isNotBlank(adornedList.getSortField());
 543             if (sortable) {
 544                 sortProperty = adornedList.getSortField();
 545             }
 546         } else if (fmd instanceof MapMetadata) {
 547             readOnly = !((MapMetadata) fmd).isMutable();
 548             MapMetadata mmd = (MapMetadata) fmd;
 549 
 550             Property p2 = cmd.getPMap().get(&quot;key&quot;);
 551             BasicFieldMetadata keyMd = (BasicFieldMetadata) p2.getMetadata();
 552             keyMd.setFriendlyName(getMapKeyFriendlyName(p2));
 553             Field hf = createHeaderField(p2, keyMd);
 554             headerFields.add(hf);
 555             wrapper.getFields().add(constructFieldDTOFromFieldData(hf, keyMd));
 556 
 557             if (mmd.isSimpleValue()) {
 558                 Property valueProperty = cmd.getPMap().get(&quot;value&quot;);
 559                 BasicFieldMetadata valueMd = (BasicFieldMetadata) valueProperty.getMetadata();
 560                 valueMd.setFriendlyName(&quot;Value&quot;);
 561                 hf = createHeaderField(valueProperty, valueMd);
 562                 headerFields.add(hf);
 563                 wrapper.getFields().add(constructFieldDTOFromFieldData(hf, valueMd));
 564 
 565                 idProperty = &quot;key&quot;;
 566                 hideIdColumn = true;
 567             } else {
 568                 for (Property p : cmd.getProperties()) {
 569                     if (p.getMetadata() instanceof BasicFieldMetadata) {
 570                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 571                         String valueClassName = mmd.getValueClassName();
 572                         if (!StringUtils.isEmpty(mmd.getToOneTargetProperty())) {
 573                             Class&lt;?&gt; clazz;
 574                             try {
 575                                 clazz = Class.forName(mmd.getValueClassName());
 576                             } catch (ClassNotFoundException e) {
 577                                 throw ExceptionHelper.refineException(e);
 578                             }
<abbr title=" 579                             java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTargetProperty());"> 579                             java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.ðŸ”µ</abbr>
 580                             ManyToOne manyToOne = nestedField.getAnnotation(ManyToOne.class);
<abbr title=" 581                             if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getName())) {"> 581                             if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.clasðŸ”µ</abbr>
 582                                 valueClassName = manyToOne.targetEntity().getName();
 583                             } else {
 584                                 OneToOne oneToOne = nestedField.getAnnotation(OneToOne.class);
<abbr title=" 585                                 if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getName())) {"> 585                                 if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.clðŸ”µ</abbr>
 586                                     valueClassName = oneToOne.targetEntity().getName();
 587                                 }
 588                             }
 589                         }
 590                         if (md.getTargetClass().equals(valueClassName)) {
 591                             if (md.isProminent() != null &amp;&amp; md.isProminent() 
<abbr title=" 592                                     &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {"> 592                                     &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibilityðŸ”µ</abbr>
 593                                 hf = createHeaderField(p, md);
 594                                 headerFields.add(hf);
 595                                 defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 596 
 597                                 // Is this a media listgrid
 598                                 if (hf.getFieldType().equals(&quot;ASSET_LOOKUP&quot;)) {
 599                                     isMedia = true;
 600                                 }
 601                             }
 602 
 603                             if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 604                                 wrapper.getFields().add(constructFieldDTOFromFieldData(hf,md));
 605                             }
 606                         }
 607                     }
 608                 }
 609             }
 610 
 611             type = ListGrid.Type.MAP;
 612             editable = true;
 613             canFilterAndSort = false;
 614         }
 615 
 616         String ceilingType = &quot;&quot;;
 617         if (fmd instanceof BasicFieldMetadata) {
 618             ceilingType = cmd.getCeilingType();
 619         } else if (fmd instanceof CollectionMetadata) {
 620             ceilingType = ((CollectionMetadata) fmd).getCollectionCeilingEntity();
 621         }
 622         
 623         if (CollectionUtils.isEmpty(headerFields)) {
<abbr title=" 624             String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; and property &#x27;&quot; +"> 624             String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingTypðŸ”µ</abbr>
 625                     StringUtil.sanitize(field.getName()) + &quot;&#x27;.&quot;;
<abbr title=" 626             if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) {"> 626             if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) ðŸ”µ</abbr>
<abbr title=" 627                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 627                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTaðŸ”µ</abbr>
 628             } else if (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM) {
<abbr title=" 629                 message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 629                 message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetðŸ”µ</abbr>
 630             } else if (selectize &amp;&amp; type == ListGrid.Type.BASIC) {
<abbr title=" 631                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuration&quot;;"> 631                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollectioðŸ”µ</abbr>
 632             } else {
 633                 message += &quot; Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 634             }
 635             LOG.error(message);
 636         }
 637 
<abbr title=" 638         ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProperty, sectionCrumbs, sortProperty);"> 638         ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrderðŸ”µ</abbr>
 639         listGrid.setSubCollectionFieldName(field.getName());
 640         listGrid.setFriendlyName(field.getMetadata().getFriendlyName());
 641         if (StringUtils.isEmpty(listGrid.getFriendlyName())) {
 642             listGrid.setFriendlyName(field.getName());
 643         }
 644         listGrid.setContainingEntityId(containingEntityId);
 645         listGrid.setIsReadOnly(readOnly);
 646         listGrid.setHideIdColumn(hideIdColumn);
 647         listGrid.setCanFilterAndSort(canFilterAndSort);
 648 
 649         // Set up the filter builder params
 650         Date c = new Date();
 651         String friendlyName = field.getMetadata().getFriendlyName();
 652         String jsonFriendlyName = friendlyName.replaceAll(&quot; &quot;, &quot;_&quot;);
 653         listGrid.setJsonFieldName(jsonFriendlyName + c.getTime() + &quot;Json&quot;);
 654         listGrid.setFriendlyName(friendlyName);
 655         listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 656         if (CollectionUtils.isEmpty(wrapper.getFields())) {
 657             wrapper.setFields(defaultWrapperFields);
 658         }
 659         listGrid.setFieldWrapper(wrapper);
 660 
 661         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 662         listGrid.setJson(blankJsonString);
 663         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 664         if (dw != null) {
 665             listGrid.setDataWrapper(dw);
 666         }
 667 
 668         if (editable) {
 669             listGrid.getRowActions().add(DefaultListGridActions.UPDATE);
 670         }
 671         if (readOnly) {
 672             listGrid.getRowActions().add(DefaultListGridActions.VIEW);
 673         }
 674         if (sortable) {
 675             listGrid.setCanFilterAndSort(false);
 676             listGrid.setIsSortable(true);
 677         }
 678 
 679         if (modalSingleSelectable) {
 680             if (readOnly) {
<abbr title=" 681                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(true));"> 681                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReðŸ”µ</abbr>
 682             } else {
 683                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 684 
 685             }
 686         }
 687         listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 688 
 689         if (selectize) {
 690             listGrid.setSelectizeUrl(buildSelectizeUrl(listGrid));
 691             listGrid.setSelectType(ListGrid.SelectType.SELECTIZE);
 692         }
 693 
 694         if (modalMultiSelectable) {
 695             listGrid.addModalRowAction(DefaultListGridActions.MULTI_SELECT);
 696             listGrid.setSelectType(ListGrid.SelectType.MULTI_SELECT);
 697         }
 698         listGrid.getRowActions().add(DefaultListGridActions.REMOVE);
 699 
 700         if (fmd.getManualFetch()) {
 701             listGrid.setManualFetch(true);
 702             listGrid.getToolbarActions().add(DefaultListGridActions.MANUAL_FETCH);
 703         }
 704         if (isMedia) {
 705             listGrid.setListGridType(ListGrid.Type.ASSET_GRID);
 706         }
 707 
 708         extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 709 
<abbr title=" 710         //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface"> 710         //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implemðŸ”µ</abbr>
 711         if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title=" 712             EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();"> 712             EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecðŸ”µ</abbr>
<abbr title=" 713             for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {"> 713             for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguratiðŸ”µ</abbr>
 714                 for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
 715                     if (modifier.isQualified(data.getModifierType())) {
 716                         modifier.modifyListGrid(new EntityFormModifierRequest()
 717                                 .withListGrid(listGrid)
 718                                 .withConfiguration(data)
 719                                 .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
 720                                 .withRowLevelSecurityService(rowLevelSecurityService));
 721                     }
 722                 }
 723             }
 724         }
 725         return listGrid;
 726     }
 727 
 728     protected String getMapKeyFriendlyName(Property property) {
 729         String friendlyNameFromMetadata = property.getMetadata().getFriendlyName();
 730 
 731         return (friendlyNameFromMetadata == null) ? &quot;Key&quot; : friendlyNameFromMetadata;
 732     }
 733 
 734     @Override
<abbr title=" 735     public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, Property field,"> 735     public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet dðŸ”µ</abbr>
 736         String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 737             throws ServiceException {
 738         FieldMetadata fmd = field.getMetadata();
 739         // Get the class metadata for this particular field
 740         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 741         if (field != null) {
 742             ppr.setSectionEntityField(field.getName());
 743         }
<abbr title=" 744         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 744         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDaðŸ”µ</abbr>
 745 
 746         Map&lt;String, Object&gt; result = constructSelectizeOptionMap(drs, cmd);
 747 
 748         AdornedTargetList adornedList = ppr.getAdornedList();
 749         if (adornedList != null &amp;&amp; adornedList.getLinkedObjectPath() != null
 750             &amp;&amp; adornedList.getTargetObjectPath() != null &amp;&amp; adornedList.getLinkedIdProperty() != null
 751             &amp;&amp; adornedList.getTargetIdProperty() != null) {
<abbr title=" 752             result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());"> 752             result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkeðŸ”µ</abbr>
 753             result.put(&quot;linkedObjectId&quot;, containingEntityId);
<abbr title=" 754             result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());"> 754             result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargeðŸ”µ</abbr>
 755         }
 756 
 757         return result;
 758     }
 759 
 760     @Override
 761     public Map&lt;String, Object&gt; constructSelectizeOptionMap(DynamicResultSet drs, ClassMetadata cmd) {
 762         Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
 763         List&lt;Map&lt;String, String&gt;&gt; options = new ArrayList&lt;&gt;();
 764 
 765         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 766         for (Property p : cmd.getProperties()) {
 767             if (p.getMetadata() instanceof BasicFieldMetadata) {
 768                 BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 769                 if (md.isProminent() != null &amp;&amp; md.isProminent()
 770                         &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 771                     Field hf = createHeaderField(p, md);
 772                     headerFields.add(hf);
 773                 }
 774             }
 775         }
 776 
 777         for (Entity e : drs.getRecords()) {
 778             Map&lt;String, String&gt; selectizeOption = new HashMap&lt;&gt;();
 779             for (Field headerField : headerFields) {
 780                 Property p = e.findProperty(headerField.getName());
 781                 if (p != null) {
 782                     selectizeOption.put(&quot;name&quot;, p.getValue());
 783                     break;
 784                 }
 785             }
 786             if (e.findProperty(&quot;id&quot;) != null) {
 787                 selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;id&quot;).getValue());
 788             //  &quot;Locale&quot; entity is a special occasion. Because it have not &quot;ID&quot; column with &quot;Long&quot; type
 789             } else if (e.findProperty(&quot;localeCode&quot;) != null) {
 790                 selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;localeCode&quot;).getValue());
 791             }
 792             if (e.findProperty(ALTERNATE_ID_PROPERTY) != null) {
 793                 selectizeOption.put(&quot;alternateId&quot;, e.findProperty(ALTERNATE_ID_PROPERTY).getValue());
 794             }
 795             options.add(selectizeOption);
 796         }
 797         result.put(&quot;options&quot;, options);
 798 
 799         return result;
 800     }
 801 
 802     protected String buildSelectizeUrl(ListGrid listGrid) {
 803         HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 804         String url = request.getContextPath();
<abbr title=" 805         url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + listGrid.getSectionKey();"> 805         url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() :ðŸ”µ</abbr>
 806         url += &quot;/&quot; + listGrid.getContainingEntityId();
 807         url += &quot;/&quot; + listGrid.getSubCollectionFieldName();
 808         return url;
 809     }
 810 
 811     /**
<abbr title=" 812      * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 812      * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, InteðŸ”µ</abbr>
 813      * @param className
 814      * @param headerFields
 815      * @param type
 816      * @param drs
 817      * @param sectionKey
 818      * @param order
 819      * @param idProperty
 820      * @param sectionCrumbs
 821      * @return
 822      */
 823     @Deprecated
<abbr title=" 824     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs, "> 824     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynðŸ”µ</abbr>
 825             String sectionKey, int order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs) {
<abbr title=" 826        return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,null);"> 826        return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,nuðŸ”µ</abbr>
 827     }
 828 
 829     /**
 830      * Populate a ListGrid with ListGridRecords.
 831      *
 832      * @param className
 833      * @param headerFields
 834      * @param type
 835      * @param drs
 836      * @param sectionKey
 837      * @param order
 838      * @param idProperty
 839      * @param sectionCrumbs
 840      * @param sortPropery
 841      * @return
 842      */
<abbr title=" 843     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 843     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynðŸ”µ</abbr>
<abbr title=" 844             String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropery) {"> 844             String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, StringðŸ”µ</abbr>
 845         // Create the list grid and set some basic attributes
 846         ListGrid listGrid = new ListGrid();
 847         listGrid.setClassName(className);
 848         listGrid.getHeaderFields().addAll(headerFields);
 849         listGrid.setListGridType(type);
 850         listGrid.setSectionCrumbs(sectionCrumbs);
 851         listGrid.setSectionKey(sectionKey);
 852         listGrid.setOrder(order);
 853         listGrid.setIdProperty(idProperty);
 854         listGrid.setStartIndex(drs.getStartIndex());
 855         listGrid.setTotalRecords(drs.getTotalRecords());
 856         listGrid.setPageSize(drs.getPageSize());
 857 
 858         String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
<abbr title=" 859         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier);"> 859         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdðŸ”µ</abbr>
 860         if (section != null) {
 861             listGrid.setExternalEntitySectionKey(section.getUrl());
 862         }
 863 
 864         // format date list grid cells
 865         SimpleDateFormat formatter = new SimpleDateFormat(&quot;MMM d, y @ hh:mma&quot;);
 866         DateFormatSymbols symbols = new DateFormatSymbols(Locale.getDefault());
 867         symbols.setAmPmStrings(new String[] { &quot;am&quot;, &quot;pm&quot; });
 868         formatter.setDateFormatSymbols(symbols);
 869 
 870         // For each of the entities (rows) in the list grid, we need to build the associated
 871         // ListGridRecord and set the required fields on the record. These fields are the same ones
 872         // that are used for the header fields.
 873         for (Entity e : drs.getRecords()) {
 874             ListGridRecord record = new ListGridRecord();
 875             record.setListGrid(listGrid);
 876             record.setDirty(e.isDirty());
 877             record.setEntity(e);
 878             if (StringUtils.isNotBlank(sortPropery) &amp;&amp; e.findProperty(sortPropery) != null) {
 879                 Property sort = e.findProperty(sortPropery);
 880                 record.setDisplayOrder(sort.getValue());
 881             }
 882             if (e.findProperty(&quot;hasError&quot;) != null) {
 883                 Boolean hasError = Boolean.parseBoolean(e.findProperty(&quot;hasError&quot;).getValue());
 884                 record.setIsError(hasError);
 885                 if (hasError) {
 886                     ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 887                             .getProxy().determineErrorMessageForEntity(e, record);
 888 
 889                     if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 890                         record.setErrorKey(&quot;listgrid.record.error&quot;);
 891                     }
 892                 }
 893             }
 894 
 895             if (e.findProperty(&quot;progressStatus&quot;) != null) {
 896                 ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 897                         .getProxy().determineStatusMessageForEntity(e, record);
 898                 if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 899                     record.setStatus(e.findProperty(&quot;progressStatus&quot;).getValue());
 900                     record.setStatusCssClass(&quot;listgrid.record.status&quot;);
 901                 }
 902             }
 903 
 904             if (e.findProperty(idProperty) != null) {
 905                 record.setId(e.findProperty(idProperty).getValue());
 906             }
 907 
 908             for (Field headerField : headerFields) {
 909                 Property p = e.findProperty(headerField.getName());
 910                 if (p != null) {
 911                     Field recordField = new Field().withName(headerField.getName())
 912                             .withFriendlyName(headerField.getFriendlyName())
 913                             .withOrder(p.getMetadata().getOrder());
 914 
 915                     if (headerField instanceof ComboField) {
 916                         recordField.setValue(((ComboField) headerField).getOption(p.getValue()));
 917                         recordField.setDisplayValue(p.getDisplayValue());
 918                     } else {
 919                         if (headerField.getFieldType().equals(&quot;DATE&quot;)) {
 920                             try {
<abbr title=" 921                                 Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue());"> 921                                 Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue(ðŸ”µ</abbr>
 922                                 String newValue = formatter.format(date);
 923                                 recordField.setValue(newValue);
 924                             } catch (Exception ex) {
 925                                 recordField.setValue(p.getValue());
 926                             }
 927                         } else {
 928                             recordField.setValue(p.getValue());
 929                         }
 930                         recordField.setDisplayValue(p.getDisplayValue());
 931                     }
 932 
 933                     recordField.setDerived(isDerivedField(headerField, recordField, p));
 934 
 935                     record.getFields().add(recordField);
 936                 }
 937             }
 938 
 939             if (e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY) != null) {
 940                 Field hiddenField = new Field().withName(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
<abbr title=" 941                 hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue());"> 941                 hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue()ðŸ”µ</abbr>
 942                 record.getHiddenFields().add(hiddenField);
 943             }
 944 
 945             if (e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY) != null) {
 946                 record.setAltId(e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY).getValue());
 947             }
 948 
 949             extensionManager.getProxy().modifyListGridRecord(className, record, e);
 950 
 951             listGrid.getRecords().add(record);
 952         }
 953 
 954         if (drs.getFirstId() != null) {
 955             listGrid.setFirstId(drs.getFirstId());
 956         }
 957         if (drs.getLastId() != null) {
 958             listGrid.setLastId(drs.getLastId());
 959         }
 960         if (drs.getUpperCount() != null) {
 961             listGrid.setUpperCount(drs.getUpperCount());
 962         }
 963         if (drs.getLowerCount() != null) {
 964             listGrid.setLowerCount(drs.getLowerCount());
 965         }
 966         if (drs.getFetchType() != null) {
 967             listGrid.setFetchType(drs.getFetchType().toString());
 968         }
 969         if (drs.getTotalCountLessThanPageSize() != null) {
 970             listGrid.setTotalCountLessThanPageSize(drs.getTotalCountLessThanPageSize());
 971         }
 972         if (drs.getPromptSearch() != null) {
 973             listGrid.setPromptSearch(drs.getPromptSearch());
 974         }
 975 
 976         return listGrid;
 977     }
 978     
 979     /**
<abbr title=" 980      * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasicFieldMetadata}"> 980      * Determines whether or not a particular field in a record is derived. By default this checks the {@ðŸ”µ</abbr>
 981      * for the given Property to see if something on the backend has marked it as derived
 982      * 
 983      * @param headerField the header for this recordField
 984      * @param recordField the recordField being populated
 985      * @param p the property that relates to this recordField
 986      * @return whether or not this field is derived
<abbr title=" 987      * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 987      * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, StringðŸ”µ</abbr>
 988      */
 989     protected Boolean isDerivedField(Field headerField, Field recordField, Property p) {
 990         return BooleanUtils.isTrue(((BasicFieldMetadata) p.getMetadata()).getIsDerived());
 991     }
 992 
 993     protected void setEntityFormFields(ClassMetadata cmd, EntityForm ef, List&lt;Property&gt; properties) {
 994         List&lt;Field&gt; homelessFields = new ArrayList&lt;&gt;();
 995         List&lt;Field&gt; fieldsWithAssociations = new ArrayList&lt;&gt;();
 996 
 997         for (Property property : properties) {
 998             if (property.getMetadata() instanceof BasicFieldMetadata) {
 999                 BasicFieldMetadata fmd = (BasicFieldMetadata) property.getMetadata();
1000 
1001 
1002                 if (!ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
<abbr title="1003                     // Depending on visibility, field for the particular property is not created on the form">1003                     // Depending on visibility, field for the particular property is not created on the fðŸ”µ</abbr>
1004                     String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
1005                     
1006                     // Create the field and set some basic attributes
1007                     Field f;
1008                     
1009                     if (fieldType.equals(SupportedFieldType.BROADLEAF_ENUMERATION.toString())
1010                             || fieldType.equals(SupportedFieldType.EXPLICIT_ENUMERATION.toString())
1011                             || fieldType.equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION.toString())
1012                             || fieldType.equals(SupportedFieldType.EMPTY_ENUMERATION.toString())) {
<abbr title="1013                         // We&#x27;re dealing with fields that should render as drop-downs, so set their possible values">1013                         // We&#x27;re dealing with fields that should render as drop-downs, so set their possiðŸ”µ</abbr>
1014                         f = new ComboField();
1015                         ((ComboField) f).setOptions(fmd.getEnumerationValues());
<abbr title="1016                         if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValue()">1016                         if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().boðŸ”µ</abbr>
1017                                 &amp;&amp; ((ComboField) f).getOptions().size() == 0) {
1018                             f.setIsVisible(false);
1019                         }
1020                     } else if (fieldType.equals(SupportedFieldType.CODE.toString())) {
1021                         f = new CodeField();
1022                     } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1023                             || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1024                             || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1025                         // We&#x27;re dealing with rule builders, so we&#x27;ll create those specialized fields
1026                         f = new RuleBuilderField();
1027                         ((RuleBuilderField) f).setJsonFieldName(property.getName() + &quot;Json&quot;);
1028                         ((RuleBuilderField) f).setDataWrapper(new DataWrapper());
1029                         ((RuleBuilderField) f).setFieldBuilder(fmd.getRuleIdentifier());
1030                         ((RuleBuilderField) f).setDisplayType(fmd.getDisplayType().toString());
1031 
1032                         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
1033                         ((RuleBuilderField) f).setJson(blankJsonString);
1034                         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
1035                         if (dw != null) {
1036                             ((RuleBuilderField) f).setDataWrapper(dw);
1037                         }
1038                         
1039                         if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())) {
1040                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple&quot;);
1041                         } else if (fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1042                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-with-quantity&quot;);
1043                         } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())) {
1044                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple-time&quot;);
1045                         }
1046                     } else if (LookupType.DROPDOWN.equals(fmd.getLookupType())) {
<abbr title="1047                         // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of in a ">1047                         // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instðŸ”µ</abbr>
<abbr title="1048                         // modal, so we&#x27;ll provision the combo field here. Available options will be set as part of a">1048                         // modal, so we&#x27;ll provision the combo field here. Available options will be set ðŸ”µ</abbr>
1049                         // subsequent operation
1050                         f = new ComboField();
1051                     } else if (fieldType.equals(SupportedFieldType.MEDIA.toString())) {
1052                         f = new MediaField();
1053                     } else {
1054                         // Create a default field since there was no specialized handler
1055                         f = new Field();
1056                     }
1057                     
1058                     Boolean required = fmd.getRequiredOverride();
1059                     if (required == null) {
1060                         required = fmd.getRequired();
1061                     }
1062 
1063                     Boolean allowNoValueEnum = fmd.getAllowNoValueEnumOption();
1064                     if (allowNoValueEnum != null) {
1065                         f.setAllowNoValueEnumOption(allowNoValueEnum);
1066                     }
1067 
1068                     f.withName(property.getName())
1069                      .withFieldType(fieldType)
1070                      .withFieldComponentRenderer(getFieldComponentRenderer(fmd))
1071                      .withGridFieldComponentRenderer(getGridFieldComponentRenderer(fmd))
1072                      .withOrder(fmd.getOrder())
1073                      .withFriendlyName(fmd.getFriendlyName())
1074                      .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
1075                      .withForeignKeyClass(fmd.getForeignKeyClass())
1076                      .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title="1077                      .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromType())">1077                      .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheriðŸ”µ</abbr>
1078                      .withRequired(required)
1079                      .withReadOnly(fmd.getReadOnly())
1080                      .withTranslatable(fmd.getTranslatable())
<abbr title="1081                      .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDERING))">1081                      .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDðŸ”µ</abbr>
1082                      .withLargeEntry(fmd.isLargeEntry())
1083                      .withHint(fmd.getHint())
1084                      .withTooltip(fmd.getTooltip())
1085                      .withHelp(fmd.getHelpText())
1086                      .withTypeaheadEnabled(fmd.getEnableTypeaheadLookup())
1087                      .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity())
1088                      .withAssociatedFieldName(fmd.getAssociatedFieldName());
1089 
1090                     String defaultValue = fmd.getDefaultValue();
1091                     if (defaultValue != null) {
1092                         defaultValue = extractDefaultValueFromFieldData(fieldType, fmd);
1093                         f.withValue(defaultValue);
1094                     }
1095 
1096                     if (StringUtils.isBlank(f.getFriendlyName())) {
1097                         f.setFriendlyName(f.getName());
1098                     }
1099 
1100                     // If is form hidden, set visible to false
1101                     if (VisibilityEnum.FORM_EXPLICITLY_HIDDEN.equals(fmd.getVisibility())) {
1102                         f.setIsVisible(false);
1103                     }
1104 
1105                     if (VisibilityEnum.VISIBLE_ALL.equals(fmd.getVisibility())) {
1106                         f.setIsVisible(true);
1107                     }
1108 
1109                     // Add the field to the appropriate FieldGroup
1110                     if (fmd.getGroup() == null) {
1111                         homelessFields.add(f);
1112                     } else {
<abbr title="1113                         ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabOrder());">1113                         ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabðŸ”µ</abbr>
1114                     }
1115 
1116                     if (StringUtils.isNotEmpty(fmd.getAssociatedFieldName())) {
1117                         fieldsWithAssociations.add(f);
1118                     }
1119                 }
1120             }
1121         }
1122 
1123         for (Field f : homelessFields) {
1124             ef.addField(cmd, f, null, null, null, null);
1125         }
1126 
1127         for (Field f : fieldsWithAssociations) {
1128             Field associatedField = findAssociatedField(ef, f);
1129             if (associatedField != null) {
1130                 associatedField.setShouldRender(false);
1131                 f.setAssociatedFieldName(associatedField.getName());
1132             } else {
1133                 f.setAssociatedFieldName(null);
1134             }
1135         }
1136     }
1137 
1138     protected String getFieldComponentRenderer(BasicFieldMetadata fmd) {
1139         if (StringUtils.isNotBlank(fmd.getFieldComponentRendererTemplate())) {
1140             return fmd.getFieldComponentRendererTemplate();
1141         }
1142         return fmd.getFieldComponentRenderer()==null?null:fmd.getFieldComponentRenderer().toString();
1143     }
1144 
1145     protected String getGridFieldComponentRenderer(BasicFieldMetadata fmd) {
1146         if (StringUtils.isNotBlank(fmd.getGridFieldComponentRendererTemplate())) {
1147             return fmd.getGridFieldComponentRendererTemplate();
1148         }
<abbr title="1149         return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toString();">1149         return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toStrinðŸ”µ</abbr>
1150     }
1151 
1152     private Field findAssociatedField(EntityForm ef, Field f) {
1153         // Try on the parent object
1154         Field associatedField = ef.findField(f.getAssociatedFieldName());
1155 
1156         if (associatedField == null) {
1157             // Check the field&#x27;s path
1158             String[] fieldPathParts = f.getName().split(&quot;\\.&quot;);
1159             String testPath = &quot;&quot;;
1160 
1161             for (String path : fieldPathParts) {
1162                 testPath += path + &quot;.&quot;;
1163 
1164                 associatedField = ef.findField(testPath + f.getAssociatedFieldName());
1165                 if (associatedField != null) {
1166                     break;
1167                 }
1168             }
1169         }
1170         return associatedField;
1171     }
1172 
1173     /**
1174      * This method gets the {@link AdminSection} for the given foreignKeyClass parameter. If none exists,
1175      * it returns the foreignKeyClass.
1176      *
1177      * @param foreignKeyClass the {@link String} class name
1178      * @return the admin section pathname
1179      */
1180     protected String getAdminSectionPath(String foreignKeyClass) {
1181         if (foreignKeyClass != null) {
<abbr title="1182             AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyClass, null);">1182             AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(fðŸ”µ</abbr>
1183             return foreignKeySection != null ? foreignKeySection.getUrl() : foreignKeyClass;
1184         }
1185         return null;
1186     }
1187 
1188     /**
<abbr title="1189      * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal to">1189      * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} iðŸ”µ</abbr>
1190      *  the processed value of another tab.
1191      *
1192      * For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a another tab where
<abbr title="1193      *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;,">1193      *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=ExamðŸ”µ</abbr>
<abbr title="1194      *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; tabs.">1194      *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; taðŸ”µ</abbr>
1195      */
1196     protected void setEntityFormTabsAndGroups(EntityForm ef, Map&lt;String, TabMetadata&gt; tabMetadataMap) {
1197         if (tabMetadataMap != null) {
1198             Set&lt;String&gt; tabMetadataKeySet = tabMetadataMap.keySet();
1199             for (String tabKey : tabMetadataKeySet) {
1200                 TabMetadata tabMetadata = tabMetadataMap.get(tabKey);
<abbr title="1201                 String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySet);">1201                 String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySeðŸ”µ</abbr>
1202 
1203                 if (foundMatchingTab(unprocessedTabName)) {
1204                     if (!tabExists(ef, unprocessedTabName)) {
1205                         TabMetadata originalTabMetadata = tabMetadataMap.get(unprocessedTabName);
1206                         unprocessedTabName = ef.addTabFromTabMetadata(originalTabMetadata);
1207                     }
1208                 } else {
1209                     if (tabExists(ef, tabKey)) {
1210                         unprocessedTabName = tabKey;
1211                     } else {
1212                         unprocessedTabName = ef.addTabFromTabMetadata(tabMetadata);
1213                     }
1214                 }
1215 
1216                 Set&lt;String&gt; groupMetadataKeySet = tabMetadata.getGroupMetadata().keySet();
1217                 for (String groupKey : groupMetadataKeySet) {
<abbr title="1218                     ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName);">1218                     ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocesseðŸ”µ</abbr>
1219                 }
1220             }
1221         }
1222     }
1223 
1224     /**
1225      * Search for any other tab on the target entity that has the same display value
1226      *  as the value provided tab name.
1227      *
<abbr title="1228      * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message property.">1228      * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message propeðŸ”µ</abbr>
<abbr title="1229      *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySet">1229      *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetaðŸ”µ</abbr>
<abbr title="1230      *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method should return">1230      *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method shoulðŸ”µ</abbr>
1231      *  &quot;Example_Tab&quot; which will end up causing the tabs to merge together.
1232      *
<abbr title="1233      * If a tab with the same display value cannot be found, then we should return null to indicate that there">1233      * If a tab with the same display value cannot be found, then we should return null to indicate that ðŸ”µ</abbr>
1234      *  is no matching tab with the same processed tabName value.
1235      */
<abbr title="1236     protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySet) {">1236     protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySðŸ”µ</abbr>
1237         for (String tabKey : tabMetadataKeySet) {
1238             String tabName = tabMetadata.getTabName();
1239 
1240             if (processedTabKeyMatchesTabName(tabName, tabKey)) {
1241                 return tabKey;
1242             }
1243         }
1244 
1245         return null;
1246     }
1247 
1248     protected boolean processedTabKeyMatchesTabName(String tabName, String candidateTabKey) {
1249         try {
1250             String processedCandidateTabKey = BLCMessageUtils.getMessage(candidateTabKey);
<abbr title="1251             boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateTabKey);">1251             boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateðŸ”µ</abbr>
1252 
<abbr title="1253             return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidateTabKey);">1253             return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidatðŸ”µ</abbr>
1254         } catch (NoSuchMessageException e) {
1255             LOG.debug(&quot;No such message exists for &quot; + candidateTabKey, e);
1256 
1257             return false;
1258         }
1259     }
1260 
1261     protected boolean foundMatchingTab(String unprocessedTabName) {
1262         return (unprocessedTabName != null);
1263     }
1264 
1265     protected boolean tabExists(EntityForm ef, String tabKey) {
1266         return (ef.findTab(tabKey) != null);
1267     }
1268 
1269     @Override
1270     public String extractDefaultValueFromFieldData(String fieldType, BasicFieldMetadata fmd) {
1271         String defaultValue = fmd.getDefaultValue();
1272         if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1273                 || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1274                 || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1275             return null;
1276         } else if (fieldType.equals(SupportedFieldType.INTEGER.toString())) {
1277             try {
1278                 Integer.parseInt(defaultValue);
1279             } catch (NumberFormatException  e) {
<abbr title="1280                 String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defaultValue);">1280                 String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defauðŸ”µ</abbr>
1281                 LOG.debug(msg);
1282                 return null;
1283             }
1284         } else if (fieldType.equals(SupportedFieldType.DECIMAL.toString())
1285                 || fieldType.equals(SupportedFieldType.MONEY.toString())) {
1286             try {
1287                 BigDecimal val = new BigDecimal(defaultValue);
1288             } catch (NumberFormatException  e) {
1289                 String msg = buildMsgForDefValException(fieldType.toString(), fmd, defaultValue);
1290                 LOG.debug(msg);
1291                 return null;
1292             }
1293         } else if (fieldType.equals(SupportedFieldType.BOOLEAN.toString())) {
1294             if (!defaultValue.toLowerCase().equals(&quot;true&quot;) &amp;&amp; !defaultValue.toLowerCase().equals(&quot;false&quot;)
<abbr title="1295                     &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)) {">1295                     &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)ðŸ”µ</abbr>
<abbr title="1296                 String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defaultValue);">1296                 String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defauðŸ”µ</abbr>
1297                 LOG.debug(msg);
1298                 return null;
1299             }
1300         } else if (fieldType.equals(SupportedFieldType.DATE.toString())) {
1301             DateFormat format = FormatUtil.getDateFormat();
1302             if (defaultValue.toLowerCase().contains(&quot;today&quot;)) {
1303                 defaultValue = format.format(new Date());
1304             } else {
1305                 try {
1306                     Date date = format.parse(defaultValue);
1307                     defaultValue = format.format(date);
1308                 } catch (ParseException e) {
<abbr title="1309                     String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue);">1309                     String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaðŸ”µ</abbr>
1310                     LOG.debug(msg);
1311                     return null;
1312                 }
1313             }
1314         }
1315         return defaultValue;
1316     }
1317 
<abbr title="1318     protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue) {">1318     protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue)ðŸ”µ</abbr>
<abbr title="1319         return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - Failed to parse &quot; ">1319         return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot;ðŸ”µ</abbr>
<abbr title="1320                 + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue) + &quot; ]&quot;;">1320                 + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue)ðŸ”µ</abbr>
1321     }
1322 
1323     @Override
1324     public void removeNonApplicableFields(ClassMetadata cmd, EntityForm entityForm, String entityType) {
1325         for (Property p : cmd.getProperties()) {
1326             if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entityType)) {
1327                 entityForm.removeField(p.getName());
1328             }
1329         }
1330     }
1331 
1332     @Override
1333     public EntityForm createEntityForm(ClassMetadata cmd, List&lt;SectionCrumb&gt; sectionCrumbs)
1334             throws ServiceException {
1335         EntityForm ef = createStandardEntityForm();
1336         populateEntityForm(cmd, ef, sectionCrumbs);
1337         return ef;
1338     }
1339     
1340     protected String extractSectionIdentifierFromCrumb(List&lt;SectionCrumb&gt; sectionCrumbs) {
1341         if (sectionCrumbs != null &amp;&amp; sectionCrumbs.size() &gt; 0) {
1342             return sectionCrumbs.get(0).getSectionIdentifier();
1343         } else {
1344             return null;
1345         }
1346     }
1347 
1348     @Override
1349     public void populateEntityForm(ClassMetadata cmd, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)
1350             throws ServiceException {
1351         ef.setCeilingEntityClassname(cmd.getCeilingType());
1352         
1353         String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
1354 
<abbr title="1355         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType(),">1355         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType()ðŸ”µ</abbr>
1356                 sectionIdentifier);
1357         if (section != null) {
1358             ef.setSectionKey(section.getUrl());
1359         } else {
1360             ef.setSectionKey(cmd.getCeilingType());
1361         }
1362         ef.setSectionCrumbsImpl(sectionCrumbs);
1363 
1364         setEntityFormTabsAndGroups(ef, cmd.getTabAndGroupMetadata());
1365 
1366         setEntityFormFields(cmd, ef, Arrays.asList(cmd.getProperties()));
1367         
1368         populateDropdownToOneFields(ef, cmd);
1369         
1370         extensionManager.getProxy().modifyUnpopulatedEntityForm(ef);
1371     }
1372     
1373     /**
1374      * This method is invoked when EntityForms are created and is meant to provide a hook to add
1375      * additional entity form actions for implementors of Broadleaf. Broadleaf modules will typically
1376      * leverage {@link FormBuilderExtensionHandler#addAdditionalFormActions(EntityForm)} method.
1377      * @param ef
1378      */
1379     protected void addAdditionalFormActions(EntityForm ef) {
1380         
1381     }
1382     
1383     @Override
<abbr title="1384     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbs)">1384     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbsðŸ”µ</abbr>
1385             throws ServiceException {
1386         EntityForm ef = createStandardEntityForm();
1387         populateEntityForm(cmd, entity, ef, sectionCrumbs);
1388         addAdditionalFormActions(ef);
1389         extensionManager.getProxy().addAdditionalFormActions(ef);
1390         return ef;
1391     }
1392 
1393     @Override
<abbr title="1394     public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1394     public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; seðŸ”µ</abbr>
1395             throws ServiceException {
1396         // Get the empty form with appropriate fields
1397         populateEntityForm(cmd, ef, sectionCrumbs);
1398 
1399         String idProperty = adminEntityService.getIdProperty(cmd);
1400         ef.setId(entity.findProperty(idProperty).getValue());
1401         ef.setEntityType(entity.getType()[0]);
1402 
1403         populateEntityFormFieldValues(cmd, entity, ef);
1404 
1405         Property p = entity.findProperty(BasicPersistenceModule.MAIN_ENTITY_NAME_PROPERTY);
1406         if (p != null) {
1407             ef.setMainEntityName(p.getValue());
1408         }
1409         
1410         extensionManager.getProxy().modifyPopulatedEntityForm(ef, entity);
1411     }
1412 
<abbr title="1413     protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef) {">1413     protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef)ðŸ”µ</abbr>
1414         for (Property p : cmd.getProperties()) {
1415             FieldMetadata fmd = p.getMetadata();
1416 
1417             if (shouldHideField(fmd, entity)) {
1418                 if (fmd instanceof CollectionMetadata) {
1419                     ef.removeListGrid(p.getName());
1420                 } else {
1421                     ef.removeField(p.getName());
1422                 }
1423             }
1424         }
1425     }
1426 
1427     protected boolean shouldHideField(FieldMetadata fmd, Entity entity) {
1428         if (fmd == null || fmd.getShowIfFieldEquals() == null) {
1429             return false;
1430         }
1431 
1432         for (String property : fmd.getShowIfFieldEquals().keySet()) {
1433             List&lt;String&gt; values = fmd.getShowIfFieldEquals().get(property);
1434             Property entityProp = entity.findProperty(property);
1435 
1436             if (entityProp == null || values.contains(entityProp.getValue())) {
1437                 return false;
1438             }
1439         }
1440         return true;
1441     }
1442 
1443     @Override
1444     public void populateEntityFormFieldValues(ClassMetadata cmd, Entity entity, EntityForm ef) {
1445         // Set the appropriate property values
1446         for (Property p : cmd.getProperties()) {
1447             if (p.getMetadata() instanceof BasicFieldMetadata) {
1448                 BasicFieldMetadata basicFM = (BasicFieldMetadata) p.getMetadata();
1449 
1450                 Property entityProp = entity.findProperty(p.getName());
1451                 
<abbr title="1452                 boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibility());">1452                 boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibiliðŸ”µ</abbr>
1453                 //always show special map fields
1454                 if (p.getName().equals(&quot;key&quot;) || p.getName().equals(&quot;priorKey&quot;)) {
1455                     explicitlyShown = true;
1456                 }
1457                 
1458                 if (entityProp == null &amp;&amp; explicitlyShown) {
1459                     Field field = ef.findField(p.getName());
1460                     if (field != null) {
1461                         field.setValue(null);
1462                     }
<abbr title="1463                 } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1463                 } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getEðŸ”µ</abbr>
1464                     ef.removeField(p.getName());
1465                 } else {
1466                     Field field = ef.findField(p.getName());
1467                     if (field != null) {
1468                         if (entityProp != null) {
<abbr title="1469                             //protect against null - can happen with password confirmation fields (i.e. admin user)">1469                             //protect against null - can happen with password confirmation fields (i.e. aðŸ”µ</abbr>
1470                             field.setDirty(entityProp.getIsDirty());
1471                         }
1472                         if (basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE
1473                                 || basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE_TIME
1474                                 || basicFM.getFieldType()==SupportedFieldType.RULE_WITH_QUANTITY) {
1475                             RuleBuilderField rbf = (RuleBuilderField) field;
1476                             if (entity.getPMap().containsKey(rbf.getJsonFieldName())) {
1477                                 String json = entity.getPMap().get(rbf.getJsonFieldName()).getValue();
1478                                 rbf.setJson(json);
1479                                 DataWrapper dw = convertJsonToDataWrapper(json);
1480                                 if (dw != null) {
1481                                     rbf.setDataWrapper(dw);
1482                                 }
1483                             }
1484                         } 
1485                         if (basicFM.getFieldType() == SupportedFieldType.MEDIA) {
1486                             field.setValue(entityProp.getValue());
1487                             field.setDisplayValue(entityProp.getDisplayValue());
1488                             MediaField mf = (MediaField) field;
<abbr title="1489                             Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(), MediaDto.class);">1489                             Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.gðŸ”µ</abbr>
<abbr title="1490                             mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(), type));">1490                             mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodeðŸ”µ</abbr>
<abbr title="1491                         } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1491                         } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldTyðŸ”µ</abbr>
1492                             field.setValue(entityProp.getValue());
1493                             field.setDisplayValue(entityProp.getDisplayValue());
1494                         }
1495                     }
1496                 }
1497             }
1498         }
1499     }
1500 
1501     /**
1502      * When using Thymeleaf, we need to convert the JSON string back to
1503      * a DataWrapper object because Thymeleaf escapes JSON strings.
1504      * Thymeleaf uses it&#x27;s own object de-serializer
1505      * see: https://github.com/thymeleaf/thymeleaf/issues/84
1506      * see: http://forum.thymeleaf.org/Spring-Javascript-and-escaped-JSON-td4024739.html
1507      * @param json
1508      * @return DataWrapper
1509      * @throws IOException
1510      */
1511     protected DataWrapper convertJsonToDataWrapper(String json) {
1512         ObjectMapper mapper = new ObjectMapper();
1513         DataDTODeserializer dtoDeserializer = new DataDTODeserializer();
<abbr title="1514         SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null));">1514         SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, nuðŸ”µ</abbr>
1515         module.addDeserializer(DataDTO.class, dtoDeserializer);
1516         mapper.registerModule(module);
1517         try {
1518             return mapper.readValue(json, DataWrapper.class);
1519         } catch (IOException e) {
1520             throw new RuntimeException(e);
1521         }
1522     }
1523     
1524     protected void populateDropdownToOneFields(EntityForm ef, ClassMetadata cmd) 
1525             throws ServiceException {
1526         for (Property p : cmd.getProperties()) {
1527             if (p.getMetadata() instanceof BasicFieldMetadata) {
1528                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
1529                 if (LookupType.DROPDOWN.equals(fmd.getLookupType())
1530                         &amp;&amp; !ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
1531                     // Get the records
1532                     PersistencePackageRequest toOnePpr = PersistencePackageRequest.standard()
1533                             .withCeilingEntityClassname(fmd.getForeignKeyClass());
<abbr title="1534                     Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecords();">1534                     Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecoðŸ”µ</abbr>
1535                     
1536                     // Determine the id field
1537                     String idProp = null;
<abbr title="1538                     ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSet().getClassMetaData();">1538                     ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamðŸ”µ</abbr>
1539                     for (Property foreignP : foreignClassMd.getProperties()) {
1540                         if (foreignP.getMetadata() instanceof BasicFieldMetadata) {
1541                             BasicFieldMetadata foreignFmd = (BasicFieldMetadata) foreignP.getMetadata();
1542                             if (SupportedFieldType.ID.equals(foreignFmd.getFieldType())) {
1543                                 idProp = foreignP.getName();
1544                             }
1545                         }
1546                     }
1547                     
1548                     if (idProp == null) {
<abbr title="1549                         throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClass());">1549                         throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeigðŸ”µ</abbr>
1550                     }
1551                     
1552                     // Determine the display field
1553                     String displayProp = fmd.getLookupDisplayProperty();
1554                     
1555                     // Build the options map
1556                     Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
1557                     for (Entity row : rows) {
1558                         Property prop = row.findProperty(displayProp);
1559                         if (prop == null) {
<abbr title="1560                             LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entity [&quot; + ">1560                             LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + ðŸ”µ</abbr>
1561                                     ef.getCeilingEntityClassname() + &quot;]&quot;);
1562                         } else {
1563                             String displayValue = prop.getDisplayValue();
1564                             if (StringUtils.isBlank(displayValue)) {
1565                                 displayValue = prop.getValue();
1566                             }
1567                             options.put(row.findProperty(idProp).getValue(), displayValue);
1568                         }
1569                     }
1570                     
1571                     // Set the options on the entity field
1572                     ComboField cf = (ComboField) ef.findField(p.getName());
1573                     cf.setOptions(options);
1574                 }
1575             }
1576         }
1577     }
1578 
1579     @Override
<abbr title="1580     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, List&lt;SectionCrumb&gt; sectionCrumbs)">1580     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; coðŸ”µ</abbr>
1581             throws ServiceException {
1582         EntityForm ef = createStandardEntityForm();
1583         populateEntityForm(cmd, entity, collectionRecords, ef, sectionCrumbs);
1584         addAdditionalFormActions(ef);
1585         extensionManager.getProxy().addAdditionalFormActions(ef);
1586         return ef;
1587     }
1588     
1589     @Override
<abbr title="1590     public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1590     public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collecðŸ”µ</abbr>
1591             throws ServiceException {
1592         // Get the form with values for this entity
1593         populateEntityForm(cmd, entity, ef, sectionCrumbs);
1594         
1595         // Attach the sub-collection list grids and specialty UI support
1596         for (Property p : cmd.getProperties()) {
1597             if (p.getMetadata() instanceof BasicFieldMetadata) {
1598                 continue;
1599             }
1600             
1601             if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entity.getType()[0])) {
1602                 continue;
1603             }
1604 
1605             if (collectionRecords != null &amp;&amp; !collectionRecords.isEmpty()) {
1606                 DynamicResultSet subCollectionEntities = collectionRecords.get(p.getName());
1607                 String containingEntityId = entity.getPMap().get(ef.getIdProperty()).getValue();
<abbr title="1608                 ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSectionKey(), sectionCrumbs);">1608                 ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p,ðŸ”µ</abbr>
1609 
1610                 CollectionMetadata md = ((CollectionMetadata) p.getMetadata());
1611                 if (md instanceof BasicCollectionMetadata) {
<abbr title="1612                     PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);">1612                     PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCruðŸ”µ</abbr>
<abbr title="1613                     ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1613                     ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResuðŸ”µ</abbr>
1614                     if (collectionCmd.getPolymorphicEntities().getChildren().length != 0) {
<abbr title="1615                         List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTrees();">1615                         List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedðŸ”µ</abbr>
1616                         ListGridActionGroup actionGroup = new ListGridActionGroup().withName(&quot;Add&quot;);
1617                         for (ClassTree entityType : entityTypes) {
1618                             ListGridAction ADD = new ListGridAction(ListGridAction.ADD)
1619                                     .withButtonClass(AddMethodType.PERSIST_EMPTY==
<abbr title="1620                                             ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-grid-add-empty&quot;:&quot;sub-list-grid-add&quot;)">1620                                             ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-gðŸ”µ</abbr>
1621                                     .withActionTargetEntity(entityType.getFullyQualifiedClassname())
1622                                     .withUrlPostfix(&quot;/add&quot;)
1623                                     .withIconClass(&quot;fa fa-plus&quot;)
<abbr title="1624                                     .withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyName()));">1624                                     .withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyNamðŸ”µ</abbr>
1625                             actionGroup.getListGridActions().add(0, ADD);
1626                         }
1627                         listGrid.addToolbarActionGroup(actionGroup);
1628                     } else {
1629                         listGrid.getToolbarActions().add(0, AddMethodType.PERSIST_EMPTY==
<abbr title="1630                                 ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ADD_EMPTY:DefaultListGridActions.ADD);">1630                                 ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ðŸ”µ</abbr>
1631                     }
1632                 } else {
1633                     listGrid.getToolbarActions().add(0, DefaultListGridActions.ADD);
1634                 }
1635 
1636                 if (subCollectionEntities.getUnselectedTabMetadata().get(md.getTab())!=null) {
1637                     ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), true);
1638                 } else {
1639                     ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), false);
1640                 }
1641             }
1642         }
1643 
1644         if (CollectionUtils.isEmpty(ef.getActions())) {
1645             ef.addAction(DefaultEntityFormActions.SAVE);
1646         }
1647         
1648         addDeleteActionIfAllowed(ef, cmd, entity);
1649         addDuplicateActionIfAllowed(ef, cmd);
1650         setReadOnlyState(ef, cmd, entity);
1651 
1652         // check for fields that should be hidden based on annotations
1653         setVisibilityBasedOnShowIfFieldEquals(cmd, entity, ef);
1654 
1655         extensionManager.getProxy().modifyDetailEntityForm(ef);
1656     }
1657     
1658     /**
<abbr title="1659      * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The user can">1659      * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/bðŸ”µ</abbr>
1660      * delete an entity for the following cases:
1661      * &lt;ol&gt;
<abbr title="1662      *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represented by">1662      *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represenðŸ”µ</abbr>
<abbr title="1663      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;">1663      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/lðŸ”µ</abbr>
1664      *  &lt;li&gt;The user has the security necessary to delete the given &lt;b&gt;entity&lt;/b&gt; according to the
1665      *  {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}&lt;/li&gt;
1666      * &lt;/ol&gt;
1667      * 
1668      * @param entityForm the form being generated
1669      * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1670      * @param entity the entity being edited
1671      * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1672      * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1673      * @see {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}
1674      */
1675     protected void addDeleteActionIfAllowed(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1676         if (isDeletionAllowed(entityForm, cmd, entity)) {
1677             entityForm.addAction(DefaultEntityFormActions.DELETE);
1678         }
1679     }
1680     
1681     protected boolean isDeletionAllowed(final EntityForm entityForm, final ClassMetadata cmd, 
1682             final Entity entity) {
1683         try {
1684             String securityEntityClassname = getSecurityClassname(entityForm, cmd);
1685             adminRemoteSecurityService
1686                     .securityCheck(securityEntityClassname, EntityOperationType.REMOVE);
1687         } catch (ServiceException e) {
1688             if (e instanceof SecurityServiceException) {
1689                 return false;
1690             }
1691         }
1692 
1693         final AdminUser persistentAdminUser = adminRemoteSecurityService.getPersistentAdminUser();
1694         
1695         return rowLevelSecurityService.canUpdate(persistentAdminUser, entity)
1696                 &amp;&amp; rowLevelSecurityService.canRemove(persistentAdminUser, entity);
1697     }
1698     
1699     protected void addDuplicateActionIfAllowed(final EntityForm entityForm,
1700             final ClassMetadata cmd) {
1701         if (isDuplicationAllowed(entityForm, cmd)) {
1702             entityForm.addAction(DefaultEntityFormActions.DUPLICATE);
1703         }
1704     }
1705 
1706     protected boolean isDuplicationAllowed(final EntityForm entityForm, final ClassMetadata cmd) {
1707         final String securityClassname = getSecurityClassname(entityForm, cmd);
1708 
1709         try {
1710             adminRemoteSecurityService.securityCheck(securityClassname, EntityOperationType.ADD);
1711         } catch (ServiceException e) {
1712             if (e instanceof SecurityServiceException) {
1713                 return false;
1714             }
1715         }
1716 
1717         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(securityClassname);
1718         
1719         return duplicator.validate(entityClass, Long.valueOf(entityForm.getId())) &amp;&amp; 
1720                 rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), 
1721                         securityClassname, cmd);
1722     }
1723     
1724     /**
1725      * The given &lt;b&gt;entityForm&lt;/b&gt; is marked as readonly for the following cases:
1726      * &lt;ol&gt;
1727      *  &lt;li&gt;All of the properties from &lt;b&gt;cmd&lt;/b&gt; are readonly&lt;/b&gt;&lt;/li&gt;
<abbr title="1728      *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represented by">1728      *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class namðŸ”µ</abbr>
<abbr title="1729      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;">1729      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/lðŸ”µ</abbr>
<abbr title="1730      *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to the">1730      *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to ðŸ”µ</abbr>
1731      *  {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}&lt;/li&gt;
1732      * &lt;/ol&gt;
1733      * 
1734      * @param entityForm the form being generated
1735      * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1736      * @param entity the entity being edited
1737      * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1738      * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1739      * @see {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}
1740      */
1741     protected void setReadOnlyState(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1742         boolean readOnly = true;
1743         
1744         // If all of the fields are read only, we&#x27;ll mark the form as such
1745         for (Property property : cmd.getProperties()) {
1746             FieldMetadata fieldMetadata = property.getMetadata();
1747             if (fieldMetadata instanceof BasicFieldMetadata) {
<abbr title="1748                 readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieldMetadata).getReadOnly();">1748                 readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetaðŸ”µ</abbr>
1749                 if (!readOnly) {
1750                     break;
1751                 }
1752             } else {
1753                 readOnly = ((CollectionMetadata) fieldMetadata).isMutable();
1754                 if (!readOnly) {
1755                     break;
1756                 }
1757             }
1758         }
1759 
1760         if (!readOnly) {
<abbr title="1761             // If the user does not have edit permissions, we will go ahead and make the form read only to prevent confusion">1761             // If the user does not have edit permissions, we will go ahead and make the form read only tðŸ”µ</abbr>
1762             try {
1763                 String securityEntityClassname = getSecurityClassname(entityForm, cmd);
<abbr title="1764                 adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDATE);">1764                 adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDðŸ”µ</abbr>
1765             } catch (ServiceException e) {
1766                 if (e instanceof SecurityServiceException) {
1767                     readOnly = true;
1768                 }
1769             }
1770         }
1771         
<abbr title="1772         // if the normal admin security service has not deemed this readonly and the all of the properties on the entity">1772         // if the normal admin security service has not deemed this readonly and the all of the propertieðŸ”µ</abbr>
1773         // are not readonly, then check the row-level security
1774         if (!readOnly) {
<abbr title="1775             readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1775             readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUsðŸ”µ</abbr>
1776         }
1777 
1778         if (readOnly) {
1779             entityForm.setReadOnly();
<abbr title="1780             //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface">1780             //If someone has replaced RowLevelSecurityService, check here to make sure the replacement imðŸ”µ</abbr>
1781             if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title="1782                 EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();">1782                 EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLeveðŸ”µ</abbr>
<abbr title="1783                 for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {">1783                 for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguðŸ”µ</abbr>
1784                     for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
1785                         if (modifier.isQualified(data.getModifierType())) {
1786                             modifier.modifyEntityForm(new EntityFormModifierRequest()
1787                                     .withEntityForm(entityForm)
1788                                     .withConfiguration(data)
1789                                     .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
1790                                     .withEntity(entity)
1791                                     .withRowLevelSecurityService(rowLevelSecurityService));
1792                         }
1793                     }
1794                 }
1795             }
1796         }
1797     }
1798     
1799     /**
1800      * Obtains the class name suitable for passing along to the {@link SecurityVerifier}
1801      * @param entityForm
1802      * @param cmd
1803      * @return
1804      */
1805     protected String getSecurityClassname(EntityForm entityForm, ClassMetadata cmd) {
1806         String securityEntityClassname = entityForm.getCeilingEntityClassname();
1807 
1808         if (!StringUtils.isEmpty(cmd.getSecurityCeilingType())) {
1809             securityEntityClassname = cmd.getSecurityCeilingType();
1810         } else {
1811             if (entityForm.getDynamicFormInfos() != null) {
1812                 for (DynamicEntityFormInfo info : entityForm.getDynamicFormInfos().values()) {
1813                     if (!StringUtils.isEmpty(info.getSecurityCeilingClassName())) {
1814                         securityEntityClassname = info.getSecurityCeilingClassName();
1815                         break;
1816                     }
1817                 }
1818             }
1819         }
1820         
1821         return securityEntityClassname;
1822     }
1823     
1824     @Override
1825     public void populateEntityFormFields(EntityForm ef, Entity entity) {
1826         populateEntityFormFields(ef, entity, true, true);
1827     }
1828 
1829     @Override
<abbr title="1830     public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean populateId) {">1830     public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean popuðŸ”µ</abbr>
1831         if (populateId) {
1832             ef.setId(entity.findProperty(ef.getIdProperty()).getValue());
1833         }
1834         if (populateType) {
1835             ef.setEntityType(entity.getType()[0]);
1836         }
1837 
1838         for (Entry&lt;String, Field&gt; entry : ef.getFields().entrySet()) {
1839             Property entityProp = entity.findProperty(entry.getKey());
1840             if (entityProp != null) {
1841                 entry.getValue().setValue(entityProp.getValue());
1842                 entry.getValue().setDisplayValue(entityProp.getDisplayValue());
1843             }
1844         }
1845     }
1846 
1847     @Override
<abbr title="1848     public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedList) {">1848     public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedLiðŸ”µ</abbr>
<abbr title="1849         Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());">1849         Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdPropeðŸ”µ</abbr>
1850         Property entityProp = entity.findProperty(ef.getIdProperty());
1851         field.setValue(entityProp.getValue());
1852 
1853         if (StringUtils.isNotBlank(adornedList.getSortField())) {
1854             field = ef.findField(adornedList.getSortField());
1855             entityProp = entity.findProperty(adornedList.getSortField());
1856             if (field != null &amp;&amp; entityProp != null) {
1857                 field.setValue(entityProp.getValue());
1858             }
1859         }
1860     }
1861 
1862     @Override
1863     public void populateMapEntityFormFields(EntityForm ef, Entity entity) {
1864         Field field = ef.findField(&quot;priorKey&quot;);
1865         Property entityProp = entity.findProperty(&quot;key&quot;);
1866         if (field != null &amp;&amp; entityProp != null) {
1867             field.setValue(entityProp.getValue());
1868         }
1869     }
1870 
1871     @Override
<abbr title="1872     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1872     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList aðŸ”µ</abbr>
<abbr title="1873             String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1873             String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdðŸ”µ</abbr>
1874             throws ServiceException {
1875         EntityForm ef = createStandardAdornedEntityForm();
<abbr title="1876         return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAdd);">1876         return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrðŸ”µ</abbr>
1877     }
1878     
1879     @Override
<abbr title="1880     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1880     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList aðŸ”µ</abbr>
<abbr title="1881             String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1881             String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbðŸ”µ</abbr>
1882             throws ServiceException {
1883         ef.setEntityType(adornedList.getAdornedTargetEntityClassname());
1884 
1885         // Get the metadata for this adorned field
1886         PersistencePackageRequest request = PersistencePackageRequest.adorned()
1887                 .withCeilingEntityClassname(adornedMd.getCollectionCeilingEntity())
1888                 .withAdornedList(adornedList)
1889                 .withSectionCrumbs(sectionCrumbs);
1890         request.setAddOperationInspect(isAdd);
<abbr title="1891         ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getClassMetaData();">1891         ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSðŸ”µ</abbr>
1892 
1893         List&lt;Property&gt; entityFormProperties = new ArrayList&lt;&gt;();
1894         if (isViewCollectionItem) {
1895             Collections.addAll(entityFormProperties, collectionMetadata.getProperties());
1896         } else {
1897             // We want our entity form to only render the maintained adorned target fields
1898             for (String targetFieldName : adornedMd.getMaintainedAdornedTargetFields()) {
1899                 Property p = collectionMetadata.getPMap().get(targetFieldName);
<abbr title="1900                 if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExcluded())) {">1900                 if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadatðŸ”µ</abbr>
1901                     ((BasicFieldMetadata) p.getMetadata()).setVisibility(VisibilityEnum.VISIBLE_ALL);
1902                     entityFormProperties.add(p);
1903                 }
1904             }
1905         }
1906 
1907         // Set the maintained fields on the form
1908         setEntityFormFields(collectionMetadata, ef, entityFormProperties);
1909 
1910         // Add these two additional hidden fields that are required for persistence
1911         Field f = new Field()
1912                 .withName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty())
1913                 .withFieldType(SupportedFieldType.HIDDEN.toString())
1914                 .withValue(parentId);
1915         ef.addHiddenField(collectionMetadata, f);
1916 
1917         f = new Field()
1918                 .withName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty())
1919                 .withFieldType(SupportedFieldType.HIDDEN.toString())
1920                 .withIdOverride(&quot;adornedTargetIdProperty&quot;);
1921         ef.addHiddenField(collectionMetadata, f);
1922 
1923         if (StringUtils.isNotBlank(adornedList.getSortField())) {
1924             f = new Field()
1925                     .withName(adornedList.getSortField())
1926                     .withFieldType(SupportedFieldType.HIDDEN.toString());
1927             ef.addHiddenField(collectionMetadata, f);
1928         }
1929 
1930         ef.setParentId(parentId);
1931 
1932         extensionManager.getProxy().addAdditionalAdornedFormActions(ef);
1933 
1934         return ef;
1935     }
1936 
1937 
1938     @Override
<abbr title="1939     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId)">1939     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd,ðŸ”µ</abbr>
1940             throws ServiceException {
1941         EntityForm ef = createStandardEntityForm();
1942         return buildMapForm(mapMd, mapStructure, cmd, parentId, ef);
1943     }
1944     
1945     @Override
<abbr title="1946     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId, EntityForm ef)">1946     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd,ðŸ”µ</abbr>
1947             throws ServiceException {
1948         ForeignKey foreignKey = (ForeignKey) mapMd.getPersistencePerspective()
1949                 .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY);
1950         ef.setEntityType(foreignKey.getForeignKeyClass());
1951 
1952         Field keyField;
1953         if (!mapMd.getForceFreeFormKeys()) {
1954             // We will use a combo field to render the key choices
1955             ComboField temp = new ComboField();
1956             temp.withName(&quot;key&quot;)
1957                     .withFieldType(&quot;combo_field&quot;)
1958                     .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1959             if (mapMd.getKeys() != null) {
1960                 // The keys can be explicitly set in the annotation...
1961                 temp.setOptions(mapMd.getKeys());
1962             } else {
1963                 // Or they could be based on a different entity
1964                 PersistencePackageRequest ppr = PersistencePackageRequest.standard()
1965                         .withCeilingEntityClassname(mapMd.getMapKeyOptionEntityClass());
1966 
1967                 DynamicResultSet drs = adminEntityService.getRecords(ppr).getDynamicResultSet();
1968     
1969                 for (Entity entity : drs.getRecords()) {
<abbr title="1970                     String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getValue();">1970                     String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getVaðŸ”µ</abbr>
<abbr title="1971                     String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getValue();">1971                     String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayFieldðŸ”µ</abbr>
1972                     temp.putOption(keyValue, keyDisplayValue);
1973                 }
1974             }
1975             keyField = temp;
1976         } else {
1977             keyField = new Field().withName(&quot;key&quot;)
1978                                 .withFieldType(SupportedFieldType.STRING.toString())
1979                                 .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1980         }
1981         keyField.setRequired(true);
1982         ef.addMapKeyField(cmd, keyField);
1983         
1984         // Set the fields for this form
1985         List&lt;Property&gt; mapFormProperties;
1986         if (mapMd.isSimpleValue()) {
1987             ef.setIdProperty(&quot;key&quot;);
1988             mapFormProperties = new ArrayList&lt;&gt;();
1989             Property valueProp = cmd.getPMap().get(&quot;value&quot;);
1990             mapFormProperties.add(valueProp);
1991         } else {
1992             String valueClassName = mapStructure.getValueClassName();
1993             List&lt;String&gt; classNames = getValueClassNames(valueClassName);
1994 
1995             mapFormProperties = new ArrayList&lt;&gt;(Arrays.asList(cmd.getProperties()));
1996             filterMapFormProperties(mapFormProperties, classNames);
1997         }
1998 
1999         setEntityFormFields(cmd, ef, mapFormProperties);
2000 
2001         Field f = new Field()
2002                 .withName(&quot;priorKey&quot;)
2003                 .withFieldType(SupportedFieldType.HIDDEN.toString());
2004         ef.addHiddenField(cmd, f);
2005 
2006         ef.setParentId(parentId);
2007 
2008         return ef;
2009     }
2010 
2011     protected List&lt;String&gt; getValueClassNames(String valueClassName) {
2012         PersistenceManager pm = PersistenceManagerFactory.getPersistenceManager(valueClassName);
2013         List&lt;String&gt; classNames = new ArrayList&lt;&gt;();
2014         try {
2015             Class&lt;?&gt;[] mapEntities = pm.getPolymorphicEntities(valueClassName);
2016             for (Class clazz : mapEntities) {
2017                 classNames.add(clazz.getName());
2018             }
2019         } catch (ClassNotFoundException e) {
2020             classNames.add(valueClassName);
2021         }
2022         return classNames;
2023     }
2024 
<abbr title="2025     protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNames) {">2025     protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNameðŸ”µ</abbr>
2026         CollectionUtils.filter(mapFormProperties, new Predicate() {
2027             @Override
2028             public boolean evaluate(Object object) {
2029                 Property p = (Property) object;
2030                 for (String availType : p.getMetadata().getAvailableToTypes()) {
2031                     if (classNames.contains(availType)) {
2032                         return true;
2033                     }
2034                 }
2035                 return false;
2036             }
2037         });
2038     }
2039 
2040     protected EntityForm createStandardEntityForm() {
2041         EntityForm ef = new EntityForm();
2042         ef.addAction(DefaultEntityFormActions.SAVE);
2043         return ef;
2044     }
2045 
2046     protected EntityForm createStandardAdornedEntityForm() {
2047         EntityForm ef = new EntityForm();
2048         ef.addAction(DefaultAdornedEntityFormActions.Add);
2049         return ef;
2050     }
2051     
2052     protected VisibilityEnum[] getGridHiddenVisibilities() {
2053         return FormBuilderServiceImpl.GRID_HIDDEN_VISIBILITIES;
2054     }
2055     
2056     protected VisibilityEnum[] getFormHiddenVisibilities() {
2057         return FormBuilderServiceImpl.FORM_HIDDEN_VISIBILITIES;
2058     }
2059 
2060 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.service;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.Predicate;
  22 import org.apache.commons.lang.ArrayUtils;
  23 import org.apache.commons.lang.BooleanUtils;
  24 import org.apache.commons.lang3.StringUtils;
  25 import org.apache.commons.logging.Log;
  26 import org.apache.commons.logging.LogFactory;
  27 import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  28 import org.broadleafcommerce.common.exception.ExceptionHelper;
  29 import org.broadleafcommerce.common.exception.SecurityServiceException;
  30 import org.broadleafcommerce.common.exception.ServiceException;
  31 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  32 import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  33 import org.broadleafcommerce.common.i18n.service.TranslationService;
  34 import org.broadleafcommerce.common.locale.service.LocaleService;
  35 import org.broadleafcommerce.common.media.domain.MediaDto;
  36 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  37 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  38 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  39 import org.broadleafcommerce.common.presentation.client.AdornedTargetAddMethodType;
  40 import org.broadleafcommerce.common.presentation.client.LookupType;
  41 import org.broadleafcommerce.common.presentation.client.PersistencePerspectiveItemType;
  42 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  43 import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  44 import org.broadleafcommerce.common.util.BLCMessageUtils;
  45 import org.broadleafcommerce.common.util.FormatUtil;
  46 import org.broadleafcommerce.common.util.StringUtil;
  47 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  48 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  49 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  50 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  51 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  52 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  53 import org.broadleafcommerce.openadmin.dto.ClassTree;
  54 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  55 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  56 import org.broadleafcommerce.openadmin.dto.Entity;
  57 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  58 import org.broadleafcommerce.openadmin.dto.ForeignKey;
  59 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  60 import org.broadleafcommerce.openadmin.dto.MapStructure;
  61 import org.broadleafcommerce.openadmin.dto.Property;
  62 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  63 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  64 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  65 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  66 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  67 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  68 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  69 import org.broadleafcommerce.openadmin.server.security.remote.SecurityVerifier;
  70 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifier;
  71 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierConfiguration;
  72 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierData;
  73 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierDataPoint;
  74 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierRequest;
  75 import org.broadleafcommerce.openadmin.server.security.service.ExceptionAwareRowLevelSecurityProvider;
  76 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  77 import org.broadleafcommerce.openadmin.server.security.service.navigation.AdminNavigationService;
  78 import org.broadleafcommerce.openadmin.server.service.AdminEntityService;
  79 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManager;
  80 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  81 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  82 import org.broadleafcommerce.openadmin.server.service.persistence.module.FieldManager;
  83 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  84 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  85 import org.broadleafcommerce.openadmin.web.form.component.ListGridAction;
  86 import org.broadleafcommerce.openadmin.web.form.component.ListGridActionGroup;
  87 import org.broadleafcommerce.openadmin.web.form.component.ListGridRecord;
  88 import org.broadleafcommerce.openadmin.web.form.component.MediaField;
  89 import org.broadleafcommerce.openadmin.web.form.component.RuleBuilderField;
  90 import org.broadleafcommerce.openadmin.web.form.entity.CodeField;
  91 import org.broadleafcommerce.openadmin.web.form.entity.ComboField;
  92 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  93 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  94 import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  95 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  96 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  97 import org.broadleafcommerce.openadmin.web.rulebuilder.DataDTODeserializer;
  98 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataDTO;
  99 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataWrapper;
 100 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldDTO;
 101 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldWrapper;
 102 import org.codehaus.jettison.json.JSONObject;
 103 import org.springframework.beans.factory.annotation.Value;
 104 import org.springframework.context.MessageSource;
 105 import org.springframework.context.NoSuchMessageException;
 106 import org.springframework.stereotype.Service;
 107 
 108 import com.fasterxml.jackson.core.Version;
 109 import com.fasterxml.jackson.databind.ObjectMapper;
 110 import com.fasterxml.jackson.databind.module.SimpleModule;
 111 
 112 import java.io.IOException;
 113 import java.math.BigDecimal;
 114 import java.text.DateFormat;
 115 import java.text.DateFormatSymbols;
 116 import java.text.ParseException;
 117 import java.text.SimpleDateFormat;
 118 import java.util.ArrayList;
 119 import java.util.Arrays;
 120 import java.util.Collections;
 121 import java.util.Date;
 122 import java.util.HashMap;
 123 import java.util.List;
 124 import java.util.Locale;
 125 import java.util.Map;
 126 import java.util.Map.Entry;
 127 import java.util.Set;
 128 
 129 import javax.annotation.Resource;
 130 import javax.persistence.ManyToOne;
 131 import javax.persistence.OneToOne;
 132 import javax.servlet.http.HttpServletRequest;
 133 
 134 
 135 /**
 136  * @author Andre Azzolini (apazzolini)
 137  */
 138 @Service(&quot;blFormBuilderService&quot;)
 139 public class FormBuilderServiceImpl implements FormBuilderService {
 140 
 141     private static final Log LOG = LogFactory.getLog(FormBuilderServiceImpl.class);
 142 
 143     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 144 
 145     @Resource(name = &quot;blAdminEntityService&quot;)
 146     protected AdminEntityService adminEntityService;
 147 
 148     @Resource (name = &quot;blAdminNavigationService&quot;)
 149     protected AdminNavigationService navigationService;
 150 
 151     @Resource(name = &quot;blFormBuilderExtensionManager&quot;)
 152     protected FormBuilderExtensionManager extensionManager;
 153 
 154     @Resource(name=&quot;blEntityConfiguration&quot;)
 155     protected EntityConfiguration entityConfiguration;
 156 
 157     @Resource(name=&quot;blAdminSecurityRemoteService&quot;)
 158     protected SecurityVerifier adminRemoteSecurityService;
 159 
 160     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 161     protected RowLevelSecurityService rowLevelSecurityService;
 162 
 163     @Resource(name = &quot;blMediaBuilderService&quot;)
 164     protected MediaBuilderService mediaBuilderService;
 165 
 166     @Resource(name = &quot;blListGridErrorMessageExtensionManager&quot;)
 167     protected ListGridErrorMessageExtensionManager listGridErrorExtensionManager;
 168 
 169     @Resource(name = &quot;blAdminNavigationService&quot;)
 170     protected AdminNavigationService adminNavigationService;
 171 
 172     @Resource(name = &quot;blEntityDuplicator&quot;)
 173     protected EntityDuplicator duplicator;
 174 
 175     @Resource(name = &quot;blDynamicEntityDao&quot;)
 176     protected DynamicEntityDao dynamicEntityDao;
 177 
 178     @Resource(name = &quot;blLocaleService&quot;)
 179     protected LocaleService localeService;
 180 
 181     @Resource(name = &quot;blTranslationService&quot;)
 182     protected TranslationService translationService;
 183 
 184     @Value(&quot;${use.translation.search:false}&quot;)
 185     protected boolean useTranslationSearch;
 186 
 187     protected static final VisibilityEnum[] FORM_HIDDEN_VISIBILITIES = new VisibilityEnum[] {
 188             VisibilityEnum.HIDDEN_ALL, VisibilityEnum.FORM_HIDDEN
 189     };
 190 
 191     protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[] {
 192             VisibilityEnum.HIDDEN_ALL, VisibilityEnum.GRID_HIDDEN
 193     };
 194 
 195     @Override
<abbr title=" 196     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)"> 196     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SeðŸ”µ</abbr>
 197             throws ServiceException {
 198 
 199         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 200         ListGrid.Type type = ListGrid.Type.MAIN;
 201         String idProperty = &quot;id&quot;;
 202 
 203         FieldWrapper wrapper = new FieldWrapper();
 204         ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 205         for (Property p : cmd.getProperties()) {
 206             if (p.getMetadata() instanceof BasicFieldMetadata) {
 207                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
 208 
 209                 if (SupportedFieldType.ID.equals(fmd.getFieldType())) {
 210                     idProperty = fmd.getName();
 211                 }
 212 
 213                 if (fmd.isProminent() != null &amp;&amp; fmd.isProminent()
 214                         &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), fmd.getVisibility())) {
 215                     Field hf = createHeaderField(p, fmd);
 216                     headerFields.add(hf);
 217                     defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, fmd));
 218                 }
 219 
 220                 if (fmd.getIsFilter() != null &amp;&amp; fmd.getIsFilter()) {
<abbr title=" 221                     wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmd));"> 221                     wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmdðŸ”µ</abbr>
 222                 }
 223             }
 224         }
 225 
 226         if (useTranslationSearch) {
 227             getTranslationSearchField(cmd.getCeilingType(), defaultWrapperFields);
 228         }
 229 
<abbr title=" 230         ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idProperty, sectionCrumbs);"> 230         ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, ðŸ”µ</abbr>
 231 
 232         if (CollectionUtils.isNotEmpty(listGrid.getHeaderFields())) {
 233             // Set the first column to be able to link to the main entity
 234             listGrid.getHeaderFields().iterator().next().setMainEntityLink(true);
 235         } else {
<abbr title=" 236             String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType();"> 236             String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeiðŸ”µ</abbr>
 237             message += &quot;Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 238             LOG.error(message);
 239         }
 240 
 241         Date c = new Date();
 242         String friendlyName = &quot;listGrid&quot; + c.getTime();
 243         // Set up the filter builder params
 244         listGrid.setJsonFieldName(friendlyName + &quot;Json&quot;);
 245         listGrid.setFriendlyName(friendlyName);
 246         listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 247         if (CollectionUtils.isEmpty(wrapper.getFields())) {
 248             wrapper.setFields(defaultWrapperFields);
 249         }
 250         listGrid.setFieldWrapper(wrapper);
 251         listGrid.setHideFriendlyName(true);
 252 
 253         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 254         listGrid.setJson(blankJsonString);
 255         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 256         if (dw != null) {
 257             listGrid.setDataWrapper(dw);
 258         }
 259 
 260         listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 261         listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 262 
 263         extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 264 
 265         return listGrid;
 266     }
 267 
<abbr title=" 268     private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFields) {"> 268     private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFieldsðŸ”µ</abbr>
 269 
 270         TranslatedEntity translatedEntity;
 271 
 272         try {
 273             translatedEntity = translationService.getAssignableEntityType(ceilingEntity);
 274 
 275             FieldDTO localeField = new FieldDTO();
 276             localeField.setId(&quot;translationLocale&quot;);
 277             localeField.setLabel(&quot;Translation locale&quot;);
 278             localeField.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 279             localeField.setInput(&quot;select&quot;);
 280             localeField.setType(&quot;string&quot;);
 281 
<abbr title=" 282             List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocales();"> 282             List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocaleðŸ”µ</abbr>
 283 
 284             Map&lt;String, String&gt; localeMap = new HashMap&lt;String, String&gt;();
 285             for (org.broadleafcommerce.common.locale.domain.Locale l : locales) {
 286                 localeMap.put(l.getLocaleCode(), l.getFriendlyName());
 287             }
 288             localeField.setValues((new JSONObject(localeMap)).toString());
 289 
 290             defaultWrapperFields.add(localeField);
 291         } catch (Exception e) {
 292             translatedEntity = null;
 293         }
 294     }
 295 
 296     protected FieldDTO constructFieldDTOFromFieldData(Field field, BasicFieldMetadata fmd) {
 297         FieldDTO fieldDTO = new FieldDTO();
 298         //translate the label to display
 299         String label = field.getFriendlyName();
 300         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 301         MessageSource messages = context.getMessageSource();
 302         if (messages != null) {
 303             label = messages.getMessage(label, null, label, context.getJavaLocale());
 304         }
 305         fieldDTO.setLabel(label);
 306 
 307         fieldDTO.setId(field.getName());
 308         if (field.getFieldType().equals(&quot;STRING&quot;)) {
 309             fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 310         } else if (field.getFieldType().equals(&quot;DATE&quot;)) {
 311             fieldDTO.setOperators(&quot;blcFilterOperators_Date&quot;);
<abbr title=" 312         } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldType().equals(&quot;DECIMAL&quot;)) {"> 312         } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || fieldðŸ”µ</abbr>
 313             fieldDTO.setOperators(&quot;blcFilterOperators_Numeric&quot;);
 314         } else if (field.getFieldType().equals(&quot;BOOLEAN&quot;)) {
 315             fieldDTO.setOperators(&quot;blcFilterOperators_Boolean&quot;);
 316         } else if (field.getFieldType().equals(&quot;BROADLEAF_ENUMERATION&quot;)) {
 317             fieldDTO.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 318             fieldDTO.setInput(&quot;select&quot;);
 319             fieldDTO.setType(&quot;string&quot;);
 320             String[][] enumerationValues = fmd.getEnumerationValues ();
 321             Map&lt;String, String&gt; enumMap = new HashMap&lt;&gt;();
 322             for (int i = 0; i &lt; enumerationValues.length; i++) {
 323                 enumMap.put(enumerationValues[i][0], enumerationValues[i][1]);
 324             }
 325 
 326             fieldDTO.setValues(new JSONObject(enumMap).toString());
 327         } else if (field.getFieldType().equals(&quot;ADDITIONAL_FOREIGN_KEY&quot;)) {
 328             fieldDTO.setOperators(&quot;blcFilterOperators_Selectize&quot;);
 329             fieldDTO.setType(&quot;string&quot;);
 330 
<abbr title=" 331             AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClass(), null);"> 331             AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeðŸ”µ</abbr>
 332             if (section != null) {
 333                 String sectionKey = section.getUrl().substring(1);
 334                 fieldDTO.setSelectizeSectionKey(sectionKey);
 335             } else {
 336                 fieldDTO.setSelectizeSectionKey(fmd.getForeignKeyClass());
 337             }
 338         } else {
 339             fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 340         }
 341 
 342         return fieldDTO;
 343     }
 344 
 345     protected Field createHeaderField(Property p, BasicFieldMetadata fmd) {
 346         Field hf;
 347         if (fmd.getFieldType().equals(SupportedFieldType.EXPLICIT_ENUMERATION) ||
 348                 fmd.getFieldType().equals(SupportedFieldType.BROADLEAF_ENUMERATION) ||
 349                 fmd.getFieldType().equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION) ||
 350                 fmd.getFieldType().equals(SupportedFieldType.EMPTY_ENUMERATION)) {
 351             hf = new ComboField();
 352             ((ComboField) hf).setOptions(fmd.getEnumerationValues());
 353         } else {
 354             hf = new Field();
 355         }
 356 
 357         hf.withName(p.getName())
<abbr title=" 358           .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getName())"> 358           .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getðŸ”µ</abbr>
 359           .withOrder(fmd.getGridOrder())
 360           .withColumnWidth(fmd.getColumnWidth())
 361           .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
 362           .withForeignKeyClass(fmd.getForeignKeyClass())
 363           .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title=" 364           .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClass())"> 364           .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClassðŸ”µ</abbr>
 365           .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity());
 366         String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 367         hf.setFieldType(fieldType);
 368 
 369         return hf;
 370     }
 371 
 372     @Override
<abbr title=" 373     public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property field,"> 373     public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property fieðŸ”µ</abbr>
 374             String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 375             throws ServiceException {
 376         FieldMetadata fmd = field.getMetadata();
 377         // Get the class metadata for this particular field
 378         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 379         if (field != null) {
 380             ppr.setSectionEntityField(field.getName());
 381         }
<abbr title=" 382         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 382         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDaðŸ”µ</abbr>
 383 
 384         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 385         ListGrid.Type type = null;
 386         boolean editable = false;
 387         boolean sortable = false;
 388         boolean readOnly = false;
 389         boolean hideIdColumn = false;
 390         boolean canFilterAndSort = true;
 391         boolean modalSingleSelectable = false;
 392         boolean modalMultiSelectable = false;
 393         boolean selectize = false;
 394         boolean isMedia = false;
 395         boolean isLookup = false;
 396         String sortProperty = null;
 397         FieldWrapper wrapper = new FieldWrapper();
 398         ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 399 
 400 
 401         String idProperty = &quot;id&quot;;
 402         for (Property property : cmd.getProperties()) {
 403             if (property.getMetadata() instanceof BasicFieldMetadata &amp;&amp;
<abbr title=" 404                     SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;&amp;"> 404                     SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;ðŸ”µ</abbr>
 405                     //make sure it&#x27;s a property for this entity - not an association
 406                     !property.getName().contains(&quot;.&quot;)) {
 407                 idProperty = property.getName();
 408                 break;
 409             }
 410         }
<abbr title=" 411         // Get the header fields for this list grid. Note that the header fields are different depending on the"> 411         // Get the header fields for this list grid. Note that the header fields are different depending ðŸ”µ</abbr>
 412         // kind of field this is.
 413         if (fmd instanceof BasicFieldMetadata) {
 414             readOnly = ((BasicFieldMetadata) fmd).getReadOnly();
 415             modalSingleSelectable = true;
 416             for (Property p : cmd.getProperties()) {
 417                 if (p.getMetadata() instanceof BasicFieldMetadata) {
 418                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 419 
 420                     if (SupportedFieldType.ID.equals(md.getFieldType())) {
 421                         idProperty = md.getName();
 422                     }
 423 
 424                     if (md.isProminent() != null &amp;&amp; md.isProminent()
 425                             &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 426                         Field hf = createHeaderField(p, md);
 427                         headerFields.add(hf);
 428                         defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 429                     }
 430 
 431                     if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 432                         Field f = createHeaderField(p, md);
 433                         wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 434                     }
 435                 }
 436             }
 437 
 438             type = ListGrid.Type.TO_ONE;
 439         } else if (fmd instanceof BasicCollectionMetadata) {
 440             BasicCollectionMetadata bcm = (BasicCollectionMetadata) fmd;
 441             readOnly = !bcm.isMutable();
 442 
 443             if(AddMethodType.LOOKUP.equals(bcm.getAddMethodType())) {
 444                 isLookup = true;
 445             }
 446 
 447             if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 448                 Property p = cmd.getPMap().get(bcm.getSelectizeVisibleField());
 449                 if (p != null) {
 450                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 451 
 452                     Field hf = createHeaderField(p, md);
 453                     headerFields.add(hf);
 454                     wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 455                 }
 456             } else {
 457                 for (Property p : cmd.getProperties()) {
 458                     if (p.getMetadata() instanceof BasicFieldMetadata) {
 459                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 460                         if (md.isProminent() != null &amp;&amp; md.isProminent()
<abbr title=" 461                                 &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {"> 461                                 &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility()))ðŸ”µ</abbr>
 462                             Field hf = createHeaderField(p, md);
 463                             headerFields.add(hf);
 464                             defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 465                         }
 466 
 467                         if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 468                             Field f = createHeaderField(p, md);
 469                             wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 470                         }
 471                     }
 472                 }
 473             }
 474 
 475             type = ListGrid.Type.BASIC;
 476 
<abbr title=" 477             if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getAddMethodType())) {"> 477             if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equalðŸ”µ</abbr>
 478                 editable = true;
 479             } else if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 480                 selectize = true;
 481                 modalSingleSelectable = true;
 482             } else {
 483                 modalSingleSelectable = true;
 484             }
 485             sortable = StringUtils.isNotBlank(bcm.getSortProperty());
 486             if (sortable) {
 487                 sortProperty = bcm.getSortProperty();
 488             }
 489         } else if (fmd instanceof AdornedTargetCollectionMetadata) {
 490             modalSingleSelectable = true;
 491             readOnly = !((AdornedTargetCollectionMetadata) fmd).isMutable();
 492             AdornedTargetCollectionMetadata atcmd = (AdornedTargetCollectionMetadata) fmd;
 493 
 494             if(AdornedTargetAddMethodType.LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 495                 isLookup = true;
 496             }
 497 
<abbr title=" 498             if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {"> 498             if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())ðŸ”µ</abbr>
 499                 selectize = true;
 500 
 501                 Property p = cmd.getPMap().get(atcmd.getSelectizeVisibleField());
 502                 if (p != null) {
 503                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 504 
 505                     Field hf = createHeaderField(p, md);
 506                     headerFields.add(hf);
 507                     wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 508                 }
 509             } else {
 510                 for (String fieldName : atcmd.getGridVisibleFields()) {
 511                     Property p = cmd.getPMap().get(fieldName);
 512                     if (p != null) {
 513                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 514 
 515                         Field hf = createHeaderField(p, md);
 516                         headerFields.add(hf);
 517                         wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 518                     }
 519 
 520                 }
 521             }
 522 
 523             type = ListGrid.Type.ADORNED;
 524 
 525             if (atcmd.getMaintainedAdornedTargetFields().length &gt; 0) {
 526                 editable = true;
 527             }
 528 
 529             AdornedTargetList adornedList = (AdornedTargetList) atcmd.getPersistencePerspective()
<abbr title=" 530                     .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);"> 530                     .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLISðŸ”µ</abbr>
 531             sortable = StringUtils.isNotBlank(adornedList.getSortField());
 532             if (sortable) {
 533                 sortProperty = adornedList.getSortField();
 534             }
 535         } else if (fmd instanceof MapMetadata) {
 536             readOnly = !((MapMetadata) fmd).isMutable();
 537             MapMetadata mmd = (MapMetadata) fmd;
 538 
 539             Property p2 = cmd.getPMap().get(&quot;key&quot;);
 540             BasicFieldMetadata keyMd = (BasicFieldMetadata) p2.getMetadata();
 541             keyMd.setFriendlyName(getMapKeyFriendlyName(p2));
 542             Field hf = createHeaderField(p2, keyMd);
 543             headerFields.add(hf);
 544             wrapper.getFields().add(constructFieldDTOFromFieldData(hf, keyMd));
 545 
 546             if (mmd.isSimpleValue()) {
 547                 Property valueProperty = cmd.getPMap().get(&quot;value&quot;);
 548                 BasicFieldMetadata valueMd = (BasicFieldMetadata) valueProperty.getMetadata();
 549                 valueMd.setFriendlyName(&quot;Value&quot;);
 550                 hf = createHeaderField(valueProperty, valueMd);
 551                 headerFields.add(hf);
 552                 wrapper.getFields().add(constructFieldDTOFromFieldData(hf, valueMd));
 553 
 554                 idProperty = &quot;key&quot;;
 555                 hideIdColumn = true;
 556             } else {
 557                 for (Property p : cmd.getProperties()) {
 558                     if (p.getMetadata() instanceof BasicFieldMetadata) {
 559                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 560                         String valueClassName = mmd.getValueClassName();
 561                         if (!StringUtils.isEmpty(mmd.getToOneTargetProperty())) {
 562                             Class&lt;?&gt; clazz;
 563                             try {
 564                                 clazz = Class.forName(mmd.getValueClassName());
 565                             } catch (ClassNotFoundException e) {
 566                                 throw ExceptionHelper.refineException(e);
 567                             }
<abbr title=" 568                             java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTargetProperty());"> 568                             java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.ðŸ”µ</abbr>
 569                             ManyToOne manyToOne = nestedField.getAnnotation(ManyToOne.class);
<abbr title=" 570                             if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getName())) {"> 570                             if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.clasðŸ”µ</abbr>
 571                                 valueClassName = manyToOne.targetEntity().getName();
 572                             } else {
 573                                 OneToOne oneToOne = nestedField.getAnnotation(OneToOne.class);
<abbr title=" 574                                 if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getName())) {"> 574                                 if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.clðŸ”µ</abbr>
 575                                     valueClassName = oneToOne.targetEntity().getName();
 576                                 }
 577                             }
 578                         }
 579                         if (md.getTargetClass().equals(valueClassName)) {
 580                             if (md.isProminent() != null &amp;&amp; md.isProminent()
<abbr title=" 581                                     &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {"> 581                                     &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibilityðŸ”µ</abbr>
 582                                 hf = createHeaderField(p, md);
 583                                 headerFields.add(hf);
 584                                 defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 585 
 586                                 // Is this a media listgrid
 587                                 if (hf.getFieldType().equals(&quot;ASSET_LOOKUP&quot;)) {
 588                                     isMedia = true;
 589                                 }
 590                             }
 591 
 592                             if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 593                                 wrapper.getFields().add(constructFieldDTOFromFieldData(hf,md));
 594                             }
 595                         }
 596                     }
 597                 }
 598             }
 599 
 600             type = ListGrid.Type.MAP;
 601             editable = true;
 602             canFilterAndSort = false;
 603         }
 604 
 605         String ceilingType = &quot;&quot;;
 606         if (fmd instanceof BasicFieldMetadata) {
 607             ceilingType = cmd.getCeilingType();
 608         } else if (fmd instanceof CollectionMetadata) {
 609             ceilingType = ((CollectionMetadata) fmd).getCollectionCeilingEntity();
 610         }
 611 
 612         if (CollectionUtils.isEmpty(headerFields)) {
<abbr title=" 613             String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; and property &#x27;&quot; +"> 613             String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingTypðŸ”µ</abbr>
 614                     StringUtil.sanitize(field.getName()) + &quot;&#x27;.&quot;;
<abbr title=" 615             if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) {"> 615             if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) ðŸ”µ</abbr>
<abbr title=" 616                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 616                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTaðŸ”µ</abbr>
 617             } else if (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM) {
<abbr title=" 618                 message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 618                 message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetðŸ”µ</abbr>
 619             } else if (selectize &amp;&amp; type == ListGrid.Type.BASIC) {
<abbr title=" 620                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuration&quot;;"> 620                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollectioðŸ”µ</abbr>
 621             } else {
 622                 message += &quot; Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 623             }
 624             LOG.error(message);
 625         }
 626 
<abbr title=" 627         ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProperty, sectionCrumbs, sortProperty);"> 627         ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrderðŸ”µ</abbr>
 628         listGrid.setSubCollectionFieldName(field.getName());
 629         listGrid.setFriendlyName(field.getMetadata().getFriendlyName());
 630         if (StringUtils.isEmpty(listGrid.getFriendlyName())) {
 631             listGrid.setFriendlyName(field.getName());
 632         }
 633         listGrid.setContainingEntityId(containingEntityId);
 634         listGrid.setIsReadOnly(readOnly);
 635         listGrid.setHideIdColumn(hideIdColumn);
 636         listGrid.setCanFilterAndSort(canFilterAndSort);
 637 
 638         // Set up the filter builder params
 639         Date c = new Date();
 640         String friendlyName = field.getMetadata().getFriendlyName();
 641         String jsonFriendlyName = friendlyName.replaceAll(&quot; &quot;, &quot;_&quot;);
 642         listGrid.setJsonFieldName(jsonFriendlyName + c.getTime() + &quot;Json&quot;);
 643         listGrid.setFriendlyName(friendlyName);
 644         listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 645         if (CollectionUtils.isEmpty(wrapper.getFields())) {
 646             wrapper.setFields(defaultWrapperFields);
 647         }
 648         listGrid.setFieldWrapper(wrapper);
 649 
 650         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 651         listGrid.setJson(blankJsonString);
 652         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 653         if (dw != null) {
 654             listGrid.setDataWrapper(dw);
 655         }
 656 
 657         if (editable) {
 658             listGrid.getRowActions().add(DefaultListGridActions.UPDATE);
 659         }
 660         if (readOnly) {
 661             listGrid.getRowActions().add(DefaultListGridActions.VIEW);
 662         }
 663         if (sortable) {
 664             listGrid.setCanFilterAndSort(false);
 665             listGrid.setIsSortable(true);
 666         }
 667 
 668         if (modalSingleSelectable) {
 669             if (readOnly) {
<abbr title=" 670                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(true));"> 670                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReðŸ”µ</abbr>
 671             } else {
 672                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 673 
 674             }
 675         }
 676         listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 677 
 678         if (selectize) {
 679             listGrid.setSelectizeUrl(buildSelectizeUrl(listGrid));
 680             listGrid.setSelectType(ListGrid.SelectType.SELECTIZE);
 681         }
 682 
 683         if (modalMultiSelectable) {
 684             listGrid.addModalRowAction(DefaultListGridActions.MULTI_SELECT);
 685             listGrid.setSelectType(ListGrid.SelectType.MULTI_SELECT);
 686         }
 687         listGrid.getRowActions().add(DefaultListGridActions.REMOVE);
 688 
 689         if (fmd.getManualFetch()) {
 690             listGrid.setManualFetch(true);
 691             listGrid.getToolbarActions().add(DefaultListGridActions.MANUAL_FETCH);
 692         }
 693         if (isMedia) {
 694             listGrid.setListGridType(ListGrid.Type.ASSET_GRID);
 695         }
 696 
 697         extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 698 
<abbr title=" 699         //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface"> 699         //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implemðŸ”µ</abbr>
 700         if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title=" 701             EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();"> 701             EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecðŸ”µ</abbr>
<abbr title=" 702             for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {"> 702             for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguratiðŸ”µ</abbr>
 703                 for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
 704                     if (modifier.isQualified(data.getModifierType())) {
 705                         modifier.modifyListGrid(new EntityFormModifierRequest()
 706                                 .withListGrid(listGrid)
 707                                 .withConfiguration(data)
 708                                 .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
 709                                 .withRowLevelSecurityService(rowLevelSecurityService));
 710                     }
 711                 }
 712             }
 713         }
 714         return listGrid;
 715     }
 716 
 717     protected String getMapKeyFriendlyName(Property property) {
 718         String friendlyNameFromMetadata = property.getMetadata().getFriendlyName();
 719 
 720         return (friendlyNameFromMetadata == null) ? &quot;Key&quot; : friendlyNameFromMetadata;
 721     }
 722 
 723     @Override
<abbr title=" 724     public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, Property field,"> 724     public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet dðŸ”µ</abbr>
 725         String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 726             throws ServiceException {
 727         FieldMetadata fmd = field.getMetadata();
 728         // Get the class metadata for this particular field
 729         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 730         if (field != null) {
 731             ppr.setSectionEntityField(field.getName());
 732         }
<abbr title=" 733         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 733         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDaðŸ”µ</abbr>
 734 
 735         Map&lt;String, Object&gt; result = constructSelectizeOptionMap(drs, cmd);
 736 
 737         AdornedTargetList adornedList = ppr.getAdornedList();
 738         if (adornedList != null &amp;&amp; adornedList.getLinkedObjectPath() != null
 739             &amp;&amp; adornedList.getTargetObjectPath() != null &amp;&amp; adornedList.getLinkedIdProperty() != null
 740             &amp;&amp; adornedList.getTargetIdProperty() != null) {
<abbr title=" 741             result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());"> 741             result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkeðŸ”µ</abbr>
 742             result.put(&quot;linkedObjectId&quot;, containingEntityId);
<abbr title=" 743             result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());"> 743             result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargeðŸ”µ</abbr>
 744         }
 745 
 746         return result;
 747     }
 748 
 749     @Override
 750     public Map&lt;String, Object&gt; constructSelectizeOptionMap(DynamicResultSet drs, ClassMetadata cmd) {
 751         Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
 752         List&lt;Map&lt;String, String&gt;&gt; options = new ArrayList&lt;&gt;();
 753 
 754         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 755         for (Property p : cmd.getProperties()) {
 756             if (p.getMetadata() instanceof BasicFieldMetadata) {
 757                 BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 758                 if (md.isProminent() != null &amp;&amp; md.isProminent()
 759                         &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 760                     Field hf = createHeaderField(p, md);
 761                     headerFields.add(hf);
 762                 }
 763             }
 764         }
 765 
 766         for (Entity e : drs.getRecords()) {
 767             Map&lt;String, String&gt; selectizeOption = new HashMap&lt;&gt;();
 768             for (Field headerField : headerFields) {
 769                 Property p = e.findProperty(headerField.getName());
 770                 if (p != null) {
 771                     selectizeOption.put(&quot;name&quot;, p.getValue());
 772                     break;
 773                 }
 774             }
 775             if (e.findProperty(&quot;id&quot;) != null) {
 776                 selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;id&quot;).getValue());
 777             //  &quot;Locale&quot; entity is a special occasion. Because it have not &quot;ID&quot; column with &quot;Long&quot; type
 778             } else if (e.findProperty(&quot;localeCode&quot;) != null) {
 779                 selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;localeCode&quot;).getValue());
 780             }
 781             if (e.findProperty(ALTERNATE_ID_PROPERTY) != null) {
 782                 selectizeOption.put(&quot;alternateId&quot;, e.findProperty(ALTERNATE_ID_PROPERTY).getValue());
 783             }
 784             options.add(selectizeOption);
 785         }
 786         result.put(&quot;options&quot;, options);
 787 
 788         return result;
 789     }
 790 
 791     protected String buildSelectizeUrl(ListGrid listGrid) {
 792         HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 793         String url = request.getContextPath();
<abbr title=" 794         url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + listGrid.getSectionKey();"> 794         url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() :ðŸ”µ</abbr>
 795         url += &quot;/&quot; + listGrid.getContainingEntityId();
 796         url += &quot;/&quot; + listGrid.getSubCollectionFieldName();
 797         return url;
 798     }
 799 
 800     /**
<abbr title=" 801      * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 801      * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, InteðŸ”µ</abbr>
 802      * @param className
 803      * @param headerFields
 804      * @param type
 805      * @param drs
 806      * @param sectionKey
 807      * @param order
 808      * @param idProperty
 809      * @param sectionCrumbs
 810      * @return
 811      */
 812     @Deprecated
<abbr title=" 813     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 813     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynðŸ”µ</abbr>
 814             String sectionKey, int order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs) {
<abbr title=" 815        return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,null);"> 815        return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,nuðŸ”µ</abbr>
 816     }
 817 
 818     /**
 819      * Populate a ListGrid with ListGridRecords.
 820      *
 821      * @param className
 822      * @param headerFields
 823      * @param type
 824      * @param drs
 825      * @param sectionKey
 826      * @param order
 827      * @param idProperty
 828      * @param sectionCrumbs
 829      * @param sortPropery
 830      * @return
 831      */
<abbr title=" 832     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 832     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynðŸ”µ</abbr>
<abbr title=" 833             String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropery) {"> 833             String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, StringðŸ”µ</abbr>
 834         // Create the list grid and set some basic attributes
 835         ListGrid listGrid = new ListGrid();
 836         listGrid.setClassName(className);
 837         listGrid.getHeaderFields().addAll(headerFields);
 838         listGrid.setListGridType(type);
 839         listGrid.setSectionCrumbs(sectionCrumbs);
 840         listGrid.setSectionKey(sectionKey);
 841         listGrid.setOrder(order);
 842         listGrid.setIdProperty(idProperty);
 843         listGrid.setStartIndex(drs.getStartIndex());
 844         listGrid.setTotalRecords(drs.getTotalRecords());
 845         listGrid.setPageSize(drs.getPageSize());
 846 
 847         String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
<abbr title=" 848         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier);"> 848         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdðŸ”µ</abbr>
 849         if (section != null) {
 850             listGrid.setExternalEntitySectionKey(section.getUrl());
 851         }
 852 
 853         // format date list grid cells
 854         SimpleDateFormat formatter = new SimpleDateFormat(&quot;MMM d, y @ hh:mma&quot;);
 855         DateFormatSymbols symbols = new DateFormatSymbols(Locale.getDefault());
 856         symbols.setAmPmStrings(new String[] { &quot;am&quot;, &quot;pm&quot; });
 857         formatter.setDateFormatSymbols(symbols);
 858 
 859         // For each of the entities (rows) in the list grid, we need to build the associated
 860         // ListGridRecord and set the required fields on the record. These fields are the same ones
 861         // that are used for the header fields.
 862         for (Entity e : drs.getRecords()) {
 863             ListGridRecord record = new ListGridRecord();
 864             record.setListGrid(listGrid);
 865             record.setDirty(e.isDirty());
 866             record.setEntity(e);
 867             if (StringUtils.isNotBlank(sortPropery) &amp;&amp; e.findProperty(sortPropery) != null) {
 868                 Property sort = e.findProperty(sortPropery);
 869                 record.setDisplayOrder(sort.getValue());
 870             }
 871             if (e.findProperty(&quot;hasError&quot;) != null) {
 872                 Boolean hasError = Boolean.parseBoolean(e.findProperty(&quot;hasError&quot;).getValue());
 873                 record.setIsError(hasError);
 874                 if (hasError) {
 875                     ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 876                             .getProxy().determineErrorMessageForEntity(e, record);
 877 
 878                     if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 879                         record.setErrorKey(&quot;listgrid.record.error&quot;);
 880                     }
 881                 }
 882             }
 883 
 884             if (e.findProperty(&quot;progressStatus&quot;) != null) {
 885                 ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 886                         .getProxy().determineStatusMessageForEntity(e, record);
 887                 if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 888                     record.setStatus(e.findProperty(&quot;progressStatus&quot;).getValue());
 889                     record.setStatusCssClass(&quot;listgrid.record.status&quot;);
 890                 }
 891             }
 892 
 893             if (e.findProperty(idProperty) != null) {
 894                 record.setId(e.findProperty(idProperty).getValue());
 895             }
 896 
 897             for (Field headerField : headerFields) {
 898                 Property p = e.findProperty(headerField.getName());
 899                 if (p != null) {
 900                     Field recordField = new Field().withName(headerField.getName())
 901                             .withFriendlyName(headerField.getFriendlyName())
 902                             .withOrder(p.getMetadata().getOrder());
 903 
 904                     if (headerField instanceof ComboField) {
 905                         recordField.setValue(((ComboField) headerField).getOption(p.getValue()));
 906                         recordField.setDisplayValue(p.getDisplayValue());
 907                     } else {
 908                         if (headerField.getFieldType().equals(&quot;DATE&quot;)) {
 909                             try {
<abbr title=" 910                                 Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue());"> 910                                 Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue(ðŸ”µ</abbr>
 911                                 String newValue = formatter.format(date);
 912                                 recordField.setValue(newValue);
 913                             } catch (Exception ex) {
 914                                 recordField.setValue(p.getValue());
 915                             }
 916                         } else {
 917                             recordField.setValue(p.getValue());
 918                         }
 919                         recordField.setDisplayValue(p.getDisplayValue());
 920                     }
 921 
 922                     recordField.setDerived(isDerivedField(headerField, recordField, p));
 923 
 924                     record.getFields().add(recordField);
 925                 }
 926             }
 927 
 928             if (e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY) != null) {
 929                 Field hiddenField = new Field().withName(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
<abbr title=" 930                 hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue());"> 930                 hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue()ðŸ”µ</abbr>
 931                 record.getHiddenFields().add(hiddenField);
 932             }
 933 
 934             if (e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY) != null) {
 935                 record.setAltId(e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY).getValue());
 936             }
 937 
 938             extensionManager.getProxy().modifyListGridRecord(className, record, e);
 939 
 940             listGrid.getRecords().add(record);
 941         }
 942 
 943         if (drs.getFirstId() != null) {
 944             listGrid.setFirstId(drs.getFirstId());
 945         }
 946         if (drs.getLastId() != null) {
 947             listGrid.setLastId(drs.getLastId());
 948         }
 949         if (drs.getUpperCount() != null) {
 950             listGrid.setUpperCount(drs.getUpperCount());
 951         }
 952         if (drs.getLowerCount() != null) {
 953             listGrid.setLowerCount(drs.getLowerCount());
 954         }
 955         if (drs.getFetchType() != null) {
 956             listGrid.setFetchType(drs.getFetchType().toString());
 957         }
 958         if (drs.getTotalCountLessThanPageSize() != null) {
 959             listGrid.setTotalCountLessThanPageSize(drs.getTotalCountLessThanPageSize());
 960         }
 961         if (drs.getPromptSearch() != null) {
 962             listGrid.setPromptSearch(drs.getPromptSearch());
 963         }
 964 
 965         return listGrid;
 966     }
 967 
 968     /**
<abbr title=" 969      * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasicFieldMetadata}"> 969      * Determines whether or not a particular field in a record is derived. By default this checks the {@ðŸ”µ</abbr>
 970      * for the given Property to see if something on the backend has marked it as derived
 971      *
 972      * @param headerField the header for this recordField
 973      * @param recordField the recordField being populated
 974      * @param p the property that relates to this recordField
 975      * @return whether or not this field is derived
<abbr title=" 976      * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 976      * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, StringðŸ”µ</abbr>
 977      */
 978     protected Boolean isDerivedField(Field headerField, Field recordField, Property p) {
 979         return BooleanUtils.isTrue(((BasicFieldMetadata) p.getMetadata()).getIsDerived());
 980     }
 981 
 982     protected void setEntityFormFields(ClassMetadata cmd, EntityForm ef, List&lt;Property&gt; properties) {
 983         List&lt;Field&gt; homelessFields = new ArrayList&lt;&gt;();
 984         List&lt;Field&gt; fieldsWithAssociations = new ArrayList&lt;&gt;();
 985 
 986         for (Property property : properties) {
 987             if (property.getMetadata() instanceof BasicFieldMetadata) {
 988                 BasicFieldMetadata fmd = (BasicFieldMetadata) property.getMetadata();
 989 
 990 
 991                 if (!ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
<abbr title=" 992                     // Depending on visibility, field for the particular property is not created on the form"> 992                     // Depending on visibility, field for the particular property is not created on the fðŸ”µ</abbr>
 993                     String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 994 
 995                     // Create the field and set some basic attributes
 996                     Field f;
 997 
 998                     if (fieldType.equals(SupportedFieldType.BROADLEAF_ENUMERATION.toString())
 999                             || fieldType.equals(SupportedFieldType.EXPLICIT_ENUMERATION.toString())
1000                             || fieldType.equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION.toString())
1001                             || fieldType.equals(SupportedFieldType.EMPTY_ENUMERATION.toString())) {
<abbr title="1002                         // We&#x27;re dealing with fields that should render as drop-downs, so set their possible values">1002                         // We&#x27;re dealing with fields that should render as drop-downs, so set their possiðŸ”µ</abbr>
1003                         f = new ComboField();
1004                         ((ComboField) f).setOptions(fmd.getEnumerationValues());
<abbr title="1005                         if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValue()">1005                         if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().boðŸ”µ</abbr>
1006                                 &amp;&amp; ((ComboField) f).getOptions().size() == 0) {
1007                             f.setIsVisible(false);
1008                         }
1009                     } else if (fieldType.equals(SupportedFieldType.CODE.toString())) {
1010                         f = new CodeField();
1011                     } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1012                             || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1013                             || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1014                         // We&#x27;re dealing with rule builders, so we&#x27;ll create those specialized fields
1015                         f = new RuleBuilderField();
1016                         ((RuleBuilderField) f).setJsonFieldName(property.getName() + &quot;Json&quot;);
1017                         ((RuleBuilderField) f).setDataWrapper(new DataWrapper());
1018                         ((RuleBuilderField) f).setFieldBuilder(fmd.getRuleIdentifier());
1019                         ((RuleBuilderField) f).setDisplayType(fmd.getDisplayType().toString());
1020 
1021                         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
1022                         ((RuleBuilderField) f).setJson(blankJsonString);
1023                         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
1024                         if (dw != null) {
1025                             ((RuleBuilderField) f).setDataWrapper(dw);
1026                         }
1027 
1028                         if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())) {
1029                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple&quot;);
1030                         } else if (fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1031                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-with-quantity&quot;);
1032                         } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())) {
1033                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple-time&quot;);
1034                         }
1035                     } else if (LookupType.DROPDOWN.equals(fmd.getLookupType())) {
<abbr title="1036                         // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of in a">1036                         // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instðŸ”µ</abbr>
<abbr title="1037                         // modal, so we&#x27;ll provision the combo field here. Available options will be set as part of a">1037                         // modal, so we&#x27;ll provision the combo field here. Available options will be set ðŸ”µ</abbr>
1038                         // subsequent operation
1039                         f = new ComboField();
1040                     } else if (fieldType.equals(SupportedFieldType.MEDIA.toString())) {
1041                         f = new MediaField();
1042                     } else {
1043                         // Create a default field since there was no specialized handler
1044                         f = new Field();
1045                     }
1046 
1047                     Boolean required = fmd.getRequiredOverride();
1048                     if (required == null) {
1049                         required = fmd.getRequired();
1050                     }
1051 
1052                     Boolean allowNoValueEnum = fmd.getAllowNoValueEnumOption();
1053                     if (allowNoValueEnum != null) {
1054                         f.setAllowNoValueEnumOption(allowNoValueEnum);
1055                     }
1056 
1057                     f.withName(property.getName())
1058                      .withFieldType(fieldType)
1059                      .withFieldComponentRenderer(getFieldComponentRenderer(fmd))
1060                      .withGridFieldComponentRenderer(getGridFieldComponentRenderer(fmd))
1061                      .withOrder(fmd.getOrder())
1062                      .withFriendlyName(fmd.getFriendlyName())
1063                      .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
1064                      .withForeignKeyClass(fmd.getForeignKeyClass())
1065                      .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title="1066                      .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromType())">1066                      .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheriðŸ”µ</abbr>
1067                      .withRequired(required)
1068                      .withReadOnly(fmd.getReadOnly())
1069                      .withTranslatable(fmd.getTranslatable())
<abbr title="1070                      .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDERING))">1070                      .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDðŸ”µ</abbr>
1071                      .withLargeEntry(fmd.isLargeEntry())
1072                      .withHint(fmd.getHint())
1073                      .withTooltip(fmd.getTooltip())
1074                      .withHelp(fmd.getHelpText())
1075                      .withTypeaheadEnabled(fmd.getEnableTypeaheadLookup())
1076                      .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity())
1077                      .withAssociatedFieldName(fmd.getAssociatedFieldName());
1078 
1079                     String defaultValue = fmd.getDefaultValue();
1080                     if (defaultValue != null) {
1081                         defaultValue = extractDefaultValueFromFieldData(fieldType, fmd);
1082                         f.withValue(defaultValue);
1083                     }
1084 
1085                     if (StringUtils.isBlank(f.getFriendlyName())) {
1086                         f.setFriendlyName(f.getName());
1087                     }
1088 
1089                     // If is form hidden, set visible to false
1090                     if (VisibilityEnum.FORM_EXPLICITLY_HIDDEN.equals(fmd.getVisibility())) {
1091                         f.setIsVisible(false);
1092                     }
1093 
1094                     if (VisibilityEnum.VISIBLE_ALL.equals(fmd.getVisibility())) {
1095                         f.setIsVisible(true);
1096                     }
1097 
1098                     // Add the field to the appropriate FieldGroup
1099                     if (fmd.getGroup() == null) {
1100                         homelessFields.add(f);
1101                     } else {
<abbr title="1102                         ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabOrder());">1102                         ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabðŸ”µ</abbr>
1103                     }
1104 
1105                     if (StringUtils.isNotEmpty(fmd.getAssociatedFieldName())) {
1106                         fieldsWithAssociations.add(f);
1107                     }
1108                 }
1109             }
1110         }
1111 
1112         for (Field f : homelessFields) {
1113             ef.addField(cmd, f, null, null, null, null);
1114         }
1115 
1116         for (Field f : fieldsWithAssociations) {
1117             Field associatedField = findAssociatedField(ef, f);
1118             if (associatedField != null) {
1119                 associatedField.setShouldRender(false);
1120                 f.setAssociatedFieldName(associatedField.getName());
1121             } else {
1122                 f.setAssociatedFieldName(null);
1123             }
1124         }
1125     }
1126 
1127     protected String getFieldComponentRenderer(BasicFieldMetadata fmd) {
1128         if (StringUtils.isNotBlank(fmd.getFieldComponentRendererTemplate())) {
1129             return fmd.getFieldComponentRendererTemplate();
1130         }
1131         return fmd.getFieldComponentRenderer()==null?null:fmd.getFieldComponentRenderer().toString();
1132     }
1133 
1134     protected String getGridFieldComponentRenderer(BasicFieldMetadata fmd) {
1135         if (StringUtils.isNotBlank(fmd.getGridFieldComponentRendererTemplate())) {
1136             return fmd.getGridFieldComponentRendererTemplate();
1137         }
<abbr title="1138         return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toString();">1138         return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toStrinðŸ”µ</abbr>
1139     }
1140 
1141     private Field findAssociatedField(EntityForm ef, Field f) {
1142         // Try on the parent object
1143         Field associatedField = ef.findField(f.getAssociatedFieldName());
1144 
1145         if (associatedField == null) {
1146             // Check the field&#x27;s path
1147             String[] fieldPathParts = f.getName().split(&quot;\\.&quot;);
1148             String testPath = &quot;&quot;;
1149 
1150             for (String path : fieldPathParts) {
1151                 testPath += path + &quot;.&quot;;
1152 
1153                 associatedField = ef.findField(testPath + f.getAssociatedFieldName());
1154                 if (associatedField != null) {
1155                     break;
1156                 }
1157             }
1158         }
1159         return associatedField;
1160     }
1161 
1162     /**
1163      * This method gets the {@link AdminSection} for the given foreignKeyClass parameter. If none exists,
1164      * it returns the foreignKeyClass.
1165      *
1166      * @param foreignKeyClass the {@link String} class name
1167      * @return the admin section pathname
1168      */
1169     protected String getAdminSectionPath(String foreignKeyClass) {
1170         if (foreignKeyClass != null) {
<abbr title="1171             AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyClass, null);">1171             AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(fðŸ”µ</abbr>
1172             return foreignKeySection != null ? foreignKeySection.getUrl() : foreignKeyClass;
1173         }
1174         return null;
1175     }
1176 
1177     /**
<abbr title="1178      * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal to">1178      * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} iðŸ”µ</abbr>
1179      *  the processed value of another tab.
1180      *
1181      * For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a another tab where
<abbr title="1182      *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;,">1182      *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=ExamðŸ”µ</abbr>
<abbr title="1183      *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; tabs.">1183      *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; taðŸ”µ</abbr>
1184      */
1185     protected void setEntityFormTabsAndGroups(EntityForm ef, Map&lt;String, TabMetadata&gt; tabMetadataMap) {
1186         if (tabMetadataMap != null) {
1187             Set&lt;String&gt; tabMetadataKeySet = tabMetadataMap.keySet();
1188             for (String tabKey : tabMetadataKeySet) {
1189                 TabMetadata tabMetadata = tabMetadataMap.get(tabKey);
<abbr title="1190                 String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySet);">1190                 String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySeðŸ”µ</abbr>
1191 
1192                 if (foundMatchingTab(unprocessedTabName)) {
1193                     if (!tabExists(ef, unprocessedTabName)) {
1194                         TabMetadata originalTabMetadata = tabMetadataMap.get(unprocessedTabName);
1195                         unprocessedTabName = ef.addTabFromTabMetadata(originalTabMetadata);
1196                     }
1197                 } else {
1198                     if (tabExists(ef, tabKey)) {
1199                         unprocessedTabName = tabKey;
1200                     } else {
1201                         unprocessedTabName = ef.addTabFromTabMetadata(tabMetadata);
1202                     }
1203                 }
1204 
1205                 Set&lt;String&gt; groupMetadataKeySet = tabMetadata.getGroupMetadata().keySet();
1206                 for (String groupKey : groupMetadataKeySet) {
<abbr title="1207                     ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName);">1207                     ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocesseðŸ”µ</abbr>
1208                 }
1209             }
1210         }
1211     }
1212 
1213     /**
1214      * Search for any other tab on the target entity that has the same display value
1215      *  as the value provided tab name.
1216      *
<abbr title="1217      * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message property.">1217      * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message propeðŸ”µ</abbr>
<abbr title="1218      *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySet">1218      *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetaðŸ”µ</abbr>
<abbr title="1219      *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method should return">1219      *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method shoulðŸ”µ</abbr>
1220      *  &quot;Example_Tab&quot; which will end up causing the tabs to merge together.
1221      *
<abbr title="1222      * If a tab with the same display value cannot be found, then we should return null to indicate that there">1222      * If a tab with the same display value cannot be found, then we should return null to indicate that ðŸ”µ</abbr>
1223      *  is no matching tab with the same processed tabName value.
1224      */
<abbr title="1225     protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySet) {">1225     protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySðŸ”µ</abbr>
1226         for (String tabKey : tabMetadataKeySet) {
1227             String tabName = tabMetadata.getTabName();
1228 
1229             if (processedTabKeyMatchesTabName(tabName, tabKey)) {
1230                 return tabKey;
1231             }
1232         }
1233 
1234         return null;
1235     }
1236 
1237     protected boolean processedTabKeyMatchesTabName(String tabName, String candidateTabKey) {
1238         try {
1239             String processedCandidateTabKey = BLCMessageUtils.getMessage(candidateTabKey);
<abbr title="1240             boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateTabKey);">1240             boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateðŸ”µ</abbr>
1241 
<abbr title="1242             return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidateTabKey);">1242             return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidatðŸ”µ</abbr>
1243         } catch (NoSuchMessageException e) {
1244             LOG.debug(&quot;No such message exists for &quot; + candidateTabKey, e);
1245 
1246             return false;
1247         }
1248     }
1249 
1250     protected boolean foundMatchingTab(String unprocessedTabName) {
1251         return (unprocessedTabName != null);
1252     }
1253 
1254     protected boolean tabExists(EntityForm ef, String tabKey) {
1255         return (ef.findTab(tabKey) != null);
1256     }
1257 
1258     @Override
1259     public String extractDefaultValueFromFieldData(String fieldType, BasicFieldMetadata fmd) {
1260         String defaultValue = fmd.getDefaultValue();
1261         if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1262                 || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1263                 || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1264             return null;
1265         } else if (fieldType.equals(SupportedFieldType.INTEGER.toString())) {
1266             try {
1267                 Integer.parseInt(defaultValue);
1268             } catch (NumberFormatException  e) {
<abbr title="1269                 String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defaultValue);">1269                 String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defauðŸ”µ</abbr>
1270                 LOG.debug(msg);
1271                 return null;
1272             }
1273         } else if (fieldType.equals(SupportedFieldType.DECIMAL.toString())
1274                 || fieldType.equals(SupportedFieldType.MONEY.toString())) {
1275             try {
1276                 BigDecimal val = new BigDecimal(defaultValue);
1277             } catch (NumberFormatException  e) {
1278                 String msg = buildMsgForDefValException(fieldType.toString(), fmd, defaultValue);
1279                 LOG.debug(msg);
1280                 return null;
1281             }
1282         } else if (fieldType.equals(SupportedFieldType.BOOLEAN.toString())) {
1283             if (!defaultValue.toLowerCase().equals(&quot;true&quot;) &amp;&amp; !defaultValue.toLowerCase().equals(&quot;false&quot;)
<abbr title="1284                     &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)) {">1284                     &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)ðŸ”µ</abbr>
<abbr title="1285                 String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defaultValue);">1285                 String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defauðŸ”µ</abbr>
1286                 LOG.debug(msg);
1287                 return null;
1288             }
1289         } else if (fieldType.equals(SupportedFieldType.DATE.toString())) {
1290             DateFormat format = FormatUtil.getDateFormat();
1291             if (defaultValue.toLowerCase().contains(&quot;today&quot;)) {
1292                 defaultValue = format.format(new Date());
1293             } else {
1294                 try {
1295                     Date date = format.parse(defaultValue);
1296                     defaultValue = format.format(date);
1297                 } catch (ParseException e) {
<abbr title="1298                     String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue);">1298                     String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaðŸ”µ</abbr>
1299                     LOG.debug(msg);
1300                     return null;
1301                 }
1302             }
1303         }
1304         return defaultValue;
1305     }
1306 
<abbr title="1307     protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue) {">1307     protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue)ðŸ”µ</abbr>
<abbr title="1308         return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - Failed to parse &quot;">1308         return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot;ðŸ”µ</abbr>
<abbr title="1309                 + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue) + &quot; ]&quot;;">1309                 + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue)ðŸ”µ</abbr>
1310     }
1311 
1312     @Override
1313     public void removeNonApplicableFields(ClassMetadata cmd, EntityForm entityForm, String entityType) {
1314         for (Property p : cmd.getProperties()) {
1315             if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entityType)) {
1316                 entityForm.removeField(p.getName());
1317             }
1318         }
1319     }
1320 
1321     @Override
1322     public EntityForm createEntityForm(ClassMetadata cmd, List&lt;SectionCrumb&gt; sectionCrumbs)
1323             throws ServiceException {
1324         EntityForm ef = createStandardEntityForm();
1325         populateEntityForm(cmd, ef, sectionCrumbs);
1326         return ef;
1327     }
1328 
1329     protected String extractSectionIdentifierFromCrumb(List&lt;SectionCrumb&gt; sectionCrumbs) {
1330         if (sectionCrumbs != null &amp;&amp; sectionCrumbs.size() &gt; 0) {
1331             return sectionCrumbs.get(0).getSectionIdentifier();
1332         } else {
1333             return null;
1334         }
1335     }
1336 
1337     @Override
1338     public void populateEntityForm(ClassMetadata cmd, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)
1339             throws ServiceException {
1340         ef.setCeilingEntityClassname(cmd.getCeilingType());
1341 
1342         String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
1343 
<abbr title="1344         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType(),">1344         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType()ðŸ”µ</abbr>
1345                 sectionIdentifier);
1346         if (section != null) {
1347             ef.setSectionKey(section.getUrl());
1348         } else {
1349             ef.setSectionKey(cmd.getCeilingType());
1350         }
1351         ef.setSectionCrumbsImpl(sectionCrumbs);
1352 
1353         setEntityFormTabsAndGroups(ef, cmd.getTabAndGroupMetadata());
1354 
1355         setEntityFormFields(cmd, ef, Arrays.asList(cmd.getProperties()));
1356 
1357         populateDropdownToOneFields(ef, cmd);
1358 
1359         extensionManager.getProxy().modifyUnpopulatedEntityForm(ef);
1360     }
1361 
1362     /**
1363      * This method is invoked when EntityForms are created and is meant to provide a hook to add
1364      * additional entity form actions for implementors of Broadleaf. Broadleaf modules will typically
1365      * leverage {@link FormBuilderExtensionHandler#addAdditionalFormActions(EntityForm)} method.
1366      * @param ef
1367      */
1368     protected void addAdditionalFormActions(EntityForm ef) {
1369 
1370     }
1371 
1372     @Override
<abbr title="1373     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbs)">1373     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbsðŸ”µ</abbr>
1374             throws ServiceException {
1375         EntityForm ef = createStandardEntityForm();
1376         populateEntityForm(cmd, entity, ef, sectionCrumbs);
1377         addAdditionalFormActions(ef);
1378         extensionManager.getProxy().addAdditionalFormActions(ef);
1379         return ef;
1380     }
1381 
1382     @Override
<abbr title="1383     public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1383     public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; seðŸ”µ</abbr>
1384             throws ServiceException {
1385         // Get the empty form with appropriate fields
1386         populateEntityForm(cmd, ef, sectionCrumbs);
1387 
1388         String idProperty = adminEntityService.getIdProperty(cmd);
1389         ef.setId(entity.findProperty(idProperty).getValue());
1390         ef.setEntityType(entity.getType()[0]);
1391 
1392         populateEntityFormFieldValues(cmd, entity, ef);
1393 
1394         Property p = entity.findProperty(BasicPersistenceModule.MAIN_ENTITY_NAME_PROPERTY);
1395         if (p != null) {
1396             ef.setMainEntityName(p.getValue());
1397         }
1398 
1399         extensionManager.getProxy().modifyPopulatedEntityForm(ef, entity);
1400     }
1401 
<abbr title="1402     protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef) {">1402     protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef)ðŸ”µ</abbr>
1403         for (Property p : cmd.getProperties()) {
1404             FieldMetadata fmd = p.getMetadata();
1405 
1406             if (shouldHideField(fmd, entity)) {
1407                 if (fmd instanceof CollectionMetadata) {
1408                     ef.removeListGrid(p.getName());
1409                 } else {
1410                     ef.removeField(p.getName());
1411                 }
1412             }
1413         }
1414     }
1415 
1416     protected boolean shouldHideField(FieldMetadata fmd, Entity entity) {
1417         if (fmd == null || fmd.getShowIfFieldEquals() == null) {
1418             return false;
1419         }
1420 
1421         for (String property : fmd.getShowIfFieldEquals().keySet()) {
1422             List&lt;String&gt; values = fmd.getShowIfFieldEquals().get(property);
1423             Property entityProp = entity.findProperty(property);
1424 
1425             if (entityProp == null || values.contains(entityProp.getValue())) {
1426                 return false;
1427             }
1428         }
1429         return true;
1430     }
1431 
1432     @Override
1433     public void populateEntityFormFieldValues(ClassMetadata cmd, Entity entity, EntityForm ef) {
1434         // Set the appropriate property values
1435         for (Property p : cmd.getProperties()) {
1436             if (p.getMetadata() instanceof BasicFieldMetadata) {
1437                 BasicFieldMetadata basicFM = (BasicFieldMetadata) p.getMetadata();
1438 
1439                 Property entityProp = entity.findProperty(p.getName());
1440 
<abbr title="1441                 boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibility());">1441                 boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibiliðŸ”µ</abbr>
1442                 //always show special map fields
1443                 if (p.getName().equals(&quot;key&quot;) || p.getName().equals(&quot;priorKey&quot;)) {
1444                     explicitlyShown = true;
1445                 }
1446 
1447                 if (entityProp == null &amp;&amp; explicitlyShown) {
1448                     Field field = ef.findField(p.getName());
1449                     if (field != null) {
1450                         field.setValue(null);
1451                     }
<abbr title="1452                 } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1452                 } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getEðŸ”µ</abbr>
1453                     ef.removeField(p.getName());
1454                 } else {
1455                     Field field = ef.findField(p.getName());
1456                     if (field != null) {
1457                         if (entityProp != null) {
<abbr title="1458                             //protect against null - can happen with password confirmation fields (i.e. admin user)">1458                             //protect against null - can happen with password confirmation fields (i.e. aðŸ”µ</abbr>
1459                             field.setDirty(entityProp.getIsDirty());
1460                         }
1461                         if (basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE
1462                                 || basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE_TIME
1463                                 || basicFM.getFieldType()==SupportedFieldType.RULE_WITH_QUANTITY) {
1464                             RuleBuilderField rbf = (RuleBuilderField) field;
1465                             if (entity.getPMap().containsKey(rbf.getJsonFieldName())) {
1466                                 String json = entity.getPMap().get(rbf.getJsonFieldName()).getValue();
1467                                 rbf.setJson(json);
1468                                 DataWrapper dw = convertJsonToDataWrapper(json);
1469                                 if (dw != null) {
1470                                     rbf.setDataWrapper(dw);
1471                                 }
1472                             }
1473                         }
1474                         if (basicFM.getFieldType() == SupportedFieldType.MEDIA) {
1475                             field.setValue(entityProp.getValue());
1476                             field.setDisplayValue(entityProp.getDisplayValue());
1477                             MediaField mf = (MediaField) field;
<abbr title="1478                             Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(), MediaDto.class);">1478                             Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.gðŸ”µ</abbr>
<abbr title="1479                             mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(), type));">1479                             mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodeðŸ”µ</abbr>
<abbr title="1480                         } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1480                         } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldTyðŸ”µ</abbr>
1481                             field.setValue(entityProp.getValue());
1482                             field.setDisplayValue(entityProp.getDisplayValue());
1483                         }
1484                     }
1485                 }
1486             }
1487         }
1488     }
1489 
1490     /**
1491      * When using Thymeleaf, we need to convert the JSON string back to
1492      * a DataWrapper object because Thymeleaf escapes JSON strings.
1493      * Thymeleaf uses it&#x27;s own object de-serializer
1494      * see: https://github.com/thymeleaf/thymeleaf/issues/84
1495      * see: http://forum.thymeleaf.org/Spring-Javascript-and-escaped-JSON-td4024739.html
1496      * @param json
1497      * @return DataWrapper
1498      * @throws IOException
1499      */
1500     protected DataWrapper convertJsonToDataWrapper(String json) {
1501         ObjectMapper mapper = new ObjectMapper();
1502         DataDTODeserializer dtoDeserializer = new DataDTODeserializer();
<abbr title="1503         SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null));">1503         SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, nuðŸ”µ</abbr>
1504         module.addDeserializer(DataDTO.class, dtoDeserializer);
1505         mapper.registerModule(module);
1506         try {
1507             return mapper.readValue(json, DataWrapper.class);
1508         } catch (IOException e) {
1509             throw new RuntimeException(e);
1510         }
1511     }
1512 
1513     protected void populateDropdownToOneFields(EntityForm ef, ClassMetadata cmd)
1514             throws ServiceException {
1515         for (Property p : cmd.getProperties()) {
1516             if (p.getMetadata() instanceof BasicFieldMetadata) {
1517                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
1518                 if (LookupType.DROPDOWN.equals(fmd.getLookupType())
1519                         &amp;&amp; !ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
1520                     // Get the records
1521                     PersistencePackageRequest toOnePpr = PersistencePackageRequest.standard()
1522                             .withCeilingEntityClassname(fmd.getForeignKeyClass());
<abbr title="1523                     Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecords();">1523                     Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecoðŸ”µ</abbr>
1524 
1525                     // Determine the id field
1526                     String idProp = null;
<abbr title="1527                     ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSet().getClassMetaData();">1527                     ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamðŸ”µ</abbr>
1528                     for (Property foreignP : foreignClassMd.getProperties()) {
1529                         if (foreignP.getMetadata() instanceof BasicFieldMetadata) {
1530                             BasicFieldMetadata foreignFmd = (BasicFieldMetadata) foreignP.getMetadata();
1531                             if (SupportedFieldType.ID.equals(foreignFmd.getFieldType())) {
1532                                 idProp = foreignP.getName();
1533                             }
1534                         }
1535                     }
1536 
1537                     if (idProp == null) {
<abbr title="1538                         throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClass());">1538                         throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeigðŸ”µ</abbr>
1539                     }
1540 
1541                     // Determine the display field
1542                     String displayProp = fmd.getLookupDisplayProperty();
1543 
1544                     // Build the options map
1545                     Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
1546                     for (Entity row : rows) {
1547                         Property prop = row.findProperty(displayProp);
1548                         if (prop == null) {
<abbr title="1549                             LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entity [&quot; +">1549                             LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + ðŸ”µ</abbr>
1550                                     ef.getCeilingEntityClassname() + &quot;]&quot;);
1551                         } else {
1552                             String displayValue = prop.getDisplayValue();
1553                             if (StringUtils.isBlank(displayValue)) {
1554                                 displayValue = prop.getValue();
1555                             }
1556                             options.put(row.findProperty(idProp).getValue(), displayValue);
1557                         }
1558                     }
1559 
1560                     // Set the options on the entity field
1561                     ComboField cf = (ComboField) ef.findField(p.getName());
1562                     cf.setOptions(options);
1563                 }
1564             }
1565         }
1566     }
1567 
1568     @Override
<abbr title="1569     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, List&lt;SectionCrumb&gt; sectionCrumbs)">1569     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; coðŸ”µ</abbr>
1570             throws ServiceException {
1571         EntityForm ef = createStandardEntityForm();
1572         populateEntityForm(cmd, entity, collectionRecords, ef, sectionCrumbs);
1573         addAdditionalFormActions(ef);
1574         extensionManager.getProxy().addAdditionalFormActions(ef);
1575         return ef;
1576     }
1577 
1578     @Override
<abbr title="1579     public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1579     public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collecðŸ”µ</abbr>
1580             throws ServiceException {
1581         // Get the form with values for this entity
1582         populateEntityForm(cmd, entity, ef, sectionCrumbs);
1583 
1584         // Attach the sub-collection list grids and specialty UI support
1585         for (Property p : cmd.getProperties()) {
1586             if (p.getMetadata() instanceof BasicFieldMetadata) {
1587                 continue;
1588             }
1589 
1590             if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entity.getType()[0])) {
1591                 continue;
1592             }
1593 
1594             if (collectionRecords != null &amp;&amp; !collectionRecords.isEmpty()) {
1595                 DynamicResultSet subCollectionEntities = collectionRecords.get(p.getName());
1596                 String containingEntityId = entity.getPMap().get(ef.getIdProperty()).getValue();
<abbr title="1597                 ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSectionKey(), sectionCrumbs);">1597                 ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p,ðŸ”µ</abbr>
1598 
1599                 CollectionMetadata md = ((CollectionMetadata) p.getMetadata());
1600                 if (md instanceof BasicCollectionMetadata) {
<abbr title="1601                     PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);">1601                     PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCruðŸ”µ</abbr>
<abbr title="1602                     ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1602                     ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResuðŸ”µ</abbr>
1603                     if (collectionCmd.getPolymorphicEntities().getChildren().length != 0) {
<abbr title="1604                         List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTrees();">1604                         List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedðŸ”µ</abbr>
1605                         ListGridActionGroup actionGroup = new ListGridActionGroup().withName(&quot;Add&quot;);
1606                         for (ClassTree entityType : entityTypes) {
1607                             ListGridAction ADD = new ListGridAction(ListGridAction.ADD)
1608                                     .withButtonClass(AddMethodType.PERSIST_EMPTY==
<abbr title="1609                                             ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-grid-add-empty&quot;:&quot;sub-list-grid-add&quot;)">1609                                             ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-gðŸ”µ</abbr>
1610                                     .withActionTargetEntity(entityType.getFullyQualifiedClassname())
1611                                     .withUrlPostfix(&quot;/add&quot;)
1612                                     .withIconClass(&quot;fa fa-plus&quot;)
<abbr title="1613                                     .withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyName()));">1613                                     .withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyNamðŸ”µ</abbr>
1614                             actionGroup.getListGridActions().add(0, ADD);
1615                         }
1616                         listGrid.addToolbarActionGroup(actionGroup);
1617                     } else {
1618                         listGrid.getToolbarActions().add(0, AddMethodType.PERSIST_EMPTY==
<abbr title="1619                                 ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ADD_EMPTY:DefaultListGridActions.ADD);">1619                                 ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ðŸ”µ</abbr>
1620                     }
1621                 } else {
1622                     listGrid.getToolbarActions().add(0, DefaultListGridActions.ADD);
1623                 }
1624 
1625                 if (subCollectionEntities.getUnselectedTabMetadata().get(md.getTab())!=null) {
1626                     ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), true);
1627                 } else {
1628                     ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), false);
1629                 }
1630             }
1631         }
1632 
1633         if (CollectionUtils.isEmpty(ef.getActions())) {
1634             ef.addAction(DefaultEntityFormActions.SAVE);
1635         }
1636 
1637         addDeleteActionIfAllowed(ef, cmd, entity);
1638         addDuplicateActionIfAllowed(ef, cmd);
1639         setReadOnlyState(ef, cmd, entity);
1640 
1641         // check for fields that should be hidden based on annotations
1642         setVisibilityBasedOnShowIfFieldEquals(cmd, entity, ef);
1643 
1644         extensionManager.getProxy().modifyDetailEntityForm(ef);
1645     }
1646 
1647     /**
<abbr title="1648      * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The user can">1648      * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/bðŸ”µ</abbr>
1649      * delete an entity for the following cases:
1650      * &lt;ol&gt;
<abbr title="1651      *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represented by">1651      *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represenðŸ”µ</abbr>
<abbr title="1652      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;">1652      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/lðŸ”µ</abbr>
1653      *  &lt;li&gt;The user has the security necessary to delete the given &lt;b&gt;entity&lt;/b&gt; according to the
1654      *  {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}&lt;/li&gt;
1655      * &lt;/ol&gt;
1656      *
1657      * @param entityForm the form being generated
1658      * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1659      * @param entity the entity being edited
1660      * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1661      * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1662      * @see {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}
1663      */
1664     protected void addDeleteActionIfAllowed(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1665         if (isDeletionAllowed(entityForm, cmd, entity)) {
1666             entityForm.addAction(DefaultEntityFormActions.DELETE);
1667         }
1668     }
1669 
1670     protected boolean isDeletionAllowed(final EntityForm entityForm, final ClassMetadata cmd,
1671             final Entity entity) {
1672         try {
1673             String securityEntityClassname = getSecurityClassname(entityForm, cmd);
1674             adminRemoteSecurityService
1675                     .securityCheck(securityEntityClassname, EntityOperationType.REMOVE);
1676         } catch (ServiceException e) {
1677             if (e instanceof SecurityServiceException) {
1678                 return false;
1679             }
1680         }
1681 
1682         final AdminUser persistentAdminUser = adminRemoteSecurityService.getPersistentAdminUser();
1683 
1684         return rowLevelSecurityService.canUpdate(persistentAdminUser, entity)
1685                 &amp;&amp; rowLevelSecurityService.canRemove(persistentAdminUser, entity);
1686     }
1687 
1688     protected void addDuplicateActionIfAllowed(final EntityForm entityForm,
1689             final ClassMetadata cmd) {
1690         if (isDuplicationAllowed(entityForm, cmd)) {
1691             entityForm.addAction(DefaultEntityFormActions.DUPLICATE);
1692         }
1693     }
1694 
1695     protected boolean isDuplicationAllowed(final EntityForm entityForm, final ClassMetadata cmd) {
1696         final String securityClassname = getSecurityClassname(entityForm, cmd);
1697 
1698         try {
1699             adminRemoteSecurityService.securityCheck(securityClassname, EntityOperationType.ADD);
1700         } catch (ServiceException e) {
1701             if (e instanceof SecurityServiceException) {
1702                 return false;
1703             }
1704         }
1705 
1706         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(securityClassname);
1707 
1708         return duplicator.validate(entityClass, Long.valueOf(entityForm.getId())) &amp;&amp;
1709                 rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(),
1710                         securityClassname, cmd);
1711     }
1712 
1713     /**
1714      * The given &lt;b&gt;entityForm&lt;/b&gt; is marked as readonly for the following cases:
1715      * &lt;ol&gt;
1716      *  &lt;li&gt;All of the properties from &lt;b&gt;cmd&lt;/b&gt; are readonly&lt;/b&gt;&lt;/li&gt;
<abbr title="1717      *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represented by">1717      *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class namðŸ”µ</abbr>
<abbr title="1718      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;">1718      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/lðŸ”µ</abbr>
<abbr title="1719      *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to the">1719      *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to ðŸ”µ</abbr>
1720      *  {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}&lt;/li&gt;
1721      * &lt;/ol&gt;
1722      *
1723      * @param entityForm the form being generated
1724      * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1725      * @param entity the entity being edited
1726      * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1727      * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1728      * @see {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}
1729      */
1730     protected void setReadOnlyState(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1731         boolean readOnly = true;
1732 
1733         // If all of the fields are read only, we&#x27;ll mark the form as such
1734         for (Property property : cmd.getProperties()) {
1735             FieldMetadata fieldMetadata = property.getMetadata();
1736             if (fieldMetadata instanceof BasicFieldMetadata) {
<abbr title="1737                 readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieldMetadata).getReadOnly();">1737                 readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetaðŸ”µ</abbr>
1738                 if (!readOnly) {
1739                     break;
1740                 }
1741             } else {
1742                 readOnly = ((CollectionMetadata) fieldMetadata).isMutable();
1743                 if (!readOnly) {
1744                     break;
1745                 }
1746             }
1747         }
1748 
1749         if (!readOnly) {
<abbr title="1750             // If the user does not have edit permissions, we will go ahead and make the form read only to prevent confusion">1750             // If the user does not have edit permissions, we will go ahead and make the form read only tðŸ”µ</abbr>
1751             try {
1752                 String securityEntityClassname = getSecurityClassname(entityForm, cmd);
<abbr title="1753                 adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDATE);">1753                 adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDðŸ”µ</abbr>
1754             } catch (ServiceException e) {
1755                 if (e instanceof SecurityServiceException) {
1756                     readOnly = true;
1757                 }
1758             }
1759         }
1760 
<abbr title="1761         // if the normal admin security service has not deemed this readonly and the all of the properties on the entity">1761         // if the normal admin security service has not deemed this readonly and the all of the propertieðŸ”µ</abbr>
1762         // are not readonly, then check the row-level security
1763         if (!readOnly) {
<abbr title="1764             readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1764             readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUsðŸ”µ</abbr>
1765         }
1766 
1767         if (readOnly) {
1768             entityForm.setReadOnly();
<abbr title="1769             //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface">1769             //If someone has replaced RowLevelSecurityService, check here to make sure the replacement imðŸ”µ</abbr>
1770             if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title="1771                 EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();">1771                 EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLeveðŸ”µ</abbr>
<abbr title="1772                 for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {">1772                 for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguðŸ”µ</abbr>
1773                     for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
1774                         if (modifier.isQualified(data.getModifierType())) {
1775                             modifier.modifyEntityForm(new EntityFormModifierRequest()
1776                                     .withEntityForm(entityForm)
1777                                     .withConfiguration(data)
1778                                     .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
1779                                     .withEntity(entity)
1780                                     .withRowLevelSecurityService(rowLevelSecurityService));
1781                         }
1782                     }
1783                 }
1784             }
1785         }
1786     }
1787 
1788     /**
1789      * Obtains the class name suitable for passing along to the {@link SecurityVerifier}
1790      * @param entityForm
1791      * @param cmd
1792      * @return
1793      */
1794     protected String getSecurityClassname(EntityForm entityForm, ClassMetadata cmd) {
1795         String securityEntityClassname = entityForm.getCeilingEntityClassname();
1796 
1797         if (!StringUtils.isEmpty(cmd.getSecurityCeilingType())) {
1798             securityEntityClassname = cmd.getSecurityCeilingType();
1799         } else {
1800             if (entityForm.getDynamicFormInfos() != null) {
1801                 for (DynamicEntityFormInfo info : entityForm.getDynamicFormInfos().values()) {
1802                     if (!StringUtils.isEmpty(info.getSecurityCeilingClassName())) {
1803                         securityEntityClassname = info.getSecurityCeilingClassName();
1804                         break;
1805                     }
1806                 }
1807             }
1808         }
1809 
1810         return securityEntityClassname;
1811     }
1812 
1813     @Override
1814     public void populateEntityFormFields(EntityForm ef, Entity entity) {
1815         populateEntityFormFields(ef, entity, true, true);
1816     }
1817 
1818     @Override
<abbr title="1819     public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean populateId) {">1819     public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean popuðŸ”µ</abbr>
1820         if (populateId) {
1821             ef.setId(entity.findProperty(ef.getIdProperty()).getValue());
1822         }
1823         if (populateType) {
1824             ef.setEntityType(entity.getType()[0]);
1825         }
1826 
1827         for (Entry&lt;String, Field&gt; entry : ef.getFields().entrySet()) {
1828             Property entityProp = entity.findProperty(entry.getKey());
1829             if (entityProp != null) {
1830                 entry.getValue().setValue(entityProp.getValue());
1831                 entry.getValue().setDisplayValue(entityProp.getDisplayValue());
1832             }
1833         }
1834     }
1835 
1836     @Override
<abbr title="1837     public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedList) {">1837     public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedLiðŸ”µ</abbr>
<abbr title="1838         Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());">1838         Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdPropeðŸ”µ</abbr>
1839         Property entityProp = entity.findProperty(ef.getIdProperty());
1840         field.setValue(entityProp.getValue());
1841 
1842         if (StringUtils.isNotBlank(adornedList.getSortField())) {
1843             field = ef.findField(adornedList.getSortField());
1844             entityProp = entity.findProperty(adornedList.getSortField());
1845             if (field != null &amp;&amp; entityProp != null) {
1846                 field.setValue(entityProp.getValue());
1847             }
1848         }
1849     }
1850 
1851     @Override
1852     public void populateMapEntityFormFields(EntityForm ef, Entity entity) {
1853         Field field = ef.findField(&quot;priorKey&quot;);
1854         Property entityProp = entity.findProperty(&quot;key&quot;);
1855         if (field != null &amp;&amp; entityProp != null) {
1856             field.setValue(entityProp.getValue());
1857         }
1858     }
1859 
1860     @Override
<abbr title="1861     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1861     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList aðŸ”µ</abbr>
<abbr title="1862             String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1862             String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdðŸ”µ</abbr>
1863             throws ServiceException {
1864         EntityForm ef = createStandardAdornedEntityForm();
<abbr title="1865         return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAdd);">1865         return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrðŸ”µ</abbr>
1866     }
1867 
1868     @Override
<abbr title="1869     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1869     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList aðŸ”µ</abbr>
<abbr title="1870             String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1870             String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbðŸ”µ</abbr>
1871             throws ServiceException {
1872         ef.setEntityType(adornedList.getAdornedTargetEntityClassname());
1873 
1874         // Get the metadata for this adorned field
1875         PersistencePackageRequest request = PersistencePackageRequest.adorned()
1876                 .withCeilingEntityClassname(adornedMd.getCollectionCeilingEntity())
1877                 .withAdornedList(adornedList)
1878                 .withSectionCrumbs(sectionCrumbs);
1879         request.setAddOperationInspect(isAdd);
<abbr title="1880         ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getClassMetaData();">1880         ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSðŸ”µ</abbr>
1881 
1882         List&lt;Property&gt; entityFormProperties = new ArrayList&lt;&gt;();
1883         if (isViewCollectionItem) {
1884             Collections.addAll(entityFormProperties, collectionMetadata.getProperties());
1885         } else {
1886             // We want our entity form to only render the maintained adorned target fields
1887             for (String targetFieldName : adornedMd.getMaintainedAdornedTargetFields()) {
1888                 Property p = collectionMetadata.getPMap().get(targetFieldName);
<abbr title="1889                 if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExcluded())) {">1889                 if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadatðŸ”µ</abbr>
1890                     ((BasicFieldMetadata) p.getMetadata()).setVisibility(VisibilityEnum.VISIBLE_ALL);
1891                     entityFormProperties.add(p);
1892                 }
1893             }
1894         }
1895 
1896         // Set the maintained fields on the form
1897         setEntityFormFields(collectionMetadata, ef, entityFormProperties);
1898 
1899         // Add these two additional hidden fields that are required for persistence
1900         Field f = new Field()
1901                 .withName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty())
1902                 .withFieldType(SupportedFieldType.HIDDEN.toString())
1903                 .withValue(parentId);
1904         ef.addHiddenField(collectionMetadata, f);
1905 
1906         f = new Field()
1907                 .withName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty())
1908                 .withFieldType(SupportedFieldType.HIDDEN.toString())
1909                 .withIdOverride(&quot;adornedTargetIdProperty&quot;);
1910         ef.addHiddenField(collectionMetadata, f);
1911 
1912         if (StringUtils.isNotBlank(adornedList.getSortField())) {
1913             f = new Field()
1914                     .withName(adornedList.getSortField())
1915                     .withFieldType(SupportedFieldType.HIDDEN.toString());
1916             ef.addHiddenField(collectionMetadata, f);
1917         }
1918 
1919         ef.setParentId(parentId);
1920 
1921         extensionManager.getProxy().addAdditionalAdornedFormActions(ef);
1922 
1923         return ef;
1924     }
1925 
1926 
1927     @Override
<abbr title="1928     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId)">1928     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd,ðŸ”µ</abbr>
1929             throws ServiceException {
1930         EntityForm ef = createStandardEntityForm();
1931         return buildMapForm(mapMd, mapStructure, cmd, parentId, ef);
1932     }
1933 
1934     @Override
<abbr title="1935     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId, EntityForm ef)">1935     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd,ðŸ”µ</abbr>
1936             throws ServiceException {
1937         ForeignKey foreignKey = (ForeignKey) mapMd.getPersistencePerspective()
1938                 .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY);
1939         ef.setEntityType(foreignKey.getForeignKeyClass());
1940 
1941         Field keyField;
1942         if (!mapMd.getForceFreeFormKeys()) {
1943             // We will use a combo field to render the key choices
1944             ComboField temp = new ComboField();
1945             temp.withName(&quot;key&quot;)
1946                     .withFieldType(&quot;combo_field&quot;)
1947                     .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1948             if (mapMd.getKeys() != null) {
1949                 // The keys can be explicitly set in the annotation...
1950                 temp.setOptions(mapMd.getKeys());
1951             } else {
1952                 // Or they could be based on a different entity
1953                 PersistencePackageRequest ppr = PersistencePackageRequest.standard()
1954                         .withCeilingEntityClassname(mapMd.getMapKeyOptionEntityClass());
1955 
1956                 DynamicResultSet drs = adminEntityService.getRecords(ppr).getDynamicResultSet();
1957 
1958                 for (Entity entity : drs.getRecords()) {
<abbr title="1959                     String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getValue();">1959                     String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getVaðŸ”µ</abbr>
<abbr title="1960                     String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getValue();">1960                     String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayFieldðŸ”µ</abbr>
1961                     temp.putOption(keyValue, keyDisplayValue);
1962                 }
1963             }
1964             keyField = temp;
1965         } else {
1966             keyField = new Field().withName(&quot;key&quot;)
1967                                 .withFieldType(SupportedFieldType.STRING.toString())
1968                                 .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1969         }
1970         keyField.setRequired(true);
1971         ef.addMapKeyField(cmd, keyField);
1972 
1973         // Set the fields for this form
1974         List&lt;Property&gt; mapFormProperties;
1975         if (mapMd.isSimpleValue()) {
1976             ef.setIdProperty(&quot;key&quot;);
1977             mapFormProperties = new ArrayList&lt;&gt;();
1978             Property valueProp = cmd.getPMap().get(&quot;value&quot;);
1979             mapFormProperties.add(valueProp);
1980         } else {
1981             String valueClassName = mapStructure.getValueClassName();
1982             List&lt;String&gt; classNames = getValueClassNames(valueClassName);
1983 
1984             mapFormProperties = new ArrayList&lt;&gt;(Arrays.asList(cmd.getProperties()));
1985             filterMapFormProperties(mapFormProperties, classNames);
1986         }
1987 
1988         setEntityFormFields(cmd, ef, mapFormProperties);
1989 
1990         Field f = new Field()
1991                 .withName(&quot;priorKey&quot;)
1992                 .withFieldType(SupportedFieldType.HIDDEN.toString());
1993         ef.addHiddenField(cmd, f);
1994 
1995         ef.setParentId(parentId);
1996 
1997         return ef;
1998     }
1999 
2000     protected List&lt;String&gt; getValueClassNames(String valueClassName) {
2001         PersistenceManager pm = PersistenceManagerFactory.getPersistenceManager(valueClassName);
2002         List&lt;String&gt; classNames = new ArrayList&lt;&gt;();
2003         try {
2004             Class&lt;?&gt;[] mapEntities = pm.getPolymorphicEntities(valueClassName);
2005             for (Class clazz : mapEntities) {
2006                 classNames.add(clazz.getName());
2007             }
2008         } catch (ClassNotFoundException e) {
2009             classNames.add(valueClassName);
2010         }
2011         return classNames;
2012     }
2013 
<abbr title="2014     protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNames) {">2014     protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNameðŸ”µ</abbr>
2015         CollectionUtils.filter(mapFormProperties, new Predicate() {
2016             @Override
2017             public boolean evaluate(Object object) {
2018                 Property p = (Property) object;
2019                 for (String availType : p.getMetadata().getAvailableToTypes()) {
2020                     if (classNames.contains(availType)) {
2021                         return true;
2022                     }
2023                 }
2024                 return false;
2025             }
2026         });
2027     }
2028 
2029     protected EntityForm createStandardEntityForm() {
2030         EntityForm ef = new EntityForm();
2031         ef.addAction(DefaultEntityFormActions.SAVE);
2032         return ef;
2033     }
2034 
2035     protected EntityForm createStandardAdornedEntityForm() {
2036         EntityForm ef = new EntityForm();
2037         ef.addAction(DefaultAdornedEntityFormActions.Add);
2038         return ef;
2039     }
2040 
2041     protected VisibilityEnum[] getGridHiddenVisibilities() {
2042         return FormBuilderServiceImpl.GRID_HIDDEN_VISIBILITIES;
2043     }
2044 
2045     protected VisibilityEnum[] getFormHiddenVisibilities() {
2046         return FormBuilderServiceImpl.FORM_HIDDEN_VISIBILITIES;
2047     }
2048 
2049 }
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.service;
  19 
  20 import com.fasterxml.jackson.core.Version;
  21 import com.fasterxml.jackson.databind.ObjectMapper;
  22 import com.fasterxml.jackson.databind.module.SimpleModule;
  23 import java.io.IOException;
  24 import java.math.BigDecimal;
  25 import java.text.DateFormat;
  26 import java.text.DateFormatSymbols;
  27 import java.text.ParseException;
  28 import java.text.SimpleDateFormat;
  29 import java.util.ArrayList;
  30 import java.util.Arrays;
  31 import java.util.Collections;
  32 import java.util.Date;
  33 import java.util.HashMap;
  34 import java.util.List;
  35 import java.util.Locale;
  36 import java.util.Map.Entry;
  37 import java.util.Map;
  38 import java.util.Set;
  39 import javax.annotation.Resource;
  40 import javax.persistence.ManyToOne;
  41 import javax.persistence.OneToOne;
  42 import javax.servlet.http.HttpServletRequest;
  43 import org.apache.commons.collections.CollectionUtils;
  44 import org.apache.commons.collections.Predicate;
  45 import org.apache.commons.lang.ArrayUtils;
  46 import org.apache.commons.lang.BooleanUtils;
  47 import org.apache.commons.lang3.StringUtils;
  48 import org.apache.commons.logging.Log;
  49 import org.apache.commons.logging.LogFactory;
  50 import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  51 import org.broadleafcommerce.common.exception.ExceptionHelper;
  52 import org.broadleafcommerce.common.exception.SecurityServiceException;
  53 import org.broadleafcommerce.common.exception.ServiceException;
  54 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  55 import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  56 import org.broadleafcommerce.common.i18n.service.TranslationService;
  57 import org.broadleafcommerce.common.locale.service.LocaleService;
  58 import org.broadleafcommerce.common.media.domain.MediaDto;
  59 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  60 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  61 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  62 import org.broadleafcommerce.common.presentation.client.AdornedTargetAddMethodType;
  63 import org.broadleafcommerce.common.presentation.client.LookupType;
  64 import org.broadleafcommerce.common.presentation.client.PersistencePerspectiveItemType;
  65 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  66 import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  67 import org.broadleafcommerce.common.util.BLCMessageUtils;
  68 import org.broadleafcommerce.common.util.FormatUtil;
  69 import org.broadleafcommerce.common.util.StringUtil;
  70 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  71 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  72 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  73 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  74 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  75 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  76 import org.broadleafcommerce.openadmin.dto.ClassTree;
  77 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  78 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  79 import org.broadleafcommerce.openadmin.dto.Entity;
  80 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  81 import org.broadleafcommerce.openadmin.dto.ForeignKey;
  82 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  83 import org.broadleafcommerce.openadmin.dto.MapStructure;
  84 import org.broadleafcommerce.openadmin.dto.Property;
  85 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  86 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  87 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  88 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  89 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  90 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  91 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  92 import org.broadleafcommerce.openadmin.server.security.remote.SecurityVerifier;
  93 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifier;
  94 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierConfiguration;
  95 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierData;
  96 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierDataPoint;
  97 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierRequest;
  98 import org.broadleafcommerce.openadmin.server.security.service.ExceptionAwareRowLevelSecurityProvider;
  99 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
 100 import org.broadleafcommerce.openadmin.server.security.service.navigation.AdminNavigationService;
 101 import org.broadleafcommerce.openadmin.server.service.AdminEntityService;
 102 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManager;
 103 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
 104 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
 105 import org.broadleafcommerce.openadmin.server.service.persistence.module.FieldManager;
 106 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
 107 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
 108 import org.broadleafcommerce.openadmin.web.form.component.ListGridAction;
 109 import org.broadleafcommerce.openadmin.web.form.component.ListGridActionGroup;
 110 import org.broadleafcommerce.openadmin.web.form.component.ListGridRecord;
 111 import org.broadleafcommerce.openadmin.web.form.component.MediaField;
 112 import org.broadleafcommerce.openadmin.web.form.component.RuleBuilderField;
 113 import org.broadleafcommerce.openadmin.web.form.entity.CodeField;
 114 import org.broadleafcommerce.openadmin.web.form.entity.ComboField;
 115 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
 116 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
 117 import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
 118 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
 119 import org.broadleafcommerce.openadmin.web.form.entity.Field;
 120 import org.broadleafcommerce.openadmin.web.rulebuilder.DataDTODeserializer;
 121 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataDTO;
 122 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataWrapper;
 123 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldDTO;
 124 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldWrapper;
 125 import org.codehaus.jettison.json.JSONObject;
 126 import org.springframework.beans.factory.annotation.Value;
 127 import org.springframework.context.MessageSource;
 128 import org.springframework.context.NoSuchMessageException;
 129 import org.springframework.stereotype.Service;
 130 
 131 
 132 /**
 133  * @author Andre Azzolini (apazzolini)
 134  */
 135 @Service(&quot;blFormBuilderService&quot;)
 136 public class FormBuilderServiceImpl implements FormBuilderService {
 137     private static final Log LOG = LogFactory.getLog(FormBuilderServiceImpl.class);
 138 
 139     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 140 
 141     @Resource(name = &quot;blAdminEntityService&quot;)
 142     protected AdminEntityService adminEntityService;
 143 
 144     @Resource (name = &quot;blAdminNavigationService&quot;)
 145     protected AdminNavigationService navigationService;
 146 
 147     @Resource(name = &quot;blFormBuilderExtensionManager&quot;)
 148     protected FormBuilderExtensionManager extensionManager;
 149 
 150     @Resource(name=&quot;blEntityConfiguration&quot;)
 151     protected EntityConfiguration entityConfiguration;
 152 
 153     @Resource(name=&quot;blAdminSecurityRemoteService&quot;)
 154     protected SecurityVerifier adminRemoteSecurityService;
 155 
 156     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 157     protected RowLevelSecurityService rowLevelSecurityService;
 158 
 159     @Resource(name = &quot;blMediaBuilderService&quot;)
 160     protected MediaBuilderService mediaBuilderService;
 161 
 162     @Resource(name = &quot;blListGridErrorMessageExtensionManager&quot;)
 163     protected ListGridErrorMessageExtensionManager listGridErrorExtensionManager;
 164 
 165     @Resource(name = &quot;blAdminNavigationService&quot;)
 166     protected AdminNavigationService adminNavigationService;
 167 
 168     @Resource(name = &quot;blEntityDuplicator&quot;)
 169     protected EntityDuplicator duplicator;
 170 
 171     @Resource(name = &quot;blDynamicEntityDao&quot;)
 172     protected DynamicEntityDao dynamicEntityDao;
 173 
 174     @Resource(name = &quot;blLocaleService&quot;)
 175     protected LocaleService localeService;
 176 
 177     @Resource(name = &quot;blTranslationService&quot;)
 178     protected TranslationService translationService;
 179 
 180     @Value(&quot;${use.translation.search:false}&quot;)
 181     protected boolean useTranslationSearch;
 182 
<abbr title=" 183     protected static final VisibilityEnum[] FORM_HIDDEN_VISIBILITIES = new VisibilityEnum[]{ VisibilityEnum.HIDDEN_ALL, VisibilityEnum.FORM_HIDDEN };"> 183     protected static final VisibilityEnum[] FORM_HIDDEN_VISIBILITIES = new VisibilityEnum[]{ VisibilityEnðŸ”µ</abbr>
 184 
<abbr title=" 185     protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[]{ VisibilityEnum.HIDDEN_ALL, VisibilityEnum.GRID_HIDDEN };"> 185     protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[]{ VisibilityEnðŸ”µ</abbr>
 186 
 187     @Override
<abbr title=" 188     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {"> 188     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SeðŸ”µ</abbr>
 189         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 190         ListGrid.Type type = ListGrid.Type.MAIN;
 191         String idProperty = &quot;id&quot;;
 192         FieldWrapper wrapper = new FieldWrapper();
 193         ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 194         for (Property p : cmd.getProperties()) {
 195             if (p.getMetadata() instanceof BasicFieldMetadata) {
 196                 BasicFieldMetadata fmd = ((BasicFieldMetadata) (p.getMetadata()));
 197                 if (SupportedFieldType.ID.equals(fmd.getFieldType())) {
 198                     idProperty = fmd.getName();
 199                 }
<abbr title=" 200                 if (((fmd.isProminent() != null) &amp;&amp; fmd.isProminent()) &amp;&amp; (!ArrayUtils.contains(getGridHiddenVisibilities(), fmd.getVisibility()))) {"> 200                 if (((fmd.isProminent() != null) &amp;&amp; fmd.isProminent()) &amp;&amp; (!ArrayUtils.contains(getGridHiðŸ”µ</abbr>
 201                     Field hf = createHeaderField(p, fmd);
 202                     headerFields.add(hf);
 203                     defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, fmd));
 204                 }
 205                 if ((fmd.getIsFilter() != null) &amp;&amp; fmd.getIsFilter()) {
<abbr title=" 206                     wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmd));"> 206                     wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmdðŸ”µ</abbr>
 207                 }
 208             }
 209         }
 210         if (useTranslationSearch) {
 211             getTranslationSearchField(cmd.getCeilingType(), defaultWrapperFields);
 212         }
<abbr title=" 213         ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idProperty, sectionCrumbs);"> 213         ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, ðŸ”µ</abbr>
 214         if (CollectionUtils.isNotEmpty(listGrid.getHeaderFields())) {
 215             // Set the first column to be able to link to the main entity
 216             listGrid.getHeaderFields().iterator().next().setMainEntityLink(true);
 217         } else {
<abbr title=" 218             String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType();"> 218             String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeiðŸ”µ</abbr>
 219             message += &quot;Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 220             LOG.error(message);
 221         }
 222         Date c = new Date();
 223         String friendlyName = &quot;listGrid&quot; + c.getTime();
 224         // Set up the filter builder params
 225         listGrid.setJsonFieldName(friendlyName + &quot;Json&quot;);
 226         listGrid.setFriendlyName(friendlyName);
 227         listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 228         if (CollectionUtils.isEmpty(wrapper.getFields())) {
 229             wrapper.setFields(defaultWrapperFields);
 230         }
 231         listGrid.setFieldWrapper(wrapper);
 232         listGrid.setHideFriendlyName(true);
 233         String blankJsonString = &quot;{\&quot;data\&quot;:[]}&quot;;
 234         listGrid.setJson(blankJsonString);
 235         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 236         if (dw != null) {
 237             listGrid.setDataWrapper(dw);
 238         }
 239         listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 240         listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 241         extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 242         return listGrid;
 243     }
 244 
<abbr title=" 245     private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFields) {"> 245     private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFieldsðŸ”µ</abbr>
 246 
 247         TranslatedEntity translatedEntity;
 248 
 249         try {
 250             translatedEntity = translationService.getAssignableEntityType(ceilingEntity);
 251 
 252             FieldDTO localeField = new FieldDTO();
 253             localeField.setId(&quot;translationLocale&quot;);
 254             localeField.setLabel(&quot;Translation locale&quot;);
 255             localeField.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 256             localeField.setInput(&quot;select&quot;);
 257             localeField.setType(&quot;string&quot;);
 258 
<abbr title=" 259             List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocales();"> 259             List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocaleðŸ”µ</abbr>
 260 
 261             Map&lt;String, String&gt; localeMap = new HashMap&lt;String, String&gt;();
 262             for (org.broadleafcommerce.common.locale.domain.Locale l : locales) {
 263                 localeMap.put(l.getLocaleCode(), l.getFriendlyName());
 264             }
 265             localeField.setValues((new JSONObject(localeMap)).toString());
 266 
 267             defaultWrapperFields.add(localeField);
 268         } catch (Exception e) {
 269             translatedEntity = null;
 270         }
 271     }
 272 
 273     protected FieldDTO constructFieldDTOFromFieldData(Field field, BasicFieldMetadata fmd) {
 274         FieldDTO fieldDTO = new FieldDTO();
 275         //translate the label to display
 276         String label = field.getFriendlyName();
 277         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 278         MessageSource messages = context.getMessageSource();
 279         if (messages != null) {
 280             label = messages.getMessage(label, null, label, context.getJavaLocale());
 281         }
 282         fieldDTO.setLabel(label);
 283 
 284         fieldDTO.setId(field.getName());
 285         if (field.getFieldType().equals(&quot;STRING&quot;)) {
 286             fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 287         } else if (field.getFieldType().equals(&quot;DATE&quot;)) {
 288             fieldDTO.setOperators(&quot;blcFilterOperators_Date&quot;);
<abbr title=" 289         } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldType().equals(&quot;DECIMAL&quot;)) {"> 289         } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || fieldðŸ”µ</abbr>
 290             fieldDTO.setOperators(&quot;blcFilterOperators_Numeric&quot;);
 291         } else if (field.getFieldType().equals(&quot;BOOLEAN&quot;)) {
 292             fieldDTO.setOperators(&quot;blcFilterOperators_Boolean&quot;);
 293         } else if (field.getFieldType().equals(&quot;BROADLEAF_ENUMERATION&quot;)) {
 294             fieldDTO.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 295             fieldDTO.setInput(&quot;select&quot;);
 296             fieldDTO.setType(&quot;string&quot;);
 297             String[][] enumerationValues = fmd.getEnumerationValues ();
 298             Map&lt;String, String&gt; enumMap = new HashMap&lt;&gt;();
 299             for (int i = 0; i &lt; enumerationValues.length; i++) {
 300                 enumMap.put(enumerationValues[i][0], enumerationValues[i][1]);
 301             }
 302 
 303             fieldDTO.setValues(new JSONObject(enumMap).toString());
 304         } else if (field.getFieldType().equals(&quot;ADDITIONAL_FOREIGN_KEY&quot;)) {
 305             fieldDTO.setOperators(&quot;blcFilterOperators_Selectize&quot;);
 306             fieldDTO.setType(&quot;string&quot;);
 307 
<abbr title=" 308             AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClass(), null);"> 308             AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeðŸ”µ</abbr>
 309             if (section != null) {
 310                 String sectionKey = section.getUrl().substring(1);
 311                 fieldDTO.setSelectizeSectionKey(sectionKey);
 312             } else {
 313                 fieldDTO.setSelectizeSectionKey(fmd.getForeignKeyClass());
 314             }
 315         } else {
 316             fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 317         }
 318 
 319         return fieldDTO;
 320     }
 321 
 322     protected Field createHeaderField(Property p, BasicFieldMetadata fmd) {
 323         Field hf;
 324         if (fmd.getFieldType().equals(SupportedFieldType.EXPLICIT_ENUMERATION) ||
 325                 fmd.getFieldType().equals(SupportedFieldType.BROADLEAF_ENUMERATION) ||
 326                 fmd.getFieldType().equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION) ||
 327                 fmd.getFieldType().equals(SupportedFieldType.EMPTY_ENUMERATION)) {
 328             hf = new ComboField();
 329             ((ComboField) hf).setOptions(fmd.getEnumerationValues());
 330         } else {
 331             hf = new Field();
 332         }
 333 
 334         hf.withName(p.getName())
<abbr title=" 335           .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getName())"> 335           .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getðŸ”µ</abbr>
 336           .withOrder(fmd.getGridOrder())
 337           .withColumnWidth(fmd.getColumnWidth())
 338           .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
 339           .withForeignKeyClass(fmd.getForeignKeyClass())
 340           .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title=" 341           .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClass())"> 341           .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClassðŸ”µ</abbr>
 342           .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity());
 343         String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 344         hf.setFieldType(fieldType);
 345 
 346         return hf;
 347     }
 348 
 349     @Override
<abbr title=" 350     public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property field,"> 350     public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property fieðŸ”µ</abbr>
 351             String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 352             throws ServiceException {
 353         FieldMetadata fmd = field.getMetadata();
 354         // Get the class metadata for this particular field
 355         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 356         if (field != null) {
 357             ppr.setSectionEntityField(field.getName());
 358         }
<abbr title=" 359         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 359         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDaðŸ”µ</abbr>
 360 
 361         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 362         ListGrid.Type type = null;
 363         boolean editable = false;
 364         boolean sortable = false;
 365         boolean readOnly = false;
 366         boolean hideIdColumn = false;
 367         boolean canFilterAndSort = true;
 368         boolean modalSingleSelectable = false;
 369         boolean modalMultiSelectable = false;
 370         boolean selectize = false;
 371         boolean isMedia = false;
 372         boolean isLookup = false;
 373         String sortProperty = null;
 374         FieldWrapper wrapper = new FieldWrapper();
 375         ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 376 
 377 
 378         String idProperty = &quot;id&quot;;
 379         for (Property property : cmd.getProperties()) {
 380             if (property.getMetadata() instanceof BasicFieldMetadata &amp;&amp;
<abbr title=" 381                     SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;&amp;"> 381                     SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;ðŸ”µ</abbr>
 382                     //make sure it&#x27;s a property for this entity - not an association
 383                     !property.getName().contains(&quot;.&quot;)) {
 384                 idProperty = property.getName();
 385                 break;
 386             }
 387         }
<abbr title=" 388         // Get the header fields for this list grid. Note that the header fields are different depending on the"> 388         // Get the header fields for this list grid. Note that the header fields are different depending ðŸ”µ</abbr>
 389         // kind of field this is.
 390         if (fmd instanceof BasicFieldMetadata) {
 391             readOnly = ((BasicFieldMetadata) fmd).getReadOnly();
 392             modalSingleSelectable = true;
 393             for (Property p : cmd.getProperties()) {
 394                 if (p.getMetadata() instanceof BasicFieldMetadata) {
 395                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 396 
 397                     if (SupportedFieldType.ID.equals(md.getFieldType())) {
 398                         idProperty = md.getName();
 399                     }
 400 
 401                     if (md.isProminent() != null &amp;&amp; md.isProminent()
 402                             &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 403                         Field hf = createHeaderField(p, md);
 404                         headerFields.add(hf);
 405                         defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 406                     }
 407 
 408                     if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 409                         Field f = createHeaderField(p, md);
 410                         wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 411                     }
 412                 }
 413             }
 414 
 415             type = ListGrid.Type.TO_ONE;
 416         } else if (fmd instanceof BasicCollectionMetadata) {
 417             BasicCollectionMetadata bcm = (BasicCollectionMetadata) fmd;
 418             readOnly = !bcm.isMutable();
 419 
 420             if(AddMethodType.LOOKUP.equals(bcm.getAddMethodType())) {
 421                 isLookup = true;
 422             }
 423 
 424             if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 425                 Property p = cmd.getPMap().get(bcm.getSelectizeVisibleField());
 426                 if (p != null) {
 427                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 428 
 429                     Field hf = createHeaderField(p, md);
 430                     headerFields.add(hf);
 431                     wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 432                 }
 433             } else {
 434                 for (Property p : cmd.getProperties()) {
 435                     if (p.getMetadata() instanceof BasicFieldMetadata) {
 436                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 437                         if (md.isProminent() != null &amp;&amp; md.isProminent()
<abbr title=" 438                                 &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {"> 438                                 &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility()))ðŸ”µ</abbr>
 439                             Field hf = createHeaderField(p, md);
 440                             headerFields.add(hf);
 441                             defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 442                         }
 443 
 444                         if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 445                             Field f = createHeaderField(p, md);
 446                             wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 447                         }
 448                     }
 449                 }
 450             }
 451 
 452             type = ListGrid.Type.BASIC;
 453 
<abbr title=" 454             if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getAddMethodType())) {"> 454             if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equalðŸ”µ</abbr>
 455                 editable = true;
 456             } else if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 457                 selectize = true;
 458                 modalSingleSelectable = true;
 459             } else {
 460                 modalSingleSelectable = true;
 461             }
 462             sortable = StringUtils.isNotBlank(bcm.getSortProperty());
 463             if (sortable) {
 464                 sortProperty = bcm.getSortProperty();
 465             }
 466         } else if (fmd instanceof AdornedTargetCollectionMetadata) {
 467             modalSingleSelectable = true;
 468             readOnly = !((AdornedTargetCollectionMetadata) fmd).isMutable();
 469             AdornedTargetCollectionMetadata atcmd = (AdornedTargetCollectionMetadata) fmd;
 470 
 471             if(AdornedTargetAddMethodType.LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 472                 isLookup = true;
 473             }
 474 
<abbr title=" 475             if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {"> 475             if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())ðŸ”µ</abbr>
 476                 selectize = true;
 477 
 478                 Property p = cmd.getPMap().get(atcmd.getSelectizeVisibleField());
 479                 if (p != null) {
 480                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 481 
 482                     Field hf = createHeaderField(p, md);
 483                     headerFields.add(hf);
 484                     wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 485                 }
 486             } else {
 487                 for (String fieldName : atcmd.getGridVisibleFields()) {
 488                     Property p = cmd.getPMap().get(fieldName);
 489                     if (p != null) {
 490                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 491 
 492                         Field hf = createHeaderField(p, md);
 493                         headerFields.add(hf);
 494                         wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 495                     }
 496 
 497                 }
 498             }
 499 
 500             type = ListGrid.Type.ADORNED;
 501 
 502             if (atcmd.getMaintainedAdornedTargetFields().length &gt; 0) {
 503                 editable = true;
 504             }
 505 
 506             AdornedTargetList adornedList = (AdornedTargetList) atcmd.getPersistencePerspective()
<abbr title=" 507                     .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);"> 507                     .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLISðŸ”µ</abbr>
 508             sortable = StringUtils.isNotBlank(adornedList.getSortField());
 509             if (sortable) {
 510                 sortProperty = adornedList.getSortField();
 511             }
 512         } else if (fmd instanceof MapMetadata) {
 513             readOnly = !((MapMetadata) fmd).isMutable();
 514             MapMetadata mmd = (MapMetadata) fmd;
 515 
 516             Property p2 = cmd.getPMap().get(&quot;key&quot;);
 517             BasicFieldMetadata keyMd = (BasicFieldMetadata) p2.getMetadata();
 518             keyMd.setFriendlyName(getMapKeyFriendlyName(p2));
 519             Field hf = createHeaderField(p2, keyMd);
 520             headerFields.add(hf);
 521             wrapper.getFields().add(constructFieldDTOFromFieldData(hf, keyMd));
 522 
 523             if (mmd.isSimpleValue()) {
 524                 Property valueProperty = cmd.getPMap().get(&quot;value&quot;);
 525                 BasicFieldMetadata valueMd = (BasicFieldMetadata) valueProperty.getMetadata();
 526                 valueMd.setFriendlyName(&quot;Value&quot;);
 527                 hf = createHeaderField(valueProperty, valueMd);
 528                 headerFields.add(hf);
 529                 wrapper.getFields().add(constructFieldDTOFromFieldData(hf, valueMd));
 530 
 531                 idProperty = &quot;key&quot;;
 532                 hideIdColumn = true;
 533             } else {
 534                 for (Property p : cmd.getProperties()) {
 535                     if (p.getMetadata() instanceof BasicFieldMetadata) {
 536                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 537                         String valueClassName = mmd.getValueClassName();
 538                         if (!StringUtils.isEmpty(mmd.getToOneTargetProperty())) {
 539                             Class&lt;?&gt; clazz;
 540                             try {
 541                                 clazz = Class.forName(mmd.getValueClassName());
 542                             } catch (ClassNotFoundException e) {
 543                                 throw ExceptionHelper.refineException(e);
 544                             }
<abbr title=" 545                             java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTargetProperty());"> 545                             java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.ðŸ”µ</abbr>
 546                             ManyToOne manyToOne = nestedField.getAnnotation(ManyToOne.class);
<abbr title=" 547                             if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getName())) {"> 547                             if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.clasðŸ”µ</abbr>
 548                                 valueClassName = manyToOne.targetEntity().getName();
 549                             } else {
 550                                 OneToOne oneToOne = nestedField.getAnnotation(OneToOne.class);
<abbr title=" 551                                 if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getName())) {"> 551                                 if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.clðŸ”µ</abbr>
 552                                     valueClassName = oneToOne.targetEntity().getName();
 553                                 }
 554                             }
 555                         }
 556                         if (md.getTargetClass().equals(valueClassName)) {
 557                             if (md.isProminent() != null &amp;&amp; md.isProminent()
<abbr title=" 558                                     &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {"> 558                                     &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibilityðŸ”µ</abbr>
 559                                 hf = createHeaderField(p, md);
 560                                 headerFields.add(hf);
 561                                 defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 562 
 563                                 // Is this a media listgrid
 564                                 if (hf.getFieldType().equals(&quot;ASSET_LOOKUP&quot;)) {
 565                                     isMedia = true;
 566                                 }
 567                             }
 568 
 569                             if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 570                                 wrapper.getFields().add(constructFieldDTOFromFieldData(hf,md));
 571                             }
 572                         }
 573                     }
 574                 }
 575             }
 576 
 577             type = ListGrid.Type.MAP;
 578             editable = true;
 579             canFilterAndSort = false;
 580         }
 581 
 582         String ceilingType = &quot;&quot;;
 583         if (fmd instanceof BasicFieldMetadata) {
 584             ceilingType = cmd.getCeilingType();
 585         } else if (fmd instanceof CollectionMetadata) {
 586             ceilingType = ((CollectionMetadata) fmd).getCollectionCeilingEntity();
 587         }
 588 
 589         if (CollectionUtils.isEmpty(headerFields)) {
<abbr title=" 590             String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; and property &#x27;&quot; +"> 590             String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingTypðŸ”µ</abbr>
 591                     StringUtil.sanitize(field.getName()) + &quot;&#x27;.&quot;;
<abbr title=" 592             if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) {"> 592             if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) ðŸ”µ</abbr>
<abbr title=" 593                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 593                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTaðŸ”µ</abbr>
 594             } else if (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM) {
<abbr title=" 595                 message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 595                 message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetðŸ”µ</abbr>
 596             } else if (selectize &amp;&amp; type == ListGrid.Type.BASIC) {
<abbr title=" 597                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuration&quot;;"> 597                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollectioðŸ”µ</abbr>
 598             } else {
 599                 message += &quot; Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 600             }
 601             LOG.error(message);
 602         }
 603 
<abbr title=" 604         ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProperty, sectionCrumbs, sortProperty);"> 604         ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrderðŸ”µ</abbr>
 605         listGrid.setSubCollectionFieldName(field.getName());
 606         listGrid.setFriendlyName(field.getMetadata().getFriendlyName());
 607         if (StringUtils.isEmpty(listGrid.getFriendlyName())) {
 608             listGrid.setFriendlyName(field.getName());
 609         }
 610         listGrid.setContainingEntityId(containingEntityId);
 611         listGrid.setIsReadOnly(readOnly);
 612         listGrid.setHideIdColumn(hideIdColumn);
 613         listGrid.setCanFilterAndSort(canFilterAndSort);
 614 
 615         // Set up the filter builder params
 616         Date c = new Date();
 617         String friendlyName = field.getMetadata().getFriendlyName();
 618         String jsonFriendlyName = friendlyName.replaceAll(&quot; &quot;, &quot;_&quot;);
 619         listGrid.setJsonFieldName(jsonFriendlyName + c.getTime() + &quot;Json&quot;);
 620         listGrid.setFriendlyName(friendlyName);
 621         listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 622         if (CollectionUtils.isEmpty(wrapper.getFields())) {
 623             wrapper.setFields(defaultWrapperFields);
 624         }
 625         listGrid.setFieldWrapper(wrapper);
 626 
 627         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 628         listGrid.setJson(blankJsonString);
 629         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 630         if (dw != null) {
 631             listGrid.setDataWrapper(dw);
 632         }
 633 
 634         if (editable) {
 635             listGrid.getRowActions().add(DefaultListGridActions.UPDATE);
 636         }
 637         if (readOnly) {
 638             listGrid.getRowActions().add(DefaultListGridActions.VIEW);
 639         }
 640         if (sortable) {
 641             listGrid.setCanFilterAndSort(false);
 642             listGrid.setIsSortable(true);
 643         }
 644 
 645         if (modalSingleSelectable) {
 646             if (readOnly) {
<abbr title=" 647                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(true));"> 647                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReðŸ”µ</abbr>
 648             } else {
 649                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 650 
 651             }
 652         }
 653         listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 654 
 655         if (selectize) {
 656             listGrid.setSelectizeUrl(buildSelectizeUrl(listGrid));
 657             listGrid.setSelectType(ListGrid.SelectType.SELECTIZE);
 658         }
 659 
 660         if (modalMultiSelectable) {
 661             listGrid.addModalRowAction(DefaultListGridActions.MULTI_SELECT);
 662             listGrid.setSelectType(ListGrid.SelectType.MULTI_SELECT);
 663         }
 664         listGrid.getRowActions().add(DefaultListGridActions.REMOVE);
 665 
 666         if (fmd.getManualFetch()) {
 667             listGrid.setManualFetch(true);
 668             listGrid.getToolbarActions().add(DefaultListGridActions.MANUAL_FETCH);
 669         }
 670         if (isMedia) {
 671             listGrid.setListGridType(ListGrid.Type.ASSET_GRID);
 672         }
 673 
 674         extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 675 
<abbr title=" 676         //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface"> 676         //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implemðŸ”µ</abbr>
 677         if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title=" 678             EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();"> 678             EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecðŸ”µ</abbr>
<abbr title=" 679             for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {"> 679             for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguratiðŸ”µ</abbr>
 680                 for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
 681                     if (modifier.isQualified(data.getModifierType())) {
 682                         modifier.modifyListGrid(new EntityFormModifierRequest()
 683                                 .withListGrid(listGrid)
 684                                 .withConfiguration(data)
 685                                 .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
 686                                 .withRowLevelSecurityService(rowLevelSecurityService));
 687                     }
 688                 }
 689             }
 690         }
 691         return listGrid;
 692     }
 693 
 694     protected String getMapKeyFriendlyName(Property property) {
 695         String friendlyNameFromMetadata = property.getMetadata().getFriendlyName();
 696 
 697         return (friendlyNameFromMetadata == null) ? &quot;Key&quot; : friendlyNameFromMetadata;
 698     }
 699 
 700     @Override
<abbr title=" 701     public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, Property field,"> 701     public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet dðŸ”µ</abbr>
 702         String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 703             throws ServiceException {
 704         FieldMetadata fmd = field.getMetadata();
 705         // Get the class metadata for this particular field
 706         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 707         if (field != null) {
 708             ppr.setSectionEntityField(field.getName());
 709         }
<abbr title=" 710         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 710         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDaðŸ”µ</abbr>
 711 
 712         Map&lt;String, Object&gt; result = constructSelectizeOptionMap(drs, cmd);
 713 
 714         AdornedTargetList adornedList = ppr.getAdornedList();
 715         if (adornedList != null &amp;&amp; adornedList.getLinkedObjectPath() != null
 716             &amp;&amp; adornedList.getTargetObjectPath() != null &amp;&amp; adornedList.getLinkedIdProperty() != null
 717             &amp;&amp; adornedList.getTargetIdProperty() != null) {
<abbr title=" 718             result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());"> 718             result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkeðŸ”µ</abbr>
 719             result.put(&quot;linkedObjectId&quot;, containingEntityId);
<abbr title=" 720             result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());"> 720             result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargeðŸ”µ</abbr>
 721         }
 722 
 723         return result;
 724     }
 725 
 726     @Override
 727     public Map&lt;String, Object&gt; constructSelectizeOptionMap(DynamicResultSet drs, ClassMetadata cmd) {
 728         Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
 729         List&lt;Map&lt;String, String&gt;&gt; options = new ArrayList&lt;&gt;();
 730 
 731         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 732         for (Property p : cmd.getProperties()) {
 733             if (p.getMetadata() instanceof BasicFieldMetadata) {
 734                 BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 735                 if (md.isProminent() != null &amp;&amp; md.isProminent()
 736                         &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 737                     Field hf = createHeaderField(p, md);
 738                     headerFields.add(hf);
 739                 }
 740             }
 741         }
 742 
 743         for (Entity e : drs.getRecords()) {
 744             Map&lt;String, String&gt; selectizeOption = new HashMap&lt;&gt;();
 745             for (Field headerField : headerFields) {
 746                 Property p = e.findProperty(headerField.getName());
 747                 if (p != null) {
 748                     selectizeOption.put(&quot;name&quot;, p.getValue());
 749                     break;
 750                 }
 751             }
 752             if (e.findProperty(&quot;id&quot;) != null) {
 753                 selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;id&quot;).getValue());
 754             //  &quot;Locale&quot; entity is a special occasion. Because it have not &quot;ID&quot; column with &quot;Long&quot; type
 755             } else if (e.findProperty(&quot;localeCode&quot;) != null) {
 756                 selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;localeCode&quot;).getValue());
 757             }
 758             if (e.findProperty(ALTERNATE_ID_PROPERTY) != null) {
 759                 selectizeOption.put(&quot;alternateId&quot;, e.findProperty(ALTERNATE_ID_PROPERTY).getValue());
 760             }
 761             options.add(selectizeOption);
 762         }
 763         result.put(&quot;options&quot;, options);
 764 
 765         return result;
 766     }
 767 
 768     protected String buildSelectizeUrl(ListGrid listGrid) {
 769         HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 770         String url = request.getContextPath();
<abbr title=" 771         url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + listGrid.getSectionKey();"> 771         url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() :ðŸ”µ</abbr>
 772         url += &quot;/&quot; + listGrid.getContainingEntityId();
 773         url += &quot;/&quot; + listGrid.getSubCollectionFieldName();
 774         return url;
 775     }
 776 
 777     /**
<abbr title=" 778      * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 778      * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, InteðŸ”µ</abbr>
 779      * @param className
 780      * @param headerFields
 781      * @param type
 782      * @param drs
 783      * @param sectionKey
 784      * @param order
 785      * @param idProperty
 786      * @param sectionCrumbs
 787      * @return
 788      */
 789     @Deprecated
<abbr title=" 790     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 790     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynðŸ”µ</abbr>
 791             String sectionKey, int order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs) {
<abbr title=" 792        return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,null);"> 792        return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,nuðŸ”µ</abbr>
 793     }
 794 
 795     /**
 796      * Populate a ListGrid with ListGridRecords.
 797      *
 798      * @param className
 799      * @param headerFields
 800      * @param type
 801      * @param drs
 802      * @param sectionKey
 803      * @param order
 804      * @param idProperty
 805      * @param sectionCrumbs
 806      * @param sortPropery
 807      * @return
 808      */
<abbr title=" 809     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 809     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynðŸ”µ</abbr>
<abbr title=" 810             String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropery) {"> 810             String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, StringðŸ”µ</abbr>
 811         // Create the list grid and set some basic attributes
 812         ListGrid listGrid = new ListGrid();
 813         listGrid.setClassName(className);
 814         listGrid.getHeaderFields().addAll(headerFields);
 815         listGrid.setListGridType(type);
 816         listGrid.setSectionCrumbs(sectionCrumbs);
 817         listGrid.setSectionKey(sectionKey);
 818         listGrid.setOrder(order);
 819         listGrid.setIdProperty(idProperty);
 820         listGrid.setStartIndex(drs.getStartIndex());
 821         listGrid.setTotalRecords(drs.getTotalRecords());
 822         listGrid.setPageSize(drs.getPageSize());
 823 
 824         String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
<abbr title=" 825         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier);"> 825         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdðŸ”µ</abbr>
 826         if (section != null) {
 827             listGrid.setExternalEntitySectionKey(section.getUrl());
 828         }
 829 
 830         // format date list grid cells
 831         SimpleDateFormat formatter = new SimpleDateFormat(&quot;MMM d, y @ hh:mma&quot;);
 832         DateFormatSymbols symbols = new DateFormatSymbols(Locale.getDefault());
 833         symbols.setAmPmStrings(new String[] { &quot;am&quot;, &quot;pm&quot; });
 834         formatter.setDateFormatSymbols(symbols);
 835 
 836         // For each of the entities (rows) in the list grid, we need to build the associated
 837         // ListGridRecord and set the required fields on the record. These fields are the same ones
 838         // that are used for the header fields.
 839         for (Entity e : drs.getRecords()) {
 840             ListGridRecord record = new ListGridRecord();
 841             record.setListGrid(listGrid);
 842             record.setDirty(e.isDirty());
 843             record.setEntity(e);
 844             if (StringUtils.isNotBlank(sortPropery) &amp;&amp; e.findProperty(sortPropery) != null) {
 845                 Property sort = e.findProperty(sortPropery);
 846                 record.setDisplayOrder(sort.getValue());
 847             }
 848             if (e.findProperty(&quot;hasError&quot;) != null) {
 849                 Boolean hasError = Boolean.parseBoolean(e.findProperty(&quot;hasError&quot;).getValue());
 850                 record.setIsError(hasError);
 851                 if (hasError) {
 852                     ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 853                             .getProxy().determineErrorMessageForEntity(e, record);
 854 
 855                     if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 856                         record.setErrorKey(&quot;listgrid.record.error&quot;);
 857                     }
 858                 }
 859             }
 860 
 861             if (e.findProperty(&quot;progressStatus&quot;) != null) {
 862                 ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 863                         .getProxy().determineStatusMessageForEntity(e, record);
 864                 if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 865                     record.setStatus(e.findProperty(&quot;progressStatus&quot;).getValue());
 866                     record.setStatusCssClass(&quot;listgrid.record.status&quot;);
 867                 }
 868             }
 869 
 870             if (e.findProperty(idProperty) != null) {
 871                 record.setId(e.findProperty(idProperty).getValue());
 872             }
 873 
 874             for (Field headerField : headerFields) {
 875                 Property p = e.findProperty(headerField.getName());
 876                 if (p != null) {
 877                     Field recordField = new Field().withName(headerField.getName())
 878                             .withFriendlyName(headerField.getFriendlyName())
 879                             .withOrder(p.getMetadata().getOrder());
 880 
 881                     if (headerField instanceof ComboField) {
 882                         recordField.setValue(((ComboField) headerField).getOption(p.getValue()));
 883                         recordField.setDisplayValue(p.getDisplayValue());
 884                     } else {
 885                         if (headerField.getFieldType().equals(&quot;DATE&quot;)) {
 886                             try {
<abbr title=" 887                                 Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue());"> 887                                 Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue(ðŸ”µ</abbr>
 888                                 String newValue = formatter.format(date);
 889                                 recordField.setValue(newValue);
 890                             } catch (Exception ex) {
 891                                 recordField.setValue(p.getValue());
 892                             }
 893                         } else {
 894                             recordField.setValue(p.getValue());
 895                         }
 896                         recordField.setDisplayValue(p.getDisplayValue());
 897                     }
 898 
 899                     recordField.setDerived(isDerivedField(headerField, recordField, p));
 900 
 901                     record.getFields().add(recordField);
 902                 }
 903             }
 904 
 905             if (e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY) != null) {
 906                 Field hiddenField = new Field().withName(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
<abbr title=" 907                 hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue());"> 907                 hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue()ðŸ”µ</abbr>
 908                 record.getHiddenFields().add(hiddenField);
 909             }
 910 
 911             if (e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY) != null) {
 912                 record.setAltId(e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY).getValue());
 913             }
 914 
 915             extensionManager.getProxy().modifyListGridRecord(className, record, e);
 916 
 917             listGrid.getRecords().add(record);
 918         }
 919 
 920         if (drs.getFirstId() != null) {
 921             listGrid.setFirstId(drs.getFirstId());
 922         }
 923         if (drs.getLastId() != null) {
 924             listGrid.setLastId(drs.getLastId());
 925         }
 926         if (drs.getUpperCount() != null) {
 927             listGrid.setUpperCount(drs.getUpperCount());
 928         }
 929         if (drs.getLowerCount() != null) {
 930             listGrid.setLowerCount(drs.getLowerCount());
 931         }
 932         if (drs.getFetchType() != null) {
 933             listGrid.setFetchType(drs.getFetchType().toString());
 934         }
 935         if (drs.getTotalCountLessThanPageSize() != null) {
 936             listGrid.setTotalCountLessThanPageSize(drs.getTotalCountLessThanPageSize());
 937         }
 938         if (drs.getPromptSearch() != null) {
 939             listGrid.setPromptSearch(drs.getPromptSearch());
 940         }
 941 
 942         return listGrid;
 943     }
 944 
 945     /**
<abbr title=" 946      * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasicFieldMetadata}"> 946      * Determines whether or not a particular field in a record is derived. By default this checks the {@ðŸ”µ</abbr>
 947      * for the given Property to see if something on the backend has marked it as derived
 948      *
 949      * @param headerField the header for this recordField
 950      * @param recordField the recordField being populated
 951      * @param p the property that relates to this recordField
 952      * @return whether or not this field is derived
<abbr title=" 953      * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 953      * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, StringðŸ”µ</abbr>
 954      */
 955     protected Boolean isDerivedField(Field headerField, Field recordField, Property p) {
 956         return BooleanUtils.isTrue(((BasicFieldMetadata) p.getMetadata()).getIsDerived());
 957     }
 958 
 959     protected void setEntityFormFields(ClassMetadata cmd, EntityForm ef, List&lt;Property&gt; properties) {
 960         List&lt;Field&gt; homelessFields = new ArrayList&lt;&gt;();
 961         List&lt;Field&gt; fieldsWithAssociations = new ArrayList&lt;&gt;();
 962 
 963         for (Property property : properties) {
 964             if (property.getMetadata() instanceof BasicFieldMetadata) {
 965                 BasicFieldMetadata fmd = (BasicFieldMetadata) property.getMetadata();
 966 
 967 
 968                 if (!ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
<abbr title=" 969                     // Depending on visibility, field for the particular property is not created on the form"> 969                     // Depending on visibility, field for the particular property is not created on the fðŸ”µ</abbr>
 970                     String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 971 
 972                     // Create the field and set some basic attributes
 973                     Field f;
 974 
 975                     if (fieldType.equals(SupportedFieldType.BROADLEAF_ENUMERATION.toString())
 976                             || fieldType.equals(SupportedFieldType.EXPLICIT_ENUMERATION.toString())
 977                             || fieldType.equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION.toString())
 978                             || fieldType.equals(SupportedFieldType.EMPTY_ENUMERATION.toString())) {
<abbr title=" 979                         // We&#x27;re dealing with fields that should render as drop-downs, so set their possible values"> 979                         // We&#x27;re dealing with fields that should render as drop-downs, so set their possiðŸ”µ</abbr>
 980                         f = new ComboField();
 981                         ((ComboField) f).setOptions(fmd.getEnumerationValues());
<abbr title=" 982                         if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValue()"> 982                         if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().boðŸ”µ</abbr>
 983                                 &amp;&amp; ((ComboField) f).getOptions().size() == 0) {
 984                             f.setIsVisible(false);
 985                         }
 986                     } else if (fieldType.equals(SupportedFieldType.CODE.toString())) {
 987                         f = new CodeField();
 988                     } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
 989                             || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
 990                             || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
 991                         // We&#x27;re dealing with rule builders, so we&#x27;ll create those specialized fields
 992                         f = new RuleBuilderField();
 993                         ((RuleBuilderField) f).setJsonFieldName(property.getName() + &quot;Json&quot;);
 994                         ((RuleBuilderField) f).setDataWrapper(new DataWrapper());
 995                         ((RuleBuilderField) f).setFieldBuilder(fmd.getRuleIdentifier());
 996                         ((RuleBuilderField) f).setDisplayType(fmd.getDisplayType().toString());
 997 
 998                         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 999                         ((RuleBuilderField) f).setJson(blankJsonString);
1000                         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
1001                         if (dw != null) {
1002                             ((RuleBuilderField) f).setDataWrapper(dw);
1003                         }
1004 
1005                         if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())) {
1006                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple&quot;);
1007                         } else if (fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1008                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-with-quantity&quot;);
1009                         } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())) {
1010                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple-time&quot;);
1011                         }
1012                     } else if (LookupType.DROPDOWN.equals(fmd.getLookupType())) {
<abbr title="1013                         // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of in a">1013                         // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instðŸ”µ</abbr>
<abbr title="1014                         // modal, so we&#x27;ll provision the combo field here. Available options will be set as part of a">1014                         // modal, so we&#x27;ll provision the combo field here. Available options will be set ðŸ”µ</abbr>
1015                         // subsequent operation
1016                         f = new ComboField();
1017                     } else if (fieldType.equals(SupportedFieldType.MEDIA.toString())) {
1018                         f = new MediaField();
1019                     } else {
1020                         // Create a default field since there was no specialized handler
1021                         f = new Field();
1022                     }
1023 
1024                     Boolean required = fmd.getRequiredOverride();
1025                     if (required == null) {
1026                         required = fmd.getRequired();
1027                     }
1028 
1029                     Boolean allowNoValueEnum = fmd.getAllowNoValueEnumOption();
1030                     if (allowNoValueEnum != null) {
1031                         f.setAllowNoValueEnumOption(allowNoValueEnum);
1032                     }
1033 
1034                     f.withName(property.getName())
1035                      .withFieldType(fieldType)
1036                      .withFieldComponentRenderer(getFieldComponentRenderer(fmd))
1037                      .withGridFieldComponentRenderer(getGridFieldComponentRenderer(fmd))
1038                      .withOrder(fmd.getOrder())
1039                      .withFriendlyName(fmd.getFriendlyName())
1040                      .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
1041                      .withForeignKeyClass(fmd.getForeignKeyClass())
1042                      .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title="1043                      .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromType())">1043                      .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheriðŸ”µ</abbr>
1044                      .withRequired(required)
1045                      .withReadOnly(fmd.getReadOnly())
1046                      .withTranslatable(fmd.getTranslatable())
<abbr title="1047                      .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDERING))">1047                      .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDðŸ”µ</abbr>
1048                      .withLargeEntry(fmd.isLargeEntry())
1049                      .withHint(fmd.getHint())
1050                      .withTooltip(fmd.getTooltip())
1051                      .withHelp(fmd.getHelpText())
1052                      .withTypeaheadEnabled(fmd.getEnableTypeaheadLookup())
1053                      .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity())
1054                      .withAssociatedFieldName(fmd.getAssociatedFieldName());
1055 
1056                     String defaultValue = fmd.getDefaultValue();
1057                     if (defaultValue != null) {
1058                         defaultValue = extractDefaultValueFromFieldData(fieldType, fmd);
1059                         f.withValue(defaultValue);
1060                     }
1061 
1062                     if (StringUtils.isBlank(f.getFriendlyName())) {
1063                         f.setFriendlyName(f.getName());
1064                     }
1065 
1066                     // If is form hidden, set visible to false
1067                     if (VisibilityEnum.FORM_EXPLICITLY_HIDDEN.equals(fmd.getVisibility())) {
1068                         f.setIsVisible(false);
1069                     }
1070 
1071                     if (VisibilityEnum.VISIBLE_ALL.equals(fmd.getVisibility())) {
1072                         f.setIsVisible(true);
1073                     }
1074 
1075                     // Add the field to the appropriate FieldGroup
1076                     if (fmd.getGroup() == null) {
1077                         homelessFields.add(f);
1078                     } else {
<abbr title="1079                         ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabOrder());">1079                         ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabðŸ”µ</abbr>
1080                     }
1081 
1082                     if (StringUtils.isNotEmpty(fmd.getAssociatedFieldName())) {
1083                         fieldsWithAssociations.add(f);
1084                     }
1085                 }
1086             }
1087         }
1088 
1089         for (Field f : homelessFields) {
1090             ef.addField(cmd, f, null, null, null, null);
1091         }
1092 
1093         for (Field f : fieldsWithAssociations) {
1094             Field associatedField = findAssociatedField(ef, f);
1095             if (associatedField != null) {
1096                 associatedField.setShouldRender(false);
1097                 f.setAssociatedFieldName(associatedField.getName());
1098             } else {
1099                 f.setAssociatedFieldName(null);
1100             }
1101         }
1102     }
1103 
1104     protected String getFieldComponentRenderer(BasicFieldMetadata fmd) {
1105         if (StringUtils.isNotBlank(fmd.getFieldComponentRendererTemplate())) {
1106             return fmd.getFieldComponentRendererTemplate();
1107         }
1108         return fmd.getFieldComponentRenderer()==null?null:fmd.getFieldComponentRenderer().toString();
1109     }
1110 
1111     protected String getGridFieldComponentRenderer(BasicFieldMetadata fmd) {
1112         if (StringUtils.isNotBlank(fmd.getGridFieldComponentRendererTemplate())) {
1113             return fmd.getGridFieldComponentRendererTemplate();
1114         }
<abbr title="1115         return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toString();">1115         return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toStrinðŸ”µ</abbr>
1116     }
1117 
1118     private Field findAssociatedField(EntityForm ef, Field f) {
1119         // Try on the parent object
1120         Field associatedField = ef.findField(f.getAssociatedFieldName());
1121 
1122         if (associatedField == null) {
1123             // Check the field&#x27;s path
1124             String[] fieldPathParts = f.getName().split(&quot;\\.&quot;);
1125             String testPath = &quot;&quot;;
1126 
1127             for (String path : fieldPathParts) {
1128                 testPath += path + &quot;.&quot;;
1129 
1130                 associatedField = ef.findField(testPath + f.getAssociatedFieldName());
1131                 if (associatedField != null) {
1132                     break;
1133                 }
1134             }
1135         }
1136         return associatedField;
1137     }
1138 
1139     /**
1140      * This method gets the {@link AdminSection} for the given foreignKeyClass parameter. If none exists,
1141      * it returns the foreignKeyClass.
1142      *
1143      * @param foreignKeyClass the {@link String} class name
1144      * @return the admin section pathname
1145      */
1146     protected String getAdminSectionPath(String foreignKeyClass) {
1147         if (foreignKeyClass != null) {
<abbr title="1148             AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyClass, null);">1148             AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(fðŸ”µ</abbr>
1149             return foreignKeySection != null ? foreignKeySection.getUrl() : foreignKeyClass;
1150         }
1151         return null;
1152     }
1153 
1154     /**
<abbr title="1155      * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal to">1155      * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} iðŸ”µ</abbr>
1156      *  the processed value of another tab.
1157      *
1158      * For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a another tab where
<abbr title="1159      *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;,">1159      *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=ExamðŸ”µ</abbr>
<abbr title="1160      *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; tabs.">1160      *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; taðŸ”µ</abbr>
1161      */
1162     protected void setEntityFormTabsAndGroups(EntityForm ef, Map&lt;String, TabMetadata&gt; tabMetadataMap) {
1163         if (tabMetadataMap != null) {
1164             Set&lt;String&gt; tabMetadataKeySet = tabMetadataMap.keySet();
1165             for (String tabKey : tabMetadataKeySet) {
1166                 TabMetadata tabMetadata = tabMetadataMap.get(tabKey);
<abbr title="1167                 String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySet);">1167                 String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySeðŸ”µ</abbr>
1168 
1169                 if (foundMatchingTab(unprocessedTabName)) {
1170                     if (!tabExists(ef, unprocessedTabName)) {
1171                         TabMetadata originalTabMetadata = tabMetadataMap.get(unprocessedTabName);
1172                         unprocessedTabName = ef.addTabFromTabMetadata(originalTabMetadata);
1173                     }
1174                 } else {
1175                     if (tabExists(ef, tabKey)) {
1176                         unprocessedTabName = tabKey;
1177                     } else {
1178                         unprocessedTabName = ef.addTabFromTabMetadata(tabMetadata);
1179                     }
1180                 }
1181 
1182                 Set&lt;String&gt; groupMetadataKeySet = tabMetadata.getGroupMetadata().keySet();
1183                 for (String groupKey : groupMetadataKeySet) {
<abbr title="1184                     ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName);">1184                     ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocesseðŸ”µ</abbr>
1185                 }
1186             }
1187         }
1188     }
1189 
1190     /**
1191      * Search for any other tab on the target entity that has the same display value
1192      *  as the value provided tab name.
1193      *
<abbr title="1194      * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message property.">1194      * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message propeðŸ”µ</abbr>
<abbr title="1195      *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySet">1195      *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetaðŸ”µ</abbr>
<abbr title="1196      *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method should return">1196      *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method shoulðŸ”µ</abbr>
1197      *  &quot;Example_Tab&quot; which will end up causing the tabs to merge together.
1198      *
<abbr title="1199      * If a tab with the same display value cannot be found, then we should return null to indicate that there">1199      * If a tab with the same display value cannot be found, then we should return null to indicate that ðŸ”µ</abbr>
1200      *  is no matching tab with the same processed tabName value.
1201      */
<abbr title="1202     protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySet) {">1202     protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySðŸ”µ</abbr>
1203         for (String tabKey : tabMetadataKeySet) {
1204             String tabName = tabMetadata.getTabName();
1205 
1206             if (processedTabKeyMatchesTabName(tabName, tabKey)) {
1207                 return tabKey;
1208             }
1209         }
1210 
1211         return null;
1212     }
1213 
1214     protected boolean processedTabKeyMatchesTabName(String tabName, String candidateTabKey) {
1215         try {
1216             String processedCandidateTabKey = BLCMessageUtils.getMessage(candidateTabKey);
<abbr title="1217             boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateTabKey);">1217             boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateðŸ”µ</abbr>
1218 
<abbr title="1219             return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidateTabKey);">1219             return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidatðŸ”µ</abbr>
1220         } catch (NoSuchMessageException e) {
1221             LOG.debug(&quot;No such message exists for &quot; + candidateTabKey, e);
1222 
1223             return false;
1224         }
1225     }
1226 
1227     protected boolean foundMatchingTab(String unprocessedTabName) {
1228         return (unprocessedTabName != null);
1229     }
1230 
1231     protected boolean tabExists(EntityForm ef, String tabKey) {
1232         return (ef.findTab(tabKey) != null);
1233     }
1234 
1235     @Override
1236     public String extractDefaultValueFromFieldData(String fieldType, BasicFieldMetadata fmd) {
1237         String defaultValue = fmd.getDefaultValue();
1238         if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1239                 || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1240                 || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1241             return null;
1242         } else if (fieldType.equals(SupportedFieldType.INTEGER.toString())) {
1243             try {
1244                 Integer.parseInt(defaultValue);
1245             } catch (NumberFormatException  e) {
<abbr title="1246                 String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defaultValue);">1246                 String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defauðŸ”µ</abbr>
1247                 LOG.debug(msg);
1248                 return null;
1249             }
1250         } else if (fieldType.equals(SupportedFieldType.DECIMAL.toString())
1251                 || fieldType.equals(SupportedFieldType.MONEY.toString())) {
1252             try {
1253                 BigDecimal val = new BigDecimal(defaultValue);
1254             } catch (NumberFormatException  e) {
1255                 String msg = buildMsgForDefValException(fieldType.toString(), fmd, defaultValue);
1256                 LOG.debug(msg);
1257                 return null;
1258             }
1259         } else if (fieldType.equals(SupportedFieldType.BOOLEAN.toString())) {
1260             if (!defaultValue.toLowerCase().equals(&quot;true&quot;) &amp;&amp; !defaultValue.toLowerCase().equals(&quot;false&quot;)
<abbr title="1261                     &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)) {">1261                     &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)ðŸ”µ</abbr>
<abbr title="1262                 String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defaultValue);">1262                 String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defauðŸ”µ</abbr>
1263                 LOG.debug(msg);
1264                 return null;
1265             }
1266         } else if (fieldType.equals(SupportedFieldType.DATE.toString())) {
1267             DateFormat format = FormatUtil.getDateFormat();
1268             if (defaultValue.toLowerCase().contains(&quot;today&quot;)) {
1269                 defaultValue = format.format(new Date());
1270             } else {
1271                 try {
1272                     Date date = format.parse(defaultValue);
1273                     defaultValue = format.format(date);
1274                 } catch (ParseException e) {
<abbr title="1275                     String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue);">1275                     String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaðŸ”µ</abbr>
1276                     LOG.debug(msg);
1277                     return null;
1278                 }
1279             }
1280         }
1281         return defaultValue;
1282     }
1283 
<abbr title="1284     protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue) {">1284     protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue)ðŸ”µ</abbr>
<abbr title="1285         return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - Failed to parse &quot;">1285         return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot;ðŸ”µ</abbr>
<abbr title="1286                 + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue) + &quot; ]&quot;;">1286                 + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue)ðŸ”µ</abbr>
1287     }
1288 
1289     @Override
1290     public void removeNonApplicableFields(ClassMetadata cmd, EntityForm entityForm, String entityType) {
1291         for (Property p : cmd.getProperties()) {
1292             if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entityType)) {
1293                 entityForm.removeField(p.getName());
1294             }
1295         }
1296     }
1297 
1298     @Override
1299     public EntityForm createEntityForm(ClassMetadata cmd, List&lt;SectionCrumb&gt; sectionCrumbs)
1300             throws ServiceException {
1301         EntityForm ef = createStandardEntityForm();
1302         populateEntityForm(cmd, ef, sectionCrumbs);
1303         return ef;
1304     }
1305 
1306     protected String extractSectionIdentifierFromCrumb(List&lt;SectionCrumb&gt; sectionCrumbs) {
1307         if (sectionCrumbs != null &amp;&amp; sectionCrumbs.size() &gt; 0) {
1308             return sectionCrumbs.get(0).getSectionIdentifier();
1309         } else {
1310             return null;
1311         }
1312     }
1313 
1314     @Override
1315     public void populateEntityForm(ClassMetadata cmd, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)
1316             throws ServiceException {
1317         ef.setCeilingEntityClassname(cmd.getCeilingType());
1318 
1319         String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
1320 
<abbr title="1321         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType(),">1321         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType()ðŸ”µ</abbr>
1322                 sectionIdentifier);
1323         if (section != null) {
1324             ef.setSectionKey(section.getUrl());
1325         } else {
1326             ef.setSectionKey(cmd.getCeilingType());
1327         }
1328         ef.setSectionCrumbsImpl(sectionCrumbs);
1329 
1330         setEntityFormTabsAndGroups(ef, cmd.getTabAndGroupMetadata());
1331 
1332         setEntityFormFields(cmd, ef, Arrays.asList(cmd.getProperties()));
1333 
1334         populateDropdownToOneFields(ef, cmd);
1335 
1336         extensionManager.getProxy().modifyUnpopulatedEntityForm(ef);
1337     }
1338 
1339     /**
1340      * This method is invoked when EntityForms are created and is meant to provide a hook to add
1341      * additional entity form actions for implementors of Broadleaf. Broadleaf modules will typically
1342      * leverage {@link FormBuilderExtensionHandler#addAdditionalFormActions(EntityForm)} method.
1343      * @param ef
1344      */
1345     protected void addAdditionalFormActions(EntityForm ef) {
1346 
1347     }
1348 
1349     @Override
<abbr title="1350     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbs)">1350     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbsðŸ”µ</abbr>
1351             throws ServiceException {
1352         EntityForm ef = createStandardEntityForm();
1353         populateEntityForm(cmd, entity, ef, sectionCrumbs);
1354         addAdditionalFormActions(ef);
1355         extensionManager.getProxy().addAdditionalFormActions(ef);
1356         return ef;
1357     }
1358 
1359     @Override
<abbr title="1360     public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1360     public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; seðŸ”µ</abbr>
1361             throws ServiceException {
1362         // Get the empty form with appropriate fields
1363         populateEntityForm(cmd, ef, sectionCrumbs);
1364 
1365         String idProperty = adminEntityService.getIdProperty(cmd);
1366         ef.setId(entity.findProperty(idProperty).getValue());
1367         ef.setEntityType(entity.getType()[0]);
1368 
1369         populateEntityFormFieldValues(cmd, entity, ef);
1370 
1371         Property p = entity.findProperty(BasicPersistenceModule.MAIN_ENTITY_NAME_PROPERTY);
1372         if (p != null) {
1373             ef.setMainEntityName(p.getValue());
1374         }
1375 
1376         extensionManager.getProxy().modifyPopulatedEntityForm(ef, entity);
1377     }
1378 
<abbr title="1379     protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef) {">1379     protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef)ðŸ”µ</abbr>
1380         for (Property p : cmd.getProperties()) {
1381             FieldMetadata fmd = p.getMetadata();
1382 
1383             if (shouldHideField(fmd, entity)) {
1384                 if (fmd instanceof CollectionMetadata) {
1385                     ef.removeListGrid(p.getName());
1386                 } else {
1387                     ef.removeField(p.getName());
1388                 }
1389             }
1390         }
1391     }
1392 
1393     protected boolean shouldHideField(FieldMetadata fmd, Entity entity) {
1394         if (fmd == null || fmd.getShowIfFieldEquals() == null) {
1395             return false;
1396         }
1397 
1398         for (String property : fmd.getShowIfFieldEquals().keySet()) {
1399             List&lt;String&gt; values = fmd.getShowIfFieldEquals().get(property);
1400             Property entityProp = entity.findProperty(property);
1401 
1402             if (entityProp == null || values.contains(entityProp.getValue())) {
1403                 return false;
1404             }
1405         }
1406         return true;
1407     }
1408 
1409     @Override
1410     public void populateEntityFormFieldValues(ClassMetadata cmd, Entity entity, EntityForm ef) {
1411         // Set the appropriate property values
1412         for (Property p : cmd.getProperties()) {
1413             if (p.getMetadata() instanceof BasicFieldMetadata) {
1414                 BasicFieldMetadata basicFM = (BasicFieldMetadata) p.getMetadata();
1415 
1416                 Property entityProp = entity.findProperty(p.getName());
1417 
<abbr title="1418                 boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibility());">1418                 boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibiliðŸ”µ</abbr>
1419                 //always show special map fields
1420                 if (p.getName().equals(&quot;key&quot;) || p.getName().equals(&quot;priorKey&quot;)) {
1421                     explicitlyShown = true;
1422                 }
1423 
1424                 if (entityProp == null &amp;&amp; explicitlyShown) {
1425                     Field field = ef.findField(p.getName());
1426                     if (field != null) {
1427                         field.setValue(null);
1428                     }
<abbr title="1429                 } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1429                 } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getEðŸ”µ</abbr>
1430                     ef.removeField(p.getName());
1431                 } else {
1432                     Field field = ef.findField(p.getName());
1433                     if (field != null) {
1434                         if (entityProp != null) {
<abbr title="1435                             //protect against null - can happen with password confirmation fields (i.e. admin user)">1435                             //protect against null - can happen with password confirmation fields (i.e. aðŸ”µ</abbr>
1436                             field.setDirty(entityProp.getIsDirty());
1437                         }
1438                         if (basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE
1439                                 || basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE_TIME
1440                                 || basicFM.getFieldType()==SupportedFieldType.RULE_WITH_QUANTITY) {
1441                             RuleBuilderField rbf = (RuleBuilderField) field;
1442                             if (entity.getPMap().containsKey(rbf.getJsonFieldName())) {
1443                                 String json = entity.getPMap().get(rbf.getJsonFieldName()).getValue();
1444                                 rbf.setJson(json);
1445                                 DataWrapper dw = convertJsonToDataWrapper(json);
1446                                 if (dw != null) {
1447                                     rbf.setDataWrapper(dw);
1448                                 }
1449                             }
1450                         }
1451                         if (basicFM.getFieldType() == SupportedFieldType.MEDIA) {
1452                             field.setValue(entityProp.getValue());
1453                             field.setDisplayValue(entityProp.getDisplayValue());
1454                             MediaField mf = (MediaField) field;
<abbr title="1455                             Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(), MediaDto.class);">1455                             Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.gðŸ”µ</abbr>
<abbr title="1456                             mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(), type));">1456                             mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodeðŸ”µ</abbr>
<abbr title="1457                         } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1457                         } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldTyðŸ”µ</abbr>
1458                             field.setValue(entityProp.getValue());
1459                             field.setDisplayValue(entityProp.getDisplayValue());
1460                         }
1461                     }
1462                 }
1463             }
1464         }
1465     }
1466 
1467     /**
1468      * When using Thymeleaf, we need to convert the JSON string back to
1469      * a DataWrapper object because Thymeleaf escapes JSON strings.
1470      * Thymeleaf uses it&#x27;s own object de-serializer
1471      * see: https://github.com/thymeleaf/thymeleaf/issues/84
1472      * see: http://forum.thymeleaf.org/Spring-Javascript-and-escaped-JSON-td4024739.html
1473      * @param json
1474      * @return DataWrapper
1475      * @throws IOException
1476      */
1477     protected DataWrapper convertJsonToDataWrapper(String json) {
1478         ObjectMapper mapper = new ObjectMapper();
1479         DataDTODeserializer dtoDeserializer = new DataDTODeserializer();
<abbr title="1480         SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null));">1480         SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, nuðŸ”µ</abbr>
1481         module.addDeserializer(DataDTO.class, dtoDeserializer);
1482         mapper.registerModule(module);
1483         try {
1484             return mapper.readValue(json, DataWrapper.class);
1485         } catch (IOException e) {
1486             throw new RuntimeException(e);
1487         }
1488     }
1489 
1490     protected void populateDropdownToOneFields(EntityForm ef, ClassMetadata cmd)
1491             throws ServiceException {
1492         for (Property p : cmd.getProperties()) {
1493             if (p.getMetadata() instanceof BasicFieldMetadata) {
1494                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
1495                 if (LookupType.DROPDOWN.equals(fmd.getLookupType())
1496                         &amp;&amp; !ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
1497                     // Get the records
1498                     PersistencePackageRequest toOnePpr = PersistencePackageRequest.standard()
1499                             .withCeilingEntityClassname(fmd.getForeignKeyClass());
<abbr title="1500                     Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecords();">1500                     Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecoðŸ”µ</abbr>
1501 
1502                     // Determine the id field
1503                     String idProp = null;
<abbr title="1504                     ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSet().getClassMetaData();">1504                     ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamðŸ”µ</abbr>
1505                     for (Property foreignP : foreignClassMd.getProperties()) {
1506                         if (foreignP.getMetadata() instanceof BasicFieldMetadata) {
1507                             BasicFieldMetadata foreignFmd = (BasicFieldMetadata) foreignP.getMetadata();
1508                             if (SupportedFieldType.ID.equals(foreignFmd.getFieldType())) {
1509                                 idProp = foreignP.getName();
1510                             }
1511                         }
1512                     }
1513 
1514                     if (idProp == null) {
<abbr title="1515                         throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClass());">1515                         throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeigðŸ”µ</abbr>
1516                     }
1517 
1518                     // Determine the display field
1519                     String displayProp = fmd.getLookupDisplayProperty();
1520 
1521                     // Build the options map
1522                     Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
1523                     for (Entity row : rows) {
1524                         Property prop = row.findProperty(displayProp);
1525                         if (prop == null) {
<abbr title="1526                             LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entity [&quot; +">1526                             LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + ðŸ”µ</abbr>
1527                                     ef.getCeilingEntityClassname() + &quot;]&quot;);
1528                         } else {
1529                             String displayValue = prop.getDisplayValue();
1530                             if (StringUtils.isBlank(displayValue)) {
1531                                 displayValue = prop.getValue();
1532                             }
1533                             options.put(row.findProperty(idProp).getValue(), displayValue);
1534                         }
1535                     }
1536 
1537                     // Set the options on the entity field
1538                     ComboField cf = (ComboField) ef.findField(p.getName());
1539                     cf.setOptions(options);
1540                 }
1541             }
1542         }
1543     }
1544 
1545     @Override
<abbr title="1546     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, List&lt;SectionCrumb&gt; sectionCrumbs)">1546     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; coðŸ”µ</abbr>
1547             throws ServiceException {
1548         EntityForm ef = createStandardEntityForm();
1549         populateEntityForm(cmd, entity, collectionRecords, ef, sectionCrumbs);
1550         addAdditionalFormActions(ef);
1551         extensionManager.getProxy().addAdditionalFormActions(ef);
1552         return ef;
1553     }
1554 
1555     @Override
<abbr title="1556     public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {">1556     public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collecðŸ”µ</abbr>
1557         // Get the form with values for this entity
1558         populateEntityForm(cmd, entity, ef, sectionCrumbs);
1559         // Attach the sub-collection list grids and specialty UI support
1560         for (Property p : cmd.getProperties()) {
1561             if (p.getMetadata() instanceof BasicFieldMetadata) {
1562                 continue;
1563             }
1564             if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entity.getType()[0])) {
1565                 continue;
1566             }
1567             if ((collectionRecords != null) &amp;&amp; (!collectionRecords.isEmpty())) {
1568                 DynamicResultSet subCollectionEntities = collectionRecords.get(p.getName());
1569                 String containingEntityId = entity.getPMap().get(ef.getIdProperty()).getValue();
<abbr title="1570                 ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSectionKey(), sectionCrumbs);">1570                 ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p,ðŸ”µ</abbr>
1571                 CollectionMetadata md = ((CollectionMetadata) (p.getMetadata()));
1572                 if (md instanceof BasicCollectionMetadata) {
<abbr title="1573                     PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);">1573                     PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCruðŸ”µ</abbr>
<abbr title="1574                     ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1574                     ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResuðŸ”µ</abbr>
1575                     if (collectionCmd.getPolymorphicEntities().getChildren().length != 0) {
<abbr title="1576                         List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTrees();">1576                         List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedðŸ”µ</abbr>
1577                         ListGridActionGroup actionGroup = new ListGridActionGroup().withName(&quot;Add&quot;);
1578                         for (ClassTree entityType : entityTypes) {
<abbr title="1579                             ListGridAction ADD = new ListGridAction(ListGridAction.ADD).withButtonClass(AddMethodType.PERSIST_EMPTY == ((BasicCollectionMetadata) (md)).getAddMethodType() ? &quot;sub-list-grid-add-empty&quot; : &quot;sub-list-grid-add&quot;).withActionTargetEntity(entityType.getFullyQualifiedClassname()).withUrlPostfix(&quot;/add&quot;).withIconClass(&quot;fa fa-plus&quot;).withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyName()));">1579                             ListGridAction ADD = new ListGridAction(ListGridAction.ADD).withButtonClass(AðŸ”µ</abbr>
1580                             actionGroup.getListGridActions().add(0, ADD);
1581                         }
1582                         listGrid.addToolbarActionGroup(actionGroup);
1583                     } else {
<abbr title="1584                         listGrid.getToolbarActions().add(0, AddMethodType.PERSIST_EMPTY == ((BasicCollectionMetadata) (md)).getAddMethodType() ? DefaultListGridActions.ADD_EMPTY : DefaultListGridActions.ADD);">1584                         listGrid.getToolbarActions().add(0, AddMethodType.PERSIST_EMPTY == ((BasicCollectðŸ”µ</abbr>
1585                     }
1586                 } else {
1587                     listGrid.getToolbarActions().add(0, DefaultListGridActions.ADD);
1588                 }
1589                 if (subCollectionEntities.getUnselectedTabMetadata().get(md.getTab()) != null) {
1590                     ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), true);
1591                 } else {
1592                     ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), false);
1593                 }
1594             }
1595         }
1596         if (CollectionUtils.isEmpty(ef.getActions())) {
1597             ef.addAction(DefaultEntityFormActions.SAVE);
1598         }
1599         addDeleteActionIfAllowed(ef, cmd, entity);
1600         addDuplicateActionIfAllowed(ef, cmd);
1601         setReadOnlyState(ef, cmd, entity);
1602         // check for fields that should be hidden based on annotations
1603         setVisibilityBasedOnShowIfFieldEquals(cmd, entity, ef);
1604         extensionManager.getProxy().modifyDetailEntityForm(ef);
1605     }
1606 
1607     /**
<abbr title="1608      * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The user can">1608      * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/bðŸ”µ</abbr>
1609      * delete an entity for the following cases:
1610      * &lt;ol&gt;
<abbr title="1611      *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represented by">1611      *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represenðŸ”µ</abbr>
<abbr title="1612      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;">1612      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/lðŸ”µ</abbr>
1613      *  &lt;li&gt;The user has the security necessary to delete the given &lt;b&gt;entity&lt;/b&gt; according to the
1614      *  {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}&lt;/li&gt;
1615      * &lt;/ol&gt;
1616      *
1617      * @param entityForm the form being generated
1618      * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1619      * @param entity the entity being edited
1620      * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1621      * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1622      * @see {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}
1623      */
1624     protected void addDeleteActionIfAllowed(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1625         if (isDeletionAllowed(entityForm, cmd, entity)) {
1626             entityForm.addAction(DefaultEntityFormActions.DELETE);
1627         }
1628     }
1629 
<abbr title="1630     protected boolean isDeletionAllowed(final EntityForm entityForm, final ClassMetadata cmd, final Entity entity) {">1630     protected boolean isDeletionAllowed(final EntityForm entityForm, final ClassMetadata cmd, final EntitðŸ”µ</abbr>
1631         try {
1632             String securityEntityClassname = getSecurityClassname(entityForm, cmd);
<abbr title="1633             adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.REMOVE);">1633             adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.REMOVE)ðŸ”µ</abbr>
1634         } catch (ServiceException e) {
1635             if (e instanceof SecurityServiceException) {
1636                 return false;
1637             }
1638         }
1639         final AdminUser persistentAdminUser = adminRemoteSecurityService.getPersistentAdminUser();
<abbr title="1640         return rowLevelSecurityService.canUpdate(persistentAdminUser, entity) &amp;&amp; rowLevelSecurityService.canRemove(persistentAdminUser, entity);">1640         return rowLevelSecurityService.canUpdate(persistentAdminUser, entity) &amp;&amp; rowLevelSecurityService.ðŸ”µ</abbr>
1641     }
1642 
1643     protected void addDuplicateActionIfAllowed(final EntityForm entityForm, final ClassMetadata cmd) {
1644         if (isDuplicationAllowed(entityForm, cmd)) {
1645             entityForm.addAction(DefaultEntityFormActions.DUPLICATE);
1646         }
1647     }
1648 
1649     protected boolean isDuplicationAllowed(final EntityForm entityForm, final ClassMetadata cmd) {
1650         final String securityClassname = getSecurityClassname(entityForm, cmd);
1651         try {
1652             adminRemoteSecurityService.securityCheck(securityClassname, EntityOperationType.ADD);
1653         } catch (ServiceException e) {
1654             if (e instanceof SecurityServiceException) {
1655                 return false;
1656             }
1657         }
1658         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(securityClassname);
<abbr title="1659         return duplicator.validate(entityClass, Long.valueOf(entityForm.getId())) &amp;&amp; rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), securityClassname, cmd);">1659         return duplicator.validate(entityClass, Long.valueOf(entityForm.getId())) &amp;&amp; rowLevelSecurityServðŸ”µ</abbr>
1660     }
1661 
1662     /**
1663      * The given &lt;b&gt;entityForm&lt;/b&gt; is marked as readonly for the following cases:
1664      * &lt;ol&gt;
1665      *  &lt;li&gt;All of the properties from &lt;b&gt;cmd&lt;/b&gt; are readonly&lt;/b&gt;&lt;/li&gt;
<abbr title="1666      *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represented by">1666      *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class namðŸ”µ</abbr>
<abbr title="1667      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;">1667      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/lðŸ”µ</abbr>
<abbr title="1668      *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to the">1668      *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to ðŸ”µ</abbr>
1669      *  {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}&lt;/li&gt;
1670      * &lt;/ol&gt;
1671      *
1672      * @param entityForm the form being generated
1673      * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1674      * @param entity the entity being edited
1675      * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1676      * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1677      * @see {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}
1678      */
1679     protected void setReadOnlyState(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1680         boolean readOnly = true;
1681 
1682         // If all of the fields are read only, we&#x27;ll mark the form as such
1683         for (Property property : cmd.getProperties()) {
1684             FieldMetadata fieldMetadata = property.getMetadata();
1685             if (fieldMetadata instanceof BasicFieldMetadata) {
<abbr title="1686                 readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieldMetadata).getReadOnly();">1686                 readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetaðŸ”µ</abbr>
1687                 if (!readOnly) {
1688                     break;
1689                 }
1690             } else {
1691                 readOnly = ((CollectionMetadata) fieldMetadata).isMutable();
1692                 if (!readOnly) {
1693                     break;
1694                 }
1695             }
1696         }
1697 
1698         if (!readOnly) {
<abbr title="1699             // If the user does not have edit permissions, we will go ahead and make the form read only to prevent confusion">1699             // If the user does not have edit permissions, we will go ahead and make the form read only tðŸ”µ</abbr>
1700             try {
1701                 String securityEntityClassname = getSecurityClassname(entityForm, cmd);
<abbr title="1702                 adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDATE);">1702                 adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDðŸ”µ</abbr>
1703             } catch (ServiceException e) {
1704                 if (e instanceof SecurityServiceException) {
1705                     readOnly = true;
1706                 }
1707             }
1708         }
1709 
<abbr title="1710         // if the normal admin security service has not deemed this readonly and the all of the properties on the entity">1710         // if the normal admin security service has not deemed this readonly and the all of the propertieðŸ”µ</abbr>
1711         // are not readonly, then check the row-level security
1712         if (!readOnly) {
<abbr title="1713             readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1713             readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUsðŸ”µ</abbr>
1714         }
1715 
1716         if (readOnly) {
1717             entityForm.setReadOnly();
<abbr title="1718             //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface">1718             //If someone has replaced RowLevelSecurityService, check here to make sure the replacement imðŸ”µ</abbr>
1719             if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title="1720                 EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();">1720                 EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLeveðŸ”µ</abbr>
<abbr title="1721                 for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {">1721                 for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguðŸ”µ</abbr>
1722                     for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
1723                         if (modifier.isQualified(data.getModifierType())) {
1724                             modifier.modifyEntityForm(new EntityFormModifierRequest()
1725                                     .withEntityForm(entityForm)
1726                                     .withConfiguration(data)
1727                                     .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
1728                                     .withEntity(entity)
1729                                     .withRowLevelSecurityService(rowLevelSecurityService));
1730                         }
1731                     }
1732                 }
1733             }
1734         }
1735     }
1736 
1737     /**
1738      * Obtains the class name suitable for passing along to the {@link SecurityVerifier}
1739      * @param entityForm
1740      * @param cmd
1741      * @return
1742      */
1743     protected String getSecurityClassname(EntityForm entityForm, ClassMetadata cmd) {
1744         String securityEntityClassname = entityForm.getCeilingEntityClassname();
1745 
1746         if (!StringUtils.isEmpty(cmd.getSecurityCeilingType())) {
1747             securityEntityClassname = cmd.getSecurityCeilingType();
1748         } else {
1749             if (entityForm.getDynamicFormInfos() != null) {
1750                 for (DynamicEntityFormInfo info : entityForm.getDynamicFormInfos().values()) {
1751                     if (!StringUtils.isEmpty(info.getSecurityCeilingClassName())) {
1752                         securityEntityClassname = info.getSecurityCeilingClassName();
1753                         break;
1754                     }
1755                 }
1756             }
1757         }
1758 
1759         return securityEntityClassname;
1760     }
1761 
1762     @Override
1763     public void populateEntityFormFields(EntityForm ef, Entity entity) {
1764         populateEntityFormFields(ef, entity, true, true);
1765     }
1766 
1767     @Override
<abbr title="1768     public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean populateId) {">1768     public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean popuðŸ”µ</abbr>
1769         if (populateId) {
1770             ef.setId(entity.findProperty(ef.getIdProperty()).getValue());
1771         }
1772         if (populateType) {
1773             ef.setEntityType(entity.getType()[0]);
1774         }
1775 
1776         for (Entry&lt;String, Field&gt; entry : ef.getFields().entrySet()) {
1777             Property entityProp = entity.findProperty(entry.getKey());
1778             if (entityProp != null) {
1779                 entry.getValue().setValue(entityProp.getValue());
1780                 entry.getValue().setDisplayValue(entityProp.getDisplayValue());
1781             }
1782         }
1783     }
1784 
1785     @Override
<abbr title="1786     public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedList) {">1786     public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedLiðŸ”µ</abbr>
<abbr title="1787         Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());">1787         Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdPropeðŸ”µ</abbr>
1788         Property entityProp = entity.findProperty(ef.getIdProperty());
1789         field.setValue(entityProp.getValue());
1790 
1791         if (StringUtils.isNotBlank(adornedList.getSortField())) {
1792             field = ef.findField(adornedList.getSortField());
1793             entityProp = entity.findProperty(adornedList.getSortField());
1794             if (field != null &amp;&amp; entityProp != null) {
1795                 field.setValue(entityProp.getValue());
1796             }
1797         }
1798     }
1799 
1800     @Override
1801     public void populateMapEntityFormFields(EntityForm ef, Entity entity) {
1802         Field field = ef.findField(&quot;priorKey&quot;);
1803         Property entityProp = entity.findProperty(&quot;key&quot;);
1804         if (field != null &amp;&amp; entityProp != null) {
1805             field.setValue(entityProp.getValue());
1806         }
1807     }
1808 
1809     @Override
<abbr title="1810     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1810     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList aðŸ”µ</abbr>
<abbr title="1811             String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1811             String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdðŸ”µ</abbr>
1812             throws ServiceException {
1813         EntityForm ef = createStandardAdornedEntityForm();
<abbr title="1814         return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAdd);">1814         return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrðŸ”µ</abbr>
1815     }
1816 
1817     @Override
<abbr title="1818     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1818     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList aðŸ”µ</abbr>
<abbr title="1819             String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1819             String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbðŸ”µ</abbr>
1820             throws ServiceException {
1821         ef.setEntityType(adornedList.getAdornedTargetEntityClassname());
1822 
1823         // Get the metadata for this adorned field
1824         PersistencePackageRequest request = PersistencePackageRequest.adorned()
1825                 .withCeilingEntityClassname(adornedMd.getCollectionCeilingEntity())
1826                 .withAdornedList(adornedList)
1827                 .withSectionCrumbs(sectionCrumbs);
1828         request.setAddOperationInspect(isAdd);
<abbr title="1829         ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getClassMetaData();">1829         ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSðŸ”µ</abbr>
1830 
1831         List&lt;Property&gt; entityFormProperties = new ArrayList&lt;&gt;();
1832         if (isViewCollectionItem) {
1833             Collections.addAll(entityFormProperties, collectionMetadata.getProperties());
1834         } else {
1835             // We want our entity form to only render the maintained adorned target fields
1836             for (String targetFieldName : adornedMd.getMaintainedAdornedTargetFields()) {
1837                 Property p = collectionMetadata.getPMap().get(targetFieldName);
<abbr title="1838                 if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExcluded())) {">1838                 if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadatðŸ”µ</abbr>
1839                     ((BasicFieldMetadata) p.getMetadata()).setVisibility(VisibilityEnum.VISIBLE_ALL);
1840                     entityFormProperties.add(p);
1841                 }
1842             }
1843         }
1844 
1845         // Set the maintained fields on the form
1846         setEntityFormFields(collectionMetadata, ef, entityFormProperties);
1847 
1848         // Add these two additional hidden fields that are required for persistence
1849         Field f = new Field()
1850                 .withName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty())
1851                 .withFieldType(SupportedFieldType.HIDDEN.toString())
1852                 .withValue(parentId);
1853         ef.addHiddenField(collectionMetadata, f);
1854 
1855         f = new Field()
1856                 .withName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty())
1857                 .withFieldType(SupportedFieldType.HIDDEN.toString())
1858                 .withIdOverride(&quot;adornedTargetIdProperty&quot;);
1859         ef.addHiddenField(collectionMetadata, f);
1860 
1861         if (StringUtils.isNotBlank(adornedList.getSortField())) {
1862             f = new Field()
1863                     .withName(adornedList.getSortField())
1864                     .withFieldType(SupportedFieldType.HIDDEN.toString());
1865             ef.addHiddenField(collectionMetadata, f);
1866         }
1867 
1868         ef.setParentId(parentId);
1869 
1870         extensionManager.getProxy().addAdditionalAdornedFormActions(ef);
1871 
1872         return ef;
1873     }
1874 
1875     @Override
<abbr title="1876     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId)">1876     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd,ðŸ”µ</abbr>
1877             throws ServiceException {
1878         EntityForm ef = createStandardEntityForm();
1879         return buildMapForm(mapMd, mapStructure, cmd, parentId, ef);
1880     }
1881 
1882     @Override
<abbr title="1883     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId, EntityForm ef)">1883     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd,ðŸ”µ</abbr>
1884             throws ServiceException {
1885         ForeignKey foreignKey = (ForeignKey) mapMd.getPersistencePerspective()
1886                 .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY);
1887         ef.setEntityType(foreignKey.getForeignKeyClass());
1888 
1889         Field keyField;
1890         if (!mapMd.getForceFreeFormKeys()) {
1891             // We will use a combo field to render the key choices
1892             ComboField temp = new ComboField();
1893             temp.withName(&quot;key&quot;)
1894                     .withFieldType(&quot;combo_field&quot;)
1895                     .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1896             if (mapMd.getKeys() != null) {
1897                 // The keys can be explicitly set in the annotation...
1898                 temp.setOptions(mapMd.getKeys());
1899             } else {
1900                 // Or they could be based on a different entity
1901                 PersistencePackageRequest ppr = PersistencePackageRequest.standard()
1902                         .withCeilingEntityClassname(mapMd.getMapKeyOptionEntityClass());
1903 
1904                 DynamicResultSet drs = adminEntityService.getRecords(ppr).getDynamicResultSet();
1905 
1906                 for (Entity entity : drs.getRecords()) {
<abbr title="1907                     String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getValue();">1907                     String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getVaðŸ”µ</abbr>
<abbr title="1908                     String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getValue();">1908                     String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayFieldðŸ”µ</abbr>
1909                     temp.putOption(keyValue, keyDisplayValue);
1910                 }
1911             }
1912             keyField = temp;
1913         } else {
1914             keyField = new Field().withName(&quot;key&quot;)
1915                                 .withFieldType(SupportedFieldType.STRING.toString())
1916                                 .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1917         }
1918         keyField.setRequired(true);
1919         ef.addMapKeyField(cmd, keyField);
1920 
1921         // Set the fields for this form
1922         List&lt;Property&gt; mapFormProperties;
1923         if (mapMd.isSimpleValue()) {
1924             ef.setIdProperty(&quot;key&quot;);
1925             mapFormProperties = new ArrayList&lt;&gt;();
1926             Property valueProp = cmd.getPMap().get(&quot;value&quot;);
1927             mapFormProperties.add(valueProp);
1928         } else {
1929             String valueClassName = mapStructure.getValueClassName();
1930             List&lt;String&gt; classNames = getValueClassNames(valueClassName);
1931 
1932             mapFormProperties = new ArrayList&lt;&gt;(Arrays.asList(cmd.getProperties()));
1933             filterMapFormProperties(mapFormProperties, classNames);
1934         }
1935 
1936         setEntityFormFields(cmd, ef, mapFormProperties);
1937 
1938         Field f = new Field()
1939                 .withName(&quot;priorKey&quot;)
1940                 .withFieldType(SupportedFieldType.HIDDEN.toString());
1941         ef.addHiddenField(cmd, f);
1942 
1943         ef.setParentId(parentId);
1944 
1945         return ef;
1946     }
1947 
1948     protected List&lt;String&gt; getValueClassNames(String valueClassName) {
1949         PersistenceManager pm = PersistenceManagerFactory.getPersistenceManager(valueClassName);
1950         List&lt;String&gt; classNames = new ArrayList&lt;&gt;();
1951         try {
1952             Class&lt;?&gt;[] mapEntities = pm.getPolymorphicEntities(valueClassName);
1953             for (Class clazz : mapEntities) {
1954                 classNames.add(clazz.getName());
1955             }
1956         } catch (ClassNotFoundException e) {
1957             classNames.add(valueClassName);
1958         }
1959         return classNames;
1960     }
1961 
<abbr title="1962     protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNames) {">1962     protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNameðŸ”µ</abbr>
1963         CollectionUtils.filter(mapFormProperties, new Predicate() {
1964             @Override
1965             public boolean evaluate(Object object) {
1966                 Property p = (Property) object;
1967                 for (String availType : p.getMetadata().getAvailableToTypes()) {
1968                     if (classNames.contains(availType)) {
1969                         return true;
1970                     }
1971                 }
1972                 return false;
1973             }
1974         });
1975     }
1976 
1977     protected EntityForm createStandardEntityForm() {
1978         EntityForm ef = new EntityForm();
1979         ef.addAction(DefaultEntityFormActions.SAVE);
1980         return ef;
1981     }
1982 
1983     protected EntityForm createStandardAdornedEntityForm() {
1984         EntityForm ef = new EntityForm();
1985         ef.addAction(DefaultAdornedEntityFormActions.Add);
1986         return ef;
1987     }
1988 
1989     protected VisibilityEnum[] getGridHiddenVisibilities() {
1990         return FormBuilderServiceImpl.GRID_HIDDEN_VISIBILITIES;
1991     }
1992 
1993     protected VisibilityEnum[] getFormHiddenVisibilities() {
1994         return FormBuilderServiceImpl.FORM_HIDDEN_VISIBILITIES;
1995     }
1996 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.web.service;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.Predicate;
  22  import org.apache.commons.lang.ArrayUtils;
  23  import org.apache.commons.lang.BooleanUtils;
  24  import org.apache.commons.lang3.StringUtils;
  25  import org.apache.commons.logging.Log;
  26  import org.apache.commons.logging.LogFactory;
  27  import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  28  import org.broadleafcommerce.common.exception.ExceptionHelper;
  29  import org.broadleafcommerce.common.exception.SecurityServiceException;
  30  import org.broadleafcommerce.common.exception.ServiceException;
  31  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;



  32  import org.broadleafcommerce.common.media.domain.MediaDto;
  33  import org.broadleafcommerce.common.persistence.EntityConfiguration;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import org.broadleafcommerce.common.persistence.EntityDuplicator;</span>
  35  import org.broadleafcommerce.common.presentation.client.AddMethodType;
  36  import org.broadleafcommerce.common.presentation.client.AdornedTargetAddMethodType;
  37  import org.broadleafcommerce.common.presentation.client.LookupType;
  38  import org.broadleafcommerce.common.presentation.client.PersistencePerspectiveItemType;
  39  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  40  import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  41  import org.broadleafcommerce.common.util.BLCMessageUtils;
  42  import org.broadleafcommerce.common.util.FormatUtil;
  43  import org.broadleafcommerce.common.util.StringUtil;
  44  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  45  import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  46  import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  47  import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  48  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  49  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  50  import org.broadleafcommerce.openadmin.dto.ClassTree;
  51  import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  52  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  53  import org.broadleafcommerce.openadmin.dto.Entity;
  54  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  55  import org.broadleafcommerce.openadmin.dto.ForeignKey;
  56  import org.broadleafcommerce.openadmin.dto.MapMetadata;
  57  import org.broadleafcommerce.openadmin.dto.MapStructure;
  58  import org.broadleafcommerce.openadmin.dto.Property;
  59  import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  60  import org.broadleafcommerce.openadmin.dto.TabMetadata;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;</span>
  62  import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  63  import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  64  import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  65  import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  66  import org.broadleafcommerce.openadmin.server.security.remote.SecurityVerifier;
  67  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifier;
  68  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierConfiguration;
  69  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierData;
  70  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierDataPoint;
  71  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierRequest;
  72  import org.broadleafcommerce.openadmin.server.security.service.ExceptionAwareRowLevelSecurityProvider;
  73  import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  74  import org.broadleafcommerce.openadmin.server.security.service.navigation.AdminNavigationService;
  75  import org.broadleafcommerce.openadmin.server.service.AdminEntityService;
  76  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManager;
  77  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  78  import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  79  import org.broadleafcommerce.openadmin.server.service.persistence.module.FieldManager;
  80  import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  81  import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  82  import org.broadleafcommerce.openadmin.web.form.component.ListGridAction;
  83  import org.broadleafcommerce.openadmin.web.form.component.ListGridActionGroup;
  84  import org.broadleafcommerce.openadmin.web.form.component.ListGridRecord;
  85  import org.broadleafcommerce.openadmin.web.form.component.MediaField;
  86  import org.broadleafcommerce.openadmin.web.form.component.RuleBuilderField;
  87  import org.broadleafcommerce.openadmin.web.form.entity.CodeField;
  88  import org.broadleafcommerce.openadmin.web.form.entity.ComboField;
  89  import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  90  import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  91  import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  92  import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  93  import org.broadleafcommerce.openadmin.web.form.entity.Field;
  94  import org.broadleafcommerce.openadmin.web.rulebuilder.DataDTODeserializer;
  95  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataDTO;
  96  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataWrapper;
  97  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldDTO;
  98  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldWrapper;
  99  import org.codehaus.jettison.json.JSONObject;

 100  import org.springframework.context.MessageSource;
 101  import org.springframework.context.NoSuchMessageException;
 102  import org.springframework.stereotype.Service;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +</span>
 104  import com.fasterxml.jackson.core.Version;
 105  import com.fasterxml.jackson.databind.ObjectMapper;
 106  import com.fasterxml.jackson.databind.module.SimpleModule;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +</span>
 108  import java.io.IOException;
 109  import java.math.BigDecimal;
 110  import java.text.DateFormat;
 111  import java.text.DateFormatSymbols;
 112  import java.text.ParseException;
 113  import java.text.SimpleDateFormat;
 114  import java.util.ArrayList;
 115  import java.util.Arrays;
 116  import java.util.Collections;
 117  import java.util.Date;
 118  import java.util.HashMap;
 119  import java.util.List;
 120  import java.util.Locale;
 121  import java.util.Map;
 122  import java.util.Map.Entry;
 123  import java.util.Set;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +</span>
 125  import javax.annotation.Resource;
 126  import javax.persistence.ManyToOne;
 127  import javax.persistence.OneToOne;
 128  import javax.servlet.http.HttpServletRequest;
 129  
 130  
 131  /**
 132   * @author Andre Azzolini (apazzolini)
 133   */
 134  @Service(&quot;blFormBuilderService&quot;)
 135  public class FormBuilderServiceImpl implements FormBuilderService {
 136  
 137      private static final Log LOG = LogFactory.getLog(FormBuilderServiceImpl.class);
 138  
 139      public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 140  
 141      @Resource(name = &quot;blAdminEntityService&quot;)
 142      protected AdminEntityService adminEntityService;
 143  
 144      @Resource (name = &quot;blAdminNavigationService&quot;)
 145      protected AdminNavigationService navigationService;
 146  
 147      @Resource(name = &quot;blFormBuilderExtensionManager&quot;)
 148      protected FormBuilderExtensionManager extensionManager;
 149  
 150      @Resource(name=&quot;blEntityConfiguration&quot;)
 151      protected EntityConfiguration entityConfiguration;
 152  
 153      @Resource(name=&quot;blAdminSecurityRemoteService&quot;)
 154      protected SecurityVerifier adminRemoteSecurityService;
 155  
 156      @Resource(name = &quot;blRowLevelSecurityService&quot;)
 157      protected RowLevelSecurityService rowLevelSecurityService;
 158  
 159      @Resource(name = &quot;blMediaBuilderService&quot;)
 160      protected MediaBuilderService mediaBuilderService;
 161  
 162      @Resource(name = &quot;blListGridErrorMessageExtensionManager&quot;)
 163      protected ListGridErrorMessageExtensionManager listGridErrorExtensionManager;
 164  
 165      @Resource(name = &quot;blAdminNavigationService&quot;)
 166      protected AdminNavigationService adminNavigationService;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +    @Resource(name = &quot;blEntityDuplicator&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +    protected EntityDuplicator duplicator;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +    @Resource(name = &quot;blDynamicEntityDao&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +    protected DynamicEntityDao dynamicEntityDao;</span>
 173  









 174      protected static final VisibilityEnum[] FORM_HIDDEN_VISIBILITIES = new VisibilityEnum[] {
 175              VisibilityEnum.HIDDEN_ALL, VisibilityEnum.FORM_HIDDEN
 176      };
 177  
 178      protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[] {
 179              VisibilityEnum.HIDDEN_ALL, VisibilityEnum.GRID_HIDDEN
 180      };
 181  
 182      @Override
<abbr title=" 183      public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)"> 183      public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumðŸ”µ</abbr>
 184              throws ServiceException {
 185  
 186          List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 187          ListGrid.Type type = ListGrid.Type.MAIN;
 188          String idProperty = &quot;id&quot;;
 189  
 190          FieldWrapper wrapper = new FieldWrapper();
 191          ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 192          for (Property p : cmd.getProperties()) {
 193              if (p.getMetadata() instanceof BasicFieldMetadata) {
 194                  BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
 195  
 196                  if (SupportedFieldType.ID.equals(fmd.getFieldType())) {
 197                      idProperty = fmd.getName();
 198                  }
 199  
 200                  if (fmd.isProminent() != null &amp;&amp; fmd.isProminent()
 201                          &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), fmd.getVisibility())) {
 202                      Field hf = createHeaderField(p, fmd);
 203                      headerFields.add(hf);
 204                      defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, fmd));
 205                  }
 206  
 207                  if (fmd.getIsFilter() != null &amp;&amp; fmd.getIsFilter()) {
 208                      wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmd));
 209                  }
 210              }




 211          }
 212  
<abbr title=" 213          ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idProperty, sectionCrumbs);"> 213          ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idPropertðŸ”µ</abbr>
 214  
 215          if (CollectionUtils.isNotEmpty(listGrid.getHeaderFields())) {
 216              // Set the first column to be able to link to the main entity
 217              listGrid.getHeaderFields().iterator().next().setMainEntityLink(true);
 218          } else {
<abbr title=" 219              String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType();"> 219              String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType(ðŸ”µ</abbr>
 220              message += &quot;Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 221              LOG.error(message);
 222          }
 223  
 224          Date c = new Date();
 225          String friendlyName = &quot;listGrid&quot; + c.getTime();
 226          // Set up the filter builder params
 227          listGrid.setJsonFieldName(friendlyName + &quot;Json&quot;);
 228          listGrid.setFriendlyName(friendlyName);
 229          listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 230          if (CollectionUtils.isEmpty(wrapper.getFields())) {
 231              wrapper.setFields(defaultWrapperFields);
 232          }
 233          listGrid.setFieldWrapper(wrapper);
 234          listGrid.setHideFriendlyName(true);
 235  
 236          String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 237          listGrid.setJson(blankJsonString);
 238          DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 239          if (dw != null) {
 240              listGrid.setDataWrapper(dw);
 241          }
 242  
 243          listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 244          listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 245  
 246          extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 247  
 248          return listGrid;




























 249      }
 250  
 251      protected FieldDTO constructFieldDTOFromFieldData(Field field, BasicFieldMetadata fmd) {
 252          FieldDTO fieldDTO = new FieldDTO();
 253          //translate the label to display
 254          String label = field.getFriendlyName();
 255          BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 256          MessageSource messages = context.getMessageSource();
 257          if (messages != null) {
 258              label = messages.getMessage(label, null, label, context.getJavaLocale());
 259          }
 260          fieldDTO.setLabel(label);
 261  
 262          fieldDTO.setId(field.getName());
 263          if (field.getFieldType().equals(&quot;STRING&quot;)) {
 264              fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 265          } else if (field.getFieldType().equals(&quot;DATE&quot;)) {
 266              fieldDTO.setOperators(&quot;blcFilterOperators_Date&quot;);
<abbr title=" 267          } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldType().equals(&quot;DECIMAL&quot;)) {"> 267          } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldðŸ”µ</abbr>
 268              fieldDTO.setOperators(&quot;blcFilterOperators_Numeric&quot;);
 269          } else if (field.getFieldType().equals(&quot;BOOLEAN&quot;)) {
 270              fieldDTO.setOperators(&quot;blcFilterOperators_Boolean&quot;);
 271          } else if (field.getFieldType().equals(&quot;BROADLEAF_ENUMERATION&quot;)) {
 272              fieldDTO.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 273              fieldDTO.setInput(&quot;select&quot;);
 274              fieldDTO.setType(&quot;string&quot;);
 275              String[][] enumerationValues = fmd.getEnumerationValues ();
 276              Map&lt;String, String&gt; enumMap = new HashMap&lt;&gt;();
 277              for (int i = 0; i &lt; enumerationValues.length; i++) {
 278                  enumMap.put(enumerationValues[i][0], enumerationValues[i][1]);
 279              }
 280  
 281              fieldDTO.setValues(new JSONObject(enumMap).toString());
 282          } else if (field.getFieldType().equals(&quot;ADDITIONAL_FOREIGN_KEY&quot;)) {
 283              fieldDTO.setOperators(&quot;blcFilterOperators_Selectize&quot;);
 284              fieldDTO.setType(&quot;string&quot;);
 285  
<abbr title=" 286              AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClass(), null);"> 286              AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClaðŸ”µ</abbr>
 287              if (section != null) {
 288                  String sectionKey = section.getUrl().substring(1);
 289                  fieldDTO.setSelectizeSectionKey(sectionKey);
 290              } else {
 291                  fieldDTO.setSelectizeSectionKey(fmd.getForeignKeyClass());
 292              }
 293          } else {
 294              fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 295          }
 296  
 297          return fieldDTO;
 298      }
 299  
 300      protected Field createHeaderField(Property p, BasicFieldMetadata fmd) {
 301          Field hf;
 302          if (fmd.getFieldType().equals(SupportedFieldType.EXPLICIT_ENUMERATION) ||
 303                  fmd.getFieldType().equals(SupportedFieldType.BROADLEAF_ENUMERATION) ||
 304                  fmd.getFieldType().equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION) ||
 305                  fmd.getFieldType().equals(SupportedFieldType.EMPTY_ENUMERATION)) {
 306              hf = new ComboField();
 307              ((ComboField) hf).setOptions(fmd.getEnumerationValues());
 308          } else {
 309              hf = new Field();
 310          }
 311  
 312          hf.withName(p.getName())
 313            .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getName())
 314            .withOrder(fmd.getGridOrder())
 315            .withColumnWidth(fmd.getColumnWidth())
 316            .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
 317            .withForeignKeyClass(fmd.getForeignKeyClass())
 318            .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
 319            .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClass())
 320            .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity());
 321          String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 322          hf.setFieldType(fieldType);
 323  
 324          return hf;
 325      }
 326  
 327      @Override
 328      public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property field,
 329              String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 330              throws ServiceException {
 331          FieldMetadata fmd = field.getMetadata();
 332          // Get the class metadata for this particular field
 333          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 334          if (field != null) {
 335              ppr.setSectionEntityField(field.getName());
 336          }
 337          ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 338  
 339          List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 340          ListGrid.Type type = null;
 341          boolean editable = false;
 342          boolean sortable = false;
 343          boolean readOnly = false;
 344          boolean hideIdColumn = false;
 345          boolean canFilterAndSort = true;
 346          boolean modalSingleSelectable = false;
 347          boolean modalMultiSelectable = false;
 348          boolean selectize = false;
 349          boolean isMedia = false;
 350          boolean isLookup = false;
 351          String sortProperty = null;
 352          FieldWrapper wrapper = new FieldWrapper();
 353          ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 354  
 355  
 356          String idProperty = &quot;id&quot;;
 357          for (Property property : cmd.getProperties()) {
 358              if (property.getMetadata() instanceof BasicFieldMetadata &amp;&amp;
 359                      SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;&amp;
 360                      //make sure it&#x27;s a property for this entity - not an association
 361                      !property.getName().contains(&quot;.&quot;)) {
 362                  idProperty = property.getName();
 363                  break;
 364              }
 365          }
 366          // Get the header fields for this list grid. Note that the header fields are different depending on the
 367          // kind of field this is.
 368          if (fmd instanceof BasicFieldMetadata) {
 369              readOnly = ((BasicFieldMetadata) fmd).getReadOnly();
 370              modalSingleSelectable = true;
 371              for (Property p : cmd.getProperties()) {
 372                  if (p.getMetadata() instanceof BasicFieldMetadata) {
 373                      BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 374  
 375                      if (SupportedFieldType.ID.equals(md.getFieldType())) {
 376                          idProperty = md.getName();
 377                      }
 378  
 379                      if (md.isProminent() != null &amp;&amp; md.isProminent()
 380                              &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 381                          Field hf = createHeaderField(p, md);
 382                          headerFields.add(hf);
 383                          defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 384                      }
 385  
 386                      if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 387                          Field f = createHeaderField(p, md);
 388                          wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 389                      }
 390                  }
 391              }
 392  
 393              type = ListGrid.Type.TO_ONE;
 394          } else if (fmd instanceof BasicCollectionMetadata) {
 395              BasicCollectionMetadata bcm = (BasicCollectionMetadata) fmd;
 396              readOnly = !bcm.isMutable();
 397  
 398              if(AddMethodType.LOOKUP.equals(bcm.getAddMethodType())) {
 399                  isLookup = true;
 400              }
 401  
 402              if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 403                  Property p = cmd.getPMap().get(bcm.getSelectizeVisibleField());
 404                  if (p != null) {
 405                      BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 406  
 407                      Field hf = createHeaderField(p, md);
 408                      headerFields.add(hf);
 409                      wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 410                  }
 411              } else {
 412                  for (Property p : cmd.getProperties()) {
 413                      if (p.getMetadata() instanceof BasicFieldMetadata) {
 414                          BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 415                          if (md.isProminent() != null &amp;&amp; md.isProminent()
 416                                  &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 417                              Field hf = createHeaderField(p, md);
 418                              headerFields.add(hf);
 419                              defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 420                          }
 421  
 422                          if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 423                              Field f = createHeaderField(p, md);
 424                              wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 425                          }
 426                      }
 427                  }
 428              }
 429  
 430              type = ListGrid.Type.BASIC;
 431  
<abbr title=" 432              if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getAddMethodType())) {"> 432              if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getðŸ”µ</abbr>
 433                  editable = true;
 434              } else if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 435                  selectize = true;
 436                  modalSingleSelectable = true;
 437              } else {
 438                  modalSingleSelectable = true;
 439              }
 440              sortable = StringUtils.isNotBlank(bcm.getSortProperty());
 441              if (sortable) {
 442                  sortProperty = bcm.getSortProperty();
 443              }
 444          } else if (fmd instanceof AdornedTargetCollectionMetadata) {
 445              modalSingleSelectable = true;
 446              readOnly = !((AdornedTargetCollectionMetadata) fmd).isMutable();
 447              AdornedTargetCollectionMetadata atcmd = (AdornedTargetCollectionMetadata) fmd;
 448  
 449              if(AdornedTargetAddMethodType.LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 450                  isLookup = true;
 451              }
 452  
 453              if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 454                  selectize = true;
 455  
 456                  Property p = cmd.getPMap().get(atcmd.getSelectizeVisibleField());
 457                  if (p != null) {
 458                      BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 459  
 460                      Field hf = createHeaderField(p, md);
 461                      headerFields.add(hf);
 462                      wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 463                  }
 464              } else {
 465                  for (String fieldName : atcmd.getGridVisibleFields()) {
 466                      Property p = cmd.getPMap().get(fieldName);
 467                      if (p != null) {
 468                          BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 469  
 470                          Field hf = createHeaderField(p, md);
 471                          headerFields.add(hf);
 472                          wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 473                      }
 474  
 475                  }
 476              }
 477  
 478              type = ListGrid.Type.ADORNED;
 479  
 480              if (atcmd.getMaintainedAdornedTargetFields().length &gt; 0) {
 481                  editable = true;
 482              }
 483  
 484              AdornedTargetList adornedList = (AdornedTargetList) atcmd.getPersistencePerspective()
 485                      .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);
 486              sortable = StringUtils.isNotBlank(adornedList.getSortField());
 487              if (sortable) {
 488                  sortProperty = adornedList.getSortField();
 489              }
 490          } else if (fmd instanceof MapMetadata) {
 491              readOnly = !((MapMetadata) fmd).isMutable();
 492              MapMetadata mmd = (MapMetadata) fmd;
 493  
 494              Property p2 = cmd.getPMap().get(&quot;key&quot;);
 495              BasicFieldMetadata keyMd = (BasicFieldMetadata) p2.getMetadata();
 496              keyMd.setFriendlyName(getMapKeyFriendlyName(p2));
 497              Field hf = createHeaderField(p2, keyMd);
 498              headerFields.add(hf);
 499              wrapper.getFields().add(constructFieldDTOFromFieldData(hf, keyMd));
 500  
 501              if (mmd.isSimpleValue()) {
 502                  Property valueProperty = cmd.getPMap().get(&quot;value&quot;);
 503                  BasicFieldMetadata valueMd = (BasicFieldMetadata) valueProperty.getMetadata();
 504                  valueMd.setFriendlyName(&quot;Value&quot;);
 505                  hf = createHeaderField(valueProperty, valueMd);
 506                  headerFields.add(hf);
 507                  wrapper.getFields().add(constructFieldDTOFromFieldData(hf, valueMd));
 508  
 509                  idProperty = &quot;key&quot;;
 510                  hideIdColumn = true;
 511              } else {
 512                  for (Property p : cmd.getProperties()) {
 513                      if (p.getMetadata() instanceof BasicFieldMetadata) {
 514                          BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 515                          String valueClassName = mmd.getValueClassName();
 516                          if (!StringUtils.isEmpty(mmd.getToOneTargetProperty())) {
 517                              Class&lt;?&gt; clazz;
 518                              try {
 519                                  clazz = Class.forName(mmd.getValueClassName());
 520                              } catch (ClassNotFoundException e) {
 521                                  throw ExceptionHelper.refineException(e);
 522                              }
<abbr title=" 523                              java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTargetProperty());"> 523                              java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTðŸ”µ</abbr>
 524                              ManyToOne manyToOne = nestedField.getAnnotation(ManyToOne.class);
<abbr title=" 525                              if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getName())) {"> 525                              if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getNameðŸ”µ</abbr>
 526                                  valueClassName = manyToOne.targetEntity().getName();
 527                              } else {
 528                                  OneToOne oneToOne = nestedField.getAnnotation(OneToOne.class);
<abbr title=" 529                                  if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getName())) {"> 529                                  if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getNaðŸ”µ</abbr>
 530                                      valueClassName = oneToOne.targetEntity().getName();
 531                                  }
 532                              }
 533                          }
 534                          if (md.getTargetClass().equals(valueClassName)) {
 535                              if (md.isProminent() != null &amp;&amp; md.isProminent()
 536                                      &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 537                                  hf = createHeaderField(p, md);
 538                                  headerFields.add(hf);
 539                                  defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 540  
 541                                  // Is this a media listgrid
 542                                  if (hf.getFieldType().equals(&quot;ASSET_LOOKUP&quot;)) {
 543                                      isMedia = true;
 544                                  }
 545                              }
 546  
 547                              if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 548                                  wrapper.getFields().add(constructFieldDTOFromFieldData(hf,md));
 549                              }
 550                          }
 551                      }
 552                  }
 553              }
 554  
 555              type = ListGrid.Type.MAP;
 556              editable = true;
 557              canFilterAndSort = false;
 558          }
 559  
 560          String ceilingType = &quot;&quot;;
 561          if (fmd instanceof BasicFieldMetadata) {
 562              ceilingType = cmd.getCeilingType();
 563          } else if (fmd instanceof CollectionMetadata) {
 564              ceilingType = ((CollectionMetadata) fmd).getCollectionCeilingEntity();
 565          }
 566  
 567          if (CollectionUtils.isEmpty(headerFields)) {
<abbr title=" 568              String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; and property &#x27;&quot; +"> 568              String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; andðŸ”µ</abbr>
 569                      StringUtil.sanitize(field.getName()) + &quot;&#x27;.&quot;;
 570              if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) {
<abbr title=" 571                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 571                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetColleðŸ”µ</abbr>
 572              } else if (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM) {
<abbr title=" 573                  message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 573                  message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollectioðŸ”µ</abbr>
 574              } else if (selectize &amp;&amp; type == ListGrid.Type.BASIC) {
<abbr title=" 575                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuration&quot;;"> 575                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuðŸ”µ</abbr>
 576              } else {
 577                  message += &quot; Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 578              }
 579              LOG.error(message);
 580          }
 581  
<abbr title=" 582          ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProperty, sectionCrumbs, sortProperty);"> 582          ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProðŸ”µ</abbr>
 583          listGrid.setSubCollectionFieldName(field.getName());
 584          listGrid.setFriendlyName(field.getMetadata().getFriendlyName());
 585          if (StringUtils.isEmpty(listGrid.getFriendlyName())) {
 586              listGrid.setFriendlyName(field.getName());
 587          }
 588          listGrid.setContainingEntityId(containingEntityId);
 589          listGrid.setIsReadOnly(readOnly);
 590          listGrid.setHideIdColumn(hideIdColumn);
 591          listGrid.setCanFilterAndSort(canFilterAndSort);
 592  
 593          // Set up the filter builder params
 594          Date c = new Date();
 595          String friendlyName = field.getMetadata().getFriendlyName();
 596          String jsonFriendlyName = friendlyName.replaceAll(&quot; &quot;, &quot;_&quot;);
 597          listGrid.setJsonFieldName(jsonFriendlyName + c.getTime() + &quot;Json&quot;);
 598          listGrid.setFriendlyName(friendlyName);
 599          listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 600          if (CollectionUtils.isEmpty(wrapper.getFields())) {
 601              wrapper.setFields(defaultWrapperFields);
 602          }
 603          listGrid.setFieldWrapper(wrapper);
 604  
 605          String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 606          listGrid.setJson(blankJsonString);
 607          DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 608          if (dw != null) {
 609              listGrid.setDataWrapper(dw);
 610          }
 611  
 612          if (editable) {
 613              listGrid.getRowActions().add(DefaultListGridActions.UPDATE);
 614          }
 615          if (readOnly) {
 616              listGrid.getRowActions().add(DefaultListGridActions.VIEW);
 617          }
 618          if (sortable) {
 619              listGrid.setCanFilterAndSort(false);
 620              listGrid.setIsSortable(true);
 621          }
 622  
 623          if (modalSingleSelectable) {
 624              if (readOnly) {
<abbr title=" 625                  listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(true));"> 625                  listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(trðŸ”µ</abbr>
 626              } else {
 627                  listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 628  
 629              }
 630          }
 631          listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 632  
 633          if (selectize) {
 634              listGrid.setSelectizeUrl(buildSelectizeUrl(listGrid));
 635              listGrid.setSelectType(ListGrid.SelectType.SELECTIZE);
 636          }
 637  
 638          if (modalMultiSelectable) {
 639              listGrid.addModalRowAction(DefaultListGridActions.MULTI_SELECT);
 640              listGrid.setSelectType(ListGrid.SelectType.MULTI_SELECT);
 641          }
 642          listGrid.getRowActions().add(DefaultListGridActions.REMOVE);
 643  
 644          if (fmd.getManualFetch()) {
 645              listGrid.setManualFetch(true);
 646              listGrid.getToolbarActions().add(DefaultListGridActions.MANUAL_FETCH);
 647          }
 648          if (isMedia) {
 649              listGrid.setListGridType(ListGrid.Type.ASSET_GRID);
 650          }
 651  
 652          extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 653  
<abbr title=" 654          //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface"> 654          //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the ðŸ”µ</abbr>
 655          if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title=" 656              EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();"> 656              EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvðŸ”µ</abbr>
<abbr title=" 657              for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {"> 657              for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getDatðŸ”µ</abbr>
 658                  for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
 659                      if (modifier.isQualified(data.getModifierType())) {
 660                          modifier.modifyListGrid(new EntityFormModifierRequest()
 661                                  .withListGrid(listGrid)
 662                                  .withConfiguration(data)
 663                                  .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
 664                                  .withRowLevelSecurityService(rowLevelSecurityService));
 665                      }
 666                  }
 667              }
 668          }
 669          return listGrid;
 670      }
 671  
 672      protected String getMapKeyFriendlyName(Property property) {
 673          String friendlyNameFromMetadata = property.getMetadata().getFriendlyName();
 674  
 675          return (friendlyNameFromMetadata == null) ? &quot;Key&quot; : friendlyNameFromMetadata;
 676      }
 677  
 678      @Override
<abbr title=" 679      public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, Property field,"> 679      public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, PropeðŸ”µ</abbr>
 680          String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 681              throws ServiceException {
 682          FieldMetadata fmd = field.getMetadata();
 683          // Get the class metadata for this particular field
 684          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 685          if (field != null) {
 686              ppr.setSectionEntityField(field.getName());
 687          }
 688          ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 689  
 690          Map&lt;String, Object&gt; result = constructSelectizeOptionMap(drs, cmd);
 691  
 692          AdornedTargetList adornedList = ppr.getAdornedList();
 693          if (adornedList != null &amp;&amp; adornedList.getLinkedObjectPath() != null
 694              &amp;&amp; adornedList.getTargetObjectPath() != null &amp;&amp; adornedList.getLinkedIdProperty() != null
 695              &amp;&amp; adornedList.getTargetIdProperty() != null) {
<abbr title=" 696              result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());"> 696              result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperðŸ”µ</abbr>
 697              result.put(&quot;linkedObjectId&quot;, containingEntityId);
<abbr title=" 698              result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());"> 698              result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperðŸ”µ</abbr>
 699          }
 700  
 701          return result;
 702      }
 703  
 704      @Override
 705      public Map&lt;String, Object&gt; constructSelectizeOptionMap(DynamicResultSet drs, ClassMetadata cmd) {
 706          Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
 707          List&lt;Map&lt;String, String&gt;&gt; options = new ArrayList&lt;&gt;();
 708  
 709          List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 710          for (Property p : cmd.getProperties()) {
 711              if (p.getMetadata() instanceof BasicFieldMetadata) {
 712                  BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 713                  if (md.isProminent() != null &amp;&amp; md.isProminent()
 714                          &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 715                      Field hf = createHeaderField(p, md);
 716                      headerFields.add(hf);
 717                  }
 718              }
 719          }
 720  
 721          for (Entity e : drs.getRecords()) {
 722              Map&lt;String, String&gt; selectizeOption = new HashMap&lt;&gt;();
 723              for (Field headerField : headerFields) {
 724                  Property p = e.findProperty(headerField.getName());
 725                  if (p != null) {
 726                      selectizeOption.put(&quot;name&quot;, p.getValue());
 727                      break;
 728                  }
 729              }
 730              if (e.findProperty(&quot;id&quot;) != null) {
 731                  selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;id&quot;).getValue());
 732              //  &quot;Locale&quot; entity is a special occasion. Because it have not &quot;ID&quot; column with &quot;Long&quot; type
 733              } else if (e.findProperty(&quot;localeCode&quot;) != null) {
 734                  selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;localeCode&quot;).getValue());
 735              }
 736              if (e.findProperty(ALTERNATE_ID_PROPERTY) != null) {
 737                  selectizeOption.put(&quot;alternateId&quot;, e.findProperty(ALTERNATE_ID_PROPERTY).getValue());
 738              }
 739              options.add(selectizeOption);
 740          }
 741          result.put(&quot;options&quot;, options);
 742  
 743          return result;
 744      }
 745  
 746      protected String buildSelectizeUrl(ListGrid listGrid) {
 747          HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 748          String url = request.getContextPath();
<abbr title=" 749          url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + listGrid.getSectionKey();"> 749          url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + liðŸ”µ</abbr>
 750          url += &quot;/&quot; + listGrid.getContainingEntityId();
 751          url += &quot;/&quot; + listGrid.getSubCollectionFieldName();
 752          return url;
 753      }
 754  
 755      /**
<abbr title=" 756       * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 756       * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, StriðŸ”µ</abbr>
 757       * @param className
 758       * @param headerFields
 759       * @param type
 760       * @param drs
 761       * @param sectionKey
 762       * @param order
 763       * @param idProperty
 764       * @param sectionCrumbs
 765       * @return
 766       */
 767      @Deprecated
<abbr title=" 768      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 768      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResulðŸ”µ</abbr>
 769              String sectionKey, int order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs) {
 770         return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,null);
 771      }
 772  
 773      /**
 774       * Populate a ListGrid with ListGridRecords.
 775       *
 776       * @param className
 777       * @param headerFields
 778       * @param type
 779       * @param drs
 780       * @param sectionKey
 781       * @param order
 782       * @param idProperty
 783       * @param sectionCrumbs
 784       * @param sortPropery
 785       * @return
 786       */
<abbr title=" 787      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 787      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResulðŸ”µ</abbr>
<abbr title=" 788              String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropery) {"> 788              String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropðŸ”µ</abbr>
 789          // Create the list grid and set some basic attributes
 790          ListGrid listGrid = new ListGrid();
 791          listGrid.setClassName(className);
 792          listGrid.getHeaderFields().addAll(headerFields);
 793          listGrid.setListGridType(type);
 794          listGrid.setSectionCrumbs(sectionCrumbs);
 795          listGrid.setSectionKey(sectionKey);
 796          listGrid.setOrder(order);
 797          listGrid.setIdProperty(idProperty);
 798          listGrid.setStartIndex(drs.getStartIndex());
 799          listGrid.setTotalRecords(drs.getTotalRecords());
 800          listGrid.setPageSize(drs.getPageSize());
 801  
 802          String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
<abbr title=" 803          AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier);"> 803          AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier)ðŸ”µ</abbr>
 804          if (section != null) {
 805              listGrid.setExternalEntitySectionKey(section.getUrl());
 806          }
 807  
 808          // format date list grid cells
 809          SimpleDateFormat formatter = new SimpleDateFormat(&quot;MMM d, y @ hh:mma&quot;);
 810          DateFormatSymbols symbols = new DateFormatSymbols(Locale.getDefault());
 811          symbols.setAmPmStrings(new String[] { &quot;am&quot;, &quot;pm&quot; });
 812          formatter.setDateFormatSymbols(symbols);
 813  
 814          // For each of the entities (rows) in the list grid, we need to build the associated
 815          // ListGridRecord and set the required fields on the record. These fields are the same ones
 816          // that are used for the header fields.
 817          for (Entity e : drs.getRecords()) {
 818              ListGridRecord record = new ListGridRecord();
 819              record.setListGrid(listGrid);
 820              record.setDirty(e.isDirty());
 821              record.setEntity(e);
 822              if (StringUtils.isNotBlank(sortPropery) &amp;&amp; e.findProperty(sortPropery) != null) {
 823                  Property sort = e.findProperty(sortPropery);
 824                  record.setDisplayOrder(sort.getValue());
 825              }
 826              if (e.findProperty(&quot;hasError&quot;) != null) {
 827                  Boolean hasError = Boolean.parseBoolean(e.findProperty(&quot;hasError&quot;).getValue());
 828                  record.setIsError(hasError);
 829                  if (hasError) {
 830                      ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 831                              .getProxy().determineErrorMessageForEntity(e, record);
 832  
 833                      if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 834                          record.setErrorKey(&quot;listgrid.record.error&quot;);
 835                      }
 836                  }
 837              }
 838  
 839              if (e.findProperty(&quot;progressStatus&quot;) != null) {
 840                  ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 841                          .getProxy().determineStatusMessageForEntity(e, record);
 842                  if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 843                      record.setStatus(e.findProperty(&quot;progressStatus&quot;).getValue());
 844                      record.setStatusCssClass(&quot;listgrid.record.status&quot;);
 845                  }
 846              }
 847  
 848              if (e.findProperty(idProperty) != null) {
 849                  record.setId(e.findProperty(idProperty).getValue());
 850              }
 851  
 852              for (Field headerField : headerFields) {
 853                  Property p = e.findProperty(headerField.getName());
 854                  if (p != null) {
 855                      Field recordField = new Field().withName(headerField.getName())
 856                              .withFriendlyName(headerField.getFriendlyName())
 857                              .withOrder(p.getMetadata().getOrder());
 858  
 859                      if (headerField instanceof ComboField) {
 860                          recordField.setValue(((ComboField) headerField).getOption(p.getValue()));
 861                          recordField.setDisplayValue(p.getDisplayValue());
 862                      } else {
 863                          if (headerField.getFieldType().equals(&quot;DATE&quot;)) {
 864                              try {
 865                                  Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue());
 866                                  String newValue = formatter.format(date);
 867                                  recordField.setValue(newValue);
 868                              } catch (Exception ex) {
 869                                  recordField.setValue(p.getValue());
 870                              }
 871                          } else {
 872                              recordField.setValue(p.getValue());
 873                          }
 874                          recordField.setDisplayValue(p.getDisplayValue());
 875                      }
 876  
 877                      recordField.setDerived(isDerivedField(headerField, recordField, p));
 878  
 879                      record.getFields().add(recordField);
 880                  }
 881              }
 882  
 883              if (e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY) != null) {
 884                  Field hiddenField = new Field().withName(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 885                  hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue());
 886                  record.getHiddenFields().add(hiddenField);
 887              }
 888  
 889              if (e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY) != null) {
 890                  record.setAltId(e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY).getValue());
 891              }
 892  
 893              extensionManager.getProxy().modifyListGridRecord(className, record, e);
 894  
 895              listGrid.getRecords().add(record);
 896          }
 897  
 898          if (drs.getFirstId() != null) {
 899              listGrid.setFirstId(drs.getFirstId());
 900          }
 901          if (drs.getLastId() != null) {
 902              listGrid.setLastId(drs.getLastId());
 903          }
 904          if (drs.getUpperCount() != null) {
 905              listGrid.setUpperCount(drs.getUpperCount());
 906          }
 907          if (drs.getLowerCount() != null) {
 908              listGrid.setLowerCount(drs.getLowerCount());
 909          }
 910          if (drs.getFetchType() != null) {
 911              listGrid.setFetchType(drs.getFetchType().toString());
 912          }
 913          if (drs.getTotalCountLessThanPageSize() != null) {
 914              listGrid.setTotalCountLessThanPageSize(drs.getTotalCountLessThanPageSize());
 915          }
 916          if (drs.getPromptSearch() != null) {
 917              listGrid.setPromptSearch(drs.getPromptSearch());
 918          }
 919  
 920          return listGrid;
 921      }
 922  
 923      /**
<abbr title=" 924       * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasicFieldMetadata}"> 924       * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasiðŸ”µ</abbr>
 925       * for the given Property to see if something on the backend has marked it as derived
 926       *
 927       * @param headerField the header for this recordField
 928       * @param recordField the recordField being populated
 929       * @param p the property that relates to this recordField
 930       * @return whether or not this field is derived
<abbr title=" 931       * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 931       * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, SðŸ”µ</abbr>
 932       */
 933      protected Boolean isDerivedField(Field headerField, Field recordField, Property p) {
 934          return BooleanUtils.isTrue(((BasicFieldMetadata) p.getMetadata()).getIsDerived());
 935      }
 936  
 937      protected void setEntityFormFields(ClassMetadata cmd, EntityForm ef, List&lt;Property&gt; properties) {
 938          List&lt;Field&gt; homelessFields = new ArrayList&lt;&gt;();
 939          List&lt;Field&gt; fieldsWithAssociations = new ArrayList&lt;&gt;();
 940  
 941          for (Property property : properties) {
 942              if (property.getMetadata() instanceof BasicFieldMetadata) {
 943                  BasicFieldMetadata fmd = (BasicFieldMetadata) property.getMetadata();
 944  
 945  
 946                  if (!ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
 947                      // Depending on visibility, field for the particular property is not created on the form
 948                      String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 949  
 950                      // Create the field and set some basic attributes
 951                      Field f;
 952  
 953                      if (fieldType.equals(SupportedFieldType.BROADLEAF_ENUMERATION.toString())
 954                              || fieldType.equals(SupportedFieldType.EXPLICIT_ENUMERATION.toString())
 955                              || fieldType.equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION.toString())
 956                              || fieldType.equals(SupportedFieldType.EMPTY_ENUMERATION.toString())) {
<abbr title=" 957                          // We&#x27;re dealing with fields that should render as drop-downs, so set their possible values"> 957                          // We&#x27;re dealing with fields that should render as drop-downs, so set their possible valueðŸ”µ</abbr>
 958                          f = new ComboField();
 959                          ((ComboField) f).setOptions(fmd.getEnumerationValues());
<abbr title=" 960                          if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValue()"> 960                          if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValuðŸ”µ</abbr>
 961                                  &amp;&amp; ((ComboField) f).getOptions().size() == 0) {
 962                              f.setIsVisible(false);
 963                          }
 964                      } else if (fieldType.equals(SupportedFieldType.CODE.toString())) {
 965                          f = new CodeField();
 966                      } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
 967                              || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
 968                              || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
 969                          // We&#x27;re dealing with rule builders, so we&#x27;ll create those specialized fields
 970                          f = new RuleBuilderField();
 971                          ((RuleBuilderField) f).setJsonFieldName(property.getName() + &quot;Json&quot;);
 972                          ((RuleBuilderField) f).setDataWrapper(new DataWrapper());
 973                          ((RuleBuilderField) f).setFieldBuilder(fmd.getRuleIdentifier());
 974                          ((RuleBuilderField) f).setDisplayType(fmd.getDisplayType().toString());
 975  
 976                          String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 977                          ((RuleBuilderField) f).setJson(blankJsonString);
 978                          DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 979                          if (dw != null) {
 980                              ((RuleBuilderField) f).setDataWrapper(dw);
 981                          }
 982  
 983                          if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())) {
 984                              ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple&quot;);
 985                          } else if (fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
 986                              ((RuleBuilderField) f).setRuleType(&quot;rule-builder-with-quantity&quot;);
 987                          } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())) {
 988                              ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple-time&quot;);
 989                          }
 990                      } else if (LookupType.DROPDOWN.equals(fmd.getLookupType())) {
<abbr title=" 991                          // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of in a"> 991                          // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of inðŸ”µ</abbr>
<abbr title=" 992                          // modal, so we&#x27;ll provision the combo field here. Available options will be set as part of a"> 992                          // modal, so we&#x27;ll provision the combo field here. Available options will be set as part oðŸ”µ</abbr>
 993                          // subsequent operation
 994                          f = new ComboField();
 995                      } else if (fieldType.equals(SupportedFieldType.MEDIA.toString())) {
 996                          f = new MediaField();
 997                      } else {
 998                          // Create a default field since there was no specialized handler
 999                          f = new Field();
1000                      }
1001  
1002                      Boolean required = fmd.getRequiredOverride();
1003                      if (required == null) {
1004                          required = fmd.getRequired();
1005                      }
1006  
1007                      Boolean allowNoValueEnum = fmd.getAllowNoValueEnumOption();
1008                      if (allowNoValueEnum != null) {
1009                          f.setAllowNoValueEnumOption(allowNoValueEnum);
1010                      }
1011  
1012                      f.withName(property.getName())
1013                       .withFieldType(fieldType)
1014                       .withFieldComponentRenderer(getFieldComponentRenderer(fmd))
1015                       .withGridFieldComponentRenderer(getGridFieldComponentRenderer(fmd))
1016                       .withOrder(fmd.getOrder())
1017                       .withFriendlyName(fmd.getFriendlyName())
1018                       .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
1019                       .withForeignKeyClass(fmd.getForeignKeyClass())
1020                       .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title="1021                       .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromType())">1021                       .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromTyðŸ”µ</abbr>
1022                       .withRequired(required)
1023                       .withReadOnly(fmd.getReadOnly())
1024                       .withTranslatable(fmd.getTranslatable())
1025                       .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDERING))
1026                       .withLargeEntry(fmd.isLargeEntry())
1027                       .withHint(fmd.getHint())
1028                       .withTooltip(fmd.getTooltip())
1029                       .withHelp(fmd.getHelpText())
1030                       .withTypeaheadEnabled(fmd.getEnableTypeaheadLookup())
1031                       .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity())
1032                       .withAssociatedFieldName(fmd.getAssociatedFieldName());
1033  
1034                      String defaultValue = fmd.getDefaultValue();
1035                      if (defaultValue != null) {
1036                          defaultValue = extractDefaultValueFromFieldData(fieldType, fmd);
1037                          f.withValue(defaultValue);
1038                      }
1039  
1040                      if (StringUtils.isBlank(f.getFriendlyName())) {
1041                          f.setFriendlyName(f.getName());
1042                      }
1043  
1044                      // If is form hidden, set visible to false
1045                      if (VisibilityEnum.FORM_EXPLICITLY_HIDDEN.equals(fmd.getVisibility())) {
1046                          f.setIsVisible(false);
1047                      }
1048  
1049                      if (VisibilityEnum.VISIBLE_ALL.equals(fmd.getVisibility())) {
1050                          f.setIsVisible(true);
1051                      }
1052  
1053                      // Add the field to the appropriate FieldGroup
1054                      if (fmd.getGroup() == null) {
1055                          homelessFields.add(f);
1056                      } else {
1057                          ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabOrder());
1058                      }
1059  
1060                      if (StringUtils.isNotEmpty(fmd.getAssociatedFieldName())) {
1061                          fieldsWithAssociations.add(f);
1062                      }
1063                  }
1064              }
1065          }
1066  
1067          for (Field f : homelessFields) {
1068              ef.addField(cmd, f, null, null, null, null);
1069          }
1070  
1071          for (Field f : fieldsWithAssociations) {
1072              Field associatedField = findAssociatedField(ef, f);
1073              if (associatedField != null) {
1074                  associatedField.setShouldRender(false);
1075                  f.setAssociatedFieldName(associatedField.getName());
1076              } else {
1077                  f.setAssociatedFieldName(null);
1078              }
1079          }
1080      }
1081  
1082      protected String getFieldComponentRenderer(BasicFieldMetadata fmd) {
1083          if (StringUtils.isNotBlank(fmd.getFieldComponentRendererTemplate())) {
1084              return fmd.getFieldComponentRendererTemplate();
1085          }
1086          return fmd.getFieldComponentRenderer()==null?null:fmd.getFieldComponentRenderer().toString();
1087      }
1088  
1089      protected String getGridFieldComponentRenderer(BasicFieldMetadata fmd) {
1090          if (StringUtils.isNotBlank(fmd.getGridFieldComponentRendererTemplate())) {
1091              return fmd.getGridFieldComponentRendererTemplate();
1092          }
1093          return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toString();
1094      }
1095  
1096      private Field findAssociatedField(EntityForm ef, Field f) {
1097          // Try on the parent object
1098          Field associatedField = ef.findField(f.getAssociatedFieldName());
1099  
1100          if (associatedField == null) {
1101              // Check the field&#x27;s path
1102              String[] fieldPathParts = f.getName().split(&quot;\\.&quot;);
1103              String testPath = &quot;&quot;;
1104  
1105              for (String path : fieldPathParts) {
1106                  testPath += path + &quot;.&quot;;
1107  
1108                  associatedField = ef.findField(testPath + f.getAssociatedFieldName());
1109                  if (associatedField != null) {
1110                      break;
1111                  }
1112              }
1113          }
1114          return associatedField;
1115      }
1116  
1117      /**
1118       * This method gets the {@link AdminSection} for the given foreignKeyClass parameter. If none exists,
1119       * it returns the foreignKeyClass.
1120       *
1121       * @param foreignKeyClass the {@link String} class name
1122       * @return the admin section pathname
1123       */
1124      protected String getAdminSectionPath(String foreignKeyClass) {
1125          if (foreignKeyClass != null) {
<abbr title="1126              AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyClass, null);">1126              AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyðŸ”µ</abbr>
1127              return foreignKeySection != null ? foreignKeySection.getUrl() : foreignKeyClass;
1128          }
1129          return null;
1130      }
1131  
1132      /**
<abbr title="1133       * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal to">1133       * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal tðŸ”µ</abbr>
1134       *  the processed value of another tab.
1135       *
1136       * For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a another tab where
1137       *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;,
1138       *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; tabs.
1139       */
1140      protected void setEntityFormTabsAndGroups(EntityForm ef, Map&lt;String, TabMetadata&gt; tabMetadataMap) {
1141          if (tabMetadataMap != null) {
1142              Set&lt;String&gt; tabMetadataKeySet = tabMetadataMap.keySet();
1143              for (String tabKey : tabMetadataKeySet) {
1144                  TabMetadata tabMetadata = tabMetadataMap.get(tabKey);
1145                  String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySet);
1146  
1147                  if (foundMatchingTab(unprocessedTabName)) {
1148                      if (!tabExists(ef, unprocessedTabName)) {
1149                          TabMetadata originalTabMetadata = tabMetadataMap.get(unprocessedTabName);
1150                          unprocessedTabName = ef.addTabFromTabMetadata(originalTabMetadata);
1151                      }
1152                  } else {
1153                      if (tabExists(ef, tabKey)) {
1154                          unprocessedTabName = tabKey;
1155                      } else {
1156                          unprocessedTabName = ef.addTabFromTabMetadata(tabMetadata);
1157                      }
1158                  }
1159  
1160                  Set&lt;String&gt; groupMetadataKeySet = tabMetadata.getGroupMetadata().keySet();
1161                  for (String groupKey : groupMetadataKeySet) {
<abbr title="1162                      ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName);">1162                      ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName)ðŸ”µ</abbr>
1163                  }
1164              }
1165          }
1166      }
1167  
1168      /**
1169       * Search for any other tab on the target entity that has the same display value
1170       *  as the value provided tab name.
1171       *
1172       * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message property.
<abbr title="1173       *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySet">1173       *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySeðŸ”µ</abbr>
1174       *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method should return
1175       *  &quot;Example_Tab&quot; which will end up causing the tabs to merge together.
1176       *
1177       * If a tab with the same display value cannot be found, then we should return null to indicate that there
1178       *  is no matching tab with the same processed tabName value.
1179       */
1180      protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySet) {
1181          for (String tabKey : tabMetadataKeySet) {
1182              String tabName = tabMetadata.getTabName();
1183  
1184              if (processedTabKeyMatchesTabName(tabName, tabKey)) {
1185                  return tabKey;
1186              }
1187          }
1188  
1189          return null;
1190      }
1191  
1192      protected boolean processedTabKeyMatchesTabName(String tabName, String candidateTabKey) {
1193          try {
1194              String processedCandidateTabKey = BLCMessageUtils.getMessage(candidateTabKey);
1195              boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateTabKey);
1196  
1197              return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidateTabKey);
1198          } catch (NoSuchMessageException e) {
1199              LOG.debug(&quot;No such message exists for &quot; + candidateTabKey, e);
1200  
1201              return false;
1202          }
1203      }
1204  
1205      protected boolean foundMatchingTab(String unprocessedTabName) {
1206          return (unprocessedTabName != null);
1207      }
1208  
1209      protected boolean tabExists(EntityForm ef, String tabKey) {
1210          return (ef.findTab(tabKey) != null);
1211      }
1212  
1213      @Override
1214      public String extractDefaultValueFromFieldData(String fieldType, BasicFieldMetadata fmd) {
1215          String defaultValue = fmd.getDefaultValue();
1216          if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1217                  || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1218                  || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1219              return null;
1220          } else if (fieldType.equals(SupportedFieldType.INTEGER.toString())) {
1221              try {
1222                  Integer.parseInt(defaultValue);
1223              } catch (NumberFormatException  e) {
1224                  String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defaultValue);
1225                  LOG.debug(msg);
1226                  return null;
1227              }
1228          } else if (fieldType.equals(SupportedFieldType.DECIMAL.toString())
1229                  || fieldType.equals(SupportedFieldType.MONEY.toString())) {
1230              try {
1231                  BigDecimal val = new BigDecimal(defaultValue);
1232              } catch (NumberFormatException  e) {
1233                  String msg = buildMsgForDefValException(fieldType.toString(), fmd, defaultValue);
1234                  LOG.debug(msg);
1235                  return null;
1236              }
1237          } else if (fieldType.equals(SupportedFieldType.BOOLEAN.toString())) {
1238              if (!defaultValue.toLowerCase().equals(&quot;true&quot;) &amp;&amp; !defaultValue.toLowerCase().equals(&quot;false&quot;)
1239                      &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)) {
1240                  String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defaultValue);
1241                  LOG.debug(msg);
1242                  return null;
1243              }
1244          } else if (fieldType.equals(SupportedFieldType.DATE.toString())) {
1245              DateFormat format = FormatUtil.getDateFormat();
1246              if (defaultValue.toLowerCase().contains(&quot;today&quot;)) {
1247                  defaultValue = format.format(new Date());
1248              } else {
1249                  try {
1250                      Date date = format.parse(defaultValue);
1251                      defaultValue = format.format(date);
1252                  } catch (ParseException e) {
<abbr title="1253                      String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue);">1253                      String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue)ðŸ”µ</abbr>
1254                      LOG.debug(msg);
1255                      return null;
1256                  }
1257              }
1258          }
1259          return defaultValue;
1260      }
1261  
1262      protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue) {
<abbr title="1263          return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - Failed to parse &quot;">1263          return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - FailedðŸ”µ</abbr>
1264                  + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue) + &quot; ]&quot;;
1265      }
1266  
1267      @Override
1268      public void removeNonApplicableFields(ClassMetadata cmd, EntityForm entityForm, String entityType) {
1269          for (Property p : cmd.getProperties()) {
1270              if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entityType)) {
1271                  entityForm.removeField(p.getName());
1272              }
1273          }
1274      }
1275  
1276      @Override
1277      public EntityForm createEntityForm(ClassMetadata cmd, List&lt;SectionCrumb&gt; sectionCrumbs)
1278              throws ServiceException {
1279          EntityForm ef = createStandardEntityForm();
1280          populateEntityForm(cmd, ef, sectionCrumbs);
1281          return ef;
1282      }
1283  
1284      protected String extractSectionIdentifierFromCrumb(List&lt;SectionCrumb&gt; sectionCrumbs) {
1285          if (sectionCrumbs != null &amp;&amp; sectionCrumbs.size() &gt; 0) {
1286              return sectionCrumbs.get(0).getSectionIdentifier();
1287          } else {
1288              return null;
1289          }
1290      }
1291  
1292      @Override
1293      public void populateEntityForm(ClassMetadata cmd, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)
1294              throws ServiceException {
1295          ef.setCeilingEntityClassname(cmd.getCeilingType());
1296  
1297          String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
1298  
1299          AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType(),
1300                  sectionIdentifier);
1301          if (section != null) {
1302              ef.setSectionKey(section.getUrl());
1303          } else {
1304              ef.setSectionKey(cmd.getCeilingType());
1305          }
1306          ef.setSectionCrumbsImpl(sectionCrumbs);
1307  
1308          setEntityFormTabsAndGroups(ef, cmd.getTabAndGroupMetadata());
1309  
1310          setEntityFormFields(cmd, ef, Arrays.asList(cmd.getProperties()));
1311  
1312          populateDropdownToOneFields(ef, cmd);
1313  
1314          extensionManager.getProxy().modifyUnpopulatedEntityForm(ef);
1315      }
1316  
1317      /**
1318       * This method is invoked when EntityForms are created and is meant to provide a hook to add
1319       * additional entity form actions for implementors of Broadleaf. Broadleaf modules will typically
1320       * leverage {@link FormBuilderExtensionHandler#addAdditionalFormActions(EntityForm)} method.
1321       * @param ef
1322       */
1323      protected void addAdditionalFormActions(EntityForm ef) {
1324  
1325      }
1326  
1327      @Override
1328      public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbs)
1329              throws ServiceException {
1330          EntityForm ef = createStandardEntityForm();
1331          populateEntityForm(cmd, entity, ef, sectionCrumbs);
1332          addAdditionalFormActions(ef);
1333          extensionManager.getProxy().addAdditionalFormActions(ef);
1334          return ef;
1335      }
1336  
1337      @Override
<abbr title="1338      public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1338      public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumðŸ”µ</abbr>
1339              throws ServiceException {
1340          // Get the empty form with appropriate fields
1341          populateEntityForm(cmd, ef, sectionCrumbs);
1342  
1343          String idProperty = adminEntityService.getIdProperty(cmd);
1344          ef.setId(entity.findProperty(idProperty).getValue());
1345          ef.setEntityType(entity.getType()[0]);
1346  
1347          populateEntityFormFieldValues(cmd, entity, ef);
1348  
1349          Property p = entity.findProperty(BasicPersistenceModule.MAIN_ENTITY_NAME_PROPERTY);
1350          if (p != null) {
1351              ef.setMainEntityName(p.getValue());
1352          }
1353  
1354          extensionManager.getProxy().modifyPopulatedEntityForm(ef, entity);
1355      }
1356  
1357      protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef) {
1358          for (Property p : cmd.getProperties()) {
1359              FieldMetadata fmd = p.getMetadata();
1360  
1361              if (shouldHideField(fmd, entity)) {
1362                  if (fmd instanceof CollectionMetadata) {
1363                      ef.removeListGrid(p.getName());
1364                  } else {
1365                      ef.removeField(p.getName());
1366                  }
1367              }
1368          }
1369      }
1370  
1371      protected boolean shouldHideField(FieldMetadata fmd, Entity entity) {
1372          if (fmd == null || fmd.getShowIfFieldEquals() == null) {
1373              return false;
1374          }
1375  
1376          for (String property : fmd.getShowIfFieldEquals().keySet()) {
1377              List&lt;String&gt; values = fmd.getShowIfFieldEquals().get(property);
1378              Property entityProp = entity.findProperty(property);
1379  
1380              if (entityProp == null || values.contains(entityProp.getValue())) {
1381                  return false;
1382              }
1383          }
1384          return true;
1385      }
1386  
1387      @Override
1388      public void populateEntityFormFieldValues(ClassMetadata cmd, Entity entity, EntityForm ef) {
1389          // Set the appropriate property values
1390          for (Property p : cmd.getProperties()) {
1391              if (p.getMetadata() instanceof BasicFieldMetadata) {
1392                  BasicFieldMetadata basicFM = (BasicFieldMetadata) p.getMetadata();
1393  
1394                  Property entityProp = entity.findProperty(p.getName());
1395  
1396                  boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibility());
1397                  //always show special map fields
1398                  if (p.getName().equals(&quot;key&quot;) || p.getName().equals(&quot;priorKey&quot;)) {
1399                      explicitlyShown = true;
1400                  }
1401  
1402                  if (entityProp == null &amp;&amp; explicitlyShown) {
1403                      Field field = ef.findField(p.getName());
1404                      if (field != null) {
1405                          field.setValue(null);
1406                      }
<abbr title="1407                  } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1407                  } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFiðŸ”µ</abbr>
1408                      ef.removeField(p.getName());
1409                  } else {
1410                      Field field = ef.findField(p.getName());
1411                      if (field != null) {
1412                          if (entityProp != null) {
<abbr title="1413                              //protect against null - can happen with password confirmation fields (i.e. admin user)">1413                              //protect against null - can happen with password confirmation fields (i.e. admin userðŸ”µ</abbr>
1414                              field.setDirty(entityProp.getIsDirty());
1415                          }
1416                          if (basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE
1417                                  || basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE_TIME
1418                                  || basicFM.getFieldType()==SupportedFieldType.RULE_WITH_QUANTITY) {
1419                              RuleBuilderField rbf = (RuleBuilderField) field;
1420                              if (entity.getPMap().containsKey(rbf.getJsonFieldName())) {
1421                                  String json = entity.getPMap().get(rbf.getJsonFieldName()).getValue();
1422                                  rbf.setJson(json);
1423                                  DataWrapper dw = convertJsonToDataWrapper(json);
1424                                  if (dw != null) {
1425                                      rbf.setDataWrapper(dw);
1426                                  }
1427                              }
1428                          }
1429                          if (basicFM.getFieldType() == SupportedFieldType.MEDIA) {
1430                              field.setValue(entityProp.getValue());
1431                              field.setDisplayValue(entityProp.getDisplayValue());
1432                              MediaField mf = (MediaField) field;
<abbr title="1433                              Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(), MediaDto.class);">1433                              Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(),ðŸ”µ</abbr>
<abbr title="1434                              mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(), type));">1434                              mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(),ðŸ”µ</abbr>
1435                          } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {
1436                              field.setValue(entityProp.getValue());
1437                              field.setDisplayValue(entityProp.getDisplayValue());
1438                          }
1439                      }
1440                  }
1441              }
1442          }
1443      }
1444  
1445      /**
1446       * When using Thymeleaf, we need to convert the JSON string back to
1447       * a DataWrapper object because Thymeleaf escapes JSON strings.
1448       * Thymeleaf uses it&#x27;s own object de-serializer
1449       * see: https://github.com/thymeleaf/thymeleaf/issues/84
1450       * see: http://forum.thymeleaf.org/Spring-Javascript-and-escaped-JSON-td4024739.html
1451       * @param json
1452       * @return DataWrapper
1453       * @throws IOException
1454       */
1455      protected DataWrapper convertJsonToDataWrapper(String json) {
1456          ObjectMapper mapper = new ObjectMapper();
1457          DataDTODeserializer dtoDeserializer = new DataDTODeserializer();
<abbr title="1458          SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null));">1458          SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null)ðŸ”µ</abbr>
1459          module.addDeserializer(DataDTO.class, dtoDeserializer);
1460          mapper.registerModule(module);
1461          try {
1462              return mapper.readValue(json, DataWrapper.class);
1463          } catch (IOException e) {
1464              throw new RuntimeException(e);
1465          }
1466      }
1467  
1468      protected void populateDropdownToOneFields(EntityForm ef, ClassMetadata cmd)
1469              throws ServiceException {
1470          for (Property p : cmd.getProperties()) {
1471              if (p.getMetadata() instanceof BasicFieldMetadata) {
1472                  BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
1473                  if (LookupType.DROPDOWN.equals(fmd.getLookupType())
1474                          &amp;&amp; !ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
1475                      // Get the records
1476                      PersistencePackageRequest toOnePpr = PersistencePackageRequest.standard()
1477                              .withCeilingEntityClassname(fmd.getForeignKeyClass());
1478                      Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecords();
1479  
1480                      // Determine the id field
1481                      String idProp = null;
<abbr title="1482                      ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSet().getClassMetaData();">1482                      ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSðŸ”µ</abbr>
1483                      for (Property foreignP : foreignClassMd.getProperties()) {
1484                          if (foreignP.getMetadata() instanceof BasicFieldMetadata) {
1485                              BasicFieldMetadata foreignFmd = (BasicFieldMetadata) foreignP.getMetadata();
1486                              if (SupportedFieldType.ID.equals(foreignFmd.getFieldType())) {
1487                                  idProp = foreignP.getName();
1488                              }
1489                          }
1490                      }
1491  
1492                      if (idProp == null) {
<abbr title="1493                          throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClass());">1493                          throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClassðŸ”µ</abbr>
1494                      }
1495  
1496                      // Determine the display field
1497                      String displayProp = fmd.getLookupDisplayProperty();
1498  
1499                      // Build the options map
1500                      Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
1501                      for (Entity row : rows) {
1502                          Property prop = row.findProperty(displayProp);
1503                          if (prop == null) {
<abbr title="1504                              LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entity [&quot; +">1504                              LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entðŸ”µ</abbr>
1505                                      ef.getCeilingEntityClassname() + &quot;]&quot;);
1506                          } else {
1507                              String displayValue = prop.getDisplayValue();
1508                              if (StringUtils.isBlank(displayValue)) {
1509                                  displayValue = prop.getValue();
1510                              }
1511                              options.put(row.findProperty(idProp).getValue(), displayValue);
1512                          }
1513                      }
1514  
1515                      // Set the options on the entity field
1516                      ComboField cf = (ComboField) ef.findField(p.getName());
1517                      cf.setOptions(options);
1518                  }
1519              }
1520          }
1521      }
1522  
1523      @Override
<abbr title="1524      public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, List&lt;SectionCrumb&gt; sectionCrumbs)">1524      public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRðŸ”µ</abbr>
1525              throws ServiceException {
1526          EntityForm ef = createStandardEntityForm();
1527          populateEntityForm(cmd, entity, collectionRecords, ef, sectionCrumbs);
1528          addAdditionalFormActions(ef);
1529          extensionManager.getProxy().addAdditionalFormActions(ef);
1530          return ef;
1531      }
1532  
1533      @Override
<abbr title="1534      public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1534      public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecorðŸ”µ</abbr>
1535              throws ServiceException {
1536          // Get the form with values for this entity
1537          populateEntityForm(cmd, entity, ef, sectionCrumbs);
1538  
1539          // Attach the sub-collection list grids and specialty UI support
1540          for (Property p : cmd.getProperties()) {
1541              if (p.getMetadata() instanceof BasicFieldMetadata) {
1542                  continue;
1543              }
1544  
1545              if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entity.getType()[0])) {
1546                  continue;
1547              }
1548  
1549              if (collectionRecords != null &amp;&amp; !collectionRecords.isEmpty()) {
1550                  DynamicResultSet subCollectionEntities = collectionRecords.get(p.getName());
1551                  String containingEntityId = entity.getPMap().get(ef.getIdProperty()).getValue();
<abbr title="1552                  ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSectionKey(), sectionCrumbs);">1552                  ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSeðŸ”µ</abbr>
1553  
1554                  CollectionMetadata md = ((CollectionMetadata) p.getMetadata());
1555                  if (md instanceof BasicCollectionMetadata) {
1556                      PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1557                      ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1557                      ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().gðŸ”µ</abbr>
1558                      if (collectionCmd.getPolymorphicEntities().getChildren().length != 0) {
<abbr title="1559                          List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTrees();">1559                          List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTreeðŸ”µ</abbr>
1560                          ListGridActionGroup actionGroup = new ListGridActionGroup().withName(&quot;Add&quot;);
1561                          for (ClassTree entityType : entityTypes) {
1562                              ListGridAction ADD = new ListGridAction(ListGridAction.ADD)
1563                                      .withButtonClass(AddMethodType.PERSIST_EMPTY==
<abbr title="1564                                              ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-grid-add-empty&quot;:&quot;sub-list-grid-add&quot;)">1564                                              ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-grid-add-eðŸ”µ</abbr>
1565                                      .withActionTargetEntity(entityType.getFullyQualifiedClassname())
1566                                      .withUrlPostfix(&quot;/add&quot;)
1567                                      .withIconClass(&quot;fa fa-plus&quot;)
1568                                      .withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyName()));
1569                              actionGroup.getListGridActions().add(0, ADD);
1570                          }
1571                          listGrid.addToolbarActionGroup(actionGroup);
1572                      } else {
1573                          listGrid.getToolbarActions().add(0, AddMethodType.PERSIST_EMPTY==
<abbr title="1574                                  ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ADD_EMPTY:DefaultListGridActions.ADD);">1574                                  ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ADD_EMPTYðŸ”µ</abbr>
1575                      }
1576                  } else {
1577                      listGrid.getToolbarActions().add(0, DefaultListGridActions.ADD);
1578                  }
1579  
1580                  if (subCollectionEntities.getUnselectedTabMetadata().get(md.getTab())!=null) {
1581                      ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), true);
1582                  } else {
1583                      ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), false);
1584                  }
1585              }
1586          }
1587  
1588          if (CollectionUtils.isEmpty(ef.getActions())) {
1589              ef.addAction(DefaultEntityFormActions.SAVE);
1590          }
1591  
1592          addDeleteActionIfAllowed(ef, cmd, entity);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1593 +        addDuplicateActionIfAllowed(ef, cmd);</span>
1594          setReadOnlyState(ef, cmd, entity);
1595  
1596          // check for fields that should be hidden based on annotations
1597          setVisibilityBasedOnShowIfFieldEquals(cmd, entity, ef);
1598  
1599          extensionManager.getProxy().modifyDetailEntityForm(ef);
1600      }
1601  
1602      /**
<abbr title="1603       * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The user can">1603       * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The usðŸ”µ</abbr>
1604       * delete an entity for the following cases:
1605       * &lt;ol&gt;
1606       *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represented by
1607       *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;
1608       *  &lt;li&gt;The user has the security necessary to delete the given &lt;b&gt;entity&lt;/b&gt; according to the
1609       *  {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}&lt;/li&gt;
1610       * &lt;/ol&gt;
1611       *
1612       * @param entityForm the form being generated
1613       * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1614       * @param entity the entity being edited
1615       * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1616       * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1617       * @see {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}
1618       */
1619      protected void addDeleteActionIfAllowed(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1620 -        boolean canDelete = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1621 +        if (isDeletionAllowed(entityForm, cmd, entity)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1622 +            entityForm.addAction(DefaultEntityFormActions.DELETE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1623 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1624 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1625 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1626 +    protected boolean isDeletionAllowed(final EntityForm entityForm, final ClassMetadata cmd,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1627 +            final Entity entity) {</span>
1628          try {
1629              String securityEntityClassname = getSecurityClassname(entityForm, cmd);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1630 -            adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.REMOVE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1631 +            adminRemoteSecurityService</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1632 +                    .securityCheck(securityEntityClassname, EntityOperationType.REMOVE);</span>
1633          } catch (ServiceException e) {
1634              if (e instanceof SecurityServiceException) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1635 -                canDelete = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1636 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1637 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1638 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1639 -        // If I cannot update a record then I certainly cannot delete it either</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1640 -        if (canDelete) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1641 -            canDelete = rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1641 -            canDelete = rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1642 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1643 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1644 -        if (canDelete) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1645 -            canDelete = rowLevelSecurityService.canRemove(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1645 -            canDelete = rowLevelSecurityService.canRemove(adminRemoteSecurityService.getPersistentAdminUser(), entðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1646 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1647 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1648 -        if (canDelete) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1649 -            entityForm.addAction(DefaultEntityFormActions.DELETE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1650 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1651 +                return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1652 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1653 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1654 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1655 +        final AdminUser persistentAdminUser = adminRemoteSecurityService.getPersistentAdminUser();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1656 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1657 +        return rowLevelSecurityService.canUpdate(persistentAdminUser, entity)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1658 +                &amp;&amp; rowLevelSecurityService.canRemove(persistentAdminUser, entity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1659 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1660 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1661 +    protected void addDuplicateActionIfAllowed(final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1662 +            final ClassMetadata cmd) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1663 +        if (isDuplicationAllowed(entityForm, cmd)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1664 +            entityForm.addAction(DefaultEntityFormActions.DUPLICATE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1665 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1666 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1667 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1668 +    protected boolean isDuplicationAllowed(final EntityForm entityForm, final ClassMetadata cmd) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1669 +        final String securityClassname = getSecurityClassname(entityForm, cmd);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1670 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1671 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1672 +            adminRemoteSecurityService.securityCheck(securityClassname, EntityOperationType.ADD);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1673 +        } catch (ServiceException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1674 +            if (e instanceof SecurityServiceException) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1675 +                return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1676 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1677 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1678 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1679 +        final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(securityClassname);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1680 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1681 +        return duplicator.validate(entityClass, Long.valueOf(entityForm.getId())) &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1682 +                rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1683 +                        securityClassname, cmd);</span>
1684      }
1685  
1686      /**
1687       * The given &lt;b&gt;entityForm&lt;/b&gt; is marked as readonly for the following cases:
1688       * &lt;ol&gt;
1689       *  &lt;li&gt;All of the properties from &lt;b&gt;cmd&lt;/b&gt; are readonly&lt;/b&gt;&lt;/li&gt;
<abbr title="1690       *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represented by">1690       *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represeðŸ”µ</abbr>
1691       *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;
1692       *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to the
1693       *  {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}&lt;/li&gt;
1694       * &lt;/ol&gt;
1695       *
1696       * @param entityForm the form being generated
1697       * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1698       * @param entity the entity being edited
1699       * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1700       * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1701       * @see {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}
1702       */
1703      protected void setReadOnlyState(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1704          boolean readOnly = true;
1705  
1706          // If all of the fields are read only, we&#x27;ll mark the form as such
1707          for (Property property : cmd.getProperties()) {
1708              FieldMetadata fieldMetadata = property.getMetadata();
1709              if (fieldMetadata instanceof BasicFieldMetadata) {
<abbr title="1710                  readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieldMetadata).getReadOnly();">1710                  readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieðŸ”µ</abbr>
1711                  if (!readOnly) {
1712                      break;
1713                  }
1714              } else {
1715                  readOnly = ((CollectionMetadata) fieldMetadata).isMutable();
1716                  if (!readOnly) {
1717                      break;
1718                  }
1719              }
1720          }
1721  
1722          if (!readOnly) {
<abbr title="1723              // If the user does not have edit permissions, we will go ahead and make the form read only to prevent confusion">1723              // If the user does not have edit permissions, we will go ahead and make the form read only to preventðŸ”µ</abbr>
1724              try {
1725                  String securityEntityClassname = getSecurityClassname(entityForm, cmd);
1726                  adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDATE);
1727              } catch (ServiceException e) {
1728                  if (e instanceof SecurityServiceException) {
1729                      readOnly = true;
1730                  }
1731              }
1732          }
1733  
<abbr title="1734          // if the normal admin security service has not deemed this readonly and the all of the properties on the entity">1734          // if the normal admin security service has not deemed this readonly and the all of the properties on the ðŸ”µ</abbr>
1735          // are not readonly, then check the row-level security
1736          if (!readOnly) {
<abbr title="1737              readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1737              readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entðŸ”µ</abbr>
1738          }
1739  
1740          if (readOnly) {
1741              entityForm.setReadOnly();
<abbr title="1742              //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface">1742              //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements ðŸ”µ</abbr>
1743              if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title="1744                  EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();">1744                  EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityðŸ”µ</abbr>
<abbr title="1745                  for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {">1745                  for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.geðŸ”µ</abbr>
1746                      for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
1747                          if (modifier.isQualified(data.getModifierType())) {
1748                              modifier.modifyEntityForm(new EntityFormModifierRequest()
1749                                      .withEntityForm(entityForm)
1750                                      .withConfiguration(data)
1751                                      .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
1752                                      .withEntity(entity)
1753                                      .withRowLevelSecurityService(rowLevelSecurityService));
1754                          }
1755                      }
1756                  }
1757              }
1758          }
1759      }
1760  
1761      /**
1762       * Obtains the class name suitable for passing along to the {@link SecurityVerifier}
1763       * @param entityForm
1764       * @param cmd
1765       * @return
1766       */
1767      protected String getSecurityClassname(EntityForm entityForm, ClassMetadata cmd) {
1768          String securityEntityClassname = entityForm.getCeilingEntityClassname();
1769  
1770          if (!StringUtils.isEmpty(cmd.getSecurityCeilingType())) {
1771              securityEntityClassname = cmd.getSecurityCeilingType();
1772          } else {
1773              if (entityForm.getDynamicFormInfos() != null) {
1774                  for (DynamicEntityFormInfo info : entityForm.getDynamicFormInfos().values()) {
1775                      if (!StringUtils.isEmpty(info.getSecurityCeilingClassName())) {
1776                          securityEntityClassname = info.getSecurityCeilingClassName();
1777                          break;
1778                      }
1779                  }
1780              }
1781          }
1782  
1783          return securityEntityClassname;
1784      }
1785  
1786      @Override
1787      public void populateEntityFormFields(EntityForm ef, Entity entity) {
1788          populateEntityFormFields(ef, entity, true, true);
1789      }
1790  
1791      @Override
1792      public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean populateId) {
1793          if (populateId) {
1794              ef.setId(entity.findProperty(ef.getIdProperty()).getValue());
1795          }
1796          if (populateType) {
1797              ef.setEntityType(entity.getType()[0]);
1798          }
1799  
1800          for (Entry&lt;String, Field&gt; entry : ef.getFields().entrySet()) {
1801              Property entityProp = entity.findProperty(entry.getKey());
1802              if (entityProp != null) {
1803                  entry.getValue().setValue(entityProp.getValue());
1804                  entry.getValue().setDisplayValue(entityProp.getDisplayValue());
1805              }
1806          }
1807      }
1808  
1809      @Override
1810      public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedList) {
1811          Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());
1812          Property entityProp = entity.findProperty(ef.getIdProperty());
1813          field.setValue(entityProp.getValue());
1814  
1815          if (StringUtils.isNotBlank(adornedList.getSortField())) {
1816              field = ef.findField(adornedList.getSortField());
1817              entityProp = entity.findProperty(adornedList.getSortField());
1818              if (field != null &amp;&amp; entityProp != null) {
1819                  field.setValue(entityProp.getValue());
1820              }
1821          }
1822      }
1823  
1824      @Override
1825      public void populateMapEntityFormFields(EntityForm ef, Entity entity) {
1826          Field field = ef.findField(&quot;priorKey&quot;);
1827          Property entityProp = entity.findProperty(&quot;key&quot;);
1828          if (field != null &amp;&amp; entityProp != null) {
1829              field.setValue(entityProp.getValue());
1830          }
1831      }
1832  
1833      @Override
<abbr title="1834      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1834      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedLisðŸ”µ</abbr>
1835              String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)
1836              throws ServiceException {
1837          EntityForm ef = createStandardAdornedEntityForm();
<abbr title="1838          return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAdd);">1838          return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAðŸ”µ</abbr>
1839      }
1840  
1841      @Override
<abbr title="1842      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1842      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedLisðŸ”µ</abbr>
<abbr title="1843              String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1843              String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, booleaðŸ”µ</abbr>
1844              throws ServiceException {
1845          ef.setEntityType(adornedList.getAdornedTargetEntityClassname());
1846  
1847          // Get the metadata for this adorned field
1848          PersistencePackageRequest request = PersistencePackageRequest.adorned()
1849                  .withCeilingEntityClassname(adornedMd.getCollectionCeilingEntity())
1850                  .withAdornedList(adornedList)
1851                  .withSectionCrumbs(sectionCrumbs);
1852          request.setAddOperationInspect(isAdd);
<abbr title="1853          ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getClassMetaData();">1853          ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getCðŸ”µ</abbr>
1854  
1855          List&lt;Property&gt; entityFormProperties = new ArrayList&lt;&gt;();
1856          if (isViewCollectionItem) {
1857              Collections.addAll(entityFormProperties, collectionMetadata.getProperties());
1858          } else {
1859              // We want our entity form to only render the maintained adorned target fields
1860              for (String targetFieldName : adornedMd.getMaintainedAdornedTargetFields()) {
1861                  Property p = collectionMetadata.getPMap().get(targetFieldName);
<abbr title="1862                  if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExcluded())) {">1862                  if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExðŸ”µ</abbr>
1863                      ((BasicFieldMetadata) p.getMetadata()).setVisibility(VisibilityEnum.VISIBLE_ALL);
1864                      entityFormProperties.add(p);
1865                  }
1866              }
1867          }
1868  
1869          // Set the maintained fields on the form
1870          setEntityFormFields(collectionMetadata, ef, entityFormProperties);
1871  
1872          // Add these two additional hidden fields that are required for persistence
1873          Field f = new Field()
1874                  .withName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty())
1875                  .withFieldType(SupportedFieldType.HIDDEN.toString())
1876                  .withValue(parentId);
1877          ef.addHiddenField(collectionMetadata, f);
1878  
1879          f = new Field()
1880                  .withName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty())
1881                  .withFieldType(SupportedFieldType.HIDDEN.toString())
1882                  .withIdOverride(&quot;adornedTargetIdProperty&quot;);
1883          ef.addHiddenField(collectionMetadata, f);
1884  
1885          if (StringUtils.isNotBlank(adornedList.getSortField())) {
1886              f = new Field()
1887                      .withName(adornedList.getSortField())
1888                      .withFieldType(SupportedFieldType.HIDDEN.toString());
1889              ef.addHiddenField(collectionMetadata, f);
1890          }
1891  
1892          ef.setParentId(parentId);
1893  
1894          extensionManager.getProxy().addAdditionalAdornedFormActions(ef);
1895  
1896          return ef;
1897      }
1898  
1899  
1900      @Override
<abbr title="1901      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId)">1901      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String pðŸ”µ</abbr>
1902              throws ServiceException {
1903          EntityForm ef = createStandardEntityForm();
1904          return buildMapForm(mapMd, mapStructure, cmd, parentId, ef);
1905      }
1906  
1907      @Override
<abbr title="1908      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId, EntityForm ef)">1908      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String pðŸ”µ</abbr>
1909              throws ServiceException {
1910          ForeignKey foreignKey = (ForeignKey) mapMd.getPersistencePerspective()
1911                  .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY);
1912          ef.setEntityType(foreignKey.getForeignKeyClass());
1913  
1914          Field keyField;
1915          if (!mapMd.getForceFreeFormKeys()) {
1916              // We will use a combo field to render the key choices
1917              ComboField temp = new ComboField();
1918              temp.withName(&quot;key&quot;)
1919                      .withFieldType(&quot;combo_field&quot;)
1920                      .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1921              if (mapMd.getKeys() != null) {
1922                  // The keys can be explicitly set in the annotation...
1923                  temp.setOptions(mapMd.getKeys());
1924              } else {
1925                  // Or they could be based on a different entity
1926                  PersistencePackageRequest ppr = PersistencePackageRequest.standard()
1927                          .withCeilingEntityClassname(mapMd.getMapKeyOptionEntityClass());
1928  
1929                  DynamicResultSet drs = adminEntityService.getRecords(ppr).getDynamicResultSet();
1930  
1931                  for (Entity entity : drs.getRecords()) {
1932                      String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getValue();
<abbr title="1933                      String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getValue();">1933                      String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getVaðŸ”µ</abbr>
1934                      temp.putOption(keyValue, keyDisplayValue);
1935                  }
1936              }
1937              keyField = temp;
1938          } else {
1939              keyField = new Field().withName(&quot;key&quot;)
1940                                  .withFieldType(SupportedFieldType.STRING.toString())
1941                                  .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1942          }
1943          keyField.setRequired(true);
1944          ef.addMapKeyField(cmd, keyField);
1945  
1946          // Set the fields for this form
1947          List&lt;Property&gt; mapFormProperties;
1948          if (mapMd.isSimpleValue()) {
1949              ef.setIdProperty(&quot;key&quot;);
1950              mapFormProperties = new ArrayList&lt;&gt;();
1951              Property valueProp = cmd.getPMap().get(&quot;value&quot;);
1952              mapFormProperties.add(valueProp);
1953          } else {
1954              String valueClassName = mapStructure.getValueClassName();
1955              List&lt;String&gt; classNames = getValueClassNames(valueClassName);
1956  
1957              mapFormProperties = new ArrayList&lt;&gt;(Arrays.asList(cmd.getProperties()));
1958              filterMapFormProperties(mapFormProperties, classNames);
1959          }
1960  
1961          setEntityFormFields(cmd, ef, mapFormProperties);
1962  
1963          Field f = new Field()
1964                  .withName(&quot;priorKey&quot;)
1965                  .withFieldType(SupportedFieldType.HIDDEN.toString());
1966          ef.addHiddenField(cmd, f);
1967  
1968          ef.setParentId(parentId);
1969  
1970          return ef;
1971      }
1972  
1973      protected List&lt;String&gt; getValueClassNames(String valueClassName) {
1974          PersistenceManager pm = PersistenceManagerFactory.getPersistenceManager(valueClassName);
1975          List&lt;String&gt; classNames = new ArrayList&lt;&gt;();
1976          try {
1977              Class&lt;?&gt;[] mapEntities = pm.getPolymorphicEntities(valueClassName);
1978              for (Class clazz : mapEntities) {
1979                  classNames.add(clazz.getName());
1980              }
1981          } catch (ClassNotFoundException e) {
1982              classNames.add(valueClassName);
1983          }
1984          return classNames;
1985      }
1986  
1987      protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNames) {
1988          CollectionUtils.filter(mapFormProperties, new Predicate() {
1989              @Override
1990              public boolean evaluate(Object object) {
1991                  Property p = (Property) object;
1992                  for (String availType : p.getMetadata().getAvailableToTypes()) {
1993                      if (classNames.contains(availType)) {
1994                          return true;
1995                      }
1996                  }
1997                  return false;
1998              }
1999          });
2000      }
2001  
2002      protected EntityForm createStandardEntityForm() {
2003          EntityForm ef = new EntityForm();
2004          ef.addAction(DefaultEntityFormActions.SAVE);
2005          return ef;
2006      }
2007  
2008      protected EntityForm createStandardAdornedEntityForm() {
2009          EntityForm ef = new EntityForm();
2010          ef.addAction(DefaultAdornedEntityFormActions.Add);
2011          return ef;
2012      }
2013  
2014      protected VisibilityEnum[] getGridHiddenVisibilities() {
2015          return FormBuilderServiceImpl.GRID_HIDDEN_VISIBILITIES;
2016      }
2017  
2018      protected VisibilityEnum[] getFormHiddenVisibilities() {
2019          return FormBuilderServiceImpl.FORM_HIDDEN_VISIBILITIES;
2020      }
2021  
2022  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.web.service;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.Predicate;
  22  import org.apache.commons.lang.ArrayUtils;
  23  import org.apache.commons.lang.BooleanUtils;
  24  import org.apache.commons.lang3.StringUtils;
  25  import org.apache.commons.logging.Log;
  26  import org.apache.commons.logging.LogFactory;
  27  import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  28  import org.broadleafcommerce.common.exception.ExceptionHelper;
  29  import org.broadleafcommerce.common.exception.SecurityServiceException;
  30  import org.broadleafcommerce.common.exception.ServiceException;
  31  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.broadleafcommerce.common.i18n.service.TranslationService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  34 +import org.broadleafcommerce.common.locale.service.LocaleService;</span>
  35  import org.broadleafcommerce.common.media.domain.MediaDto;
  36  import org.broadleafcommerce.common.persistence.EntityConfiguration;

  37  import org.broadleafcommerce.common.presentation.client.AddMethodType;
  38  import org.broadleafcommerce.common.presentation.client.AdornedTargetAddMethodType;
  39  import org.broadleafcommerce.common.presentation.client.LookupType;
  40  import org.broadleafcommerce.common.presentation.client.PersistencePerspectiveItemType;
  41  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  42  import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  43  import org.broadleafcommerce.common.util.BLCMessageUtils;
  44  import org.broadleafcommerce.common.util.FormatUtil;
  45  import org.broadleafcommerce.common.util.StringUtil;
  46  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  47  import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  48  import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  49  import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  50  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  51  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  52  import org.broadleafcommerce.openadmin.dto.ClassTree;
  53  import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  54  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  55  import org.broadleafcommerce.openadmin.dto.Entity;
  56  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  57  import org.broadleafcommerce.openadmin.dto.ForeignKey;
  58  import org.broadleafcommerce.openadmin.dto.MapMetadata;
  59  import org.broadleafcommerce.openadmin.dto.MapStructure;
  60  import org.broadleafcommerce.openadmin.dto.Property;
  61  import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  62  import org.broadleafcommerce.openadmin.dto.TabMetadata;

  63  import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  64  import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  65  import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  66  import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  67  import org.broadleafcommerce.openadmin.server.security.remote.SecurityVerifier;
  68  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifier;
  69  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierConfiguration;
  70  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierData;
  71  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierDataPoint;
  72  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierRequest;
  73  import org.broadleafcommerce.openadmin.server.security.service.ExceptionAwareRowLevelSecurityProvider;
  74  import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  75  import org.broadleafcommerce.openadmin.server.security.service.navigation.AdminNavigationService;
  76  import org.broadleafcommerce.openadmin.server.service.AdminEntityService;
  77  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManager;
  78  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  79  import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  80  import org.broadleafcommerce.openadmin.server.service.persistence.module.FieldManager;
  81  import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  82  import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  83  import org.broadleafcommerce.openadmin.web.form.component.ListGridAction;
  84  import org.broadleafcommerce.openadmin.web.form.component.ListGridActionGroup;
  85  import org.broadleafcommerce.openadmin.web.form.component.ListGridRecord;
  86  import org.broadleafcommerce.openadmin.web.form.component.MediaField;
  87  import org.broadleafcommerce.openadmin.web.form.component.RuleBuilderField;
  88  import org.broadleafcommerce.openadmin.web.form.entity.CodeField;
  89  import org.broadleafcommerce.openadmin.web.form.entity.ComboField;
  90  import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  91  import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  92  import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  93  import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  94  import org.broadleafcommerce.openadmin.web.form.entity.Field;
  95  import org.broadleafcommerce.openadmin.web.rulebuilder.DataDTODeserializer;
  96  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataDTO;
  97  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataWrapper;
  98  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldDTO;
  99  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldWrapper;
 100  import org.codehaus.jettison.json.JSONObject;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +import org.springframework.beans.factory.annotation.Value;</span>
 102  import org.springframework.context.MessageSource;
 103  import org.springframework.context.NoSuchMessageException;
 104  import org.springframework.stereotype.Service;

 105  import com.fasterxml.jackson.core.Version;
 106  import com.fasterxml.jackson.databind.ObjectMapper;
 107  import com.fasterxml.jackson.databind.module.SimpleModule;

 108  import java.io.IOException;
 109  import java.math.BigDecimal;
 110  import java.text.DateFormat;
 111  import java.text.DateFormatSymbols;
 112  import java.text.ParseException;
 113  import java.text.SimpleDateFormat;
 114  import java.util.ArrayList;
 115  import java.util.Arrays;
 116  import java.util.Collections;
 117  import java.util.Date;
 118  import java.util.HashMap;
 119  import java.util.List;
 120  import java.util.Locale;
 121  import java.util.Map;
 122  import java.util.Map.Entry;
 123  import java.util.Set;

 124  import javax.annotation.Resource;
 125  import javax.persistence.ManyToOne;
 126  import javax.persistence.OneToOne;
 127  import javax.servlet.http.HttpServletRequest;
 128  
 129  
 130  /**
 131   * @author Andre Azzolini (apazzolini)
 132   */
 133  @Service(&quot;blFormBuilderService&quot;)
 134  public class FormBuilderServiceImpl implements FormBuilderService {
 135  
 136      private static final Log LOG = LogFactory.getLog(FormBuilderServiceImpl.class);
 137  
 138      public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 139  
 140      @Resource(name = &quot;blAdminEntityService&quot;)
 141      protected AdminEntityService adminEntityService;
 142  
 143      @Resource (name = &quot;blAdminNavigationService&quot;)
 144      protected AdminNavigationService navigationService;
 145  
 146      @Resource(name = &quot;blFormBuilderExtensionManager&quot;)
 147      protected FormBuilderExtensionManager extensionManager;
 148  
 149      @Resource(name=&quot;blEntityConfiguration&quot;)
 150      protected EntityConfiguration entityConfiguration;
 151  
 152      @Resource(name=&quot;blAdminSecurityRemoteService&quot;)
 153      protected SecurityVerifier adminRemoteSecurityService;
 154  
 155      @Resource(name = &quot;blRowLevelSecurityService&quot;)
 156      protected RowLevelSecurityService rowLevelSecurityService;
 157  
 158      @Resource(name = &quot;blMediaBuilderService&quot;)
 159      protected MediaBuilderService mediaBuilderService;
 160  
 161      @Resource(name = &quot;blListGridErrorMessageExtensionManager&quot;)
 162      protected ListGridErrorMessageExtensionManager listGridErrorExtensionManager;
 163  
 164      @Resource(name = &quot;blAdminNavigationService&quot;)
 165      protected AdminNavigationService adminNavigationService;






 166  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +    @Resource(name = &quot;blLocaleService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +    protected LocaleService localeService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +    @Resource(name = &quot;blTranslationService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +    protected TranslationService translationService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +    @Value(&quot;${use.translation.search:false}&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +    protected boolean useTranslationSearch;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +</span>
 176      protected static final VisibilityEnum[] FORM_HIDDEN_VISIBILITIES = new VisibilityEnum[] {
 177              VisibilityEnum.HIDDEN_ALL, VisibilityEnum.FORM_HIDDEN
 178      };
 179  
 180      protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[] {
 181              VisibilityEnum.HIDDEN_ALL, VisibilityEnum.GRID_HIDDEN
 182      };
 183  
 184      @Override
<abbr title=" 185      public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)"> 185      public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumðŸ”µ</abbr>
 186              throws ServiceException {
 187  
 188          List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 189          ListGrid.Type type = ListGrid.Type.MAIN;
 190          String idProperty = &quot;id&quot;;
 191  
 192          FieldWrapper wrapper = new FieldWrapper();
 193          ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 194          for (Property p : cmd.getProperties()) {
 195              if (p.getMetadata() instanceof BasicFieldMetadata) {
 196                  BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
 197  
 198                  if (SupportedFieldType.ID.equals(fmd.getFieldType())) {
 199                      idProperty = fmd.getName();
 200                  }
 201  
 202                  if (fmd.isProminent() != null &amp;&amp; fmd.isProminent()
 203                          &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), fmd.getVisibility())) {
 204                      Field hf = createHeaderField(p, fmd);
 205                      headerFields.add(hf);
 206                      defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, fmd));
 207                  }
 208  
 209                  if (fmd.getIsFilter() != null &amp;&amp; fmd.getIsFilter()) {
 210                      wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmd));
 211                  }
 212              }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +        if (useTranslationSearch) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +            getTranslationSearchField(cmd.getCeilingType(), defaultWrapperFields);</span>
 217          }
 218  
<abbr title=" 219          ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idProperty, sectionCrumbs);"> 219          ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idPropertðŸ”µ</abbr>
 220  
 221          if (CollectionUtils.isNotEmpty(listGrid.getHeaderFields())) {
 222              // Set the first column to be able to link to the main entity
 223              listGrid.getHeaderFields().iterator().next().setMainEntityLink(true);
 224          } else {
<abbr title=" 225              String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType();"> 225              String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType(ðŸ”µ</abbr>
 226              message += &quot;Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 227              LOG.error(message);
 228          }
 229  
 230          Date c = new Date();
 231          String friendlyName = &quot;listGrid&quot; + c.getTime();
 232          // Set up the filter builder params
 233          listGrid.setJsonFieldName(friendlyName + &quot;Json&quot;);
 234          listGrid.setFriendlyName(friendlyName);
 235          listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 236          if (CollectionUtils.isEmpty(wrapper.getFields())) {
 237              wrapper.setFields(defaultWrapperFields);
 238          }
 239          listGrid.setFieldWrapper(wrapper);
 240          listGrid.setHideFriendlyName(true);
 241  
 242          String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 243          listGrid.setJson(blankJsonString);
 244          DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 245          if (dw != null) {
 246              listGrid.setDataWrapper(dw);
 247          }
 248  
 249          listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 250          listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 251  
 252          extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 253  
 254          return listGrid;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +    private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFields) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +        TranslatedEntity translatedEntity;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +            translatedEntity = translationService.getAssignableEntityType(ceilingEntity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +            FieldDTO localeField = new FieldDTO();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +            localeField.setId(&quot;translationLocale&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +            localeField.setLabel(&quot;Translation locale&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +            localeField.setOperators(&quot;blcFilterOperators_Enumeration&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +            localeField.setInput(&quot;select&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +            localeField.setType(&quot;string&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +            List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocales();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +            Map&lt;String, String&gt; localeMap = new HashMap&lt;String, String&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +            for (org.broadleafcommerce.common.locale.domain.Locale l : locales) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +                localeMap.put(l.getLocaleCode(), l.getFriendlyName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +            localeField.setValues((new JSONObject(localeMap)).toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +            defaultWrapperFields.add(localeField);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +        } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +            translatedEntity = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +        }</span>
 283      }
 284  
 285      protected FieldDTO constructFieldDTOFromFieldData(Field field, BasicFieldMetadata fmd) {
 286          FieldDTO fieldDTO = new FieldDTO();
 287          //translate the label to display
 288          String label = field.getFriendlyName();
 289          BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 290          MessageSource messages = context.getMessageSource();
 291          if (messages != null) {
 292              label = messages.getMessage(label, null, label, context.getJavaLocale());
 293          }
 294          fieldDTO.setLabel(label);
 295  
 296          fieldDTO.setId(field.getName());
 297          if (field.getFieldType().equals(&quot;STRING&quot;)) {
 298              fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 299          } else if (field.getFieldType().equals(&quot;DATE&quot;)) {
 300              fieldDTO.setOperators(&quot;blcFilterOperators_Date&quot;);
<abbr title=" 301          } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldType().equals(&quot;DECIMAL&quot;)) {"> 301          } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldðŸ”µ</abbr>
 302              fieldDTO.setOperators(&quot;blcFilterOperators_Numeric&quot;);
 303          } else if (field.getFieldType().equals(&quot;BOOLEAN&quot;)) {
 304              fieldDTO.setOperators(&quot;blcFilterOperators_Boolean&quot;);
 305          } else if (field.getFieldType().equals(&quot;BROADLEAF_ENUMERATION&quot;)) {
 306              fieldDTO.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 307              fieldDTO.setInput(&quot;select&quot;);
 308              fieldDTO.setType(&quot;string&quot;);
 309              String[][] enumerationValues = fmd.getEnumerationValues ();
 310              Map&lt;String, String&gt; enumMap = new HashMap&lt;&gt;();
 311              for (int i = 0; i &lt; enumerationValues.length; i++) {
 312                  enumMap.put(enumerationValues[i][0], enumerationValues[i][1]);
 313              }
 314  
 315              fieldDTO.setValues(new JSONObject(enumMap).toString());
 316          } else if (field.getFieldType().equals(&quot;ADDITIONAL_FOREIGN_KEY&quot;)) {
 317              fieldDTO.setOperators(&quot;blcFilterOperators_Selectize&quot;);
 318              fieldDTO.setType(&quot;string&quot;);
 319  
<abbr title=" 320              AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClass(), null);"> 320              AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClaðŸ”µ</abbr>
 321              if (section != null) {
 322                  String sectionKey = section.getUrl().substring(1);
 323                  fieldDTO.setSelectizeSectionKey(sectionKey);
 324              } else {
 325                  fieldDTO.setSelectizeSectionKey(fmd.getForeignKeyClass());
 326              }
 327          } else {
 328              fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 329          }
 330  
 331          return fieldDTO;
 332      }
 333  
 334      protected Field createHeaderField(Property p, BasicFieldMetadata fmd) {
 335          Field hf;
 336          if (fmd.getFieldType().equals(SupportedFieldType.EXPLICIT_ENUMERATION) ||
 337                  fmd.getFieldType().equals(SupportedFieldType.BROADLEAF_ENUMERATION) ||
 338                  fmd.getFieldType().equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION) ||
 339                  fmd.getFieldType().equals(SupportedFieldType.EMPTY_ENUMERATION)) {
 340              hf = new ComboField();
 341              ((ComboField) hf).setOptions(fmd.getEnumerationValues());
 342          } else {
 343              hf = new Field();
 344          }
 345  
 346          hf.withName(p.getName())
 347            .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getName())
 348            .withOrder(fmd.getGridOrder())
 349            .withColumnWidth(fmd.getColumnWidth())
 350            .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
 351            .withForeignKeyClass(fmd.getForeignKeyClass())
 352            .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
 353            .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClass())
 354            .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity());
 355          String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 356          hf.setFieldType(fieldType);
 357  
 358          return hf;
 359      }
 360  
 361      @Override
 362      public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property field,
 363              String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 364              throws ServiceException {
 365          FieldMetadata fmd = field.getMetadata();
 366          // Get the class metadata for this particular field
 367          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 368          if (field != null) {
 369              ppr.setSectionEntityField(field.getName());
 370          }
 371          ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 372  
 373          List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 374          ListGrid.Type type = null;
 375          boolean editable = false;
 376          boolean sortable = false;
 377          boolean readOnly = false;
 378          boolean hideIdColumn = false;
 379          boolean canFilterAndSort = true;
 380          boolean modalSingleSelectable = false;
 381          boolean modalMultiSelectable = false;
 382          boolean selectize = false;
 383          boolean isMedia = false;
 384          boolean isLookup = false;
 385          String sortProperty = null;
 386          FieldWrapper wrapper = new FieldWrapper();
 387          ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 388  
 389  
 390          String idProperty = &quot;id&quot;;
 391          for (Property property : cmd.getProperties()) {
 392              if (property.getMetadata() instanceof BasicFieldMetadata &amp;&amp;
 393                      SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;&amp;
 394                      //make sure it&#x27;s a property for this entity - not an association
 395                      !property.getName().contains(&quot;.&quot;)) {
 396                  idProperty = property.getName();
 397                  break;
 398              }
 399          }
 400          // Get the header fields for this list grid. Note that the header fields are different depending on the
 401          // kind of field this is.
 402          if (fmd instanceof BasicFieldMetadata) {
 403              readOnly = ((BasicFieldMetadata) fmd).getReadOnly();
 404              modalSingleSelectable = true;
 405              for (Property p : cmd.getProperties()) {
 406                  if (p.getMetadata() instanceof BasicFieldMetadata) {
 407                      BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 408  
 409                      if (SupportedFieldType.ID.equals(md.getFieldType())) {
 410                          idProperty = md.getName();
 411                      }
 412  
 413                      if (md.isProminent() != null &amp;&amp; md.isProminent()
 414                              &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 415                          Field hf = createHeaderField(p, md);
 416                          headerFields.add(hf);
 417                          defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 418                      }
 419  
 420                      if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 421                          Field f = createHeaderField(p, md);
 422                          wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 423                      }
 424                  }
 425              }
 426  
 427              type = ListGrid.Type.TO_ONE;
 428          } else if (fmd instanceof BasicCollectionMetadata) {
 429              BasicCollectionMetadata bcm = (BasicCollectionMetadata) fmd;
 430              readOnly = !bcm.isMutable();
 431  
 432              if(AddMethodType.LOOKUP.equals(bcm.getAddMethodType())) {
 433                  isLookup = true;
 434              }
 435  
 436              if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 437                  Property p = cmd.getPMap().get(bcm.getSelectizeVisibleField());
 438                  if (p != null) {
 439                      BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 440  
 441                      Field hf = createHeaderField(p, md);
 442                      headerFields.add(hf);
 443                      wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 444                  }
 445              } else {
 446                  for (Property p : cmd.getProperties()) {
 447                      if (p.getMetadata() instanceof BasicFieldMetadata) {
 448                          BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 449                          if (md.isProminent() != null &amp;&amp; md.isProminent()
 450                                  &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 451                              Field hf = createHeaderField(p, md);
 452                              headerFields.add(hf);
 453                              defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 454                          }
 455  
 456                          if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 457                              Field f = createHeaderField(p, md);
 458                              wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 459                          }
 460                      }
 461                  }
 462              }
 463  
 464              type = ListGrid.Type.BASIC;
 465  
<abbr title=" 466              if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getAddMethodType())) {"> 466              if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getðŸ”µ</abbr>
 467                  editable = true;
 468              } else if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 469                  selectize = true;
 470                  modalSingleSelectable = true;
 471              } else {
 472                  modalSingleSelectable = true;
 473              }
 474              sortable = StringUtils.isNotBlank(bcm.getSortProperty());
 475              if (sortable) {
 476                  sortProperty = bcm.getSortProperty();
 477              }
 478          } else if (fmd instanceof AdornedTargetCollectionMetadata) {
 479              modalSingleSelectable = true;
 480              readOnly = !((AdornedTargetCollectionMetadata) fmd).isMutable();
 481              AdornedTargetCollectionMetadata atcmd = (AdornedTargetCollectionMetadata) fmd;
 482  
 483              if(AdornedTargetAddMethodType.LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 484                  isLookup = true;
 485              }
 486  
 487              if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 488                  selectize = true;
 489  
 490                  Property p = cmd.getPMap().get(atcmd.getSelectizeVisibleField());
 491                  if (p != null) {
 492                      BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 493  
 494                      Field hf = createHeaderField(p, md);
 495                      headerFields.add(hf);
 496                      wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 497                  }
 498              } else {
 499                  for (String fieldName : atcmd.getGridVisibleFields()) {
 500                      Property p = cmd.getPMap().get(fieldName);
 501                      if (p != null) {
 502                          BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 503  
 504                          Field hf = createHeaderField(p, md);
 505                          headerFields.add(hf);
 506                          wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 507                      }
 508  
 509                  }
 510              }
 511  
 512              type = ListGrid.Type.ADORNED;
 513  
 514              if (atcmd.getMaintainedAdornedTargetFields().length &gt; 0) {
 515                  editable = true;
 516              }
 517  
 518              AdornedTargetList adornedList = (AdornedTargetList) atcmd.getPersistencePerspective()
 519                      .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);
 520              sortable = StringUtils.isNotBlank(adornedList.getSortField());
 521              if (sortable) {
 522                  sortProperty = adornedList.getSortField();
 523              }
 524          } else if (fmd instanceof MapMetadata) {
 525              readOnly = !((MapMetadata) fmd).isMutable();
 526              MapMetadata mmd = (MapMetadata) fmd;
 527  
 528              Property p2 = cmd.getPMap().get(&quot;key&quot;);
 529              BasicFieldMetadata keyMd = (BasicFieldMetadata) p2.getMetadata();
 530              keyMd.setFriendlyName(getMapKeyFriendlyName(p2));
 531              Field hf = createHeaderField(p2, keyMd);
 532              headerFields.add(hf);
 533              wrapper.getFields().add(constructFieldDTOFromFieldData(hf, keyMd));
 534  
 535              if (mmd.isSimpleValue()) {
 536                  Property valueProperty = cmd.getPMap().get(&quot;value&quot;);
 537                  BasicFieldMetadata valueMd = (BasicFieldMetadata) valueProperty.getMetadata();
 538                  valueMd.setFriendlyName(&quot;Value&quot;);
 539                  hf = createHeaderField(valueProperty, valueMd);
 540                  headerFields.add(hf);
 541                  wrapper.getFields().add(constructFieldDTOFromFieldData(hf, valueMd));
 542  
 543                  idProperty = &quot;key&quot;;
 544                  hideIdColumn = true;
 545              } else {
 546                  for (Property p : cmd.getProperties()) {
 547                      if (p.getMetadata() instanceof BasicFieldMetadata) {
 548                          BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 549                          String valueClassName = mmd.getValueClassName();
 550                          if (!StringUtils.isEmpty(mmd.getToOneTargetProperty())) {
 551                              Class&lt;?&gt; clazz;
 552                              try {
 553                                  clazz = Class.forName(mmd.getValueClassName());
 554                              } catch (ClassNotFoundException e) {
 555                                  throw ExceptionHelper.refineException(e);
 556                              }
<abbr title=" 557                              java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTargetProperty());"> 557                              java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTðŸ”µ</abbr>
 558                              ManyToOne manyToOne = nestedField.getAnnotation(ManyToOne.class);
<abbr title=" 559                              if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getName())) {"> 559                              if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getNameðŸ”µ</abbr>
 560                                  valueClassName = manyToOne.targetEntity().getName();
 561                              } else {
 562                                  OneToOne oneToOne = nestedField.getAnnotation(OneToOne.class);
<abbr title=" 563                                  if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getName())) {"> 563                                  if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getNaðŸ”µ</abbr>
 564                                      valueClassName = oneToOne.targetEntity().getName();
 565                                  }
 566                              }
 567                          }
 568                          if (md.getTargetClass().equals(valueClassName)) {
 569                              if (md.isProminent() != null &amp;&amp; md.isProminent()
 570                                      &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 571                                  hf = createHeaderField(p, md);
 572                                  headerFields.add(hf);
 573                                  defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 574  
 575                                  // Is this a media listgrid
 576                                  if (hf.getFieldType().equals(&quot;ASSET_LOOKUP&quot;)) {
 577                                      isMedia = true;
 578                                  }
 579                              }
 580  
 581                              if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 582                                  wrapper.getFields().add(constructFieldDTOFromFieldData(hf,md));
 583                              }
 584                          }
 585                      }
 586                  }
 587              }
 588  
 589              type = ListGrid.Type.MAP;
 590              editable = true;
 591              canFilterAndSort = false;
 592          }
 593  
 594          String ceilingType = &quot;&quot;;
 595          if (fmd instanceof BasicFieldMetadata) {
 596              ceilingType = cmd.getCeilingType();
 597          } else if (fmd instanceof CollectionMetadata) {
 598              ceilingType = ((CollectionMetadata) fmd).getCollectionCeilingEntity();
 599          }
 600  
 601          if (CollectionUtils.isEmpty(headerFields)) {
<abbr title=" 602              String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; and property &#x27;&quot; +"> 602              String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; andðŸ”µ</abbr>
 603                      StringUtil.sanitize(field.getName()) + &quot;&#x27;.&quot;;
 604              if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) {
<abbr title=" 605                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 605                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetColleðŸ”µ</abbr>
 606              } else if (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM) {
<abbr title=" 607                  message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 607                  message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollectioðŸ”µ</abbr>
 608              } else if (selectize &amp;&amp; type == ListGrid.Type.BASIC) {
<abbr title=" 609                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuration&quot;;"> 609                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuðŸ”µ</abbr>
 610              } else {
 611                  message += &quot; Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 612              }
 613              LOG.error(message);
 614          }
 615  
<abbr title=" 616          ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProperty, sectionCrumbs, sortProperty);"> 616          ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProðŸ”µ</abbr>
 617          listGrid.setSubCollectionFieldName(field.getName());
 618          listGrid.setFriendlyName(field.getMetadata().getFriendlyName());
 619          if (StringUtils.isEmpty(listGrid.getFriendlyName())) {
 620              listGrid.setFriendlyName(field.getName());
 621          }
 622          listGrid.setContainingEntityId(containingEntityId);
 623          listGrid.setIsReadOnly(readOnly);
 624          listGrid.setHideIdColumn(hideIdColumn);
 625          listGrid.setCanFilterAndSort(canFilterAndSort);
 626  
 627          // Set up the filter builder params
 628          Date c = new Date();
 629          String friendlyName = field.getMetadata().getFriendlyName();
 630          String jsonFriendlyName = friendlyName.replaceAll(&quot; &quot;, &quot;_&quot;);
 631          listGrid.setJsonFieldName(jsonFriendlyName + c.getTime() + &quot;Json&quot;);
 632          listGrid.setFriendlyName(friendlyName);
 633          listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 634          if (CollectionUtils.isEmpty(wrapper.getFields())) {
 635              wrapper.setFields(defaultWrapperFields);
 636          }
 637          listGrid.setFieldWrapper(wrapper);
 638  
 639          String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 640          listGrid.setJson(blankJsonString);
 641          DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 642          if (dw != null) {
 643              listGrid.setDataWrapper(dw);
 644          }
 645  
 646          if (editable) {
 647              listGrid.getRowActions().add(DefaultListGridActions.UPDATE);
 648          }
 649          if (readOnly) {
 650              listGrid.getRowActions().add(DefaultListGridActions.VIEW);
 651          }
 652          if (sortable) {
 653              listGrid.setCanFilterAndSort(false);
 654              listGrid.setIsSortable(true);
 655          }
 656  
 657          if (modalSingleSelectable) {
 658              if (readOnly) {
<abbr title=" 659                  listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(true));"> 659                  listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(trðŸ”µ</abbr>
 660              } else {
 661                  listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 662  
 663              }
 664          }
 665          listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 666  
 667          if (selectize) {
 668              listGrid.setSelectizeUrl(buildSelectizeUrl(listGrid));
 669              listGrid.setSelectType(ListGrid.SelectType.SELECTIZE);
 670          }
 671  
 672          if (modalMultiSelectable) {
 673              listGrid.addModalRowAction(DefaultListGridActions.MULTI_SELECT);
 674              listGrid.setSelectType(ListGrid.SelectType.MULTI_SELECT);
 675          }
 676          listGrid.getRowActions().add(DefaultListGridActions.REMOVE);
 677  
 678          if (fmd.getManualFetch()) {
 679              listGrid.setManualFetch(true);
 680              listGrid.getToolbarActions().add(DefaultListGridActions.MANUAL_FETCH);
 681          }
 682          if (isMedia) {
 683              listGrid.setListGridType(ListGrid.Type.ASSET_GRID);
 684          }
 685  
 686          extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 687  
<abbr title=" 688          //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface"> 688          //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the ðŸ”µ</abbr>
 689          if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title=" 690              EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();"> 690              EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvðŸ”µ</abbr>
<abbr title=" 691              for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {"> 691              for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getDatðŸ”µ</abbr>
 692                  for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
 693                      if (modifier.isQualified(data.getModifierType())) {
 694                          modifier.modifyListGrid(new EntityFormModifierRequest()
 695                                  .withListGrid(listGrid)
 696                                  .withConfiguration(data)
 697                                  .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
 698                                  .withRowLevelSecurityService(rowLevelSecurityService));
 699                      }
 700                  }
 701              }
 702          }
 703          return listGrid;
 704      }
 705  
 706      protected String getMapKeyFriendlyName(Property property) {
 707          String friendlyNameFromMetadata = property.getMetadata().getFriendlyName();
 708  
 709          return (friendlyNameFromMetadata == null) ? &quot;Key&quot; : friendlyNameFromMetadata;
 710      }
 711  
 712      @Override
<abbr title=" 713      public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, Property field,"> 713      public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, PropeðŸ”µ</abbr>
 714          String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 715              throws ServiceException {
 716          FieldMetadata fmd = field.getMetadata();
 717          // Get the class metadata for this particular field
 718          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 719          if (field != null) {
 720              ppr.setSectionEntityField(field.getName());
 721          }
 722          ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 723  
 724          Map&lt;String, Object&gt; result = constructSelectizeOptionMap(drs, cmd);
 725  
 726          AdornedTargetList adornedList = ppr.getAdornedList();
 727          if (adornedList != null &amp;&amp; adornedList.getLinkedObjectPath() != null
 728              &amp;&amp; adornedList.getTargetObjectPath() != null &amp;&amp; adornedList.getLinkedIdProperty() != null
 729              &amp;&amp; adornedList.getTargetIdProperty() != null) {
<abbr title=" 730              result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());"> 730              result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperðŸ”µ</abbr>
 731              result.put(&quot;linkedObjectId&quot;, containingEntityId);
<abbr title=" 732              result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());"> 732              result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperðŸ”µ</abbr>
 733          }
 734  
 735          return result;
 736      }
 737  
 738      @Override
 739      public Map&lt;String, Object&gt; constructSelectizeOptionMap(DynamicResultSet drs, ClassMetadata cmd) {
 740          Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
 741          List&lt;Map&lt;String, String&gt;&gt; options = new ArrayList&lt;&gt;();
 742  
 743          List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 744          for (Property p : cmd.getProperties()) {
 745              if (p.getMetadata() instanceof BasicFieldMetadata) {
 746                  BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 747                  if (md.isProminent() != null &amp;&amp; md.isProminent()
 748                          &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 749                      Field hf = createHeaderField(p, md);
 750                      headerFields.add(hf);
 751                  }
 752              }
 753          }
 754  
 755          for (Entity e : drs.getRecords()) {
 756              Map&lt;String, String&gt; selectizeOption = new HashMap&lt;&gt;();
 757              for (Field headerField : headerFields) {
 758                  Property p = e.findProperty(headerField.getName());
 759                  if (p != null) {
 760                      selectizeOption.put(&quot;name&quot;, p.getValue());
 761                      break;
 762                  }
 763              }
 764              if (e.findProperty(&quot;id&quot;) != null) {
 765                  selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;id&quot;).getValue());
 766              //  &quot;Locale&quot; entity is a special occasion. Because it have not &quot;ID&quot; column with &quot;Long&quot; type
 767              } else if (e.findProperty(&quot;localeCode&quot;) != null) {
 768                  selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;localeCode&quot;).getValue());
 769              }
 770              if (e.findProperty(ALTERNATE_ID_PROPERTY) != null) {
 771                  selectizeOption.put(&quot;alternateId&quot;, e.findProperty(ALTERNATE_ID_PROPERTY).getValue());
 772              }
 773              options.add(selectizeOption);
 774          }
 775          result.put(&quot;options&quot;, options);
 776  
 777          return result;
 778      }
 779  
 780      protected String buildSelectizeUrl(ListGrid listGrid) {
 781          HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 782          String url = request.getContextPath();
<abbr title=" 783          url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + listGrid.getSectionKey();"> 783          url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + liðŸ”µ</abbr>
 784          url += &quot;/&quot; + listGrid.getContainingEntityId();
 785          url += &quot;/&quot; + listGrid.getSubCollectionFieldName();
 786          return url;
 787      }
 788  
 789      /**
<abbr title=" 790       * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 790       * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, StriðŸ”µ</abbr>
 791       * @param className
 792       * @param headerFields
 793       * @param type
 794       * @param drs
 795       * @param sectionKey
 796       * @param order
 797       * @param idProperty
 798       * @param sectionCrumbs
 799       * @return
 800       */
 801      @Deprecated
<abbr title=" 802      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 802      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResulðŸ”µ</abbr>
 803              String sectionKey, int order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs) {
 804         return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,null);
 805      }
 806  
 807      /**
 808       * Populate a ListGrid with ListGridRecords.
 809       *
 810       * @param className
 811       * @param headerFields
 812       * @param type
 813       * @param drs
 814       * @param sectionKey
 815       * @param order
 816       * @param idProperty
 817       * @param sectionCrumbs
 818       * @param sortPropery
 819       * @return
 820       */
<abbr title=" 821      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 821      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResulðŸ”µ</abbr>
<abbr title=" 822              String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropery) {"> 822              String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropðŸ”µ</abbr>
 823          // Create the list grid and set some basic attributes
 824          ListGrid listGrid = new ListGrid();
 825          listGrid.setClassName(className);
 826          listGrid.getHeaderFields().addAll(headerFields);
 827          listGrid.setListGridType(type);
 828          listGrid.setSectionCrumbs(sectionCrumbs);
 829          listGrid.setSectionKey(sectionKey);
 830          listGrid.setOrder(order);
 831          listGrid.setIdProperty(idProperty);
 832          listGrid.setStartIndex(drs.getStartIndex());
 833          listGrid.setTotalRecords(drs.getTotalRecords());
 834          listGrid.setPageSize(drs.getPageSize());
 835  
 836          String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
<abbr title=" 837          AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier);"> 837          AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier)ðŸ”µ</abbr>
 838          if (section != null) {
 839              listGrid.setExternalEntitySectionKey(section.getUrl());
 840          }
 841  
 842          // format date list grid cells
 843          SimpleDateFormat formatter = new SimpleDateFormat(&quot;MMM d, y @ hh:mma&quot;);
 844          DateFormatSymbols symbols = new DateFormatSymbols(Locale.getDefault());
 845          symbols.setAmPmStrings(new String[] { &quot;am&quot;, &quot;pm&quot; });
 846          formatter.setDateFormatSymbols(symbols);
 847  
 848          // For each of the entities (rows) in the list grid, we need to build the associated
 849          // ListGridRecord and set the required fields on the record. These fields are the same ones
 850          // that are used for the header fields.
 851          for (Entity e : drs.getRecords()) {
 852              ListGridRecord record = new ListGridRecord();
 853              record.setListGrid(listGrid);
 854              record.setDirty(e.isDirty());
 855              record.setEntity(e);
 856              if (StringUtils.isNotBlank(sortPropery) &amp;&amp; e.findProperty(sortPropery) != null) {
 857                  Property sort = e.findProperty(sortPropery);
 858                  record.setDisplayOrder(sort.getValue());
 859              }
 860              if (e.findProperty(&quot;hasError&quot;) != null) {
 861                  Boolean hasError = Boolean.parseBoolean(e.findProperty(&quot;hasError&quot;).getValue());
 862                  record.setIsError(hasError);
 863                  if (hasError) {
 864                      ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 865                              .getProxy().determineErrorMessageForEntity(e, record);
 866  
 867                      if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 868                          record.setErrorKey(&quot;listgrid.record.error&quot;);
 869                      }
 870                  }
 871              }
 872  
 873              if (e.findProperty(&quot;progressStatus&quot;) != null) {
 874                  ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 875                          .getProxy().determineStatusMessageForEntity(e, record);
 876                  if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 877                      record.setStatus(e.findProperty(&quot;progressStatus&quot;).getValue());
 878                      record.setStatusCssClass(&quot;listgrid.record.status&quot;);
 879                  }
 880              }
 881  
 882              if (e.findProperty(idProperty) != null) {
 883                  record.setId(e.findProperty(idProperty).getValue());
 884              }
 885  
 886              for (Field headerField : headerFields) {
 887                  Property p = e.findProperty(headerField.getName());
 888                  if (p != null) {
 889                      Field recordField = new Field().withName(headerField.getName())
 890                              .withFriendlyName(headerField.getFriendlyName())
 891                              .withOrder(p.getMetadata().getOrder());
 892  
 893                      if (headerField instanceof ComboField) {
 894                          recordField.setValue(((ComboField) headerField).getOption(p.getValue()));
 895                          recordField.setDisplayValue(p.getDisplayValue());
 896                      } else {
 897                          if (headerField.getFieldType().equals(&quot;DATE&quot;)) {
 898                              try {
 899                                  Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue());
 900                                  String newValue = formatter.format(date);
 901                                  recordField.setValue(newValue);
 902                              } catch (Exception ex) {
 903                                  recordField.setValue(p.getValue());
 904                              }
 905                          } else {
 906                              recordField.setValue(p.getValue());
 907                          }
 908                          recordField.setDisplayValue(p.getDisplayValue());
 909                      }
 910  
 911                      recordField.setDerived(isDerivedField(headerField, recordField, p));
 912  
 913                      record.getFields().add(recordField);
 914                  }
 915              }
 916  
 917              if (e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY) != null) {
 918                  Field hiddenField = new Field().withName(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 919                  hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue());
 920                  record.getHiddenFields().add(hiddenField);
 921              }
 922  
 923              if (e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY) != null) {
 924                  record.setAltId(e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY).getValue());
 925              }
 926  
 927              extensionManager.getProxy().modifyListGridRecord(className, record, e);
 928  
 929              listGrid.getRecords().add(record);
 930          }
 931  
 932          if (drs.getFirstId() != null) {
 933              listGrid.setFirstId(drs.getFirstId());
 934          }
 935          if (drs.getLastId() != null) {
 936              listGrid.setLastId(drs.getLastId());
 937          }
 938          if (drs.getUpperCount() != null) {
 939              listGrid.setUpperCount(drs.getUpperCount());
 940          }
 941          if (drs.getLowerCount() != null) {
 942              listGrid.setLowerCount(drs.getLowerCount());
 943          }
 944          if (drs.getFetchType() != null) {
 945              listGrid.setFetchType(drs.getFetchType().toString());
 946          }
 947          if (drs.getTotalCountLessThanPageSize() != null) {
 948              listGrid.setTotalCountLessThanPageSize(drs.getTotalCountLessThanPageSize());
 949          }
 950          if (drs.getPromptSearch() != null) {
 951              listGrid.setPromptSearch(drs.getPromptSearch());
 952          }
 953  
 954          return listGrid;
 955      }
 956  
 957      /**
<abbr title=" 958       * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasicFieldMetadata}"> 958       * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasiðŸ”µ</abbr>
 959       * for the given Property to see if something on the backend has marked it as derived
 960       *
 961       * @param headerField the header for this recordField
 962       * @param recordField the recordField being populated
 963       * @param p the property that relates to this recordField
 964       * @return whether or not this field is derived
<abbr title=" 965       * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 965       * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, SðŸ”µ</abbr>
 966       */
 967      protected Boolean isDerivedField(Field headerField, Field recordField, Property p) {
 968          return BooleanUtils.isTrue(((BasicFieldMetadata) p.getMetadata()).getIsDerived());
 969      }
 970  
 971      protected void setEntityFormFields(ClassMetadata cmd, EntityForm ef, List&lt;Property&gt; properties) {
 972          List&lt;Field&gt; homelessFields = new ArrayList&lt;&gt;();
 973          List&lt;Field&gt; fieldsWithAssociations = new ArrayList&lt;&gt;();
 974  
 975          for (Property property : properties) {
 976              if (property.getMetadata() instanceof BasicFieldMetadata) {
 977                  BasicFieldMetadata fmd = (BasicFieldMetadata) property.getMetadata();
 978  
 979  
 980                  if (!ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
 981                      // Depending on visibility, field for the particular property is not created on the form
 982                      String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 983  
 984                      // Create the field and set some basic attributes
 985                      Field f;
 986  
 987                      if (fieldType.equals(SupportedFieldType.BROADLEAF_ENUMERATION.toString())
 988                              || fieldType.equals(SupportedFieldType.EXPLICIT_ENUMERATION.toString())
 989                              || fieldType.equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION.toString())
 990                              || fieldType.equals(SupportedFieldType.EMPTY_ENUMERATION.toString())) {
<abbr title=" 991                          // We&#x27;re dealing with fields that should render as drop-downs, so set their possible values"> 991                          // We&#x27;re dealing with fields that should render as drop-downs, so set their possible valueðŸ”µ</abbr>
 992                          f = new ComboField();
 993                          ((ComboField) f).setOptions(fmd.getEnumerationValues());
<abbr title=" 994                          if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValue()"> 994                          if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValuðŸ”µ</abbr>
 995                                  &amp;&amp; ((ComboField) f).getOptions().size() == 0) {
 996                              f.setIsVisible(false);
 997                          }
 998                      } else if (fieldType.equals(SupportedFieldType.CODE.toString())) {
 999                          f = new CodeField();
1000                      } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1001                              || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1002                              || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1003                          // We&#x27;re dealing with rule builders, so we&#x27;ll create those specialized fields
1004                          f = new RuleBuilderField();
1005                          ((RuleBuilderField) f).setJsonFieldName(property.getName() + &quot;Json&quot;);
1006                          ((RuleBuilderField) f).setDataWrapper(new DataWrapper());
1007                          ((RuleBuilderField) f).setFieldBuilder(fmd.getRuleIdentifier());
1008                          ((RuleBuilderField) f).setDisplayType(fmd.getDisplayType().toString());
1009  
1010                          String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
1011                          ((RuleBuilderField) f).setJson(blankJsonString);
1012                          DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
1013                          if (dw != null) {
1014                              ((RuleBuilderField) f).setDataWrapper(dw);
1015                          }
1016  
1017                          if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())) {
1018                              ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple&quot;);
1019                          } else if (fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1020                              ((RuleBuilderField) f).setRuleType(&quot;rule-builder-with-quantity&quot;);
1021                          } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())) {
1022                              ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple-time&quot;);
1023                          }
1024                      } else if (LookupType.DROPDOWN.equals(fmd.getLookupType())) {
<abbr title="1025                          // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of in a">1025                          // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of inðŸ”µ</abbr>
<abbr title="1026                          // modal, so we&#x27;ll provision the combo field here. Available options will be set as part of a">1026                          // modal, so we&#x27;ll provision the combo field here. Available options will be set as part oðŸ”µ</abbr>
1027                          // subsequent operation
1028                          f = new ComboField();
1029                      } else if (fieldType.equals(SupportedFieldType.MEDIA.toString())) {
1030                          f = new MediaField();
1031                      } else {
1032                          // Create a default field since there was no specialized handler
1033                          f = new Field();
1034                      }
1035  
1036                      Boolean required = fmd.getRequiredOverride();
1037                      if (required == null) {
1038                          required = fmd.getRequired();
1039                      }
1040  
1041                      Boolean allowNoValueEnum = fmd.getAllowNoValueEnumOption();
1042                      if (allowNoValueEnum != null) {
1043                          f.setAllowNoValueEnumOption(allowNoValueEnum);
1044                      }
1045  
1046                      f.withName(property.getName())
1047                       .withFieldType(fieldType)
1048                       .withFieldComponentRenderer(getFieldComponentRenderer(fmd))
1049                       .withGridFieldComponentRenderer(getGridFieldComponentRenderer(fmd))
1050                       .withOrder(fmd.getOrder())
1051                       .withFriendlyName(fmd.getFriendlyName())
1052                       .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
1053                       .withForeignKeyClass(fmd.getForeignKeyClass())
1054                       .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title="1055                       .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromType())">1055                       .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromTyðŸ”µ</abbr>
1056                       .withRequired(required)
1057                       .withReadOnly(fmd.getReadOnly())
1058                       .withTranslatable(fmd.getTranslatable())
1059                       .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDERING))
1060                       .withLargeEntry(fmd.isLargeEntry())
1061                       .withHint(fmd.getHint())
1062                       .withTooltip(fmd.getTooltip())
1063                       .withHelp(fmd.getHelpText())
1064                       .withTypeaheadEnabled(fmd.getEnableTypeaheadLookup())
1065                       .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity())
1066                       .withAssociatedFieldName(fmd.getAssociatedFieldName());
1067  
1068                      String defaultValue = fmd.getDefaultValue();
1069                      if (defaultValue != null) {
1070                          defaultValue = extractDefaultValueFromFieldData(fieldType, fmd);
1071                          f.withValue(defaultValue);
1072                      }
1073  
1074                      if (StringUtils.isBlank(f.getFriendlyName())) {
1075                          f.setFriendlyName(f.getName());
1076                      }
1077  
1078                      // If is form hidden, set visible to false
1079                      if (VisibilityEnum.FORM_EXPLICITLY_HIDDEN.equals(fmd.getVisibility())) {
1080                          f.setIsVisible(false);
1081                      }
1082  
1083                      if (VisibilityEnum.VISIBLE_ALL.equals(fmd.getVisibility())) {
1084                          f.setIsVisible(true);
1085                      }
1086  
1087                      // Add the field to the appropriate FieldGroup
1088                      if (fmd.getGroup() == null) {
1089                          homelessFields.add(f);
1090                      } else {
1091                          ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabOrder());
1092                      }
1093  
1094                      if (StringUtils.isNotEmpty(fmd.getAssociatedFieldName())) {
1095                          fieldsWithAssociations.add(f);
1096                      }
1097                  }
1098              }
1099          }
1100  
1101          for (Field f : homelessFields) {
1102              ef.addField(cmd, f, null, null, null, null);
1103          }
1104  
1105          for (Field f : fieldsWithAssociations) {
1106              Field associatedField = findAssociatedField(ef, f);
1107              if (associatedField != null) {
1108                  associatedField.setShouldRender(false);
1109                  f.setAssociatedFieldName(associatedField.getName());
1110              } else {
1111                  f.setAssociatedFieldName(null);
1112              }
1113          }
1114      }
1115  
1116      protected String getFieldComponentRenderer(BasicFieldMetadata fmd) {
1117          if (StringUtils.isNotBlank(fmd.getFieldComponentRendererTemplate())) {
1118              return fmd.getFieldComponentRendererTemplate();
1119          }
1120          return fmd.getFieldComponentRenderer()==null?null:fmd.getFieldComponentRenderer().toString();
1121      }
1122  
1123      protected String getGridFieldComponentRenderer(BasicFieldMetadata fmd) {
1124          if (StringUtils.isNotBlank(fmd.getGridFieldComponentRendererTemplate())) {
1125              return fmd.getGridFieldComponentRendererTemplate();
1126          }
1127          return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toString();
1128      }
1129  
1130      private Field findAssociatedField(EntityForm ef, Field f) {
1131          // Try on the parent object
1132          Field associatedField = ef.findField(f.getAssociatedFieldName());
1133  
1134          if (associatedField == null) {
1135              // Check the field&#x27;s path
1136              String[] fieldPathParts = f.getName().split(&quot;\\.&quot;);
1137              String testPath = &quot;&quot;;
1138  
1139              for (String path : fieldPathParts) {
1140                  testPath += path + &quot;.&quot;;
1141  
1142                  associatedField = ef.findField(testPath + f.getAssociatedFieldName());
1143                  if (associatedField != null) {
1144                      break;
1145                  }
1146              }
1147          }
1148          return associatedField;
1149      }
1150  
1151      /**
1152       * This method gets the {@link AdminSection} for the given foreignKeyClass parameter. If none exists,
1153       * it returns the foreignKeyClass.
1154       *
1155       * @param foreignKeyClass the {@link String} class name
1156       * @return the admin section pathname
1157       */
1158      protected String getAdminSectionPath(String foreignKeyClass) {
1159          if (foreignKeyClass != null) {
<abbr title="1160              AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyClass, null);">1160              AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyðŸ”µ</abbr>
1161              return foreignKeySection != null ? foreignKeySection.getUrl() : foreignKeyClass;
1162          }
1163          return null;
1164      }
1165  
1166      /**
<abbr title="1167       * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal to">1167       * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal tðŸ”µ</abbr>
1168       *  the processed value of another tab.
1169       *
1170       * For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a another tab where
1171       *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;,
1172       *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; tabs.
1173       */
1174      protected void setEntityFormTabsAndGroups(EntityForm ef, Map&lt;String, TabMetadata&gt; tabMetadataMap) {
1175          if (tabMetadataMap != null) {
1176              Set&lt;String&gt; tabMetadataKeySet = tabMetadataMap.keySet();
1177              for (String tabKey : tabMetadataKeySet) {
1178                  TabMetadata tabMetadata = tabMetadataMap.get(tabKey);
1179                  String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySet);
1180  
1181                  if (foundMatchingTab(unprocessedTabName)) {
1182                      if (!tabExists(ef, unprocessedTabName)) {
1183                          TabMetadata originalTabMetadata = tabMetadataMap.get(unprocessedTabName);
1184                          unprocessedTabName = ef.addTabFromTabMetadata(originalTabMetadata);
1185                      }
1186                  } else {
1187                      if (tabExists(ef, tabKey)) {
1188                          unprocessedTabName = tabKey;
1189                      } else {
1190                          unprocessedTabName = ef.addTabFromTabMetadata(tabMetadata);
1191                      }
1192                  }
1193  
1194                  Set&lt;String&gt; groupMetadataKeySet = tabMetadata.getGroupMetadata().keySet();
1195                  for (String groupKey : groupMetadataKeySet) {
<abbr title="1196                      ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName);">1196                      ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName)ðŸ”µ</abbr>
1197                  }
1198              }
1199          }
1200      }
1201  
1202      /**
1203       * Search for any other tab on the target entity that has the same display value
1204       *  as the value provided tab name.
1205       *
1206       * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message property.
<abbr title="1207       *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySet">1207       *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySeðŸ”µ</abbr>
1208       *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method should return
1209       *  &quot;Example_Tab&quot; which will end up causing the tabs to merge together.
1210       *
1211       * If a tab with the same display value cannot be found, then we should return null to indicate that there
1212       *  is no matching tab with the same processed tabName value.
1213       */
1214      protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySet) {
1215          for (String tabKey : tabMetadataKeySet) {
1216              String tabName = tabMetadata.getTabName();
1217  
1218              if (processedTabKeyMatchesTabName(tabName, tabKey)) {
1219                  return tabKey;
1220              }
1221          }
1222  
1223          return null;
1224      }
1225  
1226      protected boolean processedTabKeyMatchesTabName(String tabName, String candidateTabKey) {
1227          try {
1228              String processedCandidateTabKey = BLCMessageUtils.getMessage(candidateTabKey);
1229              boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateTabKey);
1230  
1231              return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidateTabKey);
1232          } catch (NoSuchMessageException e) {
1233              LOG.debug(&quot;No such message exists for &quot; + candidateTabKey, e);
1234  
1235              return false;
1236          }
1237      }
1238  
1239      protected boolean foundMatchingTab(String unprocessedTabName) {
1240          return (unprocessedTabName != null);
1241      }
1242  
1243      protected boolean tabExists(EntityForm ef, String tabKey) {
1244          return (ef.findTab(tabKey) != null);
1245      }
1246  
1247      @Override
1248      public String extractDefaultValueFromFieldData(String fieldType, BasicFieldMetadata fmd) {
1249          String defaultValue = fmd.getDefaultValue();
1250          if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1251                  || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1252                  || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1253              return null;
1254          } else if (fieldType.equals(SupportedFieldType.INTEGER.toString())) {
1255              try {
1256                  Integer.parseInt(defaultValue);
1257              } catch (NumberFormatException  e) {
1258                  String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defaultValue);
1259                  LOG.debug(msg);
1260                  return null;
1261              }
1262          } else if (fieldType.equals(SupportedFieldType.DECIMAL.toString())
1263                  || fieldType.equals(SupportedFieldType.MONEY.toString())) {
1264              try {
1265                  BigDecimal val = new BigDecimal(defaultValue);
1266              } catch (NumberFormatException  e) {
1267                  String msg = buildMsgForDefValException(fieldType.toString(), fmd, defaultValue);
1268                  LOG.debug(msg);
1269                  return null;
1270              }
1271          } else if (fieldType.equals(SupportedFieldType.BOOLEAN.toString())) {
1272              if (!defaultValue.toLowerCase().equals(&quot;true&quot;) &amp;&amp; !defaultValue.toLowerCase().equals(&quot;false&quot;)
1273                      &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)) {
1274                  String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defaultValue);
1275                  LOG.debug(msg);
1276                  return null;
1277              }
1278          } else if (fieldType.equals(SupportedFieldType.DATE.toString())) {
1279              DateFormat format = FormatUtil.getDateFormat();
1280              if (defaultValue.toLowerCase().contains(&quot;today&quot;)) {
1281                  defaultValue = format.format(new Date());
1282              } else {
1283                  try {
1284                      Date date = format.parse(defaultValue);
1285                      defaultValue = format.format(date);
1286                  } catch (ParseException e) {
<abbr title="1287                      String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue);">1287                      String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue)ðŸ”µ</abbr>
1288                      LOG.debug(msg);
1289                      return null;
1290                  }
1291              }
1292          }
1293          return defaultValue;
1294      }
1295  
1296      protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue) {
<abbr title="1297          return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - Failed to parse &quot;">1297          return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - FailedðŸ”µ</abbr>
1298                  + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue) + &quot; ]&quot;;
1299      }
1300  
1301      @Override
1302      public void removeNonApplicableFields(ClassMetadata cmd, EntityForm entityForm, String entityType) {
1303          for (Property p : cmd.getProperties()) {
1304              if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entityType)) {
1305                  entityForm.removeField(p.getName());
1306              }
1307          }
1308      }
1309  
1310      @Override
1311      public EntityForm createEntityForm(ClassMetadata cmd, List&lt;SectionCrumb&gt; sectionCrumbs)
1312              throws ServiceException {
1313          EntityForm ef = createStandardEntityForm();
1314          populateEntityForm(cmd, ef, sectionCrumbs);
1315          return ef;
1316      }
1317  
1318      protected String extractSectionIdentifierFromCrumb(List&lt;SectionCrumb&gt; sectionCrumbs) {
1319          if (sectionCrumbs != null &amp;&amp; sectionCrumbs.size() &gt; 0) {
1320              return sectionCrumbs.get(0).getSectionIdentifier();
1321          } else {
1322              return null;
1323          }
1324      }
1325  
1326      @Override
1327      public void populateEntityForm(ClassMetadata cmd, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)
1328              throws ServiceException {
1329          ef.setCeilingEntityClassname(cmd.getCeilingType());
1330  
1331          String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
1332  
1333          AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType(),
1334                  sectionIdentifier);
1335          if (section != null) {
1336              ef.setSectionKey(section.getUrl());
1337          } else {
1338              ef.setSectionKey(cmd.getCeilingType());
1339          }
1340          ef.setSectionCrumbsImpl(sectionCrumbs);
1341  
1342          setEntityFormTabsAndGroups(ef, cmd.getTabAndGroupMetadata());
1343  
1344          setEntityFormFields(cmd, ef, Arrays.asList(cmd.getProperties()));
1345  
1346          populateDropdownToOneFields(ef, cmd);
1347  
1348          extensionManager.getProxy().modifyUnpopulatedEntityForm(ef);
1349      }
1350  
1351      /**
1352       * This method is invoked when EntityForms are created and is meant to provide a hook to add
1353       * additional entity form actions for implementors of Broadleaf. Broadleaf modules will typically
1354       * leverage {@link FormBuilderExtensionHandler#addAdditionalFormActions(EntityForm)} method.
1355       * @param ef
1356       */
1357      protected void addAdditionalFormActions(EntityForm ef) {
1358  
1359      }
1360  
1361      @Override
1362      public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbs)
1363              throws ServiceException {
1364          EntityForm ef = createStandardEntityForm();
1365          populateEntityForm(cmd, entity, ef, sectionCrumbs);
1366          addAdditionalFormActions(ef);
1367          extensionManager.getProxy().addAdditionalFormActions(ef);
1368          return ef;
1369      }
1370  
1371      @Override
<abbr title="1372      public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1372      public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumðŸ”µ</abbr>
1373              throws ServiceException {
1374          // Get the empty form with appropriate fields
1375          populateEntityForm(cmd, ef, sectionCrumbs);
1376  
1377          String idProperty = adminEntityService.getIdProperty(cmd);
1378          ef.setId(entity.findProperty(idProperty).getValue());
1379          ef.setEntityType(entity.getType()[0]);
1380  
1381          populateEntityFormFieldValues(cmd, entity, ef);
1382  
1383          Property p = entity.findProperty(BasicPersistenceModule.MAIN_ENTITY_NAME_PROPERTY);
1384          if (p != null) {
1385              ef.setMainEntityName(p.getValue());
1386          }
1387  
1388          extensionManager.getProxy().modifyPopulatedEntityForm(ef, entity);
1389      }
1390  
1391      protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef) {
1392          for (Property p : cmd.getProperties()) {
1393              FieldMetadata fmd = p.getMetadata();
1394  
1395              if (shouldHideField(fmd, entity)) {
1396                  if (fmd instanceof CollectionMetadata) {
1397                      ef.removeListGrid(p.getName());
1398                  } else {
1399                      ef.removeField(p.getName());
1400                  }
1401              }
1402          }
1403      }
1404  
1405      protected boolean shouldHideField(FieldMetadata fmd, Entity entity) {
1406          if (fmd == null || fmd.getShowIfFieldEquals() == null) {
1407              return false;
1408          }
1409  
1410          for (String property : fmd.getShowIfFieldEquals().keySet()) {
1411              List&lt;String&gt; values = fmd.getShowIfFieldEquals().get(property);
1412              Property entityProp = entity.findProperty(property);
1413  
1414              if (entityProp == null || values.contains(entityProp.getValue())) {
1415                  return false;
1416              }
1417          }
1418          return true;
1419      }
1420  
1421      @Override
1422      public void populateEntityFormFieldValues(ClassMetadata cmd, Entity entity, EntityForm ef) {
1423          // Set the appropriate property values
1424          for (Property p : cmd.getProperties()) {
1425              if (p.getMetadata() instanceof BasicFieldMetadata) {
1426                  BasicFieldMetadata basicFM = (BasicFieldMetadata) p.getMetadata();
1427  
1428                  Property entityProp = entity.findProperty(p.getName());
1429  
1430                  boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibility());
1431                  //always show special map fields
1432                  if (p.getName().equals(&quot;key&quot;) || p.getName().equals(&quot;priorKey&quot;)) {
1433                      explicitlyShown = true;
1434                  }
1435  
1436                  if (entityProp == null &amp;&amp; explicitlyShown) {
1437                      Field field = ef.findField(p.getName());
1438                      if (field != null) {
1439                          field.setValue(null);
1440                      }
<abbr title="1441                  } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1441                  } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFiðŸ”µ</abbr>
1442                      ef.removeField(p.getName());
1443                  } else {
1444                      Field field = ef.findField(p.getName());
1445                      if (field != null) {
1446                          if (entityProp != null) {
<abbr title="1447                              //protect against null - can happen with password confirmation fields (i.e. admin user)">1447                              //protect against null - can happen with password confirmation fields (i.e. admin userðŸ”µ</abbr>
1448                              field.setDirty(entityProp.getIsDirty());
1449                          }
1450                          if (basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE
1451                                  || basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE_TIME
1452                                  || basicFM.getFieldType()==SupportedFieldType.RULE_WITH_QUANTITY) {
1453                              RuleBuilderField rbf = (RuleBuilderField) field;
1454                              if (entity.getPMap().containsKey(rbf.getJsonFieldName())) {
1455                                  String json = entity.getPMap().get(rbf.getJsonFieldName()).getValue();
1456                                  rbf.setJson(json);
1457                                  DataWrapper dw = convertJsonToDataWrapper(json);
1458                                  if (dw != null) {
1459                                      rbf.setDataWrapper(dw);
1460                                  }
1461                              }
1462                          }
1463                          if (basicFM.getFieldType() == SupportedFieldType.MEDIA) {
1464                              field.setValue(entityProp.getValue());
1465                              field.setDisplayValue(entityProp.getDisplayValue());
1466                              MediaField mf = (MediaField) field;
<abbr title="1467                              Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(), MediaDto.class);">1467                              Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(),ðŸ”µ</abbr>
<abbr title="1468                              mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(), type));">1468                              mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(),ðŸ”µ</abbr>
1469                          } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {
1470                              field.setValue(entityProp.getValue());
1471                              field.setDisplayValue(entityProp.getDisplayValue());
1472                          }
1473                      }
1474                  }
1475              }
1476          }
1477      }
1478  
1479      /**
1480       * When using Thymeleaf, we need to convert the JSON string back to
1481       * a DataWrapper object because Thymeleaf escapes JSON strings.
1482       * Thymeleaf uses it&#x27;s own object de-serializer
1483       * see: https://github.com/thymeleaf/thymeleaf/issues/84
1484       * see: http://forum.thymeleaf.org/Spring-Javascript-and-escaped-JSON-td4024739.html
1485       * @param json
1486       * @return DataWrapper
1487       * @throws IOException
1488       */
1489      protected DataWrapper convertJsonToDataWrapper(String json) {
1490          ObjectMapper mapper = new ObjectMapper();
1491          DataDTODeserializer dtoDeserializer = new DataDTODeserializer();
<abbr title="1492          SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null));">1492          SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null)ðŸ”µ</abbr>
1493          module.addDeserializer(DataDTO.class, dtoDeserializer);
1494          mapper.registerModule(module);
1495          try {
1496              return mapper.readValue(json, DataWrapper.class);
1497          } catch (IOException e) {
1498              throw new RuntimeException(e);
1499          }
1500      }
1501  
1502      protected void populateDropdownToOneFields(EntityForm ef, ClassMetadata cmd)
1503              throws ServiceException {
1504          for (Property p : cmd.getProperties()) {
1505              if (p.getMetadata() instanceof BasicFieldMetadata) {
1506                  BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
1507                  if (LookupType.DROPDOWN.equals(fmd.getLookupType())
1508                          &amp;&amp; !ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
1509                      // Get the records
1510                      PersistencePackageRequest toOnePpr = PersistencePackageRequest.standard()
1511                              .withCeilingEntityClassname(fmd.getForeignKeyClass());
1512                      Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecords();
1513  
1514                      // Determine the id field
1515                      String idProp = null;
<abbr title="1516                      ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSet().getClassMetaData();">1516                      ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSðŸ”µ</abbr>
1517                      for (Property foreignP : foreignClassMd.getProperties()) {
1518                          if (foreignP.getMetadata() instanceof BasicFieldMetadata) {
1519                              BasicFieldMetadata foreignFmd = (BasicFieldMetadata) foreignP.getMetadata();
1520                              if (SupportedFieldType.ID.equals(foreignFmd.getFieldType())) {
1521                                  idProp = foreignP.getName();
1522                              }
1523                          }
1524                      }
1525  
1526                      if (idProp == null) {
<abbr title="1527                          throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClass());">1527                          throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClassðŸ”µ</abbr>
1528                      }
1529  
1530                      // Determine the display field
1531                      String displayProp = fmd.getLookupDisplayProperty();
1532  
1533                      // Build the options map
1534                      Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
1535                      for (Entity row : rows) {
1536                          Property prop = row.findProperty(displayProp);
1537                          if (prop == null) {
<abbr title="1538                              LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entity [&quot; +">1538                              LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entðŸ”µ</abbr>
1539                                      ef.getCeilingEntityClassname() + &quot;]&quot;);
1540                          } else {
1541                              String displayValue = prop.getDisplayValue();
1542                              if (StringUtils.isBlank(displayValue)) {
1543                                  displayValue = prop.getValue();
1544                              }
1545                              options.put(row.findProperty(idProp).getValue(), displayValue);
1546                          }
1547                      }
1548  
1549                      // Set the options on the entity field
1550                      ComboField cf = (ComboField) ef.findField(p.getName());
1551                      cf.setOptions(options);
1552                  }
1553              }
1554          }
1555      }
1556  
1557      @Override
<abbr title="1558      public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, List&lt;SectionCrumb&gt; sectionCrumbs)">1558      public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRðŸ”µ</abbr>
1559              throws ServiceException {
1560          EntityForm ef = createStandardEntityForm();
1561          populateEntityForm(cmd, entity, collectionRecords, ef, sectionCrumbs);
1562          addAdditionalFormActions(ef);
1563          extensionManager.getProxy().addAdditionalFormActions(ef);
1564          return ef;
1565      }
1566  
1567      @Override
<abbr title="1568      public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1568      public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecorðŸ”µ</abbr>
1569              throws ServiceException {
1570          // Get the form with values for this entity
1571          populateEntityForm(cmd, entity, ef, sectionCrumbs);
1572  
1573          // Attach the sub-collection list grids and specialty UI support
1574          for (Property p : cmd.getProperties()) {
1575              if (p.getMetadata() instanceof BasicFieldMetadata) {
1576                  continue;
1577              }
1578  
1579              if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entity.getType()[0])) {
1580                  continue;
1581              }
1582  
1583              if (collectionRecords != null &amp;&amp; !collectionRecords.isEmpty()) {
1584                  DynamicResultSet subCollectionEntities = collectionRecords.get(p.getName());
1585                  String containingEntityId = entity.getPMap().get(ef.getIdProperty()).getValue();
<abbr title="1586                  ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSectionKey(), sectionCrumbs);">1586                  ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSeðŸ”µ</abbr>
1587  
1588                  CollectionMetadata md = ((CollectionMetadata) p.getMetadata());
1589                  if (md instanceof BasicCollectionMetadata) {
1590                      PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1591                      ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1591                      ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().gðŸ”µ</abbr>
1592                      if (collectionCmd.getPolymorphicEntities().getChildren().length != 0) {
<abbr title="1593                          List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTrees();">1593                          List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTreeðŸ”µ</abbr>
1594                          ListGridActionGroup actionGroup = new ListGridActionGroup().withName(&quot;Add&quot;);
1595                          for (ClassTree entityType : entityTypes) {
1596                              ListGridAction ADD = new ListGridAction(ListGridAction.ADD)
1597                                      .withButtonClass(AddMethodType.PERSIST_EMPTY==
<abbr title="1598                                              ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-grid-add-empty&quot;:&quot;sub-list-grid-add&quot;)">1598                                              ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-grid-add-eðŸ”µ</abbr>
1599                                      .withActionTargetEntity(entityType.getFullyQualifiedClassname())
1600                                      .withUrlPostfix(&quot;/add&quot;)
1601                                      .withIconClass(&quot;fa fa-plus&quot;)
1602                                      .withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyName()));
1603                              actionGroup.getListGridActions().add(0, ADD);
1604                          }
1605                          listGrid.addToolbarActionGroup(actionGroup);
1606                      } else {
1607                          listGrid.getToolbarActions().add(0, AddMethodType.PERSIST_EMPTY==
<abbr title="1608                                  ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ADD_EMPTY:DefaultListGridActions.ADD);">1608                                  ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ADD_EMPTYðŸ”µ</abbr>
1609                      }
1610                  } else {
1611                      listGrid.getToolbarActions().add(0, DefaultListGridActions.ADD);
1612                  }
1613  
1614                  if (subCollectionEntities.getUnselectedTabMetadata().get(md.getTab())!=null) {
1615                      ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), true);
1616                  } else {
1617                      ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), false);
1618                  }
1619              }
1620          }
1621  
1622          if (CollectionUtils.isEmpty(ef.getActions())) {
1623              ef.addAction(DefaultEntityFormActions.SAVE);
1624          }
1625  
1626          addDeleteActionIfAllowed(ef, cmd, entity);

1627          setReadOnlyState(ef, cmd, entity);
1628  
1629          // check for fields that should be hidden based on annotations
1630          setVisibilityBasedOnShowIfFieldEquals(cmd, entity, ef);
1631  
1632          extensionManager.getProxy().modifyDetailEntityForm(ef);
1633      }
1634  
1635      /**
<abbr title="1636       * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The user can">1636       * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The usðŸ”µ</abbr>
1637       * delete an entity for the following cases:
1638       * &lt;ol&gt;
1639       *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represented by
1640       *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;
1641       *  &lt;li&gt;The user has the security necessary to delete the given &lt;b&gt;entity&lt;/b&gt; according to the
1642       *  {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}&lt;/li&gt;
1643       * &lt;/ol&gt;
1644       *
1645       * @param entityForm the form being generated
1646       * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1647       * @param entity the entity being edited
1648       * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1649       * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1650       * @see {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}
1651       */
1652      protected void addDeleteActionIfAllowed(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1653          boolean canDelete = true;







1654          try {
1655              String securityEntityClassname = getSecurityClassname(entityForm, cmd);
1656              adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.REMOVE);


1657          } catch (ServiceException e) {
1658              if (e instanceof SecurityServiceException) {
1659                  canDelete = false;
1660              }
1661          }
1662  
1663          // If I cannot update a record then I certainly cannot delete it either
1664          if (canDelete) {
<abbr title="1665              canDelete = rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1665              canDelete = rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entðŸ”µ</abbr>
1666          }
1667  
1668          if (canDelete) {
<abbr title="1669              canDelete = rowLevelSecurityService.canRemove(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1669              canDelete = rowLevelSecurityService.canRemove(adminRemoteSecurityService.getPersistentAdminUser(), entðŸ”µ</abbr>
1670          }
1671  
1672          if (canDelete) {
1673              entityForm.addAction(DefaultEntityFormActions.DELETE);
1674          }

































1675      }
1676  
1677      /**
1678       * The given &lt;b&gt;entityForm&lt;/b&gt; is marked as readonly for the following cases:
1679       * &lt;ol&gt;
1680       *  &lt;li&gt;All of the properties from &lt;b&gt;cmd&lt;/b&gt; are readonly&lt;/b&gt;&lt;/li&gt;
<abbr title="1681       *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represented by">1681       *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represeðŸ”µ</abbr>
1682       *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;
1683       *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to the
1684       *  {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}&lt;/li&gt;
1685       * &lt;/ol&gt;
1686       *
1687       * @param entityForm the form being generated
1688       * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1689       * @param entity the entity being edited
1690       * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1691       * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1692       * @see {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}
1693       */
1694      protected void setReadOnlyState(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1695          boolean readOnly = true;
1696  
1697          // If all of the fields are read only, we&#x27;ll mark the form as such
1698          for (Property property : cmd.getProperties()) {
1699              FieldMetadata fieldMetadata = property.getMetadata();
1700              if (fieldMetadata instanceof BasicFieldMetadata) {
<abbr title="1701                  readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieldMetadata).getReadOnly();">1701                  readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieðŸ”µ</abbr>
1702                  if (!readOnly) {
1703                      break;
1704                  }
1705              } else {
1706                  readOnly = ((CollectionMetadata) fieldMetadata).isMutable();
1707                  if (!readOnly) {
1708                      break;
1709                  }
1710              }
1711          }
1712  
1713          if (!readOnly) {
<abbr title="1714              // If the user does not have edit permissions, we will go ahead and make the form read only to prevent confusion">1714              // If the user does not have edit permissions, we will go ahead and make the form read only to preventðŸ”µ</abbr>
1715              try {
1716                  String securityEntityClassname = getSecurityClassname(entityForm, cmd);
1717                  adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDATE);
1718              } catch (ServiceException e) {
1719                  if (e instanceof SecurityServiceException) {
1720                      readOnly = true;
1721                  }
1722              }
1723          }
1724  
<abbr title="1725          // if the normal admin security service has not deemed this readonly and the all of the properties on the entity">1725          // if the normal admin security service has not deemed this readonly and the all of the properties on the ðŸ”µ</abbr>
1726          // are not readonly, then check the row-level security
1727          if (!readOnly) {
<abbr title="1728              readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1728              readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entðŸ”µ</abbr>
1729          }
1730  
1731          if (readOnly) {
1732              entityForm.setReadOnly();
<abbr title="1733              //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface">1733              //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements ðŸ”µ</abbr>
1734              if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title="1735                  EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();">1735                  EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityðŸ”µ</abbr>
<abbr title="1736                  for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {">1736                  for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.geðŸ”µ</abbr>
1737                      for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
1738                          if (modifier.isQualified(data.getModifierType())) {
1739                              modifier.modifyEntityForm(new EntityFormModifierRequest()
1740                                      .withEntityForm(entityForm)
1741                                      .withConfiguration(data)
1742                                      .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
1743                                      .withEntity(entity)
1744                                      .withRowLevelSecurityService(rowLevelSecurityService));
1745                          }
1746                      }
1747                  }
1748              }
1749          }
1750      }
1751  
1752      /**
1753       * Obtains the class name suitable for passing along to the {@link SecurityVerifier}
1754       * @param entityForm
1755       * @param cmd
1756       * @return
1757       */
1758      protected String getSecurityClassname(EntityForm entityForm, ClassMetadata cmd) {
1759          String securityEntityClassname = entityForm.getCeilingEntityClassname();
1760  
1761          if (!StringUtils.isEmpty(cmd.getSecurityCeilingType())) {
1762              securityEntityClassname = cmd.getSecurityCeilingType();
1763          } else {
1764              if (entityForm.getDynamicFormInfos() != null) {
1765                  for (DynamicEntityFormInfo info : entityForm.getDynamicFormInfos().values()) {
1766                      if (!StringUtils.isEmpty(info.getSecurityCeilingClassName())) {
1767                          securityEntityClassname = info.getSecurityCeilingClassName();
1768                          break;
1769                      }
1770                  }
1771              }
1772          }
1773  
1774          return securityEntityClassname;
1775      }
1776  
1777      @Override
1778      public void populateEntityFormFields(EntityForm ef, Entity entity) {
1779          populateEntityFormFields(ef, entity, true, true);
1780      }
1781  
1782      @Override
1783      public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean populateId) {
1784          if (populateId) {
1785              ef.setId(entity.findProperty(ef.getIdProperty()).getValue());
1786          }
1787          if (populateType) {
1788              ef.setEntityType(entity.getType()[0]);
1789          }
1790  
1791          for (Entry&lt;String, Field&gt; entry : ef.getFields().entrySet()) {
1792              Property entityProp = entity.findProperty(entry.getKey());
1793              if (entityProp != null) {
1794                  entry.getValue().setValue(entityProp.getValue());
1795                  entry.getValue().setDisplayValue(entityProp.getDisplayValue());
1796              }
1797          }
1798      }
1799  
1800      @Override
1801      public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedList) {
1802          Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());
1803          Property entityProp = entity.findProperty(ef.getIdProperty());
1804          field.setValue(entityProp.getValue());
1805  
1806          if (StringUtils.isNotBlank(adornedList.getSortField())) {
1807              field = ef.findField(adornedList.getSortField());
1808              entityProp = entity.findProperty(adornedList.getSortField());
1809              if (field != null &amp;&amp; entityProp != null) {
1810                  field.setValue(entityProp.getValue());
1811              }
1812          }
1813      }
1814  
1815      @Override
1816      public void populateMapEntityFormFields(EntityForm ef, Entity entity) {
1817          Field field = ef.findField(&quot;priorKey&quot;);
1818          Property entityProp = entity.findProperty(&quot;key&quot;);
1819          if (field != null &amp;&amp; entityProp != null) {
1820              field.setValue(entityProp.getValue());
1821          }
1822      }
1823  
1824      @Override
<abbr title="1825      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1825      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedLisðŸ”µ</abbr>
1826              String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)
1827              throws ServiceException {
1828          EntityForm ef = createStandardAdornedEntityForm();
<abbr title="1829          return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAdd);">1829          return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAðŸ”µ</abbr>
1830      }
1831  
1832      @Override
<abbr title="1833      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1833      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedLisðŸ”µ</abbr>
<abbr title="1834              String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1834              String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, booleaðŸ”µ</abbr>
1835              throws ServiceException {
1836          ef.setEntityType(adornedList.getAdornedTargetEntityClassname());
1837  
1838          // Get the metadata for this adorned field
1839          PersistencePackageRequest request = PersistencePackageRequest.adorned()
1840                  .withCeilingEntityClassname(adornedMd.getCollectionCeilingEntity())
1841                  .withAdornedList(adornedList)
1842                  .withSectionCrumbs(sectionCrumbs);
1843          request.setAddOperationInspect(isAdd);
<abbr title="1844          ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getClassMetaData();">1844          ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getCðŸ”µ</abbr>
1845  
1846          List&lt;Property&gt; entityFormProperties = new ArrayList&lt;&gt;();
1847          if (isViewCollectionItem) {
1848              Collections.addAll(entityFormProperties, collectionMetadata.getProperties());
1849          } else {
1850              // We want our entity form to only render the maintained adorned target fields
1851              for (String targetFieldName : adornedMd.getMaintainedAdornedTargetFields()) {
1852                  Property p = collectionMetadata.getPMap().get(targetFieldName);
<abbr title="1853                  if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExcluded())) {">1853                  if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExðŸ”µ</abbr>
1854                      ((BasicFieldMetadata) p.getMetadata()).setVisibility(VisibilityEnum.VISIBLE_ALL);
1855                      entityFormProperties.add(p);
1856                  }
1857              }
1858          }
1859  
1860          // Set the maintained fields on the form
1861          setEntityFormFields(collectionMetadata, ef, entityFormProperties);
1862  
1863          // Add these two additional hidden fields that are required for persistence
1864          Field f = new Field()
1865                  .withName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty())
1866                  .withFieldType(SupportedFieldType.HIDDEN.toString())
1867                  .withValue(parentId);
1868          ef.addHiddenField(collectionMetadata, f);
1869  
1870          f = new Field()
1871                  .withName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty())
1872                  .withFieldType(SupportedFieldType.HIDDEN.toString())
1873                  .withIdOverride(&quot;adornedTargetIdProperty&quot;);
1874          ef.addHiddenField(collectionMetadata, f);
1875  
1876          if (StringUtils.isNotBlank(adornedList.getSortField())) {
1877              f = new Field()
1878                      .withName(adornedList.getSortField())
1879                      .withFieldType(SupportedFieldType.HIDDEN.toString());
1880              ef.addHiddenField(collectionMetadata, f);
1881          }
1882  
1883          ef.setParentId(parentId);
1884  
1885          extensionManager.getProxy().addAdditionalAdornedFormActions(ef);
1886  
1887          return ef;
1888      }
1889  
1890  
1891      @Override
<abbr title="1892      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId)">1892      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String pðŸ”µ</abbr>
1893              throws ServiceException {
1894          EntityForm ef = createStandardEntityForm();
1895          return buildMapForm(mapMd, mapStructure, cmd, parentId, ef);
1896      }
1897  
1898      @Override
<abbr title="1899      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId, EntityForm ef)">1899      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String pðŸ”µ</abbr>
1900              throws ServiceException {
1901          ForeignKey foreignKey = (ForeignKey) mapMd.getPersistencePerspective()
1902                  .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY);
1903          ef.setEntityType(foreignKey.getForeignKeyClass());
1904  
1905          Field keyField;
1906          if (!mapMd.getForceFreeFormKeys()) {
1907              // We will use a combo field to render the key choices
1908              ComboField temp = new ComboField();
1909              temp.withName(&quot;key&quot;)
1910                      .withFieldType(&quot;combo_field&quot;)
1911                      .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1912              if (mapMd.getKeys() != null) {
1913                  // The keys can be explicitly set in the annotation...
1914                  temp.setOptions(mapMd.getKeys());
1915              } else {
1916                  // Or they could be based on a different entity
1917                  PersistencePackageRequest ppr = PersistencePackageRequest.standard()
1918                          .withCeilingEntityClassname(mapMd.getMapKeyOptionEntityClass());
1919  
1920                  DynamicResultSet drs = adminEntityService.getRecords(ppr).getDynamicResultSet();
1921  
1922                  for (Entity entity : drs.getRecords()) {
1923                      String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getValue();
<abbr title="1924                      String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getValue();">1924                      String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getVaðŸ”µ</abbr>
1925                      temp.putOption(keyValue, keyDisplayValue);
1926                  }
1927              }
1928              keyField = temp;
1929          } else {
1930              keyField = new Field().withName(&quot;key&quot;)
1931                                  .withFieldType(SupportedFieldType.STRING.toString())
1932                                  .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1933          }
1934          keyField.setRequired(true);
1935          ef.addMapKeyField(cmd, keyField);
1936  
1937          // Set the fields for this form
1938          List&lt;Property&gt; mapFormProperties;
1939          if (mapMd.isSimpleValue()) {
1940              ef.setIdProperty(&quot;key&quot;);
1941              mapFormProperties = new ArrayList&lt;&gt;();
1942              Property valueProp = cmd.getPMap().get(&quot;value&quot;);
1943              mapFormProperties.add(valueProp);
1944          } else {
1945              String valueClassName = mapStructure.getValueClassName();
1946              List&lt;String&gt; classNames = getValueClassNames(valueClassName);
1947  
1948              mapFormProperties = new ArrayList&lt;&gt;(Arrays.asList(cmd.getProperties()));
1949              filterMapFormProperties(mapFormProperties, classNames);
1950          }
1951  
1952          setEntityFormFields(cmd, ef, mapFormProperties);
1953  
1954          Field f = new Field()
1955                  .withName(&quot;priorKey&quot;)
1956                  .withFieldType(SupportedFieldType.HIDDEN.toString());
1957          ef.addHiddenField(cmd, f);
1958  
1959          ef.setParentId(parentId);
1960  
1961          return ef;
1962      }
1963  
1964      protected List&lt;String&gt; getValueClassNames(String valueClassName) {
1965          PersistenceManager pm = PersistenceManagerFactory.getPersistenceManager(valueClassName);
1966          List&lt;String&gt; classNames = new ArrayList&lt;&gt;();
1967          try {
1968              Class&lt;?&gt;[] mapEntities = pm.getPolymorphicEntities(valueClassName);
1969              for (Class clazz : mapEntities) {
1970                  classNames.add(clazz.getName());
1971              }
1972          } catch (ClassNotFoundException e) {
1973              classNames.add(valueClassName);
1974          }
1975          return classNames;
1976      }
1977  
1978      protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNames) {
1979          CollectionUtils.filter(mapFormProperties, new Predicate() {
1980              @Override
1981              public boolean evaluate(Object object) {
1982                  Property p = (Property) object;
1983                  for (String availType : p.getMetadata().getAvailableToTypes()) {
1984                      if (classNames.contains(availType)) {
1985                          return true;
1986                      }
1987                  }
1988                  return false;
1989              }
1990          });
1991      }
1992  
1993      protected EntityForm createStandardEntityForm() {
1994          EntityForm ef = new EntityForm();
1995          ef.addAction(DefaultEntityFormActions.SAVE);
1996          return ef;
1997      }
1998  
1999      protected EntityForm createStandardAdornedEntityForm() {
2000          EntityForm ef = new EntityForm();
2001          ef.addAction(DefaultAdornedEntityFormActions.Add);
2002          return ef;
2003      }
2004  
2005      protected VisibilityEnum[] getGridHiddenVisibilities() {
2006          return FormBuilderServiceImpl.GRID_HIDDEN_VISIBILITIES;
2007      }
2008  
2009      protected VisibilityEnum[] getFormHiddenVisibilities() {
2010          return FormBuilderServiceImpl.FORM_HIDDEN_VISIBILITIES;
2011      }
2012  
2013  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            