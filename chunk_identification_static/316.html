<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>316</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    316
                    <a href="315.html">prev</a>
                    <a href="317.html">next</a>
                    <a href="316_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_6780311d33539eb86c4007a7d1993f6f1467a837_src/com/automattic/simplenote/NoteEditorFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;6780311d33539eb86c4007a7d1993f6f1467a837:src/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;6780311d33539eb86c4007a7d1993f6f1467a837^1:src/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;6780311d33539eb86c4007a7d1993f6f1467a837^2:src/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;20279c862696f156d42fbdab7ae10281f312fb27:src/com/automattic/simplenote/NoteEditorFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   2 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 package com.automattic.simplenote;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7 import java.util.Calendar;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10 import android.app.Fragment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11 import android.content.Context;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12 import android.os.Bundle;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13 import android.os.Handler;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14 import android.text.Editable;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15 import android.text.SpannableString;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16 import android.text.Spanned;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17 import android.text.TextUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18 import android.text.TextWatcher;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19 import android.util.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 import android.view.LayoutInflater;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 import android.view.View;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 import android.view.ViewGroup;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import android.view.inputmethod.InputMethodManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import android.widget.ArrayAdapter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import android.widget.EditText;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import android.widget.MultiAutoCompleteTextView.Tokenizer;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import android.widget.TextView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import android.widget.ToggleButton;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import com.automattic.simplenote.models.Note;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import com.automattic.simplenote.models.Tag;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import com.simperium.client.Bucket;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import com.simperium.client.Bucket.ObjectCursor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import com.simperium.client.BucketObjectMissingException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 public class NoteEditorFragment extends Fragment implements TextWatcher {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 	 * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 	 * represents.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 	public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43     private static final int AUTOSAVE_DELAY_MILLIS = 2000;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 	 * The dummy content this fragment is presenting.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 	private Note mNote;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 	private EditText mContentEditText;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 	private TagsMultiAutoCompleteTextView mTagView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51     private ToggleButton mPinButton;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52     private boolean mShowNoteTitle;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53     private Handler mAutoSaveHandler;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 	 * Mandatory empty constructor for the fragment manager to instantiate the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 	 * fragment (e.g. upon screen orientation changes).</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 	public NoteEditorFragment() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63 	public void onCreate(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64 		super.onCreate(savedInstanceState);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66 		if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67 	        Simplenote application = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68 			Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69 			String key = getArguments().getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 			try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71     			mNote = notesBucket.get(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 			} catch (BucketObjectMissingException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73 				// TODO: Handle a missing note</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         if (!((NotesActivity)getActivity()).isTwoPane())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78             mShowNoteTitle = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         mAutoSaveHandler = new Handler();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85 	public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 		View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 		mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88         mContentEditText.addTextChangedListener(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92 		refreshContent();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 		</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94 		// Populate tag list</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95         Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96         Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98 		String[] allTags = new String[tagsCursor.getCount()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99         while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100             allTags[tagsCursor.getPosition()] = tagsCursor.getObject().getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102         tagsCursor.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103         ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                 android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105         mTagView.setAdapter(adapter);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106         mTagView.setTokenizer(new SpaceTokenizer());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108 		return rootView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112     public void onResume() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         super.onResume();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116             // Show soft keyboard</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117             mContentEditText.requestFocus();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 119             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 119             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(C🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120             if (inputMethodManager != null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121                 inputMethodManager.showSoftInput(mContentEditText, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126     public void onPause() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         // Hide soft keyboard</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 130         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 130         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Conte🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131         if (inputMethodManager != null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132             inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         if (mAutoSaveHandler != null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         super.onPause();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140     public void setNote(Note note) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         // If we have a note already (on a tablet in landscape), save the note.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         if (mNote != null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143             saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145         mNote = note;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146         refreshContent();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149     public void refreshContent() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150         if (mNote != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152             // Restore the cursor position if possible.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 153             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 153             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toStrin🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154             mContentEditText.setText(mNote.getContent());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                 mContentEditText.setSelection(cursorPosition);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 158             // Populate this note&#x27;s tags in the tagView - TODO: nbradbury - for a large list of tags, using a StringBuilder here would be more efficient"> 158             // Populate this note&#x27;s tags in the tagView - TODO: nbradbury - for a large list of tags, usi🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159             String tagListString = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160             for (String tag : mNote.getTags())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161                 tagListString += tag + &quot; &quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162             mTagView.setText(tagListString);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163             mTagView.setChips();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165             mPinButton.setChecked(mNote.isPinned());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167             setActionBarTitle();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171     private void setActionBarTitle() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172         if (mShowNoteTitle) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173             if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                 getActivity().getActionBar().setTitle(mNote.getTitle());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             else</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176                 getActivity().getActionBar().setTitle(R.string.new_note);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180     int newCursorLocation(String newText, String oldText, int cursorLocation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         // Ported from the iOS app :)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         // Cases:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184         // 1. Text was added after the cursor ==&gt; no change</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185         // 2. Text was added before the cursor ==&gt; location advances</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186         // 3. Text was removed after the cursor ==&gt; no change</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         // 4. Text was removed before the cursor ==&gt; location retreats</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190         int newCursorLocation = cursorLocation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192         int deltaLength = newText.length() - oldText.length();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194         // Case 0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195         if (newText.length() &lt; cursorLocation)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196             return newText.length();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         boolean beforeCursorMatches = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199         boolean afterCursorMatches = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 202             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 202             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursor🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 203             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 203             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.subst🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208         // Cases 2 and 4</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210             newCursorLocation += deltaLength;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212         // Cases 1, 3 and 5 have no change</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213         return newCursorLocation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216     private Runnable autoSaveRunnable = new Runnable() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218         public void run() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219             saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221     };</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225         // Unused</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229     public void afterTextChanged(Editable editable) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230         // Unused</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235     public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239         if (mAutoSaveHandler != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245     private void saveAndSyncNote() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246         if (mNote == null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249         String content = mContentEditText.getText().toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250         String tagString = mTagView.getText().toString().trim();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251         List&lt;String&gt; tagList = Arrays.asList(tagString.split(&quot; &quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 252         ArrayList&lt;String&gt; tags = tagString.equals(&quot;&quot;) ? new ArrayList&lt;String&gt;() : new ArrayList&lt;String&gt;(tagList);"> 252         ArrayList&lt;String&gt; tags = tagString.equals(&quot;&quot;) ? new ArrayList&lt;String&gt;() : new ArrayList&lt;String&gt;(t🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253         if (mNote.hasChanges(content, tags, mPinButton.isChecked())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254             mNote.setContent(content);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255             mNote.setTags(tags);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256             mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257             mNote.setPinned(mPinButton.isChecked());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258             mNote.save();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261         setActionBarTitle();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263         Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266     // Use spaces in tag autocompletion list</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 267 	// From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 267 	// From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268 	public class SpaceTokenizer implements Tokenizer {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270 		public int findTokenStart(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271 			int i = cursor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272 	</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274 			    i--;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276 			while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277 			    i++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279 	</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280 			return i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283 		public int findTokenEnd(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 			int i = cursor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285 			int len = text.length();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 	</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287 			while (i &lt; len) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288 			    if (text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289 			        return i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290 			    } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291 			        i++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292 			    }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294 	</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295 			return len;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298 		public CharSequence terminateToken(CharSequence text) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299 			int i = text.length();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300 	</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301 			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302 			    i--;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304 	</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305 			if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306 			    return text;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307 			} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308 			    if (text instanceof Spanned) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309 			        SpannableString sp = new SpannableString(text + &quot; &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 			        TextUtils.copySpansFrom((Spanned) text, 0, text.length(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311 			                Object.class, sp, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312 			        return sp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313 			    } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314 			        return text + &quot; &quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315 			    }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319 }</span>
 320 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321 package com.automattic.simplenote;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325 import java.util.Calendar;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328 import android.app.Fragment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329 import android.content.Context;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330 import android.os.Bundle;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331 import android.os.Handler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332 import android.text.Editable;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333 import android.text.SpannableString;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334 import android.text.Spanned;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335 import android.text.TextUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336 import android.text.TextWatcher;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337 import android.util.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338 import android.view.LayoutInflater;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339 import android.view.View;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340 import android.view.ViewGroup;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341 import android.view.inputmethod.InputMethodManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342 import android.widget.ArrayAdapter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343 import android.widget.EditText;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344 import android.widget.LinearLayout;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345 import android.widget.MultiAutoCompleteTextView.Tokenizer;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346 import android.widget.ToggleButton;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348 import com.automattic.simplenote.models.Note;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349 import com.automattic.simplenote.models.Tag;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352 import com.simperium.client.Bucket;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353 import com.simperium.client.Bucket.ObjectCursor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354 import com.simperium.client.BucketObjectMissingException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356 public class NoteEditorFragment extends Fragment implements TextWatcher, OnTagAddedListener {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358      * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359      * represents.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361     public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362     private static final int AUTOSAVE_DELAY_MILLIS = 2000;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365      * The dummy content this fragment is presenting.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367     private Note mNote;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368     private EditText mContentEditText;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369     private TagsMultiAutoCompleteTextView mTagView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370     private ToggleButton mPinButton;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371     private boolean mShowNoteTitle;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372     private Handler mAutoSaveHandler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373     private LinearLayout mPlaceholderView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376      * Mandatory empty constructor for the fragment manager to instantiate the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377      * fragment (e.g. upon screen orientation changes).</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379     public NoteEditorFragment() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383     public void onCreate(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384         super.onCreate(savedInstanceState);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386         if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387             Simplenote application = (Simplenote) getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389             String key = getArguments().getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391                 mNote = notesBucket.get(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392             } catch (BucketObjectMissingException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393                 // TODO: Handle a missing note</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397         if (!((NotesActivity) getActivity()).isLargeScreenLandscape())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398             mShowNoteTitle = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400         mAutoSaveHandler = new Handler();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407         mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408         mContentEditText.addTextChangedListener(this);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410         mTagView.setTokenizer(new SpaceTokenizer());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414         if (!((NotesActivity) getActivity()).isLargeScreen())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415             mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 		refreshContent();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419 		return rootView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423     public void onResume() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424         super.onResume();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425         mTagView.setOnTagAddedListener(this);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426         if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427             // Show soft keyboard</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428             mContentEditText.requestFocus();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 430             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 430             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(C🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431             if (inputMethodManager != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432                 inputMethodManager.showSoftInput(mContentEditText, 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437     public void onPause() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438         saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439         mTagView.setOnTagAddedListener(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440         // Hide soft keyboard</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 441         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 441         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Conte🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442         if (inputMethodManager != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443             inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445         if (mAutoSaveHandler != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448         super.onPause();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451     public void setNote(Note note) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452         mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454         // If we have a note already (on a tablet in landscape), save the note.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455         if (mNote != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456             saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458         mNote = note;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459         refreshContent();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462     public void refreshContent() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463         if (mNote != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464             Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465             // Restore the cursor position if possible.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 466             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 466             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toStrin🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467             mContentEditText.setText(mNote.getContent());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468             if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469                 mContentEditText.setSelection(cursorPosition);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471             mPinButton.setChecked(mNote.isPinned());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473             setActionBarTitle();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475             updateTagList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479     public void updateTagList(){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480         // Populate this note&#x27;s tags in the tagView</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481         mTagView.setChips(mNote.getTagString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482         </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483 		// Populate tag list</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484         Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485         Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486         ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487         List&lt;String&gt; allTags = new ArrayList&lt;String&gt;(tagsCursor.getCount());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488         while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489             Tag tag = tagsCursor.getObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490             if (!mNote.hasTag(tag)) allTags.add(tag.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492         tagsCursor.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493         ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494                 android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495         mTagView.setAdapter(adapter);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498     private void setActionBarTitle() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499         if (mShowNoteTitle) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500             if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501                 getActivity().getActionBar().setTitle(mNote.getTitle());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502             else</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503                 getActivity().getActionBar().setTitle(R.string.new_note);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507     int newCursorLocation(String newText, String oldText, int cursorLocation) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508         // Ported from the iOS app :)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509         // Cases:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511         // 1. Text was added after the cursor ==&gt; no change</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512         // 2. Text was added before the cursor ==&gt; location advances</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513         // 3. Text was removed after the cursor ==&gt; no change</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514         // 4. Text was removed before the cursor ==&gt; location retreats</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517         int newCursorLocation = cursorLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519         int deltaLength = newText.length() - oldText.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521         // Case 0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522         if (newText.length() &lt; cursorLocation)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523             return newText.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525         boolean beforeCursorMatches = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526         boolean afterCursorMatches = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 529             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 529             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursor🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 530             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 530             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.subst🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535         // Cases 2 and 4</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537             newCursorLocation += deltaLength;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539         // Cases 1, 3 and 5 have no change</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540         return newCursorLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543     private Runnable autoSaveRunnable = new Runnable() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544         @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545         public void run() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546             saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548     };</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551     public void onTagsChanged(String tagString){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552         mNote.setTagString(tagString);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553         mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554         updateTagList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555         mNote.save();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561         // Unused</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565     public void afterTextChanged(Editable editable) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566         // Unused</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571     public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575         if (mAutoSaveHandler != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581     private void saveAndSyncNote() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582         if (mNote == null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585         String content = mContentEditText.getText().toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586         if (mNote.hasChanges(content, mPinButton.isChecked())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587             mNote.setContent(content);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588             mNote.setTagString(mTagView.getText().toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589             mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590             mNote.setPinned(mPinButton.isChecked());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591             mNote.save();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594         setActionBarTitle();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596         Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599     public void setPlaceholderVisible(boolean isVisible) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600         if (isVisible) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601             mNote = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602             mContentEditText.setText(&quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603             mTagView.setText(&quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604             if (mPlaceholderView != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605                 mPlaceholderView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607             if (mPlaceholderView != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608                 mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612     // Use spaces in tag autocompletion list</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 613     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 613     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-t🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614     public class SpaceTokenizer implements Tokenizer {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616         public int findTokenStart(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617             int i = cursor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620                 i--;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622             while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623                 i++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626             return i;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629         public int findTokenEnd(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630             int i = cursor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631             int len = text.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633             while (i &lt; len) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634                 if (text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635                     return i;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637                     i++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641             return len;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644         public CharSequence terminateToken(CharSequence text) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645             int i = text.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648                 i--;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651             if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652                 return text;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654                 if (text instanceof Spanned) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655                     SpannableString sp = new SpannableString(text + &quot; &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656                     TextUtils.copySpansFrom((Spanned) text, 0, text.length(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657                             Object.class, sp, 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658                     return sp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660                     return text + &quot; &quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665 }</span>
 666 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 package com.automattic.simplenote;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7 import java.util.Calendar;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10 import android.app.Fragment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11 import android.content.Context;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12 import android.os.Bundle;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13 import android.os.Handler;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14 import android.text.Editable;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15 import android.text.SpannableString;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16 import android.text.Spanned;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17 import android.text.TextUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18 import android.text.TextWatcher;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19 import android.util.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 import android.view.LayoutInflater;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 import android.view.View;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 import android.view.ViewGroup;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import android.view.inputmethod.InputMethodManager;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import android.widget.ArrayAdapter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import android.widget.EditText;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import android.widget.MultiAutoCompleteTextView.Tokenizer;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import android.widget.TextView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import android.widget.ToggleButton;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import com.automattic.simplenote.models.Note;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import com.automattic.simplenote.models.Tag;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import com.simperium.client.Bucket;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import com.simperium.client.Bucket.ObjectCursor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import com.simperium.client.BucketObjectMissingException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 public class NoteEditorFragment extends Fragment implements TextWatcher {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 	 * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 	 * represents.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 	public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43     private static final int AUTOSAVE_DELAY_MILLIS = 2000;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 	 * The dummy content this fragment is presenting.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 	private Note mNote;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 	private EditText mContentEditText;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 	private TagsMultiAutoCompleteTextView mTagView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51     private ToggleButton mPinButton;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52     private boolean mShowNoteTitle;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53     private Handler mAutoSaveHandler;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 	 * Mandatory empty constructor for the fragment manager to instantiate the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 	 * fragment (e.g. upon screen orientation changes).</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 	public NoteEditorFragment() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63 	public void onCreate(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64 		super.onCreate(savedInstanceState);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66 		if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67 	        Simplenote application = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68 			Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69 			String key = getArguments().getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 			try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71     			mNote = notesBucket.get(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 			} catch (BucketObjectMissingException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73 				// TODO: Handle a missing note</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         if (!((NotesActivity)getActivity()).isTwoPane())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78             mShowNoteTitle = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         mAutoSaveHandler = new Handler();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85 	public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 		View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 		mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88         mContentEditText.addTextChangedListener(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92 		refreshContent();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94 		// Populate tag list</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95         Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96         Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98 		String[] allTags = new String[tagsCursor.getCount()];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99         while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100             allTags[tagsCursor.getPosition()] = tagsCursor.getObject().getName();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102         tagsCursor.close();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103         ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                 android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105         mTagView.setAdapter(adapter);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106         mTagView.setTokenizer(new SpaceTokenizer());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108 		return rootView;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112     public void onResume() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         super.onResume();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116             // Show soft keyboard</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117             mContentEditText.requestFocus();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 119             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 119             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(C🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120             if (inputMethodManager != null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121                 inputMethodManager.showSoftInput(mContentEditText, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126     public void onPause() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         // Hide soft keyboard</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 130         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 130         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Conte🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131         if (inputMethodManager != null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132             inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         if (mAutoSaveHandler != null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137         super.onPause();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140     public void setNote(Note note) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         // If we have a note already (on a tablet in landscape), save the note.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         if (mNote != null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143             saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145         mNote = note;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146         refreshContent();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149     public void refreshContent() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150         if (mNote != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152             // Restore the cursor position if possible.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 153             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 153             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toStrin🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154             mContentEditText.setText(mNote.getContent());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156                 mContentEditText.setSelection(cursorPosition);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 158             // Populate this note&#x27;s tags in the tagView - TODO: nbradbury - for a large list of tags, using a StringBuilder here would be more efficient"> 158             // Populate this note&#x27;s tags in the tagView - TODO: nbradbury - for a large list of tags, usi🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159             String tagListString = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160             for (String tag : mNote.getTags())</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161                 tagListString += tag + &quot; &quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162             mTagView.setText(tagListString);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163             mTagView.setChips();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165             mPinButton.setChecked(mNote.isPinned());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167             setActionBarTitle();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171     private void setActionBarTitle() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172         if (mShowNoteTitle) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173             if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174                 getActivity().getActionBar().setTitle(mNote.getTitle());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             else</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176                 getActivity().getActionBar().setTitle(R.string.new_note);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180     int newCursorLocation(String newText, String oldText, int cursorLocation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         // Ported from the iOS app :)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         // Cases:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184         // 1. Text was added after the cursor ==&gt; no change</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185         // 2. Text was added before the cursor ==&gt; location advances</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186         // 3. Text was removed after the cursor ==&gt; no change</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         // 4. Text was removed before the cursor ==&gt; location retreats</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190         int newCursorLocation = cursorLocation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192         int deltaLength = newText.length() - oldText.length();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194         // Case 0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195         if (newText.length() &lt; cursorLocation)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196             return newText.length();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198         boolean beforeCursorMatches = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199         boolean afterCursorMatches = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 202             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 202             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursor🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 203             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 203             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.subst🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208         // Cases 2 and 4</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210             newCursorLocation += deltaLength;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212         // Cases 1, 3 and 5 have no change</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213         return newCursorLocation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216     private Runnable autoSaveRunnable = new Runnable() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218         public void run() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219             saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221     };</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225         // Unused</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229     public void afterTextChanged(Editable editable) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230         // Unused</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235     public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239         if (mAutoSaveHandler != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245     private void saveAndSyncNote() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246         if (mNote == null)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247             return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249         String content = mContentEditText.getText().toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250         String tagString = mTagView.getText().toString().trim();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251         List&lt;String&gt; tagList = Arrays.asList(tagString.split(&quot; &quot;));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 252         ArrayList&lt;String&gt; tags = tagString.equals(&quot;&quot;) ? new ArrayList&lt;String&gt;() : new ArrayList&lt;String&gt;(tagList);"> 252         ArrayList&lt;String&gt; tags = tagString.equals(&quot;&quot;) ? new ArrayList&lt;String&gt;() : new ArrayList&lt;String&gt;(t🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253         if (mNote.hasChanges(content, tags, mPinButton.isChecked())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254             mNote.setContent(content);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255             mNote.setTags(tags);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256             mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257             mNote.setPinned(mPinButton.isChecked());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258             mNote.save();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261         setActionBarTitle();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263         Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266     // Use spaces in tag autocompletion list</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 267 	// From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 267 	// From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268 	public class SpaceTokenizer implements Tokenizer {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270 		public int findTokenStart(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271 			int i = cursor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274 			    i--;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276 			while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277 			    i++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280 			return i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283 		public int findTokenEnd(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 			int i = cursor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285 			int len = text.length();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287 			while (i &lt; len) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288 			    if (text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289 			        return i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290 			    } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291 			        i++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292 			    }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295 			return len;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298 		public CharSequence terminateToken(CharSequence text) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299 			int i = text.length();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301 			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302 			    i--;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305 			if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306 			    return text;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307 			} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308 			    if (text instanceof Spanned) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309 			        SpannableString sp = new SpannableString(text + &quot; &quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 			        TextUtils.copySpansFrom((Spanned) text, 0, text.length(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311 			                Object.class, sp, 0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312 			        return sp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313 			    } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314 			        return text + &quot; &quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315 			    }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319 }</span>
 320 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321 package com.automattic.simplenote;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325 import java.util.Calendar;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328 import android.app.Fragment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329 import android.content.Context;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330 import android.os.Bundle;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331 import android.os.Handler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332 import android.text.Editable;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333 import android.text.SpannableString;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334 import android.text.Spanned;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335 import android.text.TextUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336 import android.text.TextWatcher;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337 import android.util.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338 import android.view.LayoutInflater;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339 import android.view.View;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340 import android.view.ViewGroup;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341 import android.view.inputmethod.InputMethodManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342 import android.widget.ArrayAdapter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343 import android.widget.EditText;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344 import android.widget.LinearLayout;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345 import android.widget.MultiAutoCompleteTextView.Tokenizer;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346 import android.widget.ToggleButton;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348 import com.automattic.simplenote.models.Note;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349 import com.automattic.simplenote.models.Tag;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352 import com.simperium.client.Bucket;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353 import com.simperium.client.Bucket.ObjectCursor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354 import com.simperium.client.BucketObjectMissingException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356 public class NoteEditorFragment extends Fragment implements TextWatcher, OnTagAddedListener {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358      * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359      * represents.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361     public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362     private static final int AUTOSAVE_DELAY_MILLIS = 2000;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365      * The dummy content this fragment is presenting.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367     private Note mNote;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368     private EditText mContentEditText;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369     private TagsMultiAutoCompleteTextView mTagView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370     private ToggleButton mPinButton;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371     private boolean mShowNoteTitle;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372     private Handler mAutoSaveHandler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373     private LinearLayout mPlaceholderView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376      * Mandatory empty constructor for the fragment manager to instantiate the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377      * fragment (e.g. upon screen orientation changes).</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379     public NoteEditorFragment() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383     public void onCreate(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384         super.onCreate(savedInstanceState);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386         if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387             Simplenote application = (Simplenote) getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389             String key = getArguments().getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391                 mNote = notesBucket.get(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392             } catch (BucketObjectMissingException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393                 // TODO: Handle a missing note</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397         if (!((NotesActivity) getActivity()).isLargeScreenLandscape())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398             mShowNoteTitle = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400         mAutoSaveHandler = new Handler();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407         mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408         mContentEditText.addTextChangedListener(this);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410         mTagView.setTokenizer(new SpaceTokenizer());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414         if (!((NotesActivity) getActivity()).isLargeScreen())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415             mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 		refreshContent();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419 		return rootView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423     public void onResume() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424         super.onResume();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425         mTagView.setOnTagAddedListener(this);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426         if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427             // Show soft keyboard</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428             mContentEditText.requestFocus();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 430             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 430             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(C🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431             if (inputMethodManager != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432                 inputMethodManager.showSoftInput(mContentEditText, 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437     public void onPause() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438         saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439         mTagView.setOnTagAddedListener(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440         // Hide soft keyboard</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 441         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 441         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Conte🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442         if (inputMethodManager != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443             inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445         if (mAutoSaveHandler != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448         super.onPause();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451     public void setNote(Note note) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452         mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454         // If we have a note already (on a tablet in landscape), save the note.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455         if (mNote != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456             saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458         mNote = note;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459         refreshContent();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462     public void refreshContent() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463         if (mNote != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464             Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465             // Restore the cursor position if possible.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 466             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 466             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toStrin🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467             mContentEditText.setText(mNote.getContent());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468             if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469                 mContentEditText.setSelection(cursorPosition);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471             mPinButton.setChecked(mNote.isPinned());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473             setActionBarTitle();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475             updateTagList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479     public void updateTagList(){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480         // Populate this note&#x27;s tags in the tagView</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481         mTagView.setChips(mNote.getTagString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483 		// Populate tag list</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484         Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485         Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486         ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487         List&lt;String&gt; allTags = new ArrayList&lt;String&gt;(tagsCursor.getCount());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488         while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489             Tag tag = tagsCursor.getObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490             if (!mNote.hasTag(tag)) allTags.add(tag.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492         tagsCursor.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493         ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494                 android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495         mTagView.setAdapter(adapter);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498     private void setActionBarTitle() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499         if (mShowNoteTitle) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500             if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501                 getActivity().getActionBar().setTitle(mNote.getTitle());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502             else</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503                 getActivity().getActionBar().setTitle(R.string.new_note);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507     int newCursorLocation(String newText, String oldText, int cursorLocation) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508         // Ported from the iOS app :)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509         // Cases:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511         // 1. Text was added after the cursor ==&gt; no change</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512         // 2. Text was added before the cursor ==&gt; location advances</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513         // 3. Text was removed after the cursor ==&gt; no change</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514         // 4. Text was removed before the cursor ==&gt; location retreats</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517         int newCursorLocation = cursorLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519         int deltaLength = newText.length() - oldText.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521         // Case 0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522         if (newText.length() &lt; cursorLocation)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523             return newText.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525         boolean beforeCursorMatches = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526         boolean afterCursorMatches = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 529             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 529             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursor🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 530             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 530             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.subst🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535         // Cases 2 and 4</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537             newCursorLocation += deltaLength;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539         // Cases 1, 3 and 5 have no change</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540         return newCursorLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543     private Runnable autoSaveRunnable = new Runnable() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544         @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545         public void run() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546             saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548     };</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551     public void onTagsChanged(String tagString){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552         mNote.setTagString(tagString);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553         mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554         updateTagList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555         mNote.save();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561         // Unused</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565     public void afterTextChanged(Editable editable) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566         // Unused</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571     public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 574 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575         if (mAutoSaveHandler != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581     private void saveAndSyncNote() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582         if (mNote == null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585         String content = mContentEditText.getText().toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586         if (mNote.hasChanges(content, mPinButton.isChecked())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587             mNote.setContent(content);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588             mNote.setTagString(mTagView.getText().toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589             mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590             mNote.setPinned(mPinButton.isChecked());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591             mNote.save();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594         setActionBarTitle();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596         Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599     public void setPlaceholderVisible(boolean isVisible) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600         if (isVisible) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601             mNote = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602             mContentEditText.setText(&quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603             mTagView.setText(&quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604             if (mPlaceholderView != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605                 mPlaceholderView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607             if (mPlaceholderView != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608                 mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612     // Use spaces in tag autocompletion list</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 613     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 613     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-t🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614     public class SpaceTokenizer implements Tokenizer {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616         public int findTokenStart(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617             int i = cursor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620                 i--;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622             while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623                 i++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626             return i;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629         public int findTokenEnd(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630             int i = cursor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631             int len = text.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633             while (i &lt; len) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634                 if (text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635                     return i;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637                     i++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641             return len;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644         public CharSequence terminateToken(CharSequence text) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645             int i = text.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648                 i--;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651             if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652                 return text;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654                 if (text instanceof Spanned) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655                     SpannableString sp = new SpannableString(text + &quot; &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656                     TextUtils.copySpansFrom((Spanned) text, 0, text.length(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657                             Object.class, sp, 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658                     return sp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660                     return text + &quot; &quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665 }</span>
 666 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
   4 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 package com.automattic.simplenote;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10 import java.util.Calendar;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13 import android.app.Fragment;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14 import android.content.Context;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15 import android.os.Bundle;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16 import android.os.Handler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17 import android.text.Editable;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18 import android.text.SpannableString;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  19 import android.text.Spanned;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  20 import android.text.TextUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21 import android.text.TextWatcher;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22 import android.util.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 import android.view.LayoutInflater;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 import android.view.View;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 import android.view.ViewGroup;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import android.view.inputmethod.InputMethodManager;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import android.widget.ArrayAdapter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import android.widget.EditText;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import android.widget.LinearLayout;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import android.widget.MultiAutoCompleteTextView.Tokenizer;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import android.widget.ToggleButton;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import com.automattic.simplenote.models.Note;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import com.automattic.simplenote.models.Tag;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import com.simperium.client.Bucket;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import com.simperium.client.Bucket.ObjectCursor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import com.simperium.client.BucketObjectMissingException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 public class NoteEditorFragment extends Fragment implements TextWatcher, OnTagAddedListener {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43      * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44      * represents.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46     public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47     private static final int AUTOSAVE_DELAY_MILLIS = 2000;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50      * The dummy content this fragment is presenting.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52     private Note mNote;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53     private EditText mContentEditText;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54     private TagsMultiAutoCompleteTextView mTagView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55     private ToggleButton mPinButton;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56     private boolean mShowNoteTitle;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57     private Handler mAutoSaveHandler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58     private LinearLayout mPlaceholderView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61      * Mandatory empty constructor for the fragment manager to instantiate the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62      * fragment (e.g. upon screen orientation changes).</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64     public NoteEditorFragment() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68     public void onCreate(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69         super.onCreate(savedInstanceState);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71         if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72             Simplenote application = (Simplenote) getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73             Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74             String key = getArguments().getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75             try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76                 mNote = notesBucket.get(key);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77             } catch (BucketObjectMissingException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78                 // TODO: Handle a missing note</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82         if (!((NotesActivity) getActivity()).isLargeScreenLandscape())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83             mShowNoteTitle = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85         mAutoSaveHandler = new Handler();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91         View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92         mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93         mContentEditText.addTextChangedListener(this);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94         mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95         mTagView.setTokenizer(new SpaceTokenizer());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97         mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98         mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99         if (!((NotesActivity) getActivity()).isLargeScreen())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100             mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102 		refreshContent();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104 		return rootView;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108     public void onResume() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109         super.onResume();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110         mTagView.setOnTagAddedListener(this);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111         if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112             // Show soft keyboard</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113             mContentEditText.requestFocus();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 115             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 115             InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(C🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116             if (inputMethodManager != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117                 inputMethodManager.showSoftInput(mContentEditText, 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122     public void onPause() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123         saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124         mTagView.setOnTagAddedListener(null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125         // Hide soft keyboard</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 126         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 126         InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Conte🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127         if (inputMethodManager != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128             inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130         if (mAutoSaveHandler != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133         super.onPause();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136     public void setNote(Note note) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137         mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139         // If we have a note already (on a tablet in landscape), save the note.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140         if (mNote != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141             saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143         mNote = note;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144         refreshContent();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147     public void refreshContent() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148         if (mNote != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149             Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150             // Restore the cursor position if possible.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 151             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 151             int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toStrin🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152             mContentEditText.setText(mNote.getContent());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153             if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154                 mContentEditText.setSelection(cursorPosition);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156             mPinButton.setChecked(mNote.isPinned());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158             setActionBarTitle();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160             updateTagList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164     public void updateTagList(){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165         // Populate this note&#x27;s tags in the tagView</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166         mTagView.setChips(mNote.getTagString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168 		// Populate tag list</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169         Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170         Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171         ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172         List&lt;String&gt; allTags = new ArrayList&lt;String&gt;(tagsCursor.getCount());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173         while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174             Tag tag = tagsCursor.getObject();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175             if (!mNote.hasTag(tag)) allTags.add(tag.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177         tagsCursor.close();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178         ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179                 android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180         mTagView.setAdapter(adapter);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183     private void setActionBarTitle() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184         if (mShowNoteTitle) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185             if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186                 getActivity().getActionBar().setTitle(mNote.getTitle());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187             else</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188                 getActivity().getActionBar().setTitle(R.string.new_note);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192     int newCursorLocation(String newText, String oldText, int cursorLocation) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193         // Ported from the iOS app :)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194         // Cases:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195         // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196         // 1. Text was added after the cursor ==&gt; no change</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197         // 2. Text was added before the cursor ==&gt; location advances</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198         // 3. Text was removed after the cursor ==&gt; no change</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199         // 4. Text was removed before the cursor ==&gt; location retreats</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200         // 5. Text was added/removed on both sides of the cursor ==&gt; not handled</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202         int newCursorLocation = cursorLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204         int deltaLength = newText.length() - oldText.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206         // Case 0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207         if (newText.length() &lt; cursorLocation)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208             return newText.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210         boolean beforeCursorMatches = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211         boolean afterCursorMatches = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 214             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 214             beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursor🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 215             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 215             afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.subst🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217             e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220         // Cases 2 and 4</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221         if (!beforeCursorMatches &amp;&amp; afterCursorMatches)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222             newCursorLocation += deltaLength;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224         // Cases 1, 3 and 5 have no change</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225         return newCursorLocation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228     private Runnable autoSaveRunnable = new Runnable() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229         @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230         public void run() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231             saveAndSyncNote();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233     };</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236     public void onTagsChanged(String tagString){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237         mNote.setTagString(tagString);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238         mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239         updateTagList();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240         mNote.save();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245     public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246         // Unused</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250     public void afterTextChanged(Editable editable) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251         // Unused</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256     public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258         // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         if (mAutoSaveHandler != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261             mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262             mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266     private void saveAndSyncNote() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267         if (mNote == null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268             return;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270         String content = mContentEditText.getText().toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271         if (mNote.hasChanges(content, mPinButton.isChecked())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272             mNote.setContent(content);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273             mNote.setTagString(mTagView.getText().toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274             mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275             mNote.setPinned(mPinButton.isChecked());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276             mNote.save();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279         setActionBarTitle();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281         Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284     public void setPlaceholderVisible(boolean isVisible) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285         if (isVisible) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286             mNote = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287             mContentEditText.setText(&quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288             mTagView.setText(&quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289             if (mPlaceholderView != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290                 mPlaceholderView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292             if (mPlaceholderView != null)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293                 mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297     // Use spaces in tag autocompletion list</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 298     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 298     // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-t🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299     public class SpaceTokenizer implements Tokenizer {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301         public int findTokenStart(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302             int i = cursor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305                 i--;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307             while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308                 i++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311             return i;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314         public int findTokenEnd(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315             int i = cursor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316             int len = text.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318             while (i &lt; len) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319                 if (text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320                     return i;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322                     i++;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326             return len;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329         public CharSequence terminateToken(CharSequence text) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330             int i = text.length();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332             while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333                 i--;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336             if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337                 return text;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338             } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339                 if (text instanceof Spanned) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340                     SpannableString sp = new SpannableString(text + &quot; &quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341                     TextUtils.copySpansFrom((Spanned) text, 0, text.length(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342                             Object.class, sp, 0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343                     return sp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345                     return text + &quot; &quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350 }</span>
 351 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -package com.automattic.simplenote;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 -import java.util.ArrayList;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 -import java.util.Arrays;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 -import java.util.Calendar;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 -import android.app.Fragment;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 -import android.content.Context;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 -import android.os.Bundle;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 -import android.os.Handler;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 -import android.text.Editable;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 -import android.text.SpannableString;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 -import android.text.Spanned;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 -import android.text.TextUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 -import android.text.TextWatcher;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 -import android.util.Log;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -import android.view.LayoutInflater;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -import android.view.View;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import android.view.ViewGroup;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import android.view.inputmethod.InputMethodManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import android.widget.ArrayAdapter;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import android.widget.EditText;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import android.widget.MultiAutoCompleteTextView.Tokenizer;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import android.widget.TextView;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import android.widget.ToggleButton;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import com.automattic.simplenote.models.Note;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import com.automattic.simplenote.models.Tag;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import com.simperium.client.Bucket;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import com.simperium.client.Bucket.ObjectCursor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import com.simperium.client.BucketObjectMissingException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -public class NoteEditorFragment extends Fragment implements TextWatcher {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -	 * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -	 * represents.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -	public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>






<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -    private static final int AUTOSAVE_DELAY_MILLIS = 2000;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -	 * The dummy content this fragment is presenting.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -	private Note mNote;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -	private EditText mContentEditText;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -	private TagsMultiAutoCompleteTextView mTagView;</span>






<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -    private ToggleButton mPinButton;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -    private boolean mShowNoteTitle;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -    private Handler mAutoSaveHandler;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -	 * Mandatory empty constructor for the fragment manager to instantiate the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -	 * fragment (e.g. upon screen orientation changes).</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -	public NoteEditorFragment() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -	public void onCreate(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -		super.onCreate(savedInstanceState);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -		if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -	        Simplenote application = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -			Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -			String key = getArguments().getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -			try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -    			mNote = notesBucket.get(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -			} catch (BucketObjectMissingException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -				// TODO: Handle a missing note</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -        if (!((NotesActivity)getActivity()).isTwoPane())</span>

























<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -            mShowNoteTitle = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -        mAutoSaveHandler = new Handler();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -	public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -		View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -		mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));</span>






<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -        mContentEditText.addTextChangedListener(this);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -        mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -		refreshContent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -		// Populate tag list</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -        Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -        Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -        ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -		String[] allTags = new String[tagsCursor.getCount()];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -        while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -            allTags[tagsCursor.getPosition()] = tagsCursor.getObject().getName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -        tagsCursor.close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -        ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -                android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        mTagView.setAdapter(adapter);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        mTagView.setTokenizer(new SpaceTokenizer());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -		return rootView;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -    public void onResume() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        super.onResume();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -        if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -            // Show soft keyboard</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -            mContentEditText.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 117 -            InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 117 -            InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.IN🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -            if (inputMethodManager != null)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -                inputMethodManager.showSoftInput(mContentEditText, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -    public void onPause() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        saveAndSyncNote();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -        // Hide soft keyboard</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 128 -        InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 128 -        InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        if (inputMethodManager != null)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -            inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        if (mAutoSaveHandler != null)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -            mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -        super.onPause();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -    public void setNote(Note note) {</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -        // If we have a note already (on a tablet in landscape), save the note.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -        if (mNote != null)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -            saveAndSyncNote();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -        mNote = note;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        refreshContent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -    public void refreshContent() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -        if (mNote != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -            Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -            // Restore the cursor position if possible.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 151 -            int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 151 -            int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mCon🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -            mContentEditText.setText(mNote.getContent());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -            if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -                mContentEditText.setSelection(cursorPosition);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 156 -            // Populate this note&#x27;s tags in the tagView - TODO: nbradbury - for a large list of tags, using a StringBuilder here would be more efficient"> 156 -            // Populate this note&#x27;s tags in the tagView - TODO: nbradbury - for a large list of tags, using a Stri🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -            String tagListString = &quot;&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -            for (String tag : mNote.getTags())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -                tagListString += tag + &quot; &quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -            mTagView.setText(tagListString);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -            mTagView.setChips();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -            mPinButton.setChecked(mNote.isPinned());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -            setActionBarTitle();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -        }</span>






















<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -    private void setActionBarTitle() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -        if (mShowNoteTitle) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -            if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -                getActivity().getActionBar().setTitle(mNote.getTitle());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -            else</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -                getActivity().getActionBar().setTitle(R.string.new_note);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -    int newCursorLocation(String newText, String oldText, int cursorLocation) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -        // Ported from the iOS app :)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -        // Cases:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -        // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -        // 1. Text was added after the cursor ==&gt; no change</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -        // 2. Text was added before the cursor ==&gt; location advances</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -        // 3. Text was removed after the cursor ==&gt; no change</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -        // 4. Text was removed before the cursor ==&gt; location retreats</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -        // 5. Text was added/removed on both sides of the cursor ==&gt; not handled</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -        int newCursorLocation = cursorLocation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -        int deltaLength = newText.length() - oldText.length();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -        // Case 0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -        if (newText.length() &lt; cursorLocation)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -            return newText.length();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -        boolean beforeCursorMatches = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -        boolean afterCursorMatches = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 200 -            beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 200 -            beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation)🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 201 -            afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 201 -            afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(curs🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -        } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -            e.printStackTrace();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -        // Cases 2 and 4</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -        if (!beforeCursorMatches &amp;&amp; afterCursorMatches)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -            newCursorLocation += deltaLength;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -        // Cases 1, 3 and 5 have no change</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -        return newCursorLocation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -    private Runnable autoSaveRunnable = new Runnable() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -        public void run() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -            saveAndSyncNote();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -    };</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -    @Override</span>









<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -    public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -        // Unused</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -    public void afterTextChanged(Editable editable) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -        // Unused</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -    public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -        // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -        if (mAutoSaveHandler != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -            mAutoSaveHandler.removeCallbacks(autoSaveRunnable);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -            mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -    private void saveAndSyncNote() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -        if (mNote == null)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -            return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -        String content = mContentEditText.getText().toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -        String tagString = mTagView.getText().toString().trim();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -        List&lt;String&gt; tagList = Arrays.asList(tagString.split(&quot; &quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -        ArrayList&lt;String&gt; tags = tagString.equals(&quot;&quot;) ? new ArrayList&lt;String&gt;() : new ArrayList&lt;String&gt;(tagList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -        if (mNote.hasChanges(content, tags, mPinButton.isChecked())) {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -            mNote.setContent(content);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -            mNote.setTags(tags);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -            mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -            mNote.setPinned(mPinButton.isChecked());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -            mNote.save();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -        setActionBarTitle();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -        Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -</span>













<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -    // Use spaces in tag autocompletion list</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 265 -	// From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 265 -	// From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiauto🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -	public class SpaceTokenizer implements Tokenizer {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -		public int findTokenStart(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -			int i = cursor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -			    i--;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -			while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -			    i++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -			return i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -		public int findTokenEnd(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -			int i = cursor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -			int len = text.length();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -			while (i &lt; len) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -			    if (text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -			        return i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -			    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -			        i++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -			    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -			return len;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -		public CharSequence terminateToken(CharSequence text) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -			int i = text.length();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -			    i--;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -			if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -			    return text;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -			} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -			    if (text instanceof Spanned) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -			        SpannableString sp = new SpannableString(text + &quot; &quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -			        TextUtils.copySpansFrom((Spanned) text, 0, text.length(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -			                Object.class, sp, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -			        return sp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -			    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -			        return text + &quot; &quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -			    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -	}</span>




















































<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 317 -}</span></pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import java.util.ArrayList;
   4  import java.util.Arrays;
   5  import java.util.Calendar;
   6  import java.util.List;
   7  
   8  import android.app.Fragment;
   9  import android.content.Context;
  10  import android.os.Bundle;
  11  import android.os.Handler;
  12  import android.text.Editable;
  13  import android.text.SpannableString;
  14  import android.text.Spanned;
  15  import android.text.TextUtils;
  16  import android.text.TextWatcher;
  17  import android.util.Log;
  18  import android.view.LayoutInflater;
  19  import android.view.View;
  20  import android.view.ViewGroup;
  21  import android.view.inputmethod.InputMethodManager;
  22  import android.widget.ArrayAdapter;
  23  import android.widget.EditText;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import android.widget.LinearLayout;</span>
  25  import android.widget.MultiAutoCompleteTextView.Tokenizer;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import android.widget.TextView;</span>
  27  import android.widget.ToggleButton;
  28  
  29  import com.automattic.simplenote.models.Note;
  30  import com.automattic.simplenote.models.Tag;
  31  import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import com.automattic.simplenote.utils.TagsMultiAutoCompleteTextView.OnTagAddedListener;</span>
  33  import com.simperium.client.Bucket;
  34  import com.simperium.client.Bucket.ObjectCursor;
  35  import com.simperium.client.BucketObjectMissingException;
  36  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -public class NoteEditorFragment extends Fragment implements TextWatcher {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -	 * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -	 * represents.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -	public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +public class NoteEditorFragment extends Fragment implements TextWatcher, OnTagAddedListener {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  45 +     * The fragment argument representing the item ID that this fragment</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +     * represents.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +    public static final String ARG_ITEM_ID = &quot;item_id&quot;;</span>
  49      private static final int AUTOSAVE_DELAY_MILLIS = 2000;
  50  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -	 * The dummy content this fragment is presenting.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -	private Note mNote;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -	private EditText mContentEditText;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -	private TagsMultiAutoCompleteTextView mTagView;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  57 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +     * The dummy content this fragment is presenting.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +    private Note mNote;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +    private EditText mContentEditText;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +    private TagsMultiAutoCompleteTextView mTagView;</span>
  63      private ToggleButton mPinButton;
  64      private boolean mShowNoteTitle;
  65      private Handler mAutoSaveHandler;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -	 * Mandatory empty constructor for the fragment manager to instantiate the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -	 * fragment (e.g. upon screen orientation changes).</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -	public NoteEditorFragment() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -	public void onCreate(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -		super.onCreate(savedInstanceState);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -		if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -	        Simplenote application = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -			Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -			String key = getArguments().getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -			try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -    			mNote = notesBucket.get(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -			} catch (BucketObjectMissingException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -				// TODO: Handle a missing note</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -        if (!((NotesActivity)getActivity()).isTwoPane())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +    private LinearLayout mPlaceholderView;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +     * Mandatory empty constructor for the fragment manager to instantiate the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +     * fragment (e.g. upon screen orientation changes).</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +    public NoteEditorFragment() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +    public void onCreate(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +        super.onCreate(savedInstanceState);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +        if (getArguments() != null &amp;&amp; getArguments().containsKey(ARG_ITEM_ID)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +            Simplenote application = (Simplenote) getActivity().getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +            Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +            String key = getArguments().getString(ARG_ITEM_ID);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +                mNote = notesBucket.get(key);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +            } catch (BucketObjectMissingException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +                // TODO: Handle a missing note</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +        if (!((NotesActivity) getActivity()).isLargeScreenLandscape())</span>
 115              mShowNoteTitle = true;
 116  
 117          mAutoSaveHandler = new Handler();
 118  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -	public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -		View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -		mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        View rootView = inflater.inflate(R.layout.fragment_note_editor, container, false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +        mContentEditText = ((EditText) rootView.findViewById(R.id.note_content));</span>
 131          mContentEditText.addTextChangedListener(this);
 132          mTagView = (TagsMultiAutoCompleteTextView) rootView.findViewById(R.id.tag_view);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +        mTagView.setTokenizer(new SpaceTokenizer());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +</span>
 135          mPinButton = (ToggleButton) rootView.findViewById(R.id.pinButton);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +        mPlaceholderView = (LinearLayout) rootView.findViewById(R.id.placeholder);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +        if (!((NotesActivity) getActivity()).isLargeScreen())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +            mPlaceholderView.setVisibility(View.GONE);</span>
 139  
 140  		refreshContent();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -		// Populate tag list</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -        Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -        ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -		String[] allTags = new String[tagsCursor.getCount()];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -        while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -            allTags[tagsCursor.getPosition()] = tagsCursor.getObject().getName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -        tagsCursor.close();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -        ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -                android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -        mTagView.setAdapter(adapter);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -        mTagView.setTokenizer(new SpaceTokenizer());</span>
 155  
 156  		return rootView;
 157  	}
 158  
 159      @Override
 160      public void onResume() {
 161          super.onResume();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +        mTagView.setOnTagAddedListener(this);</span>
 164          if (mNote != null &amp;&amp; mNote.getContent().isEmpty()) {
 165              // Show soft keyboard
 166              mContentEditText.requestFocus();
 167  
<abbr title=" 168              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 168              InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.IN🔵</abbr>
 169              if (inputMethodManager != null)
 170                  inputMethodManager.showSoftInput(mContentEditText, 0);
 171          }
 172      }
 173  
 174      @Override
 175      public void onPause() {
 176          saveAndSyncNote();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +        mTagView.setOnTagAddedListener(null);</span>
 179          // Hide soft keyboard
<abbr title=" 180          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);"> 180          InputMethodManager inputMethodManager = (InputMethodManager) getActivity().getSystemService(Context.INPUT_🔵</abbr>
 181          if (inputMethodManager != null)
 182              inputMethodManager.hideSoftInputFromWindow(mContentEditText.getWindowToken(), 0);
 183  
 184          if (mAutoSaveHandler != null)
 185              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 186  
 187          super.onPause();
 188      }
 189  
 190      public void setNote(Note note) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +        mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +</span>
 193          // If we have a note already (on a tablet in landscape), save the note.
 194          if (mNote != null)
 195              saveAndSyncNote();
 196  
 197          mNote = note;
 198          refreshContent();
 199      }
 200  
 201      public void refreshContent() {
 202          if (mNote != null) {
 203              Log.v(&quot;Simplenote&quot;, &quot;refreshing content&quot;);
 204              // Restore the cursor position if possible.
<abbr title=" 205              int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mContentEditText.getSelectionEnd());"> 205              int cursorPosition = newCursorLocation(mNote.getContent(), mContentEditText.getText().toString(), mCon🔵</abbr>
 206              mContentEditText.setText(mNote.getContent());
 207              if (mContentEditText.hasFocus() &amp;&amp; cursorPosition != mContentEditText.getSelectionEnd())
 208                  mContentEditText.setSelection(cursorPosition);
 209  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 210 -            // Populate this note&#x27;s tags in the tagView - TODO: nbradbury - for a large list of tags, using a StringBuilder here would be more efficient"> 210 -            // Populate this note&#x27;s tags in the tagView - TODO: nbradbury - for a large list of tags, using a Stri🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -            String tagListString = &quot;&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -            for (String tag : mNote.getTags())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -                tagListString += tag + &quot; &quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -            mTagView.setText(tagListString);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -            mTagView.setChips();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -</span>
 217              mPinButton.setChecked(mNote.isPinned());
 218  
 219              setActionBarTitle();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +            updateTagList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +    public void updateTagList(){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +        // Populate this note&#x27;s tags in the tagView</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +        mTagView.setChips(mNote.getTagString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +		// Populate tag list</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +        Simplenote simplenote = (Simplenote)getActivity().getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +        Bucket&lt;Tag&gt; tagBucket = simplenote.getTagsBucket();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +        ObjectCursor&lt;Tag&gt; tagsCursor = tagBucket.query().orderByKey().execute();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +        List&lt;String&gt; allTags = new ArrayList&lt;String&gt;(tagsCursor.getCount());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +        while (tagsCursor.moveToNext()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +            Tag tag = tagsCursor.getObject();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +            if (!mNote.hasTag(tag)) allTags.add(tag.getName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +        tagsCursor.close();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +        ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(getActivity(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +                android.R.layout.simple_dropdown_item_1line, allTags);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +        mTagView.setAdapter(adapter);</span>
 243      }
 244  
 245      private void setActionBarTitle() {
 246          if (mShowNoteTitle) {
 247              if (mNote.getTitle() != null &amp;&amp; !mNote.getTitle().equals(&quot;&quot;))
 248                  getActivity().getActionBar().setTitle(mNote.getTitle());
 249              else
 250                  getActivity().getActionBar().setTitle(R.string.new_note);
 251          }
 252      }
 253  
 254      int newCursorLocation(String newText, String oldText, int cursorLocation) {
 255          // Ported from the iOS app :)
 256          // Cases:
 257          // 0. All text after cursor (and possibly more) was removed ==&gt; put cursor at end
 258          // 1. Text was added after the cursor ==&gt; no change
 259          // 2. Text was added before the cursor ==&gt; location advances
 260          // 3. Text was removed after the cursor ==&gt; no change
 261          // 4. Text was removed before the cursor ==&gt; location retreats
 262          // 5. Text was added/removed on both sides of the cursor ==&gt; not handled
 263  
 264          int newCursorLocation = cursorLocation;
 265  
 266          int deltaLength = newText.length() - oldText.length();
 267  
 268          // Case 0
 269          if (newText.length() &lt; cursorLocation)
 270              return newText.length();
 271  
 272          boolean beforeCursorMatches = false;
 273          boolean afterCursorMatches = false;
 274  
 275          try {
<abbr title=" 276              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation));"> 276              beforeCursorMatches = oldText.substring(0, cursorLocation).equals(newText.substring(0, cursorLocation)🔵</abbr>
<abbr title=" 277              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(cursorLocation + deltaLength, newText.length()));"> 277              afterCursorMatches = oldText.substring(cursorLocation, oldText.length()).equals(newText.substring(curs🔵</abbr>
 278          } catch (Exception e) {
 279              e.printStackTrace();
 280          }
 281  
 282          // Cases 2 and 4
 283          if (!beforeCursorMatches &amp;&amp; afterCursorMatches)
 284              newCursorLocation += deltaLength;
 285  
 286          // Cases 1, 3 and 5 have no change
 287          return newCursorLocation;
 288      }
 289  
 290      private Runnable autoSaveRunnable = new Runnable() {
 291          @Override
 292          public void run() {
 293              saveAndSyncNote();
 294          }
 295      };
 296  
 297      @Override
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +    public void onTagsChanged(String tagString){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +        mNote.setTagString(tagString);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +        mNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +        updateTagList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +        mNote.save();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +    @Override</span>
 307      public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 308          // Unused
 309      }
 310  
 311      @Override
 312      public void afterTextChanged(Editable editable) {
 313          // Unused
 314  
 315      }
 316  
 317      @Override
 318      public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {
 319  
 320          // When text changes, start timer that will fire after AUTOSAVE_DELAY_MILLIS passes
 321  
 322          if (mAutoSaveHandler != null) {
 323              mAutoSaveHandler.removeCallbacks(autoSaveRunnable);
 324              mAutoSaveHandler.postDelayed(autoSaveRunnable, AUTOSAVE_DELAY_MILLIS);
 325          }
 326      }
 327  
 328      private void saveAndSyncNote() {
 329          if (mNote == null)
 330              return;
 331  
 332          String content = mContentEditText.getText().toString();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 333 -        String tagString = mTagView.getText().toString().trim();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -        List&lt;String&gt; tagList = Arrays.asList(tagString.split(&quot; &quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -        ArrayList&lt;String&gt; tags = tagString.equals(&quot;&quot;) ? new ArrayList&lt;String&gt;() : new ArrayList&lt;String&gt;(tagList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -        if (mNote.hasChanges(content, tags, mPinButton.isChecked())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +        if (mNote.hasChanges(content, mPinButton.isChecked())) {</span>
 338              mNote.setContent(content);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -            mNote.setTags(tags);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +            mNote.setTagString(mTagView.getText().toString());</span>
 341              mNote.setModificationDate(Calendar.getInstance());
 342              mNote.setPinned(mPinButton.isChecked());
 343              mNote.save();
 344          }
 345  
 346          setActionBarTitle();
 347  
 348          Log.v(&quot;Simplenote&quot;, &quot;autosaving note&quot;);
 349      }
 350  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +    public void setPlaceholderVisible(boolean isVisible) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +        if (isVisible) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +            mNote = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +            mContentEditText.setText(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +            mTagView.setText(&quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +            if (mPlaceholderView != null)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +                mPlaceholderView.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +            if (mPlaceholderView != null)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +                mPlaceholderView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +</span>
 364      // Use spaces in tag autocompletion list
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 365 -	// From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 365 -	// From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiauto🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -	public class SpaceTokenizer implements Tokenizer {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -		public int findTokenStart(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -			int i = cursor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -			    i--;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -			while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -			    i++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -			return i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 379 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 380 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 381 -		public int findTokenEnd(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 382 -			int i = cursor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 383 -			int len = text.length();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 384 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 385 -			while (i &lt; len) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 386 -			    if (text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 387 -			        return i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 388 -			    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 389 -			        i++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 390 -			    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 391 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 392 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 393 -			return len;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -		public CharSequence terminateToken(CharSequence text) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -			int i = text.length();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -			while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -			    i--;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -			if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -			    return text;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -			} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -			    if (text instanceof Spanned) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -			        SpannableString sp = new SpannableString(text + &quot; &quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -			        TextUtils.copySpansFrom((Spanned) text, 0, text.length(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -			                Object.class, sp, 0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -			        return sp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -			    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -			        return text + &quot; &quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -			    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 417 +    // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multiautocompletetextview"> 417 +    // From http://stackoverflow.com/questions/3482981/how-to-replace-the-comma-with-a-space-when-i-use-the-multia🔵</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +    public class SpaceTokenizer implements Tokenizer {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 420 +        public int findTokenStart(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 421 +            int i = cursor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +            while (i &gt; 0 &amp;&amp; text.charAt(i - 1) != &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 424 +                i--;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 425 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 426 +            while (i &lt; cursor &amp;&amp; text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 427 +                i++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 428 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 429 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 430 +            return i;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 431 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 432 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 433 +        public int findTokenEnd(CharSequence text, int cursor) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 434 +            int i = cursor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 435 +            int len = text.length();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 436 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 437 +            while (i &lt; len) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 438 +                if (text.charAt(i) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 439 +                    return i;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 440 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 441 +                    i++;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 442 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 443 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 444 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 445 +            return len;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 446 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 447 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 448 +        public CharSequence terminateToken(CharSequence text) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 449 +            int i = text.length();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 450 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 451 +            while (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 452 +                i--;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 453 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 454 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 455 +            if (i &gt; 0 &amp;&amp; text.charAt(i - 1) == &#x27; &#x27;) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 456 +                return text;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 457 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 458 +                if (text instanceof Spanned) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 459 +                    SpannableString sp = new SpannableString(text + &quot; &quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 460 +                    TextUtils.copySpansFrom((Spanned) text, 0, text.length(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 461 +                            Object.class, sp, 0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 462 +                    return sp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 463 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 464 +                    return text + &quot; &quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 465 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 466 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 467 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 468 +    }</span>
 469  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            