<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>68</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    68
                    <a href="67.html">prev</a>
                    <a href="69.html">next</a>
                    <a href="68_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    AriaLyy/Aria_99d857f3383c60ae4ae008f74e7d2b32afe9c26a_Aria/src/main/java/com/arialyy/aria/core/task/DownloadUtil.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;99d857f3383c60ae4ae008f74e7d2b32afe9c26a:Aria/src/main/java/com/arialyy/aria/core/task/DownloadUtil.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;99d857f3383c60ae4ae008f74e7d2b32afe9c26a^1:Aria/src/main/java/com/arialyy/aria/core/task/DownloadUtil.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;99d857f3383c60ae4ae008f74e7d2b32afe9c26a^2:Aria/src/main/java/com/arialyy/aria/core/task/DownloadUtil.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\AriaLyy\Aria show &quot;41154d47fb8664ddca206122d28b50a6a3b8e9a6:Aria/src/main/java/com/arialyy/aria/core/task/DownloadUtil.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   2 /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   3  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   4  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   5  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   6  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   7  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   8  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   9  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  10  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  11  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  12  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  13  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  14  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  15  * limitations under the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  16  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  17 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  18 package com.arialyy.aria.core.task;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  19 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 import android.content.Context;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import android.util.Log;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import android.util.SparseArray;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.arialyy.aria.core.DownloadEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.arialyy.aria.util.BufferedRandomAccessFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import java.io.File;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import java.io.IOException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import java.io.RandomAccessFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import java.net.URL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import java.util.concurrent.ExecutorService;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import java.util.concurrent.Executors;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36  * Created by lyy on 2015/8/25.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37  * 下载工具类</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39 public class DownloadUtil implements IDownloadUtil, Runnable {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40   private static final String TAG = &quot;DownloadUtil&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42    * 线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   private final int THREAD_NUM;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   //下载监听</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46   private IDownloadListener mListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47   private int mConnectTimeOut = 5000 * 4; //连接超时时间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48   private int mReadTimeOut = 5000 * 20; //流读取的超时时间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49   private boolean isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50   private boolean isSupportBreakpoint = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51   private Context mContext;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52   private DownloadEntity mDownloadEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53   private ExecutorService mFixedThreadPool;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54   private File mDownloadFile; //下载的文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55   private File mConfigFile;//下载信息配置文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56   private SparseArray&lt;Runnable&gt; mTask = new SparseArray&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57   private DownloadStateConstance mConstance;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   public DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60     this(context, entity, downloadListener, 3);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63   DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64       int threadNum) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65     mContext = context.getApplicationContext();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66     mDownloadEntity = entity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67     mListener = downloadListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68     THREAD_NUM = threadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69     mFixedThreadPool = Executors.newFixedThreadPool(Integer.MAX_VALUE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70     mConstance = new DownloadStateConstance(THREAD_NUM);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71     init();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74   private void init() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75     mDownloadFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76     //读取已完成的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77     mConfigFile = new File(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78         mContext.getFilesDir().getPath() + &quot;/temp/&quot; + mDownloadFile.getName() + &quot;.properties&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80       if (!mConfigFile.exists()) { //记录文件被删除，则重新下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81         isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82         CommonUtil.createFile(mConfigFile.getPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         isNewTask = !mDownloadFile.exists();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87       e.printStackTrace();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88       failDownload(&quot;下载失败，记录文件被删除&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92   public IDownloadListener getListener() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93     return mListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97    * 设置连接超时时间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99   public void setConnectTimeOut(int timeOut) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100     mConnectTimeOut = timeOut;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104    * 设置流读取的超时时间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106   public void setReadTimeOut(int readTimeOut) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107     mReadTimeOut = readTimeOut;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111    * 获取当前下载位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113   @Override public long getCurrentLocation() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114     return mConstance.CURRENT_LOCATION;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117   @Override public boolean isDownloading() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118     return mConstance.isDownloading;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122    * 取消下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124   @Override public void cancelDownload() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125     mConstance.isCancel = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127     mFixedThreadPool.shutdown();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129       SingleThreadTask task = (SingleThreadTask) mTask.get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130       if (task != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         task.cancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137    * 停止下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139   @Override public void stopDownload() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     mConstance.isStop = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142     mFixedThreadPool.shutdown();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144       SingleThreadTask task = (SingleThreadTask) mTask.get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145       if (task != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146         task.stop();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152    * 删除下载记录文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154   @Override public void delConfigFile() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155     if (mContext != null &amp;&amp; mDownloadEntity != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156       File dFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157       File config =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158           new File(mContext.getFilesDir().getPath() + &quot;/temp/&quot; + dFile.getName() + &quot;.properties&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159       if (config.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160         config.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166    * 删除temp文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168   @Override public void delTempFile() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169     if (mContext != null &amp;&amp; mDownloadEntity != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170       File dFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171       if (dFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172         dFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178    * 多线程断点续传下载文件，开始下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180   @Override public void startDownload() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181     mConstance.cleanState();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182     mListener.onPre();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183     new Thread(this).start();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186   @Override public void resumeDownload() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187     startDownload();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190   private void failDownload(String msg) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191     Log.e(TAG, msg);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193     stopDownload();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194     mListener.onFail();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197   @Override public void run() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199       URL url = new URL(mDownloadEntity.getDownloadUrl());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200       HttpURLConnection conn = ConnectionHelp.handleConnection(url);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201       conn = ConnectionHelp.setConnectParam(conn);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202       conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203       conn.setConnectTimeout(mConnectTimeOut * 4);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204       conn.connect();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205       int len = conn.getContentLength();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206       //if (len &lt; 0) {  //网络被劫持时会出现这个问题</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207       //  failDownload(&quot;下载失败，网络被劫持&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208       //  return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209       //}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210       int code = conn.getResponseCode();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211       //https://zh.wikipedia.org/wiki/HTTP%E7%8A%B6%E6%80%81%E7%A0%81</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212       //206支持断点</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213       if (code == HttpURLConnection.HTTP_PARTIAL) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214         isSupportBreakpoint = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215         mListener.supportBreakpoint(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216         handleBreakpoint(conn);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217       } else if (code == HttpURLConnection.HTTP_OK || len &lt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218         //在conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);下，200为不支持断点状态</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219         if (len &lt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220           failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，文件长度小于0&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221           return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223         isSupportBreakpoint = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224         mListener.supportBreakpoint(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225         Log.w(TAG, &quot;该下载链接不支持断点下载&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226         handleBreakpoint(conn);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227       } else if (code == HttpURLConnection.HTTP_NOT_FOUND) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228         Log.w(TAG, &quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，错误码：404&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229         //mListener.onCancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231         failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，错误码：&quot; + code);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233     } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234       failDownload(&quot;下载失败【downloadUrl:&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235           + mDownloadEntity.getDownloadUrl()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236           + &quot;】\n【filePath:&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237           + mDownloadFile.getPath()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238           + &quot;】&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239           + CommonUtil.getPrintException(e));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244    * 处理断点</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246   private void handleBreakpoint(HttpURLConnection conn) throws IOException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248     //不支持断点只能单线程下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249     if (!isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250       ConfigEntity entity = new ConfigEntity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251       long len = conn.getContentLength();;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252       entity.FILE_SIZE = len;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253       entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254       entity.TEMP_FILE = mDownloadFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255       entity.THREAD_ID = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256       entity.START_LOCATION = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257       entity.END_LOCATION = entity.FILE_SIZE;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258       entity.CONFIG_FILE_PATH = mConfigFile.getPath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259       entity.isSupportBreakpoint = isSupportBreakpoint;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260       SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261       mFixedThreadPool.execute(task);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262       mListener.onPostPre(len);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263       mListener.onStart(0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264       return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266     int fileLength = conn.getContentLength();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267     //必须建一个文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268     CommonUtil.createFile(mDownloadFile.getPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269     //RandomAccessFile file = new RandomAccessFile(mDownloadFile.getPath(), &quot;rwd&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270     ////设置文件长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271     //file.setLength(fileLength);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272     BufferedRandomAccessFile file =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273         new BufferedRandomAccessFile(mDownloadFile.getPath(), &quot;rwd&quot;, 8192);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274     //设置文件长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275     file.setLength(fileLength);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276     mListener.onPostPre(fileLength);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277     //分配每条线程的下载区间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278     Properties pro = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279     pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280     if (pro.isEmpty()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281       isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 283       for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284         if (pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i) == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 285           Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 286           if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 287             continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 288           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 289           isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 290           break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 291         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 292       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 293     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 294     int blockSize = fileLength / THREAD_NUM;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 295     int[] recordL = new int[THREAD_NUM];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 296     int rl = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 297     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 298       recordL[i] = -1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 299     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 300     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 301       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 302       Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 303       if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {  //该线程已经完成</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 304         mConstance.CURRENT_LOCATION += endL - startL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305         Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_已经下载完成 ++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306         mConstance.COMPLETE_THREAD_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 307         mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 308         mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 309         if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 310           if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 311             mConfigFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 312           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 313           mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 314           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 315           return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 316         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 317         continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 318       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 319       //分配下载位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 320       Object record = pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 321       //如果有记录，则恢复下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 322       if (!isNewTask &amp;&amp; record != null &amp;&amp; Long.parseLong(record + &quot;&quot;) &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 323         Long r = Long.parseLong(record + &quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 324         mConstance.CURRENT_LOCATION += r - startL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 325         Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_恢复下载 ++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 326         mListener.onChildResume(r);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 327         startL = r;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 328         recordL[rl] = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 329         rl++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 330       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 331         isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 332       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 333       if (isNewTask) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 334         recordL[rl] = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 335         rl++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 336       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 337       if (i == (THREAD_NUM - 1)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 338         //如果整个文件的大小不为线程个数的整数倍，则最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 339         endL = fileLength;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 340       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 341       ConfigEntity entity = new ConfigEntity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 342       entity.FILE_SIZE = fileLength;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 343       entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 344       entity.TEMP_FILE = mDownloadFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 345       entity.THREAD_ID = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 346       entity.START_LOCATION = startL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 347       entity.END_LOCATION = endL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 348       entity.CONFIG_FILE_PATH = mConfigFile.getPath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 349       entity.isSupportBreakpoint = isSupportBreakpoint;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 350       SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 351       mTask.put(i, task);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 352     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 353     if (mConstance.CURRENT_LOCATION &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 354       mListener.onResume(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 355     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 356       mListener.onStart(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 357     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 358     for (int l : recordL) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 359       if (l == -1) continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 360       Runnable task = mTask.get(l);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 361       if (task != null &amp;&amp; !mFixedThreadPool.isShutdown()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 362         mFixedThreadPool.execute(task);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 363       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 364     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 365   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 366 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 367   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 368    * 子线程下载信息类</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 369    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 370   final static class ConfigEntity {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 371     //文件大小</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 372     long FILE_SIZE;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 373     String DOWNLOAD_URL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 374     int THREAD_ID;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 375     long START_LOCATION;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 376     long END_LOCATION;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 377     File TEMP_FILE;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 378     boolean isSupportBreakpoint = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 379     String CONFIG_FILE_PATH;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 380   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 381 }</span>
 382 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399 package com.arialyy.aria.core.task;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401 import android.content.Context;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402 import android.util.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403 import android.util.SparseArray;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404 import com.arialyy.aria.core.DownloadEntity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408 import java.io.RandomAccessFile;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412 import java.util.concurrent.ExecutorService;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413 import java.util.concurrent.Executors;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416  * Created by lyy on 2015/8/25.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417  * 下载工具类</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419 final class DownloadUtil implements IDownloadUtil, Runnable {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420   private static final String TAG = &quot;DownloadUtil&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422    * 线程数</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424   private final int THREAD_NUM;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425   //下载监听</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426   private IDownloadListener mListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427   private int mConnectTimeOut = 5000 * 4; //连接超时时间</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428   private int mReadTimeOut = 5000 * 20; //流读取的超时时间</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429   private boolean isNewTask = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430   private boolean isSupportBreakpoint = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431   private Context mContext;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432   private DownloadEntity mDownloadEntity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433   private ExecutorService mFixedThreadPool;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434   private File mDownloadFile; //下载的文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435   private File mConfigFile;//下载信息配置文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436   private SparseArray&lt;Runnable&gt; mTask = new SparseArray&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437   private DownloadStateConstance mConstance;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439   DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440     this(context, entity, downloadListener, 3);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443   DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444       int threadNum) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445     mContext = context.getApplicationContext();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446     mDownloadEntity = entity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447     mListener = downloadListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448     THREAD_NUM = threadNum;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449     mFixedThreadPool = Executors.newFixedThreadPool(Integer.MAX_VALUE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450     mConstance = new DownloadStateConstance(THREAD_NUM);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451     init();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454   private void init() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455     mDownloadFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456     //读取已完成的线程数</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457     mConfigFile = new File(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458         mContext.getFilesDir().getPath() + &quot;/temp/&quot; + mDownloadFile.getName() + &quot;.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460       if (!mConfigFile.exists()) { //记录文件被删除，则重新下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461         isNewTask = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462         CommonUtil.createFile(mConfigFile.getPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464         isNewTask = !mDownloadFile.exists();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467       e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468       failDownload(&quot;下载失败，记录文件被删除&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472   public IDownloadListener getListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473     return mListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477    * 设置连接超时时间</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479   public void setConnectTimeOut(int timeOut) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480     mConnectTimeOut = timeOut;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484    * 设置流读取的超时时间</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486   public void setReadTimeOut(int readTimeOut) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487     mReadTimeOut = readTimeOut;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491    * 获取当前下载位置</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493   @Override public long getCurrentLocation() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494     return mConstance.CURRENT_LOCATION;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497   @Override public boolean isDownloading() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498     return mConstance.isDownloading;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502    * 取消下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504   @Override public void cancelDownload() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505     mConstance.isCancel = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507     mFixedThreadPool.shutdown();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 508     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 509       SingleThreadTask task = (SingleThreadTask) mTask.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510       if (task != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 511         task.cancel();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 515 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 517    * 停止下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 518    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 519   @Override public void stopDownload() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 520     mConstance.isStop = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 521     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 522     mFixedThreadPool.shutdown();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 523     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 524       SingleThreadTask task = (SingleThreadTask) mTask.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525       if (task != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526         task.stop();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 528     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532    * 删除下载记录文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534   @Override public void delConfigFile() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535     if (mContext != null &amp;&amp; mDownloadEntity != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536       File dFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 537       File config =</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 538           new File(mContext.getFilesDir().getPath() + &quot;/temp/&quot; + dFile.getName() + &quot;.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 539       if (config.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 540         config.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 541       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 542     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 543   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 544 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 545   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 546    * 删除temp文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 547    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 548   @Override public void delTempFile() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 549     if (mContext != null &amp;&amp; mDownloadEntity != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 550       File dFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 551       if (dFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 552         dFile.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 553       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 554     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 555   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 556 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 557   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 558    * 多线程断点续传下载文件，开始下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 559    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 560   @Override public void startDownload() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 561     mConstance.cleanState();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 562     mListener.onPre();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 563     new Thread(this).start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 564   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 565 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 566   @Override public void resumeDownload() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 567     startDownload();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 568   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 569 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 570   private void failDownload(String msg) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 571     Log.e(TAG, msg);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 572     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 573     stopDownload();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 574     mListener.onFail();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 575   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 576 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 577   @Override public void run() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 578     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 579       URL url = new URL(mDownloadEntity.getDownloadUrl());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 580       HttpURLConnection conn = ConnectionHelp.handleConnection(url);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 581       conn = ConnectionHelp.setConnectParam(conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 582       conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 583       conn.setConnectTimeout(mConnectTimeOut * 4);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 584       conn.connect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 585       int len = conn.getContentLength();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 586       //if (len &lt; 0) {  //网络被劫持时会出现这个问题</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 587       //  failDownload(&quot;下载失败，网络被劫持&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 588       //  return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 589       //}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 590       int code = conn.getResponseCode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 591       //https://zh.wikipedia.org/wiki/HTTP%E7%8A%B6%E6%80%81%E7%A0%81</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 592       //206支持断点</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 593       if (code == HttpURLConnection.HTTP_PARTIAL) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 594         isSupportBreakpoint = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 595         mListener.supportBreakpoint(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 596         handleBreakpoint(conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 597       } else if (code == HttpURLConnection.HTTP_OK || len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 598         //在conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);下，200为不支持断点状态</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 599         if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 600           failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，文件长度小于0&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 601           return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 602         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 603         isSupportBreakpoint = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 604         mListener.supportBreakpoint(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 605         Log.w(TAG, &quot;该下载链接不支持断点下载&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 606         handleBreakpoint(conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 607       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 608         failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，返回码：&quot; + code);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 609       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 610     } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 611       failDownload(&quot;下载失败【downloadUrl:&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 612           + mDownloadEntity.getDownloadUrl()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 613           + &quot;】\n【filePath:&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 614           + mDownloadFile.getPath()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 615           + &quot;】&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 616           + CommonUtil.getPrintException(e));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 617     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 618   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 619 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 620   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 621    * 处理断点</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 622    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 623   private void handleBreakpoint(HttpURLConnection conn) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 624 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 625     //不支持断点只能单线程下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 626     if (!isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 627       ConfigEntity entity = new ConfigEntity();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 628       entity.FILE_SIZE = conn.getContentLength();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 629       entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 630       entity.TEMP_FILE = mDownloadFile;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 631       entity.THREAD_ID = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 632       entity.START_LOCATION = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 633       entity.END_LOCATION = entity.FILE_SIZE;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 634       entity.CONFIG_FILE_PATH = mConfigFile.getPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 635       entity.isSupportBreakpoint = isSupportBreakpoint;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 636       SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 637       mFixedThreadPool.execute(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 638       mListener.onStart(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 639       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 640     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 641     int fileLength = conn.getContentLength();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 642     //必须建一个文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 643     CommonUtil.createFile(mDownloadFile.getPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 644     RandomAccessFile file = new RandomAccessFile(mDownloadFile.getPath(), &quot;rwd&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 645     //设置文件长度</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 646     file.setLength(fileLength);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 647     mListener.onPostPre(fileLength);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 648     //分配每条线程的下载区间</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 649     Properties pro = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 650     pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 651     if (pro.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 652       isNewTask = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 653     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 654       for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 655         if (pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i) == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 656           Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 657           if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 658             continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 659           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 660           isNewTask = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 661           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 662         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 663       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 664     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 665     int blockSize = fileLength / THREAD_NUM;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 666     int[] recordL = new int[THREAD_NUM];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 667     int rl = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 668     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 669       recordL[i] = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 670     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 671     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 672       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 673       Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 674       if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {  //该线程已经完成</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 675         mConstance.CURRENT_LOCATION += endL - startL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 676         Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_已经下载完成 ++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 677         mConstance.COMPLETE_THREAD_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 678         mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 679         mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 680         if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 681           if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 682             mConfigFile.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 683           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 684           mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 685           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 686           return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 687         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 688         continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 689       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 690       //分配下载位置</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 691       Object record = pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 692       //如果有记录，则恢复下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 693       if (!isNewTask &amp;&amp; record != null &amp;&amp; Long.parseLong(record + &quot;&quot;) &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 694         Long r = Long.parseLong(record + &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 695         mConstance.CURRENT_LOCATION += r - startL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 696         Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_恢复下载 ++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 697         mListener.onChildResume(r);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 698         startL = r;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 699         recordL[rl] = i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 700         rl++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 701       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 702         isNewTask = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 703       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 704       if (isNewTask) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 705         recordL[rl] = i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 706         rl++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 707       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 708       if (i == (THREAD_NUM - 1)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 709         //如果整个文件的大小不为线程个数的整数倍，则最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 710         endL = fileLength;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 711       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 712       ConfigEntity entity = new ConfigEntity();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 713       entity.FILE_SIZE = fileLength;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 714       entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 715       entity.TEMP_FILE = mDownloadFile;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 716       entity.THREAD_ID = i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 717       entity.START_LOCATION = startL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 718       entity.END_LOCATION = endL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 719       entity.CONFIG_FILE_PATH = mConfigFile.getPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 720       entity.isSupportBreakpoint = isSupportBreakpoint;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 721       SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 722       mTask.put(i, task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 723     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 724     if (mConstance.CURRENT_LOCATION &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 725       mListener.onResume(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 726     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 727       mListener.onStart(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 728     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 729     for (int l : recordL) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 730       if (l == -1) continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 731       Runnable task = mTask.get(l);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 732       if (task != null &amp;&amp; !mFixedThreadPool.isShutdown()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 733         mFixedThreadPool.execute(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 734       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 735     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 736   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 737 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 738   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 739    * 子线程下载信息类</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 740    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 741   final static class ConfigEntity {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 742     //文件大小</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 743     long FILE_SIZE;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 744     String DOWNLOAD_URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 745     int THREAD_ID;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 746     long START_LOCATION;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 747     long END_LOCATION;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 748     File TEMP_FILE;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 749     boolean isSupportBreakpoint = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 750     String CONFIG_FILE_PATH;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 751   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 752 }</span>
 753 =======
 754 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   2 /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   3  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   4  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   5  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   6  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   7  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   8  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   9  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  10  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  11  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  12  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  13  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  14  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  15  * limitations under the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  16  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  17 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  18 package com.arialyy.aria.core.task;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  19 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 import android.content.Context;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import android.util.Log;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import android.util.SparseArray;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.arialyy.aria.core.DownloadEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.arialyy.aria.util.BufferedRandomAccessFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import java.io.File;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import java.io.IOException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import java.io.RandomAccessFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import java.net.URL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import java.util.concurrent.ExecutorService;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import java.util.concurrent.Executors;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36  * Created by lyy on 2015/8/25.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37  * 下载工具类</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39 public class DownloadUtil implements IDownloadUtil, Runnable {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40   private static final String TAG = &quot;DownloadUtil&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42    * 线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   private final int THREAD_NUM;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   //下载监听</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46   private IDownloadListener mListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47   private int mConnectTimeOut = 5000 * 4; //连接超时时间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48   private int mReadTimeOut = 5000 * 20; //流读取的超时时间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49   private boolean isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50   private boolean isSupportBreakpoint = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51   private Context mContext;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52   private DownloadEntity mDownloadEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53   private ExecutorService mFixedThreadPool;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54   private File mDownloadFile; //下载的文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55   private File mConfigFile;//下载信息配置文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56   private SparseArray&lt;Runnable&gt; mTask = new SparseArray&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57   private DownloadStateConstance mConstance;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   public DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60     this(context, entity, downloadListener, 3);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63   DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64       int threadNum) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65     mContext = context.getApplicationContext();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66     mDownloadEntity = entity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67     mListener = downloadListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68     THREAD_NUM = threadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69     mFixedThreadPool = Executors.newFixedThreadPool(Integer.MAX_VALUE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70     mConstance = new DownloadStateConstance(THREAD_NUM);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71     init();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74   private void init() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75     mDownloadFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76     //读取已完成的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77     mConfigFile = new File(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78         mContext.getFilesDir().getPath() + &quot;/temp/&quot; + mDownloadFile.getName() + &quot;.properties&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80       if (!mConfigFile.exists()) { //记录文件被删除，则重新下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81         isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82         CommonUtil.createFile(mConfigFile.getPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         isNewTask = !mDownloadFile.exists();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87       e.printStackTrace();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88       failDownload(&quot;下载失败，记录文件被删除&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92   public IDownloadListener getListener() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93     return mListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97    * 设置连接超时时间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99   public void setConnectTimeOut(int timeOut) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100     mConnectTimeOut = timeOut;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104    * 设置流读取的超时时间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106   public void setReadTimeOut(int readTimeOut) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107     mReadTimeOut = readTimeOut;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111    * 获取当前下载位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113   @Override public long getCurrentLocation() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114     return mConstance.CURRENT_LOCATION;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117   @Override public boolean isDownloading() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118     return mConstance.isDownloading;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122    * 取消下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124   @Override public void cancelDownload() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125     mConstance.isCancel = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127     mFixedThreadPool.shutdown();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129       SingleThreadTask task = (SingleThreadTask) mTask.get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130       if (task != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         task.cancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137    * 停止下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139   @Override public void stopDownload() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     mConstance.isStop = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142     mFixedThreadPool.shutdown();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144       SingleThreadTask task = (SingleThreadTask) mTask.get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145       if (task != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146         task.stop();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152    * 删除下载记录文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154   @Override public void delConfigFile() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155     if (mContext != null &amp;&amp; mDownloadEntity != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156       File dFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157       File config =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158           new File(mContext.getFilesDir().getPath() + &quot;/temp/&quot; + dFile.getName() + &quot;.properties&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159       if (config.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160         config.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166    * 删除temp文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168   @Override public void delTempFile() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169     if (mContext != null &amp;&amp; mDownloadEntity != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170       File dFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171       if (dFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172         dFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178    * 多线程断点续传下载文件，开始下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180   @Override public void startDownload() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181     mConstance.cleanState();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182     mListener.onPre();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183     new Thread(this).start();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186   @Override public void resumeDownload() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187     startDownload();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190   private void failDownload(String msg) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191     Log.e(TAG, msg);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193     stopDownload();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194     mListener.onFail();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197   @Override public void run() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199       URL url = new URL(mDownloadEntity.getDownloadUrl());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200       HttpURLConnection conn = ConnectionHelp.handleConnection(url);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201       conn = ConnectionHelp.setConnectParam(conn);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202       conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203       conn.setConnectTimeout(mConnectTimeOut * 4);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204       conn.connect();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205       int len = conn.getContentLength();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206       //if (len &lt; 0) {  //网络被劫持时会出现这个问题</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207       //  failDownload(&quot;下载失败，网络被劫持&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208       //  return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209       //}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210       int code = conn.getResponseCode();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211       //https://zh.wikipedia.org/wiki/HTTP%E7%8A%B6%E6%80%81%E7%A0%81</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212       //206支持断点</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213       if (code == HttpURLConnection.HTTP_PARTIAL) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214         isSupportBreakpoint = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215         mListener.supportBreakpoint(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216         handleBreakpoint(conn);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217       } else if (code == HttpURLConnection.HTTP_OK || len &lt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218         //在conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);下，200为不支持断点状态</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219         if (len &lt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220           failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，文件长度小于0&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221           return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223         isSupportBreakpoint = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224         mListener.supportBreakpoint(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225         Log.w(TAG, &quot;该下载链接不支持断点下载&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226         handleBreakpoint(conn);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227       } else if (code == HttpURLConnection.HTTP_NOT_FOUND) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228         Log.w(TAG, &quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，错误码：404&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229         //mListener.onCancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231         failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，错误码：&quot; + code);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233     } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234       failDownload(&quot;下载失败【downloadUrl:&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235           + mDownloadEntity.getDownloadUrl()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236           + &quot;】\n【filePath:&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237           + mDownloadFile.getPath()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238           + &quot;】&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239           + CommonUtil.getPrintException(e));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244    * 处理断点</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246   private void handleBreakpoint(HttpURLConnection conn) throws IOException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248     //不支持断点只能单线程下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249     if (!isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250       ConfigEntity entity = new ConfigEntity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251       long len = conn.getContentLength();;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252       entity.FILE_SIZE = len;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253       entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254       entity.TEMP_FILE = mDownloadFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255       entity.THREAD_ID = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256       entity.START_LOCATION = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257       entity.END_LOCATION = entity.FILE_SIZE;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258       entity.CONFIG_FILE_PATH = mConfigFile.getPath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259       entity.isSupportBreakpoint = isSupportBreakpoint;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260       SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261       mFixedThreadPool.execute(task);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262       mListener.onPostPre(len);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263       mListener.onStart(0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264       return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266     int fileLength = conn.getContentLength();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267     //必须建一个文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268     CommonUtil.createFile(mDownloadFile.getPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269     //RandomAccessFile file = new RandomAccessFile(mDownloadFile.getPath(), &quot;rwd&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270     ////设置文件长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271     //file.setLength(fileLength);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272     BufferedRandomAccessFile file =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273         new BufferedRandomAccessFile(mDownloadFile.getPath(), &quot;rwd&quot;, 8192);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274     //设置文件长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275     file.setLength(fileLength);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276     mListener.onPostPre(fileLength);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277     //分配每条线程的下载区间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278     Properties pro = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279     pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280     if (pro.isEmpty()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281       isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 283       for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284         if (pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i) == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 285           Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 286           if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 287             continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 288           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 289           isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 290           break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 291         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 292       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 293     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 294     int blockSize = fileLength / THREAD_NUM;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 295     int[] recordL = new int[THREAD_NUM];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 296     int rl = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 297     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 298       recordL[i] = -1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 299     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 300     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 301       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 302       Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 303       if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {  //该线程已经完成</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 304         mConstance.CURRENT_LOCATION += endL - startL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305         Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_已经下载完成 ++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306         mConstance.COMPLETE_THREAD_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 307         mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 308         mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 309         if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 310           if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 311             mConfigFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 312           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 313           mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 314           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 315           return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 316         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 317         continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 318       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 319       //分配下载位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 320       Object record = pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 321       //如果有记录，则恢复下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 322       if (!isNewTask &amp;&amp; record != null &amp;&amp; Long.parseLong(record + &quot;&quot;) &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 323         Long r = Long.parseLong(record + &quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 324         mConstance.CURRENT_LOCATION += r - startL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 325         Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_恢复下载 ++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 326         mListener.onChildResume(r);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 327         startL = r;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 328         recordL[rl] = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 329         rl++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 330       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 331         isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 332       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 333       if (isNewTask) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 334         recordL[rl] = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 335         rl++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 336       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 337       if (i == (THREAD_NUM - 1)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 338         //如果整个文件的大小不为线程个数的整数倍，则最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 339         endL = fileLength;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 340       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 341       ConfigEntity entity = new ConfigEntity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 342       entity.FILE_SIZE = fileLength;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 343       entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 344       entity.TEMP_FILE = mDownloadFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 345       entity.THREAD_ID = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 346       entity.START_LOCATION = startL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 347       entity.END_LOCATION = endL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 348       entity.CONFIG_FILE_PATH = mConfigFile.getPath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 349       entity.isSupportBreakpoint = isSupportBreakpoint;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 350       SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 351       mTask.put(i, task);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 352     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 353     if (mConstance.CURRENT_LOCATION &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 354       mListener.onResume(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 355     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 356       mListener.onStart(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 357     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 358     for (int l : recordL) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 359       if (l == -1) continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 360       Runnable task = mTask.get(l);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 361       if (task != null &amp;&amp; !mFixedThreadPool.isShutdown()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 362         mFixedThreadPool.execute(task);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 363       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 364     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 365   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 366 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 367   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 368    * 子线程下载信息类</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 369    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 370   final static class ConfigEntity {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 371     //文件大小</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 372     long FILE_SIZE;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 373     String DOWNLOAD_URL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 374     int THREAD_ID;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 375     long START_LOCATION;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 376     long END_LOCATION;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 377     File TEMP_FILE;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 378     boolean isSupportBreakpoint = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 379     String CONFIG_FILE_PATH;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 380   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 381 }</span>
 382 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399 package com.arialyy.aria.core.task;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401 import android.content.Context;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402 import android.util.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403 import android.util.SparseArray;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404 import com.arialyy.aria.core.DownloadEntity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408 import java.io.RandomAccessFile;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412 import java.util.concurrent.ExecutorService;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413 import java.util.concurrent.Executors;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416  * Created by lyy on 2015/8/25.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417  * 下载工具类</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 419 final class DownloadUtil implements IDownloadUtil, Runnable {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 420   private static final String TAG = &quot;DownloadUtil&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 421   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 422    * 线程数</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 423    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 424   private final int THREAD_NUM;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 425   //下载监听</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 426   private IDownloadListener mListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 427   private int mConnectTimeOut = 5000 * 4; //连接超时时间</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 428   private int mReadTimeOut = 5000 * 20; //流读取的超时时间</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 429   private boolean isNewTask = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 430   private boolean isSupportBreakpoint = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 431   private Context mContext;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 432   private DownloadEntity mDownloadEntity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433   private ExecutorService mFixedThreadPool;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434   private File mDownloadFile; //下载的文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435   private File mConfigFile;//下载信息配置文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436   private SparseArray&lt;Runnable&gt; mTask = new SparseArray&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437   private DownloadStateConstance mConstance;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439   DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440     this(context, entity, downloadListener, 3);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443   DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444       int threadNum) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445     mContext = context.getApplicationContext();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446     mDownloadEntity = entity;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447     mListener = downloadListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448     THREAD_NUM = threadNum;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449     mFixedThreadPool = Executors.newFixedThreadPool(Integer.MAX_VALUE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450     mConstance = new DownloadStateConstance(THREAD_NUM);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451     init();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454   private void init() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455     mDownloadFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456     //读取已完成的线程数</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457     mConfigFile = new File(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458         mContext.getFilesDir().getPath() + &quot;/temp/&quot; + mDownloadFile.getName() + &quot;.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460       if (!mConfigFile.exists()) { //记录文件被删除，则重新下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461         isNewTask = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462         CommonUtil.createFile(mConfigFile.getPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464         isNewTask = !mDownloadFile.exists();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467       e.printStackTrace();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468       failDownload(&quot;下载失败，记录文件被删除&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472   public IDownloadListener getListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473     return mListener;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477    * 设置连接超时时间</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479   public void setConnectTimeOut(int timeOut) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480     mConnectTimeOut = timeOut;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484    * 设置流读取的超时时间</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486   public void setReadTimeOut(int readTimeOut) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487     mReadTimeOut = readTimeOut;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 490   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 491    * 获取当前下载位置</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 492    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 493   @Override public long getCurrentLocation() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 494     return mConstance.CURRENT_LOCATION;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 495   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 496 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 497   @Override public boolean isDownloading() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 498     return mConstance.isDownloading;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 499   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 500 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 501   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 502    * 取消下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 503    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 504   @Override public void cancelDownload() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505     mConstance.isCancel = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507     mFixedThreadPool.shutdown();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 508     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 509       SingleThreadTask task = (SingleThreadTask) mTask.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510       if (task != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 511         task.cancel();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 515 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 517    * 停止下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 518    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 519   @Override public void stopDownload() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 520     mConstance.isStop = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 521     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 522     mFixedThreadPool.shutdown();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 523     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 524       SingleThreadTask task = (SingleThreadTask) mTask.get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525       if (task != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526         task.stop();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 528     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532    * 删除下载记录文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534   @Override public void delConfigFile() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535     if (mContext != null &amp;&amp; mDownloadEntity != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536       File dFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 537       File config =</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 538           new File(mContext.getFilesDir().getPath() + &quot;/temp/&quot; + dFile.getName() + &quot;.properties&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 539       if (config.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 540         config.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 541       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 542     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 543   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 544 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 545   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 546    * 删除temp文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 547    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 548   @Override public void delTempFile() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 549     if (mContext != null &amp;&amp; mDownloadEntity != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 550       File dFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 551       if (dFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 552         dFile.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 553       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 554     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 555   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 556 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 557   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 558    * 多线程断点续传下载文件，开始下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 559    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 560   @Override public void startDownload() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 561     mConstance.cleanState();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 562     mListener.onPre();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 563     new Thread(this).start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 564   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 565 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 566   @Override public void resumeDownload() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 567     startDownload();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 568   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 569 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 570   private void failDownload(String msg) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 571     Log.e(TAG, msg);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 572     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 573     stopDownload();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 574     mListener.onFail();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 575   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 576 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 577   @Override public void run() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 578     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 579       URL url = new URL(mDownloadEntity.getDownloadUrl());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 580       HttpURLConnection conn = ConnectionHelp.handleConnection(url);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 581       conn = ConnectionHelp.setConnectParam(conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 582       conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 583       conn.setConnectTimeout(mConnectTimeOut * 4);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 584       conn.connect();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 585       int len = conn.getContentLength();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 586       //if (len &lt; 0) {  //网络被劫持时会出现这个问题</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 587       //  failDownload(&quot;下载失败，网络被劫持&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 588       //  return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 589       //}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 590       int code = conn.getResponseCode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 591       //https://zh.wikipedia.org/wiki/HTTP%E7%8A%B6%E6%80%81%E7%A0%81</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 592       //206支持断点</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 593       if (code == HttpURLConnection.HTTP_PARTIAL) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 594         isSupportBreakpoint = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 595         mListener.supportBreakpoint(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 596         handleBreakpoint(conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 597       } else if (code == HttpURLConnection.HTTP_OK || len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 598         //在conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);下，200为不支持断点状态</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 599         if (len &lt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 600           failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，文件长度小于0&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 601           return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 602         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 603         isSupportBreakpoint = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 604         mListener.supportBreakpoint(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 605         Log.w(TAG, &quot;该下载链接不支持断点下载&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 606         handleBreakpoint(conn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 607       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 608         failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，返回码：&quot; + code);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 609       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 610     } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 611       failDownload(&quot;下载失败【downloadUrl:&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 612           + mDownloadEntity.getDownloadUrl()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 613           + &quot;】\n【filePath:&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 614           + mDownloadFile.getPath()</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 615           + &quot;】&quot;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 616           + CommonUtil.getPrintException(e));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 617     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 618   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 619 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 620   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 621    * 处理断点</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 622    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 623   private void handleBreakpoint(HttpURLConnection conn) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 624 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 625     //不支持断点只能单线程下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 626     if (!isSupportBreakpoint) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 627       ConfigEntity entity = new ConfigEntity();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 628       entity.FILE_SIZE = conn.getContentLength();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 629       entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 630       entity.TEMP_FILE = mDownloadFile;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 631       entity.THREAD_ID = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 632       entity.START_LOCATION = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 633       entity.END_LOCATION = entity.FILE_SIZE;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 634       entity.CONFIG_FILE_PATH = mConfigFile.getPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 635       entity.isSupportBreakpoint = isSupportBreakpoint;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 636       SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 637       mFixedThreadPool.execute(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 638       mListener.onStart(0);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 639       return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 640     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 641     int fileLength = conn.getContentLength();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 642     //必须建一个文件</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 643     CommonUtil.createFile(mDownloadFile.getPath());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 644     RandomAccessFile file = new RandomAccessFile(mDownloadFile.getPath(), &quot;rwd&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 645     //设置文件长度</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 646     file.setLength(fileLength);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 647     mListener.onPostPre(fileLength);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 648     //分配每条线程的下载区间</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 649     Properties pro = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 650     pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 651     if (pro.isEmpty()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 652       isNewTask = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 653     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 654       for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 655         if (pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i) == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 656           Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 657           if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 658             continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 659           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 660           isNewTask = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 661           break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 662         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 663       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 664     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 665     int blockSize = fileLength / THREAD_NUM;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 666     int[] recordL = new int[THREAD_NUM];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 667     int rl = 0;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 668     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 669       recordL[i] = -1;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 670     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 671     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 672       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 673       Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 674       if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {  //该线程已经完成</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 675         mConstance.CURRENT_LOCATION += endL - startL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 676         Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_已经下载完成 ++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 677         mConstance.COMPLETE_THREAD_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 678         mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 679         mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 680         if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 681           if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 682             mConfigFile.delete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 683           }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 684           mListener.onComplete();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 685           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 686           return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 687         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 688         continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 689       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 690       //分配下载位置</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 691       Object record = pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 692       //如果有记录，则恢复下载</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 693       if (!isNewTask &amp;&amp; record != null &amp;&amp; Long.parseLong(record + &quot;&quot;) &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 694         Long r = Long.parseLong(record + &quot;&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 695         mConstance.CURRENT_LOCATION += r - startL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 696         Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_恢复下载 ++++++++++&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 697         mListener.onChildResume(r);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 698         startL = r;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 699         recordL[rl] = i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 700         rl++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 701       } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 702         isNewTask = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 703       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 704       if (isNewTask) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 705         recordL[rl] = i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 706         rl++;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 707       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 708       if (i == (THREAD_NUM - 1)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 709         //如果整个文件的大小不为线程个数的整数倍，则最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 710         endL = fileLength;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 711       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 712       ConfigEntity entity = new ConfigEntity();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 713       entity.FILE_SIZE = fileLength;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 714       entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 715       entity.TEMP_FILE = mDownloadFile;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 716       entity.THREAD_ID = i;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 717       entity.START_LOCATION = startL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 718       entity.END_LOCATION = endL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 719       entity.CONFIG_FILE_PATH = mConfigFile.getPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 720       entity.isSupportBreakpoint = isSupportBreakpoint;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 721       SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 722       mTask.put(i, task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 723     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 724     if (mConstance.CURRENT_LOCATION &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 725       mListener.onResume(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 726     } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 727       mListener.onStart(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 728     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 729     for (int l : recordL) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 730       if (l == -1) continue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 731       Runnable task = mTask.get(l);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 732       if (task != null &amp;&amp; !mFixedThreadPool.isShutdown()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 733         mFixedThreadPool.execute(task);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 734       }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 735     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 736   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 737 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 738   /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 739    * 子线程下载信息类</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 740    */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 741   final static class ConfigEntity {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 742     //文件大小</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 743     long FILE_SIZE;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 744     String DOWNLOAD_URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 745     int THREAD_ID;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 746     long START_LOCATION;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 747     long END_LOCATION;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 748     File TEMP_FILE;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 749     boolean isSupportBreakpoint = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 750     String CONFIG_FILE_PATH;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 751   }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 752 }</span>
 753 =======
 754 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   2 /*</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   3  * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   4  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   5  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   6  * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   7  * You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   8  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">   9  *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  10  *</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  11  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  12  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  13  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  14  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  15  * limitations under the License.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  16  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  17 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  18 package com.arialyy.aria.core.task;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  19 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  20 import android.content.Context;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  21 import android.util.Log;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  22 import android.util.SparseArray;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import com.arialyy.aria.core.DownloadEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  24 import com.arialyy.aria.util.BufferedRandomAccessFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  25 import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import java.io.File;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import java.io.IOException;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  28 import java.io.RandomAccessFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  29 import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  30 import java.net.URL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import java.util.Properties;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import java.util.concurrent.ExecutorService;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  33 import java.util.concurrent.Executors;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  34 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  35 /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  36  * Created by lyy on 2015/8/25.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37  * 下载工具类</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  38  */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  39 public class DownloadUtil implements IDownloadUtil, Runnable {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  40   private static final String TAG = &quot;DownloadUtil&quot;;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  41   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  42    * 线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  43    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  44   private final int THREAD_NUM;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45   //下载监听</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46   private IDownloadListener mListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47   private int mConnectTimeOut = 5000 * 4; //连接超时时间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48   private int mReadTimeOut = 5000 * 20; //流读取的超时时间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  49   private boolean isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50   private boolean isSupportBreakpoint = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51   private Context mContext;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52   private DownloadEntity mDownloadEntity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53   private ExecutorService mFixedThreadPool;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54   private File mDownloadFile; //下载的文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55   private File mConfigFile;//下载信息配置文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56   private SparseArray&lt;Runnable&gt; mTask = new SparseArray&lt;&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57   private DownloadStateConstance mConstance;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  59   public DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  60     this(context, entity, downloadListener, 3);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  61   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  62 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  63   DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  64       int threadNum) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  65     mContext = context.getApplicationContext();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66     mDownloadEntity = entity;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67     mListener = downloadListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68     THREAD_NUM = threadNum;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69     mFixedThreadPool = Executors.newFixedThreadPool(Integer.MAX_VALUE);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70     mConstance = new DownloadStateConstance(THREAD_NUM);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71     init();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  72   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  73 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  74   private void init() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  75     mDownloadFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  76     //读取已完成的线程数</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  77     mConfigFile = new File(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  78         mContext.getFilesDir().getPath() + &quot;/temp/&quot; + mDownloadFile.getName() + &quot;.properties&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  79     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  80       if (!mConfigFile.exists()) { //记录文件被删除，则重新下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  81         isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  82         CommonUtil.createFile(mConfigFile.getPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  83       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  84         isNewTask = !mDownloadFile.exists();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  85       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  86     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  87       e.printStackTrace();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88       failDownload(&quot;下载失败，记录文件被删除&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  90   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  91 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  92   public IDownloadListener getListener() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  93     return mListener;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  94   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  95 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  96   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  97    * 设置连接超时时间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  98    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  99   public void setConnectTimeOut(int timeOut) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 100     mConnectTimeOut = timeOut;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 102 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104    * 设置流读取的超时时间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106   public void setReadTimeOut(int readTimeOut) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107     mReadTimeOut = readTimeOut;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111    * 获取当前下载位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113   @Override public long getCurrentLocation() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114     return mConstance.CURRENT_LOCATION;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117   @Override public boolean isDownloading() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118     return mConstance.isDownloading;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122    * 取消下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124   @Override public void cancelDownload() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125     mConstance.isCancel = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127     mFixedThreadPool.shutdown();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129       SingleThreadTask task = (SingleThreadTask) mTask.get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130       if (task != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131         task.cancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137    * 停止下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139   @Override public void stopDownload() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140     mConstance.isStop = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142     mFixedThreadPool.shutdown();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144       SingleThreadTask task = (SingleThreadTask) mTask.get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145       if (task != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146         task.stop();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152    * 删除下载记录文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154   @Override public void delConfigFile() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155     if (mContext != null &amp;&amp; mDownloadEntity != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156       File dFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157       File config =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158           new File(mContext.getFilesDir().getPath() + &quot;/temp/&quot; + dFile.getName() + &quot;.properties&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159       if (config.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160         config.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166    * 删除temp文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168   @Override public void delTempFile() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169     if (mContext != null &amp;&amp; mDownloadEntity != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170       File dFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171       if (dFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172         dFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178    * 多线程断点续传下载文件，开始下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180   @Override public void startDownload() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181     mConstance.cleanState();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182     mListener.onPre();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183     new Thread(this).start();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186   @Override public void resumeDownload() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187     startDownload();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190   private void failDownload(String msg) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191     Log.e(TAG, msg);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192     mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193     stopDownload();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194     mListener.onFail();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197   @Override public void run() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199       URL url = new URL(mDownloadEntity.getDownloadUrl());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 200       HttpURLConnection conn = ConnectionHelp.handleConnection(url);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201       conn = ConnectionHelp.setConnectParam(conn);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 202       conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203       conn.setConnectTimeout(mConnectTimeOut * 4);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204       conn.connect();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205       int len = conn.getContentLength();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 206       //if (len &lt; 0) {  //网络被劫持时会出现这个问题</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 207       //  failDownload(&quot;下载失败，网络被劫持&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 208       //  return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 209       //}</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 210       int code = conn.getResponseCode();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211       //https://zh.wikipedia.org/wiki/HTTP%E7%8A%B6%E6%80%81%E7%A0%81</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212       //206支持断点</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213       if (code == HttpURLConnection.HTTP_PARTIAL) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214         isSupportBreakpoint = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 215         mListener.supportBreakpoint(true);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 216         handleBreakpoint(conn);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 217       } else if (code == HttpURLConnection.HTTP_OK || len &lt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 218         //在conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);下，200为不支持断点状态</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219         if (len &lt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220           failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，文件长度小于0&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221           return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 222         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 223         isSupportBreakpoint = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 224         mListener.supportBreakpoint(false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 225         Log.w(TAG, &quot;该下载链接不支持断点下载&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 226         handleBreakpoint(conn);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227       } else if (code == HttpURLConnection.HTTP_NOT_FOUND) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228         Log.w(TAG, &quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，错误码：404&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 229         //mListener.onCancel();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 230       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 231         failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，错误码：&quot; + code);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 232       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 233     } catch (IOException e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 234       failDownload(&quot;下载失败【downloadUrl:&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 235           + mDownloadEntity.getDownloadUrl()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 236           + &quot;】\n【filePath:&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 237           + mDownloadFile.getPath()</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 238           + &quot;】&quot;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 239           + CommonUtil.getPrintException(e));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 240     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 242 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 243   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 244    * 处理断点</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 246   private void handleBreakpoint(HttpURLConnection conn) throws IOException {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 247 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 248     //不支持断点只能单线程下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 249     if (!isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250       ConfigEntity entity = new ConfigEntity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251       long len = conn.getContentLength();;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 252       entity.FILE_SIZE = len;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 253       entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 254       entity.TEMP_FILE = mDownloadFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255       entity.THREAD_ID = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256       entity.START_LOCATION = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257       entity.END_LOCATION = entity.FILE_SIZE;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258       entity.CONFIG_FILE_PATH = mConfigFile.getPath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259       entity.isSupportBreakpoint = isSupportBreakpoint;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260       SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261       mFixedThreadPool.execute(task);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262       mListener.onPostPre(len);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263       mListener.onStart(0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264       return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266     int fileLength = conn.getContentLength();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267     //必须建一个文件</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268     CommonUtil.createFile(mDownloadFile.getPath());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269     //RandomAccessFile file = new RandomAccessFile(mDownloadFile.getPath(), &quot;rwd&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270     ////设置文件长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271     //file.setLength(fileLength);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272     BufferedRandomAccessFile file =</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273         new BufferedRandomAccessFile(mDownloadFile.getPath(), &quot;rwd&quot;, 8192);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274     //设置文件长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275     file.setLength(fileLength);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276     mListener.onPostPre(fileLength);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277     //分配每条线程的下载区间</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278     Properties pro = null;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279     pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280     if (pro.isEmpty()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281       isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 283       for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284         if (pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i) == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 285           Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 286           if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 287             continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 288           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 289           isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 290           break;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 291         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 292       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 293     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 294     int blockSize = fileLength / THREAD_NUM;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 295     int[] recordL = new int[THREAD_NUM];</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 296     int rl = 0;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 297     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 298       recordL[i] = -1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 299     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 300     for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 301       long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 302       Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 303       if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {  //该线程已经完成</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 304         mConstance.CURRENT_LOCATION += endL - startL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305         Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_已经下载完成 ++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306         mConstance.COMPLETE_THREAD_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 307         mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 308         mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 309         if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 310           if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 311             mConfigFile.delete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 312           }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 313           mListener.onComplete();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 314           mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 315           return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 316         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 317         continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 318       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 319       //分配下载位置</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 320       Object record = pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 321       //如果有记录，则恢复下载</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 322       if (!isNewTask &amp;&amp; record != null &amp;&amp; Long.parseLong(record + &quot;&quot;) &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 323         Long r = Long.parseLong(record + &quot;&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 324         mConstance.CURRENT_LOCATION += r - startL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 325         Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_恢复下载 ++++++++++&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 326         mListener.onChildResume(r);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 327         startL = r;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 328         recordL[rl] = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 329         rl++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 330       } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 331         isNewTask = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 332       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 333       if (isNewTask) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 334         recordL[rl] = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 335         rl++;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 336       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 337       if (i == (THREAD_NUM - 1)) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 338         //如果整个文件的大小不为线程个数的整数倍，则最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 339         endL = fileLength;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 340       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 341       ConfigEntity entity = new ConfigEntity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 342       entity.FILE_SIZE = fileLength;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 343       entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 344       entity.TEMP_FILE = mDownloadFile;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 345       entity.THREAD_ID = i;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 346       entity.START_LOCATION = startL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 347       entity.END_LOCATION = endL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 348       entity.CONFIG_FILE_PATH = mConfigFile.getPath();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 349       entity.isSupportBreakpoint = isSupportBreakpoint;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 350       SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 351       mTask.put(i, task);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 352     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 353     if (mConstance.CURRENT_LOCATION &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 354       mListener.onResume(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 355     } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 356       mListener.onStart(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 357     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 358     for (int l : recordL) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 359       if (l == -1) continue;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 360       Runnable task = mTask.get(l);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 361       if (task != null &amp;&amp; !mFixedThreadPool.isShutdown()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 362         mFixedThreadPool.execute(task);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 363       }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 364     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 365   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 366 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 367   /**</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 368    * 子线程下载信息类</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 369    */</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 370   final static class ConfigEntity {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 371     //文件大小</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 372     long FILE_SIZE;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 373     String DOWNLOAD_URL;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 374     int THREAD_ID;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 375     long START_LOCATION;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 376     long END_LOCATION;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 377     File TEMP_FILE;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 378     boolean isSupportBreakpoint = true;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 379     String CONFIG_FILE_PATH;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 380   }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 381 }</span>
 382 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 383 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 383 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
 384 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385 </span>
 386 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.arialyy.aria.core.task;
  18  
  19  import android.content.Context;
  20  import android.util.Log;
  21  import android.util.SparseArray;
  22  import com.arialyy.aria.core.DownloadEntity;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.arialyy.aria.util.BufferedRandomAccessFile;</span>
  24  import com.arialyy.aria.util.CommonUtil;
  25  import java.io.File;
  26  import java.io.IOException;
  27  import java.io.RandomAccessFile;
  28  import java.net.HttpURLConnection;
  29  import java.net.URL;
  30  import java.util.Properties;
  31  import java.util.concurrent.ExecutorService;
  32  import java.util.concurrent.Executors;
  33  
  34  /**
  35   * Created by lyy on 2015/8/25.
  36   * 下载工具类
  37   */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -final class DownloadUtil implements IDownloadUtil, Runnable {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +public class DownloadUtil implements IDownloadUtil, Runnable {</span>
  40    private static final String TAG = &quot;DownloadUtil&quot;;
  41    /**
  42     * 线程数
  43     */
  44    private final int THREAD_NUM;
  45    //下载监听
  46    private IDownloadListener mListener;
  47    private int mConnectTimeOut = 5000 * 4; //连接超时时间
  48    private int mReadTimeOut = 5000 * 20; //流读取的超时时间
  49    private boolean isNewTask = true;
  50    private boolean isSupportBreakpoint = true;
  51    private Context mContext;
  52    private DownloadEntity mDownloadEntity;
  53    private ExecutorService mFixedThreadPool;
  54    private File mDownloadFile; //下载的文件
  55    private File mConfigFile;//下载信息配置文件
  56    private SparseArray&lt;Runnable&gt; mTask = new SparseArray&lt;&gt;();
  57    private DownloadStateConstance mConstance;
  58  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -  DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +  public DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener) {</span>
  61      this(context, entity, downloadListener, 3);
  62    }
  63  
  64    DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener,
  65        int threadNum) {
  66      mContext = context.getApplicationContext();
  67      mDownloadEntity = entity;
  68      mListener = downloadListener;
  69      THREAD_NUM = threadNum;
  70      mFixedThreadPool = Executors.newFixedThreadPool(Integer.MAX_VALUE);
  71      mConstance = new DownloadStateConstance(THREAD_NUM);
  72      init();
  73    }
  74  
  75    private void init() {
  76      mDownloadFile = new File(mDownloadEntity.getDownloadPath());
  77      //读取已完成的线程数
  78      mConfigFile = new File(
  79          mContext.getFilesDir().getPath() + &quot;/temp/&quot; + mDownloadFile.getName() + &quot;.properties&quot;);
  80      try {
  81        if (!mConfigFile.exists()) { //记录文件被删除，则重新下载
  82          isNewTask = true;
  83          CommonUtil.createFile(mConfigFile.getPath());
  84        } else {
  85          isNewTask = !mDownloadFile.exists();
  86        }
  87      } catch (Exception e) {
  88        e.printStackTrace();
  89        failDownload(&quot;下载失败，记录文件被删除&quot;);
  90      }
  91    }
  92  
  93    public IDownloadListener getListener() {
  94      return mListener;
  95    }
  96  
  97    /**
  98     * 设置连接超时时间
  99     */
 100    public void setConnectTimeOut(int timeOut) {
 101      mConnectTimeOut = timeOut;
 102    }
 103  
 104    /**
 105     * 设置流读取的超时时间
 106     */
 107    public void setReadTimeOut(int readTimeOut) {
 108      mReadTimeOut = readTimeOut;
 109    }
 110  
 111    /**
 112     * 获取当前下载位置
 113     */
 114    @Override public long getCurrentLocation() {
 115      return mConstance.CURRENT_LOCATION;
 116    }
 117  
 118    @Override public boolean isDownloading() {
 119      return mConstance.isDownloading;
 120    }
 121  
 122    /**
 123     * 取消下载
 124     */
 125    @Override public void cancelDownload() {
 126      mConstance.isCancel = true;
 127      mConstance.isDownloading = false;
 128      mFixedThreadPool.shutdown();
 129      for (int i = 0; i &lt; THREAD_NUM; i++) {
 130        SingleThreadTask task = (SingleThreadTask) mTask.get(i);
 131        if (task != null) {
 132          task.cancel();
 133        }
 134      }
 135    }
 136  
 137    /**
 138     * 停止下载
 139     */
 140    @Override public void stopDownload() {
 141      mConstance.isStop = true;
 142      mConstance.isDownloading = false;
 143      mFixedThreadPool.shutdown();
 144      for (int i = 0; i &lt; THREAD_NUM; i++) {
 145        SingleThreadTask task = (SingleThreadTask) mTask.get(i);
 146        if (task != null) {
 147          task.stop();
 148        }
 149      }
 150    }
 151  
 152    /**
 153     * 删除下载记录文件
 154     */
 155    @Override public void delConfigFile() {
 156      if (mContext != null &amp;&amp; mDownloadEntity != null) {
 157        File dFile = new File(mDownloadEntity.getDownloadPath());
 158        File config =
 159            new File(mContext.getFilesDir().getPath() + &quot;/temp/&quot; + dFile.getName() + &quot;.properties&quot;);
 160        if (config.exists()) {
 161          config.delete();
 162        }
 163      }
 164    }
 165  
 166    /**
 167     * 删除temp文件
 168     */
 169    @Override public void delTempFile() {
 170      if (mContext != null &amp;&amp; mDownloadEntity != null) {
 171        File dFile = new File(mDownloadEntity.getDownloadPath());
 172        if (dFile.exists()) {
 173          dFile.delete();
 174        }
 175      }
 176    }
 177  
 178    /**
 179     * 多线程断点续传下载文件，开始下载
 180     */
 181    @Override public void startDownload() {
 182      mConstance.cleanState();
 183      mListener.onPre();
 184      new Thread(this).start();
 185    }
 186  
 187    @Override public void resumeDownload() {
 188      startDownload();
 189    }
 190  
 191    private void failDownload(String msg) {
 192      Log.e(TAG, msg);
 193      mConstance.isDownloading = false;
 194      stopDownload();
 195      mListener.onFail();
 196    }
 197  
 198    @Override public void run() {
 199      try {
 200        URL url = new URL(mDownloadEntity.getDownloadUrl());
 201        HttpURLConnection conn = ConnectionHelp.handleConnection(url);
 202        conn = ConnectionHelp.setConnectParam(conn);
 203        conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);
 204        conn.setConnectTimeout(mConnectTimeOut * 4);
 205        conn.connect();
 206        int len = conn.getContentLength();
 207        //if (len &lt; 0) {  //网络被劫持时会出现这个问题
 208        //  failDownload(&quot;下载失败，网络被劫持&quot;);
 209        //  return;
 210        //}
 211        int code = conn.getResponseCode();
 212        //https://zh.wikipedia.org/wiki/HTTP%E7%8A%B6%E6%80%81%E7%A0%81
 213        //206支持断点
 214        if (code == HttpURLConnection.HTTP_PARTIAL) {
 215          isSupportBreakpoint = true;
 216          mListener.supportBreakpoint(true);
 217          handleBreakpoint(conn);
 218        } else if (code == HttpURLConnection.HTTP_OK || len &lt; 0) {
 219          //在conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);下，200为不支持断点状态
 220          if (len &lt; 0) {
 221            failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，文件长度小于0&quot;);
 222            return;
 223          }
 224          isSupportBreakpoint = false;
 225          mListener.supportBreakpoint(false);
 226          Log.w(TAG, &quot;该下载链接不支持断点下载&quot;);
 227          handleBreakpoint(conn);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +      } else if (code == HttpURLConnection.HTTP_NOT_FOUND) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +        Log.w(TAG, &quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，错误码：404&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +        //mListener.onCancel();</span>
 231        } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -        failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，返回码：&quot; + code);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +        failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，错误码：&quot; + code);</span>
 234        }
 235      } catch (IOException e) {
 236        failDownload(&quot;下载失败【downloadUrl:&quot;
 237            + mDownloadEntity.getDownloadUrl()
 238            + &quot;】\n【filePath:&quot;
 239            + mDownloadFile.getPath()
 240            + &quot;】&quot;
 241            + CommonUtil.getPrintException(e));
 242      }
 243    }
 244  
 245    /**
 246     * 处理断点
 247     */
 248    private void handleBreakpoint(HttpURLConnection conn) throws IOException {
 249  
 250      //不支持断点只能单线程下载
 251      if (!isSupportBreakpoint) {
 252        ConfigEntity entity = new ConfigEntity();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -      entity.FILE_SIZE = conn.getContentLength();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +      long len = conn.getContentLength();;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +      entity.FILE_SIZE = len;</span>
 256        entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();
 257        entity.TEMP_FILE = mDownloadFile;
 258        entity.THREAD_ID = 0;
 259        entity.START_LOCATION = 0;
 260        entity.END_LOCATION = entity.FILE_SIZE;
 261        entity.CONFIG_FILE_PATH = mConfigFile.getPath();
 262        entity.isSupportBreakpoint = isSupportBreakpoint;
 263        SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);
 264        mFixedThreadPool.execute(task);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +      mListener.onPostPre(len);</span>
 266        mListener.onStart(0);
 267        return;
 268      }
 269      int fileLength = conn.getContentLength();
 270      //必须建一个文件
 271      CommonUtil.createFile(mDownloadFile.getPath());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -    RandomAccessFile file = new RandomAccessFile(mDownloadFile.getPath(), &quot;rwd&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +    //RandomAccessFile file = new RandomAccessFile(mDownloadFile.getPath(), &quot;rwd&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +    ////设置文件长度</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +    //file.setLength(fileLength);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +    BufferedRandomAccessFile file =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +        new BufferedRandomAccessFile(mDownloadFile.getPath(), &quot;rwd&quot;, 8192);</span>
 278      //设置文件长度
 279      file.setLength(fileLength);
 280      mListener.onPostPre(fileLength);
 281      //分配每条线程的下载区间
 282      Properties pro = null;
 283      pro = CommonUtil.loadConfig(mConfigFile);
 284      if (pro.isEmpty()) {
 285        isNewTask = true;
 286      } else {
 287        for (int i = 0; i &lt; THREAD_NUM; i++) {
 288          if (pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i) == null) {
 289            Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);
 290            if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {
 291              continue;
 292            }
 293            isNewTask = true;
 294            break;
 295          }
 296        }
 297      }
 298      int blockSize = fileLength / THREAD_NUM;
 299      int[] recordL = new int[THREAD_NUM];
 300      int rl = 0;
 301      for (int i = 0; i &lt; THREAD_NUM; i++) {
 302        recordL[i] = -1;
 303      }
 304      for (int i = 0; i &lt; THREAD_NUM; i++) {
 305        long startL = i * blockSize, endL = (i + 1) * blockSize;
 306        Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);
 307        if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {  //该线程已经完成
 308          mConstance.CURRENT_LOCATION += endL - startL;
 309          Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_已经下载完成 ++++++++++&quot;);
 310          mConstance.COMPLETE_THREAD_NUM++;
 311          mConstance.STOP_NUM++;
 312          mConstance.CANCEL_NUM++;
 313          if (mConstance.isComplete()) {
 314            if (mConfigFile.exists()) {
 315              mConfigFile.delete();
 316            }
 317            mListener.onComplete();
 318            mConstance.isDownloading = false;
 319            return;
 320          }
 321          continue;
 322        }
 323        //分配下载位置
 324        Object record = pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i);
 325        //如果有记录，则恢复下载
 326        if (!isNewTask &amp;&amp; record != null &amp;&amp; Long.parseLong(record + &quot;&quot;) &gt; 0) {
 327          Long r = Long.parseLong(record + &quot;&quot;);
 328          mConstance.CURRENT_LOCATION += r - startL;
 329          Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_恢复下载 ++++++++++&quot;);
 330          mListener.onChildResume(r);
 331          startL = r;
 332          recordL[rl] = i;
 333          rl++;
 334        } else {
 335          isNewTask = true;
 336        }
 337        if (isNewTask) {
 338          recordL[rl] = i;
 339          rl++;
 340        }
 341        if (i == (THREAD_NUM - 1)) {
 342          //如果整个文件的大小不为线程个数的整数倍，则最后一个线程的结束位置即为文件的总长度
 343          endL = fileLength;
 344        }
 345        ConfigEntity entity = new ConfigEntity();
 346        entity.FILE_SIZE = fileLength;
 347        entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();
 348        entity.TEMP_FILE = mDownloadFile;
 349        entity.THREAD_ID = i;
 350        entity.START_LOCATION = startL;
 351        entity.END_LOCATION = endL;
 352        entity.CONFIG_FILE_PATH = mConfigFile.getPath();
 353        entity.isSupportBreakpoint = isSupportBreakpoint;
 354        SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);
 355        mTask.put(i, task);
 356      }
 357      if (mConstance.CURRENT_LOCATION &gt; 0) {
 358        mListener.onResume(mConstance.CURRENT_LOCATION);
 359      } else {
 360        mListener.onStart(mConstance.CURRENT_LOCATION);
 361      }
 362      for (int l : recordL) {
 363        if (l == -1) continue;
 364        Runnable task = mTask.get(l);
 365        if (task != null &amp;&amp; !mFixedThreadPool.isShutdown()) {
 366          mFixedThreadPool.execute(task);
 367        }
 368      }
 369    }
 370  
 371    /**
 372     * 子线程下载信息类
 373     */
 374    final static class ConfigEntity {
 375      //文件大小
 376      long FILE_SIZE;
 377      String DOWNLOAD_URL;
 378      int THREAD_ID;
 379      long START_LOCATION;
 380      long END_LOCATION;
 381      File TEMP_FILE;
 382      boolean isSupportBreakpoint = true;
 383      String CONFIG_FILE_PATH;
 384    }
 385  }</pre></td>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * Copyright (C) 2016 AriaLyy(https://github.com/AriaLyy/Aria)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * you may not use this file except in compliance with the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 - * limitations under the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 -package com.arialyy.aria.core.task;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -import android.content.Context;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import android.util.Log;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import android.util.SparseArray;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.arialyy.aria.core.DownloadEntity;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.arialyy.aria.util.CommonUtil;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import java.io.File;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import java.io.IOException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import java.io.RandomAccessFile;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import java.net.HttpURLConnection;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import java.net.URL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import java.util.concurrent.ExecutorService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import java.util.concurrent.Executors;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 - * Created by lyy on 2015/8/25.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 - * 下载工具类</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -final class DownloadUtil implements IDownloadUtil, Runnable {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -  private static final String TAG = &quot;DownloadUtil&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -   * 线程数</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -  private final int THREAD_NUM;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -  //下载监听</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -  private IDownloadListener mListener;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -  private int mConnectTimeOut = 5000 * 4; //连接超时时间</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -  private int mReadTimeOut = 5000 * 20; //流读取的超时时间</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -  private boolean isNewTask = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -  private boolean isSupportBreakpoint = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -  private Context mContext;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -  private DownloadEntity mDownloadEntity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -  private ExecutorService mFixedThreadPool;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -  private File mDownloadFile; //下载的文件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -  private File mConfigFile;//下载信息配置文件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -  private SparseArray&lt;Runnable&gt; mTask = new SparseArray&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -  private DownloadStateConstance mConstance;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -  DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener) {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -    this(context, entity, downloadListener, 3);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -  DownloadUtil(Context context, DownloadEntity entity, IDownloadListener downloadListener,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -      int threadNum) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -    mContext = context.getApplicationContext();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -    mDownloadEntity = entity;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -    mListener = downloadListener;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -    THREAD_NUM = threadNum;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -    mFixedThreadPool = Executors.newFixedThreadPool(Integer.MAX_VALUE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -    mConstance = new DownloadStateConstance(THREAD_NUM);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -    init();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -  private void init() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -    mDownloadFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -    //读取已完成的线程数</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -    mConfigFile = new File(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -        mContext.getFilesDir().getPath() + &quot;/temp/&quot; + mDownloadFile.getName() + &quot;.properties&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -      if (!mConfigFile.exists()) { //记录文件被删除，则重新下载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -        isNewTask = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -        CommonUtil.createFile(mConfigFile.getPath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -        isNewTask = !mDownloadFile.exists();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -    } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -      e.printStackTrace();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -      failDownload(&quot;下载失败，记录文件被删除&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -  public IDownloadListener getListener() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -    return mListener;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -   * 设置连接超时时间</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -  public void setConnectTimeOut(int timeOut) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -    mConnectTimeOut = timeOut;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -   * 设置流读取的超时时间</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -  public void setReadTimeOut(int readTimeOut) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -    mReadTimeOut = readTimeOut;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -   * 获取当前下载位置</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -  @Override public long getCurrentLocation() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -    return mConstance.CURRENT_LOCATION;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -  @Override public boolean isDownloading() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -    return mConstance.isDownloading;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -   * 取消下载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -  @Override public void cancelDownload() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -    mConstance.isCancel = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -    mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -    mFixedThreadPool.shutdown();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -    for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -      SingleThreadTask task = (SingleThreadTask) mTask.get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -      if (task != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        task.cancel();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -   * 停止下载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -  @Override public void stopDownload() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -    mConstance.isStop = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -    mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -    mFixedThreadPool.shutdown();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -    for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -      SingleThreadTask task = (SingleThreadTask) mTask.get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -      if (task != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        task.stop();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -   * 删除下载记录文件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -  @Override public void delConfigFile() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -    if (mContext != null &amp;&amp; mDownloadEntity != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -      File dFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -      File config =</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -          new File(mContext.getFilesDir().getPath() + &quot;/temp/&quot; + dFile.getName() + &quot;.properties&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -      if (config.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -        config.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -   * 删除temp文件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -  @Override public void delTempFile() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -    if (mContext != null &amp;&amp; mDownloadEntity != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -      File dFile = new File(mDownloadEntity.getDownloadPath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -      if (dFile.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -        dFile.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -   * 多线程断点续传下载文件，开始下载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -  @Override public void startDownload() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -    mConstance.cleanState();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -    mListener.onPre();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -    new Thread(this).start();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -  @Override public void resumeDownload() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -    startDownload();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -  private void failDownload(String msg) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -    Log.e(TAG, msg);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -    mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -    stopDownload();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -    mListener.onFail();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -  @Override public void run() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -      URL url = new URL(mDownloadEntity.getDownloadUrl());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -      HttpURLConnection conn = ConnectionHelp.handleConnection(url);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -      conn = ConnectionHelp.setConnectParam(conn);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -      conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -      conn.setConnectTimeout(mConnectTimeOut * 4);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -      conn.connect();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -      int len = conn.getContentLength();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -      //if (len &lt; 0) {  //网络被劫持时会出现这个问题</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -      //  failDownload(&quot;下载失败，网络被劫持&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -      //  return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -      //}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -      int code = conn.getResponseCode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -      //https://zh.wikipedia.org/wiki/HTTP%E7%8A%B6%E6%80%81%E7%A0%81</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -      //206支持断点</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -      if (code == HttpURLConnection.HTTP_PARTIAL) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -        isSupportBreakpoint = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -        mListener.supportBreakpoint(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -        handleBreakpoint(conn);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -      } else if (code == HttpURLConnection.HTTP_OK || len &lt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -        //在conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + 0 + &quot;-&quot;);下，200为不支持断点状态</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -        if (len &lt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -          failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，文件长度小于0&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -          return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -        isSupportBreakpoint = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -        mListener.supportBreakpoint(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -        Log.w(TAG, &quot;该下载链接不支持断点下载&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -        handleBreakpoint(conn);</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -        failDownload(&quot;任务【&quot; + mDownloadEntity.getDownloadUrl() + &quot;】下载失败，返回码：&quot; + code);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -    } catch (IOException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -      failDownload(&quot;下载失败【downloadUrl:&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -          + mDownloadEntity.getDownloadUrl()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -          + &quot;】\n【filePath:&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -          + mDownloadFile.getPath()</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -          + &quot;】&quot;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -          + CommonUtil.getPrintException(e));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -   * 处理断点</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -  private void handleBreakpoint(HttpURLConnection conn) throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -    //不支持断点只能单线程下载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -    if (!isSupportBreakpoint) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -      ConfigEntity entity = new ConfigEntity();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -      entity.FILE_SIZE = conn.getContentLength();</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -      entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -      entity.TEMP_FILE = mDownloadFile;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -      entity.THREAD_ID = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -      entity.START_LOCATION = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -      entity.END_LOCATION = entity.FILE_SIZE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -      entity.CONFIG_FILE_PATH = mConfigFile.getPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -      entity.isSupportBreakpoint = isSupportBreakpoint;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -      SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -      mFixedThreadPool.execute(task);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -      mListener.onStart(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -      return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -    int fileLength = conn.getContentLength();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -    //必须建一个文件</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -    CommonUtil.createFile(mDownloadFile.getPath());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -    RandomAccessFile file = new RandomAccessFile(mDownloadFile.getPath(), &quot;rwd&quot;);</span>





<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -    //设置文件长度</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -    file.setLength(fileLength);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -    mListener.onPostPre(fileLength);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -    //分配每条线程的下载区间</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -    Properties pro = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -    pro = CommonUtil.loadConfig(mConfigFile);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -    if (pro.isEmpty()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -      isNewTask = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -      for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -        if (pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i) == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -          Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -          if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -            continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -          isNewTask = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -          break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -    int blockSize = fileLength / THREAD_NUM;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -    int[] recordL = new int[THREAD_NUM];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -    int rl = 0;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -    for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -      recordL[i] = -1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -    for (int i = 0; i &lt; THREAD_NUM; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -      long startL = i * blockSize, endL = (i + 1) * blockSize;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -      Object state = pro.getProperty(mDownloadFile.getName() + &quot;_state_&quot; + i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -      if (state != null &amp;&amp; Integer.parseInt(state + &quot;&quot;) == 1) {  //该线程已经完成</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -        mConstance.CURRENT_LOCATION += endL - startL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -        Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_已经下载完成 ++++++++++&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -        mConstance.COMPLETE_THREAD_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -        mConstance.STOP_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -        mConstance.CANCEL_NUM++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -        if (mConstance.isComplete()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -          if (mConfigFile.exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -            mConfigFile.delete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -          }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -          mListener.onComplete();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -          mConstance.isDownloading = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -          return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -        continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -      //分配下载位置</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -      Object record = pro.getProperty(mDownloadFile.getName() + &quot;_record_&quot; + i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -      //如果有记录，则恢复下载</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -      if (!isNewTask &amp;&amp; record != null &amp;&amp; Long.parseLong(record + &quot;&quot;) &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -        Long r = Long.parseLong(record + &quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -        mConstance.CURRENT_LOCATION += r - startL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -        Log.d(TAG, &quot;++++++++++ 线程_&quot; + i + &quot;_恢复下载 ++++++++++&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -        mListener.onChildResume(r);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -        startL = r;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 317 -        recordL[rl] = i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -        rl++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -      } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -        isNewTask = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 321 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -      if (isNewTask) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -        recordL[rl] = i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -        rl++;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 326 -      if (i == (THREAD_NUM - 1)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 327 -        //如果整个文件的大小不为线程个数的整数倍，则最后一个线程的结束位置即为文件的总长度</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -        endL = fileLength;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 329 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 330 -      ConfigEntity entity = new ConfigEntity();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -      entity.FILE_SIZE = fileLength;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -      entity.DOWNLOAD_URL = mDownloadEntity.getDownloadUrl();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 333 -      entity.TEMP_FILE = mDownloadFile;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -      entity.THREAD_ID = i;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -      entity.START_LOCATION = startL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -      entity.END_LOCATION = endL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -      entity.CONFIG_FILE_PATH = mConfigFile.getPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -      entity.isSupportBreakpoint = isSupportBreakpoint;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -      SingleThreadTask task = new SingleThreadTask(mConstance, mListener, entity);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -      mTask.put(i, task);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -    if (mConstance.CURRENT_LOCATION &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 343 -      mListener.onResume(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 344 -    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 345 -      mListener.onStart(mConstance.CURRENT_LOCATION);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -    for (int l : recordL) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -      if (l == -1) continue;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 349 -      Runnable task = mTask.get(l);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -      if (task != null &amp;&amp; !mFixedThreadPool.isShutdown()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -        mFixedThreadPool.execute(task);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 352 -      }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 356 -  /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 357 -   * 子线程下载信息类</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 358 -   */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -  final static class ConfigEntity {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -    //文件大小</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -    long FILE_SIZE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -    String DOWNLOAD_URL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -    int THREAD_ID;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -    long START_LOCATION;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -    long END_LOCATION;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -    File TEMP_FILE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -    boolean isSupportBreakpoint = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -    String CONFIG_FILE_PATH;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -  }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -}</span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            