<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>585</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    585
                    <a href="584.html">prev</a>
                    <a href="586.html">next</a>
                    <a href="585_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    GoogleCloudPlatform/bank-of-anthos_fb91e21ec4c6a1a58f45b1410838f6629cf5e4c9_src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;fb91e21ec4c6a1a58f45b1410838f6629cf5e4c9:src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;fb91e21ec4c6a1a58f45b1410838f6629cf5e4c9^1:src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;fb91e21ec4c6a1a58f45b1410838f6629cf5e4c9^2:src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\GoogleCloudPlatform\bank-of-anthos show &quot;7dde4068aee6a9185c76ab9df82d53ac83ce123d:src/ledgerwriter/src/main/java/anthos/samples/financedemo/ledgerwriter/LedgerWriterController.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [bj], [bj], [s], [s]], subset: [[bj], [bsj], [bsj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15  */                                                                                                      </span>
<span  style="">  16                                                                                                          </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  17 package anthos.samples.financedemo.ledgerwriter;                                                         </span>
<span  style="">  18                                                                                                          </span>
<span class="3416473218750047572" onmouseenter="enter('3416473218750047572');" onmouseout="out('3416473218750047572');" style="">  19 import io.lettuce.core.api.StatefulRedisConnection;                                                      </span>
<span class="1015650858128177541" onmouseenter="enter('1015650858128177541');" onmouseout="out('1015650858128177541');" style="">  20 import org.springframework.context.ApplicationContext;                                                   </span>
<span class="2623752691140612054" onmouseenter="enter('2623752691140612054');" onmouseout="out('2623752691140612054');" style="">  21 import org.springframework.context.annotation.AnnotationConfigApplicationContext;                        </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  22 import org.springframework.http.HttpStatus;                                                              </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  23 import org.springframework.web.bind.annotation.GetMapping;                                               </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  24 import org.springframework.web.bind.annotation.PostMapping;                                              </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  25 import org.springframework.web.bind.annotation.RestController;                                           </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  26 import org.springframework.web.bind.annotation.RequestBody;                                              </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  27 import org.springframework.web.bind.annotation.RequestHeader;                                            </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  28 import org.springframework.web.bind.annotation.ResponseStatus;                                           </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  29 import org.springframework.http.ResponseEntity;                                                          </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  30 import org.springframework.web.client.RestTemplate;                                                      </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  31 import org.springframework.http.HttpHeaders;                                                             </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  32 import org.springframework.http.HttpEntity;                                                              </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  33 import org.springframework.http.HttpMethod;                                                              </span>
<span  style="">  34                                                                                                          </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  35 import java.io.IOException;                                                                              </span>
<span class="-5249557667130751282" onmouseenter="enter('-5249557667130751282');" onmouseout="out('-5249557667130751282');" style="">  36 import java.nio.file.Files;                                                                              </span>
<span class="7071256358513765675" onmouseenter="enter('7071256358513765675');" onmouseout="out('7071256358513765675');" style="">  37 import java.nio.file.Paths;                                                                              </span>
<span class="-8013228574741439948" onmouseenter="enter('-8013228574741439948');" onmouseout="out('-8013228574741439948');" style="">  38 import java.security.KeyFactory;                                                                         </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  39 import java.security.NoSuchAlgorithmException;                                                           </span>
<span class="-61053565471358753" onmouseenter="enter('-61053565471358753');" onmouseout="out('-61053565471358753');" style="">  40 import java.security.interfaces.RSAPublicKey;                                                            </span>
<span class="3289746377953945547" onmouseenter="enter('3289746377953945547');" onmouseout="out('3289746377953945547');" style="">  41 import java.security.spec.InvalidKeySpecException;                                                       </span>
<span class="7906465591428389933" onmouseenter="enter('7906465591428389933');" onmouseout="out('7906465591428389933');" style="">  42 import java.security.spec.X509EncodedKeySpec;                                                            </span>
<span class="-6935710760624141930" onmouseenter="enter('-6935710760624141930');" onmouseout="out('-6935710760624141930');" style="">  43 import java.util.Base64;                                                                                 </span>
<span  style="">  44                                                                                                          </span>
<span class="-6655146115708071580" onmouseenter="enter('-6655146115708071580');" onmouseout="out('-6655146115708071580');" style="">  45 import com.auth0.jwt.algorithms.Algorithm;                                                               </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  46 import com.auth0.jwt.interfaces.DecodedJWT;                                                              </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  47 import com.auth0.jwt.exceptions.JWTVerificationException;                                                </span>
<span class="2931637313601470038" onmouseenter="enter('2931637313601470038');" onmouseout="out('2931637313601470038');" style="">  48 import com.auth0.jwt.JWT;                                                                                </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  49 import com.auth0.jwt.JWTVerifier;                                                                        </span>
<span  style="">  50                                                                                                          </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  51 @RestController                                                                                          </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  52 public final class LedgerWriterController {                                                              </span>
<span  style="">  53                                                                                                          </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  54 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="3137105351418099518" onmouseenter="enter('3137105351418099518');" onmouseout="out('3137105351418099518');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55     ApplicationContext ctx =                                                                             </span>
<span class="7104311876824495896" onmouseenter="enter('7104311876824495896');" onmouseout="out('7104311876824495896');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56             new AnnotationConfigApplicationContext(LedgerWriterConfig.class);                            </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  57 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="4228229669487578025" onmouseenter="enter('4228229669487578025');" onmouseout="out('4228229669487578025');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58     ApplicationContext ctx = new AnnotationConfigApplicationContext(LedgerWriterConfig.class);           </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59                                                                                                          </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  60 =======                                                                                                  </span>
<span class="2454959921614149006" onmouseenter="enter('2454959921614149006');" onmouseout="out('2454959921614149006');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61     ApplicationContext ctx = new AnnotationConfigApplicationContext(                                     </span>
<span class="6329527144215806426" onmouseenter="enter('6329527144215806426');" onmouseout="out('6329527144215806426');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62         LedgerWriterConfig.class);                                                                       </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  63 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span  style="">  64                                                                                                          </span>
<span class="-5604269207838210422" onmouseenter="enter('-5604269207838210422');" onmouseout="out('-5604269207838210422');" style="">  65     private final String ledgerStreamKey = System.getenv(&quot;LEDGER_STREAM&quot;);                               </span>
<span class="8411565151832508655" onmouseenter="enter('8411565151832508655');" onmouseout="out('8411565151832508655');" style="">  66     private final String routingNum =  System.getenv(&quot;LOCAL_ROUTING_NUM&quot;);                               </span>
<span class="-6551832665109601256" onmouseenter="enter('-6551832665109601256');" onmouseout="out('-6551832665109601256');" style="">  67     private final String balancesUri = String.format(&quot;http://%s/get_balance&quot;,                            </span>
<span class="-1420395203196747354" onmouseenter="enter('-1420395203196747354');" onmouseout="out('-1420395203196747354');" style="">  68         System.getenv(&quot;BALANCES_API_ADDR&quot;));                                                             </span>
<span class="4358404513907099662" onmouseenter="enter('4358404513907099662');" onmouseout="out('4358404513907099662');" style="">  69     private final JWTVerifier verifier;                                                                  </span>
<span  style="">  70                                                                                                          </span>
<span class="8064586665074901273" onmouseenter="enter('8064586665074901273');" onmouseout="out('8064586665074901273');" style="">  71     public LedgerWriterController() throws IOException,                                                  </span>
<span class="1894253170606682489" onmouseenter="enter('1894253170606682489');" onmouseout="out('1894253170606682489');" style="">  72                                            NoSuchAlgorithmException,                                     </span>
<span class="1072467281893302576" onmouseenter="enter('1072467281893302576');" onmouseout="out('1072467281893302576');" style="">  73                                            InvalidKeySpecException {                                     </span>
<span class="-1999315777049585600" onmouseenter="enter('-1999315777049585600');" onmouseout="out('-1999315777049585600');" style="">  74         // load public key from file                                                                     </span>
<span class="3809711205239471476" onmouseenter="enter('3809711205239471476');" onmouseout="out('3809711205239471476');" style="">  75         String fPath = System.getenv(&quot;PUB_KEY_PATH&quot;);                                                    </span>
<span class="5673882543335836624" onmouseenter="enter('5673882543335836624');" onmouseout="out('5673882543335836624');" style="">  76         String pubKeyStr  = new String(Files.readAllBytes(Paths.get(fPath)));                            </span>
<span class="7209009376448743897" onmouseenter="enter('7209009376448743897');" onmouseout="out('7209009376448743897');" style="">  77         pubKeyStr = pubKeyStr.replaceFirst(&quot;-----BEGIN PUBLIC KEY-----&quot;, &quot;&quot;);                            </span>
<span class="4927348229997813303" onmouseenter="enter('4927348229997813303');" onmouseout="out('4927348229997813303');" style="">  78         pubKeyStr = pubKeyStr.replaceFirst(&quot;-----END PUBLIC KEY-----&quot;, &quot;&quot;);                              </span>
<span class="-828263452525302924" onmouseenter="enter('-828263452525302924');" onmouseout="out('-828263452525302924');" style="">  79         pubKeyStr = pubKeyStr.replaceAll(&quot;\\s&quot;, &quot;&quot;);                                                     </span>
<span class="-3743771444177503093" onmouseenter="enter('-3743771444177503093');" onmouseout="out('-3743771444177503093');" style="">  80         byte[] pubKeyBytes = Base64.getDecoder().decode(pubKeyStr);                                      </span>
<span class="438744628498497549" onmouseenter="enter('438744628498497549');" onmouseout="out('438744628498497549');" style="">  81         KeyFactory kf = KeyFactory.getInstance(&quot;RSA&quot;);                                                   </span>
<span class="4154530442155105022" onmouseenter="enter('4154530442155105022');" onmouseout="out('4154530442155105022');" style="">  82         X509EncodedKeySpec keySpecX509 = new X509EncodedKeySpec(pubKeyBytes);                            </span>
<span class="169640045417215895" onmouseenter="enter('169640045417215895');" onmouseout="out('169640045417215895');" style="">  83         RSAPublicKey publicKey = (RSAPublicKey) kf.generatePublic(keySpecX509);                          </span>
<span class="2306753067902644237" onmouseenter="enter('2306753067902644237');" onmouseout="out('2306753067902644237');" style="">  84         // set up verifier                                                                               </span>
<span class="-6857500803242936007" onmouseenter="enter('-6857500803242936007');" onmouseout="out('-6857500803242936007');" style="">  85         Algorithm algorithm = Algorithm.RSA256(publicKey, null);                                         </span>
<span class="3110240470386105373" onmouseenter="enter('3110240470386105373');" onmouseout="out('3110240470386105373');" style="">  86         this.verifier = JWT.require(algorithm).build();                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  87     }                                                                                                    </span>
<span  style="">  88                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  89     /**                                                                                                  </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style="">  90      * Readiness probe endpoint.                                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  91      *                                                                                                   </span>
<span class="-6237848493354397724" onmouseenter="enter('-6237848493354397724');" onmouseout="out('-6237848493354397724');" style="">  92      * @return HTTP Status 200 if server is serving requests.                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  93      */                                                                                                  </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style="">  94     @GetMapping(&quot;/ready&quot;)                                                                                </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style="">  95     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="-4385440054719104188" onmouseenter="enter('-4385440054719104188');" onmouseout="out('-4385440054719104188');" style="">  96     public String readiness() {                                                                          </span>
<span class="4704682847571117723" onmouseenter="enter('4704682847571117723');" onmouseout="out('4704682847571117723');" style="">  97         return &quot;ok&quot;;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  98     }                                                                                                    </span>
<span  style="">  99                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 100     /**                                                                                                  </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style=""> 101      * Submit a new transaction to the ledger.                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 102      *                                                                                                   </span>
<span class="8344965626844763807" onmouseenter="enter('8344965626844763807');" onmouseout="out('8344965626844763807');" style=""> 103      * @param Transaction to be submitted.                                                               </span>
<span class="5706658156997278370" onmouseenter="enter('5706658156997278370');" onmouseout="out('5706658156997278370');" style=""> 104      * @return HTTP Status 200 if transaction was successfully submitted.                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 105      */                                                                                                  </span>
<span class="1119678417808751550" onmouseenter="enter('1119678417808751550');" onmouseout="out('1119678417808751550');" style=""> 106     @PostMapping(value = &quot;/new_transaction&quot;, consumes = &quot;application/json&quot;)                              </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 107     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="1897907323625472935" onmouseenter="enter('1897907323625472935');" onmouseout="out('1897907323625472935');" style=""> 108     public ResponseEntity&lt;?&gt; addTransaction(                                                             </span>
<span class="1166903297081280981" onmouseenter="enter('1166903297081280981');" onmouseout="out('1166903297081280981');" style=""> 109             @RequestHeader(&quot;Authorization&quot;) String bearerToken,                                          </span>
<span class="9022696444049056102" onmouseenter="enter('9022696444049056102');" onmouseout="out('9022696444049056102');" style=""> 110             @RequestBody Transaction transaction) {                                                      </span>
<span class="-3538581758087352701" onmouseenter="enter('-3538581758087352701');" onmouseout="out('-3538581758087352701');" style=""> 111         if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                  </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 112             bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 114         try {                                                                                            </span>
<span class="4753652363839392700" onmouseenter="enter('4753652363839392700');" onmouseout="out('4753652363839392700');" style=""> 115             DecodedJWT jwt = this.verifier.verify(bearerToken);                                          </span>
<span class="-1766896061973454949" onmouseenter="enter('-1766896061973454949');" onmouseout="out('-1766896061973454949');" style=""> 116             String initiatorAcct = jwt.getClaim(&quot;acct&quot;).asString();                                      </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 117 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="5927642596742306408" onmouseenter="enter('5927642596742306408');" onmouseout="out('5927642596742306408');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118             // Ensure sender is the one who initiated this transaction, or it is                         </span>
<span class="771710869172324231" onmouseenter="enter('771710869172324231');" onmouseout="out('771710869172324231');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119             // an external deposit.                                                                      </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 120 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="4275752493067967329" onmouseenter="enter('4275752493067967329');" onmouseout="out('4275752493067967329');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121             // TODO: Check if external account belongs to initiator of deposit.                          </span>
<span class="5445848170118178590" onmouseenter="enter('5445848170118178590');" onmouseout="out('5445848170118178590');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122             if (!(transaction.getFromAccountNum() == initiatorAcct                                       </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 123 =======                                                                                                  </span>
<span class="2239362758347684288" onmouseenter="enter('2239362758347684288');" onmouseout="out('2239362758347684288');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124             // Ensure sender is the one who initiated this transaction,                                  </span>
<span class="6727348862300723435" onmouseenter="enter('6727348862300723435');" onmouseout="out('6727348862300723435');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125             // or is external deposit.                                                                   </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 126 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="4275752493067967329" onmouseenter="enter('4275752493067967329');" onmouseout="out('4275752493067967329');" style=""> 127             // TODO: Check if external account belongs to initiator of deposit.                          </span>
<span class="5445848170118178590" onmouseenter="enter('5445848170118178590');" onmouseout="out('5445848170118178590');" style=""> 128             if (!(transaction.getFromAccountNum() == initiatorAcct                                       </span>
<span class="1192798190689011433" onmouseenter="enter('1192798190689011433');" onmouseout="out('1192798190689011433');" style=""> 129                   || transaction.getFromRoutingNum() != this.routingNum)) {                              </span>
<span class="-4261376410010701471" onmouseenter="enter('-4261376410010701471');" onmouseout="out('-4261376410010701471');" style=""> 130                 return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;,                                      </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 131                                                   HttpStatus.UNAUTHORIZED);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 132             }                                                                                            </span>
<span class="6454388725290926511" onmouseenter="enter('6454388725290926511');" onmouseout="out('6454388725290926511');" style=""> 133             // Ensure amount is valid value.                                                             </span>
<span class="-5788448725964879098" onmouseenter="enter('-5788448725964879098');" onmouseout="out('-5788448725964879098');" style=""> 134             if (transaction.getAmount() &lt;= 0) {                                                          </span>
<span class="-4728575539774215326" onmouseenter="enter('-4728575539774215326');" onmouseout="out('-4728575539774215326');" style=""> 135                 return new ResponseEntity&lt;String&gt;(&quot;invalid amount&quot;,                                      </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 136                                                   HttpStatus.BAD_REQUEST);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137             }                                                                                            </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style=""> 138             // Ensure sender balance can cover transaction.                                              </span>
<span class="3056394101732904906" onmouseenter="enter('3056394101732904906');" onmouseout="out('3056394101732904906');" style=""> 139             if (transaction.getFromRoutingNum() == this.routingNum) {                                    </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 140                 HttpHeaders headers = new HttpHeaders();                                                 </span>
<span class="-3213612526128830704" onmouseenter="enter('-3213612526128830704');" onmouseout="out('-3213612526128830704');" style=""> 141                 headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + bearerToken);                                   </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 142                 HttpEntity entity = new HttpEntity(headers);                                             </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 143                 RestTemplate restTemplate = new RestTemplate();                                          </span>
<span class="7970859498210029553" onmouseenter="enter('7970859498210029553');" onmouseout="out('7970859498210029553');" style=""> 144                 ResponseEntity&lt;Balance&gt; response = restTemplate.exchange(                                </span>
<span class="-1305278880063692183" onmouseenter="enter('-1305278880063692183');" onmouseout="out('-1305278880063692183');" style=""> 145                     balancesUri, HttpMethod.GET, entity, Balance.class);                                 </span>
<span class="6143505688729063401" onmouseenter="enter('6143505688729063401');" onmouseout="out('6143505688729063401');" style=""> 146                 Balance senderBalance = response.getBody();                                              </span>
<span class="-1303033997480808302" onmouseenter="enter('-1303033997480808302');" onmouseout="out('-1303033997480808302');" style=""> 147                 if (senderBalance.amount &lt; transaction.getAmount()) {                                    </span>
<span class="2206481543410021670" onmouseenter="enter('2206481543410021670');" onmouseout="out('2206481543410021670');" style=""> 148                     return new ResponseEntity&lt;String&gt;(&quot;insufficient balance&quot;,                            </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 149                                                       HttpStatus.BAD_REQUEST);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 150                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 151             }                                                                                            </span>
<span class="-2401114101205973109" onmouseenter="enter('-2401114101205973109');" onmouseout="out('-2401114101205973109');" style=""> 152             // Transaction looks valid. Add to ledger.                                                   </span>
<span class="3084400465291579829" onmouseenter="enter('3084400465291579829');" onmouseout="out('3084400465291579829');" style=""> 153             System.out.println(&quot;adding transaction: &quot; + transaction);                                    </span>
<span class="8546065069214242193" onmouseenter="enter('8546065069214242193');" onmouseout="out('8546065069214242193');" style=""> 154             submitTransaction(transaction);                                                              </span>
<span  style=""> 155                                                                                                          </span>
<span class="6989215251843914644" onmouseenter="enter('6989215251843914644');" onmouseout="out('6989215251843914644');" style=""> 156             return new ResponseEntity&lt;String&gt;(&quot;ok&quot;, HttpStatus.CREATED);                                 </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 157         } catch (JWTVerificationException e) {                                                           </span>
<span class="-4261376410010701471" onmouseenter="enter('-4261376410010701471');" onmouseout="out('-4261376410010701471');" style=""> 158             return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;,                                          </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 159                                               HttpStatus.UNAUTHORIZED);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161     }                                                                                                    </span>
<span  style=""> 162                                                                                                          </span>
<span class="-3784076083713608956" onmouseenter="enter('-3784076083713608956');" onmouseout="out('-3784076083713608956');" style=""> 163     private void submitTransaction(Transaction transaction) {                                            </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 164 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="7498617311447895258" onmouseenter="enter('7498617311447895258');" onmouseout="out('7498617311447895258');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165         StatefulRedisConnection redisConnection =                                                        </span>
<span class="6349065357163951214" onmouseenter="enter('6349065357163951214');" onmouseout="out('6349065357163951214');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166                 ctx.getBean(StatefulRedisConnection.class);                                              </span>
<span class="-4980751317840439774" onmouseenter="enter('-4980751317840439774');" onmouseout="out('-4980751317840439774');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167         // Use String key/values so Redis data can be read by non-Java clients.                          </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 168 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-807595089805637563" onmouseenter="enter('-807595089805637563');" onmouseout="out('-807595089805637563');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         redisConnection.async().xadd(ledgerStreamKey,                                                    </span>
<span class="4851644939618052278" onmouseenter="enter('4851644939618052278');" onmouseout="out('4851644939618052278');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170                 &quot;fromAccountNum&quot;, transaction.getFromAccountNum(),                                       </span>
<span class="-1809265815745185609" onmouseenter="enter('-1809265815745185609');" onmouseout="out('-1809265815745185609');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171                 &quot;fromRoutingNum&quot;, transaction.getFromRoutingNum(),                                       </span>
<span class="-6307168237707817579" onmouseenter="enter('-6307168237707817579');" onmouseout="out('-6307168237707817579');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172                 &quot;toAccountNum&quot;, transaction.getToAccountNum(),                                           </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 173 =======                                                                                                  </span>
<span class="-3647082945561347388" onmouseenter="enter('-3647082945561347388');" onmouseout="out('-3647082945561347388');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174         StatefulRedisConnection redisConnection = ctx.getBean(                                           </span>
<span class="8036177050952344872" onmouseenter="enter('8036177050952344872');" onmouseout="out('8036177050952344872');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175                 StatefulRedisConnection.class);                                                          </span>
<span class="-4538787334432814928" onmouseenter="enter('-4538787334432814928');" onmouseout="out('-4538787334432814928');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176         // Use String key/values so Redis data can be read by                                            </span>
<span class="8719640950027445310" onmouseenter="enter('8719640950027445310');" onmouseout="out('8719640950027445310');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177         // non-Java implementations.                                                                     </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 178 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-807595089805637563" onmouseenter="enter('-807595089805637563');" onmouseout="out('-807595089805637563');" style=""> 179         redisConnection.async().xadd(ledgerStreamKey,                                                    </span>
<span class="4851644939618052278" onmouseenter="enter('4851644939618052278');" onmouseout="out('4851644939618052278');" style=""> 180                 &quot;fromAccountNum&quot;, transaction.getFromAccountNum(),                                       </span>
<span class="-1809265815745185609" onmouseenter="enter('-1809265815745185609');" onmouseout="out('-1809265815745185609');" style=""> 181                 &quot;fromRoutingNum&quot;, transaction.getFromRoutingNum(),                                       </span>
<span class="-6307168237707817579" onmouseenter="enter('-6307168237707817579');" onmouseout="out('-6307168237707817579');" style=""> 182                 &quot;toAccountNum&quot;, transaction.getToAccountNum(),                                           </span>
<span class="3482307882589444663" onmouseenter="enter('3482307882589444663');" onmouseout="out('3482307882589444663');" style=""> 183                 &quot;toRoutingNum&quot;, transaction.getToRoutingNum(),                                           </span>
<span class="2057275500851535823" onmouseenter="enter('2057275500851535823');" onmouseout="out('2057275500851535823');" style=""> 184                 &quot;amount&quot;, transaction.getAmount().toString(),                                            </span>
<span class="718728881539759967" onmouseenter="enter('718728881539759967');" onmouseout="out('718728881539759967');" style=""> 185                 &quot;timestamp&quot;, Double.toString(transaction.getTimestamp()));                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 186     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 187 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15  */                                                                                                      </span>
<span  style="">  16                                                                                                          </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  17 package anthos.samples.financedemo.ledgerwriter;                                                         </span>
<span  style="">  18                                                                                                          </span>
<span class="3416473218750047572" onmouseenter="enter('3416473218750047572');" onmouseout="out('3416473218750047572');" style="">  19 import io.lettuce.core.api.StatefulRedisConnection;                                                      </span>
<span class="1015650858128177541" onmouseenter="enter('1015650858128177541');" onmouseout="out('1015650858128177541');" style="">  20 import org.springframework.context.ApplicationContext;                                                   </span>
<span class="2623752691140612054" onmouseenter="enter('2623752691140612054');" onmouseout="out('2623752691140612054');" style="">  21 import org.springframework.context.annotation.AnnotationConfigApplicationContext;                        </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  22 import org.springframework.http.HttpStatus;                                                              </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  23 import org.springframework.web.bind.annotation.GetMapping;                                               </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  24 import org.springframework.web.bind.annotation.PostMapping;                                              </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  25 import org.springframework.web.bind.annotation.RestController;                                           </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  26 import org.springframework.web.bind.annotation.RequestBody;                                              </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  27 import org.springframework.web.bind.annotation.RequestHeader;                                            </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  28 import org.springframework.web.bind.annotation.ResponseStatus;                                           </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  29 import org.springframework.http.ResponseEntity;                                                          </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  30 import org.springframework.web.client.RestTemplate;                                                      </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  31 import org.springframework.http.HttpHeaders;                                                             </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  32 import org.springframework.http.HttpEntity;                                                              </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  33 import org.springframework.http.HttpMethod;                                                              </span>
<span  style="">  34                                                                                                          </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  35 import java.io.IOException;                                                                              </span>
<span class="-5249557667130751282" onmouseenter="enter('-5249557667130751282');" onmouseout="out('-5249557667130751282');" style="">  36 import java.nio.file.Files;                                                                              </span>
<span class="7071256358513765675" onmouseenter="enter('7071256358513765675');" onmouseout="out('7071256358513765675');" style="">  37 import java.nio.file.Paths;                                                                              </span>
<span class="-8013228574741439948" onmouseenter="enter('-8013228574741439948');" onmouseout="out('-8013228574741439948');" style="">  38 import java.security.KeyFactory;                                                                         </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  39 import java.security.NoSuchAlgorithmException;                                                           </span>
<span class="-61053565471358753" onmouseenter="enter('-61053565471358753');" onmouseout="out('-61053565471358753');" style="">  40 import java.security.interfaces.RSAPublicKey;                                                            </span>
<span class="3289746377953945547" onmouseenter="enter('3289746377953945547');" onmouseout="out('3289746377953945547');" style="">  41 import java.security.spec.InvalidKeySpecException;                                                       </span>
<span class="7906465591428389933" onmouseenter="enter('7906465591428389933');" onmouseout="out('7906465591428389933');" style="">  42 import java.security.spec.X509EncodedKeySpec;                                                            </span>
<span class="-6935710760624141930" onmouseenter="enter('-6935710760624141930');" onmouseout="out('-6935710760624141930');" style="">  43 import java.util.Base64;                                                                                 </span>
<span  style="">  44                                                                                                          </span>
<span class="-6655146115708071580" onmouseenter="enter('-6655146115708071580');" onmouseout="out('-6655146115708071580');" style="">  45 import com.auth0.jwt.algorithms.Algorithm;                                                               </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  46 import com.auth0.jwt.interfaces.DecodedJWT;                                                              </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  47 import com.auth0.jwt.exceptions.JWTVerificationException;                                                </span>
<span class="2931637313601470038" onmouseenter="enter('2931637313601470038');" onmouseout="out('2931637313601470038');" style="">  48 import com.auth0.jwt.JWT;                                                                                </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  49 import com.auth0.jwt.JWTVerifier;                                                                        </span>
<span  style="">  50                                                                                                          </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  51 @RestController                                                                                          </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  52 public final class LedgerWriterController {                                                              </span>
<span  style="">  53                                                                                                          </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style="">  54 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="3137105351418099518" onmouseenter="enter('3137105351418099518');" onmouseout="out('3137105351418099518');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55 ApplicationContext ctx =                                                                                 </span>
<span class="7104311876824495896" onmouseenter="enter('7104311876824495896');" onmouseout="out('7104311876824495896');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56             new AnnotationConfigApplicationContext(LedgerWriterConfig.class);                            </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style="">  57 ||||||| BASE                                                                                             </span>
<span class="4228229669487578025" onmouseenter="enter('4228229669487578025');" onmouseout="out('4228229669487578025');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 ApplicationContext ctx = new AnnotationConfigApplicationContext(LedgerWriterConfig.class);               </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  59 =======                                                                                                  </span>
<span class="2454959921614149006" onmouseenter="enter('2454959921614149006');" onmouseout="out('2454959921614149006');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60 ApplicationContext ctx = new AnnotationConfigApplicationContext(                                         </span>
<span class="6329527144215806426" onmouseenter="enter('6329527144215806426');" onmouseout="out('6329527144215806426');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61         LedgerWriterConfig.class);                                                                       </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style="">  62 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span  style="">  63                                                                                                          </span>
<span  style="">  64                                                                                                          </span>
<span class="-5604269207838210422" onmouseenter="enter('-5604269207838210422');" onmouseout="out('-5604269207838210422');" style="">  65     private final String ledgerStreamKey = System.getenv(&quot;LEDGER_STREAM&quot;);                               </span>
<span class="8411565151832508655" onmouseenter="enter('8411565151832508655');" onmouseout="out('8411565151832508655');" style="">  66     private final String routingNum =  System.getenv(&quot;LOCAL_ROUTING_NUM&quot;);                               </span>
<span class="-6551832665109601256" onmouseenter="enter('-6551832665109601256');" onmouseout="out('-6551832665109601256');" style="">  67     private final String balancesUri = String.format(&quot;http://%s/get_balance&quot;,                            </span>
<span class="-1420395203196747354" onmouseenter="enter('-1420395203196747354');" onmouseout="out('-1420395203196747354');" style="">  68         System.getenv(&quot;BALANCES_API_ADDR&quot;));                                                             </span>
<span class="4358404513907099662" onmouseenter="enter('4358404513907099662');" onmouseout="out('4358404513907099662');" style="">  69     private final JWTVerifier verifier;                                                                  </span>
<span  style="">  70                                                                                                          </span>
<span class="8064586665074901273" onmouseenter="enter('8064586665074901273');" onmouseout="out('8064586665074901273');" style="">  71     public LedgerWriterController() throws IOException,                                                  </span>
<span class="1894253170606682489" onmouseenter="enter('1894253170606682489');" onmouseout="out('1894253170606682489');" style="">  72                                            NoSuchAlgorithmException,                                     </span>
<span class="1072467281893302576" onmouseenter="enter('1072467281893302576');" onmouseout="out('1072467281893302576');" style="">  73                                            InvalidKeySpecException {                                     </span>
<span class="-1999315777049585600" onmouseenter="enter('-1999315777049585600');" onmouseout="out('-1999315777049585600');" style="">  74         // load public key from file                                                                     </span>
<span class="3809711205239471476" onmouseenter="enter('3809711205239471476');" onmouseout="out('3809711205239471476');" style="">  75         String fPath = System.getenv(&quot;PUB_KEY_PATH&quot;);                                                    </span>
<span class="5673882543335836624" onmouseenter="enter('5673882543335836624');" onmouseout="out('5673882543335836624');" style="">  76         String pubKeyStr  = new String(Files.readAllBytes(Paths.get(fPath)));                            </span>
<span class="7209009376448743897" onmouseenter="enter('7209009376448743897');" onmouseout="out('7209009376448743897');" style="">  77         pubKeyStr = pubKeyStr.replaceFirst(&quot;-----BEGIN PUBLIC KEY-----&quot;, &quot;&quot;);                            </span>
<span class="4927348229997813303" onmouseenter="enter('4927348229997813303');" onmouseout="out('4927348229997813303');" style="">  78         pubKeyStr = pubKeyStr.replaceFirst(&quot;-----END PUBLIC KEY-----&quot;, &quot;&quot;);                              </span>
<span class="-828263452525302924" onmouseenter="enter('-828263452525302924');" onmouseout="out('-828263452525302924');" style="">  79         pubKeyStr = pubKeyStr.replaceAll(&quot;\\s&quot;, &quot;&quot;);                                                     </span>
<span class="-3743771444177503093" onmouseenter="enter('-3743771444177503093');" onmouseout="out('-3743771444177503093');" style="">  80         byte[] pubKeyBytes = Base64.getDecoder().decode(pubKeyStr);                                      </span>
<span class="438744628498497549" onmouseenter="enter('438744628498497549');" onmouseout="out('438744628498497549');" style="">  81         KeyFactory kf = KeyFactory.getInstance(&quot;RSA&quot;);                                                   </span>
<span class="4154530442155105022" onmouseenter="enter('4154530442155105022');" onmouseout="out('4154530442155105022');" style="">  82         X509EncodedKeySpec keySpecX509 = new X509EncodedKeySpec(pubKeyBytes);                            </span>
<span class="169640045417215895" onmouseenter="enter('169640045417215895');" onmouseout="out('169640045417215895');" style="">  83         RSAPublicKey publicKey = (RSAPublicKey) kf.generatePublic(keySpecX509);                          </span>
<span class="2306753067902644237" onmouseenter="enter('2306753067902644237');" onmouseout="out('2306753067902644237');" style="">  84         // set up verifier                                                                               </span>
<span class="-6857500803242936007" onmouseenter="enter('-6857500803242936007');" onmouseout="out('-6857500803242936007');" style="">  85         Algorithm algorithm = Algorithm.RSA256(publicKey, null);                                         </span>
<span class="3110240470386105373" onmouseenter="enter('3110240470386105373');" onmouseout="out('3110240470386105373');" style="">  86         this.verifier = JWT.require(algorithm).build();                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  87     }                                                                                                    </span>
<span  style="">  88                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  89     /**                                                                                                  </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style="">  90      * Readiness probe endpoint.                                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  91      *                                                                                                   </span>
<span class="-6237848493354397724" onmouseenter="enter('-6237848493354397724');" onmouseout="out('-6237848493354397724');" style="">  92      * @return HTTP Status 200 if server is serving requests.                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  93      */                                                                                                  </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style="">  94     @GetMapping(&quot;/ready&quot;)                                                                                </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style="">  95     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="-4385440054719104188" onmouseenter="enter('-4385440054719104188');" onmouseout="out('-4385440054719104188');" style="">  96     public String readiness() {                                                                          </span>
<span class="4704682847571117723" onmouseenter="enter('4704682847571117723');" onmouseout="out('4704682847571117723');" style="">  97         return &quot;ok&quot;;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  98     }                                                                                                    </span>
<span  style="">  99                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 100     /**                                                                                                  </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style=""> 101      * Submit a new transaction to the ledger.                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 102      *                                                                                                   </span>
<span class="8344965626844763807" onmouseenter="enter('8344965626844763807');" onmouseout="out('8344965626844763807');" style=""> 103      * @param Transaction to be submitted.                                                               </span>
<span class="5706658156997278370" onmouseenter="enter('5706658156997278370');" onmouseout="out('5706658156997278370');" style=""> 104      * @return HTTP Status 200 if transaction was successfully submitted.                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 105      */                                                                                                  </span>
<span class="1119678417808751550" onmouseenter="enter('1119678417808751550');" onmouseout="out('1119678417808751550');" style=""> 106     @PostMapping(value = &quot;/new_transaction&quot;, consumes = &quot;application/json&quot;)                              </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 107     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="1897907323625472935" onmouseenter="enter('1897907323625472935');" onmouseout="out('1897907323625472935');" style=""> 108     public ResponseEntity&lt;?&gt; addTransaction(                                                             </span>
<span class="1166903297081280981" onmouseenter="enter('1166903297081280981');" onmouseout="out('1166903297081280981');" style=""> 109             @RequestHeader(&quot;Authorization&quot;) String bearerToken,                                          </span>
<span class="9022696444049056102" onmouseenter="enter('9022696444049056102');" onmouseout="out('9022696444049056102');" style=""> 110             @RequestBody Transaction transaction) {                                                      </span>
<span class="-3538581758087352701" onmouseenter="enter('-3538581758087352701');" onmouseout="out('-3538581758087352701');" style=""> 111         if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                  </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 112             bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 114         try {                                                                                            </span>
<span class="4753652363839392700" onmouseenter="enter('4753652363839392700');" onmouseout="out('4753652363839392700');" style=""> 115             DecodedJWT jwt = this.verifier.verify(bearerToken);                                          </span>
<span class="-1766896061973454949" onmouseenter="enter('-1766896061973454949');" onmouseout="out('-1766896061973454949');" style=""> 116             String initiatorAcct = jwt.getClaim(&quot;acct&quot;).asString();                                      </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 117 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="5927642596742306408" onmouseenter="enter('5927642596742306408');" onmouseout="out('5927642596742306408');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118             // Ensure sender is the one who initiated this transaction, or it is                         </span>
<span class="771710869172324231" onmouseenter="enter('771710869172324231');" onmouseout="out('771710869172324231');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119             // an external deposit.                                                                      </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 120 ||||||| BASE                                                                                             </span>
<span class="-6144480017328455138" onmouseenter="enter('-6144480017328455138');" onmouseout="out('-6144480017328455138');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121             // Ensure sender is the one who initiated this transaction, or is external deposit.          </span>
<span class="4275752493067967329" onmouseenter="enter('4275752493067967329');" onmouseout="out('4275752493067967329');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122             // TODO: Check if external account belongs to initiator of deposit.                          </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 123 =======                                                                                                  </span>
<span class="2239362758347684288" onmouseenter="enter('2239362758347684288');" onmouseout="out('2239362758347684288');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124             // Ensure sender is the one who initiated this transaction,                                  </span>
<span class="6727348862300723435" onmouseenter="enter('6727348862300723435');" onmouseout="out('6727348862300723435');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125             // or is external deposit.                                                                   </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 126 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="4275752493067967329" onmouseenter="enter('4275752493067967329');" onmouseout="out('4275752493067967329');" style=""> 127             // TODO: Check if external account belongs to initiator of deposit.                          </span>
<span class="5445848170118178590" onmouseenter="enter('5445848170118178590');" onmouseout="out('5445848170118178590');" style=""> 128             if (!(transaction.getFromAccountNum() == initiatorAcct                                       </span>
<span class="1192798190689011433" onmouseenter="enter('1192798190689011433');" onmouseout="out('1192798190689011433');" style=""> 129                   || transaction.getFromRoutingNum() != this.routingNum)) {                              </span>
<span class="-4261376410010701471" onmouseenter="enter('-4261376410010701471');" onmouseout="out('-4261376410010701471');" style=""> 130                 return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;,                                      </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 131                                                   HttpStatus.UNAUTHORIZED);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 132             }                                                                                            </span>
<span class="6454388725290926511" onmouseenter="enter('6454388725290926511');" onmouseout="out('6454388725290926511');" style=""> 133             // Ensure amount is valid value.                                                             </span>
<span class="-5788448725964879098" onmouseenter="enter('-5788448725964879098');" onmouseout="out('-5788448725964879098');" style=""> 134             if (transaction.getAmount() &lt;= 0) {                                                          </span>
<span class="-4728575539774215326" onmouseenter="enter('-4728575539774215326');" onmouseout="out('-4728575539774215326');" style=""> 135                 return new ResponseEntity&lt;String&gt;(&quot;invalid amount&quot;,                                      </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 136                                                   HttpStatus.BAD_REQUEST);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137             }                                                                                            </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style=""> 138             // Ensure sender balance can cover transaction.                                              </span>
<span class="3056394101732904906" onmouseenter="enter('3056394101732904906');" onmouseout="out('3056394101732904906');" style=""> 139             if (transaction.getFromRoutingNum() == this.routingNum) {                                    </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 140                 HttpHeaders headers = new HttpHeaders();                                                 </span>
<span class="-3213612526128830704" onmouseenter="enter('-3213612526128830704');" onmouseout="out('-3213612526128830704');" style=""> 141                 headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + bearerToken);                                   </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 142                 HttpEntity entity = new HttpEntity(headers);                                             </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 143                 RestTemplate restTemplate = new RestTemplate();                                          </span>
<span class="7970859498210029553" onmouseenter="enter('7970859498210029553');" onmouseout="out('7970859498210029553');" style=""> 144                 ResponseEntity&lt;Balance&gt; response = restTemplate.exchange(                                </span>
<span class="-1305278880063692183" onmouseenter="enter('-1305278880063692183');" onmouseout="out('-1305278880063692183');" style=""> 145                     balancesUri, HttpMethod.GET, entity, Balance.class);                                 </span>
<span class="6143505688729063401" onmouseenter="enter('6143505688729063401');" onmouseout="out('6143505688729063401');" style=""> 146                 Balance senderBalance = response.getBody();                                              </span>
<span class="-1303033997480808302" onmouseenter="enter('-1303033997480808302');" onmouseout="out('-1303033997480808302');" style=""> 147                 if (senderBalance.amount &lt; transaction.getAmount()) {                                    </span>
<span class="2206481543410021670" onmouseenter="enter('2206481543410021670');" onmouseout="out('2206481543410021670');" style=""> 148                     return new ResponseEntity&lt;String&gt;(&quot;insufficient balance&quot;,                            </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 149                                                       HttpStatus.BAD_REQUEST);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 150                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 151             }                                                                                            </span>
<span class="-2401114101205973109" onmouseenter="enter('-2401114101205973109');" onmouseout="out('-2401114101205973109');" style=""> 152             // Transaction looks valid. Add to ledger.                                                   </span>
<span class="3084400465291579829" onmouseenter="enter('3084400465291579829');" onmouseout="out('3084400465291579829');" style=""> 153             System.out.println(&quot;adding transaction: &quot; + transaction);                                    </span>
<span class="8546065069214242193" onmouseenter="enter('8546065069214242193');" onmouseout="out('8546065069214242193');" style=""> 154             submitTransaction(transaction);                                                              </span>
<span  style=""> 155                                                                                                          </span>
<span class="6989215251843914644" onmouseenter="enter('6989215251843914644');" onmouseout="out('6989215251843914644');" style=""> 156             return new ResponseEntity&lt;String&gt;(&quot;ok&quot;, HttpStatus.CREATED);                                 </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 157         } catch (JWTVerificationException e) {                                                           </span>
<span class="-4261376410010701471" onmouseenter="enter('-4261376410010701471');" onmouseout="out('-4261376410010701471');" style=""> 158             return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;,                                          </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 159                                               HttpStatus.UNAUTHORIZED);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161     }                                                                                                    </span>
<span  style=""> 162                                                                                                          </span>
<span class="-3784076083713608956" onmouseenter="enter('-3784076083713608956');" onmouseout="out('-3784076083713608956');" style=""> 163     private void submitTransaction(Transaction transaction) {                                            </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 164 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="7498617311447895258" onmouseenter="enter('7498617311447895258');" onmouseout="out('7498617311447895258');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165         StatefulRedisConnection redisConnection =                                                        </span>
<span class="6349065357163951214" onmouseenter="enter('6349065357163951214');" onmouseout="out('6349065357163951214');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166                 ctx.getBean(StatefulRedisConnection.class);                                              </span>
<span class="-4980751317840439774" onmouseenter="enter('-4980751317840439774');" onmouseout="out('-4980751317840439774');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167         // Use String key/values so Redis data can be read by non-Java clients.                          </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 168 ||||||| BASE                                                                                             </span>
<span class="-3468620722690629670" onmouseenter="enter('-3468620722690629670');" onmouseout="out('-3468620722690629670');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         StatefulRedisConnection redisConnection = ctx.getBean(StatefulRedisConnection.class);            </span>
<span class="-7733771365331750517" onmouseenter="enter('-7733771365331750517');" onmouseout="out('-7733771365331750517');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         // Use String key/values so Redis data can be read by non-Java implementations.                  </span>
<span class="-807595089805637563" onmouseenter="enter('-807595089805637563');" onmouseout="out('-807595089805637563');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         redisConnection.async().xadd(ledgerStreamKey,                                                    </span>
<span class="4851644939618052278" onmouseenter="enter('4851644939618052278');" onmouseout="out('4851644939618052278');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172                 &quot;fromAccountNum&quot;, transaction.getFromAccountNum(),                                       </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 173 =======                                                                                                  </span>
<span class="-3647082945561347388" onmouseenter="enter('-3647082945561347388');" onmouseout="out('-3647082945561347388');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174         StatefulRedisConnection redisConnection = ctx.getBean(                                           </span>
<span class="8036177050952344872" onmouseenter="enter('8036177050952344872');" onmouseout="out('8036177050952344872');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175                 StatefulRedisConnection.class);                                                          </span>
<span class="-4538787334432814928" onmouseenter="enter('-4538787334432814928');" onmouseout="out('-4538787334432814928');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176         // Use String key/values so Redis data can be read by                                            </span>
<span class="8719640950027445310" onmouseenter="enter('8719640950027445310');" onmouseout="out('8719640950027445310');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177         // non-Java implementations.                                                                     </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 178 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="-807595089805637563" onmouseenter="enter('-807595089805637563');" onmouseout="out('-807595089805637563');" style=""> 179         redisConnection.async().xadd(ledgerStreamKey,                                                    </span>
<span class="4851644939618052278" onmouseenter="enter('4851644939618052278');" onmouseout="out('4851644939618052278');" style=""> 180                 &quot;fromAccountNum&quot;, transaction.getFromAccountNum(),                                       </span>
<span class="-1809265815745185609" onmouseenter="enter('-1809265815745185609');" onmouseout="out('-1809265815745185609');" style=""> 181                 &quot;fromRoutingNum&quot;, transaction.getFromRoutingNum(),                                       </span>
<span class="-6307168237707817579" onmouseenter="enter('-6307168237707817579');" onmouseout="out('-6307168237707817579');" style=""> 182                 &quot;toAccountNum&quot;, transaction.getToAccountNum(),                                           </span>
<span class="3482307882589444663" onmouseenter="enter('3482307882589444663');" onmouseout="out('3482307882589444663');" style=""> 183                 &quot;toRoutingNum&quot;, transaction.getToRoutingNum(),                                           </span>
<span class="2057275500851535823" onmouseenter="enter('2057275500851535823');" onmouseout="out('2057275500851535823');" style=""> 184                 &quot;amount&quot;, transaction.getAmount().toString(),                                            </span>
<span class="718728881539759967" onmouseenter="enter('718728881539759967');" onmouseout="out('718728881539759967');" style=""> 185                 &quot;timestamp&quot;, Double.toString(transaction.getTimestamp()));                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 186     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 187 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2  * Copyright 2020, Google LLC.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3  *                                                                                                       </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                       </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5  * you may not use this file except in compliance with the License.                                      </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6  * You may obtain a copy of the License at                                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15  */                                                                                                      </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  16 package anthos.samples.financedemo.ledgerwriter;                                                         </span>
<span  style="">  17                                                                                                          </span>
<span class="2931637313601470038" onmouseenter="enter('2931637313601470038');" onmouseout="out('2931637313601470038');" style="">  18 import com.auth0.jwt.JWT;                                                                                </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  19 import com.auth0.jwt.JWTVerifier;                                                                        </span>
<span class="-6655146115708071580" onmouseenter="enter('-6655146115708071580');" onmouseout="out('-6655146115708071580');" style="">  20 import com.auth0.jwt.algorithms.Algorithm;                                                               </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  21 import com.auth0.jwt.exceptions.JWTVerificationException;                                                </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  22 import com.auth0.jwt.interfaces.DecodedJWT;                                                              </span>
<span class="3416473218750047572" onmouseenter="enter('3416473218750047572');" onmouseout="out('3416473218750047572');" style="">  23 import io.lettuce.core.api.StatefulRedisConnection;                                                      </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  24 import java.io.IOException;                                                                              </span>
<span class="-5249557667130751282" onmouseenter="enter('-5249557667130751282');" onmouseout="out('-5249557667130751282');" style="">  25 import java.nio.file.Files;                                                                              </span>
<span class="7071256358513765675" onmouseenter="enter('7071256358513765675');" onmouseout="out('7071256358513765675');" style="">  26 import java.nio.file.Paths;                                                                              </span>
<span class="-8013228574741439948" onmouseenter="enter('-8013228574741439948');" onmouseout="out('-8013228574741439948');" style="">  27 import java.security.KeyFactory;                                                                         </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  28 import java.security.NoSuchAlgorithmException;                                                           </span>
<span class="-61053565471358753" onmouseenter="enter('-61053565471358753');" onmouseout="out('-61053565471358753');" style="">  29 import java.security.interfaces.RSAPublicKey;                                                            </span>
<span class="3289746377953945547" onmouseenter="enter('3289746377953945547');" onmouseout="out('3289746377953945547');" style="">  30 import java.security.spec.InvalidKeySpecException;                                                       </span>
<span class="7906465591428389933" onmouseenter="enter('7906465591428389933');" onmouseout="out('7906465591428389933');" style="">  31 import java.security.spec.X509EncodedKeySpec;                                                            </span>
<span class="-6935710760624141930" onmouseenter="enter('-6935710760624141930');" onmouseout="out('-6935710760624141930');" style="">  32 import java.util.Base64;                                                                                 </span>
<span class="1015650858128177541" onmouseenter="enter('1015650858128177541');" onmouseout="out('1015650858128177541');" style="">  33 import org.springframework.context.ApplicationContext;                                                   </span>
<span class="2623752691140612054" onmouseenter="enter('2623752691140612054');" onmouseout="out('2623752691140612054');" style="">  34 import org.springframework.context.annotation.AnnotationConfigApplicationContext;                        </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  35 import org.springframework.http.HttpEntity;                                                              </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  36 import org.springframework.http.HttpHeaders;                                                             </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  37 import org.springframework.http.HttpMethod;                                                              </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  38 import org.springframework.http.HttpStatus;                                                              </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  39 import org.springframework.http.ResponseEntity;                                                          </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  40 import org.springframework.web.bind.annotation.GetMapping;                                               </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  41 import org.springframework.web.bind.annotation.PostMapping;                                              </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  42 import org.springframework.web.bind.annotation.RequestBody;                                              </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  43 import org.springframework.web.bind.annotation.RequestHeader;                                            </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  44 import org.springframework.web.bind.annotation.ResponseStatus;                                           </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  45 import org.springframework.web.bind.annotation.RestController;                                           </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  46 import org.springframework.web.client.RestTemplate;                                                      </span>
<span  style="">  47                                                                                                          </span>
<span  style="">  48                                                                                                          </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  49 @RestController                                                                                          </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  50 public final class LedgerWriterController {                                                              </span>
<span class="4228229669487578025" onmouseenter="enter('4228229669487578025');" onmouseout="out('4228229669487578025');" style="">  51     ApplicationContext ctx = new AnnotationConfigApplicationContext(LedgerWriterConfig.class);           </span>
<span  style="">  52                                                                                                          </span>
<span class="-5604269207838210422" onmouseenter="enter('-5604269207838210422');" onmouseout="out('-5604269207838210422');" style="">  53     private final String ledgerStreamKey = System.getenv(&quot;LEDGER_STREAM&quot;);                               </span>
<span  style="">  54                                                                                                          </span>
<span class="8411565151832508655" onmouseenter="enter('8411565151832508655');" onmouseout="out('8411565151832508655');" style="">  55     private final String routingNum =  System.getenv(&quot;LOCAL_ROUTING_NUM&quot;);                               </span>
<span  style="">  56                                                                                                          </span>
<span class="2213486514290094522" onmouseenter="enter('2213486514290094522');" onmouseout="out('2213486514290094522');" style=""><abbr title="  57     private final String balancesUri = String.format(&quot;http://%s/get_balance&quot;, System.getenv(&quot;BALANCES_API_ADDR&quot;));">  57     private final String balancesUri = String.format(&quot;http://%s/get_balance&quot;, System.getenv(&quot;BALANCES_API🔵</abbr></span>
<span  style="">  58                                                                                                          </span>
<span class="4358404513907099662" onmouseenter="enter('4358404513907099662');" onmouseout="out('4358404513907099662');" style="">  59     private final JWTVerifier verifier;                                                                  </span>
<span  style="">  60                                                                                                          </span>
<span class="6520330777945933954" onmouseenter="enter('6520330777945933954');" onmouseout="out('6520330777945933954');" style=""><abbr title="  61     public LedgerWriterController() throws IOException, NoSuchAlgorithmException, InvalidKeySpecException {">  61     public LedgerWriterController() throws IOException, NoSuchAlgorithmException, InvalidKeySpecException🔵</abbr></span>
<span class="-1999315777049585600" onmouseenter="enter('-1999315777049585600');" onmouseout="out('-1999315777049585600');" style="">  62         // load public key from file                                                                     </span>
<span class="3809711205239471476" onmouseenter="enter('3809711205239471476');" onmouseout="out('3809711205239471476');" style="">  63         String fPath = System.getenv(&quot;PUB_KEY_PATH&quot;);                                                    </span>
<span class="-2535551394398579606" onmouseenter="enter('-2535551394398579606');" onmouseout="out('-2535551394398579606');" style="">  64         String pubKeyStr = new String(Files.readAllBytes(Paths.get(fPath)));                             </span>
<span class="7209009376448743897" onmouseenter="enter('7209009376448743897');" onmouseout="out('7209009376448743897');" style="">  65         pubKeyStr = pubKeyStr.replaceFirst(&quot;-----BEGIN PUBLIC KEY-----&quot;, &quot;&quot;);                            </span>
<span class="4927348229997813303" onmouseenter="enter('4927348229997813303');" onmouseout="out('4927348229997813303');" style="">  66         pubKeyStr = pubKeyStr.replaceFirst(&quot;-----END PUBLIC KEY-----&quot;, &quot;&quot;);                              </span>
<span class="-828263452525302924" onmouseenter="enter('-828263452525302924');" onmouseout="out('-828263452525302924');" style="">  67         pubKeyStr = pubKeyStr.replaceAll(&quot;\\s&quot;, &quot;&quot;);                                                     </span>
<span class="-3743771444177503093" onmouseenter="enter('-3743771444177503093');" onmouseout="out('-3743771444177503093');" style="">  68         byte[] pubKeyBytes = Base64.getDecoder().decode(pubKeyStr);                                      </span>
<span class="438744628498497549" onmouseenter="enter('438744628498497549');" onmouseout="out('438744628498497549');" style="">  69         KeyFactory kf = KeyFactory.getInstance(&quot;RSA&quot;);                                                   </span>
<span class="4154530442155105022" onmouseenter="enter('4154530442155105022');" onmouseout="out('4154530442155105022');" style="">  70         X509EncodedKeySpec keySpecX509 = new X509EncodedKeySpec(pubKeyBytes);                            </span>
<span class="-323897587480873359" onmouseenter="enter('-323897587480873359');" onmouseout="out('-323897587480873359');" style="">  71         RSAPublicKey publicKey = ((RSAPublicKey) (kf.generatePublic(keySpecX509)));                      </span>
<span class="2306753067902644237" onmouseenter="enter('2306753067902644237');" onmouseout="out('2306753067902644237');" style="">  72         // set up verifier                                                                               </span>
<span class="-6857500803242936007" onmouseenter="enter('-6857500803242936007');" onmouseout="out('-6857500803242936007');" style="">  73         Algorithm algorithm = Algorithm.RSA256(publicKey, null);                                         </span>
<span class="3110240470386105373" onmouseenter="enter('3110240470386105373');" onmouseout="out('3110240470386105373');" style="">  74         this.verifier = JWT.require(algorithm).build();                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  75     }                                                                                                    </span>
<span  style="">  76                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  77     /**                                                                                                  </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style="">  78      * Readiness probe endpoint.                                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  79      *                                                                                                   </span>
<span class="-6237848493354397724" onmouseenter="enter('-6237848493354397724');" onmouseout="out('-6237848493354397724');" style="">  80      * @return HTTP Status 200 if server is serving requests.                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  81      */                                                                                                  </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style="">  82     @GetMapping(&quot;/ready&quot;)                                                                                </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style="">  83     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="-4385440054719104188" onmouseenter="enter('-4385440054719104188');" onmouseout="out('-4385440054719104188');" style="">  84     public String readiness() {                                                                          </span>
<span class="4704682847571117723" onmouseenter="enter('4704682847571117723');" onmouseout="out('4704682847571117723');" style="">  85         return &quot;ok&quot;;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  86     }                                                                                                    </span>
<span  style="">  87                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  88     /**                                                                                                  </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style="">  89      * Submit a new transaction to the ledger.                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  90      *                                                                                                   </span>
<span class="8344965626844763807" onmouseenter="enter('8344965626844763807');" onmouseout="out('8344965626844763807');" style="">  91      * @param Transaction to be submitted.                                                               </span>
<span class="5706658156997278370" onmouseenter="enter('5706658156997278370');" onmouseout="out('5706658156997278370');" style="">  92      * @return HTTP Status 200 if transaction was successfully submitted.                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  93      */                                                                                                  </span>
<span class="1119678417808751550" onmouseenter="enter('1119678417808751550');" onmouseout="out('1119678417808751550');" style="">  94     @PostMapping(value = &quot;/new_transaction&quot;, consumes = &quot;application/json&quot;)                              </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style="">  95     @ResponseStatus(HttpStatus.OK)                                                                       </span>
<span class="5470864294584925323" onmouseenter="enter('5470864294584925323');" onmouseout="out('5470864294584925323');" style="">  96     public ResponseEntity&lt;?&gt; addTransaction(@RequestHeader(&quot;Authorization&quot;)                              </span>
<span class="-5836505278597876000" onmouseenter="enter('-5836505278597876000');" onmouseout="out('-5836505278597876000');" style="">  97     String bearerToken, @RequestBody                                                                     </span>
<span class="395989369435282996" onmouseenter="enter('395989369435282996');" onmouseout="out('395989369435282996');" style="">  98     Transaction transaction) {                                                                           </span>
<span class="-6149106221954289698" onmouseenter="enter('-6149106221954289698');" onmouseout="out('-6149106221954289698');" style="">  99         if ((bearerToken != null) &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 100             bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 101         }                                                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 102         try {                                                                                            </span>
<span class="4753652363839392700" onmouseenter="enter('4753652363839392700');" onmouseout="out('4753652363839392700');" style=""> 103             DecodedJWT jwt = this.verifier.verify(bearerToken);                                          </span>
<span class="-1766896061973454949" onmouseenter="enter('-1766896061973454949');" onmouseout="out('-1766896061973454949');" style=""> 104             String initiatorAcct = jwt.getClaim(&quot;acct&quot;).asString();                                      </span>
<span  style=""> 105                                                                                                          </span>
<span class="-6681681893462133916" onmouseenter="enter('-6681681893462133916');" onmouseout="out('-6681681893462133916');" style=""> 106 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT                                                                                             </span>
<span class="5927642596742306408" onmouseenter="enter('5927642596742306408');" onmouseout="out('5927642596742306408');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107 // Ensure sender is the one who initiated this transaction, or it is                                     </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 108 ||||||| BASE                                                                                             </span>
<span class="-3639349873877828882" onmouseenter="enter('-3639349873877828882');" onmouseout="out('-3639349873877828882');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 109 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 109 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 110 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111                                                                                                          </span>
<span class="2239362758347684288" onmouseenter="enter('2239362758347684288');" onmouseout="out('2239362758347684288');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112 // Ensure sender is the one who initiated this transaction,                                              </span>
<span class="-1814092468913316143" onmouseenter="enter('-1814092468913316143');" onmouseout="out('-1814092468913316143');" style=""> 113 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT                                                                                            </span>
<span  style=""> 114                                                                                                          </span>
<span class="4275752493067967329" onmouseenter="enter('4275752493067967329');" onmouseout="out('4275752493067967329');" style=""> 115             // TODO: Check if external account belongs to initiator of deposit.                          </span>
<span class="-9194934638473141197" onmouseenter="enter('-9194934638473141197');" onmouseout="out('-9194934638473141197');" style=""><abbr title=" 116             if (!((transaction.getFromAccountNum() == initiatorAcct) || (transaction.getFromRoutingNum() != this.routingNum))) {"> 116             if (!((transaction.getFromAccountNum() == initiatorAcct) || (transaction.getFromRoutingNum() 🔵</abbr></span>
<span class="-8783454172910499232" onmouseenter="enter('-8783454172910499232');" onmouseout="out('-8783454172910499232');" style=""> 117                 return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;, HttpStatus.UNAUTHORIZED);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 118             }                                                                                            </span>
<span class="6454388725290926511" onmouseenter="enter('6454388725290926511');" onmouseout="out('6454388725290926511');" style=""> 119             // Ensure amount is valid value.                                                             </span>
<span class="-5788448725964879098" onmouseenter="enter('-5788448725964879098');" onmouseout="out('-5788448725964879098');" style=""> 120             if (transaction.getAmount() &lt;= 0) {                                                          </span>
<span class="-1161140720203252446" onmouseenter="enter('-1161140720203252446');" onmouseout="out('-1161140720203252446');" style=""> 121                 return new ResponseEntity&lt;String&gt;(&quot;invalid amount&quot;, HttpStatus.BAD_REQUEST);             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122             }                                                                                            </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style=""> 123             // Ensure sender balance can cover transaction.                                              </span>
<span class="3056394101732904906" onmouseenter="enter('3056394101732904906');" onmouseout="out('3056394101732904906');" style=""> 124             if (transaction.getFromRoutingNum() == this.routingNum) {                                    </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 125                 HttpHeaders headers = new HttpHeaders();                                                 </span>
<span class="-3213612526128830704" onmouseenter="enter('-3213612526128830704');" onmouseout="out('-3213612526128830704');" style=""> 126                 headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + bearerToken);                                   </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 127                 HttpEntity entity = new HttpEntity(headers);                                             </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 128                 RestTemplate restTemplate = new RestTemplate();                                          </span>
<span class="-7343720464544984615" onmouseenter="enter('-7343720464544984615');" onmouseout="out('-7343720464544984615');" style=""><abbr title=" 129                 ResponseEntity&lt;Balance&gt; response = restTemplate.exchange(balancesUri, HttpMethod.GET, entity, Balance.class);"> 129                 ResponseEntity&lt;Balance&gt; response = restTemplate.exchange(balancesUri, HttpMethod.GET, ent🔵</abbr></span>
<span class="6143505688729063401" onmouseenter="enter('6143505688729063401');" onmouseout="out('6143505688729063401');" style=""> 130                 Balance senderBalance = response.getBody();                                              </span>
<span class="-1303033997480808302" onmouseenter="enter('-1303033997480808302');" onmouseout="out('-1303033997480808302');" style=""> 131                 if (senderBalance.amount &lt; transaction.getAmount()) {                                    </span>
<span class="2540236067757686791" onmouseenter="enter('2540236067757686791');" onmouseout="out('2540236067757686791');" style=""> 132                     return new ResponseEntity&lt;String&gt;(&quot;insufficient balance&quot;, HttpStatus.BAD_REQUEST);   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 134             }                                                                                            </span>
<span class="-2401114101205973109" onmouseenter="enter('-2401114101205973109');" onmouseout="out('-2401114101205973109');" style=""> 135             // Transaction looks valid. Add to ledger.                                                   </span>
<span class="3084400465291579829" onmouseenter="enter('3084400465291579829');" onmouseout="out('3084400465291579829');" style=""> 136             System.out.println(&quot;adding transaction: &quot; + transaction);                                    </span>
<span class="8546065069214242193" onmouseenter="enter('8546065069214242193');" onmouseout="out('8546065069214242193');" style=""> 137             submitTransaction(transaction);                                                              </span>
<span class="6989215251843914644" onmouseenter="enter('6989215251843914644');" onmouseout="out('6989215251843914644');" style=""> 138             return new ResponseEntity&lt;String&gt;(&quot;ok&quot;, HttpStatus.CREATED);                                 </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 139         } catch (JWTVerificationException e) {                                                           </span>
<span class="-8783454172910499232" onmouseenter="enter('-8783454172910499232');" onmouseout="out('-8783454172910499232');" style=""> 140             return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;, HttpStatus.UNAUTHORIZED);                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 142     }                                                                                                    </span>
<span  style=""> 143                                                                                                          </span>
<span class="-3784076083713608956" onmouseenter="enter('-3784076083713608956');" onmouseout="out('-3784076083713608956');" style=""> 144     private void submitTransaction(Transaction transaction) {                                            </span>
<span class="-3468620722690629670" onmouseenter="enter('-3468620722690629670');" onmouseout="out('-3468620722690629670');" style=""> 145         StatefulRedisConnection redisConnection = ctx.getBean(StatefulRedisConnection.class);            </span>
<span  style=""> 146                                                                                                          </span>
<span class="-6681681893462133916" onmouseenter="enter('-6681681893462133916');" onmouseout="out('-6681681893462133916');" style=""> 147 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT                                                                                             </span>
<span class="-4980751317840439774" onmouseenter="enter('-4980751317840439774');" onmouseout="out('-4980751317840439774');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148 // Use String key/values so Redis data can be read by non-Java clients.                                  </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 149 ||||||| BASE                                                                                             </span>
<span class="-3639349873877828882" onmouseenter="enter('-3639349873877828882');" onmouseout="out('-3639349873877828882');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 150 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 150 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 151 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152                                                                                                          </span>
<span class="-4538787334432814928" onmouseenter="enter('-4538787334432814928');" onmouseout="out('-4538787334432814928');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153 // Use String key/values so Redis data can be read by                                                    </span>
<span class="-1814092468913316143" onmouseenter="enter('-1814092468913316143');" onmouseout="out('-1814092468913316143');" style=""> 154 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT                                                                                            </span>
<span  style=""> 155                                                                                                          </span>
<span class="8719640950027445310" onmouseenter="enter('8719640950027445310');" onmouseout="out('8719640950027445310');" style=""> 156         // non-Java implementations.                                                                     </span>
<span class="-378734690076705700" onmouseenter="enter('-378734690076705700');" onmouseout="out('-378734690076705700');" style=""><abbr title=" 157         redisConnection.async().xadd(ledgerStreamKey, &quot;fromAccountNum&quot;, transaction.getFromAccountNum(), &quot;fromRoutingNum&quot;, transaction.getFromRoutingNum(), &quot;toAccountNum&quot;, transaction.getToAccountNum(), &quot;toRoutingNum&quot;, transaction.getToRoutingNum(), &quot;amount&quot;, transaction.getAmount().toString(), &quot;timestamp&quot;, Double.toString(transaction.getTimestamp()));"> 157         redisConnection.async().xadd(ledgerStreamKey, &quot;fromAccountNum&quot;, transaction.getFromAccountNum(), 🔵</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 158     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159 }                                                                                                        </span>


























</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2   * Copyright 2020, Google LLC.                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3   *                                                                                                                </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                                </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5   * you may not use this file except in compliance with the License.                                               </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6   * You may obtain a copy of the License at                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7   *                                                                                                                </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8   *     http://www.apache.org/licenses/LICENSE-2.0                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15   */                                                                                                               </span>
<span  style="">  16                                                                                                                    </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  17  package anthos.samples.financedemo.ledgerwriter;                                                                  </span>
<span  style="">  18                                                                                                                    </span>
<span class="3416473218750047572" onmouseenter="enter('3416473218750047572');" onmouseout="out('3416473218750047572');" style="">  19  import io.lettuce.core.api.StatefulRedisConnection;                                                               </span>
<span class="1015650858128177541" onmouseenter="enter('1015650858128177541');" onmouseout="out('1015650858128177541');" style="">  20  import org.springframework.context.ApplicationContext;                                                            </span>
<span class="2623752691140612054" onmouseenter="enter('2623752691140612054');" onmouseout="out('2623752691140612054');" style="">  21  import org.springframework.context.annotation.AnnotationConfigApplicationContext;                                 </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  22  import org.springframework.http.HttpStatus;                                                                       </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  23  import org.springframework.web.bind.annotation.GetMapping;                                                        </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  24  import org.springframework.web.bind.annotation.PostMapping;                                                       </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  25  import org.springframework.web.bind.annotation.RestController;                                                    </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  26  import org.springframework.web.bind.annotation.RequestBody;                                                       </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  27  import org.springframework.web.bind.annotation.RequestHeader;                                                     </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  28  import org.springframework.web.bind.annotation.ResponseStatus;                                                    </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  29  import org.springframework.http.ResponseEntity;                                                                   </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  30  import org.springframework.web.client.RestTemplate;                                                               </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  31  import org.springframework.http.HttpHeaders;                                                                      </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  32  import org.springframework.http.HttpEntity;                                                                       </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  33  import org.springframework.http.HttpMethod;                                                                       </span>
<span  style="">  34                                                                                                                    </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  35  import java.io.IOException;                                                                                       </span>
<span class="-5249557667130751282" onmouseenter="enter('-5249557667130751282');" onmouseout="out('-5249557667130751282');" style="">  36  import java.nio.file.Files;                                                                                       </span>
<span class="7071256358513765675" onmouseenter="enter('7071256358513765675');" onmouseout="out('7071256358513765675');" style="">  37  import java.nio.file.Paths;                                                                                       </span>
<span class="-8013228574741439948" onmouseenter="enter('-8013228574741439948');" onmouseout="out('-8013228574741439948');" style="">  38  import java.security.KeyFactory;                                                                                  </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  39  import java.security.NoSuchAlgorithmException;                                                                    </span>
<span class="-61053565471358753" onmouseenter="enter('-61053565471358753');" onmouseout="out('-61053565471358753');" style="">  40  import java.security.interfaces.RSAPublicKey;                                                                     </span>
<span class="3289746377953945547" onmouseenter="enter('3289746377953945547');" onmouseout="out('3289746377953945547');" style="">  41  import java.security.spec.InvalidKeySpecException;                                                                </span>
<span class="7906465591428389933" onmouseenter="enter('7906465591428389933');" onmouseout="out('7906465591428389933');" style="">  42  import java.security.spec.X509EncodedKeySpec;                                                                     </span>
<span class="-6935710760624141930" onmouseenter="enter('-6935710760624141930');" onmouseout="out('-6935710760624141930');" style="">  43  import java.util.Base64;                                                                                          </span>
<span  style="">  44                                                                                                                    </span>
<span class="-6655146115708071580" onmouseenter="enter('-6655146115708071580');" onmouseout="out('-6655146115708071580');" style="">  45  import com.auth0.jwt.algorithms.Algorithm;                                                                        </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  46  import com.auth0.jwt.interfaces.DecodedJWT;                                                                       </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  47  import com.auth0.jwt.exceptions.JWTVerificationException;                                                         </span>
<span class="2931637313601470038" onmouseenter="enter('2931637313601470038');" onmouseout="out('2931637313601470038');" style="">  48  import com.auth0.jwt.JWT;                                                                                         </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  49  import com.auth0.jwt.JWTVerifier;                                                                                 </span>
<span  style="">  50                                                                                                                    </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  51  @RestController                                                                                                   </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  52  public final class LedgerWriterController {                                                                       </span>
<span  style="">  53                                                                                                                    </span>
<span class="4228229669487578025" onmouseenter="enter('4228229669487578025');" onmouseout="out('4228229669487578025');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  54 -    ApplicationContext ctx = new AnnotationConfigApplicationContext(LedgerWriterConfig.class);                    </span>
<span class="3137105351418099518" onmouseenter="enter('3137105351418099518');" onmouseout="out('3137105351418099518');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +    ApplicationContext ctx =                                                                                      </span>
<span class="7104311876824495896" onmouseenter="enter('7104311876824495896');" onmouseout="out('7104311876824495896');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +            new AnnotationConfigApplicationContext(LedgerWriterConfig.class);                                     </span>
<span  style="">  57                                                                                                                    </span>
<span class="-5604269207838210422" onmouseenter="enter('-5604269207838210422');" onmouseout="out('-5604269207838210422');" style="">  58      private final String ledgerStreamKey = System.getenv(&quot;LEDGER_STREAM&quot;);                                        </span>
<span class="8411565151832508655" onmouseenter="enter('8411565151832508655');" onmouseout="out('8411565151832508655');" style="">  59      private final String routingNum =  System.getenv(&quot;LOCAL_ROUTING_NUM&quot;);                                        </span>
<span class="-6551832665109601256" onmouseenter="enter('-6551832665109601256');" onmouseout="out('-6551832665109601256');" style="">  60      private final String balancesUri = String.format(&quot;http://%s/get_balance&quot;,                                     </span>
<span class="-1420395203196747354" onmouseenter="enter('-1420395203196747354');" onmouseout="out('-1420395203196747354');" style="">  61          System.getenv(&quot;BALANCES_API_ADDR&quot;));                                                                      </span>
<span class="4358404513907099662" onmouseenter="enter('4358404513907099662');" onmouseout="out('4358404513907099662');" style="">  62      private final JWTVerifier verifier;                                                                           </span>
<span  style="">  63                                                                                                                    </span>
<span class="8064586665074901273" onmouseenter="enter('8064586665074901273');" onmouseout="out('8064586665074901273');" style="">  64      public LedgerWriterController() throws IOException,                                                           </span>
<span class="1894253170606682489" onmouseenter="enter('1894253170606682489');" onmouseout="out('1894253170606682489');" style="">  65                                             NoSuchAlgorithmException,                                              </span>
<span class="1072467281893302576" onmouseenter="enter('1072467281893302576');" onmouseout="out('1072467281893302576');" style="">  66                                             InvalidKeySpecException {                                              </span>
<span class="-1999315777049585600" onmouseenter="enter('-1999315777049585600');" onmouseout="out('-1999315777049585600');" style="">  67          // load public key from file                                                                              </span>
<span class="3809711205239471476" onmouseenter="enter('3809711205239471476');" onmouseout="out('3809711205239471476');" style="">  68          String fPath = System.getenv(&quot;PUB_KEY_PATH&quot;);                                                             </span>
<span class="5673882543335836624" onmouseenter="enter('5673882543335836624');" onmouseout="out('5673882543335836624');" style="">  69          String pubKeyStr  = new String(Files.readAllBytes(Paths.get(fPath)));                                     </span>
<span class="7209009376448743897" onmouseenter="enter('7209009376448743897');" onmouseout="out('7209009376448743897');" style="">  70          pubKeyStr = pubKeyStr.replaceFirst(&quot;-----BEGIN PUBLIC KEY-----&quot;, &quot;&quot;);                                     </span>
<span class="4927348229997813303" onmouseenter="enter('4927348229997813303');" onmouseout="out('4927348229997813303');" style="">  71          pubKeyStr = pubKeyStr.replaceFirst(&quot;-----END PUBLIC KEY-----&quot;, &quot;&quot;);                                       </span>
<span class="-828263452525302924" onmouseenter="enter('-828263452525302924');" onmouseout="out('-828263452525302924');" style="">  72          pubKeyStr = pubKeyStr.replaceAll(&quot;\\s&quot;, &quot;&quot;);                                                              </span>
<span class="-3743771444177503093" onmouseenter="enter('-3743771444177503093');" onmouseout="out('-3743771444177503093');" style="">  73          byte[] pubKeyBytes = Base64.getDecoder().decode(pubKeyStr);                                               </span>
<span class="438744628498497549" onmouseenter="enter('438744628498497549');" onmouseout="out('438744628498497549');" style="">  74          KeyFactory kf = KeyFactory.getInstance(&quot;RSA&quot;);                                                            </span>
<span class="4154530442155105022" onmouseenter="enter('4154530442155105022');" onmouseout="out('4154530442155105022');" style="">  75          X509EncodedKeySpec keySpecX509 = new X509EncodedKeySpec(pubKeyBytes);                                     </span>
<span class="169640045417215895" onmouseenter="enter('169640045417215895');" onmouseout="out('169640045417215895');" style="">  76          RSAPublicKey publicKey = (RSAPublicKey) kf.generatePublic(keySpecX509);                                   </span>
<span class="2306753067902644237" onmouseenter="enter('2306753067902644237');" onmouseout="out('2306753067902644237');" style="">  77          // set up verifier                                                                                        </span>
<span class="-6857500803242936007" onmouseenter="enter('-6857500803242936007');" onmouseout="out('-6857500803242936007');" style="">  78          Algorithm algorithm = Algorithm.RSA256(publicKey, null);                                                  </span>
<span class="3110240470386105373" onmouseenter="enter('3110240470386105373');" onmouseout="out('3110240470386105373');" style="">  79          this.verifier = JWT.require(algorithm).build();                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  80      }                                                                                                             </span>
<span  style="">  81                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  82      /**                                                                                                           </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style="">  83       * Readiness probe endpoint.                                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  84       *                                                                                                            </span>
<span class="-6237848493354397724" onmouseenter="enter('-6237848493354397724');" onmouseout="out('-6237848493354397724');" style="">  85       * @return HTTP Status 200 if server is serving requests.                                                     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  86       */                                                                                                           </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style="">  87      @GetMapping(&quot;/ready&quot;)                                                                                         </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style="">  88      @ResponseStatus(HttpStatus.OK)                                                                                </span>
<span class="-4078042211867737548" onmouseenter="enter('-4078042211867737548');" onmouseout="out('-4078042211867737548');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  89 -    public final String readiness() {                                                                             </span>
<span class="-4385440054719104188" onmouseenter="enter('-4385440054719104188');" onmouseout="out('-4385440054719104188');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +    public String readiness() {                                                                                   </span>
<span class="4704682847571117723" onmouseenter="enter('4704682847571117723');" onmouseout="out('4704682847571117723');" style="">  91          return &quot;ok&quot;;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  92      }                                                                                                             </span>
<span  style="">  93                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  94      /**                                                                                                           </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style="">  95       * Submit a new transaction to the ledger.                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  96       *                                                                                                            </span>
<span class="8344965626844763807" onmouseenter="enter('8344965626844763807');" onmouseout="out('8344965626844763807');" style="">  97       * @param Transaction to be submitted.                                                                        </span>
<span class="5706658156997278370" onmouseenter="enter('5706658156997278370');" onmouseout="out('5706658156997278370');" style="">  98       * @return HTTP Status 200 if transaction was successfully submitted.                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  99       */                                                                                                           </span>
<span class="1119678417808751550" onmouseenter="enter('1119678417808751550');" onmouseout="out('1119678417808751550');" style=""> 100      @PostMapping(value = &quot;/new_transaction&quot;, consumes = &quot;application/json&quot;)                                       </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 101      @ResponseStatus(HttpStatus.OK)                                                                                </span>
<span class="1897907323625472935" onmouseenter="enter('1897907323625472935');" onmouseout="out('1897907323625472935');" style=""> 102      public ResponseEntity&lt;?&gt; addTransaction(                                                                      </span>
<span class="1166903297081280981" onmouseenter="enter('1166903297081280981');" onmouseout="out('1166903297081280981');" style=""> 103              @RequestHeader(&quot;Authorization&quot;) String bearerToken,                                                   </span>
<span class="9022696444049056102" onmouseenter="enter('9022696444049056102');" onmouseout="out('9022696444049056102');" style=""> 104              @RequestBody Transaction transaction) {                                                               </span>
<span class="-3538581758087352701" onmouseenter="enter('-3538581758087352701');" onmouseout="out('-3538581758087352701');" style=""> 105          if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                           </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 106              bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 107          }                                                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 108          try {                                                                                                     </span>
<span class="4753652363839392700" onmouseenter="enter('4753652363839392700');" onmouseout="out('4753652363839392700');" style=""> 109              DecodedJWT jwt = this.verifier.verify(bearerToken);                                                   </span>
<span class="-1766896061973454949" onmouseenter="enter('-1766896061973454949');" onmouseout="out('-1766896061973454949');" style=""> 110              String initiatorAcct = jwt.getClaim(&quot;acct&quot;).asString();                                               </span>
<span class="-6144480017328455138" onmouseenter="enter('-6144480017328455138');" onmouseout="out('-6144480017328455138');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 111 -            // Ensure sender is the one who initiated this transaction, or is external deposit.                   </span>
<span class="5927642596742306408" onmouseenter="enter('5927642596742306408');" onmouseout="out('5927642596742306408');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +            // Ensure sender is the one who initiated this transaction, or it is                                  </span>
<span class="771710869172324231" onmouseenter="enter('771710869172324231');" onmouseout="out('771710869172324231');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +            // an external deposit.                                                                               </span>
<span class="4275752493067967329" onmouseenter="enter('4275752493067967329');" onmouseout="out('4275752493067967329');" style=""> 114              // TODO: Check if external account belongs to initiator of deposit.                                   </span>
<span class="5445848170118178590" onmouseenter="enter('5445848170118178590');" onmouseout="out('5445848170118178590');" style=""> 115              if (!(transaction.getFromAccountNum() == initiatorAcct                                                </span>
<span class="1192798190689011433" onmouseenter="enter('1192798190689011433');" onmouseout="out('1192798190689011433');" style=""> 116                    || transaction.getFromRoutingNum() != this.routingNum)) {                                       </span>
<span class="-4261376410010701471" onmouseenter="enter('-4261376410010701471');" onmouseout="out('-4261376410010701471');" style=""> 117                  return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;,                                               </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 118                                                    HttpStatus.UNAUTHORIZED);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 119              }                                                                                                     </span>
<span class="6454388725290926511" onmouseenter="enter('6454388725290926511');" onmouseout="out('6454388725290926511');" style=""> 120              // Ensure amount is valid value.                                                                      </span>
<span class="-5788448725964879098" onmouseenter="enter('-5788448725964879098');" onmouseout="out('-5788448725964879098');" style=""> 121              if (transaction.getAmount() &lt;= 0) {                                                                   </span>
<span class="-4728575539774215326" onmouseenter="enter('-4728575539774215326');" onmouseout="out('-4728575539774215326');" style=""> 122                  return new ResponseEntity&lt;String&gt;(&quot;invalid amount&quot;,                                               </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 123                                                    HttpStatus.BAD_REQUEST);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 124              }                                                                                                     </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style=""> 125              // Ensure sender balance can cover transaction.                                                       </span>
<span class="3056394101732904906" onmouseenter="enter('3056394101732904906');" onmouseout="out('3056394101732904906');" style=""> 126              if (transaction.getFromRoutingNum() == this.routingNum) {                                             </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 127                  HttpHeaders headers = new HttpHeaders();                                                          </span>
<span class="-3213612526128830704" onmouseenter="enter('-3213612526128830704');" onmouseout="out('-3213612526128830704');" style=""> 128                  headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + bearerToken);                                            </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 129                  HttpEntity entity = new HttpEntity(headers);                                                      </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 130                  RestTemplate restTemplate = new RestTemplate();                                                   </span>
<span class="7970859498210029553" onmouseenter="enter('7970859498210029553');" onmouseout="out('7970859498210029553');" style=""> 131                  ResponseEntity&lt;Balance&gt; response = restTemplate.exchange(                                         </span>
<span class="-1305278880063692183" onmouseenter="enter('-1305278880063692183');" onmouseout="out('-1305278880063692183');" style=""> 132                      balancesUri, HttpMethod.GET, entity, Balance.class);                                          </span>
<span class="6143505688729063401" onmouseenter="enter('6143505688729063401');" onmouseout="out('6143505688729063401');" style=""> 133                  Balance senderBalance = response.getBody();                                                       </span>
<span class="-1303033997480808302" onmouseenter="enter('-1303033997480808302');" onmouseout="out('-1303033997480808302');" style=""> 134                  if (senderBalance.amount &lt; transaction.getAmount()) {                                             </span>
<span class="2206481543410021670" onmouseenter="enter('2206481543410021670');" onmouseout="out('2206481543410021670');" style=""> 135                      return new ResponseEntity&lt;String&gt;(&quot;insufficient balance&quot;,                                     </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 136                                                        HttpStatus.BAD_REQUEST);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 138              }                                                                                                     </span>
<span class="-2401114101205973109" onmouseenter="enter('-2401114101205973109');" onmouseout="out('-2401114101205973109');" style=""> 139              // Transaction looks valid. Add to ledger.                                                            </span>
<span class="3084400465291579829" onmouseenter="enter('3084400465291579829');" onmouseout="out('3084400465291579829');" style=""> 140              System.out.println(&quot;adding transaction: &quot; + transaction);                                             </span>
<span class="8546065069214242193" onmouseenter="enter('8546065069214242193');" onmouseout="out('8546065069214242193');" style=""> 141              submitTransaction(transaction);                                                                       </span>
<span  style=""> 142                                                                                                                    </span>
<span class="6989215251843914644" onmouseenter="enter('6989215251843914644');" onmouseout="out('6989215251843914644');" style=""> 143              return new ResponseEntity&lt;String&gt;(&quot;ok&quot;, HttpStatus.CREATED);                                          </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 144          } catch (JWTVerificationException e) {                                                                    </span>
<span class="-4261376410010701471" onmouseenter="enter('-4261376410010701471');" onmouseout="out('-4261376410010701471');" style=""> 145              return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;,                                                   </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 146                                                HttpStatus.UNAUTHORIZED);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 148      }                                                                                                             </span>
<span  style=""> 149                                                                                                                    </span>
<span class="-3784076083713608956" onmouseenter="enter('-3784076083713608956');" onmouseout="out('-3784076083713608956');" style=""> 150      private void submitTransaction(Transaction transaction) {                                                     </span>
<span class="-3468620722690629670" onmouseenter="enter('-3468620722690629670');" onmouseout="out('-3468620722690629670');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 151 -        StatefulRedisConnection redisConnection = ctx.getBean(StatefulRedisConnection.class);                     </span>
<span class="-7733771365331750517" onmouseenter="enter('-7733771365331750517');" onmouseout="out('-7733771365331750517');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 152 -        // Use String key/values so Redis data can be read by non-Java implementations.                           </span>
<span class="7498617311447895258" onmouseenter="enter('7498617311447895258');" onmouseout="out('7498617311447895258');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +        StatefulRedisConnection redisConnection =                                                                 </span>
<span class="6349065357163951214" onmouseenter="enter('6349065357163951214');" onmouseout="out('6349065357163951214');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +                ctx.getBean(StatefulRedisConnection.class);                                                       </span>
<span class="-4980751317840439774" onmouseenter="enter('-4980751317840439774');" onmouseout="out('-4980751317840439774');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +        // Use String key/values so Redis data can be read by non-Java clients.                                   </span>

<span class="-807595089805637563" onmouseenter="enter('-807595089805637563');" onmouseout="out('-807595089805637563');" style=""> 156          redisConnection.async().xadd(ledgerStreamKey,                                                             </span>
<span class="4851644939618052278" onmouseenter="enter('4851644939618052278');" onmouseout="out('4851644939618052278');" style=""> 157                  &quot;fromAccountNum&quot;, transaction.getFromAccountNum(),                                                </span>
<span class="-1809265815745185609" onmouseenter="enter('-1809265815745185609');" onmouseout="out('-1809265815745185609');" style=""> 158                  &quot;fromRoutingNum&quot;, transaction.getFromRoutingNum(),                                                </span>
<span class="-6307168237707817579" onmouseenter="enter('-6307168237707817579');" onmouseout="out('-6307168237707817579');" style=""> 159                  &quot;toAccountNum&quot;, transaction.getToAccountNum(),                                                    </span>
<span class="3482307882589444663" onmouseenter="enter('3482307882589444663');" onmouseout="out('3482307882589444663');" style=""> 160                  &quot;toRoutingNum&quot;, transaction.getToRoutingNum(),                                                    </span>
<span class="2057275500851535823" onmouseenter="enter('2057275500851535823');" onmouseout="out('2057275500851535823');" style=""> 161                  &quot;amount&quot;, transaction.getAmount().toString(),                                                     </span>
<span class="718728881539759967" onmouseenter="enter('718728881539759967');" onmouseout="out('718728881539759967');" style=""> 162                  &quot;timestamp&quot;, Double.toString(transaction.getTimestamp()));                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 163      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="8011746770707306235" onmouseenter="enter('8011746770707306235');" onmouseout="out('8011746770707306235');" style="">   2   * Copyright 2020, Google LLC.                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   3   *                                                                                                                </span>
<span class="-7144700690364548245" onmouseenter="enter('-7144700690364548245');" onmouseout="out('-7144700690364548245');" style="">   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);                                                </span>
<span class="-6614298523444173250" onmouseenter="enter('-6614298523444173250');" onmouseout="out('-6614298523444173250');" style="">   5   * you may not use this file except in compliance with the License.                                               </span>
<span class="-4753901504248728101" onmouseenter="enter('-4753901504248728101');" onmouseout="out('-4753901504248728101');" style="">   6   * You may obtain a copy of the License at                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   7   *                                                                                                                </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">   8   *     http://www.apache.org/licenses/LICENSE-2.0                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  10   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  13   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  14   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  15   */                                                                                                               </span>
<span  style="">  16                                                                                                                    </span>
<span class="-1031727034891410218" onmouseenter="enter('-1031727034891410218');" onmouseout="out('-1031727034891410218');" style="">  17  package anthos.samples.financedemo.ledgerwriter;                                                                  </span>
<span  style="">  18                                                                                                                    </span>
<span class="3416473218750047572" onmouseenter="enter('3416473218750047572');" onmouseout="out('3416473218750047572');" style="">  19  import io.lettuce.core.api.StatefulRedisConnection;                                                               </span>
<span class="1015650858128177541" onmouseenter="enter('1015650858128177541');" onmouseout="out('1015650858128177541');" style="">  20  import org.springframework.context.ApplicationContext;                                                            </span>
<span class="2623752691140612054" onmouseenter="enter('2623752691140612054');" onmouseout="out('2623752691140612054');" style="">  21  import org.springframework.context.annotation.AnnotationConfigApplicationContext;                                 </span>
<span class="-6100913791676640620" onmouseenter="enter('-6100913791676640620');" onmouseout="out('-6100913791676640620');" style="">  22  import org.springframework.http.HttpStatus;                                                                       </span>
<span class="-4152290558559497176" onmouseenter="enter('-4152290558559497176');" onmouseout="out('-4152290558559497176');" style="">  23  import org.springframework.web.bind.annotation.GetMapping;                                                        </span>
<span class="4051535263177665628" onmouseenter="enter('4051535263177665628');" onmouseout="out('4051535263177665628');" style="">  24  import org.springframework.web.bind.annotation.PostMapping;                                                       </span>
<span class="-7037114424511181002" onmouseenter="enter('-7037114424511181002');" onmouseout="out('-7037114424511181002');" style="">  25  import org.springframework.web.bind.annotation.RestController;                                                    </span>
<span class="-5091358343566339359" onmouseenter="enter('-5091358343566339359');" onmouseout="out('-5091358343566339359');" style="">  26  import org.springframework.web.bind.annotation.RequestBody;                                                       </span>
<span class="7012630364184468857" onmouseenter="enter('7012630364184468857');" onmouseout="out('7012630364184468857');" style="">  27  import org.springframework.web.bind.annotation.RequestHeader;                                                     </span>
<span class="-583363652389169341" onmouseenter="enter('-583363652389169341');" onmouseout="out('-583363652389169341');" style="">  28  import org.springframework.web.bind.annotation.ResponseStatus;                                                    </span>
<span class="-4731930330216408095" onmouseenter="enter('-4731930330216408095');" onmouseout="out('-4731930330216408095');" style="">  29  import org.springframework.http.ResponseEntity;                                                                   </span>
<span class="-2270477891067927787" onmouseenter="enter('-2270477891067927787');" onmouseout="out('-2270477891067927787');" style="">  30  import org.springframework.web.client.RestTemplate;                                                               </span>
<span class="-2017038789555914398" onmouseenter="enter('-2017038789555914398');" onmouseout="out('-2017038789555914398');" style="">  31  import org.springframework.http.HttpHeaders;                                                                      </span>
<span class="-2449065930046514282" onmouseenter="enter('-2449065930046514282');" onmouseout="out('-2449065930046514282');" style="">  32  import org.springframework.http.HttpEntity;                                                                       </span>
<span class="7461978282736946494" onmouseenter="enter('7461978282736946494');" onmouseout="out('7461978282736946494');" style="">  33  import org.springframework.http.HttpMethod;                                                                       </span>
<span  style="">  34                                                                                                                    </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  35  import java.io.IOException;                                                                                       </span>
<span class="-5249557667130751282" onmouseenter="enter('-5249557667130751282');" onmouseout="out('-5249557667130751282');" style="">  36  import java.nio.file.Files;                                                                                       </span>
<span class="7071256358513765675" onmouseenter="enter('7071256358513765675');" onmouseout="out('7071256358513765675');" style="">  37  import java.nio.file.Paths;                                                                                       </span>
<span class="-8013228574741439948" onmouseenter="enter('-8013228574741439948');" onmouseout="out('-8013228574741439948');" style="">  38  import java.security.KeyFactory;                                                                                  </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  39  import java.security.NoSuchAlgorithmException;                                                                    </span>
<span class="-61053565471358753" onmouseenter="enter('-61053565471358753');" onmouseout="out('-61053565471358753');" style="">  40  import java.security.interfaces.RSAPublicKey;                                                                     </span>
<span class="3289746377953945547" onmouseenter="enter('3289746377953945547');" onmouseout="out('3289746377953945547');" style="">  41  import java.security.spec.InvalidKeySpecException;                                                                </span>
<span class="7906465591428389933" onmouseenter="enter('7906465591428389933');" onmouseout="out('7906465591428389933');" style="">  42  import java.security.spec.X509EncodedKeySpec;                                                                     </span>
<span class="-6935710760624141930" onmouseenter="enter('-6935710760624141930');" onmouseout="out('-6935710760624141930');" style="">  43  import java.util.Base64;                                                                                          </span>
<span  style="">  44                                                                                                                    </span>
<span class="-6655146115708071580" onmouseenter="enter('-6655146115708071580');" onmouseout="out('-6655146115708071580');" style="">  45  import com.auth0.jwt.algorithms.Algorithm;                                                                        </span>
<span class="5156920743651519035" onmouseenter="enter('5156920743651519035');" onmouseout="out('5156920743651519035');" style="">  46  import com.auth0.jwt.interfaces.DecodedJWT;                                                                       </span>
<span class="-7211641848955402551" onmouseenter="enter('-7211641848955402551');" onmouseout="out('-7211641848955402551');" style="">  47  import com.auth0.jwt.exceptions.JWTVerificationException;                                                         </span>
<span class="2931637313601470038" onmouseenter="enter('2931637313601470038');" onmouseout="out('2931637313601470038');" style="">  48  import com.auth0.jwt.JWT;                                                                                         </span>
<span class="494822993659260728" onmouseenter="enter('494822993659260728');" onmouseout="out('494822993659260728');" style="">  49  import com.auth0.jwt.JWTVerifier;                                                                                 </span>
<span  style="">  50                                                                                                                    </span>
<span class="6355076151554545937" onmouseenter="enter('6355076151554545937');" onmouseout="out('6355076151554545937');" style="">  51  @RestController                                                                                                   </span>
<span class="5933445460753317183" onmouseenter="enter('5933445460753317183');" onmouseout="out('5933445460753317183');" style="">  52  public final class LedgerWriterController {                                                                       </span>
<span  style="">  53                                                                                                                    </span>
<span class="4228229669487578025" onmouseenter="enter('4228229669487578025');" onmouseout="out('4228229669487578025');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  54 -    ApplicationContext ctx = new AnnotationConfigApplicationContext(LedgerWriterConfig.class);                    </span>
<span class="2454959921614149006" onmouseenter="enter('2454959921614149006');" onmouseout="out('2454959921614149006');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +    ApplicationContext ctx = new AnnotationConfigApplicationContext(                                              </span>
<span class="6329527144215806426" onmouseenter="enter('6329527144215806426');" onmouseout="out('6329527144215806426');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +        LedgerWriterConfig.class);                                                                                </span>
<span  style="">  57                                                                                                                    </span>
<span class="-5604269207838210422" onmouseenter="enter('-5604269207838210422');" onmouseout="out('-5604269207838210422');" style="">  58      private final String ledgerStreamKey = System.getenv(&quot;LEDGER_STREAM&quot;);                                        </span>
<span class="8411565151832508655" onmouseenter="enter('8411565151832508655');" onmouseout="out('8411565151832508655');" style="">  59      private final String routingNum =  System.getenv(&quot;LOCAL_ROUTING_NUM&quot;);                                        </span>
<span class="-6551832665109601256" onmouseenter="enter('-6551832665109601256');" onmouseout="out('-6551832665109601256');" style="">  60      private final String balancesUri = String.format(&quot;http://%s/get_balance&quot;,                                     </span>
<span class="-1420395203196747354" onmouseenter="enter('-1420395203196747354');" onmouseout="out('-1420395203196747354');" style="">  61          System.getenv(&quot;BALANCES_API_ADDR&quot;));                                                                      </span>
<span class="4358404513907099662" onmouseenter="enter('4358404513907099662');" onmouseout="out('4358404513907099662');" style="">  62      private final JWTVerifier verifier;                                                                           </span>
<span  style="">  63                                                                                                                    </span>
<span class="8064586665074901273" onmouseenter="enter('8064586665074901273');" onmouseout="out('8064586665074901273');" style="">  64      public LedgerWriterController() throws IOException,                                                           </span>
<span class="1894253170606682489" onmouseenter="enter('1894253170606682489');" onmouseout="out('1894253170606682489');" style="">  65                                             NoSuchAlgorithmException,                                              </span>
<span class="1072467281893302576" onmouseenter="enter('1072467281893302576');" onmouseout="out('1072467281893302576');" style="">  66                                             InvalidKeySpecException {                                              </span>
<span class="-1999315777049585600" onmouseenter="enter('-1999315777049585600');" onmouseout="out('-1999315777049585600');" style="">  67          // load public key from file                                                                              </span>
<span class="3809711205239471476" onmouseenter="enter('3809711205239471476');" onmouseout="out('3809711205239471476');" style="">  68          String fPath = System.getenv(&quot;PUB_KEY_PATH&quot;);                                                             </span>
<span class="5673882543335836624" onmouseenter="enter('5673882543335836624');" onmouseout="out('5673882543335836624');" style="">  69          String pubKeyStr  = new String(Files.readAllBytes(Paths.get(fPath)));                                     </span>
<span class="7209009376448743897" onmouseenter="enter('7209009376448743897');" onmouseout="out('7209009376448743897');" style="">  70          pubKeyStr = pubKeyStr.replaceFirst(&quot;-----BEGIN PUBLIC KEY-----&quot;, &quot;&quot;);                                     </span>
<span class="4927348229997813303" onmouseenter="enter('4927348229997813303');" onmouseout="out('4927348229997813303');" style="">  71          pubKeyStr = pubKeyStr.replaceFirst(&quot;-----END PUBLIC KEY-----&quot;, &quot;&quot;);                                       </span>
<span class="-828263452525302924" onmouseenter="enter('-828263452525302924');" onmouseout="out('-828263452525302924');" style="">  72          pubKeyStr = pubKeyStr.replaceAll(&quot;\\s&quot;, &quot;&quot;);                                                              </span>
<span class="-3743771444177503093" onmouseenter="enter('-3743771444177503093');" onmouseout="out('-3743771444177503093');" style="">  73          byte[] pubKeyBytes = Base64.getDecoder().decode(pubKeyStr);                                               </span>
<span class="438744628498497549" onmouseenter="enter('438744628498497549');" onmouseout="out('438744628498497549');" style="">  74          KeyFactory kf = KeyFactory.getInstance(&quot;RSA&quot;);                                                            </span>
<span class="4154530442155105022" onmouseenter="enter('4154530442155105022');" onmouseout="out('4154530442155105022');" style="">  75          X509EncodedKeySpec keySpecX509 = new X509EncodedKeySpec(pubKeyBytes);                                     </span>
<span class="169640045417215895" onmouseenter="enter('169640045417215895');" onmouseout="out('169640045417215895');" style="">  76          RSAPublicKey publicKey = (RSAPublicKey) kf.generatePublic(keySpecX509);                                   </span>
<span class="2306753067902644237" onmouseenter="enter('2306753067902644237');" onmouseout="out('2306753067902644237');" style="">  77          // set up verifier                                                                                        </span>
<span class="-6857500803242936007" onmouseenter="enter('-6857500803242936007');" onmouseout="out('-6857500803242936007');" style="">  78          Algorithm algorithm = Algorithm.RSA256(publicKey, null);                                                  </span>
<span class="3110240470386105373" onmouseenter="enter('3110240470386105373');" onmouseout="out('3110240470386105373');" style="">  79          this.verifier = JWT.require(algorithm).build();                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  80      }                                                                                                             </span>
<span  style="">  81                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  82      /**                                                                                                           </span>
<span class="-3900287586435222134" onmouseenter="enter('-3900287586435222134');" onmouseout="out('-3900287586435222134');" style="">  83       * Readiness probe endpoint.                                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  84       *                                                                                                            </span>
<span class="-6237848493354397724" onmouseenter="enter('-6237848493354397724');" onmouseout="out('-6237848493354397724');" style="">  85       * @return HTTP Status 200 if server is serving requests.                                                     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  86       */                                                                                                           </span>
<span class="-7757302847206504814" onmouseenter="enter('-7757302847206504814');" onmouseout="out('-7757302847206504814');" style="">  87      @GetMapping(&quot;/ready&quot;)                                                                                         </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style="">  88      @ResponseStatus(HttpStatus.OK)                                                                                </span>
<span class="-4078042211867737548" onmouseenter="enter('-4078042211867737548');" onmouseout="out('-4078042211867737548');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  89 -    public final String readiness() {                                                                             </span>
<span class="-4385440054719104188" onmouseenter="enter('-4385440054719104188');" onmouseout="out('-4385440054719104188');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +    public String readiness() {                                                                                   </span>
<span class="4704682847571117723" onmouseenter="enter('4704682847571117723');" onmouseout="out('4704682847571117723');" style="">  91          return &quot;ok&quot;;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  92      }                                                                                                             </span>
<span  style="">  93                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  94      /**                                                                                                           </span>
<span class="3242866774072620153" onmouseenter="enter('3242866774072620153');" onmouseout="out('3242866774072620153');" style="">  95       * Submit a new transaction to the ledger.                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  96       *                                                                                                            </span>
<span class="8344965626844763807" onmouseenter="enter('8344965626844763807');" onmouseout="out('8344965626844763807');" style="">  97       * @param Transaction to be submitted.                                                                        </span>
<span class="5706658156997278370" onmouseenter="enter('5706658156997278370');" onmouseout="out('5706658156997278370');" style="">  98       * @return HTTP Status 200 if transaction was successfully submitted.                                         </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  99       */                                                                                                           </span>
<span class="1119678417808751550" onmouseenter="enter('1119678417808751550');" onmouseout="out('1119678417808751550');" style=""> 100      @PostMapping(value = &quot;/new_transaction&quot;, consumes = &quot;application/json&quot;)                                       </span>
<span class="7447046953845578255" onmouseenter="enter('7447046953845578255');" onmouseout="out('7447046953845578255');" style=""> 101      @ResponseStatus(HttpStatus.OK)                                                                                </span>
<span class="1897907323625472935" onmouseenter="enter('1897907323625472935');" onmouseout="out('1897907323625472935');" style=""> 102      public ResponseEntity&lt;?&gt; addTransaction(                                                                      </span>
<span class="1166903297081280981" onmouseenter="enter('1166903297081280981');" onmouseout="out('1166903297081280981');" style=""> 103              @RequestHeader(&quot;Authorization&quot;) String bearerToken,                                                   </span>
<span class="9022696444049056102" onmouseenter="enter('9022696444049056102');" onmouseout="out('9022696444049056102');" style=""> 104              @RequestBody Transaction transaction) {                                                               </span>
<span class="-3538581758087352701" onmouseenter="enter('-3538581758087352701');" onmouseout="out('-3538581758087352701');" style=""> 105          if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {                                           </span>
<span class="-7115210276566291681" onmouseenter="enter('-7115210276566291681');" onmouseout="out('-7115210276566291681');" style=""> 106              bearerToken = bearerToken.split(&quot;Bearer &quot;)[1];                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 107          }                                                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 108          try {                                                                                                     </span>
<span class="4753652363839392700" onmouseenter="enter('4753652363839392700');" onmouseout="out('4753652363839392700');" style=""> 109              DecodedJWT jwt = this.verifier.verify(bearerToken);                                                   </span>
<span class="-1766896061973454949" onmouseenter="enter('-1766896061973454949');" onmouseout="out('-1766896061973454949');" style=""> 110              String initiatorAcct = jwt.getClaim(&quot;acct&quot;).asString();                                               </span>
<span class="-6144480017328455138" onmouseenter="enter('-6144480017328455138');" onmouseout="out('-6144480017328455138');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 111 -            // Ensure sender is the one who initiated this transaction, or is external deposit.                   </span>
<span class="2239362758347684288" onmouseenter="enter('2239362758347684288');" onmouseout="out('2239362758347684288');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +            // Ensure sender is the one who initiated this transaction,                                           </span>
<span class="6727348862300723435" onmouseenter="enter('6727348862300723435');" onmouseout="out('6727348862300723435');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +            // or is external deposit.                                                                            </span>
<span class="4275752493067967329" onmouseenter="enter('4275752493067967329');" onmouseout="out('4275752493067967329');" style=""> 114              // TODO: Check if external account belongs to initiator of deposit.                                   </span>
<span class="5445848170118178590" onmouseenter="enter('5445848170118178590');" onmouseout="out('5445848170118178590');" style=""> 115              if (!(transaction.getFromAccountNum() == initiatorAcct                                                </span>
<span class="1192798190689011433" onmouseenter="enter('1192798190689011433');" onmouseout="out('1192798190689011433');" style=""> 116                    || transaction.getFromRoutingNum() != this.routingNum)) {                                       </span>
<span class="-4261376410010701471" onmouseenter="enter('-4261376410010701471');" onmouseout="out('-4261376410010701471');" style=""> 117                  return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;,                                               </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 118                                                    HttpStatus.UNAUTHORIZED);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 119              }                                                                                                     </span>
<span class="6454388725290926511" onmouseenter="enter('6454388725290926511');" onmouseout="out('6454388725290926511');" style=""> 120              // Ensure amount is valid value.                                                                      </span>
<span class="-5788448725964879098" onmouseenter="enter('-5788448725964879098');" onmouseout="out('-5788448725964879098');" style=""> 121              if (transaction.getAmount() &lt;= 0) {                                                                   </span>
<span class="-4728575539774215326" onmouseenter="enter('-4728575539774215326');" onmouseout="out('-4728575539774215326');" style=""> 122                  return new ResponseEntity&lt;String&gt;(&quot;invalid amount&quot;,                                               </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 123                                                    HttpStatus.BAD_REQUEST);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 124              }                                                                                                     </span>
<span class="-1762835934379555281" onmouseenter="enter('-1762835934379555281');" onmouseout="out('-1762835934379555281');" style=""> 125              // Ensure sender balance can cover transaction.                                                       </span>
<span class="3056394101732904906" onmouseenter="enter('3056394101732904906');" onmouseout="out('3056394101732904906');" style=""> 126              if (transaction.getFromRoutingNum() == this.routingNum) {                                             </span>
<span class="-1187465989316714928" onmouseenter="enter('-1187465989316714928');" onmouseout="out('-1187465989316714928');" style=""> 127                  HttpHeaders headers = new HttpHeaders();                                                          </span>
<span class="-3213612526128830704" onmouseenter="enter('-3213612526128830704');" onmouseout="out('-3213612526128830704');" style=""> 128                  headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + bearerToken);                                            </span>
<span class="-1899310457862616867" onmouseenter="enter('-1899310457862616867');" onmouseout="out('-1899310457862616867');" style=""> 129                  HttpEntity entity = new HttpEntity(headers);                                                      </span>
<span class="3202802947297119524" onmouseenter="enter('3202802947297119524');" onmouseout="out('3202802947297119524');" style=""> 130                  RestTemplate restTemplate = new RestTemplate();                                                   </span>
<span class="7970859498210029553" onmouseenter="enter('7970859498210029553');" onmouseout="out('7970859498210029553');" style=""> 131                  ResponseEntity&lt;Balance&gt; response = restTemplate.exchange(                                         </span>
<span class="-1305278880063692183" onmouseenter="enter('-1305278880063692183');" onmouseout="out('-1305278880063692183');" style=""> 132                      balancesUri, HttpMethod.GET, entity, Balance.class);                                          </span>
<span class="6143505688729063401" onmouseenter="enter('6143505688729063401');" onmouseout="out('6143505688729063401');" style=""> 133                  Balance senderBalance = response.getBody();                                                       </span>
<span class="-1303033997480808302" onmouseenter="enter('-1303033997480808302');" onmouseout="out('-1303033997480808302');" style=""> 134                  if (senderBalance.amount &lt; transaction.getAmount()) {                                             </span>
<span class="2206481543410021670" onmouseenter="enter('2206481543410021670');" onmouseout="out('2206481543410021670');" style=""> 135                      return new ResponseEntity&lt;String&gt;(&quot;insufficient balance&quot;,                                     </span>
<span class="-4870417752025294804" onmouseenter="enter('-4870417752025294804');" onmouseout="out('-4870417752025294804');" style=""> 136                                                        HttpStatus.BAD_REQUEST);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 138              }                                                                                                     </span>
<span class="-2401114101205973109" onmouseenter="enter('-2401114101205973109');" onmouseout="out('-2401114101205973109');" style=""> 139              // Transaction looks valid. Add to ledger.                                                            </span>
<span class="3084400465291579829" onmouseenter="enter('3084400465291579829');" onmouseout="out('3084400465291579829');" style=""> 140              System.out.println(&quot;adding transaction: &quot; + transaction);                                             </span>
<span class="8546065069214242193" onmouseenter="enter('8546065069214242193');" onmouseout="out('8546065069214242193');" style=""> 141              submitTransaction(transaction);                                                                       </span>
<span  style=""> 142                                                                                                                    </span>
<span class="6989215251843914644" onmouseenter="enter('6989215251843914644');" onmouseout="out('6989215251843914644');" style=""> 143              return new ResponseEntity&lt;String&gt;(&quot;ok&quot;, HttpStatus.CREATED);                                          </span>
<span class="5687577372953802395" onmouseenter="enter('5687577372953802395');" onmouseout="out('5687577372953802395');" style=""> 144          } catch (JWTVerificationException e) {                                                                    </span>
<span class="-4261376410010701471" onmouseenter="enter('-4261376410010701471');" onmouseout="out('-4261376410010701471');" style=""> 145              return new ResponseEntity&lt;String&gt;(&quot;not authorized&quot;,                                                   </span>
<span class="-3711769128880294107" onmouseenter="enter('-3711769128880294107');" onmouseout="out('-3711769128880294107');" style=""> 146                                                HttpStatus.UNAUTHORIZED);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 148      }                                                                                                             </span>
<span  style=""> 149                                                                                                                    </span>
<span class="-3784076083713608956" onmouseenter="enter('-3784076083713608956');" onmouseout="out('-3784076083713608956');" style=""> 150      private void submitTransaction(Transaction transaction) {                                                     </span>
<span class="-3468620722690629670" onmouseenter="enter('-3468620722690629670');" onmouseout="out('-3468620722690629670');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 151 -        StatefulRedisConnection redisConnection = ctx.getBean(StatefulRedisConnection.class);                     </span>
<span class="-7733771365331750517" onmouseenter="enter('-7733771365331750517');" onmouseout="out('-7733771365331750517');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 152 -        // Use String key/values so Redis data can be read by non-Java implementations.                           </span>
<span class="-3647082945561347388" onmouseenter="enter('-3647082945561347388');" onmouseout="out('-3647082945561347388');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +        StatefulRedisConnection redisConnection = ctx.getBean(                                                    </span>
<span class="8036177050952344872" onmouseenter="enter('8036177050952344872');" onmouseout="out('8036177050952344872');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +                StatefulRedisConnection.class);                                                                   </span>
<span class="-4538787334432814928" onmouseenter="enter('-4538787334432814928');" onmouseout="out('-4538787334432814928');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +        // Use String key/values so Redis data can be read by                                                     </span>
<span class="8719640950027445310" onmouseenter="enter('8719640950027445310');" onmouseout="out('8719640950027445310');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +        // non-Java implementations.                                                                              </span>
<span class="-807595089805637563" onmouseenter="enter('-807595089805637563');" onmouseout="out('-807595089805637563');" style=""> 157          redisConnection.async().xadd(ledgerStreamKey,                                                             </span>
<span class="4851644939618052278" onmouseenter="enter('4851644939618052278');" onmouseout="out('4851644939618052278');" style=""> 158                  &quot;fromAccountNum&quot;, transaction.getFromAccountNum(),                                                </span>
<span class="-1809265815745185609" onmouseenter="enter('-1809265815745185609');" onmouseout="out('-1809265815745185609');" style=""> 159                  &quot;fromRoutingNum&quot;, transaction.getFromRoutingNum(),                                                </span>
<span class="-6307168237707817579" onmouseenter="enter('-6307168237707817579');" onmouseout="out('-6307168237707817579');" style=""> 160                  &quot;toAccountNum&quot;, transaction.getToAccountNum(),                                                    </span>
<span class="3482307882589444663" onmouseenter="enter('3482307882589444663');" onmouseout="out('3482307882589444663');" style=""> 161                  &quot;toRoutingNum&quot;, transaction.getToRoutingNum(),                                                    </span>
<span class="2057275500851535823" onmouseenter="enter('2057275500851535823');" onmouseout="out('2057275500851535823');" style=""> 162                  &quot;amount&quot;, transaction.getAmount().toString(),                                                     </span>
<span class="718728881539759967" onmouseenter="enter('718728881539759967');" onmouseout="out('718728881539759967');" style=""> 163                  &quot;timestamp&quot;, Double.toString(transaction.getTimestamp()));                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 165  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            