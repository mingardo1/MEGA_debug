<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>208</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    208
                    <a href="207.html">prev</a>
                    <a href="209.html">next</a>
                    <a href="208_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_47fec386683d4f12911413ae693bacd60e1538d7_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/dao/CategoryDaoImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;47fec386683d4f12911413ae693bacd60e1538d7:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/dao/CategoryDaoImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;47fec386683d4f12911413ae693bacd60e1538d7^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/dao/CategoryDaoImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;47fec386683d4f12911413ae693bacd60e1538d7^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/dao/CategoryDaoImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;a996923be2b09711d11d2a5df4df667dc9a00b19:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/catalog/dao/CategoryDaoImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.catalog.dao;
  19 
  20 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  21 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  22 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  23 import org.broadleafcommerce.common.persistence.Status;
  24 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  25 import org.broadleafcommerce.common.time.SystemTime;
  26 import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  27 import org.broadleafcommerce.core.catalog.domain.Category;
  28 import org.broadleafcommerce.core.catalog.domain.CategoryImpl;
  29 import org.broadleafcommerce.core.catalog.domain.Product;
  30 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  31 import org.broadleafcommerce.core.catalog.domain.ProductImpl;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  32 import org.hibernate.jpa.QueryHints;</span>
  33 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.broadleafcommerce.core.catalog.domain.ProductImpl;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.hibernate.ejb.QueryHints;</span>
  36 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import org.hibernate.ejb.QueryHints;</span>
  38 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  39 import org.springframework.stereotype.Repository;
  40 
  41 import java.util.Date;
  42 import java.util.List;
  43 
  44 import javax.annotation.Nonnull;
  45 import javax.annotation.Resource;
  46 import javax.persistence.EntityManager;
  47 import javax.persistence.NoResultException;
  48 import javax.persistence.PersistenceContext;
  49 import javax.persistence.Query;
  50 import javax.persistence.TypedQuery;
  51 import javax.persistence.criteria.CriteriaBuilder;
  52 import javax.persistence.criteria.CriteriaQuery;
  53 
  54 /**
  55  * 
  56  * @author Jeff Fischer
  57  */
  58 @Repository(&quot;blCategoryDao&quot;)
  59 public class CategoryDaoImpl implements CategoryDao {
  60 
  61     protected Long currentDateResolution = 10000L;
  62     protected Date cachedDate = SystemTime.asDate();
  63 
  64     protected Date getCurrentDateAfterFactoringInDateResolution() {
<abbr title="  65         Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolution());">  65         Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolutðŸ”µ</abbr>
  66         if (returnDate != cachedDate) {
  67             if (SystemTime.shouldCacheDate()) {
  68                 cachedDate = returnDate;
  69             }
  70         }
  71         return returnDate;
  72     }
  73 
  74     @PersistenceContext(unitName=&quot;blPU&quot;)
  75     protected EntityManager em;
  76 
  77     @Resource(name=&quot;blEntityConfiguration&quot;)
  78     protected EntityConfiguration entityConfiguration;
  79 
  80     @Resource(name = &quot;blSandBoxHelper&quot;)
  81     protected SandBoxHelper sandBoxHelper;
  82 
  83     @Resource(name = &quot;blCategoryDaoExtensionManager&quot;)
  84     protected CategoryDaoExtensionManager extensionManager;
  85 
  86     @Override
  87     public Category save(Category category) {
  88         return em.merge(category);
  89     }
  90 
  91     @Override
  92     public Category readCategoryById(Long categoryId) {
  93         return em.find(CategoryImpl.class, categoryId);
  94     }
  95 
  96     @Override
  97     public List&lt;Category&gt; readCategoriesByIds(List&lt;Long&gt; categoryIds) {
  98         TypedQuery&lt;Category&gt; query = em.createQuery(
  99                 &quot;select category from org.broadleafcommerce.core.catalog.domain.Category category &quot;
 100                         + &quot;where category.id in :ids&quot;,
 101                 Category.class);
 102         query.setParameter(&quot;ids&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class,
 103                 categoryIds.toArray(new Long[categoryIds.size()])));
 104         query.setHint(QueryHints.HINT_CACHEABLE, true);
 105         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 106 
 107         return query.getResultList();
 108     }
 109 
 110     @Override
 111     public Category readCategoryByExternalId(@Nonnull String externalId) {
 112         TypedQuery&lt;Category&gt; query = new TypedQueryBuilder&lt;Category&gt;(Category.class, &quot;cat&quot;)
 113                 .addRestriction(&quot;cat.externalId&quot;, &quot;=&quot;, externalId)
 114                 .toQuery(em);
 115 
 116         try {
 117             return query.getSingleResult();
 118         } catch (NoResultException e) {
 119             return null;
 120         }
 121     }
 122 
 123     @Override
 124     @Deprecated
 125     public Category readCategoryByName(String categoryName) {
 126         Query query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;);
 127         query.setParameter(&quot;categoryName&quot;, categoryName);
 128         query.setHint(QueryHints.HINT_CACHEABLE, true);
 129         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 130         return (Category) query.getSingleResult();
 131     }
 132 
 133     @Override
 134     public List&lt;Category&gt; readCategoriesByName(String categoryName) {
 135         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;, Category.class);
 136         query.setParameter(&quot;categoryName&quot;, categoryName);
 137         query.setHint(QueryHints.HINT_CACHEABLE, true);
 138         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 139         return query.getResultList();
 140     }
 141 
 142     @Override
 143     public List&lt;Category&gt; readCategoriesByName(String categoryName, int limit, int offset) {
 144         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;, Category.class);
 145         query.setParameter(&quot;categoryName&quot;, categoryName);
 146         query.setHint(QueryHints.HINT_CACHEABLE, true);
 147         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 148         query.setFirstResult(offset);
 149         query.setMaxResults(limit);
 150 
 151         return query.getResultList();
 152     }
 153 
 154     @Nonnull
 155     @Override
 156     public List&lt;Category&gt; readCategoriesByNames(List&lt;String&gt; names) {
 157         TypedQuery&lt;Category&gt; query = em.createQuery(
 158                 &quot;select category from org.broadleafcommerce.core.catalog.domain.Category category &quot;
 159                         + &quot;where category.name in :names&quot;,
 160                 Category.class);
 161         query.setParameter(&quot;names&quot;, names);
 162         query.setHint(QueryHints.HINT_CACHEABLE, true);
 163         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 164 
 165         return query.getResultList();
 166     }
 167 
 168     @Override
 169     public List&lt;Category&gt; readAllCategories() {
 170         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_CATEGORIES&quot;, Category.class);
 171         query.setHint(QueryHints.HINT_CACHEABLE, true);
 172         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 173         return query.getResultList();
 174     }
 175 
 176     @Override
 177     public List&lt;Category&gt; readAllCategories(int limit, int offset) {
 178         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_CATEGORIES&quot;, Category.class);
 179         query.setFirstResult(offset);
 180         query.setMaxResults(limit);
 181         query.setHint(QueryHints.HINT_CACHEABLE, true);
 182         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 183 
 184         return query.getResultList();
 185     }
 186 
 187     @Override
 188     public Long readTotalCategoryCount() {
 189         CriteriaBuilder builder = em.getCriteriaBuilder();
 190         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 191         criteria.select(builder.count(criteria.from(CategoryImpl.class)));
 192 
 193         TypedQuery&lt;Long&gt; query = em.createQuery(criteria);
 194         query.setHint(QueryHints.HINT_CACHEABLE, true);
 195         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 196         return query.getSingleResult();
 197     }
 198 
 199     @Override
 200     public List&lt;Product&gt; readAllProducts() {
 201         TypedQuery&lt;Product&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_PRODUCTS&quot;, Product.class);
 202         //don&#x27;t cache - could take up too much memory
 203         return query.getResultList();
 204     }
 205 
 206     @Override
 207     public List&lt;Product&gt; readAllProducts(int limit, int offset) {
 208         TypedQuery&lt;Product&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_PRODUCTS&quot;, Product.class);
 209         //don&#x27;t cache - could take up too much memory
 210         query.setFirstResult(offset);
 211         query.setMaxResults(limit);
 212 
 213         return query.getResultList();
 214     }
 215 
 216     @Override
 217     public List&lt;Category&gt; readAllSubCategories(Category category) {
 218         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_SUBCATEGORIES&quot;, Category.class);
<abbr title=" 219         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));"> 219         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.gðŸ”µ</abbr>
 220         query.setHint(QueryHints.HINT_CACHEABLE, true);
 221         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 222 
 223         return query.getResultList();
 224     }
 225 
 226     @Override
 227     public List&lt;Category&gt; readAllSubCategories(Category category, int limit, int offset) {
 228         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_SUBCATEGORIES&quot;, Category.class);
<abbr title=" 229         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));"> 229         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.gðŸ”µ</abbr>
 230         query.setHint(QueryHints.HINT_CACHEABLE, true);
 231         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 232         query.setFirstResult(offset);
 233         query.setMaxResults(limit);
 234 
 235         return query.getResultList();
 236     }
 237 
 238     @Override
 239     public List&lt;Category&gt; readActiveSubCategoriesByCategory(Category category) {
<abbr title=" 240         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.class);"> 240         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, CateðŸ”µ</abbr>
<abbr title=" 241         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));"> 241         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.gðŸ”µ</abbr>
 242         query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 243         query.setHint(QueryHints.HINT_CACHEABLE, true);
 244         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 245 
 246         return query.getResultList();
 247     }
 248 
 249     @Override
 250     public List&lt;Category&gt; readActiveSubCategoriesByCategory(Category category, int limit, int offset) {
<abbr title=" 251         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.class);"> 251         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, CateðŸ”µ</abbr>
<abbr title=" 252         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));"> 252         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.gðŸ”µ</abbr>
 253         query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 254         query.setHint(QueryHints.HINT_CACHEABLE, true);
 255         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 256         query.setFirstResult(offset);
 257         query.setMaxResults(limit);
 258 
 259         return query.getResultList();
 260     }
 261 
 262     @Override
 263     public Long getCurrentDateResolution() {
 264         return currentDateResolution;
 265     }
 266 
 267     @Override
 268     public void setCurrentDateResolution(Long currentDateResolution) {
 269         this.currentDateResolution = currentDateResolution;
 270     }
 271 
 272     @Override
 273     public void delete(Category category) {
 274         ((Status) category).setArchived(&#x27;Y&#x27;);
 275         em.merge(category);
 276     }
 277 
 278     @Override
 279     public Category create() {
 280         return (Category) entityConfiguration.createEntityInstance(Category.class.getName());
 281     }
 282 
 283     @Override
 284     public Category findCategoryByURI(String uri) {
 285         if (extensionManager != null) {
 286             ExtensionResultHolder holder = new ExtensionResultHolder();
<abbr title=" 287             ExtensionResultStatusType result = extensionManager.getProxy().findCategoryByURI(uri, holder);"> 287             ExtensionResultStatusType result = extensionManager.getProxy().findCategoryByURI(uri, holder)ðŸ”µ</abbr>
 288             if (ExtensionResultStatusType.HANDLED.equals(result)) {
 289                 return (Category) holder.getResult();
 290             }
 291         }
 292         Query query;
 293         query = em.createNamedQuery(&quot;BC_READ_CATEGORY_OUTGOING_URL&quot;);
 294         query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 295         query.setParameter(&quot;url&quot;, uri);
 296         query.setHint(QueryHints.HINT_CACHEABLE, true);
 297         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 298 
 299         @SuppressWarnings(&quot;unchecked&quot;)
 300         List&lt;Category&gt; results = query.getResultList();
 301         if (results != null &amp;&amp; !results.isEmpty()) {
 302             return results.get(0);
 303 
 304         } else {
 305             return null;
 306         }
 307     }
 308 
 309     @Override
 310     public Long readCountAllActiveProductsByCategory(Category category) {
<abbr title=" 311         TypedQuery&lt;Long&gt; query = em.createNamedQuery(&quot;BC_READ_COUNT_ALL_ACTIVE_PRODUCTS_BY_CATEGORY&quot;, Long.class);"> 311         TypedQuery&lt;Long&gt; query = em.createNamedQuery(&quot;BC_READ_COUNT_ALL_ACTIVE_PRODUCTS_BY_CATEGORY&quot;, LonðŸ”µ</abbr>
 312         query.setParameter(&quot;categoryId&quot;, category.getId());
 313         query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 314         query.setHint(QueryHints.HINT_CACHEABLE, true);
 315         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 316 
 317         return query.getSingleResult();
 318     }
 319 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.catalog.dao;
  19 
  20 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  21 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  22 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  23 import org.broadleafcommerce.common.persistence.Status;
  24 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  25 import org.broadleafcommerce.common.time.SystemTime;
  26 import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  27 import org.broadleafcommerce.core.catalog.domain.Category;
  28 import org.broadleafcommerce.core.catalog.domain.CategoryImpl;
  29 import org.broadleafcommerce.core.catalog.domain.Product;
  30 import org.hibernate.jpa.QueryHints;
  31 import org.springframework.stereotype.Repository;
  32 
  33 import java.util.Date;
  34 import java.util.List;
  35 
  36 import javax.annotation.Nonnull;
  37 import javax.annotation.Resource;
  38 import javax.persistence.EntityManager;
  39 import javax.persistence.NoResultException;
  40 import javax.persistence.PersistenceContext;
  41 import javax.persistence.Query;
  42 import javax.persistence.TypedQuery;
  43 import javax.persistence.criteria.CriteriaBuilder;
  44 import javax.persistence.criteria.CriteriaQuery;
  45 
  46 /**
  47  *
  48  * @author Jeff Fischer
  49  */
  50 @Repository(&quot;blCategoryDao&quot;)
  51 public class CategoryDaoImpl implements CategoryDao {
  52 
  53     protected Long currentDateResolution = 10000L;
  54     protected Date cachedDate = SystemTime.asDate();
  55 
  56     protected Date getCurrentDateAfterFactoringInDateResolution() {
<abbr title="  57         Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolution());">  57         Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolutðŸ”µ</abbr>
  58         if (returnDate != cachedDate) {
  59             if (SystemTime.shouldCacheDate()) {
  60                 cachedDate = returnDate;
  61             }
  62         }
  63         return returnDate;
  64     }
  65 
  66     @PersistenceContext(unitName=&quot;blPU&quot;)
  67     protected EntityManager em;
  68 
  69     @Resource(name=&quot;blEntityConfiguration&quot;)
  70     protected EntityConfiguration entityConfiguration;
  71 
  72     @Resource(name = &quot;blSandBoxHelper&quot;)
  73     protected SandBoxHelper sandBoxHelper;
  74 
  75     @Resource(name = &quot;blCategoryDaoExtensionManager&quot;)
  76     protected CategoryDaoExtensionManager extensionManager;
  77 
  78     @Override
  79     public Category save(Category category) {
  80         return em.merge(category);
  81     }
  82 
  83     @Override
  84     public Category readCategoryById(Long categoryId) {
  85         return em.find(CategoryImpl.class, categoryId);
  86     }
  87 
  88     @Override
  89     public List&lt;Category&gt; readCategoriesByIds(List&lt;Long&gt; categoryIds) {
  90         TypedQuery&lt;Category&gt; query = em.createQuery(
  91                 &quot;select category from org.broadleafcommerce.core.catalog.domain.Category category &quot;
  92                         + &quot;where category.id in :ids&quot;,
  93                 Category.class);
  94         query.setParameter(&quot;ids&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class,
  95                 categoryIds.toArray(new Long[categoryIds.size()])));
  96         query.setHint(QueryHints.HINT_CACHEABLE, true);
  97         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
  98 
  99         return query.getResultList();
 100     }
 101 
 102     @Override
 103     public Category readCategoryByExternalId(@Nonnull String externalId) {
 104         TypedQuery&lt;Category&gt; query = new TypedQueryBuilder&lt;Category&gt;(Category.class, &quot;cat&quot;)
 105                 .addRestriction(&quot;cat.externalId&quot;, &quot;=&quot;, externalId)
 106                 .toQuery(em);
 107 
 108         try {
 109             return query.getSingleResult();
 110         } catch (NoResultException e) {
 111             return null;
 112         }
 113     }
 114 
 115     @Override
 116     @Deprecated
 117     public Category readCategoryByName(String categoryName) {
 118         Query query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;);
 119         query.setParameter(&quot;categoryName&quot;, categoryName);
 120         query.setHint(QueryHints.HINT_CACHEABLE, true);
 121         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 122         return (Category) query.getSingleResult();
 123     }
 124 
 125     @Override
 126     public List&lt;Category&gt; readCategoriesByName(String categoryName) {
 127         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;, Category.class);
 128         query.setParameter(&quot;categoryName&quot;, categoryName);
 129         query.setHint(QueryHints.HINT_CACHEABLE, true);
 130         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 131         return query.getResultList();
 132     }
 133 
 134     @Override
 135     public List&lt;Category&gt; readCategoriesByName(String categoryName, int limit, int offset) {
 136         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;, Category.class);
 137         query.setParameter(&quot;categoryName&quot;, categoryName);
 138         query.setHint(QueryHints.HINT_CACHEABLE, true);
 139         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 140         query.setFirstResult(offset);
 141         query.setMaxResults(limit);
 142 
 143         return query.getResultList();
 144     }
 145 
 146     @Nonnull
 147     @Override
 148     public List&lt;Category&gt; readCategoriesByNames(List&lt;String&gt; names) {
 149         TypedQuery&lt;Category&gt; query = em.createQuery(
 150                 &quot;select category from org.broadleafcommerce.core.catalog.domain.Category category &quot;
 151                         + &quot;where category.name in :names&quot;,
 152                 Category.class);
 153         query.setParameter(&quot;names&quot;, names);
 154         query.setHint(QueryHints.HINT_CACHEABLE, true);
 155         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 156 
 157         return query.getResultList();
 158     }
 159 
 160     @Override
 161     public List&lt;Category&gt; readAllCategories() {
 162         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_CATEGORIES&quot;, Category.class);
 163         query.setHint(QueryHints.HINT_CACHEABLE, true);
 164         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 165         return query.getResultList();
 166     }
 167 
 168     @Override
 169     public List&lt;Category&gt; readAllCategories(int limit, int offset) {
 170         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_CATEGORIES&quot;, Category.class);
 171         query.setFirstResult(offset);
 172         query.setMaxResults(limit);
 173         query.setHint(QueryHints.HINT_CACHEABLE, true);
 174         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 175 
 176         return query.getResultList();
 177     }
 178 
 179     @Override
 180     public Long readTotalCategoryCount() {
 181         CriteriaBuilder builder = em.getCriteriaBuilder();
 182         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 183         criteria.select(builder.count(criteria.from(CategoryImpl.class)));
 184 
 185         TypedQuery&lt;Long&gt; query = em.createQuery(criteria);
 186         query.setHint(QueryHints.HINT_CACHEABLE, true);
 187         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 188         return query.getSingleResult();
 189     }
 190 
 191     @Override
 192     public List&lt;Product&gt; readAllProducts() {
 193         TypedQuery&lt;Product&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_PRODUCTS&quot;, Product.class);
 194         //don&#x27;t cache - could take up too much memory
 195         return query.getResultList();
 196     }
 197 
 198     @Override
 199     public List&lt;Product&gt; readAllProducts(int limit, int offset) {
 200         TypedQuery&lt;Product&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_PRODUCTS&quot;, Product.class);
 201         //don&#x27;t cache - could take up too much memory
 202         query.setFirstResult(offset);
 203         query.setMaxResults(limit);
 204 
 205         return query.getResultList();
 206     }
 207 
 208     @Override
 209     public List&lt;Category&gt; readAllSubCategories(Category category) {
 210         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_SUBCATEGORIES&quot;, Category.class);
<abbr title=" 211         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));"> 211         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.gðŸ”µ</abbr>
 212         query.setHint(QueryHints.HINT_CACHEABLE, true);
 213         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 214 
 215         return query.getResultList();
 216     }
 217 
 218     @Override
 219     public List&lt;Category&gt; readAllSubCategories(Category category, int limit, int offset) {
 220         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_SUBCATEGORIES&quot;, Category.class);
<abbr title=" 221         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));"> 221         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.gðŸ”µ</abbr>
 222         query.setHint(QueryHints.HINT_CACHEABLE, true);
 223         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 224         query.setFirstResult(offset);
 225         query.setMaxResults(limit);
 226 
 227         return query.getResultList();
 228     }
 229 
 230     @Override
 231     public List&lt;Category&gt; readActiveSubCategoriesByCategory(Category category) {
<abbr title=" 232         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.class);"> 232         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, CateðŸ”µ</abbr>
<abbr title=" 233         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));"> 233         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.gðŸ”µ</abbr>
 234         query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 235         query.setHint(QueryHints.HINT_CACHEABLE, true);
 236         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 237 
 238         return query.getResultList();
 239     }
 240 
 241     @Override
 242     public List&lt;Category&gt; readActiveSubCategoriesByCategory(Category category, int limit, int offset) {
<abbr title=" 243         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.class);"> 243         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, CateðŸ”µ</abbr>
<abbr title=" 244         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));"> 244         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.gðŸ”µ</abbr>
 245         query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 246         query.setHint(QueryHints.HINT_CACHEABLE, true);
 247         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 248         query.setFirstResult(offset);
 249         query.setMaxResults(limit);
 250 
 251         return query.getResultList();
 252     }
 253 
 254     @Override
 255     public Long getCurrentDateResolution() {
 256         return currentDateResolution;
 257     }
 258 
 259     @Override
 260     public void setCurrentDateResolution(Long currentDateResolution) {
 261         this.currentDateResolution = currentDateResolution;
 262     }
 263 
 264     @Override
 265     public void delete(Category category) {
 266         ((Status) category).setArchived(&#x27;Y&#x27;);
 267         em.merge(category);
 268     }
 269 
 270     @Override
 271     public Category create() {
 272         return (Category) entityConfiguration.createEntityInstance(Category.class.getName());
 273     }
 274 
 275     @Override
 276     public Category findCategoryByURI(String uri) {
 277         if (extensionManager != null) {
 278             ExtensionResultHolder holder = new ExtensionResultHolder();
<abbr title=" 279             ExtensionResultStatusType result = extensionManager.getProxy().findCategoryByURI(uri, holder);"> 279             ExtensionResultStatusType result = extensionManager.getProxy().findCategoryByURI(uri, holder)ðŸ”µ</abbr>
 280             if (ExtensionResultStatusType.HANDLED.equals(result)) {
 281                 return (Category) holder.getResult();
 282             }
 283         }
 284         Query query;
 285         query = em.createNamedQuery(&quot;BC_READ_CATEGORY_OUTGOING_URL&quot;);
 286         query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 287         query.setParameter(&quot;url&quot;, uri);
 288         query.setHint(QueryHints.HINT_CACHEABLE, true);
 289         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 290 
 291         @SuppressWarnings(&quot;unchecked&quot;)
 292         List&lt;Category&gt; results = query.getResultList();
 293         if (results != null &amp;&amp; !results.isEmpty()) {
 294             return results.get(0);
 295 
 296         } else {
 297             return null;
 298         }
 299     }
 300 
 301     @Override
 302     public Long readCountAllActiveProductsByCategory(Category category) {
<abbr title=" 303         TypedQuery&lt;Long&gt; query = em.createNamedQuery(&quot;BC_READ_COUNT_ALL_ACTIVE_PRODUCTS_BY_CATEGORY&quot;, Long.class);"> 303         TypedQuery&lt;Long&gt; query = em.createNamedQuery(&quot;BC_READ_COUNT_ALL_ACTIVE_PRODUCTS_BY_CATEGORY&quot;, LonðŸ”µ</abbr>
 304         query.setParameter(&quot;categoryId&quot;, category.getId());
 305         query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 306         query.setHint(QueryHints.HINT_CACHEABLE, true);
 307         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 308 
 309         return query.getSingleResult();
 310     }
 311 }
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.catalog.dao;
  19 
  20 import java.util.Date;
  21 import java.util.List;
  22 import javax.annotation.Nonnull;
  23 import javax.annotation.Resource;
  24 import javax.persistence.EntityManager;
  25 import javax.persistence.NoResultException;
  26 import javax.persistence.PersistenceContext;
  27 import javax.persistence.Query;
  28 import javax.persistence.TypedQuery;
  29 import javax.persistence.criteria.CriteriaBuilder;
  30 import javax.persistence.criteria.CriteriaQuery;
  31 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  32 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  33 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  34 import org.broadleafcommerce.common.persistence.Status;
  35 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  36 import org.broadleafcommerce.common.time.SystemTime;
  37 import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  38 import org.broadleafcommerce.core.catalog.domain.Category;
  39 import org.broadleafcommerce.core.catalog.domain.CategoryImpl;
  40 import org.broadleafcommerce.core.catalog.domain.Product;
  41 import org.hibernate.jpa.QueryHints;
  42 import org.springframework.stereotype.Repository;
  43 
  44 
  45 /**
  46  *
  47  * @author Jeff Fischer
  48  */
  49 @Repository(&quot;blCategoryDao&quot;)
  50 public class CategoryDaoImpl implements CategoryDao {
  51     protected Long currentDateResolution = 10000L;
  52 
  53     protected Date cachedDate = SystemTime.asDate();
  54 
  55     protected Date getCurrentDateAfterFactoringInDateResolution() {
<abbr title="  56         Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolution());">  56         Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolutðŸ”µ</abbr>
  57         if (returnDate != cachedDate) {
  58             if (SystemTime.shouldCacheDate()) {
  59                 cachedDate = returnDate;
  60             }
  61         }
  62         return returnDate;
  63     }
  64 
  65     @PersistenceContext(unitName=&quot;blPU&quot;)
  66     protected EntityManager em;
  67 
  68     @Resource(name=&quot;blEntityConfiguration&quot;)
  69     protected EntityConfiguration entityConfiguration;
  70 
  71     @Resource(name = &quot;blSandBoxHelper&quot;)
  72     protected SandBoxHelper sandBoxHelper;
  73 
  74     @Resource(name = &quot;blCategoryDaoExtensionManager&quot;)
  75     protected CategoryDaoExtensionManager extensionManager;
  76 
  77     @Override
  78     public Category save(Category category) {
  79         return em.merge(category);
  80     }
  81 
  82     @Override
  83     public Category readCategoryById(Long categoryId) {
  84         return em.find(CategoryImpl.class, categoryId);
  85     }
  86 
  87     @Override
  88     public List&lt;Category&gt; readCategoriesByIds(List&lt;Long&gt; categoryIds) {
  89         TypedQuery&lt;Category&gt; query = em.createQuery(
  90                 &quot;select category from org.broadleafcommerce.core.catalog.domain.Category category &quot;
  91                         + &quot;where category.id in :ids&quot;,
  92                 Category.class);
  93         query.setParameter(&quot;ids&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class,
  94                 categoryIds.toArray(new Long[categoryIds.size()])));
  95         query.setHint(QueryHints.HINT_CACHEABLE, true);
  96         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
  97 
  98         return query.getResultList();
  99     }
 100 
 101     @Override
 102     public Category readCategoryByExternalId(@Nonnull String externalId) {
 103         TypedQuery&lt;Category&gt; query = new TypedQueryBuilder&lt;Category&gt;(Category.class, &quot;cat&quot;)
 104                 .addRestriction(&quot;cat.externalId&quot;, &quot;=&quot;, externalId)
 105                 .toQuery(em);
 106 
 107         try {
 108             return query.getSingleResult();
 109         } catch (NoResultException e) {
 110             return null;
 111         }
 112     }
 113 
 114     @Override
 115     @Deprecated
 116     public Category readCategoryByName(String categoryName) {
 117         Query query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;);
 118         query.setParameter(&quot;categoryName&quot;, categoryName);
 119         query.setHint(QueryHints.HINT_CACHEABLE, true);
 120         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 121         return (Category) query.getSingleResult();
 122     }
 123 
 124     @Override
 125     public List&lt;Category&gt; readCategoriesByName(String categoryName) {
 126         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;, Category.class);
 127         query.setParameter(&quot;categoryName&quot;, categoryName);
 128         query.setHint(QueryHints.HINT_CACHEABLE, true);
 129         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 130         return query.getResultList();
 131     }
 132 
 133     @Override
 134     public List&lt;Category&gt; readCategoriesByName(String categoryName, int limit, int offset) {
 135         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;, Category.class);
 136         query.setParameter(&quot;categoryName&quot;, categoryName);
 137         query.setHint(QueryHints.HINT_CACHEABLE, true);
 138         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 139         query.setFirstResult(offset);
 140         query.setMaxResults(limit);
 141 
 142         return query.getResultList();
 143     }
 144 
 145     @Nonnull
 146     @Override
 147     public List&lt;Category&gt; readCategoriesByNames(List&lt;String&gt; names) {
 148         TypedQuery&lt;Category&gt; query = em.createQuery(
 149                 &quot;select category from org.broadleafcommerce.core.catalog.domain.Category category &quot;
 150                         + &quot;where category.name in :names&quot;,
 151                 Category.class);
 152         query.setParameter(&quot;names&quot;, names);
 153         query.setHint(QueryHints.HINT_CACHEABLE, true);
 154         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 155 
 156         return query.getResultList();
 157     }
 158 
 159     @Override
 160     public List&lt;Category&gt; readAllCategories() {
 161         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_CATEGORIES&quot;, Category.class);
 162         query.setHint(QueryHints.HINT_CACHEABLE, true);
 163         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 164         return query.getResultList();
 165     }
 166 
 167     @Override
 168     public List&lt;Category&gt; readAllCategories(int limit, int offset) {
 169         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_CATEGORIES&quot;, Category.class);
 170         query.setFirstResult(offset);
 171         query.setMaxResults(limit);
 172         query.setHint(QueryHints.HINT_CACHEABLE, true);
 173         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 174 
 175         return query.getResultList();
 176     }
 177 
 178     @Override
 179     public Long readTotalCategoryCount() {
 180         CriteriaBuilder builder = em.getCriteriaBuilder();
 181         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 182         criteria.select(builder.count(criteria.from(CategoryImpl.class)));
 183 
 184         TypedQuery&lt;Long&gt; query = em.createQuery(criteria);
 185         query.setHint(QueryHints.HINT_CACHEABLE, true);
 186         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 187         return query.getSingleResult();
 188     }
 189 
 190     @Override
 191     public List&lt;Product&gt; readAllProducts() {
 192         TypedQuery&lt;Product&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_PRODUCTS&quot;, Product.class);
 193         //don&#x27;t cache - could take up too much memory
 194         return query.getResultList();
 195     }
 196 
 197     @Override
 198     public List&lt;Product&gt; readAllProducts(int limit, int offset) {
 199         TypedQuery&lt;Product&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_PRODUCTS&quot;, Product.class);
 200         //don&#x27;t cache - could take up too much memory
 201         query.setFirstResult(offset);
 202         query.setMaxResults(limit);
 203 
 204         return query.getResultList();
 205     }
 206 
 207     @Override
 208     public List&lt;Category&gt; readAllSubCategories(Category category) {
 209         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_SUBCATEGORIES&quot;, Category.class);
<abbr title=" 210         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));"> 210         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.gðŸ”µ</abbr>
 211         query.setHint(QueryHints.HINT_CACHEABLE, true);
 212         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 213 
 214         return query.getResultList();
 215     }
 216 
 217     @Override
 218     public List&lt;Category&gt; readAllSubCategories(Category category, int limit, int offset) {
 219         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_SUBCATEGORIES&quot;, Category.class);
<abbr title=" 220         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));"> 220         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.gðŸ”µ</abbr>
 221         query.setHint(QueryHints.HINT_CACHEABLE, true);
 222         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 223         query.setFirstResult(offset);
 224         query.setMaxResults(limit);
 225 
 226         return query.getResultList();
 227     }
 228 
 229     @Override
 230     public List&lt;Category&gt; readActiveSubCategoriesByCategory(Category category) {
<abbr title=" 231         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.class);"> 231         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, CateðŸ”µ</abbr>
<abbr title=" 232         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));"> 232         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.gðŸ”µ</abbr>
 233         query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 234         query.setHint(QueryHints.HINT_CACHEABLE, true);
 235         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 236 
 237         return query.getResultList();
 238     }
 239 
 240     @Override
 241     public List&lt;Category&gt; readActiveSubCategoriesByCategory(Category category, int limit, int offset) {
<abbr title=" 242         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.class);"> 242         TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, CateðŸ”µ</abbr>
<abbr title=" 243         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));"> 243         query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.gðŸ”µ</abbr>
 244         query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 245         query.setHint(QueryHints.HINT_CACHEABLE, true);
 246         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 247         query.setFirstResult(offset);
 248         query.setMaxResults(limit);
 249 
 250         return query.getResultList();
 251     }
 252 
 253     @Override
 254     public Long getCurrentDateResolution() {
 255         return currentDateResolution;
 256     }
 257 
 258     @Override
 259     public void setCurrentDateResolution(Long currentDateResolution) {
 260         this.currentDateResolution = currentDateResolution;
 261     }
 262 
 263     @Override
 264     public void delete(Category category) {
 265         ((Status) category).setArchived(&#x27;Y&#x27;);
 266         em.merge(category);
 267     }
 268 
 269     @Override
 270     public Category create() {
 271         return (Category) entityConfiguration.createEntityInstance(Category.class.getName());
 272     }
 273 
 274     @Override
 275     public Category findCategoryByURI(String uri) {
 276         if (extensionManager != null) {
 277             ExtensionResultHolder holder = new ExtensionResultHolder();
<abbr title=" 278             ExtensionResultStatusType result = extensionManager.getProxy().findCategoryByURI(uri, holder);"> 278             ExtensionResultStatusType result = extensionManager.getProxy().findCategoryByURI(uri, holder)ðŸ”µ</abbr>
 279             if (ExtensionResultStatusType.HANDLED.equals(result)) {
 280                 return (Category) holder.getResult();
 281             }
 282         }
 283         Query query;
 284         query = em.createNamedQuery(&quot;BC_READ_CATEGORY_OUTGOING_URL&quot;);
 285         query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 286         query.setParameter(&quot;url&quot;, uri);
 287         query.setHint(QueryHints.HINT_CACHEABLE, true);
 288         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 289 
 290         @SuppressWarnings(&quot;unchecked&quot;)
 291         List&lt;Category&gt; results = query.getResultList();
 292         if (results != null &amp;&amp; !results.isEmpty()) {
 293             return results.get(0);
 294 
 295         } else {
 296             return null;
 297         }
 298     }
 299 
 300     @Override
 301     public Long readCountAllActiveProductsByCategory(Category category) {
<abbr title=" 302         TypedQuery&lt;Long&gt; query = em.createNamedQuery(&quot;BC_READ_COUNT_ALL_ACTIVE_PRODUCTS_BY_CATEGORY&quot;, Long.class);"> 302         TypedQuery&lt;Long&gt; query = em.createNamedQuery(&quot;BC_READ_COUNT_ALL_ACTIVE_PRODUCTS_BY_CATEGORY&quot;, LonðŸ”µ</abbr>
 303         query.setParameter(&quot;categoryId&quot;, category.getId());
 304         query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 305         query.setHint(QueryHints.HINT_CACHEABLE, true);
 306         query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 307 
 308         return query.getSingleResult();
 309     }
 310 }
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.catalog.dao;
  19  
  20  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  21  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  22  import org.broadleafcommerce.common.persistence.EntityConfiguration;
  23  import org.broadleafcommerce.common.persistence.Status;
  24  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  25  import org.broadleafcommerce.common.time.SystemTime;
  26  import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  27  import org.broadleafcommerce.core.catalog.domain.Category;
  28  import org.broadleafcommerce.core.catalog.domain.CategoryImpl;
  29  import org.broadleafcommerce.core.catalog.domain.Product;
  30  import org.broadleafcommerce.core.catalog.domain.ProductImpl;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import org.hibernate.ejb.QueryHints;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import org.hibernate.jpa.QueryHints;</span>
  33  import org.springframework.stereotype.Repository;
  34  
  35  import java.util.Date;
  36  import java.util.List;
  37  
  38  import javax.annotation.Nonnull;
  39  import javax.annotation.Resource;
  40  import javax.persistence.EntityManager;
  41  import javax.persistence.NoResultException;
  42  import javax.persistence.PersistenceContext;
  43  import javax.persistence.Query;
  44  import javax.persistence.TypedQuery;
  45  import javax.persistence.criteria.CriteriaBuilder;
  46  import javax.persistence.criteria.CriteriaQuery;
  47  
  48  /**
  49   *
  50   * @author Jeff Fischer
  51   */
  52  @Repository(&quot;blCategoryDao&quot;)
  53  public class CategoryDaoImpl implements CategoryDao {
  54  
  55      protected Long currentDateResolution = 10000L;
  56      protected Date cachedDate = SystemTime.asDate();
  57  
  58      protected Date getCurrentDateAfterFactoringInDateResolution() {
  59          Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolution());
  60          if (returnDate != cachedDate) {
  61              if (SystemTime.shouldCacheDate()) {
  62                  cachedDate = returnDate;
  63              }
  64          }
  65          return returnDate;
  66      }
  67  
  68      @PersistenceContext(unitName=&quot;blPU&quot;)
  69      protected EntityManager em;
  70  
  71      @Resource(name=&quot;blEntityConfiguration&quot;)
  72      protected EntityConfiguration entityConfiguration;
  73  
  74      @Resource(name = &quot;blSandBoxHelper&quot;)
  75      protected SandBoxHelper sandBoxHelper;
  76  
  77      @Resource(name = &quot;blCategoryDaoExtensionManager&quot;)
  78      protected CategoryDaoExtensionManager extensionManager;
  79  
  80      @Override
  81      public Category save(Category category) {
  82          return em.merge(category);
  83      }
  84  
  85      @Override
  86      public Category readCategoryById(Long categoryId) {
  87          return em.find(CategoryImpl.class, categoryId);
  88      }
  89  
  90      @Override
  91      public List&lt;Category&gt; readCategoriesByIds(List&lt;Long&gt; categoryIds) {
  92          TypedQuery&lt;Category&gt; query = em.createQuery(
  93                  &quot;select category from org.broadleafcommerce.core.catalog.domain.Category category &quot;
  94                          + &quot;where category.id in :ids&quot;,
  95                  Category.class);
  96          query.setParameter(&quot;ids&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class,
  97                  categoryIds.toArray(new Long[categoryIds.size()])));
  98          query.setHint(QueryHints.HINT_CACHEABLE, true);
  99          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 100  
 101          return query.getResultList();
 102      }
 103  
 104      @Override
 105      public Category readCategoryByExternalId(@Nonnull String externalId) {
 106          TypedQuery&lt;Category&gt; query = new TypedQueryBuilder&lt;Category&gt;(Category.class, &quot;cat&quot;)
 107                  .addRestriction(&quot;cat.externalId&quot;, &quot;=&quot;, externalId)
 108                  .toQuery(em);
 109  
 110          try {
 111              return query.getSingleResult();
 112          } catch (NoResultException e) {
 113              return null;
 114          }
 115      }
 116  
 117      @Override
 118      @Deprecated
 119      public Category readCategoryByName(String categoryName) {
 120          Query query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;);
 121          query.setParameter(&quot;categoryName&quot;, categoryName);
 122          query.setHint(QueryHints.HINT_CACHEABLE, true);
 123          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 124          return (Category) query.getSingleResult();
 125      }
 126  
 127      @Override
 128      public List&lt;Category&gt; readCategoriesByName(String categoryName) {
 129          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;, Category.class);
 130          query.setParameter(&quot;categoryName&quot;, categoryName);
 131          query.setHint(QueryHints.HINT_CACHEABLE, true);
 132          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 133          return query.getResultList();
 134      }
 135  
 136      @Override
 137      public List&lt;Category&gt; readCategoriesByName(String categoryName, int limit, int offset) {
 138          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;, Category.class);
 139          query.setParameter(&quot;categoryName&quot;, categoryName);
 140          query.setHint(QueryHints.HINT_CACHEABLE, true);
 141          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 142          query.setFirstResult(offset);
 143          query.setMaxResults(limit);
 144  
 145          return query.getResultList();
 146      }
 147  
 148      @Nonnull
 149      @Override
 150      public List&lt;Category&gt; readCategoriesByNames(List&lt;String&gt; names) {
 151          TypedQuery&lt;Category&gt; query = em.createQuery(
 152                  &quot;select category from org.broadleafcommerce.core.catalog.domain.Category category &quot;
 153                          + &quot;where category.name in :names&quot;,
 154                  Category.class);
 155          query.setParameter(&quot;names&quot;, names);
 156          query.setHint(QueryHints.HINT_CACHEABLE, true);
 157          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 158  
 159          return query.getResultList();
 160      }
 161  
 162      @Override
 163      public List&lt;Category&gt; readAllCategories() {
 164          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_CATEGORIES&quot;, Category.class);
 165          query.setHint(QueryHints.HINT_CACHEABLE, true);
 166          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 167          return query.getResultList();
 168      }
 169  
 170      @Override
 171      public List&lt;Category&gt; readAllCategories(int limit, int offset) {
 172          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_CATEGORIES&quot;, Category.class);
 173          query.setFirstResult(offset);
 174          query.setMaxResults(limit);
 175          query.setHint(QueryHints.HINT_CACHEABLE, true);
 176          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 177  
 178          return query.getResultList();
 179      }
 180  
 181      @Override
 182      public Long readTotalCategoryCount() {
 183          CriteriaBuilder builder = em.getCriteriaBuilder();
 184          CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 185          criteria.select(builder.count(criteria.from(CategoryImpl.class)));
 186  
 187          TypedQuery&lt;Long&gt; query = em.createQuery(criteria);
 188          query.setHint(QueryHints.HINT_CACHEABLE, true);
 189          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 190          return query.getSingleResult();
 191      }
 192  
 193      @Override
 194      public List&lt;Product&gt; readAllProducts() {
 195          TypedQuery&lt;Product&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_PRODUCTS&quot;, Product.class);
 196          //don&#x27;t cache - could take up too much memory
 197          return query.getResultList();
 198      }
 199  
 200      @Override
 201      public List&lt;Product&gt; readAllProducts(int limit, int offset) {
 202          TypedQuery&lt;Product&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_PRODUCTS&quot;, Product.class);
 203          //don&#x27;t cache - could take up too much memory
 204          query.setFirstResult(offset);
 205          query.setMaxResults(limit);
 206  
 207          return query.getResultList();
 208      }
 209  
 210      @Override
 211      public List&lt;Category&gt; readAllSubCategories(Category category) {
 212          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_SUBCATEGORIES&quot;, Category.class);
 213          query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));
 214          query.setHint(QueryHints.HINT_CACHEABLE, true);
 215          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 216  
 217          return query.getResultList();
 218      }
 219  
 220      @Override
 221      public List&lt;Category&gt; readAllSubCategories(Category category, int limit, int offset) {
 222          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_SUBCATEGORIES&quot;, Category.class);
 223          query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));
 224          query.setHint(QueryHints.HINT_CACHEABLE, true);
 225          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 226          query.setFirstResult(offset);
 227          query.setMaxResults(limit);
 228  
 229          return query.getResultList();
 230      }
 231  
 232      @Override
 233      public List&lt;Category&gt; readActiveSubCategoriesByCategory(Category category) {
<abbr title=" 234          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.class);"> 234          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.clasðŸ”µ</abbr>
 235          query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));
 236          query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 237          query.setHint(QueryHints.HINT_CACHEABLE, true);
 238          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 239  
 240          return query.getResultList();
 241      }
 242  
 243      @Override
 244      public List&lt;Category&gt; readActiveSubCategoriesByCategory(Category category, int limit, int offset) {
<abbr title=" 245          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.class);"> 245          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.clasðŸ”µ</abbr>
 246          query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));
 247          query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 248          query.setHint(QueryHints.HINT_CACHEABLE, true);
 249          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 250          query.setFirstResult(offset);
 251          query.setMaxResults(limit);
 252  
 253          return query.getResultList();
 254      }
 255  
 256      @Override
 257      public Long getCurrentDateResolution() {
 258          return currentDateResolution;
 259      }
 260  
 261      @Override
 262      public void setCurrentDateResolution(Long currentDateResolution) {
 263          this.currentDateResolution = currentDateResolution;
 264      }
 265  
 266      @Override
 267      public void delete(Category category) {
 268          ((Status) category).setArchived(&#x27;Y&#x27;);
 269          em.merge(category);
 270      }
 271  
 272      @Override
 273      public Category create() {
 274          return (Category) entityConfiguration.createEntityInstance(Category.class.getName());
 275      }
 276  
 277      @Override
 278      public Category findCategoryByURI(String uri) {
 279          if (extensionManager != null) {
 280              ExtensionResultHolder holder = new ExtensionResultHolder();
 281              ExtensionResultStatusType result = extensionManager.getProxy().findCategoryByURI(uri, holder);
 282              if (ExtensionResultStatusType.HANDLED.equals(result)) {
 283                  return (Category) holder.getResult();
 284              }
 285          }
 286          Query query;
 287          query = em.createNamedQuery(&quot;BC_READ_CATEGORY_OUTGOING_URL&quot;);
 288          query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 289          query.setParameter(&quot;url&quot;, uri);
 290          query.setHint(QueryHints.HINT_CACHEABLE, true);
 291          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 292  
 293          @SuppressWarnings(&quot;unchecked&quot;)
 294          List&lt;Category&gt; results = query.getResultList();
 295          if (results != null &amp;&amp; !results.isEmpty()) {
 296              return results.get(0);
 297  
 298          } else {
 299              return null;
 300          }
 301      }
 302  










 303  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.catalog.dao;
  19  
  20  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  21  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  22  import org.broadleafcommerce.common.persistence.EntityConfiguration;
  23  import org.broadleafcommerce.common.persistence.Status;
  24  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  25  import org.broadleafcommerce.common.time.SystemTime;
  26  import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  27  import org.broadleafcommerce.core.catalog.domain.Category;
  28  import org.broadleafcommerce.core.catalog.domain.CategoryImpl;
  29  import org.broadleafcommerce.core.catalog.domain.Product;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.broadleafcommerce.core.catalog.domain.ProductImpl;</span>
  31  import org.hibernate.ejb.QueryHints;

  32  import org.springframework.stereotype.Repository;
  33  
  34  import java.util.Date;
  35  import java.util.List;
  36  
  37  import javax.annotation.Nonnull;
  38  import javax.annotation.Resource;
  39  import javax.persistence.EntityManager;
  40  import javax.persistence.NoResultException;
  41  import javax.persistence.PersistenceContext;
  42  import javax.persistence.Query;
  43  import javax.persistence.TypedQuery;
  44  import javax.persistence.criteria.CriteriaBuilder;
  45  import javax.persistence.criteria.CriteriaQuery;
  46  
  47  /**
  48   *
  49   * @author Jeff Fischer
  50   */
  51  @Repository(&quot;blCategoryDao&quot;)
  52  public class CategoryDaoImpl implements CategoryDao {
  53  
  54      protected Long currentDateResolution = 10000L;
  55      protected Date cachedDate = SystemTime.asDate();
  56  
  57      protected Date getCurrentDateAfterFactoringInDateResolution() {
  58          Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolution());
  59          if (returnDate != cachedDate) {
  60              if (SystemTime.shouldCacheDate()) {
  61                  cachedDate = returnDate;
  62              }
  63          }
  64          return returnDate;
  65      }
  66  
  67      @PersistenceContext(unitName=&quot;blPU&quot;)
  68      protected EntityManager em;
  69  
  70      @Resource(name=&quot;blEntityConfiguration&quot;)
  71      protected EntityConfiguration entityConfiguration;
  72  
  73      @Resource(name = &quot;blSandBoxHelper&quot;)
  74      protected SandBoxHelper sandBoxHelper;
  75  
  76      @Resource(name = &quot;blCategoryDaoExtensionManager&quot;)
  77      protected CategoryDaoExtensionManager extensionManager;
  78  
  79      @Override
  80      public Category save(Category category) {
  81          return em.merge(category);
  82      }
  83  
  84      @Override
  85      public Category readCategoryById(Long categoryId) {
  86          return em.find(CategoryImpl.class, categoryId);
  87      }
  88  
  89      @Override
  90      public List&lt;Category&gt; readCategoriesByIds(List&lt;Long&gt; categoryIds) {
  91          TypedQuery&lt;Category&gt; query = em.createQuery(
  92                  &quot;select category from org.broadleafcommerce.core.catalog.domain.Category category &quot;
  93                          + &quot;where category.id in :ids&quot;,
  94                  Category.class);
  95          query.setParameter(&quot;ids&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class,
  96                  categoryIds.toArray(new Long[categoryIds.size()])));
  97          query.setHint(QueryHints.HINT_CACHEABLE, true);
  98          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
  99  
 100          return query.getResultList();
 101      }
 102  
 103      @Override
 104      public Category readCategoryByExternalId(@Nonnull String externalId) {
 105          TypedQuery&lt;Category&gt; query = new TypedQueryBuilder&lt;Category&gt;(Category.class, &quot;cat&quot;)
 106                  .addRestriction(&quot;cat.externalId&quot;, &quot;=&quot;, externalId)
 107                  .toQuery(em);
 108  
 109          try {
 110              return query.getSingleResult();
 111          } catch (NoResultException e) {
 112              return null;
 113          }
 114      }
 115  
 116      @Override
 117      @Deprecated
 118      public Category readCategoryByName(String categoryName) {
 119          Query query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;);
 120          query.setParameter(&quot;categoryName&quot;, categoryName);
 121          query.setHint(QueryHints.HINT_CACHEABLE, true);
 122          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 123          return (Category) query.getSingleResult();
 124      }
 125  
 126      @Override
 127      public List&lt;Category&gt; readCategoriesByName(String categoryName) {
 128          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;, Category.class);
 129          query.setParameter(&quot;categoryName&quot;, categoryName);
 130          query.setHint(QueryHints.HINT_CACHEABLE, true);
 131          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 132          return query.getResultList();
 133      }
 134  
 135      @Override
 136      public List&lt;Category&gt; readCategoriesByName(String categoryName, int limit, int offset) {
 137          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_CATEGORY_BY_NAME&quot;, Category.class);
 138          query.setParameter(&quot;categoryName&quot;, categoryName);
 139          query.setHint(QueryHints.HINT_CACHEABLE, true);
 140          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 141          query.setFirstResult(offset);
 142          query.setMaxResults(limit);
 143  
 144          return query.getResultList();
 145      }
 146  
 147      @Nonnull
 148      @Override
 149      public List&lt;Category&gt; readCategoriesByNames(List&lt;String&gt; names) {
 150          TypedQuery&lt;Category&gt; query = em.createQuery(
 151                  &quot;select category from org.broadleafcommerce.core.catalog.domain.Category category &quot;
 152                          + &quot;where category.name in :names&quot;,
 153                  Category.class);
 154          query.setParameter(&quot;names&quot;, names);
 155          query.setHint(QueryHints.HINT_CACHEABLE, true);
 156          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 157  
 158          return query.getResultList();
 159      }
 160  
 161      @Override
 162      public List&lt;Category&gt; readAllCategories() {
 163          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_CATEGORIES&quot;, Category.class);
 164          query.setHint(QueryHints.HINT_CACHEABLE, true);
 165          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 166          return query.getResultList();
 167      }
 168  
 169      @Override
 170      public List&lt;Category&gt; readAllCategories(int limit, int offset) {
 171          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_CATEGORIES&quot;, Category.class);
 172          query.setFirstResult(offset);
 173          query.setMaxResults(limit);
 174          query.setHint(QueryHints.HINT_CACHEABLE, true);
 175          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 176  
 177          return query.getResultList();
 178      }
 179  
 180      @Override
 181      public Long readTotalCategoryCount() {
 182          CriteriaBuilder builder = em.getCriteriaBuilder();
 183          CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 184          criteria.select(builder.count(criteria.from(CategoryImpl.class)));
 185  
 186          TypedQuery&lt;Long&gt; query = em.createQuery(criteria);
 187          query.setHint(QueryHints.HINT_CACHEABLE, true);
 188          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 189          return query.getSingleResult();
 190      }
 191  
 192      @Override
 193      public List&lt;Product&gt; readAllProducts() {
 194          TypedQuery&lt;Product&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_PRODUCTS&quot;, Product.class);
 195          //don&#x27;t cache - could take up too much memory
 196          return query.getResultList();
 197      }
 198  
 199      @Override
 200      public List&lt;Product&gt; readAllProducts(int limit, int offset) {
 201          TypedQuery&lt;Product&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_PRODUCTS&quot;, Product.class);
 202          //don&#x27;t cache - could take up too much memory
 203          query.setFirstResult(offset);
 204          query.setMaxResults(limit);
 205  
 206          return query.getResultList();
 207      }
 208  
 209      @Override
 210      public List&lt;Category&gt; readAllSubCategories(Category category) {
 211          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_SUBCATEGORIES&quot;, Category.class);
 212          query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));
 213          query.setHint(QueryHints.HINT_CACHEABLE, true);
 214          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 215  
 216          return query.getResultList();
 217      }
 218  
 219      @Override
 220      public List&lt;Category&gt; readAllSubCategories(Category category, int limit, int offset) {
 221          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ALL_SUBCATEGORIES&quot;, Category.class);
 222          query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));
 223          query.setHint(QueryHints.HINT_CACHEABLE, true);
 224          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 225          query.setFirstResult(offset);
 226          query.setMaxResults(limit);
 227  
 228          return query.getResultList();
 229      }
 230  
 231      @Override
 232      public List&lt;Category&gt; readActiveSubCategoriesByCategory(Category category) {
<abbr title=" 233          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.class);"> 233          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.clasðŸ”µ</abbr>
 234          query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));
 235          query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 236          query.setHint(QueryHints.HINT_CACHEABLE, true);
 237          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 238  
 239          return query.getResultList();
 240      }
 241  
 242      @Override
 243      public List&lt;Category&gt; readActiveSubCategoriesByCategory(Category category, int limit, int offset) {
<abbr title=" 244          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.class);"> 244          TypedQuery&lt;Category&gt; query = em.createNamedQuery(&quot;BC_READ_ACTIVE_SUBCATEGORIES_BY_CATEGORY&quot;, Category.clasðŸ”µ</abbr>
 245          query.setParameter(&quot;parentCategoryId&quot;, sandBoxHelper.mergeCloneIds(CategoryImpl.class, category.getId()));
 246          query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 247          query.setHint(QueryHints.HINT_CACHEABLE, true);
 248          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 249          query.setFirstResult(offset);
 250          query.setMaxResults(limit);
 251  
 252          return query.getResultList();
 253      }
 254  
 255      @Override
 256      public Long getCurrentDateResolution() {
 257          return currentDateResolution;
 258      }
 259  
 260      @Override
 261      public void setCurrentDateResolution(Long currentDateResolution) {
 262          this.currentDateResolution = currentDateResolution;
 263      }
 264  
 265      @Override
 266      public void delete(Category category) {
 267          ((Status) category).setArchived(&#x27;Y&#x27;);
 268          em.merge(category);
 269      }
 270  
 271      @Override
 272      public Category create() {
 273          return (Category) entityConfiguration.createEntityInstance(Category.class.getName());
 274      }
 275  
 276      @Override
 277      public Category findCategoryByURI(String uri) {
 278          if (extensionManager != null) {
 279              ExtensionResultHolder holder = new ExtensionResultHolder();
 280              ExtensionResultStatusType result = extensionManager.getProxy().findCategoryByURI(uri, holder);
 281              if (ExtensionResultStatusType.HANDLED.equals(result)) {
 282                  return (Category) holder.getResult();
 283              }
 284          }
 285          Query query;
 286          query = em.createNamedQuery(&quot;BC_READ_CATEGORY_OUTGOING_URL&quot;);
 287          query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());
 288          query.setParameter(&quot;url&quot;, uri);
 289          query.setHint(QueryHints.HINT_CACHEABLE, true);
 290          query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);
 291  
 292          @SuppressWarnings(&quot;unchecked&quot;)
 293          List&lt;Category&gt; results = query.getResultList();
 294          if (results != null &amp;&amp; !results.isEmpty()) {
 295              return results.get(0);
 296  
 297          } else {
 298              return null;
 299          }
 300      }
 301  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +    public Long readCountAllActiveProductsByCategory(Category category) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +        TypedQuery&lt;Long&gt; query = em.createNamedQuery(&quot;BC_READ_COUNT_ALL_ACTIVE_PRODUCTS_BY_CATEGORY&quot;, Long.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +        query.setParameter(&quot;categoryId&quot;, category.getId());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +        query.setParameter(&quot;currentDate&quot;, getCurrentDateAfterFactoringInDateResolution());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +        query.setHint(QueryHints.HINT_CACHEABLE, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +        query.setHint(QueryHints.HINT_CACHE_REGION, &quot;query.Catalog&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +        return query.getSingleResult();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +    }</span>
 312  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            