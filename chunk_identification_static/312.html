<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>312</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    312
                    <a href="311.html">prev</a>
                    <a href="313.html">next</a>
                    <a href="312_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_5e7616834a9f9c363492a1453124dee15a0c8249_admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/file/service/StaticAssetStorageServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;5e7616834a9f9c363492a1453124dee15a0c8249:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/file/service/StaticAssetStorageServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;5e7616834a9f9c363492a1453124dee15a0c8249^1:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/file/service/StaticAssetStorageServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;5e7616834a9f9c363492a1453124dee15a0c8249^2:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/file/service/StaticAssetStorageServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;52f7d19e4df25237a77fe0e635e773824ee19a7d:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/file/service/StaticAssetStorageServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce CMS Module
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.cms.file.service;
  19 
  20 import org.apache.commons.collections4.MapUtils;
  21 import org.apache.commons.io.FileExistsException;
  22 import org.apache.commons.io.FileUtils;
  23 import org.apache.commons.io.FilenameUtils;
  24 import org.apache.commons.io.IOUtils;
  25 import org.apache.commons.lang.ArrayUtils;
  26 import org.apache.commons.lang3.StringUtils;
  27 import org.apache.commons.logging.Log;
  28 import org.apache.commons.logging.LogFactory;
  29 import org.broadleafcommerce.cms.common.AssetNotFoundException;
  30 import org.broadleafcommerce.cms.field.type.StorageType;
  31 import org.broadleafcommerce.cms.file.dao.StaticAssetStorageDao;
  32 import org.broadleafcommerce.cms.file.domain.StaticAsset;
  33 import org.broadleafcommerce.cms.file.domain.StaticAssetStorage;
  34 import org.broadleafcommerce.cms.file.service.operation.NamedOperationManager;
  35 import org.broadleafcommerce.common.audit.Auditable;
  36 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  37 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  38 import org.broadleafcommerce.common.file.domain.FileWorkArea;
  39 import org.broadleafcommerce.common.file.service.BroadleafFileService;
  40 import org.broadleafcommerce.common.file.service.GloballySharedInputStream;
  41 import org.broadleafcommerce.common.io.ConcurrentFileOutputStream;
  42 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  43 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  44 import org.broadleafcommerce.openadmin.server.service.artifact.ArtifactService;
  45 import org.broadleafcommerce.openadmin.server.service.artifact.image.Operation;
  46 import org.springframework.beans.factory.annotation.Autowired;
  47 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48 import org.springframework.boot.autoconfigure.web.servlet.MultipartProperties;</span>
  49 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import org.springframework.boot.autoconfigure.web.MultipartProperties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import org.springframework.core.env.Environment;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import org.springframework.stereotype.Service;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import org.springframework.transaction.annotation.Transactional;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import org.springframework.web.multipart.MultipartFile;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 import java.io.BufferedInputStream;</span>
  57 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58 import org.springframework.beans.factory.annotation.Value;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59 import org.springframework.boot.autoconfigure.web.MultipartProperties;</span>
  60 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  61 import org.springframework.core.env.Environment;
  62 import org.springframework.stereotype.Service;
  63 import org.springframework.transaction.annotation.Transactional;
  64 import org.springframework.web.multipart.MultipartFile;
  65 
  66 import java.io.BufferedInputStream;
  67 import java.io.File;
  68 import java.io.FileInputStream;
  69 import java.io.FileOutputStream;
  70 import java.io.IOException;
  71 import java.io.InputStream;
  72 import java.io.OutputStream;
  73 import java.math.BigInteger;
  74 import java.security.MessageDigest;
  75 import java.security.NoSuchAlgorithmException;
  76 import java.sql.Blob;
  77 import java.sql.SQLException;
  78 import java.text.SimpleDateFormat;
  79 import java.util.Arrays;
  80 import java.util.HashMap;
  81 import java.util.List;
  82 import java.util.Map;
  83 
  84 import javax.annotation.Resource;
  85 
  86 /**
  87  * @author Jeff Fischer, Brian Polster
  88  */
  89 @Service(&quot;blStaticAssetStorageService&quot;)
  90 public class StaticAssetStorageServiceImpl implements StaticAssetStorageService {
  91 
  92     private static final Log LOG = LogFactory.getLog(StaticAssetStorageServiceImpl.class);
  93 
  94     protected static final String DEFAULT_ADMIN_IMAGE_EXTENSIONS = &quot;bmp,jpg,jpeg,png,img,tiff,gif&quot;;
  95 
  96     public static final long DEFAULT_ASSET_UPLOAD_SIZE = 1024 * 1024 * 10;
  97 
  98     // 8kb default for the buffer for moving files around
  99     protected static final int DEFAULT_BUFFER_SIZE = 8096;
 100 
 101     protected String cacheDirectory;
 102 
 103     @Autowired
 104     protected Environment env;
 105 
 106     @Resource(name=&quot;blStaticAssetService&quot;)
 107     protected StaticAssetService staticAssetService;
 108 
 109     @Resource(name = &quot;blFileService&quot;)
 110     protected BroadleafFileService broadleafFileService;
 111 
 112     @Resource(name=&quot;blArtifactService&quot;)
 113     protected ArtifactService artifactService;
 114 
 115     @Resource(name=&quot;blStaticAssetStorageDao&quot;)
 116     protected StaticAssetStorageDao staticAssetStorageDao;
 117 
 118     @Resource(name=&quot;blNamedOperationManager&quot;)
 119     protected NamedOperationManager namedOperationManager;
 120 
 121     @Resource(name = &quot;blStaticAssetServiceExtensionManager&quot;)
 122     protected StaticAssetServiceExtensionManager extensionManager;
 123 
 124     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 125     protected StreamingTransactionCapableUtil transUtil;
 126 
 127     @Value(&quot;${image.artifact.recompress.formats:png}&quot;)
 128     protected String recompressFormats = &quot;png&quot;;
 129 
 130     @Autowired(required = false)
 131     protected MultipartProperties defaultMultipartSettings;
 132 
 133     @Resource(name = &quot;blConcurrentFileOutputStream&quot;)
 134     protected ConcurrentFileOutputStream concurrentFileOutputStream;
 135 
 136 
 137     protected StaticAsset findStaticAsset(String fullUrl) {
 138         StaticAsset staticAsset = staticAssetService.findStaticAssetByFullUrl(fullUrl);
 139 
 140         return staticAsset;
 141     }
 142 
 143     protected boolean shouldUseSharedFile(InputStream is) {
 144         return (is != null &amp;&amp; is instanceof GloballySharedInputStream);
 145     }
 146 
 147     protected File getFileFromLocalRepository(String cachedFileName) {
<abbr title=" 148         // Look for a shared file (this represents a file that was based on a file originally in the classpath."> 148         // Look for a shared file (this represents a file that was based on a file originally in the clasðŸ”µ</abbr>
 149         File cacheFile = null;
 150         if (extensionManager != null) {
 151             ExtensionResultHolder holder = new ExtensionResultHolder();
<abbr title=" 152             ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holder);"> 152             ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holðŸ”µ</abbr>
 153             if (ExtensionResultStatusType.HANDLED.equals(result)) {
 154                 cacheFile = (File) holder.getResult();
 155             }
 156         }
 157         if (cacheFile == null) {
 158             cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);
 159         }
 160         if (cacheFile.exists()) {
 161             return cacheFile;
 162         } else {
 163             return broadleafFileService.getLocalResource(cachedFileName);
 164         }
 165     }
 166 
 167     protected File lookupAssetAndCreateLocalFile(StaticAsset staticAsset, File baseLocalFile)
 168             throws IOException, SQLException {
 169         if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {
 170             File returnFile = broadleafFileService.getResource(staticAsset.getFullUrl());
 171             if (!returnFile.getAbsolutePath().equals(baseLocalFile.getAbsolutePath())) {
 172                 createLocalFileFromInputStream(new FileInputStream(returnFile), baseLocalFile);
 173             }
 174             return broadleafFileService.getResource(staticAsset.getFullUrl());
 175         } else {
 176             StaticAssetStorage storage = readStaticAssetStorageByStaticAssetId(staticAsset.getId());
 177             if (storage != null) {
 178                 InputStream is = storage.getFileData().getBinaryStream();
 179                 createLocalFileFromInputStream(is, baseLocalFile);
 180             }
 181         }
 182         return baseLocalFile;
 183     }
 184 
<abbr title=" 185     protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOException {"> 185     protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throðŸ”µ</abbr>
 186         InputStream is = broadleafFileService.getClasspathResource(staticAsset.getFullUrl());
 187         createLocalFileFromInputStream(is, baseLocalFile);
 188     }
 189 
<abbr title=" 190     protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException {"> 190     protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException ðŸ”µ</abbr>
 191         try {
 192             if (!baseLocalFile.getParentFile().exists()) {
 193                 boolean directoriesCreated = false;
 194                 if (!baseLocalFile.getParentFile().exists()) {
 195                     directoriesCreated = baseLocalFile.getParentFile().mkdirs();
 196                     if (!directoriesCreated) {
<abbr title=" 197                         // There is a chance that another VM created the directories.   If not, we may not have"> 197                         // There is a chance that another VM created the directories.   If not, we may noðŸ”µ</abbr>
 198                         // proper permissions and this is an error we need to report.
 199                         if (!baseLocalFile.getParentFile().exists()) {
 200                             throw new RuntimeException(&quot;Unable to create middle directories for file: &quot; +
 201                                     baseLocalFile.getAbsolutePath());
 202                         }
 203                     }
 204                 }
 205             }
 206 
 207             concurrentFileOutputStream.write(is, baseLocalFile);
 208 
 209         } finally {
 210             IOUtils.closeQuietly(is);
 211         }
 212     }
 213 
 214     @Override
<abbr title=" 215     public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws Exception {"> 215     public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throwsðŸ”µ</abbr>
 216         StaticAsset staticAsset = findStaticAsset(fullUrl);
 217         if (staticAsset == null) {
 218             throw new AssetNotFoundException(&quot;Unable to find an asset for the url (&quot; + fullUrl + &quot;)&quot;);
 219         }
 220         String mimeType = staticAsset.getMimeType();
 221 
 222         //extract the values for any named parameters
 223         boolean shouldRecompress = shouldRecompress(mimeType);
<abbr title=" 224         Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMap);"> 224         Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMaðŸ”µ</abbr>
 225         if (shouldRecompress &amp;&amp; MapUtils.isEmpty(convertedParameters)) {
 226             convertedParameters.put(&quot;recompress&quot;,&quot;true&quot;);
 227         }
 228         String cachedFileName = constructCacheFileName(staticAsset, convertedParameters);
 229       
 230         if (shouldRecompress) {
 231             convertedParameters.remove(&quot;recompress&quot;);
 232         }
 233 
<abbr title=" 234         // Look for a shared file (this represents a file that was based on a file originally in the classpath."> 234         // Look for a shared file (this represents a file that was based on a file originally in the clasðŸ”µ</abbr>
 235         File cacheFile = getFileFromLocalRepository(cachedFileName);
 236         if (cacheFile.exists()) {
 237             return buildModel(cacheFile.getAbsolutePath(), mimeType);
 238         }
 239 
 240         // Obtain the base file (that we may need to convert based on the parameters
 241         String baseCachedFileName = constructCacheFileName(staticAsset, null);
 242         File baseLocalFile = getFileFromLocalRepository(baseCachedFileName);
 243 
 244         if (! baseLocalFile.exists()) {
 245             if (broadleafFileService.checkForResourceOnClassPath(staticAsset.getFullUrl())) {
 246                 cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);
 247                 baseLocalFile = broadleafFileService.getSharedLocalResource(baseCachedFileName);
 248                 createLocalFileFromClassPathResource(staticAsset, baseLocalFile);
 249             } else {
 250                 baseLocalFile = lookupAssetAndCreateLocalFile(staticAsset, baseLocalFile);
 251             }
 252         }
 253 
 254 
 255         if (!shouldRecompress &amp;&amp; convertedParameters.isEmpty()) {
 256             return buildModel(baseLocalFile.getAbsolutePath(), mimeType);
 257         } 
 258         else {
 259             FileInputStream assetStream = new FileInputStream(baseLocalFile);
 260             BufferedInputStream original = new BufferedInputStream(assetStream);
 261             original.mark(0);
 262 
<abbr title=" 263             Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.getMimeType());"> 263             Operation[] operations = artifactService.buildOperations(convertedParameters, original, statiðŸ”µ</abbr>
<abbr title=" 264             InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeType());"> 264             InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeTypeðŸ”µ</abbr>
 265 
 266             createLocalFileFromInputStream(converted, cacheFile);
 267             if (&quot;image/gif&quot;.equals(mimeType)) {
 268                 mimeType = &quot;image/png&quot;;
 269             }
 270             return buildModel(cacheFile.getAbsolutePath(), mimeType);
 271         }
 272     }
 273 
 274     protected boolean shouldRecompress(String mimeType) {
 275         String[] formats = null;
 276         if (!StringUtils.isEmpty(recompressFormats)) {
 277             formats = recompressFormats.split(&quot;,&quot;);
 278         }
 279         boolean response = false;
 280         if (!ArrayUtils.isEmpty(formats)) {
 281             for (String format : formats) {
 282                 if (mimeType.toLowerCase().contains(format.toLowerCase())) {
 283                     response = true;
 284                     break;
 285                 }
 286             }
 287         }
 288         return response;
 289     }
 290 
 291     protected Map&lt;String, String&gt; buildModel(String returnFilePath, String mimeType) {
 292         Map&lt;String, String&gt; model = new HashMap&lt;String, String&gt;(2);
 293         model.put(&quot;cacheFilePath&quot;, returnFilePath);
 294         model.put(&quot;mimeType&quot;, mimeType);
 295 
 296         return model;
 297     }
 298 
 299     @Override
 300     public StaticAssetStorage findStaticAssetStorageById(final Long id) {
 301         final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 302         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 303             @Override
 304             public void execute() {
 305                 storage[0] = staticAssetStorageDao.readStaticAssetStorageById(id);
 306             }
 307         }, RuntimeException.class);
 308         return storage[0];
 309     }
 310 
 311     @Override
 312     public StaticAssetStorage create() {
 313         return staticAssetStorageDao.create();
 314     }
 315 
 316     @Override
 317     public StaticAssetStorage readStaticAssetStorageByStaticAssetId(final Long id) {
 318         final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 319         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 320             @Override
 321             public void execute() {
 322                 storage[0] = staticAssetStorageDao.readStaticAssetStorageByStaticAssetId(id);
 323             }
 324         }, RuntimeException.class);
 325         return storage[0];
 326     }
 327 
 328     @Override
 329     public StaticAssetStorage save(final StaticAssetStorage assetStorage) {
 330         final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 331         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 332             @Override
 333             public void execute() {
 334                 storage[0] = staticAssetStorageDao.save(assetStorage);
 335             }
 336         }, RuntimeException.class);
 337         return storage[0];
 338     }
 339 
 340     @Override
 341     public void delete(final StaticAssetStorage assetStorage) {
 342         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 343             @Override
 344             public void execute() {
 345                 staticAssetStorageDao.delete(assetStorage);
 346             }
 347         }, RuntimeException.class);
 348     }
 349 
 350     @Override
 351     public Blob createBlob(final MultipartFile uploadedFile) throws IOException {
 352         final Blob[] blob = new Blob[1];
 353         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 354             @Override
 355             public void execute() {
 356                 try {
 357                     blob[0] = staticAssetStorageDao.createBlob(uploadedFile);
 358                 } catch (IOException e) {
 359                     LOG.error(&quot;Unable to create blob from MultipartFile.&quot;, e);
 360                 }
 361             }
 362         }, RuntimeException.class);
 363         return blob[0];
 364     }
 365 
 366     @Override
<abbr title=" 367     public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOException {"> 367     public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOExcepðŸ”µ</abbr>
 368         final Blob[] blob = new Blob[1];
 369         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 370             @Override
 371             public void execute() {
 372                 try {
 373                     blob[0] = staticAssetStorageDao.createBlob(uploadedFileInputStream, fileSize);
 374                 } catch (IOException e) {
 375                     LOG.error(&quot;Unable to create blob from InputStream.&quot;, e);
 376                 }
 377             }
 378         }, RuntimeException.class);
 379         return blob[0];
 380     }
 381 
 382     /**
 383      * Builds a file system path for the passed in static asset and paramaterMap.
 384      *
 385      * @param staticAsset
 386      * @param parameterMap
 387      * @param useSharedFile
 388      * @return
 389      */
 390     protected String constructCacheFileName(StaticAsset staticAsset, Map&lt;String, String&gt; parameterMap) {
 391         String fileName = staticAsset.getFullUrl();
 392 
 393         StringBuilder sb = new StringBuilder(200);
 394         sb.append(fileName.substring(0, fileName.lastIndexOf(&#x27;.&#x27;)));
 395         sb.append(&quot;---&quot;);
 396 
 397         StringBuilder sb2 = new StringBuilder(200);
 398         SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd-HH-mm-ss&quot;);
 399         if (staticAsset instanceof Auditable) {
 400             Auditable auditableStaticAsset = (Auditable) staticAsset;
<abbr title=" 401             sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCreated() : auditableStaticAsset.getDateUpdated()));"> 401             sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAssetðŸ”µ</abbr>
 402         }
 403 
 404         if (parameterMap != null) {
 405             for (Map.Entry&lt;String, String&gt; entry : parameterMap.entrySet()) {
 406                 sb2.append(&#x27;-&#x27;);
 407                 sb2.append(entry.getKey());
 408                 sb2.append(&#x27;-&#x27;);
 409                 sb2.append(entry.getValue());
 410             }
 411         }
 412 
 413         String digest;
 414         try {
 415             MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);
 416             byte[] messageDigest = md.digest(sb2.toString().getBytes());
 417             BigInteger number = new BigInteger(1,messageDigest);
 418             digest = number.toString(16);
 419         } catch(NoSuchAlgorithmException e) {
 420             throw new RuntimeException(e);
 421         }
 422 
 423         sb.append(pad(digest, 32, &#x27;0&#x27;));
 424         sb.append(fileName.substring(fileName.lastIndexOf(&#x27;.&#x27;)));
 425 
 426         return sb.toString();
 427     }
 428 
 429     protected String pad(String s, int length, char pad) {
 430         StringBuilder buffer = new StringBuilder(s);
 431         while (buffer.length() &lt; length) {
 432             buffer.insert(0, pad);
 433         }
 434         return buffer.toString();
 435     }
 436 
 437     @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)
 438     @Override
<abbr title=" 439     public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOException {"> 439     public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOExðŸ”µ</abbr>
 440         createStaticAssetStorage(file.getInputStream(), staticAsset);
 441     }
 442 
 443     @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)
 444     @Override
<abbr title=" 445     public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException {"> 445     public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOEðŸ”µ</abbr>
 446         if (StorageType.DATABASE.equals(staticAsset.getStorageType())) {
 447             StaticAssetStorage storage = create();
 448             storage.setStaticAssetId(staticAsset.getId());
 449             Blob uploadBlob = createBlob(fileInputStream, staticAsset.getFileSize());
 450             storage.setFileData(uploadBlob);
 451             save(storage);
 452         } else if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {
 453             FileWorkArea tempWorkArea = broadleafFileService.initializeWorkArea();
 454             // Convert the given URL from the asset to a system-specific suitable file path
<abbr title=" 455             String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FilenameUtils.separatorsToSystem(staticAsset.getFullUrl()));"> 455             String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separðŸ”µ</abbr>
 456 
 457             InputStream input = fileInputStream;
 458             byte[] buffer = new byte[getFileBufferSize()];
 459 
 460             File destFile = new File(destFileName);
 461             if (!destFile.getParentFile().exists()) {
 462                 if (!destFile.getParentFile().mkdirs()) {
 463                     if (!destFile.getParentFile().exists()) {
<abbr title=" 464                         throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileName);"> 464                         throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + desðŸ”µ</abbr>
 465                     }
 466                 }
 467             }
 468 
 469             OutputStream output = new FileOutputStream(destFile);
 470             long maxFileSize = getMaxUploadSizeForFile(destFileName);
 471             try {
 472                 int bytesRead;
 473                 int totalBytesRead = 0;
 474                 while ((bytesRead = input.read(buffer)) != -1) {
 475                     totalBytesRead += bytesRead;
 476                     if (totalBytesRead &gt; maxFileSize) {
 477                         throw new IOException(&quot;Maximum Upload File Size Exceeded&quot;);
 478                     }
 479                     output.write(buffer, 0, bytesRead);
 480                 }
 481 
 482                 // close the output file stream prior to moving files around
 483                 output.close();
 484                 broadleafFileService.addOrUpdateResource(tempWorkArea, destFile, false);
 485             } finally {
 486                 IOUtils.closeQuietly(output);
 487                 broadleafFileService.closeWorkArea(tempWorkArea);
 488             }
 489         }
 490     }
 491 
 492     protected long getMaxUploadSizeForFile(String fileName) {
 493         if (isImageFile(fileName)) {
 494             return getMaxUploadableImageSize();
 495         }
 496 
 497         return getMaxUploadableFileSize();
 498     }
 499 
 500     protected boolean isImageFile(String fileName) {
 501         String extension = getFileExtension(fileName);
 502 
 503         for (String imageFileExtension : getAdminImageFileExtensions()) {
 504             if (imageFileExtension.equalsIgnoreCase(extension)) {
 505                 return true;
 506             }
 507         }
 508 
 509         return false;
 510     }
 511 
 512     protected String getFileExtension(String assetPath) {
 513         int extensionStartIndex = assetPath.lastIndexOf(&quot;.&quot;) + 1;
 514         return assetPath.substring(extensionStartIndex);
 515     }
 516 
 517     protected long getMaxUploadableFileSize() {
 518         Long blcUploadSize = env.getProperty(&quot;asset.server.max.uploadable.file.size&quot;, Long.class);
 519         if (blcUploadSize != null) {
 520             return blcUploadSize;
 521         }
 522 
 523         if (defaultMultipartSettings != null) {
 524             return defaultMultipartSettings.createMultipartConfig().getMaxFileSize();
 525         }
 526         return DEFAULT_ASSET_UPLOAD_SIZE;
 527     }
 528 
 529     protected long getMaxUploadableImageSize() {
 530         // backwards-compatibility checks, only use the image-size specific property if it is
 531         // not the default value. Otherwise, delegate to the old property
 532         Long maxImgSize = env.getProperty(&quot;asset.server.max.uploadable.image.size&quot;, Long.class);
 533         if (maxImgSize == null) {
 534             return getMaxUploadableFileSize();
 535         } else {
 536             return maxImgSize;
 537         }
 538     }
 539 
 540     protected int getFileBufferSize() {
 541         return env.getProperty(&quot;asset.server.file.buffer.size&quot;, int.class, DEFAULT_BUFFER_SIZE);
 542     }
 543 
 544     protected List&lt;String&gt; getAdminImageFileExtensions() {
<abbr title=" 545         String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENSIONS);"> 545         String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMðŸ”µ</abbr>
 546         return Arrays.asList(extensions.split(&quot;,&quot;));
 547     }
 548 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce CMS Module
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.cms.file.service;
  19 
  20 import org.apache.commons.collections4.MapUtils;
  21 import org.apache.commons.io.FileExistsException;
  22 import org.apache.commons.io.FileUtils;
  23 import org.apache.commons.io.FilenameUtils;
  24 import org.apache.commons.io.IOUtils;
  25 import org.apache.commons.lang.ArrayUtils;
  26 import org.apache.commons.lang3.StringUtils;
  27 import org.apache.commons.logging.Log;
  28 import org.apache.commons.logging.LogFactory;
  29 import org.broadleafcommerce.cms.common.AssetNotFoundException;
  30 import org.broadleafcommerce.cms.field.type.StorageType;
  31 import org.broadleafcommerce.cms.file.dao.StaticAssetStorageDao;
  32 import org.broadleafcommerce.cms.file.domain.StaticAsset;
  33 import org.broadleafcommerce.cms.file.domain.StaticAssetStorage;
  34 import org.broadleafcommerce.cms.file.service.operation.NamedOperationManager;
  35 import org.broadleafcommerce.common.audit.Auditable;
  36 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  37 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  38 import org.broadleafcommerce.common.file.domain.FileWorkArea;
  39 import org.broadleafcommerce.common.file.service.BroadleafFileService;
  40 import org.broadleafcommerce.common.file.service.GloballySharedInputStream;
  41 import org.broadleafcommerce.common.io.ConcurrentFileOutputStream;
  42 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  43 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  44 import org.broadleafcommerce.openadmin.server.service.artifact.ArtifactService;
  45 import org.broadleafcommerce.openadmin.server.service.artifact.image.Operation;
  46 import org.springframework.beans.factory.annotation.Autowired;
  47 import org.springframework.boot.autoconfigure.web.servlet.MultipartProperties;
  48 import org.springframework.beans.factory.annotation.Value;
  49 import org.springframework.core.env.Environment;
  50 import org.springframework.stereotype.Service;
  51 import org.springframework.transaction.annotation.Transactional;
  52 import org.springframework.web.multipart.MultipartFile;
  53 
  54 import java.io.BufferedInputStream;
  55 import java.io.File;
  56 import java.io.FileInputStream;
  57 import java.io.FileOutputStream;
  58 import java.io.IOException;
  59 import java.io.InputStream;
  60 import java.io.OutputStream;
  61 import java.math.BigInteger;
  62 import java.security.MessageDigest;
  63 import java.security.NoSuchAlgorithmException;
  64 import java.sql.Blob;
  65 import java.sql.SQLException;
  66 import java.text.SimpleDateFormat;
  67 import java.util.Arrays;
  68 import java.util.HashMap;
  69 import java.util.List;
  70 import java.util.Map;
  71 
  72 import javax.annotation.Resource;
  73 
  74 /**
  75  * @author Jeff Fischer, Brian Polster
  76  */
  77 @Service(&quot;blStaticAssetStorageService&quot;)
  78 public class StaticAssetStorageServiceImpl implements StaticAssetStorageService {
  79 
  80     private static final Log LOG = LogFactory.getLog(StaticAssetStorageServiceImpl.class);
  81 
  82     protected static final String DEFAULT_ADMIN_IMAGE_EXTENSIONS = &quot;bmp,jpg,jpeg,png,img,tiff,gif&quot;;
  83 
  84     public static final long DEFAULT_ASSET_UPLOAD_SIZE = 1024 * 1024 * 10;
  85 
  86     // 8kb default for the buffer for moving files around
  87     protected static final int DEFAULT_BUFFER_SIZE = 8096;
  88 
  89     protected String cacheDirectory;
  90 
  91     @Autowired
  92     protected Environment env;
  93 
  94     @Resource(name=&quot;blStaticAssetService&quot;)
  95     protected StaticAssetService staticAssetService;
  96 
  97     @Resource(name = &quot;blFileService&quot;)
  98     protected BroadleafFileService broadleafFileService;
  99 
 100     @Resource(name=&quot;blArtifactService&quot;)
 101     protected ArtifactService artifactService;
 102 
 103     @Resource(name=&quot;blStaticAssetStorageDao&quot;)
 104     protected StaticAssetStorageDao staticAssetStorageDao;
 105 
 106     @Resource(name=&quot;blNamedOperationManager&quot;)
 107     protected NamedOperationManager namedOperationManager;
 108 
 109     @Resource(name = &quot;blStaticAssetServiceExtensionManager&quot;)
 110     protected StaticAssetServiceExtensionManager extensionManager;
 111 
 112     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 113     protected StreamingTransactionCapableUtil transUtil;
 114 
 115     @Value(&quot;${image.artifact.recompress.formats:png}&quot;)
 116     protected String recompressFormats = &quot;png&quot;;
 117 
 118     @Autowired(required = false)
 119     protected MultipartProperties defaultMultipartSettings;
 120 
 121     @Resource(name = &quot;blConcurrentFileOutputStream&quot;)
 122     protected ConcurrentFileOutputStream concurrentFileOutputStream;
 123 
 124 
 125     protected StaticAsset findStaticAsset(String fullUrl) {
 126         StaticAsset staticAsset = staticAssetService.findStaticAssetByFullUrl(fullUrl);
 127 
 128         return staticAsset;
 129     }
 130 
 131     protected boolean shouldUseSharedFile(InputStream is) {
 132         return (is != null &amp;&amp; is instanceof GloballySharedInputStream);
 133     }
 134 
 135     protected File getFileFromLocalRepository(String cachedFileName) {
<abbr title=" 136         // Look for a shared file (this represents a file that was based on a file originally in the classpath."> 136         // Look for a shared file (this represents a file that was based on a file originally in the clasðŸ”µ</abbr>
 137         File cacheFile = null;
 138         if (extensionManager != null) {
 139             ExtensionResultHolder holder = new ExtensionResultHolder();
<abbr title=" 140             ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holder);"> 140             ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holðŸ”µ</abbr>
 141             if (ExtensionResultStatusType.HANDLED.equals(result)) {
 142                 cacheFile = (File) holder.getResult();
 143             }
 144         }
 145         if (cacheFile == null) {
 146             cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);
 147         }
 148         if (cacheFile.exists()) {
 149             return cacheFile;
 150         } else {
 151             return broadleafFileService.getLocalResource(cachedFileName);
 152         }
 153     }
 154 
 155     protected File lookupAssetAndCreateLocalFile(StaticAsset staticAsset, File baseLocalFile)
 156             throws IOException, SQLException {
 157         if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {
 158             File returnFile = broadleafFileService.getResource(staticAsset.getFullUrl());
 159             if (!returnFile.getAbsolutePath().equals(baseLocalFile.getAbsolutePath())) {
 160                 createLocalFileFromInputStream(new FileInputStream(returnFile), baseLocalFile);
 161             }
 162             return broadleafFileService.getResource(staticAsset.getFullUrl());
 163         } else {
 164             StaticAssetStorage storage = readStaticAssetStorageByStaticAssetId(staticAsset.getId());
 165             if (storage != null) {
 166                 InputStream is = storage.getFileData().getBinaryStream();
 167                 createLocalFileFromInputStream(is, baseLocalFile);
 168             }
 169         }
 170         return baseLocalFile;
 171     }
 172 
<abbr title=" 173     protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOException {"> 173     protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throðŸ”µ</abbr>
 174         InputStream is = broadleafFileService.getClasspathResource(staticAsset.getFullUrl());
 175         createLocalFileFromInputStream(is, baseLocalFile);
 176     }
 177 
<abbr title=" 178     protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException {"> 178     protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException ðŸ”µ</abbr>
 179         try {
 180             if (!baseLocalFile.getParentFile().exists()) {
 181                 boolean directoriesCreated = false;
 182                 if (!baseLocalFile.getParentFile().exists()) {
 183                     directoriesCreated = baseLocalFile.getParentFile().mkdirs();
 184                     if (!directoriesCreated) {
<abbr title=" 185                         // There is a chance that another VM created the directories.   If not, we may not have"> 185                         // There is a chance that another VM created the directories.   If not, we may noðŸ”µ</abbr>
 186                         // proper permissions and this is an error we need to report.
 187                         if (!baseLocalFile.getParentFile().exists()) {
 188                             throw new RuntimeException(&quot;Unable to create middle directories for file: &quot; +
 189                                     baseLocalFile.getAbsolutePath());
 190                         }
 191                     }
 192                 }
 193             }
 194 
 195             concurrentFileOutputStream.write(is, baseLocalFile);
 196 
 197         } finally {
 198             IOUtils.closeQuietly(is);
 199         }
 200     }
 201 
 202     @Override
<abbr title=" 203     public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws Exception {"> 203     public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throwsðŸ”µ</abbr>
 204         StaticAsset staticAsset = findStaticAsset(fullUrl);
 205         if (staticAsset == null) {
 206             throw new AssetNotFoundException(&quot;Unable to find an asset for the url (&quot; + fullUrl + &quot;)&quot;);
 207         }
 208         String mimeType = staticAsset.getMimeType();
 209 
 210         //extract the values for any named parameters
 211         boolean shouldRecompress = shouldRecompress(mimeType);
<abbr title=" 212         Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMap);"> 212         Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMaðŸ”µ</abbr>
 213         if (shouldRecompress &amp;&amp; MapUtils.isEmpty(convertedParameters)) {
 214             convertedParameters.put(&quot;recompress&quot;,&quot;true&quot;);
 215         }
 216         String cachedFileName = constructCacheFileName(staticAsset, convertedParameters);
 217 
 218         if (shouldRecompress) {
 219             convertedParameters.remove(&quot;recompress&quot;);
 220         }
 221 
<abbr title=" 222         // Look for a shared file (this represents a file that was based on a file originally in the classpath."> 222         // Look for a shared file (this represents a file that was based on a file originally in the clasðŸ”µ</abbr>
 223         File cacheFile = getFileFromLocalRepository(cachedFileName);
 224         if (cacheFile.exists()) {
 225             return buildModel(cacheFile.getAbsolutePath(), mimeType);
 226         }
 227 
 228         // Obtain the base file (that we may need to convert based on the parameters
 229         String baseCachedFileName = constructCacheFileName(staticAsset, null);
 230         File baseLocalFile = getFileFromLocalRepository(baseCachedFileName);
 231 
 232         if (! baseLocalFile.exists()) {
 233             if (broadleafFileService.checkForResourceOnClassPath(staticAsset.getFullUrl())) {
 234                 cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);
 235                 baseLocalFile = broadleafFileService.getSharedLocalResource(baseCachedFileName);
 236                 createLocalFileFromClassPathResource(staticAsset, baseLocalFile);
 237             } else {
 238                 baseLocalFile = lookupAssetAndCreateLocalFile(staticAsset, baseLocalFile);
 239             }
 240         }
 241 
 242 
 243         if (!shouldRecompress &amp;&amp; convertedParameters.isEmpty()) {
 244             return buildModel(baseLocalFile.getAbsolutePath(), mimeType);
 245         }
 246         else {
 247             FileInputStream assetStream = new FileInputStream(baseLocalFile);
 248             BufferedInputStream original = new BufferedInputStream(assetStream);
 249             original.mark(0);
 250 
<abbr title=" 251             Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.getMimeType());"> 251             Operation[] operations = artifactService.buildOperations(convertedParameters, original, statiðŸ”µ</abbr>
<abbr title=" 252             InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeType());"> 252             InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeTypeðŸ”µ</abbr>
 253 
 254             createLocalFileFromInputStream(converted, cacheFile);
 255             if (&quot;image/gif&quot;.equals(mimeType)) {
 256                 mimeType = &quot;image/png&quot;;
 257             }
 258             return buildModel(cacheFile.getAbsolutePath(), mimeType);
 259         }
 260     }
 261 
 262     protected boolean shouldRecompress(String mimeType) {
 263         String[] formats = null;
 264         if (!StringUtils.isEmpty(recompressFormats)) {
 265             formats = recompressFormats.split(&quot;,&quot;);
 266         }
 267         boolean response = false;
 268         if (!ArrayUtils.isEmpty(formats)) {
 269             for (String format : formats) {
 270                 if (mimeType.toLowerCase().contains(format.toLowerCase())) {
 271                     response = true;
 272                     break;
 273                 }
 274             }
 275         }
 276         return response;
 277     }
 278 
 279     protected Map&lt;String, String&gt; buildModel(String returnFilePath, String mimeType) {
 280         Map&lt;String, String&gt; model = new HashMap&lt;String, String&gt;(2);
 281         model.put(&quot;cacheFilePath&quot;, returnFilePath);
 282         model.put(&quot;mimeType&quot;, mimeType);
 283 
 284         return model;
 285     }
 286 
 287     @Override
 288     public StaticAssetStorage findStaticAssetStorageById(final Long id) {
 289         final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 290         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 291             @Override
 292             public void execute() {
 293                 storage[0] = staticAssetStorageDao.readStaticAssetStorageById(id);
 294             }
 295         }, RuntimeException.class);
 296         return storage[0];
 297     }
 298 
 299     @Override
 300     public StaticAssetStorage create() {
 301         return staticAssetStorageDao.create();
 302     }
 303 
 304     @Override
 305     public StaticAssetStorage readStaticAssetStorageByStaticAssetId(final Long id) {
 306         final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 307         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 308             @Override
 309             public void execute() {
 310                 storage[0] = staticAssetStorageDao.readStaticAssetStorageByStaticAssetId(id);
 311             }
 312         }, RuntimeException.class);
 313         return storage[0];
 314     }
 315 
 316     @Override
 317     public StaticAssetStorage save(final StaticAssetStorage assetStorage) {
 318         final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 319         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 320             @Override
 321             public void execute() {
 322                 storage[0] = staticAssetStorageDao.save(assetStorage);
 323             }
 324         }, RuntimeException.class);
 325         return storage[0];
 326     }
 327 
 328     @Override
 329     public void delete(final StaticAssetStorage assetStorage) {
 330         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 331             @Override
 332             public void execute() {
 333                 staticAssetStorageDao.delete(assetStorage);
 334             }
 335         }, RuntimeException.class);
 336     }
 337 
 338     @Override
 339     public Blob createBlob(final MultipartFile uploadedFile) throws IOException {
 340         final Blob[] blob = new Blob[1];
 341         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 342             @Override
 343             public void execute() {
 344                 try {
 345                     blob[0] = staticAssetStorageDao.createBlob(uploadedFile);
 346                 } catch (IOException e) {
 347                     LOG.error(&quot;Unable to create blob from MultipartFile.&quot;, e);
 348                 }
 349             }
 350         }, RuntimeException.class);
 351         return blob[0];
 352     }
 353 
 354     @Override
<abbr title=" 355     public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOException {"> 355     public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOExcepðŸ”µ</abbr>
 356         final Blob[] blob = new Blob[1];
 357         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 358             @Override
 359             public void execute() {
 360                 try {
 361                     blob[0] = staticAssetStorageDao.createBlob(uploadedFileInputStream, fileSize);
 362                 } catch (IOException e) {
 363                     LOG.error(&quot;Unable to create blob from InputStream.&quot;, e);
 364                 }
 365             }
 366         }, RuntimeException.class);
 367         return blob[0];
 368     }
 369 
 370     /**
 371      * Builds a file system path for the passed in static asset and paramaterMap.
 372      *
 373      * @param staticAsset
 374      * @param parameterMap
 375      * @param useSharedFile
 376      * @return
 377      */
 378     protected String constructCacheFileName(StaticAsset staticAsset, Map&lt;String, String&gt; parameterMap) {
 379         String fileName = staticAsset.getFullUrl();
 380 
 381         StringBuilder sb = new StringBuilder(200);
 382         sb.append(fileName.substring(0, fileName.lastIndexOf(&#x27;.&#x27;)));
 383         sb.append(&quot;---&quot;);
 384 
 385         StringBuilder sb2 = new StringBuilder(200);
 386         SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd-HH-mm-ss&quot;);
 387         if (staticAsset instanceof Auditable) {
 388             Auditable auditableStaticAsset = (Auditable) staticAsset;
<abbr title=" 389             sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCreated() : auditableStaticAsset.getDateUpdated()));"> 389             sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAssetðŸ”µ</abbr>
 390         }
 391 
 392         if (parameterMap != null) {
 393             for (Map.Entry&lt;String, String&gt; entry : parameterMap.entrySet()) {
 394                 sb2.append(&#x27;-&#x27;);
 395                 sb2.append(entry.getKey());
 396                 sb2.append(&#x27;-&#x27;);
 397                 sb2.append(entry.getValue());
 398             }
 399         }
 400 
 401         String digest;
 402         try {
 403             MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);
 404             byte[] messageDigest = md.digest(sb2.toString().getBytes());
 405             BigInteger number = new BigInteger(1,messageDigest);
 406             digest = number.toString(16);
 407         } catch(NoSuchAlgorithmException e) {
 408             throw new RuntimeException(e);
 409         }
 410 
 411         sb.append(pad(digest, 32, &#x27;0&#x27;));
 412         sb.append(fileName.substring(fileName.lastIndexOf(&#x27;.&#x27;)));
 413 
 414         return sb.toString();
 415     }
 416 
 417     protected String pad(String s, int length, char pad) {
 418         StringBuilder buffer = new StringBuilder(s);
 419         while (buffer.length() &lt; length) {
 420             buffer.insert(0, pad);
 421         }
 422         return buffer.toString();
 423     }
 424 
 425     @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)
 426     @Override
<abbr title=" 427     public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOException {"> 427     public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOExðŸ”µ</abbr>
 428         createStaticAssetStorage(file.getInputStream(), staticAsset);
 429     }
 430 
 431     @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)
 432     @Override
<abbr title=" 433     public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException {"> 433     public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOEðŸ”µ</abbr>
 434         if (StorageType.DATABASE.equals(staticAsset.getStorageType())) {
 435             StaticAssetStorage storage = create();
 436             storage.setStaticAssetId(staticAsset.getId());
 437             Blob uploadBlob = createBlob(fileInputStream, staticAsset.getFileSize());
 438             storage.setFileData(uploadBlob);
 439             save(storage);
 440         } else if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {
 441             FileWorkArea tempWorkArea = broadleafFileService.initializeWorkArea();
 442             // Convert the given URL from the asset to a system-specific suitable file path
<abbr title=" 443             String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FilenameUtils.separatorsToSystem(staticAsset.getFullUrl()));"> 443             String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separðŸ”µ</abbr>
 444 
 445             InputStream input = fileInputStream;
 446             byte[] buffer = new byte[getFileBufferSize()];
 447 
 448             File destFile = new File(destFileName);
 449             if (!destFile.getParentFile().exists()) {
 450                 if (!destFile.getParentFile().mkdirs()) {
 451                     if (!destFile.getParentFile().exists()) {
<abbr title=" 452                         throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileName);"> 452                         throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + desðŸ”µ</abbr>
 453                     }
 454                 }
 455             }
 456 
 457             OutputStream output = new FileOutputStream(destFile);
 458             long maxFileSize = getMaxUploadSizeForFile(destFileName);
 459             try {
 460                 int bytesRead;
 461                 int totalBytesRead = 0;
 462                 while ((bytesRead = input.read(buffer)) != -1) {
 463                     totalBytesRead += bytesRead;
 464                     if (totalBytesRead &gt; maxFileSize) {
 465                         throw new IOException(&quot;Maximum Upload File Size Exceeded&quot;);
 466                     }
 467                     output.write(buffer, 0, bytesRead);
 468                 }
 469 
 470                 // close the output file stream prior to moving files around
 471                 output.close();
 472                 broadleafFileService.addOrUpdateResource(tempWorkArea, destFile, false);
 473             } finally {
 474                 IOUtils.closeQuietly(output);
 475                 broadleafFileService.closeWorkArea(tempWorkArea);
 476             }
 477         }
 478     }
 479 
 480     protected long getMaxUploadSizeForFile(String fileName) {
 481         if (isImageFile(fileName)) {
 482             return getMaxUploadableImageSize();
 483         }
 484 
 485         return getMaxUploadableFileSize();
 486     }
 487 
 488     protected boolean isImageFile(String fileName) {
 489         String extension = getFileExtension(fileName);
 490 
 491         for (String imageFileExtension : getAdminImageFileExtensions()) {
 492             if (imageFileExtension.equalsIgnoreCase(extension)) {
 493                 return true;
 494             }
 495         }
 496 
 497         return false;
 498     }
 499 
 500     protected String getFileExtension(String assetPath) {
 501         int extensionStartIndex = assetPath.lastIndexOf(&quot;.&quot;) + 1;
 502         return assetPath.substring(extensionStartIndex);
 503     }
 504 
 505     protected long getMaxUploadableFileSize() {
 506         Long blcUploadSize = env.getProperty(&quot;asset.server.max.uploadable.file.size&quot;, Long.class);
 507         if (blcUploadSize != null) {
 508             return blcUploadSize;
 509         }
 510 
 511         if (defaultMultipartSettings != null) {
 512             return defaultMultipartSettings.createMultipartConfig().getMaxFileSize();
 513         }
 514         return DEFAULT_ASSET_UPLOAD_SIZE;
 515     }
 516 
 517     protected long getMaxUploadableImageSize() {
 518         // backwards-compatibility checks, only use the image-size specific property if it is
 519         // not the default value. Otherwise, delegate to the old property
 520         Long maxImgSize = env.getProperty(&quot;asset.server.max.uploadable.image.size&quot;, Long.class);
 521         if (maxImgSize == null) {
 522             return getMaxUploadableFileSize();
 523         } else {
 524             return maxImgSize;
 525         }
 526     }
 527 
 528     protected int getFileBufferSize() {
 529         return env.getProperty(&quot;asset.server.file.buffer.size&quot;, int.class, DEFAULT_BUFFER_SIZE);
 530     }
 531 
 532     protected List&lt;String&gt; getAdminImageFileExtensions() {
<abbr title=" 533         String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENSIONS);"> 533         String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMðŸ”µ</abbr>
 534         return Arrays.asList(extensions.split(&quot;,&quot;));
 535     }
 536 }
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce CMS Module
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.cms.file.service;
  19 
  20 import java.io.BufferedInputStream;
  21 import java.io.File;
  22 import java.io.FileInputStream;
  23 import java.io.FileOutputStream;
  24 import java.io.IOException;
  25 import java.io.InputStream;
  26 import java.io.OutputStream;
  27 import java.math.BigInteger;
  28 import java.security.MessageDigest;
  29 import java.security.NoSuchAlgorithmException;
  30 import java.sql.Blob;
  31 import java.sql.SQLException;
  32 import java.text.SimpleDateFormat;
  33 import java.util.Arrays;
  34 import java.util.HashMap;
  35 import java.util.List;
  36 import java.util.Map;
  37 import javax.annotation.Resource;
  38 import org.apache.commons.collections4.MapUtils;
  39 import org.apache.commons.io.FileExistsException;
  40 import org.apache.commons.io.FileUtils;
  41 import org.apache.commons.io.FilenameUtils;
  42 import org.apache.commons.io.IOUtils;
  43 import org.apache.commons.lang.ArrayUtils;
  44 import org.apache.commons.lang3.StringUtils;
  45 import org.apache.commons.logging.Log;
  46 import org.apache.commons.logging.LogFactory;
  47 import org.broadleafcommerce.cms.common.AssetNotFoundException;
  48 import org.broadleafcommerce.cms.field.type.StorageType;
  49 import org.broadleafcommerce.cms.file.dao.StaticAssetStorageDao;
  50 import org.broadleafcommerce.cms.file.domain.StaticAsset;
  51 import org.broadleafcommerce.cms.file.domain.StaticAssetStorage;
  52 import org.broadleafcommerce.cms.file.service.operation.NamedOperationManager;
  53 import org.broadleafcommerce.common.audit.Auditable;
  54 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  55 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  56 import org.broadleafcommerce.common.file.domain.FileWorkArea;
  57 import org.broadleafcommerce.common.file.service.BroadleafFileService;
  58 import org.broadleafcommerce.common.file.service.GloballySharedInputStream;
  59 import org.broadleafcommerce.common.io.ConcurrentFileOutputStream;
  60 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  61 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  62 import org.broadleafcommerce.openadmin.server.service.artifact.ArtifactService;
  63 import org.broadleafcommerce.openadmin.server.service.artifact.image.Operation;
  64 import org.springframework.beans.factory.annotation.Autowired;
  65 import org.springframework.beans.factory.annotation.Value;
  66 import org.springframework.boot.autoconfigure.web.servlet.MultipartProperties;
  67 import org.springframework.core.env.Environment;
  68 import org.springframework.stereotype.Service;
  69 import org.springframework.transaction.annotation.Transactional;
  70 import org.springframework.web.multipart.MultipartFile;
  71 
  72 
  73 /**
  74  * @author Jeff Fischer, Brian Polster
  75  */
  76 @Service(&quot;blStaticAssetStorageService&quot;)
  77 public class StaticAssetStorageServiceImpl implements StaticAssetStorageService {
  78     private static final Log LOG = LogFactory.getLog(StaticAssetStorageServiceImpl.class);
  79 
  80     protected static final String DEFAULT_ADMIN_IMAGE_EXTENSIONS = &quot;bmp,jpg,jpeg,png,img,tiff,gif&quot;;
  81 
  82     public static final long DEFAULT_ASSET_UPLOAD_SIZE = 1024 * 1024 * 10;
  83 
  84     // 8kb default for the buffer for moving files around
  85     // 8kb default for the buffer for moving files around
  86     protected static final int DEFAULT_BUFFER_SIZE = 8096;
  87 
  88     protected String cacheDirectory;
  89 
  90     @Autowired
  91     protected Environment env;
  92 
  93     @Resource(name=&quot;blStaticAssetService&quot;)
  94     protected StaticAssetService staticAssetService;
  95 
  96     @Resource(name = &quot;blFileService&quot;)
  97     protected BroadleafFileService broadleafFileService;
  98 
  99     @Resource(name=&quot;blArtifactService&quot;)
 100     protected ArtifactService artifactService;
 101 
 102     @Resource(name=&quot;blStaticAssetStorageDao&quot;)
 103     protected StaticAssetStorageDao staticAssetStorageDao;
 104 
 105     @Resource(name=&quot;blNamedOperationManager&quot;)
 106     protected NamedOperationManager namedOperationManager;
 107 
 108     @Resource(name = &quot;blStaticAssetServiceExtensionManager&quot;)
 109     protected StaticAssetServiceExtensionManager extensionManager;
 110 
 111     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 112     protected StreamingTransactionCapableUtil transUtil;
 113 
 114     @Value(&quot;${image.artifact.recompress.formats:png}&quot;)
 115     protected String recompressFormats = &quot;png&quot;;
 116 
 117     @Autowired(required = false)
 118     protected MultipartProperties defaultMultipartSettings;
 119 
 120     @Resource(name = &quot;blConcurrentFileOutputStream&quot;)
 121     protected ConcurrentFileOutputStream concurrentFileOutputStream;
 122 
 123     protected StaticAsset findStaticAsset(String fullUrl) {
 124         StaticAsset staticAsset = staticAssetService.findStaticAssetByFullUrl(fullUrl);
 125 
 126         return staticAsset;
 127     }
 128 
 129     protected boolean shouldUseSharedFile(InputStream is) {
 130         return (is != null &amp;&amp; is instanceof GloballySharedInputStream);
 131     }
 132 
 133     protected File getFileFromLocalRepository(String cachedFileName) {
<abbr title=" 134         // Look for a shared file (this represents a file that was based on a file originally in the classpath."> 134         // Look for a shared file (this represents a file that was based on a file originally in the clasðŸ”µ</abbr>
 135         File cacheFile = null;
 136         if (extensionManager != null) {
 137             ExtensionResultHolder holder = new ExtensionResultHolder();
<abbr title=" 138             ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holder);"> 138             ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holðŸ”µ</abbr>
 139             if (ExtensionResultStatusType.HANDLED.equals(result)) {
 140                 cacheFile = (File) holder.getResult();
 141             }
 142         }
 143         if (cacheFile == null) {
 144             cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);
 145         }
 146         if (cacheFile.exists()) {
 147             return cacheFile;
 148         } else {
 149             return broadleafFileService.getLocalResource(cachedFileName);
 150         }
 151     }
 152 
 153     protected File lookupAssetAndCreateLocalFile(StaticAsset staticAsset, File baseLocalFile)
 154             throws IOException, SQLException {
 155         if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {
 156             File returnFile = broadleafFileService.getResource(staticAsset.getFullUrl());
 157             if (!returnFile.getAbsolutePath().equals(baseLocalFile.getAbsolutePath())) {
 158                 createLocalFileFromInputStream(new FileInputStream(returnFile), baseLocalFile);
 159             }
 160             return broadleafFileService.getResource(staticAsset.getFullUrl());
 161         } else {
 162             StaticAssetStorage storage = readStaticAssetStorageByStaticAssetId(staticAsset.getId());
 163             if (storage != null) {
 164                 InputStream is = storage.getFileData().getBinaryStream();
 165                 createLocalFileFromInputStream(is, baseLocalFile);
 166             }
 167         }
 168         return baseLocalFile;
 169     }
 170 
<abbr title=" 171     protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOException {"> 171     protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throðŸ”µ</abbr>
 172         InputStream is = broadleafFileService.getClasspathResource(staticAsset.getFullUrl());
 173         createLocalFileFromInputStream(is, baseLocalFile);
 174     }
 175 
<abbr title=" 176     protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException {"> 176     protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException ðŸ”µ</abbr>
 177         try {
 178             if (!baseLocalFile.getParentFile().exists()) {
 179                 boolean directoriesCreated = false;
 180                 if (!baseLocalFile.getParentFile().exists()) {
 181                     directoriesCreated = baseLocalFile.getParentFile().mkdirs();
 182                     if (!directoriesCreated) {
<abbr title=" 183                         // There is a chance that another VM created the directories.   If not, we may not have"> 183                         // There is a chance that another VM created the directories.   If not, we may noðŸ”µ</abbr>
 184                         // proper permissions and this is an error we need to report.
 185                         if (!baseLocalFile.getParentFile().exists()) {
 186                             throw new RuntimeException(&quot;Unable to create middle directories for file: &quot; +
 187                                     baseLocalFile.getAbsolutePath());
 188                         }
 189                     }
 190                 }
 191             }
 192 
 193             concurrentFileOutputStream.write(is, baseLocalFile);
 194 
 195         } finally {
 196             IOUtils.closeQuietly(is);
 197         }
 198     }
 199 
 200     @Override
<abbr title=" 201     public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws Exception {"> 201     public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throwsðŸ”µ</abbr>
 202         StaticAsset staticAsset = findStaticAsset(fullUrl);
 203         if (staticAsset == null) {
 204             throw new AssetNotFoundException((&quot;Unable to find an asset for the url (&quot; + fullUrl) + &quot;)&quot;);
 205         }
 206         String mimeType = staticAsset.getMimeType();
 207         // extract the values for any named parameters
 208         boolean shouldRecompress = shouldRecompress(mimeType);
<abbr title=" 209         Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMap);"> 209         Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMaðŸ”µ</abbr>
 210         if (shouldRecompress &amp;&amp; MapUtils.isEmpty(convertedParameters)) {
 211             convertedParameters.put(&quot;recompress&quot;, &quot;true&quot;);
 212         }
 213         String cachedFileName = constructCacheFileName(staticAsset, convertedParameters);
 214         if (shouldRecompress) {
 215             convertedParameters.remove(&quot;recompress&quot;);
 216         }
<abbr title=" 217         // Look for a shared file (this represents a file that was based on a file originally in the classpath."> 217         // Look for a shared file (this represents a file that was based on a file originally in the clasðŸ”µ</abbr>
 218         File cacheFile = getFileFromLocalRepository(cachedFileName);
 219         if (cacheFile.exists()) {
 220             return buildModel(cacheFile.getAbsolutePath(), mimeType);
 221         }
 222         // Obtain the base file (that we may need to convert based on the parameters
 223         String baseCachedFileName = constructCacheFileName(staticAsset, null);
 224         File baseLocalFile = getFileFromLocalRepository(baseCachedFileName);
 225         if (!baseLocalFile.exists()) {
 226             if (broadleafFileService.checkForResourceOnClassPath(staticAsset.getFullUrl())) {
 227                 cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);
 228                 baseLocalFile = broadleafFileService.getSharedLocalResource(baseCachedFileName);
 229                 createLocalFileFromClassPathResource(staticAsset, baseLocalFile);
 230             } else {
 231                 baseLocalFile = lookupAssetAndCreateLocalFile(staticAsset, baseLocalFile);
 232             }
 233         }
 234         if ((!shouldRecompress) &amp;&amp; convertedParameters.isEmpty()) {
 235             return buildModel(baseLocalFile.getAbsolutePath(), mimeType);
 236         } else {
 237             FileInputStream assetStream = new FileInputStream(baseLocalFile);
 238             BufferedInputStream original = new BufferedInputStream(assetStream);
 239             original.mark(0);
<abbr title=" 240             Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.getMimeType());"> 240             Operation[] operations = artifactService.buildOperations(convertedParameters, original, statiðŸ”µ</abbr>
<abbr title=" 241             InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeType());"> 241             InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeTypeðŸ”µ</abbr>
 242             createLocalFileFromInputStream(converted, cacheFile);
 243             if (&quot;image/gif&quot;.equals(mimeType)) {
 244                 mimeType = &quot;image/png&quot;;
 245             }
 246             return buildModel(cacheFile.getAbsolutePath(), mimeType);
 247         }
 248     }
 249 
 250     protected boolean shouldRecompress(String mimeType) {
 251         String[] formats = null;
 252         if (!StringUtils.isEmpty(recompressFormats)) {
 253             formats = recompressFormats.split(&quot;,&quot;);
 254         }
 255         boolean response = false;
 256         if (!ArrayUtils.isEmpty(formats)) {
 257             for (String format : formats) {
 258                 if (mimeType.toLowerCase().contains(format.toLowerCase())) {
 259                     response = true;
 260                     break;
 261                 }
 262             }
 263         }
 264         return response;
 265     }
 266 
 267     protected Map&lt;String, String&gt; buildModel(String returnFilePath, String mimeType) {
 268         Map&lt;String, String&gt; model = new HashMap&lt;String, String&gt;(2);
 269         model.put(&quot;cacheFilePath&quot;, returnFilePath);
 270         model.put(&quot;mimeType&quot;, mimeType);
 271 
 272         return model;
 273     }
 274 
 275     @Override
 276     public StaticAssetStorage findStaticAssetStorageById(final Long id) {
 277         final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 278         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 279             @Override
 280             public void execute() {
 281                 storage[0] = staticAssetStorageDao.readStaticAssetStorageById(id);
 282             }
 283         }, RuntimeException.class);
 284         return storage[0];
 285     }
 286 
 287     @Override
 288     public StaticAssetStorage create() {
 289         return staticAssetStorageDao.create();
 290     }
 291 
 292     @Override
 293     public StaticAssetStorage readStaticAssetStorageByStaticAssetId(final Long id) {
 294         final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 295         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 296             @Override
 297             public void execute() {
 298                 storage[0] = staticAssetStorageDao.readStaticAssetStorageByStaticAssetId(id);
 299             }
 300         }, RuntimeException.class);
 301         return storage[0];
 302     }
 303 
 304     @Override
 305     public StaticAssetStorage save(final StaticAssetStorage assetStorage) {
 306         final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 307         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 308             @Override
 309             public void execute() {
 310                 storage[0] = staticAssetStorageDao.save(assetStorage);
 311             }
 312         }, RuntimeException.class);
 313         return storage[0];
 314     }
 315 
 316     @Override
 317     public void delete(final StaticAssetStorage assetStorage) {
 318         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 319             @Override
 320             public void execute() {
 321                 staticAssetStorageDao.delete(assetStorage);
 322             }
 323         }, RuntimeException.class);
 324     }
 325 
 326     @Override
 327     public Blob createBlob(final MultipartFile uploadedFile) throws IOException {
 328         final Blob[] blob = new Blob[1];
 329         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 330             @Override
 331             public void execute() {
 332                 try {
 333                     blob[0] = staticAssetStorageDao.createBlob(uploadedFile);
 334                 } catch (IOException e) {
 335                     LOG.error(&quot;Unable to create blob from MultipartFile.&quot;, e);
 336                 }
 337             }
 338         }, RuntimeException.class);
 339         return blob[0];
 340     }
 341 
 342     @Override
<abbr title=" 343     public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOException {"> 343     public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOExcepðŸ”µ</abbr>
 344         final Blob[] blob = new Blob[1];
 345         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 346             @Override
 347             public void execute() {
 348                 try {
 349                     blob[0] = staticAssetStorageDao.createBlob(uploadedFileInputStream, fileSize);
 350                 } catch (IOException e) {
 351                     LOG.error(&quot;Unable to create blob from InputStream.&quot;, e);
 352                 }
 353             }
 354         }, RuntimeException.class);
 355         return blob[0];
 356     }
 357 
 358     /**
 359      * Builds a file system path for the passed in static asset and paramaterMap.
 360      *
 361      * @param staticAsset
 362      * @param parameterMap
 363      * @param useSharedFile
 364      * @return
 365      */
 366     protected String constructCacheFileName(StaticAsset staticAsset, Map&lt;String, String&gt; parameterMap) {
 367         String fileName = staticAsset.getFullUrl();
 368 
 369         StringBuilder sb = new StringBuilder(200);
 370         sb.append(fileName.substring(0, fileName.lastIndexOf(&#x27;.&#x27;)));
 371         sb.append(&quot;---&quot;);
 372 
 373         StringBuilder sb2 = new StringBuilder(200);
 374         SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd-HH-mm-ss&quot;);
 375         if (staticAsset instanceof Auditable) {
 376             Auditable auditableStaticAsset = (Auditable) staticAsset;
<abbr title=" 377             sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCreated() : auditableStaticAsset.getDateUpdated()));"> 377             sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAssetðŸ”µ</abbr>
 378         }
 379 
 380         if (parameterMap != null) {
 381             for (Map.Entry&lt;String, String&gt; entry : parameterMap.entrySet()) {
 382                 sb2.append(&#x27;-&#x27;);
 383                 sb2.append(entry.getKey());
 384                 sb2.append(&#x27;-&#x27;);
 385                 sb2.append(entry.getValue());
 386             }
 387         }
 388 
 389         String digest;
 390         try {
 391             MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);
 392             byte[] messageDigest = md.digest(sb2.toString().getBytes());
 393             BigInteger number = new BigInteger(1,messageDigest);
 394             digest = number.toString(16);
 395         } catch(NoSuchAlgorithmException e) {
 396             throw new RuntimeException(e);
 397         }
 398 
 399         sb.append(pad(digest, 32, &#x27;0&#x27;));
 400         sb.append(fileName.substring(fileName.lastIndexOf(&#x27;.&#x27;)));
 401 
 402         return sb.toString();
 403     }
 404 
 405     protected String pad(String s, int length, char pad) {
 406         StringBuilder buffer = new StringBuilder(s);
 407         while (buffer.length() &lt; length) {
 408             buffer.insert(0, pad);
 409         }
 410         return buffer.toString();
 411     }
 412 
 413     @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)
 414     @Override
<abbr title=" 415     public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOException {"> 415     public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOExðŸ”µ</abbr>
 416         createStaticAssetStorage(file.getInputStream(), staticAsset);
 417     }
 418 
 419     @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)
 420     @Override
<abbr title=" 421     public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException {"> 421     public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOEðŸ”µ</abbr>
 422         if (StorageType.DATABASE.equals(staticAsset.getStorageType())) {
 423             StaticAssetStorage storage = create();
 424             storage.setStaticAssetId(staticAsset.getId());
 425             Blob uploadBlob = createBlob(fileInputStream, staticAsset.getFileSize());
 426             storage.setFileData(uploadBlob);
 427             save(storage);
 428         } else if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {
 429             FileWorkArea tempWorkArea = broadleafFileService.initializeWorkArea();
 430             // Convert the given URL from the asset to a system-specific suitable file path
<abbr title=" 431             String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FilenameUtils.separatorsToSystem(staticAsset.getFullUrl()));"> 431             String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separðŸ”µ</abbr>
 432 
 433             InputStream input = fileInputStream;
 434             byte[] buffer = new byte[getFileBufferSize()];
 435 
 436             File destFile = new File(destFileName);
 437             if (!destFile.getParentFile().exists()) {
 438                 if (!destFile.getParentFile().mkdirs()) {
 439                     if (!destFile.getParentFile().exists()) {
<abbr title=" 440                         throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileName);"> 440                         throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + desðŸ”µ</abbr>
 441                     }
 442                 }
 443             }
 444 
 445             OutputStream output = new FileOutputStream(destFile);
 446             long maxFileSize = getMaxUploadSizeForFile(destFileName);
 447             try {
 448                 int bytesRead;
 449                 int totalBytesRead = 0;
 450                 while ((bytesRead = input.read(buffer)) != -1) {
 451                     totalBytesRead += bytesRead;
 452                     if (totalBytesRead &gt; maxFileSize) {
 453                         throw new IOException(&quot;Maximum Upload File Size Exceeded&quot;);
 454                     }
 455                     output.write(buffer, 0, bytesRead);
 456                 }
 457 
 458                 // close the output file stream prior to moving files around
 459                 output.close();
 460                 broadleafFileService.addOrUpdateResource(tempWorkArea, destFile, false);
 461             } finally {
 462                 IOUtils.closeQuietly(output);
 463                 broadleafFileService.closeWorkArea(tempWorkArea);
 464             }
 465         }
 466     }
 467 
 468     protected long getMaxUploadSizeForFile(String fileName) {
 469         if (isImageFile(fileName)) {
 470             return getMaxUploadableImageSize();
 471         }
 472 
 473         return getMaxUploadableFileSize();
 474     }
 475 
 476     protected boolean isImageFile(String fileName) {
 477         String extension = getFileExtension(fileName);
 478 
 479         for (String imageFileExtension : getAdminImageFileExtensions()) {
 480             if (imageFileExtension.equalsIgnoreCase(extension)) {
 481                 return true;
 482             }
 483         }
 484 
 485         return false;
 486     }
 487 
 488     protected String getFileExtension(String assetPath) {
 489         int extensionStartIndex = assetPath.lastIndexOf(&quot;.&quot;) + 1;
 490         return assetPath.substring(extensionStartIndex);
 491     }
 492 
 493     protected long getMaxUploadableFileSize() {
<abbr title=" 494         Long blcUploadSize = env.getProperty(&quot;asset.server.max.uploadable.file.size&quot;, java.lang.Long.class);"> 494         Long blcUploadSize = env.getProperty(&quot;asset.server.max.uploadable.file.size&quot;, java.lang.Long.clasðŸ”µ</abbr>
 495         if (blcUploadSize != null) {
 496             return blcUploadSize;
 497         }
 498         if (defaultMultipartSettings != null) {
 499             return defaultMultipartSettings.createMultipartConfig().getMaxFileSize();
 500         }
 501         return DEFAULT_ASSET_UPLOAD_SIZE;
 502     }
 503 
 504     protected long getMaxUploadableImageSize() {
 505         // backwards-compatibility checks, only use the image-size specific property if it is
 506         // not the default value. Otherwise, delegate to the old property
 507         Long maxImgSize = env.getProperty(&quot;asset.server.max.uploadable.image.size&quot;, Long.class);
 508         if (maxImgSize == null) {
 509             return getMaxUploadableFileSize();
 510         } else {
 511             return maxImgSize;
 512         }
 513     }
 514 
 515     protected int getFileBufferSize() {
 516         return env.getProperty(&quot;asset.server.file.buffer.size&quot;, int.class, DEFAULT_BUFFER_SIZE);
 517     }
 518 
 519     protected List&lt;String&gt; getAdminImageFileExtensions() {
<abbr title=" 520         String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENSIONS);"> 520         String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMðŸ”µ</abbr>
 521         return Arrays.asList(extensions.split(&quot;,&quot;));
 522     }
 523 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce CMS Module
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.cms.file.service;
  19  



  20  import org.apache.commons.io.FilenameUtils;
  21  import org.apache.commons.io.IOUtils;


  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
  24  import org.broadleafcommerce.cms.common.AssetNotFoundException;
  25  import org.broadleafcommerce.cms.field.type.StorageType;
  26  import org.broadleafcommerce.cms.file.dao.StaticAssetStorageDao;
  27  import org.broadleafcommerce.cms.file.domain.StaticAsset;
  28  import org.broadleafcommerce.cms.file.domain.StaticAssetStorage;
  29  import org.broadleafcommerce.cms.file.service.operation.NamedOperationManager;
  30  import org.broadleafcommerce.common.audit.Auditable;
  31  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  32  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  33  import org.broadleafcommerce.common.file.domain.FileWorkArea;
  34  import org.broadleafcommerce.common.file.service.BroadleafFileService;
  35  import org.broadleafcommerce.common.file.service.GloballySharedInputStream;
  36  import org.broadleafcommerce.common.io.ConcurrentFileOutputStream;
  37  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  38  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  39  import org.broadleafcommerce.openadmin.server.service.artifact.ArtifactService;
  40  import org.broadleafcommerce.openadmin.server.service.artifact.image.Operation;
  41  import org.springframework.beans.factory.annotation.Autowired;

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import org.springframework.boot.autoconfigure.web.MultipartProperties;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import org.springframework.boot.autoconfigure.web.servlet.MultipartProperties;</span>
  44  import org.springframework.core.env.Environment;
  45  import org.springframework.stereotype.Service;
  46  import org.springframework.transaction.annotation.Transactional;
  47  import org.springframework.web.multipart.MultipartFile;
  48  
  49  import java.io.BufferedInputStream;
  50  import java.io.File;
  51  import java.io.FileInputStream;
  52  import java.io.FileOutputStream;
  53  import java.io.IOException;
  54  import java.io.InputStream;
  55  import java.io.OutputStream;
  56  import java.math.BigInteger;
  57  import java.security.MessageDigest;
  58  import java.security.NoSuchAlgorithmException;
  59  import java.sql.Blob;
  60  import java.sql.SQLException;
  61  import java.text.SimpleDateFormat;
  62  import java.util.Arrays;
  63  import java.util.HashMap;
  64  import java.util.List;
  65  import java.util.Map;
  66  
  67  import javax.annotation.Resource;
  68  
  69  /**
  70   * @author Jeff Fischer, Brian Polster
  71   */
  72  @Service(&quot;blStaticAssetStorageService&quot;)
  73  public class StaticAssetStorageServiceImpl implements StaticAssetStorageService {
  74  
  75      private static final Log LOG = LogFactory.getLog(StaticAssetStorageServiceImpl.class);
  76  
  77      protected static final String DEFAULT_ADMIN_IMAGE_EXTENSIONS = &quot;bmp,jpg,jpeg,png,img,tiff,gif&quot;;
  78  
  79      public static final long DEFAULT_ASSET_UPLOAD_SIZE = 1024 * 1024 * 10;
  80  
  81      // 8kb default for the buffer for moving files around
  82      protected static final int DEFAULT_BUFFER_SIZE = 8096;
  83  
  84      protected String cacheDirectory;
  85  
  86      @Autowired
  87      protected Environment env;
  88  
  89      @Resource(name=&quot;blStaticAssetService&quot;)
  90      protected StaticAssetService staticAssetService;
  91  
  92      @Resource(name = &quot;blFileService&quot;)
  93      protected BroadleafFileService broadleafFileService;
  94  
  95      @Resource(name=&quot;blArtifactService&quot;)
  96      protected ArtifactService artifactService;
  97  
  98      @Resource(name=&quot;blStaticAssetStorageDao&quot;)
  99      protected StaticAssetStorageDao staticAssetStorageDao;
 100  
 101      @Resource(name=&quot;blNamedOperationManager&quot;)
 102      protected NamedOperationManager namedOperationManager;
 103  
 104      @Resource(name = &quot;blStaticAssetServiceExtensionManager&quot;)
 105      protected StaticAssetServiceExtensionManager extensionManager;
 106  
 107      @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 108      protected StreamingTransactionCapableUtil transUtil;
 109  



 110      @Autowired(required = false)
 111      protected MultipartProperties defaultMultipartSettings;
 112  
 113      @Resource(name = &quot;blConcurrentFileOutputStream&quot;)
 114      protected ConcurrentFileOutputStream concurrentFileOutputStream;

 115  
 116      protected StaticAsset findStaticAsset(String fullUrl) {
 117          StaticAsset staticAsset = staticAssetService.findStaticAssetByFullUrl(fullUrl);
 118  
 119          return staticAsset;
 120      }
 121  
 122      protected boolean shouldUseSharedFile(InputStream is) {
 123          return (is != null &amp;&amp; is instanceof GloballySharedInputStream);
 124      }
 125  
 126      protected File getFileFromLocalRepository(String cachedFileName) {
 127          // Look for a shared file (this represents a file that was based on a file originally in the classpath.
 128          File cacheFile = null;
 129          if (extensionManager != null) {
 130              ExtensionResultHolder holder = new ExtensionResultHolder();
 131              ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holder);
 132              if (ExtensionResultStatusType.HANDLED.equals(result)) {
 133                  cacheFile = (File) holder.getResult();
 134              }
 135          }
 136          if (cacheFile == null) {
 137              cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);
 138          }
 139          if (cacheFile.exists()) {
 140              return cacheFile;
 141          } else {
 142              return broadleafFileService.getLocalResource(cachedFileName);
 143          }
 144      }
 145  
 146      protected File lookupAssetAndCreateLocalFile(StaticAsset staticAsset, File baseLocalFile)
 147              throws IOException, SQLException {
 148          if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {
 149              File returnFile = broadleafFileService.getResource(staticAsset.getFullUrl());
 150              if (!returnFile.getAbsolutePath().equals(baseLocalFile.getAbsolutePath())) {
 151                  createLocalFileFromInputStream(new FileInputStream(returnFile), baseLocalFile);
 152              }
 153              return broadleafFileService.getResource(staticAsset.getFullUrl());
 154          } else {
 155              StaticAssetStorage storage = readStaticAssetStorageByStaticAssetId(staticAsset.getId());
 156              if (storage != null) {
 157                  InputStream is = storage.getFileData().getBinaryStream();
 158                  createLocalFileFromInputStream(is, baseLocalFile);
 159              }
 160          }
 161          return baseLocalFile;
 162      }
 163  
<abbr title=" 164      protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOException {"> 164      protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOExceðŸ”µ</abbr>
 165          InputStream is = broadleafFileService.getClasspathResource(staticAsset.getFullUrl());
 166          createLocalFileFromInputStream(is, baseLocalFile);
 167      }
 168  
 169      protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException {
 170          try {
 171              if (!baseLocalFile.getParentFile().exists()) {
 172                  boolean directoriesCreated = false;
 173                  if (!baseLocalFile.getParentFile().exists()) {
 174                      directoriesCreated = baseLocalFile.getParentFile().mkdirs();
 175                      if (!directoriesCreated) {
 176                          // There is a chance that another VM created the directories.   If not, we may not have
 177                          // proper permissions and this is an error we need to report.
 178                          if (!baseLocalFile.getParentFile().exists()) {
 179                              throw new RuntimeException(&quot;Unable to create middle directories for file: &quot; +
 180                                      baseLocalFile.getAbsolutePath());
 181                          }
 182                      }
 183                  }
 184              }
 185  
 186              concurrentFileOutputStream.write(is, baseLocalFile);
 187  
 188          } finally {
 189              IOUtils.closeQuietly(is);
 190          }
 191      }
 192  
 193      @Override
<abbr title=" 194      public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws Exception {"> 194      public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws ExceptioðŸ”µ</abbr>
 195          StaticAsset staticAsset = findStaticAsset(fullUrl);
 196          if (staticAsset == null) {
 197              throw new AssetNotFoundException(&quot;Unable to find an asset for the url (&quot; + fullUrl + &quot;)&quot;);
 198          }
 199          String mimeType = staticAsset.getMimeType();
 200  
 201          //extract the values for any named parameters

 202          Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMap);



 203          String cachedFileName = constructCacheFileName(staticAsset, convertedParameters);




 204  
 205          // Look for a shared file (this represents a file that was based on a file originally in the classpath.
 206          File cacheFile = getFileFromLocalRepository(cachedFileName);
 207          if (cacheFile.exists()) {
 208              return buildModel(cacheFile.getAbsolutePath(), mimeType);
 209          }
 210  
 211          // Obtain the base file (that we may need to convert based on the parameters
 212          String baseCachedFileName = constructCacheFileName(staticAsset, null);
 213          File baseLocalFile = getFileFromLocalRepository(baseCachedFileName);
 214  
 215          if (! baseLocalFile.exists()) {
 216              if (broadleafFileService.checkForResourceOnClassPath(staticAsset.getFullUrl())) {
 217                  cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);
 218                  baseLocalFile = broadleafFileService.getSharedLocalResource(baseCachedFileName);
 219                  createLocalFileFromClassPathResource(staticAsset, baseLocalFile);
 220              } else {
 221                  baseLocalFile = lookupAssetAndCreateLocalFile(staticAsset, baseLocalFile);
 222              }
 223          }
 224  
 225          if (convertedParameters.isEmpty()) {


 226              return buildModel(baseLocalFile.getAbsolutePath(), mimeType);
 227          } else {


 228              FileInputStream assetStream = new FileInputStream(baseLocalFile);
 229              BufferedInputStream original = new BufferedInputStream(assetStream);
 230              original.mark(0);
 231  
<abbr title=" 232              Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.getMimeType());"> 232              Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.geðŸ”µ</abbr>
 233              InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeType());
 234  
 235              createLocalFileFromInputStream(converted, cacheFile);
 236              if (&quot;image/gif&quot;.equals(mimeType)) {
 237                  mimeType = &quot;image/png&quot;;
 238              }
 239              return buildModel(cacheFile.getAbsolutePath(), mimeType);
 240          }

















 241      }
 242  
 243      protected Map&lt;String, String&gt; buildModel(String returnFilePath, String mimeType) {
 244          Map&lt;String, String&gt; model = new HashMap&lt;String, String&gt;(2);
 245          model.put(&quot;cacheFilePath&quot;, returnFilePath);
 246          model.put(&quot;mimeType&quot;, mimeType);
 247  
 248          return model;
 249      }
 250  
 251      @Override
 252      public StaticAssetStorage findStaticAssetStorageById(final Long id) {
 253          final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 254          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 255              @Override
 256              public void execute() {
 257                  storage[0] = staticAssetStorageDao.readStaticAssetStorageById(id);
 258              }
 259          }, RuntimeException.class);
 260          return storage[0];
 261      }
 262  
 263      @Override
 264      public StaticAssetStorage create() {
 265          return staticAssetStorageDao.create();
 266      }
 267  
 268      @Override
 269      public StaticAssetStorage readStaticAssetStorageByStaticAssetId(final Long id) {
 270          final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 271          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 272              @Override
 273              public void execute() {
 274                  storage[0] = staticAssetStorageDao.readStaticAssetStorageByStaticAssetId(id);
 275              }
 276          }, RuntimeException.class);
 277          return storage[0];
 278      }
 279  
 280      @Override
 281      public StaticAssetStorage save(final StaticAssetStorage assetStorage) {
 282          final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 283          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 284              @Override
 285              public void execute() {
 286                  storage[0] = staticAssetStorageDao.save(assetStorage);
 287              }
 288          }, RuntimeException.class);
 289          return storage[0];
 290      }
 291  
 292      @Override
 293      public void delete(final StaticAssetStorage assetStorage) {
 294          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 295              @Override
 296              public void execute() {
 297                  staticAssetStorageDao.delete(assetStorage);
 298              }
 299          }, RuntimeException.class);
 300      }
 301  
 302      @Override
 303      public Blob createBlob(final MultipartFile uploadedFile) throws IOException {
 304          final Blob[] blob = new Blob[1];
 305          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 306              @Override
 307              public void execute() {
 308                  try {
 309                      blob[0] = staticAssetStorageDao.createBlob(uploadedFile);
 310                  } catch (IOException e) {
 311                      LOG.error(&quot;Unable to create blob from MultipartFile.&quot;, e);
 312                  }
 313              }
 314          }, RuntimeException.class);
 315          return blob[0];
 316      }
 317  
 318      @Override
 319      public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOException {
 320          final Blob[] blob = new Blob[1];
 321          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 322              @Override
 323              public void execute() {
 324                  try {
 325                      blob[0] = staticAssetStorageDao.createBlob(uploadedFileInputStream, fileSize);
 326                  } catch (IOException e) {
 327                      LOG.error(&quot;Unable to create blob from InputStream.&quot;, e);
 328                  }
 329              }
 330          }, RuntimeException.class);
 331          return blob[0];
 332      }
 333  
 334      /**
 335       * Builds a file system path for the passed in static asset and paramaterMap.
 336       *
 337       * @param staticAsset
 338       * @param parameterMap
 339       * @param useSharedFile
 340       * @return
 341       */
 342      protected String constructCacheFileName(StaticAsset staticAsset, Map&lt;String, String&gt; parameterMap) {
 343          String fileName = staticAsset.getFullUrl();
 344  
 345          StringBuilder sb = new StringBuilder(200);
 346          sb.append(fileName.substring(0, fileName.lastIndexOf(&#x27;.&#x27;)));
 347          sb.append(&quot;---&quot;);
 348  
 349          StringBuilder sb2 = new StringBuilder(200);
 350          SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd-HH-mm-ss&quot;);
 351          if (staticAsset instanceof Auditable) {
 352              Auditable auditableStaticAsset = (Auditable) staticAsset;
<abbr title=" 353              sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCreated() : auditableStaticAsset.getDateUpdated()));"> 353              sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCðŸ”µ</abbr>
 354          }
 355  
 356          if (parameterMap != null) {
 357              for (Map.Entry&lt;String, String&gt; entry : parameterMap.entrySet()) {
 358                  sb2.append(&#x27;-&#x27;);
 359                  sb2.append(entry.getKey());
 360                  sb2.append(&#x27;-&#x27;);
 361                  sb2.append(entry.getValue());
 362              }
 363          }
 364  
 365          String digest;
 366          try {
 367              MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);
 368              byte[] messageDigest = md.digest(sb2.toString().getBytes());
 369              BigInteger number = new BigInteger(1,messageDigest);
 370              digest = number.toString(16);
 371          } catch(NoSuchAlgorithmException e) {
 372              throw new RuntimeException(e);
 373          }
 374  
 375          sb.append(pad(digest, 32, &#x27;0&#x27;));
 376          sb.append(fileName.substring(fileName.lastIndexOf(&#x27;.&#x27;)));
 377  
 378          return sb.toString();
 379      }
 380  
 381      protected String pad(String s, int length, char pad) {
 382          StringBuilder buffer = new StringBuilder(s);
 383          while (buffer.length() &lt; length) {
 384              buffer.insert(0, pad);
 385          }
 386          return buffer.toString();
 387      }
 388  
 389      @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)
 390      @Override
 391      public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOException {
 392          createStaticAssetStorage(file.getInputStream(), staticAsset);
 393      }
 394  
 395      @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)
 396      @Override
<abbr title=" 397      public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException {"> 397      public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException ðŸ”µ</abbr>
 398          if (StorageType.DATABASE.equals(staticAsset.getStorageType())) {
 399              StaticAssetStorage storage = create();
 400              storage.setStaticAssetId(staticAsset.getId());
 401              Blob uploadBlob = createBlob(fileInputStream, staticAsset.getFileSize());
 402              storage.setFileData(uploadBlob);
 403              save(storage);
 404          } else if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {
 405              FileWorkArea tempWorkArea = broadleafFileService.initializeWorkArea();
 406              // Convert the given URL from the asset to a system-specific suitable file path
<abbr title=" 407              String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FilenameUtils.separatorsToSystem(staticAsset.getFullUrl()));"> 407              String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FiðŸ”µ</abbr>
 408  
 409              InputStream input = fileInputStream;
 410              byte[] buffer = new byte[getFileBufferSize()];
 411  
 412              File destFile = new File(destFileName);
 413              if (!destFile.getParentFile().exists()) {
 414                  if (!destFile.getParentFile().mkdirs()) {
 415                      if (!destFile.getParentFile().exists()) {
<abbr title=" 416                          throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileName);"> 416                          throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileNameðŸ”µ</abbr>
 417                      }
 418                  }
 419              }
 420  
 421              OutputStream output = new FileOutputStream(destFile);
 422              long maxFileSize = getMaxUploadSizeForFile(destFileName);
 423              try {
 424                  int bytesRead;
 425                  int totalBytesRead = 0;
 426                  while ((bytesRead = input.read(buffer)) != -1) {
 427                      totalBytesRead += bytesRead;
 428                      if (totalBytesRead &gt; maxFileSize) {
 429                          throw new IOException(&quot;Maximum Upload File Size Exceeded&quot;);
 430                      }
 431                      output.write(buffer, 0, bytesRead);
 432                  }
 433  
 434                  // close the output file stream prior to moving files around
 435                  output.close();
 436                  broadleafFileService.addOrUpdateResource(tempWorkArea, destFile, false);
 437              } finally {
 438                  IOUtils.closeQuietly(output);
 439                  broadleafFileService.closeWorkArea(tempWorkArea);
 440              }
 441          }
 442      }
 443  
 444      protected long getMaxUploadSizeForFile(String fileName) {
 445          if (isImageFile(fileName)) {
 446              return getMaxUploadableImageSize();
 447          }
 448  
 449          return getMaxUploadableFileSize();
 450      }
 451  
 452      protected boolean isImageFile(String fileName) {
 453          String extension = getFileExtension(fileName);
 454  
 455          for (String imageFileExtension : getAdminImageFileExtensions()) {
 456              if (imageFileExtension.equalsIgnoreCase(extension)) {
 457                  return true;
 458              }
 459          }
 460  
 461          return false;
 462      }
 463  
 464      protected String getFileExtension(String assetPath) {
 465          int extensionStartIndex = assetPath.lastIndexOf(&quot;.&quot;) + 1;
 466          return assetPath.substring(extensionStartIndex);
 467      }
 468  
 469      protected long getMaxUploadableFileSize() {
 470          Long blcUploadSize = env.getProperty(&quot;asset.server.max.uploadable.file.size&quot;, Long.class);
 471          if (blcUploadSize != null) {
 472              return blcUploadSize;
 473          }
 474  
 475          if (defaultMultipartSettings != null) {
 476              return defaultMultipartSettings.createMultipartConfig().getMaxFileSize();
 477          }
 478          return DEFAULT_ASSET_UPLOAD_SIZE;
 479      }
 480  
 481      protected long getMaxUploadableImageSize() {
 482          // backwards-compatibility checks, only use the image-size specific property if it is
 483          // not the default value. Otherwise, delegate to the old property
 484          Long maxImgSize = env.getProperty(&quot;asset.server.max.uploadable.image.size&quot;, Long.class);
 485          if (maxImgSize == null) {
 486              return getMaxUploadableFileSize();
 487          } else {
 488              return maxImgSize;
 489          }
 490      }
 491  
 492      protected int getFileBufferSize() {
 493          return env.getProperty(&quot;asset.server.file.buffer.size&quot;, int.class, DEFAULT_BUFFER_SIZE);
 494      }
 495  
 496      protected List&lt;String&gt; getAdminImageFileExtensions() {
<abbr title=" 497          String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENSIONS);"> 497          String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENðŸ”µ</abbr>
 498          return Arrays.asList(extensions.split(&quot;,&quot;));
 499      }
 500  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce CMS Module
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.cms.file.service;
  19  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import org.apache.commons.collections4.MapUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import org.apache.commons.io.FileExistsException;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.apache.commons.io.FileUtils;</span>
  23  import org.apache.commons.io.FilenameUtils;
  24  import org.apache.commons.io.IOUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import org.apache.commons.lang.ArrayUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import org.apache.commons.lang3.StringUtils;</span>
  27  import org.apache.commons.logging.Log;
  28  import org.apache.commons.logging.LogFactory;
  29  import org.broadleafcommerce.cms.common.AssetNotFoundException;
  30  import org.broadleafcommerce.cms.field.type.StorageType;
  31  import org.broadleafcommerce.cms.file.dao.StaticAssetStorageDao;
  32  import org.broadleafcommerce.cms.file.domain.StaticAsset;
  33  import org.broadleafcommerce.cms.file.domain.StaticAssetStorage;
  34  import org.broadleafcommerce.cms.file.service.operation.NamedOperationManager;
  35  import org.broadleafcommerce.common.audit.Auditable;
  36  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  37  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  38  import org.broadleafcommerce.common.file.domain.FileWorkArea;
  39  import org.broadleafcommerce.common.file.service.BroadleafFileService;
  40  import org.broadleafcommerce.common.file.service.GloballySharedInputStream;
  41  import org.broadleafcommerce.common.io.ConcurrentFileOutputStream;
  42  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;
  43  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;
  44  import org.broadleafcommerce.openadmin.server.service.artifact.ArtifactService;
  45  import org.broadleafcommerce.openadmin.server.service.artifact.image.Operation;
  46  import org.springframework.beans.factory.annotation.Autowired;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import org.springframework.beans.factory.annotation.Value;</span>
  48  import org.springframework.boot.autoconfigure.web.MultipartProperties;

  49  import org.springframework.core.env.Environment;
  50  import org.springframework.stereotype.Service;
  51  import org.springframework.transaction.annotation.Transactional;
  52  import org.springframework.web.multipart.MultipartFile;
  53  
  54  import java.io.BufferedInputStream;
  55  import java.io.File;
  56  import java.io.FileInputStream;
  57  import java.io.FileOutputStream;
  58  import java.io.IOException;
  59  import java.io.InputStream;
  60  import java.io.OutputStream;
  61  import java.math.BigInteger;
  62  import java.security.MessageDigest;
  63  import java.security.NoSuchAlgorithmException;
  64  import java.sql.Blob;
  65  import java.sql.SQLException;
  66  import java.text.SimpleDateFormat;
  67  import java.util.Arrays;
  68  import java.util.HashMap;
  69  import java.util.List;
  70  import java.util.Map;
  71  
  72  import javax.annotation.Resource;
  73  
  74  /**
  75   * @author Jeff Fischer, Brian Polster
  76   */
  77  @Service(&quot;blStaticAssetStorageService&quot;)
  78  public class StaticAssetStorageServiceImpl implements StaticAssetStorageService {
  79  
  80      private static final Log LOG = LogFactory.getLog(StaticAssetStorageServiceImpl.class);
  81  
  82      protected static final String DEFAULT_ADMIN_IMAGE_EXTENSIONS = &quot;bmp,jpg,jpeg,png,img,tiff,gif&quot;;
  83  
  84      public static final long DEFAULT_ASSET_UPLOAD_SIZE = 1024 * 1024 * 10;
  85  
  86      // 8kb default for the buffer for moving files around
  87      protected static final int DEFAULT_BUFFER_SIZE = 8096;
  88  
  89      protected String cacheDirectory;
  90  
  91      @Autowired
  92      protected Environment env;
  93  
  94      @Resource(name=&quot;blStaticAssetService&quot;)
  95      protected StaticAssetService staticAssetService;
  96  
  97      @Resource(name = &quot;blFileService&quot;)
  98      protected BroadleafFileService broadleafFileService;
  99  
 100      @Resource(name=&quot;blArtifactService&quot;)
 101      protected ArtifactService artifactService;
 102  
 103      @Resource(name=&quot;blStaticAssetStorageDao&quot;)
 104      protected StaticAssetStorageDao staticAssetStorageDao;
 105  
 106      @Resource(name=&quot;blNamedOperationManager&quot;)
 107      protected NamedOperationManager namedOperationManager;
 108  
 109      @Resource(name = &quot;blStaticAssetServiceExtensionManager&quot;)
 110      protected StaticAssetServiceExtensionManager extensionManager;
 111  
 112      @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)
 113      protected StreamingTransactionCapableUtil transUtil;
 114  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +    @Value(&quot;${image.artifact.recompress.formats:png}&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +    protected String recompressFormats = &quot;png&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +</span>
 118      @Autowired(required = false)
 119      protected MultipartProperties defaultMultipartSettings;
 120  
 121      @Resource(name = &quot;blConcurrentFileOutputStream&quot;)
 122      protected ConcurrentFileOutputStream concurrentFileOutputStream;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +</span>
 124  
 125      protected StaticAsset findStaticAsset(String fullUrl) {
 126          StaticAsset staticAsset = staticAssetService.findStaticAssetByFullUrl(fullUrl);
 127  
 128          return staticAsset;
 129      }
 130  
 131      protected boolean shouldUseSharedFile(InputStream is) {
 132          return (is != null &amp;&amp; is instanceof GloballySharedInputStream);
 133      }
 134  
 135      protected File getFileFromLocalRepository(String cachedFileName) {
 136          // Look for a shared file (this represents a file that was based on a file originally in the classpath.
 137          File cacheFile = null;
 138          if (extensionManager != null) {
 139              ExtensionResultHolder holder = new ExtensionResultHolder();
 140              ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holder);
 141              if (ExtensionResultStatusType.HANDLED.equals(result)) {
 142                  cacheFile = (File) holder.getResult();
 143              }
 144          }
 145          if (cacheFile == null) {
 146              cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);
 147          }
 148          if (cacheFile.exists()) {
 149              return cacheFile;
 150          } else {
 151              return broadleafFileService.getLocalResource(cachedFileName);
 152          }
 153      }
 154  
 155      protected File lookupAssetAndCreateLocalFile(StaticAsset staticAsset, File baseLocalFile)
 156              throws IOException, SQLException {
 157          if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {
 158              File returnFile = broadleafFileService.getResource(staticAsset.getFullUrl());
 159              if (!returnFile.getAbsolutePath().equals(baseLocalFile.getAbsolutePath())) {
 160                  createLocalFileFromInputStream(new FileInputStream(returnFile), baseLocalFile);
 161              }
 162              return broadleafFileService.getResource(staticAsset.getFullUrl());
 163          } else {
 164              StaticAssetStorage storage = readStaticAssetStorageByStaticAssetId(staticAsset.getId());
 165              if (storage != null) {
 166                  InputStream is = storage.getFileData().getBinaryStream();
 167                  createLocalFileFromInputStream(is, baseLocalFile);
 168              }
 169          }
 170          return baseLocalFile;
 171      }
 172  
<abbr title=" 173      protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOException {"> 173      protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOExceðŸ”µ</abbr>
 174          InputStream is = broadleafFileService.getClasspathResource(staticAsset.getFullUrl());
 175          createLocalFileFromInputStream(is, baseLocalFile);
 176      }
 177  
 178      protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException {
 179          try {
 180              if (!baseLocalFile.getParentFile().exists()) {
 181                  boolean directoriesCreated = false;
 182                  if (!baseLocalFile.getParentFile().exists()) {
 183                      directoriesCreated = baseLocalFile.getParentFile().mkdirs();
 184                      if (!directoriesCreated) {
 185                          // There is a chance that another VM created the directories.   If not, we may not have
 186                          // proper permissions and this is an error we need to report.
 187                          if (!baseLocalFile.getParentFile().exists()) {
 188                              throw new RuntimeException(&quot;Unable to create middle directories for file: &quot; +
 189                                      baseLocalFile.getAbsolutePath());
 190                          }
 191                      }
 192                  }
 193              }
 194  
 195              concurrentFileOutputStream.write(is, baseLocalFile);
 196  
 197          } finally {
 198              IOUtils.closeQuietly(is);
 199          }
 200      }
 201  
 202      @Override
<abbr title=" 203      public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws Exception {"> 203      public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws ExceptioðŸ”µ</abbr>
 204          StaticAsset staticAsset = findStaticAsset(fullUrl);
 205          if (staticAsset == null) {
 206              throw new AssetNotFoundException(&quot;Unable to find an asset for the url (&quot; + fullUrl + &quot;)&quot;);
 207          }
 208          String mimeType = staticAsset.getMimeType();
 209  
 210          //extract the values for any named parameters
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +        boolean shouldRecompress = shouldRecompress(mimeType);</span>
 212          Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMap);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +        if (shouldRecompress &amp;&amp; MapUtils.isEmpty(convertedParameters)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +            convertedParameters.put(&quot;recompress&quot;,&quot;true&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +        }</span>
 216          String cachedFileName = constructCacheFileName(staticAsset, convertedParameters);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +        if (shouldRecompress) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +            convertedParameters.remove(&quot;recompress&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +        }</span>
 221  
 222          // Look for a shared file (this represents a file that was based on a file originally in the classpath.
 223          File cacheFile = getFileFromLocalRepository(cachedFileName);
 224          if (cacheFile.exists()) {
 225              return buildModel(cacheFile.getAbsolutePath(), mimeType);
 226          }
 227  
 228          // Obtain the base file (that we may need to convert based on the parameters
 229          String baseCachedFileName = constructCacheFileName(staticAsset, null);
 230          File baseLocalFile = getFileFromLocalRepository(baseCachedFileName);
 231  
 232          if (! baseLocalFile.exists()) {
 233              if (broadleafFileService.checkForResourceOnClassPath(staticAsset.getFullUrl())) {
 234                  cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);
 235                  baseLocalFile = broadleafFileService.getSharedLocalResource(baseCachedFileName);
 236                  createLocalFileFromClassPathResource(staticAsset, baseLocalFile);
 237              } else {
 238                  baseLocalFile = lookupAssetAndCreateLocalFile(staticAsset, baseLocalFile);
 239              }
 240          }
 241  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -        if (convertedParameters.isEmpty()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +        if (!shouldRecompress &amp;&amp; convertedParameters.isEmpty()) {</span>
 245              return buildModel(baseLocalFile.getAbsolutePath(), mimeType);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +        else {</span>
 249              FileInputStream assetStream = new FileInputStream(baseLocalFile);
 250              BufferedInputStream original = new BufferedInputStream(assetStream);
 251              original.mark(0);
 252  
<abbr title=" 253              Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.getMimeType());"> 253              Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.geðŸ”µ</abbr>
 254              InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeType());
 255  
 256              createLocalFileFromInputStream(converted, cacheFile);
 257              if (&quot;image/gif&quot;.equals(mimeType)) {
 258                  mimeType = &quot;image/png&quot;;
 259              }
 260              return buildModel(cacheFile.getAbsolutePath(), mimeType);
 261          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +    protected boolean shouldRecompress(String mimeType) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +        String[] formats = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +        if (!StringUtils.isEmpty(recompressFormats)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +            formats = recompressFormats.split(&quot;,&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +        boolean response = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +        if (!ArrayUtils.isEmpty(formats)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +            for (String format : formats) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +                if (mimeType.toLowerCase().contains(format.toLowerCase())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +                    response = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +        return response;</span>
 279      }
 280  
 281      protected Map&lt;String, String&gt; buildModel(String returnFilePath, String mimeType) {
 282          Map&lt;String, String&gt; model = new HashMap&lt;String, String&gt;(2);
 283          model.put(&quot;cacheFilePath&quot;, returnFilePath);
 284          model.put(&quot;mimeType&quot;, mimeType);
 285  
 286          return model;
 287      }
 288  
 289      @Override
 290      public StaticAssetStorage findStaticAssetStorageById(final Long id) {
 291          final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 292          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 293              @Override
 294              public void execute() {
 295                  storage[0] = staticAssetStorageDao.readStaticAssetStorageById(id);
 296              }
 297          }, RuntimeException.class);
 298          return storage[0];
 299      }
 300  
 301      @Override
 302      public StaticAssetStorage create() {
 303          return staticAssetStorageDao.create();
 304      }
 305  
 306      @Override
 307      public StaticAssetStorage readStaticAssetStorageByStaticAssetId(final Long id) {
 308          final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 309          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 310              @Override
 311              public void execute() {
 312                  storage[0] = staticAssetStorageDao.readStaticAssetStorageByStaticAssetId(id);
 313              }
 314          }, RuntimeException.class);
 315          return storage[0];
 316      }
 317  
 318      @Override
 319      public StaticAssetStorage save(final StaticAssetStorage assetStorage) {
 320          final StaticAssetStorage[] storage = new StaticAssetStorage[1];
 321          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 322              @Override
 323              public void execute() {
 324                  storage[0] = staticAssetStorageDao.save(assetStorage);
 325              }
 326          }, RuntimeException.class);
 327          return storage[0];
 328      }
 329  
 330      @Override
 331      public void delete(final StaticAssetStorage assetStorage) {
 332          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 333              @Override
 334              public void execute() {
 335                  staticAssetStorageDao.delete(assetStorage);
 336              }
 337          }, RuntimeException.class);
 338      }
 339  
 340      @Override
 341      public Blob createBlob(final MultipartFile uploadedFile) throws IOException {
 342          final Blob[] blob = new Blob[1];
 343          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 344              @Override
 345              public void execute() {
 346                  try {
 347                      blob[0] = staticAssetStorageDao.createBlob(uploadedFile);
 348                  } catch (IOException e) {
 349                      LOG.error(&quot;Unable to create blob from MultipartFile.&quot;, e);
 350                  }
 351              }
 352          }, RuntimeException.class);
 353          return blob[0];
 354      }
 355  
 356      @Override
 357      public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOException {
 358          final Blob[] blob = new Blob[1];
 359          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {
 360              @Override
 361              public void execute() {
 362                  try {
 363                      blob[0] = staticAssetStorageDao.createBlob(uploadedFileInputStream, fileSize);
 364                  } catch (IOException e) {
 365                      LOG.error(&quot;Unable to create blob from InputStream.&quot;, e);
 366                  }
 367              }
 368          }, RuntimeException.class);
 369          return blob[0];
 370      }
 371  
 372      /**
 373       * Builds a file system path for the passed in static asset and paramaterMap.
 374       *
 375       * @param staticAsset
 376       * @param parameterMap
 377       * @param useSharedFile
 378       * @return
 379       */
 380      protected String constructCacheFileName(StaticAsset staticAsset, Map&lt;String, String&gt; parameterMap) {
 381          String fileName = staticAsset.getFullUrl();
 382  
 383          StringBuilder sb = new StringBuilder(200);
 384          sb.append(fileName.substring(0, fileName.lastIndexOf(&#x27;.&#x27;)));
 385          sb.append(&quot;---&quot;);
 386  
 387          StringBuilder sb2 = new StringBuilder(200);
 388          SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd-HH-mm-ss&quot;);
 389          if (staticAsset instanceof Auditable) {
 390              Auditable auditableStaticAsset = (Auditable) staticAsset;
<abbr title=" 391              sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCreated() : auditableStaticAsset.getDateUpdated()));"> 391              sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCðŸ”µ</abbr>
 392          }
 393  
 394          if (parameterMap != null) {
 395              for (Map.Entry&lt;String, String&gt; entry : parameterMap.entrySet()) {
 396                  sb2.append(&#x27;-&#x27;);
 397                  sb2.append(entry.getKey());
 398                  sb2.append(&#x27;-&#x27;);
 399                  sb2.append(entry.getValue());
 400              }
 401          }
 402  
 403          String digest;
 404          try {
 405              MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);
 406              byte[] messageDigest = md.digest(sb2.toString().getBytes());
 407              BigInteger number = new BigInteger(1,messageDigest);
 408              digest = number.toString(16);
 409          } catch(NoSuchAlgorithmException e) {
 410              throw new RuntimeException(e);
 411          }
 412  
 413          sb.append(pad(digest, 32, &#x27;0&#x27;));
 414          sb.append(fileName.substring(fileName.lastIndexOf(&#x27;.&#x27;)));
 415  
 416          return sb.toString();
 417      }
 418  
 419      protected String pad(String s, int length, char pad) {
 420          StringBuilder buffer = new StringBuilder(s);
 421          while (buffer.length() &lt; length) {
 422              buffer.insert(0, pad);
 423          }
 424          return buffer.toString();
 425      }
 426  
 427      @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)
 428      @Override
 429      public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOException {
 430          createStaticAssetStorage(file.getInputStream(), staticAsset);
 431      }
 432  
 433      @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)
 434      @Override
<abbr title=" 435      public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException {"> 435      public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException ðŸ”µ</abbr>
 436          if (StorageType.DATABASE.equals(staticAsset.getStorageType())) {
 437              StaticAssetStorage storage = create();
 438              storage.setStaticAssetId(staticAsset.getId());
 439              Blob uploadBlob = createBlob(fileInputStream, staticAsset.getFileSize());
 440              storage.setFileData(uploadBlob);
 441              save(storage);
 442          } else if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {
 443              FileWorkArea tempWorkArea = broadleafFileService.initializeWorkArea();
 444              // Convert the given URL from the asset to a system-specific suitable file path
<abbr title=" 445              String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FilenameUtils.separatorsToSystem(staticAsset.getFullUrl()));"> 445              String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FiðŸ”µ</abbr>
 446  
 447              InputStream input = fileInputStream;
 448              byte[] buffer = new byte[getFileBufferSize()];
 449  
 450              File destFile = new File(destFileName);
 451              if (!destFile.getParentFile().exists()) {
 452                  if (!destFile.getParentFile().mkdirs()) {
 453                      if (!destFile.getParentFile().exists()) {
<abbr title=" 454                          throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileName);"> 454                          throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileNameðŸ”µ</abbr>
 455                      }
 456                  }
 457              }
 458  
 459              OutputStream output = new FileOutputStream(destFile);
 460              long maxFileSize = getMaxUploadSizeForFile(destFileName);
 461              try {
 462                  int bytesRead;
 463                  int totalBytesRead = 0;
 464                  while ((bytesRead = input.read(buffer)) != -1) {
 465                      totalBytesRead += bytesRead;
 466                      if (totalBytesRead &gt; maxFileSize) {
 467                          throw new IOException(&quot;Maximum Upload File Size Exceeded&quot;);
 468                      }
 469                      output.write(buffer, 0, bytesRead);
 470                  }
 471  
 472                  // close the output file stream prior to moving files around
 473                  output.close();
 474                  broadleafFileService.addOrUpdateResource(tempWorkArea, destFile, false);
 475              } finally {
 476                  IOUtils.closeQuietly(output);
 477                  broadleafFileService.closeWorkArea(tempWorkArea);
 478              }
 479          }
 480      }
 481  
 482      protected long getMaxUploadSizeForFile(String fileName) {
 483          if (isImageFile(fileName)) {
 484              return getMaxUploadableImageSize();
 485          }
 486  
 487          return getMaxUploadableFileSize();
 488      }
 489  
 490      protected boolean isImageFile(String fileName) {
 491          String extension = getFileExtension(fileName);
 492  
 493          for (String imageFileExtension : getAdminImageFileExtensions()) {
 494              if (imageFileExtension.equalsIgnoreCase(extension)) {
 495                  return true;
 496              }
 497          }
 498  
 499          return false;
 500      }
 501  
 502      protected String getFileExtension(String assetPath) {
 503          int extensionStartIndex = assetPath.lastIndexOf(&quot;.&quot;) + 1;
 504          return assetPath.substring(extensionStartIndex);
 505      }
 506  
 507      protected long getMaxUploadableFileSize() {
 508          Long blcUploadSize = env.getProperty(&quot;asset.server.max.uploadable.file.size&quot;, Long.class);
 509          if (blcUploadSize != null) {
 510              return blcUploadSize;
 511          }
 512  
 513          if (defaultMultipartSettings != null) {
 514              return defaultMultipartSettings.createMultipartConfig().getMaxFileSize();
 515          }
 516          return DEFAULT_ASSET_UPLOAD_SIZE;
 517      }
 518  
 519      protected long getMaxUploadableImageSize() {
 520          // backwards-compatibility checks, only use the image-size specific property if it is
 521          // not the default value. Otherwise, delegate to the old property
 522          Long maxImgSize = env.getProperty(&quot;asset.server.max.uploadable.image.size&quot;, Long.class);
 523          if (maxImgSize == null) {
 524              return getMaxUploadableFileSize();
 525          } else {
 526              return maxImgSize;
 527          }
 528      }
 529  
 530      protected int getFileBufferSize() {
 531          return env.getProperty(&quot;asset.server.file.buffer.size&quot;, int.class, DEFAULT_BUFFER_SIZE);
 532      }
 533  
 534      protected List&lt;String&gt; getAdminImageFileExtensions() {
<abbr title=" 535          String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENSIONS);"> 535          String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENðŸ”µ</abbr>
 536          return Arrays.asList(extensions.split(&quot;,&quot;));
 537      }
 538  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            