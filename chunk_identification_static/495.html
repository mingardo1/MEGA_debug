<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>495</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    495
                    <a href="494.html">prev</a>
                    <a href="496.html">next</a>
                    <a href="495_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    CyanogenMod/android_packages_apps_Trebuchet_8ffe7b76acda07a09a9c2a9eec1eb3d0c1542763_src/com/android/launcher3/LauncherClings.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;8ffe7b76acda07a09a9c2a9eec1eb3d0c1542763:src/com/android/launcher3/LauncherClings.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;8ffe7b76acda07a09a9c2a9eec1eb3d0c1542763^1:src/com/android/launcher3/LauncherClings.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;8ffe7b76acda07a09a9c2a9eec1eb3d0c1542763^2:src/com/android/launcher3/LauncherClings.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;c83d136ce4a7bde768cbea4d4b263ab6e4eaa9f1:src/com/android/launcher3/LauncherClings.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s], [s]], subset: [[sbj], [s]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Copyright (C) 2008 The Android Open Source Project
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.android.launcher3;
  18 
  19 import android.accounts.Account;
  20 import android.accounts.AccountManager;
  21 import android.animation.Animator;
  22 import android.animation.AnimatorListenerAdapter;
  23 import android.app.ActivityManager;
  24 import android.content.Context;
  25 import android.content.SharedPreferences;
  26 import android.graphics.Rect;
  27 import android.os.Bundle;
  28 import android.os.UserManager;
  29 import android.view.LayoutInflater;
  30 import android.view.View;
  31 import android.view.ViewGroup;
  32 import android.view.accessibility.AccessibilityManager;
  33 import android.widget.TextView;
  34 
  35 class LauncherClings {
  36     private static final String FIRST_RUN_CLING_DISMISSED_KEY = &quot;cling_gel.first_run.dismissed&quot;;
  37     private static final String MIGRATION_CLING_DISMISSED_KEY = &quot;cling_gel.migration.dismissed&quot;;
  38     private static final String MIGRATION_WORKSPACE_CLING_DISMISSED_KEY =
  39             &quot;cling_gel.migration_workspace.dismissed&quot;;
  40     private static final String WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.workspace.dismissed&quot;;
  41     private static final String FOLDER_CLING_DISMISSED_KEY = &quot;cling_gel.folder.dismissed&quot;;
  42 
  43     private static final boolean DISABLE_CLINGS = false;
  44     private static final boolean DISABLE_CUSTOM_CLINGS = true;
  45 
  46     private static final int SHOW_CLING_DURATION = 250;
  47     private static final int DISMISS_CLING_DURATION = 200;
  48 
  49     private Launcher mLauncher;
  50     private LayoutInflater mInflater;
  51     private HideFromAccessibilityHelper mHideFromAccessibilityHelper
  52             = new HideFromAccessibilityHelper();
  53 
  54     /** Ctor */
  55     public LauncherClings(Launcher launcher) {
  56         mLauncher = launcher;
  57         mInflater = mLauncher.getLayoutInflater();
  58     }
  59 
  60     /** Initializes a cling */
  61     private Cling initCling(int clingId, int scrimId, boolean animate,
  62                             boolean dimNavBarVisibilty) {
  63         Cling cling = (Cling) mLauncher.findViewById(clingId);
  64         View scrim = null;
  65         if (scrimId &gt; 0) {
  66             scrim = mLauncher.findViewById(scrimId);
  67         }
  68         if (cling != null) {
  69             cling.init(mLauncher, scrim);
  70             cling.show(animate, SHOW_CLING_DURATION);
  71 
  72             if (dimNavBarVisibilty) {
  73                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() |
  74                         View.SYSTEM_UI_FLAG_LOW_PROFILE);
  75             }
  76         }
  77         return cling;
  78     }
  79 
  80     /** Returns whether the clings are enabled or should be shown */
  81     private boolean areClingsEnabled() {
  82         if (DISABLE_CLINGS) {
  83             return false;
  84         }
  85 
  86         // disable clings when running in a test harness
  87         if(ActivityManager.isRunningInTestHarness()) return false;
  88 
  89         // Disable clings for accessibility when explore by touch is enabled
  90         final AccessibilityManager a11yManager = (AccessibilityManager) mLauncher.getSystemService(
  91                 Launcher.ACCESSIBILITY_SERVICE);
  92         if (a11yManager.isTouchExplorationEnabled()) {
  93             return false;
  94         }
  95 
  96         // Restricted secondary users (child mode) will potentially have very few apps
  97         // seeded when they start up for the first time. Clings won&#x27;t work well with that
  98         boolean supportsLimitedUsers =
  99                 android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.JELLY_BEAN_MR2;
 100         Account[] accounts = AccountManager.get(mLauncher).getAccounts();
 101         if (supportsLimitedUsers &amp;&amp; accounts.length == 0) {
 102             UserManager um = (UserManager) mLauncher.getSystemService(Context.USER_SERVICE);
 103             Bundle restrictions = um.getUserRestrictions();
 104             if (restrictions.getBoolean(UserManager.DISALLOW_MODIFY_ACCOUNTS, false)) {
 105                 return false;
 106             }
 107         }
 108         return true;
 109     }
 110 
 111     /** Returns whether the folder cling is visible. */
 112     public boolean isFolderClingVisible() {
 113         Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 114         if (cling != null) {
 115             return cling.getVisibility() == View.VISIBLE;
 116         }
 117         return false;
 118     }
 119 
 120     private boolean skipCustomClingIfNoAccounts() {
 121         Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 122         boolean customCling = cling.getDrawIdentifier().equals(&quot;workspace_custom&quot;);
 123         if (customCling) {
 124             AccountManager am = AccountManager.get(mLauncher);
 125             if (am == null) return false;
 126             Account[] accounts = am.getAccountsByType(&quot;com.google&quot;);
 127             return accounts.length == 0;
 128         }
 129         return false;
 130     }
 131 
 132     /** Updates the first run cling custom content hint */
 133     private void setCustomContentHintVisibility(Cling cling, String ccHintStr, boolean visible,
 134                                                 boolean animate) {
 135         final TextView ccHint = (TextView) cling.findViewById(R.id.custom_content_hint);
 136         if (ccHint != null) {
 137             if (visible &amp;&amp; !ccHintStr.isEmpty()) {
 138                 ccHint.setText(ccHintStr);
 139                 ccHint.setVisibility(View.VISIBLE);
 140                 if (animate) {
 141                     ccHint.setAlpha(0f);
 142                     ccHint.animate().alpha(1f)
 143                             .setDuration(SHOW_CLING_DURATION)
 144                             .start();
 145                 } else {
 146                     ccHint.setAlpha(1f);
 147                 }
 148             } else {
 149                 if (animate) {
 150                     ccHint.animate().alpha(0f)
 151                             .setDuration(SHOW_CLING_DURATION)
 152                             .setListener(new AnimatorListenerAdapter() {
 153                                 @Override
 154                                 public void onAnimationEnd(Animator animation) {
 155                                     ccHint.setVisibility(View.GONE);
 156                                 }
 157                             })
 158                             .start();
 159                 } else {
 160                     ccHint.setAlpha(0f);
 161                     ccHint.setVisibility(View.GONE);
 162                 }
 163             }
 164         }
 165     }
 166 
 167     /** Updates the first run cling custom content hint */
 168     public void updateCustomContentHintVisibility() {
 169         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 170         String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 171 
 172         if (mLauncher.getWorkspace().hasCustomContent()) {
 173             // Show the custom content hint if ccHintStr is not empty
 174             if (cling != null) {
 175                 setCustomContentHintVisibility(cling, ccHintStr, true, true);
 176             }
 177         } else {
 178             // Hide the custom content hint
 179             if (cling != null) {
 180                 setCustomContentHintVisibility(cling, ccHintStr, false, true);
 181             }
 182         }
 183     }
 184 
 185     /** Updates the first run cling search bar hint. */
 186     public void updateSearchBarHint(String hint) {
 187         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 188         if (cling != null &amp;&amp; cling.getVisibility() == View.VISIBLE &amp;&amp; !hint.isEmpty()) {
 189             TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 190             sbHint.setText(hint);
 191             sbHint.setVisibility(View.VISIBLE);
 192         }
 193     }
 194 
 195     public boolean shouldShowFirstRunOrMigrationClings() {
 196         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 197 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198         return isClingsEnabled() &amp;&amp;</span>
 199 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200             TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201             sbHint.setText(hint);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202             sbHint.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206     /** Shows the first run cling */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207     public void showFirstRunCling() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();</span>
 209 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210         return areClingsEnabled() &amp;&amp;</span>
 211 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 212             !sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false) &amp;&amp;
 213             !sharedPrefs.getBoolean(MIGRATION_CLING_DISMISSED_KEY, false);
 214     }
 215 
 216     public void removeFirstRunAndMigrationClings() {
 217         removeCling(R.id.first_run_cling);
 218         removeCling(R.id.migration_cling);
 219     }
 220 
 221     /**
 222      * Shows the first run cling.
 223      *
 224      * This flow is mutually exclusive with showMigrationCling, and only runs if this Launcher
 225      * package was preinstalled or there is no db to migrate from.
 226      */
 227     public void showFirstRunCling() {
 228         if (!skipCustomClingIfNoAccounts()) {
 229             SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 230             // If we&#x27;re not using the default workspace layout, replace workspace cling
 231             // with a custom workspace cling (usually specified in an overlay)
 232             // For now, only do this on tablets
 233             if (!DISABLE_CUSTOM_CLINGS) {
 234                 if (sharedPrefs.getInt(LauncherProvider.DEFAULT_WORKSPACE_RESOURCE_ID, 0) != 0 &amp;&amp;
 235                         mLauncher.getResources().getBoolean(R.bool.config_useCustomClings)) {
 236                     // Use a custom cling
 237                     View cling = mLauncher.findViewById(R.id.workspace_cling);
 238                     ViewGroup clingParent = (ViewGroup) cling.getParent();
 239                     int clingIndex = clingParent.indexOfChild(cling);
 240                     clingParent.removeViewAt(clingIndex);
 241                     View customCling = mInflater.inflate(R.layout.custom_workspace_cling,
 242                             clingParent, false);
 243                     clingParent.addView(customCling, clingIndex);
 244                     customCling.setId(R.id.workspace_cling);
 245                 }
 246             }
 247             Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 248             if (cling != null) {
 249                 String sbHintStr = mLauncher.getFirstRunClingSearchBarHint();
 250                 String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 251                 if (!sbHintStr.isEmpty()) {
 252                     TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 253                     sbHint.setText(sbHintStr);
 254                     sbHint.setVisibility(View.VISIBLE);
 255                 }
 256                 setCustomContentHintVisibility(cling, ccHintStr, true, false);
 257             }
 258             initCling(R.id.first_run_cling, 0, false, true);
 259         } else {
 260             removeFirstRunAndMigrationClings();
 261         }
 262     }
 263 
 264     /**
 265      * Shows the migration cling.
 266      *
 267      * This flow is mutually exclusive with showFirstRunCling, and only runs if this Launcher
 268      * package was not preinstalled and there exists a db to migrate from.
 269      */
 270     public void showMigrationCling() {
 271         mLauncher.hideWorkspaceSearchAndHotseat();
 272 
 273         Cling c = initCling(R.id.migration_cling, 0, false, true);
 274         c.bringScrimToFront();
 275         c.bringToFront();
 276     }
 277 
 278     public void showMigrationWorkspaceCling() {
 279         // Enable the clings only if they have not been dismissed before
 280         if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 281                 MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, false)) {
 282             Cling c = initCling(R.id.migration_workspace_cling, 0, false, true);
 283             c.updateMigrationWorkspaceBubblePosition();
 284             c.bringScrimToFront();
 285             c.bringToFront();
 286         } else {
 287             removeCling(R.id.migration_workspace_cling);
 288         }
 289     }
 290 
 291     public void showWorkspaceCling() {
 292         // Enable the clings only if they have not been dismissed before
 293         if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 294                 WORKSPACE_CLING_DISMISSED_KEY, false)) {
 295             Cling c = initCling(R.id.workspace_cling, 0, false, true);
 296             c.updateWorkspaceBubblePosition();
 297 
 298             // Set the focused hotseat app if there is one
 299             c.setFocusedHotseatApp(mLauncher.getFirstRunFocusedHotseatAppDrawableId(),
 300                     mLauncher.getFirstRunFocusedHotseatAppRank(),
 301                     mLauncher.getFirstRunFocusedHotseatAppComponentName(),
 302                     mLauncher.getFirstRunFocusedHotseatAppBubbleTitle(),
 303                     mLauncher.getFirstRunFocusedHotseatAppBubbleDescription());
 304         } else {
 305             removeCling(R.id.workspace_cling);
 306         }
 307     }
 308     public Cling showFoldersCling() {
 309         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 310         // Enable the clings only if they have not been dismissed before
 311         if (areClingsEnabled() &amp;&amp;
 312                 !sharedPrefs.getBoolean(FOLDER_CLING_DISMISSED_KEY, false) &amp;&amp;
 313                 !sharedPrefs.getBoolean(Launcher.USER_HAS_MIGRATED, false)) {
 314             Cling cling = initCling(R.id.folder_cling, R.id.cling_scrim,
 315                     true, true);
 316             Folder openFolder = mLauncher.getWorkspace().getOpenFolder();
 317             if (openFolder != null) {
 318                 Rect openFolderRect = new Rect();
 319                 openFolder.getHitRect(openFolderRect);
 320                 cling.setOpenFolderRect(openFolderRect);
 321                 openFolder.bringToFront();
 322             }
 323             return cling;
 324         } else {
 325             removeCling(R.id.folder_cling);
 326             return null;
 327         }
 328     }
 329 
 330     /** Removes the cling outright from the DragLayer */
 331     private void removeCling(int id) {
 332         final View cling = mLauncher.findViewById(id);
 333         if (cling != null) {
 334             final ViewGroup parent = (ViewGroup) cling.getParent();
 335             parent.post(new Runnable() {
 336                 @Override
 337                 public void run() {
 338                     parent.removeView(cling);
 339                 }
 340             });
 341             mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 342         }
 343     }
 344 
 345     /** Hides the specified Cling */
 346     private void dismissCling(final Cling cling, final Runnable postAnimationCb,
 347                               final String flag, int duration, boolean restoreNavBarVisibilty) {
 348         // To catch cases where siblings of top-level views are made invisible, just check whether
 349         // the cling is directly set to GONE before dismissing it.
 350         if (cling != null &amp;&amp; cling.getVisibility() != View.GONE) {
 351             final Runnable cleanUpClingCb = new Runnable() {
 352                 public void run() {
 353                     cling.cleanup();
 354                     SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();
 355                     editor.putBoolean(flag, true);
 356                     editor.apply();
 357                     if (postAnimationCb != null) {
 358                         postAnimationCb.run();
 359                     }
 360                 }
 361             };
 362             if (duration &lt;= 0) {
 363                 cleanUpClingCb.run();
 364             } else {
 365                 cling.hide(duration, cleanUpClingCb);
 366             }
 367             mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 368 
 369             if (restoreNavBarVisibilty) {
 370                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() &amp;
 371                         ~View.SYSTEM_UI_FLAG_LOW_PROFILE);
 372             }
 373         }
 374     }
 375 
 376     public void dismissFirstRunCling(View v) {
 377         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 378         Runnable cb = new Runnable() {
 379             public void run() {
 380                 // Show the workspace cling next
 381                 showWorkspaceCling();
 382             }
 383         };
 384         dismissCling(cling, cb, FIRST_RUN_CLING_DISMISSED_KEY,
 385                 DISMISS_CLING_DURATION, false);
 386 
 387         // Fade out the search bar for the workspace cling coming up
 388         mLauncher.getSearchBar().hideSearchBar(true);
 389     }
 390 
 391     private void dismissMigrationCling() {
 392         mLauncher.showWorkspaceSearchAndHotseat();
 393         Runnable dismissCb = new Runnable() {
 394             public void run() {
 395                 Cling cling = (Cling) mLauncher.findViewById(R.id.migration_cling);
 396                 Runnable cb = new Runnable() {
 397                     public void run() {
 398                         // Show the migration workspace cling next
 399                         showMigrationWorkspaceCling();
 400                     }
 401                 };
 402                 dismissCling(cling, cb, MIGRATION_CLING_DISMISSED_KEY,
 403                         DISMISS_CLING_DURATION, true);
 404             }
 405         };
 406         mLauncher.getWorkspace().post(dismissCb);
 407     }
 408 
 409     private void dismissAnyWorkspaceCling(Cling cling, String key, View v) {
 410         Runnable cb = null;
 411         if (v == null) {
 412             cb = new Runnable() {
 413                 public void run() {
 414                     mLauncher.getWorkspace().enterOverviewMode();
 415                 }
 416             };
 417         }
 418         dismissCling(cling, cb, key, DISMISS_CLING_DURATION, true);
 419 
 420         // Fade in the search bar
 421         mLauncher.getSearchBar().showSearchBar(true);
 422     }
 423 
 424     public void dismissMigrationClingCopyApps(View v) {
 425         // Copy the shortcuts from the old database
 426         LauncherModel model = mLauncher.getModel();
 427         model.resetLoadedState(false, true);
 428         model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 429                 LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE
 430                         | LauncherModel.LOADER_FLAG_MIGRATE_SHORTCUTS);
 431 
 432         // Set the flag to skip the folder cling
 433         String spKey = LauncherAppState.getSharedPreferencesKey();
 434         SharedPreferences sp = mLauncher.getSharedPreferences(spKey, Context.MODE_PRIVATE);
 435         SharedPreferences.Editor editor = sp.edit();
 436         editor.putBoolean(Launcher.USER_HAS_MIGRATED, true);
 437         editor.apply();
 438 
 439         // Disable the migration cling
 440         dismissMigrationCling();
 441     }
 442 
 443     public void dismissMigrationClingUseDefault(View v) {
 444         // Clear the workspace
 445         LauncherModel model = mLauncher.getModel();
 446         model.resetLoadedState(false, true);
 447         model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 448                 LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE);
 449 
 450         // Disable the migration cling
 451         dismissMigrationCling();
 452     }
 453 
 454     public void dismissMigrationWorkspaceCling(View v) {
 455         Cling cling = (Cling) mLauncher.findViewById(R.id.migration_workspace_cling);
 456         dismissAnyWorkspaceCling(cling, MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, v);
 457     }
 458 
 459     public void dismissWorkspaceCling(View v) {
 460         Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 461         dismissAnyWorkspaceCling(cling, WORKSPACE_CLING_DISMISSED_KEY, v);
 462     }
 463 
 464     public void dismissFolderCling(View v) {
 465         Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 466         dismissCling(cling, null, FOLDER_CLING_DISMISSED_KEY,
 467                 DISMISS_CLING_DURATION, true);
 468     }
 469 }</pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2008 The Android Open Source Project
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.android.launcher3;
  18 
  19 import android.accounts.Account;
  20 import android.accounts.AccountManager;
  21 import android.animation.Animator;
  22 import android.animation.AnimatorListenerAdapter;
  23 import android.app.ActivityManager;
  24 import android.content.Context;
  25 import android.content.SharedPreferences;
  26 import android.graphics.Rect;
  27 import android.os.Bundle;
  28 import android.os.UserManager;
  29 import android.view.LayoutInflater;
  30 import android.view.View;
  31 import android.view.ViewGroup;
  32 import android.view.accessibility.AccessibilityManager;
  33 import android.widget.TextView;
  34 
  35 class LauncherClings {
  36     private static final String FIRST_RUN_CLING_DISMISSED_KEY = &quot;cling_gel.first_run.dismissed&quot;;
  37     private static final String MIGRATION_CLING_DISMISSED_KEY = &quot;cling_gel.migration.dismissed&quot;;
  38     private static final String MIGRATION_WORKSPACE_CLING_DISMISSED_KEY =
  39             &quot;cling_gel.migration_workspace.dismissed&quot;;
  40     private static final String WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.workspace.dismissed&quot;;
  41     private static final String FOLDER_CLING_DISMISSED_KEY = &quot;cling_gel.folder.dismissed&quot;;
  42 
  43     private static final boolean DISABLE_CLINGS = false;
  44     private static final boolean DISABLE_CUSTOM_CLINGS = true;
  45 
  46     private static final int SHOW_CLING_DURATION = 250;
  47     private static final int DISMISS_CLING_DURATION = 200;
  48 
  49     private Launcher mLauncher;
  50     private LayoutInflater mInflater;
  51     private HideFromAccessibilityHelper mHideFromAccessibilityHelper
  52             = new HideFromAccessibilityHelper();
  53 
  54     /** Ctor */
  55     public LauncherClings(Launcher launcher) {
  56         mLauncher = launcher;
  57         mInflater = mLauncher.getLayoutInflater();
  58     }
  59 
  60     /** Initializes a cling */
  61     private Cling initCling(int clingId, int scrimId, boolean animate,
  62                             boolean dimNavBarVisibilty) {
  63         Cling cling = (Cling) mLauncher.findViewById(clingId);
  64         View scrim = null;
  65         if (scrimId &gt; 0) {
  66             scrim = mLauncher.findViewById(scrimId);
  67         }
  68         if (cling != null) {
  69             cling.init(mLauncher, scrim);
  70             cling.show(animate, SHOW_CLING_DURATION);
  71 
  72             if (dimNavBarVisibilty) {
  73                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() |
  74                         View.SYSTEM_UI_FLAG_LOW_PROFILE);
  75             }
  76         }
  77         return cling;
  78     }
  79 
  80     /** Returns whether the clings are enabled or should be shown */
  81     private boolean areClingsEnabled() {
  82         if (DISABLE_CLINGS) {
  83             return false;
  84         }
  85 
  86         // disable clings when running in a test harness
  87         if(ActivityManager.isRunningInTestHarness()) return false;
  88 
  89         // Disable clings for accessibility when explore by touch is enabled
  90         final AccessibilityManager a11yManager = (AccessibilityManager) mLauncher.getSystemService(
  91                 Launcher.ACCESSIBILITY_SERVICE);
  92         if (a11yManager.isTouchExplorationEnabled()) {
  93             return false;
  94         }
  95 
  96         // Restricted secondary users (child mode) will potentially have very few apps
  97         // seeded when they start up for the first time. Clings won&#x27;t work well with that
  98         boolean supportsLimitedUsers =
  99                 android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.JELLY_BEAN_MR2;
 100         Account[] accounts = AccountManager.get(mLauncher).getAccounts();
 101         if (supportsLimitedUsers &amp;&amp; accounts.length == 0) {
 102             UserManager um = (UserManager) mLauncher.getSystemService(Context.USER_SERVICE);
 103             Bundle restrictions = um.getUserRestrictions();
 104             if (restrictions.getBoolean(UserManager.DISALLOW_MODIFY_ACCOUNTS, false)) {
 105                 return false;
 106             }
 107         }
 108         return true;
 109     }
 110 
 111     /** Returns whether the folder cling is visible. */
 112     public boolean isFolderClingVisible() {
 113         Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 114         if (cling != null) {
 115             return cling.getVisibility() == View.VISIBLE;
 116         }
 117         return false;
 118     }
 119 
 120     private boolean skipCustomClingIfNoAccounts() {
 121         Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 122         boolean customCling = cling.getDrawIdentifier().equals(&quot;workspace_custom&quot;);
 123         if (customCling) {
 124             AccountManager am = AccountManager.get(mLauncher);
 125             if (am == null) return false;
 126             Account[] accounts = am.getAccountsByType(&quot;com.google&quot;);
 127             return accounts.length == 0;
 128         }
 129         return false;
 130     }
 131 
 132     /** Updates the first run cling custom content hint */
 133     private void setCustomContentHintVisibility(Cling cling, String ccHintStr, boolean visible,
 134                                                 boolean animate) {
 135         final TextView ccHint = (TextView) cling.findViewById(R.id.custom_content_hint);
 136         if (ccHint != null) {
 137             if (visible &amp;&amp; !ccHintStr.isEmpty()) {
 138                 ccHint.setText(ccHintStr);
 139                 ccHint.setVisibility(View.VISIBLE);
 140                 if (animate) {
 141                     ccHint.setAlpha(0f);
 142                     ccHint.animate().alpha(1f)
 143                             .setDuration(SHOW_CLING_DURATION)
 144                             .start();
 145                 } else {
 146                     ccHint.setAlpha(1f);
 147                 }
 148             } else {
 149                 if (animate) {
 150                     ccHint.animate().alpha(0f)
 151                             .setDuration(SHOW_CLING_DURATION)
 152                             .setListener(new AnimatorListenerAdapter() {
 153                                 @Override
 154                                 public void onAnimationEnd(Animator animation) {
 155                                     ccHint.setVisibility(View.GONE);
 156                                 }
 157                             })
 158                             .start();
 159                 } else {
 160                     ccHint.setAlpha(0f);
 161                     ccHint.setVisibility(View.GONE);
 162                 }
 163             }
 164         }
 165     }
 166 
 167     /** Updates the first run cling custom content hint */
 168     public void updateCustomContentHintVisibility() {
 169         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 170         String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 171 
 172         if (mLauncher.getWorkspace().hasCustomContent()) {
 173             // Show the custom content hint if ccHintStr is not empty
 174             if (cling != null) {
 175                 setCustomContentHintVisibility(cling, ccHintStr, true, true);
 176             }
 177         } else {
 178             // Hide the custom content hint
 179             if (cling != null) {
 180                 setCustomContentHintVisibility(cling, ccHintStr, false, true);
 181             }
 182         }
 183     }
 184 
 185     /** Updates the first run cling search bar hint. */
 186     public void updateSearchBarHint(String hint) {
 187         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 188         if (cling != null &amp;&amp; cling.getVisibility() == View.VISIBLE &amp;&amp; !hint.isEmpty()) {
 189             TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 190             sbHint.setText(hint);
 191             sbHint.setVisibility(View.VISIBLE);
 192         }
 193     }
 194 
 195     public boolean shouldShowFirstRunOrMigrationClings() {
 196         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 197 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198         return isClingsEnabled() &amp;&amp;</span>
 199 ||||||| BASE
 200 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201         return areClingsEnabled() &amp;&amp;</span>
 202 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 203             !sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false) &amp;&amp;
 204             !sharedPrefs.getBoolean(MIGRATION_CLING_DISMISSED_KEY, false);
 205     }
 206 
 207     public void removeFirstRunAndMigrationClings() {
 208         removeCling(R.id.first_run_cling);
 209         removeCling(R.id.migration_cling);
 210     }
 211 
 212     /**
 213      * Shows the first run cling.
 214      *
 215      * This flow is mutually exclusive with showMigrationCling, and only runs if this Launcher
 216      * package was preinstalled or there is no db to migrate from.
 217      */
 218     public void showFirstRunCling() {
 219         if (!skipCustomClingIfNoAccounts()) {
 220         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 221             // If we&#x27;re not using the default workspace layout, replace workspace cling
 222             // with a custom workspace cling (usually specified in an overlay)
 223             // For now, only do this on tablets
 224             if (!DISABLE_CUSTOM_CLINGS) {
 225                 if (sharedPrefs.getInt(LauncherProvider.DEFAULT_WORKSPACE_RESOURCE_ID, 0) != 0 &amp;&amp;
 226                         mLauncher.getResources().getBoolean(R.bool.config_useCustomClings)) {
 227                     // Use a custom cling
 228                     View cling = mLauncher.findViewById(R.id.workspace_cling);
 229                     ViewGroup clingParent = (ViewGroup) cling.getParent();
 230                     int clingIndex = clingParent.indexOfChild(cling);
 231                     clingParent.removeViewAt(clingIndex);
 232                     View customCling = mInflater.inflate(R.layout.custom_workspace_cling,
 233                             clingParent, false);
 234                     clingParent.addView(customCling, clingIndex);
 235                     customCling.setId(R.id.workspace_cling);
 236                 }
 237             }
 238             Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 239             if (cling != null) {
 240                 String sbHintStr = mLauncher.getFirstRunClingSearchBarHint();
 241                 String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 242                 if (!sbHintStr.isEmpty()) {
 243                     TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 244                     sbHint.setText(sbHintStr);
 245                     sbHint.setVisibility(View.VISIBLE);
 246                 }
 247                 setCustomContentHintVisibility(cling, ccHintStr, true, false);
 248             }
 249             initCling(R.id.first_run_cling, 0, false, true);
 250         } else {
 251             removeFirstRunAndMigrationClings();
 252         }
 253     }
 254 
 255     /**
 256      * Shows the migration cling.
 257      *
 258      * This flow is mutually exclusive with showFirstRunCling, and only runs if this Launcher
 259      * package was not preinstalled and there exists a db to migrate from.
 260      */
 261     public void showMigrationCling() {
 262             mLauncher.hideWorkspaceSearchAndHotseat();
 263 
 264             Cling c = initCling(R.id.migration_cling, 0, false, true);
 265             c.bringScrimToFront();
 266             c.bringToFront();
 267     }
 268 
 269     public void showMigrationWorkspaceCling() {
 270         // Enable the clings only if they have not been dismissed before
 271         if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 272                 MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, false)) {
 273             Cling c = initCling(R.id.migration_workspace_cling, 0, false, true);
 274             c.updateMigrationWorkspaceBubblePosition();
 275             c.bringScrimToFront();
 276             c.bringToFront();
 277         } else {
 278             removeCling(R.id.migration_workspace_cling);
 279         }
 280     }
 281 
 282     public void showWorkspaceCling() {
 283         // Enable the clings only if they have not been dismissed before
 284         if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 285                 WORKSPACE_CLING_DISMISSED_KEY, false)) {
 286             Cling c = initCling(R.id.workspace_cling, 0, false, true);
 287             c.updateWorkspaceBubblePosition();
 288 
 289             // Set the focused hotseat app if there is one
 290             c.setFocusedHotseatApp(mLauncher.getFirstRunFocusedHotseatAppDrawableId(),
 291                     mLauncher.getFirstRunFocusedHotseatAppRank(),
 292                     mLauncher.getFirstRunFocusedHotseatAppComponentName(),
 293                     mLauncher.getFirstRunFocusedHotseatAppBubbleTitle(),
 294                     mLauncher.getFirstRunFocusedHotseatAppBubbleDescription());
 295         } else {
 296             removeCling(R.id.workspace_cling);
 297         }
 298     }
 299     public Cling showFoldersCling() {
 300         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 301         // Enable the clings only if they have not been dismissed before
 302         if (areClingsEnabled() &amp;&amp;
 303                 !sharedPrefs.getBoolean(FOLDER_CLING_DISMISSED_KEY, false) &amp;&amp;
 304                 !sharedPrefs.getBoolean(Launcher.USER_HAS_MIGRATED, false)) {
 305             Cling cling = initCling(R.id.folder_cling, R.id.cling_scrim,
 306                     true, true);
 307             Folder openFolder = mLauncher.getWorkspace().getOpenFolder();
 308             if (openFolder != null) {
 309                 Rect openFolderRect = new Rect();
 310                 openFolder.getHitRect(openFolderRect);
 311                 cling.setOpenFolderRect(openFolderRect);
 312                 openFolder.bringToFront();
 313             }
 314             return cling;
 315         } else {
 316             removeCling(R.id.folder_cling);
 317             return null;
 318         }
 319     }
 320 
 321     /** Removes the cling outright from the DragLayer */
 322     private void removeCling(int id) {
 323         final View cling = mLauncher.findViewById(id);
 324         if (cling != null) {
 325             final ViewGroup parent = (ViewGroup) cling.getParent();
 326             parent.post(new Runnable() {
 327                 @Override
 328                 public void run() {
 329                     parent.removeView(cling);
 330                 }
 331             });
 332             mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 333         }
 334     }
 335 
 336     /** Hides the specified Cling */
 337     private void dismissCling(final Cling cling, final Runnable postAnimationCb,
 338                               final String flag, int duration, boolean restoreNavBarVisibilty) {
 339         // To catch cases where siblings of top-level views are made invisible, just check whether
 340         // the cling is directly set to GONE before dismissing it.
 341         if (cling != null &amp;&amp; cling.getVisibility() != View.GONE) {
 342             final Runnable cleanUpClingCb = new Runnable() {
 343                 public void run() {
 344                     cling.cleanup();
 345                     SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();
 346                     editor.putBoolean(flag, true);
 347                     editor.apply();
 348                     if (postAnimationCb != null) {
 349                         postAnimationCb.run();
 350                     }
 351                 }
 352             };
 353             if (duration &lt;= 0) {
 354                 cleanUpClingCb.run();
 355             } else {
 356                 cling.hide(duration, cleanUpClingCb);
 357             }
 358             mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 359 
 360             if (restoreNavBarVisibilty) {
 361                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() &amp;
 362                         ~View.SYSTEM_UI_FLAG_LOW_PROFILE);
 363             }
 364         }
 365     }
 366 
 367     public void dismissFirstRunCling(View v) {
 368         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 369         Runnable cb = new Runnable() {
 370             public void run() {
 371                 // Show the workspace cling next
 372                 showWorkspaceCling();
 373             }
 374         };
 375         dismissCling(cling, cb, FIRST_RUN_CLING_DISMISSED_KEY,
 376                 DISMISS_CLING_DURATION, false);
 377 
 378         // Fade out the search bar for the workspace cling coming up
 379         mLauncher.getSearchBar().hideSearchBar(true);
 380     }
 381 
 382     private void dismissMigrationCling() {
 383         mLauncher.showWorkspaceSearchAndHotseat();
 384         Runnable dismissCb = new Runnable() {
 385             public void run() {
 386                 Cling cling = (Cling) mLauncher.findViewById(R.id.migration_cling);
 387                 Runnable cb = new Runnable() {
 388                     public void run() {
 389                         // Show the migration workspace cling next
 390                         showMigrationWorkspaceCling();
 391                     }
 392                 };
 393                 dismissCling(cling, cb, MIGRATION_CLING_DISMISSED_KEY,
 394                         DISMISS_CLING_DURATION, true);
 395             }
 396         };
 397         mLauncher.getWorkspace().post(dismissCb);
 398     }
 399 
 400     private void dismissAnyWorkspaceCling(Cling cling, String key, View v) {
 401         Runnable cb = null;
 402         if (v == null) {
 403             cb = new Runnable() {
 404                 public void run() {
 405                     mLauncher.getWorkspace().enterOverviewMode();
 406                 }
 407             };
 408         }
 409         dismissCling(cling, cb, key, DISMISS_CLING_DURATION, true);
 410 
 411         // Fade in the search bar
 412         mLauncher.getSearchBar().showSearchBar(true);
 413     }
 414 
 415     public void dismissMigrationClingCopyApps(View v) {
 416         // Copy the shortcuts from the old database
 417         LauncherModel model = mLauncher.getModel();
 418         model.resetLoadedState(false, true);
 419         model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 420                 LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE
 421                         | LauncherModel.LOADER_FLAG_MIGRATE_SHORTCUTS);
 422 
 423         // Set the flag to skip the folder cling
 424         String spKey = LauncherAppState.getSharedPreferencesKey();
 425         SharedPreferences sp = mLauncher.getSharedPreferences(spKey, Context.MODE_PRIVATE);
 426         SharedPreferences.Editor editor = sp.edit();
 427         editor.putBoolean(Launcher.USER_HAS_MIGRATED, true);
 428         editor.apply();
 429 
 430         // Disable the migration cling
 431         dismissMigrationCling();
 432     }
 433 
 434     public void dismissMigrationClingUseDefault(View v) {
 435         // Clear the workspace
 436         LauncherModel model = mLauncher.getModel();
 437         model.resetLoadedState(false, true);
 438         model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 439                 LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE);
 440 
 441         // Disable the migration cling
 442         dismissMigrationCling();
 443     }
 444 
 445     public void dismissMigrationWorkspaceCling(View v) {
 446         Cling cling = (Cling) mLauncher.findViewById(R.id.migration_workspace_cling);
 447         dismissAnyWorkspaceCling(cling, MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, v);
 448     }
 449 
 450     public void dismissWorkspaceCling(View v) {
 451         Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 452         dismissAnyWorkspaceCling(cling, WORKSPACE_CLING_DISMISSED_KEY, v);
 453     }
 454 
 455     public void dismissFolderCling(View v) {
 456         Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 457         dismissCling(cling, null, FOLDER_CLING_DISMISSED_KEY,
 458                 DISMISS_CLING_DURATION, true);
 459     }
 460 }
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2008 The Android Open Source Project
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.android.launcher3;
  17 
  18 import android.accounts.Account;
  19 import android.accounts.AccountManager;
  20 import android.animation.Animator;
  21 import android.animation.AnimatorListenerAdapter;
  22 import android.app.ActivityManager;
  23 import android.content.Context;
  24 import android.content.SharedPreferences;
  25 import android.graphics.Rect;
  26 import android.os.Bundle;
  27 import android.os.UserManager;
  28 import android.view.LayoutInflater;
  29 import android.view.View;
  30 import android.view.ViewGroup;
  31 import android.view.accessibility.AccessibilityManager;
  32 import android.widget.TextView;
  33 
  34 
  35 class LauncherClings {
  36     private static final String FIRST_RUN_CLING_DISMISSED_KEY = &quot;cling_gel.first_run.dismissed&quot;;
  37 
  38     private static final String MIGRATION_CLING_DISMISSED_KEY = &quot;cling_gel.migration.dismissed&quot;;
  39 
<abbr title="  40     private static final String MIGRATION_WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.migration_workspace.dismissed&quot;;">  40     private static final String MIGRATION_WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.migration_workspace.</abbr>
  41 
  42     private static final String WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.workspace.dismissed&quot;;
  43 
  44     private static final String FOLDER_CLING_DISMISSED_KEY = &quot;cling_gel.folder.dismissed&quot;;
  45 
  46     private static final boolean DISABLE_CLINGS = false;
  47 
  48     private static final boolean DISABLE_CUSTOM_CLINGS = true;
  49 
  50     private static final int SHOW_CLING_DURATION = 250;
  51 
  52     private static final int DISMISS_CLING_DURATION = 200;
  53 
  54     private Launcher mLauncher;
  55 
  56     private LayoutInflater mInflater;
  57 
  58     private HideFromAccessibilityHelper mHideFromAccessibilityHelper
  59             = new HideFromAccessibilityHelper();
  60 
  61     /**
  62      * Ctor
  63      */
  64     public LauncherClings(Launcher launcher) {
  65         mLauncher = launcher;
  66         mInflater = mLauncher.getLayoutInflater();
  67     }
  68 
  69     /** Initializes a cling */
  70     private Cling initCling(int clingId, int scrimId, boolean animate, boolean dimNavBarVisibilty) {
  71         Cling cling = ((Cling) (mLauncher.findViewById(clingId)));
  72         View scrim = null;
  73         if (scrimId &gt; 0) {
  74             scrim = mLauncher.findViewById(scrimId);
  75         }
  76         if (cling != null) {
  77             cling.init(mLauncher, scrim);
  78             cling.show(animate, SHOW_CLING_DURATION);
  79             if (dimNavBarVisibilty) {
<abbr title="  80                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() | View.SYSTEM_UI_FLAG_LOW_PROFILE);">  80                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() | View.SYSTEM_UI_FLAG_LOW_PROFI</abbr>
  81             }
  82         }
  83         return cling;
  84     }
  85 
  86     /** Returns whether the clings are enabled or should be shown */
  87     private boolean areClingsEnabled() {
  88         if (DISABLE_CLINGS) {
  89             return false;
  90         }
  91         // disable clings when running in a test harness
  92         if (ActivityManager.isRunningInTestHarness()) {
  93             return false;
  94         }
  95         // Disable clings for accessibility when explore by touch is enabled
<abbr title="  96         final AccessibilityManager a11yManager = ((AccessibilityManager) (mLauncher.getSystemService(Launcher.ACCESSIBILITY_SERVICE)));">  96         final AccessibilityManager a11yManager = ((AccessibilityManager) (mLauncher.getSystemService(Laun</abbr>
  97         if (a11yManager.isTouchExplorationEnabled()) {
  98             return false;
  99         }
 100         // Restricted secondary users (child mode) will potentially have very few apps
 101         // seeded when they start up for the first time. Clings won&#x27;t work well with that
<abbr title=" 102         boolean supportsLimitedUsers = android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.JELLY_BEAN_MR2;"> 102         boolean supportsLimitedUsers = android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES</abbr>
 103         Account[] accounts = AccountManager.get(mLauncher).getAccounts();
 104         if (supportsLimitedUsers &amp;&amp; (accounts.length == 0)) {
 105             UserManager um = ((UserManager) (mLauncher.getSystemService(Context.USER_SERVICE)));
 106             Bundle restrictions = um.getUserRestrictions();
 107             if (restrictions.getBoolean(UserManager.DISALLOW_MODIFY_ACCOUNTS, false)) {
 108                 return false;
 109             }
 110         }
 111         return true;
 112     }
 113 
 114     /** Returns whether the folder cling is visible. */
 115     public boolean isFolderClingVisible() {
 116         Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 117         if (cling != null) {
 118             return cling.getVisibility() == View.VISIBLE;
 119         }
 120         return false;
 121     }
 122 
 123     private boolean skipCustomClingIfNoAccounts() {
 124         Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 125         boolean customCling = cling.getDrawIdentifier().equals(&quot;workspace_custom&quot;);
 126         if (customCling) {
 127             AccountManager am = AccountManager.get(mLauncher);
 128             if (am == null) return false;
 129             Account[] accounts = am.getAccountsByType(&quot;com.google&quot;);
 130             return accounts.length == 0;
 131         }
 132         return false;
 133     }
 134 
 135     /** Updates the first run cling custom content hint */
 136     private void setCustomContentHintVisibility(Cling cling, String ccHintStr, boolean visible,
 137                                                 boolean animate) {
 138         final TextView ccHint = (TextView) cling.findViewById(R.id.custom_content_hint);
 139         if (ccHint != null) {
 140             if (visible &amp;&amp; !ccHintStr.isEmpty()) {
 141                 ccHint.setText(ccHintStr);
 142                 ccHint.setVisibility(View.VISIBLE);
 143                 if (animate) {
 144                     ccHint.setAlpha(0f);
 145                     ccHint.animate().alpha(1f)
 146                             .setDuration(SHOW_CLING_DURATION)
 147                             .start();
 148                 } else {
 149                     ccHint.setAlpha(1f);
 150                 }
 151             } else {
 152                 if (animate) {
 153                     ccHint.animate().alpha(0f)
 154                             .setDuration(SHOW_CLING_DURATION)
 155                             .setListener(new AnimatorListenerAdapter() {
 156                                 @Override
 157                                 public void onAnimationEnd(Animator animation) {
 158                                     ccHint.setVisibility(View.GONE);
 159                                 }
 160                             })
 161                             .start();
 162                 } else {
 163                     ccHint.setAlpha(0f);
 164                     ccHint.setVisibility(View.GONE);
 165                 }
 166             }
 167         }
 168     }
 169 
 170     /** Updates the first run cling custom content hint */
 171     public void updateCustomContentHintVisibility() {
 172         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 173         String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 174 
 175         if (mLauncher.getWorkspace().hasCustomContent()) {
 176             // Show the custom content hint if ccHintStr is not empty
 177             if (cling != null) {
 178                 setCustomContentHintVisibility(cling, ccHintStr, true, true);
 179             }
 180         } else {
 181             // Hide the custom content hint
 182             if (cling != null) {
 183                 setCustomContentHintVisibility(cling, ccHintStr, false, true);
 184             }
 185         }
 186     }
 187 
 188     /** Updates the first run cling search bar hint. */
 189     public void updateSearchBarHint(String hint) {
 190         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 191         if (cling != null &amp;&amp; cling.getVisibility() == View.VISIBLE &amp;&amp; !hint.isEmpty()) {
 192             TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 193             sbHint.setText(hint);
 194             sbHint.setVisibility(View.VISIBLE);
 195         }
 196     }
 197 
 198     public boolean shouldShowFirstRunOrMigrationClings() {
 199         SharedPreferences sharedPrefs =
 200 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201 mLauncher</span>
 202 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 203 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 203 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw</abbr></span>
 204 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 mLauncher</span>
 207 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 208         .getSharedPrefs();
 209 
 210 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211         return isClingsEnabled() &amp;&amp;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212             !sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false) &amp;&amp;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213             !sharedPrefs.getBoolean(MIGRATION_CLING_DISMISSED_KEY, false);</span>
 214 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 215 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 215 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw</abbr></span>
 216 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218         return areClingsEnabled() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219             !sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220             !sharedPrefs.getBoolean(MIGRATION_CLING_DISMISSED_KEY, false);</span>
 221 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 222 
 223     }
 224 
 225     public void removeFirstRunAndMigrationClings() {
 226         removeCling(R.id.first_run_cling);
 227         removeCling(R.id.migration_cling);
 228     }
 229 
 230     /**
 231      * Shows the first run cling.
 232      *
 233      * This flow is mutually exclusive with showMigrationCling, and only runs if this Launcher
 234      * package was preinstalled or there is no db to migrate from.
 235      */
 236     public void showFirstRunCling() {
 237         if (!skipCustomClingIfNoAccounts()) {
 238             SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 239             // If we&#x27;re not using the default workspace layout, replace workspace cling
 240             // with a custom workspace cling (usually specified in an overlay)
 241             // For now, only do this on tablets
 242             if (!DISABLE_CUSTOM_CLINGS) {
<abbr title=" 243                 if ((sharedPrefs.getInt(LauncherProvider.DEFAULT_WORKSPACE_RESOURCE_ID, 0) != 0) &amp;&amp; mLauncher.getResources().getBoolean(R.bool.config_useCustomClings)) {"> 243                 if ((sharedPrefs.getInt(LauncherProvider.DEFAULT_WORKSPACE_RESOURCE_ID, 0) != 0) &amp;&amp; mLaun</abbr>
 244                     // Use a custom cling
 245                     View cling = mLauncher.findViewById(R.id.workspace_cling);
 246                     ViewGroup clingParent = ((ViewGroup) (cling.getParent()));
 247                     int clingIndex = clingParent.indexOfChild(cling);
 248                     clingParent.removeViewAt(clingIndex);
<abbr title=" 249                     View customCling = mInflater.inflate(R.layout.custom_workspace_cling, clingParent, false);"> 249                     View customCling = mInflater.inflate(R.layout.custom_workspace_cling, clingParent, fa</abbr>
 250                     clingParent.addView(customCling, clingIndex);
 251                     customCling.setId(R.id.workspace_cling);
 252                 }
 253             }
 254             Cling cling = ((Cling) (mLauncher.findViewById(R.id.first_run_cling)));
 255             if (cling != null) {
 256                 String sbHintStr = mLauncher.getFirstRunClingSearchBarHint();
 257                 String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 258                 if (!sbHintStr.isEmpty()) {
 259                     TextView sbHint = ((TextView) (cling.findViewById(R.id.search_bar_hint)));
 260                     sbHint.setText(sbHintStr);
 261                     sbHint.setVisibility(View.VISIBLE);
 262                 }
 263                 setCustomContentHintVisibility(cling, ccHintStr, true, false);
 264             }
 265             initCling(R.id.first_run_cling, 0, false, true);
 266         } else {
 267             removeFirstRunAndMigrationClings();
 268         }
 269     }
 270 
 271     /**
 272      * Shows the migration cling.
 273      *
 274      * This flow is mutually exclusive with showFirstRunCling, and only runs if this Launcher
 275      * package was not preinstalled and there exists a db to migrate from.
 276      */
 277     public void showMigrationCling() {
 278         mLauncher.hideWorkspaceSearchAndHotseat();
 279         Cling c = initCling(R.id.migration_cling, 0, false, true);
 280         c.bringScrimToFront();
 281         c.bringToFront();
 282     }
 283 
 284     public void showMigrationWorkspaceCling() {
 285         // Enable the clings only if they have not been dismissed before
<abbr title=" 286         if (areClingsEnabled() &amp;&amp; (!mLauncher.getSharedPrefs().getBoolean(MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, false))) {"> 286         if (areClingsEnabled() &amp;&amp; (!mLauncher.getSharedPrefs().getBoolean(MIGRATION_WORKSPACE_CLING_DISMI</abbr>
 287             Cling c = initCling(R.id.migration_workspace_cling, 0, false, true);
 288             c.updateMigrationWorkspaceBubblePosition();
 289             c.bringScrimToFront();
 290             c.bringToFront();
 291         } else {
 292             removeCling(R.id.migration_workspace_cling);
 293         }
 294     }
 295 
 296     public void showWorkspaceCling() {
 297         // Enable the clings only if they have not been dismissed before
<abbr title=" 298         if (areClingsEnabled() &amp;&amp; (!mLauncher.getSharedPrefs().getBoolean(WORKSPACE_CLING_DISMISSED_KEY, false))) {"> 298         if (areClingsEnabled() &amp;&amp; (!mLauncher.getSharedPrefs().getBoolean(WORKSPACE_CLING_DISMISSED_KEY, </abbr>
 299             Cling c = initCling(R.id.workspace_cling, 0, false, true);
 300             c.updateWorkspaceBubblePosition();
 301             // Set the focused hotseat app if there is one
<abbr title=" 302             c.setFocusedHotseatApp(mLauncher.getFirstRunFocusedHotseatAppDrawableId(), mLauncher.getFirstRunFocusedHotseatAppRank(), mLauncher.getFirstRunFocusedHotseatAppComponentName(), mLauncher.getFirstRunFocusedHotseatAppBubbleTitle(), mLauncher.getFirstRunFocusedHotseatAppBubbleDescription());"> 302             c.setFocusedHotseatApp(mLauncher.getFirstRunFocusedHotseatAppDrawableId(), mLauncher.getFirst</abbr>
 303         } else {
 304             removeCling(R.id.workspace_cling);
 305         }
 306     }
 307 
 308     public Cling showFoldersCling() {
 309         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 310         if (areClingsEnabled() &amp;&amp;
 311                 !sharedPrefs.getBoolean(FOLDER_CLING_DISMISSED_KEY, false) &amp;&amp;
 312                 !sharedPrefs.getBoolean(Launcher.USER_HAS_MIGRATED, false)) {
 313             Cling cling = initCling(R.id.folder_cling, R.id.cling_scrim,
 314                     true, true);
 315             Folder openFolder = mLauncher.getWorkspace().getOpenFolder();
 316             if (openFolder != null) {
 317                 Rect openFolderRect = new Rect();
 318                 openFolder.getHitRect(openFolderRect);
 319                 cling.setOpenFolderRect(openFolderRect);
 320                 openFolder.bringToFront();
 321             }
 322             return cling;
 323         } else {
 324             removeCling(R.id.folder_cling);
 325             return null;
 326         }
 327     }
 328 
 329     /** Removes the cling outright from the DragLayer */
 330     private void removeCling(int id) {
 331         final View cling = mLauncher.findViewById(id);
 332         if (cling != null) {
 333             final ViewGroup parent = (ViewGroup) cling.getParent();
 334             parent.post(new Runnable() {
 335                 @Override
 336                 public void run() {
 337                     parent.removeView(cling);
 338                 }
 339             });
 340             mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 341         }
 342     }
 343 
 344     /** Hides the specified Cling */
 345     private void dismissCling(final Cling cling, final Runnable postAnimationCb,
 346                               final String flag, int duration, boolean restoreNavBarVisibilty) {
 347         // To catch cases where siblings of top-level views are made invisible, just check whether
 348         // the cling is directly set to GONE before dismissing it.
 349         if (cling != null &amp;&amp; cling.getVisibility() != View.GONE) {
 350             final Runnable cleanUpClingCb = new Runnable() {
 351                 public void run() {
 352                     cling.cleanup();
 353                     SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();
 354                     editor.putBoolean(flag, true);
 355                     editor.apply();
 356                     if (postAnimationCb != null) {
 357                         postAnimationCb.run();
 358                     }
 359                 }
 360             };
 361             if (duration &lt;= 0) {
 362                 cleanUpClingCb.run();
 363             } else {
 364                 cling.hide(duration, cleanUpClingCb);
 365             }
 366             mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 367 
 368             if (restoreNavBarVisibilty) {
 369                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() &amp;
 370                         ~View.SYSTEM_UI_FLAG_LOW_PROFILE);
 371             }
 372         }
 373     }
 374 
 375     public void dismissFirstRunCling(View v) {
 376         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 377         Runnable cb = new Runnable() {
 378             public void run() {
 379                 // Show the workspace cling next
 380                 showWorkspaceCling();
 381             }
 382         };
 383         dismissCling(cling, cb, FIRST_RUN_CLING_DISMISSED_KEY,
 384                 DISMISS_CLING_DURATION, false);
 385 
 386         // Fade out the search bar for the workspace cling coming up
 387         mLauncher.getSearchBar().hideSearchBar(true);
 388     }
 389 
 390     private void dismissMigrationCling() {
 391         mLauncher.showWorkspaceSearchAndHotseat();
 392         Runnable dismissCb = new Runnable() {
 393             public void run() {
 394                 Cling cling = ((Cling) (mLauncher.findViewById(R.id.migration_cling)));
 395                 Runnable cb = new Runnable() {
 396                     public void run() {
 397                         // Show the migration workspace cling next
 398                         showMigrationWorkspaceCling();
 399                     }
 400                 };
 401                 dismissCling(cling, cb, MIGRATION_CLING_DISMISSED_KEY, DISMISS_CLING_DURATION, true);
 402             }
 403         };
 404         mLauncher.getWorkspace().post(dismissCb);
 405     }
 406 
 407     private void dismissAnyWorkspaceCling(Cling cling, String key, View v) {
 408         Runnable cb = null;
 409         if (v == null) {
 410             cb = new Runnable() {
 411                 public void run() {
 412                     mLauncher.getWorkspace().enterOverviewMode();
 413                 }
 414             };
 415         }
 416         dismissCling(cling, cb, key, DISMISS_CLING_DURATION, true);
 417         // Fade in the search bar
 418         mLauncher.getSearchBar().showSearchBar(true);
 419     }
 420 
 421     public void dismissMigrationClingCopyApps(View v) {
 422         // Copy the shortcuts from the old database
 423         LauncherModel model = mLauncher.getModel();
 424         model.resetLoadedState(false, true);
 425         model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 426                 LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE
 427                         | LauncherModel.LOADER_FLAG_MIGRATE_SHORTCUTS);
 428 
 429         // Set the flag to skip the folder cling
 430         String spKey = LauncherAppState.getSharedPreferencesKey();
 431         SharedPreferences sp = mLauncher.getSharedPreferences(spKey, Context.MODE_PRIVATE);
 432         SharedPreferences.Editor editor = sp.edit();
 433         editor.putBoolean(Launcher.USER_HAS_MIGRATED, true);
 434         editor.apply();
 435 
 436         // Disable the migration cling
 437         dismissMigrationCling();
 438     }
 439 
 440     public void dismissMigrationClingUseDefault(View v) {
 441         // Clear the workspace
 442         LauncherModel model = mLauncher.getModel();
 443         model.resetLoadedState(false, true);
 444         model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 445                 LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE);
 446 
 447         // Disable the migration cling
 448         dismissMigrationCling();
 449     }
 450 
 451     public void dismissMigrationWorkspaceCling(View v) {
 452         Cling cling = ((Cling) (mLauncher.findViewById(R.id.migration_workspace_cling)));
 453         dismissAnyWorkspaceCling(cling, MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, v);
 454     }
 455 
 456     public void dismissWorkspaceCling(View v) {
 457         Cling cling = ((Cling) (mLauncher.findViewById(R.id.workspace_cling)));
 458         dismissAnyWorkspaceCling(cling, WORKSPACE_CLING_DISMISSED_KEY, v);
 459     }
 460 
 461     public void dismissFolderCling(View v) {
 462         Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 463         dismissCling(cling, null, FOLDER_CLING_DISMISSED_KEY,
 464                 DISMISS_CLING_DURATION, true);
 465     }
 466 }
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Copyright (C) 2008 The Android Open Source Project
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.android.launcher3;
  18  
  19  import android.accounts.Account;
  20  import android.accounts.AccountManager;
  21  import android.animation.Animator;
  22  import android.animation.AnimatorListenerAdapter;
  23  import android.app.ActivityManager;
  24  import android.content.Context;
  25  import android.content.SharedPreferences;

  26  import android.os.Bundle;
  27  import android.os.UserManager;
  28  import android.view.LayoutInflater;
  29  import android.view.View;
  30  import android.view.ViewGroup;
  31  import android.view.accessibility.AccessibilityManager;
  32  import android.widget.TextView;
  33  
  34  class LauncherClings {
  35      private static final String FIRST_RUN_CLING_DISMISSED_KEY = &quot;cling_gel.first_run.dismissed&quot;;
  36      private static final String MIGRATION_CLING_DISMISSED_KEY = &quot;cling_gel.migration.dismissed&quot;;
  37      private static final String MIGRATION_WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.migration.dismissed&quot;;


  38      private static final String WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.workspace.dismissed&quot;;
  39      private static final String FOLDER_CLING_DISMISSED_KEY = &quot;cling_gel.folder.dismissed&quot;;
  40  
  41      private static final boolean DISABLE_CLINGS = false;
  42      private static final boolean DISABLE_CUSTOM_CLINGS = true;
  43  
  44      private static final int SHOW_CLING_DURATION = 250;
  45      private static final int DISMISS_CLING_DURATION = 200;
  46  
  47      private Launcher mLauncher;
  48      private LayoutInflater mInflater;
  49      private HideFromAccessibilityHelper mHideFromAccessibilityHelper
  50              = new HideFromAccessibilityHelper();
  51  
  52      /** Ctor */
  53      public LauncherClings(Launcher launcher) {
  54          mLauncher = launcher;
  55          mInflater = mLauncher.getLayoutInflater();
  56      }
  57  
  58      /** Initializes a cling */
  59      private Cling initCling(int clingId, int scrimId, boolean animate,
  60                              boolean dimNavBarVisibilty) {
  61          Cling cling = (Cling) mLauncher.findViewById(clingId);
  62          View scrim = null;
  63          if (scrimId &gt; 0) {
  64              scrim = mLauncher.findViewById(R.id.cling_scrim);

  65          }
  66          if (cling != null) {
  67              cling.init(mLauncher, scrim);
  68              cling.show(animate, SHOW_CLING_DURATION);
  69  
  70              if (dimNavBarVisibilty) {
  71                  cling.setSystemUiVisibility(cling.getSystemUiVisibility() |
  72                          View.SYSTEM_UI_FLAG_LOW_PROFILE);
  73              }
  74          }
  75          return cling;
  76      }
  77  
  78      /** Returns whether the clings are enabled or should be shown */
  79      private boolean isClingsEnabled() {

  80          if (DISABLE_CLINGS) {
  81              return false;
  82          }
  83  
  84          // For now, limit only to phones
  85          LauncherAppState app = LauncherAppState.getInstance();
  86          DeviceProfile grid = app.getDynamicGrid().getDeviceProfile();
  87          if (grid.isTablet()) {
  88              return false;
  89          }
  90          if (grid.isLandscape) {
  91              return false;
  92          }
  93  
  94          // disable clings when running in a test harness
  95          if(ActivityManager.isRunningInTestHarness()) return false;
  96  
  97          // Disable clings for accessibility when explore by touch is enabled
  98          final AccessibilityManager a11yManager = (AccessibilityManager) mLauncher.getSystemService(
  99                  Launcher.ACCESSIBILITY_SERVICE);
 100          if (a11yManager.isTouchExplorationEnabled()) {
 101              return false;
 102          }
 103  
 104          // Restricted secondary users (child mode) will potentially have very few apps
 105          // seeded when they start up for the first time. Clings won&#x27;t work well with that
 106          boolean supportsLimitedUsers =
 107                  android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.JELLY_BEAN_MR2;
 108          Account[] accounts = AccountManager.get(mLauncher).getAccounts();
 109          if (supportsLimitedUsers &amp;&amp; accounts.length == 0) {
 110              UserManager um = (UserManager) mLauncher.getSystemService(Context.USER_SERVICE);
 111              Bundle restrictions = um.getUserRestrictions();
 112              if (restrictions.getBoolean(UserManager.DISALLOW_MODIFY_ACCOUNTS, false)) {
 113                  return false;
 114              }
 115          }
 116          return true;
 117      }
 118  
 119      /** Returns whether the folder cling is visible. */
 120      public boolean isFolderClingVisible() {
 121          Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 122          if (cling != null) {
 123              return cling.getVisibility() == View.VISIBLE;
 124          }
 125          return false;
 126      }
 127  
 128      private boolean skipCustomClingIfNoAccounts() {
 129          Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 130          boolean customCling = cling.getDrawIdentifier().equals(&quot;workspace_custom&quot;);
 131          if (customCling) {
 132              AccountManager am = AccountManager.get(mLauncher);
 133              if (am == null) return false;
 134              Account[] accounts = am.getAccountsByType(&quot;com.google&quot;);
 135              return accounts.length == 0;
 136          }
 137          return false;
 138      }
 139  
 140      /** Updates the first run cling custom content hint */
 141      private void setCustomContentHintVisibility(Cling cling, String ccHintStr, boolean visible,
 142                                                  boolean animate) {
 143          final TextView ccHint = (TextView) cling.findViewById(R.id.custom_content_hint);
 144          if (ccHint != null) {
 145              if (visible &amp;&amp; !ccHintStr.isEmpty()) {
 146                  ccHint.setText(ccHintStr);
 147                  ccHint.setVisibility(View.VISIBLE);
 148                  if (animate) {
 149                      ccHint.setAlpha(0f);
 150                      ccHint.animate().alpha(1f)
 151                              .setDuration(SHOW_CLING_DURATION)
 152                              .start();
 153                  } else {
 154                      ccHint.setAlpha(1f);
 155                  }
 156              } else {
 157                  if (animate) {
 158                      ccHint.animate().alpha(0f)
 159                              .setDuration(SHOW_CLING_DURATION)
 160                              .setListener(new AnimatorListenerAdapter() {
 161                                  @Override
 162                                  public void onAnimationEnd(Animator animation) {
 163                                      ccHint.setVisibility(View.GONE);
 164                                  }
 165                              })
 166                              .start();
 167                  } else {
 168                      ccHint.setAlpha(0f);
 169                      ccHint.setVisibility(View.GONE);
 170                  }
 171              }
 172          }
 173      }
 174  
 175      /** Updates the first run cling custom content hint */
 176      public void updateCustomContentHintVisibility() {
 177          Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 178          String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 179  
 180          if (mLauncher.getWorkspace().hasCustomContent()) {
 181              // Show the custom content hint if ccHintStr is not empty
 182              if (cling != null) {
 183                  setCustomContentHintVisibility(cling, ccHintStr, true, true);
 184              }
 185          } else {
 186              // Hide the custom content hint
 187              if (cling != null) {
 188                  setCustomContentHintVisibility(cling, ccHintStr, false, true);
 189              }
 190          }
 191      }
 192  
 193      /** Updates the first run cling search bar hint. */
 194      public void updateSearchBarHint(String hint) {
 195          Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 196          if (cling != null &amp;&amp; cling.getVisibility() == View.VISIBLE &amp;&amp; !hint.isEmpty()) {
 197              TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 198              sbHint.setText(hint);
 199              sbHint.setVisibility(View.VISIBLE);
 200          }
 201      }
 202  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -    /** Shows the first run cling */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +    public boolean shouldShowFirstRunOrMigrationClings() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +        SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +        return isClingsEnabled() &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +            !sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false) &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +            !sharedPrefs.getBoolean(MIGRATION_CLING_DISMISSED_KEY, false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +    public void removeFirstRunAndMigrationClings() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +        removeCling(R.id.first_run_cling);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +        removeCling(R.id.migration_cling);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +     * Shows the first run cling.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +     * This flow is mutually exclusive with showMigrationCling, and only runs if this Launcher</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +     * package was preinstalled or there is no db to migrate from.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +     */</span>
 222      public void showFirstRunCling() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -        SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -        if (isClingsEnabled() &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -                !sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false) &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -                !skipCustomClingIfNoAccounts() ) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +        if (!skipCustomClingIfNoAccounts()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +            SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();</span>
 231              // If we&#x27;re not using the default workspace layout, replace workspace cling
 232              // with a custom workspace cling (usually specified in an overlay)
 233              // For now, only do this on tablets
 234              if (!DISABLE_CUSTOM_CLINGS) {
 235                  if (sharedPrefs.getInt(LauncherProvider.DEFAULT_WORKSPACE_RESOURCE_ID, 0) != 0 &amp;&amp;
 236                          mLauncher.getResources().getBoolean(R.bool.config_useCustomClings)) {
 237                      // Use a custom cling
 238                      View cling = mLauncher.findViewById(R.id.workspace_cling);
 239                      ViewGroup clingParent = (ViewGroup) cling.getParent();
 240                      int clingIndex = clingParent.indexOfChild(cling);
 241                      clingParent.removeViewAt(clingIndex);
 242                      View customCling = mInflater.inflate(R.layout.custom_workspace_cling,
 243                              clingParent, false);
 244                      clingParent.addView(customCling, clingIndex);
 245                      customCling.setId(R.id.workspace_cling);
 246                  }
 247              }
 248              Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 249              if (cling != null) {
 250                  String sbHintStr = mLauncher.getFirstRunClingSearchBarHint();
 251                  String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 252                  if (!sbHintStr.isEmpty()) {
 253                      TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 254                      sbHint.setText(sbHintStr);
 255                      sbHint.setVisibility(View.VISIBLE);
 256                  }
 257                  setCustomContentHintVisibility(cling, ccHintStr, true, false);
 258              }
 259              initCling(R.id.first_run_cling, 0, false, true);
 260          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -            removeCling(R.id.first_run_cling);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +            removeFirstRunAndMigrationClings();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +     * Shows the migration cling.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +     * This flow is mutually exclusive with showFirstRunCling, and only runs if this Launcher</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +     * package was not preinstalled and there exists a db to migrate from.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +     */</span>
 275      public void showMigrationCling() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -        // Enable the clings only if they have not been dismissed before</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -        if (isClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -                MIGRATION_CLING_DISMISSED_KEY, false)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -            mLauncher.hideWorkspaceSearchAndHotseat();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -            Cling c = initCling(R.id.migration_cling, 0, false, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -            c.bringScrimToFront();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -            c.bringToFront();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -            removeCling(R.id.migration_cling);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +        mLauncher.hideWorkspaceSearchAndHotseat();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +        Cling c = initCling(R.id.migration_cling, 0, false, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +        c.bringScrimToFront();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +        c.bringToFront();</span>
 292      }
 293  
 294      public void showMigrationWorkspaceCling() {
 295          // Enable the clings only if they have not been dismissed before
 296          if (isClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(

 297                  MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, false)) {
 298              Cling c = initCling(R.id.migration_workspace_cling, 0, false, true);
 299              c.updateMigrationWorkspaceBubblePosition();
 300              c.bringScrimToFront();
 301              c.bringToFront();
 302          } else {
 303              removeCling(R.id.migration_workspace_cling);
 304          }
 305      }
 306  
 307      public void showWorkspaceCling() {
 308          // Enable the clings only if they have not been dismissed before
 309          if (isClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(

 310                  WORKSPACE_CLING_DISMISSED_KEY, false)) {
 311              Cling c = initCling(R.id.workspace_cling, 0, false, true);

 312  
 313              // Set the focused hotseat app if there is one
 314              c.setFocusedHotseatApp(mLauncher.getFirstRunFocusedHotseatAppDrawableId(),
 315                      mLauncher.getFirstRunFocusedHotseatAppRank(),
 316                      mLauncher.getFirstRunFocusedHotseatAppComponentName(),
 317                      mLauncher.getFirstRunFocusedHotseatAppBubbleTitle(),
 318                      mLauncher.getFirstRunFocusedHotseatAppBubbleDescription());
 319          } else {
 320              removeCling(R.id.workspace_cling);
 321          }
 322      }
 323      public Cling showFoldersCling() {
 324          SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 325          // Enable the clings only if they have not been dismissed before
 326          if (isClingsEnabled() &amp;&amp;

 327                  !sharedPrefs.getBoolean(FOLDER_CLING_DISMISSED_KEY, false) &amp;&amp;
 328                  !sharedPrefs.getBoolean(Launcher.USER_HAS_MIGRATED, false)) {
 329              Cling cling = initCling(R.id.folder_cling, R.id.cling_scrim,
 330                      true, true);







 331              return cling;
 332          } else {
 333              removeCling(R.id.folder_cling);
 334              return null;
 335          }
 336      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -</span>
 338  
 339      /** Removes the cling outright from the DragLayer */
 340      private void removeCling(int id) {
 341          final View cling = mLauncher.findViewById(id);
 342          if (cling != null) {
 343              final ViewGroup parent = (ViewGroup) cling.getParent();
 344              parent.post(new Runnable() {
 345                  @Override
 346                  public void run() {
 347                      parent.removeView(cling);
 348                  }
 349              });
 350              mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 351          }
 352      }
 353  
 354      /** Hides the specified Cling */
 355      private void dismissCling(final Cling cling, final Runnable postAnimationCb,
 356                                final String flag, int duration, boolean restoreNavBarVisibilty) {
 357          // To catch cases where siblings of top-level views are made invisible, just check whether
 358          // the cling is directly set to GONE before dismissing it.
 359          if (cling != null &amp;&amp; cling.getVisibility() != View.GONE) {
 360              final Runnable cleanUpClingCb = new Runnable() {
 361                  public void run() {
 362                      cling.cleanup();
 363                      SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();
 364                      editor.putBoolean(flag, true);
 365                      editor.apply();
 366                      if (postAnimationCb != null) {
 367                          postAnimationCb.run();
 368                      }
 369                  }
 370              };
 371              if (duration &lt;= 0) {
 372                  cleanUpClingCb.run();
 373              } else {
 374                  cling.hide(duration, cleanUpClingCb);
 375              }
 376              mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 377  
 378              if (restoreNavBarVisibilty) {
 379                  cling.setSystemUiVisibility(cling.getSystemUiVisibility() &amp;
 380                          ~View.SYSTEM_UI_FLAG_LOW_PROFILE);
 381              }
 382          }
 383      }
 384  
 385      public void dismissFirstRunCling(View v) {
 386          Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 387          Runnable cb = new Runnable() {
 388              public void run() {
 389                  // Show the workspace cling next
 390                  showWorkspaceCling();
 391              }
 392          };
 393          dismissCling(cling, cb, FIRST_RUN_CLING_DISMISSED_KEY,
 394                  DISMISS_CLING_DURATION, false);
 395  
 396          // Fade out the search bar for the workspace cling coming up
 397          mLauncher.getSearchBar().hideSearchBar(true);
 398      }
 399  
 400      private void dismissMigrationCling() {
 401          mLauncher.showWorkspaceSearchAndHotseat();
 402          Runnable dismissCb = new Runnable() {
 403              public void run() {
 404                  Cling cling = (Cling) mLauncher.findViewById(R.id.migration_cling);
 405                  Runnable cb = new Runnable() {
 406                      public void run() {
 407                          // Show the migration workspace cling next
 408                          showMigrationWorkspaceCling();
 409                      }
 410                  };
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -                dismissCling(cling, cb, WORKSPACE_CLING_DISMISSED_KEY,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +                dismissCling(cling, cb, MIGRATION_CLING_DISMISSED_KEY,</span>
 413                          DISMISS_CLING_DURATION, true);
 414              }
 415          };
 416          mLauncher.getWorkspace().post(dismissCb);
 417      }
 418  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -    private void dismissAnyWorkspaceCling(Cling cling, View v) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 420 +    private void dismissAnyWorkspaceCling(Cling cling, String key, View v) {</span>
 421          Runnable cb = null;
 422          if (v == null) {
 423              cb = new Runnable() {
 424                  public void run() {
 425                      mLauncher.getWorkspace().enterOverviewMode();
 426                  }
 427              };
 428          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 429 -        dismissCling(cling, cb, WORKSPACE_CLING_DISMISSED_KEY,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 430 -                DISMISS_CLING_DURATION, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 431 +        dismissCling(cling, cb, key, DISMISS_CLING_DURATION, true);</span>
 432  
 433          // Fade in the search bar
 434          mLauncher.getSearchBar().showSearchBar(true);
 435      }
 436  
 437      public void dismissMigrationClingCopyApps(View v) {
 438          // Copy the shortcuts from the old database
 439          LauncherModel model = mLauncher.getModel();
 440          model.resetLoadedState(false, true);
 441          model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 442                  LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE
 443                          | LauncherModel.LOADER_FLAG_MIGRATE_SHORTCUTS);
 444  
 445          // Set the flag to skip the folder cling
 446          String spKey = LauncherAppState.getSharedPreferencesKey();
 447          SharedPreferences sp = mLauncher.getSharedPreferences(spKey, Context.MODE_PRIVATE);
 448          SharedPreferences.Editor editor = sp.edit();
 449          editor.putBoolean(Launcher.USER_HAS_MIGRATED, true);
 450          editor.apply();
 451  
 452          // Disable the migration cling
 453          dismissMigrationCling();
 454      }
 455  
 456      public void dismissMigrationClingUseDefault(View v) {
 457          // Clear the workspace
 458          LauncherModel model = mLauncher.getModel();
 459          model.resetLoadedState(false, true);
 460          model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 461                  LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE);
 462  
 463          // Disable the migration cling
 464          dismissMigrationCling();
 465      }
 466  
 467      public void dismissMigrationWorkspaceCling(View v) {
 468          Cling cling = (Cling) mLauncher.findViewById(R.id.migration_workspace_cling);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 469 -        dismissAnyWorkspaceCling(cling, v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 470 +        dismissAnyWorkspaceCling(cling, MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, v);</span>
 471      }
 472  
 473      public void dismissWorkspaceCling(View v) {
 474          Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -        dismissAnyWorkspaceCling(cling, v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 476 +        dismissAnyWorkspaceCling(cling, WORKSPACE_CLING_DISMISSED_KEY, v);</span>
 477      }
 478  
 479      public void dismissFolderCling(View v) {
 480          Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 481          dismissCling(cling, null, FOLDER_CLING_DISMISSED_KEY,
 482                  DISMISS_CLING_DURATION, true);
 483      }
 484  }</pre></td>
                            <td><pre>   1  /*
   2   * Copyright (C) 2008 The Android Open Source Project
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.android.launcher3;
  18  
  19  import android.accounts.Account;
  20  import android.accounts.AccountManager;
  21  import android.animation.Animator;
  22  import android.animation.AnimatorListenerAdapter;
  23  import android.app.ActivityManager;
  24  import android.content.Context;
  25  import android.content.SharedPreferences;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import android.graphics.Rect;</span>
  27  import android.os.Bundle;
  28  import android.os.UserManager;
  29  import android.view.LayoutInflater;
  30  import android.view.View;
  31  import android.view.ViewGroup;
  32  import android.view.accessibility.AccessibilityManager;
  33  import android.widget.TextView;
  34  
  35  class LauncherClings {
  36      private static final String FIRST_RUN_CLING_DISMISSED_KEY = &quot;cling_gel.first_run.dismissed&quot;;
  37      private static final String MIGRATION_CLING_DISMISSED_KEY = &quot;cling_gel.migration.dismissed&quot;;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -    private static final String MIGRATION_WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.migration.dismissed&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +    private static final String MIGRATION_WORKSPACE_CLING_DISMISSED_KEY =</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +            &quot;cling_gel.migration_workspace.dismissed&quot;;</span>
  41      private static final String WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.workspace.dismissed&quot;;
  42      private static final String FOLDER_CLING_DISMISSED_KEY = &quot;cling_gel.folder.dismissed&quot;;
  43  
  44      private static final boolean DISABLE_CLINGS = false;
  45      private static final boolean DISABLE_CUSTOM_CLINGS = true;
  46  
  47      private static final int SHOW_CLING_DURATION = 250;
  48      private static final int DISMISS_CLING_DURATION = 200;
  49  
  50      private Launcher mLauncher;
  51      private LayoutInflater mInflater;
  52      private HideFromAccessibilityHelper mHideFromAccessibilityHelper
  53              = new HideFromAccessibilityHelper();
  54  
  55      /** Ctor */
  56      public LauncherClings(Launcher launcher) {
  57          mLauncher = launcher;
  58          mInflater = mLauncher.getLayoutInflater();
  59      }
  60  
  61      /** Initializes a cling */
  62      private Cling initCling(int clingId, int scrimId, boolean animate,
  63                              boolean dimNavBarVisibilty) {
  64          Cling cling = (Cling) mLauncher.findViewById(clingId);
  65          View scrim = null;
  66          if (scrimId &gt; 0) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -            scrim = mLauncher.findViewById(R.id.cling_scrim);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +            scrim = mLauncher.findViewById(scrimId);</span>
  69          }
  70          if (cling != null) {
  71              cling.init(mLauncher, scrim);
  72              cling.show(animate, SHOW_CLING_DURATION);
  73  
  74              if (dimNavBarVisibilty) {
  75                  cling.setSystemUiVisibility(cling.getSystemUiVisibility() |
  76                          View.SYSTEM_UI_FLAG_LOW_PROFILE);
  77              }
  78          }
  79          return cling;
  80      }
  81  
  82      /** Returns whether the clings are enabled or should be shown */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -    private boolean isClingsEnabled() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +    private boolean areClingsEnabled() {</span>
  85          if (DISABLE_CLINGS) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -            return false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -        // For now, limit only to phones</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -        LauncherAppState app = LauncherAppState.getInstance();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -        DeviceProfile grid = app.getDynamicGrid().getDeviceProfile();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        if (grid.isTablet()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -            return false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -        if (grid.isLandscape) {</span>
  96              return false;
  97          }
  98  
  99          // disable clings when running in a test harness
 100          if(ActivityManager.isRunningInTestHarness()) return false;
 101  
 102          // Disable clings for accessibility when explore by touch is enabled
 103          final AccessibilityManager a11yManager = (AccessibilityManager) mLauncher.getSystemService(
 104                  Launcher.ACCESSIBILITY_SERVICE);
 105          if (a11yManager.isTouchExplorationEnabled()) {
 106              return false;
 107          }
 108  
 109          // Restricted secondary users (child mode) will potentially have very few apps
 110          // seeded when they start up for the first time. Clings won&#x27;t work well with that
 111          boolean supportsLimitedUsers =
 112                  android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.JELLY_BEAN_MR2;
 113          Account[] accounts = AccountManager.get(mLauncher).getAccounts();
 114          if (supportsLimitedUsers &amp;&amp; accounts.length == 0) {
 115              UserManager um = (UserManager) mLauncher.getSystemService(Context.USER_SERVICE);
 116              Bundle restrictions = um.getUserRestrictions();
 117              if (restrictions.getBoolean(UserManager.DISALLOW_MODIFY_ACCOUNTS, false)) {
 118                  return false;
 119              }
 120          }
 121          return true;
 122      }
 123  
 124      /** Returns whether the folder cling is visible. */
 125      public boolean isFolderClingVisible() {
 126          Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 127          if (cling != null) {
 128              return cling.getVisibility() == View.VISIBLE;
 129          }
 130          return false;
 131      }
 132  
 133      private boolean skipCustomClingIfNoAccounts() {
 134          Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 135          boolean customCling = cling.getDrawIdentifier().equals(&quot;workspace_custom&quot;);
 136          if (customCling) {
 137              AccountManager am = AccountManager.get(mLauncher);
 138              if (am == null) return false;
 139              Account[] accounts = am.getAccountsByType(&quot;com.google&quot;);
 140              return accounts.length == 0;
 141          }
 142          return false;
 143      }
 144  
 145      /** Updates the first run cling custom content hint */
 146      private void setCustomContentHintVisibility(Cling cling, String ccHintStr, boolean visible,
 147                                                  boolean animate) {
 148          final TextView ccHint = (TextView) cling.findViewById(R.id.custom_content_hint);
 149          if (ccHint != null) {
 150              if (visible &amp;&amp; !ccHintStr.isEmpty()) {
 151                  ccHint.setText(ccHintStr);
 152                  ccHint.setVisibility(View.VISIBLE);
 153                  if (animate) {
 154                      ccHint.setAlpha(0f);
 155                      ccHint.animate().alpha(1f)
 156                              .setDuration(SHOW_CLING_DURATION)
 157                              .start();
 158                  } else {
 159                      ccHint.setAlpha(1f);
 160                  }
 161              } else {
 162                  if (animate) {
 163                      ccHint.animate().alpha(0f)
 164                              .setDuration(SHOW_CLING_DURATION)
 165                              .setListener(new AnimatorListenerAdapter() {
 166                                  @Override
 167                                  public void onAnimationEnd(Animator animation) {
 168                                      ccHint.setVisibility(View.GONE);
 169                                  }
 170                              })
 171                              .start();
 172                  } else {
 173                      ccHint.setAlpha(0f);
 174                      ccHint.setVisibility(View.GONE);
 175                  }
 176              }
 177          }
 178      }
 179  
 180      /** Updates the first run cling custom content hint */
 181      public void updateCustomContentHintVisibility() {
 182          Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 183          String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 184  
 185          if (mLauncher.getWorkspace().hasCustomContent()) {
 186              // Show the custom content hint if ccHintStr is not empty
 187              if (cling != null) {
 188                  setCustomContentHintVisibility(cling, ccHintStr, true, true);
 189              }
 190          } else {
 191              // Hide the custom content hint
 192              if (cling != null) {
 193                  setCustomContentHintVisibility(cling, ccHintStr, false, true);
 194              }
 195          }
 196      }
 197  
 198      /** Updates the first run cling search bar hint. */
 199      public void updateSearchBarHint(String hint) {
 200          Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 201          if (cling != null &amp;&amp; cling.getVisibility() == View.VISIBLE &amp;&amp; !hint.isEmpty()) {
 202              TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 203              sbHint.setText(hint);
 204              sbHint.setVisibility(View.VISIBLE);
 205          }
 206      }
 207  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -    /** Shows the first run cling */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +    public boolean shouldShowFirstRunOrMigrationClings() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +        SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +        return areClingsEnabled() &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 212 +            !sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false) &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +            !sharedPrefs.getBoolean(MIGRATION_CLING_DISMISSED_KEY, false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +    public void removeFirstRunAndMigrationClings() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +        removeCling(R.id.first_run_cling);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +        removeCling(R.id.migration_cling);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +     * Shows the first run cling.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +     * This flow is mutually exclusive with showMigrationCling, and only runs if this Launcher</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +     * package was preinstalled or there is no db to migrate from.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +     */</span>
 227      public void showFirstRunCling() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -        SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -        if (isClingsEnabled() &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -                !sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false) &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -                !skipCustomClingIfNoAccounts() ) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +        if (!skipCustomClingIfNoAccounts()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +            SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();</span>
 236              // If we&#x27;re not using the default workspace layout, replace workspace cling
 237              // with a custom workspace cling (usually specified in an overlay)
 238              // For now, only do this on tablets
 239              if (!DISABLE_CUSTOM_CLINGS) {
 240                  if (sharedPrefs.getInt(LauncherProvider.DEFAULT_WORKSPACE_RESOURCE_ID, 0) != 0 &amp;&amp;
 241                          mLauncher.getResources().getBoolean(R.bool.config_useCustomClings)) {
 242                      // Use a custom cling
 243                      View cling = mLauncher.findViewById(R.id.workspace_cling);
 244                      ViewGroup clingParent = (ViewGroup) cling.getParent();
 245                      int clingIndex = clingParent.indexOfChild(cling);
 246                      clingParent.removeViewAt(clingIndex);
 247                      View customCling = mInflater.inflate(R.layout.custom_workspace_cling,
 248                              clingParent, false);
 249                      clingParent.addView(customCling, clingIndex);
 250                      customCling.setId(R.id.workspace_cling);
 251                  }
 252              }
 253              Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 254              if (cling != null) {
 255                  String sbHintStr = mLauncher.getFirstRunClingSearchBarHint();
 256                  String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 257                  if (!sbHintStr.isEmpty()) {
 258                      TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 259                      sbHint.setText(sbHintStr);
 260                      sbHint.setVisibility(View.VISIBLE);
 261                  }
 262                  setCustomContentHintVisibility(cling, ccHintStr, true, false);
 263              }
 264              initCling(R.id.first_run_cling, 0, false, true);
 265          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -            removeCling(R.id.first_run_cling);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +            removeFirstRunAndMigrationClings();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +     * Shows the migration cling.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +     *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +     * This flow is mutually exclusive with showFirstRunCling, and only runs if this Launcher</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +     * package was not preinstalled and there exists a db to migrate from.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +     */</span>
 280      public void showMigrationCling() {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -        // Enable the clings only if they have not been dismissed before</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -        if (isClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -                MIGRATION_CLING_DISMISSED_KEY, false)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -            mLauncher.hideWorkspaceSearchAndHotseat();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -            Cling c = initCling(R.id.migration_cling, 0, false, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -            c.bringScrimToFront();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -            c.bringToFront();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -            removeCling(R.id.migration_cling);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +        mLauncher.hideWorkspaceSearchAndHotseat();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +        Cling c = initCling(R.id.migration_cling, 0, false, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +        c.bringScrimToFront();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +        c.bringToFront();</span>
 297      }
 298  
 299      public void showMigrationWorkspaceCling() {
 300          // Enable the clings only if they have not been dismissed before
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -        if (isClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +        if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(</span>
 303                  MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, false)) {
 304              Cling c = initCling(R.id.migration_workspace_cling, 0, false, true);
 305              c.updateMigrationWorkspaceBubblePosition();
 306              c.bringScrimToFront();
 307              c.bringToFront();
 308          } else {
 309              removeCling(R.id.migration_workspace_cling);
 310          }
 311      }
 312  
 313      public void showWorkspaceCling() {
 314          // Enable the clings only if they have not been dismissed before
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -        if (isClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +        if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(</span>
 317                  WORKSPACE_CLING_DISMISSED_KEY, false)) {
 318              Cling c = initCling(R.id.workspace_cling, 0, false, true);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +            c.updateWorkspaceBubblePosition();</span>
 320  
 321              // Set the focused hotseat app if there is one
 322              c.setFocusedHotseatApp(mLauncher.getFirstRunFocusedHotseatAppDrawableId(),
 323                      mLauncher.getFirstRunFocusedHotseatAppRank(),
 324                      mLauncher.getFirstRunFocusedHotseatAppComponentName(),
 325                      mLauncher.getFirstRunFocusedHotseatAppBubbleTitle(),
 326                      mLauncher.getFirstRunFocusedHotseatAppBubbleDescription());
 327          } else {
 328              removeCling(R.id.workspace_cling);
 329          }
 330      }
 331      public Cling showFoldersCling() {
 332          SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 333          // Enable the clings only if they have not been dismissed before
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -        if (isClingsEnabled() &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +        if (areClingsEnabled() &amp;&amp;</span>
 336                  !sharedPrefs.getBoolean(FOLDER_CLING_DISMISSED_KEY, false) &amp;&amp;
 337                  !sharedPrefs.getBoolean(Launcher.USER_HAS_MIGRATED, false)) {
 338              Cling cling = initCling(R.id.folder_cling, R.id.cling_scrim,
 339                      true, true);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +            Folder openFolder = mLauncher.getWorkspace().getOpenFolder();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +            if (openFolder != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +                Rect openFolderRect = new Rect();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +                openFolder.getHitRect(openFolderRect);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +                cling.setOpenFolderRect(openFolderRect);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +                openFolder.bringToFront();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +            }</span>
 347              return cling;
 348          } else {
 349              removeCling(R.id.folder_cling);
 350              return null;
 351          }
 352      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -</span>
 354  
 355      /** Removes the cling outright from the DragLayer */
 356      private void removeCling(int id) {
 357          final View cling = mLauncher.findViewById(id);
 358          if (cling != null) {
 359              final ViewGroup parent = (ViewGroup) cling.getParent();
 360              parent.post(new Runnable() {
 361                  @Override
 362                  public void run() {
 363                      parent.removeView(cling);
 364                  }
 365              });
 366              mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 367          }
 368      }
 369  
 370      /** Hides the specified Cling */
 371      private void dismissCling(final Cling cling, final Runnable postAnimationCb,
 372                                final String flag, int duration, boolean restoreNavBarVisibilty) {
 373          // To catch cases where siblings of top-level views are made invisible, just check whether
 374          // the cling is directly set to GONE before dismissing it.
 375          if (cling != null &amp;&amp; cling.getVisibility() != View.GONE) {
 376              final Runnable cleanUpClingCb = new Runnable() {
 377                  public void run() {
 378                      cling.cleanup();
 379                      SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();
 380                      editor.putBoolean(flag, true);
 381                      editor.apply();
 382                      if (postAnimationCb != null) {
 383                          postAnimationCb.run();
 384                      }
 385                  }
 386              };
 387              if (duration &lt;= 0) {
 388                  cleanUpClingCb.run();
 389              } else {
 390                  cling.hide(duration, cleanUpClingCb);
 391              }
 392              mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 393  
 394              if (restoreNavBarVisibilty) {
 395                  cling.setSystemUiVisibility(cling.getSystemUiVisibility() &amp;
 396                          ~View.SYSTEM_UI_FLAG_LOW_PROFILE);
 397              }
 398          }
 399      }
 400  
 401      public void dismissFirstRunCling(View v) {
 402          Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 403          Runnable cb = new Runnable() {
 404              public void run() {
 405                  // Show the workspace cling next
 406                  showWorkspaceCling();
 407              }
 408          };
 409          dismissCling(cling, cb, FIRST_RUN_CLING_DISMISSED_KEY,
 410                  DISMISS_CLING_DURATION, false);
 411  
 412          // Fade out the search bar for the workspace cling coming up
 413          mLauncher.getSearchBar().hideSearchBar(true);
 414      }
 415  
 416      private void dismissMigrationCling() {
 417          mLauncher.showWorkspaceSearchAndHotseat();
 418          Runnable dismissCb = new Runnable() {
 419              public void run() {
 420                  Cling cling = (Cling) mLauncher.findViewById(R.id.migration_cling);
 421                  Runnable cb = new Runnable() {
 422                      public void run() {
 423                          // Show the migration workspace cling next
 424                          showMigrationWorkspaceCling();
 425                      }
 426                  };
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 427 -                dismissCling(cling, cb, WORKSPACE_CLING_DISMISSED_KEY,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 428 +                dismissCling(cling, cb, MIGRATION_CLING_DISMISSED_KEY,</span>
 429                          DISMISS_CLING_DURATION, true);
 430              }
 431          };
 432          mLauncher.getWorkspace().post(dismissCb);
 433      }
 434  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 435 -    private void dismissAnyWorkspaceCling(Cling cling, View v) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 436 +    private void dismissAnyWorkspaceCling(Cling cling, String key, View v) {</span>
 437          Runnable cb = null;
 438          if (v == null) {
 439              cb = new Runnable() {
 440                  public void run() {
 441                      mLauncher.getWorkspace().enterOverviewMode();
 442                  }
 443              };
 444          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 445 -        dismissCling(cling, cb, WORKSPACE_CLING_DISMISSED_KEY,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -                DISMISS_CLING_DURATION, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 447 +        dismissCling(cling, cb, key, DISMISS_CLING_DURATION, true);</span>
 448  
 449          // Fade in the search bar
 450          mLauncher.getSearchBar().showSearchBar(true);
 451      }
 452  
 453      public void dismissMigrationClingCopyApps(View v) {
 454          // Copy the shortcuts from the old database
 455          LauncherModel model = mLauncher.getModel();
 456          model.resetLoadedState(false, true);
 457          model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 458                  LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE
 459                          | LauncherModel.LOADER_FLAG_MIGRATE_SHORTCUTS);
 460  
 461          // Set the flag to skip the folder cling
 462          String spKey = LauncherAppState.getSharedPreferencesKey();
 463          SharedPreferences sp = mLauncher.getSharedPreferences(spKey, Context.MODE_PRIVATE);
 464          SharedPreferences.Editor editor = sp.edit();
 465          editor.putBoolean(Launcher.USER_HAS_MIGRATED, true);
 466          editor.apply();
 467  
 468          // Disable the migration cling
 469          dismissMigrationCling();
 470      }
 471  
 472      public void dismissMigrationClingUseDefault(View v) {
 473          // Clear the workspace
 474          LauncherModel model = mLauncher.getModel();
 475          model.resetLoadedState(false, true);
 476          model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 477                  LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE);
 478  
 479          // Disable the migration cling
 480          dismissMigrationCling();
 481      }
 482  
 483      public void dismissMigrationWorkspaceCling(View v) {
 484          Cling cling = (Cling) mLauncher.findViewById(R.id.migration_workspace_cling);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 485 -        dismissAnyWorkspaceCling(cling, v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 486 +        dismissAnyWorkspaceCling(cling, MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, v);</span>
 487      }
 488  
 489      public void dismissWorkspaceCling(View v) {
 490          Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 491 -        dismissAnyWorkspaceCling(cling, v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 492 +        dismissAnyWorkspaceCling(cling, WORKSPACE_CLING_DISMISSED_KEY, v);</span>
 493      }
 494  
 495      public void dismissFolderCling(View v) {
 496          Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 497          dismissCling(cling, null, FOLDER_CLING_DISMISSED_KEY,
 498                  DISMISS_CLING_DURATION, true);
 499      }
 500  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            