<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>174</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    174
                    <a href="173.html">prev</a>
                    <a href="175.html">next</a>
                    <a href="174_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_b2742e6260e4e7d992c82e42c7d3b352419d17bb_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/checkout/service/CheckoutServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;b2742e6260e4e7d992c82e42c7d3b352419d17bb:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/checkout/service/CheckoutServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;b2742e6260e4e7d992c82e42c7d3b352419d17bb^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/checkout/service/CheckoutServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;b2742e6260e4e7d992c82e42c7d3b352419d17bb^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/checkout/service/CheckoutServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;0e1bf7b54bdd251cdbd1077c4e8dc9aae3c8dc95:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/checkout/service/CheckoutServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [j], [j], [j], [j]], subset: [[bj], [bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.checkout.service;
  19 
  20 import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;
  21 import org.broadleafcommerce.common.event.OrderSubmittedEvent;
  22 import org.broadleafcommerce.core.checkout.service.exception.CheckoutException;
  23 import org.broadleafcommerce.core.checkout.service.workflow.CheckoutResponse;
  24 import org.broadleafcommerce.core.checkout.service.workflow.CheckoutSeed;
  25 import org.broadleafcommerce.core.order.domain.Order;
  26 import org.broadleafcommerce.core.order.service.OrderService;
  27 import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  28 import org.broadleafcommerce.core.order.service.type.OrderStatus;
  29 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  30 import org.broadleafcommerce.core.workflow.ActivityMessages;
  31 import org.broadleafcommerce.core.workflow.ProcessContext;
  32 import org.broadleafcommerce.core.workflow.Processor;
  33 import org.broadleafcommerce.core.workflow.WorkflowException;
  34 import org.springframework.beans.factory.annotation.Autowired;
  35 import org.springframework.beans.factory.annotation.Qualifier;
  36 import org.springframework.stereotype.Service;
  37 import java.util.HashMap;
  38 import java.util.concurrent.ConcurrentHashMap;
  39 import java.util.concurrent.ConcurrentMap;
  40 import javax.annotation.Resource;
  41 
  42 @Service(&quot;blCheckoutService&quot;)
  43 public class CheckoutServiceImpl implements CheckoutService {
  44 
  45     @Resource(name=&quot;blCheckoutWorkflow&quot;)
  46     protected Processor&lt;CheckoutSeed, CheckoutSeed&gt; checkoutWorkflow;
  47 
  48     @Autowired
  49     @Qualifier(&quot;blApplicationEventPublisher&quot;)
  50     protected BroadleafApplicationEventPublisher eventPublisher;
  51 
  52     @Resource(name=&quot;blOrderService&quot;)
  53     protected OrderService orderService;
  54 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  55 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  58      * Map of locks for given order ids. This lock map ensures that only a single request can handle a particular order">  58      * Map of locks for given order ids. This lock map ensures that only a single request can handle a paðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59      * at a time</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     protected static ConcurrentMap&lt;Long, Object&gt; lockMap = new ConcurrentHashMap&lt;&gt;();</span>
  62 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65      * @deprecated no longer supported - simplifying interface</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68     protected static ConcurrentMap&lt;Long, Object&gt; lockMap = new ConcurrentHashMap&lt;&gt;();</span>
  69 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  70 
  71     @Override
  72     public CheckoutResponse performCheckout(Order order) throws CheckoutException {
  73         // Immediately fail if this order has already been checked out previously
  74         if (hasOrderBeenCompleted(order)) {
<abbr title="  75             throw new CheckoutException(&quot;This order has already been submitted or cancelled, unable to checkout order -- id: &quot; + order.getId(), new CheckoutSeed(order, new HashMap&lt;String, Object&gt;()));">  75             throw new CheckoutException(&quot;This order has already been submitted or cancelled, unable to chðŸ”µ</abbr>
  76         }
  77         
  78         CheckoutSeed seed = null;
  79         try {
  80             // Do a final save of the order before going through with the checkout workflow
  81             order = orderService.save(order, false);
  82             seed = new CheckoutSeed(order, new HashMap&lt;&gt;());
  83 
  84             ProcessContext&lt;CheckoutSeed&gt; context = checkoutWorkflow.doActivities(seed);
  85 
<abbr title="  86             // We need to pull the order off the seed and save it here in case any activity modified the order.">  86             // We need to pull the order off the seed and save it here in case any activity modified the ðŸ”µ</abbr>
  87             order = orderService.save(seed.getOrder(), false);
  88             order.getOrderMessages().addAll(((ActivityMessages) context).getActivityMessages());
  89             seed.setOrder(order);
  90 
<abbr title="  91             OrderSubmittedEvent event = new OrderSubmittedEvent(this, seed.getOrder().getId(), seed.getOrder().getOrderNumber());">  91             OrderSubmittedEvent event = new OrderSubmittedEvent(this, seed.getOrder().getId(), seed.getOrðŸ”µ</abbr>
  92             eventPublisher.publishEvent(event);
  93 
  94             return seed;
  95         } catch (PricingException e) {
  96             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e, seed);
  97         } catch (WorkflowException e) {
<abbr title="  98             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getRootCause(), seed);">  98             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getRootCausðŸ”µ</abbr>
  99         } catch (RequiredAttributeNotProvidedException e) {
<abbr title=" 100             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getCause(), seed);"> 100             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getCause(),ðŸ”µ</abbr>
 101         }
 102     }
 103     
 104     /**
 105      * Checks if the &lt;b&gt;order&lt;/b&gt; has already been gone through the checkout workflow.
 106      * 
 107      * @param order
 108      * @return
 109      */
 110     protected boolean hasOrderBeenCompleted(Order order) {
<abbr title=" 111         return (OrderStatus.SUBMITTED.equals(order.getStatus()) || OrderStatus.CANCELLED.equals(order.getStatus()));"> 111         return (OrderStatus.SUBMITTED.equals(order.getStatus()) || OrderStatus.CANCELLED.equals(order.getðŸ”µ</abbr>
 112     }
 113 
 114 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 115 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116             // The order has completed processing, remove the order from the processing map</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117             removeLock(order.getId());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122      * Checks if the &lt;b&gt;order&lt;/b&gt; has already been gone through the checkout workflow.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123      * </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124      * @param order</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125      * @return</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127     protected boolean hasOrderBeenCompleted(Order order) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 128         return (OrderStatus.SUBMITTED.equals(order.getStatus()) || OrderStatus.CANCELLED.equals(order.getStatus()));"> 128         return (OrderStatus.SUBMITTED.equals(order.getStatus()) || OrderStatus.CANCELLED.equals(order.getðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     * Get an object to lock on for the given order id</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133     * </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134     * @param orderId</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 135     * @return null if there was not already a lock object available. If an object was already in the map, this will return"> 135     * @return null if there was not already a lock object available. If an object was already in the map,ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 136     * that object, which means that there is already a thread attempting to go through the checkout workflow"> 136     * that object, which means that there is already a thread attempting to go through the checkout workfðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137     */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     protected Object putLock(Long orderId) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         return lockMap.putIfAbsent(orderId, new Object());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143      * Done with processing the given orderId, remove the lock from the map</span>
 144 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146      * @deprecated no longer supported - simplifying interface</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149     protected Object putLock(Long orderId) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150         return lockMap.putIfAbsent(orderId, new Object());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154      * @deprecated no longer supported - simplifying interface</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157     protected void removeLock(Long orderId) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158         lockMap.remove(orderId);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160     </span>
 161 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 162 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.checkout.service;
  19 
  20 import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;
  21 import org.broadleafcommerce.common.event.OrderSubmittedEvent;
  22 import org.broadleafcommerce.core.checkout.service.exception.CheckoutException;
  23 import org.broadleafcommerce.core.checkout.service.workflow.CheckoutResponse;
  24 import org.broadleafcommerce.core.checkout.service.workflow.CheckoutSeed;
  25 import org.broadleafcommerce.core.order.domain.Order;
  26 import org.broadleafcommerce.core.order.service.OrderService;
  27 import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  28 import org.broadleafcommerce.core.order.service.type.OrderStatus;
  29 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  30 import org.broadleafcommerce.core.workflow.ActivityMessages;
  31 import org.broadleafcommerce.core.workflow.ProcessContext;
  32 import org.broadleafcommerce.core.workflow.Processor;
  33 import org.broadleafcommerce.core.workflow.WorkflowException;
  34 import org.springframework.beans.factory.annotation.Autowired;
  35 import org.springframework.beans.factory.annotation.Qualifier;
  36 import org.springframework.stereotype.Service;
  37 import java.util.HashMap;
  38 import java.util.concurrent.ConcurrentHashMap;
  39 import java.util.concurrent.ConcurrentMap;
  40 import javax.annotation.Resource;
  41 
  42 @Service(&quot;blCheckoutService&quot;)
  43 public class CheckoutServiceImpl implements CheckoutService {
  44 
  45     @Resource(name=&quot;blCheckoutWorkflow&quot;)
  46     protected Processor&lt;CheckoutSeed, CheckoutSeed&gt; checkoutWorkflow;
  47 
  48     @Autowired
  49     @Qualifier(&quot;blApplicationEventPublisher&quot;)
  50     protected BroadleafApplicationEventPublisher eventPublisher;
  51 
  52     @Resource(name=&quot;blOrderService&quot;)
  53     protected OrderService orderService;
  54 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
  55 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  59      * Map of locks for given order ids. This lock map ensures that only a single request can handle a particular order">  59      * Map of locks for given order ids. This lock map ensures that only a single request can handle a paðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60      * at a time</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 </span>
  63 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67      * @deprecated no longer supported - simplifying interface</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69 </span>
  70 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  71 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
  72 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73 protected static ConcurrentMap&lt;Long, Object&gt; lockMap = new ConcurrentHashMap&lt;&gt;();</span>
  74 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75 @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76     protected static ConcurrentMap&lt;Long, Object&gt; lockMap = new ConcurrentHashMap&lt;&gt;();</span>
  77 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  78 
  79 
  80     @Override
  81     public CheckoutResponse performCheckout(Order order) throws CheckoutException {
  82         // Immediately fail if this order has already been checked out previously
  83         if (hasOrderBeenCompleted(order)) {
<abbr title="  84             throw new CheckoutException(&quot;This order has already been submitted or cancelled, unable to checkout order -- id: &quot; + order.getId(), new CheckoutSeed(order, new HashMap&lt;String, Object&gt;()));">  84             throw new CheckoutException(&quot;This order has already been submitted or cancelled, unable to chðŸ”µ</abbr>
  85         }
  86 
  87         CheckoutSeed seed = null;
  88         try {
  89             // Do a final save of the order before going through with the checkout workflow
  90             order = orderService.save(order, false);
  91             seed = new CheckoutSeed(order, new HashMap&lt;&gt;());
  92 
  93             ProcessContext&lt;CheckoutSeed&gt; context = checkoutWorkflow.doActivities(seed);
  94 
<abbr title="  95             // We need to pull the order off the seed and save it here in case any activity modified the order.">  95             // We need to pull the order off the seed and save it here in case any activity modified the ðŸ”µ</abbr>
  96             order = orderService.save(seed.getOrder(), false);
  97             order.getOrderMessages().addAll(((ActivityMessages) context).getActivityMessages());
  98             seed.setOrder(order);
  99 
<abbr title=" 100             OrderSubmittedEvent event = new OrderSubmittedEvent(this, seed.getOrder().getId(), seed.getOrder().getOrderNumber());"> 100             OrderSubmittedEvent event = new OrderSubmittedEvent(this, seed.getOrder().getId(), seed.getOrðŸ”µ</abbr>
 101             eventPublisher.publishEvent(event);
 102 
 103             return seed;
 104         } catch (PricingException e) {
 105             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e, seed);
 106         } catch (WorkflowException e) {
<abbr title=" 107             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getRootCause(), seed);"> 107             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getRootCausðŸ”µ</abbr>
 108         } catch (RequiredAttributeNotProvidedException e) {
<abbr title=" 109             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getCause(), seed);"> 109             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getCause(),ðŸ”µ</abbr>
 110         }
 111     }
 112 
 113     /**
 114      * Checks if the &lt;b&gt;order&lt;/b&gt; has already been gone through the checkout workflow.
 115      *
 116      * @param order
 117      * @return
 118      */
 119     protected boolean hasOrderBeenCompleted(Order order) {
<abbr title=" 120         return (OrderStatus.SUBMITTED.equals(order.getStatus()) || OrderStatus.CANCELLED.equals(order.getStatus()));"> 120         return (OrderStatus.SUBMITTED.equals(order.getStatus()) || OrderStatus.CANCELLED.equals(order.getðŸ”µ</abbr>
 121     }
 122 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 123 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127     * Get an object to lock on for the given order id</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128     *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129     * @param orderId</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 130     * @return null if there was not already a lock object available. If an object was already in the map, this will return"> 130     * @return null if there was not already a lock object available. If an object was already in the map,ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 131     * that object, which means that there is already a thread attempting to go through the checkout workflow"> 131     * that object, which means that there is already a thread attempting to go through the checkout workfðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
 134 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138      * @deprecated no longer supported - simplifying interface</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140 </span>
 141 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 142 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 143 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144 protected Object putLock(Long orderId) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145         return lockMap.putIfAbsent(orderId, new Object());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146     }</span>
 147 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148 @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149     protected Object putLock(Long orderId) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150         return lockMap.putIfAbsent(orderId, new Object());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151     }</span>
 152 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 153 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 154 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158      * Done with processing the given orderId, remove the lock from the map</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160      * @param orderId</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 </span>
 163 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167      * @deprecated no longer supported - simplifying interface</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169 </span>
 170 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 171 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 172 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173 protected void removeLock(Long orderId) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174         lockMap.remove(orderId);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175     }</span>
 176 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177 @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178     protected void removeLock(Long orderId) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179         lockMap.remove(orderId);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180     }</span>
 181 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 182 
 183 
 184 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.checkout.service;
  19 
  20 import java.util.HashMap;
  21 import java.util.concurrent.ConcurrentHashMap;
  22 import java.util.concurrent.ConcurrentMap;
  23 import javax.annotation.Resource;
  24 import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;
  25 import org.broadleafcommerce.common.event.OrderSubmittedEvent;
  26 import org.broadleafcommerce.core.checkout.service.exception.CheckoutException;
  27 import org.broadleafcommerce.core.checkout.service.workflow.CheckoutResponse;
  28 import org.broadleafcommerce.core.checkout.service.workflow.CheckoutSeed;
  29 import org.broadleafcommerce.core.order.domain.Order;
  30 import org.broadleafcommerce.core.order.service.OrderService;
  31 import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  32 import org.broadleafcommerce.core.order.service.type.OrderStatus;
  33 import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  34 import org.broadleafcommerce.core.workflow.ActivityMessages;
  35 import org.broadleafcommerce.core.workflow.ProcessContext;
  36 import org.broadleafcommerce.core.workflow.Processor;
  37 import org.broadleafcommerce.core.workflow.WorkflowException;
  38 import org.springframework.beans.factory.annotation.Autowired;
  39 import org.springframework.beans.factory.annotation.Qualifier;
  40 import org.springframework.stereotype.Service;
  41 
  42 
  43 @Service(&quot;blCheckoutService&quot;)
  44 public class CheckoutServiceImpl implements CheckoutService {
  45     @Resource(name = &quot;blCheckoutWorkflow&quot;)
  46     protected Processor&lt;CheckoutSeed, CheckoutSeed&gt; checkoutWorkflow;
  47 
  48     @Autowired
  49     @Qualifier(&quot;blApplicationEventPublisher&quot;)
  50     protected BroadleafApplicationEventPublisher eventPublisher;
  51 
  52     @Resource(name=&quot;blOrderService&quot;)
  53     protected OrderService orderService;
  54 
  55     @Override
  56     public CheckoutResponse performCheckout(Order order) throws CheckoutException {
  57         // Immediately fail if this order has already been checked out previously
  58         if (hasOrderBeenCompleted(order)) {
<abbr title="  59             throw new CheckoutException(&quot;This order has already been submitted or cancelled, unable to checkout order -- id: &quot; + order.getId(), new CheckoutSeed(order, new HashMap&lt;String, Object&gt;()));">  59             throw new CheckoutException(&quot;This order has already been submitted or cancelled, unable to chðŸ”µ</abbr>
  60         }
  61         CheckoutSeed seed = null;
  62         try {
  63             // Do a final save of the order before going through with the checkout workflow
  64             order = orderService.save(order, false);
  65             seed = new CheckoutSeed(order, new HashMap&lt;&gt;());
  66             ProcessContext&lt;CheckoutSeed&gt; context = checkoutWorkflow.doActivities(seed);
<abbr title="  67             // We need to pull the order off the seed and save it here in case any activity modified the order.">  67             // We need to pull the order off the seed and save it here in case any activity modified the ðŸ”µ</abbr>
  68             order = orderService.save(seed.getOrder(), false);
  69             order.getOrderMessages().addAll(((ActivityMessages) (context)).getActivityMessages());
  70             seed.setOrder(order);
<abbr title="  71             OrderSubmittedEvent event = new OrderSubmittedEvent(this, seed.getOrder().getId(), seed.getOrder().getOrderNumber());">  71             OrderSubmittedEvent event = new OrderSubmittedEvent(this, seed.getOrder().getId(), seed.getOrðŸ”µ</abbr>
  72             eventPublisher.publishEvent(event);
  73             return seed;
  74         } catch (PricingException e) {
  75             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e, seed);
  76         } catch (WorkflowException e) {
<abbr title="  77             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getRootCause(), seed);">  77             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getRootCausðŸ”µ</abbr>
  78         } catch (RequiredAttributeNotProvidedException e) {
<abbr title="  79             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getCause(), seed);">  79             throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getCause(),ðŸ”µ</abbr>
  80         }
  81     }
  82 
  83     /**
  84      * Checks if the &lt;b&gt;order&lt;/b&gt; has already been gone through the checkout workflow.
  85      *
  86      * @param order
  87      * @return
  88      */
  89     protected boolean hasOrderBeenCompleted(Order order) {
<abbr title="  90         return (OrderStatus.SUBMITTED.equals(order.getStatus()) || OrderStatus.CANCELLED.equals(order.getStatus()));">  90         return (OrderStatus.SUBMITTED.equals(order.getStatus()) || OrderStatus.CANCELLED.equals(order.getðŸ”µ</abbr>
  91     }
  92 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.checkout.service;
  19  
  20  import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;
  21  import org.broadleafcommerce.common.event.OrderSubmittedEvent;
  22  import org.broadleafcommerce.core.checkout.service.exception.CheckoutException;
  23  import org.broadleafcommerce.core.checkout.service.workflow.CheckoutResponse;
  24  import org.broadleafcommerce.core.checkout.service.workflow.CheckoutSeed;
  25  import org.broadleafcommerce.core.order.domain.Order;
  26  import org.broadleafcommerce.core.order.service.OrderService;
  27  import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  28  import org.broadleafcommerce.core.order.service.type.OrderStatus;
  29  import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  30  import org.broadleafcommerce.core.workflow.ActivityMessages;
  31  import org.broadleafcommerce.core.workflow.ProcessContext;
  32  import org.broadleafcommerce.core.workflow.Processor;
  33  import org.broadleafcommerce.core.workflow.WorkflowException;
  34  import org.springframework.beans.factory.annotation.Autowired;
  35  import org.springframework.beans.factory.annotation.Qualifier;
  36  import org.springframework.stereotype.Service;
  37  import java.util.HashMap;
  38  import java.util.concurrent.ConcurrentHashMap;
  39  import java.util.concurrent.ConcurrentMap;
  40  import javax.annotation.Resource;
  41  
  42  @Service(&quot;blCheckoutService&quot;)
  43  public class CheckoutServiceImpl implements CheckoutService {
  44  
  45      @Resource(name=&quot;blCheckoutWorkflow&quot;)
  46      protected Processor&lt;CheckoutSeed, CheckoutSeed&gt; checkoutWorkflow;
  47  
  48      @Autowired
  49      @Qualifier(&quot;blApplicationEventPublisher&quot;)
  50      protected BroadleafApplicationEventPublisher eventPublisher;
  51  
  52      @Resource(name=&quot;blOrderService&quot;)
  53      protected OrderService orderService;
  54  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  56 -     * Map of locks for given order ids. This lock map ensures that only a single request can handle a particular order">  56 -     * Map of locks for given order ids. This lock map ensures that only a single request can handle a particular ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -     * at a time</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -     */</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -    protected static ConcurrentMap&lt;Long, Object&gt; lockMap = new ConcurrentHashMap&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -</span>
  61      @Override
  62      public CheckoutResponse performCheckout(Order order) throws CheckoutException {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -        //Immediately fail if another thread is currently attempting to check out the order</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -        Object lockObject = putLock(order.getId());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -        if (lockObject != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  66 -            throw new CheckoutException(&quot;This order is already in the process of being submitted, unable to checkout order -- id: &quot; + order.getId(), new CheckoutSeed(order, new HashMap&lt;String, Object&gt;()));">  66 -            throw new CheckoutException(&quot;This order is already in the process of being submitted, unable to checkoðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -</span>
  69          // Immediately fail if this order has already been checked out previously
  70          if (hasOrderBeenCompleted(order)) {
<abbr title="  71              throw new CheckoutException(&quot;This order has already been submitted or cancelled, unable to checkout order -- id: &quot; + order.getId(), new CheckoutSeed(order, new HashMap&lt;String, Object&gt;()));">  71              throw new CheckoutException(&quot;This order has already been submitted or cancelled, unable to checkout orðŸ”µ</abbr>
  72          }
  73  
  74          CheckoutSeed seed = null;
  75          try {
  76              // Do a final save of the order before going through with the checkout workflow
  77              order = orderService.save(order, false);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -            seed = new CheckoutSeed(order, new HashMap&lt;String, Object&gt;());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +            seed = new CheckoutSeed(order, new HashMap&lt;&gt;());</span>
  80  
  81              ProcessContext&lt;CheckoutSeed&gt; context = checkoutWorkflow.doActivities(seed);
  82  
  83              // We need to pull the order off the seed and save it here in case any activity modified the order.
  84              order = orderService.save(seed.getOrder(), false);
  85              order.getOrderMessages().addAll(((ActivityMessages) context).getActivityMessages());
  86              seed.setOrder(order);
  87  
<abbr title="  88              OrderSubmittedEvent event = new OrderSubmittedEvent(this, seed.getOrder().getId(), seed.getOrder().getOrderNumber());">  88              OrderSubmittedEvent event = new OrderSubmittedEvent(this, seed.getOrder().getId(), seed.getOrder().getðŸ”µ</abbr>
  89              eventPublisher.publishEvent(event);
  90  
  91              return seed;
  92          } catch (PricingException e) {
  93              throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e, seed);
  94          } catch (WorkflowException e) {
<abbr title="  95              throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getRootCause(), seed);">  95              throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getRootCause(), seedðŸ”µ</abbr>
  96          } catch (RequiredAttributeNotProvidedException e) {
  97              throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getCause(), seed);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -        } finally {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -            // The order has completed processing, remove the order from the processing map</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -            removeLock(order.getId());</span>
 101          }
 102      }
 103  
 104      /**
 105       * Checks if the &lt;b&gt;order&lt;/b&gt; has already been gone through the checkout workflow.
 106       *
 107       * @param order
 108       * @return
 109       */
 110      protected boolean hasOrderBeenCompleted(Order order) {
<abbr title=" 111          return (OrderStatus.SUBMITTED.equals(order.getStatus()) || OrderStatus.CANCELLED.equals(order.getStatus()));"> 111          return (OrderStatus.SUBMITTED.equals(order.getStatus()) || OrderStatus.CANCELLED.equals(order.getStatus())ðŸ”µ</abbr>
 112      }
 113  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -    * Get an object to lock on for the given order id</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -    *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -    * @param orderId</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 118 -    * @return null if there was not already a lock object available. If an object was already in the map, this will return"> 118 -    * @return null if there was not already a lock object available. If an object was already in the map, this wilðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -    * that object, which means that there is already a thread attempting to go through the checkout workflow</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -    */</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -    protected Object putLock(Long orderId) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -        return lockMap.putIfAbsent(orderId, new Object());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -     * Done with processing the given orderId, remove the lock from the map</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -     * @param orderId</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -     */</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -    protected void removeLock(Long orderId) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -        lockMap.remove(orderId);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -</span>
 134  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.checkout.service;
  19  
  20  import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;
  21  import org.broadleafcommerce.common.event.OrderSubmittedEvent;
  22  import org.broadleafcommerce.core.checkout.service.exception.CheckoutException;
  23  import org.broadleafcommerce.core.checkout.service.workflow.CheckoutResponse;
  24  import org.broadleafcommerce.core.checkout.service.workflow.CheckoutSeed;
  25  import org.broadleafcommerce.core.order.domain.Order;
  26  import org.broadleafcommerce.core.order.service.OrderService;
  27  import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;
  28  import org.broadleafcommerce.core.order.service.type.OrderStatus;
  29  import org.broadleafcommerce.core.pricing.service.exception.PricingException;
  30  import org.broadleafcommerce.core.workflow.ActivityMessages;
  31  import org.broadleafcommerce.core.workflow.ProcessContext;
  32  import org.broadleafcommerce.core.workflow.Processor;
  33  import org.broadleafcommerce.core.workflow.WorkflowException;
  34  import org.springframework.beans.factory.annotation.Autowired;
  35  import org.springframework.beans.factory.annotation.Qualifier;
  36  import org.springframework.stereotype.Service;
  37  import java.util.HashMap;
  38  import java.util.concurrent.ConcurrentHashMap;
  39  import java.util.concurrent.ConcurrentMap;
  40  import javax.annotation.Resource;
  41  
  42  @Service(&quot;blCheckoutService&quot;)
  43  public class CheckoutServiceImpl implements CheckoutService {
  44  
  45      @Resource(name=&quot;blCheckoutWorkflow&quot;)
  46      protected Processor&lt;CheckoutSeed, CheckoutSeed&gt; checkoutWorkflow;
  47  
  48      @Autowired
  49      @Qualifier(&quot;blApplicationEventPublisher&quot;)
  50      protected BroadleafApplicationEventPublisher eventPublisher;
  51  
  52      @Resource(name=&quot;blOrderService&quot;)
  53      protected OrderService orderService;
  54  
  55      /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  56 -     * Map of locks for given order ids. This lock map ensures that only a single request can handle a particular order">  56 -     * Map of locks for given order ids. This lock map ensures that only a single request can handle a particular ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -     * at a time</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +     * @deprecated no longer supported - simplifying interface</span>
  59       */
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +    @Deprecated</span>
  61      protected static ConcurrentMap&lt;Long, Object&gt; lockMap = new ConcurrentHashMap&lt;&gt;();
  62  
  63      @Override
  64      public CheckoutResponse performCheckout(Order order) throws CheckoutException {
  65          //Immediately fail if another thread is currently attempting to check out the order
  66          Object lockObject = putLock(order.getId());
  67          if (lockObject != null) {
<abbr title="  68              throw new CheckoutException(&quot;This order is already in the process of being submitted, unable to checkout order -- id: &quot; + order.getId(), new CheckoutSeed(order, new HashMap&lt;String, Object&gt;()));">  68              throw new CheckoutException(&quot;This order is already in the process of being submitted, unable to checkoðŸ”µ</abbr>
  69          }
  70  
  71          // Immediately fail if this order has already been checked out previously
  72          if (hasOrderBeenCompleted(order)) {
<abbr title="  73              throw new CheckoutException(&quot;This order has already been submitted or cancelled, unable to checkout order -- id: &quot; + order.getId(), new CheckoutSeed(order, new HashMap&lt;String, Object&gt;()));">  73              throw new CheckoutException(&quot;This order has already been submitted or cancelled, unable to checkout orðŸ”µ</abbr>
  74          }
  75  
  76          CheckoutSeed seed = null;
  77          try {
  78              // Do a final save of the order before going through with the checkout workflow
  79              order = orderService.save(order, false);
  80              seed = new CheckoutSeed(order, new HashMap&lt;String, Object&gt;());

  81  
  82              ProcessContext&lt;CheckoutSeed&gt; context = checkoutWorkflow.doActivities(seed);
  83  
  84              // We need to pull the order off the seed and save it here in case any activity modified the order.
  85              order = orderService.save(seed.getOrder(), false);
  86              order.getOrderMessages().addAll(((ActivityMessages) context).getActivityMessages());
  87              seed.setOrder(order);
  88  
<abbr title="  89              OrderSubmittedEvent event = new OrderSubmittedEvent(this, seed.getOrder().getId(), seed.getOrder().getOrderNumber());">  89              OrderSubmittedEvent event = new OrderSubmittedEvent(this, seed.getOrder().getId(), seed.getOrder().getðŸ”µ</abbr>
  90              eventPublisher.publishEvent(event);
  91  
  92              return seed;
  93          } catch (PricingException e) {
  94              throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e, seed);
  95          } catch (WorkflowException e) {
<abbr title="  96              throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getRootCause(), seed);">  96              throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getRootCause(), seedðŸ”µ</abbr>
  97          } catch (RequiredAttributeNotProvidedException e) {
  98              throw new CheckoutException(&quot;Unable to checkout order -- id: &quot; + order.getId(), e.getCause(), seed);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        } finally {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -            // The order has completed processing, remove the order from the processing map</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -            removeLock(order.getId());</span>
 102          }
 103      }
 104  
 105      /**
 106       * Checks if the &lt;b&gt;order&lt;/b&gt; has already been gone through the checkout workflow.
 107       *
 108       * @param order
 109       * @return
 110       */
 111      protected boolean hasOrderBeenCompleted(Order order) {
<abbr title=" 112          return (OrderStatus.SUBMITTED.equals(order.getStatus()) || OrderStatus.CANCELLED.equals(order.getStatus()));"> 112          return (OrderStatus.SUBMITTED.equals(order.getStatus()) || OrderStatus.CANCELLED.equals(order.getStatus())ðŸ”µ</abbr>
 113      }
 114  
 115      /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -    * Get an object to lock on for the given order id</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -    *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -    * @param orderId</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 119 -    * @return null if there was not already a lock object available. If an object was already in the map, this will return"> 119 -    * @return null if there was not already a lock object available. If an object was already in the map, this wilðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -    * that object, which means that there is already a thread attempting to go through the checkout workflow</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -    */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +     * @deprecated no longer supported - simplifying interface</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +    @Deprecated</span>
 125      protected Object putLock(Long orderId) {
 126          return lockMap.putIfAbsent(orderId, new Object());
 127      }
 128  
 129      /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -     * Done with processing the given orderId, remove the lock from the map</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -     * @param orderId</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +     * @deprecated no longer supported - simplifying interface</span>
 134       */
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +    @Deprecated</span>
 136      protected void removeLock(Long orderId) {
 137          lockMap.remove(orderId);
 138      }
 139  
 140  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            