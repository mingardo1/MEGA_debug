<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>131</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    131
                    <a href="130.html">prev</a>
                    <a href="132.html">next</a>
                    <a href="131_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_f5ca511b687ad83c95325aba0a4b8df061d40a22_Simplenote/src/main/java/com/automattic/simplenote/TagsListFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f5ca511b687ad83c95325aba0a4b8df061d40a22:Simplenote/src/main/java/com/automattic/simplenote/TagsListFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f5ca511b687ad83c95325aba0a4b8df061d40a22^1:Simplenote/src/main/java/com/automattic/simplenote/TagsListFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;f5ca511b687ad83c95325aba0a4b8df061d40a22^2:Simplenote/src/main/java/com/automattic/simplenote/TagsListFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;8799fa89bf22e08e205bad4c72b5699e0996975e:Simplenote/src/main/java/com/automattic/simplenote/TagsListFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Fragment;
   4 import android.content.Context;
   5 import android.content.DialogInterface;
   6 import android.database.Cursor;
   7 import android.os.AsyncTask;
   8 import android.os.Bundle;
   9 import android.view.ActionMode;
  10 import android.view.HapticFeedbackConstants;
  11 import android.view.LayoutInflater;
  12 import android.view.Menu;
  13 import android.view.MenuInflater;
  14 import android.view.MenuItem;
  15 import android.view.View;
  16 import android.view.ViewGroup;
  17 import android.widget.EditText;
  18 import android.widget.ImageButton;
  19 import android.widget.LinearLayout;
  20 import android.widget.TextView;
  21 import android.widget.Toast;
  22 
  23 import androidx.annotation.NonNull;
  24 import androidx.appcompat.app.AlertDialog;
  25 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  26 import androidx.appcompat.view.ContextThemeWrapper;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  27 import androidx.recyclerview.widget.DividerItemDecoration;</span>
  28 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import androidx.recyclerview.widget.DividerItemDecoration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import androidx.recyclerview.widget.LinearLayoutManager;</span>
  31 =======
  32 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  33 import androidx.recyclerview.widget.LinearLayoutManager;
  34 import androidx.recyclerview.widget.RecyclerView;
  35 
  36 import com.automattic.simplenote.analytics.AnalyticsTracker;
  37 import com.automattic.simplenote.models.Note;
  38 import com.automattic.simplenote.models.Tag;
  39 import com.automattic.simplenote.utils.BaseCursorAdapter;
  40 import com.automattic.simplenote.utils.HtmlCompat;
  41 import com.automattic.simplenote.widgets.EmptyViewRecyclerView;
  42 import com.simperium.client.Bucket;
  43 import com.simperium.client.BucketObjectNameInvalid;
  44 import com.simperium.client.Query;
  45 
  46 import java.util.List;
  47 
  48 public class TagsListFragment extends Fragment implements ActionMode.Callback, Bucket.Listener&lt;Tag&gt; {
  49 
  50     private ActionMode mActionMode;
  51     private Bucket&lt;Tag&gt; mTagsBucket;
  52     private Bucket&lt;Note&gt; mNotesBucket;
  53     private TagsAdapter mTagsAdapter;
  54 
  55     /**
  56      * Mandatory empty constructor for the fragment manager to instantiate the
  57      * fragment (e.g. upon screen orientation changes).
  58      */
  59     public TagsListFragment() {
  60     }
  61 
  62     @Override
<abbr title="  63     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {">  63     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr>
  64         return inflater.inflate(R.layout.fragment_tags_list, container, false);
  65     }
  66 
  67     @Override
  68     public void onActivityCreated(Bundle savedInstanceState) {
  69         super.onActivityCreated(savedInstanceState);
  70 
  71         setHasOptionsMenu(true);
  72 
  73         Simplenote application = (Simplenote) getActivity().getApplication();
  74         mTagsBucket = application.getTagsBucket();
  75         mNotesBucket = application.getNotesBucket();
  76 
  77         EmptyViewRecyclerView recyclerView = getActivity().findViewById(R.id.list);
  78         mTagsAdapter = new TagsAdapter();
  79         recyclerView.setAdapter(mTagsAdapter);
  80         recyclerView.setLayoutManager(new LinearLayoutManager(getActivity()));
  81         TextView emptyView = getActivity().findViewById(R.id.empty);
<abbr title="  82         emptyView.setText(HtmlCompat.fromHtml(&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found) + &quot;&lt;/strong&gt;&quot;));">  82         emptyView.setText(HtmlCompat.fromHtml(&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
  83         recyclerView.setEmptyView(emptyView);
  84 
  85         refreshTags();
  86     }
  87 
  88     @Override
  89     public void onResume() {
  90         super.onResume();
  91 
  92         mNotesBucket.start();
  93         mTagsBucket.start();
  94 
  95         mTagsBucket.addOnNetworkChangeListener(this);
  96         mTagsBucket.addOnSaveObjectListener(this);
  97         mTagsBucket.addOnDeleteObjectListener(this);
  98     }
  99 
 100     @Override
 101     public void onPause() {
 102         super.onPause();
 103 
 104         mTagsBucket.removeOnNetworkChangeListener(this);
 105         mTagsBucket.removeOnSaveObjectListener(this);
 106         mTagsBucket.removeOnDeleteObjectListener(this);
 107 
 108         mNotesBucket.stop();
 109         mTagsBucket.stop();
 110     }
 111 
 112     protected void refreshTags() {
<abbr title=" 113         Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAME);"> 113         Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAðŸ”µ</abbr>
 114         Bucket.ObjectCursor&lt;Tag&gt; cursor = tagQuery.execute();
 115         mTagsAdapter.swapCursor(cursor);
 116     }
 117 
 118     // TODO: Finish bulk editing
 119     @Override
 120     public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 121         MenuInflater inflater = actionMode.getMenuInflater();
 122         inflater.inflate(R.menu.bulk_edit, menu);
 123         mActionMode = actionMode;
 124         return true;
 125     }
 126 
 127     @Override
 128     public boolean onPrepareActionMode(ActionMode actionMode, Menu menu) {
 129         return false;
 130     }
 131 
 132     @Override
 133     public boolean onActionItemClicked(ActionMode actionMode, MenuItem menuItem) {
 134         if (menuItem.getItemId() == R.id.menu_delete) {
 135             actionMode.finish(); // Action picked, so close the CAB
 136             return true;
 137         }
 138         return false;
 139     }
 140 
 141     @Override
 142     public void onDestroyActionMode(ActionMode actionMode) {
 143         mActionMode = null;
 144     }
 145 
 146     @Override
 147     public boolean onOptionsItemSelected(MenuItem item) {
 148 
 149         if (item.getItemId() == android.R.id.home) {
 150             if (isAdded()) {
 151                 getActivity().finish();
 152                 return true;
 153             }
 154         }
 155 
 156         return super.onOptionsItemSelected(item);
 157     }
 158 
 159     // Tag Bucket listeners
 160     @Override
 161     public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 162         if (isAdded()) {
 163             getActivity().runOnUiThread(new Runnable() {
 164                 @Override
 165                 public void run() {
 166                     refreshTags();
 167                 }
 168             });
 169         }
 170     }
 171 
 172     @Override
 173     public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 174         if (isAdded()) {
 175             getActivity().runOnUiThread(new Runnable() {
 176                 @Override
 177                 public void run() {
 178                     refreshTags();
 179                 }
 180             });
 181         }
 182     }
 183 
 184     @Override
 185     public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 186         if (isAdded()) {
 187             getActivity().runOnUiThread(new Runnable() {
 188                 @Override
 189                 public void run() {
 190                     refreshTags();
 191                 }
 192             });
 193         }
 194     }
 195 
 196     @Override
 197     public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 198         // noop
 199     }
 200 
 201     private class removeTagFromNotesTask extends AsyncTask&lt;Tag, Void, Void&gt; {
 202 
 203         @Override
 204         protected Void doInBackground(Tag... removedTags) {
 205             Tag tag = removedTags[0];
 206             if (tag != null) {
 207                 Bucket.ObjectCursor&lt;Note&gt; notesCursor = tag.findNotes(mNotesBucket);
 208                 while (notesCursor.moveToNext()) {
 209                     Note note = notesCursor.getObject();
 210                     List&lt;String&gt; tags = note.getTags();
 211                     tags.remove(tag.getName());
 212                     note.setTags(tags);
 213                     note.save();
 214                 }
 215                 notesCursor.close();
 216             }
 217             return null;
 218         }
 219     }
 220 
 221     private class TagsAdapter extends BaseCursorAdapter&lt;TagsAdapter.ViewHolder&gt; {
 222 
 223         public class ViewHolder extends RecyclerView.ViewHolder implements View.OnClickListener {
 224 
 225             private TextView tagTitle;
 226             private TextView tagCountTextView;
 227             private ImageButton deleteButton;
 228 
 229             private ViewHolder(View itemView) {
 230                 super(itemView);
 231 
 232                 tagTitle = itemView.findViewById(R.id.tag_name);
 233                 tagCountTextView = itemView.findViewById(R.id.tag_count);
 234                 deleteButton = itemView.findViewById(R.id.tag_trash);
 235 
 236                 deleteButton.setOnClickListener(new View.OnClickListener() {
 237                     @Override
 238                     public void onClick(View view) {
 239                         if (!isAdded()) return;
 240 
<abbr title=" 241                         final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();"> 241                         final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObjeðŸ”µ</abbr>
<abbr title=" 242                         final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 242                         final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAðŸ”µ</abbr>
 243                         if (tagCount == 0) {
 244                             deleteTag(tag);
 245                         } else if (tagCount &gt; 0) {
<abbr title=" 246                             AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContext(), R.style.Dialog));"> 246                             AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(gðŸ”µ</abbr>
 247                             alert.setTitle(R.string.delete_tag);
 248                             alert.setMessage(getString(R.string.confirm_delete_tag));
 249                             alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 250                                 public void onClick(DialogInterface dialog, int whichButton) {
 251                                     deleteTag(tag);
 252                                 }
 253                             });
 254                             alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 255                                 public void onClick(DialogInterface dialog, int whichButton) {
 256                                     // Do nothing, just closing the dialog
 257                                 }
 258                             });
 259                             alert.show();
 260                         }
 261                     }
 262                 });
 263                 deleteButton.setOnLongClickListener(new View.OnLongClickListener() {
 264                     @Override
 265                     public boolean onLongClick(View v) {
 266                         if (v.isHapticFeedbackEnabled()) {
 267                             v.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS);
 268                         }
 269 
<abbr title=" 270                         Toast.makeText(getContext(), getContext().getString(R.string.delete_tag), Toast.LENGTH_SHORT).show();"> 270                         Toast.makeText(getContext(), getContext().getString(R.string.delete_tag), Toast.LðŸ”µ</abbr>
 271                         return true;
 272                     }
 273                 });
 274 
 275                 itemView.setOnClickListener(this);
 276             }
 277 
 278             @Override
 279             public void onClick(View view) {
 280                 if (!isAdded()) return;
 281 
<abbr title=" 282                 final AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContext(), R.style.Dialog));"> 282                 final AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContðŸ”µ</abbr>
<abbr title=" 283                 LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null);"> 283                 LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layouðŸ”µ</abbr>
 284 
 285                 final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();
 286 
 287                 final EditText tagNameEditText = alertView.findViewById(R.id.tag_name_edit);
 288                 tagNameEditText.setText(tag.getName());
 289                 tagNameEditText.setSelection(tagNameEditText.length());
 290                 alert.setView(alertView);
 291                 alert.setTitle(R.string.rename_tag);
 292                 alert.setPositiveButton(R.string.save, new DialogInterface.OnClickListener() {
 293                     public void onClick(DialogInterface dialog, int whichButton) {
 294                         String value = tagNameEditText.getText().toString().trim();
 295                         try {
 296                             tag.renameTo(value, mNotesBucket);
 297                             AnalyticsTracker.track(
 298                                     AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED,
 299                                     AnalyticsTracker.CATEGORY_TAG,
 300                                     &quot;tag_alert_edit_box&quot;
 301                             );
 302                         } catch (BucketObjectNameInvalid e) {
 303                             android.util.Log.e(Simplenote.TAG, &quot;Unable to rename tag&quot;, e);
 304                             // TODO: show user a message that new tag name is not ok
 305                         }
 306                     }
 307                 });
 308                 alert.setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() {
 309                     public void onClick(DialogInterface dialog, int whichButton) {
 310                         // Do nothing
 311                     }
 312                 });
 313                 alert.show();
 314             }
 315 
 316             private void deleteTag(Tag tag) {
 317                 tag.delete();
 318                 new removeTagFromNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, tag);
 319                 AnalyticsTracker.track(
 320                         AnalyticsTracker.Stat.TAG_MENU_DELETED,
 321                         AnalyticsTracker.CATEGORY_TAG,
 322                         &quot;list_trash_button&quot;
 323                 );
 324             }
 325         }
 326 
 327         private TagsAdapter() {
 328             super(null);
 329         }
 330 
 331         @NonNull
 332         @Override
 333         public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
 334             Context context = parent.getContext();
 335             LayoutInflater inflater = LayoutInflater.from(context);
 336 
 337             View contactView = inflater.inflate(R.layout.tags_list_row, parent, false);
 338 
 339             return new ViewHolder(contactView);
 340         }
 341 
 342         @Override
 343         public void onBindViewHolder(@NonNull ViewHolder holder, Cursor cursor) {
 344             Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)cursor).getObject();
 345 
 346             holder.tagTitle.setText(tag.getName());
<abbr title=" 347             final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 347             final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.geðŸ”µ</abbr>
 348             if (tagCount &gt; 0) {
 349                 holder.tagCountTextView.setText(String.valueOf(tagCount));
 350             } else {
 351                 holder.tagCountTextView.setText(&quot;&quot;);
 352             }
 353         }
 354 
 355         @Override
 356         public void swapCursor(Cursor newCursor) {
 357             super.swapCursor(newCursor);
 358         }
 359     }
 360 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Fragment;
   4 import android.content.Context;
   5 import android.content.DialogInterface;
   6 import android.database.Cursor;
   7 import android.os.AsyncTask;
   8 import android.os.Bundle;
   9 import android.view.ActionMode;
  10 import android.view.HapticFeedbackConstants;
  11 import android.view.LayoutInflater;
  12 import android.view.Menu;
  13 import android.view.MenuInflater;
  14 import android.view.MenuItem;
  15 import android.view.View;
  16 import android.view.ViewGroup;
  17 import android.widget.EditText;
  18 import android.widget.ImageButton;
  19 import android.widget.LinearLayout;
  20 import android.widget.TextView;
  21 import android.widget.Toast;
  22 
  23 import androidx.annotation.NonNull;
  24 import androidx.appcompat.app.AlertDialog;
  25 import androidx.appcompat.view.ContextThemeWrapper;
  26 import androidx.recyclerview.widget.LinearLayoutManager;
  27 import androidx.recyclerview.widget.RecyclerView;
  28 
  29 import com.automattic.simplenote.analytics.AnalyticsTracker;
  30 import com.automattic.simplenote.models.Note;
  31 import com.automattic.simplenote.models.Tag;
  32 import com.automattic.simplenote.utils.BaseCursorAdapter;
  33 import com.automattic.simplenote.utils.HtmlCompat;
  34 import com.automattic.simplenote.widgets.EmptyViewRecyclerView;
  35 import com.simperium.client.Bucket;
  36 import com.simperium.client.BucketObjectNameInvalid;
  37 import com.simperium.client.Query;
  38 
  39 import java.util.List;
  40 
  41 public class TagsListFragment extends Fragment implements ActionMode.Callback, Bucket.Listener&lt;Tag&gt; {
  42 
  43     private ActionMode mActionMode;
  44     private Bucket&lt;Tag&gt; mTagsBucket;
  45     private Bucket&lt;Note&gt; mNotesBucket;
  46     private TagsAdapter mTagsAdapter;
  47 
  48     /**
  49      * Mandatory empty constructor for the fragment manager to instantiate the
  50      * fragment (e.g. upon screen orientation changes).
  51      */
  52     public TagsListFragment() {
  53     }
  54 
  55     @Override
<abbr title="  56     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {">  56     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr>
  57         return inflater.inflate(R.layout.fragment_tags_list, container, false);
  58     }
  59 
  60     @Override
  61     public void onActivityCreated(Bundle savedInstanceState) {
  62         super.onActivityCreated(savedInstanceState);
  63 
  64         setHasOptionsMenu(true);
  65 
  66         Simplenote application = (Simplenote) getActivity().getApplication();
  67         mTagsBucket = application.getTagsBucket();
  68         mNotesBucket = application.getNotesBucket();
  69 
  70         EmptyViewRecyclerView recyclerView = getActivity().findViewById(R.id.list);
  71         mTagsAdapter = new TagsAdapter();
  72         recyclerView.setAdapter(mTagsAdapter);
  73         recyclerView.setLayoutManager(new LinearLayoutManager(getActivity()));
  74         TextView emptyView = getActivity().findViewById(R.id.empty);
<abbr title="  75         emptyView.setText(HtmlCompat.fromHtml(&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found) + &quot;&lt;/strong&gt;&quot;));">  75         emptyView.setText(HtmlCompat.fromHtml(&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
  76         recyclerView.setEmptyView(emptyView);
  77 
  78         refreshTags();
  79     }
  80 
  81     @Override
  82     public void onResume() {
  83         super.onResume();
  84 
  85         mNotesBucket.start();
  86         mTagsBucket.start();
  87 
  88         mTagsBucket.addOnNetworkChangeListener(this);
  89         mTagsBucket.addOnSaveObjectListener(this);
  90         mTagsBucket.addOnDeleteObjectListener(this);
  91     }
  92 
  93     @Override
  94     public void onPause() {
  95         super.onPause();
  96 
  97         mTagsBucket.removeOnNetworkChangeListener(this);
  98         mTagsBucket.removeOnSaveObjectListener(this);
  99         mTagsBucket.removeOnDeleteObjectListener(this);
 100 
 101         mNotesBucket.stop();
 102         mTagsBucket.stop();
 103     }
 104 
 105     protected void refreshTags() {
<abbr title=" 106         Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAME);"> 106         Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAðŸ”µ</abbr>
 107         Bucket.ObjectCursor&lt;Tag&gt; cursor = tagQuery.execute();
 108         mTagsAdapter.swapCursor(cursor);
 109     }
 110 
 111     // TODO: Finish bulk editing
 112     @Override
 113     public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 114         MenuInflater inflater = actionMode.getMenuInflater();
 115         inflater.inflate(R.menu.bulk_edit, menu);
 116         mActionMode = actionMode;
 117         return true;
 118     }
 119 
 120     @Override
 121     public boolean onPrepareActionMode(ActionMode actionMode, Menu menu) {
 122         return false;
 123     }
 124 
 125     @Override
 126     public boolean onActionItemClicked(ActionMode actionMode, MenuItem menuItem) {
 127         if (menuItem.getItemId() == R.id.menu_delete) {
 128             actionMode.finish(); // Action picked, so close the CAB
 129             return true;
 130         }
 131         return false;
 132     }
 133 
 134     @Override
 135     public void onDestroyActionMode(ActionMode actionMode) {
 136         mActionMode = null;
 137     }
 138 
 139     @Override
 140     public boolean onOptionsItemSelected(MenuItem item) {
 141 
 142         if (item.getItemId() == android.R.id.home) {
 143             if (isAdded()) {
 144                 getActivity().finish();
 145                 return true;
 146             }
 147         }
 148 
 149         return super.onOptionsItemSelected(item);
 150     }
 151 
 152     // Tag Bucket listeners
 153     @Override
 154     public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 155         if (isAdded()) {
 156             getActivity().runOnUiThread(new Runnable() {
 157                 @Override
 158                 public void run() {
 159                     refreshTags();
 160                 }
 161             });
 162         }
 163     }
 164 
 165     @Override
 166     public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 167         if (isAdded()) {
 168             getActivity().runOnUiThread(new Runnable() {
 169                 @Override
 170                 public void run() {
 171                     refreshTags();
 172                 }
 173             });
 174         }
 175     }
 176 
 177     @Override
 178     public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 179         if (isAdded()) {
 180             getActivity().runOnUiThread(new Runnable() {
 181                 @Override
 182                 public void run() {
 183                     refreshTags();
 184                 }
 185             });
 186         }
 187     }
 188 
 189     @Override
 190     public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 191         // noop
 192     }
 193 
 194     private class removeTagFromNotesTask extends AsyncTask&lt;Tag, Void, Void&gt; {
 195 
 196         @Override
 197         protected Void doInBackground(Tag... removedTags) {
 198             Tag tag = removedTags[0];
 199             if (tag != null) {
 200                 Bucket.ObjectCursor&lt;Note&gt; notesCursor = tag.findNotes(mNotesBucket);
 201                 while (notesCursor.moveToNext()) {
 202                     Note note = notesCursor.getObject();
 203                     List&lt;String&gt; tags = note.getTags();
 204                     tags.remove(tag.getName());
 205                     note.setTags(tags);
 206                     note.save();
 207                 }
 208                 notesCursor.close();
 209             }
 210             return null;
 211         }
 212     }
 213 
 214     private class TagsAdapter extends BaseCursorAdapter&lt;TagsAdapter.ViewHolder&gt; {
 215 
 216         public class ViewHolder extends RecyclerView.ViewHolder implements View.OnClickListener {
 217 
 218             private TextView tagTitle;
 219             private TextView tagCountTextView;
 220             private ImageButton deleteButton;
 221 
 222             private ViewHolder(View itemView) {
 223                 super(itemView);
 224 
 225                 tagTitle = itemView.findViewById(R.id.tag_name);
 226                 tagCountTextView = itemView.findViewById(R.id.tag_count);
 227                 deleteButton = itemView.findViewById(R.id.tag_trash);
 228 
 229                 deleteButton.setOnClickListener(new View.OnClickListener() {
 230                     @Override
 231                     public void onClick(View view) {
 232                         if (!isAdded()) return;
 233 
<abbr title=" 234                         final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();"> 234                         final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObjeðŸ”µ</abbr>
<abbr title=" 235                         final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 235                         final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAðŸ”µ</abbr>
 236                         if (tagCount == 0) {
 237                             deleteTag(tag);
 238                         } else if (tagCount &gt; 0) {
<abbr title=" 239                             AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContext(), R.style.Dialog));"> 239                             AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(gðŸ”µ</abbr>
 240                             alert.setTitle(R.string.delete_tag);
 241                             alert.setMessage(getString(R.string.confirm_delete_tag));
 242                             alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 243                                 public void onClick(DialogInterface dialog, int whichButton) {
 244                                     deleteTag(tag);
 245                                 }
 246                             });
 247                             alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 248                                 public void onClick(DialogInterface dialog, int whichButton) {
 249                                     // Do nothing, just closing the dialog
 250                                 }
 251                             });
 252                             alert.show();
 253                         }
 254                     }
 255                 });
 256                 deleteButton.setOnLongClickListener(new View.OnLongClickListener() {
 257                     @Override
 258                     public boolean onLongClick(View v) {
 259                         if (v.isHapticFeedbackEnabled()) {
 260                             v.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS);
 261                         }
 262 
<abbr title=" 263                         Toast.makeText(getContext(), getContext().getString(R.string.delete_tag), Toast.LENGTH_SHORT).show();"> 263                         Toast.makeText(getContext(), getContext().getString(R.string.delete_tag), Toast.LðŸ”µ</abbr>
 264                         return true;
 265                     }
 266                 });
 267 
 268                 itemView.setOnClickListener(this);
 269             }
 270 
 271             @Override
 272             public void onClick(View view) {
 273                 if (!isAdded()) return;
 274 
<abbr title=" 275                 final AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContext(), R.style.Dialog));"> 275                 final AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContðŸ”µ</abbr>
<abbr title=" 276                 LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null);"> 276                 LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layouðŸ”µ</abbr>
 277 
 278                 final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();
 279 
 280                 final EditText tagNameEditText = alertView.findViewById(R.id.tag_name_edit);
 281                 tagNameEditText.setText(tag.getName());
 282                 tagNameEditText.setSelection(tagNameEditText.length());
 283                 alert.setView(alertView);
 284                 alert.setTitle(R.string.rename_tag);
 285                 alert.setPositiveButton(R.string.save, new DialogInterface.OnClickListener() {
 286                     public void onClick(DialogInterface dialog, int whichButton) {
 287                         String value = tagNameEditText.getText().toString().trim();
 288                         try {
 289                             tag.renameTo(value, mNotesBucket);
 290                             AnalyticsTracker.track(
 291                                     AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED,
 292                                     AnalyticsTracker.CATEGORY_TAG,
 293                                     &quot;tag_alert_edit_box&quot;
 294                             );
 295                         } catch (BucketObjectNameInvalid e) {
 296                             android.util.Log.e(Simplenote.TAG, &quot;Unable to rename tag&quot;, e);
 297                             // TODO: show user a message that new tag name is not ok
 298                         }
 299                     }
 300                 });
 301                 alert.setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() {
 302                     public void onClick(DialogInterface dialog, int whichButton) {
 303                         // Do nothing
 304                     }
 305                 });
 306                 alert.show();
 307             }
 308 
 309             private void deleteTag(Tag tag) {
 310                 tag.delete();
 311                 new removeTagFromNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, tag);
 312                 AnalyticsTracker.track(
 313                         AnalyticsTracker.Stat.TAG_MENU_DELETED,
 314                         AnalyticsTracker.CATEGORY_TAG,
 315                         &quot;list_trash_button&quot;
 316                 );
 317             }
 318         }
 319 
 320         private TagsAdapter() {
 321             super(null);
 322         }
 323 
 324         @NonNull
 325         @Override
 326         public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
 327             Context context = parent.getContext();
 328             LayoutInflater inflater = LayoutInflater.from(context);
 329 
 330             View contactView = inflater.inflate(R.layout.tags_list_row, parent, false);
 331 
 332             return new ViewHolder(contactView);
 333         }
 334 
 335         @Override
 336         public void onBindViewHolder(@NonNull ViewHolder holder, Cursor cursor) {
 337             Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)cursor).getObject();
 338 
 339             holder.tagTitle.setText(tag.getName());
<abbr title=" 340             final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 340             final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.geðŸ”µ</abbr>
 341             if (tagCount &gt; 0) {
 342                 holder.tagCountTextView.setText(String.valueOf(tagCount));
 343             } else {
 344                 holder.tagCountTextView.setText(&quot;&quot;);
 345             }
 346         }
 347 
 348         @Override
 349         public void swapCursor(Cursor newCursor) {
 350             super.swapCursor(newCursor);
 351         }
 352     }
 353 }
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Fragment;
   4 import android.content.Context;
   5 import android.content.DialogInterface;
   6 import android.database.Cursor;
   7 import android.os.AsyncTask;
   8 import android.os.Bundle;
   9 import android.view.ActionMode;
  10 import android.view.HapticFeedbackConstants;
  11 import android.view.LayoutInflater;
  12 import android.view.Menu;
  13 import android.view.MenuInflater;
  14 import android.view.MenuItem;
  15 import android.view.View;
  16 import android.view.ViewGroup;
  17 import android.widget.EditText;
  18 import android.widget.ImageButton;
  19 import android.widget.LinearLayout;
  20 import android.widget.TextView;
  21 import android.widget.Toast;
  22 import androidx.annotation.NonNull;
  23 import androidx.appcompat.app.AlertDialog;
  24 import androidx.appcompat.view.ContextThemeWrapper;
  25 import androidx.recyclerview.widget.LinearLayoutManager;
  26 import androidx.recyclerview.widget.RecyclerView;
  27 import com.automattic.simplenote.analytics.AnalyticsTracker;
  28 import com.automattic.simplenote.models.Note;
  29 import com.automattic.simplenote.models.Tag;
  30 import com.automattic.simplenote.utils.BaseCursorAdapter;
  31 import com.automattic.simplenote.utils.HtmlCompat;
  32 import com.automattic.simplenote.widgets.EmptyViewRecyclerView;
  33 import com.simperium.client.Bucket;
  34 import com.simperium.client.BucketObjectNameInvalid;
  35 import com.simperium.client.Query;
  36 import java.util.List;
  37 
  38 
  39 public class TagsListFragment extends Fragment implements ActionMode.Callback , Bucket.Listener&lt;Tag&gt; {
  40     private ActionMode mActionMode;
  41 
  42     private Bucket&lt;Tag&gt; mTagsBucket;
  43 
  44     private Bucket&lt;Note&gt; mNotesBucket;
  45 
  46     private TagsAdapter mTagsAdapter;
  47 
  48     /**
  49      * Mandatory empty constructor for the fragment manager to instantiate the
  50      * fragment (e.g. upon screen orientation changes).
  51      */
  52     public TagsListFragment() {
  53     }
  54 
  55     @Override
<abbr title="  56     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {">  56     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr>
  57         return inflater.inflate(R.layout.fragment_tags_list, container, false);
  58     }
  59 
  60     @Override
  61     public void onActivityCreated(Bundle savedInstanceState) {
  62         super.onActivityCreated(savedInstanceState);
  63         setHasOptionsMenu(true);
  64         Simplenote application = ((Simplenote) (getActivity().getApplication()));
  65         mTagsBucket = application.getTagsBucket();
  66         mNotesBucket = application.getNotesBucket();
  67         EmptyViewRecyclerView recyclerView = getActivity().findViewById(R.id.list);
  68         mTagsAdapter = new TagsAdapter();
  69         recyclerView.setAdapter(mTagsAdapter);
  70         recyclerView.setLayoutManager(new LinearLayoutManager(getActivity()));
  71         TextView emptyView = getActivity().findViewById(R.id.empty);
<abbr title="  72         emptyView.setText(HtmlCompat.fromHtml((&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found)) + &quot;&lt;/strong&gt;&quot;));">  72         emptyView.setText(HtmlCompat.fromHtml((&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found)) + &quot;&lt;/stronðŸ”µ</abbr>
  73         recyclerView.setEmptyView(emptyView);
  74         refreshTags();
  75     }
  76 
  77     @Override
  78     public void onResume() {
  79         super.onResume();
  80 
  81         mNotesBucket.start();
  82         mTagsBucket.start();
  83 
  84         mTagsBucket.addOnNetworkChangeListener(this);
  85         mTagsBucket.addOnSaveObjectListener(this);
  86         mTagsBucket.addOnDeleteObjectListener(this);
  87     }
  88 
  89     @Override
  90     public void onPause() {
  91         super.onPause();
  92 
  93         mTagsBucket.removeOnNetworkChangeListener(this);
  94         mTagsBucket.removeOnSaveObjectListener(this);
  95         mTagsBucket.removeOnDeleteObjectListener(this);
  96 
  97         mNotesBucket.stop();
  98         mTagsBucket.stop();
  99     }
 100 
 101     protected void refreshTags() {
<abbr title=" 102         Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAME);"> 102         Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAðŸ”µ</abbr>
 103         Bucket.ObjectCursor&lt;Tag&gt; cursor = tagQuery.execute();
 104         mTagsAdapter.swapCursor(cursor);
 105     }
 106 
 107     // TODO: Finish bulk editing
 108     @Override
 109     public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 110         MenuInflater inflater = actionMode.getMenuInflater();
 111         inflater.inflate(R.menu.bulk_edit, menu);
 112         mActionMode = actionMode;
 113         return true;
 114     }
 115 
 116     @Override
 117     public boolean onPrepareActionMode(ActionMode actionMode, Menu menu) {
 118         return false;
 119     }
 120 
 121     @Override
 122     public boolean onActionItemClicked(ActionMode actionMode, MenuItem menuItem) {
 123         if (menuItem.getItemId() == R.id.menu_delete) {
 124             actionMode.finish(); // Action picked, so close the CAB
 125             return true;
 126         }
 127         return false;
 128     }
 129 
 130     @Override
 131     public void onDestroyActionMode(ActionMode actionMode) {
 132         mActionMode = null;
 133     }
 134 
 135     @Override
 136     public boolean onOptionsItemSelected(MenuItem item) {
 137 
 138         if (item.getItemId() == android.R.id.home) {
 139             if (isAdded()) {
 140                 getActivity().finish();
 141                 return true;
 142             }
 143         }
 144 
 145         return super.onOptionsItemSelected(item);
 146     }
 147 
 148     // Tag Bucket listeners
 149     @Override
 150     public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 151         if (isAdded()) {
 152             getActivity().runOnUiThread(new Runnable() {
 153                 @Override
 154                 public void run() {
 155                     refreshTags();
 156                 }
 157             });
 158         }
 159     }
 160 
 161     @Override
 162     public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 163         if (isAdded()) {
 164             getActivity().runOnUiThread(new Runnable() {
 165                 @Override
 166                 public void run() {
 167                     refreshTags();
 168                 }
 169             });
 170         }
 171     }
 172 
 173     @Override
 174     public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 175         if (isAdded()) {
 176             getActivity().runOnUiThread(new Runnable() {
 177                 @Override
 178                 public void run() {
 179                     refreshTags();
 180                 }
 181             });
 182         }
 183     }
 184 
 185     @Override
 186     public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 187         // noop
 188     }
 189 
 190     private class removeTagFromNotesTask extends AsyncTask&lt;Tag, Void, Void&gt; {
 191         @Override
 192         protected Void doInBackground(Tag... removedTags) {
 193             Tag tag = removedTags[0];
 194             if (tag != null) {
 195                 Bucket.ObjectCursor&lt;Note&gt; notesCursor = tag.findNotes(mNotesBucket);
 196                 while (notesCursor.moveToNext()) {
 197                     Note note = notesCursor.getObject();
 198                     List&lt;String&gt; tags = note.getTags();
 199                     tags.remove(tag.getName());
 200                     note.setTags(tags);
 201                     note.save();
 202                 }
 203                 notesCursor.close();
 204             }
 205             return null;
 206         }
 207     }
 208 
 209     private class TagsAdapter extends BaseCursorAdapter&lt;TagsAdapter.ViewHolder&gt; {
 210         public class ViewHolder extends RecyclerView.ViewHolder implements View.OnClickListener {
 211             private TextView tagTitle;
 212 
 213             private TextView tagCountTextView;
 214 
 215             private ImageButton deleteButton;
 216 
 217             private ViewHolder(View itemView) {
 218                 super(itemView);
 219                 tagTitle = itemView.findViewById(R.id.tag_name);
 220                 tagCountTextView = itemView.findViewById(R.id.tag_count);
 221                 deleteButton = itemView.findViewById(R.id.tag_trash);
 222                 deleteButton.setOnClickListener(new View.OnClickListener() {
 223                     @Override
 224                     public void onClick(View view) {
 225                         if (!isAdded()) {
 226                             return;
 227                         }
<abbr title=" 228                         final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;) (getItem(getAdapterPosition()))).getObject();"> 228                         final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;) (getItem(getAdapterPosition()))).getOðŸ”µ</abbr>
<abbr title=" 229                         final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 229                         final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAðŸ”µ</abbr>
 230                         if (tagCount == 0) {
 231                             deleteTag(tag);
 232                         } else if (tagCount &gt; 0) {
<abbr title=" 233                             AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContext(), R.style.Dialog));"> 233                             AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(gðŸ”µ</abbr>
 234                             alert.setTitle(R.string.delete_tag);
 235                             alert.setMessage(getString(R.string.confirm_delete_tag));
 236                             alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 237                                 public void onClick(DialogInterface dialog, int whichButton) {
 238                                     deleteTag(tag);
 239                                 }
 240                             });
 241                             alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 242                                 public void onClick(DialogInterface dialog, int whichButton) {
 243                                     // Do nothing, just closing the dialog
 244                                 }
 245                             });
 246                             alert.show();
 247                         }
 248                     }
 249                 });
 250                 deleteButton.setOnLongClickListener(new View.OnLongClickListener() {
 251                     @Override
 252                     public boolean onLongClick(View v) {
 253                         if (v.isHapticFeedbackEnabled()) {
 254                             v.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS);
 255                         }
<abbr title=" 256                         Toast.makeText(getContext(), getContext().getString(R.string.delete_tag), Toast.LENGTH_SHORT).show();"> 256                         Toast.makeText(getContext(), getContext().getString(R.string.delete_tag), Toast.LðŸ”µ</abbr>
 257                         return true;
 258                     }
 259                 });
 260                 itemView.setOnClickListener(this);
 261             }
 262 
 263             @Override
 264             public void onClick(View view) {
 265                 if (!isAdded()) {
 266                     return;
 267                 }
<abbr title=" 268                 final AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContext(), R.style.Dialog));"> 268                 final AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContðŸ”µ</abbr>
<abbr title=" 269                 LinearLayout alertView = ((LinearLayout) (getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null)));"> 269                 LinearLayout alertView = ((LinearLayout) (getActivity().getLayoutInflater().inflate(R.layðŸ”µ</abbr>
 270                 final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;) (getItem(getAdapterPosition()))).getObject();
 271                 final EditText tagNameEditText = alertView.findViewById(R.id.tag_name_edit);
 272                 tagNameEditText.setText(tag.getName());
 273                 tagNameEditText.setSelection(tagNameEditText.length());
 274                 alert.setView(alertView);
 275                 alert.setTitle(R.string.rename_tag);
 276                 alert.setPositiveButton(R.string.save, new DialogInterface.OnClickListener() {
 277                     public void onClick(DialogInterface dialog, int whichButton) {
 278                         String value = tagNameEditText.getText().toString().trim();
 279                         try {
 280                             tag.renameTo(value, mNotesBucket);
<abbr title=" 281                             AnalyticsTracker.track(AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED, AnalyticsTracker.CATEGORY_TAG, &quot;tag_alert_edit_box&quot;);"> 281                             AnalyticsTracker.track(AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED, AnalyticsTrðŸ”µ</abbr>
 282                         } catch (BucketObjectNameInvalid e) {
 283                             android.util.Log.e(Simplenote.TAG, &quot;Unable to rename tag&quot;, e);
 284                             // TODO: show user a message that new tag name is not ok
 285                         }
 286                     }
 287                 });
 288                 alert.setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() {
 289                     public void onClick(DialogInterface dialog, int whichButton) {
 290                         // Do nothing
 291                     }
 292                 });
 293                 alert.show();
 294             }
 295 
 296             private void deleteTag(Tag tag) {
 297                 tag.delete();
 298                 new removeTagFromNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, tag);
 299                 AnalyticsTracker.track(
 300                         AnalyticsTracker.Stat.TAG_MENU_DELETED,
 301                         AnalyticsTracker.CATEGORY_TAG,
 302                         &quot;list_trash_button&quot;
 303                 );
 304             }
 305         }
 306 
 307         private TagsAdapter() {
 308             super(null);
 309         }
 310 
 311         @NonNull
 312         @Override
 313         public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
 314             Context context = parent.getContext();
 315             LayoutInflater inflater = LayoutInflater.from(context);
 316 
 317             View contactView = inflater.inflate(R.layout.tags_list_row, parent, false);
 318 
 319             return new ViewHolder(contactView);
 320         }
 321 
 322         @Override
 323         public void onBindViewHolder(@NonNull ViewHolder holder, Cursor cursor) {
 324             Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)cursor).getObject();
 325 
 326             holder.tagTitle.setText(tag.getName());
<abbr title=" 327             final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 327             final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.geðŸ”µ</abbr>
 328             if (tagCount &gt; 0) {
 329                 holder.tagCountTextView.setText(String.valueOf(tagCount));
 330             } else {
 331                 holder.tagCountTextView.setText(&quot;&quot;);
 332             }
 333         }
 334 
 335         @Override
 336         public void swapCursor(Cursor newCursor) {
 337             super.swapCursor(newCursor);
 338         }
 339     }
 340 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Fragment;
   4  import android.content.Context;
   5  import android.content.DialogInterface;
   6  import android.database.Cursor;
   7  import android.os.AsyncTask;
   8  import android.os.Bundle;
   9  import android.view.ActionMode;

  10  import android.view.LayoutInflater;
  11  import android.view.Menu;
  12  import android.view.MenuInflater;
  13  import android.view.MenuItem;
  14  import android.view.View;
  15  import android.view.ViewGroup;
  16  import android.widget.EditText;
  17  import android.widget.ImageButton;
  18  import android.widget.LinearLayout;
  19  import android.widget.TextView;

  20  
  21  import androidx.annotation.NonNull;
  22  import androidx.appcompat.app.AlertDialog;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import androidx.appcompat.view.ContextThemeWrapper;</span>
  24  import androidx.recyclerview.widget.DividerItemDecoration;
  25  import androidx.recyclerview.widget.LinearLayoutManager;
  26  import androidx.recyclerview.widget.RecyclerView;
  27  
  28  import com.automattic.simplenote.analytics.AnalyticsTracker;
  29  import com.automattic.simplenote.models.Note;
  30  import com.automattic.simplenote.models.Tag;
  31  import com.automattic.simplenote.utils.BaseCursorAdapter;
  32  import com.automattic.simplenote.utils.HtmlCompat;
  33  import com.automattic.simplenote.widgets.EmptyViewRecyclerView;
  34  import com.simperium.client.Bucket;
  35  import com.simperium.client.BucketObjectNameInvalid;
  36  import com.simperium.client.Query;
  37  
  38  import java.util.List;
  39  
  40  public class TagsListFragment extends Fragment implements ActionMode.Callback, Bucket.Listener&lt;Tag&gt; {
  41  
  42      private ActionMode mActionMode;
  43      private Bucket&lt;Tag&gt; mTagsBucket;
  44      private Bucket&lt;Note&gt; mNotesBucket;
  45      private TagsAdapter mTagsAdapter;
  46  
  47      /**
  48       * Mandatory empty constructor for the fragment manager to instantiate the
  49       * fragment (e.g. upon screen orientation changes).
  50       */
  51      public TagsListFragment() {
  52      }
  53  
  54      @Override
  55      public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  56          return inflater.inflate(R.layout.fragment_tags_list, container, false);
  57      }
  58  
  59      @Override
  60      public void onActivityCreated(Bundle savedInstanceState) {
  61          super.onActivityCreated(savedInstanceState);
  62  
  63          setHasOptionsMenu(true);
  64  
  65          Simplenote application = (Simplenote) getActivity().getApplication();
  66          mTagsBucket = application.getTagsBucket();
  67          mNotesBucket = application.getNotesBucket();
  68  
  69          EmptyViewRecyclerView recyclerView = getActivity().findViewById(R.id.list);
  70          mTagsAdapter = new TagsAdapter();
  71          recyclerView.setAdapter(mTagsAdapter);
  72          recyclerView.setLayoutManager(new LinearLayoutManager(getActivity()));
<abbr title="  73          recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDecoration.VERTICAL));">  73          recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDecoration.ðŸ”µ</abbr>
  74          TextView emptyView = getActivity().findViewById(R.id.empty);
  75          emptyView.setText(HtmlCompat.fromHtml(&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found) + &quot;&lt;/strong&gt;&quot;));
  76          recyclerView.setEmptyView(emptyView);
  77  
  78          refreshTags();
  79      }
  80  
  81      @Override
  82      public void onResume() {
  83          super.onResume();
  84  
  85          mNotesBucket.start();
  86          mTagsBucket.start();
  87  
  88          mTagsBucket.addOnNetworkChangeListener(this);
  89          mTagsBucket.addOnSaveObjectListener(this);
  90          mTagsBucket.addOnDeleteObjectListener(this);
  91      }
  92  
  93      @Override
  94      public void onPause() {
  95          super.onPause();
  96  
  97          mTagsBucket.removeOnNetworkChangeListener(this);
  98          mTagsBucket.removeOnSaveObjectListener(this);
  99          mTagsBucket.removeOnDeleteObjectListener(this);
 100  
 101          mNotesBucket.stop();
 102          mTagsBucket.stop();
 103      }
 104  
 105      protected void refreshTags() {
 106          Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAME);
 107          Bucket.ObjectCursor&lt;Tag&gt; cursor = tagQuery.execute();
 108          mTagsAdapter.swapCursor(cursor);
 109      }
 110  
 111      // TODO: Finish bulk editing
 112      @Override
 113      public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 114          MenuInflater inflater = actionMode.getMenuInflater();
 115          inflater.inflate(R.menu.bulk_edit, menu);
 116          mActionMode = actionMode;
 117          return true;
 118      }
 119  
 120      @Override
 121      public boolean onPrepareActionMode(ActionMode actionMode, Menu menu) {
 122          return false;
 123      }
 124  
 125      @Override
 126      public boolean onActionItemClicked(ActionMode actionMode, MenuItem menuItem) {
 127          if (menuItem.getItemId() == R.id.menu_delete) {
 128              actionMode.finish(); // Action picked, so close the CAB
 129              return true;
 130          }
 131          return false;
 132      }
 133  
 134      @Override
 135      public void onDestroyActionMode(ActionMode actionMode) {
 136          mActionMode = null;
 137      }
 138  
 139      @Override
 140      public boolean onOptionsItemSelected(MenuItem item) {
 141  
 142          if (item.getItemId() == android.R.id.home) {
 143              if (isAdded()) {
 144                  getActivity().finish();
 145                  return true;
 146              }
 147          }
 148  
 149          return super.onOptionsItemSelected(item);
 150      }
 151  
 152      // Tag Bucket listeners
 153      @Override
 154      public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 155          if (isAdded()) {
 156              getActivity().runOnUiThread(new Runnable() {
 157                  @Override
 158                  public void run() {
 159                      refreshTags();
 160                  }
 161              });
 162          }
 163      }
 164  
 165      @Override
 166      public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 167          if (isAdded()) {
 168              getActivity().runOnUiThread(new Runnable() {
 169                  @Override
 170                  public void run() {
 171                      refreshTags();
 172                  }
 173              });
 174          }
 175      }
 176  
 177      @Override
 178      public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 179          if (isAdded()) {
 180              getActivity().runOnUiThread(new Runnable() {
 181                  @Override
 182                  public void run() {
 183                      refreshTags();
 184                  }
 185              });
 186          }
 187      }
 188  
 189      @Override
 190      public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 191          // noop
 192      }
 193  
 194      private class removeTagFromNotesTask extends AsyncTask&lt;Tag, Void, Void&gt; {
 195  
 196          @Override
 197          protected Void doInBackground(Tag... removedTags) {
 198              Tag tag = removedTags[0];
 199              if (tag != null) {
 200                  Bucket.ObjectCursor&lt;Note&gt; notesCursor = tag.findNotes(mNotesBucket);
 201                  while (notesCursor.moveToNext()) {
 202                      Note note = notesCursor.getObject();
 203                      List&lt;String&gt; tags = note.getTags();
 204                      tags.remove(tag.getName());
 205                      note.setTags(tags);
 206                      note.save();
 207                  }
 208                  notesCursor.close();
 209              }
 210              return null;
 211          }
 212      }
 213  
 214      private class TagsAdapter extends BaseCursorAdapter&lt;TagsAdapter.ViewHolder&gt; {
 215  
 216          public class ViewHolder extends RecyclerView.ViewHolder implements View.OnClickListener {
 217  
 218              private TextView tagTitle;
 219              private TextView tagCountTextView;
 220              private ImageButton deleteButton;
 221  
 222              private ViewHolder(View itemView) {
 223                  super(itemView);
 224  
 225                  tagTitle = itemView.findViewById(R.id.tag_name);
 226                  tagCountTextView = itemView.findViewById(R.id.tag_count);
 227                  deleteButton = itemView.findViewById(R.id.tag_trash);
 228  
 229                  deleteButton.setOnClickListener(new View.OnClickListener() {
 230                      @Override
 231                      public void onClick(View view) {
 232                          if (!isAdded()) return;
 233  
 234                          final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();
<abbr title=" 235                          final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 235                          final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tagðŸ”µ</abbr>
 236                          if (tagCount == 0) {
 237                              deleteTag(tag);
 238                          } else if (tagCount &gt; 0) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -                            AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 240 +                            AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContext(), R.style.Dialog));"> 240 +                            AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContextðŸ”µ</abbr></span>
 241                              alert.setTitle(R.string.delete_tag);
 242                              alert.setMessage(getString(R.string.confirm_delete_tag));
 243                              alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 244                                  public void onClick(DialogInterface dialog, int whichButton) {
 245                                      deleteTag(tag);
 246                                  }
 247                              });
 248                              alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 249                                  public void onClick(DialogInterface dialog, int whichButton) {
 250                                      // Do nothing, just closing the dialog
 251                                  }
 252                              });
 253                              alert.show();
 254                          }











 255                      }
 256                  });
 257  
 258                  itemView.setOnClickListener(this);
 259              }
 260  
 261              @Override
 262              public void onClick(View view) {
 263                  if (!isAdded()) return;
 264  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -                final AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 266 +                final AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContext(), R.style.Dialog));"> 266 +                final AlertDialog.Builder alert = new AlertDialog.Builder(new ContextThemeWrapper(getContext(), R.ðŸ”µ</abbr></span>
<abbr title=" 267                  LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null);"> 267                  LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_taðŸ”µ</abbr>
 268  
 269                  final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();
 270  
 271                  final EditText tagNameEditText = alertView.findViewById(R.id.tag_name_edit);
 272                  tagNameEditText.setText(tag.getName());
 273                  tagNameEditText.setSelection(tagNameEditText.length());
 274                  alert.setView(alertView);
 275                  alert.setTitle(R.string.rename_tag);
 276                  alert.setPositiveButton(R.string.save, new DialogInterface.OnClickListener() {
 277                      public void onClick(DialogInterface dialog, int whichButton) {
 278                          String value = tagNameEditText.getText().toString().trim();
 279                          try {
 280                              tag.renameTo(value, mNotesBucket);
 281                              AnalyticsTracker.track(
 282                                      AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED,
 283                                      AnalyticsTracker.CATEGORY_TAG,
 284                                      &quot;tag_alert_edit_box&quot;
 285                              );
 286                          } catch (BucketObjectNameInvalid e) {
 287                              android.util.Log.e(Simplenote.TAG, &quot;Unable to rename tag&quot;, e);
 288                              // TODO: show user a message that new tag name is not ok
 289                          }
 290                      }
 291                  });
 292                  alert.setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() {
 293                      public void onClick(DialogInterface dialog, int whichButton) {
 294                          // Do nothing
 295                      }
 296                  });
 297                  alert.show();
 298              }
 299  
 300              private void deleteTag(Tag tag) {
 301                  tag.delete();
 302                  new removeTagFromNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, tag);
 303                  AnalyticsTracker.track(
 304                          AnalyticsTracker.Stat.TAG_MENU_DELETED,
 305                          AnalyticsTracker.CATEGORY_TAG,
 306                          &quot;list_trash_button&quot;
 307                  );
 308              }
 309          }
 310  
 311          private TagsAdapter() {
 312              super(null);
 313          }
 314  
 315          @NonNull
 316          @Override
 317          public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
 318              Context context = parent.getContext();
 319              LayoutInflater inflater = LayoutInflater.from(context);
 320  
 321              View contactView = inflater.inflate(R.layout.tags_list_row, parent, false);
 322  
 323              return new ViewHolder(contactView);
 324          }
 325  
 326          @Override
 327          public void onBindViewHolder(@NonNull ViewHolder holder, Cursor cursor) {
 328              Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)cursor).getObject();
 329  
 330              holder.tagTitle.setText(tag.getName());
<abbr title=" 331              final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 331              final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).ðŸ”µ</abbr>
 332              if (tagCount &gt; 0) {
 333                  holder.tagCountTextView.setText(String.valueOf(tagCount));
 334              } else {
 335                  holder.tagCountTextView.setText(&quot;&quot;);
 336              }
 337          }
 338  
 339          @Override
 340          public void swapCursor(Cursor newCursor) {
 341              super.swapCursor(newCursor);
 342          }
 343      }
 344  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Fragment;
   4  import android.content.Context;
   5  import android.content.DialogInterface;
   6  import android.database.Cursor;
   7  import android.os.AsyncTask;
   8  import android.os.Bundle;
   9  import android.view.ActionMode;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 +import android.view.HapticFeedbackConstants;</span>
  11  import android.view.LayoutInflater;
  12  import android.view.Menu;
  13  import android.view.MenuInflater;
  14  import android.view.MenuItem;
  15  import android.view.View;
  16  import android.view.ViewGroup;
  17  import android.widget.EditText;
  18  import android.widget.ImageButton;
  19  import android.widget.LinearLayout;
  20  import android.widget.TextView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import android.widget.Toast;</span>
  22  
  23  import androidx.annotation.NonNull;
  24  import androidx.appcompat.app.AlertDialog;

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import androidx.recyclerview.widget.DividerItemDecoration;</span>
  26  import androidx.recyclerview.widget.LinearLayoutManager;
  27  import androidx.recyclerview.widget.RecyclerView;
  28  
  29  import com.automattic.simplenote.analytics.AnalyticsTracker;
  30  import com.automattic.simplenote.models.Note;
  31  import com.automattic.simplenote.models.Tag;
  32  import com.automattic.simplenote.utils.BaseCursorAdapter;
  33  import com.automattic.simplenote.utils.HtmlCompat;
  34  import com.automattic.simplenote.widgets.EmptyViewRecyclerView;
  35  import com.simperium.client.Bucket;
  36  import com.simperium.client.BucketObjectNameInvalid;
  37  import com.simperium.client.Query;
  38  
  39  import java.util.List;
  40  
  41  public class TagsListFragment extends Fragment implements ActionMode.Callback, Bucket.Listener&lt;Tag&gt; {
  42  
  43      private ActionMode mActionMode;
  44      private Bucket&lt;Tag&gt; mTagsBucket;
  45      private Bucket&lt;Note&gt; mNotesBucket;
  46      private TagsAdapter mTagsAdapter;
  47  
  48      /**
  49       * Mandatory empty constructor for the fragment manager to instantiate the
  50       * fragment (e.g. upon screen orientation changes).
  51       */
  52      public TagsListFragment() {
  53      }
  54  
  55      @Override
  56      public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
  57          return inflater.inflate(R.layout.fragment_tags_list, container, false);
  58      }
  59  
  60      @Override
  61      public void onActivityCreated(Bundle savedInstanceState) {
  62          super.onActivityCreated(savedInstanceState);
  63  
  64          setHasOptionsMenu(true);
  65  
  66          Simplenote application = (Simplenote) getActivity().getApplication();
  67          mTagsBucket = application.getTagsBucket();
  68          mNotesBucket = application.getNotesBucket();
  69  
  70          EmptyViewRecyclerView recyclerView = getActivity().findViewById(R.id.list);
  71          mTagsAdapter = new TagsAdapter();
  72          recyclerView.setAdapter(mTagsAdapter);
  73          recyclerView.setLayoutManager(new LinearLayoutManager(getActivity()));
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  74 -        recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDecoration.VERTICAL));">  74 -        recyclerView.addItemDecoration(new DividerItemDecoration(recyclerView.getContext(), DividerItemDecoration.ðŸ”µ</abbr></span>
  75          TextView emptyView = getActivity().findViewById(R.id.empty);
  76          emptyView.setText(HtmlCompat.fromHtml(&quot;&lt;strong&gt;&quot; + getString(R.string.no_tags_found) + &quot;&lt;/strong&gt;&quot;));
  77          recyclerView.setEmptyView(emptyView);
  78  
  79          refreshTags();
  80      }
  81  
  82      @Override
  83      public void onResume() {
  84          super.onResume();
  85  
  86          mNotesBucket.start();
  87          mTagsBucket.start();
  88  
  89          mTagsBucket.addOnNetworkChangeListener(this);
  90          mTagsBucket.addOnSaveObjectListener(this);
  91          mTagsBucket.addOnDeleteObjectListener(this);
  92      }
  93  
  94      @Override
  95      public void onPause() {
  96          super.onPause();
  97  
  98          mTagsBucket.removeOnNetworkChangeListener(this);
  99          mTagsBucket.removeOnSaveObjectListener(this);
 100          mTagsBucket.removeOnDeleteObjectListener(this);
 101  
 102          mNotesBucket.stop();
 103          mTagsBucket.stop();
 104      }
 105  
 106      protected void refreshTags() {
 107          Query&lt;Tag&gt; tagQuery = Tag.all(mTagsBucket).reorder().orderByKey().include(Tag.NOTE_COUNT_INDEX_NAME);
 108          Bucket.ObjectCursor&lt;Tag&gt; cursor = tagQuery.execute();
 109          mTagsAdapter.swapCursor(cursor);
 110      }
 111  
 112      // TODO: Finish bulk editing
 113      @Override
 114      public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 115          MenuInflater inflater = actionMode.getMenuInflater();
 116          inflater.inflate(R.menu.bulk_edit, menu);
 117          mActionMode = actionMode;
 118          return true;
 119      }
 120  
 121      @Override
 122      public boolean onPrepareActionMode(ActionMode actionMode, Menu menu) {
 123          return false;
 124      }
 125  
 126      @Override
 127      public boolean onActionItemClicked(ActionMode actionMode, MenuItem menuItem) {
 128          if (menuItem.getItemId() == R.id.menu_delete) {
 129              actionMode.finish(); // Action picked, so close the CAB
 130              return true;
 131          }
 132          return false;
 133      }
 134  
 135      @Override
 136      public void onDestroyActionMode(ActionMode actionMode) {
 137          mActionMode = null;
 138      }
 139  
 140      @Override
 141      public boolean onOptionsItemSelected(MenuItem item) {
 142  
 143          if (item.getItemId() == android.R.id.home) {
 144              if (isAdded()) {
 145                  getActivity().finish();
 146                  return true;
 147              }
 148          }
 149  
 150          return super.onOptionsItemSelected(item);
 151      }
 152  
 153      // Tag Bucket listeners
 154      @Override
 155      public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 156          if (isAdded()) {
 157              getActivity().runOnUiThread(new Runnable() {
 158                  @Override
 159                  public void run() {
 160                      refreshTags();
 161                  }
 162              });
 163          }
 164      }
 165  
 166      @Override
 167      public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 168          if (isAdded()) {
 169              getActivity().runOnUiThread(new Runnable() {
 170                  @Override
 171                  public void run() {
 172                      refreshTags();
 173                  }
 174              });
 175          }
 176      }
 177  
 178      @Override
 179      public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 180          if (isAdded()) {
 181              getActivity().runOnUiThread(new Runnable() {
 182                  @Override
 183                  public void run() {
 184                      refreshTags();
 185                  }
 186              });
 187          }
 188      }
 189  
 190      @Override
 191      public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 192          // noop
 193      }
 194  
 195      private class removeTagFromNotesTask extends AsyncTask&lt;Tag, Void, Void&gt; {
 196  
 197          @Override
 198          protected Void doInBackground(Tag... removedTags) {
 199              Tag tag = removedTags[0];
 200              if (tag != null) {
 201                  Bucket.ObjectCursor&lt;Note&gt; notesCursor = tag.findNotes(mNotesBucket);
 202                  while (notesCursor.moveToNext()) {
 203                      Note note = notesCursor.getObject();
 204                      List&lt;String&gt; tags = note.getTags();
 205                      tags.remove(tag.getName());
 206                      note.setTags(tags);
 207                      note.save();
 208                  }
 209                  notesCursor.close();
 210              }
 211              return null;
 212          }
 213      }
 214  
 215      private class TagsAdapter extends BaseCursorAdapter&lt;TagsAdapter.ViewHolder&gt; {
 216  
 217          public class ViewHolder extends RecyclerView.ViewHolder implements View.OnClickListener {
 218  
 219              private TextView tagTitle;
 220              private TextView tagCountTextView;
 221              private ImageButton deleteButton;
 222  
 223              private ViewHolder(View itemView) {
 224                  super(itemView);
 225  
 226                  tagTitle = itemView.findViewById(R.id.tag_name);
 227                  tagCountTextView = itemView.findViewById(R.id.tag_count);
 228                  deleteButton = itemView.findViewById(R.id.tag_trash);
 229  
 230                  deleteButton.setOnClickListener(new View.OnClickListener() {
 231                      @Override
 232                      public void onClick(View view) {
 233                          if (!isAdded()) return;
 234  
 235                          final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();
<abbr title=" 236                          final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 236                          final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tagðŸ”µ</abbr>
 237                          if (tagCount == 0) {
 238                              deleteTag(tag);
 239                          } else if (tagCount &gt; 0) {
 240                              AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());

 241                              alert.setTitle(R.string.delete_tag);
 242                              alert.setMessage(getString(R.string.confirm_delete_tag));
 243                              alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 244                                  public void onClick(DialogInterface dialog, int whichButton) {
 245                                      deleteTag(tag);
 246                                  }
 247                              });
 248                              alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 249                                  public void onClick(DialogInterface dialog, int whichButton) {
 250                                      // Do nothing, just closing the dialog
 251                                  }
 252                              });
 253                              alert.show();
 254                          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +                });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +                deleteButton.setOnLongClickListener(new View.OnLongClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +                    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +                    public boolean onLongClick(View v) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +                        if (v.isHapticFeedbackEnabled()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +                            v.performHapticFeedback(HapticFeedbackConstants.LONG_PRESS);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 264 +                        Toast.makeText(getContext(), getContext().getString(R.string.delete_tag), Toast.LENGTH_SHORT).show();"> 264 +                        Toast.makeText(getContext(), getContext().getString(R.string.delete_tag), Toast.LENGTH_SHOðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +                        return true;</span>
 266                      }
 267                  });
 268  
 269                  itemView.setOnClickListener(this);
 270              }
 271  
 272              @Override
 273              public void onClick(View view) {
 274                  if (!isAdded()) return;
 275  
 276                  final AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());

<abbr title=" 277                  LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_tag, null);"> 277                  LinearLayout alertView = (LinearLayout) getActivity().getLayoutInflater().inflate(R.layout.edit_taðŸ”µ</abbr>
 278  
 279                  final Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)getItem(getAdapterPosition())).getObject();
 280  
 281                  final EditText tagNameEditText = alertView.findViewById(R.id.tag_name_edit);
 282                  tagNameEditText.setText(tag.getName());
 283                  tagNameEditText.setSelection(tagNameEditText.length());
 284                  alert.setView(alertView);
 285                  alert.setTitle(R.string.rename_tag);
 286                  alert.setPositiveButton(R.string.save, new DialogInterface.OnClickListener() {
 287                      public void onClick(DialogInterface dialog, int whichButton) {
 288                          String value = tagNameEditText.getText().toString().trim();
 289                          try {
 290                              tag.renameTo(value, mNotesBucket);
 291                              AnalyticsTracker.track(
 292                                      AnalyticsTracker.Stat.TAG_EDITOR_ACCESSED,
 293                                      AnalyticsTracker.CATEGORY_TAG,
 294                                      &quot;tag_alert_edit_box&quot;
 295                              );
 296                          } catch (BucketObjectNameInvalid e) {
 297                              android.util.Log.e(Simplenote.TAG, &quot;Unable to rename tag&quot;, e);
 298                              // TODO: show user a message that new tag name is not ok
 299                          }
 300                      }
 301                  });
 302                  alert.setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() {
 303                      public void onClick(DialogInterface dialog, int whichButton) {
 304                          // Do nothing
 305                      }
 306                  });
 307                  alert.show();
 308              }
 309  
 310              private void deleteTag(Tag tag) {
 311                  tag.delete();
 312                  new removeTagFromNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, tag);
 313                  AnalyticsTracker.track(
 314                          AnalyticsTracker.Stat.TAG_MENU_DELETED,
 315                          AnalyticsTracker.CATEGORY_TAG,
 316                          &quot;list_trash_button&quot;
 317                  );
 318              }
 319          }
 320  
 321          private TagsAdapter() {
 322              super(null);
 323          }
 324  
 325          @NonNull
 326          @Override
 327          public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
 328              Context context = parent.getContext();
 329              LayoutInflater inflater = LayoutInflater.from(context);
 330  
 331              View contactView = inflater.inflate(R.layout.tags_list_row, parent, false);
 332  
 333              return new ViewHolder(contactView);
 334          }
 335  
 336          @Override
 337          public void onBindViewHolder(@NonNull ViewHolder holder, Cursor cursor) {
 338              Tag tag = ((Bucket.ObjectCursor&lt;Tag&gt;)cursor).getObject();
 339  
 340              holder.tagTitle.setText(tag.getName());
<abbr title=" 341              final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).count();"> 341              final int tagCount = mNotesBucket.query().where(&quot;tags&quot;, Query.ComparisonType.EQUAL_TO, tag.getName()).ðŸ”µ</abbr>
 342              if (tagCount &gt; 0) {
 343                  holder.tagCountTextView.setText(String.valueOf(tagCount));
 344              } else {
 345                  holder.tagCountTextView.setText(&quot;&quot;);
 346              }
 347          }
 348  
 349          @Override
 350          public void swapCursor(Cursor newCursor) {
 351              super.swapCursor(newCursor);
 352          }
 353      }
 354  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            