<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>553</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    553
                    <a href="552.html">prev</a>
                    <a href="554.html">next</a>
                    <a href="553_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_480cc75b1cb442e73c527d4143197bb30c9b53c5_kafka10/kafka10-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/KafkaSink.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;480cc75b1cb442e73c527d4143197bb30c9b53c5:kafka10/kafka10-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/KafkaSink.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;480cc75b1cb442e73c527d4143197bb30c9b53c5^1:kafka10/kafka10-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/KafkaSink.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;480cc75b1cb442e73c527d4143197bb30c9b53c5^2:kafka10/kafka10-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/KafkaSink.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;cf3543519ddfe6db5473b2b15766ed32bc95d5cf:kafka10/kafka10-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/KafkaSink.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj], [b], [j], [j], [s], [s]], subset: [[sbj], [bs], [sj], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.sink.kafka;
  20 
  21 import com.dtstack.flink.sql.sink.IStreamSinkGener;
  22 import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  23 import com.dtstack.flink.sql.table.AbstractTargetTableInfo;
  24 import org.apache.commons.lang3.StringUtils;
  25 import org.apache.flink.api.common.typeinfo.TypeInformation;
  26 import org.apache.flink.api.java.tuple.Tuple2;
  27 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  28 import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  29 import org.apache.flink.streaming.api.datastream.DataStream;
  30 import org.apache.flink.streaming.api.datastream.DataStreamSink;
  31 import org.apache.flink.streaming.api.functions.sink.SinkFunction;
  32 import org.apache.flink.table.api.TableSchema;
  33 import org.apache.flink.table.runtime.types.CRow;
  34 import org.apache.flink.table.runtime.types.CRowTypeInfo;
  35 import org.apache.flink.table.sinks.RetractStreamTableSink;
  36 import org.apache.flink.table.sinks.TableSink;
  37 import org.apache.flink.types.Row;
  38 
  39 import java.util.Optional;
  40 import java.util.Properties;
  41 
  42 /**
  43  *
  44  * Date: 2018/12/18
  45  * Company: www.dtstack.com
  46  *
  47  * @author DocLi
  48  *
  49  * @modifyer maqi
  50  *
  51  */
  52 public class KafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener&lt;KafkaSink&gt; {
  53 
  54     private static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;
  55     protected String[] fieldNames;
  56 
  57     protected TypeInformation&lt;?&gt;[] fieldTypes;
  58 
  59     protected String topic;
  60 
  61     protected Properties properties;
  62 
  63     protected int parallelism;
  64 
  65     protected KafkaSinkTableInfo kafka10SinkTableInfo;
  66 
  67     protected RichSinkFunction&lt;CRow&gt; kafkaProducer010;
  68     protected CRowTypeInfo typeInformation;
  69 
  70     /** The schema of the table. */
  71     protected TableSchema schema;
  72 
  73     private String[] partitionKeys;
  74 
  75     protected SinkFunction&lt;Row&gt; kafkaProducer010;
  76 
  77     protected String sinkOperatorName;
  78 
  79     @Override
  80     public KafkaSink genStreamSink(AbstractTargetTableInfo targetTableInfo) {
  81         this.kafka10SinkTableInfo = (KafkaSinkTableInfo) targetTableInfo;
  82         this.topic = kafka10SinkTableInfo.getTopic();
  83 
  84         properties = new Properties();
  85         properties.setProperty(&quot;bootstrap.servers&quot;, kafka10SinkTableInfo.getBootstrapServers());
  86 
  87         for (String key : kafka10SinkTableInfo.getKafkaParamKeys()) {
  88             properties.setProperty(key, kafka10SinkTableInfo.getKafkaParam(key));
  89         }
  90 
  91         this.partitionKeys = getPartitionKeys(kafka10SinkTableInfo);
  92         this.fieldNames = kafka10SinkTableInfo.getFields();
  93         TypeInformation[] types = new TypeInformation[kafka10SinkTableInfo.getFields().length];
  94         for (int i = 0; i &lt; kafka10SinkTableInfo.getFieldClasses().length; i++) {
  95             types[i] = TypeInformation.of(kafka10SinkTableInfo.getFieldClasses()[i]);
  96         }
  97         this.fieldTypes = types;
  98 
  99 
 100         TableSchema.Builder schemaBuilder = TableSchema.builder();
 101         for (int i = 0; i &lt; fieldNames.length; i++) {
 102             schemaBuilder.field(fieldNames[i], fieldTypes[i]);
 103         }
 104         this.schema = schemaBuilder.build();
 105 
 106         Integer parallelism = kafka10SinkTableInfo.getParallelism();
 107         if (parallelism != null) {
 108             this.parallelism = parallelism;
 109         }
 110 
 111 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 112         kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo, getOutputType().getTypeAt(1), properties,"> 112         kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo, getOutðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113                 Optional.of(new CustomerFlinkPartition&lt;&gt;()), partitionKeys);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 115         sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka10SinkTableInfo.getName());"> 115         sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka10SðŸ”µ</abbr></span>
 116 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120     public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 </span>
 122 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123         typeInformation = new CRowTypeInfo(new RowTypeInfo(fieldTypes, fieldNames));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124         kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125                 typeInformation, properties,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126                 Optional.of(new CustomerFlinkPartition&lt;&gt;()), partitionKeys);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127 </span>
 128 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 129         return this;
 130     }
 131 
 132     @Override
 133     public TypeInformation&lt;Row&gt; getRecordType() {
 134         return new RowTypeInfo(fieldTypes, fieldNames);
 135     }
 136 
 137     @Override
 138     public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {
 139 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140         consumeDataStream(dataStream);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144     public DataStreamSink&lt;Row&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145         DataStream&lt;Row&gt; ds = dataStream</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146                 .filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147                 .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148                 .returns(getOutputType().getTypeAt(1))</span>
 149 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153     public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 154         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 154         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158     public String[] getFieldNames() {</span>
 159 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160         DataStream&lt;CRow&gt; mapDataStream = dataStream</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161                 .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; new CRow(record.f1, record.f0))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162                 .returns(typeInformation)</span>
 163 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 164                 .setParallelism(parallelism);
 165 
 166         DataStreamSink&lt;Row&gt; dataStreamSink = ds.addSink(kafkaProducer010).name(sinkOperatorName);
 167         return dataStreamSink;
 168     }
 169 
 170 
 171     @Override
 172     public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {
<abbr title=" 173         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 173         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, ðŸ”µ</abbr>
 174     }
 175 
 176 
 177     @Override
 178     public TableSchema getTableSchema() {
 179         return schema;
 180     }
 181 
 182     @Override
<abbr title=" 183     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {"> 183     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypesðŸ”µ</abbr>
 184         this.fieldNames = fieldNames;
 185         this.fieldTypes = fieldTypes;
 186         return this;
 187     }
 188 
 189     private String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo) {
 190         if (StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())) {
 191             return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);
 192         }
 193         return null;
 194     }
 195 
 196 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 package com.dtstack.flink.sql.sink.kafka;
  20 
  21 import com.dtstack.flink.sql.sink.IStreamSinkGener;
  22 import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  23 import com.dtstack.flink.sql.table.AbstractTargetTableInfo;
  24 import org.apache.commons.lang3.StringUtils;
  25 import org.apache.flink.api.common.typeinfo.TypeInformation;
  26 import org.apache.flink.api.java.tuple.Tuple2;
  27 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  28 import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  29 import org.apache.flink.streaming.api.datastream.DataStream;
  30 import org.apache.flink.streaming.api.datastream.DataStreamSink;
  31 import org.apache.flink.streaming.api.functions.sink.SinkFunction;
  32 import org.apache.flink.table.api.TableSchema;
  33 import org.apache.flink.table.runtime.types.CRow;
  34 import org.apache.flink.table.runtime.types.CRowTypeInfo;
  35 import org.apache.flink.table.sinks.RetractStreamTableSink;
  36 import org.apache.flink.table.sinks.TableSink;
  37 import org.apache.flink.types.Row;
  38 
  39 import java.util.Optional;
  40 import java.util.Properties;
  41 
  42 /**
  43  *
  44  * Date: 2018/12/18
  45  * Company: www.dtstack.com
  46  *
  47  * @author DocLi
  48  *
  49  * @modifyer maqi
  50  *
  51  */
  52 public class KafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener&lt;KafkaSink&gt; {
  53 
  54     private static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;
  55     protected String[] fieldNames;
  56 
  57     protected TypeInformation&lt;?&gt;[] fieldTypes;
  58 
  59     protected String topic;
  60 
  61     protected Properties properties;
  62 
  63     protected int parallelism;
  64 
  65     protected  KafkaSinkTableInfo kafka10SinkTableInfo;
  66 
  67 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68 protected SinkFunction&lt;Row&gt; kafkaProducer010;</span>
  69 ||||||| BASE
  70 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71 protected RichSinkFunction&lt;CRow&gt; kafkaProducer010;</span>
  72 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
  73 
  74 
  75     protected String sinkOperatorName;
  76     protected CRowTypeInfo typeInformation;
  77 
  78     /** The schema of the table. */
  79     protected TableSchema schema;
  80 
  81     private String[] partitionKeys;
  82 
  83     @Override
  84     public KafkaSink genStreamSink(AbstractTargetTableInfo targetTableInfo) {
  85         this.kafka10SinkTableInfo = (KafkaSinkTableInfo) targetTableInfo;
  86         this.topic = kafka10SinkTableInfo.getTopic();
  87 
  88         properties = new Properties();
  89         properties.setProperty(&quot;bootstrap.servers&quot;, kafka10SinkTableInfo.getBootstrapServers());
  90 
  91         for (String key : kafka10SinkTableInfo.getKafkaParamKeys()) {
  92             properties.setProperty(key, kafka10SinkTableInfo.getKafkaParam(key));
  93         }
  94 
  95         this.partitionKeys = getPartitionKeys(kafka10SinkTableInfo);
  96         this.fieldNames = kafka10SinkTableInfo.getFields();
  97         TypeInformation[] types = new TypeInformation[kafka10SinkTableInfo.getFields().length];
  98         for (int i = 0; i &lt; kafka10SinkTableInfo.getFieldClasses().length; i++) {
  99             types[i] = TypeInformation.of(kafka10SinkTableInfo.getFieldClasses()[i]);
 100         }
 101         this.fieldTypes = types;
 102 
 103 
 104         TableSchema.Builder schemaBuilder = TableSchema.builder();
 105         for (int i=0;i&lt;fieldNames.length;i++){
 106             schemaBuilder.field(fieldNames[i], fieldTypes[i]);
 107         }
 108         this.schema = schemaBuilder.build();
 109 
 110         Integer parallelism = kafka10SinkTableInfo.getParallelism();
 111         if (parallelism != null) {
 112             this.parallelism = parallelism;
 113         }
 114 
 115 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 116         kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo, getOutputType().getTypeAt(1), properties,"> 116         kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo, getOutðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117                 Optional.of(new CustomerFlinkPartition&lt;&gt;()), partitionKeys);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 119         sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka10SinkTableInfo.getName());"> 119         sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka10SðŸ”µ</abbr></span>
 120 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121     }</span>
 122 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123         typeInformation = new CRowTypeInfo(new RowTypeInfo(fieldTypes, fieldNames));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124         kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125                 typeInformation, properties,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126                 Optional.of(new CustomerFlinkPartition&lt;&gt;()), partitionKeys);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127 </span>
 128 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 129         return this;
 130     }
 131 
 132     @Override
 133     public TypeInformation&lt;Row&gt; getRecordType() {
 134         return new RowTypeInfo(fieldTypes, fieldNames);
 135     }
 136 
 137     @Override
 138     public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {
 139 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140         consumeDataStream(dataStream);</span>
 141 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 143         RichSinkFunction&lt;Row&gt; kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo, getOutputType().getTypeAt(1), properties,"> 143         RichSinkFunction&lt;Row&gt; kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka1ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144                 Optional.of(new CustomerFlinkPartition&lt;&gt;()), partitionKeys);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146         DataStream&lt;Row&gt; mapDataStream = dataStream.filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147                 .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1)</span>
 148 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149         DataStream&lt;CRow&gt; mapDataStream = dataStream</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150                 .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; new CRow(record.f1, record.f0))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151                 .returns(typeInformation)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152                 .setParallelism(parallelism);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 154         mapDataStream.addSink(kafkaProducer010).name(TableConnectorUtils.generateRuntimeName(this.getClass(), getFieldNames()));"> 154         mapDataStream.addSink(kafkaProducer010).name(TableConnectorUtils.generateRuntimeName(this.getClasðŸ”µ</abbr></span>
 155 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 156     }
 157 
 158     @Override
 159     public DataStreamSink&lt;Row&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {
 160         DataStream&lt;Row&gt; ds = dataStream
 161                 .filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)
 162                 .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1)
 163                 .returns(getOutputType().getTypeAt(1))
 164                 .setParallelism(parallelism);
 165 
 166         DataStreamSink&lt;Row&gt; dataStreamSink = ds.addSink(kafkaProducer010).name(sinkOperatorName);
 167         return dataStreamSink;
 168     }
 169 
 170 
 171     @Override
 172     public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {
<abbr title=" 173         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 173         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, ðŸ”µ</abbr>
 174     }
 175 
 176 
 177     @Override
 178     public TableSchema getTableSchema() {
 179         return schema;
 180     }
 181 
 182     @Override
<abbr title=" 183     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {"> 183     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypesðŸ”µ</abbr>
 184         this.fieldNames = fieldNames;
 185         this.fieldTypes = fieldTypes;
 186         return this;
 187     }
 188 
 189     private String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo){
 190         if(StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())){
 191             return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);
 192         }
 193         return null;
 194     }
 195 
 196 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.sink.kafka;
  19 
  20 import com.dtstack.flink.sql.sink.IStreamSinkGener;
  21 import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  22 import com.dtstack.flink.sql.table.AbstractTargetTableInfo;
  23 import java.util.Optional;
  24 import java.util.Properties;
  25 import org.apache.commons.lang3.StringUtils;
  26 import org.apache.flink.api.common.typeinfo.TypeInformation;
  27 import org.apache.flink.api.java.tuple.Tuple2;
  28 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  29 import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  30 import org.apache.flink.streaming.api.datastream.DataStream;
  31 import org.apache.flink.streaming.api.datastream.DataStreamSink;
  32 import org.apache.flink.streaming.api.functions.sink.SinkFunction;
  33 import org.apache.flink.table.api.TableSchema;
  34 import org.apache.flink.table.runtime.types.CRow;
  35 import org.apache.flink.table.runtime.types.CRowTypeInfo;
  36 import org.apache.flink.table.sinks.RetractStreamTableSink;
  37 import org.apache.flink.table.sinks.TableSink;
  38 import org.apache.flink.types.Row;
  39 
  40 
  41 /**
  42  *
  43  * Date: 2018/12/18
  44  * Company: www.dtstack.com
  45  *
  46  * @author DocLi
  47  *
  48  * @modifyer maqi
  49  *
  50  */
  51 public class KafkaSink implements RetractStreamTableSink&lt;Row&gt; , IStreamSinkGener&lt;KafkaSink&gt; {
  52     private static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;
  53 
  54     protected String[] fieldNames;
  55 
  56     protected TypeInformation&lt;?&gt;[] fieldTypes;
  57 
  58     protected String topic;
  59 
  60     protected Properties properties;
  61 
  62     protected int parallelism;
  63 
  64     protected  KafkaSinkTableInfo kafka10SinkTableInfo;
  65 
  66     protected CRowTypeInfo typeInformation;
  67 
  68     /** The schema of the table. */
  69     protected TableSchema schema;
  70 
  71     private String[] partitionKeys;
  72 
  73     protected String sinkOperatorName;
  74 
  75     @Override
  76     public KafkaSink genStreamSink(AbstractTargetTableInfo targetTableInfo) {
  77         this.kafka10SinkTableInfo = ((KafkaSinkTableInfo) (targetTableInfo));
  78         this.topic = kafka10SinkTableInfo.getTopic();
  79         properties = new Properties();
  80         properties.setProperty(&quot;bootstrap.servers&quot;, kafka10SinkTableInfo.getBootstrapServers());
  81         for (String key : kafka10SinkTableInfo.getKafkaParamKeys()) {
  82             properties.setProperty(key, kafka10SinkTableInfo.getKafkaParam(key));
  83         }
  84         this.partitionKeys = getPartitionKeys(kafka10SinkTableInfo);
  85         this.fieldNames = kafka10SinkTableInfo.getFields();
  86         TypeInformation[] types = new TypeInformation[kafka10SinkTableInfo.getFields().length];
  87         for (int i = 0; i &lt; kafka10SinkTableInfo.getFieldClasses().length; i++) {
  88             types[i] = TypeInformation.of(kafka10SinkTableInfo.getFieldClasses()[i]);
  89         }
  90         this.fieldTypes = types;
  91         TableSchema.Builder schemaBuilder = TableSchema.builder();
  92         for (int i = 0; i &lt; fieldNames.length; i++) {
  93             schemaBuilder.field(fieldNames[i], fieldTypes[i]);
  94         }
  95         this.schema = schemaBuilder.build();
  96         Integer parallelism = kafka10SinkTableInfo.getParallelism();
  97         if (parallelism != null) {
  98             this.parallelism = parallelism;
  99         }
 100 
 101 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 102         kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo, getOutputType().getTypeAt(1), properties,"> 102         kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo, getOutðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103                 Optional.of(new CustomerFlinkPartition&lt;&gt;()), partitionKeys);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 105         sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka10SinkTableInfo.getName());"> 105         sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka10SðŸ”µ</abbr></span>
 106 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 107 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 107 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 108 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110         typeInformation = new CRowTypeInfo(new RowTypeInfo(fieldTypes, fieldNames));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111         kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112                 typeInformation, properties,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113                 Optional.of(new CustomerFlinkPartition&lt;&gt;()), partitionKeys);</span>
 114 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 115 
 116         return this;
 117     }
 118 
 119     @Override
 120     public TypeInformation&lt;Row&gt; getRecordType() {
 121         return new RowTypeInfo(fieldTypes, fieldNames);
 122     }
 123 
 124     @Override
 125     public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {
 126         consumeDataStream(dataStream);
 127     }
 128 
 129     @Override
 130     public DataStreamSink&lt;Row&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {
<abbr title=" 131         DataStream&lt;Row&gt; ds = dataStream.filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0).map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1).returns(getOutputType().getTypeAt(1)).setParallelism(parallelism);"> 131         DataStream&lt;Row&gt; ds = dataStream.filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0).map((Tuple2&lt;BoðŸ”µ</abbr>
 132         DataStreamSink&lt;Row&gt; dataStreamSink = ds.addSink(kafkaProducer010).name(sinkOperatorName);
 133         return dataStreamSink;
 134     }
 135 
 136     @Override
 137     public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {
<abbr title=" 138         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 138         return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, ðŸ”µ</abbr>
 139     }
 140 
 141     @Override
 142     public TableSchema getTableSchema() {
 143         return schema;
 144     }
 145 
 146     @Override
<abbr title=" 147     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {"> 147     public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypesðŸ”µ</abbr>
 148         this.fieldNames = fieldNames;
 149         this.fieldTypes = fieldTypes;
 150         return this;
 151     }
 152 
 153     private String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo){
 154         if(StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())){
 155             return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);
 156         }
 157         return null;
 158     }
 159 
 160     protected
 161 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162 SinkFunction</span>
 163 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 164 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 164 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 165 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167 RichSinkFunction</span>
 168 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 169     &lt;
 170 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171 Row</span>
 172 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 173 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 173 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 174 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176 CRow</span>
 177 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 178     &gt; kafkaProducer010;
 179 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.sink.kafka;
  20  
  21  import com.dtstack.flink.sql.sink.IStreamSinkGener;
  22  import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  23  import com.dtstack.flink.sql.table.AbstractTargetTableInfo;
  24  import org.apache.commons.lang3.StringUtils;
  25  import org.apache.flink.api.common.typeinfo.TypeInformation;
  26  import org.apache.flink.api.java.tuple.Tuple2;
  27  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  28  import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  29  import org.apache.flink.streaming.api.datastream.DataStream;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import org.apache.flink.streaming.api.datastream.DataStreamSink;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import org.apache.flink.streaming.api.functions.sink.SinkFunction;</span>
  33  import org.apache.flink.table.api.TableSchema;


  34  import org.apache.flink.table.sinks.RetractStreamTableSink;
  35  import org.apache.flink.table.sinks.TableSink;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import org.apache.flink.table.utils.TableConnectorUtils;</span>
  37  import org.apache.flink.types.Row;
  38  
  39  import java.util.Optional;
  40  import java.util.Properties;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +</span>
  42  /**
  43   *
  44   * Date: 2018/12/18
  45   * Company: www.dtstack.com
  46   *
  47   * @author DocLi
  48   *
  49   * @modifyer maqi
  50   *
  51   */
  52  public class KafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener&lt;KafkaSink&gt; {
  53  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +    private static final String SINK_OPERATOR_NAME_TPL = &quot;${topic}_${table}&quot;;</span>
  56      protected String[] fieldNames;
  57  
  58      protected TypeInformation&lt;?&gt;[] fieldTypes;
  59  
  60      protected String topic;
  61  
  62      protected Properties properties;
  63  
  64      protected int parallelism;
  65  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -    protected  KafkaSinkTableInfo kafka10SinkTableInfo;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +    protected KafkaSinkTableInfo kafka10SinkTableInfo;</span>


  68  
  69      /** The schema of the table. */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -    private TableSchema schema;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +    protected TableSchema schema;</span>
  72  
  73      private String[] partitionKeys;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +    protected SinkFunction&lt;Row&gt; kafkaProducer010;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  77 +    protected String sinkOperatorName;</span>
  78  
  79      @Override
  80      public KafkaSink genStreamSink(AbstractTargetTableInfo targetTableInfo) {
  81          this.kafka10SinkTableInfo = (KafkaSinkTableInfo) targetTableInfo;
  82          this.topic = kafka10SinkTableInfo.getTopic();
  83  
  84          properties = new Properties();
  85          properties.setProperty(&quot;bootstrap.servers&quot;, kafka10SinkTableInfo.getBootstrapServers());
  86  
  87          for (String key : kafka10SinkTableInfo.getKafkaParamKeys()) {
  88              properties.setProperty(key, kafka10SinkTableInfo.getKafkaParam(key));
  89          }
  90  
  91          this.partitionKeys = getPartitionKeys(kafka10SinkTableInfo);
  92          this.fieldNames = kafka10SinkTableInfo.getFields();
  93          TypeInformation[] types = new TypeInformation[kafka10SinkTableInfo.getFields().length];
  94          for (int i = 0; i &lt; kafka10SinkTableInfo.getFieldClasses().length; i++) {
  95              types[i] = TypeInformation.of(kafka10SinkTableInfo.getFieldClasses()[i]);
  96          }
  97          this.fieldTypes = types;
  98  
  99  
 100          TableSchema.Builder schemaBuilder = TableSchema.builder();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -        for (int i=0;i&lt;fieldNames.length;i++){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +        for (int i = 0; i &lt; fieldNames.length; i++) {</span>
 103              schemaBuilder.field(fieldNames[i], fieldTypes[i]);
 104          }
 105          this.schema = schemaBuilder.build();
 106  
 107          Integer parallelism = kafka10SinkTableInfo.getParallelism();
 108          if (parallelism != null) {
 109              this.parallelism = parallelism;
 110          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 112 +        kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo, getOutputType().getTypeAt(1), properties,"> 112 +        kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo, getOutputType()ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +                Optional.of(new CustomerFlinkPartition&lt;&gt;()), partitionKeys);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 115 +        sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka10SinkTableInfo.getName());"> 115 +        sinkOperatorName = SINK_OPERATOR_NAME_TPL.replace(&quot;${topic}&quot;, topic).replace(&quot;${table}&quot;, kafka10SinkTableIðŸ”µ</abbr></span>

 116          return this;
 117      }
 118  
 119      @Override
 120      public TypeInformation&lt;Row&gt; getRecordType() {
 121          return new RowTypeInfo(fieldTypes, fieldNames);
 122      }
 123  
 124      @Override
 125      public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        consumeDataStream(dataStream);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +    }</span>
 128  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 129 -        RichSinkFunction&lt;Row&gt; kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo, getOutputType().getTypeAt(1), properties,"> 129 -        RichSinkFunction&lt;Row&gt; kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTablðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -                Optional.of(new CustomerFlinkPartition&lt;&gt;()), partitionKeys);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        DataStream&lt;Row&gt; mapDataStream = dataStream.filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +    public DataStreamSink&lt;Row&gt; consumeDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +        DataStream&lt;Row&gt; ds = dataStream</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +                .filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)</span>
 137                  .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1)
 138                  .returns(getOutputType().getTypeAt(1))



 139                  .setParallelism(parallelism);
 140  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 141 -        mapDataStream.addSink(kafkaProducer010).name(TableConnectorUtils.generateRuntimeName(this.getClass(), getFieldNames()));"> 141 -        mapDataStream.addSink(kafkaProducer010).name(TableConnectorUtils.generateRuntimeName(this.getClass(), getFðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +        DataStreamSink&lt;Row&gt; dataStreamSink = ds.addSink(kafkaProducer010).name(sinkOperatorName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +        return dataStreamSink;</span>
 144      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +</span>
 146  
 147      @Override
 148      public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {
<abbr title=" 149          return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 149          return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNameðŸ”µ</abbr>
 150      }
 151  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -    public String[] getFieldNames() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -        return fieldNames;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -    }</span>
 156  
 157      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -    public TypeInformation&lt;?&gt;[] getFieldTypes() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -        return fieldTypes;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +    public TableSchema getTableSchema() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +        return schema;</span>
 162      }
 163  
 164      @Override
 165      public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {
 166          this.fieldNames = fieldNames;
 167          this.fieldTypes = fieldTypes;
 168          return this;
 169      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -    private String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -        if(StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +    private String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +        if (StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())) {</span>
 175              return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);
 176          }
 177          return null;
 178      }
 179  
 180  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.sink.kafka;
  20  
  21  import com.dtstack.flink.sql.sink.IStreamSinkGener;
  22  import com.dtstack.flink.sql.sink.kafka.table.KafkaSinkTableInfo;
  23  import com.dtstack.flink.sql.table.AbstractTargetTableInfo;
  24  import org.apache.commons.lang3.StringUtils;
  25  import org.apache.flink.api.common.typeinfo.TypeInformation;
  26  import org.apache.flink.api.java.tuple.Tuple2;
  27  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  28  import org.apache.flink.api.java.typeutils.TupleTypeInfo;
  29  import org.apache.flink.streaming.api.datastream.DataStream;
  30  import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;


  31  import org.apache.flink.table.api.TableSchema;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.apache.flink.table.runtime.types.CRowTypeInfo;</span>
  34  import org.apache.flink.table.sinks.RetractStreamTableSink;
  35  import org.apache.flink.table.sinks.TableSink;
  36  import org.apache.flink.table.utils.TableConnectorUtils;
  37  import org.apache.flink.types.Row;
  38  
  39  import java.util.Optional;
  40  import java.util.Properties;

  41  /**
  42   *
  43   * Date: 2018/12/18
  44   * Company: www.dtstack.com
  45   *
  46   * @author DocLi
  47   *
  48   * @modifyer maqi
  49   *
  50   */
  51  public class KafkaSink implements RetractStreamTableSink&lt;Row&gt;, IStreamSinkGener&lt;KafkaSink&gt; {
  52  
  53  

  54      protected String[] fieldNames;
  55  
  56      protected TypeInformation&lt;?&gt;[] fieldTypes;
  57  
  58      protected String topic;
  59  
  60      protected Properties properties;
  61  
  62      protected int parallelism;
  63  
  64      protected  KafkaSinkTableInfo kafka10SinkTableInfo;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +    protected RichSinkFunction&lt;CRow&gt; kafkaProducer010;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +    protected CRowTypeInfo typeInformation;</span>
  68  
  69      /** The schema of the table. */
  70      private TableSchema schema;

  71  
  72      private String[] partitionKeys;




  73  
  74      @Override
  75      public KafkaSink genStreamSink(AbstractTargetTableInfo targetTableInfo) {
  76          this.kafka10SinkTableInfo = (KafkaSinkTableInfo) targetTableInfo;
  77          this.topic = kafka10SinkTableInfo.getTopic();
  78  
  79          properties = new Properties();
  80          properties.setProperty(&quot;bootstrap.servers&quot;, kafka10SinkTableInfo.getBootstrapServers());
  81  
  82          for (String key : kafka10SinkTableInfo.getKafkaParamKeys()) {
  83              properties.setProperty(key, kafka10SinkTableInfo.getKafkaParam(key));
  84          }
  85  
  86          this.partitionKeys = getPartitionKeys(kafka10SinkTableInfo);
  87          this.fieldNames = kafka10SinkTableInfo.getFields();
  88          TypeInformation[] types = new TypeInformation[kafka10SinkTableInfo.getFields().length];
  89          for (int i = 0; i &lt; kafka10SinkTableInfo.getFieldClasses().length; i++) {
  90              types[i] = TypeInformation.of(kafka10SinkTableInfo.getFieldClasses()[i]);
  91          }
  92          this.fieldTypes = types;
  93  
  94  
  95          TableSchema.Builder schemaBuilder = TableSchema.builder();
  96          for (int i=0;i&lt;fieldNames.length;i++){

  97              schemaBuilder.field(fieldNames[i], fieldTypes[i]);
  98          }
  99          this.schema = schemaBuilder.build();
 100  
 101          Integer parallelism = kafka10SinkTableInfo.getParallelism();
 102          if (parallelism != null) {
 103              this.parallelism = parallelism;
 104          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +        typeInformation = new CRowTypeInfo(new RowTypeInfo(fieldTypes, fieldNames));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +        kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +                typeInformation, properties,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +                Optional.of(new CustomerFlinkPartition&lt;&gt;()), partitionKeys);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +</span>
 111          return this;
 112      }
 113  
 114      @Override
 115      public TypeInformation&lt;Row&gt; getRecordType() {
 116          return new RowTypeInfo(fieldTypes, fieldNames);
 117      }
 118  
 119      @Override
 120      public void emitDataStream(DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; dataStream) {


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 122 -        RichSinkFunction&lt;Row&gt; kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTableInfo, getOutputType().getTypeAt(1), properties,"> 122 -        RichSinkFunction&lt;Row&gt; kafkaProducer010 = new KafkaProducer010Factory().createKafkaProducer(kafka10SinkTablðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -                Optional.of(new CustomerFlinkPartition&lt;&gt;()), partitionKeys);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        DataStream&lt;Row&gt; mapDataStream = dataStream.filter((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f0)</span>




<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -                .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; record.f1)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -                .returns(getOutputType().getTypeAt(1))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +        DataStream&lt;CRow&gt; mapDataStream = dataStream</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +                .map((Tuple2&lt;Boolean, Row&gt; record) -&gt; new CRow(record.f1, record.f0))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +                .returns(typeInformation)</span>
 131                  .setParallelism(parallelism);
 132  
<abbr title=" 133          mapDataStream.addSink(kafkaProducer010).name(TableConnectorUtils.generateRuntimeName(this.getClass(), getFieldNames()));"> 133          mapDataStream.addSink(kafkaProducer010).name(TableConnectorUtils.generateRuntimeName(this.getClass(), getFðŸ”µ</abbr>


 134      }

 135  
 136      @Override
 137      public TupleTypeInfo&lt;Tuple2&lt;Boolean, Row&gt;&gt; getOutputType() {
<abbr title=" 138          return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNames));"> 138          return new TupleTypeInfo(org.apache.flink.table.api.Types.BOOLEAN(), new RowTypeInfo(fieldTypes, fieldNameðŸ”µ</abbr>
 139      }
 140  
 141      @Override
 142      public String[] getFieldNames() {
 143          return fieldNames;
 144      }
 145  
 146      @Override
 147      public TypeInformation&lt;?&gt;[] getFieldTypes() {
 148          return fieldTypes;


 149      }
 150  
 151      @Override
 152      public TableSink&lt;Tuple2&lt;Boolean, Row&gt;&gt; configure(String[] fieldNames, TypeInformation&lt;?&gt;[] fieldTypes) {
 153          this.fieldNames = fieldNames;
 154          this.fieldTypes = fieldTypes;
 155          return this;
 156      }
 157      private String[] getPartitionKeys(KafkaSinkTableInfo kafkaSinkTableInfo){
 158          if(StringUtils.isNotBlank(kafkaSinkTableInfo.getPartitionKeys())){



 159              return StringUtils.split(kafkaSinkTableInfo.getPartitionKeys(), &#x27;,&#x27;);
 160          }
 161          return null;
 162      }
 163  
 164  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            