<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>172</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    172
                    <a href="171.html">prev</a>
                    <a href="173.html">next</a>
                    <a href="172_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_8b2b1cfc2b94b8ca25fb780bb6d7e9463f4c0ffc_Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;8b2b1cfc2b94b8ca25fb780bb6d7e9463f4c0ffc:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;8b2b1cfc2b94b8ca25fb780bb6d7e9463f4c0ffc^1:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;8b2b1cfc2b94b8ca25fb780bb6d7e9463f4c0ffc^2:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;448dcf036249b943a729aa9c18b62998b9620bfa:Simplenote/src/main/java/com/automattic/simplenote/NotesActivity.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.annotation.SuppressLint;
   4 import android.app.Activity;
   5 import android.app.AlertDialog;
   6 import android.content.DialogInterface;
   7 import android.content.Intent;
   8 import android.content.SharedPreferences;
   9 import android.content.res.Configuration;
  10 import android.os.AsyncTask;
  11 import android.os.Build;
  12 import android.os.Bundle;
  13 import android.os.Handler;
  14 import android.support.design.widget.NavigationView;
  15 import android.support.v4.app.FragmentManager;
  16 import android.support.v4.app.FragmentTransaction;
  17 import android.support.v4.content.ContextCompat;
  18 import android.support.v4.view.GravityCompat;
  19 import android.support.v4.widget.DrawerLayout;
  20 import android.support.v7.app.ActionBar;
  21 import android.support.v7.app.ActionBarDrawerToggle;
  22 import android.support.v7.app.AppCompatActivity;
  23 import android.support.v7.preference.PreferenceManager;
  24 import android.support.v7.widget.SearchView;
  25 import android.support.v7.widget.Toolbar;
  26 import android.text.Spannable;
  27 import android.text.SpannableString;
  28 import android.text.TextUtils;
  29 import android.view.Menu;
  30 import android.view.MenuInflater;
  31 import android.view.MenuItem;
  32 import android.view.View;
  33 import android.view.WindowInsets;
  34 import android.view.WindowManager;
  35 import android.widget.AdapterView;
  36 import android.widget.LinearLayout;
  37 import android.widget.ListView;
  38 import android.widget.ProgressBar;
  39 
  40 import com.automattic.simplenote.analytics.AnalyticsTracker;
  41 import com.automattic.simplenote.models.Note;
  42 import com.automattic.simplenote.models.Tag;
  43 import com.automattic.simplenote.utils.DisplayUtils;
  44 import com.automattic.simplenote.utils.DrawableUtils;
  45 import com.automattic.simplenote.utils.HtmlCompat;
  46 import com.automattic.simplenote.utils.PrefUtils;
  47 import com.automattic.simplenote.utils.StrUtils;
  48 import com.automattic.simplenote.utils.TagsAdapter;
  49 import com.automattic.simplenote.utils.ThemeUtils;
  50 import com.automattic.simplenote.utils.UndoBarController;
  51 import com.automattic.simplenote.widgets.TypefaceSpan;
  52 import com.simperium.Simperium;
  53 import com.simperium.client.Bucket;
  54 import com.simperium.client.BucketObjectMissingException;
  55 import com.simperium.client.BucketObjectNameInvalid;
  56 import com.simperium.client.Query;
  57 import com.simperium.client.User;
  58 
  59 import org.wordpress.passcodelock.AppLockManager;
  60 
  61 import java.util.ArrayList;
  62 import java.util.Calendar;
  63 import java.util.List;
  64 
  65 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  66 
  67 public class NotesActivity extends AppCompatActivity implements
<abbr title="  68         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  68         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  69         Bucket.Listener&lt;Note&gt; {
  70 
  71     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  72     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  73     protected Bucket&lt;Note&gt; mNotesBucket;
  74     protected Bucket&lt;Tag&gt; mTagsBucket;
  75     private int TRASH_SELECTED_ID = 1;
  76     private boolean mIsShowingMarkdown;
  77     private boolean mShouldSelectNewNote;
  78 
  79     private String mTabletSearchQuery;
  80     private UndoBarController mUndoBarController;
  81     private View mFragmentsContainer;
  82     private SearchView mSearchView;
  83     private MenuItem mSearchMenuItem;
  84     private NoteListFragment mNoteListFragment;
  85     private NoteEditorFragment mNoteEditorFragment;
  86     private Note mCurrentNote;
  87     private MenuItem mEmptyTrashMenuItem;
  88 
  89     // Menu drawer
  90     private DrawerLayout mDrawerLayout;
  91     private ListView mDrawerList;
  92     private NavigationView mNavigationView;
  93     private ActionBarDrawerToggle mDrawerToggle;
  94     private TagsAdapter mTagsAdapter;
  95     private TagsAdapter.TagMenuItem mSelectedTag;
  96     // Tags bucket listener
  97     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
  98         void updateNavigationDrawer() {
  99             runOnUiThread(new Runnable() {
 100                 public void run() {
 101                     updateNavigationDrawerItems();
 102                 }
 103             });
 104         }
 105 
 106         @Override
 107         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 108             updateNavigationDrawer();
 109         }
 110 
 111         @Override
 112         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 113             updateNavigationDrawer();
 114         }
 115 
 116         @Override
 117         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 118             updateNavigationDrawer();
 119         }
 120 
 121         @Override
 122         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 123             // noop
 124         }
 125     };
 126 
 127     @Override
 128     protected void onCreate(Bundle savedInstanceState) {
 129         // On lollipop, configure the translucent status bar
 130         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 131             getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
 132 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133             getWindow().setStatusBarColor(ContextCompat.getColor(this, android.R.color.transparent));</span>
 134 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138         ThemeUtils.setTheme(this);</span>
 139 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 140             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.translucent_grey_medium_light));"> 140             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.translucent_grey_medium_liðŸ”µ</abbr></span>
 141 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 142         }
 143 
 144         ThemeUtils.setTheme(this);
 145         super.onCreate(savedInstanceState);
 146 
 147         setContentView(R.layout.activity_notes);
 148 
 149         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 150 
 151         Simplenote currentApp = (Simplenote) getApplication();
 152         if (mNotesBucket == null) {
 153             mNotesBucket = currentApp.getNotesBucket();
 154         }
 155 
 156         if (mTagsBucket == null) {
 157             mTagsBucket = currentApp.getTagsBucket();
 158         }
 159 
 160         Toolbar toolbar = findViewById(R.id.toolbar);
 161         setSupportActionBar(toolbar);
 162         configureNavigationDrawer(toolbar);
 163 
 164         if (savedInstanceState == null) {
 165             mNoteListFragment = new NoteListFragment();
 166             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 167             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 168             fragmentTransaction.commit();
 169         } else {
<abbr title=" 170             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 170             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 171         }
 172 
 173         if (DisplayUtils.isLargeScreen(this)) {
 174             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 175                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 175                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 176             } else if (DisplayUtils.isLandscape(this)) {
 177                 addEditorFragment();
 178             }
 179         }
 180 
 181         // enable ActionBar app icon to behave as action to toggle nav drawer
 182         ActionBar actionBar = getSupportActionBar();
 183         if (actionBar != null) {
 184             actionBar.setDisplayHomeAsUpEnabled(true);
 185             actionBar.setHomeButtonEnabled(true);
 186 
 187             // Add loading indicator to show when indexing
<abbr title=" 188             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 188             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 189             actionBar.setDisplayShowCustomEnabled(true);
 190             actionBar.setCustomView(progressBar);
 191             setToolbarProgressVisibility(false);
 192         }
 193 
 194         mUndoBarController = new UndoBarController(this);
 195 
 196         // Creates &#x27;Welcome&#x27; note
 197         checkForFirstLaunch();
 198 
 199         checkForSharedContent();
 200 
 201         currentApp.getSimperium().setOnUserCreatedListener(this);
 202         currentApp.getSimperium().setUserStatusChangeListener(this);
 203     }
 204 
 205     @Override
 206     protected void onResume() {
 207         super.onResume();
 208 
 209         // Ensure user has valid authorization
 210         if (userAuthenticationIsInvalid()) {
 211             startLoginActivity(true);
 212         }
 213 
 214         disableScreenshotsIfLocked(this);
 215 
 216         mNotesBucket.start();
 217         mTagsBucket.start();
 218 
 219         mNotesBucket.addOnNetworkChangeListener(this);
 220         mNotesBucket.addOnSaveObjectListener(this);
 221         mNotesBucket.addOnDeleteObjectListener(this);
 222         mTagsBucket.addListener(mTagsMenuUpdater);
 223 
 224         updateNavigationDrawerItems();
 225 
 226         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 227         if (userIsUnauthorized()) {
 228             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 229                 mSelectedTag = null;
 230                 mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 231             }
 232         }
 233 
 234         setSelectedTagActive();
 235 
 236         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 237             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 238             mShouldSelectNewNote = false;
 239         }
 240 
 241         if (mIsShowingMarkdown) {
 242             setMarkdownShowing(false);
 243         }
 244 
 245     }
 246 
 247     @Override
 248     protected void onPause() {
 249         super.onPause();  // Always call the superclass method first
 250         mTagsBucket.removeListener(mTagsMenuUpdater);
 251         mTagsBucket.stop();
 252 
 253         mNotesBucket.removeOnNetworkChangeListener(this);
 254         mNotesBucket.removeOnSaveObjectListener(this);
 255         mNotesBucket.removeOnDeleteObjectListener(this);
 256         mNotesBucket.stop();
 257     }
 258 
 259     @Override
 260     public void setTitle(CharSequence title) {
 261         if (title == null) {
 262             title = &quot;&quot;;
 263         }
 264 
 265         setTitleWithCustomFont(title);
 266     }
 267 
 268     @Override
 269     public void onBackPressed() {
 270         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 271             mDrawerLayout.closeDrawer(GravityCompat.START);
 272         } else {
 273             super.onBackPressed();
 274         }
 275     }
 276 
 277     private void setTitleWithCustomFont(CharSequence title) {
 278         if (getSupportActionBar() == null) return;
 279 
 280         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 281         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 282                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 283             getSupportActionBar().setTitle(title);
 284             return;
 285         }
 286 
 287         SpannableString s = new SpannableString(title);
 288         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 289         getSupportActionBar().setTitle(s);
 290     }
 291 
 292     private void configureNavigationDrawer(Toolbar toolbar) {
 293         mDrawerLayout = findViewById(R.id.drawer_layout);
 294         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 295         mNavigationView = findViewById(R.id.navigation_view);
 296         mDrawerList = findViewById(R.id.drawer_list);
 297 
 298         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 299             mNavigationView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {
 300                 @Override
 301                 @SuppressLint(&quot;NewApi&quot;)
 302                 public WindowInsets onApplyWindowInsets(View view, WindowInsets windowInsets) {
 303                     LinearLayout drawerView = findViewById(R.id.drawer_view);
 304                     drawerView.setPadding(
 305                             drawerView.getPaddingLeft(),
 306                             windowInsets.getSystemWindowInsetTop(),
 307                             drawerView.getPaddingRight(),
 308                             drawerView.getPaddingBottom());
 309 
 310                     return windowInsets.consumeSystemWindowInsets();
 311                 }
 312             });
 313         }
 314 
 315         View settingsButton = findViewById(R.id.nav_settings);
 316         settingsButton.setOnClickListener(new View.OnClickListener() {
 317             @Override
 318             public void onClick(View v) {
 319                 Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 320                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 321             }
 322         });
 323 
 324         mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 325         mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 326         mDrawerList.setAdapter(mTagsAdapter);
 327         // Set the list&#x27;s click listener
 328         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 329 
 330         if (mSelectedTag == null)
 331             mSelectedTag = mTagsAdapter.getDefaultItem();
 332 
 333         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 334                 R.string.close_drawer) {
 335             public void onDrawerClosed(View view) {
 336                 supportInvalidateOptionsMenu();
 337             }
 338 
 339             public void onDrawerOpened(View drawerView) {
 340                 // noop
 341             }
 342 
 343             @Override
 344             public void onDrawerSlide(View drawerView, float slideOffset) {
 345                 super.onDrawerSlide(drawerView, 0f);
 346             }
 347         };
 348 
 349         mDrawerLayout.addDrawerListener(mDrawerToggle);
 350     }
 351 
 352     private void checkForFirstLaunch() {
 353         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 354             // Create the welcome note
 355             try {
 356                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 357                 welcomeNote.setCreationDate(Calendar.getInstance());
 358                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 359                 welcomeNote.setContent(getString(R.string.welcome_note));
 360                 welcomeNote.getTitle();
 361                 welcomeNote.save();
 362             } catch (BucketObjectNameInvalid e) {
 363                 // this won&#x27;t happen because welcome-android is a valid name
 364             }
 365 
 366             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 367             SharedPreferences.Editor editor = preferences.edit();
 368             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 369             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 370             editor.apply();
 371         }
 372     }
 373 
 374     private void checkForSharedContent() {
 375         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 376             // Check share action
 377             Intent intent = getIntent();
 378             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 379             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 380 
<abbr title=" 381             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 381             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 382             String intentAction = StrUtils.notNullStr(intent.getAction());
 383             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 384             if (!TextUtils.isEmpty(text)) {
 385                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 386                     text = subject + &quot;\n\n&quot; + text;
 387                 }
 388                 Note note = mNotesBucket.newObject();
 389                 note.setCreationDate(Calendar.getInstance());
 390                 note.setModificationDate(note.getCreationDate());
 391                 note.setContent(text);
 392                 note.save();
 393                 setCurrentNote(note);
 394                 mShouldSelectNewNote = true;
 395 
 396                 AnalyticsTracker.track(
 397                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 398                         AnalyticsTracker.CATEGORY_NOTE,
 399                         &quot;external_share&quot;
 400                 );
 401 
 402                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 403                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 404                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 405                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 406                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 407                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 408                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 409                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 410                     }
 411                 }
 412             }
 413         }
 414     }
 415 
 416     private void updateNavigationDrawerItems() {
 417         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 418         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 419         if (isAlphaSort) {
 420             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 421         } else {
 422             tagCursor = Tag.allWithName(mTagsBucket).execute();
 423         }
 424 
 425         mTagsAdapter.changeCursor(tagCursor);
 426     }
 427 
 428     private void setSelectedTagActive() {
 429         if (mSelectedTag == null)
 430             mSelectedTag = mTagsAdapter.getDefaultItem();
 431 
 432         setTitle(mSelectedTag.name);
<abbr title=" 433         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 433         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCouðŸ”µ</abbr>
 434     }
 435 
 436     public TagsAdapter.TagMenuItem getSelectedTag() {
 437         if (mSelectedTag == null) {
 438             mSelectedTag = mTagsAdapter.getDefaultItem();
 439         }
 440 
 441         return mSelectedTag;
 442     }
 443 
 444     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 445     public void updateTrashMenuItem() {
 446         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 447             return;
 448 
 449         // Disable the trash icon if there are no notes trashed.
 450         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 451         if (query.count() == 0) {
 452             mEmptyTrashMenuItem.setEnabled(false);
 453         } else {
 454             mEmptyTrashMenuItem.setEnabled(true);
 455         }
 456     }
 457 
 458     private void addEditorFragment() {
 459         FragmentManager fm = getSupportFragmentManager();
 460         FragmentTransaction ft = fm.beginTransaction();
 461         mNoteEditorFragment = new NoteEditorFragment();
 462         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 463         ft.commitAllowingStateLoss();
 464         fm.executePendingTransactions();
 465     }
 466 
 467     private boolean userAccountRequired() {
 468         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 469     }
 470 
 471     /**
 472      * Checks for a previously valid user that is now not authenticated
 473      * Also checks if user account is required (added in version 1.5.6)
 474      *
 475      * @return true if user has invalid authorization
 476      */
 477     private boolean userAuthenticationIsInvalid() {
 478         Simplenote currentApp = (Simplenote) getApplication();
 479         Simperium simperium = currentApp.getSimperium();
 480         User user = simperium.getUser();
 481         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 482         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 483                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 484     }
 485 
 486     public boolean userIsUnauthorized() {
 487         Simplenote currentApp = (Simplenote) getApplication();
 488         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 489     }
 490 
 491     public void setCurrentNote(Note note) {
 492         mCurrentNote = note;
 493     }
 494 
 495     public NoteListFragment getNoteListFragment() {
 496         return mNoteListFragment;
 497     }
 498 
 499     @SuppressWarnings(&quot;ResourceType&quot;)
 500     @Override
 501     public boolean onCreateOptionsMenu(Menu menu) {
 502         super.onCreateOptionsMenu(menu);
 503         MenuInflater inflater = getMenuInflater();
 504         inflater.inflate(R.menu.notes_list, menu);
 505 
 506         // restore the search query if on a landscape tablet
 507         String searchQuery = null;
 508         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 509             searchQuery = mSearchView.getQuery().toString();
 510 
 511         mSearchMenuItem = menu.findItem(R.id.menu_search);
 512         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 513 
 514         if (!TextUtils.isEmpty(searchQuery)) {
 515             mSearchView.setQuery(searchQuery, false);
 516             mSearchMenuItem.expandActionView();
 517         } else {
 518             // Workaround for setting the search placeholder text color
 519             String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 520                     getString(R.color.gray_light) :
 521                     getString(R.color.text_preview)).replace(&quot;ff&quot;, &quot;&quot;);
 522             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 523                     hintHexColor,
 524                     getString(R.string.search))));
 525         }
 526 
 527         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 528             @Override
 529             public boolean onQueryTextChange(String newText) {
 530                 if (mSearchMenuItem.isActionViewExpanded()) {
 531                     getNoteListFragment().searchNotes(newText);
 532                 }
 533                 return true;
 534             }
 535 
 536             @Override
 537             public boolean onQueryTextSubmit(String queryText) {
 538                 getNoteListFragment().searchNotes(queryText);
 539                 return true;
 540             }
 541 
 542         });
 543 
 544         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 545             @Override
 546             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 547                 checkEmptyListText(true);
 548                 if (mNoteListFragment != null) {
 549                     mNoteListFragment.setFloatingActionButtonVisible(false);
 550                 }
 551                 AnalyticsTracker.track(
 552                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 553                         AnalyticsTracker.CATEGORY_NOTE,
 554                         &quot;action_bar_search_tap&quot;
 555                 );
 556                 return true;
 557             }
 558 
 559             @Override
 560             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 561                 // Show all notes again
 562                 if (mNoteListFragment != null) {
 563                     mNoteListFragment.setFloatingActionButtonVisible(true);
 564                 }
 565                 mTabletSearchQuery = &quot;&quot;;
 566                 mSearchView.setQuery(&quot;&quot;, false);
 567                 checkEmptyListText(false);
 568                 getNoteListFragment().clearSearch();
 569                 return true;
 570             }
 571         });
 572 
 573         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 574             @Override
 575             public boolean onMenuItemClick(MenuItem item) {
 576                 if (!mSearchMenuItem.isActionViewExpanded())
 577                     showDetailPlaceholder();
 578                 return false;
 579             }
 580         });
 581 
 582         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 583         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 584             trashItem.setTitle(R.string.undelete);
 585             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 586         } else {
 587             trashItem.setTitle(R.string.delete);
 588             trashItem.setIcon(R.drawable.ic_trash_24dp);
 589         }
 590 
 591         if (DisplayUtils.isLargeScreenLandscape(this)) {
 592             // Restore the search query on landscape tablets
 593             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 594                 mSearchMenuItem.expandActionView();
 595                 mSearchView.setQuery(mTabletSearchQuery, false);
 596                 mSearchView.clearFocus();
 597             }
 598 
 599             if (mCurrentNote != null) {
 600                 menu.findItem(R.id.menu_share).setVisible(true);
 601                 menu.findItem(R.id.menu_view_info).setVisible(true);
 602                 menu.findItem(R.id.menu_checklist).setVisible(true);
 603                 menu.findItem(R.id.menu_history).setVisible(true);
 604                 menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 605                 trashItem.setVisible(true);
 606             } else {
 607                 menu.findItem(R.id.menu_share).setVisible(false);
 608                 menu.findItem(R.id.menu_view_info).setVisible(false);
 609                 menu.findItem(R.id.menu_checklist).setVisible(false);
 610                 menu.findItem(R.id.menu_history).setVisible(false);
 611                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 612                 trashItem.setVisible(false);
 613             }
 614             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 615         } else {
 616             menu.findItem(R.id.menu_search).setVisible(true);
 617             menu.findItem(R.id.menu_share).setVisible(false);
 618             menu.findItem(R.id.menu_view_info).setVisible(false);
 619             menu.findItem(R.id.menu_checklist).setVisible(false);
 620             menu.findItem(R.id.menu_history).setVisible(false);
 621             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 622             trashItem.setVisible(false);
 623             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 624         }
 625 
 626         // Are we looking at the trash? Adjust menu accordingly.
 627         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 628             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 629             mEmptyTrashMenuItem.setVisible(true);
 630 
 631             updateTrashMenuItem();
 632 
 633             menu.findItem(R.id.menu_search).setVisible(false);
 634             menu.findItem(R.id.menu_share).setVisible(false);
 635             menu.findItem(R.id.menu_history).setVisible(false);
 636             menu.findItem(R.id.menu_checklist).setVisible(false);
 637         }
 638 
 639         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 640 
 641         return true;
 642     }
 643 
 644     @Override
 645     public boolean onOptionsItemSelected(MenuItem item) {
 646         if (mDrawerToggle.onOptionsItemSelected(item)) {
 647             return true;
 648         }
 649         switch (item.getItemId()) {
 650             case R.id.menu_markdown_preview:
 651                 if (mIsShowingMarkdown) {
 652                     item.setIcon(R.drawable.ic_preview_24dp);
 653                     item.setTitle(getString(R.string.markdown_show));
 654                     setMarkdownShowing(false);
 655                 } else {
 656                     item.setIcon(R.drawable.ic_preview_stop_24dp);
 657                     item.setTitle(getString(R.string.markdown_hide));
 658                     setMarkdownShowing(true);
 659                 }
 660 
 661                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 662 
 663                 return true;
 664             case R.id.menu_delete:
 665                 if (mNoteEditorFragment != null) {
 666                     if (mCurrentNote != null) {
 667                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 668                         mCurrentNote.setModificationDate(Calendar.getInstance());
 669                         mCurrentNote.save();
 670 
 671                         updateViewsAfterTrashAction(mCurrentNote);
 672                     }
 673                 }
 674                 return true;
 675             case R.id.menu_empty_trash:
 676                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 677 
 678                 alert.setTitle(R.string.empty_trash);
 679                 alert.setMessage(R.string.confirm_empty_trash);
 680                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 681                     public void onClick(DialogInterface dialog, int whichButton) {
 682                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 683                         AnalyticsTracker.track(
 684                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 685                                 AnalyticsTracker.CATEGORY_NOTE,
 686                                 &quot;overflow_menu&quot;
 687                         );
 688                     }
 689                 });
 690                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 691                     public void onClick(DialogInterface dialog, int whichButton) {
 692                         // Do nothing, just closing the dialog
 693                     }
 694                 });
 695                 alert.show();
 696                 return true;
 697             case android.R.id.home:
 698                 invalidateOptionsMenu();
 699                 return true;
 700             default:
 701                 return super.onOptionsItemSelected(item);
 702         }
 703     }
 704 
 705     @Override
 706     public boolean onPrepareOptionsMenu(Menu menu) {
 707         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 708 
 709         if (mIsShowingMarkdown) {
 710             markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 711             markdownItem.setTitle(getString(R.string.markdown_hide));
 712         } else {
 713             markdownItem.setIcon(R.drawable.ic_preview_24dp);
 714             markdownItem.setTitle(getString(R.string.markdown_show));
 715         }
 716 
 717         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 718 
 719         return super.onPrepareOptionsMenu(menu);
 720     }
 721 
 722     public void updateViewsAfterTrashAction(Note note) {
 723         if (note == null || isFinishing()) {
 724             return;
 725         }
 726 
 727         if (note.isDeleted()) {
 728             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 729             deletedNoteIds.add(note.getSimperiumKey());
 730             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 731             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 732             AnalyticsTracker.track(
 733                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 734                     AnalyticsTracker.CATEGORY_NOTE,
 735                     &quot;overflow_menu&quot;
 736             );
 737         } else {
 738             AnalyticsTracker.track(
 739                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 740                     AnalyticsTracker.CATEGORY_NOTE,
 741                     &quot;overflow_menu&quot;
 742             );
 743         }
 744 
 745         // If we just deleted/restored the active note, show the placeholder
 746         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 747             showDetailPlaceholder();
 748         }
 749 
 750         NoteListFragment fragment = getNoteListFragment();
 751         if (fragment != null) {
 752             fragment.getPrefs();
 753             fragment.refreshList();
 754         }
 755 
 756         invalidateOptionsMenu();
 757     }
 758 
 759     public void setMarkdownShowing(boolean isMarkdownShowing) {
 760         mIsShowingMarkdown = isMarkdownShowing;
 761         if (mNoteEditorFragment != null) {
 762             if (isMarkdownShowing) {
 763                 mNoteEditorFragment.showMarkdown();
 764             } else {
 765                 mNoteEditorFragment.hideMarkdown();
 766             }
 767         }
 768         invalidateOptionsMenu();
 769     }
 770 
 771     /**
 772      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 773      * the item with the given ID was selected. Used for tablets only.
 774      */
 775     @Override
<abbr title=" 776     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {"> 776     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 777         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 778             // Launch the editor activity
 779             Bundle arguments = new Bundle();
 780             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 781             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 782 
 783             if (matchOffsets != null)
 784                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 785 
 786             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 787             editNoteIntent.putExtras(arguments);
 788             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 789         } else {
 790             mNoteEditorFragment.setNote(noteID, matchOffsets);
 791             getNoteListFragment().setNoteSelected(noteID);
 792 
 793             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 794                 mTabletSearchQuery = mSearchView.getQuery().toString();
 795             }
 796 
 797             mNoteEditorFragment.clearMarkdown();
 798 
 799             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 800                 setMarkdownShowing(false);
 801             }
 802 
 803             invalidateOptionsMenu();
 804         }
 805 
 806         AnalyticsTracker.track(
 807                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 808                 AnalyticsTracker.CATEGORY_NOTE,
 809                 &quot;note_list_row_tap&quot;
 810         );
 811     }
 812 
 813     @Override
 814     public void onUserCreated(User user) {
 815         // New account created
 816         AnalyticsTracker.track(
 817                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 818                 AnalyticsTracker.CATEGORY_USER,
 819                 &quot;account_created_from_login_activity&quot;
 820         );
 821     }
 822 
 823     public void onUserStatusChange(User.Status status) {
 824         switch (status) {
 825             // successfully used access token to connect to simperium bucket
 826             case AUTHORIZED:
 827                 runOnUiThread(new Runnable() {
 828                     @Override
 829                     public void run() {
 830                         if (!mNotesBucket.hasChangeVersion()) {
 831                             setToolbarProgressVisibility(true);
 832                         }
 833                     }
 834                 });
 835                 break;
 836 
 837             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 838             case NOT_AUTHORIZED:
 839                 runOnUiThread(new Runnable() {
 840                     @Override
 841                     public void run() {
 842                         startLoginActivity(true);
 843                     }
 844                 });
 845                 break;
 846 
<abbr title=" 847             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 847             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 848             case UNKNOWN:
 849                 break;
 850         }
 851     }
 852 
 853     private void setToolbarProgressVisibility(boolean isVisible) {
 854         if (getSupportActionBar() != null) {
 855             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 856         }
 857     }
 858 
 859     public void startLoginActivity(boolean signInFirst) {
 860         // Clear some account-specific prefs
 861         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 862         editor.remove(PrefUtils.PREF_WP_TOKEN);
 863         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 864         editor.apply();
 865 
 866         Intent loginIntent = new Intent(this, SignInActivity.class);
 867         if (signInFirst) {
 868             loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 869         }
 870         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 871     }
 872 
 873     @Override
 874     public void recreate() {
 875         Handler handler = new Handler();
 876         handler.post(new Runnable() {
 877             @Override
 878             public void run() {
 879                 NotesActivity.super.recreate();
 880             }
 881         });
 882     }
 883 
 884     @Override
 885     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 886         super.onActivityResult(requestCode, resultCode, data);
 887         switch (requestCode) {
 888             case Simplenote.INTENT_PREFERENCES:
 889                 if (ThemeUtils.themeWasChanged(data)) {
 890                     // Restart this activity to apply the new theme
 891                     recreate();
 892                     break;
 893                 }
<abbr title=" 894                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 894                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 895                 invalidateOptionsMenu();
 896                 NoteListFragment fragment = getNoteListFragment();
 897                 if (fragment != null) {
 898                     fragment.getPrefs();
 899                     fragment.refreshList();
 900                 }
 901 
 902                 break;
 903             case Simplenote.INTENT_EDIT_NOTE:
 904                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
 905                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 906                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 907                         if (noteId != null) {
 908                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 909                             deletedNoteIds.add(noteId);
 910                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 911                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));"> 911                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
 912                         }
<abbr title=" 913                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 913                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
 914                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 915                         mNoteListFragment.setNoteSelected(selectedNoteId);
 916                         if (mNoteEditorFragment != null) {
 917                             mNoteEditorFragment.setNote(selectedNoteId);
 918                         }
 919                     }
 920                 }
 921                 break;
 922             case Simperium.SIGNUP_SIGNIN_REQUEST:
 923                 invalidateOptionsMenu();
 924 
 925                 Simplenote app = (Simplenote) getApplication();
 926                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 927 
 928                 AnalyticsTracker.track(
 929                         AnalyticsTracker.Stat.USER_SIGNED_IN,
 930                         AnalyticsTracker.CATEGORY_USER,
 931                         &quot;signed_in_from_login_activity&quot;
 932                 );
 933 
 934                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 935                     finish();
 936                 }
 937 
 938                 break;
 939         }
 940     }
 941 
 942     @Override
 943     public void onUndo() {
 944         if (mUndoBarController == null) return;
 945 
 946         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 947         if (deletedNoteIds != null) {
 948             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 949                 Note deletedNote;
 950                 try {
 951                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 952                 } catch (BucketObjectMissingException e) {
 953                     return;
 954                 }
 955                 if (deletedNote != null) {
 956                     deletedNote.setDeleted(false);
 957                     deletedNote.setModificationDate(Calendar.getInstance());
 958                     deletedNote.save();
 959                     NoteListFragment fragment = getNoteListFragment();
 960                     if (fragment != null) {
 961                         fragment.getPrefs();
 962                         fragment.refreshList();
 963                     }
 964                 }
 965             }
 966         }
 967     }
 968 
 969     @Override
 970     protected void onPostCreate(Bundle savedInstanceState) {
 971         super.onPostCreate(savedInstanceState);
 972         // Sync the toggle state after onRestoreInstanceState has occurred.
 973         mDrawerToggle.syncState();
 974     }
 975 
 976     @Override
 977     public void onConfigurationChanged(Configuration newConfig) {
 978         super.onConfigurationChanged(newConfig);
 979 
 980         mDrawerToggle.onConfigurationChanged(newConfig);
 981 
 982         if (DisplayUtils.isLargeScreen(this)) {
 983             mIsShowingMarkdown = false;
 984 
 985             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 986                 // Add the editor fragment
 987                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 988                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 988                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
 989                 } else if (DisplayUtils.isLandscape(this)) {
 990                     addEditorFragment();
 991                 }
 992                 if (mNoteListFragment != null) {
 993                     mNoteListFragment.setActivateOnItemClick(true);
 994                     mNoteListFragment.setDividerVisible(true);
 995                 }
 996                 // Select the current note on a tablet
 997                 if (mCurrentNote != null)
<abbr title=" 998                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());"> 998                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
 999                 else {
1000                     mNoteEditorFragment.setPlaceholderVisible(true);
1001                     mNoteListFragment.getListView().clearChoices();
1002                 }
1003                 invalidateOptionsMenu();
1004             }
1005         }
1006 
1007         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1008             // Remove the editor fragment when rotating back to portrait
1009             mCurrentNote = null;
1010             if (mNoteListFragment != null) {
1011                 mNoteListFragment.setActivateOnItemClick(false);
1012                 mNoteListFragment.setDividerVisible(false);
1013                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1014                 mNoteListFragment.refreshList();
1015             }
1016             FragmentManager fm = getSupportFragmentManager();
1017             FragmentTransaction ft = fm.beginTransaction();
1018             ft.remove(mNoteEditorFragment);
1019             mNoteEditorFragment = null;
1020             ft.commitAllowingStateLoss();
1021             fm.executePendingTransactions();
1022             invalidateOptionsMenu();
1023         }
1024     }
1025 
1026     public void checkEmptyListText(boolean isSearch) {
1027         if (isSearch) {
<abbr title="1028             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1028             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1029             getNoteListFragment().setEmptyListViewClickable(false);
1030         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1031             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1031             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1032             AnalyticsTracker.track(
1033                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1034                     AnalyticsTracker.CATEGORY_NOTE,
1035                     &quot;trash_filter_selected&quot;
1036             );
1037             getNoteListFragment().setEmptyListViewClickable(false);
1038         } else {
<abbr title="1039             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1039             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1040             getNoteListFragment().setEmptyListViewClickable(true);
1041         }
1042     }
1043 
1044     public void showDetailPlaceholder() {
1045         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1046             mCurrentNote = null;
1047             mNoteEditorFragment.setPlaceholderVisible(true);
1048             mNoteEditorFragment.clearMarkdown();
1049             mNoteEditorFragment.hideMarkdown();
1050             mIsShowingMarkdown = false;
1051         }
1052     }
1053 
1054     public void stopListeningToNotesBucket() {
1055         mNotesBucket.removeOnNetworkChangeListener(this);
1056         mNotesBucket.removeOnSaveObjectListener(this);
1057         mNotesBucket.removeOnDeleteObjectListener(this);
1058     }
1059 
1060     // Returns the appropriate view to show the undo bar within
1061     private View getUndoView() {
1062         View undoView = mFragmentsContainer;
1063         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1064                 getNoteListFragment() != null &amp;&amp;
1065                 getNoteListFragment().getRootView() != null) {
1066             undoView = getNoteListFragment().getRootView();
1067         }
1068 
1069         return undoView;
1070     }
1071 
1072     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1073         if (mUndoBarController != null) {
1074             mUndoBarController.setDeletedNoteIds(noteIds);
1075             mUndoBarController.showUndoBar(
1076                     getUndoView(),
<abbr title="1077                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1077                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1078             );
1079         }
1080     }
1081 
1082     /* Simperium Bucket Listeners */
1083     // received a change from the network, refresh the list
1084     @Override
1085     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1086         runOnUiThread(new Runnable() {
1087             @Override
1088             public void run() {
1089                 if (type == Bucket.ChangeType.INDEX) {
1090                     setToolbarProgressVisibility(false);
1091                 }
1092                 mNoteListFragment.refreshList();
1093             }
1094         });
1095     }
1096 
1097     @Override
1098     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1099         runOnUiThread(new Runnable() {
1100             @Override
1101             public void run() {
1102                 mNoteListFragment.refreshList();
1103             }
1104         });
1105     }
1106 
1107     @Override
1108     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1109         runOnUiThread(new Runnable() {
1110             @Override
1111             public void run() {
1112                 mNoteListFragment.refreshList();
1113             }
1114         });
1115     }
1116 
1117     @Override
1118     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1119         // noop, NoteEditorFragment will handle this
1120     }
1121 
1122     /* The click listener for ListView in the navigation drawer */
1123     private class DrawerItemClickListener implements ListView.OnItemClickListener {
1124         @Override
1125         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1126 
1127             // Adjust for header view
1128             position -= mDrawerList.getHeaderViewsCount();
1129             mSelectedTag = mTagsAdapter.getItem(position);
1130             checkEmptyListText(false);
1131             // Update checked item in navigation drawer and close it
1132             setSelectedTagActive();
1133             mDrawerLayout.closeDrawer(mNavigationView);
1134             updateNavigationDrawerItems();
1135 
1136             // Disable long press on notes if we&#x27;re viewing the trash
1137             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1138                 getNoteListFragment().getListView().setLongClickable(false);
1139             } else {
1140                 getNoteListFragment().getListView().setLongClickable(true);
1141             }
1142 
1143             getNoteListFragment().refreshListFromNavSelect();
1144             if (position &gt; 1) {
1145                 AnalyticsTracker.track(
1146                         AnalyticsTracker.Stat.LIST_TAG_VIEWED,
1147                         AnalyticsTracker.CATEGORY_TAG,
1148                         &quot;selected_tag_in_navigation_drawer&quot;
1149                 );
1150             }
1151         }
1152     }
1153 
1154     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1155 
1156         @Override
1157         protected Void doInBackground(Void... voids) {
1158             if (mNotesBucket == null) return null;
1159 
1160             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1161             Bucket.ObjectCursor c = query.execute();
1162             while (c.moveToNext()) {
1163                 c.getObject().delete();
1164             }
1165 
1166             return null;
1167         }
1168 
1169         @Override
1170         protected void onPostExecute(Void nada) {
1171             showDetailPlaceholder();
1172         }
1173     }
1174 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.annotation.SuppressLint;
   4 import android.app.Activity;
   5 import android.app.AlertDialog;
   6 import android.content.DialogInterface;
   7 import android.content.Intent;
   8 import android.content.SharedPreferences;
   9 import android.content.res.Configuration;
  10 import android.os.AsyncTask;
  11 import android.os.Build;
  12 import android.os.Bundle;
  13 import android.os.Handler;
  14 import android.support.design.widget.NavigationView;
  15 import android.support.v4.app.FragmentManager;
  16 import android.support.v4.app.FragmentTransaction;
  17 import android.support.v4.content.ContextCompat;
  18 import android.support.v4.view.GravityCompat;
  19 import android.support.v4.widget.DrawerLayout;
  20 import android.support.v7.app.ActionBar;
  21 import android.support.v7.app.ActionBarDrawerToggle;
  22 import android.support.v7.app.AppCompatActivity;
  23 import android.support.v7.preference.PreferenceManager;
  24 import android.support.v7.widget.SearchView;
  25 import android.support.v7.widget.Toolbar;
  26 import android.text.Spannable;
  27 import android.text.SpannableString;
  28 import android.text.TextUtils;
  29 import android.view.Menu;
  30 import android.view.MenuInflater;
  31 import android.view.MenuItem;
  32 import android.view.View;
  33 import android.view.WindowInsets;
  34 import android.view.WindowManager;
  35 import android.widget.AdapterView;
  36 import android.widget.LinearLayout;
  37 import android.widget.ListView;
  38 import android.widget.ProgressBar;
  39 
  40 import com.automattic.simplenote.analytics.AnalyticsTracker;
  41 import com.automattic.simplenote.models.Note;
  42 import com.automattic.simplenote.models.Tag;
  43 import com.automattic.simplenote.utils.DisplayUtils;
  44 import com.automattic.simplenote.utils.DrawableUtils;
  45 import com.automattic.simplenote.utils.HtmlCompat;
  46 import com.automattic.simplenote.utils.PrefUtils;
  47 import com.automattic.simplenote.utils.StrUtils;
  48 import com.automattic.simplenote.utils.TagsAdapter;
  49 import com.automattic.simplenote.utils.ThemeUtils;
  50 import com.automattic.simplenote.utils.UndoBarController;
  51 import com.automattic.simplenote.widgets.TypefaceSpan;
  52 import com.simperium.Simperium;
  53 import com.simperium.client.Bucket;
  54 import com.simperium.client.BucketObjectMissingException;
  55 import com.simperium.client.BucketObjectNameInvalid;
  56 import com.simperium.client.Query;
  57 import com.simperium.client.User;
  58 
  59 import org.wordpress.passcodelock.AppLockManager;
  60 
  61 import java.util.ArrayList;
  62 import java.util.Calendar;
  63 import java.util.List;
  64 
  65 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  66 
  67 public class NotesActivity extends AppCompatActivity implements
<abbr title="  68         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  68         NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarCoðŸ”µ</abbr>
  69         Bucket.Listener&lt;Note&gt; {
  70 
  71     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  72     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  73     protected Bucket&lt;Note&gt; mNotesBucket;
  74     protected Bucket&lt;Tag&gt; mTagsBucket;
  75     private int TRASH_SELECTED_ID = 1;
  76     private boolean mIsShowingMarkdown;
  77     private boolean mShouldSelectNewNote;
  78 
  79     private String mTabletSearchQuery;
  80     private UndoBarController mUndoBarController;
  81     private View mFragmentsContainer;
  82     private SearchView mSearchView;
  83     private MenuItem mSearchMenuItem;
  84     private NoteListFragment mNoteListFragment;
  85     private NoteEditorFragment mNoteEditorFragment;
  86     private Note mCurrentNote;
  87     private MenuItem mEmptyTrashMenuItem;
  88 
  89     // Menu drawer
  90     private DrawerLayout mDrawerLayout;
  91     private ListView mDrawerList;
  92     private NavigationView mNavigationView;
  93     private ActionBarDrawerToggle mDrawerToggle;
  94     private TagsAdapter mTagsAdapter;
  95     private TagsAdapter.TagMenuItem mSelectedTag;
  96     // Tags bucket listener
  97     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
  98         void updateNavigationDrawer() {
  99             runOnUiThread(new Runnable() {
 100                 public void run() {
 101                     updateNavigationDrawerItems();
 102                 }
 103             });
 104         }
 105 
 106         @Override
 107         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 108             updateNavigationDrawer();
 109         }
 110 
 111         @Override
 112         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 113             updateNavigationDrawer();
 114         }
 115 
 116         @Override
 117         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 118             updateNavigationDrawer();
 119         }
 120 
 121         @Override
 122         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 123             // noop
 124         }
 125     };
 126 
 127     @Override
 128     protected void onCreate(Bundle savedInstanceState) {
 129         // On lollipop, configure the translucent status bar
 130         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 131             getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
 132 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133             getWindow().setStatusBarColor(ContextCompat.getColor(this, android.R.color.transparent));</span>
 134 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
 136 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 137             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.translucent_grey_medium_light));"> 137             getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.translucent_grey_medium_liðŸ”µ</abbr></span>
 138 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 139         }
 140 
 141         ThemeUtils.setTheme(this);
 142         super.onCreate(savedInstanceState);
 143 
 144         setContentView(R.layout.activity_notes);
 145 
 146         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 147 
 148         Simplenote currentApp = (Simplenote) getApplication();
 149         if (mNotesBucket == null) {
 150             mNotesBucket = currentApp.getNotesBucket();
 151         }
 152 
 153         if (mTagsBucket == null) {
 154             mTagsBucket = currentApp.getTagsBucket();
 155         }
 156 
 157         Toolbar toolbar = findViewById(R.id.toolbar);
 158         setSupportActionBar(toolbar);
 159         configureNavigationDrawer(toolbar);
 160 
 161         if (savedInstanceState == null) {
 162             mNoteListFragment = new NoteListFragment();
 163             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 164             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 165             fragmentTransaction.commit();
 166         } else {
<abbr title=" 167             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);"> 167             mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTEðŸ”µ</abbr>
 168         }
 169 
 170         if (DisplayUtils.isLargeScreen(this)) {
 171             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 172                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 172                 mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(ðŸ”µ</abbr>
 173             } else if (DisplayUtils.isLandscape(this)) {
 174                 addEditorFragment();
 175             }
 176         }
 177 
 178         // enable ActionBar app icon to behave as action to toggle nav drawer
 179         ActionBar actionBar = getSupportActionBar();
 180         if (actionBar != null) {
 181             actionBar.setDisplayHomeAsUpEnabled(true);
 182             actionBar.setHomeButtonEnabled(true);
 183 
 184             // Add loading indicator to show when indexing
<abbr title=" 185             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 185             ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolðŸ”µ</abbr>
 186             actionBar.setDisplayShowCustomEnabled(true);
 187             actionBar.setCustomView(progressBar);
 188             setToolbarProgressVisibility(false);
 189         }
 190 
 191         mUndoBarController = new UndoBarController(this);
 192 
 193         // Creates &#x27;Welcome&#x27; note
 194         checkForFirstLaunch();
 195 
 196         checkForSharedContent();
 197 
 198         currentApp.getSimperium().setOnUserCreatedListener(this);
 199         currentApp.getSimperium().setUserStatusChangeListener(this);
 200     }
 201 
 202     @Override
 203     protected void onResume() {
 204         super.onResume();
 205 
 206         // Ensure user has valid authorization
 207         if (userAuthenticationIsInvalid()) {
 208             startLoginActivity(true);
 209         }
 210 
 211         disableScreenshotsIfLocked(this);
 212 
 213         mNotesBucket.start();
 214         mTagsBucket.start();
 215 
 216         mNotesBucket.addOnNetworkChangeListener(this);
 217         mNotesBucket.addOnSaveObjectListener(this);
 218         mNotesBucket.addOnDeleteObjectListener(this);
 219         mTagsBucket.addListener(mTagsMenuUpdater);
 220 
 221         updateNavigationDrawerItems();
 222 
 223         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 224         if (userIsUnauthorized()) {
 225             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 226                 mSelectedTag = null;
 227                 mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 228             }
 229         }
 230 
 231         setSelectedTagActive();
 232 
 233         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 234             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 235             mShouldSelectNewNote = false;
 236         }
 237 
 238         if (mIsShowingMarkdown) {
 239             setMarkdownShowing(false);
 240         }
 241 
 242     }
 243 
 244     @Override
 245     protected void onPause() {
 246         super.onPause();  // Always call the superclass method first
 247         mTagsBucket.removeListener(mTagsMenuUpdater);
 248         mTagsBucket.stop();
 249 
 250         mNotesBucket.removeOnNetworkChangeListener(this);
 251         mNotesBucket.removeOnSaveObjectListener(this);
 252         mNotesBucket.removeOnDeleteObjectListener(this);
 253         mNotesBucket.stop();
 254     }
 255 
 256     @Override
 257     public void setTitle(CharSequence title) {
 258         if (title == null) {
 259             title = &quot;&quot;;
 260         }
 261 
 262         setTitleWithCustomFont(title);
 263     }
 264 
 265     @Override
 266     public void onBackPressed() {
 267         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 268             mDrawerLayout.closeDrawer(GravityCompat.START);
 269         } else {
 270             super.onBackPressed();
 271         }
 272     }
 273 
 274     private void setTitleWithCustomFont(CharSequence title) {
 275         if (getSupportActionBar() == null) return;
 276 
 277         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 278         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 279                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 280             getSupportActionBar().setTitle(title);
 281             return;
 282         }
 283 
 284         SpannableString s = new SpannableString(title);
 285         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 286         getSupportActionBar().setTitle(s);
 287     }
 288 
 289     private void configureNavigationDrawer(Toolbar toolbar) {
 290         mDrawerLayout = findViewById(R.id.drawer_layout);
 291         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 292         mNavigationView = findViewById(R.id.navigation_view);
 293         mDrawerList = findViewById(R.id.drawer_list);
 294 
 295         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 296             mNavigationView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {
 297                 @Override
 298                 @SuppressLint(&quot;NewApi&quot;)
 299                 public WindowInsets onApplyWindowInsets(View view, WindowInsets windowInsets) {
 300                     LinearLayout drawerView = findViewById(R.id.drawer_view);
 301                     drawerView.setPadding(
 302                             drawerView.getPaddingLeft(),
 303                             windowInsets.getSystemWindowInsetTop(),
 304                             drawerView.getPaddingRight(),
 305                             drawerView.getPaddingBottom());
 306 
 307                     return windowInsets.consumeSystemWindowInsets();
 308                 }
 309             });
 310         }
 311 
 312         View settingsButton = findViewById(R.id.nav_settings);
 313         settingsButton.setOnClickListener(new View.OnClickListener() {
 314             @Override
 315             public void onClick(View v) {
 316                 Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 317                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 318             }
 319         });
 320 
 321         mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 322         mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 323         mDrawerList.setAdapter(mTagsAdapter);
 324         // Set the list&#x27;s click listener
 325         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 326 
 327         if (mSelectedTag == null)
 328             mSelectedTag = mTagsAdapter.getDefaultItem();
 329 
 330         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 331                 R.string.close_drawer) {
 332             public void onDrawerClosed(View view) {
 333                 supportInvalidateOptionsMenu();
 334             }
 335 
 336             public void onDrawerOpened(View drawerView) {
 337                 // noop
 338             }
 339 
 340             @Override
 341             public void onDrawerSlide(View drawerView, float slideOffset) {
 342                 super.onDrawerSlide(drawerView, 0f);
 343             }
 344         };
 345 
 346         mDrawerLayout.addDrawerListener(mDrawerToggle);
 347     }
 348 
 349     private void checkForFirstLaunch() {
 350         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 351             // Create the welcome note
 352             try {
 353                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 354                 welcomeNote.setCreationDate(Calendar.getInstance());
 355                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 356                 welcomeNote.setContent(getString(R.string.welcome_note));
 357                 welcomeNote.getTitle();
 358                 welcomeNote.save();
 359             } catch (BucketObjectNameInvalid e) {
 360                 // this won&#x27;t happen because welcome-android is a valid name
 361             }
 362 
 363             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 364             SharedPreferences.Editor editor = preferences.edit();
 365             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 366             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 367             editor.apply();
 368         }
 369     }
 370 
 371     private void checkForSharedContent() {
 372         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 373             // Check share action
 374             Intent intent = getIntent();
 375             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 376             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 377 
<abbr title=" 378             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 378             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 379             String intentAction = StrUtils.notNullStr(intent.getAction());
 380             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 381             if (!TextUtils.isEmpty(text)) {
 382                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 383                     text = subject + &quot;\n\n&quot; + text;
 384                 }
 385                 Note note = mNotesBucket.newObject();
 386                 note.setCreationDate(Calendar.getInstance());
 387                 note.setModificationDate(note.getCreationDate());
 388                 note.setContent(text);
 389                 note.save();
 390                 setCurrentNote(note);
 391                 mShouldSelectNewNote = true;
 392 
 393                 AnalyticsTracker.track(
 394                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 395                         AnalyticsTracker.CATEGORY_NOTE,
 396                         &quot;external_share&quot;
 397                 );
 398 
 399                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 400                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 401                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 402                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 403                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 404                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 405                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 406                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 407                     }
 408                 }
 409             }
 410         }
 411     }
 412 
 413     private void updateNavigationDrawerItems() {
 414         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 415         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 416         if (isAlphaSort) {
 417             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 418         } else {
 419             tagCursor = Tag.allWithName(mTagsBucket).execute();
 420         }
 421 
 422         mTagsAdapter.changeCursor(tagCursor);
 423     }
 424 
 425     private void setSelectedTagActive() {
 426         if (mSelectedTag == null)
 427             mSelectedTag = mTagsAdapter.getDefaultItem();
 428 
 429         setTitle(mSelectedTag.name);
<abbr title=" 430         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 430         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCouðŸ”µ</abbr>
 431     }
 432 
 433     public TagsAdapter.TagMenuItem getSelectedTag() {
 434         if (mSelectedTag == null) {
 435             mSelectedTag = mTagsAdapter.getDefaultItem();
 436         }
 437 
 438         return mSelectedTag;
 439     }
 440 
 441     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 442     public void updateTrashMenuItem() {
 443         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 444             return;
 445 
 446         // Disable the trash icon if there are no notes trashed.
 447         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 448         if (query.count() == 0) {
 449             mEmptyTrashMenuItem.setEnabled(false);
 450         } else {
 451             mEmptyTrashMenuItem.setEnabled(true);
 452         }
 453     }
 454 
 455     private void addEditorFragment() {
 456         FragmentManager fm = getSupportFragmentManager();
 457         FragmentTransaction ft = fm.beginTransaction();
 458         mNoteEditorFragment = new NoteEditorFragment();
 459         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 460         ft.commitAllowingStateLoss();
 461         fm.executePendingTransactions();
 462     }
 463 
 464     private boolean userAccountRequired() {
 465         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 466     }
 467 
 468     /**
 469      * Checks for a previously valid user that is now not authenticated
 470      * Also checks if user account is required (added in version 1.5.6)
 471      *
 472      * @return true if user has invalid authorization
 473      */
 474     private boolean userAuthenticationIsInvalid() {
 475         Simplenote currentApp = (Simplenote) getApplication();
 476         Simperium simperium = currentApp.getSimperium();
 477         User user = simperium.getUser();
 478         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 479         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 480                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 481     }
 482 
 483     public boolean userIsUnauthorized() {
 484         Simplenote currentApp = (Simplenote) getApplication();
 485         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 486     }
 487 
 488     public void setCurrentNote(Note note) {
 489         mCurrentNote = note;
 490     }
 491 
 492     public NoteListFragment getNoteListFragment() {
 493         return mNoteListFragment;
 494     }
 495 
 496     @SuppressWarnings(&quot;ResourceType&quot;)
 497     @Override
 498     public boolean onCreateOptionsMenu(Menu menu) {
 499         super.onCreateOptionsMenu(menu);
 500         MenuInflater inflater = getMenuInflater();
 501         inflater.inflate(R.menu.notes_list, menu);
 502 
 503         // restore the search query if on a landscape tablet
 504         String searchQuery = null;
 505         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 506             searchQuery = mSearchView.getQuery().toString();
 507 
 508         mSearchMenuItem = menu.findItem(R.id.menu_search);
 509         mSearchView = (SearchView) mSearchMenuItem.getActionView();
 510 
 511         if (!TextUtils.isEmpty(searchQuery)) {
 512             mSearchView.setQuery(searchQuery, false);
 513             mSearchMenuItem.expandActionView();
 514         } else {
 515             // Workaround for setting the search placeholder text color
 516             String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 517                     getString(R.color.gray_light) :
 518                     getString(R.color.text_preview)).replace(&quot;ff&quot;, &quot;&quot;);
 519             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 520                     hintHexColor,
 521                     getString(R.string.search))));
 522         }
 523 
 524         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 525             @Override
 526             public boolean onQueryTextChange(String newText) {
 527                 if (mSearchMenuItem.isActionViewExpanded()) {
 528                     getNoteListFragment().searchNotes(newText);
 529                 }
 530                 return true;
 531             }
 532 
 533             @Override
 534             public boolean onQueryTextSubmit(String queryText) {
 535                 getNoteListFragment().searchNotes(queryText);
 536                 return true;
 537             }
 538 
 539         });
 540 
 541         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 542             @Override
 543             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 544                 checkEmptyListText(true);
 545                 if (mNoteListFragment != null) {
 546                     mNoteListFragment.setFloatingActionButtonVisible(false);
 547                 }
 548                 AnalyticsTracker.track(
 549                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 550                         AnalyticsTracker.CATEGORY_NOTE,
 551                         &quot;action_bar_search_tap&quot;
 552                 );
 553                 return true;
 554             }
 555 
 556             @Override
 557             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 558                 // Show all notes again
 559                 if (mNoteListFragment != null) {
 560                     mNoteListFragment.setFloatingActionButtonVisible(true);
 561                 }
 562                 mTabletSearchQuery = &quot;&quot;;
 563                 mSearchView.setQuery(&quot;&quot;, false);
 564                 checkEmptyListText(false);
 565                 getNoteListFragment().clearSearch();
 566                 return true;
 567             }
 568         });
 569 
 570         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 571             @Override
 572             public boolean onMenuItemClick(MenuItem item) {
 573                 if (!mSearchMenuItem.isActionViewExpanded())
 574                     showDetailPlaceholder();
 575                 return false;
 576             }
 577         });
 578 
 579         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 580         if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 581             trashItem.setTitle(R.string.undelete);
 582             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 583         } else {
 584             trashItem.setTitle(R.string.delete);
 585             trashItem.setIcon(R.drawable.ic_trash_24dp);
 586         }
 587 
 588         if (DisplayUtils.isLargeScreenLandscape(this)) {
 589             // Restore the search query on landscape tablets
 590             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 591                 mSearchMenuItem.expandActionView();
 592                 mSearchView.setQuery(mTabletSearchQuery, false);
 593                 mSearchView.clearFocus();
 594             }
 595 
 596             if (mCurrentNote != null) {
 597                 menu.findItem(R.id.menu_share).setVisible(true);
 598                 menu.findItem(R.id.menu_view_info).setVisible(true);
 599                 menu.findItem(R.id.menu_checklist).setVisible(true);
 600                 menu.findItem(R.id.menu_history).setVisible(true);
 601                 menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 602                 trashItem.setVisible(true);
 603             } else {
 604                 menu.findItem(R.id.menu_share).setVisible(false);
 605                 menu.findItem(R.id.menu_view_info).setVisible(false);
 606                 menu.findItem(R.id.menu_checklist).setVisible(false);
 607                 menu.findItem(R.id.menu_history).setVisible(false);
 608                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 609                 trashItem.setVisible(false);
 610             }
 611             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 612         } else {
 613             menu.findItem(R.id.menu_search).setVisible(true);
 614             menu.findItem(R.id.menu_share).setVisible(false);
 615             menu.findItem(R.id.menu_view_info).setVisible(false);
 616             menu.findItem(R.id.menu_checklist).setVisible(false);
 617             menu.findItem(R.id.menu_history).setVisible(false);
 618             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 619             trashItem.setVisible(false);
 620             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 621         }
 622 
 623         // Are we looking at the trash? Adjust menu accordingly.
 624         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 625             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 626             mEmptyTrashMenuItem.setVisible(true);
 627 
 628             updateTrashMenuItem();
 629 
 630             menu.findItem(R.id.menu_search).setVisible(false);
 631             menu.findItem(R.id.menu_share).setVisible(false);
 632             menu.findItem(R.id.menu_history).setVisible(false);
 633             menu.findItem(R.id.menu_checklist).setVisible(false);
 634         }
 635 
 636         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 637 
 638         return true;
 639     }
 640 
 641     @Override
 642     public boolean onOptionsItemSelected(MenuItem item) {
 643         if (mDrawerToggle.onOptionsItemSelected(item)) {
 644             return true;
 645         }
 646         switch (item.getItemId()) {
 647             case R.id.menu_markdown_preview:
 648                 if (mIsShowingMarkdown) {
 649                     item.setIcon(R.drawable.ic_preview_24dp);
 650                     item.setTitle(getString(R.string.markdown_show));
 651                     setMarkdownShowing(false);
 652                 } else {
 653                     item.setIcon(R.drawable.ic_preview_stop_24dp);
 654                     item.setTitle(getString(R.string.markdown_hide));
 655                     setMarkdownShowing(true);
 656                 }
 657 
 658                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 659 
 660                 return true;
 661             case R.id.menu_delete:
 662                 if (mNoteEditorFragment != null) {
 663                     if (mCurrentNote != null) {
 664                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 665                         mCurrentNote.setModificationDate(Calendar.getInstance());
 666                         mCurrentNote.save();
 667 
 668                         updateViewsAfterTrashAction(mCurrentNote);
 669                     }
 670                 }
 671                 return true;
 672             case R.id.menu_empty_trash:
 673                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 674 
 675                 alert.setTitle(R.string.empty_trash);
 676                 alert.setMessage(R.string.confirm_empty_trash);
 677                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 678                     public void onClick(DialogInterface dialog, int whichButton) {
 679                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 680                         AnalyticsTracker.track(
 681                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 682                                 AnalyticsTracker.CATEGORY_NOTE,
 683                                 &quot;overflow_menu&quot;
 684                         );
 685                     }
 686                 });
 687                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 688                     public void onClick(DialogInterface dialog, int whichButton) {
 689                         // Do nothing, just closing the dialog
 690                     }
 691                 });
 692                 alert.show();
 693                 return true;
 694             case android.R.id.home:
 695                 invalidateOptionsMenu();
 696                 return true;
 697             default:
 698                 return super.onOptionsItemSelected(item);
 699         }
 700     }
 701 
 702     @Override
 703     public boolean onPrepareOptionsMenu(Menu menu) {
 704         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 705 
 706         if (mIsShowingMarkdown) {
 707             markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 708             markdownItem.setTitle(getString(R.string.markdown_hide));
 709         } else {
 710             markdownItem.setIcon(R.drawable.ic_preview_24dp);
 711             markdownItem.setTitle(getString(R.string.markdown_show));
 712         }
 713 
 714         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 715 
 716         return super.onPrepareOptionsMenu(menu);
 717     }
 718 
 719     public void updateViewsAfterTrashAction(Note note) {
 720         if (note == null || isFinishing()) {
 721             return;
 722         }
 723 
 724         if (note.isDeleted()) {
 725             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 726             deletedNoteIds.add(note.getSimperiumKey());
 727             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 728             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 729             AnalyticsTracker.track(
 730                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 731                     AnalyticsTracker.CATEGORY_NOTE,
 732                     &quot;overflow_menu&quot;
 733             );
 734         } else {
 735             AnalyticsTracker.track(
 736                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 737                     AnalyticsTracker.CATEGORY_NOTE,
 738                     &quot;overflow_menu&quot;
 739             );
 740         }
 741 
 742         // If we just deleted/restored the active note, show the placeholder
 743         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 744             showDetailPlaceholder();
 745         }
 746 
 747         NoteListFragment fragment = getNoteListFragment();
 748         if (fragment != null) {
 749             fragment.getPrefs();
 750             fragment.refreshList();
 751         }
 752 
 753         invalidateOptionsMenu();
 754     }
 755 
 756     public void setMarkdownShowing(boolean isMarkdownShowing) {
 757         mIsShowingMarkdown = isMarkdownShowing;
 758         if (mNoteEditorFragment != null) {
 759             if (isMarkdownShowing) {
 760                 mNoteEditorFragment.showMarkdown();
 761             } else {
 762                 mNoteEditorFragment.hideMarkdown();
 763             }
 764         }
 765         invalidateOptionsMenu();
 766     }
 767 
 768     /**
 769      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 770      * the item with the given ID was selected. Used for tablets only.
 771      */
 772     @Override
<abbr title=" 773     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {"> 773     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 774         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 775             // Launch the editor activity
 776             Bundle arguments = new Bundle();
 777             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 778             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 779 
 780             if (matchOffsets != null)
 781                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 782 
 783             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 784             editNoteIntent.putExtras(arguments);
 785             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 786         } else {
 787             mNoteEditorFragment.setNote(noteID, matchOffsets);
 788             getNoteListFragment().setNoteSelected(noteID);
 789 
 790             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 791                 mTabletSearchQuery = mSearchView.getQuery().toString();
 792             }
 793 
 794             mNoteEditorFragment.clearMarkdown();
 795 
 796             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 797                 setMarkdownShowing(false);
 798             }
 799 
 800             invalidateOptionsMenu();
 801         }
 802 
 803         AnalyticsTracker.track(
 804                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 805                 AnalyticsTracker.CATEGORY_NOTE,
 806                 &quot;note_list_row_tap&quot;
 807         );
 808     }
 809 
 810     @Override
 811     public void onUserCreated(User user) {
 812         // New account created
 813         AnalyticsTracker.track(
 814                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 815                 AnalyticsTracker.CATEGORY_USER,
 816                 &quot;account_created_from_login_activity&quot;
 817         );
 818     }
 819 
 820     public void onUserStatusChange(User.Status status) {
 821         switch (status) {
 822             // successfully used access token to connect to simperium bucket
 823             case AUTHORIZED:
 824                 runOnUiThread(new Runnable() {
 825                     @Override
 826                     public void run() {
 827                         if (!mNotesBucket.hasChangeVersion()) {
 828                             setToolbarProgressVisibility(true);
 829                         }
 830                     }
 831                 });
 832                 break;
 833 
 834             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 835             case NOT_AUTHORIZED:
 836                 runOnUiThread(new Runnable() {
 837                     @Override
 838                     public void run() {
 839                         startLoginActivity(true);
 840                     }
 841                 });
 842                 break;
 843 
<abbr title=" 844             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 844             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 845             case UNKNOWN:
 846                 break;
 847         }
 848     }
 849 
 850     private void setToolbarProgressVisibility(boolean isVisible) {
 851         if (getSupportActionBar() != null) {
 852             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 853         }
 854     }
 855 
 856     public void startLoginActivity(boolean signInFirst) {
 857         // Clear some account-specific prefs
 858         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 859         editor.remove(PrefUtils.PREF_WP_TOKEN);
 860         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 861         editor.apply();
 862 
 863         Intent loginIntent = new Intent(this, SignInActivity.class);
 864         if (signInFirst) {
 865             loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 866         }
 867         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 868     }
 869 
 870     @Override
 871     public void recreate() {
 872         Handler handler = new Handler();
 873         handler.post(new Runnable() {
 874             @Override
 875             public void run() {
 876                 NotesActivity.super.recreate();
 877             }
 878         });
 879     }
 880 
 881     @Override
 882     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 883         super.onActivityResult(requestCode, resultCode, data);
 884         switch (requestCode) {
 885             case Simplenote.INTENT_PREFERENCES:
 886                 if (ThemeUtils.themeWasChanged(data)) {
 887                     // Restart this activity to apply the new theme
 888                     recreate();
 889                     break;
 890                 }
<abbr title=" 891                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 891                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 892                 invalidateOptionsMenu();
 893                 NoteListFragment fragment = getNoteListFragment();
 894                 if (fragment != null) {
 895                     fragment.getPrefs();
 896                     fragment.refreshList();
 897                 }
 898 
 899                 break;
 900             case Simplenote.INTENT_EDIT_NOTE:
 901                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
 902                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 903                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 904                         if (noteId != null) {
 905                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 906                             deletedNoteIds.add(noteId);
 907                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 908                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));"> 908                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
 909                         }
<abbr title=" 910                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 910                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
 911                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 912                         mNoteListFragment.setNoteSelected(selectedNoteId);
 913                         if (mNoteEditorFragment != null) {
 914                             mNoteEditorFragment.setNote(selectedNoteId);
 915                         }
 916                     }
 917                 }
 918                 break;
 919             case Simperium.SIGNUP_SIGNIN_REQUEST:
 920                 invalidateOptionsMenu();
 921 
 922                 Simplenote app = (Simplenote) getApplication();
 923                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 924 
 925                 AnalyticsTracker.track(
 926                         AnalyticsTracker.Stat.USER_SIGNED_IN,
 927                         AnalyticsTracker.CATEGORY_USER,
 928                         &quot;signed_in_from_login_activity&quot;
 929                 );
 930 
 931                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 932                     finish();
 933                 }
 934 
 935                 break;
 936         }
 937     }
 938 
 939     @Override
 940     public void onUndo() {
 941         if (mUndoBarController == null) return;
 942 
 943         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 944         if (deletedNoteIds != null) {
 945             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 946                 Note deletedNote;
 947                 try {
 948                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 949                 } catch (BucketObjectMissingException e) {
 950                     return;
 951                 }
 952                 if (deletedNote != null) {
 953                     deletedNote.setDeleted(false);
 954                     deletedNote.setModificationDate(Calendar.getInstance());
 955                     deletedNote.save();
 956                     NoteListFragment fragment = getNoteListFragment();
 957                     if (fragment != null) {
 958                         fragment.getPrefs();
 959                         fragment.refreshList();
 960                     }
 961                 }
 962             }
 963         }
 964     }
 965 
 966     @Override
 967     protected void onPostCreate(Bundle savedInstanceState) {
 968         super.onPostCreate(savedInstanceState);
 969         // Sync the toggle state after onRestoreInstanceState has occurred.
 970         mDrawerToggle.syncState();
 971     }
 972 
 973     @Override
 974     public void onConfigurationChanged(Configuration newConfig) {
 975         super.onConfigurationChanged(newConfig);
 976 
 977         mDrawerToggle.onConfigurationChanged(newConfig);
 978 
 979         if (DisplayUtils.isLargeScreen(this)) {
 980             mIsShowingMarkdown = false;
 981 
 982             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 983                 // Add the editor fragment
 984                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 985                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 985                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
 986                 } else if (DisplayUtils.isLandscape(this)) {
 987                     addEditorFragment();
 988                 }
 989                 if (mNoteListFragment != null) {
 990                     mNoteListFragment.setActivateOnItemClick(true);
 991                     mNoteListFragment.setDividerVisible(true);
 992                 }
 993                 // Select the current note on a tablet
 994                 if (mCurrentNote != null)
<abbr title=" 995                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());"> 995                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
 996                 else {
 997                     mNoteEditorFragment.setPlaceholderVisible(true);
 998                     mNoteListFragment.getListView().clearChoices();
 999                 }
1000                 invalidateOptionsMenu();
1001             }
1002         }
1003 
1004         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1005             // Remove the editor fragment when rotating back to portrait
1006             mCurrentNote = null;
1007             if (mNoteListFragment != null) {
1008                 mNoteListFragment.setActivateOnItemClick(false);
1009                 mNoteListFragment.setDividerVisible(false);
1010                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1011                 mNoteListFragment.refreshList();
1012             }
1013             FragmentManager fm = getSupportFragmentManager();
1014             FragmentTransaction ft = fm.beginTransaction();
1015             ft.remove(mNoteEditorFragment);
1016             mNoteEditorFragment = null;
1017             ft.commitAllowingStateLoss();
1018             fm.executePendingTransactions();
1019             invalidateOptionsMenu();
1020         }
1021     }
1022 
1023     public void checkEmptyListText(boolean isSearch) {
1024         if (isSearch) {
<abbr title="1025             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1025             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
1026             getNoteListFragment().setEmptyListViewClickable(false);
1027         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1028             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1028             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
1029             AnalyticsTracker.track(
1030                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1031                     AnalyticsTracker.CATEGORY_NOTE,
1032                     &quot;trash_filter_selected&quot;
1033             );
1034             getNoteListFragment().setEmptyListViewClickable(false);
1035         } else {
<abbr title="1036             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1036             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1037             getNoteListFragment().setEmptyListViewClickable(true);
1038         }
1039     }
1040 
1041     public void showDetailPlaceholder() {
1042         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1043             mCurrentNote = null;
1044             mNoteEditorFragment.setPlaceholderVisible(true);
1045             mNoteEditorFragment.clearMarkdown();
1046             mNoteEditorFragment.hideMarkdown();
1047             mIsShowingMarkdown = false;
1048         }
1049     }
1050 
1051     public void stopListeningToNotesBucket() {
1052         mNotesBucket.removeOnNetworkChangeListener(this);
1053         mNotesBucket.removeOnSaveObjectListener(this);
1054         mNotesBucket.removeOnDeleteObjectListener(this);
1055     }
1056 
1057     // Returns the appropriate view to show the undo bar within
1058     private View getUndoView() {
1059         View undoView = mFragmentsContainer;
1060         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1061                 getNoteListFragment() != null &amp;&amp;
1062                 getNoteListFragment().getRootView() != null) {
1063             undoView = getNoteListFragment().getRootView();
1064         }
1065 
1066         return undoView;
1067     }
1068 
1069     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1070         if (mUndoBarController != null) {
1071             mUndoBarController.setDeletedNoteIds(noteIds);
1072             mUndoBarController.showUndoBar(
1073                     getUndoView(),
<abbr title="1074                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1074                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1075             );
1076         }
1077     }
1078 
1079     /* Simperium Bucket Listeners */
1080     // received a change from the network, refresh the list
1081     @Override
1082     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1083         runOnUiThread(new Runnable() {
1084             @Override
1085             public void run() {
1086                 if (type == Bucket.ChangeType.INDEX) {
1087                     setToolbarProgressVisibility(false);
1088                 }
1089                 mNoteListFragment.refreshList();
1090             }
1091         });
1092     }
1093 
1094     @Override
1095     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1096         runOnUiThread(new Runnable() {
1097             @Override
1098             public void run() {
1099                 mNoteListFragment.refreshList();
1100             }
1101         });
1102     }
1103 
1104     @Override
1105     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1106         runOnUiThread(new Runnable() {
1107             @Override
1108             public void run() {
1109                 mNoteListFragment.refreshList();
1110             }
1111         });
1112     }
1113 
1114     @Override
1115     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1116         // noop, NoteEditorFragment will handle this
1117     }
1118 
1119     /* The click listener for ListView in the navigation drawer */
1120     private class DrawerItemClickListener implements ListView.OnItemClickListener {
1121         @Override
1122         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1123 
1124             // Adjust for header view
1125             position -= mDrawerList.getHeaderViewsCount();
1126             mSelectedTag = mTagsAdapter.getItem(position);
1127             checkEmptyListText(false);
1128             // Update checked item in navigation drawer and close it
1129             setSelectedTagActive();
1130             mDrawerLayout.closeDrawer(mNavigationView);
1131             updateNavigationDrawerItems();
1132 
1133             // Disable long press on notes if we&#x27;re viewing the trash
1134             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1135                 getNoteListFragment().getListView().setLongClickable(false);
1136             } else {
1137                 getNoteListFragment().getListView().setLongClickable(true);
1138             }
1139 
1140             getNoteListFragment().refreshListFromNavSelect();
1141             if (position &gt; 1) {
1142                 AnalyticsTracker.track(
1143                         AnalyticsTracker.Stat.LIST_TAG_VIEWED,
1144                         AnalyticsTracker.CATEGORY_TAG,
1145                         &quot;selected_tag_in_navigation_drawer&quot;
1146                 );
1147             }
1148         }
1149     }
1150 
1151     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1152 
1153         @Override
1154         protected Void doInBackground(Void... voids) {
1155             if (mNotesBucket == null) return null;
1156 
1157             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1158             Bucket.ObjectCursor c = query.execute();
1159             while (c.moveToNext()) {
1160                 c.getObject().delete();
1161             }
1162 
1163             return null;
1164         }
1165 
1166         @Override
1167         protected void onPostExecute(Void nada) {
1168             showDetailPlaceholder();
1169         }
1170     }
1171 }
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.annotation.SuppressLint;
   4 import android.app.Activity;
   5 import android.app.AlertDialog;
   6 import android.content.DialogInterface;
   7 import android.content.Intent;
   8 import android.content.SharedPreferences;
   9 import android.content.res.Configuration;
  10 import android.os.AsyncTask;
  11 import android.os.Build;
  12 import android.os.Bundle;
  13 import android.os.Handler;
  14 import android.support.design.widget.NavigationView;
  15 import android.support.v4.app.FragmentManager;
  16 import android.support.v4.app.FragmentTransaction;
  17 import android.support.v4.content.ContextCompat;
  18 import android.support.v4.view.GravityCompat;
  19 import android.support.v4.widget.DrawerLayout;
  20 import android.support.v7.app.ActionBar;
  21 import android.support.v7.app.ActionBarDrawerToggle;
  22 import android.support.v7.app.AppCompatActivity;
  23 import android.support.v7.preference.PreferenceManager;
  24 import android.support.v7.widget.SearchView;
  25 import android.support.v7.widget.Toolbar;
  26 import android.text.Spannable;
  27 import android.text.SpannableString;
  28 import android.text.TextUtils;
  29 import android.view.Menu;
  30 import android.view.MenuInflater;
  31 import android.view.MenuItem;
  32 import android.view.View;
  33 import android.view.WindowInsets;
  34 import android.view.WindowManager;
  35 import android.widget.AdapterView;
  36 import android.widget.LinearLayout;
  37 import android.widget.ListView;
  38 import android.widget.ProgressBar;
  39 import com.automattic.simplenote.analytics.AnalyticsTracker;
  40 import com.automattic.simplenote.models.Note;
  41 import com.automattic.simplenote.models.Tag;
  42 import com.automattic.simplenote.utils.DisplayUtils;
  43 import com.automattic.simplenote.utils.DrawableUtils;
  44 import com.automattic.simplenote.utils.HtmlCompat;
  45 import com.automattic.simplenote.utils.PrefUtils;
  46 import com.automattic.simplenote.utils.StrUtils;
  47 import com.automattic.simplenote.utils.TagsAdapter;
  48 import com.automattic.simplenote.utils.ThemeUtils;
  49 import com.automattic.simplenote.utils.UndoBarController;
  50 import com.automattic.simplenote.widgets.TypefaceSpan;
  51 import com.simperium.Simperium;
  52 import com.simperium.client.Bucket;
  53 import com.simperium.client.BucketObjectMissingException;
  54 import com.simperium.client.BucketObjectNameInvalid;
  55 import com.simperium.client.Query;
  56 import com.simperium.client.User;
  57 import java.util.ArrayList;
  58 import java.util.Calendar;
  59 import java.util.List;
  60 import org.wordpress.passcodelock.AppLockManager;
  61 import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  62 
  63 
<abbr title="  64 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusChangeListener , Simperium.OnUserCreatedListener , UndoBarController.UndoListener , Bucket.Listener&lt;Note&gt; {">  64 public class NotesActivity extends AppCompatActivity implements NoteListFragment.Callbacks , User.StatusCðŸ”µ</abbr>
  65     public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  66 
  67     public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  68 
  69     protected Bucket&lt;Note&gt; mNotesBucket;
  70 
  71     protected Bucket&lt;Tag&gt; mTagsBucket;
  72 
  73     private int TRASH_SELECTED_ID = 1;
  74 
  75     private boolean mIsShowingMarkdown;
  76 
  77     private boolean mShouldSelectNewNote;
  78 
  79     private String mTabletSearchQuery;
  80 
  81     private UndoBarController mUndoBarController;
  82 
  83     private View mFragmentsContainer;
  84 
  85     private SearchView mSearchView;
  86 
  87     private MenuItem mSearchMenuItem;
  88 
  89     private NoteListFragment mNoteListFragment;
  90 
  91     private NoteEditorFragment mNoteEditorFragment;
  92 
  93     private Note mCurrentNote;
  94 
  95     private MenuItem mEmptyTrashMenuItem;
  96 
  97     // Menu drawer
  98     // Menu drawer
  99     private DrawerLayout mDrawerLayout;
 100 
 101     private ListView mDrawerList;
 102 
 103     private NavigationView mNavigationView;
 104 
 105     private ActionBarDrawerToggle mDrawerToggle;
 106 
 107     private TagsAdapter mTagsAdapter;
 108 
 109     private TagsAdapter.TagMenuItem mSelectedTag;
 110 
 111     // Tags bucket listener
 112     // Tags bucket listener
 113     private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
 114         void updateNavigationDrawer() {
 115             runOnUiThread(new Runnable() {
 116                 public void run() {
 117                     updateNavigationDrawerItems();
 118                 }
 119             });
 120         }
 121 
 122         @Override
 123         public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 124             updateNavigationDrawer();
 125         }
 126 
 127         @Override
 128         public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 129             updateNavigationDrawer();
 130         }
 131 
 132         @Override
 133         public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 134             updateNavigationDrawer();
 135         }
 136 
 137         @Override
 138         public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 139             // noop
 140         }
 141     };
 142 
 143     @Override
 144     protected void onCreate(Bundle savedInstanceState) {
 145         // On lollipop, configure the translucent status bar
 146         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 147             getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
<abbr title=" 148             getWindow().setStatusBarColor(ContextCompat.getColor(this, android.R.color.translucent_grey_medium_light));"> 148             getWindow().setStatusBarColor(ContextCompat.getColor(this, android.R.color.translucent_grey_mðŸ”µ</abbr>
 149         }
 150         ThemeUtils.setTheme(this);
 151         super.onCreate(savedInstanceState);
 152         setContentView(R.layout.activity_notes);
 153         mFragmentsContainer = findViewById(R.id.note_fragment_container);
 154         Simplenote currentApp = ((Simplenote) (getApplication()));
 155         if (mNotesBucket == null) {
 156             mNotesBucket = currentApp.getNotesBucket();
 157         }
 158         if (mTagsBucket == null) {
 159             mTagsBucket = currentApp.getTagsBucket();
 160         }
 161         Toolbar toolbar = findViewById(R.id.toolbar);
 162         setSupportActionBar(toolbar);
 163         configureNavigationDrawer(toolbar);
 164         if (savedInstanceState == null) {
 165             mNoteListFragment = new NoteListFragment();
 166             FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 167             fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 168             fragmentTransaction.commit();
 169         } else {
<abbr title=" 170             mNoteListFragment = ((NoteListFragment) (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST)));"> 170             mNoteListFragment = ((NoteListFragment) (getSupportFragmentManager().findFragmentByTag(TAG_NOðŸ”µ</abbr>
 171         }
 172         if (DisplayUtils.isLargeScreen(this)) {
 173             if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 174                 mNoteEditorFragment = ((NoteEditorFragment) (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR)));"> 174                 mNoteEditorFragment = ((NoteEditorFragment) (getSupportFragmentManager().findFragmentByTaðŸ”µ</abbr>
 175             } else if (DisplayUtils.isLandscape(this)) {
 176                 addEditorFragment();
 177             }
 178         }
 179         // enable ActionBar app icon to behave as action to toggle nav drawer
 180         ActionBar actionBar = getSupportActionBar();
 181         if (actionBar != null) {
 182             actionBar.setDisplayHomeAsUpEnabled(true);
 183             actionBar.setHomeButtonEnabled(true);
 184             // Add loading indicator to show when indexing
<abbr title=" 185             ProgressBar progressBar = ((ProgressBar) (getLayoutInflater().inflate(R.layout.progressbar_toolbar, null)));"> 185             ProgressBar progressBar = ((ProgressBar) (getLayoutInflater().inflate(R.layout.progressbar_toðŸ”µ</abbr>
 186             actionBar.setDisplayShowCustomEnabled(true);
 187             actionBar.setCustomView(progressBar);
 188             setToolbarProgressVisibility(false);
 189         }
 190         mUndoBarController = new UndoBarController(this);
 191         // Creates &#x27;Welcome&#x27; note
 192         checkForFirstLaunch();
 193         checkForSharedContent();
 194         currentApp.getSimperium().setOnUserCreatedListener(this);
 195         currentApp.getSimperium().setUserStatusChangeListener(this);
 196     }
 197 
 198     @Override
 199     protected void onResume() {
 200         super.onResume();
 201 
 202         // Ensure user has valid authorization
 203         if (userAuthenticationIsInvalid()) {
 204             startLoginActivity(true);
 205         }
 206 
 207         disableScreenshotsIfLocked(this);
 208 
 209         mNotesBucket.start();
 210         mTagsBucket.start();
 211 
 212         mNotesBucket.addOnNetworkChangeListener(this);
 213         mNotesBucket.addOnSaveObjectListener(this);
 214         mNotesBucket.addOnDeleteObjectListener(this);
 215         mTagsBucket.addListener(mTagsMenuUpdater);
 216 
 217         updateNavigationDrawerItems();
 218 
 219         // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 220         if (userIsUnauthorized()) {
 221             if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 222                 mSelectedTag = null;
 223                 mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 224             }
 225         }
 226 
 227         setSelectedTagActive();
 228 
 229         if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 230             onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 231             mShouldSelectNewNote = false;
 232         }
 233 
 234         if (mIsShowingMarkdown) {
 235             setMarkdownShowing(false);
 236         }
 237 
 238     }
 239 
 240     @Override
 241     protected void onPause() {
 242         super.onPause();  // Always call the superclass method first
 243         mTagsBucket.removeListener(mTagsMenuUpdater);
 244         mTagsBucket.stop();
 245 
 246         mNotesBucket.removeOnNetworkChangeListener(this);
 247         mNotesBucket.removeOnSaveObjectListener(this);
 248         mNotesBucket.removeOnDeleteObjectListener(this);
 249         mNotesBucket.stop();
 250     }
 251 
 252     @Override
 253     public void setTitle(CharSequence title) {
 254         if (title == null) {
 255             title = &quot;&quot;;
 256         }
 257 
 258         setTitleWithCustomFont(title);
 259     }
 260 
 261     @Override
 262     public void onBackPressed() {
 263         if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 264             mDrawerLayout.closeDrawer(GravityCompat.START);
 265         } else {
 266             super.onBackPressed();
 267         }
 268     }
 269 
 270     private void setTitleWithCustomFont(CharSequence title) {
 271         if (getSupportActionBar() == null) return;
 272 
 273         // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 274         if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 275                 &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 276             getSupportActionBar().setTitle(title);
 277             return;
 278         }
 279 
 280         SpannableString s = new SpannableString(title);
 281         s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 282         getSupportActionBar().setTitle(s);
 283     }
 284 
 285     private void configureNavigationDrawer(Toolbar toolbar) {
 286         mDrawerLayout = findViewById(R.id.drawer_layout);
 287         mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 288         mNavigationView = findViewById(R.id.navigation_view);
 289         mDrawerList = findViewById(R.id.drawer_list);
 290         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 291             mNavigationView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {
 292                 @Override
 293                 @SuppressLint(&quot;NewApi&quot;)
 294                 public WindowInsets onApplyWindowInsets(View view, WindowInsets windowInsets) {
 295                     LinearLayout drawerView = findViewById(R.id.drawer_view);
<abbr title=" 296                     drawerView.setPadding(drawerView.getPaddingLeft(), windowInsets.getSystemWindowInsetTop(), drawerView.getPaddingRight(), drawerView.getPaddingBottom());"> 296                     drawerView.setPadding(drawerView.getPaddingLeft(), windowInsets.getSystemWindowInsetTðŸ”µ</abbr>
 297                     return windowInsets.consumeSystemWindowInsets();
 298                 }
 299             });
 300         }
 301         View settingsButton = findViewById(R.id.nav_settings);
 302         settingsButton.setOnClickListener(new View.OnClickListener() {
 303             @Override
 304             public void onClick(View v) {
 305                 Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 306                 startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 307             }
 308         });
 309         mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 310         mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 311         mDrawerList.setAdapter(mTagsAdapter);
 312         // Set the list&#x27;s click listener
 313         mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 314         if (mSelectedTag == null) {
 315             mSelectedTag = mTagsAdapter.getDefaultItem();
 316         }
<abbr title=" 317         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer, R.string.close_drawer) {"> 317         mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer, R.sðŸ”µ</abbr>
 318             public void onDrawerClosed(View view) {
 319                 supportInvalidateOptionsMenu();
 320             }
 321 
 322             public void onDrawerOpened(View drawerView) {
 323                 // noop
 324             }
 325 
 326             @Override
 327             public void onDrawerSlide(View drawerView, float slideOffset) {
 328                 super.onDrawerSlide(drawerView, 0.0F);
 329             }
 330         };
 331         mDrawerLayout.addDrawerListener(mDrawerToggle);
 332     }
 333 
 334     private void checkForFirstLaunch() {
 335         if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 336             // Create the welcome note
 337             try {
 338                 Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 339                 welcomeNote.setCreationDate(Calendar.getInstance());
 340                 welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 341                 welcomeNote.setContent(getString(R.string.welcome_note));
 342                 welcomeNote.getTitle();
 343                 welcomeNote.save();
 344             } catch (BucketObjectNameInvalid e) {
 345                 // this won&#x27;t happen because welcome-android is a valid name
 346             }
 347 
 348             SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 349             SharedPreferences.Editor editor = preferences.edit();
 350             editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 351             editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 352             editor.apply();
 353         }
 354     }
 355 
 356     private void checkForSharedContent() {
 357         if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 358             // Check share action
 359             Intent intent = getIntent();
 360             String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 361             String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 362 
<abbr title=" 363             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search"> 363             // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice searðŸ”µ</abbr>
 364             String intentAction = StrUtils.notNullStr(intent.getAction());
 365             boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 366             if (!TextUtils.isEmpty(text)) {
 367                 if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 368                     text = subject + &quot;\n\n&quot; + text;
 369                 }
 370                 Note note = mNotesBucket.newObject();
 371                 note.setCreationDate(Calendar.getInstance());
 372                 note.setModificationDate(note.getCreationDate());
 373                 note.setContent(text);
 374                 note.save();
 375                 setCurrentNote(note);
 376                 mShouldSelectNewNote = true;
 377 
 378                 AnalyticsTracker.track(
 379                         AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 380                         AnalyticsTracker.CATEGORY_NOTE,
 381                         &quot;external_share&quot;
 382                 );
 383 
 384                 if (!DisplayUtils.isLargeScreenLandscape(this)) {
 385                     // Disable the lock screen when sharing content and opening NoteEditorActivity
 386                     // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 387                     if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 388                         AppLockManager.getInstance().getAppLock().setExemptActivities(
 389                                 new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 390                                         &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 391                         AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 392                     }
 393                 }
 394             }
 395         }
 396     }
 397 
 398     private void updateNavigationDrawerItems() {
 399         boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 400         Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 401         if (isAlphaSort) {
 402             tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 403         } else {
 404             tagCursor = Tag.allWithName(mTagsBucket).execute();
 405         }
 406 
 407         mTagsAdapter.changeCursor(tagCursor);
 408     }
 409 
 410     private void setSelectedTagActive() {
 411         if (mSelectedTag == null)
 412             mSelectedTag = mTagsAdapter.getDefaultItem();
 413 
 414         setTitle(mSelectedTag.name);
<abbr title=" 415         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 415         mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCouðŸ”µ</abbr>
 416     }
 417 
 418     public TagsAdapter.TagMenuItem getSelectedTag() {
 419         if (mSelectedTag == null) {
 420             mSelectedTag = mTagsAdapter.getDefaultItem();
 421         }
 422 
 423         return mSelectedTag;
 424     }
 425 
 426     // Enable or disable the trash action bar button depending on if there are deleted notes or not
 427     public void updateTrashMenuItem() {
 428         if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 429             return;
 430 
 431         // Disable the trash icon if there are no notes trashed.
 432         Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 433         if (query.count() == 0) {
 434             mEmptyTrashMenuItem.setEnabled(false);
 435         } else {
 436             mEmptyTrashMenuItem.setEnabled(true);
 437         }
 438     }
 439 
 440     private void addEditorFragment() {
 441         FragmentManager fm = getSupportFragmentManager();
 442         FragmentTransaction ft = fm.beginTransaction();
 443         mNoteEditorFragment = new NoteEditorFragment();
 444         ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 445         ft.commitAllowingStateLoss();
 446         fm.executePendingTransactions();
 447     }
 448 
 449     private boolean userAccountRequired() {
 450         return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 451     }
 452 
 453     /**
 454      * Checks for a previously valid user that is now not authenticated
 455      * Also checks if user account is required (added in version 1.5.6)
 456      *
 457      * @return true if user has invalid authorization
 458      */
 459     private boolean userAuthenticationIsInvalid() {
 460         Simplenote currentApp = (Simplenote) getApplication();
 461         Simperium simperium = currentApp.getSimperium();
 462         User user = simperium.getUser();
 463         boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 464         return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 465                 (userAccountRequired() &amp;&amp; isNotAuthorized);
 466     }
 467 
 468     public boolean userIsUnauthorized() {
 469         Simplenote currentApp = (Simplenote) getApplication();
 470         return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 471     }
 472 
 473     public void setCurrentNote(Note note) {
 474         mCurrentNote = note;
 475     }
 476 
 477     public NoteListFragment getNoteListFragment() {
 478         return mNoteListFragment;
 479     }
 480 
 481     @SuppressWarnings(&quot;ResourceType&quot;)
 482     @Override
 483     public boolean onCreateOptionsMenu(Menu menu) {
 484         super.onCreateOptionsMenu(menu);
 485         MenuInflater inflater = getMenuInflater();
 486         inflater.inflate(R.menu.notes_list, menu);
 487         // restore the search query if on a landscape tablet
 488         String searchQuery = null;
 489         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; (mSearchView != null)) {
 490             searchQuery = mSearchView.getQuery().toString();
 491         }
 492         mSearchMenuItem = menu.findItem(R.id.menu_search);
 493         mSearchView = ((SearchView) (mSearchMenuItem.getActionView()));
 494         if (!TextUtils.isEmpty(searchQuery)) {
 495             mSearchView.setQuery(searchQuery, false);
 496             mSearchMenuItem.expandActionView();
 497         } else {
 498             // Workaround for setting the search placeholder text color
<abbr title=" 499             String hintHexColor = (ThemeUtils.isLightTheme(this) ? getString(R.color.gray_light) : getString(R.color.text_preview)).replace(&quot;ff&quot;, &quot;&quot;);"> 499             String hintHexColor = (ThemeUtils.isLightTheme(this) ? getString(R.color.gray_light) : getStrðŸ”µ</abbr>
<abbr title=" 500             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hintHexColor, getString(R.string.search))));"> 500             mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;, hiðŸ”µ</abbr>
 501         }
 502         mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 503             @Override
 504             public boolean onQueryTextChange(String newText) {
 505                 if (mSearchMenuItem.isActionViewExpanded()) {
 506                     getNoteListFragment().searchNotes(newText);
 507                 }
 508                 return true;
 509             }
 510 
 511             @Override
 512             public boolean onQueryTextSubmit(String queryText) {
 513                 getNoteListFragment().searchNotes(queryText);
 514                 return true;
 515             }
 516         });
 517         mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 518             @Override
 519             public boolean onMenuItemActionExpand(MenuItem menuItem) {
 520                 checkEmptyListText(true);
 521                 if (mNoteListFragment != null) {
 522                     mNoteListFragment.setFloatingActionButtonVisible(false);
 523                 }
 524                 AnalyticsTracker.track(
 525                         AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 526                         AnalyticsTracker.CATEGORY_NOTE,
 527                         &quot;action_bar_search_tap&quot;
 528                 );
 529                 return true;
 530             }
 531 
 532             @Override
 533             public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 534                 // Show all notes again
 535                 if (mNoteListFragment != null) {
 536                     mNoteListFragment.setFloatingActionButtonVisible(true);
 537                 }
 538                 mTabletSearchQuery = &quot;&quot;;
 539                 mSearchView.setQuery(&quot;&quot;, false);
 540                 checkEmptyListText(false);
 541                 getNoteListFragment().clearSearch();
 542                 return true;
 543             }
 544         });
 545         mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 546             @Override
 547             public boolean onMenuItemClick(MenuItem item) {
 548                 if (!mSearchMenuItem.isActionViewExpanded()) {
 549                     showDetailPlaceholder();
 550                 }
 551                 return false;
 552             }
 553         });
 554         MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 555         if ((mCurrentNote != null) &amp;&amp; mCurrentNote.isDeleted()) {
 556             trashItem.setTitle(R.string.undelete);
 557             trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 558         } else {
 559             trashItem.setTitle(R.string.delete);
 560             trashItem.setIcon(R.drawable.ic_trash_24dp);
 561         }
 562         if (DisplayUtils.isLargeScreenLandscape(this)) {
 563             // Restore the search query on landscape tablets
 564             if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 565                 mSearchMenuItem.expandActionView();
 566                 mSearchView.setQuery(mTabletSearchQuery, false);
 567                 mSearchView.clearFocus();
 568             }
 569             if (mCurrentNote != null) {
 570                 menu.findItem(R.id.menu_share).setVisible(true);
 571                 menu.findItem(R.id.menu_view_info).setVisible(true);
 572                 menu.findItem(R.id.menu_checklist).setVisible(true);
 573                 menu.findItem(R.id.menu_history).setVisible(true);
 574                 menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 575                 trashItem.setVisible(true);
 576             } else {
 577                 menu.findItem(R.id.menu_share).setVisible(false);
 578                 menu.findItem(R.id.menu_view_info).setVisible(false);
 579                 menu.findItem(R.id.menu_checklist).setVisible(false);
 580                 menu.findItem(R.id.menu_history).setVisible(false);
 581                 menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 582                 trashItem.setVisible(false);
 583             }
 584             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 585         } else {
 586             menu.findItem(R.id.menu_search).setVisible(true);
 587             menu.findItem(R.id.menu_share).setVisible(false);
 588             menu.findItem(R.id.menu_view_info).setVisible(false);
 589             menu.findItem(R.id.menu_checklist).setVisible(false);
 590             menu.findItem(R.id.menu_history).setVisible(false);
 591             menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 592             trashItem.setVisible(false);
 593             menu.findItem(R.id.menu_empty_trash).setVisible(false);
 594         }
 595         // Are we looking at the trash? Adjust menu accordingly.
 596         if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 597             mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 598             mEmptyTrashMenuItem.setVisible(true);
 599             updateTrashMenuItem();
 600             menu.findItem(R.id.menu_search).setVisible(false);
 601             menu.findItem(R.id.menu_share).setVisible(false);
 602             menu.findItem(R.id.menu_history).setVisible(false);
 603             menu.findItem(R.id.menu_checklist).setVisible(false);
 604         }
 605         DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 606         return true;
 607     }
 608 
 609     @Override
 610     public boolean onOptionsItemSelected(MenuItem item) {
 611         if (mDrawerToggle.onOptionsItemSelected(item)) {
 612             return true;
 613         }
 614         switch (item.getItemId()) {
 615             case R.id.menu_markdown_preview:
 616                 if (mIsShowingMarkdown) {
 617                     item.setIcon(R.drawable.ic_preview_24dp);
 618                     item.setTitle(getString(R.string.markdown_show));
 619                     setMarkdownShowing(false);
 620                 } else {
 621                     item.setIcon(R.drawable.ic_preview_stop_24dp);
 622                     item.setTitle(getString(R.string.markdown_hide));
 623                     setMarkdownShowing(true);
 624                 }
 625 
 626                 DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 627 
 628                 return true;
 629             case R.id.menu_delete:
 630                 if (mNoteEditorFragment != null) {
 631                     if (mCurrentNote != null) {
 632                         mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 633                         mCurrentNote.setModificationDate(Calendar.getInstance());
 634                         mCurrentNote.save();
 635 
 636                         updateViewsAfterTrashAction(mCurrentNote);
 637                     }
 638                 }
 639                 return true;
 640             case R.id.menu_empty_trash:
 641                 AlertDialog.Builder alert = new AlertDialog.Builder(this);
 642 
 643                 alert.setTitle(R.string.empty_trash);
 644                 alert.setMessage(R.string.confirm_empty_trash);
 645                 alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 646                     public void onClick(DialogInterface dialog, int whichButton) {
 647                         new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 648                         AnalyticsTracker.track(
 649                                 AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 650                                 AnalyticsTracker.CATEGORY_NOTE,
 651                                 &quot;overflow_menu&quot;
 652                         );
 653                     }
 654                 });
 655                 alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 656                     public void onClick(DialogInterface dialog, int whichButton) {
 657                         // Do nothing, just closing the dialog
 658                     }
 659                 });
 660                 alert.show();
 661                 return true;
 662             case android.R.id.home:
 663                 invalidateOptionsMenu();
 664                 return true;
 665             default:
 666                 return super.onOptionsItemSelected(item);
 667         }
 668     }
 669 
 670     @Override
 671     public boolean onPrepareOptionsMenu(Menu menu) {
 672         MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 673 
 674         if (mIsShowingMarkdown) {
 675             markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 676             markdownItem.setTitle(getString(R.string.markdown_hide));
 677         } else {
 678             markdownItem.setIcon(R.drawable.ic_preview_24dp);
 679             markdownItem.setTitle(getString(R.string.markdown_show));
 680         }
 681 
 682         DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 683 
 684         return super.onPrepareOptionsMenu(menu);
 685     }
 686 
 687     public void updateViewsAfterTrashAction(Note note) {
 688         if (note == null || isFinishing()) {
 689             return;
 690         }
 691 
 692         if (note.isDeleted()) {
 693             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 694             deletedNoteIds.add(note.getSimperiumKey());
 695             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 696             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 697             AnalyticsTracker.track(
 698                     AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 699                     AnalyticsTracker.CATEGORY_NOTE,
 700                     &quot;overflow_menu&quot;
 701             );
 702         } else {
 703             AnalyticsTracker.track(
 704                     AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 705                     AnalyticsTracker.CATEGORY_NOTE,
 706                     &quot;overflow_menu&quot;
 707             );
 708         }
 709 
 710         // If we just deleted/restored the active note, show the placeholder
 711         if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 712             showDetailPlaceholder();
 713         }
 714 
 715         NoteListFragment fragment = getNoteListFragment();
 716         if (fragment != null) {
 717             fragment.getPrefs();
 718             fragment.refreshList();
 719         }
 720 
 721         invalidateOptionsMenu();
 722     }
 723 
 724     public void setMarkdownShowing(boolean isMarkdownShowing) {
 725         mIsShowingMarkdown = isMarkdownShowing;
 726         if (mNoteEditorFragment != null) {
 727             if (isMarkdownShowing) {
 728                 mNoteEditorFragment.showMarkdown();
 729             } else {
 730                 mNoteEditorFragment.hideMarkdown();
 731             }
 732         }
 733         invalidateOptionsMenu();
 734     }
 735 
 736     /**
 737      * Callback method from {@link NoteListFragment.Callbacks} indicating that
 738      * the item with the given ID was selected. Used for tablets only.
 739      */
 740     @Override
<abbr title=" 741     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {"> 741     public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnableðŸ”µ</abbr>
 742         if (!DisplayUtils.isLargeScreenLandscape(this)) {
 743             // Launch the editor activity
 744             Bundle arguments = new Bundle();
 745             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 746             arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 747 
 748             if (matchOffsets != null)
 749                 arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 750 
 751             Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 752             editNoteIntent.putExtras(arguments);
 753             startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 754         } else {
 755             mNoteEditorFragment.setNote(noteID, matchOffsets);
 756             getNoteListFragment().setNoteSelected(noteID);
 757 
 758             if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 759                 mTabletSearchQuery = mSearchView.getQuery().toString();
 760             }
 761 
 762             mNoteEditorFragment.clearMarkdown();
 763 
 764             if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 765                 setMarkdownShowing(false);
 766             }
 767 
 768             invalidateOptionsMenu();
 769         }
 770 
 771         AnalyticsTracker.track(
 772                 AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 773                 AnalyticsTracker.CATEGORY_NOTE,
 774                 &quot;note_list_row_tap&quot;
 775         );
 776     }
 777 
 778     @Override
 779     public void onUserCreated(User user) {
 780         // New account created
 781         AnalyticsTracker.track(
 782                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 783                 AnalyticsTracker.CATEGORY_USER,
 784                 &quot;account_created_from_login_activity&quot;
 785         );
 786     }
 787 
 788     public void onUserStatusChange(User.Status status) {
 789         switch (status) {
 790             // successfully used access token to connect to simperium bucket
 791             case AUTHORIZED:
 792                 runOnUiThread(new Runnable() {
 793                     @Override
 794                     public void run() {
 795                         if (!mNotesBucket.hasChangeVersion()) {
 796                             setToolbarProgressVisibility(true);
 797                         }
 798                     }
 799                 });
 800                 break;
 801 
 802             // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 803             case NOT_AUTHORIZED:
 804                 runOnUiThread(new Runnable() {
 805                     @Override
 806                     public void run() {
 807                         startLoginActivity(true);
 808                     }
 809                 });
 810                 break;
 811 
<abbr title=" 812             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 812             // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in ðŸ”µ</abbr>
 813             case UNKNOWN:
 814                 break;
 815         }
 816     }
 817 
 818     private void setToolbarProgressVisibility(boolean isVisible) {
 819         if (getSupportActionBar() != null) {
 820             getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 821         }
 822     }
 823 
 824     public void startLoginActivity(boolean signInFirst) {
 825         // Clear some account-specific prefs
 826         SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 827         editor.remove(PrefUtils.PREF_WP_TOKEN);
 828         editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 829         editor.apply();
 830 
 831         Intent loginIntent = new Intent(this, SignInActivity.class);
 832         if (signInFirst) {
 833             loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 834         }
 835         startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 836     }
 837 
 838     @Override
 839     public void recreate() {
 840         Handler handler = new Handler();
 841         handler.post(new Runnable() {
 842             @Override
 843             public void run() {
 844                 NotesActivity.super.recreate();
 845             }
 846         });
 847     }
 848 
 849     @Override
 850     protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 851         super.onActivityResult(requestCode, resultCode, data);
 852         switch (requestCode) {
 853             case Simplenote.INTENT_PREFERENCES:
 854                 if (ThemeUtils.themeWasChanged(data)) {
 855                     // Restart this activity to apply the new theme
 856                     recreate();
 857                     break;
 858                 }
<abbr title=" 859                 // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 859                 // nbradbury - refresh note list when user returns from preferences (in case they changedðŸ”µ</abbr>
 860                 invalidateOptionsMenu();
 861                 NoteListFragment fragment = getNoteListFragment();
 862                 if (fragment != null) {
 863                     fragment.getPrefs();
 864                     fragment.refreshList();
 865                 }
 866 
 867                 break;
 868             case Simplenote.INTENT_EDIT_NOTE:
 869                 if (resultCode == RESULT_OK &amp;&amp; data != null) {
 870                     if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 871                         String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 872                         if (noteId != null) {
 873                             List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 874                             deletedNoteIds.add(noteId);
 875                             mUndoBarController.setDeletedNoteIds(deletedNoteIds);
<abbr title=" 876                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));"> 876                             mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deletedðŸ”µ</abbr>
 877                         }
<abbr title=" 878                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 878                     } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELEðŸ”µ</abbr>
 879                         String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 880                         mNoteListFragment.setNoteSelected(selectedNoteId);
 881                         if (mNoteEditorFragment != null) {
 882                             mNoteEditorFragment.setNote(selectedNoteId);
 883                         }
 884                     }
 885                 }
 886                 break;
 887             case Simperium.SIGNUP_SIGNIN_REQUEST:
 888                 invalidateOptionsMenu();
 889 
 890                 Simplenote app = (Simplenote) getApplication();
 891                 AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 892 
 893                 AnalyticsTracker.track(
 894                         AnalyticsTracker.Stat.USER_SIGNED_IN,
 895                         AnalyticsTracker.CATEGORY_USER,
 896                         &quot;signed_in_from_login_activity&quot;
 897                 );
 898 
 899                 if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 900                     finish();
 901                 }
 902 
 903                 break;
 904         }
 905     }
 906 
 907     @Override
 908     public void onUndo() {
 909         if (mUndoBarController == null) return;
 910 
 911         List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 912         if (deletedNoteIds != null) {
 913             for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 914                 Note deletedNote;
 915                 try {
 916                     deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 917                 } catch (BucketObjectMissingException e) {
 918                     return;
 919                 }
 920                 if (deletedNote != null) {
 921                     deletedNote.setDeleted(false);
 922                     deletedNote.setModificationDate(Calendar.getInstance());
 923                     deletedNote.save();
 924                     NoteListFragment fragment = getNoteListFragment();
 925                     if (fragment != null) {
 926                         fragment.getPrefs();
 927                         fragment.refreshList();
 928                     }
 929                 }
 930             }
 931         }
 932     }
 933 
 934     @Override
 935     protected void onPostCreate(Bundle savedInstanceState) {
 936         super.onPostCreate(savedInstanceState);
 937         // Sync the toggle state after onRestoreInstanceState has occurred.
 938         mDrawerToggle.syncState();
 939     }
 940 
 941     @Override
 942     public void onConfigurationChanged(Configuration newConfig) {
 943         super.onConfigurationChanged(newConfig);
 944 
 945         mDrawerToggle.onConfigurationChanged(newConfig);
 946 
 947         if (DisplayUtils.isLargeScreen(this)) {
 948             mIsShowingMarkdown = false;
 949 
 950             if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 951                 // Add the editor fragment
 952                 if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 953                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 953                     mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByðŸ”µ</abbr>
 954                 } else if (DisplayUtils.isLandscape(this)) {
 955                     addEditorFragment();
 956                 }
 957                 if (mNoteListFragment != null) {
 958                     mNoteListFragment.setActivateOnItemClick(true);
 959                     mNoteListFragment.setDividerVisible(true);
 960                 }
 961                 // Select the current note on a tablet
 962                 if (mCurrentNote != null)
<abbr title=" 963                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());"> 963                     onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnableðŸ”µ</abbr>
 964                 else {
 965                     mNoteEditorFragment.setPlaceholderVisible(true);
 966                     mNoteListFragment.getListView().clearChoices();
 967                 }
 968                 invalidateOptionsMenu();
 969             }
 970         }
 971 
 972         if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
 973             // Remove the editor fragment when rotating back to portrait
 974             mCurrentNote = null;
 975             if (mNoteListFragment != null) {
 976                 mNoteListFragment.setActivateOnItemClick(false);
 977                 mNoteListFragment.setDividerVisible(false);
 978                 mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 979                 mNoteListFragment.refreshList();
 980             }
 981             FragmentManager fm = getSupportFragmentManager();
 982             FragmentTransaction ft = fm.beginTransaction();
 983             ft.remove(mNoteEditorFragment);
 984             mNoteEditorFragment = null;
 985             ft.commitAllowingStateLoss();
 986             fm.executePendingTransactions();
 987             invalidateOptionsMenu();
 988         }
 989     }
 990 
 991     public void checkEmptyListText(boolean isSearch) {
 992         if (isSearch) {
<abbr title=" 993             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);"> 993             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;ðŸ”µ</abbr>
 994             getNoteListFragment().setEmptyListViewClickable(false);
 995         } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title=" 996             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);"> 996             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;ðŸ”µ</abbr>
 997             AnalyticsTracker.track(
 998                     AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
 999                     AnalyticsTracker.CATEGORY_NOTE,
1000                     &quot;trash_filter_selected&quot;
1001             );
1002             getNoteListFragment().setEmptyListViewClickable(false);
1003         } else {
<abbr title="1004             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1004             getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;ðŸ”µ</abbr>
1005             getNoteListFragment().setEmptyListViewClickable(true);
1006         }
1007     }
1008 
1009     public void showDetailPlaceholder() {
1010         if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1011             mCurrentNote = null;
1012             mNoteEditorFragment.setPlaceholderVisible(true);
1013             mNoteEditorFragment.clearMarkdown();
1014             mNoteEditorFragment.hideMarkdown();
1015             mIsShowingMarkdown = false;
1016         }
1017     }
1018 
1019     public void stopListeningToNotesBucket() {
1020         mNotesBucket.removeOnNetworkChangeListener(this);
1021         mNotesBucket.removeOnSaveObjectListener(this);
1022         mNotesBucket.removeOnDeleteObjectListener(this);
1023     }
1024 
1025     // Returns the appropriate view to show the undo bar within
1026     private View getUndoView() {
1027         View undoView = mFragmentsContainer;
1028         if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1029                 getNoteListFragment() != null &amp;&amp;
1030                 getNoteListFragment().getRootView() != null) {
1031             undoView = getNoteListFragment().getRootView();
1032         }
1033 
1034         return undoView;
1035     }
1036 
1037     public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1038         if (mUndoBarController != null) {
1039             mUndoBarController.setDeletedNoteIds(noteIds);
1040             mUndoBarController.showUndoBar(
1041                     getUndoView(),
<abbr title="1042                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())">1042                     getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.sizðŸ”µ</abbr>
1043             );
1044         }
1045     }
1046 
1047     /* Simperium Bucket Listeners */
1048     // received a change from the network, refresh the list
1049     @Override
1050     public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1051         runOnUiThread(new Runnable() {
1052             @Override
1053             public void run() {
1054                 if (type == Bucket.ChangeType.INDEX) {
1055                     setToolbarProgressVisibility(false);
1056                 }
1057                 mNoteListFragment.refreshList();
1058             }
1059         });
1060     }
1061 
1062     @Override
1063     public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1064         runOnUiThread(new Runnable() {
1065             @Override
1066             public void run() {
1067                 mNoteListFragment.refreshList();
1068             }
1069         });
1070     }
1071 
1072     @Override
1073     public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1074         runOnUiThread(new Runnable() {
1075             @Override
1076             public void run() {
1077                 mNoteListFragment.refreshList();
1078             }
1079         });
1080     }
1081 
1082     @Override
1083     public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1084         // noop, NoteEditorFragment will handle this
1085     }
1086 
1087     /* The click listener for ListView in the navigation drawer */
1088     private class DrawerItemClickListener implements ListView.OnItemClickListener {
1089         @Override
1090         public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1091             // Adjust for header view
1092             position -= mDrawerList.getHeaderViewsCount();
1093             mSelectedTag = mTagsAdapter.getItem(position);
1094             checkEmptyListText(false);
1095             // Update checked item in navigation drawer and close it
1096             setSelectedTagActive();
1097             mDrawerLayout.closeDrawer(mNavigationView);
1098             updateNavigationDrawerItems();
1099             // Disable long press on notes if we&#x27;re viewing the trash
1100             if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1101                 getNoteListFragment().getListView().setLongClickable(false);
1102             } else {
1103                 getNoteListFragment().getListView().setLongClickable(true);
1104             }
1105             getNoteListFragment().refreshListFromNavSelect();
1106             if (position &gt; 1) {
<abbr title="1107                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TAG_VIEWED, AnalyticsTracker.CATEGORY_TAG, &quot;selected_tag_in_navigation_drawer&quot;);">1107                 AnalyticsTracker.track(AnalyticsTracker.Stat.LIST_TAG_VIEWED, AnalyticsTracker.CATEGORY_TðŸ”µ</abbr>
1108             }
1109         }
1110     }
1111 
1112     private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1113         @Override
1114         protected Void doInBackground(Void... voids) {
1115             if (mNotesBucket == null) {
1116                 return null;
1117             }
1118             Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1119             Bucket.ObjectCursor c = query.execute();
1120             while (c.moveToNext()) {
1121                 c.getObject().delete();
1122             }
1123             return null;
1124         }
1125 
1126         @Override
1127         protected void onPostExecute(Void nada) {
1128             showDetailPlaceholder();
1129         }
1130     }
1131 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  

   3  import android.app.Activity;
   4  import android.app.AlertDialog;
   5  import android.content.DialogInterface;
   6  import android.content.Intent;
   7  import android.content.SharedPreferences;
   8  import android.content.res.Configuration;
   9  import android.os.AsyncTask;
  10  import android.os.Build;
  11  import android.os.Bundle;
  12  import android.os.Handler;
  13  import android.support.design.widget.NavigationView;
  14  import android.support.v4.app.FragmentManager;
  15  import android.support.v4.app.FragmentTransaction;
  16  import android.support.v4.content.ContextCompat;
  17  import android.support.v4.view.GravityCompat;
  18  import android.support.v4.widget.DrawerLayout;
  19  import android.support.v7.app.ActionBar;
  20  import android.support.v7.app.ActionBarDrawerToggle;
  21  import android.support.v7.app.AppCompatActivity;
  22  import android.support.v7.preference.PreferenceManager;
  23  import android.support.v7.widget.SearchView;
  24  import android.support.v7.widget.Toolbar;
  25  import android.text.Spannable;
  26  import android.text.SpannableString;
  27  import android.text.TextUtils;
  28  import android.view.Menu;
  29  import android.view.MenuInflater;
  30  import android.view.MenuItem;
  31  import android.view.View;

  32  import android.view.WindowManager;
  33  import android.widget.AdapterView;

  34  import android.widget.ListView;
  35  import android.widget.ProgressBar;
  36  
  37  import com.automattic.simplenote.analytics.AnalyticsTracker;
  38  import com.automattic.simplenote.models.Note;
  39  import com.automattic.simplenote.models.Tag;
  40  import com.automattic.simplenote.utils.DisplayUtils;
  41  import com.automattic.simplenote.utils.DrawableUtils;
  42  import com.automattic.simplenote.utils.HtmlCompat;
  43  import com.automattic.simplenote.utils.PrefUtils;
  44  import com.automattic.simplenote.utils.StrUtils;
  45  import com.automattic.simplenote.utils.TagsAdapter;
  46  import com.automattic.simplenote.utils.ThemeUtils;
  47  import com.automattic.simplenote.utils.UndoBarController;
  48  import com.automattic.simplenote.widgets.TypefaceSpan;
  49  import com.simperium.Simperium;
  50  import com.simperium.client.Bucket;
  51  import com.simperium.client.BucketObjectMissingException;
  52  import com.simperium.client.BucketObjectNameInvalid;
  53  import com.simperium.client.Query;
  54  import com.simperium.client.User;
  55  
  56  import org.wordpress.passcodelock.AppLockManager;
  57  
  58  import java.util.ArrayList;
  59  import java.util.Calendar;
  60  import java.util.List;
  61  
  62  import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  63  
  64  public class NotesActivity extends AppCompatActivity implements
<abbr title="  65          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  65          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  66          Bucket.Listener&lt;Note&gt; {
  67  
  68      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  69      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  70      protected Bucket&lt;Note&gt; mNotesBucket;
  71      protected Bucket&lt;Tag&gt; mTagsBucket;
  72      private int TRASH_SELECTED_ID = 1;
  73      private boolean mIsShowingMarkdown;
  74      private boolean mShouldSelectNewNote;
  75  
  76      private String mTabletSearchQuery;
  77      private UndoBarController mUndoBarController;
  78      private View mFragmentsContainer;
  79      private SearchView mSearchView;
  80      private MenuItem mSearchMenuItem;
  81      private NoteListFragment mNoteListFragment;
  82      private NoteEditorFragment mNoteEditorFragment;
  83      private Note mCurrentNote;
  84      private MenuItem mEmptyTrashMenuItem;
  85  
  86      // Menu drawer
  87      private DrawerLayout mDrawerLayout;
  88      private ListView mDrawerList;
  89      private NavigationView mNavigationView;
  90      private ActionBarDrawerToggle mDrawerToggle;
  91      private TagsAdapter mTagsAdapter;
  92      private TagsAdapter.TagMenuItem mSelectedTag;
  93      // Tags bucket listener
  94      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
  95          void updateNavigationDrawer() {
  96              runOnUiThread(new Runnable() {
  97                  public void run() {
  98                      updateNavigationDrawerItems();
  99                  }
 100              });
 101          }
 102  
 103          @Override
 104          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 105              updateNavigationDrawer();
 106          }
 107  
 108          @Override
 109          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 110              updateNavigationDrawer();
 111          }
 112  
 113          @Override
 114          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 115              updateNavigationDrawer();
 116          }
 117  
 118          @Override
 119          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 120              // noop
 121          }
 122      };
 123  
 124      @Override
 125      protected void onCreate(Bundle savedInstanceState) {
 126          // On lollipop, configure the translucent status bar
 127          if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 128              getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -            getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +            getWindow().setStatusBarColor(ContextCompat.getColor(this, android.R.color.transparent));</span>
 131          }
 132  
 133          ThemeUtils.setTheme(this);
 134          super.onCreate(savedInstanceState);
 135  
 136          setContentView(R.layout.activity_notes);
 137  
 138          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 139  
 140          Simplenote currentApp = (Simplenote) getApplication();
 141          if (mNotesBucket == null) {
 142              mNotesBucket = currentApp.getNotesBucket();
 143          }
 144  
 145          if (mTagsBucket == null) {
 146              mTagsBucket = currentApp.getTagsBucket();
 147          }
 148  
 149          Toolbar toolbar = findViewById(R.id.toolbar);
 150          setSupportActionBar(toolbar);
 151          configureNavigationDrawer(toolbar);
 152  
 153          if (savedInstanceState == null) {
 154              mNoteListFragment = new NoteListFragment();
 155              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 156              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 157              fragmentTransaction.commit();
 158          } else {
 159              mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 160          }
 161  
 162          if (DisplayUtils.isLargeScreen(this)) {
 163              if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 164                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 164                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr>
 165              } else if (DisplayUtils.isLandscape(this)) {
 166                  addEditorFragment();
 167              }
 168          }
 169  
 170          // enable ActionBar app icon to behave as action to toggle nav drawer
 171          ActionBar actionBar = getSupportActionBar();
 172          if (actionBar != null) {
 173              actionBar.setDisplayHomeAsUpEnabled(true);
 174              actionBar.setHomeButtonEnabled(true);
 175  
 176              // Add loading indicator to show when indexing
<abbr title=" 177              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 177              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 178              actionBar.setDisplayShowCustomEnabled(true);
 179              actionBar.setCustomView(progressBar);
 180              setToolbarProgressVisibility(false);
 181          }
 182  
 183          mUndoBarController = new UndoBarController(this);
 184  
 185          // Creates &#x27;Welcome&#x27; note
 186          checkForFirstLaunch();
 187  
 188          checkForSharedContent();
 189  
 190          currentApp.getSimperium().setOnUserCreatedListener(this);
 191          currentApp.getSimperium().setUserStatusChangeListener(this);
 192      }
 193  
 194      @Override
 195      protected void onResume() {
 196          super.onResume();
 197  
 198          // Ensure user has valid authorization
 199          if (userAuthenticationIsInvalid()) {
 200              startLoginActivity(true);
 201          }
 202  
 203          disableScreenshotsIfLocked(this);
 204  
 205          mNotesBucket.start();
 206          mTagsBucket.start();
 207  
 208          mNotesBucket.addOnNetworkChangeListener(this);
 209          mNotesBucket.addOnSaveObjectListener(this);
 210          mNotesBucket.addOnDeleteObjectListener(this);
 211          mTagsBucket.addListener(mTagsMenuUpdater);
 212  
 213          updateNavigationDrawerItems();
 214  
 215          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 216          if (userIsUnauthorized()) {
 217              if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 218                  mSelectedTag = null;
 219                  mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 220              }
 221          }
 222  
 223          setSelectedTagActive();
 224  
 225          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 226              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 227              mShouldSelectNewNote = false;
 228          }
 229  
 230          if (mIsShowingMarkdown) {
 231              setMarkdownShowing(false);
 232          }
 233  
 234      }
 235  
 236      @Override
 237      protected void onPause() {
 238          super.onPause();  // Always call the superclass method first
 239          mTagsBucket.removeListener(mTagsMenuUpdater);
 240          mTagsBucket.stop();
 241  
 242          mNotesBucket.removeOnNetworkChangeListener(this);
 243          mNotesBucket.removeOnSaveObjectListener(this);
 244          mNotesBucket.removeOnDeleteObjectListener(this);
 245          mNotesBucket.stop();
 246      }
 247  
 248      @Override
 249      public void setTitle(CharSequence title) {
 250          if (title == null) {
 251              title = &quot;&quot;;
 252          }
 253  
 254          setTitleWithCustomFont(title);
 255      }
 256  
 257      @Override
 258      public void onBackPressed() {
 259          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 260              mDrawerLayout.closeDrawer(GravityCompat.START);
 261          } else {
 262              super.onBackPressed();
 263          }
 264      }
 265  
 266      private void setTitleWithCustomFont(CharSequence title) {
 267          if (getSupportActionBar() == null) return;
 268  
 269          // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 270          if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 271                  &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 272              getSupportActionBar().setTitle(title);
 273              return;
 274          }
 275  
 276          SpannableString s = new SpannableString(title);
 277          s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 278          getSupportActionBar().setTitle(s);
 279      }
 280  
 281      private void configureNavigationDrawer(Toolbar toolbar) {
 282          mDrawerLayout = findViewById(R.id.drawer_layout);
 283          mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 284          mNavigationView = findViewById(R.id.navigation_view);
 285          mDrawerList = findViewById(R.id.drawer_list);

















 286  
 287          View settingsButton = findViewById(R.id.nav_settings);
 288          settingsButton.setOnClickListener(new View.OnClickListener() {
 289              @Override
 290              public void onClick(View v) {
 291                  Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 292                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 293              }
 294          });
 295  
 296          mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 297          mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 298          mDrawerList.setAdapter(mTagsAdapter);
 299          // Set the list&#x27;s click listener
 300          mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 301  
 302          if (mSelectedTag == null)
 303              mSelectedTag = mTagsAdapter.getDefaultItem();
 304  
 305          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 306                  R.string.close_drawer) {
 307              public void onDrawerClosed(View view) {
 308                  supportInvalidateOptionsMenu();
 309              }
 310  
 311              public void onDrawerOpened(View drawerView) {
 312                  // noop
 313              }
 314  
 315              @Override
 316              public void onDrawerSlide(View drawerView, float slideOffset) {
 317                  super.onDrawerSlide(drawerView, 0f);
 318              }
 319          };
 320  
 321          mDrawerLayout.addDrawerListener(mDrawerToggle);
 322      }
 323  
 324      private void checkForFirstLaunch() {
 325          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 326              // Create the welcome note
 327              try {
 328                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 329                  welcomeNote.setCreationDate(Calendar.getInstance());
 330                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 331                  welcomeNote.setContent(getString(R.string.welcome_note));
 332                  welcomeNote.getTitle();
 333                  welcomeNote.save();
 334              } catch (BucketObjectNameInvalid e) {
 335                  // this won&#x27;t happen because welcome-android is a valid name
 336              }
 337  
 338              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 339              SharedPreferences.Editor editor = preferences.edit();
 340              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 341              editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 342              editor.apply();
 343          }
 344      }
 345  
 346      private void checkForSharedContent() {
 347          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 348              // Check share action
 349              Intent intent = getIntent();
 350              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 351              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 352  
 353              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 354              String intentAction = StrUtils.notNullStr(intent.getAction());
 355              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 356              if (!TextUtils.isEmpty(text)) {
 357                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 358                      text = subject + &quot;\n\n&quot; + text;
 359                  }
 360                  Note note = mNotesBucket.newObject();
 361                  note.setCreationDate(Calendar.getInstance());
 362                  note.setModificationDate(note.getCreationDate());
 363                  note.setContent(text);
 364                  note.save();
 365                  setCurrentNote(note);
 366                  mShouldSelectNewNote = true;
 367  
 368                  AnalyticsTracker.track(
 369                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 370                          AnalyticsTracker.CATEGORY_NOTE,
 371                          &quot;external_share&quot;
 372                  );
 373  
 374                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 375                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 376                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 377                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 378                          AppLockManager.getInstance().getAppLock().setExemptActivities(
 379                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 380                                          &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 381                          AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 382                      }
 383                  }
 384              }
 385          }
 386      }
 387  
 388      private void updateNavigationDrawerItems() {
 389          boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 390          Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 391          if (isAlphaSort) {
 392              tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 393          } else {
 394              tagCursor = Tag.allWithName(mTagsBucket).execute();
 395          }
 396  
 397          mTagsAdapter.changeCursor(tagCursor);
 398      }
 399  
 400      private void setSelectedTagActive() {
 401          if (mSelectedTag == null)
 402              mSelectedTag = mTagsAdapter.getDefaultItem();
 403  
 404          setTitle(mSelectedTag.name);
<abbr title=" 405          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 405          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), truðŸ”µ</abbr>
 406      }
 407  
 408      public TagsAdapter.TagMenuItem getSelectedTag() {
 409          if (mSelectedTag == null) {
 410              mSelectedTag = mTagsAdapter.getDefaultItem();
 411          }
 412  
 413          return mSelectedTag;
 414      }
 415  
 416      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 417      public void updateTrashMenuItem() {
 418          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 419              return;
 420  
 421          // Disable the trash icon if there are no notes trashed.
 422          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 423          if (query.count() == 0) {
 424              mEmptyTrashMenuItem.setEnabled(false);
 425          } else {
 426              mEmptyTrashMenuItem.setEnabled(true);
 427          }
 428      }
 429  
 430      private void addEditorFragment() {
 431          FragmentManager fm = getSupportFragmentManager();
 432          FragmentTransaction ft = fm.beginTransaction();
 433          mNoteEditorFragment = new NoteEditorFragment();
 434          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 435          ft.commitAllowingStateLoss();
 436          fm.executePendingTransactions();
 437      }
 438  
 439      private boolean userAccountRequired() {
 440          return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 441      }
 442  
 443      /**
 444       * Checks for a previously valid user that is now not authenticated
 445       * Also checks if user account is required (added in version 1.5.6)
 446       *
 447       * @return true if user has invalid authorization
 448       */
 449      private boolean userAuthenticationIsInvalid() {
 450          Simplenote currentApp = (Simplenote) getApplication();
 451          Simperium simperium = currentApp.getSimperium();
 452          User user = simperium.getUser();
 453          boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 454          return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 455                  (userAccountRequired() &amp;&amp; isNotAuthorized);
 456      }
 457  
 458      public boolean userIsUnauthorized() {
 459          Simplenote currentApp = (Simplenote) getApplication();
 460          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 461      }
 462  
 463      public void setCurrentNote(Note note) {
 464          mCurrentNote = note;
 465      }
 466  
 467      public NoteListFragment getNoteListFragment() {
 468          return mNoteListFragment;
 469      }
 470  
 471      @SuppressWarnings(&quot;ResourceType&quot;)
 472      @Override
 473      public boolean onCreateOptionsMenu(Menu menu) {
 474          super.onCreateOptionsMenu(menu);
 475          MenuInflater inflater = getMenuInflater();
 476          inflater.inflate(R.menu.notes_list, menu);
 477  
 478          // restore the search query if on a landscape tablet
 479          String searchQuery = null;
 480          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 481              searchQuery = mSearchView.getQuery().toString();
 482  
 483          mSearchMenuItem = menu.findItem(R.id.menu_search);
 484          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 485  
 486          if (!TextUtils.isEmpty(searchQuery)) {
 487              mSearchView.setQuery(searchQuery, false);
 488              mSearchMenuItem.expandActionView();
 489          } else {
 490              // Workaround for setting the search placeholder text color
 491              String hintHexColor = (ThemeUtils.isLightTheme(this) ?
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 492 -                    getString(R.color.simplenote_light_grey) :</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 493 -                    getString(R.color.simplenote_text_preview)).replace(&quot;ff&quot;, &quot;&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 494 +                    getString(R.color.gray_light) :</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 495 +                    getString(R.color.text_preview)).replace(&quot;ff&quot;, &quot;&quot;);</span>
 496              mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 497                      hintHexColor,
 498                      getString(R.string.search))));
 499          }
 500  
 501          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 502              @Override
 503              public boolean onQueryTextChange(String newText) {
 504                  if (mSearchMenuItem.isActionViewExpanded()) {
 505                      getNoteListFragment().searchNotes(newText);
 506                  }
 507                  return true;
 508              }
 509  
 510              @Override
 511              public boolean onQueryTextSubmit(String queryText) {
 512                  getNoteListFragment().searchNotes(queryText);
 513                  return true;
 514              }
 515  
 516          });
 517  
 518          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 519              @Override
 520              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 521                  checkEmptyListText(true);
 522                  if (mNoteListFragment != null) {
 523                      mNoteListFragment.setFloatingActionButtonVisible(false);
 524                  }
 525                  AnalyticsTracker.track(
 526                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 527                          AnalyticsTracker.CATEGORY_NOTE,
 528                          &quot;action_bar_search_tap&quot;
 529                  );
 530                  return true;
 531              }
 532  
 533              @Override
 534              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 535                  // Show all notes again
 536                  if (mNoteListFragment != null) {
 537                      mNoteListFragment.setFloatingActionButtonVisible(true);
 538                  }
 539                  mTabletSearchQuery = &quot;&quot;;
 540                  mSearchView.setQuery(&quot;&quot;, false);
 541                  checkEmptyListText(false);
 542                  getNoteListFragment().clearSearch();
 543                  return true;
 544              }
 545          });
 546  
 547          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 548              @Override
 549              public boolean onMenuItemClick(MenuItem item) {
 550                  if (!mSearchMenuItem.isActionViewExpanded())
 551                      showDetailPlaceholder();
 552                  return false;
 553              }
 554          });
 555  
 556          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 557          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 558              trashItem.setTitle(R.string.undelete);
 559              trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 560          } else {
 561              trashItem.setTitle(R.string.delete);
 562              trashItem.setIcon(R.drawable.ic_trash_24dp);
 563          }
 564  
 565          if (DisplayUtils.isLargeScreenLandscape(this)) {
 566              // Restore the search query on landscape tablets
 567              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 568                  mSearchMenuItem.expandActionView();
 569                  mSearchView.setQuery(mTabletSearchQuery, false);
 570                  mSearchView.clearFocus();
 571              }
 572  
 573              if (mCurrentNote != null) {
 574                  menu.findItem(R.id.menu_share).setVisible(true);
 575                  menu.findItem(R.id.menu_view_info).setVisible(true);
 576                  menu.findItem(R.id.menu_checklist).setVisible(true);
 577                  menu.findItem(R.id.menu_history).setVisible(true);
 578                  menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 579                  trashItem.setVisible(true);
 580              } else {
 581                  menu.findItem(R.id.menu_share).setVisible(false);
 582                  menu.findItem(R.id.menu_view_info).setVisible(false);
 583                  menu.findItem(R.id.menu_checklist).setVisible(false);
 584                  menu.findItem(R.id.menu_history).setVisible(false);
 585                  menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 586                  trashItem.setVisible(false);
 587              }
 588              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 589          } else {
 590              menu.findItem(R.id.menu_search).setVisible(true);
 591              menu.findItem(R.id.menu_share).setVisible(false);
 592              menu.findItem(R.id.menu_view_info).setVisible(false);
 593              menu.findItem(R.id.menu_checklist).setVisible(false);
 594              menu.findItem(R.id.menu_history).setVisible(false);
 595              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 596              trashItem.setVisible(false);
 597              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 598          }
 599  
 600          // Are we looking at the trash? Adjust menu accordingly.
 601          if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 602              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 603              mEmptyTrashMenuItem.setVisible(true);
 604  
 605              updateTrashMenuItem();
 606  
 607              menu.findItem(R.id.menu_search).setVisible(false);
 608              menu.findItem(R.id.menu_share).setVisible(false);
 609              menu.findItem(R.id.menu_history).setVisible(false);
 610              menu.findItem(R.id.menu_checklist).setVisible(false);
 611          }
 612  
 613          DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 614  
 615          return true;
 616      }
 617  
 618      @Override
 619      public boolean onOptionsItemSelected(MenuItem item) {
 620          if (mDrawerToggle.onOptionsItemSelected(item)) {
 621              return true;
 622          }
 623          switch (item.getItemId()) {
 624              case R.id.menu_markdown_preview:
 625                  if (mIsShowingMarkdown) {
 626                      item.setIcon(R.drawable.ic_preview_24dp);
 627                      item.setTitle(getString(R.string.markdown_show));
 628                      setMarkdownShowing(false);
 629                  } else {
 630                      item.setIcon(R.drawable.ic_preview_stop_24dp);
 631                      item.setTitle(getString(R.string.markdown_hide));
 632                      setMarkdownShowing(true);
 633                  }
 634  
 635                  DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 636  
 637                  return true;
 638              case R.id.menu_delete:
 639                  if (mNoteEditorFragment != null) {
 640                      if (mCurrentNote != null) {
 641                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 642                          mCurrentNote.setModificationDate(Calendar.getInstance());
 643                          mCurrentNote.save();
 644  
 645                          updateViewsAfterTrashAction(mCurrentNote);
 646                      }
 647                  }
 648                  return true;
 649              case R.id.menu_empty_trash:
 650                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 651  
 652                  alert.setTitle(R.string.empty_trash);
 653                  alert.setMessage(R.string.confirm_empty_trash);
 654                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 655                      public void onClick(DialogInterface dialog, int whichButton) {
 656                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 657                          AnalyticsTracker.track(
 658                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 659                                  AnalyticsTracker.CATEGORY_NOTE,
 660                                  &quot;overflow_menu&quot;
 661                          );
 662                      }
 663                  });
 664                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 665                      public void onClick(DialogInterface dialog, int whichButton) {
 666                          // Do nothing, just closing the dialog
 667                      }
 668                  });
 669                  alert.show();
 670                  return true;
 671              case android.R.id.home:
 672                  invalidateOptionsMenu();
 673                  return true;
 674              default:
 675                  return super.onOptionsItemSelected(item);
 676          }
 677      }
 678  
 679      @Override
 680      public boolean onPrepareOptionsMenu(Menu menu) {
 681          MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 682  
 683          if (mIsShowingMarkdown) {
 684              markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 685              markdownItem.setTitle(getString(R.string.markdown_hide));
 686          } else {
 687              markdownItem.setIcon(R.drawable.ic_preview_24dp);
 688              markdownItem.setTitle(getString(R.string.markdown_show));
 689          }
 690  
 691          DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 692  
 693          return super.onPrepareOptionsMenu(menu);
 694      }
 695  
 696      public void updateViewsAfterTrashAction(Note note) {
 697          if (note == null || isFinishing()) {
 698              return;
 699          }
 700  
 701          if (note.isDeleted()) {
 702              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 703              deletedNoteIds.add(note.getSimperiumKey());
 704              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 705              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 706              AnalyticsTracker.track(
 707                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 708                      AnalyticsTracker.CATEGORY_NOTE,
 709                      &quot;overflow_menu&quot;
 710              );
 711          } else {
 712              AnalyticsTracker.track(
 713                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 714                      AnalyticsTracker.CATEGORY_NOTE,
 715                      &quot;overflow_menu&quot;
 716              );
 717          }
 718  
 719          // If we just deleted/restored the active note, show the placeholder
 720          if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 721              showDetailPlaceholder();
 722          }
 723  
 724          NoteListFragment fragment = getNoteListFragment();
 725          if (fragment != null) {
 726              fragment.getPrefs();
 727              fragment.refreshList();
 728          }
 729  
 730          invalidateOptionsMenu();
 731      }
 732  
 733      public void setMarkdownShowing(boolean isMarkdownShowing) {
 734          mIsShowingMarkdown = isMarkdownShowing;
 735          if (mNoteEditorFragment != null) {
 736              if (isMarkdownShowing) {
 737                  mNoteEditorFragment.showMarkdown();
 738              } else {
 739                  mNoteEditorFragment.hideMarkdown();
 740              }
 741          }
 742          invalidateOptionsMenu();
 743      }
 744  
 745      /**
 746       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 747       * the item with the given ID was selected. Used for tablets only.
 748       */
 749      @Override
 750      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {
 751          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 752              // Launch the editor activity
 753              Bundle arguments = new Bundle();
 754              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 755              arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 756  
 757              if (matchOffsets != null)
 758                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 759  
 760              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 761              editNoteIntent.putExtras(arguments);
 762              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 763          } else {
 764              mNoteEditorFragment.setNote(noteID, matchOffsets);
 765              getNoteListFragment().setNoteSelected(noteID);
 766  
 767              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 768                  mTabletSearchQuery = mSearchView.getQuery().toString();
 769              }
 770  
 771              mNoteEditorFragment.clearMarkdown();
 772  
 773              if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 774                  setMarkdownShowing(false);
 775              }
 776  
 777              invalidateOptionsMenu();
 778          }
 779  
 780          AnalyticsTracker.track(
 781                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 782                  AnalyticsTracker.CATEGORY_NOTE,
 783                  &quot;note_list_row_tap&quot;
 784          );
 785      }
 786  
 787      @Override
 788      public void onUserCreated(User user) {
 789          // New account created
 790          AnalyticsTracker.track(
 791                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 792                  AnalyticsTracker.CATEGORY_USER,
 793                  &quot;account_created_from_login_activity&quot;
 794          );
 795      }
 796  
 797      public void onUserStatusChange(User.Status status) {
 798          switch (status) {
 799              // successfully used access token to connect to simperium bucket
 800              case AUTHORIZED:
 801                  runOnUiThread(new Runnable() {
 802                      @Override
 803                      public void run() {
 804                          if (!mNotesBucket.hasChangeVersion()) {
 805                              setToolbarProgressVisibility(true);
 806                          }
 807                      }
 808                  });
 809                  break;
 810  
 811              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 812              case NOT_AUTHORIZED:
 813                  runOnUiThread(new Runnable() {
 814                      @Override
 815                      public void run() {
 816                          startLoginActivity(true);
 817                      }
 818                  });
 819                  break;
 820  
<abbr title=" 821              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 821              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 822              case UNKNOWN:
 823                  break;
 824          }
 825      }
 826  
 827      private void setToolbarProgressVisibility(boolean isVisible) {
 828          if (getSupportActionBar() != null) {
 829              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 830          }
 831      }
 832  
 833      public void startLoginActivity(boolean signInFirst) {
 834          // Clear some account-specific prefs
 835          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 836          editor.remove(PrefUtils.PREF_WP_TOKEN);
 837          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 838          editor.apply();
 839  
 840          Intent loginIntent = new Intent(this, SignInActivity.class);
 841          if (signInFirst) {
 842              loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 843          }
 844          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 845      }
 846  
 847      @Override
 848      public void recreate() {
 849          Handler handler = new Handler();
 850          handler.post(new Runnable() {
 851              @Override
 852              public void run() {
 853                  NotesActivity.super.recreate();
 854              }
 855          });
 856      }
 857  
 858      @Override
 859      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 860          super.onActivityResult(requestCode, resultCode, data);
 861          switch (requestCode) {
 862              case Simplenote.INTENT_PREFERENCES:
 863                  if (ThemeUtils.themeWasChanged(data)) {
 864                      // Restart this activity to apply the new theme
 865                      recreate();
 866                      break;
 867                  }
<abbr title=" 868                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 868                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 869                  invalidateOptionsMenu();
 870                  NoteListFragment fragment = getNoteListFragment();
 871                  if (fragment != null) {
 872                      fragment.getPrefs();
 873                      fragment.refreshList();
 874                  }
 875  
 876                  break;
 877              case Simplenote.INTENT_EDIT_NOTE:
 878                  if (resultCode == RESULT_OK &amp;&amp; data != null) {
 879                      if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 880                          String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 881                          if (noteId != null) {
 882                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 883                              deletedNoteIds.add(noteId);
 884                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 885                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 886                          }
<abbr title=" 887                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 887                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTEðŸ”µ</abbr>
 888                          String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 889                          mNoteListFragment.setNoteSelected(selectedNoteId);
 890                          if (mNoteEditorFragment != null) {
 891                              mNoteEditorFragment.setNote(selectedNoteId);
 892                          }
 893                      }
 894                  }
 895                  break;
 896              case Simperium.SIGNUP_SIGNIN_REQUEST:
 897                  invalidateOptionsMenu();
 898  
 899                  Simplenote app = (Simplenote) getApplication();
 900                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 901  
 902                  AnalyticsTracker.track(
 903                          AnalyticsTracker.Stat.USER_SIGNED_IN,
 904                          AnalyticsTracker.CATEGORY_USER,
 905                          &quot;signed_in_from_login_activity&quot;
 906                  );
 907  
 908                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 909                      finish();
 910                  }
 911  
 912                  break;
 913          }
 914      }
 915  
 916      @Override
 917      public void onUndo() {
 918          if (mUndoBarController == null) return;
 919  
 920          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 921          if (deletedNoteIds != null) {
 922              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 923                  Note deletedNote;
 924                  try {
 925                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 926                  } catch (BucketObjectMissingException e) {
 927                      return;
 928                  }
 929                  if (deletedNote != null) {
 930                      deletedNote.setDeleted(false);
 931                      deletedNote.setModificationDate(Calendar.getInstance());
 932                      deletedNote.save();
 933                      NoteListFragment fragment = getNoteListFragment();
 934                      if (fragment != null) {
 935                          fragment.getPrefs();
 936                          fragment.refreshList();
 937                      }
 938                  }
 939              }
 940          }
 941      }
 942  
 943      @Override
 944      protected void onPostCreate(Bundle savedInstanceState) {
 945          super.onPostCreate(savedInstanceState);
 946          // Sync the toggle state after onRestoreInstanceState has occurred.
 947          mDrawerToggle.syncState();
 948      }
 949  
 950      @Override
 951      public void onConfigurationChanged(Configuration newConfig) {
 952          super.onConfigurationChanged(newConfig);
 953  
 954          mDrawerToggle.onConfigurationChanged(newConfig);
 955  
 956          if (DisplayUtils.isLargeScreen(this)) {
 957              mIsShowingMarkdown = false;
 958  
 959              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 960                  // Add the editor fragment
 961                  if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 962                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 962                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
 963                  } else if (DisplayUtils.isLandscape(this)) {
 964                      addEditorFragment();
 965                  }
 966                  if (mNoteListFragment != null) {
 967                      mNoteListFragment.setActivateOnItemClick(true);
 968                      mNoteListFragment.setDividerVisible(true);
 969                  }
 970                  // Select the current note on a tablet
 971                  if (mCurrentNote != null)
 972                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 973                  else {
 974                      mNoteEditorFragment.setPlaceholderVisible(true);
 975                      mNoteListFragment.getListView().clearChoices();
 976                  }
 977                  invalidateOptionsMenu();
 978              }
 979          }
 980  
 981          if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
 982              // Remove the editor fragment when rotating back to portrait
 983              mCurrentNote = null;
 984              if (mNoteListFragment != null) {
 985                  mNoteListFragment.setActivateOnItemClick(false);
 986                  mNoteListFragment.setDividerVisible(false);
 987                  mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
 988                  mNoteListFragment.refreshList();
 989              }
 990              FragmentManager fm = getSupportFragmentManager();
 991              FragmentTransaction ft = fm.beginTransaction();
 992              ft.remove(mNoteEditorFragment);
 993              mNoteEditorFragment = null;
 994              ft.commitAllowingStateLoss();
 995              fm.executePendingTransactions();
 996              invalidateOptionsMenu();
 997          }
 998      }
 999  
1000      public void checkEmptyListText(boolean isSearch) {
1001          if (isSearch) {
<abbr title="1002              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1002              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1003              getNoteListFragment().setEmptyListViewClickable(false);
1004          } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1005              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1005              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1006              AnalyticsTracker.track(
1007                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1008                      AnalyticsTracker.CATEGORY_NOTE,
1009                      &quot;trash_filter_selected&quot;
1010              );
1011              getNoteListFragment().setEmptyListViewClickable(false);
1012          } else {
<abbr title="1013              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1013              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
1014              getNoteListFragment().setEmptyListViewClickable(true);
1015          }
1016      }
1017  
1018      public void showDetailPlaceholder() {
1019          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1020              mCurrentNote = null;
1021              mNoteEditorFragment.setPlaceholderVisible(true);
1022              mNoteEditorFragment.clearMarkdown();
1023              mNoteEditorFragment.hideMarkdown();
1024              mIsShowingMarkdown = false;
1025          }
1026      }
1027  
1028      public void stopListeningToNotesBucket() {
1029          mNotesBucket.removeOnNetworkChangeListener(this);
1030          mNotesBucket.removeOnSaveObjectListener(this);
1031          mNotesBucket.removeOnDeleteObjectListener(this);
1032      }
1033  
1034      // Returns the appropriate view to show the undo bar within
1035      private View getUndoView() {
1036          View undoView = mFragmentsContainer;
1037          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1038                  getNoteListFragment() != null &amp;&amp;
1039                  getNoteListFragment().getRootView() != null) {
1040              undoView = getNoteListFragment().getRootView();
1041          }
1042  
1043          return undoView;
1044      }
1045  
1046      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1047          if (mUndoBarController != null) {
1048              mUndoBarController.setDeletedNoteIds(noteIds);
1049              mUndoBarController.showUndoBar(
1050                      getUndoView(),
1051                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())
1052              );
1053          }
1054      }
1055  
1056      /* Simperium Bucket Listeners */
1057      // received a change from the network, refresh the list
1058      @Override
1059      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1060          runOnUiThread(new Runnable() {
1061              @Override
1062              public void run() {
1063                  if (type == Bucket.ChangeType.INDEX) {
1064                      setToolbarProgressVisibility(false);
1065                  }
1066                  mNoteListFragment.refreshList();
1067              }
1068          });
1069      }
1070  
1071      @Override
1072      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1073          runOnUiThread(new Runnable() {
1074              @Override
1075              public void run() {
1076                  mNoteListFragment.refreshList();
1077              }
1078          });
1079      }
1080  
1081      @Override
1082      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1083          runOnUiThread(new Runnable() {
1084              @Override
1085              public void run() {
1086                  mNoteListFragment.refreshList();
1087              }
1088          });
1089      }
1090  
1091      @Override
1092      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1093          // noop, NoteEditorFragment will handle this
1094      }
1095  
1096      /* The click listener for ListView in the navigation drawer */
1097      private class DrawerItemClickListener implements ListView.OnItemClickListener {
1098          @Override
1099          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1100  
1101              // Adjust for header view
1102              position -= mDrawerList.getHeaderViewsCount();
1103              mSelectedTag = mTagsAdapter.getItem(position);
1104              checkEmptyListText(false);
1105              // Update checked item in navigation drawer and close it
1106              setSelectedTagActive();
1107              mDrawerLayout.closeDrawer(mNavigationView);
1108              updateNavigationDrawerItems();
1109  
1110              // Disable long press on notes if we&#x27;re viewing the trash
1111              if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1112                  getNoteListFragment().getListView().setLongClickable(false);
1113              } else {
1114                  getNoteListFragment().getListView().setLongClickable(true);
1115              }
1116  
1117              getNoteListFragment().refreshListFromNavSelect();
1118              if (position &gt; 1) {
1119                  AnalyticsTracker.track(
1120                          AnalyticsTracker.Stat.LIST_TAG_VIEWED,
1121                          AnalyticsTracker.CATEGORY_TAG,
1122                          &quot;selected_tag_in_navigation_drawer&quot;
1123                  );
1124              }
1125          }
1126      }
1127  
1128      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1129  
1130          @Override
1131          protected Void doInBackground(Void... voids) {
1132              if (mNotesBucket == null) return null;
1133  
1134              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1135              Bucket.ObjectCursor c = query.execute();
1136              while (c.moveToNext()) {
1137                  c.getObject().delete();
1138              }
1139  
1140              return null;
1141          }
1142  
1143          @Override
1144          protected void onPostExecute(Void nada) {
1145              showDetailPlaceholder();
1146          }
1147      }
1148  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 +import android.annotation.SuppressLint;</span>
   4  import android.app.Activity;
   5  import android.app.AlertDialog;
   6  import android.content.DialogInterface;
   7  import android.content.Intent;
   8  import android.content.SharedPreferences;
   9  import android.content.res.Configuration;
  10  import android.os.AsyncTask;
  11  import android.os.Build;
  12  import android.os.Bundle;
  13  import android.os.Handler;
  14  import android.support.design.widget.NavigationView;
  15  import android.support.v4.app.FragmentManager;
  16  import android.support.v4.app.FragmentTransaction;
  17  import android.support.v4.content.ContextCompat;
  18  import android.support.v4.view.GravityCompat;
  19  import android.support.v4.widget.DrawerLayout;
  20  import android.support.v7.app.ActionBar;
  21  import android.support.v7.app.ActionBarDrawerToggle;
  22  import android.support.v7.app.AppCompatActivity;
  23  import android.support.v7.preference.PreferenceManager;
  24  import android.support.v7.widget.SearchView;
  25  import android.support.v7.widget.Toolbar;
  26  import android.text.Spannable;
  27  import android.text.SpannableString;
  28  import android.text.TextUtils;
  29  import android.view.Menu;
  30  import android.view.MenuInflater;
  31  import android.view.MenuItem;
  32  import android.view.View;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import android.view.WindowInsets;</span>
  34  import android.view.WindowManager;
  35  import android.widget.AdapterView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import android.widget.LinearLayout;</span>
  37  import android.widget.ListView;
  38  import android.widget.ProgressBar;
  39  
  40  import com.automattic.simplenote.analytics.AnalyticsTracker;
  41  import com.automattic.simplenote.models.Note;
  42  import com.automattic.simplenote.models.Tag;
  43  import com.automattic.simplenote.utils.DisplayUtils;
  44  import com.automattic.simplenote.utils.DrawableUtils;
  45  import com.automattic.simplenote.utils.HtmlCompat;
  46  import com.automattic.simplenote.utils.PrefUtils;
  47  import com.automattic.simplenote.utils.StrUtils;
  48  import com.automattic.simplenote.utils.TagsAdapter;
  49  import com.automattic.simplenote.utils.ThemeUtils;
  50  import com.automattic.simplenote.utils.UndoBarController;
  51  import com.automattic.simplenote.widgets.TypefaceSpan;
  52  import com.simperium.Simperium;
  53  import com.simperium.client.Bucket;
  54  import com.simperium.client.BucketObjectMissingException;
  55  import com.simperium.client.BucketObjectNameInvalid;
  56  import com.simperium.client.Query;
  57  import com.simperium.client.User;
  58  
  59  import org.wordpress.passcodelock.AppLockManager;
  60  
  61  import java.util.ArrayList;
  62  import java.util.Calendar;
  63  import java.util.List;
  64  
  65  import static com.automattic.simplenote.utils.DisplayUtils.disableScreenshotsIfLocked;
  66  
  67  public class NotesActivity extends AppCompatActivity implements
<abbr title="  68          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.UndoListener,">  68          NoteListFragment.Callbacks, User.StatusChangeListener, Simperium.OnUserCreatedListener, UndoBarController.ðŸ”µ</abbr>
  69          Bucket.Listener&lt;Note&gt; {
  70  
  71      public static String TAG_NOTE_LIST = &quot;noteList&quot;;
  72      public static String TAG_NOTE_EDITOR = &quot;noteEditor&quot;;
  73      protected Bucket&lt;Note&gt; mNotesBucket;
  74      protected Bucket&lt;Tag&gt; mTagsBucket;
  75      private int TRASH_SELECTED_ID = 1;
  76      private boolean mIsShowingMarkdown;
  77      private boolean mShouldSelectNewNote;
  78  
  79      private String mTabletSearchQuery;
  80      private UndoBarController mUndoBarController;
  81      private View mFragmentsContainer;
  82      private SearchView mSearchView;
  83      private MenuItem mSearchMenuItem;
  84      private NoteListFragment mNoteListFragment;
  85      private NoteEditorFragment mNoteEditorFragment;
  86      private Note mCurrentNote;
  87      private MenuItem mEmptyTrashMenuItem;
  88  
  89      // Menu drawer
  90      private DrawerLayout mDrawerLayout;
  91      private ListView mDrawerList;
  92      private NavigationView mNavigationView;
  93      private ActionBarDrawerToggle mDrawerToggle;
  94      private TagsAdapter mTagsAdapter;
  95      private TagsAdapter.TagMenuItem mSelectedTag;
  96      // Tags bucket listener
  97      private Bucket.Listener&lt;Tag&gt; mTagsMenuUpdater = new Bucket.Listener&lt;Tag&gt;() {
  98          void updateNavigationDrawer() {
  99              runOnUiThread(new Runnable() {
 100                  public void run() {
 101                      updateNavigationDrawerItems();
 102                  }
 103              });
 104          }
 105  
 106          @Override
 107          public void onSaveObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 108              updateNavigationDrawer();
 109          }
 110  
 111          @Override
 112          public void onDeleteObject(Bucket&lt;Tag&gt; bucket, Tag tag) {
 113              updateNavigationDrawer();
 114          }
 115  
 116          @Override
 117          public void onNetworkChange(Bucket&lt;Tag&gt; bucket, Bucket.ChangeType type, String key) {
 118              updateNavigationDrawer();
 119          }
 120  
 121          @Override
 122          public void onBeforeUpdateObject(Bucket&lt;Tag&gt; bucket, Tag object) {
 123              // noop
 124          }
 125      };
 126  
 127      @Override
 128      protected void onCreate(Bundle savedInstanceState) {
 129          // On lollipop, configure the translucent status bar
 130          if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
 131              getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -            getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.transparent));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +            getWindow().setStatusBarColor(ContextCompat.getColor(this, R.color.translucent_grey_medium_light));</span>
 134          }
 135  
 136          ThemeUtils.setTheme(this);
 137          super.onCreate(savedInstanceState);
 138  
 139          setContentView(R.layout.activity_notes);
 140  
 141          mFragmentsContainer = findViewById(R.id.note_fragment_container);
 142  
 143          Simplenote currentApp = (Simplenote) getApplication();
 144          if (mNotesBucket == null) {
 145              mNotesBucket = currentApp.getNotesBucket();
 146          }
 147  
 148          if (mTagsBucket == null) {
 149              mTagsBucket = currentApp.getTagsBucket();
 150          }
 151  
 152          Toolbar toolbar = findViewById(R.id.toolbar);
 153          setSupportActionBar(toolbar);
 154          configureNavigationDrawer(toolbar);
 155  
 156          if (savedInstanceState == null) {
 157              mNoteListFragment = new NoteListFragment();
 158              FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();
 159              fragmentTransaction.add(R.id.note_fragment_container, mNoteListFragment, TAG_NOTE_LIST);
 160              fragmentTransaction.commit();
 161          } else {
 162              mNoteListFragment = (NoteListFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_LIST);
 163          }
 164  
 165          if (DisplayUtils.isLargeScreen(this)) {
 166              if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 167                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 167                  mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_ðŸ”µ</abbr>
 168              } else if (DisplayUtils.isLandscape(this)) {
 169                  addEditorFragment();
 170              }
 171          }
 172  
 173          // enable ActionBar app icon to behave as action to toggle nav drawer
 174          ActionBar actionBar = getSupportActionBar();
 175          if (actionBar != null) {
 176              actionBar.setDisplayHomeAsUpEnabled(true);
 177              actionBar.setHomeButtonEnabled(true);
 178  
 179              // Add loading indicator to show when indexing
<abbr title=" 180              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, null);"> 180              ProgressBar progressBar = (ProgressBar) getLayoutInflater().inflate(R.layout.progressbar_toolbar, nullðŸ”µ</abbr>
 181              actionBar.setDisplayShowCustomEnabled(true);
 182              actionBar.setCustomView(progressBar);
 183              setToolbarProgressVisibility(false);
 184          }
 185  
 186          mUndoBarController = new UndoBarController(this);
 187  
 188          // Creates &#x27;Welcome&#x27; note
 189          checkForFirstLaunch();
 190  
 191          checkForSharedContent();
 192  
 193          currentApp.getSimperium().setOnUserCreatedListener(this);
 194          currentApp.getSimperium().setUserStatusChangeListener(this);
 195      }
 196  
 197      @Override
 198      protected void onResume() {
 199          super.onResume();
 200  
 201          // Ensure user has valid authorization
 202          if (userAuthenticationIsInvalid()) {
 203              startLoginActivity(true);
 204          }
 205  
 206          disableScreenshotsIfLocked(this);
 207  
 208          mNotesBucket.start();
 209          mTagsBucket.start();
 210  
 211          mNotesBucket.addOnNetworkChangeListener(this);
 212          mNotesBucket.addOnSaveObjectListener(this);
 213          mNotesBucket.addOnDeleteObjectListener(this);
 214          mTagsBucket.addListener(mTagsMenuUpdater);
 215  
 216          updateNavigationDrawerItems();
 217  
 218          // if the user is not authenticated and the tag doesn&#x27;t exist revert to default drawer selection
 219          if (userIsUnauthorized()) {
 220              if (-1 == mTagsAdapter.getPosition(mSelectedTag)) {
 221                  mSelectedTag = null;
 222                  mDrawerList.setSelection(TagsAdapter.DEFAULT_ITEM_POSITION);
 223              }
 224          }
 225  
 226          setSelectedTagActive();
 227  
 228          if (mCurrentNote != null &amp;&amp; mShouldSelectNewNote) {
 229              onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 230              mShouldSelectNewNote = false;
 231          }
 232  
 233          if (mIsShowingMarkdown) {
 234              setMarkdownShowing(false);
 235          }
 236  
 237      }
 238  
 239      @Override
 240      protected void onPause() {
 241          super.onPause();  // Always call the superclass method first
 242          mTagsBucket.removeListener(mTagsMenuUpdater);
 243          mTagsBucket.stop();
 244  
 245          mNotesBucket.removeOnNetworkChangeListener(this);
 246          mNotesBucket.removeOnSaveObjectListener(this);
 247          mNotesBucket.removeOnDeleteObjectListener(this);
 248          mNotesBucket.stop();
 249      }
 250  
 251      @Override
 252      public void setTitle(CharSequence title) {
 253          if (title == null) {
 254              title = &quot;&quot;;
 255          }
 256  
 257          setTitleWithCustomFont(title);
 258      }
 259  
 260      @Override
 261      public void onBackPressed() {
 262          if (mDrawerLayout != null &amp;&amp; mDrawerLayout.isDrawerOpen(GravityCompat.START)) {
 263              mDrawerLayout.closeDrawer(GravityCompat.START);
 264          } else {
 265              super.onBackPressed();
 266          }
 267      }
 268  
 269      private void setTitleWithCustomFont(CharSequence title) {
 270          if (getSupportActionBar() == null) return;
 271  
 272          // LG devices running 4.1 can&#x27;t handle a custom font in the action bar title
 273          if ((!TextUtils.isEmpty(Build.BRAND) &amp;&amp; Build.BRAND.toLowerCase().contains(&quot;lge&quot;))
 274                  &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.JELLY_BEAN) {
 275              getSupportActionBar().setTitle(title);
 276              return;
 277          }
 278  
 279          SpannableString s = new SpannableString(title);
 280          s.setSpan(new TypefaceSpan(this), 0, s.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
 281          getSupportActionBar().setTitle(s);
 282      }
 283  
 284      private void configureNavigationDrawer(Toolbar toolbar) {
 285          mDrawerLayout = findViewById(R.id.drawer_layout);
 286          mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);
 287          mNavigationView = findViewById(R.id.navigation_view);
 288          mDrawerList = findViewById(R.id.drawer_list);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +            mNavigationView.setOnApplyWindowInsetsListener(new View.OnApplyWindowInsetsListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +                @SuppressLint(&quot;NewApi&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +                public WindowInsets onApplyWindowInsets(View view, WindowInsets windowInsets) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +                    LinearLayout drawerView = findViewById(R.id.drawer_view);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +                    drawerView.setPadding(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +                            drawerView.getPaddingLeft(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +                            windowInsets.getSystemWindowInsetTop(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +                            drawerView.getPaddingRight(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +                            drawerView.getPaddingBottom());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +                    return windowInsets.consumeSystemWindowInsets();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +        }</span>
 306  
 307          View settingsButton = findViewById(R.id.nav_settings);
 308          settingsButton.setOnClickListener(new View.OnClickListener() {
 309              @Override
 310              public void onClick(View v) {
 311                  Intent i = new Intent(NotesActivity.this, PreferencesActivity.class);
 312                  startActivityForResult(i, Simplenote.INTENT_PREFERENCES);
 313              }
 314          });
 315  
 316          mNavigationView.getLayoutParams().width = ThemeUtils.getOptimalDrawerWidth(this);
 317          mTagsAdapter = new TagsAdapter(this, mNotesBucket, mDrawerList.getHeaderViewsCount());
 318          mDrawerList.setAdapter(mTagsAdapter);
 319          // Set the list&#x27;s click listener
 320          mDrawerList.setOnItemClickListener(new DrawerItemClickListener());
 321  
 322          if (mSelectedTag == null)
 323              mSelectedTag = mTagsAdapter.getDefaultItem();
 324  
 325          mDrawerToggle = new ActionBarDrawerToggle(this, mDrawerLayout, toolbar, R.string.open_drawer,
 326                  R.string.close_drawer) {
 327              public void onDrawerClosed(View view) {
 328                  supportInvalidateOptionsMenu();
 329              }
 330  
 331              public void onDrawerOpened(View drawerView) {
 332                  // noop
 333              }
 334  
 335              @Override
 336              public void onDrawerSlide(View drawerView, float slideOffset) {
 337                  super.onDrawerSlide(drawerView, 0f);
 338              }
 339          };
 340  
 341          mDrawerLayout.addDrawerListener(mDrawerToggle);
 342      }
 343  
 344      private void checkForFirstLaunch() {
 345          if (PrefUtils.getBoolPref(this, PrefUtils.PREF_FIRST_LAUNCH, true)) {
 346              // Create the welcome note
 347              try {
 348                  Note welcomeNote = mNotesBucket.newObject(&quot;welcome-android&quot;);
 349                  welcomeNote.setCreationDate(Calendar.getInstance());
 350                  welcomeNote.setModificationDate(welcomeNote.getCreationDate());
 351                  welcomeNote.setContent(getString(R.string.welcome_note));
 352                  welcomeNote.getTitle();
 353                  welcomeNote.save();
 354              } catch (BucketObjectNameInvalid e) {
 355                  // this won&#x27;t happen because welcome-android is a valid name
 356              }
 357  
 358              SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
 359              SharedPreferences.Editor editor = preferences.edit();
 360              editor.putBoolean(PrefUtils.PREF_FIRST_LAUNCH, false);
 361              editor.putBoolean(PrefUtils.PREF_ACCOUNT_REQUIRED, true);
 362              editor.apply();
 363          }
 364      }
 365  
 366      private void checkForSharedContent() {
 367          if (getIntent().hasExtra(Intent.EXTRA_TEXT)) {
 368              // Check share action
 369              Intent intent = getIntent();
 370              String subject = intent.getStringExtra(Intent.EXTRA_SUBJECT);
 371              String text = intent.getStringExtra(Intent.EXTRA_TEXT);
 372  
 373              // Don&#x27;t add the &#x27;Note to self&#x27; subject or open the note if this was shared from a voice search
 374              String intentAction = StrUtils.notNullStr(intent.getAction());
 375              boolean isVoiceShare = intentAction.equals(&quot;com.google.android.gm.action.AUTO_SEND&quot;);
 376              if (!TextUtils.isEmpty(text)) {
 377                  if (!TextUtils.isEmpty(subject) &amp;&amp; !isVoiceShare) {
 378                      text = subject + &quot;\n\n&quot; + text;
 379                  }
 380                  Note note = mNotesBucket.newObject();
 381                  note.setCreationDate(Calendar.getInstance());
 382                  note.setModificationDate(note.getCreationDate());
 383                  note.setContent(text);
 384                  note.save();
 385                  setCurrentNote(note);
 386                  mShouldSelectNewNote = true;
 387  
 388                  AnalyticsTracker.track(
 389                          AnalyticsTracker.Stat.LIST_NOTE_CREATED,
 390                          AnalyticsTracker.CATEGORY_NOTE,
 391                          &quot;external_share&quot;
 392                  );
 393  
 394                  if (!DisplayUtils.isLargeScreenLandscape(this)) {
 395                      // Disable the lock screen when sharing content and opening NoteEditorActivity
 396                      // Lock screen activities are enabled again in NoteEditorActivity.onPause()
 397                      if (AppLockManager.getInstance().isAppLockFeatureEnabled()) {
 398                          AppLockManager.getInstance().getAppLock().setExemptActivities(
 399                                  new String[]{&quot;com.automattic.simplenote.NotesActivity&quot;,
 400                                          &quot;com.automattic.simplenote.NoteEditorActivity&quot;});
 401                          AppLockManager.getInstance().getAppLock().setOneTimeTimeout(0);
 402                      }
 403                  }
 404              }
 405          }
 406      }
 407  
 408      private void updateNavigationDrawerItems() {
 409          boolean isAlphaSort = PrefUtils.getBoolPref(this, PrefUtils.PREF_SORT_TAGS_ALPHA);
 410          Bucket.ObjectCursor&lt;Tag&gt; tagCursor;
 411          if (isAlphaSort) {
 412              tagCursor = Tag.allSortedAlphabetically(mTagsBucket).execute();
 413          } else {
 414              tagCursor = Tag.allWithName(mTagsBucket).execute();
 415          }
 416  
 417          mTagsAdapter.changeCursor(tagCursor);
 418      }
 419  
 420      private void setSelectedTagActive() {
 421          if (mSelectedTag == null)
 422              mSelectedTag = mTagsAdapter.getDefaultItem();
 423  
 424          setTitle(mSelectedTag.name);
<abbr title=" 425          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), true);"> 425          mDrawerList.setItemChecked(mTagsAdapter.getPosition(mSelectedTag) + mDrawerList.getHeaderViewsCount(), truðŸ”µ</abbr>
 426      }
 427  
 428      public TagsAdapter.TagMenuItem getSelectedTag() {
 429          if (mSelectedTag == null) {
 430              mSelectedTag = mTagsAdapter.getDefaultItem();
 431          }
 432  
 433          return mSelectedTag;
 434      }
 435  
 436      // Enable or disable the trash action bar button depending on if there are deleted notes or not
 437      public void updateTrashMenuItem() {
 438          if (mEmptyTrashMenuItem == null || mNotesBucket == null)
 439              return;
 440  
 441          // Disable the trash icon if there are no notes trashed.
 442          Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
 443          if (query.count() == 0) {
 444              mEmptyTrashMenuItem.setEnabled(false);
 445          } else {
 446              mEmptyTrashMenuItem.setEnabled(true);
 447          }
 448      }
 449  
 450      private void addEditorFragment() {
 451          FragmentManager fm = getSupportFragmentManager();
 452          FragmentTransaction ft = fm.beginTransaction();
 453          mNoteEditorFragment = new NoteEditorFragment();
 454          ft.add(R.id.note_fragment_container, mNoteEditorFragment, TAG_NOTE_EDITOR);
 455          ft.commitAllowingStateLoss();
 456          fm.executePendingTransactions();
 457      }
 458  
 459      private boolean userAccountRequired() {
 460          return PrefUtils.getBoolPref(this, PrefUtils.PREF_ACCOUNT_REQUIRED, false);
 461      }
 462  
 463      /**
 464       * Checks for a previously valid user that is now not authenticated
 465       * Also checks if user account is required (added in version 1.5.6)
 466       *
 467       * @return true if user has invalid authorization
 468       */
 469      private boolean userAuthenticationIsInvalid() {
 470          Simplenote currentApp = (Simplenote) getApplication();
 471          Simperium simperium = currentApp.getSimperium();
 472          User user = simperium.getUser();
 473          boolean isNotAuthorized = user.getStatus().equals(User.Status.NOT_AUTHORIZED);
 474          return (user.hasAccessToken() &amp;&amp; isNotAuthorized) ||
 475                  (userAccountRequired() &amp;&amp; isNotAuthorized);
 476      }
 477  
 478      public boolean userIsUnauthorized() {
 479          Simplenote currentApp = (Simplenote) getApplication();
 480          return currentApp.getSimperium().getUser().getStatus() == User.Status.NOT_AUTHORIZED;
 481      }
 482  
 483      public void setCurrentNote(Note note) {
 484          mCurrentNote = note;
 485      }
 486  
 487      public NoteListFragment getNoteListFragment() {
 488          return mNoteListFragment;
 489      }
 490  
 491      @SuppressWarnings(&quot;ResourceType&quot;)
 492      @Override
 493      public boolean onCreateOptionsMenu(Menu menu) {
 494          super.onCreateOptionsMenu(menu);
 495          MenuInflater inflater = getMenuInflater();
 496          inflater.inflate(R.menu.notes_list, menu);
 497  
 498          // restore the search query if on a landscape tablet
 499          String searchQuery = null;
 500          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mSearchView != null)
 501              searchQuery = mSearchView.getQuery().toString();
 502  
 503          mSearchMenuItem = menu.findItem(R.id.menu_search);
 504          mSearchView = (SearchView) mSearchMenuItem.getActionView();
 505  
 506          if (!TextUtils.isEmpty(searchQuery)) {
 507              mSearchView.setQuery(searchQuery, false);
 508              mSearchMenuItem.expandActionView();
 509          } else {
 510              // Workaround for setting the search placeholder text color
 511              String hintHexColor = (ThemeUtils.isLightTheme(this) ?
 512                      getString(R.color.simplenote_light_grey) :
 513                      getString(R.color.simplenote_text_preview)).replace(&quot;ff&quot;, &quot;&quot;);


 514              mSearchView.setQueryHint(HtmlCompat.fromHtml(String.format(&quot;&lt;font color=\&quot;%s\&quot;&gt;%s&lt;/font&gt;&quot;,
 515                      hintHexColor,
 516                      getString(R.string.search))));
 517          }
 518  
 519          mSearchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
 520              @Override
 521              public boolean onQueryTextChange(String newText) {
 522                  if (mSearchMenuItem.isActionViewExpanded()) {
 523                      getNoteListFragment().searchNotes(newText);
 524                  }
 525                  return true;
 526              }
 527  
 528              @Override
 529              public boolean onQueryTextSubmit(String queryText) {
 530                  getNoteListFragment().searchNotes(queryText);
 531                  return true;
 532              }
 533  
 534          });
 535  
 536          mSearchMenuItem.setOnActionExpandListener(new MenuItem.OnActionExpandListener() {
 537              @Override
 538              public boolean onMenuItemActionExpand(MenuItem menuItem) {
 539                  checkEmptyListText(true);
 540                  if (mNoteListFragment != null) {
 541                      mNoteListFragment.setFloatingActionButtonVisible(false);
 542                  }
 543                  AnalyticsTracker.track(
 544                          AnalyticsTracker.Stat.LIST_NOTES_SEARCHED,
 545                          AnalyticsTracker.CATEGORY_NOTE,
 546                          &quot;action_bar_search_tap&quot;
 547                  );
 548                  return true;
 549              }
 550  
 551              @Override
 552              public boolean onMenuItemActionCollapse(MenuItem menuItem) {
 553                  // Show all notes again
 554                  if (mNoteListFragment != null) {
 555                      mNoteListFragment.setFloatingActionButtonVisible(true);
 556                  }
 557                  mTabletSearchQuery = &quot;&quot;;
 558                  mSearchView.setQuery(&quot;&quot;, false);
 559                  checkEmptyListText(false);
 560                  getNoteListFragment().clearSearch();
 561                  return true;
 562              }
 563          });
 564  
 565          mSearchMenuItem.setOnMenuItemClickListener(new MenuItem.OnMenuItemClickListener() {
 566              @Override
 567              public boolean onMenuItemClick(MenuItem item) {
 568                  if (!mSearchMenuItem.isActionViewExpanded())
 569                      showDetailPlaceholder();
 570                  return false;
 571              }
 572          });
 573  
 574          MenuItem trashItem = menu.findItem(R.id.menu_delete).setTitle(R.string.undelete);
 575          if (mCurrentNote != null &amp;&amp; mCurrentNote.isDeleted()) {
 576              trashItem.setTitle(R.string.undelete);
 577              trashItem.setIcon(R.drawable.ic_trash_restore_24dp);
 578          } else {
 579              trashItem.setTitle(R.string.delete);
 580              trashItem.setIcon(R.drawable.ic_trash_24dp);
 581          }
 582  
 583          if (DisplayUtils.isLargeScreenLandscape(this)) {
 584              // Restore the search query on landscape tablets
 585              if (!TextUtils.isEmpty(mTabletSearchQuery)) {
 586                  mSearchMenuItem.expandActionView();
 587                  mSearchView.setQuery(mTabletSearchQuery, false);
 588                  mSearchView.clearFocus();
 589              }
 590  
 591              if (mCurrentNote != null) {
 592                  menu.findItem(R.id.menu_share).setVisible(true);
 593                  menu.findItem(R.id.menu_view_info).setVisible(true);
 594                  menu.findItem(R.id.menu_checklist).setVisible(true);
 595                  menu.findItem(R.id.menu_history).setVisible(true);
 596                  menu.findItem(R.id.menu_markdown_preview).setVisible(mCurrentNote.isMarkdownEnabled());
 597                  trashItem.setVisible(true);
 598              } else {
 599                  menu.findItem(R.id.menu_share).setVisible(false);
 600                  menu.findItem(R.id.menu_view_info).setVisible(false);
 601                  menu.findItem(R.id.menu_checklist).setVisible(false);
 602                  menu.findItem(R.id.menu_history).setVisible(false);
 603                  menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 604                  trashItem.setVisible(false);
 605              }
 606              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 607          } else {
 608              menu.findItem(R.id.menu_search).setVisible(true);
 609              menu.findItem(R.id.menu_share).setVisible(false);
 610              menu.findItem(R.id.menu_view_info).setVisible(false);
 611              menu.findItem(R.id.menu_checklist).setVisible(false);
 612              menu.findItem(R.id.menu_history).setVisible(false);
 613              menu.findItem(R.id.menu_markdown_preview).setVisible(false);
 614              trashItem.setVisible(false);
 615              menu.findItem(R.id.menu_empty_trash).setVisible(false);
 616          }
 617  
 618          // Are we looking at the trash? Adjust menu accordingly.
 619          if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
 620              mEmptyTrashMenuItem = menu.findItem(R.id.menu_empty_trash);
 621              mEmptyTrashMenuItem.setVisible(true);
 622  
 623              updateTrashMenuItem();
 624  
 625              menu.findItem(R.id.menu_search).setVisible(false);
 626              menu.findItem(R.id.menu_share).setVisible(false);
 627              menu.findItem(R.id.menu_history).setVisible(false);
 628              menu.findItem(R.id.menu_checklist).setVisible(false);
 629          }
 630  
 631          DrawableUtils.tintMenuWithAttribute(this, menu, R.attr.actionBarTextColor);
 632  
 633          return true;
 634      }
 635  
 636      @Override
 637      public boolean onOptionsItemSelected(MenuItem item) {
 638          if (mDrawerToggle.onOptionsItemSelected(item)) {
 639              return true;
 640          }
 641          switch (item.getItemId()) {
 642              case R.id.menu_markdown_preview:
 643                  if (mIsShowingMarkdown) {
 644                      item.setIcon(R.drawable.ic_preview_24dp);
 645                      item.setTitle(getString(R.string.markdown_show));
 646                      setMarkdownShowing(false);
 647                  } else {
 648                      item.setIcon(R.drawable.ic_preview_stop_24dp);
 649                      item.setTitle(getString(R.string.markdown_hide));
 650                      setMarkdownShowing(true);
 651                  }
 652  
 653                  DrawableUtils.tintMenuItemWithAttribute(this, item, R.attr.actionBarTextColor);
 654  
 655                  return true;
 656              case R.id.menu_delete:
 657                  if (mNoteEditorFragment != null) {
 658                      if (mCurrentNote != null) {
 659                          mCurrentNote.setDeleted(!mCurrentNote.isDeleted());
 660                          mCurrentNote.setModificationDate(Calendar.getInstance());
 661                          mCurrentNote.save();
 662  
 663                          updateViewsAfterTrashAction(mCurrentNote);
 664                      }
 665                  }
 666                  return true;
 667              case R.id.menu_empty_trash:
 668                  AlertDialog.Builder alert = new AlertDialog.Builder(this);
 669  
 670                  alert.setTitle(R.string.empty_trash);
 671                  alert.setMessage(R.string.confirm_empty_trash);
 672                  alert.setPositiveButton(R.string.yes, new DialogInterface.OnClickListener() {
 673                      public void onClick(DialogInterface dialog, int whichButton) {
 674                          new emptyTrashTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 675                          AnalyticsTracker.track(
 676                                  AnalyticsTracker.Stat.LIST_TRASH_EMPTIED,
 677                                  AnalyticsTracker.CATEGORY_NOTE,
 678                                  &quot;overflow_menu&quot;
 679                          );
 680                      }
 681                  });
 682                  alert.setNegativeButton(R.string.no, new DialogInterface.OnClickListener() {
 683                      public void onClick(DialogInterface dialog, int whichButton) {
 684                          // Do nothing, just closing the dialog
 685                      }
 686                  });
 687                  alert.show();
 688                  return true;
 689              case android.R.id.home:
 690                  invalidateOptionsMenu();
 691                  return true;
 692              default:
 693                  return super.onOptionsItemSelected(item);
 694          }
 695      }
 696  
 697      @Override
 698      public boolean onPrepareOptionsMenu(Menu menu) {
 699          MenuItem markdownItem = menu.findItem(R.id.menu_markdown_preview);
 700  
 701          if (mIsShowingMarkdown) {
 702              markdownItem.setIcon(R.drawable.ic_preview_stop_24dp);
 703              markdownItem.setTitle(getString(R.string.markdown_hide));
 704          } else {
 705              markdownItem.setIcon(R.drawable.ic_preview_24dp);
 706              markdownItem.setTitle(getString(R.string.markdown_show));
 707          }
 708  
 709          DrawableUtils.tintMenuItemWithAttribute(this, markdownItem, R.attr.actionBarTextColor);
 710  
 711          return super.onPrepareOptionsMenu(menu);
 712      }
 713  
 714      public void updateViewsAfterTrashAction(Note note) {
 715          if (note == null || isFinishing()) {
 716              return;
 717          }
 718  
 719          if (note.isDeleted()) {
 720              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 721              deletedNoteIds.add(note.getSimperiumKey());
 722              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 723              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 724              AnalyticsTracker.track(
 725                      AnalyticsTracker.Stat.LIST_NOTE_DELETED,
 726                      AnalyticsTracker.CATEGORY_NOTE,
 727                      &quot;overflow_menu&quot;
 728              );
 729          } else {
 730              AnalyticsTracker.track(
 731                      AnalyticsTracker.Stat.EDITOR_NOTE_RESTORED,
 732                      AnalyticsTracker.CATEGORY_NOTE,
 733                      &quot;overflow_menu&quot;
 734              );
 735          }
 736  
 737          // If we just deleted/restored the active note, show the placeholder
 738          if (mCurrentNote != null &amp;&amp; mCurrentNote.getSimperiumKey().equals(note.getSimperiumKey())) {
 739              showDetailPlaceholder();
 740          }
 741  
 742          NoteListFragment fragment = getNoteListFragment();
 743          if (fragment != null) {
 744              fragment.getPrefs();
 745              fragment.refreshList();
 746          }
 747  
 748          invalidateOptionsMenu();
 749      }
 750  
 751      public void setMarkdownShowing(boolean isMarkdownShowing) {
 752          mIsShowingMarkdown = isMarkdownShowing;
 753          if (mNoteEditorFragment != null) {
 754              if (isMarkdownShowing) {
 755                  mNoteEditorFragment.showMarkdown();
 756              } else {
 757                  mNoteEditorFragment.hideMarkdown();
 758              }
 759          }
 760          invalidateOptionsMenu();
 761      }
 762  
 763      /**
 764       * Callback method from {@link NoteListFragment.Callbacks} indicating that
 765       * the item with the given ID was selected. Used for tablets only.
 766       */
 767      @Override
 768      public void onNoteSelected(String noteID, int position, String matchOffsets, boolean isMarkdownEnabled) {
 769          if (!DisplayUtils.isLargeScreenLandscape(this)) {
 770              // Launch the editor activity
 771              Bundle arguments = new Bundle();
 772              arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 773              arguments.putBoolean(NoteEditorFragment.ARG_MARKDOWN_ENABLED, isMarkdownEnabled);
 774  
 775              if (matchOffsets != null)
 776                  arguments.putString(NoteEditorFragment.ARG_MATCH_OFFSETS, matchOffsets);
 777  
 778              Intent editNoteIntent = new Intent(this, NoteEditorActivity.class);
 779              editNoteIntent.putExtras(arguments);
 780              startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 781          } else {
 782              mNoteEditorFragment.setNote(noteID, matchOffsets);
 783              getNoteListFragment().setNoteSelected(noteID);
 784  
 785              if (mSearchView != null &amp;&amp; mSearchView.getQuery() != null) {
 786                  mTabletSearchQuery = mSearchView.getQuery().toString();
 787              }
 788  
 789              mNoteEditorFragment.clearMarkdown();
 790  
 791              if (!isMarkdownEnabled &amp;&amp; mIsShowingMarkdown) {
 792                  setMarkdownShowing(false);
 793              }
 794  
 795              invalidateOptionsMenu();
 796          }
 797  
 798          AnalyticsTracker.track(
 799                  AnalyticsTracker.Stat.LIST_NOTE_OPENED,
 800                  AnalyticsTracker.CATEGORY_NOTE,
 801                  &quot;note_list_row_tap&quot;
 802          );
 803      }
 804  
 805      @Override
 806      public void onUserCreated(User user) {
 807          // New account created
 808          AnalyticsTracker.track(
 809                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 810                  AnalyticsTracker.CATEGORY_USER,
 811                  &quot;account_created_from_login_activity&quot;
 812          );
 813      }
 814  
 815      public void onUserStatusChange(User.Status status) {
 816          switch (status) {
 817              // successfully used access token to connect to simperium bucket
 818              case AUTHORIZED:
 819                  runOnUiThread(new Runnable() {
 820                      @Override
 821                      public void run() {
 822                          if (!mNotesBucket.hasChangeVersion()) {
 823                              setToolbarProgressVisibility(true);
 824                          }
 825                      }
 826                  });
 827                  break;
 828  
 829              // NOT_AUTHORIZED means we attempted to connect but the token was not valid
 830              case NOT_AUTHORIZED:
 831                  runOnUiThread(new Runnable() {
 832                      @Override
 833                      public void run() {
 834                          startLoginActivity(true);
 835                      }
 836                  });
 837                  break;
 838  
<abbr title=" 839              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t do anything"> 839              // Default starting state of User, don&#x27;t do anything we allow use of app while not signed in so don&#x27;t ðŸ”µ</abbr>
 840              case UNKNOWN:
 841                  break;
 842          }
 843      }
 844  
 845      private void setToolbarProgressVisibility(boolean isVisible) {
 846          if (getSupportActionBar() != null) {
 847              getSupportActionBar().setDisplayShowCustomEnabled(isVisible);
 848          }
 849      }
 850  
 851      public void startLoginActivity(boolean signInFirst) {
 852          // Clear some account-specific prefs
 853          SharedPreferences.Editor editor = PreferenceManager.getDefaultSharedPreferences(this).edit();
 854          editor.remove(PrefUtils.PREF_WP_TOKEN);
 855          editor.remove(PrefUtils.PREF_WORDPRESS_SITES);
 856          editor.apply();
 857  
 858          Intent loginIntent = new Intent(this, SignInActivity.class);
 859          if (signInFirst) {
 860              loginIntent.putExtra(SignInActivity.EXTRA_SIGN_IN_FIRST, true);
 861          }
 862          startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 863      }
 864  
 865      @Override
 866      public void recreate() {
 867          Handler handler = new Handler();
 868          handler.post(new Runnable() {
 869              @Override
 870              public void run() {
 871                  NotesActivity.super.recreate();
 872              }
 873          });
 874      }
 875  
 876      @Override
 877      protected void onActivityResult(int requestCode, int resultCode, Intent data) {
 878          super.onActivityResult(requestCode, resultCode, data);
 879          switch (requestCode) {
 880              case Simplenote.INTENT_PREFERENCES:
 881                  if (ThemeUtils.themeWasChanged(data)) {
 882                      // Restart this activity to apply the new theme
 883                      recreate();
 884                      break;
 885                  }
<abbr title=" 886                  // nbradbury - refresh note list when user returns from preferences (in case they changed anything)"> 886                  // nbradbury - refresh note list when user returns from preferences (in case they changed anythingðŸ”µ</abbr>
 887                  invalidateOptionsMenu();
 888                  NoteListFragment fragment = getNoteListFragment();
 889                  if (fragment != null) {
 890                      fragment.getPrefs();
 891                      fragment.refreshList();
 892                  }
 893  
 894                  break;
 895              case Simplenote.INTENT_EDIT_NOTE:
 896                  if (resultCode == RESULT_OK &amp;&amp; data != null) {
 897                      if (data.hasExtra(Simplenote.DELETED_NOTE_ID)) {
 898                          String noteId = data.getStringExtra(Simplenote.DELETED_NOTE_ID);
 899                          if (noteId != null) {
 900                              List&lt;String&gt; deletedNoteIds = new ArrayList&lt;&gt;();
 901                              deletedNoteIds.add(noteId);
 902                              mUndoBarController.setDeletedNoteIds(deletedNoteIds);
 903                              mUndoBarController.showUndoBar(getUndoView(), getString(R.string.note_deleted));
 904                          }
<abbr title=" 905                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTE_ID)) {"> 905                      } else if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; data.hasExtra(Simplenote.SELECTED_NOTEðŸ”µ</abbr>
 906                          String selectedNoteId = data.getStringExtra(Simplenote.SELECTED_NOTE_ID);
 907                          mNoteListFragment.setNoteSelected(selectedNoteId);
 908                          if (mNoteEditorFragment != null) {
 909                              mNoteEditorFragment.setNote(selectedNoteId);
 910                          }
 911                      }
 912                  }
 913                  break;
 914              case Simperium.SIGNUP_SIGNIN_REQUEST:
 915                  invalidateOptionsMenu();
 916  
 917                  Simplenote app = (Simplenote) getApplication();
 918                  AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 919  
 920                  AnalyticsTracker.track(
 921                          AnalyticsTracker.Stat.USER_SIGNED_IN,
 922                          AnalyticsTracker.CATEGORY_USER,
 923                          &quot;signed_in_from_login_activity&quot;
 924                  );
 925  
 926                  if (resultCode == Activity.RESULT_CANCELED &amp;&amp; userAuthenticationIsInvalid()) {
 927                      finish();
 928                  }
 929  
 930                  break;
 931          }
 932      }
 933  
 934      @Override
 935      public void onUndo() {
 936          if (mUndoBarController == null) return;
 937  
 938          List&lt;String&gt; deletedNoteIds = mUndoBarController.getDeletedNoteIds();
 939          if (deletedNoteIds != null) {
 940              for (int i = 0; i &lt; deletedNoteIds.size(); i++) {
 941                  Note deletedNote;
 942                  try {
 943                      deletedNote = mNotesBucket.get(deletedNoteIds.get(i));
 944                  } catch (BucketObjectMissingException e) {
 945                      return;
 946                  }
 947                  if (deletedNote != null) {
 948                      deletedNote.setDeleted(false);
 949                      deletedNote.setModificationDate(Calendar.getInstance());
 950                      deletedNote.save();
 951                      NoteListFragment fragment = getNoteListFragment();
 952                      if (fragment != null) {
 953                          fragment.getPrefs();
 954                          fragment.refreshList();
 955                      }
 956                  }
 957              }
 958          }
 959      }
 960  
 961      @Override
 962      protected void onPostCreate(Bundle savedInstanceState) {
 963          super.onPostCreate(savedInstanceState);
 964          // Sync the toggle state after onRestoreInstanceState has occurred.
 965          mDrawerToggle.syncState();
 966      }
 967  
 968      @Override
 969      public void onConfigurationChanged(Configuration newConfig) {
 970          super.onConfigurationChanged(newConfig);
 971  
 972          mDrawerToggle.onConfigurationChanged(newConfig);
 973  
 974          if (DisplayUtils.isLargeScreen(this)) {
 975              mIsShowingMarkdown = false;
 976  
 977              if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
 978                  // Add the editor fragment
 979                  if (getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR) != null) {
<abbr title=" 980                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NOTE_EDITOR);"> 980                      mNoteEditorFragment = (NoteEditorFragment) getSupportFragmentManager().findFragmentByTag(TAG_NðŸ”µ</abbr>
 981                  } else if (DisplayUtils.isLandscape(this)) {
 982                      addEditorFragment();
 983                  }
 984                  if (mNoteListFragment != null) {
 985                      mNoteListFragment.setActivateOnItemClick(true);
 986                      mNoteListFragment.setDividerVisible(true);
 987                  }
 988                  // Select the current note on a tablet
 989                  if (mCurrentNote != null)
 990                      onNoteSelected(mCurrentNote.getSimperiumKey(), 0, null, mCurrentNote.isMarkdownEnabled());
 991                  else {
 992                      mNoteEditorFragment.setPlaceholderVisible(true);
 993                      mNoteListFragment.getListView().clearChoices();
 994                  }
 995                  invalidateOptionsMenu();
 996              }
 997          }
 998  
 999          if (newConfig.orientation == Configuration.ORIENTATION_PORTRAIT &amp;&amp; mNoteEditorFragment != null) {
1000              // Remove the editor fragment when rotating back to portrait
1001              mCurrentNote = null;
1002              if (mNoteListFragment != null) {
1003                  mNoteListFragment.setActivateOnItemClick(false);
1004                  mNoteListFragment.setDividerVisible(false);
1005                  mNoteListFragment.setActivatedPosition(ListView.INVALID_POSITION);
1006                  mNoteListFragment.refreshList();
1007              }
1008              FragmentManager fm = getSupportFragmentManager();
1009              FragmentTransaction ft = fm.beginTransaction();
1010              ft.remove(mNoteEditorFragment);
1011              mNoteEditorFragment = null;
1012              ft.commitAllowingStateLoss();
1013              fm.executePendingTransactions();
1014              invalidateOptionsMenu();
1015          }
1016      }
1017  
1018      public void checkEmptyListText(boolean isSearch) {
1019          if (isSearch) {
<abbr title="1020              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;&quot;);">1020              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_found) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1021              getNoteListFragment().setEmptyListViewClickable(false);
1022          } else if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
<abbr title="1023              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;&quot;);">1023              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.trash_is_empty) + &quot;&lt;/strong&gt;ðŸ”µ</abbr>
1024              AnalyticsTracker.track(
1025                      AnalyticsTracker.Stat.LIST_TRASH_VIEWED,
1026                      AnalyticsTracker.CATEGORY_NOTE,
1027                      &quot;trash_filter_selected&quot;
1028              );
1029              getNoteListFragment().setEmptyListViewClickable(false);
1030          } else {
<abbr title="1031              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));">1031              getNoteListFragment().setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;ðŸ”µ</abbr>
1032              getNoteListFragment().setEmptyListViewClickable(true);
1033          }
1034      }
1035  
1036      public void showDetailPlaceholder() {
1037          if (DisplayUtils.isLargeScreenLandscape(this) &amp;&amp; mNoteEditorFragment != null) {
1038              mCurrentNote = null;
1039              mNoteEditorFragment.setPlaceholderVisible(true);
1040              mNoteEditorFragment.clearMarkdown();
1041              mNoteEditorFragment.hideMarkdown();
1042              mIsShowingMarkdown = false;
1043          }
1044      }
1045  
1046      public void stopListeningToNotesBucket() {
1047          mNotesBucket.removeOnNetworkChangeListener(this);
1048          mNotesBucket.removeOnSaveObjectListener(this);
1049          mNotesBucket.removeOnDeleteObjectListener(this);
1050      }
1051  
1052      // Returns the appropriate view to show the undo bar within
1053      private View getUndoView() {
1054          View undoView = mFragmentsContainer;
1055          if (!DisplayUtils.isLargeScreenLandscape(this) &amp;&amp;
1056                  getNoteListFragment() != null &amp;&amp;
1057                  getNoteListFragment().getRootView() != null) {
1058              undoView = getNoteListFragment().getRootView();
1059          }
1060  
1061          return undoView;
1062      }
1063  
1064      public void showUndoBarWithNoteIds(List&lt;String&gt; noteIds) {
1065          if (mUndoBarController != null) {
1066              mUndoBarController.setDeletedNoteIds(noteIds);
1067              mUndoBarController.showUndoBar(
1068                      getUndoView(),
1069                      getResources().getQuantityString(R.plurals.trashed_notes, noteIds.size(), noteIds.size())
1070              );
1071          }
1072      }
1073  
1074      /* Simperium Bucket Listeners */
1075      // received a change from the network, refresh the list
1076      @Override
1077      public void onNetworkChange(Bucket&lt;Note&gt; bucket, final Bucket.ChangeType type, String key) {
1078          runOnUiThread(new Runnable() {
1079              @Override
1080              public void run() {
1081                  if (type == Bucket.ChangeType.INDEX) {
1082                      setToolbarProgressVisibility(false);
1083                  }
1084                  mNoteListFragment.refreshList();
1085              }
1086          });
1087      }
1088  
1089      @Override
1090      public void onSaveObject(Bucket&lt;Note&gt; bucket, Note object) {
1091          runOnUiThread(new Runnable() {
1092              @Override
1093              public void run() {
1094                  mNoteListFragment.refreshList();
1095              }
1096          });
1097      }
1098  
1099      @Override
1100      public void onDeleteObject(Bucket&lt;Note&gt; bucket, Note object) {
1101          runOnUiThread(new Runnable() {
1102              @Override
1103              public void run() {
1104                  mNoteListFragment.refreshList();
1105              }
1106          });
1107      }
1108  
1109      @Override
1110      public void onBeforeUpdateObject(Bucket&lt;Note&gt; bucket, Note note) {
1111          // noop, NoteEditorFragment will handle this
1112      }
1113  
1114      /* The click listener for ListView in the navigation drawer */
1115      private class DrawerItemClickListener implements ListView.OnItemClickListener {
1116          @Override
1117          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
1118  
1119              // Adjust for header view
1120              position -= mDrawerList.getHeaderViewsCount();
1121              mSelectedTag = mTagsAdapter.getItem(position);
1122              checkEmptyListText(false);
1123              // Update checked item in navigation drawer and close it
1124              setSelectedTagActive();
1125              mDrawerLayout.closeDrawer(mNavigationView);
1126              updateNavigationDrawerItems();
1127  
1128              // Disable long press on notes if we&#x27;re viewing the trash
1129              if (mDrawerList.getCheckedItemPosition() == TRASH_SELECTED_ID) {
1130                  getNoteListFragment().getListView().setLongClickable(false);
1131              } else {
1132                  getNoteListFragment().getListView().setLongClickable(true);
1133              }
1134  
1135              getNoteListFragment().refreshListFromNavSelect();
1136              if (position &gt; 1) {
1137                  AnalyticsTracker.track(
1138                          AnalyticsTracker.Stat.LIST_TAG_VIEWED,
1139                          AnalyticsTracker.CATEGORY_TAG,
1140                          &quot;selected_tag_in_navigation_drawer&quot;
1141                  );
1142              }
1143          }
1144      }
1145  
1146      private class emptyTrashTask extends AsyncTask&lt;Void, Void, Void&gt; {
1147  
1148          @Override
1149          protected Void doInBackground(Void... voids) {
1150              if (mNotesBucket == null) return null;
1151  
1152              Query&lt;Note&gt; query = Note.allDeleted(mNotesBucket);
1153              Bucket.ObjectCursor c = query.execute();
1154              while (c.moveToNext()) {
1155                  c.getObject().delete();
1156              }
1157  
1158              return null;
1159          }
1160  
1161          @Override
1162          protected void onPostExecute(Void nada) {
1163              showDetailPlaceholder();
1164          }
1165      }
1166  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            