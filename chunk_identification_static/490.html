<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>490</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    490
                    <a href="489.html">prev</a>
                    <a href="491.html">next</a>
                    <a href="490_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e346a804d69c8cd0124b4eb3d35156cfb5cd0779_rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^1:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^2:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;6e351a99f6e8449c76ad55e517a5da6cbb108379:rdb/rdb-side/src/main/java/com/dtstack/flink/sql/side/rdb/async/RdbAsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [b], [b], [b], [b], [j], [j], [j], [s], [s]], subset: [[b], [bs], [b], [b], [b], [bj], [bj], [j], [s]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.rdb.async;
  21 
  22 import com.dtstack.flink.sql.enums.ECacheContentType;
  23 import com.dtstack.flink.sql.factory.DTThreadFactory;
  24 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  25 import com.dtstack.flink.sql.side.BaseSideInfo;
  26 import com.dtstack.flink.sql.side.CacheMissVal;
  27 import com.dtstack.flink.sql.side.cache.CacheObj;
  28 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  29 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  30 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  31 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import com.dtstack.flink.sql.util.DateUtil;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import io.vertx.core.json.JsonArray;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import io.vertx.core.json.JsonObject;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import io.vertx.ext.sql.SQLClient;</span>
  36 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import com.dtstack.flink.sql.util.DateUtil;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import com.google.common.collect.Maps;</span>
  40 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  41 import io.vertx.core.json.JsonArray;
  42 import io.vertx.ext.sql.SQLClient;
  43 import io.vertx.ext.sql.SQLConnection;
  44 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  45 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  46 import org.apache.flink.api.java.tuple.Tuple2;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  47 import org.apache.flink.configuration.Configuration;</span>
  48 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import io.vertx.ext.sql.SQLClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import io.vertx.ext.sql.SQLConnection;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import org.apache.flink.streaming.api.functions.async.ResultFuture;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import org.apache.flink.table.runtime.types.CRow;</span>
  55 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56 import org.apache.commons.lang3.StringUtils;</span>
  57 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  58 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  59 import org.apache.flink.types.Row;
  60 import org.slf4j.Logger;
  61 import org.slf4j.LoggerFactory;
  62 
  63 import java.util.List;
  64 import java.util.Map;
  65 import java.util.concurrent.*;
  66 import java.util.concurrent.atomic.AtomicBoolean;
  67 import java.util.concurrent.atomic.AtomicLong;
  68 
  69 /**
  70  * Date: 2018/11/26
  71  * Company: www.dtstack.com
  72  *
  73  * @author maqi
  74  */
  75 
  76 public class RdbAsyncReqRow extends BaseAsyncReqRow {
  77 
  78     private static final long serialVersionUID = 2098635244857937720L;
  79 
  80     private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  81 
  82     public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  83 
<abbr title="  84     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;">  84     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() *ðŸ”µ</abbr>
  85 
<abbr title="  86     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  86     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTðŸ”µ</abbr>
  87 
  88     public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  89 
  90     public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  91 
  92     public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  93 
<abbr title="  94     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  94     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSouðŸ”µ</abbr>
  95 
  96     public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  97 
  98     private transient SQLClient rdbSqlClient;
  99 
 100     private AtomicBoolean connectionStatus = new AtomicBoolean(true);
 101 
 102     private transient ThreadPoolExecutor executor;
 103 
 104     public RdbAsyncReqRow(BaseSideInfo sideInfo) {
 105         super(sideInfo);
 106         init(sideInfo);
 107     }
 108 
 109     protected void init(BaseSideInfo sideInfo) {
 110         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
 111         int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title=" 112         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;"> 112         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() :ðŸ”µ</abbr>
 113         rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
 114     }
 115 
 116     @Override
 117     protected void preInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture){
 118 
 119     }
 120 
 121     @Override
 122 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 123     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 123     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) thðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 124         Tuple2&lt;Boolean,Row&gt; inputCopy =  Tuple2.of(input.f0,input.f1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128             Object equalObj = inputCopy.f1.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129             if (equalObj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131                 return;</span>
 132 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133         super.open(parameters);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135         LOG.info(&quot;rdb dim table config info: {} &quot;, rdbSideTableInfo.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         CRow copyCrow = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143             Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145                 dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148             inputParams.add(convertDataType(equalObj));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151         String key = buildCacheKey(inputParams);</span>
 152 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 153     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 153     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155         AtomicLong networkLogCounter = new AtomicLong(0L);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156         while (!connectionStatus.get()){//network is unhealth</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157             if(networkLogCounter.getAndIncrement() % 1000 == 0){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158                 LOG.info(&quot;network unhealth to block task&quot;);</span>
 159 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 160             }
 161 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162             inputParams.add(equalObj);</span>
 163 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164             Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166                 dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169             inputParams.add(convertDataType(equalObj));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174             CacheObj val = getFromCache(key);</span>
 175 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176             Thread.sleep(100);</span>
 177 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 178         }
 179         Map&lt;String, Object&gt; params = formatInputParam(inputParams);
 180         executor.execute(() -&gt; connectWithRetry(params, input, resultFuture, rdbSqlClient));
 181     }
 182 
 183 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185         if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187             if (val != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 193                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, null, (List) val.getContent());"> 193                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, null, (List) val.getContenðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 195                     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 196                         dealFillDataError(resultFuture, e, inputCopy);</span>
 197 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200             inputParams.add(convertDataType(equalObj));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208                     dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212                         List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 218                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 218                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224         rdbSqlClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225             if (conn.failed()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226                 //Treatment failures</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227                 resultFuture.completeExceptionally(conn.cause());</span>
 228 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 229     private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture, SQLClient rdbSqlClient) {"> 229     private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230         AtomicLong failCounter = new AtomicLong(0);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231         AtomicBoolean finishFlag = new AtomicBoolean(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232         while(!finishFlag.get()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233             CountDownLatch latch = new CountDownLatch(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234             rdbSqlClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235                 try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236                     if(conn.failed()){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237                         connectionStatus.set(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238                         if(failCounter.getAndIncrement() % 1000 == 0){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239                             LOG.error(&quot;getConnection error&quot;, conn.cause());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241                         if(failCounter.get() &gt;= sideInfo.getSideTableInfo().getConnectRetryMaxNum(100)){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242                             resultFuture.completeExceptionally(conn.cause());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243                             finishFlag.set(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245                         return;</span>
 246 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 247                     }
 248                     connectionStatus.set(true);
 249                     ScheduledFuture&lt;?&gt; timerFuture = registerTimer(input, resultFuture);
 250                     cancelTimerWhenComplete(resultFuture, timerFuture);
 251                     handleQuery(conn.result(), inputParams, input, resultFuture);
 252                     finishFlag.set(true);
 253                 } catch (Exception e) {
 254                     dealFillDataError(input, resultFuture, e);
 255                 } finally {
 256                     latch.countDown();
 257                 }
 258 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263         rdbSqlClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264             if (conn.failed()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 265                 //Treatment failures</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 266                 resultFuture.completeExceptionally(conn.cause());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 267                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 268             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 269 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 270             final SQLConnection connection = conn.result();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 271             String sqlCondition = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 272             connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 273                 if (rs.failed()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 274                     LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275                     resultFuture.completeExceptionally(rs.cause());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 276                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 277                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 278                 List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 279                 List&lt;JsonArray&gt; results = rs.result().getResults();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 280                 if (results.size() &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 281                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 282                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, cacheContent, results);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 283                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 283                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConteðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 284                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 285                     } catch (Exception e){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 286                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 287                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 288                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 289                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 290                     dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 291                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 292 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 293                 // and close the connection</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 294                 connection.close(done -&gt; {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 295                     if (done.failed()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 296                         throw new RuntimeException(done.cause());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 297                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 298                 });</span>
 299 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 303                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 303                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309         rdbSqlClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310             if (conn.failed()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311                 //Treatment failures</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312                 resultFuture.completeExceptionally(conn.cause());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316             final SQLConnection connection = conn.result();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317             String sqlCondition = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318             connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319                 if (rs.failed()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320                     LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321                     resultFuture.completeExceptionally(rs.cause());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324                 List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325                 List&lt;JsonArray&gt; results = rs.result().getResults();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326                 if (results.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328                         List&lt;CRow&gt; rowList = getRows(copyCrow, cacheContent, results);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 329                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 329                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331                     } catch (Exception e){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335                     dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336                     dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339                 // and close the connection</span>
 340 =======
 341 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 342             });
 343             try {
 344                 latch.await();
 345             } catch (InterruptedException e) {
 346                 LOG.error(&quot;&quot;, e);
 347             }
 348             if(!finishFlag.get()){
 349                 try {
 350                     Thread.sleep(3000);
 351                 } catch (Exception e){
 352                     LOG.error(&quot;&quot;, e);
 353                 }
 354             }
 355         }
 356     }
 357 
 358 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 359     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {"> 359     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 360         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 361         for (JsonArray line : results) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 362             Row row = fillData(inputRow.f1, line);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 363             if (null != cacheContent &amp;&amp; openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 364                 cacheContent.add(line);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 365             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 366             rowList.add(Tuple2.of(inputRow.f0, row));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 367         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 368         return rowList;</span>
 369 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370                 connection.close(done -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371                     if (done.failed()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372                         throw new RuntimeException(done.cause());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375             });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380     private Object convertDataType(Object val) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381         if (val == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382             // OK</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383         } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384             // OK</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385         } else if (val instanceof Boolean) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386             // OK</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387         } else if (val instanceof String) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388             // OK</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389         } else if (val instanceof Character) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390             // OK</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391         } else if (val instanceof CharSequence) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393         } else if (val instanceof JsonObject) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395         } else if (val instanceof JsonArray) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397         } else if (val instanceof Map) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399         } else if (val instanceof List) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401         } else if (val instanceof byte[]) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403         } else if (val instanceof Instant) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405         } else if (val instanceof Timestamp) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406             val = DateUtil.timestampToString((Timestamp) val);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407         } else if (val instanceof java.util.Date) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408             val = DateUtil.dateToString((java.util.Date)val);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409         } else {</span>
 410 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412     private Object convertDataType(Object val) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413         if (val == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415         } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417         } else if (val instanceof Boolean) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419         } else if (val instanceof String) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421         } else if (val instanceof Character) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423         } else if (val instanceof CharSequence) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425         } else if (val instanceof JsonObject) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427         } else if (val instanceof JsonArray) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429         } else if (val instanceof Map) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431         } else if (val instanceof List) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433         } else if (val instanceof byte[]) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435         } else if (val instanceof Instant) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437         } else if (val instanceof Timestamp) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438             val = DateUtil.timestampToString((Timestamp) val);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439         } else if (val instanceof java.util.Date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440             val = DateUtil.dateToString((java.sql.Date) val);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442             val = val.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444         return val;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449     public String buildCacheKey(Map&lt;String, Object&gt; inputParam) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450         return StringUtils.join(inputParam.values(),&quot;_&quot;);</span>
 451 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 452     }
 453 
 454     @Override
 455     public Row fillData(Row input, Object line) {
 456         JsonArray jsonArray = (JsonArray) line;
 457         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 458         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 459             Object obj = input.getField(entry.getValue());
 460             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 461             row.setField(entry.getKey(), obj);
 462         }
 463 
 464         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 465             if (jsonArray == null) {
 466                 row.setField(entry.getKey(), null);
 467             } else {
 468                 String fieldType = sideInfo.getSelectSideFieldType(entry.getValue());
 469                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fieldType);
 470                 row.setField(entry.getKey(), object);
 471             }
 472         }
 473 
 474         return row;
 475     }
 476 
 477 
 478     @Override
 479     public void close() throws Exception {
 480         super.close();
 481         if (rdbSqlClient != null) {
 482             rdbSqlClient.close();
 483         }
 484 
 485         if(executor != null){
 486             executor.shutdown();
 487         }
 488 
 489     }
 490 
 491     public void setRdbSqlClient(SQLClient rdbSqlClient) {
 492         this.rdbSqlClient = rdbSqlClient;
 493     }
 494 
 495     public void setExecutor(ThreadPoolExecutor executor) {
 496         this.executor = executor;
 497     }
 498 
<abbr title=" 499     private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture){"> 499     private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResulðŸ”µ</abbr>
 500         String key = buildCacheKey(inputParams);
 501         JsonArray params = new JsonArray(Lists.newArrayList(inputParams.values()));
 502         connection.queryWithParams(sideInfo.getSqlCondition(), params, rs -&gt; {
 503             if (rs.failed()) {
 504                 dealFillDataError(input, resultFuture, rs.cause());
 505                 return;
 506             }
 507 
 508             List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 509 
 510             int resultSize = rs.result().getResults().size();
 511             if (resultSize &gt; 0) {
 512                 List&lt;CRow&gt; rowList = Lists.newArrayList();
 513 
 514                 for (JsonArray line : rs.result().getResults()) {
 515                     Row row = fillData(input.row(), line);
 516                     if (openCache()) {
 517                         cacheContent.add(line);
 518                     }
 519                     rowList.add(new CRow(row, input.change()));
 520                 }
 521 
 522                 if (openCache()) {
 523                     putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 524                 }
 525 
 526                 resultFuture.complete(rowList);
 527             } else {
 528                 dealMissKey(input, resultFuture);
 529                 if (openCache()) {
 530                     putCache(key, CacheMissVal.getMissKeyObj());
 531                 }
 532             }
 533 
 534             // and close the connection
 535             connection.close(done -&gt; {
 536                 if (done.failed()) {
 537                     throw new RuntimeException(done.cause());
 538                 }
 539             });
 540         });
 541     }
 542 
 543     private Map&lt;String, Object&gt; formatInputParam(Map&lt;String, Object&gt; inputParam){
 544         Map&lt;String, Object&gt; result = Maps.newHashMap();
 545         inputParam.forEach((k,v) -&gt; {
 546             result.put(k, convertDataType(v));
 547         });
 548         return result;
 549     }
 550 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 package com.dtstack.flink.sql.side.rdb.async;
  21 
  22 import com.dtstack.flink.sql.enums.ECacheContentType;
  23 import com.dtstack.flink.sql.factory.DTThreadFactory;
  24 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  25 import com.dtstack.flink.sql.side.BaseSideInfo;
  26 import com.dtstack.flink.sql.side.CacheMissVal;
  27 import com.dtstack.flink.sql.side.cache.CacheObj;
  28 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  29 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  30 import com.google.common.collect.Lists;
  31 import org.apache.flink.api.java.tuple.Tuple2;
  32 import com.google.common.collect.Maps;
  33 import io.vertx.core.json.JsonArray;
  34 import io.vertx.ext.sql.SQLClient;
  35 import io.vertx.ext.sql.SQLConnection;
  36 import org.apache.commons.lang3.StringUtils;
  37 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  38 import org.apache.flink.types.Row;
  39 import org.slf4j.Logger;
  40 import org.slf4j.LoggerFactory;
  41 
  42 import java.util.List;
  43 import java.util.Map;
  44 import java.util.concurrent.*;
  45 import java.util.concurrent.atomic.AtomicBoolean;
  46 import java.util.concurrent.atomic.AtomicLong;
  47 
  48 /**
  49  * Date: 2018/11/26
  50  * Company: www.dtstack.com
  51  *
  52  * @author maqi
  53  */
  54 
  55 public class RdbAsyncReqRow extends BaseAsyncReqRow {
  56 
  57     private static final long serialVersionUID = 2098635244857937720L;
  58 
  59     private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  60 
  61     public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  62 
<abbr title="  63     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;">  63     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() *ðŸ”µ</abbr>
  64 
<abbr title="  65     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  65     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTðŸ”µ</abbr>
  66 
  67     public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  68 
  69     public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  70 
  71     public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  72 
<abbr title="  73     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  73     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSouðŸ”µ</abbr>
  74 
  75     public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  76 
  77     private transient SQLClient rdbSqlClient;
  78 
  79     private AtomicBoolean connectionStatus = new AtomicBoolean(true);
  80 
  81     private transient ThreadPoolExecutor executor;
  82 
  83     public RdbAsyncReqRow(BaseSideInfo sideInfo) {
  84         super(sideInfo);
  85         init(sideInfo);
  86     }
  87 
  88     protected void init(BaseSideInfo sideInfo) {
  89         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  90         int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title="  91         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;">  91         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() :ðŸ”µ</abbr>
  92         rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
  93     }
  94 
  95     @Override
  96     protected void preInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture){
  97 
  98     }
  99 
 100 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 101     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 102     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 102     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) thðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         Tuple2&lt;Boolean,Row&gt; inputCopy =  Tuple2.of(input.f0,input.f1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107             Object equalObj = inputCopy.f1.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108             if (equalObj == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112             inputParams.add(equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 113         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 114 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 115         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 116         if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 117             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 118             if (val != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 119                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 120                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 121                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 122                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 123                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 124                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, null, (List) val.getContent());"> 124                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, null, (List) val.getContenðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126                     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 130                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 130                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136         rdbSqlClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137             if (conn.failed()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138                 //Treatment failures</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139                 resultFuture.completeExceptionally(conn.cause());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143             final SQLConnection connection = conn.result();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144             String sqlCondition = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145             connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146                 if (rs.failed()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147                     LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148                     resultFuture.completeExceptionally(rs.cause());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151                 List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152                 List&lt;JsonArray&gt; results = rs.result().getResults();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153                 if (results.size() &gt; 0) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155                         List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, cacheContent, results);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 156                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 156                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConteðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158                     } catch (Exception e){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161                 } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163                     dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166                 // and close the connection</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167                 connection.close(done -&gt; {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168                     if (done.failed()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169                         throw new RuntimeException(done.cause());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171                 });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172             });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173         });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174     }</span>
 175 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178         CRow copyCrow = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180         for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181             Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182             if (equalObj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183                 dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186             inputParams.add(convertDataType(equalObj));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189         String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191             CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                     dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198                         List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 204                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 204                     resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210         rdbSqlClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211             if (conn.failed()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212                 //Treatment failures</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213                 resultFuture.completeExceptionally(conn.cause());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217             final SQLConnection connection = conn.result();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218             String sqlCondition = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219             connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220                 if (rs.failed()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221                     LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222                     resultFuture.completeExceptionally(rs.cause());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225                 List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226                 List&lt;JsonArray&gt; results = rs.result().getResults();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227                 if (results.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229                         List&lt;CRow&gt; rowList = getRows(copyCrow, cacheContent, results);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 230                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));"> 230                         dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheConteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231                         resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232                     } catch (Exception e){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233                         dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236                     dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237                     dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240                 // and close the connection</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241                 connection.close(done -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242                     if (done.failed()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243                         throw new RuntimeException(done.cause());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245                 });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246             });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248     }</span>
 249 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250 </span>
 251 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 252 
 253 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 254     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {"> 254     protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 255         List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 256         for (JsonArray line : results) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 257             Row row = fillData(inputRow.f1, line);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 258             if (null != cacheContent &amp;&amp; openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 259                 cacheContent.add(line);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 260             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 261             rowList.add(Tuple2.of(inputRow.f0, row));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 262         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 263         return rowList;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 264     }</span>
 265 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266     protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267         List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268         for (JsonArray line : results) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269             Row row = fillData(inputRow.row(), line);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270             if (null != cacheContent &amp;&amp; openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271                 cacheContent.add(line);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273             rowList.add(new CRow(row, inputRow.change()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275         return rowList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276     }</span>
 277 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278 </span>
 279 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 280 
 281     @Override
<abbr title=" 282     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 282     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
 283 
 284         AtomicLong networkLogCounter = new AtomicLong(0L);
 285         while (!connectionStatus.get()){//network is unhealth
 286             if(networkLogCounter.getAndIncrement() % 1000 == 0){
 287                 LOG.info(&quot;network unhealth to block task&quot;);
 288             }
 289             Thread.sleep(100);
 290         }
 291         Map&lt;String, Object&gt; params = formatInputParam(inputParams);
 292         executor.execute(() -&gt; connectWithRetry(params, input, resultFuture, rdbSqlClient));
 293     }
 294 
<abbr title=" 295     private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture, SQLClient rdbSqlClient) {"> 295     private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
 296         AtomicLong failCounter = new AtomicLong(0);
 297         AtomicBoolean finishFlag = new AtomicBoolean(false);
 298         while(!finishFlag.get()){
 299             CountDownLatch latch = new CountDownLatch(1);
 300             rdbSqlClient.getConnection(conn -&gt; {
 301                 try {
 302                     if(conn.failed()){
 303                         connectionStatus.set(false);
 304                         if(failCounter.getAndIncrement() % 1000 == 0){
 305                             LOG.error(&quot;getConnection error&quot;, conn.cause());
 306                         }
 307                         if(failCounter.get() &gt;= sideInfo.getSideTableInfo().getConnectRetryMaxNum(100)){
 308                             resultFuture.completeExceptionally(conn.cause());
 309                             finishFlag.set(true);
 310                         }
 311                         return;
 312                     }
 313                     connectionStatus.set(true);
 314                     ScheduledFuture&lt;?&gt; timerFuture = registerTimer(input, resultFuture);
 315                     cancelTimerWhenComplete(resultFuture, timerFuture);
 316                     handleQuery(conn.result(), inputParams, input, resultFuture);
 317                     finishFlag.set(true);
 318                 } catch (Exception e) {
 319                     dealFillDataError(input, resultFuture, e);
 320                 } finally {
 321                     latch.countDown();
 322                 }
 323             });
 324             try {
 325                 latch.await();
 326             } catch (InterruptedException e) {
 327                 LOG.error(&quot;&quot;, e);
 328             }
 329             if(!finishFlag.get()){
 330                 try {
 331                     Thread.sleep(3000);
 332                 } catch (Exception e){
 333                     LOG.error(&quot;&quot;, e);
 334                 }
 335             }
 336         }
 337     }
 338 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 339 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340 private Object convertDataType(Object val) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341         if (val == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342             // OK</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343         } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344             // OK</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345         } else if (val instanceof Boolean) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346             // OK</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347         } else if (val instanceof String) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348             // OK</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349         } else if (val instanceof Character) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350             // OK</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351         } else if (val instanceof CharSequence) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353         } else if (val instanceof JsonObject) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355         } else if (val instanceof JsonArray) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357         } else if (val instanceof Map) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359         } else if (val instanceof List) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361         } else if (val instanceof byte[]) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363         } else if (val instanceof Instant) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365         } else if (val instanceof Timestamp) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366             val = DateUtil.timestampToString((Timestamp) val);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367         } else if (val instanceof java.util.Date) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368             val = DateUtil.dateToString((java.util.Date)val);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370             val = val.toString();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372         return val;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373     }</span>
 374 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375 private Object convertDataType(Object val) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376         if (val == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378         } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380         } else if (val instanceof Boolean) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382         } else if (val instanceof String) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384         } else if (val instanceof Character) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385             // OK</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386         } else if (val instanceof CharSequence) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388         } else if (val instanceof JsonObject) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390         } else if (val instanceof JsonArray) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392         } else if (val instanceof Map) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394         } else if (val instanceof List) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396         } else if (val instanceof byte[]) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398         } else if (val instanceof Instant) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400         } else if (val instanceof Timestamp) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401             val = DateUtil.timestampToString((Timestamp) val);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402         } else if (val instanceof java.util.Date) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403             val = DateUtil.dateToString((java.sql.Date) val);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405             val = val.toString();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407         return val;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409     }</span>
 410 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 411 
 412 
 413     @Override
 414     public String buildCacheKey(Map&lt;String, Object&gt; inputParam) {
 415         return StringUtils.join(inputParam.values(),&quot;_&quot;);
 416     }
 417 
 418     @Override
 419     public Row fillData(Row input, Object line) {
 420         JsonArray jsonArray = (JsonArray) line;
 421         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 422         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 423             Object obj = input.getField(entry.getValue());
 424             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 425             row.setField(entry.getKey(), obj);
 426         }
 427 
 428         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 429             if (jsonArray == null) {
 430                 row.setField(entry.getKey(), null);
 431             } else {
 432                 String fieldType = sideInfo.getSelectSideFieldType(entry.getValue());
 433                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fieldType);
 434                 row.setField(entry.getKey(), object);
 435             }
 436         }
 437 
 438         return row;
 439     }
 440 
 441 
 442     @Override
 443     public void close() throws Exception {
 444         super.close();
 445         if (rdbSqlClient != null) {
 446             rdbSqlClient.close();
 447         }
 448 
 449         if(executor != null){
 450             executor.shutdown();
 451         }
 452 
 453     }
 454 
 455     public void setRdbSqlClient(SQLClient rdbSqlClient) {
 456         this.rdbSqlClient = rdbSqlClient;
 457     }
 458 
 459     public void setExecutor(ThreadPoolExecutor executor) {
 460         this.executor = executor;
 461     }
 462 
<abbr title=" 463     private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture){"> 463     private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResulðŸ”µ</abbr>
 464         String key = buildCacheKey(inputParams);
 465         JsonArray params = new JsonArray(Lists.newArrayList(inputParams.values()));
 466         connection.queryWithParams(sideInfo.getSqlCondition(), params, rs -&gt; {
 467             if (rs.failed()) {
 468                 dealFillDataError(input, resultFuture, rs.cause());
 469                 return;
 470             }
 471 
 472             List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 473 
 474             int resultSize = rs.result().getResults().size();
 475             if (resultSize &gt; 0) {
 476                 List&lt;CRow&gt; rowList = Lists.newArrayList();
 477 
 478                 for (JsonArray line : rs.result().getResults()) {
 479                     Row row = fillData(input.row(), line);
 480                     if (openCache()) {
 481                         cacheContent.add(line);
 482                     }
 483                     rowList.add(new CRow(row, input.change()));
 484                 }
 485 
 486                 if (openCache()) {
 487                     putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 488                 }
 489 
 490                 resultFuture.complete(rowList);
 491             } else {
 492                 dealMissKey(input, resultFuture);
 493                 if (openCache()) {
 494                     putCache(key, CacheMissVal.getMissKeyObj());
 495                 }
 496             }
 497 
 498             // and close the connection
 499             connection.close(done -&gt; {
 500                 if (done.failed()) {
 501                     throw new RuntimeException(done.cause());
 502                 }
 503             });
 504         });
 505     }
 506 
 507     private Map&lt;String, Object&gt; formatInputParam(Map&lt;String, Object&gt; inputParam){
 508         Map&lt;String, Object&gt; result = Maps.newHashMap();
 509         inputParam.forEach((k,v) -&gt; {
 510             result.put(k, convertDataType(v));
 511         });
 512         return result;
 513     }
 514 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.rdb.async;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheContentType;
  21 import com.dtstack.flink.sql.factory.DTThreadFactory;
  22 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  23 import com.dtstack.flink.sql.side.BaseSideInfo;
  24 import com.dtstack.flink.sql.side.CacheMissVal;
  25 import com.dtstack.flink.sql.side.cache.CacheObj;
  26 import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  27 import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  28 import com.google.common.collect.Lists;
  29 import com.google.common.collect.Maps;
  30 import io.vertx.core.json.JsonArray;
  31 import io.vertx.ext.sql.SQLClient;
  32 import io.vertx.ext.sql.SQLConnection;
  33 import java.util.List;
  34 import java.util.Map;
  35 import java.util.concurrent.*;
  36 import java.util.concurrent.atomic.AtomicBoolean;
  37 import java.util.concurrent.atomic.AtomicLong;
  38 import org.apache.commons.lang3.StringUtils;
  39 import org.apache.flink.api.java.tuple.Tuple2;
  40 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  41 import org.apache.flink.types.Row;
  42 import org.slf4j.Logger;
  43 import org.slf4j.LoggerFactory;
  44 
  45 
  46 /**
  47  * Date: 2018/11/26
  48  * Company: www.dtstack.com
  49  *
  50  * @author maqi
  51  */
  52 public class RdbAsyncReqRow extends BaseAsyncReqRow {
  53     private static final long serialVersionUID = 2098635244857937720L;
  54 
  55     private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  56 
  57     public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  58 
<abbr title="  59     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;">  59     public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() *ðŸ”µ</abbr>
  60 
<abbr title="  61     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  61     public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTðŸ”µ</abbr>
  62 
  63     public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  64 
  65     public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  66 
  67     public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  68 
<abbr title="  69     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  69     public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSouðŸ”µ</abbr>
  70 
  71     public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  72 
  73     private transient SQLClient rdbSqlClient;
  74 
  75     private AtomicBoolean connectionStatus = new AtomicBoolean(true);
  76 
  77     private transient ThreadPoolExecutor executor;
  78 
  79     public RdbAsyncReqRow(BaseSideInfo sideInfo) {
  80         super(sideInfo);
  81         init(sideInfo);
  82     }
  83 
  84     protected void init(BaseSideInfo sideInfo) {
  85         RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  86         int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title="  87         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;">  87         int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() :ðŸ”µ</abbr>
  88         rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
  89     }
  90 
  91     @Override
  92     protected void preInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) {
  93     }
  94 
  95     @Override
<abbr title="  96     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {">  96     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
  97         AtomicLong networkLogCounter = new AtomicLong(0L);
  98         while (!connectionStatus.get()) {
  99         //network is unhealth
 100             if ((networkLogCounter.getAndIncrement() % 1000) == 0) {
 101                 LOG.info(&quot;network unhealth to block task&quot;);
 102             }
 103             Thread.sleep(100);
 104         }
 105         Map&lt;String, Object&gt; params = formatInputParam(inputParams);
 106         executor.execute(() -&gt; connectWithRetry(params, input, resultFuture, rdbSqlClient));
 107     }
 108 
<abbr title=" 109     private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture, SQLClient rdbSqlClient) {"> 109     private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
 110         AtomicLong failCounter = new AtomicLong(0);
 111         AtomicBoolean finishFlag = new AtomicBoolean(false);
 112         while (!finishFlag.get()) {
 113             CountDownLatch latch = new CountDownLatch(1);
 114             rdbSqlClient.getConnection(( conn) -&gt; {
 115                 try {
 116                     if (conn.failed()) {
 117                         connectionStatus.set(false);
 118                         if ((failCounter.getAndIncrement() % 1000) == 0) {
 119                             LOG.error(&quot;getConnection error&quot;, conn.cause());
 120                         }
<abbr title=" 121                         if (failCounter.get() &gt;= sideInfo.getSideTableInfo().getConnectRetryMaxNum(100)) {"> 121                         if (failCounter.get() &gt;= sideInfo.getSideTableInfo().getConnectRetryMaxNum(100)) ðŸ”µ</abbr>
 122                             resultFuture.completeExceptionally(conn.cause());
 123                             finishFlag.set(true);
 124                         }
 125                         return;
 126                     }
 127                     connectionStatus.set(true);
 128                     ScheduledFuture&lt;?&gt; timerFuture = registerTimer(input, resultFuture);
 129                     cancelTimerWhenComplete(resultFuture, timerFuture);
 130                     handleQuery(conn.result(), inputParams, input, resultFuture);
 131                     finishFlag.set(true);
 132                 } catch ( e) {
 133                     dealFillDataError(input, resultFuture, e);
 134                 } finally {
 135                     latch.countDown();
 136                 }
 137             });
 138             try {
 139                 latch.await();
 140             } catch (java.lang.InterruptedException e) {
 141                 LOG.error(&quot;&quot;, e);
 142             }
 143             if (!finishFlag.get()) {
 144                 try {
 145                     Thread.sleep(3000);
 146                 } catch (java.lang.Exception e) {
 147                     LOG.error(&quot;&quot;, e);
 148                 }
 149             }
 150         }
 151     }
 152 
 153     private Object convertDataType(Object val) {
 154         if (val == null) {
 155             // OK
 156         } else if ((val instanceof Number) &amp;&amp; (!(val instanceof BigDecimal))) {
 157             // OK
 158         } else if (val instanceof Boolean) {
 159             // OK
 160         } else if (val instanceof String) {
 161             // OK
 162         } else if (val instanceof Character) {
 163             // OK
 164         } else if (val instanceof CharSequence) {
 165         } else if (val instanceof JsonObject) {
 166         } else if (val instanceof JsonArray) {
 167         } else if (val instanceof Map) {
 168         } else if (val instanceof List) {
 169         } else if (val instanceof byte[]) {
 170         } else if (val instanceof Instant) {
 171         } else if (val instanceof Timestamp) {
 172             val = DateUtil.timestampToString(((Timestamp) (val)));
 173         } else if (val instanceof java.util.Date) {
 174             val = DateUtil.dateToString(((java.sql.Date) (val)));
 175         } else {
 176             val = val.toString();
 177         }
 178         return val;
 179     }
 180 
 181     @Override
 182     public String buildCacheKey(Map&lt;String, Object&gt; inputParam) {
 183         return StringUtils.join(inputParam.values(),&quot;_&quot;);
 184     }
 185 
 186     @Override
 187     public Row fillData(Row input, Object line) {
 188         JsonArray jsonArray = ((JsonArray) (line));
 189         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 190         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 191             Object obj = input.getField(entry.getValue());
 192             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 193             row.setField(entry.getKey(), obj);
 194         }
 195         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 196             if (jsonArray == null) {
 197                 row.setField(entry.getKey(), null);
 198             } else {
 199                 String fieldType = sideInfo.getSelectSideFieldType(entry.getValue());
 200                 Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fieldType);
 201                 row.setField(entry.getKey(), object);
 202             }
 203         }
 204         return row;
 205     }
 206 
 207     @Override
 208     public void close() throws Exception {
 209         super.close();
 210         if (rdbSqlClient != null) {
 211             rdbSqlClient.close();
 212         }
 213         if (executor != null) {
 214             executor.shutdown();
 215         }
 216     }
 217 
 218     public void setRdbSqlClient(SQLClient rdbSqlClient) {
 219         this.rdbSqlClient = rdbSqlClient;
 220     }
 221 
 222     public void setExecutor(ThreadPoolExecutor executor) {
 223         this.executor = executor;
 224     }
 225 
<abbr title=" 226     private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, Tuple2&lt;Boolean, Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean, Row&gt;&gt; resultFuture) {"> 226     private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, Tuple2&lt;Boolean, RðŸ”µ</abbr>
 227         String key = buildCacheKey(inputParams);
 228         JsonArray params = new JsonArray(Lists.newArrayList(inputParams.values()));
 229         connection.queryWithParams(sideInfo.getSqlCondition(), params, ( rs) -&gt; {
 230             if (rs.failed()) {
 231                 dealFillDataError(input, resultFuture, rs.cause());
 232                 return;
 233             }
 234             List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 235             int resultSize = rs.result().getResults().size();
 236             if (resultSize &gt; 0) {
 237                 List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();
 238                 for (JsonArray line : rs.result().getResults()) {
 239                     Row row = fillData(input.row(),
 240 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 241 inputCopy</span>
 242 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 243 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 243 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 244 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 line</span>
 247 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 248                     );
 249                     if (openCache()) {
 250                         cacheContent.add(line);
 251                     }
 252                     rowList.add(new CRow(row, input.change()));
 253                 }
 254                 if (openCache()) {
 255                     putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 256                 }
 257                 resultFuture.complete(rowList);
 258             } else {
 259                 dealMissKey(input, resultFuture);
 260                 if (openCache()) {
 261                     putCache(key, CacheMissVal.getMissKeyObj());
 262                 }
 263             }
 264                 // and close the connection
 265             connection.close(( done) -&gt; {
 266                 if (done.failed()) {
 267                     throw new RuntimeException(done.cause());
 268                 }
 269             });
 270         });
 271     }
 272 
 273     private Map&lt;
 274 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 275 Tuple2</span>
 276 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 277 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 277 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 278 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280 String</span>
 281 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 282     &lt;Boolean, Row&gt;, Object&gt; formatInputParam(Map&lt;String, Object&gt; inputParam) {
 283         Map&lt;String, Object&gt; result = Maps.newHashMap();
 284         inputParam.forEach(( k, v) -&gt; {
 285             result.put(k, convertDataType(v));
 286         });
 287         return result;
 288     }
 289 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql.side.rdb.async;
  21  
  22  import com.dtstack.flink.sql.enums.ECacheContentType;

  23  import com.dtstack.flink.sql.side.BaseAsyncReqRow;

  24  import com.dtstack.flink.sql.side.CacheMissVal;
  25  import com.dtstack.flink.sql.side.BaseSideInfo;
  26  import com.dtstack.flink.sql.side.cache.CacheObj;
  27  import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  28  import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import com.dtstack.flink.sql.util.DateUtil;</span>


  30  import io.vertx.core.json.JsonArray;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import io.vertx.core.json.JsonObject;</span>
  32  import io.vertx.ext.sql.SQLClient;
  33  import io.vertx.ext.sql.SQLConnection;
  34  import com.google.common.collect.Lists;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import org.apache.flink.api.java.tuple.Tuple2;</span>
  36  import org.apache.flink.configuration.Configuration;

  37  import org.apache.flink.streaming.api.functions.async.ResultFuture;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
  40  import org.apache.flink.types.Row;
  41  import org.slf4j.Logger;
  42  import org.slf4j.LoggerFactory;
  43  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import java.math.BigDecimal;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import java.sql.Timestamp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import java.time.Instant;</span>
  47  import java.util.List;
  48  import java.util.Map;



  49  
  50  /**
  51   * Date: 2018/11/26
  52   * Company: www.dtstack.com
  53   *
  54   * @author maqi
  55   */
  56  
  57  public class RdbAsyncReqRow extends BaseAsyncReqRow {
  58  
  59      private static final long serialVersionUID = 2098635244857937720L;
  60  
  61      private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  62  
  63      public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  64  
  65      public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;
  66  
<abbr title="  67      public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  67      public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_ðŸ”µ</abbr>
  68  
  69      public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  70  
  71      public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  72  
  73      public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  74  
<abbr title="  75      public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  75      public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvidðŸ”µ</abbr>
  76  
  77      public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  78  
  79      private transient SQLClient rdbSqlClient;
  80  




  81      public RdbAsyncReqRow(BaseSideInfo sideInfo) {
  82          super(sideInfo);
  83          init(sideInfo);
  84      }
  85  
  86      protected void init(BaseSideInfo sideInfo) {
  87          RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  88          int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title="  89          int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;">  89          int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAðŸ”µ</abbr>
  90          rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
  91      }
  92  
  93      @Override
  94      public void open(Configuration parameters) throws Exception {
  95          super.open(parameters);
  96          RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  97          LOG.info(&quot;rdb dim table config info: {} &quot;, rdbSideTableInfo.toString());
  98      }
  99  
 100      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -        CRow copyCrow = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 103 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 103 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws ExceðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +        Tuple2&lt;Boolean,Row&gt; inputCopy =  Tuple2.of(input.f0,input.f1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +</span>
 106          JsonArray inputParams = new JsonArray();
 107          for (Integer conValIndex : sideInfo.getEqualValIndex()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -            Object equalObj = copyCrow.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +            Object equalObj = inputCopy.f1.getField(conValIndex);</span>
 110              if (equalObj == null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -                dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +                dealMissKey(inputCopy, resultFuture);</span>
 113                  return;
 114              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -            inputParams.add(convertDataType(equalObj));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +            inputParams.add(equalObj);</span>
 117          }
 118  
 119          String key = buildCacheKey(inputParams);
 120          if (openCache()) {
 121              CacheObj val = getFromCache(key);
 122              if (val != null) {
 123                  if (ECacheContentType.MissVal == val.getType()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -                    dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                    dealMissKey(inputCopy, resultFuture);</span>
 126                      return;
 127                  } else if (ECacheContentType.MultiLine == val.getType()) {
 128                      try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -                        List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +                        List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, null, (List) val.getContent());</span>
 131                          resultFuture.complete(rowList);
 132                      } catch (Exception e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -                        dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +                        dealFillDataError(resultFuture, e, inputCopy);</span>


































 135                      }
 136                  } else {
<abbr title=" 137                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 137                      resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.geðŸ”µ</abbr>
 138                  }
 139                  return;
 140              }
 141          }
 142  
 143          rdbSqlClient.getConnection(conn -&gt; {
 144              if (conn.failed()) {
 145                  //Treatment failures
 146                  resultFuture.completeExceptionally(conn.cause());
 147                  return;
 148              }
 149  
 150              final SQLConnection connection = conn.result();
 151              String sqlCondition = sideInfo.getSqlCondition();
 152              connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {
 153                  if (rs.failed()) {
 154                      LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());
 155                      resultFuture.completeExceptionally(rs.cause());
 156                      return;
 157                  }
 158                  List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();
 159                  List&lt;JsonArray&gt; results = rs.result().getResults();
 160                  if (results.size() &gt; 0) {
 161                      try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -                        List&lt;CRow&gt; rowList = getRows(copyCrow, cacheContent, results);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +                        List&lt;Tuple2&lt;Boolean,Row&gt;&gt; rowList = getRows(inputCopy, cacheContent, results);</span>
 164                          dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));
 165                          resultFuture.complete(rowList);
 166                      } catch (Exception e){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -                        dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +                        dealFillDataError(resultFuture, e, inputCopy);</span>
 169                      }
 170                  } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -                    dealMissKey(copyCrow, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +                    dealMissKey(inputCopy, resultFuture);</span>
 173                      dealCacheData(key, CacheMissVal.getMissKeyObj());
 174                  }
 175  
 176                  // and close the connection
 177                  connection.close(done -&gt; {
 178                      if (done.failed()) {
 179                          throw new RuntimeException(done.cause());
 180                      }
 181                  });










 182              });
 183          });













 184      }
 185  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -    private Object convertDataType(Object val) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -        if (val == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -            // OK</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -        } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -            // OK</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -        } else if (val instanceof Boolean) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -            // OK</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -        } else if (val instanceof String) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -            // OK</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -        } else if (val instanceof Character) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -            // OK</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -        } else if (val instanceof CharSequence) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -        } else if (val instanceof JsonObject) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -        } else if (val instanceof JsonArray) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -        } else if (val instanceof Map) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -        } else if (val instanceof List) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -        } else if (val instanceof byte[]) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -        } else if (val instanceof Instant) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -        } else if (val instanceof Timestamp) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -            val = DateUtil.timestampToString((Timestamp) val);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -        } else if (val instanceof java.util.Date) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -            val = DateUtil.dateToString((java.util.Date)val);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -            val = val.toString();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -        return val;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -    protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -        List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 224 +    protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {"> 224 +    protected List&lt;Tuple2&lt;Boolean, Row&gt;&gt; getRows(Tuple2&lt;Boolean, Row&gt; inputRow, List&lt;JsonArray&gt; cacheContent, ListðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +        List&lt;Tuple2&lt;Boolean, Row&gt;&gt; rowList = Lists.newArrayList();</span>
 226          for (JsonArray line : results) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -            Row row = fillData(inputRow.row(), line);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +            Row row = fillData(inputRow.f1, line);</span>
 229              if (null != cacheContent &amp;&amp; openCache()) {
 230                  cacheContent.add(line);
 231              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -            rowList.add(new CRow(row, inputRow.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +            rowList.add(Tuple2.of(inputRow.f0, row));</span>
 234          }
 235          return rowList;






 236      }
 237  
 238      @Override
 239      public Row fillData(Row input, Object line) {
 240          JsonArray jsonArray = (JsonArray) line;
 241          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 242          String[] fields = sideInfo.getSideTableInfo().getFieldTypes();
 243          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 244              Object obj = input.getField(entry.getValue());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 245 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 245 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -            if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -                obj = ((Timestamp) obj).getTime();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +            obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
 251              row.setField(entry.getKey(), obj);
 252          }
 253  
 254          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 255              if (jsonArray == null) {
 256                  row.setField(entry.getKey(), null);
 257              } else {
<abbr title=" 258                  Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.getValue()]);"> 258                  Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.getValue()ðŸ”µ</abbr>


 259                  row.setField(entry.getKey(), object);
 260              }
 261          }
 262  
 263          return row;
 264      }

 265  
 266      @Override
 267      public void close() throws Exception {
 268          super.close();
 269          if (rdbSqlClient != null) {
 270              rdbSqlClient.close();
 271          }
 272  
 273      }
 274  
 275      public String buildCacheKey(JsonArray jsonArray) {
 276          StringBuilder sb = new StringBuilder();
 277          for (Object ele : jsonArray.getList()) {
 278              sb.append(ele.toString())
 279                      .append(&quot;_&quot;);
 280          }
 281  
 282          return sb.toString();




 283      }
 284  
 285      public void setRdbSqlClient(SQLClient rdbSqlClient) {
 286          this.rdbSqlClient = rdbSqlClient;
 287      }
 288  























































 289  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  package com.dtstack.flink.sql.side.rdb.async;
  21  
  22  import com.dtstack.flink.sql.enums.ECacheContentType;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import com.dtstack.flink.sql.factory.DTThreadFactory;</span>
  24  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import com.dtstack.flink.sql.side.BaseSideInfo;</span>
  26  import com.dtstack.flink.sql.side.CacheMissVal;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import com.dtstack.flink.sql.side.BaseSideInfo;</span>
  28  import com.dtstack.flink.sql.side.cache.CacheObj;
  29  import com.dtstack.flink.sql.side.rdb.table.RdbSideTableInfo;
  30  import com.dtstack.flink.sql.side.rdb.util.SwitchUtil;
  31  import com.dtstack.flink.sql.util.DateUtil;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import com.google.common.collect.Lists;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import com.google.common.collect.Maps;</span>
  34  import io.vertx.core.json.JsonArray;
  35  import io.vertx.core.json.JsonObject;
  36  import io.vertx.ext.sql.SQLClient;
  37  import io.vertx.ext.sql.SQLConnection;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import com.google.common.collect.Lists;</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import org.apache.commons.lang3.StringUtils;</span>
  41  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  42  import org.apache.flink.table.runtime.types.CRow;
  43  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  44  import org.apache.flink.types.Row;
  45  import org.slf4j.Logger;
  46  import org.slf4j.LoggerFactory;
  47  
  48  import java.math.BigDecimal;
  49  import java.sql.Timestamp;
  50  import java.time.Instant;
  51  import java.util.List;
  52  import java.util.Map;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  53 +import java.util.concurrent.*;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +import java.util.concurrent.atomic.AtomicBoolean;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  55 +import java.util.concurrent.atomic.AtomicLong;</span>
  56  
  57  /**
  58   * Date: 2018/11/26
  59   * Company: www.dtstack.com
  60   *
  61   * @author maqi
  62   */
  63  
  64  public class RdbAsyncReqRow extends BaseAsyncReqRow {
  65  
  66      private static final long serialVersionUID = 2098635244857937720L;
  67  
  68      private static final Logger LOG = LoggerFactory.getLogger(RdbAsyncReqRow.class);
  69  
  70      public final static int DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE = 1;
  71  
  72      public final static int DEFAULT_VERTX_WORKER_POOL_SIZE = Runtime.getRuntime().availableProcessors() * 2;
  73  
<abbr title="  74      public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_POOL_SIZE;">  74      public final static int DEFAULT_DB_CONN_POOL_SIZE = DEFAULT_VERTX_EVENT_LOOP_POOL_SIZE + DEFAULT_VERTX_WORKER_ðŸ”µ</abbr>
  75  
  76      public final static int MAX_DB_CONN_POOL_SIZE_LIMIT = 20;
  77  
  78      public final static int DEFAULT_IDLE_CONNECTION_TEST_PEROID = 60;
  79  
  80      public final static boolean DEFAULT_TEST_CONNECTION_ON_CHECKIN = true;
  81  
<abbr title="  82      public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvider&quot;;">  82      public final static String DT_PROVIDER_CLASS = &quot;com.dtstack.flink.sql.side.rdb.provider.DTC3P0DataSourceProvidðŸ”µ</abbr>
  83  
  84      public final static String PREFERRED_TEST_QUERY_SQL = &quot;select 1 from dual&quot;;
  85  
  86      private transient SQLClient rdbSqlClient;
  87  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +    private AtomicBoolean connectionStatus = new AtomicBoolean(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +    private transient ThreadPoolExecutor executor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +</span>
  92      public RdbAsyncReqRow(BaseSideInfo sideInfo) {
  93          super(sideInfo);
  94          init(sideInfo);
  95      }
  96  
  97      protected void init(BaseSideInfo sideInfo) {
  98          RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();
  99          int defaultAsyncPoolSize = Math.min(MAX_DB_CONN_POOL_SIZE_LIMIT, DEFAULT_DB_CONN_POOL_SIZE);
<abbr title=" 100          int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAsyncPoolSize;"> 100          int rdbPoolSize = rdbSideTableInfo.getAsyncPoolSize() &gt; 0 ? rdbSideTableInfo.getAsyncPoolSize() : defaultAðŸ”µ</abbr>
 101          rdbSideTableInfo.setAsyncPoolSize(rdbPoolSize);
 102      }
 103  
 104      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -    public void open(Configuration parameters) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -        super.open(parameters);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -        RdbSideTableInfo rdbSideTableInfo = (RdbSideTableInfo) sideInfo.getSideTableInfo();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -        LOG.info(&quot;rdb dim table config info: {} &quot;, rdbSideTableInfo.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -        CRow copyCrow = new CRow(input.row(), input.change());</span>



<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        JsonArray inputParams = new JsonArray();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -        for (Integer conValIndex : sideInfo.getEqualValIndex()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -            Object equalObj = copyCrow.row().getField(conValIndex);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -            if (equalObj == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -                dealMissKey(copyCrow, resultFuture);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -            inputParams.add(convertDataType(equalObj));</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        if (openCache()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -            CacheObj val = getFromCache(key);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -            if (val != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -                if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -                    dealMissKey(copyCrow, resultFuture);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -                } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -                        List&lt;CRow&gt; rowList = getRows(copyCrow, null, (List) val.getContent());</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -                        resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -                    } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -                        dealFillDataError(resultFuture, e, copyCrow);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +    protected void preInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 142 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 142 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) thðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +        AtomicLong networkLogCounter = new AtomicLong(0L);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +        while (!connectionStatus.get()){//network is unhealth</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +            if(networkLogCounter.getAndIncrement() % 1000 == 0){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +                LOG.info(&quot;network unhealth to block task&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +            Thread.sleep(100);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +        Map&lt;String, Object&gt; params = formatInputParam(inputParams);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +        executor.execute(() -&gt; connectWithRetry(params, input, resultFuture, rdbSqlClient));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 155 +    private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture, SQLClient rdbSqlClient) {"> 155 +    private void connectWithRetry(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture, SQðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +        AtomicLong failCounter = new AtomicLong(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +        AtomicBoolean finishFlag = new AtomicBoolean(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +        while(!finishFlag.get()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +            CountDownLatch latch = new CountDownLatch(1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +            rdbSqlClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +                    if(conn.failed()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +                        connectionStatus.set(false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +                        if(failCounter.getAndIncrement() % 1000 == 0){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +                            LOG.error(&quot;getConnection error&quot;, conn.cause());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +                        if(failCounter.get() &gt;= sideInfo.getSideTableInfo().getConnectRetryMaxNum(100)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +                            resultFuture.completeExceptionally(conn.cause());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +                            finishFlag.set(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +                        return;</span>
 172                      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 174 -                    resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.getType()));"> 174 -                    resultFuture.completeExceptionally(new RuntimeException(&quot;not support cache obj type &quot; + val.geðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -        rdbSqlClient.getConnection(conn -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -            if (conn.failed()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -                //Treatment failures</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -                resultFuture.completeExceptionally(conn.cause());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -            final SQLConnection connection = conn.result();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -            String sqlCondition = sideInfo.getSqlCondition();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -            connection.queryWithParams(sqlCondition, inputParams, rs -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -                if (rs.failed()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -                    LOG.error(&quot;Cannot retrieve the data from the database&quot;, rs.cause());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -                    resultFuture.completeExceptionally(rs.cause());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -                List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -                List&lt;JsonArray&gt; results = rs.result().getResults();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -                if (results.size() &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -                        List&lt;CRow&gt; rowList = getRows(copyCrow, cacheContent, results);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -                        dealCacheData(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -                        resultFuture.complete(rowList);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -                    } catch (Exception e){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -                        dealFillDataError(resultFuture, e, copyCrow);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -                    dealMissKey(copyCrow, resultFuture);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -                    dealCacheData(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -                // and close the connection</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -                connection.close(done -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -                    if (done.failed()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -                        throw new RuntimeException(done.cause());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -                });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 216 +                    connectionStatus.set(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +                    ScheduledFuture&lt;?&gt; timerFuture = registerTimer(input, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +                    cancelTimerWhenComplete(resultFuture, timerFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +                    handleQuery(conn.result(), inputParams, input, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +                    finishFlag.set(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +                } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                    dealFillDataError(input, resultFuture, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +                    latch.countDown();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                }</span>
 226              });
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +                latch.await();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +            } catch (InterruptedException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +                LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +            if(!finishFlag.get()){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +                try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +                    Thread.sleep(3000);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +                } catch (Exception e){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +                    LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +        }</span>
 241      }
 242  
 243  
 244      private Object convertDataType(Object val) {
 245          if (val == null) {
 246              // OK
 247          } else if (val instanceof Number &amp;&amp; !(val instanceof BigDecimal)) {
 248              // OK
 249          } else if (val instanceof Boolean) {
 250              // OK
 251          } else if (val instanceof String) {
 252              // OK
 253          } else if (val instanceof Character) {
 254              // OK
 255          } else if (val instanceof CharSequence) {
 256  
 257          } else if (val instanceof JsonObject) {
 258  
 259          } else if (val instanceof JsonArray) {
 260  
 261          } else if (val instanceof Map) {
 262  
 263          } else if (val instanceof List) {
 264  
 265          } else if (val instanceof byte[]) {
 266  
 267          } else if (val instanceof Instant) {
 268  
 269          } else if (val instanceof Timestamp) {
 270              val = DateUtil.timestampToString((Timestamp) val);
 271          } else if (val instanceof java.util.Date) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -            val = DateUtil.dateToString((java.util.Date)val);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +            val = DateUtil.dateToString((java.sql.Date) val);</span>
 274          } else {
 275              val = val.toString();
 276          }
 277          return val;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -    protected List&lt;CRow&gt; getRows(CRow inputRow, List&lt;JsonArray&gt; cacheContent, List&lt;JsonArray&gt; results) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -        List&lt;CRow&gt; rowList = Lists.newArrayList();</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -        for (JsonArray line : results) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -            Row row = fillData(inputRow.row(), line);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -            if (null != cacheContent &amp;&amp; openCache()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -                cacheContent.add(line);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -            rowList.add(new CRow(row, inputRow.change()));</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -        return rowList;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +    public String buildCacheKey(Map&lt;String, Object&gt; inputParam) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +        return StringUtils.join(inputParam.values(),&quot;_&quot;);</span>
 296      }
 297  
 298      @Override
 299      public Row fillData(Row input, Object line) {
 300          JsonArray jsonArray = (JsonArray) line;
 301          Row row = new Row(sideInfo.getOutFieldInfoList().size());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -        String[] fields = sideInfo.getSideTableInfo().getFieldTypes();</span>
 303          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 304              Object obj = input.getField(entry.getValue());
<abbr title=" 305              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 305              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoðŸ”µ</abbr>
 306              if (obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo) {
 307                  obj = ((Timestamp) obj).getTime();
 308              }
 309  

 310              row.setField(entry.getKey(), obj);
 311          }
 312  
 313          for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 314              if (jsonArray == null) {
 315                  row.setField(entry.getKey(), null);
 316              } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 317 -                Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.getValue()]);"> 317 -                Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fields[entry.getValue()ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +                String fieldType = sideInfo.getSelectSideFieldType(entry.getValue());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +                Object object = SwitchUtil.getTarget(jsonArray.getValue(entry.getValue()), fieldType);</span>
 320                  row.setField(entry.getKey(), object);
 321              }
 322          }
 323  
 324          return row;
 325      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +</span>
 327  
 328      @Override
 329      public void close() throws Exception {
 330          super.close();
 331          if (rdbSqlClient != null) {
 332              rdbSqlClient.close();
 333          }
 334  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -    public String buildCacheKey(JsonArray jsonArray) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -        StringBuilder sb = new StringBuilder();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -        for (Object ele : jsonArray.getList()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -            sb.append(ele.toString())</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -                    .append(&quot;_&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 343 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 344 -        return sb.toString();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +        if(executor != null){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +            executor.shutdown();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +</span>
 349      }
 350  
 351      public void setRdbSqlClient(SQLClient rdbSqlClient) {
 352          this.rdbSqlClient = rdbSqlClient;
 353      }
 354  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +    public void setExecutor(ThreadPoolExecutor executor) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +        this.executor = executor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 359 +    private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture){"> 359 +    private void handleQuery(SQLConnection connection, Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +        String key = buildCacheKey(inputParams);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +        JsonArray params = new JsonArray(Lists.newArrayList(inputParams.values()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +        connection.queryWithParams(sideInfo.getSqlCondition(), params, rs -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +            if (rs.failed()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +                dealFillDataError(input, resultFuture, rs.cause());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +            List&lt;JsonArray&gt; cacheContent = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 370 +            int resultSize = rs.result().getResults().size();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 371 +            if (resultSize &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 372 +                List&lt;CRow&gt; rowList = Lists.newArrayList();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 373 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 374 +                for (JsonArray line : rs.result().getResults()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +                    Row row = fillData(input.row(), line);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 376 +                    if (openCache()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +                        cacheContent.add(line);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +                    rowList.add(new CRow(row, input.change()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +                if (openCache()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +                    putCache(key, CacheObj.buildCacheObj(ECacheContentType.MultiLine, cacheContent));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +                resultFuture.complete(rowList);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +                dealMissKey(input, resultFuture);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +                if (openCache()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +                    putCache(key, CacheMissVal.getMissKeyObj());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +            // and close the connection</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +            connection.close(done -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +                if (done.failed()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +                    throw new RuntimeException(done.cause());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 398 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 399 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +    private Map&lt;String, Object&gt; formatInputParam(Map&lt;String, Object&gt; inputParam){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 404 +        Map&lt;String, Object&gt; result = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +        inputParam.forEach((k,v) -&gt; {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +            result.put(k, convertDataType(v));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 407 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 408 +        return result;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +    }</span>
 410  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            