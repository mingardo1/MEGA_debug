<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>143</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    143
                    <a href="142.html">prev</a>
                    <a href="144.html">next</a>
                    <a href="143_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_43bc5971257bc0b34863e0fb492c7371153eda52_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;43bc5971257bc0b34863e0fb492c7371153eda52:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;43bc5971257bc0b34863e0fb492c7371153eda52^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;43bc5971257bc0b34863e0fb492c7371153eda52^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;68d0a170f9399845027214d6e8e6e30c591900dd:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/service/OfferServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj]], subset: [[bj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18 package org.broadleafcommerce.core.offer.service;                                                        </span>
<span  style="">  19                                                                                                          </span>
<span class="8596464405353709537" onmouseenter="enter('8596464405353709537');" onmouseout="out('8596464405353709537');" style="">  20 import org.apache.commons.collections.CollectionUtils;                                                   </span>
<span class="2953846583056246827" onmouseenter="enter('2953846583056246827');" onmouseout="out('2953846583056246827');" style="">  21 import org.apache.commons.collections.Transformer;                                                       </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  22 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  23 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-2193028153657877676" onmouseenter="enter('-2193028153657877676');" onmouseout="out('-2193028153657877676');" style="">  24 import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;                                 </span>
<span class="-3349026188166660873" onmouseenter="enter('-3349026188166660873');" onmouseout="out('-3349026188166660873');" style="">  25 import org.broadleafcommerce.common.persistence.EntityDuplicator;                                        </span>
<span class="-2818686525334833130" onmouseenter="enter('-2818686525334833130');" onmouseout="out('-2818686525334833130');" style="">  26 import org.broadleafcommerce.common.sandbox.SandBoxHelper;                                               </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  27 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                     </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  28 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                </span>
<span class="6205208880685044389" onmouseenter="enter('6205208880685044389');" onmouseout="out('6205208880685044389');" style="">  29 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;                                            </span>
<span class="-7911436562744873568" onmouseenter="enter('-7911436562744873568');" onmouseout="out('-7911436562744873568');" style="">  30 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;                                                </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  31 import org.broadleafcommerce.core.offer.dao.OfferDao;                                                    </span>
<span class="-91689670446949346" onmouseenter="enter('-91689670446949346');" onmouseout="out('-91689670446949346');" style="">  32 import org.broadleafcommerce.core.offer.domain.*;                                                        </span>
<span class="4287099423657810905" onmouseenter="enter('4287099423657810905');" onmouseout="out('4287099423657810905');" style="">  33 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;</span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  34 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;            </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  35 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;           </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  36 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                   </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  37 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                         </span>
<span class="5713212224635448284" onmouseenter="enter('5713212224635448284');" onmouseout="out('5713212224635448284');" style="">  38 import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;                </span>
<span class="-2454758753718589449" onmouseenter="enter('-2454758753718589449');" onmouseout="out('-2454758753718589449');" style="">  39 import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;                            </span>
<span class="8227287359407176835" onmouseenter="enter('8227287359407176835');" onmouseout="out('8227287359407176835');" style="">  40 import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;                           </span>
<span class="-5727938558534008634" onmouseenter="enter('-5727938558534008634');" onmouseout="out('-5727938558534008634');" style="">  41 import org.broadleafcommerce.core.offer.service.type.OfferType;                                          </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  42 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                         </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  43 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  44 import org.broadleafcommerce.core.order.domain.OrderItem;                                                </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  45 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                     </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  46 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  47 import org.broadleafcommerce.core.pricing.service.exception.PricingException;                            </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  48 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  49 import org.springframework.stereotype.Service;                                                           </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  50 import org.springframework.transaction.annotation.Transactional;                                         </span>
<span  style="">  51                                                                                                          </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  52 import java.util.ArrayList;                                                                              </span>
<span class="-112105277767313938" onmouseenter="enter('-112105277767313938');" onmouseout="out('-112105277767313938');" style="">  53 import java.util.Collection;                                                                             </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  54 import java.util.HashMap;                                                                                </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  55 import java.util.HashSet;                                                                                </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  56 import java.util.Iterator;                                                                               </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  57 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  58 import java.util.Map;                                                                                    </span>
<span class="6306724220981822255" onmouseenter="enter('6306724220981822255');" onmouseout="out('6306724220981822255');" style="">  59 import java.util.Objects;                                                                                </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  60 import java.util.Set;                                                                                    </span>
<span  style="">  61                                                                                                          </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  62 import javax.annotation.Resource;                                                                        </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  63 import javax.persistence.EntityManager;                                                                  </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  64 import javax.persistence.PersistenceContext;                                                             </span>
<span  style="">  65                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  66 /**                                                                                                      </span>
<span class="-2667338179687874348" onmouseenter="enter('-2667338179687874348');" onmouseout="out('-2667338179687874348');" style="">  67  * The Class OfferServiceImpl.                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  68  */                                                                                                      </span>
<span class="504450232350438262" onmouseenter="enter('504450232350438262');" onmouseout="out('504450232350438262');" style="">  69 @Service(&quot;blOfferService&quot;)                                                                               </span>
<span class="6786430150403502423" onmouseenter="enter('6786430150403502423');" onmouseout="out('6786430150403502423');" style="">  70 public class OfferServiceImpl implements OfferService {                                                  </span>
<span  style="">  71                                                                                                          </span>
<span class="8897944981470617719" onmouseenter="enter('8897944981470617719');" onmouseout="out('8897944981470617719');" style="">  72     private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);                            </span>
<span  style="">  73                                                                                                          </span>
<span class="3846751699212951796" onmouseenter="enter('3846751699212951796');" onmouseout="out('3846751699212951796');" style="">  74     // should be called outside of Offer service after Offer service is executed                         </span>
<span class="-5484979233832760683" onmouseenter="enter('-5484979233832760683');" onmouseout="out('-5484979233832760683');" style="">  75     @Resource(name=&quot;blCustomerOfferDao&quot;)                                                                 </span>
<span class="-5771823415174942027" onmouseenter="enter('-5771823415174942027');" onmouseout="out('-5771823415174942027');" style="">  76     protected CustomerOfferDao customerOfferDao;                                                         </span>
<span  style="">  77                                                                                                          </span>
<span class="-1524144969871346405" onmouseenter="enter('-1524144969871346405');" onmouseout="out('-1524144969871346405');" style="">  78     @Resource(name=&quot;blOfferCodeDao&quot;)                                                                     </span>
<span class="-6984238934820524758" onmouseenter="enter('-6984238934820524758');" onmouseout="out('-6984238934820524758');" style="">  79     protected OfferCodeDao offerCodeDao;                                                                 </span>
<span  style="">  80                                                                                                          </span>
<span class="-8247969455122443370" onmouseenter="enter('-8247969455122443370');" onmouseout="out('-8247969455122443370');" style="">  81     @Resource(name=&quot;blOfferAuditService&quot;)                                                                </span>
<span class="-6742419488595856311" onmouseenter="enter('-6742419488595856311');" onmouseout="out('-6742419488595856311');" style="">  82     protected OfferAuditService offerAuditService;                                                       </span>
<span  style="">  83                                                                                                          </span>
<span class="-6976077299079381435" onmouseenter="enter('-6976077299079381435');" onmouseout="out('-6976077299079381435');" style="">  84     @Resource(name=&quot;blOfferDao&quot;)                                                                         </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  85     protected OfferDao offerDao;                                                                         </span>
<span  style="">  86                                                                                                          </span>
<span class="-3191658961867656636" onmouseenter="enter('-3191658961867656636');" onmouseout="out('-3191658961867656636');" style="">  87     @Resource(name=&quot;blOrderOfferProcessor&quot;)                                                              </span>
<span class="-3818126380928091101" onmouseenter="enter('-3818126380928091101');" onmouseout="out('-3818126380928091101');" style="">  88     protected OrderOfferProcessor orderOfferProcessor;                                                   </span>
<span  style="">  89                                                                                                          </span>
<span class="-6223428528083119866" onmouseenter="enter('-6223428528083119866');" onmouseout="out('-6223428528083119866');" style="">  90     @Resource(name=&quot;blItemOfferProcessor&quot;)                                                               </span>
<span class="-7827297227357944415" onmouseenter="enter('-7827297227357944415');" onmouseout="out('-7827297227357944415');" style="">  91     protected ItemOfferProcessor itemOfferProcessor;                                                     </span>
<span  style="">  92                                                                                                          </span>
<span class="-1476654469985531605" onmouseenter="enter('-1476654469985531605');" onmouseout="out('-1476654469985531605');" style="">  93     @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)                                                   </span>
<span class="7634983124983010999" onmouseenter="enter('7634983124983010999');" onmouseout="out('7634983124983010999');" style="">  94     protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;                             </span>
<span  style="">  95                                                                                                          </span>
<span class="-4330844585159307437" onmouseenter="enter('-4330844585159307437');" onmouseout="out('-4330844585159307437');" style="">  96     @Resource(name=&quot;blPromotableItemFactory&quot;)                                                            </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  97     protected PromotableItemFactory promotableItemFactory;                                               </span>
<span  style="">  98                                                                                                          </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style="">  99     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                   </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style=""> 100     protected OfferServiceExtensionManager extensionManager;                                             </span>
<span  style=""> 101                                                                                                          </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 102     @Resource(name = &quot;blOrderService&quot;)                                                                   </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 103     protected OrderService orderService;                                                                 </span>
<span  style=""> 104                                                                                                          </span>
<span class="-3946461589801993391" onmouseenter="enter('-3946461589801993391');" onmouseout="out('-3946461589801993391');" style=""> 105     @Resource(name = &quot;blSandBoxHelper&quot;)                                                                  </span>
<span class="-7799183597372200632" onmouseenter="enter('-7799183597372200632');" onmouseout="out('-7799183597372200632');" style=""> 106     protected SandBoxHelper sandBoxHelper;                                                               </span>
<span  style=""> 107                                                                                                          </span>
<span class="-4259734795637808055" onmouseenter="enter('-4259734795637808055');" onmouseout="out('-4259734795637808055');" style=""> 108     @PersistenceContext(unitName=&quot;blPU&quot;)                                                                 </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style=""> 109     protected EntityManager em;                                                                          </span>
<span  style=""> 110                                                                                                          </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 111     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                  </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 112     protected StreamingTransactionCapableUtil transUtil;                                                 </span>
<span  style=""> 113                                                                                                          </span>
<span class="-8384326529234094002" onmouseenter="enter('-8384326529234094002');" onmouseout="out('-8384326529234094002');" style=""> 114     @Resource(name=&quot;blEntityDuplicator&quot;)                                                                 </span>
<span class="-9194612273021432316" onmouseenter="enter('-9194612273021432316');" onmouseout="out('-9194612273021432316');" style=""> 115     protected EntityDuplicator duplicator;                                                               </span>
<span  style=""> 116                                                                                                          </span>
<span class="723166851410757036" onmouseenter="enter('723166851410757036');" onmouseout="out('723166851410757036');" style=""> 117     @Resource(name=&quot;blOfferDuplicateModifier&quot;)                                                           </span>
<span class="8658910844320022950" onmouseenter="enter('8658910844320022950');" onmouseout="out('8658910844320022950');" style=""> 118     protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;                                     </span>
<span  style=""> 119                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 120     @Override                                                                                            </span>
<span class="-2033305286790048708" onmouseenter="enter('-2033305286790048708');" onmouseout="out('-2033305286790048708');" style=""> 121     public List&lt;Offer&gt; findAllOffers() {                                                                 </span>
<span class="2132174063530273788" onmouseenter="enter('2132174063530273788');" onmouseout="out('2132174063530273788');" style=""> 122         return offerDao.readAllOffers();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 123     }                                                                                                    </span>
<span  style=""> 124                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 125     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 126     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="7144811092176845141" onmouseenter="enter('7144811092176845141');" onmouseout="out('7144811092176845141');" style=""> 127     public Offer save(Offer offer) {                                                                     </span>
<span class="-264708178039771798" onmouseenter="enter('-264708178039771798');" onmouseout="out('-264708178039771798');" style=""> 128         return offerDao.save(offer);                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129     }                                                                                                    </span>
<span  style=""> 130                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 131     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 132     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-5514670765130856091" onmouseenter="enter('-5514670765130856091');" onmouseout="out('-5514670765130856091');" style=""> 133     public OfferCode saveOfferCode(OfferCode offerCode) {                                                </span>
<span class="3125778008044685658" onmouseenter="enter('3125778008044685658');" onmouseout="out('3125778008044685658');" style=""> 134         offerCode.setOffer(offerDao.save(offerCode.getOffer()));                                         </span>
<span class="6906137479190051982" onmouseenter="enter('6906137479190051982');" onmouseout="out('6906137479190051982');" style=""> 135         return offerCodeDao.save(offerCode);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 136     }                                                                                                    </span>
<span  style=""> 137                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 138     /**                                                                                                  </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""><abbr title=" 139      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 139      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr></span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""><abbr title=" 140      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 140      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr></span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 141      * cannot appear more than once in the list.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 142      *                                                                                                   </span>
<span class="-709313334493645866" onmouseenter="enter('-709313334493645866');" onmouseout="out('-709313334493645866');" style=""> 143      * @param code                                                                                       </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 144      * @return a List of offers that may apply to this order                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 145      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 146     @Override                                                                                            </span>
<span class="-6840847083603451180" onmouseenter="enter('-6840847083603451180');" onmouseout="out('-6840847083603451180');" style=""> 147     public Offer lookupOfferByCode(String code) {                                                        </span>
<span class="-531732708503781646" onmouseenter="enter('-531732708503781646');" onmouseout="out('-531732708503781646');" style=""> 148         Offer offer = null;                                                                              </span>
<span class="-8218576552188075283" onmouseenter="enter('-8218576552188075283');" onmouseout="out('-8218576552188075283');" style=""> 149         OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);                                    </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 150         if (offerCode != null) {                                                                         </span>
<span class="-2561785727340284423" onmouseenter="enter('-2561785727340284423');" onmouseout="out('-2561785727340284423');" style=""> 151             offer = offerCode.getOffer();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 152         }                                                                                                </span>
<span class="-8963791522625561917" onmouseenter="enter('-8963791522625561917');" onmouseout="out('-8963791522625561917');" style=""> 153         return offer;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 154     }                                                                                                    </span>
<span  style=""> 155                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 156     @Override                                                                                            </span>
<span class="2883322601430833612" onmouseenter="enter('2883322601430833612');" onmouseout="out('2883322601430833612');" style=""> 157     public OfferCode lookupOfferCodeByCode(String code){                                                 </span>
<span class="8795189428566002896" onmouseenter="enter('8795189428566002896');" onmouseout="out('8795189428566002896');" style=""> 158         return offerCodeDao.readOfferCodeByCode(code);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159     }                                                                                                    </span>
<span  style=""> 160                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 161     @Override                                                                                            </span>
<span class="-2543778591938191529" onmouseenter="enter('-2543778591938191529');" onmouseout="out('-2543778591938191529');" style=""> 162     public List&lt;Offer&gt; lookupAllOffersByCode(String code) {                                              </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 163         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                     </span>
<span class="-3360697953765841703" onmouseenter="enter('-3360697953765841703');" onmouseout="out('-3360697953765841703');" style=""> 164         List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);                         </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 165         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 166             if (offerCode != null) {                                                                     </span>
<span class="-7816274075460376657" onmouseenter="enter('-7816274075460376657');" onmouseout="out('-7816274075460376657');" style=""> 167                 offers.add(offerCode.getOffer());                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169         }                                                                                                </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 170         return offers;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 171     }                                                                                                    </span>
<span  style=""> 172                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 173     @Override                                                                                            </span>
<span class="4676855439599320404" onmouseenter="enter('4676855439599320404');" onmouseout="out('4676855439599320404');" style=""> 174     public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){                                       </span>
<span class="-4234235759448675045" onmouseenter="enter('-4234235759448675045');" onmouseout="out('-4234235759448675045');" style=""> 175         return offerCodeDao.readAllOfferCodesByCode(code);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 176     }                                                                                                    </span>
<span  style=""> 177                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 178     /**                                                                                                  </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""><abbr title=" 179      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 179      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr></span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""><abbr title=" 180      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 180      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr></span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 181      * cannot appear more than once in the list.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 182      *                                                                                                   </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 183      * @param order                                                                                      </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 184      * @return a List of offers that may apply to this order                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 185      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 186     @Override                                                                                            </span>
<span class="-5814298891852821500" onmouseenter="enter('-5814298891852821500');" onmouseout="out('-5814298891852821500');" style=""> 187     public List&lt;Offer&gt; buildOfferListForOrder(Order order) {                                             </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 188         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                     </span>
<span class="-3235900677601494398" onmouseenter="enter('-3235900677601494398');" onmouseout="out('-3235900677601494398');" style=""> 189         List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());         </span>
<span class="7699769166343685501" onmouseenter="enter('7699769166343685501');" onmouseout="out('7699769166343685501');" style=""> 190         for (CustomerOffer customerOffer : customerOffers) {                                             </span>
<span class="-2310400538171319838" onmouseenter="enter('-2310400538171319838');" onmouseout="out('-2310400538171319838');" style=""> 191             if (!offers.contains(customerOffer.getOffer())) {                                            </span>
<span class="5233078073066950969" onmouseenter="enter('5233078073066950969');" onmouseout="out('5233078073066950969');" style=""> 192                 offers.add(customerOffer.getOffer());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 194         }                                                                                                </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 195         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                          </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 196 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-7332519531441163733" onmouseenter="enter('-7332519531441163733');" onmouseout="out('-7332519531441163733');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197 //        int before = orderOfferCodes.size();                                                           </span>
<span class="1955749666612820833" onmouseenter="enter('1955749666612820833');" onmouseout="out('1955749666612820833');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198 //        orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                  </span>
<span class="-6467003552280566260" onmouseenter="enter('-6467003552280566260');" onmouseout="out('-6467003552280566260');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199 /*        int after = orderOfferCodes.size();                                                            </span>
<span class="2182795146752320946" onmouseenter="enter('2182795146752320946');" onmouseout="out('2182795146752320946');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 200         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 200         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr></span>
<span class="3842576300509712789" onmouseenter="enter('3842576300509712789');" onmouseout="out('3842576300509712789');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201         if(o !=null &amp;&amp; (Boolean)o &amp;&amp; before!=after){                                                     </span>
<span class="-3668454086264686215" onmouseenter="enter('-3668454086264686215');" onmouseout="out('-3668454086264686215');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 202             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 202             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiðŸ”µ</abbr></span>
<span class="-2684617365274670769" onmouseenter="enter('-2684617365274670769');" onmouseout="out('-2684617365274670769');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203         }*/                                                                                              </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 204 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-2310400538171319838" onmouseenter="enter('-2310400538171319838');" onmouseout="out('-2310400538171319838');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205             if (!offers.contains(customerOffer.getOffer())) {                                            </span>
<span class="5233078073066950969" onmouseenter="enter('5233078073066950969');" onmouseout="out('5233078073066950969');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206                 offers.add(customerOffer.getOffer());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208         }                                                                                                </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                          </span>
<span class="-5394428663749604022" onmouseenter="enter('-5394428663749604022');" onmouseout="out('-5394428663749604022');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210         int before = orderOfferCodes.size();                                                             </span>
<span class="-6665865767746694239" onmouseenter="enter('-6665865767746694239');" onmouseout="out('-6665865767746694239');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                    </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 212 =======                                                                                                  </span>
<span class="-6665865767746694239" onmouseenter="enter('-6665865767746694239');" onmouseout="out('-6665865767746694239');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                    </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 214 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="2682597879629079185" onmouseenter="enter('2682597879629079185');" onmouseout="out('2682597879629079185');" style=""> 215         for (OfferCode orderOfferCode : orderOfferCodes) {                                               </span>
<span class="-1857624084667800558" onmouseenter="enter('-1857624084667800558');" onmouseout="out('-1857624084667800558');" style=""> 216             if (!offers.contains(orderOfferCode.getOffer())) {                                           </span>
<span class="4188766124804405127" onmouseenter="enter('4188766124804405127');" onmouseout="out('4188766124804405127');" style=""> 217                 offers.add(orderOfferCode.getOffer());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 218             }                                                                                            </span>
<span class="-4468546552745233084" onmouseenter="enter('-4468546552745233084');" onmouseout="out('-4468546552745233084');" style=""> 219             extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 220         }                                                                                                </span>
<span class="-9188634082558155234" onmouseenter="enter('-9188634082558155234');" onmouseout="out('-9188634082558155234');" style=""> 221         List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();                                      </span>
<span class="-8411171878687156520" onmouseenter="enter('-8411171878687156520');" onmouseout="out('-8411171878687156520');" style=""> 222         for (Offer globalOffer : globalOffers) {                                                         </span>
<span class="2071278729839157974" onmouseenter="enter('2071278729839157974');" onmouseout="out('2071278729839157974');" style=""> 223             if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {  </span>
<span class="-3050025518373868772" onmouseenter="enter('-3050025518373868772');" onmouseout="out('-3050025518373868772');" style=""> 224                 offers.add(globalOffer);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 225             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 226         }                                                                                                </span>
<span  style=""> 227                                                                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 228         if (extensionManager != null) {                                                                  </span>
<span class="1817402996237899777" onmouseenter="enter('1817402996237899777');" onmouseout="out('1817402996237899777');" style=""> 229             extensionManager.applyAdditionalFilters(offers, order);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 230         }                                                                                                </span>
<span  style=""> 231                                                                                                          </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 232         return offers;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 233     }                                                                                                    </span>
<span  style=""> 234                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 235     @Override                                                                                            </span>
<span class="2056305643902587707" onmouseenter="enter('2056305643902587707');" onmouseout="out('2056305643902587707');" style=""> 236     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {                                  </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 237         Customer customer = order.getCustomer();                                                         </span>
<span class="-5041998041456755776" onmouseenter="enter('-5041998041456755776');" onmouseout="out('-5041998041456755776');" style=""> 238         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();                                             </span>
<span  style=""> 239                                                                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 240         if (extensionManager != null) {                                                                  </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 241             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 242         }                                                                                                </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 243         if (!offerCodes.isEmpty()) {                                                                     </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 244             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                             </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 245             while (itr.hasNext()) {                                                                      </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 246                 OfferCode offerCode = itr.next();                                                        </span>
<span class="-776136422183497161" onmouseenter="enter('-776136422183497161');" onmouseout="out('-776136422183497161');" style=""> 247                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {       </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 248                     itr.remove();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 249                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 250             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 252         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 253     }                                                                                                    </span>
<span  style=""> 254                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 255     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 256     @Override                                                                                            </span>
<span class="3843851677430304310" onmouseenter="enter('3843851677430304310');" onmouseout="out('3843851677430304310');" style=""> 257     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {                            </span>
<span class="-6957816096303048614" onmouseenter="enter('-6957816096303048614');" onmouseout="out('-6957816096303048614');" style=""> 258         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 259         if (extensionManager != null) {                                                                  </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 260             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261         }                                                                                                </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 262         if (!offerCodes.isEmpty()) {                                                                     </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 263             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                             </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 264             while (itr.hasNext()) {                                                                      </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 265                 OfferCode offerCode = itr.next();                                                        </span>
<span class="6086018267170409432" onmouseenter="enter('6086018267170409432');" onmouseout="out('6086018267170409432');" style=""> 266                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {    </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 267                     itr.remove();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 268                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 269             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 270         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 271         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 272     }                                                                                                    </span>
<span  style=""> 273                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 274     /**                                                                                                  </span>
<span class="2837560355574155003" onmouseenter="enter('2837560355574155003');" onmouseout="out('2837560355574155003');" style=""> 275      * Private method used to retrieve all offers assigned to this customer.  These offers are           </span>
<span class="4852710310174118924" onmouseenter="enter('4852710310174118924');" onmouseout="out('4852710310174118924');" style=""> 276      * programmatically assigned to the customer.                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 277      *                                                                                                   </span>
<span class="1094425505394812731" onmouseenter="enter('1094425505394812731');" onmouseout="out('1094425505394812731');" style=""> 278      * @param customer                                                                                   </span>
<span class="-3868237647402015492" onmouseenter="enter('-3868237647402015492');" onmouseout="out('-3868237647402015492');" style=""> 279      * @return a List of offers assigned to the customer                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 280      */                                                                                                  </span>
<span class="-1064959765029423996" onmouseenter="enter('-1064959765029423996');" onmouseout="out('-1064959765029423996');" style=""> 281     protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {                     </span>
<span class="1699675085073278700" onmouseenter="enter('1699675085073278700');" onmouseout="out('1699675085073278700');" style=""> 282         List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);    </span>
<span class="5611761187435301880" onmouseenter="enter('5611761187435301880');" onmouseout="out('5611761187435301880');" style=""> 283         return offerCustomers;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 284     }                                                                                                    </span>
<span  style=""> 285                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 286     /**                                                                                                  </span>
<span class="-8831229104457932482" onmouseenter="enter('-8831229104457932482');" onmouseout="out('-8831229104457932482');" style=""> 287      * Private method used to retrieve all offers with automaticallyAdded set to true                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 288      *                                                                                                   </span>
<span class="-2057313490179191281" onmouseenter="enter('-2057313490179191281');" onmouseout="out('-2057313490179191281');" style=""> 289      * @return a List of automatic delivery offers                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 290      */                                                                                                  </span>
<span class="-9186908469762752320" onmouseenter="enter('-9186908469762752320');" onmouseout="out('-9186908469762752320');" style=""> 291     protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {                                              </span>
<span class="-2657712449795339218" onmouseenter="enter('-2657712449795339218');" onmouseout="out('-2657712449795339218');" style=""> 292         List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();                         </span>
<span class="-7738403477037597046" onmouseenter="enter('-7738403477037597046');" onmouseout="out('-7738403477037597046');" style=""> 293         return globalOffers;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 294     }                                                                                                    </span>
<span  style=""> 295                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 296     /**                                                                                                  </span>
<span class="-582485916100204765" onmouseenter="enter('-582485916100204765');" onmouseout="out('-582485916100204765');" style=""> 297      * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end           </span>
<span class="-591413864231465226" onmouseenter="enter('-591413864231465226');" onmouseout="out('-591413864231465226');" style=""> 298      * date.  If an offerCode has a later start date, that offerCode will be removed.                    </span>
<span class="-1600892852414517397" onmouseenter="enter('-1600892852414517397');" onmouseout="out('-1600892852414517397');" style=""> 299      * OfferCodes without a start date will still be processed. If the offerCode                         </span>
<span class="-6972954356288154926" onmouseenter="enter('-6972954356288154926');" onmouseout="out('-6972954356288154926');" style=""> 300      * has a end date that has already passed, that offerCode will be removed.  OfferCodes               </span>
<span class="-7007360996659097530" onmouseenter="enter('-7007360996659097530');" onmouseout="out('-7007360996659097530');" style=""> 301      * without a end date will be processed.  The start and end dates on the offer will                  </span>
<span class="-216139196908541615" onmouseenter="enter('-216139196908541615');" onmouseout="out('-216139196908541615');" style=""> 302      * still need to be evaluated.                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 303      *                                                                                                   </span>
<span class="-142155654396048960" onmouseenter="enter('-142155654396048960');" onmouseout="out('-142155654396048960');" style=""> 304      * @param offerCodes                                                                                 </span>
<span class="-7645314644020819692" onmouseenter="enter('-7645314644020819692');" onmouseout="out('-7645314644020819692');" style=""> 305      * @return a List of non-expired offers                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 306      */                                                                                                  </span>
<span class="3097073257270455619" onmouseenter="enter('3097073257270455619');" onmouseout="out('3097073257270455619');" style=""> 307     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){                     </span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 308         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                 </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 309         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4179739580098873664" onmouseenter="enter('4179739580098873664');" onmouseout="out('4179739580098873664');" style=""> 310             if (!offerCode.isActive()){                                                                  </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 311                 offerCodesToRemove.add(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 312             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 313         }                                                                                                </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 314         // remove all offers in the offersToRemove list from original offers list                        </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 315         for (OfferCode offerCode : offerCodesToRemove) {                                                 </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 316             offerCodes.remove(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 317         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 318         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 319     }                                                                                                    </span>
<span  style=""> 320                                                                                                          </span>
<span class="4108048093343952474" onmouseenter="enter('4108048093343952474');" onmouseout="out('4108048093343952474');" style=""><abbr title=" 321     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; offers){"> 321     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; ðŸ”µ</abbr></span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 322         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                 </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 323         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4179739580098873664" onmouseenter="enter('4179739580098873664');" onmouseout="out('4179739580098873664');" style=""> 324             if (!offerCode.isActive()){                                                                  </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 325                 offerCodesToRemove.add(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 326             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 327         }                                                                                                </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 328         // remove all offers in the offersToRemove list from original offers list                        </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 329         for (OfferCode offerCode : offerCodesToRemove) {                                                 </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 330             offerCodes.remove(offerCode);                                                                </span>
<span class="-6904171993325612449" onmouseenter="enter('-6904171993325612449');" onmouseout="out('-6904171993325612449');" style=""> 331             offers.remove(offerCode.getOffer());                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 332         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 333         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 334     }                                                                                                    </span>
<span  style=""> 335                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 336     /**                                                                                                  </span>
<span class="5637961435104982406" onmouseenter="enter('5637961435104982406');" onmouseout="out('5637961435104982406');" style=""> 337      * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with       </span>
<span class="1724276086246688719" onmouseenter="enter('1724276086246688719');" onmouseout="out('1724276086246688719');" style=""> 338      * current sandbox status.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 339      *                                                                                                   </span>
<span class="202872854140107873" onmouseenter="enter('202872854140107873');" onmouseout="out('202872854140107873');" style=""> 340      * @param order the order to check                                                                   </span>
<span class="2772482249434351691" onmouseenter="enter('2772482249434351691');" onmouseout="out('2772482249434351691');" style=""> 341      * @return the refreshed list of OfferCodes                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 342      */                                                                                                  </span>
<span class="7210051143895905366" onmouseenter="enter('7210051143895905366');" onmouseout="out('7210051143895905366');" style=""> 343     protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {                         </span>
<span class="7464496307728629396" onmouseenter="enter('7464496307728629396');" onmouseout="out('7464496307728629396');" style=""> 344         final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();                              </span>
<span  style=""> 345                                                                                                          </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 346         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 347             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 348             public void execute() {                                                                      </span>
<span class="-6058145000184664425" onmouseenter="enter('-6058145000184664425');" onmouseout="out('-6058145000184664425');" style=""> 349                 for (OfferCode offerCode : orderOfferCodes) {                                            </span>
<span class="-4263515828536000223" onmouseenter="enter('-4263515828536000223');" onmouseout="out('-4263515828536000223');" style=""> 350                     if (offerCode.getOffer() != null) {                                                  </span>
<span class="8507823172595815939" onmouseenter="enter('8507823172595815939');" onmouseout="out('8507823172595815939');" style=""><abbr title=" 351                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 351                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCðŸ”µ</abbr></span>
<span class="-4217337457935304447" onmouseenter="enter('-4217337457935304447');" onmouseout="out('-4217337457935304447');" style=""><abbr title=" 352                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 352                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOfðŸ”µ</abbr></span>
<span class="-6104864632261418874" onmouseenter="enter('-6104864632261418874');" onmouseout="out('-6104864632261418874');" style=""> 353                             em.refresh(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 354                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 355                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 356                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 357             }                                                                                            </span>
<span  style=""> 358                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 359             @Override                                                                                    </span>
<span class="1336357167460974281" onmouseenter="enter('1336357167460974281');" onmouseout="out('1336357167460974281');" style=""> 360             public boolean shouldRetryOnTransactionLockAcquisitionFailure() {                            </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 361                 return true;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 362             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 363         }, RuntimeException.class);                                                                      </span>
<span  style=""> 364                                                                                                          </span>
<span class="720292142172901868" onmouseenter="enter('720292142172901868');" onmouseout="out('720292142172901868');" style=""> 365         return orderOfferCodes;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 366     }                                                                                                    </span>
<span  style=""> 367                                                                                                          </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 368     /*                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 369      *                                                                                                   </span>
<span class="-1078885518483632555" onmouseenter="enter('-1078885518483632555');" onmouseout="out('-1078885518483632555');" style=""> 370      * Offers Logic:                                                                                     </span>
<span class="-6544489594486398439" onmouseenter="enter('-6544489594486398439');" onmouseout="out('-6544489594486398439');" style=""> 371      * 1) Remove all existing offers in the Order (order, item, and fulfillment)                         </span>
<span class="472654013095872963" onmouseenter="enter('472654013095872963');" onmouseout="out('472654013095872963');" style=""> 372      * 2) Check and remove offers                                                                        </span>
<span class="8111384560802328496" onmouseenter="enter('8111384560802328496');" onmouseout="out('8111384560802328496');" style=""> 373      *    a) Remove out of date offers                                                                   </span>
<span class="3025649188866691570" onmouseenter="enter('3025649188866691570');" onmouseout="out('3025649188866691570');" style=""> 374      *    b) Remove offers that do not apply to this customer                                            </span>
<span class="5156402814943015913" onmouseenter="enter('5156402814943015913');" onmouseout="out('5156402814943015913');" style=""> 375      * 3) Loop through offers                                                                            </span>
<span class="6235203245796610706" onmouseenter="enter('6235203245796610706');" onmouseout="out('6235203245796610706');" style=""> 376      *    a) Verifies type of offer (order, order item, fulfillment)                                     </span>
<span class="7315686159335672158" onmouseenter="enter('7315686159335672158');" onmouseout="out('7315686159335672158');" style=""> 377      *    b) Verifies if offer can be applies                                                            </span>
<span class="-6634234506054969031" onmouseenter="enter('-6634234506054969031');" onmouseout="out('-6634234506054969031');" style=""> 378      *    c) Assign offer to type (order, order item, or fulfillment)                                    </span>
<span class="-4584093434328536587" onmouseenter="enter('-4584093434328536587');" onmouseout="out('-4584093434328536587');" style=""> 379      * 4) Sorts the order and item offers list by priority and then discount                             </span>
<span class="-2042995489836168848" onmouseenter="enter('-2042995489836168848');" onmouseout="out('-2042995489836168848');" style=""> 380      * 5) Identify the best offers to apply to order item and create adjustments for each item offer     </span>
<span class="8597383329030492662" onmouseenter="enter('8597383329030492662');" onmouseout="out('8597383329030492662');" style=""><abbr title=" 381      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better"> 381      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is betðŸ”µ</abbr></span>
<span class="-5003028621529242985" onmouseenter="enter('-5003028621529242985');" onmouseout="out('-5003028621529242985');" style=""> 382      * 7) Identify the best offers to apply to the order and create adjustments for each order offer     </span>
<span class="-1324083657955785943" onmouseenter="enter('-1324083657955785943');" onmouseout="out('-1324083657955785943');" style=""><abbr title=" 383      * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 383      * 8) If item contains non-combinable offers remove either the item or order adjustments based on disðŸ”µ</abbr></span>
<span class="-8610949319074908232" onmouseenter="enter('-8610949319074908232');" onmouseout="out('-8610949319074908232');" style=""> 384      * 9) Set final order item prices and reapply order offers                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 385      *                                                                                                   </span>
<span class="9071544830737596533" onmouseenter="enter('9071544830737596533');" onmouseout="out('9071544830737596533');" style=""> 386      * Assumptions:                                                                                      </span>
<span class="7676524731541901514" onmouseenter="enter('7676524731541901514');" onmouseout="out('7676524731541901514');" style=""> 387      * 1) % off all items will be created as an item offer with no expression                            </span>
<span class="-814522364757940962" onmouseenter="enter('-814522364757940962');" onmouseout="out('-814522364757940962');" style=""> 388      * 2) $ off order will be created as an order offer                                                  </span>
<span class="7365449813142531261" onmouseenter="enter('7365449813142531261');" onmouseout="out('7365449813142531261');" style=""> 389      * 3) Order offers applies to the best price for each item (not just retail price)                   </span>
<span class="-1636653647835076359" onmouseenter="enter('-1636653647835076359');" onmouseout="out('-1636653647835076359');" style=""> 390      * 4) Fulfillment offers apply to best price for each item (not just retail price)                   </span>
<span class="-5866280996345915157" onmouseenter="enter('-5866280996345915157');" onmouseout="out('-5866280996345915157');" style=""><abbr title=" 391      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 391      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used witðŸ”µ</abbr></span>
<span class="-8022045642448063338" onmouseenter="enter('-8022045642448063338');" onmouseout="out('-8022045642448063338');" style=""> 392      * 6) Fulfillment offers cannot be not combinable                                                    </span>
<span class="-5108644804585013203" onmouseenter="enter('-5108644804585013203');" onmouseout="out('-5108644804585013203');" style=""> 393      * 7) Order offers cannot be FIXED_PRICE                                                             </span>
<span class="6161153439596163093" onmouseenter="enter('6161153439596163093');" onmouseout="out('6161153439596163093');" style=""> 394      * 8) FIXED_PRICE offers cannot be stackable                                                         </span>
<span class="7044504232316014062" onmouseenter="enter('7044504232316014062');" onmouseout="out('7044504232316014062');" style=""><abbr title=" 395      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 395      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will alðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 396      *                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 397      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 398     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 399     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-4704847871427432866" onmouseenter="enter('-4704847871427432866');" onmouseout="out('-4704847871427432866');" style=""> 400     public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {    </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 401         /*                                                                                               </span>
<span class="-6180845550366984877" onmouseenter="enter('-6180845550366984877');" onmouseout="out('-6180845550366984877');" style=""> 402         TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to </span>
<span class="9161254164549280190" onmouseenter="enter('9161254164549280190');" onmouseout="out('9161254164549280190');" style=""> 403         use a richer object to describe the parameters of the pricing call. This object would include    </span>
<span class="1561516658361300705" onmouseenter="enter('1561516658361300705');" onmouseout="out('1561516658361300705');" style=""> 404         the pricing boolean, but would also include a list of activities to include or exclude in the    </span>
<span class="-6797832594843538707" onmouseenter="enter('-6797832594843538707');" onmouseout="out('-6797832594843538707');" style=""> 405         call - see http://jira.broadleafcommerce.org/browse/BLC-664                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 406          */                                                                                              </span>
<span class="2182795146752320946" onmouseenter="enter('2182795146752320946');" onmouseout="out('2182795146752320946');" style=""><abbr title=" 407         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 407         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr></span>
<span class="-2779719222870458088" onmouseenter="enter('-2779719222870458088');" onmouseout="out('-2779719222870458088');" style=""> 408         int offerCount = 0;                                                                              </span>
<span class="-845359809890439940" onmouseenter="enter('-845359809890439940');" onmouseout="out('-845359809890439940');" style=""> 409         if(o!=null &amp;&amp; (Boolean)o){                                                                       </span>
<span class="-4703255484140988550" onmouseenter="enter('-4703255484140988550');" onmouseout="out('-4703255484140988550');" style=""> 410             if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())){ </span>
<span class="187767283697509415" onmouseenter="enter('187767283697509415');" onmouseout="out('187767283697509415');" style=""> 411                 for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {                    </span>
<span class="-169235058410924848" onmouseenter="enter('-169235058410924848');" onmouseout="out('-169235058410924848');" style=""> 412                     if(orderAdjustment.getOffer()!=null){                                                </span>
<span class="6329272383142541507" onmouseenter="enter('6329272383142541507');" onmouseout="out('6329272383142541507');" style=""> 413                         offerCount++;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 414                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 415                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 416             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417         }                                                                                                </span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 418         OfferContext offerContext = OfferContext.getOfferContext();                                      </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 419         if (offerContext == null || offerContext.executePromotionCalculation) {                          </span>
<span class="-2683885994659783076" onmouseenter="enter('-2683885994659783076');" onmouseout="out('-2683885994659783076');" style=""> 420             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false); </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 421             List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                      </span>
<span class="-2406747375061389964" onmouseenter="enter('-2406747375061389964');" onmouseout="out('-2406747375061389964');" style=""> 422             removeOutOfDateOfferCodesAndOffers(orderOfferCodes, offers);                                 </span>
<span class="-9066266687178937853" onmouseenter="enter('-9066266687178937853');" onmouseout="out('-9066266687178937853');" style=""> 423             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());  </span>
<span class="-1421782411503697087" onmouseenter="enter('-1421782411503697087');" onmouseout="out('-1421782411503697087');" style=""> 424             if ((filteredOffers == null) || (filteredOffers.isEmpty())) {                                </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 425                 if (LOG.isTraceEnabled()) {                                                              </span>
<span class="2760579588161124045" onmouseenter="enter('2760579588161124045');" onmouseout="out('2760579588161124045');" style=""> 426                     LOG.trace(&quot;No offers applicable to this order.&quot;);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 427                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 428             } else {                                                                                     </span>
<span class="7300520529047311728" onmouseenter="enter('7300520529047311728');" onmouseout="out('7300520529047311728');" style=""><abbr title=" 429                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 429                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidðŸ”µ</abbr></span>
<span class="-7404348590242143631" onmouseenter="enter('-7404348590242143631');" onmouseout="out('-7404348590242143631');" style=""><abbr title=" 430                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 430                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr></span>
<span  style=""> 431                                                                                                          </span>
<span class="-5526882442984993330" onmouseenter="enter('-5526882442984993330');" onmouseout="out('-5526882442984993330');" style=""><abbr title=" 432                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 432                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, quðŸ”µ</abbr></span>
<span  style=""> 433                                                                                                          </span>
<span class="-6480919216777131248" onmouseenter="enter('-6480919216777131248');" onmouseout="out('-6480919216777131248');" style=""><abbr title=" 434                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {                "> 434                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {               ðŸ”µ</abbr></span>
<span class="-2723881742436166059" onmouseenter="enter('-2723881742436166059');" onmouseout="out('-2723881742436166059');" style=""><abbr title=" 435                     // At this point, we should have a PromotableOrder that contains PromotableItems each of which"> 435                     // At this point, we should have a PromotableOrder that contains PromotableItems eachðŸ”µ</abbr></span>
<span class="751015906320167144" onmouseenter="enter('751015906320167144');" onmouseout="out('751015906320167144');" style=""> 436                     // has a list of candidatePromotions that might be applied.                          </span>
<span  style=""> 437                                                                                                          </span>
<span class="5941864862011378901" onmouseenter="enter('5941864862011378901');" onmouseout="out('5941864862011378901');" style=""><abbr title=" 438                     // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 438                     // We also have a list of orderOffers that might apply and a list of itemOffers that ðŸ”µ</abbr></span>
<span class="1127078869550353626" onmouseenter="enter('1127078869550353626');" onmouseout="out('1127078869550353626');" style=""><abbr title=" 439                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 439                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 440                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 441             }                                                                                            </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 442             orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                        </span>
<span  style=""> 443                                                                                                          </span>
<span class="514986819999277890" onmouseenter="enter('514986819999277890');" onmouseout="out('514986819999277890');" style=""> 444             verifyAdjustments(order, true);                                                              </span>
<span  style=""> 445                                                                                                          </span>
<span class="-8901364638816691349" onmouseenter="enter('-8901364638816691349');" onmouseout="out('-8901364638816691349');" style=""> 446             order.setSubTotal(order.calculateSubTotal());                                                </span>
<span class="8881079200386597596" onmouseenter="enter('8881079200386597596');" onmouseout="out('8881079200386597596');" style=""> 447             order.finalizeItemPrices();                                                                  </span>
<span  style=""> 448                                                                                                          </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 449             order = orderService.save(order, false);                                                     </span>
<span  style=""> 450                                                                                                          </span>
<span class="-5335273514929397197" onmouseenter="enter('-5335273514929397197');" onmouseout="out('-5335273514929397197');" style=""> 451             boolean madeChange = verifyAdjustments(order, false);                                        </span>
<span class="-3218959195648057803" onmouseenter="enter('-3218959195648057803');" onmouseout="out('-3218959195648057803');" style=""> 452             if (madeChange) {                                                                            </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 453                 order = orderService.save(order, false);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 454             }                                                                                            </span>
<span class="-8586437722090950510" onmouseenter="enter('-8586437722090950510');" onmouseout="out('-8586437722090950510');" style=""> 455             int offerCountAfter=0;                                                                       </span>
<span class="-845359809890439940" onmouseenter="enter('-845359809890439940');" onmouseout="out('-845359809890439940');" style=""> 456             if(o!=null &amp;&amp; (Boolean)o){                                                                   </span>
<span class="-4703255484140988550" onmouseenter="enter('-4703255484140988550');" onmouseout="out('-4703255484140988550');" style=""><abbr title=" 457                 if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())){"> 457                 if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments()ðŸ”µ</abbr></span>
<span class="187767283697509415" onmouseenter="enter('187767283697509415');" onmouseout="out('187767283697509415');" style=""> 458                     for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {                </span>
<span class="-169235058410924848" onmouseenter="enter('-169235058410924848');" onmouseout="out('-169235058410924848');" style=""> 459                         if(orderAdjustment.getOffer()!=null){                                            </span>
<span class="-8696114592748620649" onmouseenter="enter('-8696114592748620649');" onmouseout="out('-8696114592748620649');" style=""> 460                             offerCountAfter++;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 461                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463                 }                                                                                        </span>
<span class="513357313329824873" onmouseenter="enter('513357313329824873');" onmouseout="out('513357313329824873');" style=""> 464                 if(offerCountAfter!=offerCount){                                                         </span>
<span class="-3668454086264686215" onmouseenter="enter('-3668454086264686215');" onmouseout="out('-3668454086264686215');" style=""><abbr title=" 465                     BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 465                     BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 466                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 467             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 468         }                                                                                                </span>
<span  style=""> 469                                                                                                          </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 470         return order;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 471     }                                                                                                    </span>
<span  style=""> 472                                                                                                          </span>
<span class="219209447823395758" onmouseenter="enter('219209447823395758');" onmouseout="out('219209447823395758');" style=""> 473     protected boolean verifyAdjustments(Order order, boolean beforeSave) {                               </span>
<span class="79408939766017075" onmouseenter="enter('79408939766017075');" onmouseout="out('79408939766017075');" style=""> 474         boolean madeChange = false;                                                                      </span>
<span  style=""> 475                                                                                                          </span>
<span class="-8966123689509035198" onmouseenter="enter('-8966123689509035198');" onmouseout="out('-8966123689509035198');" style=""> 476         if (order.getOrderItems() == null) {                                                             </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 477             return madeChange;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 478         }                                                                                                </span>
<span  style=""> 479                                                                                                          </span>
<span class="8447029191885982498" onmouseenter="enter('8447029191885982498');" onmouseout="out('8447029191885982498');" style=""> 480         for (OrderItem oi : order.getOrderItems()) {                                                     </span>
<span class="-5982197742320851056" onmouseenter="enter('-5982197742320851056');" onmouseout="out('-5982197742320851056');" style=""> 481             if (oi.getOrderItemPriceDetails() == null) {                                                 </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 482                 continue;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 483             }                                                                                            </span>
<span  style=""> 484                                                                                                          </span>
<span class="7391296704731194189" onmouseenter="enter('7391296704731194189');" onmouseout="out('7391296704731194189');" style=""> 485             for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {                              </span>
<span class="-8259157388002947293" onmouseenter="enter('-8259157388002947293');" onmouseout="out('-8259157388002947293');" style=""> 486                 if (pd.getOrderItemPriceDetailAdjustments() == null) {                                   </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 487                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 488                 }                                                                                        </span>
<span  style=""> 489                                                                                                          </span>
<span class="-8160497408394725913" onmouseenter="enter('-8160497408394725913');" onmouseout="out('-8160497408394725913');" style=""><abbr title=" 490                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 490                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdðŸ”µ</abbr></span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 491                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 491                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDeðŸ”µ</abbr></span>
<span class="-3008507732031274392" onmouseenter="enter('-3008507732031274392');" onmouseout="out('-3008507732031274392');" style=""> 492                 for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {     </span>
<span class="-1975641521768786423" onmouseenter="enter('-1975641521768786423');" onmouseout="out('-1975641521768786423');" style=""> 493                     if (adjs.containsKey(adj.getOffer().getId())) {                                      </span>
<span class="-6913168070672082713" onmouseenter="enter('-6913168070672082713');" onmouseout="out('-6913168070672082713');" style=""> 494                         adjustmentsToRemove.add(adj);                                                    </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 495                         if (LOG.isDebugEnabled()) {                                                      </span>
<span class="-2834336870885753779" onmouseenter="enter('-2834336870885753779');" onmouseout="out('-2834336870885753779');" style=""> 496                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)                 </span>
<span class="201513945492742471" onmouseenter="enter('201513945492742471');" onmouseout="out('201513945492742471');" style=""> 497                                 .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)                   </span>
<span class="2195430440089355634" onmouseenter="enter('2195430440089355634');" onmouseout="out('2195430440089355634');" style=""> 498                                 .append(&quot; with ids &quot;)                                                    </span>
<span class="-3149719647859419210" onmouseenter="enter('-3149719647859419210');" onmouseout="out('-3149719647859419210');" style=""> 499                                 .append(adjs.get(adj.getOffer().getId()).getId())                        </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 500                                 .append(&quot; and &quot;)                                                         </span>
<span class="6832270653349147085" onmouseenter="enter('6832270653349147085');" onmouseout="out('6832270653349147085');" style=""> 501                                 .append(adj.getId());                                                    </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 502                             LOG.debug(sb.toString());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 503                         }                                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 504                     } else {                                                                             </span>
<span class="-7759509127049565554" onmouseenter="enter('-7759509127049565554');" onmouseout="out('-7759509127049565554');" style=""> 505                         adjs.put(adj.getOffer().getId(), adj);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 506                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 507                 }                                                                                        </span>
<span  style=""> 508                                                                                                          </span>
<span class="7848730128284985932" onmouseenter="enter('7848730128284985932');" onmouseout="out('7848730128284985932');" style=""> 509                 for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {                         </span>
<span class="6756116260498887863" onmouseenter="enter('6756116260498887863');" onmouseout="out('6756116260498887863');" style=""> 510                     pd.getOrderItemPriceDetailAdjustments().remove(adj);                                 </span>
<span class="5571803755205047298" onmouseenter="enter('5571803755205047298');" onmouseout="out('5571803755205047298');" style=""> 511                     madeChange = true;                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 512                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 513             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 514         }                                                                                                </span>
<span  style=""> 515                                                                                                          </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 516         return madeChange;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 517      }                                                                                                   </span>
<span  style=""> 518                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 519     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 520     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 521     @Deprecated                                                                                          </span>
<span class="-3021599232242429775" onmouseenter="enter('-3021599232242429775');" onmouseout="out('-3021599232242429775');" style=""> 522     public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {            </span>
<span class="-6341015309393843959" onmouseenter="enter('-6341015309393843959');" onmouseout="out('-6341015309393843959');" style=""> 523         applyAndSaveOffersToOrder(offers, order);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 524     }                                                                                                    </span>
<span  style=""> 525                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 526     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 527     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 528     @Deprecated                                                                                          </span>
<span class="-5535279977913938928" onmouseenter="enter('-5535279977913938928');" onmouseout="out('-5535279977913938928');" style=""><abbr title=" 529     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 529     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptiðŸ”µ</abbr></span>
<span class="6394386461467124428" onmouseenter="enter('6394386461467124428');" onmouseout="out('6394386461467124428');" style=""> 530         applyAndSaveFulfillmentGroupOffersToOrder(offers, order);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 531     }                                                                                                    </span>
<span  style=""> 532                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 533     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 534     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="2855881782634007850" onmouseenter="enter('2855881782634007850');" onmouseout="out('2855881782634007850');" style=""><abbr title=" 535     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 535     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricinðŸ”µ</abbr></span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 536         OfferContext offerContext = OfferContext.getOfferContext();                                      </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 537         if (offerContext == null || offerContext.executePromotionCalculation) {                          </span>
<span class="-791836473256513905" onmouseenter="enter('-791836473256513905');" onmouseout="out('-791836473256513905');" style=""> 538             PromotableOrder promotableOrder =                                                            </span>
<span class="-5771222684966163235" onmouseenter="enter('-5771222684966163235');" onmouseout="out('-5771222684966163235');" style=""> 539                     promotableItemFactory.createPromotableOrder(order, true);                            </span>
<span class="-6252467951249219732" onmouseenter="enter('-6252467951249219732');" onmouseout="out('-6252467951249219732');" style=""> 540             List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();                                       </span>
<span class="-8689854403875612694" onmouseenter="enter('-8689854403875612694');" onmouseout="out('-8689854403875612694');" style=""> 541             for (Offer offer : offers) {                                                                 </span>
<span class="3344482016035270743" onmouseenter="enter('3344482016035270743');" onmouseout="out('3344482016035270743');" style=""> 542                 if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {           </span>
<span class="2965579239059640859" onmouseenter="enter('2965579239059640859');" onmouseout="out('2965579239059640859');" style=""> 543                     possibleFGOffers.add(offer);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 544                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 545             }                                                                                            </span>
<span class="7272445213685933500" onmouseenter="enter('7272445213685933500');" onmouseout="out('7272445213685933500');" style=""><abbr title=" 546             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());"> 546             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustðŸ”µ</abbr></span>
<span class="-380250791493510209" onmouseenter="enter('-380250791493510209');" onmouseout="out('-380250791493510209');" style=""><abbr title=" 547             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 547             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCaðŸ”µ</abbr></span>
<span class="5471512156259214352" onmouseenter="enter('5471512156259214352');" onmouseout="out('5471512156259214352');" style=""> 548             for (Offer offer : filteredOffers) {                                                         </span>
<span class="6341701119621727258" onmouseenter="enter('6341701119621727258');" onmouseout="out('6341701119621727258');" style=""><abbr title=" 549                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 549                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifieðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 550             }                                                                                            </span>
<span class="6757974448768463" onmouseenter="enter('6757974448768463');" onmouseout="out('6757974448768463');" style=""> 551             if (!qualifiedFGOffers.isEmpty()) {                                                          </span>
<span class="-3737539762239464744" onmouseenter="enter('-3737539762239464744');" onmouseout="out('-3737539762239464744');" style=""><abbr title=" 552                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);"> 552                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotabðŸ”µ</abbr></span>
<span class="-1748187190347404908" onmouseenter="enter('-1748187190347404908');" onmouseout="out('-1748187190347404908');" style=""> 553                 fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);          </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 554                 orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 555             }                                                                                            </span>
<span  style=""> 556                                                                                                          </span>
<span class="-7204486914274790826" onmouseenter="enter('-7204486914274790826');" onmouseout="out('-7204486914274790826');" style=""> 557             return orderService.save(order, false);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 558         }                                                                                                </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 559         return order;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 560     }                                                                                                    </span>
<span  style=""> 561                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 562     @Override                                                                                            </span>
<span class="-8983195686564092827" onmouseenter="enter('-8983195686564092827');" onmouseout="out('-8983195686564092827');" style=""> 563     public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {                           </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 564         Customer customer = order.getCustomer();                                                         </span>
<span  style=""> 565                                                                                                          </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 566         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="-8305970541390666259" onmouseenter="enter('-8305970541390666259');" onmouseout="out('-8305970541390666259');" style=""><abbr title=" 567             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 567             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr></span>
<span  style=""> 568                                                                                                          </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 569             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 570                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 571             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 572         }                                                                                                </span>
<span  style=""> 573                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 574         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 575     }                                                                                                    </span>
<span  style=""> 576                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 577     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 578     @Override                                                                                            </span>
<span class="4849754295577860926" onmouseenter="enter('4849754295577860926');" onmouseout="out('4849754295577860926');" style=""> 579     public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {                     </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 580         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="8084739095609490454" onmouseenter="enter('8084739095609490454');" onmouseout="out('8084739095609490454');" style=""> 581             Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());   </span>
<span  style=""> 582                                                                                                          </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 583             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 584                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 585             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 586         }                                                                                                </span>
<span  style=""> 587                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 588         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 589     }                                                                                                    </span>
<span  style=""> 590                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 591     @Override                                                                                            </span>
<span class="-4305912419408886648" onmouseenter="enter('-4305912419408886648');" onmouseout="out('-4305912419408886648');" style=""> 592     public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {                        </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 593         boolean underCodeMaxUses = true;                                                                 </span>
<span  style=""> 594                                                                                                          </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 595         if (code.isLimitedUse()) {                                                                       </span>
<span class="-7378740545085856894" onmouseenter="enter('-7378740545085856894');" onmouseout="out('-7378740545085856894');" style=""> 596             Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());            </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 597             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 598         }                                                                                                </span>
<span  style=""> 599                                                                                                          </span>
<span class="5446263071698048925" onmouseenter="enter('5446263071698048925');" onmouseout="out('5446263071698048925');" style=""> 600         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 601     }                                                                                                    </span>
<span  style=""> 602                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 603     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 604     @Override                                                                                            </span>
<span class="135967723667379112" onmouseenter="enter('135967723667379112');" onmouseout="out('135967723667379112');" style=""> 605     public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {                  </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 606         boolean underCodeMaxUses = true;                                                                 </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 607         if (code.isLimitedUse()) {                                                                       </span>
<span class="5487567461678823803" onmouseenter="enter('5487567461678823803');" onmouseout="out('5487567461678823803');" style=""> 608             Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());                   </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 609             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 610         }                                                                                                </span>
<span class="7193079189056024188" onmouseenter="enter('7193079189056024188');" onmouseout="out('7193079189056024188');" style=""> 611         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 612     }                                                                                                    </span>
<span  style=""> 613                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 614     @Override                                                                                            </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 615     @SuppressWarnings(&quot;unchecked&quot;)                                                                       </span>
<span class="-640784293225096821" onmouseenter="enter('-640784293225096821');" onmouseout="out('-640784293225096821');" style=""> 616     public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {                                            </span>
<span class="-348027159212233091" onmouseenter="enter('-348027159212233091');" onmouseout="out('-348027159212233091');" style=""> 617         HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();                                                    </span>
<span  style=""> 618                                                                                                          </span>
<span class="-7949809618309864364" onmouseenter="enter('-7949809618309864364');" onmouseout="out('-7949809618309864364');" style=""> 619         Transformer adjustmentToOfferTransformer = new Transformer() {                                   </span>
<span  style=""> 620                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 621             @Override                                                                                    </span>
<span class="-2718541205900117239" onmouseenter="enter('-2718541205900117239');" onmouseout="out('-2718541205900117239');" style=""> 622             public Object transform(Object input) {                                                      </span>
<span class="4176981446584954696" onmouseenter="enter('4176981446584954696');" onmouseout="out('4176981446584954696');" style=""> 623                 return ((Adjustment)input).getOffer();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 624             }                                                                                            </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 625         };                                                                                               </span>
<span  style=""> 626                                                                                                          </span>
<span class="-8370514600917699300" onmouseenter="enter('-8370514600917699300');" onmouseout="out('-8370514600917699300');" style=""><abbr title=" 627         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));"> 627         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer))ðŸ”µ</abbr></span>
<span  style=""> 628                                                                                                          </span>
<span class="3897119298100986011" onmouseenter="enter('3897119298100986011');" onmouseout="out('3897119298100986011');" style=""> 629         if (order.getOrderItems() != null) {                                                             </span>
<span class="820796442257070700" onmouseenter="enter('820796442257070700');" onmouseout="out('820796442257070700');" style=""> 630             for (OrderItem item : order.getOrderItems()) {                                               </span>
<span class="722957474719034118" onmouseenter="enter('722957474719034118');" onmouseout="out('722957474719034118');" style=""><abbr title=" 631                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 631                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTrðŸ”µ</abbr></span>
<span  style=""> 632                                                                                                          </span>
<span class="-3519908190158496681" onmouseenter="enter('-3519908190158496681');" onmouseout="out('-3519908190158496681');" style=""> 633                 //record usage for price details on the item as well                                     </span>
<span class="-2952948196187271811" onmouseenter="enter('-2952948196187271811');" onmouseout="out('-2952948196187271811');" style=""> 634                 if (item.getOrderItemPriceDetails() != null) {                                           </span>
<span class="773323050474809935" onmouseenter="enter('773323050474809935');" onmouseout="out('773323050474809935');" style=""> 635                     for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {                </span>
<span class="7134713472391876911" onmouseenter="enter('7134713472391876911');" onmouseout="out('7134713472391876911');" style=""><abbr title=" 636                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 636                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments()ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 637                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 638                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 639             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 640         }                                                                                                </span>
<span  style=""> 641                                                                                                          </span>
<span class="7944520279780748823" onmouseenter="enter('7944520279780748823');" onmouseout="out('7944520279780748823');" style=""> 642         if (order.getFulfillmentGroups() != null) {                                                      </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 643             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                   </span>
<span class="-293187079687761920" onmouseenter="enter('-293187079687761920');" onmouseout="out('-293187079687761920');" style=""><abbr title=" 644                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 644                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 645             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 646         }                                                                                                </span>
<span class="-6419540350677864751" onmouseenter="enter('-6419540350677864751');" onmouseout="out('-6419540350677864751');" style=""> 647         return result;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 648     }                                                                                                    </span>
<span  style=""> 649                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 650     @Override                                                                                            </span>
<span class="-2491837224879773303" onmouseenter="enter('-2491837224879773303');" onmouseout="out('-2491837224879773303');" style=""> 651     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {                             </span>
<span class="-1370687283458217641" onmouseenter="enter('-1370687283458217641');" onmouseout="out('-1370687283458217641');" style=""> 652         return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order)); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 653     }                                                                                                    </span>
<span  style=""> 654                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 655     @Override                                                                                            </span>
<span class="-6407317956511861474" onmouseenter="enter('-6407317956511861474');" onmouseout="out('-6407317956511861474');" style=""><abbr title=" 656     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {"> 656     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffðŸ”µ</abbr></span>
<span class="-4490485247927949218" onmouseenter="enter('-4490485247927949218');" onmouseout="out('-4490485247927949218');" style=""> 657         HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();                  </span>
<span class="983580358500385861" onmouseenter="enter('983580358500385861');" onmouseout="out('983580358500385861');" style=""> 658         for (OfferCode code : codes) {                                                                   </span>
<span class="6305098044991751707" onmouseenter="enter('6305098044991751707');" onmouseout="out('6305098044991751707');" style=""> 659             if (appliedOffers.contains(code.getOffer())) {                                               </span>
<span class="3746501443462939384" onmouseenter="enter('3746501443462939384');" onmouseout="out('3746501443462939384');" style=""> 660                 offerToCodeMapping.put(code.getOffer(), code);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 661             }                                                                                            </span>
<span  style=""> 662                                                                                                          </span>
<span class="-240986298797431748" onmouseenter="enter('-240986298797431748');" onmouseout="out('-240986298797431748');" style=""> 663             List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();                            </span>
<span  style=""> 664                                                                                                          </span>
<span class="7454577566794152811" onmouseenter="enter('7454577566794152811');" onmouseout="out('7454577566794152811');" style=""> 665             extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);   </span>
<span class="-7985615425314556326" onmouseenter="enter('-7985615425314556326');" onmouseout="out('-7985615425314556326');" style=""> 666             for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {                       </span>
<span class="-808811284028256215" onmouseenter="enter('-808811284028256215');" onmouseout="out('-808811284028256215');" style=""> 667                 offerToCodeMapping.put(additionalOfferToBeApplied, code);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 668             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 669         }                                                                                                </span>
<span class="7175253914401568841" onmouseenter="enter('7175253914401568841');" onmouseout="out('7175253914401568841');" style=""> 670         return offerToCodeMapping;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 671     }                                                                                                    </span>
<span  style=""> 672                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 673     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 674     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-1347767159915315738" onmouseenter="enter('-1347767159915315738');" onmouseout="out('-1347767159915315738');" style=""> 675     public Boolean deleteOfferCode(OfferCode code) {                                                     </span>
<span class="-5986603348121186173" onmouseenter="enter('-5986603348121186173');" onmouseout="out('-5986603348121186173');" style=""> 676         if (offerCodeDao.offerCodeIsUsed(code)) {                                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 677             return false;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 678         }                                                                                                </span>
<span  style=""> 679                                                                                                          </span>
<span class="-9122073777393685295" onmouseenter="enter('-9122073777393685295');" onmouseout="out('-9122073777393685295');" style=""> 680         offerCodeDao.delete(code);                                                                       </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 681         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 682     }                                                                                                    </span>
<span  style=""> 683                                                                                                          </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 684     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 685     @Override                                                                                            </span>
<span class="-3816301958562278169" onmouseenter="enter('-3816301958562278169');" onmouseout="out('-3816301958562278169');" style=""> 686     public Offer duplicate(Long originalOfferId) {                                                       </span>
<span class="-5738299300293223874" onmouseenter="enter('-5738299300293223874');" onmouseout="out('-5738299300293223874');" style=""> 687         Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();                                   </span>
<span class="2715783386963629594" onmouseenter="enter('2715783386963629594');" onmouseout="out('2715783386963629594');" style=""> 688         copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);                                    </span>
<span class="-2013584672995219797" onmouseenter="enter('-2013584672995219797');" onmouseout="out('-2013584672995219797');" style=""> 689         return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 690     }                                                                                                    </span>
<span  style=""> 691                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 692     @Override                                                                                            </span>
<span class="3228088005821970316" onmouseenter="enter('3228088005821970316');" onmouseout="out('3228088005821970316');" style=""> 693     public CustomerOfferDao getCustomerOfferDao() {                                                      </span>
<span class="-801333879424417122" onmouseenter="enter('-801333879424417122');" onmouseout="out('-801333879424417122');" style=""> 694         return customerOfferDao;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 695     }                                                                                                    </span>
<span  style=""> 696                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 697     @Override                                                                                            </span>
<span class="6308179313298689001" onmouseenter="enter('6308179313298689001');" onmouseout="out('6308179313298689001');" style=""> 698     public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {                                 </span>
<span class="438520929977701037" onmouseenter="enter('438520929977701037');" onmouseout="out('438520929977701037');" style=""> 699         this.customerOfferDao = customerOfferDao;                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 700     }                                                                                                    </span>
<span  style=""> 701                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 702     @Override                                                                                            </span>
<span class="8266606365944954497" onmouseenter="enter('8266606365944954497');" onmouseout="out('8266606365944954497');" style=""> 703     public OfferCodeDao getOfferCodeDao() {                                                              </span>
<span class="-4005874311041664572" onmouseenter="enter('-4005874311041664572');" onmouseout="out('-4005874311041664572');" style=""> 704         return offerCodeDao;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 705     }                                                                                                    </span>
<span  style=""> 706                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 707     @Override                                                                                            </span>
<span class="-5083072655758254890" onmouseenter="enter('-5083072655758254890');" onmouseout="out('-5083072655758254890');" style=""> 708     public void setOfferCodeDao(OfferCodeDao offerCodeDao) {                                             </span>
<span class="-7060255547979502806" onmouseenter="enter('-7060255547979502806');" onmouseout="out('-7060255547979502806');" style=""> 709         this.offerCodeDao = offerCodeDao;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 710     }                                                                                                    </span>
<span  style=""> 711                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 712     @Override                                                                                            </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 713     public OfferDao getOfferDao() {                                                                      </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 714         return offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 715     }                                                                                                    </span>
<span  style=""> 716                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 717     @Override                                                                                            </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 718     public void setOfferDao(OfferDao offerDao) {                                                         </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 719         this.offerDao = offerDao;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 720     }                                                                                                    </span>
<span  style=""> 721                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 722     @Override                                                                                            </span>
<span class="3012408951835963759" onmouseenter="enter('3012408951835963759');" onmouseout="out('3012408951835963759');" style=""> 723     public OrderOfferProcessor getOrderOfferProcessor() {                                                </span>
<span class="-5069105522766505260" onmouseenter="enter('-5069105522766505260');" onmouseout="out('-5069105522766505260');" style=""> 724         return orderOfferProcessor;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 725     }                                                                                                    </span>
<span  style=""> 726                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 727     @Override                                                                                            </span>
<span class="-2542583147665382651" onmouseenter="enter('-2542583147665382651');" onmouseout="out('-2542583147665382651');" style=""> 728     public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {                        </span>
<span class="1533378703496715943" onmouseenter="enter('1533378703496715943');" onmouseout="out('1533378703496715943');" style=""> 729         this.orderOfferProcessor = orderOfferProcessor;                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 730     }                                                                                                    </span>
<span  style=""> 731                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 732     @Override                                                                                            </span>
<span class="1694843298235251985" onmouseenter="enter('1694843298235251985');" onmouseout="out('1694843298235251985');" style=""> 733     public ItemOfferProcessor getItemOfferProcessor() {                                                  </span>
<span class="1583504692330339191" onmouseenter="enter('1583504692330339191');" onmouseout="out('1583504692330339191');" style=""> 734         return itemOfferProcessor;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 735     }                                                                                                    </span>
<span  style=""> 736                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 737     @Override                                                                                            </span>
<span class="145400756853488798" onmouseenter="enter('145400756853488798');" onmouseout="out('145400756853488798');" style=""> 738     public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {                           </span>
<span class="-102405468021411755" onmouseenter="enter('-102405468021411755');" onmouseout="out('-102405468021411755');" style=""> 739         this.itemOfferProcessor = itemOfferProcessor;                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 740     }                                                                                                    </span>
<span  style=""> 741                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 742     @Override                                                                                            </span>
<span class="3022939772369206873" onmouseenter="enter('3022939772369206873');" onmouseout="out('3022939772369206873');" style=""> 743     public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {                          </span>
<span class="-3088775944214719317" onmouseenter="enter('-3088775944214719317');" onmouseout="out('-3088775944214719317');" style=""> 744         return fulfillmentGroupOfferProcessor;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 745     }                                                                                                    </span>
<span  style=""> 746                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 747     @Override                                                                                            </span>
<span class="-8855456203149015957" onmouseenter="enter('-8855456203149015957');" onmouseout="out('-8855456203149015957');" style=""><abbr title=" 748     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {"> 748     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProðŸ”µ</abbr></span>
<span class="-7108053920330155376" onmouseenter="enter('-7108053920330155376');" onmouseout="out('-7108053920330155376');" style=""> 749         this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 750     }                                                                                                    </span>
<span  style=""> 751                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 752     @Override                                                                                            </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 753     public PromotableItemFactory getPromotableItemFactory() {                                            </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 754         return promotableItemFactory;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 755     }                                                                                                    </span>
<span  style=""> 756                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 757     @Override                                                                                            </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 758     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                  </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 759         this.promotableItemFactory = promotableItemFactory;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 760     }                                                                                                    </span>
<span  style=""> 761                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 762     @Override                                                                                            </span>
<span class="-285725005067991728" onmouseenter="enter('-285725005067991728');" onmouseout="out('-285725005067991728');" style=""> 763     public OfferCode findOfferCodeById(Long id) {                                                        </span>
<span class="4928857363700364693" onmouseenter="enter('4928857363700364693');" onmouseout="out('4928857363700364693');" style=""> 764         return offerCodeDao.readOfferCodeById(id);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 765     }                                                                                                    </span>
<span  style=""> 766                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 767     @Override                                                                                            </span>
<span class="-6829155498814719074" onmouseenter="enter('-6829155498814719074');" onmouseout="out('-6829155498814719074');" style=""> 768     public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {                                   </span>
<span class="-1521639274006709657" onmouseenter="enter('-1521639274006709657');" onmouseout="out('-1521639274006709657');" style=""> 769         return offerCodeDao.readOfferCodesByIds(ids);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 770     }                                                                                                    </span>
<span  style=""> 771                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 772     @Override                                                                                            </span>
<span class="5587340050529616033" onmouseenter="enter('5587340050529616033');" onmouseout="out('5587340050529616033');" style=""> 773     public OrderService getOrderService() {                                                              </span>
<span class="-7558473787756148723" onmouseenter="enter('-7558473787756148723');" onmouseout="out('-7558473787756148723');" style=""> 774         return orderService;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 775     }                                                                                                    </span>
<span  style=""> 776                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 777     @Override                                                                                            </span>
<span class="4536819371590947172" onmouseenter="enter('4536819371590947172');" onmouseout="out('4536819371590947172');" style=""> 778     public void setOrderService(OrderService orderService) {                                             </span>
<span class="7368861914925934250" onmouseenter="enter('7368861914925934250');" onmouseout="out('7368861914925934250');" style=""> 779         this.orderService = orderService;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 780     }                                                                                                    </span>
<span  style=""> 781                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 782     @Override                                                                                            </span>
<span class="-2217088353489190987" onmouseenter="enter('-2217088353489190987');" onmouseout="out('-2217088353489190987');" style=""> 783     public Offer findOfferById(Long offerId) {                                                           </span>
<span class="-5171648678549667040" onmouseenter="enter('-5171648678549667040');" onmouseout="out('-5171648678549667040');" style=""> 784         return offerDao.readOfferById(offerId);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 785     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 786 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18 package org.broadleafcommerce.core.offer.service;                                                        </span>
<span  style="">  19                                                                                                          </span>
<span class="8596464405353709537" onmouseenter="enter('8596464405353709537');" onmouseout="out('8596464405353709537');" style="">  20 import org.apache.commons.collections.CollectionUtils;                                                   </span>
<span class="2953846583056246827" onmouseenter="enter('2953846583056246827');" onmouseout="out('2953846583056246827');" style="">  21 import org.apache.commons.collections.Transformer;                                                       </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  22 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  23 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-2193028153657877676" onmouseenter="enter('-2193028153657877676');" onmouseout="out('-2193028153657877676');" style="">  24 import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;                                 </span>
<span class="-3349026188166660873" onmouseenter="enter('-3349026188166660873');" onmouseout="out('-3349026188166660873');" style="">  25 import org.broadleafcommerce.common.persistence.EntityDuplicator;                                        </span>
<span class="-2818686525334833130" onmouseenter="enter('-2818686525334833130');" onmouseout="out('-2818686525334833130');" style="">  26 import org.broadleafcommerce.common.sandbox.SandBoxHelper;                                               </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  27 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                     </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  28 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                </span>
<span class="6205208880685044389" onmouseenter="enter('6205208880685044389');" onmouseout="out('6205208880685044389');" style="">  29 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;                                            </span>
<span class="-7911436562744873568" onmouseenter="enter('-7911436562744873568');" onmouseout="out('-7911436562744873568');" style="">  30 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;                                                </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  31 import org.broadleafcommerce.core.offer.dao.OfferDao;                                                    </span>
<span class="-91689670446949346" onmouseenter="enter('-91689670446949346');" onmouseout="out('-91689670446949346');" style="">  32 import org.broadleafcommerce.core.offer.domain.*;                                                        </span>
<span class="4287099423657810905" onmouseenter="enter('4287099423657810905');" onmouseout="out('4287099423657810905');" style="">  33 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;</span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  34 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;            </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  35 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;           </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  36 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                   </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  37 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                         </span>
<span class="5713212224635448284" onmouseenter="enter('5713212224635448284');" onmouseout="out('5713212224635448284');" style="">  38 import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;                </span>
<span class="-2454758753718589449" onmouseenter="enter('-2454758753718589449');" onmouseout="out('-2454758753718589449');" style="">  39 import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;                            </span>
<span class="8227287359407176835" onmouseenter="enter('8227287359407176835');" onmouseout="out('8227287359407176835');" style="">  40 import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;                           </span>
<span class="-5727938558534008634" onmouseenter="enter('-5727938558534008634');" onmouseout="out('-5727938558534008634');" style="">  41 import org.broadleafcommerce.core.offer.service.type.OfferType;                                          </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  42 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                         </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  43 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  44 import org.broadleafcommerce.core.order.domain.OrderItem;                                                </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  45 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                     </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  46 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  47 import org.broadleafcommerce.core.pricing.service.exception.PricingException;                            </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  48 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  49 import org.springframework.stereotype.Service;                                                           </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  50 import org.springframework.transaction.annotation.Transactional;                                         </span>
<span  style="">  51                                                                                                          </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  52 import java.util.ArrayList;                                                                              </span>
<span class="-112105277767313938" onmouseenter="enter('-112105277767313938');" onmouseout="out('-112105277767313938');" style="">  53 import java.util.Collection;                                                                             </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  54 import java.util.HashMap;                                                                                </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  55 import java.util.HashSet;                                                                                </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  56 import java.util.Iterator;                                                                               </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  57 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  58 import java.util.Map;                                                                                    </span>
<span class="6306724220981822255" onmouseenter="enter('6306724220981822255');" onmouseout="out('6306724220981822255');" style="">  59 import java.util.Objects;                                                                                </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  60 import java.util.Set;                                                                                    </span>
<span  style="">  61                                                                                                          </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  62 import javax.annotation.Resource;                                                                        </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  63 import javax.persistence.EntityManager;                                                                  </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  64 import javax.persistence.PersistenceContext;                                                             </span>
<span  style="">  65                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  66 /**                                                                                                      </span>
<span class="-2667338179687874348" onmouseenter="enter('-2667338179687874348');" onmouseout="out('-2667338179687874348');" style="">  67  * The Class OfferServiceImpl.                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  68  */                                                                                                      </span>
<span class="504450232350438262" onmouseenter="enter('504450232350438262');" onmouseout="out('504450232350438262');" style="">  69 @Service(&quot;blOfferService&quot;)                                                                               </span>
<span class="6786430150403502423" onmouseenter="enter('6786430150403502423');" onmouseout="out('6786430150403502423');" style="">  70 public class OfferServiceImpl implements OfferService {                                                  </span>
<span  style="">  71                                                                                                          </span>
<span class="8897944981470617719" onmouseenter="enter('8897944981470617719');" onmouseout="out('8897944981470617719');" style="">  72     private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);                            </span>
<span  style="">  73                                                                                                          </span>
<span class="3846751699212951796" onmouseenter="enter('3846751699212951796');" onmouseout="out('3846751699212951796');" style="">  74     // should be called outside of Offer service after Offer service is executed                         </span>
<span class="-5484979233832760683" onmouseenter="enter('-5484979233832760683');" onmouseout="out('-5484979233832760683');" style="">  75     @Resource(name=&quot;blCustomerOfferDao&quot;)                                                                 </span>
<span class="-5771823415174942027" onmouseenter="enter('-5771823415174942027');" onmouseout="out('-5771823415174942027');" style="">  76     protected CustomerOfferDao customerOfferDao;                                                         </span>
<span  style="">  77                                                                                                          </span>
<span class="-1524144969871346405" onmouseenter="enter('-1524144969871346405');" onmouseout="out('-1524144969871346405');" style="">  78     @Resource(name=&quot;blOfferCodeDao&quot;)                                                                     </span>
<span class="-6984238934820524758" onmouseenter="enter('-6984238934820524758');" onmouseout="out('-6984238934820524758');" style="">  79     protected OfferCodeDao offerCodeDao;                                                                 </span>
<span  style="">  80                                                                                                          </span>
<span class="-8247969455122443370" onmouseenter="enter('-8247969455122443370');" onmouseout="out('-8247969455122443370');" style="">  81     @Resource(name=&quot;blOfferAuditService&quot;)                                                                </span>
<span class="-6742419488595856311" onmouseenter="enter('-6742419488595856311');" onmouseout="out('-6742419488595856311');" style="">  82     protected OfferAuditService offerAuditService;                                                       </span>
<span  style="">  83                                                                                                          </span>
<span class="-6976077299079381435" onmouseenter="enter('-6976077299079381435');" onmouseout="out('-6976077299079381435');" style="">  84     @Resource(name=&quot;blOfferDao&quot;)                                                                         </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  85     protected OfferDao offerDao;                                                                         </span>
<span  style="">  86                                                                                                          </span>
<span class="-3191658961867656636" onmouseenter="enter('-3191658961867656636');" onmouseout="out('-3191658961867656636');" style="">  87     @Resource(name=&quot;blOrderOfferProcessor&quot;)                                                              </span>
<span class="-3818126380928091101" onmouseenter="enter('-3818126380928091101');" onmouseout="out('-3818126380928091101');" style="">  88     protected OrderOfferProcessor orderOfferProcessor;                                                   </span>
<span  style="">  89                                                                                                          </span>
<span class="-6223428528083119866" onmouseenter="enter('-6223428528083119866');" onmouseout="out('-6223428528083119866');" style="">  90     @Resource(name=&quot;blItemOfferProcessor&quot;)                                                               </span>
<span class="-7827297227357944415" onmouseenter="enter('-7827297227357944415');" onmouseout="out('-7827297227357944415');" style="">  91     protected ItemOfferProcessor itemOfferProcessor;                                                     </span>
<span  style="">  92                                                                                                          </span>
<span class="-1476654469985531605" onmouseenter="enter('-1476654469985531605');" onmouseout="out('-1476654469985531605');" style="">  93     @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)                                                   </span>
<span class="7634983124983010999" onmouseenter="enter('7634983124983010999');" onmouseout="out('7634983124983010999');" style="">  94     protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;                             </span>
<span  style="">  95                                                                                                          </span>
<span class="-4330844585159307437" onmouseenter="enter('-4330844585159307437');" onmouseout="out('-4330844585159307437');" style="">  96     @Resource(name=&quot;blPromotableItemFactory&quot;)                                                            </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  97     protected PromotableItemFactory promotableItemFactory;                                               </span>
<span  style="">  98                                                                                                          </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style="">  99     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                   </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style=""> 100     protected OfferServiceExtensionManager extensionManager;                                             </span>
<span  style=""> 101                                                                                                          </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 102     @Resource(name = &quot;blOrderService&quot;)                                                                   </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 103     protected OrderService orderService;                                                                 </span>
<span  style=""> 104                                                                                                          </span>
<span class="-3946461589801993391" onmouseenter="enter('-3946461589801993391');" onmouseout="out('-3946461589801993391');" style=""> 105     @Resource(name = &quot;blSandBoxHelper&quot;)                                                                  </span>
<span class="-7799183597372200632" onmouseenter="enter('-7799183597372200632');" onmouseout="out('-7799183597372200632');" style=""> 106     protected SandBoxHelper sandBoxHelper;                                                               </span>
<span  style=""> 107                                                                                                          </span>
<span class="-4259734795637808055" onmouseenter="enter('-4259734795637808055');" onmouseout="out('-4259734795637808055');" style=""> 108     @PersistenceContext(unitName=&quot;blPU&quot;)                                                                 </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style=""> 109     protected EntityManager em;                                                                          </span>
<span  style=""> 110                                                                                                          </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 111     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                  </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 112     protected StreamingTransactionCapableUtil transUtil;                                                 </span>
<span  style=""> 113                                                                                                          </span>
<span class="-8384326529234094002" onmouseenter="enter('-8384326529234094002');" onmouseout="out('-8384326529234094002');" style=""> 114     @Resource(name=&quot;blEntityDuplicator&quot;)                                                                 </span>
<span class="-9194612273021432316" onmouseenter="enter('-9194612273021432316');" onmouseout="out('-9194612273021432316');" style=""> 115     protected EntityDuplicator duplicator;                                                               </span>
<span  style=""> 116                                                                                                          </span>
<span class="723166851410757036" onmouseenter="enter('723166851410757036');" onmouseout="out('723166851410757036');" style=""> 117     @Resource(name=&quot;blOfferDuplicateModifier&quot;)                                                           </span>
<span class="8658910844320022950" onmouseenter="enter('8658910844320022950');" onmouseout="out('8658910844320022950');" style=""> 118     protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;                                     </span>
<span  style=""> 119                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 120     @Override                                                                                            </span>
<span class="-2033305286790048708" onmouseenter="enter('-2033305286790048708');" onmouseout="out('-2033305286790048708');" style=""> 121     public List&lt;Offer&gt; findAllOffers() {                                                                 </span>
<span class="2132174063530273788" onmouseenter="enter('2132174063530273788');" onmouseout="out('2132174063530273788');" style=""> 122         return offerDao.readAllOffers();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 123     }                                                                                                    </span>
<span  style=""> 124                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 125     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 126     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="7144811092176845141" onmouseenter="enter('7144811092176845141');" onmouseout="out('7144811092176845141');" style=""> 127     public Offer save(Offer offer) {                                                                     </span>
<span class="-264708178039771798" onmouseenter="enter('-264708178039771798');" onmouseout="out('-264708178039771798');" style=""> 128         return offerDao.save(offer);                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129     }                                                                                                    </span>
<span  style=""> 130                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 131     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 132     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-5514670765130856091" onmouseenter="enter('-5514670765130856091');" onmouseout="out('-5514670765130856091');" style=""> 133     public OfferCode saveOfferCode(OfferCode offerCode) {                                                </span>
<span class="3125778008044685658" onmouseenter="enter('3125778008044685658');" onmouseout="out('3125778008044685658');" style=""> 134         offerCode.setOffer(offerDao.save(offerCode.getOffer()));                                         </span>
<span class="6906137479190051982" onmouseenter="enter('6906137479190051982');" onmouseout="out('6906137479190051982');" style=""> 135         return offerCodeDao.save(offerCode);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 136     }                                                                                                    </span>
<span  style=""> 137                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 138     /**                                                                                                  </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""><abbr title=" 139      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 139      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr></span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""><abbr title=" 140      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 140      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr></span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 141      * cannot appear more than once in the list.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 142      *                                                                                                   </span>
<span class="-709313334493645866" onmouseenter="enter('-709313334493645866');" onmouseout="out('-709313334493645866');" style=""> 143      * @param code                                                                                       </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 144      * @return a List of offers that may apply to this order                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 145      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 146     @Override                                                                                            </span>
<span class="-6840847083603451180" onmouseenter="enter('-6840847083603451180');" onmouseout="out('-6840847083603451180');" style=""> 147     public Offer lookupOfferByCode(String code) {                                                        </span>
<span class="-531732708503781646" onmouseenter="enter('-531732708503781646');" onmouseout="out('-531732708503781646');" style=""> 148         Offer offer = null;                                                                              </span>
<span class="-8218576552188075283" onmouseenter="enter('-8218576552188075283');" onmouseout="out('-8218576552188075283');" style=""> 149         OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);                                    </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 150         if (offerCode != null) {                                                                         </span>
<span class="-2561785727340284423" onmouseenter="enter('-2561785727340284423');" onmouseout="out('-2561785727340284423');" style=""> 151             offer = offerCode.getOffer();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 152         }                                                                                                </span>
<span class="-8963791522625561917" onmouseenter="enter('-8963791522625561917');" onmouseout="out('-8963791522625561917');" style=""> 153         return offer;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 154     }                                                                                                    </span>
<span  style=""> 155                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 156     @Override                                                                                            </span>
<span class="2883322601430833612" onmouseenter="enter('2883322601430833612');" onmouseout="out('2883322601430833612');" style=""> 157     public OfferCode lookupOfferCodeByCode(String code){                                                 </span>
<span class="8795189428566002896" onmouseenter="enter('8795189428566002896');" onmouseout="out('8795189428566002896');" style=""> 158         return offerCodeDao.readOfferCodeByCode(code);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159     }                                                                                                    </span>
<span  style=""> 160                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 161     @Override                                                                                            </span>
<span class="-2543778591938191529" onmouseenter="enter('-2543778591938191529');" onmouseout="out('-2543778591938191529');" style=""> 162     public List&lt;Offer&gt; lookupAllOffersByCode(String code) {                                              </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 163         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                     </span>
<span class="-3360697953765841703" onmouseenter="enter('-3360697953765841703');" onmouseout="out('-3360697953765841703');" style=""> 164         List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);                         </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 165         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 166             if (offerCode != null) {                                                                     </span>
<span class="-7816274075460376657" onmouseenter="enter('-7816274075460376657');" onmouseout="out('-7816274075460376657');" style=""> 167                 offers.add(offerCode.getOffer());                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169         }                                                                                                </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 170         return offers;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 171     }                                                                                                    </span>
<span  style=""> 172                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 173     @Override                                                                                            </span>
<span class="4676855439599320404" onmouseenter="enter('4676855439599320404');" onmouseout="out('4676855439599320404');" style=""> 174     public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){                                       </span>
<span class="-4234235759448675045" onmouseenter="enter('-4234235759448675045');" onmouseout="out('-4234235759448675045');" style=""> 175         return offerCodeDao.readAllOfferCodesByCode(code);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 176     }                                                                                                    </span>
<span  style=""> 177                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 178     /**                                                                                                  </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""><abbr title=" 179      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 179      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr></span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""><abbr title=" 180      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 180      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr></span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 181      * cannot appear more than once in the list.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 182      *                                                                                                   </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 183      * @param order                                                                                      </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 184      * @return a List of offers that may apply to this order                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 185      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 186     @Override                                                                                            </span>
<span class="-5814298891852821500" onmouseenter="enter('-5814298891852821500');" onmouseout="out('-5814298891852821500');" style=""> 187     public List&lt;Offer&gt; buildOfferListForOrder(Order order) {                                             </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 188         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                     </span>
<span class="-3235900677601494398" onmouseenter="enter('-3235900677601494398');" onmouseout="out('-3235900677601494398');" style=""> 189         List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());         </span>
<span class="7699769166343685501" onmouseenter="enter('7699769166343685501');" onmouseout="out('7699769166343685501');" style=""> 190         for (CustomerOffer customerOffer : customerOffers) {                                             </span>
<span class="-2310400538171319838" onmouseenter="enter('-2310400538171319838');" onmouseout="out('-2310400538171319838');" style=""> 191             if (!offers.contains(customerOffer.getOffer())) {                                            </span>
<span class="5233078073066950969" onmouseenter="enter('5233078073066950969');" onmouseout="out('5233078073066950969');" style=""> 192                 offers.add(customerOffer.getOffer());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 194         }                                                                                                </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 195         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                          </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 196 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="-7332519531441163733" onmouseenter="enter('-7332519531441163733');" onmouseout="out('-7332519531441163733');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 197 //        int before = orderOfferCodes.size();                                                           </span>
<span class="1955749666612820833" onmouseenter="enter('1955749666612820833');" onmouseout="out('1955749666612820833');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 198 //        orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                  </span>
<span class="-6467003552280566260" onmouseenter="enter('-6467003552280566260');" onmouseout="out('-6467003552280566260');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 199 /*        int after = orderOfferCodes.size();                                                            </span>
<span class="2182795146752320946" onmouseenter="enter('2182795146752320946');" onmouseout="out('2182795146752320946');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 200         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 200         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr></span>
<span class="3842576300509712789" onmouseenter="enter('3842576300509712789');" onmouseout="out('3842576300509712789');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 201         if(o !=null &amp;&amp; (Boolean)o &amp;&amp; before!=after){                                                     </span>
<span class="-3668454086264686215" onmouseenter="enter('-3668454086264686215');" onmouseout="out('-3668454086264686215');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 202             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 202             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiðŸ”µ</abbr></span>
<span class="-2684617365274670769" onmouseenter="enter('-2684617365274670769');" onmouseout="out('-2684617365274670769');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 203         }*/                                                                                              </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 204 ||||||| BASE                                                                                             </span>
<span class="-5394428663749604022" onmouseenter="enter('-5394428663749604022');" onmouseout="out('-5394428663749604022');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205         int before = orderOfferCodes.size();                                                             </span>
<span class="-6665865767746694239" onmouseenter="enter('-6665865767746694239');" onmouseout="out('-6665865767746694239');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                    </span>
<span class="8766753228261658218" onmouseenter="enter('8766753228261658218');" onmouseout="out('8766753228261658218');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207         int after = orderOfferCodes.size();                                                              </span>
<span class="2182795146752320946" onmouseenter="enter('2182795146752320946');" onmouseout="out('2182795146752320946');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 208         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 208         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr></span>
<span class="3842576300509712789" onmouseenter="enter('3842576300509712789');" onmouseout="out('3842576300509712789');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209         if(o !=null &amp;&amp; (Boolean)o &amp;&amp; before!=after){                                                     </span>
<span class="-3668454086264686215" onmouseenter="enter('-3668454086264686215');" onmouseout="out('-3668454086264686215');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 210             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 210             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211         }                                                                                                </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 212 =======                                                                                                  </span>
<span class="-6665865767746694239" onmouseenter="enter('-6665865767746694239');" onmouseout="out('-6665865767746694239');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                    </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 214 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="2682597879629079185" onmouseenter="enter('2682597879629079185');" onmouseout="out('2682597879629079185');" style=""> 215         for (OfferCode orderOfferCode : orderOfferCodes) {                                               </span>
<span class="-1857624084667800558" onmouseenter="enter('-1857624084667800558');" onmouseout="out('-1857624084667800558');" style=""> 216             if (!offers.contains(orderOfferCode.getOffer())) {                                           </span>
<span class="4188766124804405127" onmouseenter="enter('4188766124804405127');" onmouseout="out('4188766124804405127');" style=""> 217                 offers.add(orderOfferCode.getOffer());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 218             }                                                                                            </span>
<span class="-4468546552745233084" onmouseenter="enter('-4468546552745233084');" onmouseout="out('-4468546552745233084');" style=""> 219             extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 220         }                                                                                                </span>
<span class="-9188634082558155234" onmouseenter="enter('-9188634082558155234');" onmouseout="out('-9188634082558155234');" style=""> 221         List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();                                      </span>
<span class="-8411171878687156520" onmouseenter="enter('-8411171878687156520');" onmouseout="out('-8411171878687156520');" style=""> 222         for (Offer globalOffer : globalOffers) {                                                         </span>
<span class="2071278729839157974" onmouseenter="enter('2071278729839157974');" onmouseout="out('2071278729839157974');" style=""> 223             if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {  </span>
<span class="-3050025518373868772" onmouseenter="enter('-3050025518373868772');" onmouseout="out('-3050025518373868772');" style=""> 224                 offers.add(globalOffer);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 225             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 226         }                                                                                                </span>
<span  style=""> 227                                                                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 228         if (extensionManager != null) {                                                                  </span>
<span class="1817402996237899777" onmouseenter="enter('1817402996237899777');" onmouseout="out('1817402996237899777');" style=""> 229             extensionManager.applyAdditionalFilters(offers, order);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 230         }                                                                                                </span>
<span  style=""> 231                                                                                                          </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 232         return offers;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 233     }                                                                                                    </span>
<span  style=""> 234                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 235     @Override                                                                                            </span>
<span class="2056305643902587707" onmouseenter="enter('2056305643902587707');" onmouseout="out('2056305643902587707');" style=""> 236     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {                                  </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 237         Customer customer = order.getCustomer();                                                         </span>
<span class="-5041998041456755776" onmouseenter="enter('-5041998041456755776');" onmouseout="out('-5041998041456755776');" style=""> 238         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();                                             </span>
<span  style=""> 239                                                                                                          </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 240         if (extensionManager != null) {                                                                  </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 241             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 242         }                                                                                                </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 243         if (!offerCodes.isEmpty()) {                                                                     </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 244             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                             </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 245             while (itr.hasNext()) {                                                                      </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 246                 OfferCode offerCode = itr.next();                                                        </span>
<span class="-776136422183497161" onmouseenter="enter('-776136422183497161');" onmouseout="out('-776136422183497161');" style=""> 247                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {       </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 248                     itr.remove();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 249                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 250             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 252         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 253     }                                                                                                    </span>
<span  style=""> 254                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 255     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 256     @Override                                                                                            </span>
<span class="3843851677430304310" onmouseenter="enter('3843851677430304310');" onmouseout="out('3843851677430304310');" style=""> 257     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {                            </span>
<span class="-6957816096303048614" onmouseenter="enter('-6957816096303048614');" onmouseout="out('-6957816096303048614');" style=""> 258         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 259         if (extensionManager != null) {                                                                  </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 260             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261         }                                                                                                </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 262         if (!offerCodes.isEmpty()) {                                                                     </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 263             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                             </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 264             while (itr.hasNext()) {                                                                      </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 265                 OfferCode offerCode = itr.next();                                                        </span>
<span class="6086018267170409432" onmouseenter="enter('6086018267170409432');" onmouseout="out('6086018267170409432');" style=""> 266                 if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {    </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 267                     itr.remove();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 268                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 269             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 270         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 271         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 272     }                                                                                                    </span>
<span  style=""> 273                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 274     /**                                                                                                  </span>
<span class="2837560355574155003" onmouseenter="enter('2837560355574155003');" onmouseout="out('2837560355574155003');" style=""> 275      * Private method used to retrieve all offers assigned to this customer.  These offers are           </span>
<span class="4852710310174118924" onmouseenter="enter('4852710310174118924');" onmouseout="out('4852710310174118924');" style=""> 276      * programmatically assigned to the customer.                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 277      *                                                                                                   </span>
<span class="1094425505394812731" onmouseenter="enter('1094425505394812731');" onmouseout="out('1094425505394812731');" style=""> 278      * @param customer                                                                                   </span>
<span class="-3868237647402015492" onmouseenter="enter('-3868237647402015492');" onmouseout="out('-3868237647402015492');" style=""> 279      * @return a List of offers assigned to the customer                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 280      */                                                                                                  </span>
<span class="-1064959765029423996" onmouseenter="enter('-1064959765029423996');" onmouseout="out('-1064959765029423996');" style=""> 281     protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {                     </span>
<span class="1699675085073278700" onmouseenter="enter('1699675085073278700');" onmouseout="out('1699675085073278700');" style=""> 282         List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);    </span>
<span class="5611761187435301880" onmouseenter="enter('5611761187435301880');" onmouseout="out('5611761187435301880');" style=""> 283         return offerCustomers;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 284     }                                                                                                    </span>
<span  style=""> 285                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 286     /**                                                                                                  </span>
<span class="-8831229104457932482" onmouseenter="enter('-8831229104457932482');" onmouseout="out('-8831229104457932482');" style=""> 287      * Private method used to retrieve all offers with automaticallyAdded set to true                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 288      *                                                                                                   </span>
<span class="-2057313490179191281" onmouseenter="enter('-2057313490179191281');" onmouseout="out('-2057313490179191281');" style=""> 289      * @return a List of automatic delivery offers                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 290      */                                                                                                  </span>
<span class="-9186908469762752320" onmouseenter="enter('-9186908469762752320');" onmouseout="out('-9186908469762752320');" style=""> 291     protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {                                              </span>
<span class="-2657712449795339218" onmouseenter="enter('-2657712449795339218');" onmouseout="out('-2657712449795339218');" style=""> 292         List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();                         </span>
<span class="-7738403477037597046" onmouseenter="enter('-7738403477037597046');" onmouseout="out('-7738403477037597046');" style=""> 293         return globalOffers;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 294     }                                                                                                    </span>
<span  style=""> 295                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 296     /**                                                                                                  </span>
<span class="-582485916100204765" onmouseenter="enter('-582485916100204765');" onmouseout="out('-582485916100204765');" style=""> 297      * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end           </span>
<span class="-591413864231465226" onmouseenter="enter('-591413864231465226');" onmouseout="out('-591413864231465226');" style=""> 298      * date.  If an offerCode has a later start date, that offerCode will be removed.                    </span>
<span class="-1600892852414517397" onmouseenter="enter('-1600892852414517397');" onmouseout="out('-1600892852414517397');" style=""> 299      * OfferCodes without a start date will still be processed. If the offerCode                         </span>
<span class="-6972954356288154926" onmouseenter="enter('-6972954356288154926');" onmouseout="out('-6972954356288154926');" style=""> 300      * has a end date that has already passed, that offerCode will be removed.  OfferCodes               </span>
<span class="-7007360996659097530" onmouseenter="enter('-7007360996659097530');" onmouseout="out('-7007360996659097530');" style=""> 301      * without a end date will be processed.  The start and end dates on the offer will                  </span>
<span class="-216139196908541615" onmouseenter="enter('-216139196908541615');" onmouseout="out('-216139196908541615');" style=""> 302      * still need to be evaluated.                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 303      *                                                                                                   </span>
<span class="-142155654396048960" onmouseenter="enter('-142155654396048960');" onmouseout="out('-142155654396048960');" style=""> 304      * @param offerCodes                                                                                 </span>
<span class="-7645314644020819692" onmouseenter="enter('-7645314644020819692');" onmouseout="out('-7645314644020819692');" style=""> 305      * @return a List of non-expired offers                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 306      */                                                                                                  </span>
<span class="3097073257270455619" onmouseenter="enter('3097073257270455619');" onmouseout="out('3097073257270455619');" style=""> 307     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){                     </span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 308         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                 </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 309         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4179739580098873664" onmouseenter="enter('4179739580098873664');" onmouseout="out('4179739580098873664');" style=""> 310             if (!offerCode.isActive()){                                                                  </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 311                 offerCodesToRemove.add(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 312             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 313         }                                                                                                </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 314         // remove all offers in the offersToRemove list from original offers list                        </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 315         for (OfferCode offerCode : offerCodesToRemove) {                                                 </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 316             offerCodes.remove(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 317         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 318         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 319     }                                                                                                    </span>
<span  style=""> 320                                                                                                          </span>
<span class="4108048093343952474" onmouseenter="enter('4108048093343952474');" onmouseout="out('4108048093343952474');" style=""><abbr title=" 321     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; offers){"> 321     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; ðŸ”µ</abbr></span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 322         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                 </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 323         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4179739580098873664" onmouseenter="enter('4179739580098873664');" onmouseout="out('4179739580098873664');" style=""> 324             if (!offerCode.isActive()){                                                                  </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 325                 offerCodesToRemove.add(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 326             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 327         }                                                                                                </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 328         // remove all offers in the offersToRemove list from original offers list                        </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 329         for (OfferCode offerCode : offerCodesToRemove) {                                                 </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 330             offerCodes.remove(offerCode);                                                                </span>
<span class="-6904171993325612449" onmouseenter="enter('-6904171993325612449');" onmouseout="out('-6904171993325612449');" style=""> 331             offers.remove(offerCode.getOffer());                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 332         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 333         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 334     }                                                                                                    </span>
<span  style=""> 335                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 336     /**                                                                                                  </span>
<span class="5637961435104982406" onmouseenter="enter('5637961435104982406');" onmouseout="out('5637961435104982406');" style=""> 337      * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with       </span>
<span class="1724276086246688719" onmouseenter="enter('1724276086246688719');" onmouseout="out('1724276086246688719');" style=""> 338      * current sandbox status.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 339      *                                                                                                   </span>
<span class="202872854140107873" onmouseenter="enter('202872854140107873');" onmouseout="out('202872854140107873');" style=""> 340      * @param order the order to check                                                                   </span>
<span class="2772482249434351691" onmouseenter="enter('2772482249434351691');" onmouseout="out('2772482249434351691');" style=""> 341      * @return the refreshed list of OfferCodes                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 342      */                                                                                                  </span>
<span class="7210051143895905366" onmouseenter="enter('7210051143895905366');" onmouseout="out('7210051143895905366');" style=""> 343     protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {                         </span>
<span class="7464496307728629396" onmouseenter="enter('7464496307728629396');" onmouseout="out('7464496307728629396');" style=""> 344         final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();                              </span>
<span  style=""> 345                                                                                                          </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 346         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 347             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 348             public void execute() {                                                                      </span>
<span class="-6058145000184664425" onmouseenter="enter('-6058145000184664425');" onmouseout="out('-6058145000184664425');" style=""> 349                 for (OfferCode offerCode : orderOfferCodes) {                                            </span>
<span class="-4263515828536000223" onmouseenter="enter('-4263515828536000223');" onmouseout="out('-4263515828536000223');" style=""> 350                     if (offerCode.getOffer() != null) {                                                  </span>
<span class="8507823172595815939" onmouseenter="enter('8507823172595815939');" onmouseout="out('8507823172595815939');" style=""><abbr title=" 351                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 351                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCðŸ”µ</abbr></span>
<span class="-4217337457935304447" onmouseenter="enter('-4217337457935304447');" onmouseout="out('-4217337457935304447');" style=""><abbr title=" 352                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 352                         if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOfðŸ”µ</abbr></span>
<span class="-6104864632261418874" onmouseenter="enter('-6104864632261418874');" onmouseout="out('-6104864632261418874');" style=""> 353                             em.refresh(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 354                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 355                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 356                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 357             }                                                                                            </span>
<span  style=""> 358                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 359             @Override                                                                                    </span>
<span class="1336357167460974281" onmouseenter="enter('1336357167460974281');" onmouseout="out('1336357167460974281');" style=""> 360             public boolean shouldRetryOnTransactionLockAcquisitionFailure() {                            </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 361                 return true;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 362             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 363         }, RuntimeException.class);                                                                      </span>
<span  style=""> 364                                                                                                          </span>
<span class="720292142172901868" onmouseenter="enter('720292142172901868');" onmouseout="out('720292142172901868');" style=""> 365         return orderOfferCodes;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 366     }                                                                                                    </span>
<span  style=""> 367                                                                                                          </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 368     /*                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 369      *                                                                                                   </span>
<span class="-1078885518483632555" onmouseenter="enter('-1078885518483632555');" onmouseout="out('-1078885518483632555');" style=""> 370      * Offers Logic:                                                                                     </span>
<span class="-6544489594486398439" onmouseenter="enter('-6544489594486398439');" onmouseout="out('-6544489594486398439');" style=""> 371      * 1) Remove all existing offers in the Order (order, item, and fulfillment)                         </span>
<span class="472654013095872963" onmouseenter="enter('472654013095872963');" onmouseout="out('472654013095872963');" style=""> 372      * 2) Check and remove offers                                                                        </span>
<span class="8111384560802328496" onmouseenter="enter('8111384560802328496');" onmouseout="out('8111384560802328496');" style=""> 373      *    a) Remove out of date offers                                                                   </span>
<span class="3025649188866691570" onmouseenter="enter('3025649188866691570');" onmouseout="out('3025649188866691570');" style=""> 374      *    b) Remove offers that do not apply to this customer                                            </span>
<span class="5156402814943015913" onmouseenter="enter('5156402814943015913');" onmouseout="out('5156402814943015913');" style=""> 375      * 3) Loop through offers                                                                            </span>
<span class="6235203245796610706" onmouseenter="enter('6235203245796610706');" onmouseout="out('6235203245796610706');" style=""> 376      *    a) Verifies type of offer (order, order item, fulfillment)                                     </span>
<span class="7315686159335672158" onmouseenter="enter('7315686159335672158');" onmouseout="out('7315686159335672158');" style=""> 377      *    b) Verifies if offer can be applies                                                            </span>
<span class="-6634234506054969031" onmouseenter="enter('-6634234506054969031');" onmouseout="out('-6634234506054969031');" style=""> 378      *    c) Assign offer to type (order, order item, or fulfillment)                                    </span>
<span class="-4584093434328536587" onmouseenter="enter('-4584093434328536587');" onmouseout="out('-4584093434328536587');" style=""> 379      * 4) Sorts the order and item offers list by priority and then discount                             </span>
<span class="-2042995489836168848" onmouseenter="enter('-2042995489836168848');" onmouseout="out('-2042995489836168848');" style=""> 380      * 5) Identify the best offers to apply to order item and create adjustments for each item offer     </span>
<span class="8597383329030492662" onmouseenter="enter('8597383329030492662');" onmouseout="out('8597383329030492662');" style=""><abbr title=" 381      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better"> 381      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is betðŸ”µ</abbr></span>
<span class="-5003028621529242985" onmouseenter="enter('-5003028621529242985');" onmouseout="out('-5003028621529242985');" style=""> 382      * 7) Identify the best offers to apply to the order and create adjustments for each order offer     </span>
<span class="-1324083657955785943" onmouseenter="enter('-1324083657955785943');" onmouseout="out('-1324083657955785943');" style=""><abbr title=" 383      * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 383      * 8) If item contains non-combinable offers remove either the item or order adjustments based on disðŸ”µ</abbr></span>
<span class="-8610949319074908232" onmouseenter="enter('-8610949319074908232');" onmouseout="out('-8610949319074908232');" style=""> 384      * 9) Set final order item prices and reapply order offers                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 385      *                                                                                                   </span>
<span class="9071544830737596533" onmouseenter="enter('9071544830737596533');" onmouseout="out('9071544830737596533');" style=""> 386      * Assumptions:                                                                                      </span>
<span class="7676524731541901514" onmouseenter="enter('7676524731541901514');" onmouseout="out('7676524731541901514');" style=""> 387      * 1) % off all items will be created as an item offer with no expression                            </span>
<span class="-814522364757940962" onmouseenter="enter('-814522364757940962');" onmouseout="out('-814522364757940962');" style=""> 388      * 2) $ off order will be created as an order offer                                                  </span>
<span class="7365449813142531261" onmouseenter="enter('7365449813142531261');" onmouseout="out('7365449813142531261');" style=""> 389      * 3) Order offers applies to the best price for each item (not just retail price)                   </span>
<span class="-1636653647835076359" onmouseenter="enter('-1636653647835076359');" onmouseout="out('-1636653647835076359');" style=""> 390      * 4) Fulfillment offers apply to best price for each item (not just retail price)                   </span>
<span class="-5866280996345915157" onmouseenter="enter('-5866280996345915157');" onmouseout="out('-5866280996345915157');" style=""><abbr title=" 391      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 391      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used witðŸ”µ</abbr></span>
<span class="-8022045642448063338" onmouseenter="enter('-8022045642448063338');" onmouseout="out('-8022045642448063338');" style=""> 392      * 6) Fulfillment offers cannot be not combinable                                                    </span>
<span class="-5108644804585013203" onmouseenter="enter('-5108644804585013203');" onmouseout="out('-5108644804585013203');" style=""> 393      * 7) Order offers cannot be FIXED_PRICE                                                             </span>
<span class="6161153439596163093" onmouseenter="enter('6161153439596163093');" onmouseout="out('6161153439596163093');" style=""> 394      * 8) FIXED_PRICE offers cannot be stackable                                                         </span>
<span class="7044504232316014062" onmouseenter="enter('7044504232316014062');" onmouseout="out('7044504232316014062');" style=""><abbr title=" 395      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 395      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will alðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 396      *                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 397      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 398     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 399     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-4704847871427432866" onmouseenter="enter('-4704847871427432866');" onmouseout="out('-4704847871427432866');" style=""> 400     public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {    </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 401         /*                                                                                               </span>
<span class="-6180845550366984877" onmouseenter="enter('-6180845550366984877');" onmouseout="out('-6180845550366984877');" style=""> 402         TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to </span>
<span class="9161254164549280190" onmouseenter="enter('9161254164549280190');" onmouseout="out('9161254164549280190');" style=""> 403         use a richer object to describe the parameters of the pricing call. This object would include    </span>
<span class="1561516658361300705" onmouseenter="enter('1561516658361300705');" onmouseout="out('1561516658361300705');" style=""> 404         the pricing boolean, but would also include a list of activities to include or exclude in the    </span>
<span class="-6797832594843538707" onmouseenter="enter('-6797832594843538707');" onmouseout="out('-6797832594843538707');" style=""> 405         call - see http://jira.broadleafcommerce.org/browse/BLC-664                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 406          */                                                                                              </span>
<span class="2182795146752320946" onmouseenter="enter('2182795146752320946');" onmouseout="out('2182795146752320946');" style=""><abbr title=" 407         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 407         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr></span>
<span class="-2779719222870458088" onmouseenter="enter('-2779719222870458088');" onmouseout="out('-2779719222870458088');" style=""> 408         int offerCount = 0;                                                                              </span>
<span class="-845359809890439940" onmouseenter="enter('-845359809890439940');" onmouseout="out('-845359809890439940');" style=""> 409         if(o!=null &amp;&amp; (Boolean)o){                                                                       </span>
<span class="-4703255484140988550" onmouseenter="enter('-4703255484140988550');" onmouseout="out('-4703255484140988550');" style=""> 410             if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())){ </span>
<span class="187767283697509415" onmouseenter="enter('187767283697509415');" onmouseout="out('187767283697509415');" style=""> 411                 for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {                    </span>
<span class="-169235058410924848" onmouseenter="enter('-169235058410924848');" onmouseout="out('-169235058410924848');" style=""> 412                     if(orderAdjustment.getOffer()!=null){                                                </span>
<span class="6329272383142541507" onmouseenter="enter('6329272383142541507');" onmouseout="out('6329272383142541507');" style=""> 413                         offerCount++;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 414                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 415                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 416             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417         }                                                                                                </span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 418         OfferContext offerContext = OfferContext.getOfferContext();                                      </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 419         if (offerContext == null || offerContext.executePromotionCalculation) {                          </span>
<span class="-2683885994659783076" onmouseenter="enter('-2683885994659783076');" onmouseout="out('-2683885994659783076');" style=""> 420             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false); </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 421             List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                      </span>
<span class="-2406747375061389964" onmouseenter="enter('-2406747375061389964');" onmouseout="out('-2406747375061389964');" style=""> 422             removeOutOfDateOfferCodesAndOffers(orderOfferCodes, offers);                                 </span>
<span class="-9066266687178937853" onmouseenter="enter('-9066266687178937853');" onmouseout="out('-9066266687178937853');" style=""> 423             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());  </span>
<span class="-1421782411503697087" onmouseenter="enter('-1421782411503697087');" onmouseout="out('-1421782411503697087');" style=""> 424             if ((filteredOffers == null) || (filteredOffers.isEmpty())) {                                </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 425                 if (LOG.isTraceEnabled()) {                                                              </span>
<span class="2760579588161124045" onmouseenter="enter('2760579588161124045');" onmouseout="out('2760579588161124045');" style=""> 426                     LOG.trace(&quot;No offers applicable to this order.&quot;);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 427                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 428             } else {                                                                                     </span>
<span class="7300520529047311728" onmouseenter="enter('7300520529047311728');" onmouseout="out('7300520529047311728');" style=""><abbr title=" 429                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 429                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidðŸ”µ</abbr></span>
<span class="-7404348590242143631" onmouseenter="enter('-7404348590242143631');" onmouseout="out('-7404348590242143631');" style=""><abbr title=" 430                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 430                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr></span>
<span  style=""> 431                                                                                                          </span>
<span class="-5526882442984993330" onmouseenter="enter('-5526882442984993330');" onmouseout="out('-5526882442984993330');" style=""><abbr title=" 432                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 432                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, quðŸ”µ</abbr></span>
<span  style=""> 433                                                                                                          </span>
<span class="-6480919216777131248" onmouseenter="enter('-6480919216777131248');" onmouseout="out('-6480919216777131248');" style=""> 434                 if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {               </span>
<span class="-2723881742436166059" onmouseenter="enter('-2723881742436166059');" onmouseout="out('-2723881742436166059');" style=""><abbr title=" 435                     // At this point, we should have a PromotableOrder that contains PromotableItems each of which"> 435                     // At this point, we should have a PromotableOrder that contains PromotableItems eachðŸ”µ</abbr></span>
<span class="751015906320167144" onmouseenter="enter('751015906320167144');" onmouseout="out('751015906320167144');" style=""> 436                     // has a list of candidatePromotions that might be applied.                          </span>
<span  style=""> 437                                                                                                          </span>
<span class="5941864862011378901" onmouseenter="enter('5941864862011378901');" onmouseout="out('5941864862011378901');" style=""><abbr title=" 438                     // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 438                     // We also have a list of orderOffers that might apply and a list of itemOffers that ðŸ”µ</abbr></span>
<span class="1127078869550353626" onmouseenter="enter('1127078869550353626');" onmouseout="out('1127078869550353626');" style=""><abbr title=" 439                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 439                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 440                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 441             }                                                                                            </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 442             orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                        </span>
<span  style=""> 443                                                                                                          </span>
<span class="514986819999277890" onmouseenter="enter('514986819999277890');" onmouseout="out('514986819999277890');" style=""> 444             verifyAdjustments(order, true);                                                              </span>
<span  style=""> 445                                                                                                          </span>
<span class="-8901364638816691349" onmouseenter="enter('-8901364638816691349');" onmouseout="out('-8901364638816691349');" style=""> 446             order.setSubTotal(order.calculateSubTotal());                                                </span>
<span class="8881079200386597596" onmouseenter="enter('8881079200386597596');" onmouseout="out('8881079200386597596');" style=""> 447             order.finalizeItemPrices();                                                                  </span>
<span  style=""> 448                                                                                                          </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 449             order = orderService.save(order, false);                                                     </span>
<span  style=""> 450                                                                                                          </span>
<span class="-5335273514929397197" onmouseenter="enter('-5335273514929397197');" onmouseout="out('-5335273514929397197');" style=""> 451             boolean madeChange = verifyAdjustments(order, false);                                        </span>
<span class="-3218959195648057803" onmouseenter="enter('-3218959195648057803');" onmouseout="out('-3218959195648057803');" style=""> 452             if (madeChange) {                                                                            </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 453                 order = orderService.save(order, false);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 454             }                                                                                            </span>
<span class="-8586437722090950510" onmouseenter="enter('-8586437722090950510');" onmouseout="out('-8586437722090950510');" style=""> 455             int offerCountAfter=0;                                                                       </span>
<span class="-845359809890439940" onmouseenter="enter('-845359809890439940');" onmouseout="out('-845359809890439940');" style=""> 456             if(o!=null &amp;&amp; (Boolean)o){                                                                   </span>
<span class="-4703255484140988550" onmouseenter="enter('-4703255484140988550');" onmouseout="out('-4703255484140988550');" style=""><abbr title=" 457                 if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())){"> 457                 if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments()ðŸ”µ</abbr></span>
<span class="187767283697509415" onmouseenter="enter('187767283697509415');" onmouseout="out('187767283697509415');" style=""> 458                     for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {                </span>
<span class="-169235058410924848" onmouseenter="enter('-169235058410924848');" onmouseout="out('-169235058410924848');" style=""> 459                         if(orderAdjustment.getOffer()!=null){                                            </span>
<span class="-8696114592748620649" onmouseenter="enter('-8696114592748620649');" onmouseout="out('-8696114592748620649');" style=""> 460                             offerCountAfter++;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 461                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 463                 }                                                                                        </span>
<span class="513357313329824873" onmouseenter="enter('513357313329824873');" onmouseout="out('513357313329824873');" style=""> 464                 if(offerCountAfter!=offerCount){                                                         </span>
<span class="-3668454086264686215" onmouseenter="enter('-3668454086264686215');" onmouseout="out('-3668454086264686215');" style=""><abbr title=" 465                     BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 465                     BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 466                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 467             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 468         }                                                                                                </span>
<span  style=""> 469                                                                                                          </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 470         return order;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 471     }                                                                                                    </span>
<span  style=""> 472                                                                                                          </span>
<span class="219209447823395758" onmouseenter="enter('219209447823395758');" onmouseout="out('219209447823395758');" style=""> 473     protected boolean verifyAdjustments(Order order, boolean beforeSave) {                               </span>
<span class="79408939766017075" onmouseenter="enter('79408939766017075');" onmouseout="out('79408939766017075');" style=""> 474         boolean madeChange = false;                                                                      </span>
<span  style=""> 475                                                                                                          </span>
<span class="-8966123689509035198" onmouseenter="enter('-8966123689509035198');" onmouseout="out('-8966123689509035198');" style=""> 476         if (order.getOrderItems() == null) {                                                             </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 477             return madeChange;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 478         }                                                                                                </span>
<span  style=""> 479                                                                                                          </span>
<span class="8447029191885982498" onmouseenter="enter('8447029191885982498');" onmouseout="out('8447029191885982498');" style=""> 480         for (OrderItem oi : order.getOrderItems()) {                                                     </span>
<span class="-5982197742320851056" onmouseenter="enter('-5982197742320851056');" onmouseout="out('-5982197742320851056');" style=""> 481             if (oi.getOrderItemPriceDetails() == null) {                                                 </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 482                 continue;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 483             }                                                                                            </span>
<span  style=""> 484                                                                                                          </span>
<span class="7391296704731194189" onmouseenter="enter('7391296704731194189');" onmouseout="out('7391296704731194189');" style=""> 485             for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {                              </span>
<span class="-8259157388002947293" onmouseenter="enter('-8259157388002947293');" onmouseout="out('-8259157388002947293');" style=""> 486                 if (pd.getOrderItemPriceDetailAdjustments() == null) {                                   </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 487                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 488                 }                                                                                        </span>
<span  style=""> 489                                                                                                          </span>
<span class="-8160497408394725913" onmouseenter="enter('-8160497408394725913');" onmouseout="out('-8160497408394725913');" style=""><abbr title=" 490                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 490                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdðŸ”µ</abbr></span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 491                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 491                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDeðŸ”µ</abbr></span>
<span class="-3008507732031274392" onmouseenter="enter('-3008507732031274392');" onmouseout="out('-3008507732031274392');" style=""> 492                 for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {     </span>
<span class="-1975641521768786423" onmouseenter="enter('-1975641521768786423');" onmouseout="out('-1975641521768786423');" style=""> 493                     if (adjs.containsKey(adj.getOffer().getId())) {                                      </span>
<span class="-6913168070672082713" onmouseenter="enter('-6913168070672082713');" onmouseout="out('-6913168070672082713');" style=""> 494                         adjustmentsToRemove.add(adj);                                                    </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 495                         if (LOG.isDebugEnabled()) {                                                      </span>
<span class="-2834336870885753779" onmouseenter="enter('-2834336870885753779');" onmouseout="out('-2834336870885753779');" style=""> 496                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)                 </span>
<span class="201513945492742471" onmouseenter="enter('201513945492742471');" onmouseout="out('201513945492742471');" style=""> 497                                 .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)                   </span>
<span class="2195430440089355634" onmouseenter="enter('2195430440089355634');" onmouseout="out('2195430440089355634');" style=""> 498                                 .append(&quot; with ids &quot;)                                                    </span>
<span class="-3149719647859419210" onmouseenter="enter('-3149719647859419210');" onmouseout="out('-3149719647859419210');" style=""> 499                                 .append(adjs.get(adj.getOffer().getId()).getId())                        </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 500                                 .append(&quot; and &quot;)                                                         </span>
<span class="6832270653349147085" onmouseenter="enter('6832270653349147085');" onmouseout="out('6832270653349147085');" style=""> 501                                 .append(adj.getId());                                                    </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 502                             LOG.debug(sb.toString());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 503                         }                                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 504                     } else {                                                                             </span>
<span class="-7759509127049565554" onmouseenter="enter('-7759509127049565554');" onmouseout="out('-7759509127049565554');" style=""> 505                         adjs.put(adj.getOffer().getId(), adj);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 506                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 507                 }                                                                                        </span>
<span  style=""> 508                                                                                                          </span>
<span class="7848730128284985932" onmouseenter="enter('7848730128284985932');" onmouseout="out('7848730128284985932');" style=""> 509                 for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {                         </span>
<span class="6756116260498887863" onmouseenter="enter('6756116260498887863');" onmouseout="out('6756116260498887863');" style=""> 510                     pd.getOrderItemPriceDetailAdjustments().remove(adj);                                 </span>
<span class="5571803755205047298" onmouseenter="enter('5571803755205047298');" onmouseout="out('5571803755205047298');" style=""> 511                     madeChange = true;                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 512                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 513             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 514         }                                                                                                </span>
<span  style=""> 515                                                                                                          </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 516         return madeChange;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 517      }                                                                                                   </span>
<span  style=""> 518                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 519     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 520     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 521     @Deprecated                                                                                          </span>
<span class="-3021599232242429775" onmouseenter="enter('-3021599232242429775');" onmouseout="out('-3021599232242429775');" style=""> 522     public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {            </span>
<span class="-6341015309393843959" onmouseenter="enter('-6341015309393843959');" onmouseout="out('-6341015309393843959');" style=""> 523         applyAndSaveOffersToOrder(offers, order);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 524     }                                                                                                    </span>
<span  style=""> 525                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 526     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 527     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 528     @Deprecated                                                                                          </span>
<span class="-5535279977913938928" onmouseenter="enter('-5535279977913938928');" onmouseout="out('-5535279977913938928');" style=""><abbr title=" 529     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 529     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptiðŸ”µ</abbr></span>
<span class="6394386461467124428" onmouseenter="enter('6394386461467124428');" onmouseout="out('6394386461467124428');" style=""> 530         applyAndSaveFulfillmentGroupOffersToOrder(offers, order);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 531     }                                                                                                    </span>
<span  style=""> 532                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 533     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 534     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="2855881782634007850" onmouseenter="enter('2855881782634007850');" onmouseout="out('2855881782634007850');" style=""><abbr title=" 535     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 535     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricinðŸ”µ</abbr></span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 536         OfferContext offerContext = OfferContext.getOfferContext();                                      </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 537         if (offerContext == null || offerContext.executePromotionCalculation) {                          </span>
<span class="-791836473256513905" onmouseenter="enter('-791836473256513905');" onmouseout="out('-791836473256513905');" style=""> 538             PromotableOrder promotableOrder =                                                            </span>
<span class="-5771222684966163235" onmouseenter="enter('-5771222684966163235');" onmouseout="out('-5771222684966163235');" style=""> 539                     promotableItemFactory.createPromotableOrder(order, true);                            </span>
<span class="-6252467951249219732" onmouseenter="enter('-6252467951249219732');" onmouseout="out('-6252467951249219732');" style=""> 540             List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();                                       </span>
<span class="-8689854403875612694" onmouseenter="enter('-8689854403875612694');" onmouseout="out('-8689854403875612694');" style=""> 541             for (Offer offer : offers) {                                                                 </span>
<span class="3344482016035270743" onmouseenter="enter('3344482016035270743');" onmouseout="out('3344482016035270743');" style=""> 542                 if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {           </span>
<span class="2965579239059640859" onmouseenter="enter('2965579239059640859');" onmouseout="out('2965579239059640859');" style=""> 543                     possibleFGOffers.add(offer);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 544                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 545             }                                                                                            </span>
<span class="7272445213685933500" onmouseenter="enter('7272445213685933500');" onmouseout="out('7272445213685933500');" style=""><abbr title=" 546             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());"> 546             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustðŸ”µ</abbr></span>
<span class="-380250791493510209" onmouseenter="enter('-380250791493510209');" onmouseout="out('-380250791493510209');" style=""><abbr title=" 547             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 547             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCaðŸ”µ</abbr></span>
<span class="5471512156259214352" onmouseenter="enter('5471512156259214352');" onmouseout="out('5471512156259214352');" style=""> 548             for (Offer offer : filteredOffers) {                                                         </span>
<span class="6341701119621727258" onmouseenter="enter('6341701119621727258');" onmouseout="out('6341701119621727258');" style=""><abbr title=" 549                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 549                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifieðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 550             }                                                                                            </span>
<span class="6757974448768463" onmouseenter="enter('6757974448768463');" onmouseout="out('6757974448768463');" style=""> 551             if (!qualifiedFGOffers.isEmpty()) {                                                          </span>
<span class="-3737539762239464744" onmouseenter="enter('-3737539762239464744');" onmouseout="out('-3737539762239464744');" style=""><abbr title=" 552                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);"> 552                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotabðŸ”µ</abbr></span>
<span class="-1748187190347404908" onmouseenter="enter('-1748187190347404908');" onmouseout="out('-1748187190347404908');" style=""> 553                 fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);          </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 554                 orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 555             }                                                                                            </span>
<span  style=""> 556                                                                                                          </span>
<span class="-7204486914274790826" onmouseenter="enter('-7204486914274790826');" onmouseout="out('-7204486914274790826');" style=""> 557             return orderService.save(order, false);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 558         }                                                                                                </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 559         return order;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 560     }                                                                                                    </span>
<span  style=""> 561                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 562     @Override                                                                                            </span>
<span class="-8983195686564092827" onmouseenter="enter('-8983195686564092827');" onmouseout="out('-8983195686564092827');" style=""> 563     public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {                           </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 564         Customer customer = order.getCustomer();                                                         </span>
<span  style=""> 565                                                                                                          </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 566         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="-8305970541390666259" onmouseenter="enter('-8305970541390666259');" onmouseout="out('-8305970541390666259');" style=""><abbr title=" 567             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 567             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr></span>
<span  style=""> 568                                                                                                          </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 569             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 570                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 571             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 572         }                                                                                                </span>
<span  style=""> 573                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 574         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 575     }                                                                                                    </span>
<span  style=""> 576                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 577     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 578     @Override                                                                                            </span>
<span class="4849754295577860926" onmouseenter="enter('4849754295577860926');" onmouseout="out('4849754295577860926');" style=""> 579     public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {                     </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 580         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="8084739095609490454" onmouseenter="enter('8084739095609490454');" onmouseout="out('8084739095609490454');" style=""> 581             Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());   </span>
<span  style=""> 582                                                                                                          </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 583             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 584                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 585             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 586         }                                                                                                </span>
<span  style=""> 587                                                                                                          </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 588         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 589     }                                                                                                    </span>
<span  style=""> 590                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 591     @Override                                                                                            </span>
<span class="-4305912419408886648" onmouseenter="enter('-4305912419408886648');" onmouseout="out('-4305912419408886648');" style=""> 592     public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {                        </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 593         boolean underCodeMaxUses = true;                                                                 </span>
<span  style=""> 594                                                                                                          </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 595         if (code.isLimitedUse()) {                                                                       </span>
<span class="-7378740545085856894" onmouseenter="enter('-7378740545085856894');" onmouseout="out('-7378740545085856894');" style=""> 596             Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());            </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 597             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 598         }                                                                                                </span>
<span  style=""> 599                                                                                                          </span>
<span class="5446263071698048925" onmouseenter="enter('5446263071698048925');" onmouseout="out('5446263071698048925');" style=""> 600         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 601     }                                                                                                    </span>
<span  style=""> 602                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 603     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 604     @Override                                                                                            </span>
<span class="135967723667379112" onmouseenter="enter('135967723667379112');" onmouseout="out('135967723667379112');" style=""> 605     public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {                  </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 606         boolean underCodeMaxUses = true;                                                                 </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 607         if (code.isLimitedUse()) {                                                                       </span>
<span class="5487567461678823803" onmouseenter="enter('5487567461678823803');" onmouseout="out('5487567461678823803');" style=""> 608             Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());                   </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 609             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 610         }                                                                                                </span>
<span class="7193079189056024188" onmouseenter="enter('7193079189056024188');" onmouseout="out('7193079189056024188');" style=""> 611         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 612     }                                                                                                    </span>
<span  style=""> 613                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 614     @Override                                                                                            </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 615     @SuppressWarnings(&quot;unchecked&quot;)                                                                       </span>
<span class="-640784293225096821" onmouseenter="enter('-640784293225096821');" onmouseout="out('-640784293225096821');" style=""> 616     public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {                                            </span>
<span class="-348027159212233091" onmouseenter="enter('-348027159212233091');" onmouseout="out('-348027159212233091');" style=""> 617         HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();                                                    </span>
<span  style=""> 618                                                                                                          </span>
<span class="-7949809618309864364" onmouseenter="enter('-7949809618309864364');" onmouseout="out('-7949809618309864364');" style=""> 619         Transformer adjustmentToOfferTransformer = new Transformer() {                                   </span>
<span  style=""> 620                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 621             @Override                                                                                    </span>
<span class="-2718541205900117239" onmouseenter="enter('-2718541205900117239');" onmouseout="out('-2718541205900117239');" style=""> 622             public Object transform(Object input) {                                                      </span>
<span class="4176981446584954696" onmouseenter="enter('4176981446584954696');" onmouseout="out('4176981446584954696');" style=""> 623                 return ((Adjustment)input).getOffer();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 624             }                                                                                            </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 625         };                                                                                               </span>
<span  style=""> 626                                                                                                          </span>
<span class="-8370514600917699300" onmouseenter="enter('-8370514600917699300');" onmouseout="out('-8370514600917699300');" style=""><abbr title=" 627         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));"> 627         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer))ðŸ”µ</abbr></span>
<span  style=""> 628                                                                                                          </span>
<span class="3897119298100986011" onmouseenter="enter('3897119298100986011');" onmouseout="out('3897119298100986011');" style=""> 629         if (order.getOrderItems() != null) {                                                             </span>
<span class="820796442257070700" onmouseenter="enter('820796442257070700');" onmouseout="out('820796442257070700');" style=""> 630             for (OrderItem item : order.getOrderItems()) {                                               </span>
<span class="722957474719034118" onmouseenter="enter('722957474719034118');" onmouseout="out('722957474719034118');" style=""><abbr title=" 631                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 631                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTrðŸ”µ</abbr></span>
<span  style=""> 632                                                                                                          </span>
<span class="-3519908190158496681" onmouseenter="enter('-3519908190158496681');" onmouseout="out('-3519908190158496681');" style=""> 633                 //record usage for price details on the item as well                                     </span>
<span class="-2952948196187271811" onmouseenter="enter('-2952948196187271811');" onmouseout="out('-2952948196187271811');" style=""> 634                 if (item.getOrderItemPriceDetails() != null) {                                           </span>
<span class="773323050474809935" onmouseenter="enter('773323050474809935');" onmouseout="out('773323050474809935');" style=""> 635                     for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {                </span>
<span class="7134713472391876911" onmouseenter="enter('7134713472391876911');" onmouseout="out('7134713472391876911');" style=""><abbr title=" 636                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 636                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments()ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 637                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 638                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 639             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 640         }                                                                                                </span>
<span  style=""> 641                                                                                                          </span>
<span class="7944520279780748823" onmouseenter="enter('7944520279780748823');" onmouseout="out('7944520279780748823');" style=""> 642         if (order.getFulfillmentGroups() != null) {                                                      </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 643             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                   </span>
<span class="-293187079687761920" onmouseenter="enter('-293187079687761920');" onmouseout="out('-293187079687761920');" style=""><abbr title=" 644                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 644                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 645             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 646         }                                                                                                </span>
<span class="-6419540350677864751" onmouseenter="enter('-6419540350677864751');" onmouseout="out('-6419540350677864751');" style=""> 647         return result;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 648     }                                                                                                    </span>
<span  style=""> 649                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 650     @Override                                                                                            </span>
<span class="-2491837224879773303" onmouseenter="enter('-2491837224879773303');" onmouseout="out('-2491837224879773303');" style=""> 651     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {                             </span>
<span class="-1370687283458217641" onmouseenter="enter('-1370687283458217641');" onmouseout="out('-1370687283458217641');" style=""> 652         return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order)); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 653     }                                                                                                    </span>
<span  style=""> 654                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 655     @Override                                                                                            </span>
<span class="-6407317956511861474" onmouseenter="enter('-6407317956511861474');" onmouseout="out('-6407317956511861474');" style=""><abbr title=" 656     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {"> 656     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffðŸ”µ</abbr></span>
<span class="-4490485247927949218" onmouseenter="enter('-4490485247927949218');" onmouseout="out('-4490485247927949218');" style=""> 657         HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();                  </span>
<span class="983580358500385861" onmouseenter="enter('983580358500385861');" onmouseout="out('983580358500385861');" style=""> 658         for (OfferCode code : codes) {                                                                   </span>
<span class="6305098044991751707" onmouseenter="enter('6305098044991751707');" onmouseout="out('6305098044991751707');" style=""> 659             if (appliedOffers.contains(code.getOffer())) {                                               </span>
<span class="3746501443462939384" onmouseenter="enter('3746501443462939384');" onmouseout="out('3746501443462939384');" style=""> 660                 offerToCodeMapping.put(code.getOffer(), code);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 661             }                                                                                            </span>
<span  style=""> 662                                                                                                          </span>
<span class="-240986298797431748" onmouseenter="enter('-240986298797431748');" onmouseout="out('-240986298797431748');" style=""> 663             List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();                            </span>
<span  style=""> 664                                                                                                          </span>
<span class="7454577566794152811" onmouseenter="enter('7454577566794152811');" onmouseout="out('7454577566794152811');" style=""> 665             extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);   </span>
<span class="-7985615425314556326" onmouseenter="enter('-7985615425314556326');" onmouseout="out('-7985615425314556326');" style=""> 666             for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {                       </span>
<span class="-808811284028256215" onmouseenter="enter('-808811284028256215');" onmouseout="out('-808811284028256215');" style=""> 667                 offerToCodeMapping.put(additionalOfferToBeApplied, code);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 668             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 669         }                                                                                                </span>
<span class="7175253914401568841" onmouseenter="enter('7175253914401568841');" onmouseout="out('7175253914401568841');" style=""> 670         return offerToCodeMapping;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 671     }                                                                                                    </span>
<span  style=""> 672                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 673     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 674     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-1347767159915315738" onmouseenter="enter('-1347767159915315738');" onmouseout="out('-1347767159915315738');" style=""> 675     public Boolean deleteOfferCode(OfferCode code) {                                                     </span>
<span class="-5986603348121186173" onmouseenter="enter('-5986603348121186173');" onmouseout="out('-5986603348121186173');" style=""> 676         if (offerCodeDao.offerCodeIsUsed(code)) {                                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 677             return false;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 678         }                                                                                                </span>
<span  style=""> 679                                                                                                          </span>
<span class="-9122073777393685295" onmouseenter="enter('-9122073777393685295');" onmouseout="out('-9122073777393685295');" style=""> 680         offerCodeDao.delete(code);                                                                       </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 681         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 682     }                                                                                                    </span>
<span  style=""> 683                                                                                                          </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 684     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 685     @Override                                                                                            </span>
<span class="-3816301958562278169" onmouseenter="enter('-3816301958562278169');" onmouseout="out('-3816301958562278169');" style=""> 686     public Offer duplicate(Long originalOfferId) {                                                       </span>
<span class="-5738299300293223874" onmouseenter="enter('-5738299300293223874');" onmouseout="out('-5738299300293223874');" style=""> 687         Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();                                   </span>
<span class="2715783386963629594" onmouseenter="enter('2715783386963629594');" onmouseout="out('2715783386963629594');" style=""> 688         copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);                                    </span>
<span class="-2013584672995219797" onmouseenter="enter('-2013584672995219797');" onmouseout="out('-2013584672995219797');" style=""> 689         return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 690     }                                                                                                    </span>
<span  style=""> 691                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 692     @Override                                                                                            </span>
<span class="3228088005821970316" onmouseenter="enter('3228088005821970316');" onmouseout="out('3228088005821970316');" style=""> 693     public CustomerOfferDao getCustomerOfferDao() {                                                      </span>
<span class="-801333879424417122" onmouseenter="enter('-801333879424417122');" onmouseout="out('-801333879424417122');" style=""> 694         return customerOfferDao;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 695     }                                                                                                    </span>
<span  style=""> 696                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 697     @Override                                                                                            </span>
<span class="6308179313298689001" onmouseenter="enter('6308179313298689001');" onmouseout="out('6308179313298689001');" style=""> 698     public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {                                 </span>
<span class="438520929977701037" onmouseenter="enter('438520929977701037');" onmouseout="out('438520929977701037');" style=""> 699         this.customerOfferDao = customerOfferDao;                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 700     }                                                                                                    </span>
<span  style=""> 701                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 702     @Override                                                                                            </span>
<span class="8266606365944954497" onmouseenter="enter('8266606365944954497');" onmouseout="out('8266606365944954497');" style=""> 703     public OfferCodeDao getOfferCodeDao() {                                                              </span>
<span class="-4005874311041664572" onmouseenter="enter('-4005874311041664572');" onmouseout="out('-4005874311041664572');" style=""> 704         return offerCodeDao;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 705     }                                                                                                    </span>
<span  style=""> 706                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 707     @Override                                                                                            </span>
<span class="-5083072655758254890" onmouseenter="enter('-5083072655758254890');" onmouseout="out('-5083072655758254890');" style=""> 708     public void setOfferCodeDao(OfferCodeDao offerCodeDao) {                                             </span>
<span class="-7060255547979502806" onmouseenter="enter('-7060255547979502806');" onmouseout="out('-7060255547979502806');" style=""> 709         this.offerCodeDao = offerCodeDao;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 710     }                                                                                                    </span>
<span  style=""> 711                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 712     @Override                                                                                            </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 713     public OfferDao getOfferDao() {                                                                      </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 714         return offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 715     }                                                                                                    </span>
<span  style=""> 716                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 717     @Override                                                                                            </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 718     public void setOfferDao(OfferDao offerDao) {                                                         </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 719         this.offerDao = offerDao;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 720     }                                                                                                    </span>
<span  style=""> 721                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 722     @Override                                                                                            </span>
<span class="3012408951835963759" onmouseenter="enter('3012408951835963759');" onmouseout="out('3012408951835963759');" style=""> 723     public OrderOfferProcessor getOrderOfferProcessor() {                                                </span>
<span class="-5069105522766505260" onmouseenter="enter('-5069105522766505260');" onmouseout="out('-5069105522766505260');" style=""> 724         return orderOfferProcessor;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 725     }                                                                                                    </span>
<span  style=""> 726                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 727     @Override                                                                                            </span>
<span class="-2542583147665382651" onmouseenter="enter('-2542583147665382651');" onmouseout="out('-2542583147665382651');" style=""> 728     public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {                        </span>
<span class="1533378703496715943" onmouseenter="enter('1533378703496715943');" onmouseout="out('1533378703496715943');" style=""> 729         this.orderOfferProcessor = orderOfferProcessor;                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 730     }                                                                                                    </span>
<span  style=""> 731                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 732     @Override                                                                                            </span>
<span class="1694843298235251985" onmouseenter="enter('1694843298235251985');" onmouseout="out('1694843298235251985');" style=""> 733     public ItemOfferProcessor getItemOfferProcessor() {                                                  </span>
<span class="1583504692330339191" onmouseenter="enter('1583504692330339191');" onmouseout="out('1583504692330339191');" style=""> 734         return itemOfferProcessor;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 735     }                                                                                                    </span>
<span  style=""> 736                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 737     @Override                                                                                            </span>
<span class="145400756853488798" onmouseenter="enter('145400756853488798');" onmouseout="out('145400756853488798');" style=""> 738     public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {                           </span>
<span class="-102405468021411755" onmouseenter="enter('-102405468021411755');" onmouseout="out('-102405468021411755');" style=""> 739         this.itemOfferProcessor = itemOfferProcessor;                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 740     }                                                                                                    </span>
<span  style=""> 741                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 742     @Override                                                                                            </span>
<span class="3022939772369206873" onmouseenter="enter('3022939772369206873');" onmouseout="out('3022939772369206873');" style=""> 743     public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {                          </span>
<span class="-3088775944214719317" onmouseenter="enter('-3088775944214719317');" onmouseout="out('-3088775944214719317');" style=""> 744         return fulfillmentGroupOfferProcessor;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 745     }                                                                                                    </span>
<span  style=""> 746                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 747     @Override                                                                                            </span>
<span class="-8855456203149015957" onmouseenter="enter('-8855456203149015957');" onmouseout="out('-8855456203149015957');" style=""><abbr title=" 748     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {"> 748     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProðŸ”µ</abbr></span>
<span class="-7108053920330155376" onmouseenter="enter('-7108053920330155376');" onmouseout="out('-7108053920330155376');" style=""> 749         this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 750     }                                                                                                    </span>
<span  style=""> 751                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 752     @Override                                                                                            </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 753     public PromotableItemFactory getPromotableItemFactory() {                                            </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 754         return promotableItemFactory;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 755     }                                                                                                    </span>
<span  style=""> 756                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 757     @Override                                                                                            </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 758     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                  </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 759         this.promotableItemFactory = promotableItemFactory;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 760     }                                                                                                    </span>
<span  style=""> 761                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 762     @Override                                                                                            </span>
<span class="-285725005067991728" onmouseenter="enter('-285725005067991728');" onmouseout="out('-285725005067991728');" style=""> 763     public OfferCode findOfferCodeById(Long id) {                                                        </span>
<span class="4928857363700364693" onmouseenter="enter('4928857363700364693');" onmouseout="out('4928857363700364693');" style=""> 764         return offerCodeDao.readOfferCodeById(id);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 765     }                                                                                                    </span>
<span  style=""> 766                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 767     @Override                                                                                            </span>
<span class="-6829155498814719074" onmouseenter="enter('-6829155498814719074');" onmouseout="out('-6829155498814719074');" style=""> 768     public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {                                   </span>
<span class="-1521639274006709657" onmouseenter="enter('-1521639274006709657');" onmouseout="out('-1521639274006709657');" style=""> 769         return offerCodeDao.readOfferCodesByIds(ids);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 770     }                                                                                                    </span>
<span  style=""> 771                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 772     @Override                                                                                            </span>
<span class="5587340050529616033" onmouseenter="enter('5587340050529616033');" onmouseout="out('5587340050529616033');" style=""> 773     public OrderService getOrderService() {                                                              </span>
<span class="-7558473787756148723" onmouseenter="enter('-7558473787756148723');" onmouseout="out('-7558473787756148723');" style=""> 774         return orderService;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 775     }                                                                                                    </span>
<span  style=""> 776                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 777     @Override                                                                                            </span>
<span class="4536819371590947172" onmouseenter="enter('4536819371590947172');" onmouseout="out('4536819371590947172');" style=""> 778     public void setOrderService(OrderService orderService) {                                             </span>
<span class="7368861914925934250" onmouseenter="enter('7368861914925934250');" onmouseout="out('7368861914925934250');" style=""> 779         this.orderService = orderService;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 780     }                                                                                                    </span>
<span  style=""> 781                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 782     @Override                                                                                            </span>
<span class="-2217088353489190987" onmouseenter="enter('-2217088353489190987');" onmouseout="out('-2217088353489190987');" style=""> 783     public Offer findOfferById(Long offerId) {                                                           </span>
<span class="-5171648678549667040" onmouseenter="enter('-5171648678549667040');" onmouseout="out('-5171648678549667040');" style=""> 784         return offerDao.readOfferById(offerId);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 785     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 786 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3  * BroadleafCommerce Framework                                                                           </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18 package org.broadleafcommerce.core.offer.service;                                                        </span>
<span  style="">  19                                                                                                          </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  20 import java.util.ArrayList;                                                                              </span>
<span class="-112105277767313938" onmouseenter="enter('-112105277767313938');" onmouseout="out('-112105277767313938');" style="">  21 import java.util.Collection;                                                                             </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  22 import java.util.HashMap;                                                                                </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  23 import java.util.HashSet;                                                                                </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  24 import java.util.Iterator;                                                                               </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  25 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  26 import java.util.Map;                                                                                    </span>
<span class="6306724220981822255" onmouseenter="enter('6306724220981822255');" onmouseout="out('6306724220981822255');" style="">  27 import java.util.Objects;                                                                                </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  28 import java.util.Set;                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  29 import javax.annotation.Resource;                                                                        </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  30 import javax.persistence.EntityManager;                                                                  </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  31 import javax.persistence.PersistenceContext;                                                             </span>
<span class="8596464405353709537" onmouseenter="enter('8596464405353709537');" onmouseout="out('8596464405353709537');" style="">  32 import org.apache.commons.collections.CollectionUtils;                                                   </span>
<span class="2953846583056246827" onmouseenter="enter('2953846583056246827');" onmouseout="out('2953846583056246827');" style="">  33 import org.apache.commons.collections.Transformer;                                                       </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  34 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  35 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="-2193028153657877676" onmouseenter="enter('-2193028153657877676');" onmouseout="out('-2193028153657877676');" style="">  36 import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;                                 </span>
<span class="-3349026188166660873" onmouseenter="enter('-3349026188166660873');" onmouseout="out('-3349026188166660873');" style="">  37 import org.broadleafcommerce.common.persistence.EntityDuplicator;                                        </span>
<span class="-2818686525334833130" onmouseenter="enter('-2818686525334833130');" onmouseout="out('-2818686525334833130');" style="">  38 import org.broadleafcommerce.common.sandbox.SandBoxHelper;                                               </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  39 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                     </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  40 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                </span>
<span class="6205208880685044389" onmouseenter="enter('6205208880685044389');" onmouseout="out('6205208880685044389');" style="">  41 import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;                                            </span>
<span class="-7911436562744873568" onmouseenter="enter('-7911436562744873568');" onmouseout="out('-7911436562744873568');" style="">  42 import org.broadleafcommerce.core.offer.dao.OfferCodeDao;                                                </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  43 import org.broadleafcommerce.core.offer.dao.OfferDao;                                                    </span>
<span class="-91689670446949346" onmouseenter="enter('-91689670446949346');" onmouseout="out('-91689670446949346');" style="">  44 import org.broadleafcommerce.core.offer.domain.*;                                                        </span>
<span class="4287099423657810905" onmouseenter="enter('4287099423657810905');" onmouseout="out('4287099423657810905');" style="">  45 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;</span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  46 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;            </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  47 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;           </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  48 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                   </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  49 import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                         </span>
<span class="5713212224635448284" onmouseenter="enter('5713212224635448284');" onmouseout="out('5713212224635448284');" style="">  50 import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;                </span>
<span class="-2454758753718589449" onmouseenter="enter('-2454758753718589449');" onmouseout="out('-2454758753718589449');" style="">  51 import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;                            </span>
<span class="8227287359407176835" onmouseenter="enter('8227287359407176835');" onmouseout="out('8227287359407176835');" style="">  52 import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;                           </span>
<span class="-5727938558534008634" onmouseenter="enter('-5727938558534008634');" onmouseout="out('-5727938558534008634');" style="">  53 import org.broadleafcommerce.core.offer.service.type.OfferType;                                          </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  54 import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                         </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  55 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  56 import org.broadleafcommerce.core.order.domain.OrderItem;                                                </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  57 import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                     </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  58 import org.broadleafcommerce.core.order.service.OrderService;                                            </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  59 import org.broadleafcommerce.core.pricing.service.exception.PricingException;                            </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  60 import org.broadleafcommerce.profile.core.domain.Customer;                                               </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  61 import org.springframework.stereotype.Service;                                                           </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  62 import org.springframework.transaction.annotation.Transactional;                                         </span>
<span  style="">  63                                                                                                          </span>
<span  style="">  64                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  65 /**                                                                                                      </span>
<span class="-2667338179687874348" onmouseenter="enter('-2667338179687874348');" onmouseout="out('-2667338179687874348');" style="">  66  * The Class OfferServiceImpl.                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  67  */                                                                                                      </span>
<span class="504450232350438262" onmouseenter="enter('504450232350438262');" onmouseout="out('504450232350438262');" style="">  68 @Service(&quot;blOfferService&quot;)                                                                               </span>
<span class="6786430150403502423" onmouseenter="enter('6786430150403502423');" onmouseout="out('6786430150403502423');" style="">  69 public class OfferServiceImpl implements OfferService {                                                  </span>
<span class="8897944981470617719" onmouseenter="enter('8897944981470617719');" onmouseout="out('8897944981470617719');" style="">  70     private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);                            </span>
<span  style="">  71                                                                                                          </span>
<span class="3846751699212951796" onmouseenter="enter('3846751699212951796');" onmouseout="out('3846751699212951796');" style="">  72     // should be called outside of Offer service after Offer service is executed                         </span>
<span class="3846751699212951796" onmouseenter="enter('3846751699212951796');" onmouseout="out('3846751699212951796');" style="">  73     // should be called outside of Offer service after Offer service is executed                         </span>
<span class="-5484979233832760683" onmouseenter="enter('-5484979233832760683');" onmouseout="out('-5484979233832760683');" style="">  74     @Resource(name=&quot;blCustomerOfferDao&quot;)                                                                 </span>
<span class="-5771823415174942027" onmouseenter="enter('-5771823415174942027');" onmouseout="out('-5771823415174942027');" style="">  75     protected CustomerOfferDao customerOfferDao;                                                         </span>
<span  style="">  76                                                                                                          </span>
<span class="-1524144969871346405" onmouseenter="enter('-1524144969871346405');" onmouseout="out('-1524144969871346405');" style="">  77     @Resource(name=&quot;blOfferCodeDao&quot;)                                                                     </span>
<span class="-6984238934820524758" onmouseenter="enter('-6984238934820524758');" onmouseout="out('-6984238934820524758');" style="">  78     protected OfferCodeDao offerCodeDao;                                                                 </span>
<span  style="">  79                                                                                                          </span>
<span class="-8247969455122443370" onmouseenter="enter('-8247969455122443370');" onmouseout="out('-8247969455122443370');" style="">  80     @Resource(name=&quot;blOfferAuditService&quot;)                                                                </span>
<span class="-6742419488595856311" onmouseenter="enter('-6742419488595856311');" onmouseout="out('-6742419488595856311');" style="">  81     protected OfferAuditService offerAuditService;                                                       </span>
<span  style="">  82                                                                                                          </span>
<span class="-6976077299079381435" onmouseenter="enter('-6976077299079381435');" onmouseout="out('-6976077299079381435');" style="">  83     @Resource(name=&quot;blOfferDao&quot;)                                                                         </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  84     protected OfferDao offerDao;                                                                         </span>
<span  style="">  85                                                                                                          </span>
<span class="-3191658961867656636" onmouseenter="enter('-3191658961867656636');" onmouseout="out('-3191658961867656636');" style="">  86     @Resource(name=&quot;blOrderOfferProcessor&quot;)                                                              </span>
<span class="-3818126380928091101" onmouseenter="enter('-3818126380928091101');" onmouseout="out('-3818126380928091101');" style="">  87     protected OrderOfferProcessor orderOfferProcessor;                                                   </span>
<span  style="">  88                                                                                                          </span>
<span class="-6223428528083119866" onmouseenter="enter('-6223428528083119866');" onmouseout="out('-6223428528083119866');" style="">  89     @Resource(name=&quot;blItemOfferProcessor&quot;)                                                               </span>
<span class="-7827297227357944415" onmouseenter="enter('-7827297227357944415');" onmouseout="out('-7827297227357944415');" style="">  90     protected ItemOfferProcessor itemOfferProcessor;                                                     </span>
<span  style="">  91                                                                                                          </span>
<span class="-1476654469985531605" onmouseenter="enter('-1476654469985531605');" onmouseout="out('-1476654469985531605');" style="">  92     @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)                                                   </span>
<span class="7634983124983010999" onmouseenter="enter('7634983124983010999');" onmouseout="out('7634983124983010999');" style="">  93     protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;                             </span>
<span  style="">  94                                                                                                          </span>
<span class="-4330844585159307437" onmouseenter="enter('-4330844585159307437');" onmouseout="out('-4330844585159307437');" style="">  95     @Resource(name=&quot;blPromotableItemFactory&quot;)                                                            </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style="">  96     protected PromotableItemFactory promotableItemFactory;                                               </span>
<span  style="">  97                                                                                                          </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style="">  98     @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                   </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style="">  99     protected OfferServiceExtensionManager extensionManager;                                             </span>
<span  style=""> 100                                                                                                          </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 101     @Resource(name = &quot;blOrderService&quot;)                                                                   </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 102     protected OrderService orderService;                                                                 </span>
<span  style=""> 103                                                                                                          </span>
<span class="-3946461589801993391" onmouseenter="enter('-3946461589801993391');" onmouseout="out('-3946461589801993391');" style=""> 104     @Resource(name = &quot;blSandBoxHelper&quot;)                                                                  </span>
<span class="-7799183597372200632" onmouseenter="enter('-7799183597372200632');" onmouseout="out('-7799183597372200632');" style=""> 105     protected SandBoxHelper sandBoxHelper;                                                               </span>
<span  style=""> 106                                                                                                          </span>
<span class="-4259734795637808055" onmouseenter="enter('-4259734795637808055');" onmouseout="out('-4259734795637808055');" style=""> 107     @PersistenceContext(unitName=&quot;blPU&quot;)                                                                 </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style=""> 108     protected EntityManager em;                                                                          </span>
<span  style=""> 109                                                                                                          </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 110     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                  </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 111     protected StreamingTransactionCapableUtil transUtil;                                                 </span>
<span  style=""> 112                                                                                                          </span>
<span class="-8384326529234094002" onmouseenter="enter('-8384326529234094002');" onmouseout="out('-8384326529234094002');" style=""> 113     @Resource(name=&quot;blEntityDuplicator&quot;)                                                                 </span>
<span class="-9194612273021432316" onmouseenter="enter('-9194612273021432316');" onmouseout="out('-9194612273021432316');" style=""> 114     protected EntityDuplicator duplicator;                                                               </span>
<span  style=""> 115                                                                                                          </span>
<span class="-8394660854730181484" onmouseenter="enter('-8394660854730181484');" onmouseout="out('-8394660854730181484');" style=""> 116     @Resource(name = &quot;blOfferDuplicateModifier&quot;)                                                         </span>
<span class="8658910844320022950" onmouseenter="enter('8658910844320022950');" onmouseout="out('8658910844320022950');" style=""> 117     protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;                                     </span>
<span  style=""> 118                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 119     @Override                                                                                            </span>
<span class="-2033305286790048708" onmouseenter="enter('-2033305286790048708');" onmouseout="out('-2033305286790048708');" style=""> 120     public List&lt;Offer&gt; findAllOffers() {                                                                 </span>
<span class="2132174063530273788" onmouseenter="enter('2132174063530273788');" onmouseout="out('2132174063530273788');" style=""> 121         return offerDao.readAllOffers();                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122     }                                                                                                    </span>
<span  style=""> 123                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 124     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 125     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="7144811092176845141" onmouseenter="enter('7144811092176845141');" onmouseout="out('7144811092176845141');" style=""> 126     public Offer save(Offer offer) {                                                                     </span>
<span class="-264708178039771798" onmouseenter="enter('-264708178039771798');" onmouseout="out('-264708178039771798');" style=""> 127         return offerDao.save(offer);                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 128     }                                                                                                    </span>
<span  style=""> 129                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 130     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 131     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-5514670765130856091" onmouseenter="enter('-5514670765130856091');" onmouseout="out('-5514670765130856091');" style=""> 132     public OfferCode saveOfferCode(OfferCode offerCode) {                                                </span>
<span class="3125778008044685658" onmouseenter="enter('3125778008044685658');" onmouseout="out('3125778008044685658');" style=""> 133         offerCode.setOffer(offerDao.save(offerCode.getOffer()));                                         </span>
<span class="6906137479190051982" onmouseenter="enter('6906137479190051982');" onmouseout="out('6906137479190051982');" style=""> 134         return offerCodeDao.save(offerCode);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 135     }                                                                                                    </span>
<span  style=""> 136                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 137     /**                                                                                                  </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""><abbr title=" 138      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 138      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr></span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""><abbr title=" 139      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 139      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr></span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 140      * cannot appear more than once in the list.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 141      *                                                                                                   </span>
<span class="-709313334493645866" onmouseenter="enter('-709313334493645866');" onmouseout="out('-709313334493645866');" style=""> 142      * @param code                                                                                       </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 143      * @return a List of offers that may apply to this order                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 144      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 145     @Override                                                                                            </span>
<span class="-6840847083603451180" onmouseenter="enter('-6840847083603451180');" onmouseout="out('-6840847083603451180');" style=""> 146     public Offer lookupOfferByCode(String code) {                                                        </span>
<span class="-531732708503781646" onmouseenter="enter('-531732708503781646');" onmouseout="out('-531732708503781646');" style=""> 147         Offer offer = null;                                                                              </span>
<span class="-8218576552188075283" onmouseenter="enter('-8218576552188075283');" onmouseout="out('-8218576552188075283');" style=""> 148         OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);                                    </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 149         if (offerCode != null) {                                                                         </span>
<span class="-2561785727340284423" onmouseenter="enter('-2561785727340284423');" onmouseout="out('-2561785727340284423');" style=""> 150             offer = offerCode.getOffer();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 151         }                                                                                                </span>
<span class="-8963791522625561917" onmouseenter="enter('-8963791522625561917');" onmouseout="out('-8963791522625561917');" style=""> 152         return offer;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 153     }                                                                                                    </span>
<span  style=""> 154                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 155     @Override                                                                                            </span>
<span class="8523319015886947471" onmouseenter="enter('8523319015886947471');" onmouseout="out('8523319015886947471');" style=""> 156     public OfferCode lookupOfferCodeByCode(String code) {                                                </span>
<span class="8795189428566002896" onmouseenter="enter('8795189428566002896');" onmouseout="out('8795189428566002896');" style=""> 157         return offerCodeDao.readOfferCodeByCode(code);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 158     }                                                                                                    </span>
<span  style=""> 159                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 160     @Override                                                                                            </span>
<span class="-2543778591938191529" onmouseenter="enter('-2543778591938191529');" onmouseout="out('-2543778591938191529');" style=""> 161     public List&lt;Offer&gt; lookupAllOffersByCode(String code) {                                              </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 162         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                     </span>
<span class="-3360697953765841703" onmouseenter="enter('-3360697953765841703');" onmouseout="out('-3360697953765841703');" style=""> 163         List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);                         </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 164         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 165             if (offerCode != null) {                                                                     </span>
<span class="-7816274075460376657" onmouseenter="enter('-7816274075460376657');" onmouseout="out('-7816274075460376657');" style=""> 166                 offers.add(offerCode.getOffer());                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 167             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168         }                                                                                                </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 169         return offers;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 170     }                                                                                                    </span>
<span  style=""> 171                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 172     @Override                                                                                            </span>
<span class="-2234097583540207697" onmouseenter="enter('-2234097583540207697');" onmouseout="out('-2234097583540207697');" style=""> 173     public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code) {                                      </span>
<span class="-4234235759448675045" onmouseenter="enter('-4234235759448675045');" onmouseout="out('-4234235759448675045');" style=""> 174         return offerCodeDao.readAllOfferCodesByCode(code);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 175     }                                                                                                    </span>
<span  style=""> 176                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 177     /**                                                                                                  </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""><abbr title=" 178      * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,"> 178      * Creates a list of offers that applies to this order.  All offers that are assigned to the customerðŸ”µ</abbr></span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""><abbr title=" 179      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer"> 179      * entered during checkout, or has a delivery type of automatic are added to the list.  The same offeðŸ”µ</abbr></span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 180      * cannot appear more than once in the list.                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 181      *                                                                                                   </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 182      * @param order                                                                                      </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 183      * @return a List of offers that may apply to this order                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 184      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 185     @Override                                                                                            </span>
<span class="-5814298891852821500" onmouseenter="enter('-5814298891852821500');" onmouseout="out('-5814298891852821500');" style=""> 186     public List&lt;Offer&gt; buildOfferListForOrder(Order order) {                                             </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 187         List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                     </span>
<span class="-3235900677601494398" onmouseenter="enter('-3235900677601494398');" onmouseout="out('-3235900677601494398');" style=""> 188         List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());         </span>
<span class="7699769166343685501" onmouseenter="enter('7699769166343685501');" onmouseout="out('7699769166343685501');" style=""> 189         for (CustomerOffer customerOffer : customerOffers) {                                             </span>
<span class="-2310400538171319838" onmouseenter="enter('-2310400538171319838');" onmouseout="out('-2310400538171319838');" style=""> 190             if (!offers.contains(customerOffer.getOffer())) {                                            </span>
<span class="5233078073066950969" onmouseenter="enter('5233078073066950969');" onmouseout="out('5233078073066950969');" style=""> 191                 offers.add(customerOffer.getOffer());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 192             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193         }                                                                                                </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 194         List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                          </span>
<span class="-6665865767746694239" onmouseenter="enter('-6665865767746694239');" onmouseout="out('-6665865767746694239');" style=""> 195         orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                    </span>
<span class="-7332519531441163733" onmouseenter="enter('-7332519531441163733');" onmouseout="out('-7332519531441163733');" style=""> 196 //        int before = orderOfferCodes.size();                                                           </span>
<span class="1955749666612820833" onmouseenter="enter('1955749666612820833');" onmouseout="out('1955749666612820833');" style=""> 197 //        orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                  </span>
<span class="-6467003552280566260" onmouseenter="enter('-6467003552280566260');" onmouseout="out('-6467003552280566260');" style=""> 198 /*        int after = orderOfferCodes.size();                                                            </span>
<span class="2182795146752320946" onmouseenter="enter('2182795146752320946');" onmouseout="out('2182795146752320946');" style=""><abbr title=" 199         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 199         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr></span>
<span class="3842576300509712789" onmouseenter="enter('3842576300509712789');" onmouseout="out('3842576300509712789');" style=""> 200         if(o !=null &amp;&amp; (Boolean)o &amp;&amp; before!=after){                                                     </span>
<span class="-3668454086264686215" onmouseenter="enter('-3668454086264686215');" onmouseout="out('-3668454086264686215');" style=""><abbr title=" 201             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 201             BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiðŸ”µ</abbr></span>
<span class="-2684617365274670769" onmouseenter="enter('-2684617365274670769');" onmouseout="out('-2684617365274670769');" style=""> 202         }*/                                                                                              </span>
<span class="2682597879629079185" onmouseenter="enter('2682597879629079185');" onmouseout="out('2682597879629079185');" style=""> 203         for (OfferCode orderOfferCode : orderOfferCodes) {                                               </span>
<span class="-1857624084667800558" onmouseenter="enter('-1857624084667800558');" onmouseout="out('-1857624084667800558');" style=""> 204             if (!offers.contains(orderOfferCode.getOffer())) {                                           </span>
<span class="4188766124804405127" onmouseenter="enter('4188766124804405127');" onmouseout="out('4188766124804405127');" style=""> 205                 offers.add(orderOfferCode.getOffer());                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 206             }                                                                                            </span>
<span class="-4468546552745233084" onmouseenter="enter('-4468546552745233084');" onmouseout="out('-4468546552745233084');" style=""> 207             extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 208         }                                                                                                </span>
<span class="-9188634082558155234" onmouseenter="enter('-9188634082558155234');" onmouseout="out('-9188634082558155234');" style=""> 209         List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();                                      </span>
<span class="-8411171878687156520" onmouseenter="enter('-8411171878687156520');" onmouseout="out('-8411171878687156520');" style=""> 210         for (Offer globalOffer : globalOffers) {                                                         </span>
<span class="-5805980646770316691" onmouseenter="enter('-5805980646770316691');" onmouseout="out('-5805980646770316691');" style=""> 211             if ((!offers.contains(globalOffer)) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {</span>
<span class="-3050025518373868772" onmouseenter="enter('-3050025518373868772');" onmouseout="out('-3050025518373868772');" style=""> 212                 offers.add(globalOffer);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 213             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 214         }                                                                                                </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 215         if (extensionManager != null) {                                                                  </span>
<span class="1817402996237899777" onmouseenter="enter('1817402996237899777');" onmouseout="out('1817402996237899777');" style=""> 216             extensionManager.applyAdditionalFilters(offers, order);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 217         }                                                                                                </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 218         return offers;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 219     }                                                                                                    </span>
<span  style=""> 220                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 221     @Override                                                                                            </span>
<span class="2056305643902587707" onmouseenter="enter('2056305643902587707');" onmouseout="out('2056305643902587707');" style=""> 222     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {                                  </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 223         Customer customer = order.getCustomer();                                                         </span>
<span class="-5041998041456755776" onmouseenter="enter('-5041998041456755776');" onmouseout="out('-5041998041456755776');" style=""> 224         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();                                             </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 225         if (extensionManager != null) {                                                                  </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 226             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 227         }                                                                                                </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 228         if (!offerCodes.isEmpty()) {                                                                     </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 229             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                             </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 230             while (itr.hasNext()) {                                                                      </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 231                 OfferCode offerCode = itr.next();                                                        </span>
<span class="1398520463543853590" onmouseenter="enter('1398520463543853590');" onmouseout="out('1398520463543853590');" style=""> 232                 if ((!offerCode.isActive()) || (!verifyMaxCustomerUsageThreshold(order, offerCode))) {   </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 233                     itr.remove();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 235             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 236         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 237         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238     }                                                                                                    </span>
<span  style=""> 239                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 240     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 241     @Override                                                                                            </span>
<span class="3843851677430304310" onmouseenter="enter('3843851677430304310');" onmouseout="out('3843851677430304310');" style=""> 242     public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {                            </span>
<span class="-6957816096303048614" onmouseenter="enter('-6957816096303048614');" onmouseout="out('-6957816096303048614');" style=""> 243         ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 244         if (extensionManager != null) {                                                                  </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 245             extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 246         }                                                                                                </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 247         if (!offerCodes.isEmpty()) {                                                                     </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 248             Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                             </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 249             while (itr.hasNext()) {                                                                      </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 250                 OfferCode offerCode = itr.next();                                                        </span>
<span class="-6077080642354656881" onmouseenter="enter('-6077080642354656881');" onmouseout="out('-6077080642354656881');" style=""> 251                 if ((!offerCode.isActive()) || (!verifyMaxCustomerUsageThreshold(customer, offerCode))) {</span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 252                     itr.remove();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 253                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 254             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 255         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 256         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 257     }                                                                                                    </span>
<span  style=""> 258                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 259     /**                                                                                                  </span>
<span class="2837560355574155003" onmouseenter="enter('2837560355574155003');" onmouseout="out('2837560355574155003');" style=""> 260      * Private method used to retrieve all offers assigned to this customer.  These offers are           </span>
<span class="4852710310174118924" onmouseenter="enter('4852710310174118924');" onmouseout="out('4852710310174118924');" style=""> 261      * programmatically assigned to the customer.                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 262      *                                                                                                   </span>
<span class="1094425505394812731" onmouseenter="enter('1094425505394812731');" onmouseout="out('1094425505394812731');" style=""> 263      * @param customer                                                                                   </span>
<span class="-3868237647402015492" onmouseenter="enter('-3868237647402015492');" onmouseout="out('-3868237647402015492');" style=""> 264      * @return a List of offers assigned to the customer                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 265      */                                                                                                  </span>
<span class="-1064959765029423996" onmouseenter="enter('-1064959765029423996');" onmouseout="out('-1064959765029423996');" style=""> 266     protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {                     </span>
<span class="1699675085073278700" onmouseenter="enter('1699675085073278700');" onmouseout="out('1699675085073278700');" style=""> 267         List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);    </span>
<span class="5611761187435301880" onmouseenter="enter('5611761187435301880');" onmouseout="out('5611761187435301880');" style=""> 268         return offerCustomers;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 269     }                                                                                                    </span>
<span  style=""> 270                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 271     /**                                                                                                  </span>
<span class="-8831229104457932482" onmouseenter="enter('-8831229104457932482');" onmouseout="out('-8831229104457932482');" style=""> 272      * Private method used to retrieve all offers with automaticallyAdded set to true                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 273      *                                                                                                   </span>
<span class="-2057313490179191281" onmouseenter="enter('-2057313490179191281');" onmouseout="out('-2057313490179191281');" style=""> 274      * @return a List of automatic delivery offers                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 275      */                                                                                                  </span>
<span class="-9186908469762752320" onmouseenter="enter('-9186908469762752320');" onmouseout="out('-9186908469762752320');" style=""> 276     protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {                                              </span>
<span class="-2657712449795339218" onmouseenter="enter('-2657712449795339218');" onmouseout="out('-2657712449795339218');" style=""> 277         List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();                         </span>
<span class="-7738403477037597046" onmouseenter="enter('-7738403477037597046');" onmouseout="out('-7738403477037597046');" style=""> 278         return globalOffers;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 279     }                                                                                                    </span>
<span  style=""> 280                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 281     /**                                                                                                  </span>
<span class="-582485916100204765" onmouseenter="enter('-582485916100204765');" onmouseout="out('-582485916100204765');" style=""> 282      * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end           </span>
<span class="-591413864231465226" onmouseenter="enter('-591413864231465226');" onmouseout="out('-591413864231465226');" style=""> 283      * date.  If an offerCode has a later start date, that offerCode will be removed.                    </span>
<span class="-1600892852414517397" onmouseenter="enter('-1600892852414517397');" onmouseout="out('-1600892852414517397');" style=""> 284      * OfferCodes without a start date will still be processed. If the offerCode                         </span>
<span class="-6972954356288154926" onmouseenter="enter('-6972954356288154926');" onmouseout="out('-6972954356288154926');" style=""> 285      * has a end date that has already passed, that offerCode will be removed.  OfferCodes               </span>
<span class="-7007360996659097530" onmouseenter="enter('-7007360996659097530');" onmouseout="out('-7007360996659097530');" style=""> 286      * without a end date will be processed.  The start and end dates on the offer will                  </span>
<span class="-216139196908541615" onmouseenter="enter('-216139196908541615');" onmouseout="out('-216139196908541615');" style=""> 287      * still need to be evaluated.                                                                       </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 288      *                                                                                                   </span>
<span class="-142155654396048960" onmouseenter="enter('-142155654396048960');" onmouseout="out('-142155654396048960');" style=""> 289      * @param offerCodes                                                                                 </span>
<span class="-7645314644020819692" onmouseenter="enter('-7645314644020819692');" onmouseout="out('-7645314644020819692');" style=""> 290      * @return a List of non-expired offers                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 291      */                                                                                                  </span>
<span class="2162752701967495613" onmouseenter="enter('2162752701967495613');" onmouseout="out('2162752701967495613');" style=""> 292     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes) {                    </span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 293         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                 </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 294         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="2389554693717353300" onmouseenter="enter('2389554693717353300');" onmouseout="out('2389554693717353300');" style=""> 295             if (!offerCode.isActive()) {                                                                 </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 296                 offerCodesToRemove.add(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 297             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 298         }                                                                                                </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 299         // remove all offers in the offersToRemove list from original offers list                        </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 300         for (OfferCode offerCode : offerCodesToRemove) {                                                 </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 301             offerCodes.remove(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 302         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 303         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304     }                                                                                                    </span>
<span  style=""> 305                                                                                                          </span>
<span class="-1122966598762212117" onmouseenter="enter('-1122966598762212117');" onmouseout="out('-1122966598762212117');" style=""><abbr title=" 306     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; offers) {"> 306     protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; ðŸ”µ</abbr></span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 307         List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                 </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 308         for (OfferCode offerCode : offerCodes) {                                                         </span>
<span class="2389554693717353300" onmouseenter="enter('2389554693717353300');" onmouseout="out('2389554693717353300');" style=""> 309             if (!offerCode.isActive()) {                                                                 </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 310                 offerCodesToRemove.add(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 311             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 312         }                                                                                                </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 313         // remove all offers in the offersToRemove list from original offers list                        </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 314         for (OfferCode offerCode : offerCodesToRemove) {                                                 </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 315             offerCodes.remove(offerCode);                                                                </span>
<span class="-6904171993325612449" onmouseenter="enter('-6904171993325612449');" onmouseout="out('-6904171993325612449');" style=""> 316             offers.remove(offerCode.getOffer());                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 317         }                                                                                                </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 318         return offerCodes;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 319     }                                                                                                    </span>
<span  style=""> 320                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 321     /**                                                                                                  </span>
<span class="5637961435104982406" onmouseenter="enter('5637961435104982406');" onmouseout="out('5637961435104982406');" style=""> 322      * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with       </span>
<span class="1724276086246688719" onmouseenter="enter('1724276086246688719');" onmouseout="out('1724276086246688719');" style=""> 323      * current sandbox status.                                                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 324      *                                                                                                   </span>
<span class="202872854140107873" onmouseenter="enter('202872854140107873');" onmouseout="out('202872854140107873');" style=""> 325      * @param order the order to check                                                                   </span>
<span class="2772482249434351691" onmouseenter="enter('2772482249434351691');" onmouseout="out('2772482249434351691');" style=""> 326      * @return the refreshed list of OfferCodes                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 327      */                                                                                                  </span>
<span class="7210051143895905366" onmouseenter="enter('7210051143895905366');" onmouseout="out('7210051143895905366');" style=""> 328     protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {                         </span>
<span class="7464496307728629396" onmouseenter="enter('7464496307728629396');" onmouseout="out('7464496307728629396');" style=""> 329         final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();                              </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 330         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 331             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 332             public void execute() {                                                                      </span>
<span class="-6058145000184664425" onmouseenter="enter('-6058145000184664425');" onmouseout="out('-6058145000184664425');" style=""> 333                 for (OfferCode offerCode : orderOfferCodes) {                                            </span>
<span class="-4263515828536000223" onmouseenter="enter('-4263515828536000223');" onmouseout="out('-4263515828536000223');" style=""> 334                     if (offerCode.getOffer() != null) {                                                  </span>
<span class="8507823172595815939" onmouseenter="enter('8507823172595815939');" onmouseout="out('8507823172595815939');" style=""><abbr title=" 335                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 335                         Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCðŸ”µ</abbr></span>
<span class="7213118550719593773" onmouseenter="enter('7213118550719593773');" onmouseout="out('7213118550719593773');" style=""><abbr title=" 336                         if ((sandBoxVersionId != null) &amp;&amp; (!Objects.equals(sandBoxVersionId, offerCode.getOffer().getId()))) {"> 336                         if ((sandBoxVersionId != null) &amp;&amp; (!Objects.equals(sandBoxVersionId, offerCode.geðŸ”µ</abbr></span>
<span class="-6104864632261418874" onmouseenter="enter('-6104864632261418874');" onmouseout="out('-6104864632261418874');" style=""> 337                             em.refresh(offerCode);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 338                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 339                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 340                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 341             }                                                                                            </span>
<span  style=""> 342                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 343             @Override                                                                                    </span>
<span class="1336357167460974281" onmouseenter="enter('1336357167460974281');" onmouseout="out('1336357167460974281');" style=""> 344             public boolean shouldRetryOnTransactionLockAcquisitionFailure() {                            </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 345                 return true;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 346             }                                                                                            </span>
<span class="-6091186094481843758" onmouseenter="enter('-6091186094481843758');" onmouseout="out('-6091186094481843758');" style=""> 347         }, java.lang.RuntimeException.class);                                                            </span>
<span class="720292142172901868" onmouseenter="enter('720292142172901868');" onmouseout="out('720292142172901868');" style=""> 348         return orderOfferCodes;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 349     }                                                                                                    </span>
<span  style=""> 350                                                                                                          </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 351     /*                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 352      *                                                                                                   </span>
<span class="-1078885518483632555" onmouseenter="enter('-1078885518483632555');" onmouseout="out('-1078885518483632555');" style=""> 353      * Offers Logic:                                                                                     </span>
<span class="-6544489594486398439" onmouseenter="enter('-6544489594486398439');" onmouseout="out('-6544489594486398439');" style=""> 354      * 1) Remove all existing offers in the Order (order, item, and fulfillment)                         </span>
<span class="472654013095872963" onmouseenter="enter('472654013095872963');" onmouseout="out('472654013095872963');" style=""> 355      * 2) Check and remove offers                                                                        </span>
<span class="8111384560802328496" onmouseenter="enter('8111384560802328496');" onmouseout="out('8111384560802328496');" style=""> 356      *    a) Remove out of date offers                                                                   </span>
<span class="3025649188866691570" onmouseenter="enter('3025649188866691570');" onmouseout="out('3025649188866691570');" style=""> 357      *    b) Remove offers that do not apply to this customer                                            </span>
<span class="5156402814943015913" onmouseenter="enter('5156402814943015913');" onmouseout="out('5156402814943015913');" style=""> 358      * 3) Loop through offers                                                                            </span>
<span class="6235203245796610706" onmouseenter="enter('6235203245796610706');" onmouseout="out('6235203245796610706');" style=""> 359      *    a) Verifies type of offer (order, order item, fulfillment)                                     </span>
<span class="7315686159335672158" onmouseenter="enter('7315686159335672158');" onmouseout="out('7315686159335672158');" style=""> 360      *    b) Verifies if offer can be applies                                                            </span>
<span class="-6634234506054969031" onmouseenter="enter('-6634234506054969031');" onmouseout="out('-6634234506054969031');" style=""> 361      *    c) Assign offer to type (order, order item, or fulfillment)                                    </span>
<span class="-4584093434328536587" onmouseenter="enter('-4584093434328536587');" onmouseout="out('-4584093434328536587');" style=""> 362      * 4) Sorts the order and item offers list by priority and then discount                             </span>
<span class="-2042995489836168848" onmouseenter="enter('-2042995489836168848');" onmouseout="out('-2042995489836168848');" style=""> 363      * 5) Identify the best offers to apply to order item and create adjustments for each item offer     </span>
<span class="8597383329030492662" onmouseenter="enter('8597383329030492662');" onmouseout="out('8597383329030492662');" style=""><abbr title=" 364      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better"> 364      * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is betðŸ”µ</abbr></span>
<span class="-5003028621529242985" onmouseenter="enter('-5003028621529242985');" onmouseout="out('-5003028621529242985');" style=""> 365      * 7) Identify the best offers to apply to the order and create adjustments for each order offer     </span>
<span class="-1324083657955785943" onmouseenter="enter('-1324083657955785943');" onmouseout="out('-1324083657955785943');" style=""><abbr title=" 366      * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 366      * 8) If item contains non-combinable offers remove either the item or order adjustments based on disðŸ”µ</abbr></span>
<span class="-8610949319074908232" onmouseenter="enter('-8610949319074908232');" onmouseout="out('-8610949319074908232');" style=""> 367      * 9) Set final order item prices and reapply order offers                                           </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 368      *                                                                                                   </span>
<span class="9071544830737596533" onmouseenter="enter('9071544830737596533');" onmouseout="out('9071544830737596533');" style=""> 369      * Assumptions:                                                                                      </span>
<span class="7676524731541901514" onmouseenter="enter('7676524731541901514');" onmouseout="out('7676524731541901514');" style=""> 370      * 1) % off all items will be created as an item offer with no expression                            </span>
<span class="-814522364757940962" onmouseenter="enter('-814522364757940962');" onmouseout="out('-814522364757940962');" style=""> 371      * 2) $ off order will be created as an order offer                                                  </span>
<span class="7365449813142531261" onmouseenter="enter('7365449813142531261');" onmouseout="out('7365449813142531261');" style=""> 372      * 3) Order offers applies to the best price for each item (not just retail price)                   </span>
<span class="-1636653647835076359" onmouseenter="enter('-1636653647835076359');" onmouseout="out('-1636653647835076359');" style=""> 373      * 4) Fulfillment offers apply to best price for each item (not just retail price)                   </span>
<span class="-5866280996345915157" onmouseenter="enter('-5866280996345915157');" onmouseout="out('-5866280996345915157');" style=""><abbr title=" 374      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 374      * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used witðŸ”µ</abbr></span>
<span class="-8022045642448063338" onmouseenter="enter('-8022045642448063338');" onmouseout="out('-8022045642448063338');" style=""> 375      * 6) Fulfillment offers cannot be not combinable                                                    </span>
<span class="-5108644804585013203" onmouseenter="enter('-5108644804585013203');" onmouseout="out('-5108644804585013203');" style=""> 376      * 7) Order offers cannot be FIXED_PRICE                                                             </span>
<span class="6161153439596163093" onmouseenter="enter('6161153439596163093');" onmouseout="out('6161153439596163093');" style=""> 377      * 8) FIXED_PRICE offers cannot be stackable                                                         </span>
<span class="7044504232316014062" onmouseenter="enter('7044504232316014062');" onmouseout="out('7044504232316014062');" style=""><abbr title=" 378      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 378      * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will alðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 379      *                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 380      */                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 381     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 382     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-4704847871427432866" onmouseenter="enter('-4704847871427432866');" onmouseout="out('-4704847871427432866');" style=""> 383     public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {    </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 384         /*                                                                                               </span>
<span class="-6180845550366984877" onmouseenter="enter('-6180845550366984877');" onmouseout="out('-6180845550366984877');" style=""> 385         TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to </span>
<span class="9161254164549280190" onmouseenter="enter('9161254164549280190');" onmouseout="out('9161254164549280190');" style=""> 386         use a richer object to describe the parameters of the pricing call. This object would include    </span>
<span class="1561516658361300705" onmouseenter="enter('1561516658361300705');" onmouseout="out('1561516658361300705');" style=""> 387         the pricing boolean, but would also include a list of activities to include or exclude in the    </span>
<span class="-6797832594843538707" onmouseenter="enter('-6797832594843538707');" onmouseout="out('-6797832594843538707');" style=""> 388         call - see http://jira.broadleafcommerce.org/browse/BLC-664                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 389          */                                                                                              </span>
<span class="2182795146752320946" onmouseenter="enter('2182795146752320946');" onmouseout="out('2182795146752320946');" style=""><abbr title=" 390         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 390         Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINðŸ”µ</abbr></span>
<span class="-2779719222870458088" onmouseenter="enter('-2779719222870458088');" onmouseout="out('-2779719222870458088');" style=""> 391         int offerCount = 0;                                                                              </span>
<span class="3586598712564634546" onmouseenter="enter('3586598712564634546');" onmouseout="out('3586598712564634546');" style=""> 392         if ((o != null) &amp;&amp; ((Boolean) (o))) {                                                            </span>
<span class="7231372767400990750" onmouseenter="enter('7231372767400990750');" onmouseout="out('7231372767400990750');" style=""><abbr title=" 393             if (org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())) {"> 393             if (org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())) ðŸ”µ</abbr></span>
<span class="187767283697509415" onmouseenter="enter('187767283697509415');" onmouseout="out('187767283697509415');" style=""> 394                 for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {                    </span>
<span class="-7651338500631954149" onmouseenter="enter('-7651338500631954149');" onmouseout="out('-7651338500631954149');" style=""> 395                     if (orderAdjustment.getOffer() != null) {                                            </span>
<span class="6329272383142541507" onmouseenter="enter('6329272383142541507');" onmouseout="out('6329272383142541507');" style=""> 396                         offerCount++;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 397                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 398                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 399             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 400         }                                                                                                </span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 401         OfferContext offerContext = OfferContext.getOfferContext();                                      </span>
<span class="-1823780693566075420" onmouseenter="enter('-1823780693566075420');" onmouseout="out('-1823780693566075420');" style=""> 402         if ((offerContext == null) || offerContext.executePromotionCalculation) {                        </span>
<span class="-2683885994659783076" onmouseenter="enter('-2683885994659783076');" onmouseout="out('-2683885994659783076');" style=""> 403             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false); </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 404             List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                      </span>
<span class="-2406747375061389964" onmouseenter="enter('-2406747375061389964');" onmouseout="out('-2406747375061389964');" style=""> 405             removeOutOfDateOfferCodesAndOffers(orderOfferCodes, offers);                                 </span>
<span class="-9066266687178937853" onmouseenter="enter('-9066266687178937853');" onmouseout="out('-9066266687178937853');" style=""> 406             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());  </span>
<span class="-6868190609932159890" onmouseenter="enter('-6868190609932159890');" onmouseout="out('-6868190609932159890');" style=""> 407             if ((filteredOffers == null) || filteredOffers.isEmpty()) {                                  </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 408                 if (LOG.isTraceEnabled()) {                                                              </span>
<span class="2760579588161124045" onmouseenter="enter('2760579588161124045');" onmouseout="out('2760579588161124045');" style=""> 409                     LOG.trace(&quot;No offers applicable to this order.&quot;);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 410                 }                                                                                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 411             } else {                                                                                     </span>
<span class="7300520529047311728" onmouseenter="enter('7300520529047311728');" onmouseout="out('7300520529047311728');" style=""><abbr title=" 412                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 412                 List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidðŸ”µ</abbr></span>
<span class="-7404348590242143631" onmouseenter="enter('-7404348590242143631');" onmouseout="out('-7404348590242143631');" style=""><abbr title=" 413                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 413                 List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidatðŸ”µ</abbr></span>
<span class="-5526882442984993330" onmouseenter="enter('-5526882442984993330');" onmouseout="out('-5526882442984993330');" style=""><abbr title=" 414                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 414                 itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, quðŸ”µ</abbr></span>
<span class="-5791915517208654876" onmouseenter="enter('-5791915517208654876');" onmouseout="out('-5791915517208654876');" style=""> 415                 if (!(qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {                </span>
<span class="-2723881742436166059" onmouseenter="enter('-2723881742436166059');" onmouseout="out('-2723881742436166059');" style=""><abbr title=" 416                     // At this point, we should have a PromotableOrder that contains PromotableItems each of which"> 416                     // At this point, we should have a PromotableOrder that contains PromotableItems eachðŸ”µ</abbr></span>
<span class="751015906320167144" onmouseenter="enter('751015906320167144');" onmouseout="out('751015906320167144');" style=""> 417                     // has a list of candidatePromotions that might be applied.                          </span>
<span class="5941864862011378901" onmouseenter="enter('5941864862011378901');" onmouseout="out('5941864862011378901');" style=""><abbr title=" 418                     // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 418                     // We also have a list of orderOffers that might apply and a list of itemOffers that ðŸ”µ</abbr></span>
<span class="1127078869550353626" onmouseenter="enter('1127078869550353626');" onmouseout="out('1127078869550353626');" style=""><abbr title=" 419                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 419                     itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 420                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 421             }                                                                                            </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 422             orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                        </span>
<span class="514986819999277890" onmouseenter="enter('514986819999277890');" onmouseout="out('514986819999277890');" style=""> 423             verifyAdjustments(order, true);                                                              </span>
<span class="-8901364638816691349" onmouseenter="enter('-8901364638816691349');" onmouseout="out('-8901364638816691349');" style=""> 424             order.setSubTotal(order.calculateSubTotal());                                                </span>
<span class="8881079200386597596" onmouseenter="enter('8881079200386597596');" onmouseout="out('8881079200386597596');" style=""> 425             order.finalizeItemPrices();                                                                  </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 426             order = orderService.save(order, false);                                                     </span>
<span class="-5335273514929397197" onmouseenter="enter('-5335273514929397197');" onmouseout="out('-5335273514929397197');" style=""> 427             boolean madeChange = verifyAdjustments(order, false);                                        </span>
<span class="-3218959195648057803" onmouseenter="enter('-3218959195648057803');" onmouseout="out('-3218959195648057803');" style=""> 428             if (madeChange) {                                                                            </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 429                 order = orderService.save(order, false);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 430             }                                                                                            </span>
<span class="-6042045376028000407" onmouseenter="enter('-6042045376028000407');" onmouseout="out('-6042045376028000407');" style=""> 431             int offerCountAfter = 0;                                                                     </span>
<span class="3586598712564634546" onmouseenter="enter('3586598712564634546');" onmouseout="out('3586598712564634546');" style=""> 432             if ((o != null) &amp;&amp; ((Boolean) (o))) {                                                        </span>
<span class="7231372767400990750" onmouseenter="enter('7231372767400990750');" onmouseout="out('7231372767400990750');" style=""><abbr title=" 433                 if (org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())) {"> 433                 if (org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments(ðŸ”µ</abbr></span>
<span class="187767283697509415" onmouseenter="enter('187767283697509415');" onmouseout="out('187767283697509415');" style=""> 434                     for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {                </span>
<span class="-7651338500631954149" onmouseenter="enter('-7651338500631954149');" onmouseout="out('-7651338500631954149');" style=""> 435                         if (orderAdjustment.getOffer() != null) {                                        </span>
<span class="-8696114592748620649" onmouseenter="enter('-8696114592748620649');" onmouseout="out('-8696114592748620649');" style=""> 436                             offerCountAfter++;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 437                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 438                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 439                 }                                                                                        </span>
<span class="-7943316056411719752" onmouseenter="enter('-7943316056411719752');" onmouseout="out('-7943316056411719752');" style=""> 440                 if (offerCountAfter != offerCount) {                                                     </span>
<span class="-3668454086264686215" onmouseenter="enter('-3668454086264686215');" onmouseout="out('-3668454086264686215');" style=""><abbr title=" 441                     BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 441                     BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 442                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 443             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 444         }                                                                                                </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 445         return order;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 446     }                                                                                                    </span>
<span  style=""> 447                                                                                                          </span>
<span class="219209447823395758" onmouseenter="enter('219209447823395758');" onmouseout="out('219209447823395758');" style=""> 448     protected boolean verifyAdjustments(Order order, boolean beforeSave) {                               </span>
<span class="79408939766017075" onmouseenter="enter('79408939766017075');" onmouseout="out('79408939766017075');" style=""> 449         boolean madeChange = false;                                                                      </span>
<span class="-8966123689509035198" onmouseenter="enter('-8966123689509035198');" onmouseout="out('-8966123689509035198');" style=""> 450         if (order.getOrderItems() == null) {                                                             </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 451             return madeChange;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 452         }                                                                                                </span>
<span class="8447029191885982498" onmouseenter="enter('8447029191885982498');" onmouseout="out('8447029191885982498');" style=""> 453         for (OrderItem oi : order.getOrderItems()) {                                                     </span>
<span class="-5982197742320851056" onmouseenter="enter('-5982197742320851056');" onmouseout="out('-5982197742320851056');" style=""> 454             if (oi.getOrderItemPriceDetails() == null) {                                                 </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 455                 continue;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 456             }                                                                                            </span>
<span class="7391296704731194189" onmouseenter="enter('7391296704731194189');" onmouseout="out('7391296704731194189');" style=""> 457             for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {                              </span>
<span class="-8259157388002947293" onmouseenter="enter('-8259157388002947293');" onmouseout="out('-8259157388002947293');" style=""> 458                 if (pd.getOrderItemPriceDetailAdjustments() == null) {                                   </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 459                     continue;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 460                 }                                                                                        </span>
<span class="-8160497408394725913" onmouseenter="enter('-8160497408394725913');" onmouseout="out('-8160497408394725913');" style=""><abbr title=" 461                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 461                 Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdðŸ”µ</abbr></span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 462                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 462                 List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDeðŸ”µ</abbr></span>
<span class="-3008507732031274392" onmouseenter="enter('-3008507732031274392');" onmouseout="out('-3008507732031274392');" style=""> 463                 for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {     </span>
<span class="-1975641521768786423" onmouseenter="enter('-1975641521768786423');" onmouseout="out('-1975641521768786423');" style=""> 464                     if (adjs.containsKey(adj.getOffer().getId())) {                                      </span>
<span class="-6913168070672082713" onmouseenter="enter('-6913168070672082713');" onmouseout="out('-6913168070672082713');" style=""> 465                         adjustmentsToRemove.add(adj);                                                    </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 466                         if (LOG.isDebugEnabled()) {                                                      </span>
<span class="1127322910475386047" onmouseenter="enter('1127322910475386047');" onmouseout="out('1127322910475386047');" style=""><abbr title=" 467                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;).append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;).append(&quot; with ids &quot;).append(adjs.get(adj.getOffer().getId()).getId()).append(&quot; and &quot;).append(adj.getId());"> 467                             StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;).append(beforeSavðŸ”µ</abbr></span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 468                             LOG.debug(sb.toString());                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 469                         }                                                                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 470                     } else {                                                                             </span>
<span class="-7759509127049565554" onmouseenter="enter('-7759509127049565554');" onmouseout="out('-7759509127049565554');" style=""> 471                         adjs.put(adj.getOffer().getId(), adj);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 472                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 473                 }                                                                                        </span>
<span class="7848730128284985932" onmouseenter="enter('7848730128284985932');" onmouseout="out('7848730128284985932');" style=""> 474                 for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {                         </span>
<span class="6756116260498887863" onmouseenter="enter('6756116260498887863');" onmouseout="out('6756116260498887863');" style=""> 475                     pd.getOrderItemPriceDetailAdjustments().remove(adj);                                 </span>
<span class="5571803755205047298" onmouseenter="enter('5571803755205047298');" onmouseout="out('5571803755205047298');" style=""> 476                     madeChange = true;                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 477                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 478             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 479         }                                                                                                </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 480         return madeChange;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 481     }                                                                                                    </span>
<span  style=""> 482                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 483     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 484     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 485     @Deprecated                                                                                          </span>
<span class="-3021599232242429775" onmouseenter="enter('-3021599232242429775');" onmouseout="out('-3021599232242429775');" style=""> 486     public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {            </span>
<span class="-6341015309393843959" onmouseenter="enter('-6341015309393843959');" onmouseout="out('-6341015309393843959');" style=""> 487         applyAndSaveOffersToOrder(offers, order);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 488     }                                                                                                    </span>
<span  style=""> 489                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 490     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 491     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 492     @Deprecated                                                                                          </span>
<span class="-5535279977913938928" onmouseenter="enter('-5535279977913938928');" onmouseout="out('-5535279977913938928');" style=""><abbr title=" 493     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 493     public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptiðŸ”µ</abbr></span>
<span class="6394386461467124428" onmouseenter="enter('6394386461467124428');" onmouseout="out('6394386461467124428');" style=""> 494         applyAndSaveFulfillmentGroupOffersToOrder(offers, order);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 495     }                                                                                                    </span>
<span  style=""> 496                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 497     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 498     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="2855881782634007850" onmouseenter="enter('2855881782634007850');" onmouseout="out('2855881782634007850');" style=""><abbr title=" 499     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 499     public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricinðŸ”µ</abbr></span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 500         OfferContext offerContext = OfferContext.getOfferContext();                                      </span>
<span class="-1823780693566075420" onmouseenter="enter('-1823780693566075420');" onmouseout="out('-1823780693566075420');" style=""> 501         if ((offerContext == null) || offerContext.executePromotionCalculation) {                        </span>
<span class="-6175933736447840798" onmouseenter="enter('-6175933736447840798');" onmouseout="out('-6175933736447840798');" style=""> 502             PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, true);  </span>
<span class="-6252467951249219732" onmouseenter="enter('-6252467951249219732');" onmouseout="out('-6252467951249219732');" style=""> 503             List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();                                       </span>
<span class="-8689854403875612694" onmouseenter="enter('-8689854403875612694');" onmouseout="out('-8689854403875612694');" style=""> 504             for (Offer offer : offers) {                                                                 </span>
<span class="3344482016035270743" onmouseenter="enter('3344482016035270743');" onmouseout="out('3344482016035270743');" style=""> 505                 if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {           </span>
<span class="2965579239059640859" onmouseenter="enter('2965579239059640859');" onmouseout="out('2965579239059640859');" style=""> 506                     possibleFGOffers.add(offer);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 507                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 508             }                                                                                            </span>
<span class="7272445213685933500" onmouseenter="enter('7272445213685933500');" onmouseout="out('7272445213685933500');" style=""><abbr title=" 509             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer());"> 509             List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustðŸ”µ</abbr></span>
<span class="-380250791493510209" onmouseenter="enter('-380250791493510209');" onmouseout="out('-380250791493510209');" style=""><abbr title=" 510             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 510             List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCaðŸ”µ</abbr></span>
<span class="5471512156259214352" onmouseenter="enter('5471512156259214352');" onmouseout="out('5471512156259214352');" style=""> 511             for (Offer offer : filteredOffers) {                                                         </span>
<span class="6341701119621727258" onmouseenter="enter('6341701119621727258');" onmouseout="out('6341701119621727258');" style=""><abbr title=" 512                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 512                 fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifieðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 513             }                                                                                            </span>
<span class="6757974448768463" onmouseenter="enter('6757974448768463');" onmouseout="out('6757974448768463');" style=""> 514             if (!qualifiedFGOffers.isEmpty()) {                                                          </span>
<span class="-3737539762239464744" onmouseenter="enter('-3737539762239464744');" onmouseout="out('-3737539762239464744');" style=""><abbr title=" 515                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);"> 515                 fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotabðŸ”µ</abbr></span>
<span class="-1748187190347404908" onmouseenter="enter('-1748187190347404908');" onmouseout="out('-1748187190347404908');" style=""> 516                 fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);          </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 517                 orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 518             }                                                                                            </span>
<span class="-7204486914274790826" onmouseenter="enter('-7204486914274790826');" onmouseout="out('-7204486914274790826');" style=""> 519             return orderService.save(order, false);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 520         }                                                                                                </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 521         return order;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 522     }                                                                                                    </span>
<span  style=""> 523                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 524     @Override                                                                                            </span>
<span class="-8983195686564092827" onmouseenter="enter('-8983195686564092827');" onmouseout="out('-8983195686564092827');" style=""> 525     public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {                           </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 526         Customer customer = order.getCustomer();                                                         </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 527         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="-8305970541390666259" onmouseenter="enter('-8305970541390666259');" onmouseout="out('-8305970541390666259');" style=""><abbr title=" 528             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());"> 528             Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getIdðŸ”µ</abbr></span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 529             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 530                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 531             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 532         }                                                                                                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 533         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 534     }                                                                                                    </span>
<span  style=""> 535                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 536     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 537     @Override                                                                                            </span>
<span class="4849754295577860926" onmouseenter="enter('4849754295577860926');" onmouseout="out('4849754295577860926');" style=""> 538     public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {                     </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 539         if (offer.isLimitedUsePerCustomer()) {                                                           </span>
<span class="8084739095609490454" onmouseenter="enter('8084739095609490454');" onmouseout="out('8084739095609490454');" style=""> 540             Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());   </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 541             if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 542                 return false;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 543             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 544         }                                                                                                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 545         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 546     }                                                                                                    </span>
<span  style=""> 547                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 548     @Override                                                                                            </span>
<span class="-4305912419408886648" onmouseenter="enter('-4305912419408886648');" onmouseout="out('-4305912419408886648');" style=""> 549     public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {                        </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 550         boolean underCodeMaxUses = true;                                                                 </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 551         if (code.isLimitedUse()) {                                                                       </span>
<span class="-7378740545085856894" onmouseenter="enter('-7378740545085856894');" onmouseout="out('-7378740545085856894');" style=""> 552             Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());            </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 553             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 554         }                                                                                                </span>
<span class="5446263071698048925" onmouseenter="enter('5446263071698048925');" onmouseout="out('5446263071698048925');" style=""> 555         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 556     }                                                                                                    </span>
<span  style=""> 557                                                                                                          </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 558     @Deprecated                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 559     @Override                                                                                            </span>
<span class="135967723667379112" onmouseenter="enter('135967723667379112');" onmouseout="out('135967723667379112');" style=""> 560     public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {                  </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 561         boolean underCodeMaxUses = true;                                                                 </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 562         if (code.isLimitedUse()) {                                                                       </span>
<span class="5487567461678823803" onmouseenter="enter('5487567461678823803');" onmouseout="out('5487567461678823803');" style=""> 563             Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());                   </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 564             underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 565         }                                                                                                </span>
<span class="7193079189056024188" onmouseenter="enter('7193079189056024188');" onmouseout="out('7193079189056024188');" style=""> 566         return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 567     }                                                                                                    </span>
<span  style=""> 568                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 569     @Override                                                                                            </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 570     @SuppressWarnings(&quot;unchecked&quot;)                                                                       </span>
<span class="-640784293225096821" onmouseenter="enter('-640784293225096821');" onmouseout="out('-640784293225096821');" style=""> 571     public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {                                            </span>
<span class="-348027159212233091" onmouseenter="enter('-348027159212233091');" onmouseout="out('-348027159212233091');" style=""> 572         HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();                                                    </span>
<span class="-7949809618309864364" onmouseenter="enter('-7949809618309864364');" onmouseout="out('-7949809618309864364');" style=""> 573         Transformer adjustmentToOfferTransformer = new Transformer() {                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 574             @Override                                                                                    </span>
<span class="-2718541205900117239" onmouseenter="enter('-2718541205900117239');" onmouseout="out('-2718541205900117239');" style=""> 575             public Object transform(Object input) {                                                      </span>
<span class="3859601049004020554" onmouseenter="enter('3859601049004020554');" onmouseout="out('3859601049004020554');" style=""> 576                 return ((Adjustment) (input)).getOffer();                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 577             }                                                                                            </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 578         };                                                                                               </span>
<span class="-8370514600917699300" onmouseenter="enter('-8370514600917699300');" onmouseout="out('-8370514600917699300');" style=""><abbr title=" 579         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));"> 579         result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer))ðŸ”µ</abbr></span>
<span class="3897119298100986011" onmouseenter="enter('3897119298100986011');" onmouseout="out('3897119298100986011');" style=""> 580         if (order.getOrderItems() != null) {                                                             </span>
<span class="820796442257070700" onmouseenter="enter('820796442257070700');" onmouseout="out('820796442257070700');" style=""> 581             for (OrderItem item : order.getOrderItems()) {                                               </span>
<span class="722957474719034118" onmouseenter="enter('722957474719034118');" onmouseout="out('722957474719034118');" style=""><abbr title=" 582                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 582                 result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTrðŸ”µ</abbr></span>
<span class="-3519908190158496681" onmouseenter="enter('-3519908190158496681');" onmouseout="out('-3519908190158496681');" style=""> 583                 //record usage for price details on the item as well                                     </span>
<span class="-2952948196187271811" onmouseenter="enter('-2952948196187271811');" onmouseout="out('-2952948196187271811');" style=""> 584                 if (item.getOrderItemPriceDetails() != null) {                                           </span>
<span class="773323050474809935" onmouseenter="enter('773323050474809935');" onmouseout="out('773323050474809935');" style=""> 585                     for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {                </span>
<span class="7134713472391876911" onmouseenter="enter('7134713472391876911');" onmouseout="out('7134713472391876911');" style=""><abbr title=" 586                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 586                         result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments()ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 587                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 588                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 589             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 590         }                                                                                                </span>
<span class="7944520279780748823" onmouseenter="enter('7944520279780748823');" onmouseout="out('7944520279780748823');" style=""> 591         if (order.getFulfillmentGroups() != null) {                                                      </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 592             for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                   </span>
<span class="-293187079687761920" onmouseenter="enter('-293187079687761920');" onmouseout="out('-293187079687761920');" style=""><abbr title=" 593                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 593                 result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 594             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 595         }                                                                                                </span>
<span class="-6419540350677864751" onmouseenter="enter('-6419540350677864751');" onmouseout="out('-6419540350677864751');" style=""> 596         return result;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 597     }                                                                                                    </span>
<span  style=""> 598                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 599     @Override                                                                                            </span>
<span class="-7522872552093234294" onmouseenter="enter('-7522872552093234294');" onmouseout="out('-7522872552093234294');" style=""> 600     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order) {                              </span>
<span class="-1370687283458217641" onmouseenter="enter('-1370687283458217641');" onmouseout="out('-1370687283458217641');" style=""> 601         return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order)); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 602     }                                                                                                    </span>
<span  style=""> 603                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 604     @Override                                                                                            </span>
<span class="-6407317956511861474" onmouseenter="enter('-6407317956511861474');" onmouseout="out('-6407317956511861474');" style=""><abbr title=" 605     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {"> 605     public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffðŸ”µ</abbr></span>
<span class="-4490485247927949218" onmouseenter="enter('-4490485247927949218');" onmouseout="out('-4490485247927949218');" style=""> 606         HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();                  </span>
<span class="983580358500385861" onmouseenter="enter('983580358500385861');" onmouseout="out('983580358500385861');" style=""> 607         for (OfferCode code : codes) {                                                                   </span>
<span class="6305098044991751707" onmouseenter="enter('6305098044991751707');" onmouseout="out('6305098044991751707');" style=""> 608             if (appliedOffers.contains(code.getOffer())) {                                               </span>
<span class="3746501443462939384" onmouseenter="enter('3746501443462939384');" onmouseout="out('3746501443462939384');" style=""> 609                 offerToCodeMapping.put(code.getOffer(), code);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 610             }                                                                                            </span>
<span class="-240986298797431748" onmouseenter="enter('-240986298797431748');" onmouseout="out('-240986298797431748');" style=""> 611             List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();                            </span>
<span class="7454577566794152811" onmouseenter="enter('7454577566794152811');" onmouseout="out('7454577566794152811');" style=""> 612             extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);   </span>
<span class="-7985615425314556326" onmouseenter="enter('-7985615425314556326');" onmouseout="out('-7985615425314556326');" style=""> 613             for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {                       </span>
<span class="-808811284028256215" onmouseenter="enter('-808811284028256215');" onmouseout="out('-808811284028256215');" style=""> 614                 offerToCodeMapping.put(additionalOfferToBeApplied, code);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 615             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 616         }                                                                                                </span>
<span class="7175253914401568841" onmouseenter="enter('7175253914401568841');" onmouseout="out('7175253914401568841');" style=""> 617         return offerToCodeMapping;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 618     }                                                                                                    </span>
<span  style=""> 619                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 620     @Override                                                                                            </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 621     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="-1347767159915315738" onmouseenter="enter('-1347767159915315738');" onmouseout="out('-1347767159915315738');" style=""> 622     public Boolean deleteOfferCode(OfferCode code) {                                                     </span>
<span class="-5986603348121186173" onmouseenter="enter('-5986603348121186173');" onmouseout="out('-5986603348121186173');" style=""> 623         if (offerCodeDao.offerCodeIsUsed(code)) {                                                        </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 624             return false;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 625         }                                                                                                </span>
<span class="-9122073777393685295" onmouseenter="enter('-9122073777393685295');" onmouseout="out('-9122073777393685295');" style=""> 626         offerCodeDao.delete(code);                                                                       </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 627         return true;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 628     }                                                                                                    </span>
<span  style=""> 629                                                                                                          </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 630     @Transactional(&quot;blTransactionManager&quot;)                                                               </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 631     @Override                                                                                            </span>
<span class="-3816301958562278169" onmouseenter="enter('-3816301958562278169');" onmouseout="out('-3816301958562278169');" style=""> 632     public Offer duplicate(Long originalOfferId) {                                                       </span>
<span class="-5738299300293223874" onmouseenter="enter('-5738299300293223874');" onmouseout="out('-5738299300293223874');" style=""> 633         Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();                                   </span>
<span class="2715783386963629594" onmouseenter="enter('2715783386963629594');" onmouseout="out('2715783386963629594');" style=""> 634         copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);                                    </span>
<span class="-2013584672995219797" onmouseenter="enter('-2013584672995219797');" onmouseout="out('-2013584672995219797');" style=""> 635         return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 636     }                                                                                                    </span>
<span  style=""> 637                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 638     @Override                                                                                            </span>
<span class="3228088005821970316" onmouseenter="enter('3228088005821970316');" onmouseout="out('3228088005821970316');" style=""> 639     public CustomerOfferDao getCustomerOfferDao() {                                                      </span>
<span class="-801333879424417122" onmouseenter="enter('-801333879424417122');" onmouseout="out('-801333879424417122');" style=""> 640         return customerOfferDao;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 641     }                                                                                                    </span>
<span  style=""> 642                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 643     @Override                                                                                            </span>
<span class="6308179313298689001" onmouseenter="enter('6308179313298689001');" onmouseout="out('6308179313298689001');" style=""> 644     public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {                                 </span>
<span class="438520929977701037" onmouseenter="enter('438520929977701037');" onmouseout="out('438520929977701037');" style=""> 645         this.customerOfferDao = customerOfferDao;                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 646     }                                                                                                    </span>
<span  style=""> 647                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 648     @Override                                                                                            </span>
<span class="8266606365944954497" onmouseenter="enter('8266606365944954497');" onmouseout="out('8266606365944954497');" style=""> 649     public OfferCodeDao getOfferCodeDao() {                                                              </span>
<span class="-4005874311041664572" onmouseenter="enter('-4005874311041664572');" onmouseout="out('-4005874311041664572');" style=""> 650         return offerCodeDao;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 651     }                                                                                                    </span>
<span  style=""> 652                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 653     @Override                                                                                            </span>
<span class="-5083072655758254890" onmouseenter="enter('-5083072655758254890');" onmouseout="out('-5083072655758254890');" style=""> 654     public void setOfferCodeDao(OfferCodeDao offerCodeDao) {                                             </span>
<span class="-7060255547979502806" onmouseenter="enter('-7060255547979502806');" onmouseout="out('-7060255547979502806');" style=""> 655         this.offerCodeDao = offerCodeDao;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 656     }                                                                                                    </span>
<span  style=""> 657                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 658     @Override                                                                                            </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 659     public OfferDao getOfferDao() {                                                                      </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 660         return offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 661     }                                                                                                    </span>
<span  style=""> 662                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 663     @Override                                                                                            </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 664     public void setOfferDao(OfferDao offerDao) {                                                         </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 665         this.offerDao = offerDao;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 666     }                                                                                                    </span>
<span  style=""> 667                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 668     @Override                                                                                            </span>
<span class="3012408951835963759" onmouseenter="enter('3012408951835963759');" onmouseout="out('3012408951835963759');" style=""> 669     public OrderOfferProcessor getOrderOfferProcessor() {                                                </span>
<span class="-5069105522766505260" onmouseenter="enter('-5069105522766505260');" onmouseout="out('-5069105522766505260');" style=""> 670         return orderOfferProcessor;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 671     }                                                                                                    </span>
<span  style=""> 672                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 673     @Override                                                                                            </span>
<span class="-2542583147665382651" onmouseenter="enter('-2542583147665382651');" onmouseout="out('-2542583147665382651');" style=""> 674     public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {                        </span>
<span class="1533378703496715943" onmouseenter="enter('1533378703496715943');" onmouseout="out('1533378703496715943');" style=""> 675         this.orderOfferProcessor = orderOfferProcessor;                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 676     }                                                                                                    </span>
<span  style=""> 677                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 678     @Override                                                                                            </span>
<span class="1694843298235251985" onmouseenter="enter('1694843298235251985');" onmouseout="out('1694843298235251985');" style=""> 679     public ItemOfferProcessor getItemOfferProcessor() {                                                  </span>
<span class="1583504692330339191" onmouseenter="enter('1583504692330339191');" onmouseout="out('1583504692330339191');" style=""> 680         return itemOfferProcessor;                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 681     }                                                                                                    </span>
<span  style=""> 682                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 683     @Override                                                                                            </span>
<span class="145400756853488798" onmouseenter="enter('145400756853488798');" onmouseout="out('145400756853488798');" style=""> 684     public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {                           </span>
<span class="-102405468021411755" onmouseenter="enter('-102405468021411755');" onmouseout="out('-102405468021411755');" style=""> 685         this.itemOfferProcessor = itemOfferProcessor;                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 686     }                                                                                                    </span>
<span  style=""> 687                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 688     @Override                                                                                            </span>
<span class="3022939772369206873" onmouseenter="enter('3022939772369206873');" onmouseout="out('3022939772369206873');" style=""> 689     public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {                          </span>
<span class="-3088775944214719317" onmouseenter="enter('-3088775944214719317');" onmouseout="out('-3088775944214719317');" style=""> 690         return fulfillmentGroupOfferProcessor;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 691     }                                                                                                    </span>
<span  style=""> 692                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 693     @Override                                                                                            </span>
<span class="-8855456203149015957" onmouseenter="enter('-8855456203149015957');" onmouseout="out('-8855456203149015957');" style=""><abbr title=" 694     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {"> 694     public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProðŸ”µ</abbr></span>
<span class="-7108053920330155376" onmouseenter="enter('-7108053920330155376');" onmouseout="out('-7108053920330155376');" style=""> 695         this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 696     }                                                                                                    </span>
<span  style=""> 697                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 698     @Override                                                                                            </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 699     public PromotableItemFactory getPromotableItemFactory() {                                            </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 700         return promotableItemFactory;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 701     }                                                                                                    </span>
<span  style=""> 702                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 703     @Override                                                                                            </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 704     public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                  </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 705         this.promotableItemFactory = promotableItemFactory;                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 706     }                                                                                                    </span>
<span  style=""> 707                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 708     @Override                                                                                            </span>
<span class="-285725005067991728" onmouseenter="enter('-285725005067991728');" onmouseout="out('-285725005067991728');" style=""> 709     public OfferCode findOfferCodeById(Long id) {                                                        </span>
<span class="4928857363700364693" onmouseenter="enter('4928857363700364693');" onmouseout="out('4928857363700364693');" style=""> 710         return offerCodeDao.readOfferCodeById(id);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 711     }                                                                                                    </span>
<span  style=""> 712                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 713     @Override                                                                                            </span>
<span class="-6829155498814719074" onmouseenter="enter('-6829155498814719074');" onmouseout="out('-6829155498814719074');" style=""> 714     public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {                                   </span>
<span class="-1521639274006709657" onmouseenter="enter('-1521639274006709657');" onmouseout="out('-1521639274006709657');" style=""> 715         return offerCodeDao.readOfferCodesByIds(ids);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 716     }                                                                                                    </span>
<span  style=""> 717                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 718     @Override                                                                                            </span>
<span class="5587340050529616033" onmouseenter="enter('5587340050529616033');" onmouseout="out('5587340050529616033');" style=""> 719     public OrderService getOrderService() {                                                              </span>
<span class="-7558473787756148723" onmouseenter="enter('-7558473787756148723');" onmouseout="out('-7558473787756148723');" style=""> 720         return orderService;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 721     }                                                                                                    </span>
<span  style=""> 722                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 723     @Override                                                                                            </span>
<span class="4536819371590947172" onmouseenter="enter('4536819371590947172');" onmouseout="out('4536819371590947172');" style=""> 724     public void setOrderService(OrderService orderService) {                                             </span>
<span class="7368861914925934250" onmouseenter="enter('7368861914925934250');" onmouseout="out('7368861914925934250');" style=""> 725         this.orderService = orderService;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 726     }                                                                                                    </span>
<span  style=""> 727                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 728     @Override                                                                                            </span>
<span class="-2217088353489190987" onmouseenter="enter('-2217088353489190987');" onmouseout="out('-2217088353489190987');" style=""> 729     public Offer findOfferById(Long offerId) {                                                           </span>
<span class="-5171648678549667040" onmouseenter="enter('-5171648678549667040');" onmouseout="out('-5171648678549667040');" style=""> 730         return offerDao.readOfferById(offerId);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 731     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 732 }                                                                                                        </span>




















































</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3   * BroadleafCommerce Framework                                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18  package org.broadleafcommerce.core.offer.service;                                                                 </span>
<span  style="">  19                                                                                                                    </span>
<span class="8596464405353709537" onmouseenter="enter('8596464405353709537');" onmouseout="out('8596464405353709537');" style="">  20  import org.apache.commons.collections.CollectionUtils;                                                            </span>
<span class="2953846583056246827" onmouseenter="enter('2953846583056246827');" onmouseout="out('2953846583056246827');" style="">  21  import org.apache.commons.collections.Transformer;                                                                </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  22  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  23  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="-2193028153657877676" onmouseenter="enter('-2193028153657877676');" onmouseout="out('-2193028153657877676');" style="">  24  import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;                                          </span>
<span class="-3349026188166660873" onmouseenter="enter('-3349026188166660873');" onmouseout="out('-3349026188166660873');" style="">  25  import org.broadleafcommerce.common.persistence.EntityDuplicator;                                                 </span>
<span class="-2818686525334833130" onmouseenter="enter('-2818686525334833130');" onmouseout="out('-2818686525334833130');" style="">  26  import org.broadleafcommerce.common.sandbox.SandBoxHelper;                                                        </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  27  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                              </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  28  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                         </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  29  import org.broadleafcommerce.common.web.BroadleafRequestContext;                                                  </span>
<span class="6205208880685044389" onmouseenter="enter('6205208880685044389');" onmouseout="out('6205208880685044389');" style="">  30  import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;                                                     </span>
<span class="-7911436562744873568" onmouseenter="enter('-7911436562744873568');" onmouseout="out('-7911436562744873568');" style="">  31  import org.broadleafcommerce.core.offer.dao.OfferCodeDao;                                                         </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  32  import org.broadleafcommerce.core.offer.dao.OfferDao;                                                             </span>
<span class="-1633608357492319903" onmouseenter="enter('-1633608357492319903');" onmouseout="out('-1633608357492319903');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  33 -import org.broadleafcommerce.core.offer.domain.Adjustment;                                                        </span>
<span class="984981432680799531" onmouseenter="enter('984981432680799531');" onmouseout="out('984981432680799531');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  34 -import org.broadleafcommerce.core.offer.domain.CustomerOffer;                                                     </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  35 -import org.broadleafcommerce.core.offer.domain.Offer;                                                             </span>
<span class="1521662235446319191" onmouseenter="enter('1521662235446319191');" onmouseout="out('1521662235446319191');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  36 -import org.broadleafcommerce.core.offer.domain.OfferCode;                                                         </span>
<span class="-7025591891527881733" onmouseenter="enter('-7025591891527881733');" onmouseout="out('-7025591891527881733');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  37 -import org.broadleafcommerce.core.offer.domain.OfferImpl;                                                         </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  38 -import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                                    </span>
<span class="-91689670446949346" onmouseenter="enter('-91689670446949346');" onmouseout="out('-91689670446949346');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +import org.broadleafcommerce.core.offer.domain.*;                                                                 </span>
<span class="4287099423657810905" onmouseenter="enter('4287099423657810905');" onmouseout="out('4287099423657810905');" style="">  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;         </span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;                     </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;                    </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  43  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                            </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  44  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                                  </span>
<span class="5713212224635448284" onmouseenter="enter('5713212224635448284');" onmouseout="out('5713212224635448284');" style="">  45  import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;                         </span>
<span class="-2454758753718589449" onmouseenter="enter('-2454758753718589449');" onmouseout="out('-2454758753718589449');" style="">  46  import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;                                     </span>
<span class="8227287359407176835" onmouseenter="enter('8227287359407176835');" onmouseout="out('8227287359407176835');" style="">  47  import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;                                    </span>
<span class="-5727938558534008634" onmouseenter="enter('-5727938558534008634');" onmouseout="out('-5727938558534008634');" style="">  48  import org.broadleafcommerce.core.offer.service.type.OfferType;                                                   </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  49  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                                  </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  50  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  51  import org.broadleafcommerce.core.order.domain.OrderItem;                                                         </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  52  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                              </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  53  import org.broadleafcommerce.core.order.service.OrderService;                                                     </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  54  import org.broadleafcommerce.core.pricing.service.exception.PricingException;                                     </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  55  import org.broadleafcommerce.profile.core.domain.Customer;                                                        </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  56  import org.springframework.stereotype.Service;                                                                    </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  57  import org.springframework.transaction.annotation.Transactional;                                                  </span>
<span  style="">  58                                                                                                                    </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  59  import java.util.ArrayList;                                                                                       </span>
<span class="-112105277767313938" onmouseenter="enter('-112105277767313938');" onmouseout="out('-112105277767313938');" style="">  60  import java.util.Collection;                                                                                      </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  61  import java.util.HashMap;                                                                                         </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  62  import java.util.HashSet;                                                                                         </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  63  import java.util.Iterator;                                                                                        </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  64  import java.util.List;                                                                                            </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  65  import java.util.Map;                                                                                             </span>
<span class="6306724220981822255" onmouseenter="enter('6306724220981822255');" onmouseout="out('6306724220981822255');" style="">  66  import java.util.Objects;                                                                                         </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  67  import java.util.Set;                                                                                             </span>
<span  style="">  68                                                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  69  import javax.annotation.Resource;                                                                                 </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  70  import javax.persistence.EntityManager;                                                                           </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  71  import javax.persistence.PersistenceContext;                                                                      </span>
<span  style="">  72                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  73  /**                                                                                                               </span>
<span class="-2667338179687874348" onmouseenter="enter('-2667338179687874348');" onmouseout="out('-2667338179687874348');" style="">  74   * The Class OfferServiceImpl.                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  75   */                                                                                                               </span>
<span class="504450232350438262" onmouseenter="enter('504450232350438262');" onmouseout="out('504450232350438262');" style="">  76  @Service(&quot;blOfferService&quot;)                                                                                        </span>
<span class="6786430150403502423" onmouseenter="enter('6786430150403502423');" onmouseout="out('6786430150403502423');" style="">  77  public class OfferServiceImpl implements OfferService {                                                           </span>
<span  style="">  78                                                                                                                    </span>
<span class="8897944981470617719" onmouseenter="enter('8897944981470617719');" onmouseout="out('8897944981470617719');" style="">  79      private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);                                     </span>
<span class="1923365470115514932" onmouseenter="enter('1923365470115514932');" onmouseout="out('1923365470115514932');" style="">  80      public static final String FINALIZE_CHECKOUT = &quot;FINALIZE_CHECKOUT&quot;;                                           </span>
<span class="2963930970649904799" onmouseenter="enter('2963930970649904799');" onmouseout="out('2963930970649904799');" style="">  81      public static final String OFFERS_EXPIRED = &quot;OFFERS_EXPIRED&quot;;                                                 </span>
<span  style="">  82                                                                                                                    </span>
<span class="3846751699212951796" onmouseenter="enter('3846751699212951796');" onmouseout="out('3846751699212951796');" style="">  83      // should be called outside of Offer service after Offer service is executed                                  </span>
<span class="-5484979233832760683" onmouseenter="enter('-5484979233832760683');" onmouseout="out('-5484979233832760683');" style="">  84      @Resource(name=&quot;blCustomerOfferDao&quot;)                                                                          </span>
<span class="-5771823415174942027" onmouseenter="enter('-5771823415174942027');" onmouseout="out('-5771823415174942027');" style="">  85      protected CustomerOfferDao customerOfferDao;                                                                  </span>
<span  style="">  86                                                                                                                    </span>
<span class="-1524144969871346405" onmouseenter="enter('-1524144969871346405');" onmouseout="out('-1524144969871346405');" style="">  87      @Resource(name=&quot;blOfferCodeDao&quot;)                                                                              </span>
<span class="-6984238934820524758" onmouseenter="enter('-6984238934820524758');" onmouseout="out('-6984238934820524758');" style="">  88      protected OfferCodeDao offerCodeDao;                                                                          </span>
<span  style="">  89                                                                                                                    </span>
<span class="-8247969455122443370" onmouseenter="enter('-8247969455122443370');" onmouseout="out('-8247969455122443370');" style="">  90      @Resource(name=&quot;blOfferAuditService&quot;)                                                                         </span>
<span class="-6742419488595856311" onmouseenter="enter('-6742419488595856311');" onmouseout="out('-6742419488595856311');" style="">  91      protected OfferAuditService offerAuditService;                                                                </span>
<span  style="">  92                                                                                                                    </span>
<span class="-6976077299079381435" onmouseenter="enter('-6976077299079381435');" onmouseout="out('-6976077299079381435');" style="">  93      @Resource(name=&quot;blOfferDao&quot;)                                                                                  </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  94      protected OfferDao offerDao;                                                                                  </span>
<span  style="">  95                                                                                                                    </span>
<span class="-3191658961867656636" onmouseenter="enter('-3191658961867656636');" onmouseout="out('-3191658961867656636');" style="">  96      @Resource(name=&quot;blOrderOfferProcessor&quot;)                                                                       </span>
<span class="-3818126380928091101" onmouseenter="enter('-3818126380928091101');" onmouseout="out('-3818126380928091101');" style="">  97      protected OrderOfferProcessor orderOfferProcessor;                                                            </span>
<span  style="">  98                                                                                                                    </span>
<span class="-6223428528083119866" onmouseenter="enter('-6223428528083119866');" onmouseout="out('-6223428528083119866');" style="">  99      @Resource(name=&quot;blItemOfferProcessor&quot;)                                                                        </span>
<span class="-7827297227357944415" onmouseenter="enter('-7827297227357944415');" onmouseout="out('-7827297227357944415');" style=""> 100      protected ItemOfferProcessor itemOfferProcessor;                                                              </span>
<span  style=""> 101                                                                                                                    </span>
<span class="-1476654469985531605" onmouseenter="enter('-1476654469985531605');" onmouseout="out('-1476654469985531605');" style=""> 102      @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)                                                            </span>
<span class="7634983124983010999" onmouseenter="enter('7634983124983010999');" onmouseout="out('7634983124983010999');" style=""> 103      protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;                                      </span>
<span  style=""> 104                                                                                                                    </span>
<span class="-4330844585159307437" onmouseenter="enter('-4330844585159307437');" onmouseout="out('-4330844585159307437');" style=""> 105      @Resource(name=&quot;blPromotableItemFactory&quot;)                                                                     </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style=""> 106      protected PromotableItemFactory promotableItemFactory;                                                        </span>
<span  style=""> 107                                                                                                                    </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style=""> 108      @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                            </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style=""> 109      protected OfferServiceExtensionManager extensionManager;                                                      </span>
<span  style=""> 110                                                                                                                    </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 111      @Resource(name = &quot;blOrderService&quot;)                                                                            </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 112      protected OrderService orderService;                                                                          </span>
<span  style=""> 113                                                                                                                    </span>
<span class="-3946461589801993391" onmouseenter="enter('-3946461589801993391');" onmouseout="out('-3946461589801993391');" style=""> 114      @Resource(name = &quot;blSandBoxHelper&quot;)                                                                           </span>
<span class="-7799183597372200632" onmouseenter="enter('-7799183597372200632');" onmouseout="out('-7799183597372200632');" style=""> 115      protected SandBoxHelper sandBoxHelper;                                                                        </span>
<span  style=""> 116                                                                                                                    </span>
<span class="-4259734795637808055" onmouseenter="enter('-4259734795637808055');" onmouseout="out('-4259734795637808055');" style=""> 117      @PersistenceContext(unitName=&quot;blPU&quot;)                                                                          </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style=""> 118      protected EntityManager em;                                                                                   </span>
<span  style=""> 119                                                                                                                    </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 120      @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                           </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 121      protected StreamingTransactionCapableUtil transUtil;                                                          </span>
<span  style=""> 122                                                                                                                    </span>
<span class="-8384326529234094002" onmouseenter="enter('-8384326529234094002');" onmouseout="out('-8384326529234094002');" style=""> 123      @Resource(name=&quot;blEntityDuplicator&quot;)                                                                          </span>
<span class="-9194612273021432316" onmouseenter="enter('-9194612273021432316');" onmouseout="out('-9194612273021432316');" style=""> 124      protected EntityDuplicator duplicator;                                                                        </span>
<span  style=""> 125                                                                                                                    </span>
<span class="723166851410757036" onmouseenter="enter('723166851410757036');" onmouseout="out('723166851410757036');" style=""> 126      @Resource(name=&quot;blOfferDuplicateModifier&quot;)                                                                    </span>
<span class="8658910844320022950" onmouseenter="enter('8658910844320022950');" onmouseout="out('8658910844320022950');" style=""> 127      protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;                                              </span>
<span  style=""> 128                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 129      @Override                                                                                                     </span>
<span class="-2033305286790048708" onmouseenter="enter('-2033305286790048708');" onmouseout="out('-2033305286790048708');" style=""> 130      public List&lt;Offer&gt; findAllOffers() {                                                                          </span>
<span class="2132174063530273788" onmouseenter="enter('2132174063530273788');" onmouseout="out('2132174063530273788');" style=""> 131          return offerDao.readAllOffers();                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 132      }                                                                                                             </span>
<span  style=""> 133                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 134      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 135      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="7144811092176845141" onmouseenter="enter('7144811092176845141');" onmouseout="out('7144811092176845141');" style=""> 136      public Offer save(Offer offer) {                                                                              </span>
<span class="-264708178039771798" onmouseenter="enter('-264708178039771798');" onmouseout="out('-264708178039771798');" style=""> 137          return offerDao.save(offer);                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 138      }                                                                                                             </span>
<span  style=""> 139                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 140      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 141      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-5514670765130856091" onmouseenter="enter('-5514670765130856091');" onmouseout="out('-5514670765130856091');" style=""> 142      public OfferCode saveOfferCode(OfferCode offerCode) {                                                         </span>
<span class="3125778008044685658" onmouseenter="enter('3125778008044685658');" onmouseout="out('3125778008044685658');" style=""> 143          offerCode.setOffer(offerDao.save(offerCode.getOffer()));                                                  </span>
<span class="6906137479190051982" onmouseenter="enter('6906137479190051982');" onmouseout="out('6906137479190051982');" style=""> 144          return offerCodeDao.save(offerCode);                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145      }                                                                                                             </span>
<span  style=""> 146                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 147      /**                                                                                                           </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""> 148       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,        </span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""> 149       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer        </span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 150       * cannot appear more than once in the list.                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 151       *                                                                                                            </span>
<span class="-709313334493645866" onmouseenter="enter('-709313334493645866');" onmouseout="out('-709313334493645866');" style=""> 152       * @param code                                                                                                </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 153       * @return a List of offers that may apply to this order                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 154       */                                                                                                           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 155      @Override                                                                                                     </span>
<span class="-6840847083603451180" onmouseenter="enter('-6840847083603451180');" onmouseout="out('-6840847083603451180');" style=""> 156      public Offer lookupOfferByCode(String code) {                                                                 </span>
<span class="-531732708503781646" onmouseenter="enter('-531732708503781646');" onmouseout="out('-531732708503781646');" style=""> 157          Offer offer = null;                                                                                       </span>
<span class="-8218576552188075283" onmouseenter="enter('-8218576552188075283');" onmouseout="out('-8218576552188075283');" style=""> 158          OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);                                             </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 159          if (offerCode != null) {                                                                                  </span>
<span class="-2561785727340284423" onmouseenter="enter('-2561785727340284423');" onmouseout="out('-2561785727340284423');" style=""> 160              offer = offerCode.getOffer();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161          }                                                                                                         </span>
<span class="-8963791522625561917" onmouseenter="enter('-8963791522625561917');" onmouseout="out('-8963791522625561917');" style=""> 162          return offer;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 163      }                                                                                                             </span>
<span  style=""> 164                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 165      @Override                                                                                                     </span>
<span class="2883322601430833612" onmouseenter="enter('2883322601430833612');" onmouseout="out('2883322601430833612');" style=""> 166      public OfferCode lookupOfferCodeByCode(String code){                                                          </span>
<span class="8795189428566002896" onmouseenter="enter('8795189428566002896');" onmouseout="out('8795189428566002896');" style=""> 167          return offerCodeDao.readOfferCodeByCode(code);                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168      }                                                                                                             </span>
<span  style=""> 169                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 170      @Override                                                                                                     </span>
<span class="-2543778591938191529" onmouseenter="enter('-2543778591938191529');" onmouseout="out('-2543778591938191529');" style=""> 171      public List&lt;Offer&gt; lookupAllOffersByCode(String code) {                                                       </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 172          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                              </span>
<span class="-3360697953765841703" onmouseenter="enter('-3360697953765841703');" onmouseout="out('-3360697953765841703');" style=""> 173          List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);                                  </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 174          for (OfferCode offerCode : offerCodes) {                                                                  </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 175              if (offerCode != null) {                                                                              </span>
<span class="-7816274075460376657" onmouseenter="enter('-7816274075460376657');" onmouseout="out('-7816274075460376657');" style=""> 176                  offers.add(offerCode.getOffer());                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 177              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 178          }                                                                                                         </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 179          return offers;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180      }                                                                                                             </span>
<span  style=""> 181                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 182      @Override                                                                                                     </span>
<span class="4676855439599320404" onmouseenter="enter('4676855439599320404');" onmouseout="out('4676855439599320404');" style=""> 183      public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){                                                </span>
<span class="-4234235759448675045" onmouseenter="enter('-4234235759448675045');" onmouseout="out('-4234235759448675045');" style=""> 184          return offerCodeDao.readAllOfferCodesByCode(code);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185      }                                                                                                             </span>
<span  style=""> 186                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 187      /**                                                                                                           </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""> 188       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,        </span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""> 189       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer        </span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 190       * cannot appear more than once in the list.                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 191       *                                                                                                            </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 192       * @param order                                                                                               </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 193       * @return a List of offers that may apply to this order                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 194       */                                                                                                           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 195      @Override                                                                                                     </span>
<span class="-5814298891852821500" onmouseenter="enter('-5814298891852821500');" onmouseout="out('-5814298891852821500');" style=""> 196      public List&lt;Offer&gt; buildOfferListForOrder(Order order) {                                                      </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 197          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                              </span>
<span class="-3235900677601494398" onmouseenter="enter('-3235900677601494398');" onmouseout="out('-3235900677601494398');" style=""> 198          List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());                  </span>
<span class="7699769166343685501" onmouseenter="enter('7699769166343685501');" onmouseout="out('7699769166343685501');" style=""> 199          for (CustomerOffer customerOffer : customerOffers) {                                                      </span>
<span class="-2310400538171319838" onmouseenter="enter('-2310400538171319838');" onmouseout="out('-2310400538171319838');" style=""> 200              if (!offers.contains(customerOffer.getOffer())) {                                                     </span>
<span class="5233078073066950969" onmouseenter="enter('5233078073066950969');" onmouseout="out('5233078073066950969');" style=""> 201                  offers.add(customerOffer.getOffer());                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 202              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 203          }                                                                                                         </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 204          List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                                   </span>
<span class="-5394428663749604022" onmouseenter="enter('-5394428663749604022');" onmouseout="out('-5394428663749604022');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 205 -        int before = orderOfferCodes.size();                                                                      </span>
<span class="-6665865767746694239" onmouseenter="enter('-6665865767746694239');" onmouseout="out('-6665865767746694239');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 206 -        orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                             </span>
<span class="8766753228261658218" onmouseenter="enter('8766753228261658218');" onmouseout="out('8766753228261658218');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 207 -        int after = orderOfferCodes.size();                                                                       </span>
<span class="-7332519531441163733" onmouseenter="enter('-7332519531441163733');" onmouseout="out('-7332519531441163733');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +//        int before = orderOfferCodes.size();                                                                    </span>
<span class="1955749666612820833" onmouseenter="enter('1955749666612820833');" onmouseout="out('1955749666612820833');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +//        orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                           </span>
<span class="-6467003552280566260" onmouseenter="enter('-6467003552280566260');" onmouseout="out('-6467003552280566260');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +/*        int after = orderOfferCodes.size();                                                                     </span>
<span class="2182795146752320946" onmouseenter="enter('2182795146752320946');" onmouseout="out('2182795146752320946');" style=""><abbr title=" 211          Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 211          Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHEðŸ”µ</abbr></span>
<span class="3842576300509712789" onmouseenter="enter('3842576300509712789');" onmouseout="out('3842576300509712789');" style=""> 212          if(o !=null &amp;&amp; (Boolean)o &amp;&amp; before!=after){                                                              </span>
<span class="-3668454086264686215" onmouseenter="enter('-3668454086264686215');" onmouseout="out('-3668454086264686215');" style=""><abbr title=" 213              BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 213              BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 214 -        }                                                                                                         </span>
<span class="-2684617365274670769" onmouseenter="enter('-2684617365274670769');" onmouseout="out('-2684617365274670769');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +        }*/                                                                                                       </span>
<span class="2682597879629079185" onmouseenter="enter('2682597879629079185');" onmouseout="out('2682597879629079185');" style=""> 216          for (OfferCode orderOfferCode : orderOfferCodes) {                                                        </span>
<span class="-1857624084667800558" onmouseenter="enter('-1857624084667800558');" onmouseout="out('-1857624084667800558');" style=""> 217              if (!offers.contains(orderOfferCode.getOffer())) {                                                    </span>
<span class="4188766124804405127" onmouseenter="enter('4188766124804405127');" onmouseout="out('4188766124804405127');" style=""> 218                  offers.add(orderOfferCode.getOffer());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 219              }                                                                                                     </span>
<span class="-4468546552745233084" onmouseenter="enter('-4468546552745233084');" onmouseout="out('-4468546552745233084');" style=""> 220              extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221          }                                                                                                         </span>
<span class="-9188634082558155234" onmouseenter="enter('-9188634082558155234');" onmouseout="out('-9188634082558155234');" style=""> 222          List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();                                               </span>
<span class="-8411171878687156520" onmouseenter="enter('-8411171878687156520');" onmouseout="out('-8411171878687156520');" style=""> 223          for (Offer globalOffer : globalOffers) {                                                                  </span>
<span class="2071278729839157974" onmouseenter="enter('2071278729839157974');" onmouseout="out('2071278729839157974');" style=""> 224              if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {           </span>
<span class="-3050025518373868772" onmouseenter="enter('-3050025518373868772');" onmouseout="out('-3050025518373868772');" style=""> 225                  offers.add(globalOffer);                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 226              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 227          }                                                                                                         </span>
<span  style=""> 228                                                                                                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 229          if (extensionManager != null) {                                                                           </span>
<span class="1817402996237899777" onmouseenter="enter('1817402996237899777');" onmouseout="out('1817402996237899777');" style=""> 230              extensionManager.applyAdditionalFilters(offers, order);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 231          }                                                                                                         </span>
<span  style=""> 232                                                                                                                    </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 233          return offers;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234      }                                                                                                             </span>
<span  style=""> 235                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 236      @Override                                                                                                     </span>
<span class="2056305643902587707" onmouseenter="enter('2056305643902587707');" onmouseout="out('2056305643902587707');" style=""> 237      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {                                           </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 238          Customer customer = order.getCustomer();                                                                  </span>
<span class="-5041998041456755776" onmouseenter="enter('-5041998041456755776');" onmouseout="out('-5041998041456755776');" style=""> 239          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();                                                      </span>
<span  style=""> 240                                                                                                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 241          if (extensionManager != null) {                                                                           </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 242              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 243          }                                                                                                         </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 244          if (!offerCodes.isEmpty()) {                                                                              </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 245              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                                      </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 246              while (itr.hasNext()) {                                                                               </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 247                  OfferCode offerCode = itr.next();                                                                 </span>
<span class="-776136422183497161" onmouseenter="enter('-776136422183497161');" onmouseout="out('-776136422183497161');" style=""> 248                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {                </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 249                      itr.remove();                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 250                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 252          }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 253          return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 254      }                                                                                                             </span>
<span  style=""> 255                                                                                                                    </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 256      @Deprecated                                                                                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 257      @Override                                                                                                     </span>
<span class="3843851677430304310" onmouseenter="enter('3843851677430304310');" onmouseout="out('3843851677430304310');" style=""> 258      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {                                     </span>
<span class="-6957816096303048614" onmouseenter="enter('-6957816096303048614');" onmouseout="out('-6957816096303048614');" style=""> 259          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();                                             </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 260          if (extensionManager != null) {                                                                           </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 261              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 262          }                                                                                                         </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 263          if (!offerCodes.isEmpty()) {                                                                              </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 264              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                                      </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 265              while (itr.hasNext()) {                                                                               </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 266                  OfferCode offerCode = itr.next();                                                                 </span>
<span class="6086018267170409432" onmouseenter="enter('6086018267170409432');" onmouseout="out('6086018267170409432');" style=""> 267                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {             </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 268                      itr.remove();                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 269                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 270              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 271          }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 272          return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 273      }                                                                                                             </span>
<span  style=""> 274                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 275      /**                                                                                                           </span>
<span class="2837560355574155003" onmouseenter="enter('2837560355574155003');" onmouseout="out('2837560355574155003');" style=""> 276       * Private method used to retrieve all offers assigned to this customer.  These offers are                    </span>
<span class="4852710310174118924" onmouseenter="enter('4852710310174118924');" onmouseout="out('4852710310174118924');" style=""> 277       * programmatically assigned to the customer.                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 278       *                                                                                                            </span>
<span class="1094425505394812731" onmouseenter="enter('1094425505394812731');" onmouseout="out('1094425505394812731');" style=""> 279       * @param customer                                                                                            </span>
<span class="-3868237647402015492" onmouseenter="enter('-3868237647402015492');" onmouseout="out('-3868237647402015492');" style=""> 280       * @return a List of offers assigned to the customer                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 281       */                                                                                                           </span>
<span class="-1064959765029423996" onmouseenter="enter('-1064959765029423996');" onmouseout="out('-1064959765029423996');" style=""> 282      protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {                              </span>
<span class="1699675085073278700" onmouseenter="enter('1699675085073278700');" onmouseout="out('1699675085073278700');" style=""> 283          List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);             </span>
<span class="5611761187435301880" onmouseenter="enter('5611761187435301880');" onmouseout="out('5611761187435301880');" style=""> 284          return offerCustomers;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285      }                                                                                                             </span>
<span  style=""> 286                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 287      /**                                                                                                           </span>
<span class="-8831229104457932482" onmouseenter="enter('-8831229104457932482');" onmouseout="out('-8831229104457932482');" style=""> 288       * Private method used to retrieve all offers with automaticallyAdded set to true                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 289       *                                                                                                            </span>
<span class="-2057313490179191281" onmouseenter="enter('-2057313490179191281');" onmouseout="out('-2057313490179191281');" style=""> 290       * @return a List of automatic delivery offers                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 291       */                                                                                                           </span>
<span class="-9186908469762752320" onmouseenter="enter('-9186908469762752320');" onmouseout="out('-9186908469762752320');" style=""> 292      protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {                                                       </span>
<span class="-2657712449795339218" onmouseenter="enter('-2657712449795339218');" onmouseout="out('-2657712449795339218');" style=""> 293          List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();                                  </span>
<span class="-7738403477037597046" onmouseenter="enter('-7738403477037597046');" onmouseout="out('-7738403477037597046');" style=""> 294          return globalOffers;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 295      }                                                                                                             </span>
<span  style=""> 296                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 297      /**                                                                                                           </span>
<span class="-582485916100204765" onmouseenter="enter('-582485916100204765');" onmouseout="out('-582485916100204765');" style=""> 298       * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end                    </span>
<span class="-591413864231465226" onmouseenter="enter('-591413864231465226');" onmouseout="out('-591413864231465226');" style=""> 299       * date.  If an offerCode has a later start date, that offerCode will be removed.                             </span>
<span class="-1600892852414517397" onmouseenter="enter('-1600892852414517397');" onmouseout="out('-1600892852414517397');" style=""> 300       * OfferCodes without a start date will still be processed. If the offerCode                                  </span>
<span class="-6972954356288154926" onmouseenter="enter('-6972954356288154926');" onmouseout="out('-6972954356288154926');" style=""> 301       * has a end date that has already passed, that offerCode will be removed.  OfferCodes                        </span>
<span class="-7007360996659097530" onmouseenter="enter('-7007360996659097530');" onmouseout="out('-7007360996659097530');" style=""> 302       * without a end date will be processed.  The start and end dates on the offer will                           </span>
<span class="-216139196908541615" onmouseenter="enter('-216139196908541615');" onmouseout="out('-216139196908541615');" style=""> 303       * still need to be evaluated.                                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 304       *                                                                                                            </span>
<span class="-142155654396048960" onmouseenter="enter('-142155654396048960');" onmouseout="out('-142155654396048960');" style=""> 305       * @param offerCodes                                                                                          </span>
<span class="-7645314644020819692" onmouseenter="enter('-7645314644020819692');" onmouseout="out('-7645314644020819692');" style=""> 306       * @return a List of non-expired offers                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 307       */                                                                                                           </span>
<span class="3097073257270455619" onmouseenter="enter('3097073257270455619');" onmouseout="out('3097073257270455619');" style=""> 308      protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){                              </span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 309          List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                          </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 310          for (OfferCode offerCode : offerCodes) {                                                                  </span>
<span class="4179739580098873664" onmouseenter="enter('4179739580098873664');" onmouseout="out('4179739580098873664');" style=""> 311              if (!offerCode.isActive()){                                                                           </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 312                  offerCodesToRemove.add(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 313              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 314          }                                                                                                         </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 315          // remove all offers in the offersToRemove list from original offers list                                 </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 316          for (OfferCode offerCode : offerCodesToRemove) {                                                          </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 317              offerCodes.remove(offerCode);                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +        }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +        return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +                                                                                                                  </span>
<span class="4108048093343952474" onmouseenter="enter('4108048093343952474');" onmouseout="out('4108048093343952474');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +    protected List&lt;OfferCode&gt; removeOutOfDateOfferCodesAndOffers(List&lt;OfferCode&gt; offerCodes, List&lt;Offer&gt; offers){ </span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +        List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                          </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +        for (OfferCode offerCode : offerCodes) {                                                                  </span>
<span class="4179739580098873664" onmouseenter="enter('4179739580098873664');" onmouseout="out('4179739580098873664');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +            if (!offerCode.isActive()){                                                                           </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +                offerCodesToRemove.add(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +        }                                                                                                         </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +        // remove all offers in the offersToRemove list from original offers list                                 </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +        for (OfferCode offerCode : offerCodesToRemove) {                                                          </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +            offerCodes.remove(offerCode);                                                                         </span>
<span class="-6904171993325612449" onmouseenter="enter('-6904171993325612449');" onmouseout="out('-6904171993325612449');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +            offers.remove(offerCode.getOffer());                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 333          }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 334          return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 335      }                                                                                                             </span>
<span  style=""> 336                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 337      /**                                                                                                           </span>
<span class="5637961435104982406" onmouseenter="enter('5637961435104982406');" onmouseout="out('5637961435104982406');" style=""> 338       * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with                </span>
<span class="1724276086246688719" onmouseenter="enter('1724276086246688719');" onmouseout="out('1724276086246688719');" style=""> 339       * current sandbox status.                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 340       *                                                                                                            </span>
<span class="202872854140107873" onmouseenter="enter('202872854140107873');" onmouseout="out('202872854140107873');" style=""> 341       * @param order the order to check                                                                            </span>
<span class="2772482249434351691" onmouseenter="enter('2772482249434351691');" onmouseout="out('2772482249434351691');" style=""> 342       * @return the refreshed list of OfferCodes                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 343       */                                                                                                           </span>
<span class="7210051143895905366" onmouseenter="enter('7210051143895905366');" onmouseout="out('7210051143895905366');" style=""> 344      protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {                                  </span>
<span class="7464496307728629396" onmouseenter="enter('7464496307728629396');" onmouseout="out('7464496307728629396');" style=""> 345          final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();                                       </span>
<span  style=""> 346                                                                                                                    </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 347          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 348              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 349              public void execute() {                                                                               </span>
<span class="-6058145000184664425" onmouseenter="enter('-6058145000184664425');" onmouseout="out('-6058145000184664425');" style=""> 350                  for (OfferCode offerCode : orderOfferCodes) {                                                     </span>
<span class="-4263515828536000223" onmouseenter="enter('-4263515828536000223');" onmouseout="out('-4263515828536000223');" style=""> 351                      if (offerCode.getOffer() != null) {                                                           </span>
<span class="8507823172595815939" onmouseenter="enter('8507823172595815939');" onmouseout="out('8507823172595815939');" style=""><abbr title=" 352                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 352                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOfðŸ”µ</abbr></span>
<span class="-4217337457935304447" onmouseenter="enter('-4217337457935304447');" onmouseout="out('-4217337457935304447');" style=""><abbr title=" 353                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 353                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getðŸ”µ</abbr></span>
<span class="-6104864632261418874" onmouseenter="enter('-6104864632261418874');" onmouseout="out('-6104864632261418874');" style=""> 354                              em.refresh(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 355                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 356                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 357                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 358              }                                                                                                     </span>
<span  style=""> 359                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 360              @Override                                                                                             </span>
<span class="1336357167460974281" onmouseenter="enter('1336357167460974281');" onmouseout="out('1336357167460974281');" style=""> 361              public boolean shouldRetryOnTransactionLockAcquisitionFailure() {                                     </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 362                  return true;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 363              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 364          }, RuntimeException.class);                                                                               </span>
<span  style=""> 365                                                                                                                    </span>
<span class="720292142172901868" onmouseenter="enter('720292142172901868');" onmouseout="out('720292142172901868');" style=""> 366          return orderOfferCodes;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 367      }                                                                                                             </span>
<span  style=""> 368                                                                                                                    </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 369      /*                                                                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 370       *                                                                                                            </span>
<span class="-1078885518483632555" onmouseenter="enter('-1078885518483632555');" onmouseout="out('-1078885518483632555');" style=""> 371       * Offers Logic:                                                                                              </span>
<span class="-6544489594486398439" onmouseenter="enter('-6544489594486398439');" onmouseout="out('-6544489594486398439');" style=""> 372       * 1) Remove all existing offers in the Order (order, item, and fulfillment)                                  </span>
<span class="472654013095872963" onmouseenter="enter('472654013095872963');" onmouseout="out('472654013095872963');" style=""> 373       * 2) Check and remove offers                                                                                 </span>
<span class="8111384560802328496" onmouseenter="enter('8111384560802328496');" onmouseout="out('8111384560802328496');" style=""> 374       *    a) Remove out of date offers                                                                            </span>
<span class="3025649188866691570" onmouseenter="enter('3025649188866691570');" onmouseout="out('3025649188866691570');" style=""> 375       *    b) Remove offers that do not apply to this customer                                                     </span>
<span class="5156402814943015913" onmouseenter="enter('5156402814943015913');" onmouseout="out('5156402814943015913');" style=""> 376       * 3) Loop through offers                                                                                     </span>
<span class="6235203245796610706" onmouseenter="enter('6235203245796610706');" onmouseout="out('6235203245796610706');" style=""> 377       *    a) Verifies type of offer (order, order item, fulfillment)                                              </span>
<span class="7315686159335672158" onmouseenter="enter('7315686159335672158');" onmouseout="out('7315686159335672158');" style=""> 378       *    b) Verifies if offer can be applies                                                                     </span>
<span class="-6634234506054969031" onmouseenter="enter('-6634234506054969031');" onmouseout="out('-6634234506054969031');" style=""> 379       *    c) Assign offer to type (order, order item, or fulfillment)                                             </span>
<span class="-4584093434328536587" onmouseenter="enter('-4584093434328536587');" onmouseout="out('-4584093434328536587');" style=""> 380       * 4) Sorts the order and item offers list by priority and then discount                                      </span>
<span class="-2042995489836168848" onmouseenter="enter('-2042995489836168848');" onmouseout="out('-2042995489836168848');" style=""> 381       * 5) Identify the best offers to apply to order item and create adjustments for each item offer              </span>
<span class="8597383329030492662" onmouseenter="enter('8597383329030492662');" onmouseout="out('8597383329030492662');" style=""> 382       * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better      </span>
<span class="-5003028621529242985" onmouseenter="enter('-5003028621529242985');" onmouseout="out('-5003028621529242985');" style=""> 383       * 7) Identify the best offers to apply to the order and create adjustments for each order offer              </span>
<span class="-1324083657955785943" onmouseenter="enter('-1324083657955785943');" onmouseout="out('-1324083657955785943');" style=""><abbr title=" 384       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 384       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount valðŸ”µ</abbr></span>
<span class="-8610949319074908232" onmouseenter="enter('-8610949319074908232');" onmouseout="out('-8610949319074908232');" style=""> 385       * 9) Set final order item prices and reapply order offers                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 386       *                                                                                                            </span>
<span class="9071544830737596533" onmouseenter="enter('9071544830737596533');" onmouseout="out('9071544830737596533');" style=""> 387       * Assumptions:                                                                                               </span>
<span class="7676524731541901514" onmouseenter="enter('7676524731541901514');" onmouseout="out('7676524731541901514');" style=""> 388       * 1) % off all items will be created as an item offer with no expression                                     </span>
<span class="-814522364757940962" onmouseenter="enter('-814522364757940962');" onmouseout="out('-814522364757940962');" style=""> 389       * 2) $ off order will be created as an order offer                                                           </span>
<span class="7365449813142531261" onmouseenter="enter('7365449813142531261');" onmouseout="out('7365449813142531261');" style=""> 390       * 3) Order offers applies to the best price for each item (not just retail price)                            </span>
<span class="-1636653647835076359" onmouseenter="enter('-1636653647835076359');" onmouseout="out('-1636653647835076359');" style=""> 391       * 4) Fulfillment offers apply to best price for each item (not just retail price)                            </span>
<span class="-5866280996345915157" onmouseenter="enter('-5866280996345915157');" onmouseout="out('-5866280996345915157');" style=""><abbr title=" 392       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 392       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item ofðŸ”µ</abbr></span>
<span class="-8022045642448063338" onmouseenter="enter('-8022045642448063338');" onmouseout="out('-8022045642448063338');" style=""> 393       * 6) Fulfillment offers cannot be not combinable                                                             </span>
<span class="-5108644804585013203" onmouseenter="enter('-5108644804585013203');" onmouseout="out('-5108644804585013203');" style=""> 394       * 7) Order offers cannot be FIXED_PRICE                                                                      </span>
<span class="6161153439596163093" onmouseenter="enter('6161153439596163093');" onmouseout="out('6161153439596163093');" style=""> 395       * 8) FIXED_PRICE offers cannot be stackable                                                                  </span>
<span class="7044504232316014062" onmouseenter="enter('7044504232316014062');" onmouseout="out('7044504232316014062');" style=""><abbr title=" 396       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 396       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always applðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 397       *                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 398       */                                                                                                           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 399      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 400      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-4704847871427432866" onmouseenter="enter('-4704847871427432866');" onmouseout="out('-4704847871427432866');" style=""> 401      public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {             </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 402          /*                                                                                                        </span>
<span class="-6180845550366984877" onmouseenter="enter('-6180845550366984877');" onmouseout="out('-6180845550366984877');" style=""> 403          TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to          </span>
<span class="9161254164549280190" onmouseenter="enter('9161254164549280190');" onmouseout="out('9161254164549280190');" style=""> 404          use a richer object to describe the parameters of the pricing call. This object would include             </span>
<span class="1561516658361300705" onmouseenter="enter('1561516658361300705');" onmouseout="out('1561516658361300705');" style=""> 405          the pricing boolean, but would also include a list of activities to include or exclude in the             </span>
<span class="-6797832594843538707" onmouseenter="enter('-6797832594843538707');" onmouseout="out('-6797832594843538707');" style=""> 406          call - see http://jira.broadleafcommerce.org/browse/BLC-664                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 407           */                                                                                                       </span>
<span class="2182795146752320946" onmouseenter="enter('2182795146752320946');" onmouseout="out('2182795146752320946');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 408 +        Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 408 +        Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHEðŸ”µ</abbr></span>
<span class="-2779719222870458088" onmouseenter="enter('-2779719222870458088');" onmouseout="out('-2779719222870458088');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +        int offerCount = 0;                                                                                       </span>
<span class="-845359809890439940" onmouseenter="enter('-845359809890439940');" onmouseout="out('-845359809890439940');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 410 +        if(o!=null &amp;&amp; (Boolean)o){                                                                                </span>
<span class="-4703255484140988550" onmouseenter="enter('-4703255484140988550');" onmouseout="out('-4703255484140988550');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +            if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())){          </span>
<span class="187767283697509415" onmouseenter="enter('187767283697509415');" onmouseout="out('187767283697509415');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +                for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {                             </span>
<span class="-169235058410924848" onmouseenter="enter('-169235058410924848');" onmouseout="out('-169235058410924848');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +                    if(orderAdjustment.getOffer()!=null){                                                         </span>
<span class="6329272383142541507" onmouseenter="enter('6329272383142541507');" onmouseout="out('6329272383142541507');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 414 +                        offerCount++;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 415 +                    }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 416 +                }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +        }                                                                                                         </span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 419          OfferContext offerContext = OfferContext.getOfferContext();                                               </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 420          if (offerContext == null || offerContext.executePromotionCalculation) {                                   </span>
<span class="-2683885994659783076" onmouseenter="enter('-2683885994659783076');" onmouseout="out('-2683885994659783076');" style=""> 421              PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);          </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +            List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                               </span>
<span class="-2406747375061389964" onmouseenter="enter('-2406747375061389964');" onmouseout="out('-2406747375061389964');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +            removeOutOfDateOfferCodesAndOffers(orderOfferCodes, offers);                                          </span>
<span class="-9066266687178937853" onmouseenter="enter('-9066266687178937853');" onmouseout="out('-9066266687178937853');" style=""> 424              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());           </span>
<span class="-1421782411503697087" onmouseenter="enter('-1421782411503697087');" onmouseout="out('-1421782411503697087');" style=""> 425              if ((filteredOffers == null) || (filteredOffers.isEmpty())) {                                         </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 426                  if (LOG.isTraceEnabled()) {                                                                       </span>
<span class="2760579588161124045" onmouseenter="enter('2760579588161124045');" onmouseout="out('2760579588161124045');" style=""> 427                      LOG.trace(&quot;No offers applicable to this order.&quot;);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 428                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 429              } else {                                                                                              </span>
<span class="7300520529047311728" onmouseenter="enter('7300520529047311728');" onmouseout="out('7300520529047311728');" style=""><abbr title=" 430                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 430                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOðŸ”µ</abbr></span>
<span class="-7404348590242143631" onmouseenter="enter('-7404348590242143631');" onmouseout="out('-7404348590242143631');" style=""><abbr title=" 431                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 431                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffeðŸ”µ</abbr></span>
<span  style=""> 432                                                                                                                    </span>
<span class="-5526882442984993330" onmouseenter="enter('-5526882442984993330');" onmouseout="out('-5526882442984993330');" style=""><abbr title=" 433                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 433                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItðŸ”µ</abbr></span>
<span  style=""> 434                                                                                                                    </span>
<span class="-6480919216777131248" onmouseenter="enter('-6480919216777131248');" onmouseout="out('-6480919216777131248');" style=""> 435                  if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {                        </span>
<span class="-2723881742436166059" onmouseenter="enter('-2723881742436166059');" onmouseout="out('-2723881742436166059');" style=""> 436                      // At this point, we should have a PromotableOrder that contains PromotableItems each of which</span>
<span class="751015906320167144" onmouseenter="enter('751015906320167144');" onmouseout="out('751015906320167144');" style=""> 437                      // has a list of candidatePromotions that might be applied.                                   </span>
<span  style=""> 438                                                                                                                    </span>
<span class="5941864862011378901" onmouseenter="enter('5941864862011378901');" onmouseout="out('5941864862011378901');" style=""><abbr title=" 439                      // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 439                      // We also have a list of orderOffers that might apply and a list of itemOffers that might appðŸ”µ</abbr></span>
<span class="1127078869550353626" onmouseenter="enter('1127078869550353626');" onmouseout="out('1127078869550353626');" style=""><abbr title=" 440                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 440                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, quðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 441                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 442              }                                                                                                     </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 443              orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                                 </span>
<span  style=""> 444                                                                                                                    </span>
<span class="514986819999277890" onmouseenter="enter('514986819999277890');" onmouseout="out('514986819999277890');" style=""> 445              verifyAdjustments(order, true);                                                                       </span>
<span  style=""> 446                                                                                                                    </span>
<span class="-8901364638816691349" onmouseenter="enter('-8901364638816691349');" onmouseout="out('-8901364638816691349');" style=""> 447              order.setSubTotal(order.calculateSubTotal());                                                         </span>
<span class="8881079200386597596" onmouseenter="enter('8881079200386597596');" onmouseout="out('8881079200386597596');" style=""> 448              order.finalizeItemPrices();                                                                           </span>
<span  style=""> 449                                                                                                                    </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 450              order = orderService.save(order, false);                                                              </span>
<span  style=""> 451                                                                                                                    </span>
<span class="-5335273514929397197" onmouseenter="enter('-5335273514929397197');" onmouseout="out('-5335273514929397197');" style=""> 452              boolean madeChange = verifyAdjustments(order, false);                                                 </span>
<span class="-3218959195648057803" onmouseenter="enter('-3218959195648057803');" onmouseout="out('-3218959195648057803');" style=""> 453              if (madeChange) {                                                                                     </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 454                  order = orderService.save(order, false);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 455 +            }                                                                                                     </span>
<span class="-8586437722090950510" onmouseenter="enter('-8586437722090950510');" onmouseout="out('-8586437722090950510');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 456 +            int offerCountAfter=0;                                                                                </span>
<span class="-845359809890439940" onmouseenter="enter('-845359809890439940');" onmouseout="out('-845359809890439940');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 457 +            if(o!=null &amp;&amp; (Boolean)o){                                                                            </span>
<span class="-4703255484140988550" onmouseenter="enter('-4703255484140988550');" onmouseout="out('-4703255484140988550');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 458 +                if(org.apache.commons.collections4.CollectionUtils.isNotEmpty(order.getOrderAdjustments())){      </span>
<span class="187767283697509415" onmouseenter="enter('187767283697509415');" onmouseout="out('187767283697509415');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 459 +                    for (OrderAdjustment orderAdjustment : order.getOrderAdjustments()) {                         </span>
<span class="-169235058410924848" onmouseenter="enter('-169235058410924848');" onmouseout="out('-169235058410924848');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 460 +                        if(orderAdjustment.getOffer()!=null){                                                     </span>
<span class="-8696114592748620649" onmouseenter="enter('-8696114592748620649');" onmouseout="out('-8696114592748620649');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 461 +                            offerCountAfter++;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 462 +                        }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 463 +                    }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 464 +                }                                                                                                 </span>
<span class="513357313329824873" onmouseenter="enter('513357313329824873');" onmouseout="out('513357313329824873');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 465 +                if(offerCountAfter!=offerCount){                                                                  </span>
<span class="-3668454086264686215" onmouseenter="enter('-3668454086264686215');" onmouseout="out('-3668454086264686215');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 466 +                    BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 466 +                    BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServicðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 467 +                }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 468              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 469          }                                                                                                         </span>
<span  style=""> 470                                                                                                                    </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 471          return order;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 472      }                                                                                                             </span>
<span  style=""> 473                                                                                                                    </span>
<span class="219209447823395758" onmouseenter="enter('219209447823395758');" onmouseout="out('219209447823395758');" style=""> 474      protected boolean verifyAdjustments(Order order, boolean beforeSave) {                                        </span>
<span class="79408939766017075" onmouseenter="enter('79408939766017075');" onmouseout="out('79408939766017075');" style=""> 475          boolean madeChange = false;                                                                               </span>
<span  style=""> 476                                                                                                                    </span>
<span class="-8966123689509035198" onmouseenter="enter('-8966123689509035198');" onmouseout="out('-8966123689509035198');" style=""> 477          if (order.getOrderItems() == null) {                                                                      </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 478              return madeChange;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 479          }                                                                                                         </span>
<span  style=""> 480                                                                                                                    </span>
<span class="8447029191885982498" onmouseenter="enter('8447029191885982498');" onmouseout="out('8447029191885982498');" style=""> 481          for (OrderItem oi : order.getOrderItems()) {                                                              </span>
<span class="-5982197742320851056" onmouseenter="enter('-5982197742320851056');" onmouseout="out('-5982197742320851056');" style=""> 482              if (oi.getOrderItemPriceDetails() == null) {                                                          </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 483                  continue;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 484              }                                                                                                     </span>
<span  style=""> 485                                                                                                                    </span>
<span class="7391296704731194189" onmouseenter="enter('7391296704731194189');" onmouseout="out('7391296704731194189');" style=""> 486              for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {                                       </span>
<span class="-8259157388002947293" onmouseenter="enter('-8259157388002947293');" onmouseout="out('-8259157388002947293');" style=""> 487                  if (pd.getOrderItemPriceDetailAdjustments() == null) {                                            </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 488                      continue;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 489                  }                                                                                                 </span>
<span  style=""> 490                                                                                                                    </span>
<span class="-8160497408394725913" onmouseenter="enter('-8160497408394725913');" onmouseout="out('-8160497408394725913');" style=""><abbr title=" 491                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 491                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;ðŸ”µ</abbr></span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 492                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 492                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjusðŸ”µ</abbr></span>
<span class="-3008507732031274392" onmouseenter="enter('-3008507732031274392');" onmouseout="out('-3008507732031274392');" style=""> 493                  for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {              </span>
<span class="-1975641521768786423" onmouseenter="enter('-1975641521768786423');" onmouseout="out('-1975641521768786423');" style=""> 494                      if (adjs.containsKey(adj.getOffer().getId())) {                                               </span>
<span class="-6913168070672082713" onmouseenter="enter('-6913168070672082713');" onmouseout="out('-6913168070672082713');" style=""> 495                          adjustmentsToRemove.add(adj);                                                             </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 496                          if (LOG.isDebugEnabled()) {                                                               </span>
<span class="-2834336870885753779" onmouseenter="enter('-2834336870885753779');" onmouseout="out('-2834336870885753779');" style=""> 497                              StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)                          </span>
<span class="201513945492742471" onmouseenter="enter('201513945492742471');" onmouseout="out('201513945492742471');" style=""> 498                                  .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)                            </span>
<span class="2195430440089355634" onmouseenter="enter('2195430440089355634');" onmouseout="out('2195430440089355634');" style=""> 499                                  .append(&quot; with ids &quot;)                                                             </span>
<span class="-3149719647859419210" onmouseenter="enter('-3149719647859419210');" onmouseout="out('-3149719647859419210');" style=""> 500                                  .append(adjs.get(adj.getOffer().getId()).getId())                                 </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 501                                  .append(&quot; and &quot;)                                                                  </span>
<span class="6832270653349147085" onmouseenter="enter('6832270653349147085');" onmouseout="out('6832270653349147085');" style=""> 502                                  .append(adj.getId());                                                             </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 503                              LOG.debug(sb.toString());                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 504                          }                                                                                         </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 505                      } else {                                                                                      </span>
<span class="-7759509127049565554" onmouseenter="enter('-7759509127049565554');" onmouseout="out('-7759509127049565554');" style=""> 506                          adjs.put(adj.getOffer().getId(), adj);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 507                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 508                  }                                                                                                 </span>
<span  style=""> 509                                                                                                                    </span>
<span class="7848730128284985932" onmouseenter="enter('7848730128284985932');" onmouseout="out('7848730128284985932');" style=""> 510                  for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {                                  </span>
<span class="6756116260498887863" onmouseenter="enter('6756116260498887863');" onmouseout="out('6756116260498887863');" style=""> 511                      pd.getOrderItemPriceDetailAdjustments().remove(adj);                                          </span>
<span class="5571803755205047298" onmouseenter="enter('5571803755205047298');" onmouseout="out('5571803755205047298');" style=""> 512                      madeChange = true;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 513                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 514              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 515          }                                                                                                         </span>
<span  style=""> 516                                                                                                                    </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 517          return madeChange;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 518       }                                                                                                            </span>
<span  style=""> 519                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 520      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 521      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 522      @Deprecated                                                                                                   </span>
<span class="-3021599232242429775" onmouseenter="enter('-3021599232242429775');" onmouseout="out('-3021599232242429775');" style=""> 523      public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {                     </span>
<span class="-6341015309393843959" onmouseenter="enter('-6341015309393843959');" onmouseout="out('-6341015309393843959');" style=""> 524          applyAndSaveOffersToOrder(offers, order);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 525      }                                                                                                             </span>
<span  style=""> 526                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 527      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 528      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 529      @Deprecated                                                                                                   </span>
<span class="-5535279977913938928" onmouseenter="enter('-5535279977913938928');" onmouseout="out('-5535279977913938928');" style=""> 530      public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {     </span>
<span class="6394386461467124428" onmouseenter="enter('6394386461467124428');" onmouseout="out('6394386461467124428');" style=""> 531          applyAndSaveFulfillmentGroupOffersToOrder(offers, order);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 532      }                                                                                                             </span>
<span  style=""> 533                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 534      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 535      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="2855881782634007850" onmouseenter="enter('2855881782634007850');" onmouseout="out('2855881782634007850');" style=""><abbr title=" 536      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 536      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptioðŸ”µ</abbr></span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 537          OfferContext offerContext = OfferContext.getOfferContext();                                               </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 538          if (offerContext == null || offerContext.executePromotionCalculation) {                                   </span>
<span class="-791836473256513905" onmouseenter="enter('-791836473256513905');" onmouseout="out('-791836473256513905');" style=""> 539              PromotableOrder promotableOrder =                                                                     </span>
<span class="-5771222684966163235" onmouseenter="enter('-5771222684966163235');" onmouseout="out('-5771222684966163235');" style=""> 540                      promotableItemFactory.createPromotableOrder(order, true);                                     </span>
<span class="-6252467951249219732" onmouseenter="enter('-6252467951249219732');" onmouseout="out('-6252467951249219732');" style=""> 541              List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();                                                </span>
<span class="-8689854403875612694" onmouseenter="enter('-8689854403875612694');" onmouseout="out('-8689854403875612694');" style=""> 542              for (Offer offer : offers) {                                                                          </span>
<span class="3344482016035270743" onmouseenter="enter('3344482016035270743');" onmouseout="out('3344482016035270743');" style=""> 543                  if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {                    </span>
<span class="2965579239059640859" onmouseenter="enter('2965579239059640859');" onmouseout="out('2965579239059640859');" style=""> 544                      possibleFGOffers.add(offer);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 545                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 546              }                                                                                                     </span>
<span class="7272445213685933500" onmouseenter="enter('7272445213685933500');" onmouseout="out('7272445213685933500');" style=""> 547              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer()); </span>
<span class="-380250791493510209" onmouseenter="enter('-380250791493510209');" onmouseout="out('-380250791493510209');" style=""><abbr title=" 548              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 548              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFuðŸ”µ</abbr></span>
<span class="5471512156259214352" onmouseenter="enter('5471512156259214352');" onmouseout="out('5471512156259214352');" style=""> 549              for (Offer offer : filteredOffers) {                                                                  </span>
<span class="6341701119621727258" onmouseenter="enter('6341701119621727258');" onmouseout="out('6341701119621727258');" style=""><abbr title=" 550                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 550                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffersðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 551              }                                                                                                     </span>
<span class="6757974448768463" onmouseenter="enter('6757974448768463');" onmouseout="out('6757974448768463');" style=""> 552              if (!qualifiedFGOffers.isEmpty()) {                                                                   </span>
<span class="-3737539762239464744" onmouseenter="enter('-3737539762239464744');" onmouseout="out('-3737539762239464744');" style=""> 553                  fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);</span>
<span class="-1748187190347404908" onmouseenter="enter('-1748187190347404908');" onmouseout="out('-1748187190347404908');" style=""> 554                  fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);                   </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 555                  orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 556              }                                                                                                     </span>
<span  style=""> 557                                                                                                                    </span>
<span class="-7204486914274790826" onmouseenter="enter('-7204486914274790826');" onmouseout="out('-7204486914274790826');" style=""> 558              return orderService.save(order, false);                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 559          }                                                                                                         </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 560          return order;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 561      }                                                                                                             </span>
<span  style=""> 562                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 563      @Override                                                                                                     </span>
<span class="-8983195686564092827" onmouseenter="enter('-8983195686564092827');" onmouseout="out('-8983195686564092827');" style=""> 564      public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {                                    </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 565          Customer customer = order.getCustomer();                                                                  </span>
<span  style=""> 566                                                                                                                    </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 567          if (offer.isLimitedUsePerCustomer()) {                                                                    </span>
<span class="-8305970541390666259" onmouseenter="enter('-8305970541390666259');" onmouseout="out('-8305970541390666259');" style=""> 568              Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());     </span>
<span  style=""> 569                                                                                                                    </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 570              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                                   </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 571                  return false;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 572              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 573          }                                                                                                         </span>
<span  style=""> 574                                                                                                                    </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 575          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 576      }                                                                                                             </span>
<span  style=""> 577                                                                                                                    </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 578      @Deprecated                                                                                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 579      @Override                                                                                                     </span>
<span class="4849754295577860926" onmouseenter="enter('4849754295577860926');" onmouseout="out('4849754295577860926');" style=""> 580      public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {                              </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 581          if (offer.isLimitedUsePerCustomer()) {                                                                    </span>
<span class="8084739095609490454" onmouseenter="enter('8084739095609490454');" onmouseout="out('8084739095609490454');" style=""> 582              Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());            </span>
<span  style=""> 583                                                                                                                    </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 584              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                                   </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 585                  return false;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 586              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 587          }                                                                                                         </span>
<span  style=""> 588                                                                                                                    </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 589          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 590      }                                                                                                             </span>
<span  style=""> 591                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 592      @Override                                                                                                     </span>
<span class="-4305912419408886648" onmouseenter="enter('-4305912419408886648');" onmouseout="out('-4305912419408886648');" style=""> 593      public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {                                 </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 594          boolean underCodeMaxUses = true;                                                                          </span>
<span  style=""> 595                                                                                                                    </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 596          if (code.isLimitedUse()) {                                                                                </span>
<span class="-7378740545085856894" onmouseenter="enter('-7378740545085856894');" onmouseout="out('-7378740545085856894');" style=""> 597              Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());                     </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 598              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 599          }                                                                                                         </span>
<span  style=""> 600                                                                                                                    </span>
<span class="5446263071698048925" onmouseenter="enter('5446263071698048925');" onmouseout="out('5446263071698048925');" style=""> 601          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 602      }                                                                                                             </span>
<span  style=""> 603                                                                                                                    </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 604      @Deprecated                                                                                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 605      @Override                                                                                                     </span>
<span class="135967723667379112" onmouseenter="enter('135967723667379112');" onmouseout="out('135967723667379112');" style=""> 606      public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {                           </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 607          boolean underCodeMaxUses = true;                                                                          </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 608          if (code.isLimitedUse()) {                                                                                </span>
<span class="5487567461678823803" onmouseenter="enter('5487567461678823803');" onmouseout="out('5487567461678823803');" style=""> 609              Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());                            </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 610              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 611          }                                                                                                         </span>
<span class="7193079189056024188" onmouseenter="enter('7193079189056024188');" onmouseout="out('7193079189056024188');" style=""> 612          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 613      }                                                                                                             </span>
<span  style=""> 614                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 615      @Override                                                                                                     </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 616      @SuppressWarnings(&quot;unchecked&quot;)                                                                                </span>
<span class="-640784293225096821" onmouseenter="enter('-640784293225096821');" onmouseout="out('-640784293225096821');" style=""> 617      public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {                                                     </span>
<span class="-348027159212233091" onmouseenter="enter('-348027159212233091');" onmouseout="out('-348027159212233091');" style=""> 618          HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();                                                             </span>
<span  style=""> 619                                                                                                                    </span>
<span class="-7949809618309864364" onmouseenter="enter('-7949809618309864364');" onmouseout="out('-7949809618309864364');" style=""> 620          Transformer adjustmentToOfferTransformer = new Transformer() {                                            </span>
<span  style=""> 621                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 622              @Override                                                                                             </span>
<span class="-2718541205900117239" onmouseenter="enter('-2718541205900117239');" onmouseout="out('-2718541205900117239');" style=""> 623              public Object transform(Object input) {                                                               </span>
<span class="4176981446584954696" onmouseenter="enter('4176981446584954696');" onmouseout="out('4176981446584954696');" style=""> 624                  return ((Adjustment)input).getOffer();                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 625              }                                                                                                     </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 626          };                                                                                                        </span>
<span  style=""> 627                                                                                                                    </span>
<span class="-8370514600917699300" onmouseenter="enter('-8370514600917699300');" onmouseout="out('-8370514600917699300');" style=""> 628          result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));        </span>
<span  style=""> 629                                                                                                                    </span>
<span class="3897119298100986011" onmouseenter="enter('3897119298100986011');" onmouseout="out('3897119298100986011');" style=""> 630          if (order.getOrderItems() != null) {                                                                      </span>
<span class="820796442257070700" onmouseenter="enter('820796442257070700');" onmouseout="out('820796442257070700');" style=""> 631              for (OrderItem item : order.getOrderItems()) {                                                        </span>
<span class="722957474719034118" onmouseenter="enter('722957474719034118');" onmouseout="out('722957474719034118');" style=""><abbr title=" 632                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 632                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformerðŸ”µ</abbr></span>
<span  style=""> 633                                                                                                                    </span>
<span class="-3519908190158496681" onmouseenter="enter('-3519908190158496681');" onmouseout="out('-3519908190158496681');" style=""> 634                  //record usage for price details on the item as well                                              </span>
<span class="-2952948196187271811" onmouseenter="enter('-2952948196187271811');" onmouseout="out('-2952948196187271811');" style=""> 635                  if (item.getOrderItemPriceDetails() != null) {                                                    </span>
<span class="773323050474809935" onmouseenter="enter('773323050474809935');" onmouseout="out('773323050474809935');" style=""> 636                      for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {                         </span>
<span class="7134713472391876911" onmouseenter="enter('7134713472391876911');" onmouseout="out('7134713472391876911');" style=""><abbr title=" 637                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 637                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 638                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 639                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 640              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 641          }                                                                                                         </span>
<span  style=""> 642                                                                                                                    </span>
<span class="7944520279780748823" onmouseenter="enter('7944520279780748823');" onmouseout="out('7944520279780748823');" style=""> 643          if (order.getFulfillmentGroups() != null) {                                                               </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 644              for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                            </span>
<span class="-293187079687761920" onmouseenter="enter('-293187079687761920');" onmouseout="out('-293187079687761920');" style=""><abbr title=" 645                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 645                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 646              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 647          }                                                                                                         </span>
<span class="-6419540350677864751" onmouseenter="enter('-6419540350677864751');" onmouseout="out('-6419540350677864751');" style=""> 648          return result;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 649      }                                                                                                             </span>
<span  style=""> 650                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 651      @Override                                                                                                     </span>
<span class="-2491837224879773303" onmouseenter="enter('-2491837224879773303');" onmouseout="out('-2491837224879773303');" style=""> 652      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {                                      </span>
<span class="-1370687283458217641" onmouseenter="enter('-1370687283458217641');" onmouseout="out('-1370687283458217641');" style=""> 653          return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 654      }                                                                                                             </span>
<span  style=""> 655                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 656      @Override                                                                                                     </span>
<span class="-6407317956511861474" onmouseenter="enter('-6407317956511861474');" onmouseout="out('-6407317956511861474');" style=""> 657      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {   </span>
<span class="-4490485247927949218" onmouseenter="enter('-4490485247927949218');" onmouseout="out('-4490485247927949218');" style=""> 658          HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();                           </span>
<span class="983580358500385861" onmouseenter="enter('983580358500385861');" onmouseout="out('983580358500385861');" style=""> 659          for (OfferCode code : codes) {                                                                            </span>
<span class="6305098044991751707" onmouseenter="enter('6305098044991751707');" onmouseout="out('6305098044991751707');" style=""> 660              if (appliedOffers.contains(code.getOffer())) {                                                        </span>
<span class="3746501443462939384" onmouseenter="enter('3746501443462939384');" onmouseout="out('3746501443462939384');" style=""> 661                  offerToCodeMapping.put(code.getOffer(), code);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 662              }                                                                                                     </span>
<span  style=""> 663                                                                                                                    </span>
<span class="-240986298797431748" onmouseenter="enter('-240986298797431748');" onmouseout="out('-240986298797431748');" style=""> 664              List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();                                     </span>
<span  style=""> 665                                                                                                                    </span>
<span class="7454577566794152811" onmouseenter="enter('7454577566794152811');" onmouseout="out('7454577566794152811');" style=""> 666              extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);            </span>
<span class="-7985615425314556326" onmouseenter="enter('-7985615425314556326');" onmouseout="out('-7985615425314556326');" style=""> 667              for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {                                </span>
<span class="-808811284028256215" onmouseenter="enter('-808811284028256215');" onmouseout="out('-808811284028256215');" style=""> 668                  offerToCodeMapping.put(additionalOfferToBeApplied, code);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 669              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 670          }                                                                                                         </span>
<span class="7175253914401568841" onmouseenter="enter('7175253914401568841');" onmouseout="out('7175253914401568841');" style=""> 671          return offerToCodeMapping;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 672      }                                                                                                             </span>
<span  style=""> 673                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 674      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 675      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-1347767159915315738" onmouseenter="enter('-1347767159915315738');" onmouseout="out('-1347767159915315738');" style=""> 676      public Boolean deleteOfferCode(OfferCode code) {                                                              </span>
<span class="-5986603348121186173" onmouseenter="enter('-5986603348121186173');" onmouseout="out('-5986603348121186173');" style=""> 677          if (offerCodeDao.offerCodeIsUsed(code)) {                                                                 </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 678              return false;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 679          }                                                                                                         </span>
<span  style=""> 680                                                                                                                    </span>
<span class="-9122073777393685295" onmouseenter="enter('-9122073777393685295');" onmouseout="out('-9122073777393685295');" style=""> 681          offerCodeDao.delete(code);                                                                                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 682          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 683      }                                                                                                             </span>
<span  style=""> 684                                                                                                                    </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 685      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 686      @Override                                                                                                     </span>
<span class="-3816301958562278169" onmouseenter="enter('-3816301958562278169');" onmouseout="out('-3816301958562278169');" style=""> 687      public Offer duplicate(Long originalOfferId) {                                                                </span>
<span class="-5738299300293223874" onmouseenter="enter('-5738299300293223874');" onmouseout="out('-5738299300293223874');" style=""> 688          Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();                                            </span>
<span class="2715783386963629594" onmouseenter="enter('2715783386963629594');" onmouseout="out('2715783386963629594');" style=""> 689          copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);                                             </span>
<span class="-2013584672995219797" onmouseenter="enter('-2013584672995219797');" onmouseout="out('-2013584672995219797');" style=""> 690          return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 691      }                                                                                                             </span>
<span  style=""> 692                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 693      @Override                                                                                                     </span>
<span class="3228088005821970316" onmouseenter="enter('3228088005821970316');" onmouseout="out('3228088005821970316');" style=""> 694      public CustomerOfferDao getCustomerOfferDao() {                                                               </span>
<span class="-801333879424417122" onmouseenter="enter('-801333879424417122');" onmouseout="out('-801333879424417122');" style=""> 695          return customerOfferDao;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 696      }                                                                                                             </span>
<span  style=""> 697                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 698      @Override                                                                                                     </span>
<span class="6308179313298689001" onmouseenter="enter('6308179313298689001');" onmouseout="out('6308179313298689001');" style=""> 699      public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {                                          </span>
<span class="438520929977701037" onmouseenter="enter('438520929977701037');" onmouseout="out('438520929977701037');" style=""> 700          this.customerOfferDao = customerOfferDao;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 701      }                                                                                                             </span>
<span  style=""> 702                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 703      @Override                                                                                                     </span>
<span class="8266606365944954497" onmouseenter="enter('8266606365944954497');" onmouseout="out('8266606365944954497');" style=""> 704      public OfferCodeDao getOfferCodeDao() {                                                                       </span>
<span class="-4005874311041664572" onmouseenter="enter('-4005874311041664572');" onmouseout="out('-4005874311041664572');" style=""> 705          return offerCodeDao;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 706      }                                                                                                             </span>
<span  style=""> 707                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 708      @Override                                                                                                     </span>
<span class="-5083072655758254890" onmouseenter="enter('-5083072655758254890');" onmouseout="out('-5083072655758254890');" style=""> 709      public void setOfferCodeDao(OfferCodeDao offerCodeDao) {                                                      </span>
<span class="-7060255547979502806" onmouseenter="enter('-7060255547979502806');" onmouseout="out('-7060255547979502806');" style=""> 710          this.offerCodeDao = offerCodeDao;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 711      }                                                                                                             </span>
<span  style=""> 712                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 713      @Override                                                                                                     </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 714      public OfferDao getOfferDao() {                                                                               </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 715          return offerDao;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 716      }                                                                                                             </span>
<span  style=""> 717                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 718      @Override                                                                                                     </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 719      public void setOfferDao(OfferDao offerDao) {                                                                  </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 720          this.offerDao = offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 721      }                                                                                                             </span>
<span  style=""> 722                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 723      @Override                                                                                                     </span>
<span class="3012408951835963759" onmouseenter="enter('3012408951835963759');" onmouseout="out('3012408951835963759');" style=""> 724      public OrderOfferProcessor getOrderOfferProcessor() {                                                         </span>
<span class="-5069105522766505260" onmouseenter="enter('-5069105522766505260');" onmouseout="out('-5069105522766505260');" style=""> 725          return orderOfferProcessor;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 726      }                                                                                                             </span>
<span  style=""> 727                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 728      @Override                                                                                                     </span>
<span class="-2542583147665382651" onmouseenter="enter('-2542583147665382651');" onmouseout="out('-2542583147665382651');" style=""> 729      public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {                                 </span>
<span class="1533378703496715943" onmouseenter="enter('1533378703496715943');" onmouseout="out('1533378703496715943');" style=""> 730          this.orderOfferProcessor = orderOfferProcessor;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 731      }                                                                                                             </span>
<span  style=""> 732                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 733      @Override                                                                                                     </span>
<span class="1694843298235251985" onmouseenter="enter('1694843298235251985');" onmouseout="out('1694843298235251985');" style=""> 734      public ItemOfferProcessor getItemOfferProcessor() {                                                           </span>
<span class="1583504692330339191" onmouseenter="enter('1583504692330339191');" onmouseout="out('1583504692330339191');" style=""> 735          return itemOfferProcessor;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 736      }                                                                                                             </span>
<span  style=""> 737                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 738      @Override                                                                                                     </span>
<span class="145400756853488798" onmouseenter="enter('145400756853488798');" onmouseout="out('145400756853488798');" style=""> 739      public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {                                    </span>
<span class="-102405468021411755" onmouseenter="enter('-102405468021411755');" onmouseout="out('-102405468021411755');" style=""> 740          this.itemOfferProcessor = itemOfferProcessor;                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 741      }                                                                                                             </span>
<span  style=""> 742                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 743      @Override                                                                                                     </span>
<span class="3022939772369206873" onmouseenter="enter('3022939772369206873');" onmouseout="out('3022939772369206873');" style=""> 744      public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {                                   </span>
<span class="-3088775944214719317" onmouseenter="enter('-3088775944214719317');" onmouseout="out('-3088775944214719317');" style=""> 745          return fulfillmentGroupOfferProcessor;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 746      }                                                                                                             </span>
<span  style=""> 747                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 748      @Override                                                                                                     </span>
<span class="-8855456203149015957" onmouseenter="enter('-8855456203149015957');" onmouseout="out('-8855456203149015957');" style=""> 749      public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {</span>
<span class="-7108053920330155376" onmouseenter="enter('-7108053920330155376');" onmouseout="out('-7108053920330155376');" style=""> 750          this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 751      }                                                                                                             </span>
<span  style=""> 752                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 753      @Override                                                                                                     </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 754      public PromotableItemFactory getPromotableItemFactory() {                                                     </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 755          return promotableItemFactory;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 756      }                                                                                                             </span>
<span  style=""> 757                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 758      @Override                                                                                                     </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 759      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                           </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 760          this.promotableItemFactory = promotableItemFactory;                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 761      }                                                                                                             </span>
<span  style=""> 762                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 763      @Override                                                                                                     </span>
<span class="-285725005067991728" onmouseenter="enter('-285725005067991728');" onmouseout="out('-285725005067991728');" style=""> 764      public OfferCode findOfferCodeById(Long id) {                                                                 </span>
<span class="4928857363700364693" onmouseenter="enter('4928857363700364693');" onmouseout="out('4928857363700364693');" style=""> 765          return offerCodeDao.readOfferCodeById(id);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 766      }                                                                                                             </span>
<span  style=""> 767                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 768      @Override                                                                                                     </span>
<span class="-6829155498814719074" onmouseenter="enter('-6829155498814719074');" onmouseout="out('-6829155498814719074');" style=""> 769      public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {                                            </span>
<span class="-1521639274006709657" onmouseenter="enter('-1521639274006709657');" onmouseout="out('-1521639274006709657');" style=""> 770          return offerCodeDao.readOfferCodesByIds(ids);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 771      }                                                                                                             </span>
<span  style=""> 772                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 773      @Override                                                                                                     </span>
<span class="5587340050529616033" onmouseenter="enter('5587340050529616033');" onmouseout="out('5587340050529616033');" style=""> 774      public OrderService getOrderService() {                                                                       </span>
<span class="-7558473787756148723" onmouseenter="enter('-7558473787756148723');" onmouseout="out('-7558473787756148723');" style=""> 775          return orderService;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 776      }                                                                                                             </span>
<span  style=""> 777                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 778      @Override                                                                                                     </span>
<span class="4536819371590947172" onmouseenter="enter('4536819371590947172');" onmouseout="out('4536819371590947172');" style=""> 779      public void setOrderService(OrderService orderService) {                                                      </span>
<span class="7368861914925934250" onmouseenter="enter('7368861914925934250');" onmouseout="out('7368861914925934250');" style=""> 780          this.orderService = orderService;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 781      }                                                                                                             </span>
<span  style=""> 782                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 783      @Override                                                                                                     </span>
<span class="-2217088353489190987" onmouseenter="enter('-2217088353489190987');" onmouseout="out('-2217088353489190987');" style=""> 784      public Offer findOfferById(Long offerId) {                                                                    </span>
<span class="-5171648678549667040" onmouseenter="enter('-5171648678549667040');" onmouseout="out('-5171648678549667040');" style=""> 785          return offerDao.readOfferById(offerId);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 786      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 787  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-5062573030309236877" onmouseenter="enter('-5062573030309236877');" onmouseout="out('-5062573030309236877');" style="">   3   * BroadleafCommerce Framework                                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-2350834265180208989" onmouseenter="enter('-2350834265180208989');" onmouseout="out('-2350834265180208989');" style="">  18  package org.broadleafcommerce.core.offer.service;                                                                 </span>
<span  style="">  19                                                                                                                    </span>
<span class="8596464405353709537" onmouseenter="enter('8596464405353709537');" onmouseout="out('8596464405353709537');" style="">  20  import org.apache.commons.collections.CollectionUtils;                                                            </span>
<span class="2953846583056246827" onmouseenter="enter('2953846583056246827');" onmouseout="out('2953846583056246827');" style="">  21  import org.apache.commons.collections.Transformer;                                                                </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  22  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  23  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="-2193028153657877676" onmouseenter="enter('-2193028153657877676');" onmouseout="out('-2193028153657877676');" style="">  24  import org.broadleafcommerce.common.persistence.EntityDuplicateModifier;                                          </span>
<span class="-3349026188166660873" onmouseenter="enter('-3349026188166660873');" onmouseout="out('-3349026188166660873');" style="">  25  import org.broadleafcommerce.common.persistence.EntityDuplicator;                                                 </span>
<span class="-2818686525334833130" onmouseenter="enter('-2818686525334833130');" onmouseout="out('-2818686525334833130');" style="">  26  import org.broadleafcommerce.common.sandbox.SandBoxHelper;                                                        </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  27  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                              </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  28  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                         </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  29 -import org.broadleafcommerce.common.web.BroadleafRequestContext;                                                  </span>
<span class="6205208880685044389" onmouseenter="enter('6205208880685044389');" onmouseout="out('6205208880685044389');" style="">  30  import org.broadleafcommerce.core.offer.dao.CustomerOfferDao;                                                     </span>
<span class="-7911436562744873568" onmouseenter="enter('-7911436562744873568');" onmouseout="out('-7911436562744873568');" style="">  31  import org.broadleafcommerce.core.offer.dao.OfferCodeDao;                                                         </span>
<span class="-2793633202507663758" onmouseenter="enter('-2793633202507663758');" onmouseout="out('-2793633202507663758');" style="">  32  import org.broadleafcommerce.core.offer.dao.OfferDao;                                                             </span>
<span class="-1633608357492319903" onmouseenter="enter('-1633608357492319903');" onmouseout="out('-1633608357492319903');" style="">  33  import org.broadleafcommerce.core.offer.domain.Adjustment;                                                        </span>
<span class="984981432680799531" onmouseenter="enter('984981432680799531');" onmouseout="out('984981432680799531');" style="">  34  import org.broadleafcommerce.core.offer.domain.CustomerOffer;                                                     </span>
<span class="4081153142019712377" onmouseenter="enter('4081153142019712377');" onmouseout="out('4081153142019712377');" style="">  35  import org.broadleafcommerce.core.offer.domain.Offer;                                                             </span>
<span class="1521662235446319191" onmouseenter="enter('1521662235446319191');" onmouseout="out('1521662235446319191');" style="">  36  import org.broadleafcommerce.core.offer.domain.OfferCode;                                                         </span>
<span class="-7025591891527881733" onmouseenter="enter('-7025591891527881733');" onmouseout="out('-7025591891527881733');" style="">  37  import org.broadleafcommerce.core.offer.domain.OfferImpl;                                                         </span>
<span class="6786419255693124735" onmouseenter="enter('6786419255693124735');" onmouseout="out('6786419255693124735');" style="">  38  import org.broadleafcommerce.core.offer.domain.OrderItemPriceDetailAdjustment;                                    </span>

<span class="4287099423657810905" onmouseenter="enter('4287099423657810905');" onmouseout="out('4287099423657810905');" style="">  39  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateFulfillmentGroupOffer;         </span>
<span class="7831481241902679836" onmouseenter="enter('7831481241902679836');" onmouseout="out('7831481241902679836');" style="">  40  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateItemOffer;                     </span>
<span class="3084705229570823543" onmouseenter="enter('3084705229570823543');" onmouseout="out('3084705229570823543');" style="">  41  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableCandidateOrderOffer;                    </span>
<span class="-7267862110060338073" onmouseenter="enter('-7267862110060338073');" onmouseout="out('-7267862110060338073');" style="">  42  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableItemFactory;                            </span>
<span class="-6456406933954769040" onmouseenter="enter('-6456406933954769040');" onmouseout="out('-6456406933954769040');" style="">  43  import org.broadleafcommerce.core.offer.service.discount.domain.PromotableOrder;                                  </span>
<span class="5713212224635448284" onmouseenter="enter('5713212224635448284');" onmouseout="out('5713212224635448284');" style="">  44  import org.broadleafcommerce.core.offer.service.processor.FulfillmentGroupOfferProcessor;                         </span>
<span class="-2454758753718589449" onmouseenter="enter('-2454758753718589449');" onmouseout="out('-2454758753718589449');" style="">  45  import org.broadleafcommerce.core.offer.service.processor.ItemOfferProcessor;                                     </span>
<span class="8227287359407176835" onmouseenter="enter('8227287359407176835');" onmouseout="out('8227287359407176835');" style="">  46  import org.broadleafcommerce.core.offer.service.processor.OrderOfferProcessor;                                    </span>
<span class="-5727938558534008634" onmouseenter="enter('-5727938558534008634');" onmouseout="out('-5727938558534008634');" style="">  47  import org.broadleafcommerce.core.offer.service.type.OfferType;                                                   </span>
<span class="-6302349778747925467" onmouseenter="enter('-6302349778747925467');" onmouseout="out('-6302349778747925467');" style="">  48  import org.broadleafcommerce.core.order.domain.FulfillmentGroup;                                                  </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  49  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="-3117062451881073195" onmouseenter="enter('-3117062451881073195');" onmouseout="out('-3117062451881073195');" style="">  50  import org.broadleafcommerce.core.order.domain.OrderItem;                                                         </span>
<span class="230297408131782266" onmouseenter="enter('230297408131782266');" onmouseout="out('230297408131782266');" style="">  51  import org.broadleafcommerce.core.order.domain.OrderItemPriceDetail;                                              </span>
<span class="-4523094285760083742" onmouseenter="enter('-4523094285760083742');" onmouseout="out('-4523094285760083742');" style="">  52  import org.broadleafcommerce.core.order.service.OrderService;                                                     </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  53  import org.broadleafcommerce.core.pricing.service.exception.PricingException;                                     </span>
<span class="-6242194486783230477" onmouseenter="enter('-6242194486783230477');" onmouseout="out('-6242194486783230477');" style="">  54  import org.broadleafcommerce.profile.core.domain.Customer;                                                        </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  55  import org.springframework.stereotype.Service;                                                                    </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  56  import org.springframework.transaction.annotation.Transactional;                                                  </span>
<span  style="">  57                                                                                                                    </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  58  import java.util.ArrayList;                                                                                       </span>
<span class="-112105277767313938" onmouseenter="enter('-112105277767313938');" onmouseout="out('-112105277767313938');" style="">  59  import java.util.Collection;                                                                                      </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  60  import java.util.HashMap;                                                                                         </span>
<span class="-1320562196372945707" onmouseenter="enter('-1320562196372945707');" onmouseout="out('-1320562196372945707');" style="">  61  import java.util.HashSet;                                                                                         </span>
<span class="7112180775387943933" onmouseenter="enter('7112180775387943933');" onmouseout="out('7112180775387943933');" style="">  62  import java.util.Iterator;                                                                                        </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  63  import java.util.List;                                                                                            </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  64  import java.util.Map;                                                                                             </span>
<span class="6306724220981822255" onmouseenter="enter('6306724220981822255');" onmouseout="out('6306724220981822255');" style="">  65  import java.util.Objects;                                                                                         </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  66  import java.util.Set;                                                                                             </span>
<span  style="">  67                                                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  68  import javax.annotation.Resource;                                                                                 </span>
<span class="7911938180110628123" onmouseenter="enter('7911938180110628123');" onmouseout="out('7911938180110628123');" style="">  69  import javax.persistence.EntityManager;                                                                           </span>
<span class="3821515051839343306" onmouseenter="enter('3821515051839343306');" onmouseout="out('3821515051839343306');" style="">  70  import javax.persistence.PersistenceContext;                                                                      </span>
<span  style="">  71                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  72  /**                                                                                                               </span>
<span class="-2667338179687874348" onmouseenter="enter('-2667338179687874348');" onmouseout="out('-2667338179687874348');" style="">  73   * The Class OfferServiceImpl.                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  74   */                                                                                                               </span>
<span class="504450232350438262" onmouseenter="enter('504450232350438262');" onmouseout="out('504450232350438262');" style="">  75  @Service(&quot;blOfferService&quot;)                                                                                        </span>
<span class="6786430150403502423" onmouseenter="enter('6786430150403502423');" onmouseout="out('6786430150403502423');" style="">  76  public class OfferServiceImpl implements OfferService {                                                           </span>
<span  style="">  77                                                                                                                    </span>
<span class="8897944981470617719" onmouseenter="enter('8897944981470617719');" onmouseout="out('8897944981470617719');" style="">  78      private static final Log LOG = LogFactory.getLog(OfferServiceImpl.class);                                     </span>
<span class="1923365470115514932" onmouseenter="enter('1923365470115514932');" onmouseout="out('1923365470115514932');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  79 -    public static final String FINALIZE_CHECKOUT = &quot;FINALIZE_CHECKOUT&quot;;                                           </span>
<span class="2963930970649904799" onmouseenter="enter('2963930970649904799');" onmouseout="out('2963930970649904799');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  80 -    public static final String OFFERS_EXPIRED = &quot;OFFERS_EXPIRED&quot;;                                                 </span>
<span  style="">  81                                                                                                                    </span>
<span class="3846751699212951796" onmouseenter="enter('3846751699212951796');" onmouseout="out('3846751699212951796');" style="">  82      // should be called outside of Offer service after Offer service is executed                                  </span>
<span class="-5484979233832760683" onmouseenter="enter('-5484979233832760683');" onmouseout="out('-5484979233832760683');" style="">  83      @Resource(name=&quot;blCustomerOfferDao&quot;)                                                                          </span>
<span class="-5771823415174942027" onmouseenter="enter('-5771823415174942027');" onmouseout="out('-5771823415174942027');" style="">  84      protected CustomerOfferDao customerOfferDao;                                                                  </span>
<span  style="">  85                                                                                                                    </span>
<span class="-1524144969871346405" onmouseenter="enter('-1524144969871346405');" onmouseout="out('-1524144969871346405');" style="">  86      @Resource(name=&quot;blOfferCodeDao&quot;)                                                                              </span>
<span class="-6984238934820524758" onmouseenter="enter('-6984238934820524758');" onmouseout="out('-6984238934820524758');" style="">  87      protected OfferCodeDao offerCodeDao;                                                                          </span>
<span  style="">  88                                                                                                                    </span>
<span class="-8247969455122443370" onmouseenter="enter('-8247969455122443370');" onmouseout="out('-8247969455122443370');" style="">  89      @Resource(name=&quot;blOfferAuditService&quot;)                                                                         </span>
<span class="-6742419488595856311" onmouseenter="enter('-6742419488595856311');" onmouseout="out('-6742419488595856311');" style="">  90      protected OfferAuditService offerAuditService;                                                                </span>
<span  style="">  91                                                                                                                    </span>
<span class="-6976077299079381435" onmouseenter="enter('-6976077299079381435');" onmouseout="out('-6976077299079381435');" style="">  92      @Resource(name=&quot;blOfferDao&quot;)                                                                                  </span>
<span class="8858788780557179486" onmouseenter="enter('8858788780557179486');" onmouseout="out('8858788780557179486');" style="">  93      protected OfferDao offerDao;                                                                                  </span>
<span  style="">  94                                                                                                                    </span>
<span class="-3191658961867656636" onmouseenter="enter('-3191658961867656636');" onmouseout="out('-3191658961867656636');" style="">  95      @Resource(name=&quot;blOrderOfferProcessor&quot;)                                                                       </span>
<span class="-3818126380928091101" onmouseenter="enter('-3818126380928091101');" onmouseout="out('-3818126380928091101');" style="">  96      protected OrderOfferProcessor orderOfferProcessor;                                                            </span>
<span  style="">  97                                                                                                                    </span>
<span class="-6223428528083119866" onmouseenter="enter('-6223428528083119866');" onmouseout="out('-6223428528083119866');" style="">  98      @Resource(name=&quot;blItemOfferProcessor&quot;)                                                                        </span>
<span class="-7827297227357944415" onmouseenter="enter('-7827297227357944415');" onmouseout="out('-7827297227357944415');" style="">  99      protected ItemOfferProcessor itemOfferProcessor;                                                              </span>
<span  style=""> 100                                                                                                                    </span>
<span class="-1476654469985531605" onmouseenter="enter('-1476654469985531605');" onmouseout="out('-1476654469985531605');" style=""> 101      @Resource(name=&quot;blFulfillmentGroupOfferProcessor&quot;)                                                            </span>
<span class="7634983124983010999" onmouseenter="enter('7634983124983010999');" onmouseout="out('7634983124983010999');" style=""> 102      protected FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor;                                      </span>
<span  style=""> 103                                                                                                                    </span>
<span class="-4330844585159307437" onmouseenter="enter('-4330844585159307437');" onmouseout="out('-4330844585159307437');" style=""> 104      @Resource(name=&quot;blPromotableItemFactory&quot;)                                                                     </span>
<span class="3092322393226863633" onmouseenter="enter('3092322393226863633');" onmouseout="out('3092322393226863633');" style=""> 105      protected PromotableItemFactory promotableItemFactory;                                                        </span>
<span  style=""> 106                                                                                                                    </span>
<span class="1476595721846482438" onmouseenter="enter('1476595721846482438');" onmouseout="out('1476595721846482438');" style=""> 107      @Resource(name = &quot;blOfferServiceExtensionManager&quot;)                                                            </span>
<span class="1854954620380588089" onmouseenter="enter('1854954620380588089');" onmouseout="out('1854954620380588089');" style=""> 108      protected OfferServiceExtensionManager extensionManager;                                                      </span>
<span  style=""> 109                                                                                                                    </span>
<span class="-6135682035086935956" onmouseenter="enter('-6135682035086935956');" onmouseout="out('-6135682035086935956');" style=""> 110      @Resource(name = &quot;blOrderService&quot;)                                                                            </span>
<span class="4242410752290390693" onmouseenter="enter('4242410752290390693');" onmouseout="out('4242410752290390693');" style=""> 111      protected OrderService orderService;                                                                          </span>
<span  style=""> 112                                                                                                                    </span>
<span class="-3946461589801993391" onmouseenter="enter('-3946461589801993391');" onmouseout="out('-3946461589801993391');" style=""> 113      @Resource(name = &quot;blSandBoxHelper&quot;)                                                                           </span>
<span class="-7799183597372200632" onmouseenter="enter('-7799183597372200632');" onmouseout="out('-7799183597372200632');" style=""> 114      protected SandBoxHelper sandBoxHelper;                                                                        </span>
<span  style=""> 115                                                                                                                    </span>
<span class="-4259734795637808055" onmouseenter="enter('-4259734795637808055');" onmouseout="out('-4259734795637808055');" style=""> 116      @PersistenceContext(unitName=&quot;blPU&quot;)                                                                          </span>
<span class="-5741815223868414625" onmouseenter="enter('-5741815223868414625');" onmouseout="out('-5741815223868414625');" style=""> 117      protected EntityManager em;                                                                                   </span>
<span  style=""> 118                                                                                                                    </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 119      @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                           </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 120      protected StreamingTransactionCapableUtil transUtil;                                                          </span>
<span  style=""> 121                                                                                                                    </span>
<span class="-8384326529234094002" onmouseenter="enter('-8384326529234094002');" onmouseout="out('-8384326529234094002');" style=""> 122      @Resource(name=&quot;blEntityDuplicator&quot;)                                                                          </span>
<span class="-9194612273021432316" onmouseenter="enter('-9194612273021432316');" onmouseout="out('-9194612273021432316');" style=""> 123      protected EntityDuplicator duplicator;                                                                        </span>
<span  style=""> 124                                                                                                                    </span>
<span class="723166851410757036" onmouseenter="enter('723166851410757036');" onmouseout="out('723166851410757036');" style=""> 125      @Resource(name=&quot;blOfferDuplicateModifier&quot;)                                                                    </span>
<span class="8658910844320022950" onmouseenter="enter('8658910844320022950');" onmouseout="out('8658910844320022950');" style=""> 126      protected EntityDuplicateModifier&lt;Offer&gt; offerDuplicateModifier;                                              </span>
<span  style=""> 127                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 128      @Override                                                                                                     </span>
<span class="-2033305286790048708" onmouseenter="enter('-2033305286790048708');" onmouseout="out('-2033305286790048708');" style=""> 129      public List&lt;Offer&gt; findAllOffers() {                                                                          </span>
<span class="2132174063530273788" onmouseenter="enter('2132174063530273788');" onmouseout="out('2132174063530273788');" style=""> 130          return offerDao.readAllOffers();                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 131      }                                                                                                             </span>
<span  style=""> 132                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 133      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 134      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="7144811092176845141" onmouseenter="enter('7144811092176845141');" onmouseout="out('7144811092176845141');" style=""> 135      public Offer save(Offer offer) {                                                                              </span>
<span class="-264708178039771798" onmouseenter="enter('-264708178039771798');" onmouseout="out('-264708178039771798');" style=""> 136          return offerDao.save(offer);                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137      }                                                                                                             </span>
<span  style=""> 138                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 139      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 140      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-5514670765130856091" onmouseenter="enter('-5514670765130856091');" onmouseout="out('-5514670765130856091');" style=""> 141      public OfferCode saveOfferCode(OfferCode offerCode) {                                                         </span>
<span class="3125778008044685658" onmouseenter="enter('3125778008044685658');" onmouseout="out('3125778008044685658');" style=""> 142          offerCode.setOffer(offerDao.save(offerCode.getOffer()));                                                  </span>
<span class="6906137479190051982" onmouseenter="enter('6906137479190051982');" onmouseout="out('6906137479190051982');" style=""> 143          return offerCodeDao.save(offerCode);                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 144      }                                                                                                             </span>
<span  style=""> 145                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 146      /**                                                                                                           </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""> 147       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,        </span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""> 148       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer        </span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 149       * cannot appear more than once in the list.                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 150       *                                                                                                            </span>
<span class="-709313334493645866" onmouseenter="enter('-709313334493645866');" onmouseout="out('-709313334493645866');" style=""> 151       * @param code                                                                                                </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 152       * @return a List of offers that may apply to this order                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 153       */                                                                                                           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 154      @Override                                                                                                     </span>
<span class="-6840847083603451180" onmouseenter="enter('-6840847083603451180');" onmouseout="out('-6840847083603451180');" style=""> 155      public Offer lookupOfferByCode(String code) {                                                                 </span>
<span class="-531732708503781646" onmouseenter="enter('-531732708503781646');" onmouseout="out('-531732708503781646');" style=""> 156          Offer offer = null;                                                                                       </span>
<span class="-8218576552188075283" onmouseenter="enter('-8218576552188075283');" onmouseout="out('-8218576552188075283');" style=""> 157          OfferCode offerCode = offerCodeDao.readOfferCodeByCode(code);                                             </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 158          if (offerCode != null) {                                                                                  </span>
<span class="-2561785727340284423" onmouseenter="enter('-2561785727340284423');" onmouseout="out('-2561785727340284423');" style=""> 159              offer = offerCode.getOffer();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160          }                                                                                                         </span>
<span class="-8963791522625561917" onmouseenter="enter('-8963791522625561917');" onmouseout="out('-8963791522625561917');" style=""> 161          return offer;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 162      }                                                                                                             </span>
<span  style=""> 163                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 164      @Override                                                                                                     </span>
<span class="2883322601430833612" onmouseenter="enter('2883322601430833612');" onmouseout="out('2883322601430833612');" style=""> 165      public OfferCode lookupOfferCodeByCode(String code){                                                          </span>
<span class="8795189428566002896" onmouseenter="enter('8795189428566002896');" onmouseout="out('8795189428566002896');" style=""> 166          return offerCodeDao.readOfferCodeByCode(code);                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 167      }                                                                                                             </span>
<span  style=""> 168                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 169      @Override                                                                                                     </span>
<span class="-2543778591938191529" onmouseenter="enter('-2543778591938191529');" onmouseout="out('-2543778591938191529');" style=""> 170      public List&lt;Offer&gt; lookupAllOffersByCode(String code) {                                                       </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 171          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                              </span>
<span class="-3360697953765841703" onmouseenter="enter('-3360697953765841703');" onmouseout="out('-3360697953765841703');" style=""> 172          List&lt;OfferCode&gt; offerCodes = offerCodeDao.readAllOfferCodesByCode(code);                                  </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 173          for (OfferCode offerCode : offerCodes) {                                                                  </span>
<span class="4240534687544668976" onmouseenter="enter('4240534687544668976');" onmouseout="out('4240534687544668976');" style=""> 174              if (offerCode != null) {                                                                              </span>
<span class="-7816274075460376657" onmouseenter="enter('-7816274075460376657');" onmouseout="out('-7816274075460376657');" style=""> 175                  offers.add(offerCode.getOffer());                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 176              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 177          }                                                                                                         </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 178          return offers;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179      }                                                                                                             </span>
<span  style=""> 180                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 181      @Override                                                                                                     </span>
<span class="4676855439599320404" onmouseenter="enter('4676855439599320404');" onmouseout="out('4676855439599320404');" style=""> 182      public List&lt;OfferCode&gt; lookupAllOfferCodesByCode(String code){                                                </span>
<span class="-4234235759448675045" onmouseenter="enter('-4234235759448675045');" onmouseout="out('-4234235759448675045');" style=""> 183          return offerCodeDao.readAllOfferCodesByCode(code);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184      }                                                                                                             </span>
<span  style=""> 185                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 186      /**                                                                                                           </span>
<span class="1999615713536044973" onmouseenter="enter('1999615713536044973');" onmouseout="out('1999615713536044973');" style=""> 187       * Creates a list of offers that applies to this order.  All offers that are assigned to the customer,        </span>
<span class="4586134706384622093" onmouseenter="enter('4586134706384622093');" onmouseout="out('4586134706384622093');" style=""> 188       * entered during checkout, or has a delivery type of automatic are added to the list.  The same offer        </span>
<span class="-6316566047140909322" onmouseenter="enter('-6316566047140909322');" onmouseout="out('-6316566047140909322');" style=""> 189       * cannot appear more than once in the list.                                                                  </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 190       *                                                                                                            </span>
<span class="6414796960983960786" onmouseenter="enter('6414796960983960786');" onmouseout="out('6414796960983960786');" style=""> 191       * @param order                                                                                               </span>
<span class="-6835612905005661064" onmouseenter="enter('-6835612905005661064');" onmouseout="out('-6835612905005661064');" style=""> 192       * @return a List of offers that may apply to this order                                                      </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 193       */                                                                                                           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 194      @Override                                                                                                     </span>
<span class="-5814298891852821500" onmouseenter="enter('-5814298891852821500');" onmouseout="out('-5814298891852821500');" style=""> 195      public List&lt;Offer&gt; buildOfferListForOrder(Order order) {                                                      </span>
<span class="2099956539522342594" onmouseenter="enter('2099956539522342594');" onmouseout="out('2099956539522342594');" style=""> 196          List&lt;Offer&gt; offers = new ArrayList&lt;Offer&gt;();                                                              </span>
<span class="-3235900677601494398" onmouseenter="enter('-3235900677601494398');" onmouseout="out('-3235900677601494398');" style=""> 197          List&lt;CustomerOffer&gt; customerOffers = lookupOfferCustomerByCustomer(order.getCustomer());                  </span>
<span class="7699769166343685501" onmouseenter="enter('7699769166343685501');" onmouseout="out('7699769166343685501');" style=""> 198          for (CustomerOffer customerOffer : customerOffers) {                                                      </span>
<span class="-2310400538171319838" onmouseenter="enter('-2310400538171319838');" onmouseout="out('-2310400538171319838');" style=""> 199              if (!offers.contains(customerOffer.getOffer())) {                                                     </span>
<span class="5233078073066950969" onmouseenter="enter('5233078073066950969');" onmouseout="out('5233078073066950969');" style=""> 200                  offers.add(customerOffer.getOffer());                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 201              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 202          }                                                                                                         </span>
<span class="4450798447253558445" onmouseenter="enter('4450798447253558445');" onmouseout="out('4450798447253558445');" style=""> 203          List&lt;OfferCode&gt; orderOfferCodes = refreshOfferCodesIfApplicable(order);                                   </span>
<span class="-5394428663749604022" onmouseenter="enter('-5394428663749604022');" onmouseout="out('-5394428663749604022');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 204 -        int before = orderOfferCodes.size();                                                                      </span>
<span class="-6665865767746694239" onmouseenter="enter('-6665865767746694239');" onmouseout="out('-6665865767746694239');" style=""> 205          orderOfferCodes = removeOutOfDateOfferCodes(orderOfferCodes);                                             </span>
<span class="8766753228261658218" onmouseenter="enter('8766753228261658218');" onmouseout="out('8766753228261658218');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 206 -        int after = orderOfferCodes.size();                                                                       </span>



<span class="2182795146752320946" onmouseenter="enter('2182795146752320946');" onmouseout="out('2182795146752320946');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 207 -        Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHECKOUT);"> 207 -        Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(FINALIZE_CHEðŸ”µ</abbr></span>
<span class="3842576300509712789" onmouseenter="enter('3842576300509712789');" onmouseout="out('3842576300509712789');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 208 -        if(o !=null &amp;&amp; (Boolean)o &amp;&amp; before!=after){                                                              </span>
<span class="-3668454086264686215" onmouseenter="enter('-3668454086264686215');" onmouseout="out('-3668454086264686215');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 209 -            BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFFERS_EXPIRED, Boolean.TRUE);"> 209 -            BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().put(OfferServiceImpl.OFðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 210 -        }                                                                                                         </span>

<span class="2682597879629079185" onmouseenter="enter('2682597879629079185');" onmouseout="out('2682597879629079185');" style=""> 211          for (OfferCode orderOfferCode : orderOfferCodes) {                                                        </span>
<span class="-1857624084667800558" onmouseenter="enter('-1857624084667800558');" onmouseout="out('-1857624084667800558');" style=""> 212              if (!offers.contains(orderOfferCode.getOffer())) {                                                    </span>
<span class="4188766124804405127" onmouseenter="enter('4188766124804405127');" onmouseout="out('4188766124804405127');" style=""> 213                  offers.add(orderOfferCode.getOffer());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 214              }                                                                                                     </span>
<span class="-4468546552745233084" onmouseenter="enter('-4468546552745233084');" onmouseout="out('-4468546552745233084');" style=""> 215              extensionManager.getProxy().addAdditionalOffersForCode(offers, orderOfferCode);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 216          }                                                                                                         </span>
<span class="-9188634082558155234" onmouseenter="enter('-9188634082558155234');" onmouseout="out('-9188634082558155234');" style=""> 217          List&lt;Offer&gt; globalOffers = lookupAutomaticDeliveryOffers();                                               </span>
<span class="-8411171878687156520" onmouseenter="enter('-8411171878687156520');" onmouseout="out('-8411171878687156520');" style=""> 218          for (Offer globalOffer : globalOffers) {                                                                  </span>
<span class="2071278729839157974" onmouseenter="enter('2071278729839157974');" onmouseout="out('2071278729839157974');" style=""> 219              if (!offers.contains(globalOffer) &amp;&amp; verifyMaxCustomerUsageThreshold(order, globalOffer)) {           </span>
<span class="-3050025518373868772" onmouseenter="enter('-3050025518373868772');" onmouseout="out('-3050025518373868772');" style=""> 220                  offers.add(globalOffer);                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 222          }                                                                                                         </span>
<span  style=""> 223                                                                                                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 224          if (extensionManager != null) {                                                                           </span>
<span class="1817402996237899777" onmouseenter="enter('1817402996237899777');" onmouseout="out('1817402996237899777');" style=""> 225              extensionManager.applyAdditionalFilters(offers, order);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 226          }                                                                                                         </span>
<span  style=""> 227                                                                                                                    </span>
<span class="1843080783963809440" onmouseenter="enter('1843080783963809440');" onmouseout="out('1843080783963809440');" style=""> 228          return offers;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 229      }                                                                                                             </span>
<span  style=""> 230                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 231      @Override                                                                                                     </span>
<span class="2056305643902587707" onmouseenter="enter('2056305643902587707');" onmouseout="out('2056305643902587707');" style=""> 232      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Order order) {                                           </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 233          Customer customer = order.getCustomer();                                                                  </span>
<span class="-5041998041456755776" onmouseenter="enter('-5041998041456755776');" onmouseout="out('-5041998041456755776');" style=""> 234          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;&gt;();                                                      </span>
<span  style=""> 235                                                                                                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 236          if (extensionManager != null) {                                                                           </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 237              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238          }                                                                                                         </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 239          if (!offerCodes.isEmpty()) {                                                                              </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 240              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                                      </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 241              while (itr.hasNext()) {                                                                               </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 242                  OfferCode offerCode = itr.next();                                                                 </span>
<span class="-776136422183497161" onmouseenter="enter('-776136422183497161');" onmouseout="out('-776136422183497161');" style=""> 243                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(order, offerCode)) {                </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 244                      itr.remove();                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 245                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 246              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 247          }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 248          return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 249      }                                                                                                             </span>
<span  style=""> 250                                                                                                                    </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 251      @Deprecated                                                                                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 252      @Override                                                                                                     </span>
<span class="3843851677430304310" onmouseenter="enter('3843851677430304310');" onmouseout="out('3843851677430304310');" style=""> 253      public List&lt;OfferCode&gt; buildOfferCodeListForCustomer(Customer customer) {                                     </span>
<span class="-6957816096303048614" onmouseenter="enter('-6957816096303048614');" onmouseout="out('-6957816096303048614');" style=""> 254          ArrayList&lt;OfferCode&gt; offerCodes = new ArrayList&lt;OfferCode&gt;();                                             </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 255          if (extensionManager != null) {                                                                           </span>
<span class="2705805432104274261" onmouseenter="enter('2705805432104274261');" onmouseout="out('2705805432104274261');" style=""> 256              extensionManager.buildOfferCodeListForCustomer(customer, offerCodes);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 257          }                                                                                                         </span>
<span class="-6612931616346502381" onmouseenter="enter('-6612931616346502381');" onmouseout="out('-6612931616346502381');" style=""> 258          if (!offerCodes.isEmpty()) {                                                                              </span>
<span class="7586150380940115071" onmouseenter="enter('7586150380940115071');" onmouseout="out('7586150380940115071');" style=""> 259              Iterator&lt;OfferCode&gt; itr = offerCodes.iterator();                                                      </span>
<span class="-1927883489771171385" onmouseenter="enter('-1927883489771171385');" onmouseout="out('-1927883489771171385');" style=""> 260              while (itr.hasNext()) {                                                                               </span>
<span class="-7575980556971435256" onmouseenter="enter('-7575980556971435256');" onmouseout="out('-7575980556971435256');" style=""> 261                  OfferCode offerCode = itr.next();                                                                 </span>
<span class="6086018267170409432" onmouseenter="enter('6086018267170409432');" onmouseout="out('6086018267170409432');" style=""> 262                  if (!offerCode.isActive() || !verifyMaxCustomerUsageThreshold(customer, offerCode)) {             </span>
<span class="8671827622721429867" onmouseenter="enter('8671827622721429867');" onmouseout="out('8671827622721429867');" style=""> 263                      itr.remove();                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 264                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 265              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 266          }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 267          return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 268      }                                                                                                             </span>
<span  style=""> 269                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 270      /**                                                                                                           </span>
<span class="2837560355574155003" onmouseenter="enter('2837560355574155003');" onmouseout="out('2837560355574155003');" style=""> 271       * Private method used to retrieve all offers assigned to this customer.  These offers are                    </span>
<span class="4852710310174118924" onmouseenter="enter('4852710310174118924');" onmouseout="out('4852710310174118924');" style=""> 272       * programmatically assigned to the customer.                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 273       *                                                                                                            </span>
<span class="1094425505394812731" onmouseenter="enter('1094425505394812731');" onmouseout="out('1094425505394812731');" style=""> 274       * @param customer                                                                                            </span>
<span class="-3868237647402015492" onmouseenter="enter('-3868237647402015492');" onmouseout="out('-3868237647402015492');" style=""> 275       * @return a List of offers assigned to the customer                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 276       */                                                                                                           </span>
<span class="-1064959765029423996" onmouseenter="enter('-1064959765029423996');" onmouseout="out('-1064959765029423996');" style=""> 277      protected List&lt;CustomerOffer&gt; lookupOfferCustomerByCustomer(Customer customer) {                              </span>
<span class="1699675085073278700" onmouseenter="enter('1699675085073278700');" onmouseout="out('1699675085073278700');" style=""> 278          List&lt;CustomerOffer&gt; offerCustomers = customerOfferDao.readCustomerOffersByCustomer(customer);             </span>
<span class="5611761187435301880" onmouseenter="enter('5611761187435301880');" onmouseout="out('5611761187435301880');" style=""> 279          return offerCustomers;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 280      }                                                                                                             </span>
<span  style=""> 281                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 282      /**                                                                                                           </span>
<span class="-8831229104457932482" onmouseenter="enter('-8831229104457932482');" onmouseout="out('-8831229104457932482');" style=""> 283       * Private method used to retrieve all offers with automaticallyAdded set to true                             </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 284       *                                                                                                            </span>
<span class="-2057313490179191281" onmouseenter="enter('-2057313490179191281');" onmouseout="out('-2057313490179191281');" style=""> 285       * @return a List of automatic delivery offers                                                                </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 286       */                                                                                                           </span>
<span class="-9186908469762752320" onmouseenter="enter('-9186908469762752320');" onmouseout="out('-9186908469762752320');" style=""> 287      protected List&lt;Offer&gt; lookupAutomaticDeliveryOffers() {                                                       </span>
<span class="-2657712449795339218" onmouseenter="enter('-2657712449795339218');" onmouseout="out('-2657712449795339218');" style=""> 288          List&lt;Offer&gt; globalOffers = offerDao.readOffersByAutomaticDeliveryType();                                  </span>
<span class="-7738403477037597046" onmouseenter="enter('-7738403477037597046');" onmouseout="out('-7738403477037597046');" style=""> 289          return globalOffers;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 290      }                                                                                                             </span>
<span  style=""> 291                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 292      /**                                                                                                           </span>
<span class="-582485916100204765" onmouseenter="enter('-582485916100204765');" onmouseout="out('-582485916100204765');" style=""> 293       * Removes all out of date offerCodes based on the offerCode and its offer&#x27;s start and end                    </span>
<span class="-591413864231465226" onmouseenter="enter('-591413864231465226');" onmouseout="out('-591413864231465226');" style=""> 294       * date.  If an offerCode has a later start date, that offerCode will be removed.                             </span>
<span class="-1600892852414517397" onmouseenter="enter('-1600892852414517397');" onmouseout="out('-1600892852414517397');" style=""> 295       * OfferCodes without a start date will still be processed. If the offerCode                                  </span>
<span class="-6972954356288154926" onmouseenter="enter('-6972954356288154926');" onmouseout="out('-6972954356288154926');" style=""> 296       * has a end date that has already passed, that offerCode will be removed.  OfferCodes                        </span>
<span class="-7007360996659097530" onmouseenter="enter('-7007360996659097530');" onmouseout="out('-7007360996659097530');" style=""> 297       * without a end date will be processed.  The start and end dates on the offer will                           </span>
<span class="-216139196908541615" onmouseenter="enter('-216139196908541615');" onmouseout="out('-216139196908541615');" style=""> 298       * still need to be evaluated.                                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 299       *                                                                                                            </span>
<span class="-142155654396048960" onmouseenter="enter('-142155654396048960');" onmouseout="out('-142155654396048960');" style=""> 300       * @param offerCodes                                                                                          </span>
<span class="-7645314644020819692" onmouseenter="enter('-7645314644020819692');" onmouseout="out('-7645314644020819692');" style=""> 301       * @return a List of non-expired offers                                                                       </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 302       */                                                                                                           </span>
<span class="3097073257270455619" onmouseenter="enter('3097073257270455619');" onmouseout="out('3097073257270455619');" style=""> 303      protected List&lt;OfferCode&gt; removeOutOfDateOfferCodes(List&lt;OfferCode&gt; offerCodes){                              </span>
<span class="-71581284051087612" onmouseenter="enter('-71581284051087612');" onmouseout="out('-71581284051087612');" style=""> 304          List&lt;OfferCode&gt; offerCodesToRemove = new ArrayList&lt;OfferCode&gt;();                                          </span>
<span class="8649045155270180220" onmouseenter="enter('8649045155270180220');" onmouseout="out('8649045155270180220');" style=""> 305          for (OfferCode offerCode : offerCodes) {                                                                  </span>
<span class="4179739580098873664" onmouseenter="enter('4179739580098873664');" onmouseout="out('4179739580098873664');" style=""> 306              if (!offerCode.isActive()){                                                                           </span>
<span class="2973899686965396382" onmouseenter="enter('2973899686965396382');" onmouseout="out('2973899686965396382');" style=""> 307                  offerCodesToRemove.add(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 308              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 309          }                                                                                                         </span>
<span class="3113103044265464111" onmouseenter="enter('3113103044265464111');" onmouseout="out('3113103044265464111');" style=""> 310          // remove all offers in the offersToRemove list from original offers list                                 </span>
<span class="6883206030034557562" onmouseenter="enter('6883206030034557562');" onmouseout="out('6883206030034557562');" style=""> 311          for (OfferCode offerCode : offerCodesToRemove) {                                                          </span>
<span class="-8473869847996752510" onmouseenter="enter('-8473869847996752510');" onmouseout="out('-8473869847996752510');" style=""> 312              offerCodes.remove(offerCode);                                                                         </span>















<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 313          }                                                                                                         </span>
<span class="653750789058942996" onmouseenter="enter('653750789058942996');" onmouseout="out('653750789058942996');" style=""> 314          return offerCodes;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 315      }                                                                                                             </span>
<span  style=""> 316                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 317      /**                                                                                                           </span>
<span class="5637961435104982406" onmouseenter="enter('5637961435104982406');" onmouseout="out('5637961435104982406');" style=""> 318       * For enterprise installations, this will refresh any OfferCodes found to be out-of-date with                </span>
<span class="1724276086246688719" onmouseenter="enter('1724276086246688719');" onmouseout="out('1724276086246688719');" style=""> 319       * current sandbox status.                                                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 320       *                                                                                                            </span>
<span class="202872854140107873" onmouseenter="enter('202872854140107873');" onmouseout="out('202872854140107873');" style=""> 321       * @param order the order to check                                                                            </span>
<span class="2772482249434351691" onmouseenter="enter('2772482249434351691');" onmouseout="out('2772482249434351691');" style=""> 322       * @return the refreshed list of OfferCodes                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 323       */                                                                                                           </span>
<span class="7210051143895905366" onmouseenter="enter('7210051143895905366');" onmouseout="out('7210051143895905366');" style=""> 324      protected List&lt;OfferCode&gt; refreshOfferCodesIfApplicable(final Order order) {                                  </span>
<span class="7464496307728629396" onmouseenter="enter('7464496307728629396');" onmouseout="out('7464496307728629396');" style=""> 325          final List&lt;OfferCode&gt; orderOfferCodes = order.getAddedOfferCodes();                                       </span>
<span  style=""> 326                                                                                                                    </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 327          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 328              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 329              public void execute() {                                                                               </span>
<span class="-6058145000184664425" onmouseenter="enter('-6058145000184664425');" onmouseout="out('-6058145000184664425');" style=""> 330                  for (OfferCode offerCode : orderOfferCodes) {                                                     </span>
<span class="-4263515828536000223" onmouseenter="enter('-4263515828536000223');" onmouseout="out('-4263515828536000223');" style=""> 331                      if (offerCode.getOffer() != null) {                                                           </span>
<span class="8507823172595815939" onmouseenter="enter('8507823172595815939');" onmouseout="out('8507823172595815939');" style=""><abbr title=" 332                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOffer().getId());"> 332                          Long sandBoxVersionId = sandBoxHelper.getSandBoxVersionId(OfferImpl.class, offerCode.getOfðŸ”µ</abbr></span>
<span class="-4217337457935304447" onmouseenter="enter('-4217337457935304447');" onmouseout="out('-4217337457935304447');" style=""><abbr title=" 333                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getId())) {"> 333                          if (sandBoxVersionId != null &amp;&amp; !Objects.equals(sandBoxVersionId, offerCode.getOffer().getðŸ”µ</abbr></span>
<span class="-6104864632261418874" onmouseenter="enter('-6104864632261418874');" onmouseout="out('-6104864632261418874');" style=""> 334                              em.refresh(offerCode);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 335                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 336                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 337                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 338              }                                                                                                     </span>
<span  style=""> 339                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 340              @Override                                                                                             </span>
<span class="1336357167460974281" onmouseenter="enter('1336357167460974281');" onmouseout="out('1336357167460974281');" style=""> 341              public boolean shouldRetryOnTransactionLockAcquisitionFailure() {                                     </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 342                  return true;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 343              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 344          }, RuntimeException.class);                                                                               </span>
<span  style=""> 345                                                                                                                    </span>
<span class="720292142172901868" onmouseenter="enter('720292142172901868');" onmouseout="out('720292142172901868');" style=""> 346          return orderOfferCodes;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 347      }                                                                                                             </span>
<span  style=""> 348                                                                                                                    </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 349      /*                                                                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 350       *                                                                                                            </span>
<span class="-1078885518483632555" onmouseenter="enter('-1078885518483632555');" onmouseout="out('-1078885518483632555');" style=""> 351       * Offers Logic:                                                                                              </span>
<span class="-6544489594486398439" onmouseenter="enter('-6544489594486398439');" onmouseout="out('-6544489594486398439');" style=""> 352       * 1) Remove all existing offers in the Order (order, item, and fulfillment)                                  </span>
<span class="472654013095872963" onmouseenter="enter('472654013095872963');" onmouseout="out('472654013095872963');" style=""> 353       * 2) Check and remove offers                                                                                 </span>
<span class="8111384560802328496" onmouseenter="enter('8111384560802328496');" onmouseout="out('8111384560802328496');" style=""> 354       *    a) Remove out of date offers                                                                            </span>
<span class="3025649188866691570" onmouseenter="enter('3025649188866691570');" onmouseout="out('3025649188866691570');" style=""> 355       *    b) Remove offers that do not apply to this customer                                                     </span>
<span class="5156402814943015913" onmouseenter="enter('5156402814943015913');" onmouseout="out('5156402814943015913');" style=""> 356       * 3) Loop through offers                                                                                     </span>
<span class="6235203245796610706" onmouseenter="enter('6235203245796610706');" onmouseout="out('6235203245796610706');" style=""> 357       *    a) Verifies type of offer (order, order item, fulfillment)                                              </span>
<span class="7315686159335672158" onmouseenter="enter('7315686159335672158');" onmouseout="out('7315686159335672158');" style=""> 358       *    b) Verifies if offer can be applies                                                                     </span>
<span class="-6634234506054969031" onmouseenter="enter('-6634234506054969031');" onmouseout="out('-6634234506054969031');" style=""> 359       *    c) Assign offer to type (order, order item, or fulfillment)                                             </span>
<span class="-4584093434328536587" onmouseenter="enter('-4584093434328536587');" onmouseout="out('-4584093434328536587');" style=""> 360       * 4) Sorts the order and item offers list by priority and then discount                                      </span>
<span class="-2042995489836168848" onmouseenter="enter('-2042995489836168848');" onmouseout="out('-2042995489836168848');" style=""> 361       * 5) Identify the best offers to apply to order item and create adjustments for each item offer              </span>
<span class="8597383329030492662" onmouseenter="enter('8597383329030492662');" onmouseout="out('8597383329030492662');" style=""> 362       * 6) Compare order item adjustment price to sales price, and remove adjustments if sale price is better      </span>
<span class="-5003028621529242985" onmouseenter="enter('-5003028621529242985');" onmouseout="out('-5003028621529242985');" style=""> 363       * 7) Identify the best offers to apply to the order and create adjustments for each order offer              </span>
<span class="-1324083657955785943" onmouseenter="enter('-1324083657955785943');" onmouseout="out('-1324083657955785943');" style=""><abbr title=" 364       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount value"> 364       * 8) If item contains non-combinable offers remove either the item or order adjustments based on discount valðŸ”µ</abbr></span>
<span class="-8610949319074908232" onmouseenter="enter('-8610949319074908232');" onmouseout="out('-8610949319074908232');" style=""> 365       * 9) Set final order item prices and reapply order offers                                                    </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 366       *                                                                                                            </span>
<span class="9071544830737596533" onmouseenter="enter('9071544830737596533');" onmouseout="out('9071544830737596533');" style=""> 367       * Assumptions:                                                                                               </span>
<span class="7676524731541901514" onmouseenter="enter('7676524731541901514');" onmouseout="out('7676524731541901514');" style=""> 368       * 1) % off all items will be created as an item offer with no expression                                     </span>
<span class="-814522364757940962" onmouseenter="enter('-814522364757940962');" onmouseout="out('-814522364757940962');" style=""> 369       * 2) $ off order will be created as an order offer                                                           </span>
<span class="7365449813142531261" onmouseenter="enter('7365449813142531261');" onmouseout="out('7365449813142531261');" style=""> 370       * 3) Order offers applies to the best price for each item (not just retail price)                            </span>
<span class="-1636653647835076359" onmouseenter="enter('-1636653647835076359');" onmouseout="out('-1636653647835076359');" style=""> 371       * 4) Fulfillment offers apply to best price for each item (not just retail price)                            </span>
<span class="-5866280996345915157" onmouseenter="enter('-5866280996345915157');" onmouseout="out('-5866280996345915157');" style=""><abbr title=" 372       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item offers)"> 372       * 5) Stackable only applies to the same offer type (i.e. a not stackable order offer can be used with item ofðŸ”µ</abbr></span>
<span class="-8022045642448063338" onmouseenter="enter('-8022045642448063338');" onmouseout="out('-8022045642448063338');" style=""> 373       * 6) Fulfillment offers cannot be not combinable                                                             </span>
<span class="-5108644804585013203" onmouseenter="enter('-5108644804585013203');" onmouseout="out('-5108644804585013203');" style=""> 374       * 7) Order offers cannot be FIXED_PRICE                                                                      </span>
<span class="6161153439596163093" onmouseenter="enter('6161153439596163093');" onmouseout="out('6161153439596163093');" style=""> 375       * 8) FIXED_PRICE offers cannot be stackable                                                                  </span>
<span class="7044504232316014062" onmouseenter="enter('7044504232316014062');" onmouseout="out('7044504232316014062');" style=""><abbr title=" 376       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always apply"> 376       * 9) Non-combinable offers only apply to the order and order items, fulfillment group offers will always applðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 377       *                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 378       */                                                                                                           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 379      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 380      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-4704847871427432866" onmouseenter="enter('-4704847871427432866');" onmouseout="out('-4704847871427432866');" style=""> 381      public Order applyAndSaveOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {             </span>
<span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style=""> 382          /*                                                                                                        </span>
<span class="-6180845550366984877" onmouseenter="enter('-6180845550366984877');" onmouseout="out('-6180845550366984877');" style=""> 383          TODO rather than a threadlocal, we should update the &quot;shouldPrice&quot; boolean on the service API to          </span>
<span class="9161254164549280190" onmouseenter="enter('9161254164549280190');" onmouseout="out('9161254164549280190');" style=""> 384          use a richer object to describe the parameters of the pricing call. This object would include             </span>
<span class="1561516658361300705" onmouseenter="enter('1561516658361300705');" onmouseout="out('1561516658361300705');" style=""> 385          the pricing boolean, but would also include a list of activities to include or exclude in the             </span>
<span class="-6797832594843538707" onmouseenter="enter('-6797832594843538707');" onmouseout="out('-6797832594843538707');" style=""> 386          call - see http://jira.broadleafcommerce.org/browse/BLC-664                                               </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 387           */                                                                                                       </span>











<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 388          OfferContext offerContext = OfferContext.getOfferContext();                                               </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 389          if (offerContext == null || offerContext.executePromotionCalculation) {                                   </span>
<span class="-2683885994659783076" onmouseenter="enter('-2683885994659783076');" onmouseout="out('-2683885994659783076');" style=""> 390              PromotableOrder promotableOrder = promotableItemFactory.createPromotableOrder(order, false);          </span>


<span class="-9066266687178937853" onmouseenter="enter('-9066266687178937853');" onmouseout="out('-9066266687178937853');" style=""> 391              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(offers, order.getCustomer());           </span>
<span class="-1421782411503697087" onmouseenter="enter('-1421782411503697087');" onmouseout="out('-1421782411503697087');" style=""> 392              if ((filteredOffers == null) || (filteredOffers.isEmpty())) {                                         </span>
<span class="1446253227197554536" onmouseenter="enter('1446253227197554536');" onmouseout="out('1446253227197554536');" style=""> 393                  if (LOG.isTraceEnabled()) {                                                                       </span>
<span class="2760579588161124045" onmouseenter="enter('2760579588161124045');" onmouseout="out('2760579588161124045');" style=""> 394                      LOG.trace(&quot;No offers applicable to this order.&quot;);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 395                  }                                                                                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 396              } else {                                                                                              </span>
<span class="7300520529047311728" onmouseenter="enter('7300520529047311728');" onmouseout="out('7300520529047311728');" style=""><abbr title=" 397                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOffer&gt;();"> 397                  List&lt;PromotableCandidateOrderOffer&gt; qualifiedOrderOffers = new ArrayList&lt;PromotableCandidateOrderOðŸ”µ</abbr></span>
<span class="-7404348590242143631" onmouseenter="enter('-7404348590242143631');" onmouseout="out('-7404348590242143631');" style=""><abbr title=" 398                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffer&gt;();"> 398                  List&lt;PromotableCandidateItemOffer&gt; qualifiedItemOffers = new ArrayList&lt;PromotableCandidateItemOffeðŸ”µ</abbr></span>
<span  style=""> 399                                                                                                                    </span>
<span class="-5526882442984993330" onmouseenter="enter('-5526882442984993330');" onmouseout="out('-5526882442984993330');" style=""><abbr title=" 400                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItemOffers);"> 400                  itemOfferProcessor.filterOffers(promotableOrder, filteredOffers, qualifiedOrderOffers, qualifiedItðŸ”µ</abbr></span>
<span  style=""> 401                                                                                                                    </span>
<span class="-6480919216777131248" onmouseenter="enter('-6480919216777131248');" onmouseout="out('-6480919216777131248');" style=""> 402                  if (! (qualifiedItemOffers.isEmpty() &amp;&amp; qualifiedOrderOffers.isEmpty())) {                        </span>
<span class="-2723881742436166059" onmouseenter="enter('-2723881742436166059');" onmouseout="out('-2723881742436166059');" style=""> 403                      // At this point, we should have a PromotableOrder that contains PromotableItems each of which</span>
<span class="751015906320167144" onmouseenter="enter('751015906320167144');" onmouseout="out('751015906320167144');" style=""> 404                      // has a list of candidatePromotions that might be applied.                                   </span>
<span  style=""> 405                                                                                                                    </span>
<span class="5941864862011378901" onmouseenter="enter('5941864862011378901');" onmouseout="out('5941864862011378901');" style=""><abbr title=" 406                      // We also have a list of orderOffers that might apply and a list of itemOffers that might apply."> 406                      // We also have a list of orderOffers that might apply and a list of itemOffers that might appðŸ”µ</abbr></span>
<span class="1127078869550353626" onmouseenter="enter('1127078869550353626');" onmouseout="out('1127078869550353626');" style=""><abbr title=" 407                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, qualifiedItemOffers);"> 407                      itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder, qualifiedOrderOffers, quðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 408                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 409              }                                                                                                     </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 410              orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                                 </span>
<span  style=""> 411                                                                                                                    </span>
<span class="514986819999277890" onmouseenter="enter('514986819999277890');" onmouseout="out('514986819999277890');" style=""> 412              verifyAdjustments(order, true);                                                                       </span>
<span  style=""> 413                                                                                                                    </span>
<span class="-8901364638816691349" onmouseenter="enter('-8901364638816691349');" onmouseout="out('-8901364638816691349');" style=""> 414              order.setSubTotal(order.calculateSubTotal());                                                         </span>
<span class="8881079200386597596" onmouseenter="enter('8881079200386597596');" onmouseout="out('8881079200386597596');" style=""> 415              order.finalizeItemPrices();                                                                           </span>
<span  style=""> 416                                                                                                                    </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 417              order = orderService.save(order, false);                                                              </span>
<span  style=""> 418                                                                                                                    </span>
<span class="-5335273514929397197" onmouseenter="enter('-5335273514929397197');" onmouseout="out('-5335273514929397197');" style=""> 419              boolean madeChange = verifyAdjustments(order, false);                                                 </span>
<span class="-3218959195648057803" onmouseenter="enter('-3218959195648057803');" onmouseout="out('-3218959195648057803');" style=""> 420              if (madeChange) {                                                                                     </span>
<span class="6494558446725059340" onmouseenter="enter('6494558446725059340');" onmouseout="out('6494558446725059340');" style=""> 421                  order = orderService.save(order, false);                                                          </span>













<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 422              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 423          }                                                                                                         </span>
<span  style=""> 424                                                                                                                    </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 425          return order;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 426      }                                                                                                             </span>
<span  style=""> 427                                                                                                                    </span>
<span class="219209447823395758" onmouseenter="enter('219209447823395758');" onmouseout="out('219209447823395758');" style=""> 428      protected boolean verifyAdjustments(Order order, boolean beforeSave) {                                        </span>
<span class="79408939766017075" onmouseenter="enter('79408939766017075');" onmouseout="out('79408939766017075');" style=""> 429          boolean madeChange = false;                                                                               </span>
<span  style=""> 430                                                                                                                    </span>
<span class="-8966123689509035198" onmouseenter="enter('-8966123689509035198');" onmouseout="out('-8966123689509035198');" style=""> 431          if (order.getOrderItems() == null) {                                                                      </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 432              return madeChange;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 433          }                                                                                                         </span>
<span  style=""> 434                                                                                                                    </span>
<span class="8447029191885982498" onmouseenter="enter('8447029191885982498');" onmouseout="out('8447029191885982498');" style=""> 435          for (OrderItem oi : order.getOrderItems()) {                                                              </span>
<span class="-5982197742320851056" onmouseenter="enter('-5982197742320851056');" onmouseout="out('-5982197742320851056');" style=""> 436              if (oi.getOrderItemPriceDetails() == null) {                                                          </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 437                  continue;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 438              }                                                                                                     </span>
<span  style=""> 439                                                                                                                    </span>
<span class="7391296704731194189" onmouseenter="enter('7391296704731194189');" onmouseout="out('7391296704731194189');" style=""> 440              for (OrderItemPriceDetail pd : oi.getOrderItemPriceDetails()) {                                       </span>
<span class="-8259157388002947293" onmouseenter="enter('-8259157388002947293');" onmouseout="out('-8259157388002947293');" style=""> 441                  if (pd.getOrderItemPriceDetailAdjustments() == null) {                                            </span>
<span class="-6362435147834875541" onmouseenter="enter('-6362435147834875541');" onmouseout="out('-6362435147834875541');" style=""> 442                      continue;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 443                  }                                                                                                 </span>
<span  style=""> 444                                                                                                                    </span>
<span class="-8160497408394725913" onmouseenter="enter('-8160497408394725913');" onmouseout="out('-8160497408394725913');" style=""><abbr title=" 445                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;();"> 445                  Map&lt;Long, OrderItemPriceDetailAdjustment&gt; adjs = new HashMap&lt;Long, OrderItemPriceDetailAdjustment&gt;ðŸ”µ</abbr></span>
<span class="2858076988107155086" onmouseenter="enter('2858076988107155086');" onmouseout="out('2858076988107155086');" style=""><abbr title=" 446                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjustment&gt;();"> 446                  List&lt;OrderItemPriceDetailAdjustment&gt; adjustmentsToRemove = new ArrayList&lt;OrderItemPriceDetailAdjusðŸ”µ</abbr></span>
<span class="-3008507732031274392" onmouseenter="enter('-3008507732031274392');" onmouseout="out('-3008507732031274392');" style=""> 447                  for (OrderItemPriceDetailAdjustment adj : pd.getOrderItemPriceDetailAdjustments()) {              </span>
<span class="-1975641521768786423" onmouseenter="enter('-1975641521768786423');" onmouseout="out('-1975641521768786423');" style=""> 448                      if (adjs.containsKey(adj.getOffer().getId())) {                                               </span>
<span class="-6913168070672082713" onmouseenter="enter('-6913168070672082713');" onmouseout="out('-6913168070672082713');" style=""> 449                          adjustmentsToRemove.add(adj);                                                             </span>
<span class="4800026243591222227" onmouseenter="enter('4800026243591222227');" onmouseout="out('4800026243591222227');" style=""> 450                          if (LOG.isDebugEnabled()) {                                                               </span>
<span class="-2834336870885753779" onmouseenter="enter('-2834336870885753779');" onmouseout="out('-2834336870885753779');" style=""> 451                              StringBuilder sb = new StringBuilder(&quot;Detected collisions &quot;)                          </span>
<span class="201513945492742471" onmouseenter="enter('201513945492742471');" onmouseout="out('201513945492742471');" style=""> 452                                  .append(beforeSave ? &quot;before saving&quot; : &quot;after saving&quot;)                            </span>
<span class="2195430440089355634" onmouseenter="enter('2195430440089355634');" onmouseout="out('2195430440089355634');" style=""> 453                                  .append(&quot; with ids &quot;)                                                             </span>
<span class="-3149719647859419210" onmouseenter="enter('-3149719647859419210');" onmouseout="out('-3149719647859419210');" style=""> 454                                  .append(adjs.get(adj.getOffer().getId()).getId())                                 </span>
<span class="7312533819175146387" onmouseenter="enter('7312533819175146387');" onmouseout="out('7312533819175146387');" style=""> 455                                  .append(&quot; and &quot;)                                                                  </span>
<span class="6832270653349147085" onmouseenter="enter('6832270653349147085');" onmouseout="out('6832270653349147085');" style=""> 456                                  .append(adj.getId());                                                             </span>
<span class="7612965875014623443" onmouseenter="enter('7612965875014623443');" onmouseout="out('7612965875014623443');" style=""> 457                              LOG.debug(sb.toString());                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 458                          }                                                                                         </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 459                      } else {                                                                                      </span>
<span class="-7759509127049565554" onmouseenter="enter('-7759509127049565554');" onmouseout="out('-7759509127049565554');" style=""> 460                          adjs.put(adj.getOffer().getId(), adj);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 461                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462                  }                                                                                                 </span>
<span  style=""> 463                                                                                                                    </span>
<span class="7848730128284985932" onmouseenter="enter('7848730128284985932');" onmouseout="out('7848730128284985932');" style=""> 464                  for (OrderItemPriceDetailAdjustment adj : adjustmentsToRemove) {                                  </span>
<span class="6756116260498887863" onmouseenter="enter('6756116260498887863');" onmouseout="out('6756116260498887863');" style=""> 465                      pd.getOrderItemPriceDetailAdjustments().remove(adj);                                          </span>
<span class="5571803755205047298" onmouseenter="enter('5571803755205047298');" onmouseout="out('5571803755205047298');" style=""> 466                      madeChange = true;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 467                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 468              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 469          }                                                                                                         </span>
<span  style=""> 470                                                                                                                    </span>
<span class="-6246613001880661859" onmouseenter="enter('-6246613001880661859');" onmouseout="out('-6246613001880661859');" style=""> 471          return madeChange;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 472       }                                                                                                            </span>
<span  style=""> 473                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 474      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 475      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 476      @Deprecated                                                                                                   </span>
<span class="-3021599232242429775" onmouseenter="enter('-3021599232242429775');" onmouseout="out('-3021599232242429775');" style=""> 477      public void applyOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {                     </span>
<span class="-6341015309393843959" onmouseenter="enter('-6341015309393843959');" onmouseout="out('-6341015309393843959');" style=""> 478          applyAndSaveOffersToOrder(offers, order);                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 479      }                                                                                                             </span>
<span  style=""> 480                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 481      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 482      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 483      @Deprecated                                                                                                   </span>
<span class="-5535279977913938928" onmouseenter="enter('-5535279977913938928');" onmouseout="out('-5535279977913938928');" style=""> 484      public void applyFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {     </span>
<span class="6394386461467124428" onmouseenter="enter('6394386461467124428');" onmouseout="out('6394386461467124428');" style=""> 485          applyAndSaveFulfillmentGroupOffersToOrder(offers, order);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 486      }                                                                                                             </span>
<span  style=""> 487                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 488      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 489      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="2855881782634007850" onmouseenter="enter('2855881782634007850');" onmouseout="out('2855881782634007850');" style=""><abbr title=" 490      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingException {"> 490      public Order applyAndSaveFulfillmentGroupOffersToOrder(List&lt;Offer&gt; offers, Order order) throws PricingExceptioðŸ”µ</abbr></span>
<span class="1234170158446074202" onmouseenter="enter('1234170158446074202');" onmouseout="out('1234170158446074202');" style=""> 491          OfferContext offerContext = OfferContext.getOfferContext();                                               </span>
<span class="-8123100641957448062" onmouseenter="enter('-8123100641957448062');" onmouseout="out('-8123100641957448062');" style=""> 492          if (offerContext == null || offerContext.executePromotionCalculation) {                                   </span>
<span class="-791836473256513905" onmouseenter="enter('-791836473256513905');" onmouseout="out('-791836473256513905');" style=""> 493              PromotableOrder promotableOrder =                                                                     </span>
<span class="-5771222684966163235" onmouseenter="enter('-5771222684966163235');" onmouseout="out('-5771222684966163235');" style=""> 494                      promotableItemFactory.createPromotableOrder(order, true);                                     </span>
<span class="-6252467951249219732" onmouseenter="enter('-6252467951249219732');" onmouseout="out('-6252467951249219732');" style=""> 495              List&lt;Offer&gt; possibleFGOffers = new ArrayList&lt;Offer&gt;();                                                </span>
<span class="-8689854403875612694" onmouseenter="enter('-8689854403875612694');" onmouseout="out('-8689854403875612694');" style=""> 496              for (Offer offer : offers) {                                                                          </span>
<span class="3344482016035270743" onmouseenter="enter('3344482016035270743');" onmouseout="out('3344482016035270743');" style=""> 497                  if (offer.getType().getType().equals(OfferType.FULFILLMENT_GROUP.getType())) {                    </span>
<span class="2965579239059640859" onmouseenter="enter('2965579239059640859');" onmouseout="out('2965579239059640859');" style=""> 498                      possibleFGOffers.add(offer);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 499                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 500              }                                                                                                     </span>
<span class="7272445213685933500" onmouseenter="enter('7272445213685933500');" onmouseout="out('7272445213685933500');" style=""> 501              List&lt;Offer&gt; filteredOffers = orderOfferProcessor.filterOffers(possibleFGOffers, order.getCustomer()); </span>
<span class="-380250791493510209" onmouseenter="enter('-380250791493510209');" onmouseout="out('-380250791493510209');" style=""><abbr title=" 502              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFulfillmentGroupOffer&gt;();"> 502              List&lt;PromotableCandidateFulfillmentGroupOffer&gt; qualifiedFGOffers = new ArrayList&lt;PromotableCandidateFuðŸ”µ</abbr></span>
<span class="5471512156259214352" onmouseenter="enter('5471512156259214352');" onmouseout="out('5471512156259214352');" style=""> 503              for (Offer offer : filteredOffers) {                                                                  </span>
<span class="6341701119621727258" onmouseenter="enter('6341701119621727258');" onmouseout="out('6341701119621727258');" style=""><abbr title=" 504                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffers, offer);"> 504                  fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(promotableOrder, qualifiedFGOffersðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 505              }                                                                                                     </span>
<span class="6757974448768463" onmouseenter="enter('6757974448768463');" onmouseout="out('6757974448768463');" style=""> 506              if (!qualifiedFGOffers.isEmpty()) {                                                                   </span>
<span class="-3737539762239464744" onmouseenter="enter('-3737539762239464744');" onmouseout="out('-3737539762239464744');" style=""> 507                  fulfillmentGroupOfferProcessor.applyAllFulfillmentGroupOffers(qualifiedFGOffers, promotableOrder);</span>
<span class="-1748187190347404908" onmouseenter="enter('-1748187190347404908');" onmouseout="out('-1748187190347404908');" style=""> 508                  fulfillmentGroupOfferProcessor.calculateFulfillmentGroupTotal(promotableOrder);                   </span>
<span class="-2662366104081332973" onmouseenter="enter('-2662366104081332973');" onmouseout="out('-2662366104081332973');" style=""> 509                  orderOfferProcessor.synchronizeAdjustmentsAndPrices(promotableOrder);                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 510              }                                                                                                     </span>
<span  style=""> 511                                                                                                                    </span>
<span class="-7204486914274790826" onmouseenter="enter('-7204486914274790826');" onmouseout="out('-7204486914274790826');" style=""> 512              return orderService.save(order, false);                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 513          }                                                                                                         </span>
<span class="-5747246288187903060" onmouseenter="enter('-5747246288187903060');" onmouseout="out('-5747246288187903060');" style=""> 514          return order;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 515      }                                                                                                             </span>
<span  style=""> 516                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 517      @Override                                                                                                     </span>
<span class="-8983195686564092827" onmouseenter="enter('-8983195686564092827');" onmouseout="out('-8983195686564092827');" style=""> 518      public boolean verifyMaxCustomerUsageThreshold(Order order, Offer offer) {                                    </span>
<span class="3141309231367904228" onmouseenter="enter('3141309231367904228');" onmouseout="out('3141309231367904228');" style=""> 519          Customer customer = order.getCustomer();                                                                  </span>
<span  style=""> 520                                                                                                                    </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 521          if (offer.isLimitedUsePerCustomer()) {                                                                    </span>
<span class="-8305970541390666259" onmouseenter="enter('-8305970541390666259');" onmouseout="out('-8305970541390666259');" style=""> 522              Long currentUses = offerAuditService.countUsesByCustomer(order, customer.getId(), offer.getId());     </span>
<span  style=""> 523                                                                                                                    </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 524              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                                   </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 525                  return false;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 526              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 527          }                                                                                                         </span>
<span  style=""> 528                                                                                                                    </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 529          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 530      }                                                                                                             </span>
<span  style=""> 531                                                                                                                    </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 532      @Deprecated                                                                                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 533      @Override                                                                                                     </span>
<span class="4849754295577860926" onmouseenter="enter('4849754295577860926');" onmouseout="out('4849754295577860926');" style=""> 534      public boolean verifyMaxCustomerUsageThreshold(Customer customer, Offer offer) {                              </span>
<span class="7342915690298317850" onmouseenter="enter('7342915690298317850');" onmouseout="out('7342915690298317850');" style=""> 535          if (offer.isLimitedUsePerCustomer()) {                                                                    </span>
<span class="8084739095609490454" onmouseenter="enter('8084739095609490454');" onmouseout="out('8084739095609490454');" style=""> 536              Long currentUses = offerAuditService.countUsesByCustomer(customer.getId(), offer.getId());            </span>
<span  style=""> 537                                                                                                                    </span>
<span class="-4931309402597338187" onmouseenter="enter('-4931309402597338187');" onmouseout="out('-4931309402597338187');" style=""> 538              if (currentUses &gt;= offer.getMaxUsesPerCustomer()) {                                                   </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 539                  return false;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 540              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 541          }                                                                                                         </span>
<span  style=""> 542                                                                                                                    </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 543          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 544      }                                                                                                             </span>
<span  style=""> 545                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 546      @Override                                                                                                     </span>
<span class="-4305912419408886648" onmouseenter="enter('-4305912419408886648');" onmouseout="out('-4305912419408886648');" style=""> 547      public boolean verifyMaxCustomerUsageThreshold(Order order, OfferCode code) {                                 </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 548          boolean underCodeMaxUses = true;                                                                          </span>
<span  style=""> 549                                                                                                                    </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 550          if (code.isLimitedUse()) {                                                                                </span>
<span class="-7378740545085856894" onmouseenter="enter('-7378740545085856894');" onmouseout="out('-7378740545085856894');" style=""> 551              Long currentCodeUses = offerAuditService.countOfferCodeUses(order, code.getId());                     </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 552              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 553          }                                                                                                         </span>
<span  style=""> 554                                                                                                                    </span>
<span class="5446263071698048925" onmouseenter="enter('5446263071698048925');" onmouseout="out('5446263071698048925');" style=""> 555          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(order, code.getOffer());                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 556      }                                                                                                             </span>
<span  style=""> 557                                                                                                                    </span>
<span class="-9122364098618956613" onmouseenter="enter('-9122364098618956613');" onmouseout="out('-9122364098618956613');" style=""> 558      @Deprecated                                                                                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 559      @Override                                                                                                     </span>
<span class="135967723667379112" onmouseenter="enter('135967723667379112');" onmouseout="out('135967723667379112');" style=""> 560      public boolean verifyMaxCustomerUsageThreshold(Customer customer, OfferCode code) {                           </span>
<span class="1090242434443111564" onmouseenter="enter('1090242434443111564');" onmouseout="out('1090242434443111564');" style=""> 561          boolean underCodeMaxUses = true;                                                                          </span>
<span class="4436701899449480172" onmouseenter="enter('4436701899449480172');" onmouseout="out('4436701899449480172');" style=""> 562          if (code.isLimitedUse()) {                                                                                </span>
<span class="5487567461678823803" onmouseenter="enter('5487567461678823803');" onmouseout="out('5487567461678823803');" style=""> 563              Long currentCodeUses = offerAuditService.countOfferCodeUses(code.getId());                            </span>
<span class="-5560319604541727516" onmouseenter="enter('-5560319604541727516');" onmouseout="out('-5560319604541727516');" style=""> 564              underCodeMaxUses = currentCodeUses &lt; code.getMaxUses();                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 565          }                                                                                                         </span>
<span class="7193079189056024188" onmouseenter="enter('7193079189056024188');" onmouseout="out('7193079189056024188');" style=""> 566          return underCodeMaxUses &amp;&amp; verifyMaxCustomerUsageThreshold(customer, code.getOffer());                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 567      }                                                                                                             </span>
<span  style=""> 568                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 569      @Override                                                                                                     </span>
<span class="7948482626287429940" onmouseenter="enter('7948482626287429940');" onmouseout="out('7948482626287429940');" style=""> 570      @SuppressWarnings(&quot;unchecked&quot;)                                                                                </span>
<span class="-640784293225096821" onmouseenter="enter('-640784293225096821');" onmouseout="out('-640784293225096821');" style=""> 571      public Set&lt;Offer&gt; getUniqueOffersFromOrder(Order order) {                                                     </span>
<span class="-348027159212233091" onmouseenter="enter('-348027159212233091');" onmouseout="out('-348027159212233091');" style=""> 572          HashSet&lt;Offer&gt; result = new HashSet&lt;Offer&gt;();                                                             </span>
<span  style=""> 573                                                                                                                    </span>
<span class="-7949809618309864364" onmouseenter="enter('-7949809618309864364');" onmouseout="out('-7949809618309864364');" style=""> 574          Transformer adjustmentToOfferTransformer = new Transformer() {                                            </span>
<span  style=""> 575                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 576              @Override                                                                                             </span>
<span class="-2718541205900117239" onmouseenter="enter('-2718541205900117239');" onmouseout="out('-2718541205900117239');" style=""> 577              public Object transform(Object input) {                                                               </span>
<span class="4176981446584954696" onmouseenter="enter('4176981446584954696');" onmouseout="out('4176981446584954696');" style=""> 578                  return ((Adjustment)input).getOffer();                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 579              }                                                                                                     </span>
<span class="2468309323999483380" onmouseenter="enter('2468309323999483380');" onmouseout="out('2468309323999483380');" style=""> 580          };                                                                                                        </span>
<span  style=""> 581                                                                                                                    </span>
<span class="-8370514600917699300" onmouseenter="enter('-8370514600917699300');" onmouseout="out('-8370514600917699300');" style=""> 582          result.addAll(CollectionUtils.collect(order.getOrderAdjustments(), adjustmentToOfferTransformer));        </span>
<span  style=""> 583                                                                                                                    </span>
<span class="3897119298100986011" onmouseenter="enter('3897119298100986011');" onmouseout="out('3897119298100986011');" style=""> 584          if (order.getOrderItems() != null) {                                                                      </span>
<span class="820796442257070700" onmouseenter="enter('820796442257070700');" onmouseout="out('820796442257070700');" style=""> 585              for (OrderItem item : order.getOrderItems()) {                                                        </span>
<span class="722957474719034118" onmouseenter="enter('722957474719034118');" onmouseout="out('722957474719034118');" style=""><abbr title=" 586                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformer));"> 586                  result.addAll(CollectionUtils.collect(item.getOrderItemAdjustments(), adjustmentToOfferTransformerðŸ”µ</abbr></span>
<span  style=""> 587                                                                                                                    </span>
<span class="-3519908190158496681" onmouseenter="enter('-3519908190158496681');" onmouseout="out('-3519908190158496681');" style=""> 588                  //record usage for price details on the item as well                                              </span>
<span class="-2952948196187271811" onmouseenter="enter('-2952948196187271811');" onmouseout="out('-2952948196187271811');" style=""> 589                  if (item.getOrderItemPriceDetails() != null) {                                                    </span>
<span class="773323050474809935" onmouseenter="enter('773323050474809935');" onmouseout="out('773323050474809935');" style=""> 590                      for (OrderItemPriceDetail detail : item.getOrderItemPriceDetails()) {                         </span>
<span class="7134713472391876911" onmouseenter="enter('7134713472391876911');" onmouseout="out('7134713472391876911');" style=""><abbr title=" 591                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmentToOfferTransformer));"> 591                          result.addAll(CollectionUtils.collect(detail.getOrderItemPriceDetailAdjustments(), adjustmðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 592                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 593                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 594              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 595          }                                                                                                         </span>
<span  style=""> 596                                                                                                                    </span>
<span class="7944520279780748823" onmouseenter="enter('7944520279780748823');" onmouseout="out('7944520279780748823');" style=""> 597          if (order.getFulfillmentGroups() != null) {                                                               </span>
<span class="-1206553190780034737" onmouseenter="enter('-1206553190780034737');" onmouseout="out('-1206553190780034737');" style=""> 598              for (FulfillmentGroup fg : order.getFulfillmentGroups()) {                                            </span>
<span class="-293187079687761920" onmouseenter="enter('-293187079687761920');" onmouseout="out('-293187079687761920');" style=""><abbr title=" 599                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransformer));"> 599                  result.addAll(CollectionUtils.collect(fg.getFulfillmentGroupAdjustments(), adjustmentToOfferTransfðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 600              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 601          }                                                                                                         </span>
<span class="-6419540350677864751" onmouseenter="enter('-6419540350677864751');" onmouseout="out('-6419540350677864751');" style=""> 602          return result;                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 603      }                                                                                                             </span>
<span  style=""> 604                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 605      @Override                                                                                                     </span>
<span class="-2491837224879773303" onmouseenter="enter('-2491837224879773303');" onmouseout="out('-2491837224879773303');" style=""> 606      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(Order order)  {                                      </span>
<span class="-1370687283458217641" onmouseenter="enter('-1370687283458217641');" onmouseout="out('-1370687283458217641');" style=""> 607          return getOffersRetrievedFromCodes(order.getAddedOfferCodes(), getUniqueOffersFromOrder(order));          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 608      }                                                                                                             </span>
<span  style=""> 609                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 610      @Override                                                                                                     </span>
<span class="-6407317956511861474" onmouseenter="enter('-6407317956511861474');" onmouseout="out('-6407317956511861474');" style=""> 611      public Map&lt;Offer, OfferCode&gt; getOffersRetrievedFromCodes(List&lt;OfferCode&gt; codes, Set&lt;Offer&gt; appliedOffers) {   </span>
<span class="-4490485247927949218" onmouseenter="enter('-4490485247927949218');" onmouseout="out('-4490485247927949218');" style=""> 612          HashMap&lt;Offer, OfferCode&gt; offerToCodeMapping = new HashMap&lt;Offer, OfferCode&gt;();                           </span>
<span class="983580358500385861" onmouseenter="enter('983580358500385861');" onmouseout="out('983580358500385861');" style=""> 613          for (OfferCode code : codes) {                                                                            </span>
<span class="6305098044991751707" onmouseenter="enter('6305098044991751707');" onmouseout="out('6305098044991751707');" style=""> 614              if (appliedOffers.contains(code.getOffer())) {                                                        </span>
<span class="3746501443462939384" onmouseenter="enter('3746501443462939384');" onmouseout="out('3746501443462939384');" style=""> 615                  offerToCodeMapping.put(code.getOffer(), code);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 616              }                                                                                                     </span>
<span  style=""> 617                                                                                                                    </span>
<span class="-240986298797431748" onmouseenter="enter('-240986298797431748');" onmouseout="out('-240986298797431748');" style=""> 618              List&lt;Offer&gt; additionalOffersToBeApplied = new ArrayList&lt;Offer&gt;();                                     </span>
<span  style=""> 619                                                                                                                    </span>
<span class="7454577566794152811" onmouseenter="enter('7454577566794152811');" onmouseout="out('7454577566794152811');" style=""> 620              extensionManager.getProxy().addAdditionalOffersForCode(additionalOffersToBeApplied, code);            </span>
<span class="-7985615425314556326" onmouseenter="enter('-7985615425314556326');" onmouseout="out('-7985615425314556326');" style=""> 621              for (Offer additionalOfferToBeApplied : additionalOffersToBeApplied) {                                </span>
<span class="-808811284028256215" onmouseenter="enter('-808811284028256215');" onmouseout="out('-808811284028256215');" style=""> 622                  offerToCodeMapping.put(additionalOfferToBeApplied, code);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 623              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 624          }                                                                                                         </span>
<span class="7175253914401568841" onmouseenter="enter('7175253914401568841');" onmouseout="out('7175253914401568841');" style=""> 625          return offerToCodeMapping;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 626      }                                                                                                             </span>
<span  style=""> 627                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 628      @Override                                                                                                     </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 629      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="-1347767159915315738" onmouseenter="enter('-1347767159915315738');" onmouseout="out('-1347767159915315738');" style=""> 630      public Boolean deleteOfferCode(OfferCode code) {                                                              </span>
<span class="-5986603348121186173" onmouseenter="enter('-5986603348121186173');" onmouseout="out('-5986603348121186173');" style=""> 631          if (offerCodeDao.offerCodeIsUsed(code)) {                                                                 </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 632              return false;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 633          }                                                                                                         </span>
<span  style=""> 634                                                                                                                    </span>
<span class="-9122073777393685295" onmouseenter="enter('-9122073777393685295');" onmouseout="out('-9122073777393685295');" style=""> 635          offerCodeDao.delete(code);                                                                                </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 636          return true;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 637      }                                                                                                             </span>
<span  style=""> 638                                                                                                                    </span>
<span class="5049387329381023556" onmouseenter="enter('5049387329381023556');" onmouseout="out('5049387329381023556');" style=""> 639      @Transactional(&quot;blTransactionManager&quot;)                                                                        </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 640      @Override                                                                                                     </span>
<span class="-3816301958562278169" onmouseenter="enter('-3816301958562278169');" onmouseout="out('-3816301958562278169');" style=""> 641      public Offer duplicate(Long originalOfferId) {                                                                </span>
<span class="-5738299300293223874" onmouseenter="enter('-5738299300293223874');" onmouseout="out('-5738299300293223874');" style=""> 642          Map&lt;String, String&gt; copyHints = new HashMap&lt;String, String&gt;();                                            </span>
<span class="2715783386963629594" onmouseenter="enter('2715783386963629594');" onmouseout="out('2715783386963629594');" style=""> 643          copyHints.put(OfferImpl.EXCLUDE_OFFERCODE_COPY_HINT, &quot;true&quot;);                                             </span>
<span class="-2013584672995219797" onmouseenter="enter('-2013584672995219797');" onmouseout="out('-2013584672995219797');" style=""> 644          return duplicator.copy(OfferImpl.class, originalOfferId, copyHints, offerDuplicateModifier);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 645      }                                                                                                             </span>
<span  style=""> 646                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 647      @Override                                                                                                     </span>
<span class="3228088005821970316" onmouseenter="enter('3228088005821970316');" onmouseout="out('3228088005821970316');" style=""> 648      public CustomerOfferDao getCustomerOfferDao() {                                                               </span>
<span class="-801333879424417122" onmouseenter="enter('-801333879424417122');" onmouseout="out('-801333879424417122');" style=""> 649          return customerOfferDao;                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 650      }                                                                                                             </span>
<span  style=""> 651                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 652      @Override                                                                                                     </span>
<span class="6308179313298689001" onmouseenter="enter('6308179313298689001');" onmouseout="out('6308179313298689001');" style=""> 653      public void setCustomerOfferDao(CustomerOfferDao customerOfferDao) {                                          </span>
<span class="438520929977701037" onmouseenter="enter('438520929977701037');" onmouseout="out('438520929977701037');" style=""> 654          this.customerOfferDao = customerOfferDao;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 655      }                                                                                                             </span>
<span  style=""> 656                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 657      @Override                                                                                                     </span>
<span class="8266606365944954497" onmouseenter="enter('8266606365944954497');" onmouseout="out('8266606365944954497');" style=""> 658      public OfferCodeDao getOfferCodeDao() {                                                                       </span>
<span class="-4005874311041664572" onmouseenter="enter('-4005874311041664572');" onmouseout="out('-4005874311041664572');" style=""> 659          return offerCodeDao;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 660      }                                                                                                             </span>
<span  style=""> 661                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 662      @Override                                                                                                     </span>
<span class="-5083072655758254890" onmouseenter="enter('-5083072655758254890');" onmouseout="out('-5083072655758254890');" style=""> 663      public void setOfferCodeDao(OfferCodeDao offerCodeDao) {                                                      </span>
<span class="-7060255547979502806" onmouseenter="enter('-7060255547979502806');" onmouseout="out('-7060255547979502806');" style=""> 664          this.offerCodeDao = offerCodeDao;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 665      }                                                                                                             </span>
<span  style=""> 666                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 667      @Override                                                                                                     </span>
<span class="-7735286594756225585" onmouseenter="enter('-7735286594756225585');" onmouseout="out('-7735286594756225585');" style=""> 668      public OfferDao getOfferDao() {                                                                               </span>
<span class="1944419696528289419" onmouseenter="enter('1944419696528289419');" onmouseout="out('1944419696528289419');" style=""> 669          return offerDao;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 670      }                                                                                                             </span>
<span  style=""> 671                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 672      @Override                                                                                                     </span>
<span class="2682146842090194395" onmouseenter="enter('2682146842090194395');" onmouseout="out('2682146842090194395');" style=""> 673      public void setOfferDao(OfferDao offerDao) {                                                                  </span>
<span class="-2386217355911403401" onmouseenter="enter('-2386217355911403401');" onmouseout="out('-2386217355911403401');" style=""> 674          this.offerDao = offerDao;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 675      }                                                                                                             </span>
<span  style=""> 676                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 677      @Override                                                                                                     </span>
<span class="3012408951835963759" onmouseenter="enter('3012408951835963759');" onmouseout="out('3012408951835963759');" style=""> 678      public OrderOfferProcessor getOrderOfferProcessor() {                                                         </span>
<span class="-5069105522766505260" onmouseenter="enter('-5069105522766505260');" onmouseout="out('-5069105522766505260');" style=""> 679          return orderOfferProcessor;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 680      }                                                                                                             </span>
<span  style=""> 681                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 682      @Override                                                                                                     </span>
<span class="-2542583147665382651" onmouseenter="enter('-2542583147665382651');" onmouseout="out('-2542583147665382651');" style=""> 683      public void setOrderOfferProcessor(OrderOfferProcessor orderOfferProcessor) {                                 </span>
<span class="1533378703496715943" onmouseenter="enter('1533378703496715943');" onmouseout="out('1533378703496715943');" style=""> 684          this.orderOfferProcessor = orderOfferProcessor;                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 685      }                                                                                                             </span>
<span  style=""> 686                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 687      @Override                                                                                                     </span>
<span class="1694843298235251985" onmouseenter="enter('1694843298235251985');" onmouseout="out('1694843298235251985');" style=""> 688      public ItemOfferProcessor getItemOfferProcessor() {                                                           </span>
<span class="1583504692330339191" onmouseenter="enter('1583504692330339191');" onmouseout="out('1583504692330339191');" style=""> 689          return itemOfferProcessor;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 690      }                                                                                                             </span>
<span  style=""> 691                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 692      @Override                                                                                                     </span>
<span class="145400756853488798" onmouseenter="enter('145400756853488798');" onmouseout="out('145400756853488798');" style=""> 693      public void setItemOfferProcessor(ItemOfferProcessor itemOfferProcessor) {                                    </span>
<span class="-102405468021411755" onmouseenter="enter('-102405468021411755');" onmouseout="out('-102405468021411755');" style=""> 694          this.itemOfferProcessor = itemOfferProcessor;                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 695      }                                                                                                             </span>
<span  style=""> 696                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 697      @Override                                                                                                     </span>
<span class="3022939772369206873" onmouseenter="enter('3022939772369206873');" onmouseout="out('3022939772369206873');" style=""> 698      public FulfillmentGroupOfferProcessor getFulfillmentGroupOfferProcessor() {                                   </span>
<span class="-3088775944214719317" onmouseenter="enter('-3088775944214719317');" onmouseout="out('-3088775944214719317');" style=""> 699          return fulfillmentGroupOfferProcessor;                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 700      }                                                                                                             </span>
<span  style=""> 701                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 702      @Override                                                                                                     </span>
<span class="-8855456203149015957" onmouseenter="enter('-8855456203149015957');" onmouseout="out('-8855456203149015957');" style=""> 703      public void setFulfillmentGroupOfferProcessor(FulfillmentGroupOfferProcessor fulfillmentGroupOfferProcessor) {</span>
<span class="-7108053920330155376" onmouseenter="enter('-7108053920330155376');" onmouseout="out('-7108053920330155376');" style=""> 704          this.fulfillmentGroupOfferProcessor = fulfillmentGroupOfferProcessor;                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 705      }                                                                                                             </span>
<span  style=""> 706                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 707      @Override                                                                                                     </span>
<span class="3942276378191238722" onmouseenter="enter('3942276378191238722');" onmouseout="out('3942276378191238722');" style=""> 708      public PromotableItemFactory getPromotableItemFactory() {                                                     </span>
<span class="-6513746104588284038" onmouseenter="enter('-6513746104588284038');" onmouseout="out('-6513746104588284038');" style=""> 709          return promotableItemFactory;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 710      }                                                                                                             </span>
<span  style=""> 711                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 712      @Override                                                                                                     </span>
<span class="-6100322182085470553" onmouseenter="enter('-6100322182085470553');" onmouseout="out('-6100322182085470553');" style=""> 713      public void setPromotableItemFactory(PromotableItemFactory promotableItemFactory) {                           </span>
<span class="-6350357115321214782" onmouseenter="enter('-6350357115321214782');" onmouseout="out('-6350357115321214782');" style=""> 714          this.promotableItemFactory = promotableItemFactory;                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 715      }                                                                                                             </span>
<span  style=""> 716                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 717      @Override                                                                                                     </span>
<span class="-285725005067991728" onmouseenter="enter('-285725005067991728');" onmouseout="out('-285725005067991728');" style=""> 718      public OfferCode findOfferCodeById(Long id) {                                                                 </span>
<span class="4928857363700364693" onmouseenter="enter('4928857363700364693');" onmouseout="out('4928857363700364693');" style=""> 719          return offerCodeDao.readOfferCodeById(id);                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 720      }                                                                                                             </span>
<span  style=""> 721                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 722      @Override                                                                                                     </span>
<span class="-6829155498814719074" onmouseenter="enter('-6829155498814719074');" onmouseout="out('-6829155498814719074');" style=""> 723      public List&lt;OfferCode&gt; findOfferCodesByIds(Collection&lt;Long&gt; ids) {                                            </span>
<span class="-1521639274006709657" onmouseenter="enter('-1521639274006709657');" onmouseout="out('-1521639274006709657');" style=""> 724          return offerCodeDao.readOfferCodesByIds(ids);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 725      }                                                                                                             </span>
<span  style=""> 726                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 727      @Override                                                                                                     </span>
<span class="5587340050529616033" onmouseenter="enter('5587340050529616033');" onmouseout="out('5587340050529616033');" style=""> 728      public OrderService getOrderService() {                                                                       </span>
<span class="-7558473787756148723" onmouseenter="enter('-7558473787756148723');" onmouseout="out('-7558473787756148723');" style=""> 729          return orderService;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 730      }                                                                                                             </span>
<span  style=""> 731                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 732      @Override                                                                                                     </span>
<span class="4536819371590947172" onmouseenter="enter('4536819371590947172');" onmouseout="out('4536819371590947172');" style=""> 733      public void setOrderService(OrderService orderService) {                                                      </span>
<span class="7368861914925934250" onmouseenter="enter('7368861914925934250');" onmouseout="out('7368861914925934250');" style=""> 734          this.orderService = orderService;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 735      }                                                                                                             </span>
<span  style=""> 736                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 737      @Override                                                                                                     </span>
<span class="-2217088353489190987" onmouseenter="enter('-2217088353489190987');" onmouseout="out('-2217088353489190987');" style=""> 738      public Offer findOfferById(Long offerId) {                                                                    </span>
<span class="-5171648678549667040" onmouseenter="enter('-5171648678549667040');" onmouseout="out('-5171648678549667040');" style=""> 739          return offerDao.readOfferById(offerId);                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 740      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 741  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            