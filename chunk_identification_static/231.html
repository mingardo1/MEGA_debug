<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>231</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    231
                    <a href="230.html">prev</a>
                    <a href="232.html">next</a>
                    <a href="231_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_fd1394d8a0df0583b1f2c7c6fefa993051f65c10_common/src/main/java/org/broadleafcommerce/common/util/tenant/IdentityExecutionUtils.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;fd1394d8a0df0583b1f2c7c6fefa993051f65c10:common/src/main/java/org/broadleafcommerce/common/util/tenant/IdentityExecutionUtils.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;fd1394d8a0df0583b1f2c7c6fefa993051f65c10^1:common/src/main/java/org/broadleafcommerce/common/util/tenant/IdentityExecutionUtils.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;fd1394d8a0df0583b1f2c7c6fefa993051f65c10^2:common/src/main/java/org/broadleafcommerce/common/util/tenant/IdentityExecutionUtils.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;f40b9b4e9d4d9c82000944599b1a359d6f8adba4:common/src/main/java/org/broadleafcommerce/common/util/tenant/IdentityExecutionUtils.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [j], [j], [s], [s]], subset: [[b], [b], [j], [s], [s]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-4573490878212285276" onmouseenter="enter('-4573490878212285276');" onmouseout="out('-4573490878212285276');" style="">   3  * BroadleafCommerce Common Libraries                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-512514810257161872" onmouseenter="enter('-512514810257161872');" onmouseout="out('-512514810257161872');" style="">  18 package org.broadleafcommerce.common.util.tenant;                                                        </span>
<span  style="">  19                                                                                                          </span>
<span class="-4286566313930798693" onmouseenter="enter('-4286566313930798693');" onmouseout="out('-4286566313930798693');" style="">  20 import org.broadleafcommerce.common.site.domain.Catalog;                                                 </span>
<span class="3350833871385260454" onmouseenter="enter('3350833871385260454');" onmouseout="out('3350833871385260454');" style="">  21 import org.broadleafcommerce.common.site.domain.Site;                                                    </span>
<span class="5107697851223623564" onmouseenter="enter('5107697851223623564');" onmouseout="out('5107697851223623564');" style="">  22 import org.broadleafcommerce.common.util.TransactionUtils;                                               </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  23 import org.broadleafcommerce.common.web.BroadleafRequestContext;                                         </span>
<span class="-740123120803947738" onmouseenter="enter('-740123120803947738');" onmouseout="out('-740123120803947738');" style="">  24 import org.springframework.transaction.PlatformTransactionManager;                                       </span>
<span class="-8923386680468181280" onmouseenter="enter('-8923386680468181280');" onmouseout="out('-8923386680468181280');" style="">  25 import org.springframework.transaction.TransactionDefinition;                                            </span>
<span class="8980559080936335720" onmouseenter="enter('8980559080936335720');" onmouseout="out('8980559080936335720');" style="">  26 import org.springframework.transaction.TransactionStatus;                                                </span>
<span class="-25494037965120322" onmouseenter="enter('-25494037965120322');" onmouseout="out('-25494037965120322');" style="">  27 import org.springframework.transaction.support.TransactionSynchronizationManager;                        </span>
<span  style="">  28                                                                                                          </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  29 import java.util.HashMap;                                                                                </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  30 import java.util.Map;                                                                                    </span>
<span  style="">  31                                                                                                          </span>
<span class="1791670663098173858" onmouseenter="enter('1791670663098173858');" onmouseout="out('1791670663098173858');" style="">  32 import javax.persistence.EntityManagerFactory;                                                           </span>
<span class="-7201454294566819418" onmouseenter="enter('-7201454294566819418');" onmouseout="out('-7201454294566819418');" style="">  33 import javax.sql.DataSource;                                                                             </span>
<span  style="">  34                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  35 /**                                                                                                      </span>
<span class="-5413269856564896844" onmouseenter="enter('-5413269856564896844');" onmouseout="out('-5413269856564896844');" style=""><abbr title="  36  * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and instead">  36  * The utility methods in this class provide a way to ignore the currently configured site/catalog contexðŸ”µ</abbr></span>
<span class="-1334135248073305720" onmouseenter="enter('-1334135248073305720');" onmouseout="out('-1334135248073305720');" style="">  37  * explicitly run operations in the specified context.                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  38  *                                                                                                       </span>
<span class="-7311139588847938491" onmouseenter="enter('-7311139588847938491');" onmouseout="out('-7311139588847938491');" style="">  39  * @author Jeff Fischer                                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  40  */                                                                                                      </span>
<span class="-1398877175080343843" onmouseenter="enter('-1398877175080343843');" onmouseout="out('-1398877175080343843');" style="">  41 public class IdentityExecutionUtils {                                                                    </span>
<span  style="">  42                                                                                                          </span>
<span class="-652529928056955706" onmouseenter="enter('-652529928056955706');" onmouseout="out('-652529928056955706');" style=""><abbr title="  43     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog,">  43     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="6167977986734295120" onmouseenter="enter('6167977986734295120');" onmouseout="out('6167977986734295120');" style=""><abbr title="  44                                                               PlatformTransactionManager transactionManager) throws G {">  44                                                               PlatformTransactionManager transactionManagðŸ”µ</abbr></span>
<span  style="">  45                                                                                                          </span>
<span class="-7770167299096999061" onmouseenter="enter('-7770167299096999061');" onmouseout="out('-7770167299096999061');" style="">  46         IdentityUtilContext context = new IdentityUtilContext();                                         </span>
<span class="732355087831690145" onmouseenter="enter('732355087831690145');" onmouseout="out('732355087831690145');" style="">  47         context.setIdentifier(site);                                                                     </span>
<span class="3289280907674551762" onmouseenter="enter('3289280907674551762');" onmouseout="out('3289280907674551762');" style="">  48         IdentityUtilContext.setUtilContext(context);                                                     </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  49 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  50                                                                                                          </span>
<span class="-8689839391291561327" onmouseenter="enter('-8689839391291561327');" onmouseout="out('-8689839391291561327');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  51         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();              </span>
<span class="-6065207352220794681" onmouseenter="enter('-6065207352220794681');" onmouseout="out('-6065207352220794681');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  52         Site previousSite = brc.getSite();                                                               </span>
<span class="-2315761264854046842" onmouseenter="enter('-2315761264854046842');" onmouseout="out('-2315761264854046842');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  53         Catalog previousCatalog = brc.getCurrentCatalog();                                               </span>
<span class="36002691450064890" onmouseenter="enter('36002691450064890');" onmouseout="out('36002691450064890');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  54         Site previousProfile = brc.getCurrentProfile();                                                  </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  55                                                                                                          </span>
<span class="2981698039391216134" onmouseenter="enter('2981698039391216134');" onmouseout="out('2981698039391216134');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  56         boolean isNew = initRequestContext(site, profile, catalog);                                      </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  57                                                                                                          </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  58 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-7770167299096999061" onmouseenter="enter('-7770167299096999061');" onmouseout="out('-7770167299096999061');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59         IdentityUtilContext context = new IdentityUtilContext();                                         </span>
<span class="732355087831690145" onmouseenter="enter('732355087831690145');" onmouseout="out('732355087831690145');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60         context.setIdentifier(site);                                                                     </span>
<span class="3289280907674551762" onmouseenter="enter('3289280907674551762');" onmouseout="out('3289280907674551762');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61         IdentityUtilContext.setUtilContext(context);                                                     </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62                                                                                                          </span>
<span class="-8689839391291561327" onmouseenter="enter('-8689839391291561327');" onmouseout="out('-8689839391291561327');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();              </span>
<span class="-6065207352220794681" onmouseenter="enter('-6065207352220794681');" onmouseout="out('-6065207352220794681');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64         Site previousSite = brc.getSite();                                                               </span>
<span class="-2315761264854046842" onmouseenter="enter('-2315761264854046842');" onmouseout="out('-2315761264854046842');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65         Catalog previousCatalog = brc.getCurrentCatalog();                                               </span>
<span class="36002691450064890" onmouseenter="enter('36002691450064890');" onmouseout="out('36002691450064890');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66         Site previousProfile = brc.getCurrentProfile();                                                  </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67                                                                                                          </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  68 =======                                                                                                  </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  69 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style="">  70         TransactionContainer container = null;                                                           </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style="">  71         boolean isError = false;                                                                         </span>
<span class="5982941254864048436" onmouseenter="enter('5982941254864048436');" onmouseout="out('5982941254864048436');" style="">  72         Site previousSite = null;                                                                        </span>
<span class="-1736636036474983614" onmouseenter="enter('-1736636036474983614');" onmouseout="out('-1736636036474983614');" style="">  73         Catalog previousCatalog = null;                                                                  </span>
<span class="6146465993479879827" onmouseenter="enter('6146465993479879827');" onmouseout="out('6146465993479879827');" style="">  74         Site previousProfile = null;                                                                     </span>
<span class="-3038915738898370631" onmouseenter="enter('-3038915738898370631');" onmouseout="out('-3038915738898370631');" style="">  75         Boolean previousIsIgnoringSite = false;                                                          </span>
<span  style="">  76                                                                                                          </span>
<span class="-7323698650211604384" onmouseenter="enter('-7323698650211604384');" onmouseout="out('-7323698650211604384');" style="">  77         BroadleafRequestContext originalBrc = BroadleafRequestContext.getBroadleafRequestContext(false); </span>
<span class="386637157613053325" onmouseenter="enter('386637157613053325');" onmouseout="out('386637157613053325');" style="">  78         if (originalBrc != null) {                                                                       </span>
<span class="-7815041635819803257" onmouseenter="enter('-7815041635819803257');" onmouseout="out('-7815041635819803257');" style="">  79             previousSite = originalBrc.getNonPersistentSite();                                           </span>
<span class="-1817538935719022010" onmouseenter="enter('-1817538935719022010');" onmouseout="out('-1817538935719022010');" style="">  80             previousCatalog = originalBrc.getCurrentCatalog();                                           </span>
<span class="-6859502314315274901" onmouseenter="enter('-6859502314315274901');" onmouseout="out('-6859502314315274901');" style="">  81             previousProfile = originalBrc.getCurrentProfile();                                           </span>
<span class="7174699852720058151" onmouseenter="enter('7174699852720058151');" onmouseout="out('7174699852720058151');" style="">  82             previousIsIgnoringSite = originalBrc.getIgnoreSite();                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  83         }                                                                                                </span>
<span  style="">  84                                                                                                          </span>
<span class="2981698039391216134" onmouseenter="enter('2981698039391216134');" onmouseout="out('2981698039391216134');" style="">  85         boolean isNew = initRequestContext(site, profile, catalog);                                      </span>
<span  style="">  86                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  87         try {                                                                                            </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="">  88             activateSession();                                                                           </span>
<span  style="">  89                                                                                                          </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="">  90             if (transactionManager != null) {                                                            </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style="">  91                 container = establishTransaction(transactionManager);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  92             }                                                                                            </span>
<span  style="">  93                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  94             try {                                                                                        </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style="">  95                 return operation.execute();                                                              </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style="">  96             } catch (RuntimeException e) {                                                               </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style="">  97                 isError = true;                                                                          </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style="">  98                 throw e;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  99             }                                                                                            </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 100         } finally {                                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 101             try {                                                                                        </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style=""> 102                 if (container != null) {                                                                 </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style=""> 103                     finalizeTransaction(transactionManager, container, isError);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 104                 }                                                                                        </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 105             } finally {                                                                                  </span>
<span class="-866580000084113477" onmouseenter="enter('-866580000084113477');" onmouseout="out('-866580000084113477');" style=""> 106                 IdentityUtilContext.setUtilContext(null);                                                </span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style=""> 107                 if (isNew) {                                                                             </span>
<span class="8043600097329985222" onmouseenter="enter('8043600097329985222');" onmouseout="out('8043600097329985222');" style=""> 108                     BroadleafRequestContext.setBroadleafRequestContext(null);                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 109                 } else {                                                                                 </span>
<span class="-5663523450271762170" onmouseenter="enter('-5663523450271762170');" onmouseout="out('-5663523450271762170');" style=""><abbr title=" 110                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);"> 110                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringðŸ”µ</abbr></span>
<span class="-519937983444515271" onmouseenter="enter('-519937983444515271');" onmouseout="out('-519937983444515271');" style=""><abbr title=" 111                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);"> 111                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSitðŸ”µ</abbr></span>
<span class="-1622484655952997173" onmouseenter="enter('-1622484655952997173');" onmouseout="out('-1622484655952997173');" style=""><abbr title=" 112                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);"> 112                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCataloðŸ”µ</abbr></span>
<span class="5071379482955896849" onmouseenter="enter('5071379482955896849');" onmouseout="out('5071379482955896849');" style=""><abbr title=" 113                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);"> 113                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfilðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 114                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 115             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 116         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 117     }                                                                                                    </span>
<span  style=""> 118                                                                                                          </span>
<span class="-485315311381460363" onmouseenter="enter('-485315311381460363');" onmouseout="out('-485315311381460363');" style=""><abbr title=" 119     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Catalog catalog) throws G {"> 119     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="-2149174260692711216" onmouseenter="enter('-2149174260692711216');" onmouseout="out('-2149174260692711216');" style=""> 120         return runOperationByIdentifier(operation, site, null, catalog, null);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 121     }                                                                                                    </span>
<span  style=""> 122                                                                                                          </span>
<span class="-3389004741801466008" onmouseenter="enter('-3389004741801466008');" onmouseout="out('-3389004741801466008');" style=""><abbr title=" 123     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog) throws G {"> 123     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="-4482989458560555755" onmouseenter="enter('-4482989458560555755');" onmouseout="out('-4482989458560555755');" style=""> 124         return runOperationByIdentifier(operation, site, profile, catalog, null);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 125     }                                                                                                    </span>
<span  style=""> 126                                                                                                          </span>
<span class="-8143870051657701621" onmouseenter="enter('-8143870051657701621');" onmouseout="out('-8143870051657701621');" style=""><abbr title=" 127     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site) throws G {"> 127     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="-3215157294418599548" onmouseenter="enter('-3215157294418599548');" onmouseout="out('-3215157294418599548');" style=""> 128         return runOperationByIdentifier(operation, site, null, null, null);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129     }                                                                                                    </span>
<span  style=""> 130                                                                                                          </span>
<span class="-2275937291032103964" onmouseenter="enter('-2275937291032103964');" onmouseout="out('-2275937291032103964');" style=""><abbr title=" 131     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile) throws G {"> 131     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="8388199613493551564" onmouseenter="enter('8388199613493551564');" onmouseout="out('8388199613493551564');" style=""> 132         return runOperationByIdentifier(operation, site, profile, null);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133     }                                                                                                    </span>
<span  style=""> 134                                                                                                          </span>
<span class="6819324175888184161" onmouseenter="enter('6819324175888184161');" onmouseout="out('6819324175888184161');" style=""><abbr title=" 135     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) throws G {"> 135     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operðŸ”µ</abbr></span>
<span class="-4246408630280487290" onmouseenter="enter('-4246408630280487290');" onmouseout="out('-4246408630280487290');" style=""> 136         return runOperationAndIgnoreIdentifier(operation, null);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137     }                                                                                                    </span>
<span  style=""> 138                                                                                                          </span>
<span class="-4518289252412213481" onmouseenter="enter('-4518289252412213481');" onmouseout="out('-4518289252412213481');" style=""><abbr title=" 139     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation, "> 139     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operðŸ”µ</abbr></span>
<span class="6167977986734295120" onmouseenter="enter('6167977986734295120');" onmouseout="out('6167977986734295120');" style=""> 140             PlatformTransactionManager transactionManager) throws G {                                    </span>
<span class="-5567505797438091464" onmouseenter="enter('-5567505797438091464');" onmouseout="out('-5567505797438091464');" style=""> 141         //Set up pre-existing state...                                                                   </span>
<span class="1874085528725214811" onmouseenter="enter('1874085528725214811');" onmouseout="out('1874085528725214811');" style=""> 142         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext(false);         </span>
<span class="5982941254864048436" onmouseenter="enter('5982941254864048436');" onmouseout="out('5982941254864048436');" style=""> 143         Site previousSite = null;                                                                        </span>
<span class="-1736636036474983614" onmouseenter="enter('-1736636036474983614');" onmouseout="out('-1736636036474983614');" style=""> 144         Catalog previousCatalog = null;                                                                  </span>
<span class="6146465993479879827" onmouseenter="enter('6146465993479879827');" onmouseout="out('6146465993479879827');" style=""> 145         Site previousProfile = null;                                                                     </span>
<span class="-3038915738898370631" onmouseenter="enter('-3038915738898370631');" onmouseout="out('-3038915738898370631');" style=""> 146         Boolean previousIsIgnoringSite = false;                                                          </span>
<span  style=""> 147                                                                                                          </span>
<span class="-3197739461753066202" onmouseenter="enter('-3197739461753066202');" onmouseout="out('-3197739461753066202');" style=""> 148         if (brc != null) {                                                                               </span>
<span class="-8911406761612770367" onmouseenter="enter('-8911406761612770367');" onmouseout="out('-8911406761612770367');" style=""> 149             previousSite = brc.getNonPersistentSite();                                                   </span>
<span class="-4648385020762162138" onmouseenter="enter('-4648385020762162138');" onmouseout="out('-4648385020762162138');" style=""> 150             previousCatalog = brc.getCurrentCatalog();                                                   </span>
<span class="-117804761019864275" onmouseenter="enter('-117804761019864275');" onmouseout="out('-117804761019864275');" style=""> 151             previousProfile = brc.getCurrentProfile();                                                   </span>
<span class="-4607913904778825019" onmouseenter="enter('-4607913904778825019');" onmouseout="out('-4607913904778825019');" style=""> 152             previousIsIgnoringSite = brc.getIgnoreSite();                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 153         }                                                                                                </span>
<span  style=""> 154                                                                                                          </span>
<span class="139705847590485842" onmouseenter="enter('139705847590485842');" onmouseout="out('139705847590485842');" style=""><abbr title=" 155         //Initialize new state...  This will guaratee that a BroadleafRequestContext is available to this thread."> 155         //Initialize new state...  This will guaratee that a BroadleafRequestContext is available to thisðŸ”µ</abbr></span>
<span class="-1943348167742156849" onmouseenter="enter('-1943348167742156849');" onmouseout="out('-1943348167742156849');" style=""> 156         boolean isNew = initRequestContext(null, null, null);                                            </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 157 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-3564107913275418963" onmouseenter="enter('-3564107913275418963');" onmouseout="out('-3564107913275418963');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158         boolean isIgnoringSite = BroadleafRequestContext.getBroadleafRequestContext().getIgnoreSite();   </span>
<span class="7425048344239509528" onmouseenter="enter('7425048344239509528');" onmouseout="out('7425048344239509528');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159         BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);                        </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 160 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-2315761264854046842" onmouseenter="enter('-2315761264854046842');" onmouseout="out('-2315761264854046842');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161         Catalog previousCatalog = brc.getCurrentCatalog();                                               </span>
<span class="36002691450064890" onmouseenter="enter('36002691450064890');" onmouseout="out('36002691450064890');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         Site previousProfile = brc.getCurrentProfile();                                                  </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163                                                                                                          </span>
<span class="-1943348167742156849" onmouseenter="enter('-1943348167742156849');" onmouseout="out('-1943348167742156849');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164         boolean isNew = initRequestContext(null, null, null);                                            </span>
<span class="-3564107913275418963" onmouseenter="enter('-3564107913275418963');" onmouseout="out('-3564107913275418963');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165         boolean isIgnoringSite = BroadleafRequestContext.getBroadleafRequestContext().getIgnoreSite();   </span>
<span class="7425048344239509528" onmouseenter="enter('7425048344239509528');" onmouseout="out('7425048344239509528');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);                        </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167                                                                                                          </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168         activateSession();                                                                               </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169                                                                                                          </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         TransactionContainer container = null;                                                           </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         if (transactionManager != null) {                                                                </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172             container = establishTransaction(transactionManager);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         }                                                                                                </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174         boolean isError = false;                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175         try {                                                                                            </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176             return operation.execute();                                                                  </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         } catch (RuntimeException e) {                                                                   </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             isError = true;                                                                              </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             throw e;                                                                                     </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180         } finally {                                                                                      </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181             if (container != null) {                                                                     </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                 finalizeTransaction(transactionManager, container, isError);                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183             }                                                                                            </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184                                                                                                          </span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185             if (isNew) {                                                                                 </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 186 =======                                                                                                  </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 187 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span  style=""> 188                                                                                                          </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style=""> 189         TransactionContainer container = null;                                                           </span>
<span  style=""> 190                                                                                                          </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style=""> 191         boolean isError = false;                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 192         try {                                                                                            </span>
<span class="7425048344239509528" onmouseenter="enter('7425048344239509528');" onmouseout="out('7425048344239509528');" style=""> 193             BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);                    </span>
<span  style=""> 194                                                                                                          </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style=""> 195             activateSession();                                                                           </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style=""> 196             if (transactionManager != null) {                                                            </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style=""> 197                 container = establishTransaction(transactionManager);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198             }                                                                                            </span>
<span  style=""> 199                                                                                                          </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style=""> 200             return operation.execute();                                                                  </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style=""> 201         } catch (RuntimeException e) {                                                                   </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style=""> 202             isError = true;                                                                              </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 203             throw e;                                                                                     </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 204         } finally {                                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 205             try {                                                                                        </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style=""> 206                 if (container != null) {                                                                 </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style=""> 207                     finalizeTransaction(transactionManager, container, isError);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 208                 }                                                                                        </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 209             } finally {                                                                                  </span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style=""> 210                 if (isNew) {                                                                             </span>
<span class="6183760171671125539" onmouseenter="enter('6183760171671125539');" onmouseout="out('6183760171671125539');" style=""> 211                     //We just created this, so don&#x27;t leave it lying around.                              </span>
<span class="8043600097329985222" onmouseenter="enter('8043600097329985222');" onmouseout="out('8043600097329985222');" style=""> 212                     BroadleafRequestContext.setBroadleafRequestContext(null);                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 213                 } else {                                                                                 </span>
<span class="-3608180821406181105" onmouseenter="enter('-3608180821406181105');" onmouseout="out('-3608180821406181105');" style=""> 214                     //Otherwise, reset pre-existing state.                                               </span>
<span class="-5663523450271762170" onmouseenter="enter('-5663523450271762170');" onmouseout="out('-5663523450271762170');" style=""><abbr title=" 215                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);"> 215                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringðŸ”µ</abbr></span>
<span class="-519937983444515271" onmouseenter="enter('-519937983444515271');" onmouseout="out('-519937983444515271');" style=""><abbr title=" 216                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);"> 216                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSitðŸ”µ</abbr></span>
<span class="-1622484655952997173" onmouseenter="enter('-1622484655952997173');" onmouseout="out('-1622484655952997173');" style=""><abbr title=" 217                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);"> 217                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCataloðŸ”µ</abbr></span>
<span class="5071379482955896849" onmouseenter="enter('5071379482955896849');" onmouseout="out('5071379482955896849');" style=""><abbr title=" 218                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);"> 218                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfilðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 219                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 220             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 222     }                                                                                                    </span>
<span  style=""> 223                                                                                                          </span>
<span class="-7595713675186321428" onmouseenter="enter('-7595713675186321428');" onmouseout="out('-7595713675186321428');" style=""> 224     private static boolean initRequestContext(Site site, Site profile, Catalog catalog) {                </span>
<span class="-2081663176034123456" onmouseenter="enter('-2081663176034123456');" onmouseout="out('-2081663176034123456');" style=""> 225         boolean isNew = false;                                                                           </span>
<span class="1959723908368963258" onmouseenter="enter('1959723908368963258');" onmouseout="out('1959723908368963258');" style=""><abbr title=" 226         BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(false);"> 226         BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(falseðŸ”µ</abbr></span>
<span  style=""> 227                                                                                                          </span>
<span class="-5701496640250763224" onmouseenter="enter('-5701496640250763224');" onmouseout="out('-5701496640250763224');" style=""> 228         if (requestContext == null) {                                                                    </span>
<span class="7779864663200542762" onmouseenter="enter('7779864663200542762');" onmouseout="out('7779864663200542762');" style=""> 229             requestContext = new BroadleafRequestContext();                                              </span>
<span class="2698271589848593965" onmouseenter="enter('2698271589848593965');" onmouseout="out('2698271589848593965');" style=""> 230             BroadleafRequestContext.setBroadleafRequestContext(requestContext);                          </span>
<span class="8240120666987537487" onmouseenter="enter('8240120666987537487');" onmouseout="out('8240120666987537487');" style=""> 231             isNew = true;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 232         }                                                                                                </span>
<span  style=""> 233                                                                                                          </span>
<span class="-8845229620035771295" onmouseenter="enter('-8845229620035771295');" onmouseout="out('-8845229620035771295');" style=""> 234         requestContext.setNonPersistentSite(site);                                                       </span>
<span class="-596833746214779570" onmouseenter="enter('-596833746214779570');" onmouseout="out('-596833746214779570');" style=""> 235         requestContext.setCurrentCatalog(catalog);                                                       </span>
<span class="8511565119954978446" onmouseenter="enter('8511565119954978446');" onmouseout="out('8511565119954978446');" style=""> 236         requestContext.setCurrentProfile(profile);                                                       </span>
<span  style=""> 237                                                                                                          </span>
<span class="-2695749731081795645" onmouseenter="enter('-2695749731081795645');" onmouseout="out('-2695749731081795645');" style=""> 238         if (site != null) {                                                                              </span>
<span class="-5430658613312263263" onmouseenter="enter('-5430658613312263263');" onmouseout="out('-5430658613312263263');" style=""> 239             requestContext.setIgnoreSite(false);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 240         }                                                                                                </span>
<span  style=""> 241                                                                                                          </span>
<span class="-825861712451607908" onmouseenter="enter('-825861712451607908');" onmouseout="out('-825861712451607908');" style=""> 242         return isNew;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 243     }                                                                                                    </span>
<span  style=""> 244                                                                                                          </span>
<span class="-2258466500087063678" onmouseenter="enter('-2258466500087063678');" onmouseout="out('-2258466500087063678');" style=""><abbr title=" 245     private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionContainer"> 245     private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionConðŸ”µ</abbr></span>
<span class="-2034814968288808691" onmouseenter="enter('-2034814968288808691');" onmouseout="out('-2034814968288808691');" style=""> 246             container, boolean error) {                                                                  </span>
<span class="-766120542822293312" onmouseenter="enter('-766120542822293312');" onmouseout="out('-766120542822293312');" style=""> 247         TransactionUtils.finalizeTransaction(container.status, transactionManager, error);               </span>
<span class="8979610216143330423" onmouseenter="enter('8979610216143330423');" onmouseout="out('8979610216143330423');" style=""> 248         for (Map.Entry&lt;Object, Object&gt; entry : container.usedResources.entrySet()) {                     </span>
<span class="-2519888297476662498" onmouseenter="enter('-2519888297476662498');" onmouseout="out('-2519888297476662498');" style=""> 249             if (!TransactionSynchronizationManager.hasResource(entry.getKey())) {                        </span>
<span class="2316092200318402466" onmouseenter="enter('2316092200318402466');" onmouseout="out('2316092200318402466');" style=""> 250                 TransactionSynchronizationManager.bindResource(entry.getKey(), entry.getValue());        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 252         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 253     }                                                                                                    </span>
<span  style=""> 254                                                                                                          </span>
<span class="-8414791524342294371" onmouseenter="enter('-8414791524342294371');" onmouseout="out('-8414791524342294371');" style=""><abbr title=" 255     private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManager) {"> 255     private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManageðŸ”µ</abbr></span>
<span class="-8282331564281702139" onmouseenter="enter('-8282331564281702139');" onmouseout="out('-8282331564281702139');" style=""> 256         Map&lt;Object, Object&gt; usedResources = new HashMap&lt;Object, Object&gt;();                               </span>
<span class="810797588728929745" onmouseenter="enter('810797588728929745');" onmouseout="out('810797588728929745');" style=""> 257         Map&lt;Object, Object&gt; resources = TransactionSynchronizationManager.getResourceMap();              </span>
<span class="-3185760663221336664" onmouseenter="enter('-3185760663221336664');" onmouseout="out('-3185760663221336664');" style=""> 258         for (Map.Entry&lt;Object, Object&gt; entry : resources.entrySet()) {                                   </span>
<span class="393811491900493678" onmouseenter="enter('393811491900493678');" onmouseout="out('393811491900493678');" style=""><abbr title=" 259             if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource) &amp;&amp;"> 259             if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource)ðŸ”µ</abbr></span>
<span class="-3808176742636074825" onmouseenter="enter('-3808176742636074825');" onmouseout="out('-3808176742636074825');" style=""> 260                     TransactionSynchronizationManager.hasResource(entry.getKey())) {                     </span>
<span class="-6602288961953579852" onmouseenter="enter('-6602288961953579852');" onmouseout="out('-6602288961953579852');" style=""> 261                 usedResources.put(entry.getKey(), entry.getValue());                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 262             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 263         }                                                                                                </span>
<span class="-9108483853738564605" onmouseenter="enter('-9108483853738564605');" onmouseout="out('-9108483853738564605');" style=""> 264         for (Map.Entry&lt;Object, Object&gt; entry : usedResources.entrySet()) {                               </span>
<span class="574188550403203073" onmouseenter="enter('574188550403203073');" onmouseout="out('574188550403203073');" style=""> 265             TransactionSynchronizationManager.unbindResource(entry.getKey());                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 266         }                                                                                                </span>
<span  style=""> 267                                                                                                          </span>
<span class="-2686947146472656670" onmouseenter="enter('-2686947146472656670');" onmouseout="out('-2686947146472656670');" style=""> 268         TransactionStatus status;                                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 269         try {                                                                                            </span>
<span class="-7651374686191088801" onmouseenter="enter('-7651374686191088801');" onmouseout="out('-7651374686191088801');" style=""> 270             status = TransactionUtils.createTransaction(TransactionDefinition.PROPAGATION_REQUIRES_NEW,  </span>
<span class="2995382785742484314" onmouseenter="enter('2995382785742484314');" onmouseout="out('2995382785742484314');" style=""> 271                     transactionManager, false);                                                          </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style=""> 272         } catch (RuntimeException e) {                                                                   </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 273             throw e;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 274         }                                                                                                </span>
<span class="-3836925212545710491" onmouseenter="enter('-3836925212545710491');" onmouseout="out('-3836925212545710491');" style=""> 275         return new TransactionContainer(status, usedResources);                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 276     }                                                                                                    </span>
<span  style=""> 277                                                                                                          </span>
<span class="-8049495641573146634" onmouseenter="enter('-8049495641573146634');" onmouseout="out('-8049495641573146634');" style=""> 278     private static class TransactionContainer {                                                          </span>
<span class="-2686947146472656670" onmouseenter="enter('-2686947146472656670');" onmouseout="out('-2686947146472656670');" style=""> 279         TransactionStatus status;                                                                        </span>
<span class="7376018894019906245" onmouseenter="enter('7376018894019906245');" onmouseout="out('7376018894019906245');" style=""> 280         Map&lt;Object, Object&gt; usedResources;                                                               </span>
<span  style=""> 281                                                                                                          </span>
<span class="1782715066093141529" onmouseenter="enter('1782715066093141529');" onmouseout="out('1782715066093141529');" style=""> 282         private TransactionContainer(TransactionStatus status, Map&lt;Object, Object&gt; usedResources) {      </span>
<span class="-5831567129597574107" onmouseenter="enter('-5831567129597574107');" onmouseout="out('-5831567129597574107');" style=""> 283             this.status = status;                                                                        </span>
<span class="-2556535949128531147" onmouseenter="enter('-2556535949128531147');" onmouseout="out('-2556535949128531147');" style=""> 284             this.usedResources = usedResources;                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285         }                                                                                                </span>
<span  style=""> 286                                                                                                          </span>
<span class="1560481439222774158" onmouseenter="enter('1560481439222774158');" onmouseout="out('1560481439222774158');" style=""> 287         public TransactionStatus getStatus() {                                                           </span>
<span class="-8054900221824109356" onmouseenter="enter('-8054900221824109356');" onmouseout="out('-8054900221824109356');" style=""> 288             return status;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 289         }                                                                                                </span>
<span  style=""> 290                                                                                                          </span>
<span class="-505973652319309977" onmouseenter="enter('-505973652319309977');" onmouseout="out('-505973652319309977');" style=""> 291         public void setStatus(TransactionStatus status) {                                                </span>
<span class="-5831567129597574107" onmouseenter="enter('-5831567129597574107');" onmouseout="out('-5831567129597574107');" style=""> 292             this.status = status;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 293         }                                                                                                </span>
<span  style=""> 294                                                                                                          </span>
<span class="-2349550172450043036" onmouseenter="enter('-2349550172450043036');" onmouseout="out('-2349550172450043036');" style=""> 295         public Map&lt;Object, Object&gt; getUsedResources() {                                                  </span>
<span class="-7324790907786626209" onmouseenter="enter('-7324790907786626209');" onmouseout="out('-7324790907786626209');" style=""> 296             return usedResources;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 297         }                                                                                                </span>
<span  style=""> 298                                                                                                          </span>
<span class="9139736372877762091" onmouseenter="enter('9139736372877762091');" onmouseout="out('9139736372877762091');" style=""> 299         public void setUsedResources(Map&lt;Object, Object&gt; usedResources) {                                </span>
<span class="-2556535949128531147" onmouseenter="enter('-2556535949128531147');" onmouseout="out('-2556535949128531147');" style=""> 300             this.usedResources = usedResources;                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 301         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 302     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 303 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-4573490878212285276" onmouseenter="enter('-4573490878212285276');" onmouseout="out('-4573490878212285276');" style="">   3  * BroadleafCommerce Common Libraries                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-512514810257161872" onmouseenter="enter('-512514810257161872');" onmouseout="out('-512514810257161872');" style="">  18 package org.broadleafcommerce.common.util.tenant;                                                        </span>
<span  style="">  19                                                                                                          </span>
<span class="-4286566313930798693" onmouseenter="enter('-4286566313930798693');" onmouseout="out('-4286566313930798693');" style="">  20 import org.broadleafcommerce.common.site.domain.Catalog;                                                 </span>
<span class="3350833871385260454" onmouseenter="enter('3350833871385260454');" onmouseout="out('3350833871385260454');" style="">  21 import org.broadleafcommerce.common.site.domain.Site;                                                    </span>
<span class="5107697851223623564" onmouseenter="enter('5107697851223623564');" onmouseout="out('5107697851223623564');" style="">  22 import org.broadleafcommerce.common.util.TransactionUtils;                                               </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  23 import org.broadleafcommerce.common.web.BroadleafRequestContext;                                         </span>
<span class="-740123120803947738" onmouseenter="enter('-740123120803947738');" onmouseout="out('-740123120803947738');" style="">  24 import org.springframework.transaction.PlatformTransactionManager;                                       </span>
<span class="-8923386680468181280" onmouseenter="enter('-8923386680468181280');" onmouseout="out('-8923386680468181280');" style="">  25 import org.springframework.transaction.TransactionDefinition;                                            </span>
<span class="8980559080936335720" onmouseenter="enter('8980559080936335720');" onmouseout="out('8980559080936335720');" style="">  26 import org.springframework.transaction.TransactionStatus;                                                </span>
<span class="-25494037965120322" onmouseenter="enter('-25494037965120322');" onmouseout="out('-25494037965120322');" style="">  27 import org.springframework.transaction.support.TransactionSynchronizationManager;                        </span>
<span  style="">  28                                                                                                          </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  29 import java.util.HashMap;                                                                                </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  30 import java.util.Map;                                                                                    </span>
<span  style="">  31                                                                                                          </span>
<span class="1791670663098173858" onmouseenter="enter('1791670663098173858');" onmouseout="out('1791670663098173858');" style="">  32 import javax.persistence.EntityManagerFactory;                                                           </span>
<span class="-7201454294566819418" onmouseenter="enter('-7201454294566819418');" onmouseout="out('-7201454294566819418');" style="">  33 import javax.sql.DataSource;                                                                             </span>
<span  style="">  34                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  35 /**                                                                                                      </span>
<span class="-5413269856564896844" onmouseenter="enter('-5413269856564896844');" onmouseout="out('-5413269856564896844');" style=""><abbr title="  36  * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and instead">  36  * The utility methods in this class provide a way to ignore the currently configured site/catalog contexðŸ”µ</abbr></span>
<span class="-1334135248073305720" onmouseenter="enter('-1334135248073305720');" onmouseout="out('-1334135248073305720');" style="">  37  * explicitly run operations in the specified context.                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  38  *                                                                                                       </span>
<span class="-7311139588847938491" onmouseenter="enter('-7311139588847938491');" onmouseout="out('-7311139588847938491');" style="">  39  * @author Jeff Fischer                                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  40  */                                                                                                      </span>
<span class="-1398877175080343843" onmouseenter="enter('-1398877175080343843');" onmouseout="out('-1398877175080343843');" style="">  41 public class IdentityExecutionUtils {                                                                    </span>
<span  style="">  42                                                                                                          </span>
<span class="-652529928056955706" onmouseenter="enter('-652529928056955706');" onmouseout="out('-652529928056955706');" style=""><abbr title="  43     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog,">  43     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="6167977986734295120" onmouseenter="enter('6167977986734295120');" onmouseout="out('6167977986734295120');" style=""><abbr title="  44                                                               PlatformTransactionManager transactionManager) throws G {">  44                                                               PlatformTransactionManager transactionManagðŸ”µ</abbr></span>
<span  style="">  45                                                                                                          </span>
<span class="-7770167299096999061" onmouseenter="enter('-7770167299096999061');" onmouseout="out('-7770167299096999061');" style="">  46         IdentityUtilContext context = new IdentityUtilContext();                                         </span>
<span class="732355087831690145" onmouseenter="enter('732355087831690145');" onmouseout="out('732355087831690145');" style="">  47         context.setIdentifier(site);                                                                     </span>
<span class="3289280907674551762" onmouseenter="enter('3289280907674551762');" onmouseout="out('3289280907674551762');" style="">  48         IdentityUtilContext.setUtilContext(context);                                                     </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style="">  49         TransactionContainer container = null;                                                           </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style="">  50         boolean isError = false;                                                                         </span>
<span class="5982941254864048436" onmouseenter="enter('5982941254864048436');" onmouseout="out('5982941254864048436');" style="">  51         Site previousSite = null;                                                                        </span>
<span class="-1736636036474983614" onmouseenter="enter('-1736636036474983614');" onmouseout="out('-1736636036474983614');" style="">  52         Catalog previousCatalog = null;                                                                  </span>
<span class="6146465993479879827" onmouseenter="enter('6146465993479879827');" onmouseout="out('6146465993479879827');" style="">  53         Site previousProfile = null;                                                                     </span>
<span class="-3038915738898370631" onmouseenter="enter('-3038915738898370631');" onmouseout="out('-3038915738898370631');" style="">  54         Boolean previousIsIgnoringSite = false;                                                          </span>
<span  style="">  55                                                                                                          </span>
<span class="-7323698650211604384" onmouseenter="enter('-7323698650211604384');" onmouseout="out('-7323698650211604384');" style="">  56         BroadleafRequestContext originalBrc = BroadleafRequestContext.getBroadleafRequestContext(false); </span>
<span class="386637157613053325" onmouseenter="enter('386637157613053325');" onmouseout="out('386637157613053325');" style="">  57         if (originalBrc != null) {                                                                       </span>
<span class="-7815041635819803257" onmouseenter="enter('-7815041635819803257');" onmouseout="out('-7815041635819803257');" style="">  58             previousSite = originalBrc.getNonPersistentSite();                                           </span>
<span class="-1817538935719022010" onmouseenter="enter('-1817538935719022010');" onmouseout="out('-1817538935719022010');" style="">  59             previousCatalog = originalBrc.getCurrentCatalog();                                           </span>
<span class="-6859502314315274901" onmouseenter="enter('-6859502314315274901');" onmouseout="out('-6859502314315274901');" style="">  60             previousProfile = originalBrc.getCurrentProfile();                                           </span>
<span class="7174699852720058151" onmouseenter="enter('7174699852720058151');" onmouseout="out('7174699852720058151');" style="">  61             previousIsIgnoringSite = originalBrc.getIgnoreSite();                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  62         }                                                                                                </span>
<span  style="">  63                                                                                                          </span>
<span class="2981698039391216134" onmouseenter="enter('2981698039391216134');" onmouseout="out('2981698039391216134');" style="">  64         boolean isNew = initRequestContext(site, profile, catalog);                                      </span>
<span  style="">  65                                                                                                          </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style="">  66 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  67         TransactionContainer container = null;                                                           </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style="">  68 ||||||| BASE                                                                                             </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69         activateSession();                                                                               </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70                                                                                                          </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71         TransactionContainer container = null;                                                           </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72         if (transactionManager != null) {                                                                </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73             container = establishTransaction(transactionManager);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74         }                                                                                                </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75                                                                                                          </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         boolean isError = false;                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         try {                                                                                            </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78             return operation.execute();                                                                  </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         } catch (RuntimeException e) {                                                                   </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80             isError = true;                                                                              </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81             throw e;                                                                                     </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  82 =======                                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83         try {                                                                                            </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84             activateSession();                                                                           </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85                                                                                                          </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style="">  86 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="">  87         if (transactionManager != null) {                                                                </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style="">  88             container = establishTransaction(transactionManager);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  89         }                                                                                                </span>
<span  style="">  90                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  91         try {                                                                                            </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style="">  92             return operation.execute();                                                                  </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style="">  93         } catch (RuntimeException e) {                                                                   </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style="">  94             isError = true;                                                                              </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style="">  95             throw e;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  96             }                                                                                            </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style="">  97         } finally {                                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  98             try {                                                                                        </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style="">  99             if (container != null) {                                                                     </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style=""> 100                 finalizeTransaction(transactionManager, container, isError);                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 101             }                                                                                            </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 102             } finally {                                                                                  </span>
<span class="-866580000084113477" onmouseenter="enter('-866580000084113477');" onmouseout="out('-866580000084113477');" style=""> 103             IdentityUtilContext.setUtilContext(null);                                                    </span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style=""> 104             if (isNew) {                                                                                 </span>
<span class="8043600097329985222" onmouseenter="enter('8043600097329985222');" onmouseout="out('8043600097329985222');" style=""> 105                 BroadleafRequestContext.setBroadleafRequestContext(null);                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 106                 } else {                                                                                 </span>
<span class="-5663523450271762170" onmouseenter="enter('-5663523450271762170');" onmouseout="out('-5663523450271762170');" style=""><abbr title=" 107                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);"> 107                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringðŸ”µ</abbr></span>
<span class="-519937983444515271" onmouseenter="enter('-519937983444515271');" onmouseout="out('-519937983444515271');" style=""><abbr title=" 108                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);"> 108                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSitðŸ”µ</abbr></span>
<span class="-1622484655952997173" onmouseenter="enter('-1622484655952997173');" onmouseout="out('-1622484655952997173');" style=""> 109             BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);     </span>
<span class="5071379482955896849" onmouseenter="enter('5071379482955896849');" onmouseout="out('5071379482955896849');" style=""> 110             BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 111         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 112     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 114     }                                                                                                    </span>
<span  style=""> 115                                                                                                          </span>
<span class="-485315311381460363" onmouseenter="enter('-485315311381460363');" onmouseout="out('-485315311381460363');" style=""><abbr title=" 116     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Catalog catalog) throws G {"> 116     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="-2149174260692711216" onmouseenter="enter('-2149174260692711216');" onmouseout="out('-2149174260692711216');" style=""> 117         return runOperationByIdentifier(operation, site, null, catalog, null);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 118     }                                                                                                    </span>
<span  style=""> 119                                                                                                          </span>
<span class="-3389004741801466008" onmouseenter="enter('-3389004741801466008');" onmouseout="out('-3389004741801466008');" style=""><abbr title=" 120     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog) throws G {"> 120     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="-4482989458560555755" onmouseenter="enter('-4482989458560555755');" onmouseout="out('-4482989458560555755');" style=""> 121         return runOperationByIdentifier(operation, site, profile, catalog, null);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122     }                                                                                                    </span>
<span  style=""> 123                                                                                                          </span>
<span class="-8143870051657701621" onmouseenter="enter('-8143870051657701621');" onmouseout="out('-8143870051657701621');" style=""><abbr title=" 124     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site) throws G {"> 124     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="-3215157294418599548" onmouseenter="enter('-3215157294418599548');" onmouseout="out('-3215157294418599548');" style=""> 125         return runOperationByIdentifier(operation, site, null, null, null);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 126     }                                                                                                    </span>
<span  style=""> 127                                                                                                          </span>
<span class="-2275937291032103964" onmouseenter="enter('-2275937291032103964');" onmouseout="out('-2275937291032103964');" style=""><abbr title=" 128     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile) throws G {"> 128     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="8388199613493551564" onmouseenter="enter('8388199613493551564');" onmouseout="out('8388199613493551564');" style=""> 129         return runOperationByIdentifier(operation, site, profile, null);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 130     }                                                                                                    </span>
<span  style=""> 131                                                                                                          </span>
<span class="6819324175888184161" onmouseenter="enter('6819324175888184161');" onmouseout="out('6819324175888184161');" style=""><abbr title=" 132     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) throws G {"> 132     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operðŸ”µ</abbr></span>
<span class="-4246408630280487290" onmouseenter="enter('-4246408630280487290');" onmouseout="out('-4246408630280487290');" style=""> 133         return runOperationAndIgnoreIdentifier(operation, null);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 134     }                                                                                                    </span>
<span  style=""> 135                                                                                                          </span>
<span class="-4518289252412213481" onmouseenter="enter('-4518289252412213481');" onmouseout="out('-4518289252412213481');" style=""><abbr title=" 136     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation,"> 136     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operðŸ”µ</abbr></span>
<span class="6167977986734295120" onmouseenter="enter('6167977986734295120');" onmouseout="out('6167977986734295120');" style=""> 137             PlatformTransactionManager transactionManager) throws G {                                    </span>
<span class="-5567505797438091464" onmouseenter="enter('-5567505797438091464');" onmouseout="out('-5567505797438091464');" style=""> 138         //Set up pre-existing state...                                                                   </span>
<span class="1874085528725214811" onmouseenter="enter('1874085528725214811');" onmouseout="out('1874085528725214811');" style=""> 139         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext(false);         </span>
<span class="5982941254864048436" onmouseenter="enter('5982941254864048436');" onmouseout="out('5982941254864048436');" style=""> 140         Site previousSite = null;                                                                        </span>
<span class="-1736636036474983614" onmouseenter="enter('-1736636036474983614');" onmouseout="out('-1736636036474983614');" style=""> 141         Catalog previousCatalog = null;                                                                  </span>
<span class="6146465993479879827" onmouseenter="enter('6146465993479879827');" onmouseout="out('6146465993479879827');" style=""> 142         Site previousProfile = null;                                                                     </span>
<span class="-3038915738898370631" onmouseenter="enter('-3038915738898370631');" onmouseout="out('-3038915738898370631');" style=""> 143         Boolean previousIsIgnoringSite = false;                                                          </span>
<span  style=""> 144                                                                                                          </span>
<span class="-3197739461753066202" onmouseenter="enter('-3197739461753066202');" onmouseout="out('-3197739461753066202');" style=""> 145         if (brc != null) {                                                                               </span>
<span class="-8911406761612770367" onmouseenter="enter('-8911406761612770367');" onmouseout="out('-8911406761612770367');" style=""> 146             previousSite = brc.getNonPersistentSite();                                                   </span>
<span class="-4648385020762162138" onmouseenter="enter('-4648385020762162138');" onmouseout="out('-4648385020762162138');" style=""> 147             previousCatalog = brc.getCurrentCatalog();                                                   </span>
<span class="-117804761019864275" onmouseenter="enter('-117804761019864275');" onmouseout="out('-117804761019864275');" style=""> 148             previousProfile = brc.getCurrentProfile();                                                   </span>
<span class="-4607913904778825019" onmouseenter="enter('-4607913904778825019');" onmouseout="out('-4607913904778825019');" style=""> 149             previousIsIgnoringSite = brc.getIgnoreSite();                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 150         }                                                                                                </span>
<span  style=""> 151                                                                                                          </span>
<span class="139705847590485842" onmouseenter="enter('139705847590485842');" onmouseout="out('139705847590485842');" style=""><abbr title=" 152         //Initialize new state...  This will guaratee that a BroadleafRequestContext is available to this thread."> 152         //Initialize new state...  This will guaratee that a BroadleafRequestContext is available to thisðŸ”µ</abbr></span>
<span class="-1943348167742156849" onmouseenter="enter('-1943348167742156849');" onmouseout="out('-1943348167742156849');" style=""> 153         boolean isNew = initRequestContext(null, null, null);                                            </span>
<span  style=""> 154                                                                                                          </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style=""> 155         TransactionContainer container = null;                                                           </span>
<span  style=""> 156                                                                                                          </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style=""> 157         boolean isError = false;                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 158         try {                                                                                            </span>
<span class="7425048344239509528" onmouseenter="enter('7425048344239509528');" onmouseout="out('7425048344239509528');" style=""> 159         BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);                        </span>
<span  style=""> 160                                                                                                          </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 161 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162         TransactionContainer container = null;                                                           </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 163 ||||||| BASE                                                                                             </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164         activateSession();                                                                               </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165                                                                                                          </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         TransactionContainer container = null;                                                           </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         if (transactionManager != null) {                                                                </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168             container = establishTransaction(transactionManager);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         }                                                                                                </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         boolean isError = false;                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         try {                                                                                            </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172             return operation.execute();                                                                  </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         } catch (RuntimeException e) {                                                                   </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174             isError = true;                                                                              </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175             throw e;                                                                                     </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176         } finally {                                                                                      </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177             if (container != null) {                                                                     </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178                 finalizeTransaction(transactionManager, container, isError);                             </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 179 =======                                                                                                  </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180             activateSession();                                                                           </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 181 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style=""> 182         if (transactionManager != null) {                                                                </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style=""> 183             container = establishTransaction(transactionManager);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184         }                                                                                                </span>
<span  style=""> 185                                                                                                          </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style=""> 186             return operation.execute();                                                                  </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style=""> 187         } catch (RuntimeException e) {                                                                   </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style=""> 188             isError = true;                                                                              </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 189             throw e;                                                                                     </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 190         } finally {                                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 191             try {                                                                                        </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style=""> 192             if (container != null) {                                                                     </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style=""> 193                 finalizeTransaction(transactionManager, container, isError);                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 194             }                                                                                            </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 195             } finally {                                                                                  </span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style=""> 196             if (isNew) {                                                                                 </span>
<span class="6183760171671125539" onmouseenter="enter('6183760171671125539');" onmouseout="out('6183760171671125539');" style=""> 197                     //We just created this, so don&#x27;t leave it lying around.                              </span>
<span class="8043600097329985222" onmouseenter="enter('8043600097329985222');" onmouseout="out('8043600097329985222');" style=""> 198                 BroadleafRequestContext.setBroadleafRequestContext(null);                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 199                 } else {                                                                                 </span>
<span class="-3608180821406181105" onmouseenter="enter('-3608180821406181105');" onmouseout="out('-3608180821406181105');" style=""> 200                     //Otherwise, reset pre-existing state.                                               </span>
<span class="-5663523450271762170" onmouseenter="enter('-5663523450271762170');" onmouseout="out('-5663523450271762170');" style=""><abbr title=" 201                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);"> 201                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringðŸ”µ</abbr></span>
<span class="-519937983444515271" onmouseenter="enter('-519937983444515271');" onmouseout="out('-519937983444515271');" style=""><abbr title=" 202                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);"> 202                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSitðŸ”µ</abbr></span>
<span class="-1622484655952997173" onmouseenter="enter('-1622484655952997173');" onmouseout="out('-1622484655952997173');" style=""> 203             BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);     </span>
<span class="5071379482955896849" onmouseenter="enter('5071379482955896849');" onmouseout="out('5071379482955896849');" style=""> 204             BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 205         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 206     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 207         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 208     }                                                                                                    </span>
<span  style=""> 209                                                                                                          </span>
<span class="-7595713675186321428" onmouseenter="enter('-7595713675186321428');" onmouseout="out('-7595713675186321428');" style=""> 210     private static boolean initRequestContext(Site site, Site profile, Catalog catalog) {                </span>
<span class="-2081663176034123456" onmouseenter="enter('-2081663176034123456');" onmouseout="out('-2081663176034123456');" style=""> 211         boolean isNew = false;                                                                           </span>
<span class="1959723908368963258" onmouseenter="enter('1959723908368963258');" onmouseout="out('1959723908368963258');" style=""><abbr title=" 212         BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(false);"> 212         BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(falseðŸ”µ</abbr></span>
<span  style=""> 213                                                                                                          </span>
<span class="-5701496640250763224" onmouseenter="enter('-5701496640250763224');" onmouseout="out('-5701496640250763224');" style=""> 214         if (requestContext == null) {                                                                    </span>
<span class="7779864663200542762" onmouseenter="enter('7779864663200542762');" onmouseout="out('7779864663200542762');" style=""> 215             requestContext = new BroadleafRequestContext();                                              </span>
<span class="2698271589848593965" onmouseenter="enter('2698271589848593965');" onmouseout="out('2698271589848593965');" style=""> 216             BroadleafRequestContext.setBroadleafRequestContext(requestContext);                          </span>
<span class="8240120666987537487" onmouseenter="enter('8240120666987537487');" onmouseout="out('8240120666987537487');" style=""> 217             isNew = true;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 218         }                                                                                                </span>
<span  style=""> 219                                                                                                          </span>
<span class="-8845229620035771295" onmouseenter="enter('-8845229620035771295');" onmouseout="out('-8845229620035771295');" style=""> 220         requestContext.setNonPersistentSite(site);                                                       </span>
<span class="-596833746214779570" onmouseenter="enter('-596833746214779570');" onmouseout="out('-596833746214779570');" style=""> 221         requestContext.setCurrentCatalog(catalog);                                                       </span>
<span class="8511565119954978446" onmouseenter="enter('8511565119954978446');" onmouseout="out('8511565119954978446');" style=""> 222         requestContext.setCurrentProfile(profile);                                                       </span>
<span  style=""> 223                                                                                                          </span>
<span class="-2695749731081795645" onmouseenter="enter('-2695749731081795645');" onmouseout="out('-2695749731081795645');" style=""> 224         if (site != null) {                                                                              </span>
<span class="-5430658613312263263" onmouseenter="enter('-5430658613312263263');" onmouseout="out('-5430658613312263263');" style=""> 225             requestContext.setIgnoreSite(false);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 226         }                                                                                                </span>
<span  style=""> 227                                                                                                          </span>
<span class="-825861712451607908" onmouseenter="enter('-825861712451607908');" onmouseout="out('-825861712451607908');" style=""> 228         return isNew;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 229     }                                                                                                    </span>
<span  style=""> 230                                                                                                          </span>
<span class="-2258466500087063678" onmouseenter="enter('-2258466500087063678');" onmouseout="out('-2258466500087063678');" style=""><abbr title=" 231     private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionContainer"> 231     private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionConðŸ”µ</abbr></span>
<span class="-2034814968288808691" onmouseenter="enter('-2034814968288808691');" onmouseout="out('-2034814968288808691');" style=""> 232             container, boolean error) {                                                                  </span>
<span class="-766120542822293312" onmouseenter="enter('-766120542822293312');" onmouseout="out('-766120542822293312');" style=""> 233         TransactionUtils.finalizeTransaction(container.status, transactionManager, error);               </span>
<span class="8979610216143330423" onmouseenter="enter('8979610216143330423');" onmouseout="out('8979610216143330423');" style=""> 234         for (Map.Entry&lt;Object, Object&gt; entry : container.usedResources.entrySet()) {                     </span>
<span class="-2519888297476662498" onmouseenter="enter('-2519888297476662498');" onmouseout="out('-2519888297476662498');" style=""> 235             if (!TransactionSynchronizationManager.hasResource(entry.getKey())) {                        </span>
<span class="2316092200318402466" onmouseenter="enter('2316092200318402466');" onmouseout="out('2316092200318402466');" style=""> 236                 TransactionSynchronizationManager.bindResource(entry.getKey(), entry.getValue());        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 237             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 239     }                                                                                                    </span>
<span  style=""> 240                                                                                                          </span>
<span class="-8414791524342294371" onmouseenter="enter('-8414791524342294371');" onmouseout="out('-8414791524342294371');" style=""><abbr title=" 241     private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManager) {"> 241     private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManageðŸ”µ</abbr></span>
<span class="-8282331564281702139" onmouseenter="enter('-8282331564281702139');" onmouseout="out('-8282331564281702139');" style=""> 242         Map&lt;Object, Object&gt; usedResources = new HashMap&lt;Object, Object&gt;();                               </span>
<span class="810797588728929745" onmouseenter="enter('810797588728929745');" onmouseout="out('810797588728929745');" style=""> 243         Map&lt;Object, Object&gt; resources = TransactionSynchronizationManager.getResourceMap();              </span>
<span class="-3185760663221336664" onmouseenter="enter('-3185760663221336664');" onmouseout="out('-3185760663221336664');" style=""> 244         for (Map.Entry&lt;Object, Object&gt; entry : resources.entrySet()) {                                   </span>
<span class="393811491900493678" onmouseenter="enter('393811491900493678');" onmouseout="out('393811491900493678');" style=""><abbr title=" 245             if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource) &amp;&amp;"> 245             if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource)ðŸ”µ</abbr></span>
<span class="-3808176742636074825" onmouseenter="enter('-3808176742636074825');" onmouseout="out('-3808176742636074825');" style=""> 246                     TransactionSynchronizationManager.hasResource(entry.getKey())) {                     </span>
<span class="-6602288961953579852" onmouseenter="enter('-6602288961953579852');" onmouseout="out('-6602288961953579852');" style=""> 247                 usedResources.put(entry.getKey(), entry.getValue());                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 248             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 249         }                                                                                                </span>
<span class="-9108483853738564605" onmouseenter="enter('-9108483853738564605');" onmouseout="out('-9108483853738564605');" style=""> 250         for (Map.Entry&lt;Object, Object&gt; entry : usedResources.entrySet()) {                               </span>
<span class="574188550403203073" onmouseenter="enter('574188550403203073');" onmouseout="out('574188550403203073');" style=""> 251             TransactionSynchronizationManager.unbindResource(entry.getKey());                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 252         }                                                                                                </span>
<span  style=""> 253                                                                                                          </span>
<span class="-2686947146472656670" onmouseenter="enter('-2686947146472656670');" onmouseout="out('-2686947146472656670');" style=""> 254         TransactionStatus status;                                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 255         try {                                                                                            </span>
<span class="-7651374686191088801" onmouseenter="enter('-7651374686191088801');" onmouseout="out('-7651374686191088801');" style=""> 256             status = TransactionUtils.createTransaction(TransactionDefinition.PROPAGATION_REQUIRES_NEW,  </span>
<span class="2995382785742484314" onmouseenter="enter('2995382785742484314');" onmouseout="out('2995382785742484314');" style=""> 257                     transactionManager, false);                                                          </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style=""> 258         } catch (RuntimeException e) {                                                                   </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 259             throw e;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 260         }                                                                                                </span>
<span class="-3836925212545710491" onmouseenter="enter('-3836925212545710491');" onmouseout="out('-3836925212545710491');" style=""> 261         return new TransactionContainer(status, usedResources);                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 262     }                                                                                                    </span>
<span  style=""> 263                                                                                                          </span>
<span class="-8049495641573146634" onmouseenter="enter('-8049495641573146634');" onmouseout="out('-8049495641573146634');" style=""> 264     private static class TransactionContainer {                                                          </span>
<span class="-2686947146472656670" onmouseenter="enter('-2686947146472656670');" onmouseout="out('-2686947146472656670');" style=""> 265         TransactionStatus status;                                                                        </span>
<span class="7376018894019906245" onmouseenter="enter('7376018894019906245');" onmouseout="out('7376018894019906245');" style=""> 266         Map&lt;Object, Object&gt; usedResources;                                                               </span>
<span  style=""> 267                                                                                                          </span>
<span class="1782715066093141529" onmouseenter="enter('1782715066093141529');" onmouseout="out('1782715066093141529');" style=""> 268         private TransactionContainer(TransactionStatus status, Map&lt;Object, Object&gt; usedResources) {      </span>
<span class="-5831567129597574107" onmouseenter="enter('-5831567129597574107');" onmouseout="out('-5831567129597574107');" style=""> 269             this.status = status;                                                                        </span>
<span class="-2556535949128531147" onmouseenter="enter('-2556535949128531147');" onmouseout="out('-2556535949128531147');" style=""> 270             this.usedResources = usedResources;                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 271         }                                                                                                </span>
<span  style=""> 272                                                                                                          </span>
<span class="1560481439222774158" onmouseenter="enter('1560481439222774158');" onmouseout="out('1560481439222774158');" style=""> 273         public TransactionStatus getStatus() {                                                           </span>
<span class="-8054900221824109356" onmouseenter="enter('-8054900221824109356');" onmouseout="out('-8054900221824109356');" style=""> 274             return status;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 275         }                                                                                                </span>
<span  style=""> 276                                                                                                          </span>
<span class="-505973652319309977" onmouseenter="enter('-505973652319309977');" onmouseout="out('-505973652319309977');" style=""> 277         public void setStatus(TransactionStatus status) {                                                </span>
<span class="-5831567129597574107" onmouseenter="enter('-5831567129597574107');" onmouseout="out('-5831567129597574107');" style=""> 278             this.status = status;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 279         }                                                                                                </span>
<span  style=""> 280                                                                                                          </span>
<span class="-2349550172450043036" onmouseenter="enter('-2349550172450043036');" onmouseout="out('-2349550172450043036');" style=""> 281         public Map&lt;Object, Object&gt; getUsedResources() {                                                  </span>
<span class="-7324790907786626209" onmouseenter="enter('-7324790907786626209');" onmouseout="out('-7324790907786626209');" style=""> 282             return usedResources;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 283         }                                                                                                </span>
<span  style=""> 284                                                                                                          </span>
<span class="9139736372877762091" onmouseenter="enter('9139736372877762091');" onmouseout="out('9139736372877762091');" style=""> 285         public void setUsedResources(Map&lt;Object, Object&gt; usedResources) {                                </span>
<span class="-2556535949128531147" onmouseenter="enter('-2556535949128531147');" onmouseout="out('-2556535949128531147');" style=""> 286             this.usedResources = usedResources;                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 287         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 288     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 289 }                                                                                                        </span>












</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-4573490878212285276" onmouseenter="enter('-4573490878212285276');" onmouseout="out('-4573490878212285276');" style="">   3  * BroadleafCommerce Common Libraries                                                                    </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-512514810257161872" onmouseenter="enter('-512514810257161872');" onmouseout="out('-512514810257161872');" style="">  18 package org.broadleafcommerce.common.util.tenant;                                                        </span>
<span  style="">  19                                                                                                          </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  20 import java.util.HashMap;                                                                                </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  21 import java.util.Map;                                                                                    </span>
<span class="1791670663098173858" onmouseenter="enter('1791670663098173858');" onmouseout="out('1791670663098173858');" style="">  22 import javax.persistence.EntityManagerFactory;                                                           </span>
<span class="-7201454294566819418" onmouseenter="enter('-7201454294566819418');" onmouseout="out('-7201454294566819418');" style="">  23 import javax.sql.DataSource;                                                                             </span>
<span class="-4286566313930798693" onmouseenter="enter('-4286566313930798693');" onmouseout="out('-4286566313930798693');" style="">  24 import org.broadleafcommerce.common.site.domain.Catalog;                                                 </span>
<span class="3350833871385260454" onmouseenter="enter('3350833871385260454');" onmouseout="out('3350833871385260454');" style="">  25 import org.broadleafcommerce.common.site.domain.Site;                                                    </span>
<span class="5107697851223623564" onmouseenter="enter('5107697851223623564');" onmouseout="out('5107697851223623564');" style="">  26 import org.broadleafcommerce.common.util.TransactionUtils;                                               </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  27 import org.broadleafcommerce.common.web.BroadleafRequestContext;                                         </span>
<span class="-740123120803947738" onmouseenter="enter('-740123120803947738');" onmouseout="out('-740123120803947738');" style="">  28 import org.springframework.transaction.PlatformTransactionManager;                                       </span>
<span class="-8923386680468181280" onmouseenter="enter('-8923386680468181280');" onmouseout="out('-8923386680468181280');" style="">  29 import org.springframework.transaction.TransactionDefinition;                                            </span>
<span class="8980559080936335720" onmouseenter="enter('8980559080936335720');" onmouseout="out('8980559080936335720');" style="">  30 import org.springframework.transaction.TransactionStatus;                                                </span>
<span class="-25494037965120322" onmouseenter="enter('-25494037965120322');" onmouseout="out('-25494037965120322');" style="">  31 import org.springframework.transaction.support.TransactionSynchronizationManager;                        </span>
<span  style="">  32                                                                                                          </span>
<span  style="">  33                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  34 /**                                                                                                      </span>
<span class="-5413269856564896844" onmouseenter="enter('-5413269856564896844');" onmouseout="out('-5413269856564896844');" style=""><abbr title="  35  * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and instead">  35  * The utility methods in this class provide a way to ignore the currently configured site/catalog contexðŸ”µ</abbr></span>
<span class="-1334135248073305720" onmouseenter="enter('-1334135248073305720');" onmouseout="out('-1334135248073305720');" style="">  36  * explicitly run operations in the specified context.                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  37  *                                                                                                       </span>
<span class="-7311139588847938491" onmouseenter="enter('-7311139588847938491');" onmouseout="out('-7311139588847938491');" style="">  38  * @author Jeff Fischer                                                                                  </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  39  */                                                                                                      </span>
<span class="-1398877175080343843" onmouseenter="enter('-1398877175080343843');" onmouseout="out('-1398877175080343843');" style="">  40 public class IdentityExecutionUtils {                                                                    </span>
<span class="5813135504558044952" onmouseenter="enter('5813135504558044952');" onmouseout="out('5813135504558044952');" style=""><abbr title="  41     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog, PlatformTransactionManager transactionManager) throws G {">  41     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span  style="">  42                                                                                                          </span>
<span class="-7770167299096999061" onmouseenter="enter('-7770167299096999061');" onmouseout="out('-7770167299096999061');" style=""><abbr title="  43                                                                     IdentityUtilContext context = new IdentityUtilContext();">  43                                                                     IdentityUtilContext context = new IdeðŸ”µ</abbr></span>
<span class="732355087831690145" onmouseenter="enter('732355087831690145');" onmouseout="out('732355087831690145');" style="">  44                                                                     context.setIdentifier(site);         </span>
<span class="3289280907674551762" onmouseenter="enter('3289280907674551762');" onmouseout="out('3289280907674551762');" style=""><abbr title="  45                                                                     IdentityUtilContext.setUtilContext(context);">  45                                                                     IdentityUtilContext.setUtilContext(coðŸ”µ</abbr></span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style=""><abbr title="  46                                                                     TransactionContainer container = null;">  46                                                                     TransactionContainer container = nullðŸ”µ</abbr></span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style="">  47                                                                     boolean isError = false;             </span>
<span class="5982941254864048436" onmouseenter="enter('5982941254864048436');" onmouseout="out('5982941254864048436');" style="">  48                                                                     Site previousSite = null;            </span>
<span class="-1736636036474983614" onmouseenter="enter('-1736636036474983614');" onmouseout="out('-1736636036474983614');" style="">  49                                                                     Catalog previousCatalog = null;      </span>
<span class="6146465993479879827" onmouseenter="enter('6146465993479879827');" onmouseout="out('6146465993479879827');" style="">  50                                                                     Site previousProfile = null;         </span>
<span class="-3038915738898370631" onmouseenter="enter('-3038915738898370631');" onmouseout="out('-3038915738898370631');" style=""><abbr title="  51                                                                     Boolean previousIsIgnoringSite = false;">  51                                                                     Boolean previousIsIgnoringSite = falsðŸ”µ</abbr></span>
<span  style="">  52                                                                                                          </span>
<span class="-7323698650211604384" onmouseenter="enter('-7323698650211604384');" onmouseout="out('-7323698650211604384');" style=""><abbr title="  53                                                                     BroadleafRequestContext originalBrc = BroadleafRequestContext.getBroadleafRequestContext(false);">  53                                                                     BroadleafRequestContext originalBrc =ðŸ”µ</abbr></span>
<span class="386637157613053325" onmouseenter="enter('386637157613053325');" onmouseout="out('386637157613053325');" style="">  54                                                                     if (originalBrc != null) {           </span>
<span class="-7815041635819803257" onmouseenter="enter('-7815041635819803257');" onmouseout="out('-7815041635819803257');" style=""><abbr title="  55                                                                         previousSite = originalBrc.getNonPersistentSite();">  55                                                                         previousSite = originalBrc.getNonðŸ”µ</abbr></span>
<span class="-1817538935719022010" onmouseenter="enter('-1817538935719022010');" onmouseout="out('-1817538935719022010');" style=""><abbr title="  56                                                                         previousCatalog = originalBrc.getCurrentCatalog();">  56                                                                         previousCatalog = originalBrc.getðŸ”µ</abbr></span>
<span class="-6859502314315274901" onmouseenter="enter('-6859502314315274901');" onmouseout="out('-6859502314315274901');" style=""><abbr title="  57                                                                         previousProfile = originalBrc.getCurrentProfile();">  57                                                                         previousProfile = originalBrc.getðŸ”µ</abbr></span>
<span class="7174699852720058151" onmouseenter="enter('7174699852720058151');" onmouseout="out('7174699852720058151');" style=""><abbr title="  58                                                                         previousIsIgnoringSite = originalBrc.getIgnoreSite();">  58                                                                         previousIsIgnoringSite = originalðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  59                                                                     }                                    </span>
<span  style="">  60                                                                                                          </span>
<span class="2981698039391216134" onmouseenter="enter('2981698039391216134');" onmouseout="out('2981698039391216134');" style=""><abbr title="  61                                                                     boolean isNew = initRequestContext(site, profile, catalog);">  61                                                                     boolean isNew = initRequestContext(siðŸ”µ</abbr></span>
<span  style="">  62                                                                                                          </span>
<span  style="">  63                                                                                                          </span>
<span class="-6681681893462133916" onmouseenter="enter('-6681681893462133916');" onmouseout="out('-6681681893462133916');" style="">  64 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT                                                                                             </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  65                                                                     TransactionContainer container = null;">  65                                                                     TransactionContainer container = nullðŸ”µ</abbr></span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  66                                                                     if (transactionManager != null) {    </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title="  67                                                                         container = establishTransaction(transactionManager);">  67                                                                         container = establishTransaction(ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  68                                                                     }                                    </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  69                                                                                                          </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  70                                                                     boolean isError = false;             </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  71                                                                                                          </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style="">  72 ||||||| BASE                                                                                             </span>
<span class="-3639349873877828882" onmouseenter="enter('-3639349873877828882');" onmouseout="out('-3639349873877828882');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  73 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">  73 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  74 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75                                                                                                          </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76                                                                                                          </span>
<span class="-1814092468913316143" onmouseenter="enter('-1814092468913316143');" onmouseout="out('-1814092468913316143');" style="">  77 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT                                                                                            </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  78                                                                     try {                                </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="">  79                                                                         activateSession();               </span>
<span  style="">  80                                                                                                          </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="">  81                                                                         if (transactionManager != null) {</span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style=""><abbr title="  82                                                                             container = establishTransaction(transactionManager);">  82                                                                             container = establishTransactðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  83                                                                         }                                </span>
<span  style="">  84                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  85                                                                         try {                            </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style="">  86                                                                             return operation.execute();  </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style="">  87                                                                         } catch (RuntimeException e) {   </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style="">  88                                                                             isError = true;              </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style="">  89                                                                             throw e;                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  90                                                                         }                                </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style="">  91                                                                     } finally {                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  92                                                                         try {                            </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style="">  93                                                                             if (container != null) {     </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style=""><abbr title="  94                                                                                 finalizeTransaction(transactionManager, container, isError);">  94                                                                                 finalizeTransaction(transðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  95                                                                             }                            </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style="">  96                                                                         } finally {                      </span>
<span class="-866580000084113477" onmouseenter="enter('-866580000084113477');" onmouseout="out('-866580000084113477');" style=""><abbr title="  97                                                                             IdentityUtilContext.setUtilContext(null);">  97                                                                             IdentityUtilContext.setUtilCoðŸ”µ</abbr></span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style="">  98                                                                             if (isNew) {                 </span>
<span class="8043600097329985222" onmouseenter="enter('8043600097329985222');" onmouseout="out('8043600097329985222');" style=""><abbr title="  99                                                                                 BroadleafRequestContext.setBroadleafRequestContext(null);">  99                                                                                 BroadleafRequestContext.sðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 100                                                                             } else {                     </span>
<span class="-5663523450271762170" onmouseenter="enter('-5663523450271762170');" onmouseout="out('-5663523450271762170');" style=""><abbr title=" 101                                                                                 BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);"> 101                                                                                 BroadleafRequestContext.gðŸ”µ</abbr></span>
<span class="-519937983444515271" onmouseenter="enter('-519937983444515271');" onmouseout="out('-519937983444515271');" style=""><abbr title=" 102                                                                                 BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);"> 102                                                                                 BroadleafRequestContext.gðŸ”µ</abbr></span>
<span class="-1622484655952997173" onmouseenter="enter('-1622484655952997173');" onmouseout="out('-1622484655952997173');" style=""><abbr title=" 103                                                                                 BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);"> 103                                                                                 BroadleafRequestContext.gðŸ”µ</abbr></span>
<span class="5071379482955896849" onmouseenter="enter('5071379482955896849');" onmouseout="out('5071379482955896849');" style=""><abbr title=" 104                                                                                 BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);"> 104                                                                                 BroadleafRequestContext.gðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 105                                                                             }                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 106                                                                         }                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 107                                                                     }                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 108                                                                 }                                        </span>
<span  style=""> 109                                                                                                          </span>
<span class="-485315311381460363" onmouseenter="enter('-485315311381460363');" onmouseout="out('-485315311381460363');" style=""><abbr title=" 110     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Catalog catalog) throws G {"> 110     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="-2149174260692711216" onmouseenter="enter('-2149174260692711216');" onmouseout="out('-2149174260692711216');" style=""> 111         return runOperationByIdentifier(operation, site, null, catalog, null);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 112     }                                                                                                    </span>
<span  style=""> 113                                                                                                          </span>
<span class="-3389004741801466008" onmouseenter="enter('-3389004741801466008');" onmouseout="out('-3389004741801466008');" style=""><abbr title=" 114     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog) throws G {"> 114     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="-4482989458560555755" onmouseenter="enter('-4482989458560555755');" onmouseout="out('-4482989458560555755');" style=""> 115         return runOperationByIdentifier(operation, site, profile, catalog, null);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 116     }                                                                                                    </span>
<span  style=""> 117                                                                                                          </span>
<span class="-8143870051657701621" onmouseenter="enter('-8143870051657701621');" onmouseout="out('-8143870051657701621');" style=""><abbr title=" 118     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site) throws G {"> 118     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="-3215157294418599548" onmouseenter="enter('-3215157294418599548');" onmouseout="out('-3215157294418599548');" style=""> 119         return runOperationByIdentifier(operation, site, null, null, null);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120     }                                                                                                    </span>
<span  style=""> 121                                                                                                          </span>
<span class="-2275937291032103964" onmouseenter="enter('-2275937291032103964');" onmouseout="out('-2275937291032103964');" style=""><abbr title=" 122     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile) throws G {"> 122     public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, ðŸ”µ</abbr></span>
<span class="8388199613493551564" onmouseenter="enter('8388199613493551564');" onmouseout="out('8388199613493551564');" style=""> 123         return runOperationByIdentifier(operation, site, profile, null);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 124     }                                                                                                    </span>
<span  style=""> 125                                                                                                          </span>
<span class="6819324175888184161" onmouseenter="enter('6819324175888184161');" onmouseout="out('6819324175888184161');" style=""><abbr title=" 126     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) throws G {"> 126     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operðŸ”µ</abbr></span>
<span class="-4246408630280487290" onmouseenter="enter('-4246408630280487290');" onmouseout="out('-4246408630280487290');" style=""> 127         return runOperationAndIgnoreIdentifier(operation, null);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 128     }                                                                                                    </span>
<span  style=""> 129                                                                                                          </span>
<span class="-2017674323678293657" onmouseenter="enter('-2017674323678293657');" onmouseout="out('-2017674323678293657');" style=""><abbr title=" 130     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation, PlatformTransactionManager transactionManager) throws G {"> 130     public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operðŸ”µ</abbr></span>
<span class="-5567505797438091464" onmouseenter="enter('-5567505797438091464');" onmouseout="out('-5567505797438091464');" style=""> 131         //Set up pre-existing state...                                                                   </span>
<span class="1874085528725214811" onmouseenter="enter('1874085528725214811');" onmouseout="out('1874085528725214811');" style=""> 132         BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext(false);         </span>
<span class="5982941254864048436" onmouseenter="enter('5982941254864048436');" onmouseout="out('5982941254864048436');" style=""> 133         Site previousSite = null;                                                                        </span>
<span class="-1736636036474983614" onmouseenter="enter('-1736636036474983614');" onmouseout="out('-1736636036474983614');" style=""> 134         Catalog previousCatalog = null;                                                                  </span>
<span class="6146465993479879827" onmouseenter="enter('6146465993479879827');" onmouseout="out('6146465993479879827');" style=""> 135         Site previousProfile = null;                                                                     </span>
<span class="-3038915738898370631" onmouseenter="enter('-3038915738898370631');" onmouseout="out('-3038915738898370631');" style=""> 136         Boolean previousIsIgnoringSite = false;                                                          </span>
<span  style=""> 137                                                                                                          </span>
<span class="-6681681893462133916" onmouseenter="enter('-6681681893462133916');" onmouseout="out('-6681681893462133916');" style=""> 138 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT                                                                                             </span>
<span class="7425048344239509528" onmouseenter="enter('7425048344239509528');" onmouseout="out('7425048344239509528');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139         BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);                        </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 140 ||||||| BASE                                                                                             </span>
<span class="-3639349873877828882" onmouseenter="enter('-3639349873877828882');" onmouseout="out('-3639349873877828882');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 141 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 141 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 142 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143                                                                                                          </span>
<span class="-1943348167742156849" onmouseenter="enter('-1943348167742156849');" onmouseout="out('-1943348167742156849');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144         boolean isNew = initRequestContext(null, null, null);                                            </span>
<span class="-3564107913275418963" onmouseenter="enter('-3564107913275418963');" onmouseout="out('-3564107913275418963');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145         boolean isIgnoringSite = BroadleafRequestContext.getBroadleafRequestContext().getIgnoreSite();   </span>
<span class="7425048344239509528" onmouseenter="enter('7425048344239509528');" onmouseout="out('7425048344239509528');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146         BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);                        </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147                                                                                                          </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148         activateSession();                                                                               </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149                                                                                                          </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150         TransactionContainer container = null;                                                           </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151         if (transactionManager != null) {                                                                </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152             container = establishTransaction(transactionManager);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153         }                                                                                                </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154         boolean isError = false;                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155         try {                                                                                            </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156             return operation.execute();                                                                  </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157         } catch (RuntimeException e) {                                                                   </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158             isError = true;                                                                              </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159             throw e;                                                                                     </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160         } finally {                                                                                      </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161             if (container != null) {                                                                     </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162                 finalizeTransaction(transactionManager, container, isError);                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163             }                                                                                            </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164                                                                                                          </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165                                                                                                          </span>
<span class="-1814092468913316143" onmouseenter="enter('-1814092468913316143');" onmouseout="out('-1814092468913316143');" style=""> 166 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT                                                                                            </span>
<span  style=""> 167                                                                                                          </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style=""> 168         TransactionContainer container = null;                                                           </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style=""> 169         boolean isError = false;                                                                         </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 170         try {                                                                                            </span>
<span class="7425048344239509528" onmouseenter="enter('7425048344239509528');" onmouseout="out('7425048344239509528');" style=""> 171             BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);                    </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style=""> 172             activateSession();                                                                           </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style=""> 173             if (transactionManager != null) {                                                            </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style=""> 174                 container = establishTransaction(transactionManager);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 175             }                                                                                            </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style=""> 176             return operation.execute();                                                                  </span>
<span class="5702813929982664684" onmouseenter="enter('5702813929982664684');" onmouseout="out('5702813929982664684');" style=""> 177         } catch (java.lang.RuntimeException e) {                                                         </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style=""> 178             isError = true;                                                                              </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 179             throw e;                                                                                     </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 180         } finally {                                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 181             try {                                                                                        </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style=""> 182                 if (container != null) {                                                                 </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style=""> 183                     finalizeTransaction(transactionManager, container, isError);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184                 }                                                                                        </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 185             } finally {                                                                                  </span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style=""> 186                 if (isNew) {                                                                             </span>
<span class="6183760171671125539" onmouseenter="enter('6183760171671125539');" onmouseout="out('6183760171671125539');" style=""> 187                     //We just created this, so don&#x27;t leave it lying around.                              </span>
<span class="8043600097329985222" onmouseenter="enter('8043600097329985222');" onmouseout="out('8043600097329985222');" style=""> 188                     BroadleafRequestContext.setBroadleafRequestContext(null);                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 189                 } else {                                                                                 </span>
<span class="-3608180821406181105" onmouseenter="enter('-3608180821406181105');" onmouseout="out('-3608180821406181105');" style=""> 190                     //Otherwise, reset pre-existing state.                                               </span>
<span class="-5663523450271762170" onmouseenter="enter('-5663523450271762170');" onmouseout="out('-5663523450271762170');" style=""><abbr title=" 191                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);"> 191                     BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringðŸ”µ</abbr></span>
<span class="-519937983444515271" onmouseenter="enter('-519937983444515271');" onmouseout="out('-519937983444515271');" style=""><abbr title=" 192                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);"> 192                     BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSitðŸ”µ</abbr></span>
<span class="-1622484655952997173" onmouseenter="enter('-1622484655952997173');" onmouseout="out('-1622484655952997173');" style=""><abbr title=" 193                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);"> 193                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCataloðŸ”µ</abbr></span>
<span class="5071379482955896849" onmouseenter="enter('5071379482955896849');" onmouseout="out('5071379482955896849');" style=""><abbr title=" 194                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);"> 194                     BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfilðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 195                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 196             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 197         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198     }                                                                                                    </span>
<span  style=""> 199                                                                                                          </span>
<span class="-7595713675186321428" onmouseenter="enter('-7595713675186321428');" onmouseout="out('-7595713675186321428');" style=""> 200     private static boolean initRequestContext(Site site, Site profile, Catalog catalog) {                </span>
<span class="-2081663176034123456" onmouseenter="enter('-2081663176034123456');" onmouseout="out('-2081663176034123456');" style=""> 201         boolean isNew = false;                                                                           </span>
<span class="1959723908368963258" onmouseenter="enter('1959723908368963258');" onmouseout="out('1959723908368963258');" style=""><abbr title=" 202         BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(false);"> 202         BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(falseðŸ”µ</abbr></span>
<span class="-5701496640250763224" onmouseenter="enter('-5701496640250763224');" onmouseout="out('-5701496640250763224');" style=""> 203         if (requestContext == null) {                                                                    </span>
<span class="7779864663200542762" onmouseenter="enter('7779864663200542762');" onmouseout="out('7779864663200542762');" style=""> 204             requestContext = new BroadleafRequestContext();                                              </span>
<span class="2698271589848593965" onmouseenter="enter('2698271589848593965');" onmouseout="out('2698271589848593965');" style=""> 205             BroadleafRequestContext.setBroadleafRequestContext(requestContext);                          </span>
<span class="8240120666987537487" onmouseenter="enter('8240120666987537487');" onmouseout="out('8240120666987537487');" style=""> 206             isNew = true;                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 207         }                                                                                                </span>
<span class="-8845229620035771295" onmouseenter="enter('-8845229620035771295');" onmouseout="out('-8845229620035771295');" style=""> 208         requestContext.setNonPersistentSite(site);                                                       </span>
<span class="-596833746214779570" onmouseenter="enter('-596833746214779570');" onmouseout="out('-596833746214779570');" style=""> 209         requestContext.setCurrentCatalog(catalog);                                                       </span>
<span class="8511565119954978446" onmouseenter="enter('8511565119954978446');" onmouseout="out('8511565119954978446');" style=""> 210         requestContext.setCurrentProfile(profile);                                                       </span>
<span class="-2695749731081795645" onmouseenter="enter('-2695749731081795645');" onmouseout="out('-2695749731081795645');" style=""> 211         if (site != null) {                                                                              </span>
<span class="-5430658613312263263" onmouseenter="enter('-5430658613312263263');" onmouseout="out('-5430658613312263263');" style=""> 212             requestContext.setIgnoreSite(false);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 213         }                                                                                                </span>
<span class="-825861712451607908" onmouseenter="enter('-825861712451607908');" onmouseout="out('-825861712451607908');" style=""> 214         return isNew;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 215     }                                                                                                    </span>
<span  style=""> 216                                                                                                          </span>
<span class="-2258466500087063678" onmouseenter="enter('-2258466500087063678');" onmouseout="out('-2258466500087063678');" style=""><abbr title=" 217     private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionContainer"> 217     private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionConðŸ”µ</abbr></span>
<span class="-2034814968288808691" onmouseenter="enter('-2034814968288808691');" onmouseout="out('-2034814968288808691');" style=""> 218             container, boolean error) {                                                                  </span>
<span class="-766120542822293312" onmouseenter="enter('-766120542822293312');" onmouseout="out('-766120542822293312');" style=""> 219         TransactionUtils.finalizeTransaction(container.status, transactionManager, error);               </span>
<span class="8979610216143330423" onmouseenter="enter('8979610216143330423');" onmouseout="out('8979610216143330423');" style=""> 220         for (Map.Entry&lt;Object, Object&gt; entry : container.usedResources.entrySet()) {                     </span>
<span class="-2519888297476662498" onmouseenter="enter('-2519888297476662498');" onmouseout="out('-2519888297476662498');" style=""> 221             if (!TransactionSynchronizationManager.hasResource(entry.getKey())) {                        </span>
<span class="2316092200318402466" onmouseenter="enter('2316092200318402466');" onmouseout="out('2316092200318402466');" style=""> 222                 TransactionSynchronizationManager.bindResource(entry.getKey(), entry.getValue());        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 223             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 224         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 225     }                                                                                                    </span>
<span  style=""> 226                                                                                                          </span>
<span class="-8414791524342294371" onmouseenter="enter('-8414791524342294371');" onmouseout="out('-8414791524342294371');" style=""><abbr title=" 227     private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManager) {"> 227     private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManageðŸ”µ</abbr></span>
<span class="-8282331564281702139" onmouseenter="enter('-8282331564281702139');" onmouseout="out('-8282331564281702139');" style=""> 228         Map&lt;Object, Object&gt; usedResources = new HashMap&lt;Object, Object&gt;();                               </span>
<span class="810797588728929745" onmouseenter="enter('810797588728929745');" onmouseout="out('810797588728929745');" style=""> 229         Map&lt;Object, Object&gt; resources = TransactionSynchronizationManager.getResourceMap();              </span>
<span class="-3185760663221336664" onmouseenter="enter('-3185760663221336664');" onmouseout="out('-3185760663221336664');" style=""> 230         for (Map.Entry&lt;Object, Object&gt; entry : resources.entrySet()) {                                   </span>
<span class="393811491900493678" onmouseenter="enter('393811491900493678');" onmouseout="out('393811491900493678');" style=""><abbr title=" 231             if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource) &amp;&amp;"> 231             if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource)ðŸ”µ</abbr></span>
<span class="-3808176742636074825" onmouseenter="enter('-3808176742636074825');" onmouseout="out('-3808176742636074825');" style=""> 232                     TransactionSynchronizationManager.hasResource(entry.getKey())) {                     </span>
<span class="-6602288961953579852" onmouseenter="enter('-6602288961953579852');" onmouseout="out('-6602288961953579852');" style=""> 233                 usedResources.put(entry.getKey(), entry.getValue());                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 235         }                                                                                                </span>
<span class="-9108483853738564605" onmouseenter="enter('-9108483853738564605');" onmouseout="out('-9108483853738564605');" style=""> 236         for (Map.Entry&lt;Object, Object&gt; entry : usedResources.entrySet()) {                               </span>
<span class="574188550403203073" onmouseenter="enter('574188550403203073');" onmouseout="out('574188550403203073');" style=""> 237             TransactionSynchronizationManager.unbindResource(entry.getKey());                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238         }                                                                                                </span>
<span  style=""> 239                                                                                                          </span>
<span class="-2686947146472656670" onmouseenter="enter('-2686947146472656670');" onmouseout="out('-2686947146472656670');" style=""> 240         TransactionStatus status;                                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 241         try {                                                                                            </span>
<span class="-7651374686191088801" onmouseenter="enter('-7651374686191088801');" onmouseout="out('-7651374686191088801');" style=""> 242             status = TransactionUtils.createTransaction(TransactionDefinition.PROPAGATION_REQUIRES_NEW,  </span>
<span class="2995382785742484314" onmouseenter="enter('2995382785742484314');" onmouseout="out('2995382785742484314');" style=""> 243                     transactionManager, false);                                                          </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style=""> 244         } catch (RuntimeException e) {                                                                   </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 245             throw e;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 246         }                                                                                                </span>
<span class="-3836925212545710491" onmouseenter="enter('-3836925212545710491');" onmouseout="out('-3836925212545710491');" style=""> 247         return new TransactionContainer(status, usedResources);                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 248     }                                                                                                    </span>
<span  style=""> 249                                                                                                          </span>
<span class="-8049495641573146634" onmouseenter="enter('-8049495641573146634');" onmouseout="out('-8049495641573146634');" style=""> 250     private static class TransactionContainer {                                                          </span>
<span class="-2686947146472656670" onmouseenter="enter('-2686947146472656670');" onmouseout="out('-2686947146472656670');" style=""> 251         TransactionStatus status;                                                                        </span>
<span  style=""> 252                                                                                                          </span>
<span class="7376018894019906245" onmouseenter="enter('7376018894019906245');" onmouseout="out('7376018894019906245');" style=""> 253         Map&lt;Object, Object&gt; usedResources;                                                               </span>
<span  style=""> 254                                                                                                          </span>
<span class="1782715066093141529" onmouseenter="enter('1782715066093141529');" onmouseout="out('1782715066093141529');" style=""> 255         private TransactionContainer(TransactionStatus status, Map&lt;Object, Object&gt; usedResources) {      </span>
<span class="-5831567129597574107" onmouseenter="enter('-5831567129597574107');" onmouseout="out('-5831567129597574107');" style=""> 256             this.status = status;                                                                        </span>
<span class="-2556535949128531147" onmouseenter="enter('-2556535949128531147');" onmouseout="out('-2556535949128531147');" style=""> 257             this.usedResources = usedResources;                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 258         }                                                                                                </span>
<span  style=""> 259                                                                                                          </span>
<span class="1560481439222774158" onmouseenter="enter('1560481439222774158');" onmouseout="out('1560481439222774158');" style=""> 260         public TransactionStatus getStatus() {                                                           </span>
<span class="-8054900221824109356" onmouseenter="enter('-8054900221824109356');" onmouseout="out('-8054900221824109356');" style=""> 261             return status;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 262         }                                                                                                </span>
<span  style=""> 263                                                                                                          </span>
<span class="-505973652319309977" onmouseenter="enter('-505973652319309977');" onmouseout="out('-505973652319309977');" style=""> 264         public void setStatus(TransactionStatus status) {                                                </span>
<span class="-5831567129597574107" onmouseenter="enter('-5831567129597574107');" onmouseout="out('-5831567129597574107');" style=""> 265             this.status = status;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 266         }                                                                                                </span>
<span  style=""> 267                                                                                                          </span>
<span class="-2349550172450043036" onmouseenter="enter('-2349550172450043036');" onmouseout="out('-2349550172450043036');" style=""> 268         public Map&lt;Object, Object&gt; getUsedResources() {                                                  </span>
<span class="-7324790907786626209" onmouseenter="enter('-7324790907786626209');" onmouseout="out('-7324790907786626209');" style=""> 269             return usedResources;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 270         }                                                                                                </span>
<span  style=""> 271                                                                                                          </span>
<span class="9139736372877762091" onmouseenter="enter('9139736372877762091');" onmouseout="out('9139736372877762091');" style=""> 272         public void setUsedResources(Map&lt;Object, Object&gt; usedResources) {                                </span>
<span class="-2556535949128531147" onmouseenter="enter('-2556535949128531147');" onmouseout="out('-2556535949128531147');" style=""> 273             this.usedResources = usedResources;                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 274         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 275     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 276 }                                                                                                        </span>

























</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-4573490878212285276" onmouseenter="enter('-4573490878212285276');" onmouseout="out('-4573490878212285276');" style="">   3   * BroadleafCommerce Common Libraries                                                                             </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-512514810257161872" onmouseenter="enter('-512514810257161872');" onmouseout="out('-512514810257161872');" style="">  18  package org.broadleafcommerce.common.util.tenant;                                                                 </span>
<span  style="">  19                                                                                                                    </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="-4286566313930798693" onmouseenter="enter('-4286566313930798693');" onmouseout="out('-4286566313930798693');" style="">  22  import org.broadleafcommerce.common.site.domain.Catalog;                                                          </span>
<span class="3350833871385260454" onmouseenter="enter('3350833871385260454');" onmouseout="out('3350833871385260454');" style="">  23  import org.broadleafcommerce.common.site.domain.Site;                                                             </span>
<span class="5107697851223623564" onmouseenter="enter('5107697851223623564');" onmouseout="out('5107697851223623564');" style="">  24  import org.broadleafcommerce.common.util.TransactionUtils;                                                        </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  25  import org.broadleafcommerce.common.web.BroadleafRequestContext;                                                  </span>
<span class="-582519941885656893" onmouseenter="enter('-582519941885656893');" onmouseout="out('-582519941885656893');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  26 -import org.hibernate.ejb.HibernateEntityManager;                                                                  </span>
<span class="4965441576334617108" onmouseenter="enter('4965441576334617108');" onmouseout="out('4965441576334617108');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  27 -import org.springframework.orm.jpa.EntityManagerHolder;                                                           </span>
<span class="-740123120803947738" onmouseenter="enter('-740123120803947738');" onmouseout="out('-740123120803947738');" style="">  28  import org.springframework.transaction.PlatformTransactionManager;                                                </span>
<span class="-8923386680468181280" onmouseenter="enter('-8923386680468181280');" onmouseout="out('-8923386680468181280');" style="">  29  import org.springframework.transaction.TransactionDefinition;                                                     </span>
<span class="8980559080936335720" onmouseenter="enter('8980559080936335720');" onmouseout="out('8980559080936335720');" style="">  30  import org.springframework.transaction.TransactionStatus;                                                         </span>
<span class="-25494037965120322" onmouseenter="enter('-25494037965120322');" onmouseout="out('-25494037965120322');" style="">  31  import org.springframework.transaction.support.TransactionSynchronizationManager;                                 </span>
<span  style="">  32                                                                                                                    </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  33  import java.util.HashMap;                                                                                         </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  34  import java.util.Map;                                                                                             </span>
<span  style="">  35                                                                                                                    </span>
<span class="1791670663098173858" onmouseenter="enter('1791670663098173858');" onmouseout="out('1791670663098173858');" style="">  36  import javax.persistence.EntityManagerFactory;                                                                    </span>
<span class="-7201454294566819418" onmouseenter="enter('-7201454294566819418');" onmouseout="out('-7201454294566819418');" style="">  37  import javax.sql.DataSource;                                                                                      </span>
<span  style="">  38                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  39  /**                                                                                                               </span>
<span class="-5413269856564896844" onmouseenter="enter('-5413269856564896844');" onmouseout="out('-5413269856564896844');" style=""><abbr title="  40   * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and instead">  40   * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and inðŸ”µ</abbr></span>
<span class="-1334135248073305720" onmouseenter="enter('-1334135248073305720');" onmouseout="out('-1334135248073305720');" style="">  41   * explicitly run operations in the specified context.                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  42   *                                                                                                                </span>
<span class="-7311139588847938491" onmouseenter="enter('-7311139588847938491');" onmouseout="out('-7311139588847938491');" style="">  43   * @author Jeff Fischer                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  44   */                                                                                                               </span>
<span class="-1398877175080343843" onmouseenter="enter('-1398877175080343843');" onmouseout="out('-1398877175080343843');" style="">  45  public class IdentityExecutionUtils {                                                                             </span>
<span  style="">  46                                                                                                                    </span>
<span class="6362220773373469995" onmouseenter="enter('6362220773373469995');" onmouseout="out('6362220773373469995');" style="">  47      private static final Log LOG = LogFactory.getLog(IdentityExecutionUtils.class);                               </span>
<span  style="">  48                                                                                                                    </span>
<span class="-652529928056955706" onmouseenter="enter('-652529928056955706');" onmouseout="out('-652529928056955706');" style=""><abbr title="  49      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog,">  49      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="6167977986734295120" onmouseenter="enter('6167977986734295120');" onmouseout="out('6167977986734295120');" style=""><abbr title="  50                                                                PlatformTransactionManager transactionManager) throws G {">  50                                                                PlatformTransactionManager transactionManager) throwðŸ”µ</abbr></span>

<span class="-7770167299096999061" onmouseenter="enter('-7770167299096999061');" onmouseout="out('-7770167299096999061');" style="">  51          IdentityUtilContext context = new IdentityUtilContext();                                                  </span>
<span class="732355087831690145" onmouseenter="enter('732355087831690145');" onmouseout="out('732355087831690145');" style="">  52          context.setIdentifier(site);                                                                              </span>
<span class="3289280907674551762" onmouseenter="enter('3289280907674551762');" onmouseout="out('3289280907674551762');" style="">  53          IdentityUtilContext.setUtilContext(context);                                                              </span>
<span  style="">  54                                                                                                                    </span>
<span class="-8689839391291561327" onmouseenter="enter('-8689839391291561327');" onmouseout="out('-8689839391291561327');" style="">  55          BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();                       </span>
<span class="-6065207352220794681" onmouseenter="enter('-6065207352220794681');" onmouseout="out('-6065207352220794681');" style="">  56          Site previousSite = brc.getSite();                                                                        </span>
<span class="-2315761264854046842" onmouseenter="enter('-2315761264854046842');" onmouseout="out('-2315761264854046842');" style="">  57          Catalog previousCatalog = brc.getCurrentCatalog();                                                        </span>
<span class="36002691450064890" onmouseenter="enter('36002691450064890');" onmouseout="out('36002691450064890');" style="">  58          Site previousProfile = brc.getCurrentProfile();                                                           </span>














<span  style="">  59                                                                                                                    </span>
<span class="2981698039391216134" onmouseenter="enter('2981698039391216134');" onmouseout="out('2981698039391216134');" style="">  60          boolean isNew = initRequestContext(site, profile, catalog);                                               </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  61 -                                                                                                                  </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  62 -        activateSession();                                                                                        </span>






































































<span  style="">  63                                                                                                                    </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style="">  64          TransactionContainer container = null;                                                                    </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="">  65          if (transactionManager != null) {                                                                         </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style="">  66              container = establishTransaction(transactionManager);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  67          }                                                                                                         </span>
<span  style="">  68                                                                                                                    </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style="">  69          boolean isError = false;                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  70          try {                                                                                                     </span>







<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style="">  71              return operation.execute();                                                                           </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style="">  72          } catch (RuntimeException e) {                                                                            </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style="">  73              isError = true;                                                                                       </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style="">  74              throw e;                                                                                              </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style="">  75          } finally {                                                                                               </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style="">  76              if (container != null) {                                                                              </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style="">  77                  finalizeTransaction(transactionManager, container, isError);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  78              }                                                                                                     </span>
<span class="-866580000084113477" onmouseenter="enter('-866580000084113477');" onmouseout="out('-866580000084113477');" style="">  79              IdentityUtilContext.setUtilContext(null);                                                             </span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style="">  80              if (isNew) {                                                                                          </span>
<span class="8043600097329985222" onmouseenter="enter('8043600097329985222');" onmouseout="out('8043600097329985222');" style="">  81                  BroadleafRequestContext.setBroadleafRequestContext(null);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  82              }                                                                                                     </span>
<span class="8242911450769618252" onmouseenter="enter('8242911450769618252');" onmouseout="out('8242911450769618252');" style="">  83              BroadleafRequestContext.getBroadleafRequestContext().setSite(previousSite);                           </span>
<span class="-1622484655952997173" onmouseenter="enter('-1622484655952997173');" onmouseout="out('-1622484655952997173');" style="">  84              BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);              </span>
<span class="5071379482955896849" onmouseenter="enter('5071379482955896849');" onmouseout="out('5071379482955896849');" style="">  85              BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  86          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  87      }                                                                                                             </span>
<span  style="">  88                                                                                                                    </span>
<span class="-485315311381460363" onmouseenter="enter('-485315311381460363');" onmouseout="out('-485315311381460363');" style=""><abbr title="  89      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Catalog catalog) throws G {">  89      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="-2149174260692711216" onmouseenter="enter('-2149174260692711216');" onmouseout="out('-2149174260692711216');" style="">  90          return runOperationByIdentifier(operation, site, null, catalog, null);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  91      }                                                                                                             </span>
<span  style="">  92                                                                                                                    </span>
<span class="-3389004741801466008" onmouseenter="enter('-3389004741801466008');" onmouseout="out('-3389004741801466008');" style=""><abbr title="  93      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog) throws G {">  93      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="-4482989458560555755" onmouseenter="enter('-4482989458560555755');" onmouseout="out('-4482989458560555755');" style="">  94          return runOperationByIdentifier(operation, site, profile, catalog, null);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  95      }                                                                                                             </span>
<span  style="">  96                                                                                                                    </span>
<span class="-8143870051657701621" onmouseenter="enter('-8143870051657701621');" onmouseout="out('-8143870051657701621');" style=""><abbr title="  97      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site) throws G {">  97      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="-3215157294418599548" onmouseenter="enter('-3215157294418599548');" onmouseout="out('-3215157294418599548');" style="">  98          return runOperationByIdentifier(operation, site, null, null, null);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  99      }                                                                                                             </span>
<span  style=""> 100                                                                                                                    </span>
<span class="-2275937291032103964" onmouseenter="enter('-2275937291032103964');" onmouseout="out('-2275937291032103964');" style=""><abbr title=" 101      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile) throws G {"> 101      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="8388199613493551564" onmouseenter="enter('8388199613493551564');" onmouseout="out('8388199613493551564');" style=""> 102          return runOperationByIdentifier(operation, site, profile, null);                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 103      }                                                                                                             </span>
<span  style=""> 104                                                                                                                    </span>
<span class="6819324175888184161" onmouseenter="enter('6819324175888184161');" onmouseout="out('6819324175888184161');" style=""><abbr title=" 105      public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) throws G {"> 105      public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) thðŸ”µ</abbr></span>
<span class="-4246408630280487290" onmouseenter="enter('-4246408630280487290');" onmouseout="out('-4246408630280487290');" style=""> 106          return runOperationAndIgnoreIdentifier(operation, null);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 107      }                                                                                                             </span>
<span  style=""> 108                                                                                                                    </span>
<span class="-4518289252412213481" onmouseenter="enter('-4518289252412213481');" onmouseout="out('-4518289252412213481');" style=""> 109      public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation,   </span>
<span class="6167977986734295120" onmouseenter="enter('6167977986734295120');" onmouseout="out('6167977986734295120');" style=""> 110              PlatformTransactionManager transactionManager) throws G {                                             </span>
<span class="-8689839391291561327" onmouseenter="enter('-8689839391291561327');" onmouseout="out('-8689839391291561327');" style=""> 111          BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();                       </span>
<span class="-6065207352220794681" onmouseenter="enter('-6065207352220794681');" onmouseout="out('-6065207352220794681');" style=""> 112          Site previousSite = brc.getSite();                                                                        </span>
<span class="-2315761264854046842" onmouseenter="enter('-2315761264854046842');" onmouseout="out('-2315761264854046842');" style=""> 113          Catalog previousCatalog = brc.getCurrentCatalog();                                                        </span>
<span class="36002691450064890" onmouseenter="enter('36002691450064890');" onmouseout="out('36002691450064890');" style=""> 114          Site previousProfile = brc.getCurrentProfile();                                                           </span>
<span  style=""> 115                                                                                                                    </span>
<span class="-1943348167742156849" onmouseenter="enter('-1943348167742156849');" onmouseout="out('-1943348167742156849');" style=""> 116          boolean isNew = initRequestContext(null, null, null);                                                     </span>
<span class="-3564107913275418963" onmouseenter="enter('-3564107913275418963');" onmouseout="out('-3564107913275418963');" style=""> 117          boolean isIgnoringSite = BroadleafRequestContext.getBroadleafRequestContext().getIgnoreSite();            </span>
<span class="7425048344239509528" onmouseenter="enter('7425048344239509528');" onmouseout="out('7425048344239509528');" style=""> 118          BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);                                 </span>
<span  style=""> 119                                                                                                                    </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 120 -        activateSession();                                                                                        </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 121 -                                                                                                                  </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style=""> 122          TransactionContainer container = null;                                                                    </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style=""> 123          if (transactionManager != null) {                                                                         </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style=""> 124              container = establishTransaction(transactionManager);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 125          }                                                                                                         </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style=""> 126          boolean isError = false;                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 127          try {                                                                                                     </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style=""> 128              return operation.execute();                                                                           </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style=""> 129          } catch (RuntimeException e) {                                                                            </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style=""> 130              isError = true;                                                                                       </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 131              throw e;                                                                                              </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 132          } finally {                                                                                               </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style=""> 133              if (container != null) {                                                                              </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style=""> 134                  finalizeTransaction(transactionManager, container, isError);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 135              }                                                                                                     </span>
<span  style=""> 136                                                                                                                    </span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style=""> 137              if (isNew) {                                                                                          </span>
<span class="8043600097329985222" onmouseenter="enter('8043600097329985222');" onmouseout="out('8043600097329985222');" style=""> 138                  BroadleafRequestContext.setBroadleafRequestContext(null);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 139              }                                                                                                     </span>
<span class="8294068778351097889" onmouseenter="enter('8294068778351097889');" onmouseout="out('8294068778351097889');" style=""> 140              BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(isIgnoringSite);                   </span>
<span class="8242911450769618252" onmouseenter="enter('8242911450769618252');" onmouseout="out('8242911450769618252');" style=""> 141              BroadleafRequestContext.getBroadleafRequestContext().setSite(previousSite);                           </span>
<span class="-1622484655952997173" onmouseenter="enter('-1622484655952997173');" onmouseout="out('-1622484655952997173');" style=""> 142              BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);              </span>
<span class="5071379482955896849" onmouseenter="enter('5071379482955896849');" onmouseout="out('5071379482955896849');" style=""> 143              BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);              </span>
















<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 144          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145      }                                                                                                             </span>
<span  style=""> 146                                                                                                                    </span>
<span class="-7595713675186321428" onmouseenter="enter('-7595713675186321428');" onmouseout="out('-7595713675186321428');" style=""> 147      private static boolean initRequestContext(Site site, Site profile, Catalog catalog) {                         </span>
<span class="-2081663176034123456" onmouseenter="enter('-2081663176034123456');" onmouseout="out('-2081663176034123456');" style=""> 148          boolean isNew = false;                                                                                    </span>
<span class="5443711698127361328" onmouseenter="enter('5443711698127361328');" onmouseout="out('5443711698127361328');" style=""> 149          BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext();            </span>

<span  style=""> 150                                                                                                                    </span>
<span class="-5701496640250763224" onmouseenter="enter('-5701496640250763224');" onmouseout="out('-5701496640250763224');" style=""> 151          if (requestContext == null) {                                                                             </span>
<span class="7779864663200542762" onmouseenter="enter('7779864663200542762');" onmouseout="out('7779864663200542762');" style=""> 152              requestContext = new BroadleafRequestContext();                                                       </span>
<span class="2698271589848593965" onmouseenter="enter('2698271589848593965');" onmouseout="out('2698271589848593965');" style=""> 153              BroadleafRequestContext.setBroadleafRequestContext(requestContext);                                   </span>
<span class="8240120666987537487" onmouseenter="enter('8240120666987537487');" onmouseout="out('8240120666987537487');" style=""> 154              isNew = true;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 155          }                                                                                                         </span>
<span  style=""> 156                                                                                                                    </span>
<span class="-2895093609936300614" onmouseenter="enter('-2895093609936300614');" onmouseout="out('-2895093609936300614');" style=""> 157          requestContext.setSite(site);                                                                             </span>

<span class="-596833746214779570" onmouseenter="enter('-596833746214779570');" onmouseout="out('-596833746214779570');" style=""> 158          requestContext.setCurrentCatalog(catalog);                                                                </span>
<span class="8511565119954978446" onmouseenter="enter('8511565119954978446');" onmouseout="out('8511565119954978446');" style=""> 159          requestContext.setCurrentProfile(profile);                                                                </span>
<span  style=""> 160                                                                                                                    </span>
<span class="-2695749731081795645" onmouseenter="enter('-2695749731081795645');" onmouseout="out('-2695749731081795645');" style=""> 161          if (site != null) {                                                                                       </span>
<span class="-5430658613312263263" onmouseenter="enter('-5430658613312263263');" onmouseout="out('-5430658613312263263');" style=""> 162              requestContext.setIgnoreSite(false);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 163          }                                                                                                         </span>
<span  style=""> 164                                                                                                                    </span>
<span class="-825861712451607908" onmouseenter="enter('-825861712451607908');" onmouseout="out('-825861712451607908');" style=""> 165          return isNew;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 166      }                                                                                                             </span>
<span  style=""> 167                                                                                                                    </span>
<span class="2243456860191033243" onmouseenter="enter('2243456860191033243');" onmouseout="out('2243456860191033243');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 168 -    private static void activateSession() {                                                                       </span>
<span class="-4974190386186762214" onmouseenter="enter('-4974190386186762214');" onmouseout="out('-4974190386186762214');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 169 -        Map&lt;Object, Object&gt; resourceMap = TransactionSynchronizationManager.getResourceMap();                     </span>
<span class="5969116952081507387" onmouseenter="enter('5969116952081507387');" onmouseout="out('5969116952081507387');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 170 -        for (Map.Entry&lt;Object, Object&gt; entry : resourceMap.entrySet()) {                                          </span>
<span class="1907820485967051486" onmouseenter="enter('1907820485967051486');" onmouseout="out('1907820485967051486');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 171 -            if (entry.getKey() instanceof EntityManagerFactory &amp;&amp; entry.getValue() instanceof EntityManagerHolder) {"> 171 -            if (entry.getKey() instanceof EntityManagerFactory &amp;&amp; entry.getValue() instanceof EntityManagerHolder)ðŸ”µ</abbr></span>
<span class="-1683598494407488402" onmouseenter="enter('-1683598494407488402');" onmouseout="out('-1683598494407488402');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 172 -                ((HibernateEntityManager) ((EntityManagerHolder) entry.getValue()).getEntityManager()).getSession();"> 172 -                ((HibernateEntityManager) ((EntityManagerHolder) entry.getValue()).getEntityManager()).getSession(ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 173 -            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 174 -        }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 175 -    }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 176 -                                                                                                                  </span>
<span class="-2258466500087063678" onmouseenter="enter('-2258466500087063678');" onmouseout="out('-2258466500087063678');" style=""> 177      private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionContainer   </span>
<span class="-2034814968288808691" onmouseenter="enter('-2034814968288808691');" onmouseout="out('-2034814968288808691');" style=""> 178              container, boolean error) {                                                                           </span>
<span class="-766120542822293312" onmouseenter="enter('-766120542822293312');" onmouseout="out('-766120542822293312');" style=""> 179          TransactionUtils.finalizeTransaction(container.status, transactionManager, error);                        </span>
<span class="8979610216143330423" onmouseenter="enter('8979610216143330423');" onmouseout="out('8979610216143330423');" style=""> 180          for (Map.Entry&lt;Object, Object&gt; entry : container.usedResources.entrySet()) {                              </span>
<span class="-2519888297476662498" onmouseenter="enter('-2519888297476662498');" onmouseout="out('-2519888297476662498');" style=""> 181              if (!TransactionSynchronizationManager.hasResource(entry.getKey())) {                                 </span>
<span class="2316092200318402466" onmouseenter="enter('2316092200318402466');" onmouseout="out('2316092200318402466');" style=""> 182                  TransactionSynchronizationManager.bindResource(entry.getKey(), entry.getValue());                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 185      }                                                                                                             </span>
<span  style=""> 186                                                                                                                    </span>
<span class="-8414791524342294371" onmouseenter="enter('-8414791524342294371');" onmouseout="out('-8414791524342294371');" style=""> 187      private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManager) {     </span>
<span class="-8282331564281702139" onmouseenter="enter('-8282331564281702139');" onmouseout="out('-8282331564281702139');" style=""> 188          Map&lt;Object, Object&gt; usedResources = new HashMap&lt;Object, Object&gt;();                                        </span>
<span class="810797588728929745" onmouseenter="enter('810797588728929745');" onmouseout="out('810797588728929745');" style=""> 189          Map&lt;Object, Object&gt; resources = TransactionSynchronizationManager.getResourceMap();                       </span>
<span class="-3185760663221336664" onmouseenter="enter('-3185760663221336664');" onmouseout="out('-3185760663221336664');" style=""> 190          for (Map.Entry&lt;Object, Object&gt; entry : resources.entrySet()) {                                            </span>
<span class="393811491900493678" onmouseenter="enter('393811491900493678');" onmouseout="out('393811491900493678');" style=""> 191              if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource) &amp;&amp;      </span>
<span class="-3808176742636074825" onmouseenter="enter('-3808176742636074825');" onmouseout="out('-3808176742636074825');" style=""> 192                      TransactionSynchronizationManager.hasResource(entry.getKey())) {                              </span>
<span class="-6602288961953579852" onmouseenter="enter('-6602288961953579852');" onmouseout="out('-6602288961953579852');" style=""> 193                  usedResources.put(entry.getKey(), entry.getValue());                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 194              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 195          }                                                                                                         </span>
<span class="-9108483853738564605" onmouseenter="enter('-9108483853738564605');" onmouseout="out('-9108483853738564605');" style=""> 196          for (Map.Entry&lt;Object, Object&gt; entry : usedResources.entrySet()) {                                        </span>
<span class="574188550403203073" onmouseenter="enter('574188550403203073');" onmouseout="out('574188550403203073');" style=""> 197              TransactionSynchronizationManager.unbindResource(entry.getKey());                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198          }                                                                                                         </span>
<span  style=""> 199                                                                                                                    </span>
<span class="-2686947146472656670" onmouseenter="enter('-2686947146472656670');" onmouseout="out('-2686947146472656670');" style=""> 200          TransactionStatus status;                                                                                 </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 201          try {                                                                                                     </span>
<span class="-7651374686191088801" onmouseenter="enter('-7651374686191088801');" onmouseout="out('-7651374686191088801');" style=""> 202              status = TransactionUtils.createTransaction(TransactionDefinition.PROPAGATION_REQUIRES_NEW,           </span>
<span class="2995382785742484314" onmouseenter="enter('2995382785742484314');" onmouseout="out('2995382785742484314');" style=""> 203                      transactionManager, false);                                                                   </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style=""> 204          } catch (RuntimeException e) {                                                                            </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 205              throw e;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 206          }                                                                                                         </span>
<span class="-3836925212545710491" onmouseenter="enter('-3836925212545710491');" onmouseout="out('-3836925212545710491');" style=""> 207          return new TransactionContainer(status, usedResources);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 208      }                                                                                                             </span>
<span  style=""> 209                                                                                                                    </span>
<span class="-8049495641573146634" onmouseenter="enter('-8049495641573146634');" onmouseout="out('-8049495641573146634');" style=""> 210      private static class TransactionContainer {                                                                   </span>
<span class="-2686947146472656670" onmouseenter="enter('-2686947146472656670');" onmouseout="out('-2686947146472656670');" style=""> 211          TransactionStatus status;                                                                                 </span>
<span class="7376018894019906245" onmouseenter="enter('7376018894019906245');" onmouseout="out('7376018894019906245');" style=""> 212          Map&lt;Object, Object&gt; usedResources;                                                                        </span>
<span  style=""> 213                                                                                                                    </span>
<span class="1782715066093141529" onmouseenter="enter('1782715066093141529');" onmouseout="out('1782715066093141529');" style=""> 214          private TransactionContainer(TransactionStatus status, Map&lt;Object, Object&gt; usedResources) {               </span>
<span class="-5831567129597574107" onmouseenter="enter('-5831567129597574107');" onmouseout="out('-5831567129597574107');" style=""> 215              this.status = status;                                                                                 </span>
<span class="-2556535949128531147" onmouseenter="enter('-2556535949128531147');" onmouseout="out('-2556535949128531147');" style=""> 216              this.usedResources = usedResources;                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 217          }                                                                                                         </span>
<span  style=""> 218                                                                                                                    </span>
<span class="1560481439222774158" onmouseenter="enter('1560481439222774158');" onmouseout="out('1560481439222774158');" style=""> 219          public TransactionStatus getStatus() {                                                                    </span>
<span class="-8054900221824109356" onmouseenter="enter('-8054900221824109356');" onmouseout="out('-8054900221824109356');" style=""> 220              return status;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221          }                                                                                                         </span>
<span  style=""> 222                                                                                                                    </span>
<span class="-505973652319309977" onmouseenter="enter('-505973652319309977');" onmouseout="out('-505973652319309977');" style=""> 223          public void setStatus(TransactionStatus status) {                                                         </span>
<span class="-5831567129597574107" onmouseenter="enter('-5831567129597574107');" onmouseout="out('-5831567129597574107');" style=""> 224              this.status = status;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 225          }                                                                                                         </span>
<span  style=""> 226                                                                                                                    </span>
<span class="-2349550172450043036" onmouseenter="enter('-2349550172450043036');" onmouseout="out('-2349550172450043036');" style=""> 227          public Map&lt;Object, Object&gt; getUsedResources() {                                                           </span>
<span class="-7324790907786626209" onmouseenter="enter('-7324790907786626209');" onmouseout="out('-7324790907786626209');" style=""> 228              return usedResources;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 229          }                                                                                                         </span>
<span  style=""> 230                                                                                                                    </span>
<span class="9139736372877762091" onmouseenter="enter('9139736372877762091');" onmouseout="out('9139736372877762091');" style=""> 231          public void setUsedResources(Map&lt;Object, Object&gt; usedResources) {                                         </span>
<span class="-2556535949128531147" onmouseenter="enter('-2556535949128531147');" onmouseout="out('-2556535949128531147');" style=""> 232              this.usedResources = usedResources;                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 233          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 235  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-4573490878212285276" onmouseenter="enter('-4573490878212285276');" onmouseout="out('-4573490878212285276');" style="">   3   * BroadleafCommerce Common Libraries                                                                             </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-512514810257161872" onmouseenter="enter('-512514810257161872');" onmouseout="out('-512514810257161872');" style="">  18  package org.broadleafcommerce.common.util.tenant;                                                                 </span>
<span  style="">  19                                                                                                                    </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  20 -import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  21 -import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="-4286566313930798693" onmouseenter="enter('-4286566313930798693');" onmouseout="out('-4286566313930798693');" style="">  22  import org.broadleafcommerce.common.site.domain.Catalog;                                                          </span>
<span class="3350833871385260454" onmouseenter="enter('3350833871385260454');" onmouseout="out('3350833871385260454');" style="">  23  import org.broadleafcommerce.common.site.domain.Site;                                                             </span>
<span class="5107697851223623564" onmouseenter="enter('5107697851223623564');" onmouseout="out('5107697851223623564');" style="">  24  import org.broadleafcommerce.common.util.TransactionUtils;                                                        </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  25  import org.broadleafcommerce.common.web.BroadleafRequestContext;                                                  </span>
<span class="-582519941885656893" onmouseenter="enter('-582519941885656893');" onmouseout="out('-582519941885656893');" style="">  26  import org.hibernate.ejb.HibernateEntityManager;                                                                  </span>
<span class="4965441576334617108" onmouseenter="enter('4965441576334617108');" onmouseout="out('4965441576334617108');" style="">  27  import org.springframework.orm.jpa.EntityManagerHolder;                                                           </span>
<span class="-740123120803947738" onmouseenter="enter('-740123120803947738');" onmouseout="out('-740123120803947738');" style="">  28  import org.springframework.transaction.PlatformTransactionManager;                                                </span>
<span class="-8923386680468181280" onmouseenter="enter('-8923386680468181280');" onmouseout="out('-8923386680468181280');" style="">  29  import org.springframework.transaction.TransactionDefinition;                                                     </span>
<span class="8980559080936335720" onmouseenter="enter('8980559080936335720');" onmouseout="out('8980559080936335720');" style="">  30  import org.springframework.transaction.TransactionStatus;                                                         </span>
<span class="-25494037965120322" onmouseenter="enter('-25494037965120322');" onmouseout="out('-25494037965120322');" style="">  31  import org.springframework.transaction.support.TransactionSynchronizationManager;                                 </span>
<span  style="">  32                                                                                                                    </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  33  import java.util.HashMap;                                                                                         </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  34  import java.util.Map;                                                                                             </span>
<span  style="">  35                                                                                                                    </span>
<span class="1791670663098173858" onmouseenter="enter('1791670663098173858');" onmouseout="out('1791670663098173858');" style="">  36  import javax.persistence.EntityManagerFactory;                                                                    </span>
<span class="-7201454294566819418" onmouseenter="enter('-7201454294566819418');" onmouseout="out('-7201454294566819418');" style="">  37  import javax.sql.DataSource;                                                                                      </span>
<span  style="">  38                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  39  /**                                                                                                               </span>
<span class="-5413269856564896844" onmouseenter="enter('-5413269856564896844');" onmouseout="out('-5413269856564896844');" style=""><abbr title="  40   * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and instead">  40   * The utility methods in this class provide a way to ignore the currently configured site/catalog contexts and inðŸ”µ</abbr></span>
<span class="-1334135248073305720" onmouseenter="enter('-1334135248073305720');" onmouseout="out('-1334135248073305720');" style="">  41   * explicitly run operations in the specified context.                                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  42   *                                                                                                                </span>
<span class="-7311139588847938491" onmouseenter="enter('-7311139588847938491');" onmouseout="out('-7311139588847938491');" style="">  43   * @author Jeff Fischer                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  44   */                                                                                                               </span>
<span class="-1398877175080343843" onmouseenter="enter('-1398877175080343843');" onmouseout="out('-1398877175080343843');" style="">  45  public class IdentityExecutionUtils {                                                                             </span>
<span  style="">  46                                                                                                                    </span>
<span class="6362220773373469995" onmouseenter="enter('6362220773373469995');" onmouseout="out('6362220773373469995');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  47 -    private static final Log LOG = LogFactory.getLog(IdentityExecutionUtils.class);                               </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  48 -                                                                                                                  </span>
<span class="-652529928056955706" onmouseenter="enter('-652529928056955706');" onmouseout="out('-652529928056955706');" style=""><abbr title="  49      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog,">  49      public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="6167977986734295120" onmouseenter="enter('6167977986734295120');" onmouseout="out('6167977986734295120');" style=""><abbr title="  50                                                                PlatformTransactionManager transactionManager) throws G {">  50                                                                PlatformTransactionManager transactionManager) throwðŸ”µ</abbr></span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +                                                                                                                  </span>
<span class="-7770167299096999061" onmouseenter="enter('-7770167299096999061');" onmouseout="out('-7770167299096999061');" style="">  52          IdentityUtilContext context = new IdentityUtilContext();                                                  </span>
<span class="732355087831690145" onmouseenter="enter('732355087831690145');" onmouseout="out('732355087831690145');" style="">  53          context.setIdentifier(site);                                                                              </span>
<span class="3289280907674551762" onmouseenter="enter('3289280907674551762');" onmouseout="out('3289280907674551762');" style="">  54          IdentityUtilContext.setUtilContext(context);                                                              </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  55 -                                                                                                                  </span>
<span class="-8689839391291561327" onmouseenter="enter('-8689839391291561327');" onmouseout="out('-8689839391291561327');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  56 -        BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();                       </span>
<span class="-6065207352220794681" onmouseenter="enter('-6065207352220794681');" onmouseout="out('-6065207352220794681');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  57 -        Site previousSite = brc.getSite();                                                                        </span>
<span class="-2315761264854046842" onmouseenter="enter('-2315761264854046842');" onmouseout="out('-2315761264854046842');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  58 -        Catalog previousCatalog = brc.getCurrentCatalog();                                                        </span>
<span class="36002691450064890" onmouseenter="enter('36002691450064890');" onmouseout="out('36002691450064890');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  59 -        Site previousProfile = brc.getCurrentProfile();                                                           </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +        TransactionContainer container = null;                                                                    </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +        boolean isError = false;                                                                                  </span>
<span class="5982941254864048436" onmouseenter="enter('5982941254864048436');" onmouseout="out('5982941254864048436');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +        Site previousSite = null;                                                                                 </span>
<span class="-1736636036474983614" onmouseenter="enter('-1736636036474983614');" onmouseout="out('-1736636036474983614');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +        Catalog previousCatalog = null;                                                                           </span>
<span class="6146465993479879827" onmouseenter="enter('6146465993479879827');" onmouseout="out('6146465993479879827');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +        Site previousProfile = null;                                                                              </span>
<span class="-3038915738898370631" onmouseenter="enter('-3038915738898370631');" onmouseout="out('-3038915738898370631');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +        Boolean previousIsIgnoringSite = false;                                                                   </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +                                                                                                                  </span>
<span class="-7323698650211604384" onmouseenter="enter('-7323698650211604384');" onmouseout="out('-7323698650211604384');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +        BroadleafRequestContext originalBrc = BroadleafRequestContext.getBroadleafRequestContext(false);          </span>
<span class="386637157613053325" onmouseenter="enter('386637157613053325');" onmouseout="out('386637157613053325');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +        if (originalBrc != null) {                                                                                </span>
<span class="-7815041635819803257" onmouseenter="enter('-7815041635819803257');" onmouseout="out('-7815041635819803257');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +            previousSite = originalBrc.getNonPersistentSite();                                                    </span>
<span class="-1817538935719022010" onmouseenter="enter('-1817538935719022010');" onmouseout="out('-1817538935719022010');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +            previousCatalog = originalBrc.getCurrentCatalog();                                                    </span>
<span class="-6859502314315274901" onmouseenter="enter('-6859502314315274901');" onmouseout="out('-6859502314315274901');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +            previousProfile = originalBrc.getCurrentProfile();                                                    </span>
<span class="7174699852720058151" onmouseenter="enter('7174699852720058151');" onmouseout="out('7174699852720058151');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +            previousIsIgnoringSite = originalBrc.getIgnoreSite();                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +        }                                                                                                         </span>
<span  style="">  74                                                                                                                    </span>
<span class="2981698039391216134" onmouseenter="enter('2981698039391216134');" onmouseout="out('2981698039391216134');" style="">  75          boolean isNew = initRequestContext(site, profile, catalog);                                               </span>
<span  style="">  76                                                                                                                    </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  77 -        activateSession();                                                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  78 +        try {                                                                                                     </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  79 +            activateSession();                                                                                    </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +                                                                                                                  </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +            if (transactionManager != null) {                                                                     </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +                container = establishTransaction(transactionManager);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +            }                                                                                                     </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +                                                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +            try {                                                                                                 </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +                return operation.execute();                                                                       </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +            } catch (RuntimeException e) {                                                                        </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +                isError = true;                                                                                   </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +                throw e;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +            }                                                                                                     </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +        } finally {                                                                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +            try {                                                                                                 </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +                if (container != null) {                                                                          </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +                    finalizeTransaction(transactionManager, container, isError);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +                }                                                                                                 </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +            } finally {                                                                                           </span>
<span class="-866580000084113477" onmouseenter="enter('-866580000084113477');" onmouseout="out('-866580000084113477');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +                IdentityUtilContext.setUtilContext(null);                                                         </span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +                if (isNew) {                                                                                      </span>
<span class="8043600097329985222" onmouseenter="enter('8043600097329985222');" onmouseout="out('8043600097329985222');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +                    BroadleafRequestContext.setBroadleafRequestContext(null);                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +                } else {                                                                                          </span>
<span class="-5663523450271762170" onmouseenter="enter('-5663523450271762170');" onmouseout="out('-5663523450271762170');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +                    BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);   </span>
<span class="-519937983444515271" onmouseenter="enter('-519937983444515271');" onmouseout="out('-519937983444515271');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +                    BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);      </span>
<span class="-1622484655952997173" onmouseenter="enter('-1622484655952997173');" onmouseout="out('-1622484655952997173');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +                    BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);      </span>
<span class="5071379482955896849" onmouseenter="enter('5071379482955896849');" onmouseout="out('5071379482955896849');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +                    BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +                }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +        }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +                                                                                                                  </span>
<span class="-485315311381460363" onmouseenter="enter('-485315311381460363');" onmouseout="out('-485315311381460363');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 110 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Catalog catalog) throws G {"> 110 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="-2149174260692711216" onmouseenter="enter('-2149174260692711216');" onmouseout="out('-2149174260692711216');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +        return runOperationByIdentifier(operation, site, null, catalog, null);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +                                                                                                                  </span>
<span class="-3389004741801466008" onmouseenter="enter('-3389004741801466008');" onmouseout="out('-3389004741801466008');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 114 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog) throws G {"> 114 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="-4482989458560555755" onmouseenter="enter('-4482989458560555755');" onmouseout="out('-4482989458560555755');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +        return runOperationByIdentifier(operation, site, profile, catalog, null);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +                                                                                                                  </span>
<span class="-8143870051657701621" onmouseenter="enter('-8143870051657701621');" onmouseout="out('-8143870051657701621');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 118 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site) throws G {"> 118 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="-3215157294418599548" onmouseenter="enter('-3215157294418599548');" onmouseout="out('-3215157294418599548');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        return runOperationByIdentifier(operation, site, null, null, null);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +                                                                                                                  </span>
<span class="-2275937291032103964" onmouseenter="enter('-2275937291032103964');" onmouseout="out('-2275937291032103964');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 122 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile) throws G {"> 122 +    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="8388199613493551564" onmouseenter="enter('8388199613493551564');" onmouseout="out('8388199613493551564');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +        return runOperationByIdentifier(operation, site, profile, null);                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +                                                                                                                  </span>
<span class="6819324175888184161" onmouseenter="enter('6819324175888184161');" onmouseout="out('6819324175888184161');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 126 +    public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) throws G {"> 126 +    public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) thðŸ”µ</abbr></span>
<span class="-4246408630280487290" onmouseenter="enter('-4246408630280487290');" onmouseout="out('-4246408630280487290');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +        return runOperationAndIgnoreIdentifier(operation, null);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +                                                                                                                  </span>
<span class="-4518289252412213481" onmouseenter="enter('-4518289252412213481');" onmouseout="out('-4518289252412213481');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +    public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation,   </span>
<span class="6167977986734295120" onmouseenter="enter('6167977986734295120');" onmouseout="out('6167977986734295120');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +            PlatformTransactionManager transactionManager) throws G {                                             </span>
<span class="-5567505797438091464" onmouseenter="enter('-5567505797438091464');" onmouseout="out('-5567505797438091464');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +        //Set up pre-existing state...                                                                            </span>
<span class="1874085528725214811" onmouseenter="enter('1874085528725214811');" onmouseout="out('1874085528725214811');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +        BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext(false);                  </span>
<span class="5982941254864048436" onmouseenter="enter('5982941254864048436');" onmouseout="out('5982941254864048436');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +        Site previousSite = null;                                                                                 </span>
<span class="-1736636036474983614" onmouseenter="enter('-1736636036474983614');" onmouseout="out('-1736636036474983614');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +        Catalog previousCatalog = null;                                                                           </span>
<span class="6146465993479879827" onmouseenter="enter('6146465993479879827');" onmouseout="out('6146465993479879827');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +        Site previousProfile = null;                                                                              </span>
<span class="-3038915738898370631" onmouseenter="enter('-3038915738898370631');" onmouseout="out('-3038915738898370631');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +        Boolean previousIsIgnoringSite = false;                                                                   </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +                                                                                                                  </span>
<span class="-3197739461753066202" onmouseenter="enter('-3197739461753066202');" onmouseout="out('-3197739461753066202');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +        if (brc != null) {                                                                                        </span>
<span class="-8911406761612770367" onmouseenter="enter('-8911406761612770367');" onmouseout="out('-8911406761612770367');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +            previousSite = brc.getNonPersistentSite();                                                            </span>
<span class="-4648385020762162138" onmouseenter="enter('-4648385020762162138');" onmouseout="out('-4648385020762162138');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +            previousCatalog = brc.getCurrentCatalog();                                                            </span>
<span class="-117804761019864275" onmouseenter="enter('-117804761019864275');" onmouseout="out('-117804761019864275');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +            previousProfile = brc.getCurrentProfile();                                                            </span>
<span class="-4607913904778825019" onmouseenter="enter('-4607913904778825019');" onmouseout="out('-4607913904778825019');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +            previousIsIgnoringSite = brc.getIgnoreSite();                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +        }                                                                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                                                                                                                  </span>
<span class="139705847590485842" onmouseenter="enter('139705847590485842');" onmouseout="out('139705847590485842');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +        //Initialize new state...  This will guaratee that a BroadleafRequestContext is available to this thread. </span>
<span class="-1943348167742156849" onmouseenter="enter('-1943348167742156849');" onmouseout="out('-1943348167742156849');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +        boolean isNew = initRequestContext(null, null, null);                                                     </span>
<span  style=""> 148                                                                                                                    </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style=""> 149          TransactionContainer container = null;                                                                    </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 150 -        if (transactionManager != null) {                                                                         </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 151 -            container = establishTransaction(transactionManager);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 152 -        }                                                                                                         </span>
<span  style=""> 153                                                                                                                    </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style=""> 154          boolean isError = false;                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 155          try {                                                                                                     </span>
<span class="7425048344239509528" onmouseenter="enter('7425048344239509528');" onmouseout="out('7425048344239509528');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +            BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +                                                                                                                  </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +            activateSession();                                                                                    </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +            if (transactionManager != null) {                                                                     </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +                container = establishTransaction(transactionManager);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +            }                                                                                                     </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +                                                                                                                  </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style=""> 163              return operation.execute();                                                                           </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style=""> 164          } catch (RuntimeException e) {                                                                            </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style=""> 165              isError = true;                                                                                       </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 166              throw e;                                                                                              </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 167          } finally {                                                                                               </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 168 -            if (container != null) {                                                                              </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 169 -                finalizeTransaction(transactionManager, container, isError);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 170 -            }                                                                                                     </span>
<span class="-866580000084113477" onmouseenter="enter('-866580000084113477');" onmouseout="out('-866580000084113477');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 171 -            IdentityUtilContext.setUtilContext(null);                                                             </span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 172 -            if (isNew) {                                                                                          </span>
<span class="8043600097329985222" onmouseenter="enter('8043600097329985222');" onmouseout="out('8043600097329985222');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 173 -                BroadleafRequestContext.setBroadleafRequestContext(null);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 174 -            }                                                                                                     </span>
<span class="8242911450769618252" onmouseenter="enter('8242911450769618252');" onmouseout="out('8242911450769618252');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 175 -            BroadleafRequestContext.getBroadleafRequestContext().setSite(previousSite);                           </span>
<span class="-1622484655952997173" onmouseenter="enter('-1622484655952997173');" onmouseout="out('-1622484655952997173');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 176 -            BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);              </span>
<span class="5071379482955896849" onmouseenter="enter('5071379482955896849');" onmouseout="out('5071379482955896849');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 177 -            BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 178 -        }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 179 -    }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 180 -                                                                                                                  </span>
<span class="-485315311381460363" onmouseenter="enter('-485315311381460363');" onmouseout="out('-485315311381460363');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 181 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Catalog catalog) throws G {"> 181 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="-2149174260692711216" onmouseenter="enter('-2149174260692711216');" onmouseout="out('-2149174260692711216');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 182 -        return runOperationByIdentifier(operation, site, null, catalog, null);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 183 -    }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 184 -                                                                                                                  </span>
<span class="-3389004741801466008" onmouseenter="enter('-3389004741801466008');" onmouseout="out('-3389004741801466008');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 185 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile, Catalog catalog) throws G {"> 185 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="-4482989458560555755" onmouseenter="enter('-4482989458560555755');" onmouseout="out('-4482989458560555755');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 186 -        return runOperationByIdentifier(operation, site, profile, catalog, null);                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 187 -    }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 188 -                                                                                                                  </span>
<span class="-8143870051657701621" onmouseenter="enter('-8143870051657701621');" onmouseout="out('-8143870051657701621');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 189 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site) throws G {"> 189 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="-3215157294418599548" onmouseenter="enter('-3215157294418599548');" onmouseout="out('-3215157294418599548');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 190 -        return runOperationByIdentifier(operation, site, null, null, null);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 191 -    }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 192 -                                                                                                                  </span>
<span class="-2275937291032103964" onmouseenter="enter('-2275937291032103964');" onmouseout="out('-2275937291032103964');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 193 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site site, Site profile) throws G {"> 193 -    public static &lt;T, G extends Throwable&gt; T runOperationByIdentifier(IdentityOperation&lt;T, G&gt; operation, Site siteðŸ”µ</abbr></span>
<span class="8388199613493551564" onmouseenter="enter('8388199613493551564');" onmouseout="out('8388199613493551564');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 194 -        return runOperationByIdentifier(operation, site, profile, null);                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 195 -    }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 196 -                                                                                                                  </span>
<span class="6819324175888184161" onmouseenter="enter('6819324175888184161');" onmouseout="out('6819324175888184161');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"><abbr title=" 197 -    public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) throws G {"> 197 -    public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation) thðŸ”µ</abbr></span>
<span class="-4246408630280487290" onmouseenter="enter('-4246408630280487290');" onmouseout="out('-4246408630280487290');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 198 -        return runOperationAndIgnoreIdentifier(operation, null);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 199 -    }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 200 -                                                                                                                  </span>
<span class="-4518289252412213481" onmouseenter="enter('-4518289252412213481');" onmouseout="out('-4518289252412213481');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 201 -    public static &lt;T, G extends Throwable&gt; T runOperationAndIgnoreIdentifier(IdentityOperation&lt;T, G&gt; operation,   </span>
<span class="6167977986734295120" onmouseenter="enter('6167977986734295120');" onmouseout="out('6167977986734295120');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 202 -            PlatformTransactionManager transactionManager) throws G {                                             </span>
<span class="-8689839391291561327" onmouseenter="enter('-8689839391291561327');" onmouseout="out('-8689839391291561327');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 203 -        BroadleafRequestContext brc = BroadleafRequestContext.getBroadleafRequestContext();                       </span>
<span class="-6065207352220794681" onmouseenter="enter('-6065207352220794681');" onmouseout="out('-6065207352220794681');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 204 -        Site previousSite = brc.getSite();                                                                        </span>
<span class="-2315761264854046842" onmouseenter="enter('-2315761264854046842');" onmouseout="out('-2315761264854046842');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 205 -        Catalog previousCatalog = brc.getCurrentCatalog();                                                        </span>
<span class="36002691450064890" onmouseenter="enter('36002691450064890');" onmouseout="out('36002691450064890');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 206 -        Site previousProfile = brc.getCurrentProfile();                                                           </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 207 -                                                                                                                  </span>
<span class="-1943348167742156849" onmouseenter="enter('-1943348167742156849');" onmouseout="out('-1943348167742156849');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 208 -        boolean isNew = initRequestContext(null, null, null);                                                     </span>
<span class="-3564107913275418963" onmouseenter="enter('-3564107913275418963');" onmouseout="out('-3564107913275418963');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 209 -        boolean isIgnoringSite = BroadleafRequestContext.getBroadleafRequestContext().getIgnoreSite();            </span>
<span class="7425048344239509528" onmouseenter="enter('7425048344239509528');" onmouseout="out('7425048344239509528');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 210 -        BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(true);                                 </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 211 -                                                                                                                  </span>
<span class="1889756673308666901" onmouseenter="enter('1889756673308666901');" onmouseout="out('1889756673308666901');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 212 -        activateSession();                                                                                        </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 213 -                                                                                                                  </span>
<span class="-4597456551974696718" onmouseenter="enter('-4597456551974696718');" onmouseout="out('-4597456551974696718');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 214 -        TransactionContainer container = null;                                                                    </span>
<span class="8813333106928190082" onmouseenter="enter('8813333106928190082');" onmouseout="out('8813333106928190082');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 215 -        if (transactionManager != null) {                                                                         </span>
<span class="-6190247663659057361" onmouseenter="enter('-6190247663659057361');" onmouseout="out('-6190247663659057361');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 216 -            container = establishTransaction(transactionManager);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 217 -        }                                                                                                         </span>
<span class="449988326903539074" onmouseenter="enter('449988326903539074');" onmouseout="out('449988326903539074');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 218 -        boolean isError = false;                                                                                  </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 219 -        try {                                                                                                     </span>
<span class="8802780783732136948" onmouseenter="enter('8802780783732136948');" onmouseout="out('8802780783732136948');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 220 -            return operation.execute();                                                                           </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 221 -        } catch (RuntimeException e) {                                                                            </span>
<span class="1962661735303866574" onmouseenter="enter('1962661735303866574');" onmouseout="out('1962661735303866574');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 222 -            isError = true;                                                                                       </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 223 -            throw e;                                                                                              </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 224 -        } finally {                                                                                               </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 225 -            if (container != null) {                                                                              </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 226 -                finalizeTransaction(transactionManager, container, isError);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 227 -            }                                                                                                     </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 228 -                                                                                                                  </span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 229 -            if (isNew) {                                                                                          </span>
<span class="8043600097329985222" onmouseenter="enter('8043600097329985222');" onmouseout="out('8043600097329985222');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 230 -                BroadleafRequestContext.setBroadleafRequestContext(null);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 231 -            }                                                                                                     </span>
<span class="8294068778351097889" onmouseenter="enter('8294068778351097889');" onmouseout="out('8294068778351097889');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 232 -            BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(isIgnoringSite);                   </span>
<span class="8242911450769618252" onmouseenter="enter('8242911450769618252');" onmouseout="out('8242911450769618252');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 233 -            BroadleafRequestContext.getBroadleafRequestContext().setSite(previousSite);                           </span>
<span class="-1622484655952997173" onmouseenter="enter('-1622484655952997173');" onmouseout="out('-1622484655952997173');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 234 -            BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);              </span>
<span class="5071379482955896849" onmouseenter="enter('5071379482955896849');" onmouseout="out('5071379482955896849');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 235 -            BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);              </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +            try {                                                                                                 </span>
<span class="5397683965205639787" onmouseenter="enter('5397683965205639787');" onmouseout="out('5397683965205639787');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +                if (container != null) {                                                                          </span>
<span class="-5862875736788800223" onmouseenter="enter('-5862875736788800223');" onmouseout="out('-5862875736788800223');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +                    finalizeTransaction(transactionManager, container, isError);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +                }                                                                                                 </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +            } finally {                                                                                           </span>
<span class="7939562084642324717" onmouseenter="enter('7939562084642324717');" onmouseout="out('7939562084642324717');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +                if (isNew) {                                                                                      </span>
<span class="6183760171671125539" onmouseenter="enter('6183760171671125539');" onmouseout="out('6183760171671125539');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +                    //We just created this, so don&#x27;t leave it lying around.                                       </span>
<span class="8043600097329985222" onmouseenter="enter('8043600097329985222');" onmouseout="out('8043600097329985222');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +                    BroadleafRequestContext.setBroadleafRequestContext(null);                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +                } else {                                                                                          </span>
<span class="-3608180821406181105" onmouseenter="enter('-3608180821406181105');" onmouseout="out('-3608180821406181105');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +                    //Otherwise, reset pre-existing state.                                                        </span>
<span class="-5663523450271762170" onmouseenter="enter('-5663523450271762170');" onmouseout="out('-5663523450271762170');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +                    BroadleafRequestContext.getBroadleafRequestContext().setIgnoreSite(previousIsIgnoringSite);   </span>
<span class="-519937983444515271" onmouseenter="enter('-519937983444515271');" onmouseout="out('-519937983444515271');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +                    BroadleafRequestContext.getBroadleafRequestContext().setNonPersistentSite(previousSite);      </span>
<span class="-1622484655952997173" onmouseenter="enter('-1622484655952997173');" onmouseout="out('-1622484655952997173');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +                    BroadleafRequestContext.getBroadleafRequestContext().setCurrentCatalog(previousCatalog);      </span>
<span class="5071379482955896849" onmouseenter="enter('5071379482955896849');" onmouseout="out('5071379482955896849');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +                    BroadleafRequestContext.getBroadleafRequestContext().setCurrentProfile(previousProfile);      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +                }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 252          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 253      }                                                                                                             </span>
<span  style=""> 254                                                                                                                    </span>
<span class="-7595713675186321428" onmouseenter="enter('-7595713675186321428');" onmouseout="out('-7595713675186321428');" style=""> 255      private static boolean initRequestContext(Site site, Site profile, Catalog catalog) {                         </span>
<span class="-2081663176034123456" onmouseenter="enter('-2081663176034123456');" onmouseout="out('-2081663176034123456');" style=""> 256          boolean isNew = false;                                                                                    </span>
<span class="5443711698127361328" onmouseenter="enter('5443711698127361328');" onmouseout="out('5443711698127361328');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 257 -        BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext();            </span>
<span class="1959723908368963258" onmouseenter="enter('1959723908368963258');" onmouseout="out('1959723908368963258');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +        BroadleafRequestContext requestContext = BroadleafRequestContext.getBroadleafRequestContext(false);       </span>
<span  style=""> 259                                                                                                                    </span>
<span class="-5701496640250763224" onmouseenter="enter('-5701496640250763224');" onmouseout="out('-5701496640250763224');" style=""> 260          if (requestContext == null) {                                                                             </span>
<span class="7779864663200542762" onmouseenter="enter('7779864663200542762');" onmouseout="out('7779864663200542762');" style=""> 261              requestContext = new BroadleafRequestContext();                                                       </span>
<span class="2698271589848593965" onmouseenter="enter('2698271589848593965');" onmouseout="out('2698271589848593965');" style=""> 262              BroadleafRequestContext.setBroadleafRequestContext(requestContext);                                   </span>
<span class="8240120666987537487" onmouseenter="enter('8240120666987537487');" onmouseout="out('8240120666987537487');" style=""> 263              isNew = true;                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 264          }                                                                                                         </span>
<span  style=""> 265                                                                                                                    </span>
<span class="-2895093609936300614" onmouseenter="enter('-2895093609936300614');" onmouseout="out('-2895093609936300614');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 266 -        requestContext.setSite(site);                                                                             </span>
<span class="-8845229620035771295" onmouseenter="enter('-8845229620035771295');" onmouseout="out('-8845229620035771295');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +        requestContext.setNonPersistentSite(site);                                                                </span>
<span class="-596833746214779570" onmouseenter="enter('-596833746214779570');" onmouseout="out('-596833746214779570');" style=""> 268          requestContext.setCurrentCatalog(catalog);                                                                </span>
<span class="8511565119954978446" onmouseenter="enter('8511565119954978446');" onmouseout="out('8511565119954978446');" style=""> 269          requestContext.setCurrentProfile(profile);                                                                </span>
<span  style=""> 270                                                                                                                    </span>
<span class="-2695749731081795645" onmouseenter="enter('-2695749731081795645');" onmouseout="out('-2695749731081795645');" style=""> 271          if (site != null) {                                                                                       </span>
<span class="-5430658613312263263" onmouseenter="enter('-5430658613312263263');" onmouseout="out('-5430658613312263263');" style=""> 272              requestContext.setIgnoreSite(false);                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 273          }                                                                                                         </span>
<span  style=""> 274                                                                                                                    </span>
<span class="-825861712451607908" onmouseenter="enter('-825861712451607908');" onmouseout="out('-825861712451607908');" style=""> 275          return isNew;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 276      }                                                                                                             </span>
<span  style=""> 277                                                                                                                    </span>
<span class="2243456860191033243" onmouseenter="enter('2243456860191033243');" onmouseout="out('2243456860191033243');" style=""> 278      private static void activateSession() {                                                                       </span>
<span class="-4974190386186762214" onmouseenter="enter('-4974190386186762214');" onmouseout="out('-4974190386186762214');" style=""> 279          Map&lt;Object, Object&gt; resourceMap = TransactionSynchronizationManager.getResourceMap();                     </span>
<span class="5969116952081507387" onmouseenter="enter('5969116952081507387');" onmouseout="out('5969116952081507387');" style=""> 280          for (Map.Entry&lt;Object, Object&gt; entry : resourceMap.entrySet()) {                                          </span>
<span class="1907820485967051486" onmouseenter="enter('1907820485967051486');" onmouseout="out('1907820485967051486');" style=""><abbr title=" 281              if (entry.getKey() instanceof EntityManagerFactory &amp;&amp; entry.getValue() instanceof EntityManagerHolder) {"> 281              if (entry.getKey() instanceof EntityManagerFactory &amp;&amp; entry.getValue() instanceof EntityManagerHolder)ðŸ”µ</abbr></span>
<span class="-1683598494407488402" onmouseenter="enter('-1683598494407488402');" onmouseout="out('-1683598494407488402');" style=""><abbr title=" 282                  ((HibernateEntityManager) ((EntityManagerHolder) entry.getValue()).getEntityManager()).getSession();"> 282                  ((HibernateEntityManager) ((EntityManagerHolder) entry.getValue()).getEntityManager()).getSession(ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 283              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 284          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285      }                                                                                                             </span>
<span  style=""> 286                                                                                                                    </span>
<span class="-2258466500087063678" onmouseenter="enter('-2258466500087063678');" onmouseout="out('-2258466500087063678');" style=""> 287      private static void finalizeTransaction(PlatformTransactionManager transactionManager, TransactionContainer   </span>
<span class="-2034814968288808691" onmouseenter="enter('-2034814968288808691');" onmouseout="out('-2034814968288808691');" style=""> 288              container, boolean error) {                                                                           </span>
<span class="-766120542822293312" onmouseenter="enter('-766120542822293312');" onmouseout="out('-766120542822293312');" style=""> 289          TransactionUtils.finalizeTransaction(container.status, transactionManager, error);                        </span>
<span class="8979610216143330423" onmouseenter="enter('8979610216143330423');" onmouseout="out('8979610216143330423');" style=""> 290          for (Map.Entry&lt;Object, Object&gt; entry : container.usedResources.entrySet()) {                              </span>
<span class="-2519888297476662498" onmouseenter="enter('-2519888297476662498');" onmouseout="out('-2519888297476662498');" style=""> 291              if (!TransactionSynchronizationManager.hasResource(entry.getKey())) {                                 </span>
<span class="2316092200318402466" onmouseenter="enter('2316092200318402466');" onmouseout="out('2316092200318402466');" style=""> 292                  TransactionSynchronizationManager.bindResource(entry.getKey(), entry.getValue());                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 293              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 294          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 295      }                                                                                                             </span>
<span  style=""> 296                                                                                                                    </span>
<span class="-8414791524342294371" onmouseenter="enter('-8414791524342294371');" onmouseout="out('-8414791524342294371');" style=""> 297      private static TransactionContainer establishTransaction(PlatformTransactionManager transactionManager) {     </span>
<span class="-8282331564281702139" onmouseenter="enter('-8282331564281702139');" onmouseout="out('-8282331564281702139');" style=""> 298          Map&lt;Object, Object&gt; usedResources = new HashMap&lt;Object, Object&gt;();                                        </span>
<span class="810797588728929745" onmouseenter="enter('810797588728929745');" onmouseout="out('810797588728929745');" style=""> 299          Map&lt;Object, Object&gt; resources = TransactionSynchronizationManager.getResourceMap();                       </span>
<span class="-3185760663221336664" onmouseenter="enter('-3185760663221336664');" onmouseout="out('-3185760663221336664');" style=""> 300          for (Map.Entry&lt;Object, Object&gt; entry : resources.entrySet()) {                                            </span>
<span class="393811491900493678" onmouseenter="enter('393811491900493678');" onmouseout="out('393811491900493678');" style=""> 301              if ((entry.getKey() instanceof EntityManagerFactory  || entry.getKey() instanceof DataSource) &amp;&amp;      </span>
<span class="-3808176742636074825" onmouseenter="enter('-3808176742636074825');" onmouseout="out('-3808176742636074825');" style=""> 302                      TransactionSynchronizationManager.hasResource(entry.getKey())) {                              </span>
<span class="-6602288961953579852" onmouseenter="enter('-6602288961953579852');" onmouseout="out('-6602288961953579852');" style=""> 303                  usedResources.put(entry.getKey(), entry.getValue());                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 305          }                                                                                                         </span>
<span class="-9108483853738564605" onmouseenter="enter('-9108483853738564605');" onmouseout="out('-9108483853738564605');" style=""> 306          for (Map.Entry&lt;Object, Object&gt; entry : usedResources.entrySet()) {                                        </span>
<span class="574188550403203073" onmouseenter="enter('574188550403203073');" onmouseout="out('574188550403203073');" style=""> 307              TransactionSynchronizationManager.unbindResource(entry.getKey());                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 308          }                                                                                                         </span>
<span  style=""> 309                                                                                                                    </span>
<span class="-2686947146472656670" onmouseenter="enter('-2686947146472656670');" onmouseout="out('-2686947146472656670');" style=""> 310          TransactionStatus status;                                                                                 </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 311          try {                                                                                                     </span>
<span class="-7651374686191088801" onmouseenter="enter('-7651374686191088801');" onmouseout="out('-7651374686191088801');" style=""> 312              status = TransactionUtils.createTransaction(TransactionDefinition.PROPAGATION_REQUIRES_NEW,           </span>
<span class="2995382785742484314" onmouseenter="enter('2995382785742484314');" onmouseout="out('2995382785742484314');" style=""> 313                      transactionManager, false);                                                                   </span>
<span class="1200625667814236005" onmouseenter="enter('1200625667814236005');" onmouseout="out('1200625667814236005');" style=""> 314          } catch (RuntimeException e) {                                                                            </span>
<span class="-2532054300390783036" onmouseenter="enter('-2532054300390783036');" onmouseout="out('-2532054300390783036');" style=""> 315              throw e;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 316          }                                                                                                         </span>
<span class="-3836925212545710491" onmouseenter="enter('-3836925212545710491');" onmouseout="out('-3836925212545710491');" style=""> 317          return new TransactionContainer(status, usedResources);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 318      }                                                                                                             </span>
<span  style=""> 319                                                                                                                    </span>
<span class="-8049495641573146634" onmouseenter="enter('-8049495641573146634');" onmouseout="out('-8049495641573146634');" style=""> 320      private static class TransactionContainer {                                                                   </span>
<span class="-2686947146472656670" onmouseenter="enter('-2686947146472656670');" onmouseout="out('-2686947146472656670');" style=""> 321          TransactionStatus status;                                                                                 </span>
<span class="7376018894019906245" onmouseenter="enter('7376018894019906245');" onmouseout="out('7376018894019906245');" style=""> 322          Map&lt;Object, Object&gt; usedResources;                                                                        </span>
<span  style=""> 323                                                                                                                    </span>
<span class="1782715066093141529" onmouseenter="enter('1782715066093141529');" onmouseout="out('1782715066093141529');" style=""> 324          private TransactionContainer(TransactionStatus status, Map&lt;Object, Object&gt; usedResources) {               </span>
<span class="-5831567129597574107" onmouseenter="enter('-5831567129597574107');" onmouseout="out('-5831567129597574107');" style=""> 325              this.status = status;                                                                                 </span>
<span class="-2556535949128531147" onmouseenter="enter('-2556535949128531147');" onmouseout="out('-2556535949128531147');" style=""> 326              this.usedResources = usedResources;                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 327          }                                                                                                         </span>
<span  style=""> 328                                                                                                                    </span>
<span class="1560481439222774158" onmouseenter="enter('1560481439222774158');" onmouseout="out('1560481439222774158');" style=""> 329          public TransactionStatus getStatus() {                                                                    </span>
<span class="-8054900221824109356" onmouseenter="enter('-8054900221824109356');" onmouseout="out('-8054900221824109356');" style=""> 330              return status;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 331          }                                                                                                         </span>
<span  style=""> 332                                                                                                                    </span>
<span class="-505973652319309977" onmouseenter="enter('-505973652319309977');" onmouseout="out('-505973652319309977');" style=""> 333          public void setStatus(TransactionStatus status) {                                                         </span>
<span class="-5831567129597574107" onmouseenter="enter('-5831567129597574107');" onmouseout="out('-5831567129597574107');" style=""> 334              this.status = status;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 335          }                                                                                                         </span>
<span  style=""> 336                                                                                                                    </span>
<span class="-2349550172450043036" onmouseenter="enter('-2349550172450043036');" onmouseout="out('-2349550172450043036');" style=""> 337          public Map&lt;Object, Object&gt; getUsedResources() {                                                           </span>
<span class="-7324790907786626209" onmouseenter="enter('-7324790907786626209');" onmouseout="out('-7324790907786626209');" style=""> 338              return usedResources;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 339          }                                                                                                         </span>
<span  style=""> 340                                                                                                                    </span>
<span class="9139736372877762091" onmouseenter="enter('9139736372877762091');" onmouseout="out('9139736372877762091');" style=""> 341          public void setUsedResources(Map&lt;Object, Object&gt; usedResources) {                                         </span>
<span class="-2556535949128531147" onmouseenter="enter('-2556535949128531147');" onmouseout="out('-2556535949128531147');" style=""> 342              this.usedResources = usedResources;                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 343          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 344      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 345  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            