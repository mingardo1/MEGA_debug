<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>230</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    230
                    <a href="229.html">prev</a>
                    <a href="231.html">next</a>
                    <a href="230_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_c245f67751899f3d5af7879dfdf68c0ff9e8fa4b_Simplenote/src/main/java/com/automattic/simplenote/NoteListFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;c245f67751899f3d5af7879dfdf68c0ff9e8fa4b:Simplenote/src/main/java/com/automattic/simplenote/NoteListFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;c245f67751899f3d5af7879dfdf68c0ff9e8fa4b^1:Simplenote/src/main/java/com/automattic/simplenote/NoteListFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;c245f67751899f3d5af7879dfdf68c0ff9e8fa4b^2:Simplenote/src/main/java/com/automattic/simplenote/NoteListFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;83dc04246e28666b49f73f49ee5a38b8bf432329:Simplenote/src/main/java/com/automattic/simplenote/NoteListFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [sbj]], subset: [[b], [sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.ListFragment;
   5 import android.content.Context;
   6 import android.content.SharedPreferences;
   7 import android.database.Cursor;
   8 import android.database.sqlite.SQLiteException;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.preference.PreferenceManager;
  13 import android.text.Html;
  14 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  15 import android.text.SpannableString;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  16 import android.text.style.TextAppearanceSpan;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  17 import android.util.SparseBooleanArray;</span>
  18 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19 import android.util.SparseBooleanArray;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 import android.util.TypedValue;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 import android.view.ActionMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 import android.view.LayoutInflater;</span>
  23 =======
  24 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  25 import android.util.TypedValue;
  26 import android.view.LayoutInflater;
  27 import android.view.View;
  28 import android.view.ViewGroup;
  29 import android.widget.Button;
  30 import android.widget.CursorAdapter;
  31 import android.widget.ImageView;
  32 import android.widget.LinearLayout;
  33 import android.widget.ListView;
  34 import android.widget.TextView;
  35 import android.widget.ViewSwitcher;
  36 
  37 import com.automattic.simplenote.models.Note;
  38 import com.automattic.simplenote.utils.PrefUtils;
  39 import com.automattic.simplenote.utils.SearchSnippetFormatter;
  40 import com.automattic.simplenote.utils.SearchTokenizer;
  41 import com.automattic.simplenote.utils.TextHighlighter;
  42 import com.automattic.simplenote.utils.Typefaces;
  43 import com.simperium.client.Bucket;
  44 import com.simperium.client.Bucket.ObjectCursor;
  45 import com.simperium.client.Query;
  46 import com.simperium.client.Query.SortType;
  47 
  48 import java.util.Calendar;
  49 
  50 /**
  51  * A list fragment representing a list of Notes. This fragment also supports
  52  * tablet devices by allowing list items to be given an &#x27;activated&#x27; state upon
  53  * selection. This helps indicate which item is currently being viewed in a
  54  * {@link NoteEditorFragment}.
  55  * &lt;p&gt;
  56  * Activities containing this fragment MUST implement the {@link Callbacks}
  57  * interface.
  58  */
  59 public class NoteListFragment extends ListFragment {
  60 
  61 	private NotesCursorAdapter mNotesAdapter;
  62     private TextView mEmptyListTextView;
  63     private LinearLayout mDividerShadow;
  64 	private int mNumPreviewLines;
  65     private String mSearchString;
  66     private ViewSwitcher mWelcomeViewSwitcher;
  67     private String mSelectedNoteId;
  68 
  69 	/**
  70 	 * The preferences key representing the activated item position. Only used on tablets.
  71 	 */
  72 	private static final String STATE_ACTIVATED_POSITION = &quot;activated_position&quot;;
  73     private static final String TAG_BUTTON_SIGNIN = &quot;sign_in&quot;;
  74     private static final String TAG_BUTTON_SIGNUP = &quot;sign_up&quot;;
  75 
  76 	/**
  77 	 * The fragment&#x27;s current callback object, which is notified of list item
  78 	 * clicks.
  79 	 */
  80 	private Callbacks mCallbacks = sCallbacks;
  81 
  82 	/**
  83 	 * The current activated item position. Only used on tablets.
  84 	 */
  85 	private int mActivatedPosition = ListView.INVALID_POSITION;
  86 
  87     public void setEmptyListViewClickable(boolean isClickable) {
  88         if (mEmptyListTextView != null) {
  89             mEmptyListTextView.setClickable(isClickable);
  90         }
  91     }
  92 
  93     /**
  94 	 * A callback interface that all activities containing this fragment must
  95 	 * implement. This mechanism allows activities to be notified of item
  96 	 * selections.
  97 	 */
  98 	public interface Callbacks {
  99 		/**
 100 		 * Callback for when a note has been selected.
 101 		 */
 102 		public void onNoteSelected(String noteID, boolean isNew, String matchOffsets);
 103 	}
 104 
 105 	/**
 106 	 * A dummy implementation of the {@link Callbacks} interface that does
 107 	 * nothing. Used only when this fragment is not attached to an activity.
 108 	 */
 109 	private static Callbacks sCallbacks = new Callbacks() {
 110 		@Override
 111 		public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 112 		}
 113 	};
 114 
 115 	/**
 116 	 * Mandatory empty constructor for the fragment manager to instantiate the
 117 	 * fragment (e.g. upon screen orientation changes).
 118 	 */
 119 	public NoteListFragment() {
 120 	}
 121 
 122 	@Override
 123 	public void onCreate(Bundle savedInstanceState) {
 124 		super.onCreate(savedInstanceState);
 125 
 126 		Simplenote application = (Simplenote) getActivity().getApplication();
 127 
 128 		mNotesAdapter = new NotesCursorAdapter(getActivity().getBaseContext(), null, 0);
 129 		setListAdapter(mNotesAdapter);
 130 
 131 	}
 132 
 133     @Override
 134     public void onActivityCreated(Bundle savedInstanceState) {
 135         super.onActivityCreated(savedInstanceState);
 136 
 137     }
 138 
 139     // nbradbury - load values from preferences
 140 	protected void getPrefs() {
<abbr title=" 141         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, false);"> 141         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, falseðŸ”µ</abbr>
 142 		mNumPreviewLines = (condensedList) ? 0 : 2;
 143 	}
 144 
 145     @Override
 146     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)
 147     {
 148         View view = inflater.inflate(R.layout.notes_list, container, false);
 149         return view;
 150     }
 151 
 152 	@Override
 153 	public void onViewCreated(View view, Bundle savedInstanceState) {
 154 		super.onViewCreated(view, savedInstanceState);
 155 
 156         NotesActivity notesActivity = (NotesActivity)getActivity();
 157 
 158         LinearLayout emptyView = (LinearLayout)view.findViewById(android.R.id.empty);
 159         emptyView.setVisibility(View.GONE);
 160         mEmptyListTextView = (TextView)view.findViewById(R.id.empty_message);
 161         mEmptyListTextView.setOnClickListener(new View.OnClickListener() {
 162             @Override
 163             public void onClick(View v) {
 164                 addNote();
 165             }
 166         });
<abbr title=" 167         setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 167         setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.fðŸ”µ</abbr>
 168         mDividerShadow = (LinearLayout)view.findViewById(R.id.divider_shadow);
 169         mWelcomeViewSwitcher = (ViewSwitcher)view.findViewById(R.id.welcome_view_switcher);
 170 
 171         TextView welcomeTextView = (TextView)view.findViewById(R.id.welcome_textview);
<abbr title=" 172         welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.use_simplenote_account) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 172         welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(ðŸ”µ</abbr>
 173         TextView laterTextView = (TextView)view.findViewById(R.id.welcome_later_textview);
<abbr title=" 174         laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_try_app) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 174         laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.strinðŸ”µ</abbr>
 175 
 176         Button signInButton = (Button)view.findViewById(R.id.welcome_sign_in);
 177         signInButton.setTag(TAG_BUTTON_SIGNIN);
 178         signInButton.setOnClickListener(signInClickListener);
 179         Button signUpButton = (Button)view.findViewById(R.id.welcome_sign_up);
 180         signUpButton.setTag(TAG_BUTTON_SIGNUP);
 181         signUpButton.setOnClickListener(signInClickListener);
 182 
 183         // Set custom typeface
 184         mEmptyListTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 185         welcomeTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 186         laterTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 187         signInButton.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 188         signUpButton.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 189 
 190         if (notesActivity.isLargeScreenLandscape()) {
 191             setActivateOnItemClick(true);
 192             mDividerShadow.setVisibility(View.VISIBLE);
 193         }
 194 
 195         welcomeTextView.setOnClickListener(new View.OnClickListener() {
 196             @Override
 197             public void onClick(View v) {
 198                 mWelcomeViewSwitcher.showNext();
 199             }
 200         });
 201         laterTextView.setOnClickListener(new View.OnClickListener() {
 202             @Override
 203             public void onClick(View v) {
 204                 mWelcomeViewSwitcher.showNext();
<abbr title=" 205                 SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivity());"> 205                 SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivityðŸ”µ</abbr>
 206                 SharedPreferences.Editor editor = preferences.edit();
 207                 editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 208                 editor.commit();
 209             }
 210         });
 211 
 212 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213         getListView().setOnItemLongClickListener(this);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 214         getListView().setMultiChoiceModeListener(this);</span>
 215 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216         LinearLayout emptyView = (LinearLayout)view.findViewById(android.R.id.empty);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         emptyView.setVisibility(View.GONE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218         mEmptyListTextView = (TextView)view.findViewById(R.id.empty_message);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219         mEmptyListTextView.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221             public void onClick(View v) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222                 addNote();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 225         setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 225         setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.fðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226         mDividerShadow = (LinearLayout)view.findViewById(R.id.divider_shadow);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227         mWelcomeViewSwitcher = (ViewSwitcher)view.findViewById(R.id.welcome_view_switcher);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229         TextView welcomeTextView = (TextView)view.findViewById(R.id.welcome_textview);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 230         welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.use_simplenote_account) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 230         welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231         TextView laterTextView = (TextView)view.findViewById(R.id.welcome_later_textview);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 232         laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_try_app) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 232         laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.strinðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234         Button signInButton = (Button)view.findViewById(R.id.welcome_sign_in);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235         signInButton.setTag(TAG_BUTTON_SIGNIN);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236         signInButton.setOnClickListener(signInClickListener);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237         Button signUpButton = (Button)view.findViewById(R.id.welcome_sign_up);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238         signUpButton.setTag(TAG_BUTTON_SIGNUP);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239         signUpButton.setOnClickListener(signInClickListener);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241         // Set custom typeface</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242         mEmptyListTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243         welcomeTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244         laterTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245         signInButton.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246         signUpButton.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248         if (notesActivity.isLargeScreenLandscape()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249             setActivateOnItemClick(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250             mDividerShadow.setVisibility(View.VISIBLE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253         welcomeTextView.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255             public void onClick(View v) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256                 mWelcomeViewSwitcher.showNext();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259         laterTextView.setOnClickListener(new View.OnClickListener() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260             @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261             public void onClick(View v) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262                 mWelcomeViewSwitcher.showNext();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 263                 SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivity());"> 263                 SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivityðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264                 SharedPreferences.Editor editor = preferences.edit();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265                 editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266                 editor.commit();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268         });</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270         getListView().setOnItemLongClickListener(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271         getListView().setMultiChoiceModeListener(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272         getListView().setDivider(getResources().getDrawable(R.drawable.list_divider));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273         getListView().setDividerHeight(1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277 	public void onAttach(Activity activity) {</span>
 278 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279         getListView().setDivider(getResources().getDrawable(R.drawable.list_divider));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280         getListView().setDividerHeight(1);</span>
 281 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 282 	}
 283 
 284 	@Override
 285 	public void onAttach(Activity activity) {
 286 		super.onAttach(activity);
 287 
 288 		// Activities containing this fragment must implement its callbacks.
 289 		if (!(activity instanceof Callbacks)) {
 290 			throw new IllegalStateException(&quot;Activity must implement fragment&#x27;s callbacks.&quot;);
 291 		}
 292 
 293 		mCallbacks = (Callbacks) activity;
 294 	}
 295 
 296 	@Override
 297 	public void onResume() {
 298 		super.onResume();
 299         getPrefs();
 300 
 301         setWelcomeViewVisibility();
 302 
 303         refreshList();
 304 
 305         if (!PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_APP_TRIAL, false)) {
 306             new Handler().postDelayed(new Runnable() {
 307                 @Override
 308                 public void run() {
 309                     mWelcomeViewSwitcher.showNext();
 310                 }
 311             }, 100);
 312         }
 313 	}
 314 
 315     public void setWelcomeViewVisibility() {
 316         if (mWelcomeViewSwitcher != null &amp;&amp; getActivity() != null) {
 317             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 318             if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 319                 int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().getDisplayMetrics());"> 319                 int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResðŸ”µ</abbr>
<abbr title=" 320                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();"> 320                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutðŸ”µ</abbr>
 321                 mlp.setMargins(0, 0, 0, bottomMargin);
 322                 getListView().getEmptyView().setLayoutParams(mlp);
 323                 mWelcomeViewSwitcher.setVisibility(View.VISIBLE);
 324             } else {
 325                 mWelcomeViewSwitcher.setVisibility(View.GONE);
<abbr title=" 326                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();"> 326                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutðŸ”µ</abbr>
 327                 mlp.setMargins(0, 0, 0, 0);
 328                 getListView().getEmptyView().setLayoutParams(mlp);
 329             }
 330         }
 331     }
 332 
 333     public void hideWelcomeView() {
 334         if (mWelcomeViewSwitcher != null)
 335             mWelcomeViewSwitcher.setVisibility(View.GONE);
 336     }
 337 
 338     private Button.OnClickListener signInClickListener = new Button.OnClickListener() {
 339         @Override
 340         public void onClick(View v) {
<abbr title=" 341             ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? true : false);"> 341             ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? trueðŸ”µ</abbr>
 342         }
 343     };
 344 
 345 	@Override
 346 	public void onDetach() {
 347 		super.onDetach();
 348 
 349 		// Reset the active callbacks interface to the dummy implementation.
 350 		mCallbacks = sCallbacks;
 351 	}
 352 
 353     @Override
 354     public void onDestroy(){
 355         super.onDestroy();
 356     }
 357 
 358     public void setEmptyListMessage(String message) {
 359         if (mEmptyListTextView != null &amp;&amp; message != null)
 360             mEmptyListTextView.setText(Html.fromHtml(message));
 361     }
 362 
 363 	@Override
 364 	public void onListItemClick(ListView listView, View view, int position, long id) {
 365 		super.onListItemClick(listView, view, position, id);
 366 
 367         NoteViewHolder holder = (NoteViewHolder)view.getTag();
 368         String noteID = holder.getNoteId();
 369         if (noteID != null)
 370             mCallbacks.onNoteSelected(noteID, false, holder.matchOffsets);
 371 
 372         mActivatedPosition = position;
 373 	}
 374 
 375     /**
 376      * Selects first row in the list if available
 377      */
 378     public void selectFirstNote() {
 379         if (mNotesAdapter.getCount() &gt; 0) {
 380             Note selectedNote = mNotesAdapter.getItem(0);
 381             mCallbacks.onNoteSelected(selectedNote.getSimperiumKey(), false, null);
 382         }
 383     }
 384 
 385     @Override
 386     public void onSaveInstanceState(Bundle outState) {
 387         super.onSaveInstanceState(outState);
 388         if (mActivatedPosition != ListView.INVALID_POSITION) {
 389             // Serialize and persist the activated item position.
 390             outState.putInt(STATE_ACTIVATED_POSITION, mActivatedPosition);
 391         }
 392     }
 393 
 394 	/**
 395 	 * Turns on activate-on-click mode. When this mode is on, list items will be
 396 	 * given the &#x27;activated&#x27; state when touched.
 397 	 */
 398 	public void setActivateOnItemClick(boolean activateOnItemClick) {
 399 		// When setting CHOICE_MODE_SINGLE, ListView will automatically
 400 		// give items the &#x27;activated&#x27; state when touched.
<abbr title=" 401 		getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NONE);"> 401 		getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NOðŸ”µ</abbr>
 402 	}
 403 
 404 	public void setActivatedPosition(int position) {
 405         if (getListView() != null) {
 406             if (position == ListView.INVALID_POSITION) {
 407                 getListView().setItemChecked(mActivatedPosition, false);
 408             } else {
 409                 getListView().setItemChecked(position, true);
 410             }
 411 
 412             mActivatedPosition = position;
 413         }
 414 	}
 415 
 416     public void setDividerVisible(boolean visible) {
 417         if (visible)
 418             mDividerShadow.setVisibility(View.VISIBLE);
 419         else
 420             mDividerShadow.setVisibility(View.GONE);
 421     }
 422 
 423 	public void refreshList() {
 424         new refreshListTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, false);
 425 	}
 426 
 427     public void refreshListFromNavSelect() {
 428         new refreshListTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, true);
 429     }
 430 
 431     public ObjectCursor&lt;Note&gt; queryNotes(){
 432         NotesActivity notesActivity = (NotesActivity)getActivity();
 433         Query&lt;Note&gt; query = notesActivity.getSelectedTag().query();
 434 
 435         if (hasSearchQuery()) {
 436             query.where(new Query.FullTextMatch(new SearchTokenizer(mSearchString)));
 437             query.include(new Query.FullTextOffsets(&quot;match_offsets&quot;));
 438             query.include(new Query.FullTextSnippet(Note.TITLE_INDEX_NAME, Note.TITLE_INDEX_NAME));
<abbr title=" 439             query.include(new Query.FullTextSnippet(Note.CONTENT_PREVIEW_INDEX_NAME, Note.CONTENT_PROPERTY));"> 439             query.include(new Query.FullTextSnippet(Note.CONTENT_PREVIEW_INDEX_NAME, Note.CONTENT_PROPERTðŸ”µ</abbr>
 440         } else {
 441             query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 442         }
 443 
 444         query.include(Note.PINNED_INDEX_NAME);
 445 
 446         sortNoteQuery(query);
 447 
 448         return query.execute();
 449     }
 450 
 451 	public void addNote() {
 452 
 453         // Prevents jarring &#x27;New note...&#x27; from showing in the list view when creating a new note
 454         NotesActivity notesActivity = (NotesActivity)getActivity();
 455         if (!notesActivity.isLargeScreenLandscape())
 456             notesActivity.stopListeningToNotesBucket();
 457 
 458 		// Create &amp; save new note
 459 		Simplenote simplenote = (Simplenote) getActivity().getApplication();
 460 		Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 461 		Note note = notesBucket.newObject();
 462         note.setCreationDate(Calendar.getInstance());
 463         note.setModificationDate(note.getCreationDate());
 464 
 465         if (notesActivity.getSelectedTag() != null &amp;&amp; notesActivity.getSelectedTag().name != null) {
 466             String tagName = notesActivity.getSelectedTag().name;
 467             if (!tagName.equals(getString(R.string.notes)) &amp;&amp; !tagName.equals(getString(R.string.trash)))
 468                 note.setTagString(tagName);
 469         }
 470 
 471 		note.save();
 472 		
<abbr title=" 473 		// nbradbury - call onNoteSelected() directly rather than using code below, since code below may not always select the correct note depending on user&#x27;s sort preference"> 473 		// nbradbury - call onNoteSelected() directly rather than using code below, since code below may not alðŸ”µ</abbr>
 474 		mCallbacks.onNoteSelected(note.getSimperiumKey(), true, null);
 475 	}
 476 
 477     public void setNoteSelected(String selectedNoteID) {
 478         // Loop through notes and set note selected if found
 479         ObjectCursor&lt;Note&gt; cursor = (ObjectCursor&lt;Note&gt;)mNotesAdapter.getCursor();
 480         if (cursor == null || cursor.getCount() == 0)
 481             return;
 482         for(int i=0; i &lt; cursor.getCount(); i++) {
 483             cursor.moveToPosition(i);
 484             String noteKey = cursor.getSimperiumKey();
 485             if (noteKey != null &amp;&amp; noteKey.equals(selectedNoteID)) {
 486                 setActivatedPosition(i);
 487                 return;
 488             }
 489         }
 490 
 491         // Didn&#x27;t find the note, let&#x27;s try again after the cursor updates (see refreshListTask)
 492         mSelectedNoteId = selectedNoteID;
 493     }
 494 
 495 	public class NotesCursorAdapter extends CursorAdapter {
 496         private ObjectCursor&lt;Note&gt; mCursor;
 497 
<abbr title=" 498         private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(),"> 498         private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(ðŸ”µ</abbr>
 499             R.attr.listSearchHighlightForegroundColor, R.attr.listSearchHighlightBackgroundColor);
 500 
 501         public NotesCursorAdapter(Context context, ObjectCursor&lt;Note&gt; c, int flags) {
 502             super(context, c, flags);
 503             mCursor = c;
 504         }
 505 
 506         public void changeCursor(ObjectCursor&lt;Note&gt; cursor){
 507             mCursor = cursor;
 508             super.changeCursor(cursor);
 509         }
 510 
 511         @Override
 512         public Note getItem(int position) {
 513             mCursor.moveToPosition(position);
 514             return mCursor.getObject();
 515         }
 516 
 517         /*
 518         *  nbradbury - implemented &quot;holder pattern&quot; to boost performance with large note lists
 519         */
 520 		@Override
 521 		public View getView(int position, View view, ViewGroup parent) {
 522 
 523 			NoteViewHolder holder;
 524 			if (view == null) {
 525 				view = View.inflate(getActivity().getBaseContext(), R.layout.note_list_row, null);
 526 				holder = new NoteViewHolder();
 527 				holder.titleTextView = (TextView) view.findViewById(R.id.note_title);
<abbr title=" 528                 holder.titleTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 528                 holder.titleTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), SimplenoteðŸ”µ</abbr>
 529 				holder.contentTextView = (TextView) view.findViewById(R.id.note_content);
<abbr title=" 530                 holder.contentTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 530                 holder.contentTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), SimplenoðŸ”µ</abbr>
 531 				holder.pinImageView = (ImageView) view.findViewById(R.id.note_pin);
 532 				view.setTag(holder);
 533 			} else {
 534 				holder = (NoteViewHolder) view.getTag();
 535 			}
 536 
 537             if (position == getListView().getCheckedItemPosition())
 538                 view.setActivated(true);
 539             else
 540                 view.setActivated(false);
 541 
 542             // for performance reasons we are going to get indexed values
 543             // from the cursor instead of instantiating the entire bucket object
 544             holder.contentTextView.setVisibility(View.VISIBLE);
 545             holder.contentTextView.setMaxLines(mNumPreviewLines);
 546             mCursor.moveToPosition(position);
 547             holder.setNoteId(mCursor.getSimperiumKey());
 548             int pinned = mCursor.getInt(mCursor.getColumnIndex(Note.PINNED_INDEX_NAME));
 549             holder.pinImageView.setVisibility(pinned == 1 ? View.VISIBLE : View.GONE);
 550 
 551             String title = mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME));
 552 
 553             if (title == null || title.equals(&quot;&quot;)) {
 554                 SpannableString untitled = new SpannableString(getString(R.string.new_note_list));
<abbr title=" 555                 untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0, untitled.length(), 0x0);"> 555                 untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0ðŸ”µ</abbr>
 556                 holder.titleTextView.setText(untitled);
 557             } else {
 558                 holder.titleTextView.setText(title);
 559             }
 560 
 561             holder.matchOffsets = null;
 562 
 563             if (hasSearchQuery()) {
<abbr title=" 564                 String snippet = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));"> 564                 String snippet = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAMEðŸ”µ</abbr>
 565 
 566                 holder.matchOffsets = mCursor.getString(mCursor.getColumnIndex(&quot;match_offsets&quot;));
 567 
<abbr title=" 568                 holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlighter));"> 568                 holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlðŸ”µ</abbr>
<abbr title=" 569                 holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlighter));"> 569                 holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlightðŸ”µ</abbr>
 570 
 571             } else if (mNumPreviewLines &gt; 0) {
<abbr title=" 572                 String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));"> 572                 String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDðŸ”µ</abbr>
<abbr title=" 573                 if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_note_list)))"> 573                 if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_ðŸ”µ</abbr>
 574                     holder.contentTextView.setVisibility(View.GONE);
 575                 else
 576                     holder.contentTextView.setText(contentPreview);
 577             }
 578 			
 579 			return view;
 580 		}
 581 
 582         @Override
 583         public View newView(Context context, Cursor cursor, ViewGroup viewGroup) {
 584             return null;
 585         }
 586 
 587         @Override
 588         public void bindView(View view, Context context, Cursor cursor) {
 589 
 590         }
 591 
 592 	}
 593 	
 594 	// view holder for NotesCursorAdapter
 595 	private static class NoteViewHolder {
 596 		TextView titleTextView;
 597 		TextView contentTextView;
 598 		ImageView pinImageView;
 599         public String matchOffsets;
 600         private String mNoteId;
 601 
 602         public void setNoteId(String noteId) {
 603             mNoteId = noteId;
 604         }
 605 
 606         public String getNoteId() {
 607             return mNoteId;
 608         }
 609 	}
 610 
 611 	public void searchNotes(String searchString) {
 612         if (!searchString.equals(mSearchString)){
 613             mSearchString = searchString;
 614             refreshList();
 615         }
 616 	}
 617 
 618     /**
 619      * Clear search and load all notes
 620      */
 621     public void clearSearch() {
 622         if (mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;)){
 623             mSearchString = null;
 624             refreshList();
 625         }
 626     }
 627 
 628     public boolean hasSearchQuery(){
 629         return mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;);
 630     }
 631 
 632     public void sortNoteQuery(Query&lt;Note&gt; noteQuery){
 633         noteQuery.order(&quot;pinned&quot;, SortType.DESCENDING);
 634 		int sortPref = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_SORT_ORDER);
 635 		switch (sortPref) {
 636         case 0:
 637             noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.DESCENDING);
 638             break;
 639 		case 1:
 640             noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.ASCENDING);
 641 			break;
 642 		case 2:
 643             noteQuery.order(Note.CREATED_INDEX_NAME, SortType.DESCENDING);
 644 			break;
 645 		case 3:
 646             noteQuery.order(Note.CREATED_INDEX_NAME, SortType.ASCENDING);
 647 			break;
 648 		case 4:
 649             noteQuery.order(Note.CONTENT_PROPERTY, SortType.ASCENDING);
 650 			break;
 651 		case 5:
 652             noteQuery.order(Note.CONTENT_PROPERTY, SortType.DESCENDING);
 653 			break;
 654 		}
 655     }
 656 
 657     private class refreshListTask extends AsyncTask&lt;Boolean, Void, ObjectCursor&lt;Note&gt;&gt; {
 658         boolean mIsFromNavSelect;
 659 
 660         @Override
 661         protected ObjectCursor&lt;Note&gt; doInBackground(Boolean ... args) {
 662             mIsFromNavSelect = args[0];
 663             return queryNotes();
 664         }
 665 
 666         @Override
 667         protected void onPostExecute(ObjectCursor&lt;Note&gt; cursor) {
 668             if (getActivity() == null || getActivity().isFinishing())
 669                 return;
 670 
<abbr title=" 671             // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error and clear the cursor"> 671             // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error anðŸ”µ</abbr>
 672             int count = 0;
 673             try {
 674                 mNotesAdapter.changeCursor(cursor);
 675                 count = mNotesAdapter.getCount();
 676             } catch (SQLiteException e) {
 677                 count = 0;
 678                 android.util.Log.e(Simplenote.TAG, &quot;Invalid SQL statement&quot;, e);
 679                 mNotesAdapter.changeCursor(null);
 680             }
 681 
 682             NotesActivity notesActivity = (NotesActivity)getActivity();
 683             if (notesActivity != null) {
 684                 if (mIsFromNavSelect &amp;&amp; notesActivity.isLargeScreenLandscape()) {
 685                         if (count == 0) {
 686                             notesActivity.showDetailPlaceholder();
 687                         } else {
 688                             // Select the first note
 689                             selectFirstNote();
 690                         }
 691                 }
 692                 notesActivity.updateTrashMenuItem();
 693             }
 694 
 695             if (mSelectedNoteId != null) {
 696                 setNoteSelected(mSelectedNoteId);
 697                 mSelectedNoteId = null;
 698             }
 699         }
 700     }
 701 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.ListFragment;
   5 import android.content.Context;
   6 import android.content.SharedPreferences;
   7 import android.database.Cursor;
   8 import android.database.sqlite.SQLiteException;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.preference.PreferenceManager;
  13 import android.text.Html;
  14 import android.text.SpannableString;
  15 import android.text.style.TextAppearanceSpan;
  16 import android.util.TypedValue;
  17 import android.view.LayoutInflater;
  18 import android.view.View;
  19 import android.view.ViewGroup;
  20 import android.widget.Button;
  21 import android.widget.CursorAdapter;
  22 import android.widget.ImageView;
  23 import android.widget.LinearLayout;
  24 import android.widget.ListView;
  25 import android.widget.TextView;
  26 import android.widget.ViewSwitcher;
  27 
  28 import com.automattic.simplenote.models.Note;
  29 import com.automattic.simplenote.utils.PrefUtils;
  30 import com.automattic.simplenote.utils.SearchSnippetFormatter;
  31 import com.automattic.simplenote.utils.SearchTokenizer;
  32 import com.automattic.simplenote.utils.TextHighlighter;
  33 import com.automattic.simplenote.utils.Typefaces;
  34 import com.simperium.client.Bucket;
  35 import com.simperium.client.Bucket.ObjectCursor;
  36 import com.simperium.client.Query;
  37 import com.simperium.client.Query.SortType;
  38 
  39 import java.util.Calendar;
  40 
  41 /**
  42  * A list fragment representing a list of Notes. This fragment also supports
  43  * tablet devices by allowing list items to be given an &#x27;activated&#x27; state upon
  44  * selection. This helps indicate which item is currently being viewed in a
  45  * {@link NoteEditorFragment}.
  46  * &lt;p&gt;
  47  * Activities containing this fragment MUST implement the {@link Callbacks}
  48  * interface.
  49  */
  50 public class NoteListFragment extends ListFragment {
  51 
  52 	private NotesCursorAdapter mNotesAdapter;
  53     private TextView mEmptyListTextView;
  54     private LinearLayout mDividerShadow;
  55 	private int mNumPreviewLines;
  56     private String mSearchString;
  57     private ViewSwitcher mWelcomeViewSwitcher;
  58     private String mSelectedNoteId;
  59 
  60 	/**
  61 	 * The preferences key representing the activated item position. Only used on tablets.
  62 	 */
  63 	private static final String STATE_ACTIVATED_POSITION = &quot;activated_position&quot;;
  64     private static final String TAG_BUTTON_SIGNIN = &quot;sign_in&quot;;
  65     private static final String TAG_BUTTON_SIGNUP = &quot;sign_up&quot;;
  66 
  67 	/**
  68 	 * The fragment&#x27;s current callback object, which is notified of list item
  69 	 * clicks.
  70 	 */
  71 	private Callbacks mCallbacks = sCallbacks;
  72 
  73 	/**
  74 	 * The current activated item position. Only used on tablets.
  75 	 */
  76 	private int mActivatedPosition = ListView.INVALID_POSITION;
  77 
  78     public void setEmptyListViewClickable(boolean isClickable) {
  79         if (mEmptyListTextView != null) {
  80             mEmptyListTextView.setClickable(isClickable);
  81         }
  82     }
  83 
  84 	/**
  85 	 * Mandatory empty constructor for the fragment manager to instantiate the
  86 	 * fragment (e.g. upon screen orientation changes).
  87 	 */
  88 	public NoteListFragment() {
  89     }
  90 
  91     /**
  92 	 * A callback interface that all activities containing this fragment must
  93 	 * implement. This mechanism allows activities to be notified of item
  94 	 * selections.
  95 	 */
  96 	public interface Callbacks {
  97 		/**
  98 		 * Callback for when a note has been selected.
  99 		 */
 100 		public void onNoteSelected(String noteID, boolean isNew, String matchOffsets);
 101 	}
 102 
 103 	/**
 104 	 * A dummy implementation of the {@link Callbacks} interface that does
 105 	 * nothing. Used only when this fragment is not attached to an activity.
 106 	 */
 107 	private static Callbacks sCallbacks = new Callbacks() {
 108 		@Override
 109 		public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 110 		}
 111 	};
 112 
 113 	@Override
 114 	public void onCreate(Bundle savedInstanceState) {
 115 		super.onCreate(savedInstanceState);
 116 
 117 		Simplenote application = (Simplenote) getActivity().getApplication();
 118 
 119 		mNotesAdapter = new NotesCursorAdapter(getActivity().getBaseContext(), null, 0);
 120 		setListAdapter(mNotesAdapter);
 121 
 122 	}
 123 
 124     @Override
 125     public void onActivityCreated(Bundle savedInstanceState) {
 126         super.onActivityCreated(savedInstanceState);
 127 
 128     }
 129 
 130     // nbradbury - load values from preferences
 131 	protected void getPrefs() {
<abbr title=" 132         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, false);"> 132         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, falseðŸ”µ</abbr>
 133 		mNumPreviewLines = (condensedList) ? 0 : 2;
 134 	}
 135 
 136     @Override
 137     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)
 138     {
 139         View view = inflater.inflate(R.layout.notes_list, container, false);
 140         return view;
 141     }
 142 
 143 	@Override
 144 	public void onViewCreated(View view, Bundle savedInstanceState) {
 145 		super.onViewCreated(view, savedInstanceState);
 146 
 147         NotesActivity notesActivity = (NotesActivity)getActivity();
 148 
 149         LinearLayout emptyView = (LinearLayout)view.findViewById(android.R.id.empty);
 150         emptyView.setVisibility(View.GONE);
 151         mEmptyListTextView = (TextView)view.findViewById(R.id.empty_message);
 152         mEmptyListTextView.setOnClickListener(new View.OnClickListener() {
 153             @Override
 154             public void onClick(View v) {
 155                 addNote();
 156             }
 157         });
<abbr title=" 158         setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 158         setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.fðŸ”µ</abbr>
 159         mDividerShadow = (LinearLayout)view.findViewById(R.id.divider_shadow);
 160         mWelcomeViewSwitcher = (ViewSwitcher)view.findViewById(R.id.welcome_view_switcher);
 161 
 162         TextView welcomeTextView = (TextView)view.findViewById(R.id.welcome_textview);
<abbr title=" 163         welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.use_simplenote_account) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 163         welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(ðŸ”µ</abbr>
 164         TextView laterTextView = (TextView)view.findViewById(R.id.welcome_later_textview);
<abbr title=" 165         laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_try_app) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 165         laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.strinðŸ”µ</abbr>
 166 
 167         Button signInButton = (Button)view.findViewById(R.id.welcome_sign_in);
 168         signInButton.setTag(TAG_BUTTON_SIGNIN);
 169         signInButton.setOnClickListener(signInClickListener);
 170         Button signUpButton = (Button)view.findViewById(R.id.welcome_sign_up);
 171         signUpButton.setTag(TAG_BUTTON_SIGNUP);
 172         signUpButton.setOnClickListener(signInClickListener);
 173 
 174         // Set custom typeface
 175         mEmptyListTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 176         welcomeTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 177         laterTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 178         signInButton.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 179         signUpButton.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 180 
 181         if (notesActivity.isLargeScreenLandscape()) {
 182             setActivateOnItemClick(true);
 183             mDividerShadow.setVisibility(View.VISIBLE);
 184         }
 185 
 186         welcomeTextView.setOnClickListener(new View.OnClickListener() {
 187             @Override
 188             public void onClick(View v) {
 189                 mWelcomeViewSwitcher.showNext();
 190             }
 191         });
 192         laterTextView.setOnClickListener(new View.OnClickListener() {
 193             @Override
 194             public void onClick(View v) {
 195                 mWelcomeViewSwitcher.showNext();
<abbr title=" 196                 SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivity());"> 196                 SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivityðŸ”µ</abbr>
 197                 SharedPreferences.Editor editor = preferences.edit();
 198                 editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 199                 editor.commit();
 200             }
 201         });
 202 
 203 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 204         getListView().setOnItemLongClickListener(this);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 205         getListView().setMultiChoiceModeListener(this);</span>
 206 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207         getListView().setOnItemLongClickListener(this);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208         getListView().setMultiChoiceModeListener(this);</span>
 209 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210         getListView().setDivider(getResources().getDrawable(R.drawable.list_divider));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211         getListView().setDividerHeight(1);</span>
 212 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 213 	}
 214 
 215 	@Override
 216 	public void onAttach(Activity activity) {
 217 		super.onAttach(activity);
 218 
 219 		// Activities containing this fragment must implement its callbacks.
 220 		if (!(activity instanceof Callbacks)) {
 221 			throw new IllegalStateException(&quot;Activity must implement fragment&#x27;s callbacks.&quot;);
 222 		}
 223 
 224 		mCallbacks = (Callbacks) activity;
 225 	}
 226 
 227 	@Override
 228 	public void onResume() {
 229 		super.onResume();
 230         getPrefs();
 231 
 232         setWelcomeViewVisibility();
 233 
 234         refreshList();
 235 
 236         if (!PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_APP_TRIAL, false)) {
 237             new Handler().postDelayed(new Runnable() {
 238                 @Override
 239                 public void run() {
 240                     mWelcomeViewSwitcher.showNext();
 241                 }
 242             }, 100);
 243         }
 244 	}
 245 
 246     public void setWelcomeViewVisibility() {
 247         if (mWelcomeViewSwitcher != null &amp;&amp; getActivity() != null) {
 248             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 249             if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 250                 int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().getDisplayMetrics());"> 250                 int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResðŸ”µ</abbr>
<abbr title=" 251                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();"> 251                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutðŸ”µ</abbr>
 252                 mlp.setMargins(0, 0, 0, bottomMargin);
 253                 getListView().getEmptyView().setLayoutParams(mlp);
 254                 mWelcomeViewSwitcher.setVisibility(View.VISIBLE);
 255             } else {
 256                 mWelcomeViewSwitcher.setVisibility(View.GONE);
<abbr title=" 257                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();"> 257                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutðŸ”µ</abbr>
 258                 mlp.setMargins(0, 0, 0, 0);
 259                 getListView().getEmptyView().setLayoutParams(mlp);
 260             }
 261         }
 262     }
 263 
 264     public void hideWelcomeView() {
 265         if (mWelcomeViewSwitcher != null)
 266             mWelcomeViewSwitcher.setVisibility(View.GONE);
 267     }
 268 
 269     private Button.OnClickListener signInClickListener = new Button.OnClickListener() {
 270         @Override
 271         public void onClick(View v) {
<abbr title=" 272             ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? true : false);"> 272             ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? trueðŸ”µ</abbr>
 273         }
 274     };
 275 
 276 	@Override
 277 	public void onDetach() {
 278 		super.onDetach();
 279 
 280 		// Reset the active callbacks interface to the dummy implementation.
 281 		mCallbacks = sCallbacks;
 282 	}
 283 
 284     @Override
 285     public void onDestroy(){
 286         super.onDestroy();
 287     }
 288 
 289     public void setEmptyListMessage(String message) {
 290         if (mEmptyListTextView != null &amp;&amp; message != null)
 291             mEmptyListTextView.setText(Html.fromHtml(message));
 292     }
 293 
 294 	@Override
 295 	public void onListItemClick(ListView listView, View view, int position, long id) {
 296 		super.onListItemClick(listView, view, position, id);
 297 
 298         NoteViewHolder holder = (NoteViewHolder)view.getTag();
 299         String noteID = holder.getNoteId();
 300         if (noteID != null)
 301             mCallbacks.onNoteSelected(noteID, false, holder.matchOffsets);
 302 
 303         mActivatedPosition = position;
 304 	}
 305 
 306     /**
 307      * Selects first row in the list if available
 308      */
 309     public void selectFirstNote() {
 310         if (mNotesAdapter.getCount() &gt; 0) {
 311             Note selectedNote = mNotesAdapter.getItem(0);
 312             mCallbacks.onNoteSelected(selectedNote.getSimperiumKey(), false, null);
 313         }
 314     }
 315 
 316     @Override
 317     public void onSaveInstanceState(Bundle outState) {
 318         super.onSaveInstanceState(outState);
 319         if (mActivatedPosition != ListView.INVALID_POSITION) {
 320             // Serialize and persist the activated item position.
 321             outState.putInt(STATE_ACTIVATED_POSITION, mActivatedPosition);
 322         }
 323     }
 324 
 325 	/**
 326 	 * Turns on activate-on-click mode. When this mode is on, list items will be
 327 	 * given the &#x27;activated&#x27; state when touched.
 328 	 */
 329 	public void setActivateOnItemClick(boolean activateOnItemClick) {
 330 		// When setting CHOICE_MODE_SINGLE, ListView will automatically
 331 		// give items the &#x27;activated&#x27; state when touched.
<abbr title=" 332 		getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NONE);"> 332 		getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NOðŸ”µ</abbr>
 333 	}
 334 
 335 	public void setActivatedPosition(int position) {
 336         if (getListView() != null) {
 337             if (position == ListView.INVALID_POSITION) {
 338                 getListView().setItemChecked(mActivatedPosition, false);
 339             } else {
 340                 getListView().setItemChecked(position, true);
 341             }
 342 
 343             mActivatedPosition = position;
 344         }
 345 	}
 346 
 347     public void setDividerVisible(boolean visible) {
 348         if (visible)
 349             mDividerShadow.setVisibility(View.VISIBLE);
 350         else
 351             mDividerShadow.setVisibility(View.GONE);
 352     }
 353 
 354 	public void refreshList() {
 355         new refreshListTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, false);
 356 	}
 357 
 358     public void refreshListFromNavSelect() {
 359         new refreshListTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, true);
 360     }
 361 
 362     public ObjectCursor&lt;Note&gt; queryNotes(){
 363         NotesActivity notesActivity = (NotesActivity)getActivity();
 364         Query&lt;Note&gt; query = notesActivity.getSelectedTag().query();
 365 
 366         if (hasSearchQuery()) {
 367             query.where(new Query.FullTextMatch(new SearchTokenizer(mSearchString)));
 368             query.include(new Query.FullTextOffsets(&quot;match_offsets&quot;));
 369             query.include(new Query.FullTextSnippet(Note.TITLE_INDEX_NAME, Note.TITLE_INDEX_NAME));
<abbr title=" 370             query.include(new Query.FullTextSnippet(Note.CONTENT_PREVIEW_INDEX_NAME, Note.CONTENT_PROPERTY));"> 370             query.include(new Query.FullTextSnippet(Note.CONTENT_PREVIEW_INDEX_NAME, Note.CONTENT_PROPERTðŸ”µ</abbr>
 371         } else {
 372             query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 373         }
 374 
 375         query.include(Note.PINNED_INDEX_NAME);
 376 
 377         sortNoteQuery(query);
 378 
 379         return query.execute();
 380     }
 381 
 382 	public void addNote() {
 383 
 384         // Prevents jarring &#x27;New note...&#x27; from showing in the list view when creating a new note
 385         NotesActivity notesActivity = (NotesActivity)getActivity();
 386         if (!notesActivity.isLargeScreenLandscape())
 387             notesActivity.stopListeningToNotesBucket();
 388 
 389 		// Create &amp; save new note
 390 		Simplenote simplenote = (Simplenote) getActivity().getApplication();
 391 		Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 392 		Note note = notesBucket.newObject();
 393         note.setCreationDate(Calendar.getInstance());
 394         note.setModificationDate(note.getCreationDate());
 395 
 396         if (notesActivity.getSelectedTag() != null &amp;&amp; notesActivity.getSelectedTag().name != null) {
 397             String tagName = notesActivity.getSelectedTag().name;
 398             if (!tagName.equals(getString(R.string.notes)) &amp;&amp; !tagName.equals(getString(R.string.trash)))
 399                 note.setTagString(tagName);
 400         }
 401 
 402 		note.save();
 403 
<abbr title=" 404 		// nbradbury - call onNoteSelected() directly rather than using code below, since code below may not always select the correct note depending on user&#x27;s sort preference"> 404 		// nbradbury - call onNoteSelected() directly rather than using code below, since code below may not alðŸ”µ</abbr>
 405 		mCallbacks.onNoteSelected(note.getSimperiumKey(), true, null);
 406 	}
 407 
 408     public void setNoteSelected(String selectedNoteID) {
 409         // Loop through notes and set note selected if found
 410         ObjectCursor&lt;Note&gt; cursor = (ObjectCursor&lt;Note&gt;)mNotesAdapter.getCursor();
 411         if (cursor == null || cursor.getCount() == 0)
 412             return;
 413         for(int i=0; i &lt; cursor.getCount(); i++) {
 414             cursor.moveToPosition(i);
 415             String noteKey = cursor.getSimperiumKey();
 416             if (noteKey != null &amp;&amp; noteKey.equals(selectedNoteID)) {
 417                 setActivatedPosition(i);
 418                 return;
 419             }
 420         }
 421 
 422         // Didn&#x27;t find the note, let&#x27;s try again after the cursor updates (see refreshListTask)
 423         mSelectedNoteId = selectedNoteID;
 424     }
 425 
 426 	public class NotesCursorAdapter extends CursorAdapter {
 427         private ObjectCursor&lt;Note&gt; mCursor;
 428 
<abbr title=" 429         private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(),"> 429         private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(ðŸ”µ</abbr>
 430             R.attr.listSearchHighlightForegroundColor, R.attr.listSearchHighlightBackgroundColor);
 431 
 432         public NotesCursorAdapter(Context context, ObjectCursor&lt;Note&gt; c, int flags) {
 433             super(context, c, flags);
 434             mCursor = c;
 435         }
 436 
 437         public void changeCursor(ObjectCursor&lt;Note&gt; cursor){
 438             mCursor = cursor;
 439             super.changeCursor(cursor);
 440         }
 441 
 442         @Override
 443         public Note getItem(int position) {
 444             mCursor.moveToPosition(position);
 445             return mCursor.getObject();
 446         }
 447 
 448         /*
 449         *  nbradbury - implemented &quot;holder pattern&quot; to boost performance with large note lists
 450         */
 451 		@Override
 452 		public View getView(int position, View view, ViewGroup parent) {
 453 
 454 			NoteViewHolder holder;
 455 			if (view == null) {
 456 				view = View.inflate(getActivity().getBaseContext(), R.layout.note_list_row, null);
 457 				holder = new NoteViewHolder();
 458 				holder.titleTextView = (TextView) view.findViewById(R.id.note_title);
<abbr title=" 459                 holder.titleTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 459                 holder.titleTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), SimplenoteðŸ”µ</abbr>
 460 				holder.contentTextView = (TextView) view.findViewById(R.id.note_content);
<abbr title=" 461                 holder.contentTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 461                 holder.contentTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), SimplenoðŸ”µ</abbr>
 462 				holder.pinImageView = (ImageView) view.findViewById(R.id.note_pin);
 463 				view.setTag(holder);
 464 			} else {
 465 				holder = (NoteViewHolder) view.getTag();
 466 			}
 467 
 468             if (position == getListView().getCheckedItemPosition())
 469                 view.setActivated(true);
 470             else
 471                 view.setActivated(false);
 472 
 473             // for performance reasons we are going to get indexed values
 474             // from the cursor instead of instantiating the entire bucket object
 475             holder.contentTextView.setVisibility(View.VISIBLE);
 476             holder.contentTextView.setMaxLines(mNumPreviewLines);
 477             mCursor.moveToPosition(position);
 478             holder.setNoteId(mCursor.getSimperiumKey());
 479             int pinned = mCursor.getInt(mCursor.getColumnIndex(Note.PINNED_INDEX_NAME));
 480             holder.pinImageView.setVisibility(pinned == 1 ? View.VISIBLE : View.GONE);
 481 
 482             String title = mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME));
 483 
 484             if (title == null || title.equals(&quot;&quot;)) {
 485                 SpannableString untitled = new SpannableString(getString(R.string.new_note_list));
<abbr title=" 486                 untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0, untitled.length(), 0x0);"> 486                 untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0ðŸ”µ</abbr>
 487                 holder.titleTextView.setText(untitled);
 488             } else {
 489                 holder.titleTextView.setText(title);
 490             }
 491 
 492             holder.matchOffsets = null;
 493 
 494             if (hasSearchQuery()) {
<abbr title=" 495                 String snippet = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));"> 495                 String snippet = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAMEðŸ”µ</abbr>
 496 
 497                 holder.matchOffsets = mCursor.getString(mCursor.getColumnIndex(&quot;match_offsets&quot;));
 498 
<abbr title=" 499                 holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlighter));"> 499                 holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlðŸ”µ</abbr>
<abbr title=" 500                 holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlighter));"> 500                 holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlightðŸ”µ</abbr>
 501 
 502             } else if (mNumPreviewLines &gt; 0) {
<abbr title=" 503                 String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));"> 503                 String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDðŸ”µ</abbr>
<abbr title=" 504                 if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_note_list)))"> 504                 if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_ðŸ”µ</abbr>
 505                     holder.contentTextView.setVisibility(View.GONE);
 506                 else
 507                     holder.contentTextView.setText(contentPreview);
 508             }
 509 
 510 			return view;
 511 		}
 512 
 513         @Override
 514         public View newView(Context context, Cursor cursor, ViewGroup viewGroup) {
 515             return null;
 516         }
 517 
 518         @Override
 519         public void bindView(View view, Context context, Cursor cursor) {
 520 
 521         }
 522 
 523 	}
 524 
 525 	// view holder for NotesCursorAdapter
 526 	private static class NoteViewHolder {
 527 		TextView titleTextView;
 528 		TextView contentTextView;
 529 		ImageView pinImageView;
 530         public String matchOffsets;
 531         private String mNoteId;
 532 
 533         public void setNoteId(String noteId) {
 534             mNoteId = noteId;
 535         }
 536 
 537         public String getNoteId() {
 538             return mNoteId;
 539         }
 540 	}
 541 
 542 	public void searchNotes(String searchString) {
 543         if (!searchString.equals(mSearchString)){
 544             mSearchString = searchString;
 545             refreshList();
 546         }
 547 	}
 548 
 549     /**
 550      * Clear search and load all notes
 551      */
 552     public void clearSearch() {
 553         if (mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;)){
 554             mSearchString = null;
 555             refreshList();
 556         }
 557     }
 558 
 559     public boolean hasSearchQuery(){
 560         return mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;);
 561     }
 562 
 563     public void sortNoteQuery(Query&lt;Note&gt; noteQuery){
 564         noteQuery.order(&quot;pinned&quot;, SortType.DESCENDING);
 565 		int sortPref = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_SORT_ORDER);
 566 		switch (sortPref) {
 567         case 0:
 568             noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.DESCENDING);
 569             break;
 570 		case 1:
 571             noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.ASCENDING);
 572 			break;
 573 		case 2:
 574             noteQuery.order(Note.CREATED_INDEX_NAME, SortType.DESCENDING);
 575 			break;
 576 		case 3:
 577             noteQuery.order(Note.CREATED_INDEX_NAME, SortType.ASCENDING);
 578 			break;
 579 		case 4:
 580             noteQuery.order(Note.CONTENT_PROPERTY, SortType.ASCENDING);
 581 			break;
 582 		case 5:
 583             noteQuery.order(Note.CONTENT_PROPERTY, SortType.DESCENDING);
 584 			break;
 585 		}
 586     }
 587 
 588     private class refreshListTask extends AsyncTask&lt;Boolean, Void, ObjectCursor&lt;Note&gt;&gt; {
 589         boolean mIsFromNavSelect;
 590 
 591         @Override
 592         protected ObjectCursor&lt;Note&gt; doInBackground(Boolean ... args) {
 593             mIsFromNavSelect = args[0];
 594             return queryNotes();
 595         }
 596 
 597         @Override
 598         protected void onPostExecute(ObjectCursor&lt;Note&gt; cursor) {
 599             if (getActivity() == null || getActivity().isFinishing())
 600                 return;
 601 
<abbr title=" 602             // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error and clear the cursor"> 602             // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error anðŸ”µ</abbr>
 603             int count = 0;
 604             try {
 605             mNotesAdapter.changeCursor(cursor);
 606                 count = mNotesAdapter.getCount();
 607             } catch (SQLiteException e) {
 608                 count = 0;
 609                 android.util.Log.e(Simplenote.TAG, &quot;Invalid SQL statement&quot;, e);
 610                 mNotesAdapter.changeCursor(null);
 611             }
 612 
 613             NotesActivity notesActivity = (NotesActivity)getActivity();
 614             if (notesActivity != null) {
 615                 if (mIsFromNavSelect &amp;&amp; notesActivity.isLargeScreenLandscape()) {
 616                         if (count == 0) {
 617                             notesActivity.showDetailPlaceholder();
 618                         } else {
 619                             // Select the first note
 620                             selectFirstNote();
 621                         }
 622                 }
 623                 notesActivity.updateTrashMenuItem();
 624             }
 625 
 626             if (mSelectedNoteId != null) {
 627                 setNoteSelected(mSelectedNoteId);
 628                 mSelectedNoteId = null;
 629             }
 630         }
 631     }
 632 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.ListFragment;
   5 import android.content.Context;
   6 import android.content.SharedPreferences;
   7 import android.database.Cursor;
   8 import android.database.sqlite.SQLiteException;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.Handler;
  12 import android.preference.PreferenceManager;
  13 import android.text.Html;
  14 import android.text.SpannableString;
  15 import android.text.style.TextAppearanceSpan;
  16 import android.util.TypedValue;
  17 import android.view.LayoutInflater;
  18 import android.view.View;
  19 import android.view.ViewGroup;
  20 import android.widget.Button;
  21 import android.widget.CursorAdapter;
  22 import android.widget.ImageView;
  23 import android.widget.LinearLayout;
  24 import android.widget.ListView;
  25 import android.widget.TextView;
  26 import android.widget.ViewSwitcher;
  27 import com.automattic.simplenote.models.Note;
  28 import com.automattic.simplenote.utils.PrefUtils;
  29 import com.automattic.simplenote.utils.SearchSnippetFormatter;
  30 import com.automattic.simplenote.utils.SearchTokenizer;
  31 import com.automattic.simplenote.utils.TextHighlighter;
  32 import com.automattic.simplenote.utils.Typefaces;
  33 import com.simperium.client.Bucket.ObjectCursor;
  34 import com.simperium.client.Bucket;
  35 import com.simperium.client.Query.SortType;
  36 import com.simperium.client.Query;
  37 import java.util.Calendar;
  38 
  39 
  40 /**
  41  * A list fragment representing a list of Notes. This fragment also supports
  42  * tablet devices by allowing list items to be given an &#x27;activated&#x27; state upon
  43  * selection. This helps indicate which item is currently being viewed in a
  44  * {@link NoteEditorFragment}.
  45  * &lt;p&gt;
  46  * Activities containing this fragment MUST implement the {@link Callbacks}
  47  * interface.
  48  */
  49 public class NoteListFragment extends ListFragment {
  50 private NotesCursorAdapter mNotesAdapter;
  51 
  52     private TextView mEmptyListTextView;
  53 
  54     private LinearLayout mDividerShadow;
  55 
  56 private int mNumPreviewLines;
  57 
  58     private String mSearchString;
  59 
  60     private ViewSwitcher mWelcomeViewSwitcher;
  61 
  62     private String mSelectedNoteId;
  63 
  64 /**
  65  * The preferences key representing the activated item position. Only used on tablets.
  66  */
  67 private static final String STATE_ACTIVATED_POSITION = &quot;activated_position&quot;;
  68 
  69     private static final String TAG_BUTTON_SIGNIN = &quot;sign_in&quot;;
  70 
  71     private static final String TAG_BUTTON_SIGNUP = &quot;sign_up&quot;;
  72 
  73     /**
  74      * The fragment&#x27;s current callback object, which is notified of list item
  75      * clicks.
  76      */
  77     private Callbacks mCallbacks = sCallbacks;
  78 
  79 /**
  80  * The current activated item position. Only used on tablets.
  81  */
  82 private int mActivatedPosition = ListView.INVALID_POSITION;
  83 
  84     public void setEmptyListViewClickable(boolean isClickable) {
  85         if (mEmptyListTextView != null) {
  86             mEmptyListTextView.setClickable(isClickable);
  87         }
  88     }
  89 
  90     /**
  91     	 * A callback interface that all activities containing this fragment must
  92     	 * implement. This mechanism allows activities to be notified of item
  93     	 * selections.
  94     	 */
  95     public interface Callbacks {
  96 /**
  97  * Callback for when a note has been selected.
  98  */
  99         public abstract void onNoteSelected(String noteID, boolean isNew, String matchOffsets);
 100     }
 101 
 102 /**
 103  * A dummy implementation of the {@link Callbacks} interface that does
 104  * nothing. Used only when this fragment is not attached to an activity.
 105  */
 106     private static Callbacks sCallbacks = new Callbacks() {
 107         @Override
 108         public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {
 109         }
 110     };
 111 
 112     /**
 113      * Mandatory empty constructor for the fragment manager to instantiate the
 114      * fragment (e.g. upon screen orientation changes).
 115      */
 116     public NoteListFragment() {
 117     }
 118 
 119 @Override
 120 public void onCreate(Bundle savedInstanceState) {
 121 	super.onCreate(savedInstanceState);
 122 
 123 	Simplenote application = (Simplenote) getActivity().getApplication();
 124 
 125 	mNotesAdapter = new NotesCursorAdapter(getActivity().getBaseContext(), null, 0);
 126 	setListAdapter(mNotesAdapter);
 127 
 128 }
 129 
 130     @Override
 131     public void onActivityCreated(Bundle savedInstanceState) {
 132         super.onActivityCreated(savedInstanceState);
 133 
 134     }
 135 
 136     // nbradbury - load values from preferences
 137     	protected void getPrefs() {
<abbr title=" 138         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, false);"> 138         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, falseðŸ”µ</abbr>
 139     		mNumPreviewLines = (condensedList) ? 0 : 2;
 140     	}
 141 
 142     @Override
 143     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)
 144     {
 145         View view = inflater.inflate(R.layout.notes_list, container, false);
 146         return view;
 147     }
 148 
 149     @Override
 150     public void onViewCreated(View view, Bundle savedInstanceState) {
 151 	super.onViewCreated(view, savedInstanceState);
 152 
 153        NotesActivity notesActivity = (NotesActivity)getActivity();
 154 
 155        LinearLayout emptyView = (LinearLayout)view.findViewById(android.R.id.empty);
 156        emptyView.setVisibility(View.GONE);
 157        mEmptyListTextView = (TextView)view.findViewById(R.id.empty_message);
 158        mEmptyListTextView.setOnClickListener(new View.OnClickListener() {
 159            @Override
 160            public void onClick(View v) {
 161                addNote();
 162            }
 163        });
<abbr title=" 164        setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 164        setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.foðŸ”µ</abbr>
 165        mDividerShadow = (LinearLayout)view.findViewById(R.id.divider_shadow);
 166        mWelcomeViewSwitcher = (ViewSwitcher)view.findViewById(R.id.welcome_view_switcher);
 167 
 168        TextView welcomeTextView = (TextView)view.findViewById(R.id.welcome_textview);
<abbr title=" 169        welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.use_simplenote_account) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 169        welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(RðŸ”µ</abbr>
 170        TextView laterTextView = (TextView)view.findViewById(R.id.welcome_later_textview);
<abbr title=" 171        laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_try_app) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 171        laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.stringðŸ”µ</abbr>
 172 
 173        Button signInButton = (Button)view.findViewById(R.id.welcome_sign_in);
 174        signInButton.setTag(TAG_BUTTON_SIGNIN);
 175        signInButton.setOnClickListener(signInClickListener);
 176        Button signUpButton = (Button)view.findViewById(R.id.welcome_sign_up);
 177        signUpButton.setTag(TAG_BUTTON_SIGNUP);
 178        signUpButton.setOnClickListener(signInClickListener);
 179 
 180        // Set custom typeface
 181        mEmptyListTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 182        welcomeTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 183        laterTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 184        signInButton.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 185        signUpButton.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 186 
 187        if (notesActivity.isLargeScreenLandscape()) {
 188            setActivateOnItemClick(true);
 189            mDividerShadow.setVisibility(View.VISIBLE);
 190        }
 191 
 192        welcomeTextView.setOnClickListener(new View.OnClickListener() {
 193            @Override
 194            public void onClick(View v) {
 195                mWelcomeViewSwitcher.showNext();
 196            }
 197        });
 198        laterTextView.setOnClickListener(new View.OnClickListener() {
 199            @Override
 200            public void onClick(View v) {
 201                mWelcomeViewSwitcher.showNext();
<abbr title=" 202                SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivity());"> 202                SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivity(ðŸ”µ</abbr>
 203                SharedPreferences.Editor editor = preferences.edit();
 204                editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 205                editor.commit();
 206            }
 207        });
 208 
 209 
 210 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 211        getListView().setOnItemLongClickListener(this);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 212        getListView().setMultiChoiceModeListener(this);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 213 </span>
 214 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 215 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 215 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 216 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218        getListView().setDivider(getResources().getDrawable(R.drawable.list_divider));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219        getListView().setDividerHeight(1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 </span>
 221 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 222 }
 223 
 224 @Override
 225 public void onAttach(Activity activity) {
 226 	super.onAttach(activity);
 227 
 228 	// Activities containing this fragment must implement its callbacks.
 229 	if (!(activity instanceof Callbacks)) {
 230 		throw new IllegalStateException(&quot;Activity must implement fragment&#x27;s callbacks.&quot;);
 231 	}
 232 
 233 	mCallbacks = (Callbacks) activity;
 234 }
 235 
 236 @Override
 237 public void onResume() {
 238 	super.onResume();
 239        getPrefs();
 240 
 241        setWelcomeViewVisibility();
 242 
 243        refreshList();
 244 
 245        if (!PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_APP_TRIAL, false)) {
 246            new Handler().postDelayed(new Runnable() {
 247                @Override
 248                public void run() {
 249                    mWelcomeViewSwitcher.showNext();
 250                }
 251            }, 100);
 252        }
 253 }
 254 
 255     public void setWelcomeViewVisibility() {
 256         if (mWelcomeViewSwitcher != null &amp;&amp; getActivity() != null) {
 257             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 258             if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 259                 int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().getDisplayMetrics());"> 259                 int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResðŸ”µ</abbr>
<abbr title=" 260                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();"> 260                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutðŸ”µ</abbr>
 261                 mlp.setMargins(0, 0, 0, bottomMargin);
 262                 getListView().getEmptyView().setLayoutParams(mlp);
 263                 mWelcomeViewSwitcher.setVisibility(View.VISIBLE);
 264             } else {
 265                 mWelcomeViewSwitcher.setVisibility(View.GONE);
<abbr title=" 266                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();"> 266                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutðŸ”µ</abbr>
 267                 mlp.setMargins(0, 0, 0, 0);
 268                 getListView().getEmptyView().setLayoutParams(mlp);
 269             }
 270         }
 271     }
 272 
 273     public void hideWelcomeView() {
 274         if (mWelcomeViewSwitcher != null)
 275             mWelcomeViewSwitcher.setVisibility(View.GONE);
 276     }
 277 
 278     private Button.OnClickListener signInClickListener = new Button.OnClickListener() {
 279         @Override
 280         public void onClick(View v) {
<abbr title=" 281             ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? true : false);"> 281             ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? trueðŸ”µ</abbr>
 282         }
 283     };
 284 
 285 @Override
 286 public void onDetach() {
 287 	super.onDetach();
 288 
 289 	// Reset the active callbacks interface to the dummy implementation.
 290 	mCallbacks = sCallbacks;
 291 }
 292 
 293     @Override
 294     public void onDestroy(){
 295         super.onDestroy();
 296     }
 297 
 298     public void setEmptyListMessage(String message) {
 299         if (mEmptyListTextView != null &amp;&amp; message != null)
 300             mEmptyListTextView.setText(Html.fromHtml(message));
 301     }
 302 
 303     @Override
 304     public void onListItemClick(ListView listView, View view, int position, long id) {
 305         super.onListItemClick(listView, view, position, id);
 306         NoteViewHolder holder = ((NoteViewHolder) (view.getTag()));
 307         String noteID = holder.getNoteId();
 308         if (noteID != null) {
 309             mCallbacks.onNoteSelected(noteID, false, holder.matchOffsets);
 310         }
 311         mActivatedPosition = position;
 312     }
 313 
 314     /**
 315      * Selects first row in the list if available
 316      */
 317     public void selectFirstNote() {
 318         if (mNotesAdapter.getCount() &gt; 0) {
 319             Note selectedNote = mNotesAdapter.getItem(0);
 320             mCallbacks.onNoteSelected(selectedNote.getSimperiumKey(), false, null);
 321         }
 322     }
 323 
 324     @Override
 325     public void onSaveInstanceState(Bundle outState) {
 326         super.onSaveInstanceState(outState);
 327         if (mActivatedPosition != ListView.INVALID_POSITION) {
 328             // Serialize and persist the activated item position.
 329             outState.putInt(STATE_ACTIVATED_POSITION, mActivatedPosition);
 330         }
 331     }
 332 
 333 /**
 334  * Turns on activate-on-click mode. When this mode is on, list items will be
 335  * given the &#x27;activated&#x27; state when touched.
 336  */
 337 public void setActivateOnItemClick(boolean activateOnItemClick) {
 338 	// When setting CHOICE_MODE_SINGLE, ListView will automatically
 339 	// give items the &#x27;activated&#x27; state when touched.
<abbr title=" 340 	getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NONE);"> 340 	getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NONðŸ”µ</abbr>
 341 }
 342 
 343 public void setActivatedPosition(int position) {
 344        if (getListView() != null) {
 345            if (position == ListView.INVALID_POSITION) {
 346                getListView().setItemChecked(mActivatedPosition, false);
 347            } else {
 348                getListView().setItemChecked(position, true);
 349            }
 350 
 351            mActivatedPosition = position;
 352        }
 353 }
 354 
 355     public void setDividerVisible(boolean visible) {
 356         if (visible)
 357             mDividerShadow.setVisibility(View.VISIBLE);
 358         else
 359             mDividerShadow.setVisibility(View.GONE);
 360     }
 361 
 362 public void refreshList() {
 363        new refreshListTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, false);
 364 }
 365 
 366     public void refreshListFromNavSelect() {
 367         new refreshListTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, true);
 368     }
 369 
 370     public ObjectCursor&lt;Note&gt; queryNotes() {
 371         NotesActivity notesActivity = ((NotesActivity) (getActivity()));
 372         Query&lt;Note&gt; query = notesActivity.getSelectedTag().query();
 373         if (hasSearchQuery()) {
 374             query.where(new Query.FullTextMatch(new SearchTokenizer(mSearchString)));
 375             query.include(new Query.FullTextOffsets(&quot;match_offsets&quot;));
 376             query.include(new Query.FullTextSnippet(Note.TITLE_INDEX_NAME, Note.TITLE_INDEX_NAME));
<abbr title=" 377             query.include(new Query.FullTextSnippet(Note.CONTENT_PREVIEW_INDEX_NAME, Note.CONTENT_PROPERTY));"> 377             query.include(new Query.FullTextSnippet(Note.CONTENT_PREVIEW_INDEX_NAME, Note.CONTENT_PROPERTðŸ”µ</abbr>
 378         } else {
 379             query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 380         }
 381         query.include(Note.PINNED_INDEX_NAME);
 382         sortNoteQuery(query);
 383         return query.execute();
 384     }
 385 
 386     public void addNote() {
 387         // Prevents jarring &#x27;New note...&#x27; from showing in the list view when creating a new note
 388         NotesActivity notesActivity = ((NotesActivity) (getActivity()));
 389         if (!notesActivity.isLargeScreenLandscape()) {
 390             notesActivity.stopListeningToNotesBucket();
 391         }
 392         // Create &amp; save new note
 393         Simplenote simplenote = ((Simplenote) (getActivity().getApplication()));
 394         Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 395         Note note = notesBucket.newObject();
 396         note.setCreationDate(Calendar.getInstance());
 397         note.setModificationDate(note.getCreationDate());
 398         if ((notesActivity.getSelectedTag() != null) &amp;&amp; (notesActivity.getSelectedTag().name != null)) {
 399             String tagName = notesActivity.getSelectedTag().name;
<abbr title=" 400             if ((!tagName.equals(getString(R.string.notes))) &amp;&amp; (!tagName.equals(getString(R.string.trash)))) {"> 400             if ((!tagName.equals(getString(R.string.notes))) &amp;&amp; (!tagName.equals(getString(R.string.trashðŸ”µ</abbr>
 401                 note.setTagString(tagName);
 402             }
 403         }
 404         note.save();
<abbr title=" 405 // nbradbury - call onNoteSelected() directly rather than using code below, since code below may not always select the correct note depending on user&#x27;s sort preference"> 405 // nbradbury - call onNoteSelected() directly rather than using code below, since code below may not alwaðŸ”µ</abbr>
 406         mCallbacks.onNoteSelected(note.getSimperiumKey(), true, null);
 407     }
 408 
 409     public void setNoteSelected(String selectedNoteID) {
 410         // Loop through notes and set note selected if found
 411         ObjectCursor&lt;Note&gt; cursor = (ObjectCursor&lt;Note&gt;)mNotesAdapter.getCursor();
 412         if (cursor == null || cursor.getCount() == 0)
 413             return;
 414         for(int i=0; i &lt; cursor.getCount(); i++) {
 415             cursor.moveToPosition(i);
 416             String noteKey = cursor.getSimperiumKey();
 417             if (noteKey != null &amp;&amp; noteKey.equals(selectedNoteID)) {
 418                 setActivatedPosition(i);
 419                 return;
 420             }
 421         }
 422 
 423         // Didn&#x27;t find the note, let&#x27;s try again after the cursor updates (see refreshListTask)
 424         mSelectedNoteId = selectedNoteID;
 425     }
 426 
 427     public class NotesCursorAdapter extends CursorAdapter {
 428         private ObjectCursor&lt;Note&gt; mCursor;
 429 
<abbr title=" 430         private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(), R.attr.listSearchHighlightForegroundColor, R.attr.listSearchHighlightBackgroundColor);"> 430         private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(ðŸ”µ</abbr>
 431 
 432         public NotesCursorAdapter(Context context, ObjectCursor&lt;Note&gt; c, int flags) {
 433             super(context, c, flags);
 434             mCursor = c;
 435         }
 436 
 437         public void changeCursor(ObjectCursor&lt;Note&gt; cursor){
 438             mCursor = cursor;
 439             super.changeCursor(cursor);
 440         }
 441 
 442         @Override
 443         public Note getItem(int position) {
 444             mCursor.moveToPosition(position);
 445             return mCursor.getObject();
 446         }
 447 
 448         /*
 449         *  nbradbury - implemented &quot;holder pattern&quot; to boost performance with large note lists
 450         */
 451         @Override
 452         public View getView(int position, View view, ViewGroup parent) {
 453             NoteViewHolder holder;
 454             if (view == null) {
 455                 view = View.inflate(getActivity().getBaseContext(), R.layout.note_list_row, null);
 456                 holder = new NoteViewHolder();
 457                 holder.titleTextView = ((TextView) (view.findViewById(R.id.note_title)));
<abbr title=" 458                 holder.titleTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 458                 holder.titleTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), SimplenoteðŸ”µ</abbr>
 459                 holder.contentTextView = ((TextView) (view.findViewById(R.id.note_content)));
<abbr title=" 460                 holder.contentTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 460                 holder.contentTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), SimplenoðŸ”µ</abbr>
 461                 holder.pinImageView = ((ImageView) (view.findViewById(R.id.note_pin)));
 462                 view.setTag(holder);
 463             } else {
 464                 holder = ((NoteViewHolder) (view.getTag()));
 465             }
 466             if (position == getListView().getCheckedItemPosition()) {
 467                 view.setActivated(true);
 468             } else {
 469                 view.setActivated(false);
 470             }
 471             // for performance reasons we are going to get indexed values
 472             // from the cursor instead of instantiating the entire bucket object
 473             holder.contentTextView.setVisibility(View.VISIBLE);
 474             holder.contentTextView.setMaxLines(mNumPreviewLines);
 475             mCursor.moveToPosition(position);
 476             holder.setNoteId(mCursor.getSimperiumKey());
 477             int pinned = mCursor.getInt(mCursor.getColumnIndex(Note.PINNED_INDEX_NAME));
 478             holder.pinImageView.setVisibility(pinned == 1 ? View.VISIBLE : View.GONE);
 479             String title = mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME));
 480             if ((title == null) || title.equals(&quot;&quot;)) {
 481                 SpannableString untitled = new SpannableString(getString(R.string.new_note_list));
<abbr title=" 482                 untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0, untitled.length(), 0x0);"> 482                 untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0ðŸ”µ</abbr>
 483                 holder.titleTextView.setText(untitled);
 484             } else {
 485                 holder.titleTextView.setText(title);
 486             }
 487             holder.matchOffsets = null;
 488             if (hasSearchQuery()) {
<abbr title=" 489                 String snippet = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));"> 489                 String snippet = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAMEðŸ”µ</abbr>
 490                 holder.matchOffsets = mCursor.getString(mCursor.getColumnIndex(&quot;match_offsets&quot;));
<abbr title=" 491                 holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlighter));"> 491                 holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlðŸ”µ</abbr>
<abbr title=" 492                 holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlighter));"> 492                 holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlightðŸ”µ</abbr>
 493             } else if (mNumPreviewLines &gt; 0) {
<abbr title=" 494                 String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));"> 494                 String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDðŸ”µ</abbr>
<abbr title=" 495                 if (((title == null) || title.equals(contentPreview)) || title.equals(getString(R.string.new_note_list))) {"> 495                 if (((title == null) || title.equals(contentPreview)) || title.equals(getString(R.string.ðŸ”µ</abbr>
 496                     holder.contentTextView.setVisibility(View.GONE);
 497                 } else {
 498                     holder.contentTextView.setText(contentPreview);
 499                 }
 500             }
 501             return view;
 502         }
 503 
 504         @Override
 505         public View newView(Context context, Cursor cursor, ViewGroup viewGroup) {
 506             return null;
 507         }
 508 
 509         @Override
 510         public void bindView(View view, Context context, Cursor cursor) {
 511 
 512         }
 513     }
 514 
 515 // view holder for NotesCursorAdapter
 516     private static class NoteViewHolder {
 517 TextView titleTextView;
 518 
 519 TextView contentTextView;
 520 
 521 ImageView pinImageView;
 522 
 523         public String matchOffsets;
 524 
 525         private String mNoteId;
 526 
 527         public void setNoteId(String noteId) {
 528             mNoteId = noteId;
 529         }
 530 
 531         public String getNoteId() {
 532             return mNoteId;
 533         }
 534     }
 535 
 536 public void searchNotes(String searchString) {
 537        if (!searchString.equals(mSearchString)){
 538            mSearchString = searchString;
 539            refreshList();
 540        }
 541 }
 542 
 543     /**
 544      * Clear search and load all notes
 545      */
 546     public void clearSearch() {
 547         if (mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;)){
 548             mSearchString = null;
 549             refreshList();
 550         }
 551     }
 552 
 553     public boolean hasSearchQuery() {
 554         return (mSearchString != null) &amp;&amp; (!mSearchString.equals(&quot;&quot;));
 555     }
 556 
 557     public void sortNoteQuery(Query&lt;Note&gt; noteQuery){
 558         noteQuery.order(&quot;pinned&quot;, SortType.DESCENDING);
 559     		int sortPref = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_SORT_ORDER);
 560     		switch (sortPref) {
 561         case 0:
 562             noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.DESCENDING);
 563             break;
 564     		case 1:
 565             noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.ASCENDING);
 566     			break;
 567     		case 2:
 568             noteQuery.order(Note.CREATED_INDEX_NAME, SortType.DESCENDING);
 569     			break;
 570     		case 3:
 571             noteQuery.order(Note.CREATED_INDEX_NAME, SortType.ASCENDING);
 572     			break;
 573     		case 4:
 574             noteQuery.order(Note.CONTENT_PROPERTY, SortType.ASCENDING);
 575     			break;
 576     		case 5:
 577             noteQuery.order(Note.CONTENT_PROPERTY, SortType.DESCENDING);
 578     			break;
 579     		}
 580     }
 581 
 582     private class refreshListTask extends AsyncTask&lt;Boolean, Void, ObjectCursor&lt;Note&gt;&gt; {
 583         boolean mIsFromNavSelect;
 584 
 585         @Override
 586         protected ObjectCursor&lt;Note&gt; doInBackground(Boolean ... args) {
 587             mIsFromNavSelect = args[0];
 588             return queryNotes();
 589         }
 590 
 591         @Override
 592         protected void onPostExecute(ObjectCursor&lt;Note&gt; cursor) {
 593             if ((getActivity() == null) || getActivity().isFinishing()) {
 594                 return;
 595             }
<abbr title=" 596             // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error and clear the cursor"> 596             // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error anðŸ”µ</abbr>
 597             int count = 0;
 598             try {
 599                 mNotesAdapter.changeCursor(cursor);
 600                 count = mNotesAdapter.getCount();
 601             } catch (SQLiteException e) {
 602                 count = 0;
 603                 android.util.Log.e(Simplenote.TAG, &quot;Invalid SQL statement&quot;, e);
 604                 mNotesAdapter.changeCursor(null);
 605             }
 606             NotesActivity notesActivity = ((NotesActivity) (getActivity()));
 607             if (notesActivity != null) {
 608                 if (mIsFromNavSelect &amp;&amp; notesActivity.isLargeScreenLandscape()) {
 609                     if (count == 0) {
 610                         notesActivity.showDetailPlaceholder();
 611                     } else {
 612                         // Select the first note
 613                         selectFirstNote();
 614                     }
 615                 }
 616                 notesActivity.updateTrashMenuItem();
 617             }
 618             if (mSelectedNoteId != null) {
 619                 setNoteSelected(mSelectedNoteId);
 620                 mSelectedNoteId = null;
 621             }
 622         }
 623     }
 624 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.ListFragment;
   5  import android.content.Context;
   6  import android.content.SharedPreferences;
   7  import android.database.Cursor;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   8 +import android.database.sqlite.SQLiteException;</span>
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;
  11  import android.os.Handler;
  12  import android.preference.PreferenceManager;
  13  import android.text.Html;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 +import android.text.SpannableString;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 +import android.text.style.TextAppearanceSpan;</span>
  16  import android.util.SparseBooleanArray;
  17  import android.util.TypedValue;
  18  import android.view.ActionMode;
  19  import android.view.LayoutInflater;
  20  import android.view.Menu;
  21  import android.view.MenuInflater;
  22  import android.view.MenuItem;
  23  import android.view.View;
  24  import android.view.ViewGroup;
  25  import android.widget.AbsListView;
  26  import android.widget.AdapterView;
  27  import android.widget.Button;
  28  import android.widget.CursorAdapter;
  29  import android.widget.ImageView;
  30  import android.widget.LinearLayout;
  31  import android.widget.ListView;
  32  import android.widget.TextView;
  33  import android.widget.ViewSwitcher;
  34  
  35  import com.automattic.simplenote.models.Note;
  36  import com.automattic.simplenote.utils.PrefUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import com.automattic.simplenote.utils.SearchSnippetFormatter;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import com.automattic.simplenote.utils.SearchTokenizer;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +import com.automattic.simplenote.utils.TextHighlighter;</span>
  40  import com.automattic.simplenote.utils.Typefaces;
  41  import com.simperium.client.Bucket;
  42  import com.simperium.client.Bucket.ObjectCursor;
  43  import com.simperium.client.Query;
  44  import com.simperium.client.Query.SortType;
  45  
  46  import java.util.ArrayList;
  47  import java.util.Calendar;
  48  import java.util.List;
  49  
  50  /**
  51   * A list fragment representing a list of Notes. This fragment also supports
  52   * tablet devices by allowing list items to be given an &#x27;activated&#x27; state upon
  53   * selection. This helps indicate which item is currently being viewed in a
  54   * {@link NoteEditorFragment}.
  55   * &lt;p&gt;
  56   * Activities containing this fragment MUST implement the {@link Callbacks}
  57   * interface.
  58   */
<abbr title="  59  public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsListView.MultiChoiceModeListener, ActionMode.Callback {">  59  public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsListView.MulðŸ”µ</abbr>
  60  
  61      private ActionMode mActionMode;

  62  
  63  	private NotesCursorAdapter mNotesAdapter;
  64      private TextView mEmptyListTextView;
  65      private LinearLayout mDividerShadow;
  66  	private int mNumPreviewLines;
  67      private String mSearchString;
  68      private ViewSwitcher mWelcomeViewSwitcher;
  69      private String mSelectedNoteId;
  70  
  71  	/**
  72  	 * The preferences key representing the activated item position. Only used on tablets.
  73  	 */
  74  	private static final String STATE_ACTIVATED_POSITION = &quot;activated_position&quot;;
  75      private static final String TAG_BUTTON_SIGNIN = &quot;sign_in&quot;;
  76      private static final String TAG_BUTTON_SIGNUP = &quot;sign_up&quot;;
  77  
  78  	/**
  79  	 * The fragment&#x27;s current callback object, which is notified of list item
  80  	 * clicks.
  81  	 */
  82  	private Callbacks mCallbacks = sCallbacks;
  83  
  84  	/**
  85  	 * The current activated item position. Only used on tablets.
  86  	 */
  87  	private int mActivatedPosition = ListView.INVALID_POSITION;
  88  
  89      public void setEmptyListViewClickable(boolean isClickable) {
  90          if (mEmptyListTextView != null) {
  91              mEmptyListTextView.setClickable(isClickable);
  92          }
  93      }
  94  
  95      @Override
  96      public boolean onItemLongClick(AdapterView&lt;?&gt; adapterView, View view, int position, long l) {
  97          getListView().setChoiceMode(ListView.CHOICE_MODE_MULTIPLE_MODAL);
  98          getListView().setItemChecked(position, true);
  99          if (mActionMode == null)
 100              getActivity().startActionMode(this);
 101          return true;
 102      }
 103  
 104      @Override
 105      public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 106          MenuInflater inflater = actionMode.getMenuInflater();
 107          inflater.inflate(R.menu.bulk_edit_tags, menu);
 108          mActionMode = actionMode;
 109          return true;
 110      }
 111  
 112      @Override
 113      public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 114          return false;
 115      }
 116  
 117      @Override
 118      public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 119          if (getListView().getCheckedItemIds().length &gt; 0 &amp;&amp; item.getItemId() == R.id.menu_delete)
 120              new trashNotesTask().execute();
 121          return false;
 122      }
 123  
 124      @Override
 125      public void onDestroyActionMode(ActionMode mode) {
 126  
 127      }
 128  
 129      @Override
 130      public void onItemCheckedStateChanged(ActionMode actionMode, int position, long id, boolean checked) {
 131          int checkedCount = getListView().getCheckedItemCount();
 132          if (checkedCount == 0)
 133              actionMode.setTitle(&quot;&quot;);
 134          else
<abbr title=" 135              actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, checkedCount));"> 135              actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, checkedCoðŸ”µ</abbr>
 136      }
 137  
 138      /**
 139  	 * A callback interface that all activities containing this fragment must
 140  	 * implement. This mechanism allows activities to be notified of item
 141  	 * selections.
 142  	 */
 143  	public interface Callbacks {
 144  		/**
 145  		 * Callback for when a note has been selected.
 146  		 */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -		public void onNoteSelected(String noteID, boolean isNew);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +		public void onNoteSelected(String noteID, boolean isNew, String matchOffsets);</span>
 149  	}
 150  
 151  	/**
 152  	 * A dummy implementation of the {@link Callbacks} interface that does
 153  	 * nothing. Used only when this fragment is not attached to an activity.
 154  	 */
 155  	private static Callbacks sCallbacks = new Callbacks() {
 156  		@Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -		public void onNoteSelected(String noteID, boolean isNew) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +		public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {</span>
 159  		}
 160  	};
 161  
 162  	/**
 163  	 * Mandatory empty constructor for the fragment manager to instantiate the
 164  	 * fragment (e.g. upon screen orientation changes).
 165  	 */
 166  	public NoteListFragment() {
 167  	}
 168  
 169  	@Override
 170  	public void onCreate(Bundle savedInstanceState) {
 171  		super.onCreate(savedInstanceState);
 172  
 173  		Simplenote application = (Simplenote) getActivity().getApplication();
 174  
 175  		mNotesAdapter = new NotesCursorAdapter(getActivity().getBaseContext(), null, 0);
 176  		setListAdapter(mNotesAdapter);
 177  
 178  	}
 179  
 180      @Override
 181      public void onActivityCreated(Bundle savedInstanceState) {
 182          super.onActivityCreated(savedInstanceState);
 183  
 184      }
 185  
 186      // nbradbury - load values from preferences
 187  	protected void getPrefs() {
 188          boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, false);
 189  		mNumPreviewLines = (condensedList) ? 0 : 2;
 190  	}
 191  
 192      @Override
 193      public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)
 194      {
 195          View view = inflater.inflate(R.layout.notes_list, container, false);
 196          return view;
 197      }
 198  
 199  	@Override
 200  	public void onViewCreated(View view, Bundle savedInstanceState) {
 201  		super.onViewCreated(view, savedInstanceState);
 202  
 203          NotesActivity notesActivity = (NotesActivity)getActivity();
 204  
 205          LinearLayout emptyView = (LinearLayout)view.findViewById(android.R.id.empty);
 206          emptyView.setVisibility(View.GONE);
 207          mEmptyListTextView = (TextView)view.findViewById(R.id.empty_message);
 208          mEmptyListTextView.setOnClickListener(new View.OnClickListener() {
 209              @Override
 210              public void onClick(View v) {
 211                  addNote();
 212              }
 213          });
<abbr title=" 214          setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 214          setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getðŸ”µ</abbr>
 215          mDividerShadow = (LinearLayout)view.findViewById(R.id.divider_shadow);
 216          mWelcomeViewSwitcher = (ViewSwitcher)view.findViewById(R.id.welcome_view_switcher);
 217  
 218          TextView welcomeTextView = (TextView)view.findViewById(R.id.welcome_textview);
<abbr title=" 219          welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.use_simplenote_account) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 219          welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.ðŸ”µ</abbr>
 220          TextView laterTextView = (TextView)view.findViewById(R.id.welcome_later_textview);
<abbr title=" 221          laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_try_app) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 221          laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_trðŸ”µ</abbr>
 222  
 223          Button signInButton = (Button)view.findViewById(R.id.welcome_sign_in);
 224          signInButton.setTag(TAG_BUTTON_SIGNIN);
 225          signInButton.setOnClickListener(signInClickListener);
 226          Button signUpButton = (Button)view.findViewById(R.id.welcome_sign_up);
 227          signUpButton.setTag(TAG_BUTTON_SIGNUP);
 228          signUpButton.setOnClickListener(signInClickListener);
 229  
 230          // Set custom typeface
 231          mEmptyListTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 232          welcomeTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 233          laterTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 234          signInButton.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 235          signUpButton.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 236  
 237          if (notesActivity.isLargeScreenLandscape()) {
 238              setActivateOnItemClick(true);
 239              mDividerShadow.setVisibility(View.VISIBLE);
 240          }
 241  
 242          welcomeTextView.setOnClickListener(new View.OnClickListener() {
 243              @Override
 244              public void onClick(View v) {
 245                  mWelcomeViewSwitcher.showNext();
 246              }
 247          });
 248          laterTextView.setOnClickListener(new View.OnClickListener() {
 249              @Override
 250              public void onClick(View v) {
 251                  mWelcomeViewSwitcher.showNext();
 252                  SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivity());
 253                  SharedPreferences.Editor editor = preferences.edit();
 254                  editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 255                  editor.commit();
 256              }
 257          });
 258  
 259          getListView().setOnItemLongClickListener(this);
 260          getListView().setMultiChoiceModeListener(this);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -        getListView().setDivider(getResources().getDrawable(R.drawable.list_divider));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -        getListView().setDividerHeight(1);</span>
 263  	}
 264  
 265  	@Override
 266  	public void onAttach(Activity activity) {
 267  		super.onAttach(activity);
 268  
 269  		// Activities containing this fragment must implement its callbacks.
 270  		if (!(activity instanceof Callbacks)) {
 271  			throw new IllegalStateException(&quot;Activity must implement fragment&#x27;s callbacks.&quot;);
 272  		}
 273  
 274  		mCallbacks = (Callbacks) activity;
 275  	}
 276  
 277  	@Override
 278  	public void onResume() {
 279  		super.onResume();
 280          getPrefs();
 281  
 282          setWelcomeViewVisibility();
 283  
 284          refreshList();
 285  
 286          if (!PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_APP_TRIAL, false)) {
 287              new Handler().postDelayed(new Runnable() {
 288                  @Override
 289                  public void run() {
 290                      mWelcomeViewSwitcher.showNext();
 291                  }
 292              }, 100);
 293          }
 294  	}
 295  
 296      public void setWelcomeViewVisibility() {
 297          if (mWelcomeViewSwitcher != null &amp;&amp; getActivity() != null) {
 298              Simplenote currentApp = (Simplenote) getActivity().getApplication();
 299              if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 300                  int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().getDisplayMetrics());"> 300                  int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().ðŸ”µ</abbr>
 301                  ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();
 302                  mlp.setMargins(0, 0, 0, bottomMargin);
 303                  getListView().getEmptyView().setLayoutParams(mlp);
 304                  mWelcomeViewSwitcher.setVisibility(View.VISIBLE);
 305              } else {
 306                  mWelcomeViewSwitcher.setVisibility(View.GONE);
 307                  ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();
 308                  mlp.setMargins(0, 0, 0, 0);
 309                  getListView().getEmptyView().setLayoutParams(mlp);
 310              }
 311          }
 312      }
 313  
 314      public void hideWelcomeView() {
 315          if (mWelcomeViewSwitcher != null)
 316              mWelcomeViewSwitcher.setVisibility(View.GONE);
 317      }
 318  
 319      private Button.OnClickListener signInClickListener = new Button.OnClickListener() {
 320          @Override
 321          public void onClick(View v) {
<abbr title=" 322              ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? true : false);"> 322              ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? true : false)ðŸ”µ</abbr>
 323          }
 324      };
 325  
 326  	@Override
 327  	public void onDetach() {
 328  		super.onDetach();
 329  
 330  		// Reset the active callbacks interface to the dummy implementation.
 331  		mCallbacks = sCallbacks;
 332  	}
 333  
 334      @Override
 335      public void onDestroy(){
 336          super.onDestroy();
 337      }
 338  
 339      public void setEmptyListMessage(String message) {
 340          if (mEmptyListTextView != null &amp;&amp; message != null)
 341              mEmptyListTextView.setText(Html.fromHtml(message));
 342      }
 343  
 344  	@Override
 345  	public void onListItemClick(ListView listView, View view, int position, long id) {
 346  		super.onListItemClick(listView, view, position, id);
 347  
 348          NoteViewHolder holder = (NoteViewHolder)view.getTag();
 349          String noteID = holder.getNoteId();
 350          if (noteID != null)
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -            mCallbacks.onNoteSelected(noteID, false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +            mCallbacks.onNoteSelected(noteID, false, holder.matchOffsets);</span>
 353  
 354          mActivatedPosition = position;
 355  	}
 356  
 357      /**
 358       * Selects first row in the list if available
 359       */
 360      public void selectFirstNote() {
 361          if (mNotesAdapter.getCount() &gt; 0) {
 362              Note selectedNote = mNotesAdapter.getItem(0);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -            mCallbacks.onNoteSelected(selectedNote.getSimperiumKey(), false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +            mCallbacks.onNoteSelected(selectedNote.getSimperiumKey(), false, null);</span>
 365          }
 366      }
 367  
 368      @Override
 369      public void onSaveInstanceState(Bundle outState) {
 370          super.onSaveInstanceState(outState);
 371          if (mActivatedPosition != ListView.INVALID_POSITION) {
 372              // Serialize and persist the activated item position.
 373              outState.putInt(STATE_ACTIVATED_POSITION, mActivatedPosition);
 374          }
 375      }
 376  
 377  	/**
 378  	 * Turns on activate-on-click mode. When this mode is on, list items will be
 379  	 * given the &#x27;activated&#x27; state when touched.
 380  	 */
 381  	public void setActivateOnItemClick(boolean activateOnItemClick) {
 382  		// When setting CHOICE_MODE_SINGLE, ListView will automatically
 383  		// give items the &#x27;activated&#x27; state when touched.
 384  		getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NONE);
 385  	}
 386  
 387  	public void setActivatedPosition(int position) {
 388          if (getListView() != null) {
 389              if (position == ListView.INVALID_POSITION) {
 390                  getListView().setItemChecked(mActivatedPosition, false);
 391              } else {
 392                  getListView().setItemChecked(position, true);
 393              }
 394  
 395              mActivatedPosition = position;
 396          }
 397  	}
 398  
 399      public void setDividerVisible(boolean visible) {
 400          if (visible)
 401              mDividerShadow.setVisibility(View.VISIBLE);
 402          else
 403              mDividerShadow.setVisibility(View.GONE);
 404      }
 405  
 406  	public void refreshList() {
 407          new refreshListTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, false);
 408  	}
 409  
 410      public void refreshListFromNavSelect() {
 411          new refreshListTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, true);
 412      }
 413  
 414      public ObjectCursor&lt;Note&gt; queryNotes(){
 415          NotesActivity notesActivity = (NotesActivity)getActivity();
 416          Query&lt;Note&gt; query = notesActivity.getSelectedTag().query();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -        if (mSearchString != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -            query.where(Note.CONTENT_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%%%s%%&quot;, mSearchString));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 420 -        query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME, Note.PINNED_INDEX_NAME, Note.MODIFICATION_DATE_PROPERTY);"> 420 -        query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME, Note.PINNED_INDEX_NAME, Note.MODIFICðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 421 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +        if (hasSearchQuery()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +            query.where(new Query.FullTextMatch(new SearchTokenizer(mSearchString)));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 424 +            query.include(new Query.FullTextOffsets(&quot;match_offsets&quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 425 +            query.include(new Query.FullTextSnippet(Note.TITLE_INDEX_NAME, Note.TITLE_INDEX_NAME));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 426 +            query.include(new Query.FullTextSnippet(Note.CONTENT_PREVIEW_INDEX_NAME, Note.CONTENT_PROPERTY));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 427 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 428 +            query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 429 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 430 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 431 +        query.include(Note.PINNED_INDEX_NAME);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 432 +</span>
 433          sortNoteQuery(query);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 434 +</span>
 435          return query.execute();
 436      }
 437  
 438  	public void addNote() {
 439  
 440          // Prevents jarring &#x27;New note...&#x27; from showing in the list view when creating a new note
 441          NotesActivity notesActivity = (NotesActivity)getActivity();
 442          if (!notesActivity.isLargeScreenLandscape())
 443              notesActivity.stopListeningToNotesBucket();
 444  
 445  		// Create &amp; save new note
 446  		Simplenote simplenote = (Simplenote) getActivity().getApplication();
 447  		Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 448  		Note note = notesBucket.newObject();
 449          note.setCreationDate(Calendar.getInstance());
 450          note.setModificationDate(note.getCreationDate());
 451  
 452          if (notesActivity.getSelectedTag() != null &amp;&amp; notesActivity.getSelectedTag().name != null) {
 453              String tagName = notesActivity.getSelectedTag().name;
 454              if (!tagName.equals(getString(R.string.notes)) &amp;&amp; !tagName.equals(getString(R.string.trash)))
 455                  note.setTagString(tagName);
 456          }
 457  
 458  		note.save();
 459  
<abbr title=" 460  		// nbradbury - call onNoteSelected() directly rather than using code below, since code below may not always select the correct note depending on user&#x27;s sort preference"> 460  		// nbradbury - call onNoteSelected() directly rather than using code below, since code below may not always seleðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -		mCallbacks.onNoteSelected(note.getSimperiumKey(), true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 462 +		mCallbacks.onNoteSelected(note.getSimperiumKey(), true, null);</span>
 463  	}
 464  
 465      public void setNoteSelected(String selectedNoteID) {
 466          // Loop through notes and set note selected if found
 467          ObjectCursor&lt;Note&gt; cursor = (ObjectCursor&lt;Note&gt;)mNotesAdapter.getCursor();
 468          if (cursor == null || cursor.getCount() == 0)
 469              return;
 470          for(int i=0; i &lt; cursor.getCount(); i++) {
 471              cursor.moveToPosition(i);
 472              String noteKey = cursor.getSimperiumKey();
 473              if (noteKey != null &amp;&amp; noteKey.equals(selectedNoteID)) {
 474                  setActivatedPosition(i);
 475                  return;
 476              }
 477          }
 478  
 479          // Didn&#x27;t find the note, let&#x27;s try again after the cursor updates (see refreshListTask)
 480          mSelectedNoteId = selectedNoteID;
 481      }
 482  
 483  	public class NotesCursorAdapter extends CursorAdapter {
 484          private ObjectCursor&lt;Note&gt; mCursor;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 485 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 486 +        private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 487 +            R.attr.listSearchHighlightForegroundColor, R.attr.listSearchHighlightBackgroundColor);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 488 +</span>
 489          public NotesCursorAdapter(Context context, ObjectCursor&lt;Note&gt; c, int flags) {
 490              super(context, c, flags);
 491              mCursor = c;
 492          }
 493  
 494          public void changeCursor(ObjectCursor&lt;Note&gt; cursor){
 495              mCursor = cursor;
 496              super.changeCursor(cursor);
 497          }
 498  
 499          @Override
 500          public Note getItem(int position) {
 501              mCursor.moveToPosition(position);
 502              return mCursor.getObject();
 503          }
 504  
 505          /*
 506          *  nbradbury - implemented &quot;holder pattern&quot; to boost performance with large note lists
 507          */
 508  		@Override
 509  		public View getView(int position, View view, ViewGroup parent) {
 510  
 511  			NoteViewHolder holder;
 512  			if (view == null) {
 513  				view = View.inflate(getActivity().getBaseContext(), R.layout.note_list_row, null);
 514  				holder = new NoteViewHolder();
 515  				holder.titleTextView = (TextView) view.findViewById(R.id.note_title);
<abbr title=" 516                  holder.titleTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 516                  holder.titleTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FðŸ”µ</abbr>
 517  				holder.contentTextView = (TextView) view.findViewById(R.id.note_content);
<abbr title=" 518                  holder.contentTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 518                  holder.contentTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOMðŸ”µ</abbr>
 519  				holder.pinImageView = (ImageView) view.findViewById(R.id.note_pin);
 520  				view.setTag(holder);
 521  			} else {
 522  				holder = (NoteViewHolder) view.getTag();
 523  			}
 524  
 525              if (position == getListView().getCheckedItemPosition())
 526                  view.setActivated(true);
 527              else
 528                  view.setActivated(false);
 529  
 530              // for performance reasons we are going to get indexed values
 531              // from the cursor instead of instantiating the entire bucket object
 532              holder.contentTextView.setVisibility(View.VISIBLE);
 533              holder.contentTextView.setMaxLines(mNumPreviewLines);
 534              mCursor.moveToPosition(position);
 535              holder.setNoteId(mCursor.getSimperiumKey());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 536 -            int pinned = mCursor.getInt(mCursor.getColumnIndex(&quot;pinned&quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 537 +            int pinned = mCursor.getInt(mCursor.getColumnIndex(Note.PINNED_INDEX_NAME));</span>
 538              holder.pinImageView.setVisibility(pinned == 1 ? View.VISIBLE : View.GONE);
 539  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 540 -            String title = mCursor.getString(mCursor.getColumnIndex(&quot;title&quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 541 +            String title = mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 542 +</span>
 543              if (title == null || title.equals(&quot;&quot;)) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 544 -                title = getString(R.string.new_note_list);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 545 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 546 -            holder.titleTextView.setText(title);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 547 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 548 -            if (mNumPreviewLines &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 549 -                String contentPreview = mCursor.getString(mCursor.getColumnIndex(&quot;contentPreview&quot;));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 550 -                if (title.equals(contentPreview) || title.equals(getString(R.string.new_note_list)))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 551 +                SpannableString untitled = new SpannableString(getString(R.string.new_note_list));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 552 +                untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0, untitled.length(), 0x0);"> 552 +                untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0, untitleðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 553 +                holder.titleTextView.setText(untitled);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 554 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 555 +                holder.titleTextView.setText(title);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 556 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 557 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 558 +            holder.matchOffsets = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 559 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 560 +            if (hasSearchQuery()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 561 +                String snippet = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 562 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 563 +                holder.matchOffsets = mCursor.getString(mCursor.getColumnIndex(&quot;match_offsets&quot;));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 564 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 565 +                holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlighter));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 566 +                holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlighter));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 567 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 568 +            } else if (mNumPreviewLines &gt; 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 569 +                String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));"> 569 +                String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME))ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 570 +                if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_note_list)))"> 570 +                if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_note_listðŸ”µ</abbr></span>
 571                      holder.contentTextView.setVisibility(View.GONE);
 572                  else
 573                      holder.contentTextView.setText(contentPreview);
 574              }
 575  
 576  			return view;
 577  		}
 578  
 579          @Override
 580          public View newView(Context context, Cursor cursor, ViewGroup viewGroup) {
 581              return null;
 582          }
 583  
 584          @Override
 585          public void bindView(View view, Context context, Cursor cursor) {
 586  
 587          }
 588  
 589  	}
 590  
 591  	// view holder for NotesCursorAdapter
 592  	private static class NoteViewHolder {
 593  		TextView titleTextView;
 594  		TextView contentTextView;
 595  		ImageView pinImageView;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 596 +        public String matchOffsets;</span>
 597          private String mNoteId;
 598  
 599          public void setNoteId(String noteId) {
 600              mNoteId = noteId;
 601          }
 602  
 603          public String getNoteId() {
 604              return mNoteId;
 605          }
 606  	}
 607  
 608  	public void searchNotes(String searchString) {
 609          if (!searchString.equals(mSearchString)){
 610              mSearchString = searchString;
 611              refreshList();
 612          }
 613  	}
 614  
 615      /**
 616       * Clear search and load all notes
 617       */
 618      public void clearSearch() {
 619          if (mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;)){
 620              mSearchString = null;
 621              refreshList();
 622          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 623 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 624 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 625 +    public boolean hasSearchQuery(){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 626 +        return mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;);</span>
 627      }
 628  
 629      public void sortNoteQuery(Query&lt;Note&gt; noteQuery){
 630          noteQuery.order(&quot;pinned&quot;, SortType.DESCENDING);
 631  		int sortPref = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_SORT_ORDER);
 632  		switch (sortPref) {
 633          case 0:
 634              noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.DESCENDING);
 635              break;
 636  		case 1:
 637              noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.ASCENDING);
 638  			break;
 639  		case 2:
 640              noteQuery.order(Note.CREATED_INDEX_NAME, SortType.DESCENDING);
 641  			break;
 642  		case 3:
 643              noteQuery.order(Note.CREATED_INDEX_NAME, SortType.ASCENDING);
 644  			break;
 645  		case 4:
 646              noteQuery.order(Note.CONTENT_PROPERTY, SortType.ASCENDING);
 647  			break;
 648  		case 5:
 649              noteQuery.order(Note.CONTENT_PROPERTY, SortType.DESCENDING);
 650  			break;
 651  		}
 652      }
 653  
 654      private class refreshListTask extends AsyncTask&lt;Boolean, Void, ObjectCursor&lt;Note&gt;&gt; {
 655          boolean mIsFromNavSelect;
 656  
 657          @Override
 658          protected ObjectCursor&lt;Note&gt; doInBackground(Boolean ... args) {
 659              mIsFromNavSelect = args[0];
 660              return queryNotes();
 661          }
 662  
 663          @Override
 664          protected void onPostExecute(ObjectCursor&lt;Note&gt; cursor) {
 665              if (getActivity() == null || getActivity().isFinishing())
 666                  return;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 667 -            mNotesAdapter.changeCursor(cursor);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 668 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 669 +            // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error and clear the cursor"> 669 +            // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error and clear tðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 670 +            int count = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 671 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 672 +                mNotesAdapter.changeCursor(cursor);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 673 +                count = mNotesAdapter.getCount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 674 +            } catch (SQLiteException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 675 +                count = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 676 +                android.util.Log.e(Simplenote.TAG, &quot;Invalid SQL statement&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 677 +                mNotesAdapter.changeCursor(null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 678 +            }</span>
 679  
 680              NotesActivity notesActivity = (NotesActivity)getActivity();
 681              if (notesActivity != null) {
 682                  if (mIsFromNavSelect &amp;&amp; notesActivity.isLargeScreenLandscape()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 683 -                        if (mNotesAdapter.getCount() == 0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 684 +                        if (count == 0) {</span>
 685                              notesActivity.showDetailPlaceholder();
 686                          } else {
 687                              // Select the first note
 688                              selectFirstNote();
 689                          }
 690                  }
 691                  notesActivity.updateTrashMenuItem();
 692              }
 693  
 694              if (mSelectedNoteId != null) {
 695                  setNoteSelected(mSelectedNoteId);
 696                  mSelectedNoteId = null;
 697              }
 698          }
 699      }
 700  
 701      private class trashNotesTask extends AsyncTask&lt;Void, Void, Void&gt; {
 702  
 703          List&lt;String&gt; deletedNotesIds = new ArrayList&lt;String&gt;();
 704  
 705          @Override
 706          protected Void doInBackground(Void... args) {
 707              SparseBooleanArray selectedRows = getListView().getCheckedItemPositions();
 708              for (int i = 0; i &lt; selectedRows.size(); i++) {
 709                  if (selectedRows.valueAt(i) == true) {
 710                      Note deletedNote = mNotesAdapter.getItem(selectedRows.keyAt(i));
 711                      deletedNotesIds.add(deletedNote.getSimperiumKey());
 712                      deletedNote.setDeleted(!deletedNote.isDeleted());
 713                      deletedNote.setModificationDate(Calendar.getInstance());
 714                      deletedNote.save();
 715                  }
 716              }
 717  
 718              return null;
 719          }
 720  
 721          @Override
 722          protected void onPostExecute(Void aVoid) {
 723              NotesActivity notesActivity = ((NotesActivity) getActivity());
 724              if (notesActivity != null)
 725                  notesActivity.showUndoBarWithNoteIds(deletedNotesIds);
 726          }
 727      }
 728  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.ListFragment;
   5  import android.content.Context;
   6  import android.content.SharedPreferences;
   7  import android.database.Cursor;

   8  import android.os.AsyncTask;
   9  import android.os.Bundle;
  10  import android.os.Handler;
  11  import android.preference.PreferenceManager;
  12  import android.text.Html;


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 -import android.util.SparseBooleanArray;</span>
  14  import android.util.TypedValue;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 -import android.view.ActionMode;</span>
  16  import android.view.LayoutInflater;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 -import android.view.Menu;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -import android.view.MenuInflater;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -import android.view.MenuItem;</span>
  20  import android.view.View;
  21  import android.view.ViewGroup;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import android.widget.AbsListView;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import android.widget.AdapterView;</span>
  24  import android.widget.Button;
  25  import android.widget.CursorAdapter;
  26  import android.widget.ImageView;
  27  import android.widget.LinearLayout;
  28  import android.widget.ListView;
  29  import android.widget.TextView;
  30  import android.widget.ViewSwitcher;
  31  
  32  import com.automattic.simplenote.models.Note;
  33  import com.automattic.simplenote.utils.PrefUtils;



  34  import com.automattic.simplenote.utils.Typefaces;
  35  import com.simperium.client.Bucket;
  36  import com.simperium.client.Bucket.ObjectCursor;
  37  import com.simperium.client.Query;
  38  import com.simperium.client.Query.SortType;
  39  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import java.util.ArrayList;</span>
  41  import java.util.Calendar;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import java.util.List;</span>
  43  
  44  /**
  45   * A list fragment representing a list of Notes. This fragment also supports
  46   * tablet devices by allowing list items to be given an &#x27;activated&#x27; state upon
  47   * selection. This helps indicate which item is currently being viewed in a
  48   * {@link NoteEditorFragment}.
  49   * &lt;p&gt;
  50   * Activities containing this fragment MUST implement the {@link Callbacks}
  51   * interface.
  52   */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  53 -public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsListView.MultiChoiceModeListener, ActionMode.Callback {">  53 -public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsListView.MulðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -    private ActionMode mActionMode;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +public class NoteListFragment extends ListFragment {</span>
  57  
  58  	private NotesCursorAdapter mNotesAdapter;
  59      private TextView mEmptyListTextView;
  60      private LinearLayout mDividerShadow;
  61  	private int mNumPreviewLines;
  62      private String mSearchString;
  63      private ViewSwitcher mWelcomeViewSwitcher;
  64      private String mSelectedNoteId;
  65  
  66  	/**
  67  	 * The preferences key representing the activated item position. Only used on tablets.
  68  	 */
  69  	private static final String STATE_ACTIVATED_POSITION = &quot;activated_position&quot;;
  70      private static final String TAG_BUTTON_SIGNIN = &quot;sign_in&quot;;
  71      private static final String TAG_BUTTON_SIGNUP = &quot;sign_up&quot;;
  72  
  73  	/**
  74  	 * The fragment&#x27;s current callback object, which is notified of list item
  75  	 * clicks.
  76  	 */
  77  	private Callbacks mCallbacks = sCallbacks;
  78  
  79  	/**
  80  	 * The current activated item position. Only used on tablets.
  81  	 */
  82  	private int mActivatedPosition = ListView.INVALID_POSITION;
  83  
  84      public void setEmptyListViewClickable(boolean isClickable) {
  85          if (mEmptyListTextView != null) {
  86              mEmptyListTextView.setClickable(isClickable);
  87          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -    public boolean onItemLongClick(AdapterView&lt;?&gt; adapterView, View view, int position, long l) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        getListView().setChoiceMode(ListView.CHOICE_MODE_MULTIPLE_MODAL);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -        getListView().setItemChecked(position, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -        if (mActionMode == null)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -            getActivity().startActionMode(this);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -        return true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -    public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -        MenuInflater inflater = actionMode.getMenuInflater();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -        inflater.inflate(R.menu.bulk_edit_tags, menu);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -        mActionMode = actionMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        return true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -    public boolean onPrepareActionMode(ActionMode mode, Menu menu) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        return false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -    public boolean onActionItemClicked(ActionMode mode, MenuItem item) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -        if (getListView().getCheckedItemIds().length &gt; 0 &amp;&amp; item.getItemId() == R.id.menu_delete)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -            new trashNotesTask().execute();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -        return false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -    public void onDestroyActionMode(ActionMode mode) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -    public void onItemCheckedStateChanged(ActionMode actionMode, int position, long id, boolean checked) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -        int checkedCount = getListView().getCheckedItemCount();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -        if (checkedCount == 0)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -            actionMode.setTitle(&quot;&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        else</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 130 -            actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, checkedCount));"> 130 -            actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, checkedCoðŸ”µ</abbr></span>
 131      }
 132  
 133      /**
 134  	 * A callback interface that all activities containing this fragment must
 135  	 * implement. This mechanism allows activities to be notified of item
 136  	 * selections.
 137  	 */
 138  	public interface Callbacks {
 139  		/**
 140  		 * Callback for when a note has been selected.
 141  		 */
 142  		public void onNoteSelected(String noteID, boolean isNew);

 143  	}
 144  
 145  	/**
 146  	 * A dummy implementation of the {@link Callbacks} interface that does
 147  	 * nothing. Used only when this fragment is not attached to an activity.
 148  	 */
 149  	private static Callbacks sCallbacks = new Callbacks() {
 150  		@Override
 151  		public void onNoteSelected(String noteID, boolean isNew) {

 152  		}
 153  	};
 154  
 155  	/**
 156  	 * Mandatory empty constructor for the fragment manager to instantiate the
 157  	 * fragment (e.g. upon screen orientation changes).
 158  	 */
 159  	public NoteListFragment() {
 160  	}
 161  
 162  	@Override
 163  	public void onCreate(Bundle savedInstanceState) {
 164  		super.onCreate(savedInstanceState);
 165  
 166  		Simplenote application = (Simplenote) getActivity().getApplication();
 167  
 168  		mNotesAdapter = new NotesCursorAdapter(getActivity().getBaseContext(), null, 0);
 169  		setListAdapter(mNotesAdapter);
 170  
 171  	}
 172  
 173      @Override
 174      public void onActivityCreated(Bundle savedInstanceState) {
 175          super.onActivityCreated(savedInstanceState);
 176  
 177      }
 178  
 179      // nbradbury - load values from preferences
 180  	protected void getPrefs() {
 181          boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, false);
 182  		mNumPreviewLines = (condensedList) ? 0 : 2;
 183  	}
 184  
 185      @Override
 186      public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)
 187      {
 188          View view = inflater.inflate(R.layout.notes_list, container, false);
 189          return view;
 190      }
 191  
 192  	@Override
 193  	public void onViewCreated(View view, Bundle savedInstanceState) {
 194  		super.onViewCreated(view, savedInstanceState);
 195  
 196          NotesActivity notesActivity = (NotesActivity)getActivity();
 197  
 198          LinearLayout emptyView = (LinearLayout)view.findViewById(android.R.id.empty);
 199          emptyView.setVisibility(View.GONE);
 200          mEmptyListTextView = (TextView)view.findViewById(R.id.empty_message);
 201          mEmptyListTextView.setOnClickListener(new View.OnClickListener() {
 202              @Override
 203              public void onClick(View v) {
 204                  addNote();
 205              }
 206          });
<abbr title=" 207          setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 207          setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getðŸ”µ</abbr>
 208          mDividerShadow = (LinearLayout)view.findViewById(R.id.divider_shadow);
 209          mWelcomeViewSwitcher = (ViewSwitcher)view.findViewById(R.id.welcome_view_switcher);
 210  
 211          TextView welcomeTextView = (TextView)view.findViewById(R.id.welcome_textview);
<abbr title=" 212          welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.use_simplenote_account) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 212          welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.ðŸ”µ</abbr>
 213          TextView laterTextView = (TextView)view.findViewById(R.id.welcome_later_textview);
<abbr title=" 214          laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_try_app) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 214          laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_trðŸ”µ</abbr>
 215  
 216          Button signInButton = (Button)view.findViewById(R.id.welcome_sign_in);
 217          signInButton.setTag(TAG_BUTTON_SIGNIN);
 218          signInButton.setOnClickListener(signInClickListener);
 219          Button signUpButton = (Button)view.findViewById(R.id.welcome_sign_up);
 220          signUpButton.setTag(TAG_BUTTON_SIGNUP);
 221          signUpButton.setOnClickListener(signInClickListener);
 222  
 223          // Set custom typeface
 224          mEmptyListTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 225          welcomeTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 226          laterTextView.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 227          signInButton.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 228          signUpButton.setTypeface(Typefaces.get(getActivity(), Simplenote.CUSTOM_FONT_PATH));
 229  
 230          if (notesActivity.isLargeScreenLandscape()) {
 231              setActivateOnItemClick(true);
 232              mDividerShadow.setVisibility(View.VISIBLE);
 233          }
 234  
 235          welcomeTextView.setOnClickListener(new View.OnClickListener() {
 236              @Override
 237              public void onClick(View v) {
 238                  mWelcomeViewSwitcher.showNext();
 239              }
 240          });
 241          laterTextView.setOnClickListener(new View.OnClickListener() {
 242              @Override
 243              public void onClick(View v) {
 244                  mWelcomeViewSwitcher.showNext();
 245                  SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivity());
 246                  SharedPreferences.Editor editor = preferences.edit();
 247                  editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 248                  editor.commit();
 249              }
 250          });
 251  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -        getListView().setOnItemLongClickListener(this);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -        getListView().setMultiChoiceModeListener(this);</span>
 254          getListView().setDivider(getResources().getDrawable(R.drawable.list_divider));
 255          getListView().setDividerHeight(1);
 256  	}
 257  
 258  	@Override
 259  	public void onAttach(Activity activity) {
 260  		super.onAttach(activity);
 261  
 262  		// Activities containing this fragment must implement its callbacks.
 263  		if (!(activity instanceof Callbacks)) {
 264  			throw new IllegalStateException(&quot;Activity must implement fragment&#x27;s callbacks.&quot;);
 265  		}
 266  
 267  		mCallbacks = (Callbacks) activity;
 268  	}
 269  
 270  	@Override
 271  	public void onResume() {
 272  		super.onResume();
 273          getPrefs();
 274  
 275          setWelcomeViewVisibility();
 276  
 277          refreshList();
 278  
 279          if (!PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_APP_TRIAL, false)) {
 280              new Handler().postDelayed(new Runnable() {
 281                  @Override
 282                  public void run() {
 283                      mWelcomeViewSwitcher.showNext();
 284                  }
 285              }, 100);
 286          }
 287  	}
 288  
 289      public void setWelcomeViewVisibility() {
 290          if (mWelcomeViewSwitcher != null &amp;&amp; getActivity() != null) {
 291              Simplenote currentApp = (Simplenote) getActivity().getApplication();
 292              if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 293                  int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().getDisplayMetrics());"> 293                  int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().ðŸ”µ</abbr>
 294                  ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();
 295                  mlp.setMargins(0, 0, 0, bottomMargin);
 296                  getListView().getEmptyView().setLayoutParams(mlp);
 297                  mWelcomeViewSwitcher.setVisibility(View.VISIBLE);
 298              } else {
 299                  mWelcomeViewSwitcher.setVisibility(View.GONE);
 300                  ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();
 301                  mlp.setMargins(0, 0, 0, 0);
 302                  getListView().getEmptyView().setLayoutParams(mlp);
 303              }
 304          }
 305      }
 306  
 307      public void hideWelcomeView() {
 308          if (mWelcomeViewSwitcher != null)
 309              mWelcomeViewSwitcher.setVisibility(View.GONE);
 310      }
 311  
 312      private Button.OnClickListener signInClickListener = new Button.OnClickListener() {
 313          @Override
 314          public void onClick(View v) {
<abbr title=" 315              ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? true : false);"> 315              ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? true : false)ðŸ”µ</abbr>
 316          }
 317      };
 318  
 319  	@Override
 320  	public void onDetach() {
 321  		super.onDetach();
 322  
 323  		// Reset the active callbacks interface to the dummy implementation.
 324  		mCallbacks = sCallbacks;
 325  	}
 326  
 327      @Override
 328      public void onDestroy(){
 329          super.onDestroy();
 330      }
 331  
 332      public void setEmptyListMessage(String message) {
 333          if (mEmptyListTextView != null &amp;&amp; message != null)
 334              mEmptyListTextView.setText(Html.fromHtml(message));
 335      }
 336  
 337  	@Override
 338  	public void onListItemClick(ListView listView, View view, int position, long id) {
 339  		super.onListItemClick(listView, view, position, id);
 340  
 341          NoteViewHolder holder = (NoteViewHolder)view.getTag();
 342          String noteID = holder.getNoteId();
 343          if (noteID != null)
 344              mCallbacks.onNoteSelected(noteID, false);

 345  
 346          mActivatedPosition = position;
 347  	}
 348  
 349      /**
 350       * Selects first row in the list if available
 351       */
 352      public void selectFirstNote() {
 353          if (mNotesAdapter.getCount() &gt; 0) {
 354              Note selectedNote = mNotesAdapter.getItem(0);
 355              mCallbacks.onNoteSelected(selectedNote.getSimperiumKey(), false);

 356          }
 357      }
 358  
 359      @Override
 360      public void onSaveInstanceState(Bundle outState) {
 361          super.onSaveInstanceState(outState);
 362          if (mActivatedPosition != ListView.INVALID_POSITION) {
 363              // Serialize and persist the activated item position.
 364              outState.putInt(STATE_ACTIVATED_POSITION, mActivatedPosition);
 365          }
 366      }
 367  
 368  	/**
 369  	 * Turns on activate-on-click mode. When this mode is on, list items will be
 370  	 * given the &#x27;activated&#x27; state when touched.
 371  	 */
 372  	public void setActivateOnItemClick(boolean activateOnItemClick) {
 373  		// When setting CHOICE_MODE_SINGLE, ListView will automatically
 374  		// give items the &#x27;activated&#x27; state when touched.
 375  		getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NONE);
 376  	}
 377  
 378  	public void setActivatedPosition(int position) {
 379          if (getListView() != null) {
 380              if (position == ListView.INVALID_POSITION) {
 381                  getListView().setItemChecked(mActivatedPosition, false);
 382              } else {
 383                  getListView().setItemChecked(position, true);
 384              }
 385  
 386              mActivatedPosition = position;
 387          }
 388  	}
 389  
 390      public void setDividerVisible(boolean visible) {
 391          if (visible)
 392              mDividerShadow.setVisibility(View.VISIBLE);
 393          else
 394              mDividerShadow.setVisibility(View.GONE);
 395      }
 396  
 397  	public void refreshList() {
 398          new refreshListTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, false);
 399  	}
 400  
 401      public void refreshListFromNavSelect() {
 402          new refreshListTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, true);
 403      }
 404  
 405      public ObjectCursor&lt;Note&gt; queryNotes(){
 406          NotesActivity notesActivity = (NotesActivity)getActivity();
 407          Query&lt;Note&gt; query = notesActivity.getSelectedTag().query();
 408          if (mSearchString != null) {
 409              query.where(Note.CONTENT_PROPERTY, Query.ComparisonType.LIKE, String.format(&quot;%%%s%%&quot;, mSearchString));
 410          }
<abbr title=" 411          query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME, Note.PINNED_INDEX_NAME, Note.MODIFICATION_DATE_PROPERTY);"> 411          query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME, Note.PINNED_INDEX_NAME, Note.MODIFICðŸ”µ</abbr>












 412          sortNoteQuery(query);

 413          return query.execute();
 414      }
 415  
 416  	public void addNote() {
 417  
 418          // Prevents jarring &#x27;New note...&#x27; from showing in the list view when creating a new note
 419          NotesActivity notesActivity = (NotesActivity)getActivity();
 420          if (!notesActivity.isLargeScreenLandscape())
 421              notesActivity.stopListeningToNotesBucket();
 422  
 423  		// Create &amp; save new note
 424  		Simplenote simplenote = (Simplenote) getActivity().getApplication();
 425  		Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 426  		Note note = notesBucket.newObject();
 427          note.setCreationDate(Calendar.getInstance());
 428          note.setModificationDate(note.getCreationDate());
 429  
 430          if (notesActivity.getSelectedTag() != null &amp;&amp; notesActivity.getSelectedTag().name != null) {
 431              String tagName = notesActivity.getSelectedTag().name;
 432              if (!tagName.equals(getString(R.string.notes)) &amp;&amp; !tagName.equals(getString(R.string.trash)))
 433                  note.setTagString(tagName);
 434          }
 435  
 436  		note.save();
 437  
<abbr title=" 438  		// nbradbury - call onNoteSelected() directly rather than using code below, since code below may not always select the correct note depending on user&#x27;s sort preference"> 438  		// nbradbury - call onNoteSelected() directly rather than using code below, since code below may not always seleðŸ”µ</abbr>
 439  		mCallbacks.onNoteSelected(note.getSimperiumKey(), true);

 440  	}
 441  
 442      public void setNoteSelected(String selectedNoteID) {
 443          // Loop through notes and set note selected if found
 444          ObjectCursor&lt;Note&gt; cursor = (ObjectCursor&lt;Note&gt;)mNotesAdapter.getCursor();
 445          if (cursor == null || cursor.getCount() == 0)
 446              return;
 447          for(int i=0; i &lt; cursor.getCount(); i++) {
 448              cursor.moveToPosition(i);
 449              String noteKey = cursor.getSimperiumKey();
 450              if (noteKey != null &amp;&amp; noteKey.equals(selectedNoteID)) {
 451                  setActivatedPosition(i);
 452                  return;
 453              }
 454          }
 455  
 456          // Didn&#x27;t find the note, let&#x27;s try again after the cursor updates (see refreshListTask)
 457          mSelectedNoteId = selectedNoteID;
 458      }
 459  
 460  	public class NotesCursorAdapter extends CursorAdapter {
 461          private ObjectCursor&lt;Note&gt; mCursor;




 462          public NotesCursorAdapter(Context context, ObjectCursor&lt;Note&gt; c, int flags) {
 463              super(context, c, flags);
 464              mCursor = c;
 465          }
 466  
 467          public void changeCursor(ObjectCursor&lt;Note&gt; cursor){
 468              mCursor = cursor;
 469              super.changeCursor(cursor);
 470          }
 471  
 472          @Override
 473          public Note getItem(int position) {
 474              mCursor.moveToPosition(position);
 475              return mCursor.getObject();
 476          }
 477  
 478          /*
 479          *  nbradbury - implemented &quot;holder pattern&quot; to boost performance with large note lists
 480          */
 481  		@Override
 482  		public View getView(int position, View view, ViewGroup parent) {
 483  
 484  			NoteViewHolder holder;
 485  			if (view == null) {
 486  				view = View.inflate(getActivity().getBaseContext(), R.layout.note_list_row, null);
 487  				holder = new NoteViewHolder();
 488  				holder.titleTextView = (TextView) view.findViewById(R.id.note_title);
<abbr title=" 489                  holder.titleTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 489                  holder.titleTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FðŸ”µ</abbr>
 490  				holder.contentTextView = (TextView) view.findViewById(R.id.note_content);
<abbr title=" 491                  holder.contentTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOM_FONT_PATH));"> 491                  holder.contentTextView.setTypeface(Typefaces.get(getActivity().getBaseContext(), Simplenote.CUSTOMðŸ”µ</abbr>
 492  				holder.pinImageView = (ImageView) view.findViewById(R.id.note_pin);
 493  				view.setTag(holder);
 494  			} else {
 495  				holder = (NoteViewHolder) view.getTag();
 496  			}
 497  
 498              if (position == getListView().getCheckedItemPosition())
 499                  view.setActivated(true);
 500              else
 501                  view.setActivated(false);
 502  
 503              // for performance reasons we are going to get indexed values
 504              // from the cursor instead of instantiating the entire bucket object
 505              holder.contentTextView.setVisibility(View.VISIBLE);
 506              holder.contentTextView.setMaxLines(mNumPreviewLines);
 507              mCursor.moveToPosition(position);
 508              holder.setNoteId(mCursor.getSimperiumKey());
 509              int pinned = mCursor.getInt(mCursor.getColumnIndex(&quot;pinned&quot;));

 510              holder.pinImageView.setVisibility(pinned == 1 ? View.VISIBLE : View.GONE);
 511  
 512              String title = mCursor.getString(mCursor.getColumnIndex(&quot;title&quot;));


 513              if (title == null || title.equals(&quot;&quot;)) {
 514                  title = getString(R.string.new_note_list);
 515              }
 516              holder.titleTextView.setText(title);
 517  
 518              if (mNumPreviewLines &gt; 0) {
 519                  String contentPreview = mCursor.getString(mCursor.getColumnIndex(&quot;contentPreview&quot;));
 520                  if (title.equals(contentPreview) || title.equals(getString(R.string.new_note_list)))




















 521                      holder.contentTextView.setVisibility(View.GONE);
 522                  else
 523                      holder.contentTextView.setText(contentPreview);
 524              }
 525  
 526  			return view;
 527  		}
 528  
 529          @Override
 530          public View newView(Context context, Cursor cursor, ViewGroup viewGroup) {
 531              return null;
 532          }
 533  
 534          @Override
 535          public void bindView(View view, Context context, Cursor cursor) {
 536  
 537          }
 538  
 539  	}
 540  
 541  	// view holder for NotesCursorAdapter
 542  	private static class NoteViewHolder {
 543  		TextView titleTextView;
 544  		TextView contentTextView;
 545  		ImageView pinImageView;

 546          private String mNoteId;
 547  
 548          public void setNoteId(String noteId) {
 549              mNoteId = noteId;
 550          }
 551  
 552          public String getNoteId() {
 553              return mNoteId;
 554          }
 555  	}
 556  
 557  	public void searchNotes(String searchString) {
 558          if (!searchString.equals(mSearchString)){
 559              mSearchString = searchString;
 560              refreshList();
 561          }
 562  	}
 563  
 564      /**
 565       * Clear search and load all notes
 566       */
 567      public void clearSearch() {
 568          if (mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;)){
 569              mSearchString = null;
 570              refreshList();
 571          }




 572      }
 573  
 574      public void sortNoteQuery(Query&lt;Note&gt; noteQuery){
 575          noteQuery.order(&quot;pinned&quot;, SortType.DESCENDING);
 576  		int sortPref = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_SORT_ORDER);
 577  		switch (sortPref) {
 578          case 0:
 579              noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.DESCENDING);
 580              break;
 581  		case 1:
 582              noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.ASCENDING);
 583  			break;
 584  		case 2:
 585              noteQuery.order(Note.CREATED_INDEX_NAME, SortType.DESCENDING);
 586  			break;
 587  		case 3:
 588              noteQuery.order(Note.CREATED_INDEX_NAME, SortType.ASCENDING);
 589  			break;
 590  		case 4:
 591              noteQuery.order(Note.CONTENT_PROPERTY, SortType.ASCENDING);
 592  			break;
 593  		case 5:
 594              noteQuery.order(Note.CONTENT_PROPERTY, SortType.DESCENDING);
 595  			break;
 596  		}
 597      }
 598  
 599      private class refreshListTask extends AsyncTask&lt;Boolean, Void, ObjectCursor&lt;Note&gt;&gt; {
 600          boolean mIsFromNavSelect;
 601  
 602          @Override
 603          protected ObjectCursor&lt;Note&gt; doInBackground(Boolean ... args) {
 604              mIsFromNavSelect = args[0];
 605              return queryNotes();
 606          }
 607  
 608          @Override
 609          protected void onPostExecute(ObjectCursor&lt;Note&gt; cursor) {
 610              if (getActivity() == null || getActivity().isFinishing())
 611                  return;
 612              mNotesAdapter.changeCursor(cursor);











 613  
 614              NotesActivity notesActivity = (NotesActivity)getActivity();
 615              if (notesActivity != null) {
 616                  if (mIsFromNavSelect &amp;&amp; notesActivity.isLargeScreenLandscape()) {
 617                          if (mNotesAdapter.getCount() == 0) {

 618                              notesActivity.showDetailPlaceholder();
 619                          } else {
 620                              // Select the first note
 621                              selectFirstNote();
 622                          }
 623                  }
 624                  notesActivity.updateTrashMenuItem();
 625              }
 626  
 627              if (mSelectedNoteId != null) {
 628                  setNoteSelected(mSelectedNoteId);
 629                  mSelectedNoteId = null;
 630              }
 631          }
 632      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 633 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 634 -    private class trashNotesTask extends AsyncTask&lt;Void, Void, Void&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 635 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 636 -        List&lt;String&gt; deletedNotesIds = new ArrayList&lt;String&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 637 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 638 -        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 639 -        protected Void doInBackground(Void... args) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 640 -            SparseBooleanArray selectedRows = getListView().getCheckedItemPositions();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 641 -            for (int i = 0; i &lt; selectedRows.size(); i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 642 -                if (selectedRows.valueAt(i) == true) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 643 -                    Note deletedNote = mNotesAdapter.getItem(selectedRows.keyAt(i));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 644 -                    deletedNotesIds.add(deletedNote.getSimperiumKey());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 645 -                    deletedNote.setDeleted(!deletedNote.isDeleted());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 646 -                    deletedNote.setModificationDate(Calendar.getInstance());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 647 -                    deletedNote.save();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 648 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 649 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 650 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 651 -            return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 652 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 653 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 654 -        @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 655 -        protected void onPostExecute(Void aVoid) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 656 -            NotesActivity notesActivity = ((NotesActivity) getActivity());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 657 -            if (notesActivity != null)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 658 -                notesActivity.showUndoBarWithNoteIds(deletedNotesIds);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 659 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 660 -    }</span>
 661  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            