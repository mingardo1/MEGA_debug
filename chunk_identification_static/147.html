<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>147</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    147
                    <a href="146.html">prev</a>
                    <a href="148.html">next</a>
                    <a href="147_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_68d0a170f9399845027214d6e8e6e30c591900dd_core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;68d0a170f9399845027214d6e8e6e30c591900dd:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;68d0a170f9399845027214d6e8e6e30c591900dd^1:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;68d0a170f9399845027214d6e8e6e30c591900dd^2:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;3a313f224612dac7bdcaf4abaf4b36d05d83b1ae:core/broadleaf-framework-web/src/main/java/org/broadleafcommerce/core/web/controller/checkout/BroadleafCheckoutController.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[bj], [s]], subset: [[bsj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="6211491254187717485" onmouseenter="enter('6211491254187717485');" onmouseout="out('6211491254187717485');" style="">   3  * BroadleafCommerce Framework Web                                                                       </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-8629421599793957064" onmouseenter="enter('-8629421599793957064');" onmouseout="out('-8629421599793957064');" style="">  18 package org.broadleafcommerce.core.web.controller.checkout;                                              </span>
<span  style="">  19                                                                                                          </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  22 import org.broadleafcommerce.common.exception.ServiceException;                                          </span>
<span class="5237224010034497476" onmouseenter="enter('5237224010034497476');" onmouseout="out('5237224010034497476');" style="">  23 import org.broadleafcommerce.common.payment.PaymentGatewayType;                                          </span>
<span class="479407306950343868" onmouseenter="enter('479407306950343868');" onmouseout="out('479407306950343868');" style="">  24 import org.broadleafcommerce.common.payment.PaymentTransactionType;                                      </span>
<span class="7974202605197813097" onmouseenter="enter('7974202605197813097');" onmouseout="out('7974202605197813097');" style="">  25 import org.broadleafcommerce.common.payment.PaymentType;                                                 </span>
<span class="-2982073195956465030" onmouseenter="enter('-2982073195956465030');" onmouseout="out('-2982073195956465030');" style="">  26 import org.broadleafcommerce.common.vendor.service.exception.PaymentException;                           </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  27 import org.broadleafcommerce.common.web.BroadleafRequestContext;                                         </span>
<span class="-1388823727075420947" onmouseenter="enter('-1388823727075420947');" onmouseout="out('-1388823727075420947');" style="">  28 import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;             </span>
<span class="-1537931304336191501" onmouseenter="enter('-1537931304336191501');" onmouseout="out('-1537931304336191501');" style="">  29 import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;                  </span>
<span class="-6326345691456347408" onmouseenter="enter('-6326345691456347408');" onmouseout="out('-6326345691456347408');" style="">  30 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;                                        </span>
<span class="7718612833831637853" onmouseenter="enter('7718612833831637853');" onmouseout="out('7718612833831637853');" style="">  31 import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;                         </span>
<span class="2542407303560298775" onmouseenter="enter('2542407303560298775');" onmouseout="out('2542407303560298775');" style="">  32 import org.broadleafcommerce.core.offer.service.exception.OfferMaxUseExceededException;                  </span>
<span class="6568352354414313904" onmouseenter="enter('6568352354414313904');" onmouseout="out('6568352354414313904');" style="">  33 import org.broadleafcommerce.core.order.domain.NullOrderImpl;                                            </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  34 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-8548142165698551205" onmouseenter="enter('-8548142165698551205');" onmouseout="out('-8548142165698551205');" style="">  35 import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;                 </span>
<span class="-5209046066651310391" onmouseenter="enter('-5209046066651310391');" onmouseout="out('-5209046066651310391');" style="">  36 import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;         </span>
<span class="725806334255742314" onmouseenter="enter('725806334255742314');" onmouseout="out('725806334255742314');" style="">  37 import org.broadleafcommerce.core.payment.domain.OrderPayment;                                           </span>
<span class="-3835471990257693692" onmouseenter="enter('-3835471990257693692');" onmouseout="out('-3835471990257693692');" style="">  38 import org.broadleafcommerce.core.payment.domain.PaymentTransaction;                                     </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  39 import org.broadleafcommerce.core.pricing.service.exception.PricingException;                            </span>
<span class="8867715597751215715" onmouseenter="enter('8867715597751215715');" onmouseout="out('8867715597751215715');" style="">  40 import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;                                      </span>
<span class="-8122138792032766956" onmouseenter="enter('-8122138792032766956');" onmouseout="out('-8122138792032766956');" style="">  41 import org.broadleafcommerce.core.web.order.CartState;                                                   </span>
<span class="-6031821648249405492" onmouseenter="enter('-6031821648249405492');" onmouseout="out('-6031821648249405492');" style="">  42 import org.broadleafcommerce.profile.web.core.CustomerState;                                             </span>
<span class="2230089600625206822" onmouseenter="enter('2230089600625206822');" onmouseout="out('2230089600625206822');" style="">  43 import org.springframework.ui.Model;                                                                     </span>
<span class="-5446610002806720528" onmouseenter="enter('-5446610002806720528');" onmouseout="out('-5446610002806720528');" style="">  44 import org.springframework.validation.BindingResult;                                                     </span>
<span class="4289605998216587359" onmouseenter="enter('4289605998216587359');" onmouseout="out('4289605998216587359');" style="">  45 import org.springframework.web.servlet.mvc.support.RedirectAttributes;                                   </span>
<span  style="">  46                                                                                                          </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  47 import java.util.ArrayList;                                                                              </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  48 import java.util.List;                                                                                   </span>
<span  style="">  49                                                                                                          </span>
<span class="-2972028083581866805" onmouseenter="enter('-2972028083581866805');" onmouseout="out('-2972028083581866805');" style="">  50 import javax.servlet.http.HttpServletRequest;                                                            </span>
<span class="-2247759832438184775" onmouseenter="enter('-2247759832438184775');" onmouseout="out('-2247759832438184775');" style="">  51 import javax.servlet.http.HttpServletResponse;                                                           </span>
<span  style="">  52                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  53 /**                                                                                                      </span>
<span class="8742371521735015235" onmouseenter="enter('8742371521735015235');" onmouseout="out('8742371521735015235');" style="">  54  * In charge of performing the various checkout operations                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  55  *                                                                                                       </span>
<span class="-346667533686466806" onmouseenter="enter('-346667533686466806');" onmouseout="out('-346667533686466806');" style="">  56  * @author Andre Azzolini (apazzolini)                                                                   </span>
<span class="-7691131132890779522" onmouseenter="enter('-7691131132890779522');" onmouseout="out('-7691131132890779522');" style="">  57  * @author Elbert Bautista (elbertbautista)                                                              </span>
<span class="6360699620585460494" onmouseenter="enter('6360699620585460494');" onmouseout="out('6360699620585460494');" style="">  58  * @author Joshua Skorton (jskorton)                                                                     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  59  */                                                                                                      </span>
<span class="7030698850353387546" onmouseenter="enter('7030698850353387546');" onmouseout="out('7030698850353387546');" style="">  60 public class BroadleafCheckoutController extends AbstractCheckoutController {                            </span>
<span  style="">  61                                                                                                          </span>
<span class="-5830014166099721744" onmouseenter="enter('-5830014166099721744');" onmouseout="out('-5830014166099721744');" style="">  62     private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);                 </span>
<span class="6427092946309232849" onmouseenter="enter('6427092946309232849');" onmouseout="out('6427092946309232849');" style="">  63     protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;                         </span>
<span  style="">  64                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  65     /**                                                                                                  </span>
<span class="-5096071225963020400" onmouseenter="enter('-5096071225963020400');" onmouseout="out('-5096071225963020400');" style="">  66      * Renders the default checkout page and allows modules to add variables to the model.               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  67      *                                                                                                   </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style="">  68      * @param request                                                                                    </span>
<span class="592482809986819432" onmouseenter="enter('592482809986819432');" onmouseout="out('592482809986819432');" style="">  69      * @param response                                                                                   </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  70      * @param model                                                                                      </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  71      * @param model                                                                                      </span>
<span class="-2950909643428865356" onmouseenter="enter('-2950909643428865356');" onmouseout="out('-2950909643428865356');" style="">  72      * @return the checkout view path                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  73      */                                                                                                  </span>
<span class="-967467976240534127" onmouseenter="enter('-967467976240534127');" onmouseout="out('-967467976240534127');" style="">  74     public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,        </span>
<span class="696875836648250935" onmouseenter="enter('696875836648250935');" onmouseout="out('696875836648250935');" style="">  75             RedirectAttributes redirectAttributes) {                                                     </span>
<span class="270872852217962230" onmouseenter="enter('270872852217962230');" onmouseout="out('270872852217962230');" style="">  76         preValidateCartOperation(model);                                                                 </span>
<span class="-1086353471713277153" onmouseenter="enter('-1086353471713277153');" onmouseout="out('-1086353471713277153');" style="">  77         populateModelWithReferenceData(request, model);                                                  </span>
<span  style="">  78                                                                                                          </span>
<span class="-1859137930126069715" onmouseenter="enter('-1859137930126069715');" onmouseout="out('-1859137930126069715');" style="">  79         return getCheckoutView();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  80     }                                                                                                    </span>
<span  style="">  81                                                                                                          </span>
<span class="3128862131256497566" onmouseenter="enter('3128862131256497566');" onmouseout="out('3128862131256497566');" style="">  82     protected void preValidateCartOperation(Model model) {                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  83         try {                                                                                            </span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style="">  84             Order cart = CartState.getCart();                                                            </span>
<span class="8317005274507227996" onmouseenter="enter('8317005274507227996');" onmouseout="out('8317005274507227996');" style="">  85             orderService.preValidateCartOperation(cart);                                                 </span>
<span class="-7281640055951108504" onmouseenter="enter('-7281640055951108504');" onmouseout="out('-7281640055951108504');" style="">  86         } catch (IllegalCartOperationException ex) {                                                     </span>
<span class="339425943881620554" onmouseenter="enter('339425943881620554');" onmouseout="out('339425943881620554');" style="">  87             model.addAttribute(&quot;cartRequiresLock&quot;, true);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  88         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  89     }                                                                                                    </span>
<span  style="">  90                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  91     /**                                                                                                  </span>
<span class="1130589780629338932" onmouseenter="enter('1130589780629338932');" onmouseout="out('1130589780629338932');" style="">  92      * Renders checkout stages partial at the requested stage                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  93      *                                                                                                   </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style="">  94      * @param request                                                                                    </span>
<span class="592482809986819432" onmouseenter="enter('592482809986819432');" onmouseout="out('592482809986819432');" style="">  95      * @param response                                                                                   </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  96      * @param model                                                                                      </span>
<span class="4895955032086297450" onmouseenter="enter('4895955032086297450');" onmouseout="out('4895955032086297450');" style="">  97      * @param stage                                                                                      </span>
<span class="-7461455283175296223" onmouseenter="enter('-7461455283175296223');" onmouseout="out('-7461455283175296223');" style="">  98      * @return the checkout stages partial path                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  99      */                                                                                                  </span>
<span class="-7433197152380805769" onmouseenter="enter('-7433197152380805769');" onmouseout="out('-7433197152380805769');" style=""><abbr title=" 100     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,"> 100     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, ModelðŸ”µ</abbr></span>
<span class="2266763686826895306" onmouseenter="enter('2266763686826895306');" onmouseout="out('2266763686826895306');" style=""> 101             String stage, RedirectAttributes redirectAttributes) {                                       </span>
<span class="3963575602163400700" onmouseenter="enter('3963575602163400700');" onmouseout="out('3963575602163400700');" style=""> 102         model.addAttribute(ACTIVE_STAGE, stage);                                                         </span>
<span class="-3680994274736134122" onmouseenter="enter('-3680994274736134122');" onmouseout="out('-3680994274736134122');" style=""> 103         return getCheckoutStagesPartial();                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 104     }                                                                                                    </span>
<span  style=""> 105                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 106     /**                                                                                                  </span>
<span class="6425048121249974617" onmouseenter="enter('6425048121249974617');" onmouseout="out('6425048121249974617');" style=""> 107      * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously             </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style=""> 108      * @param request                                                                                    </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style=""> 109      * @param model                                                                                      </span>
<span class="-4336315843383652520" onmouseenter="enter('-4336315843383652520');" onmouseout="out('-4336315843383652520');" style=""> 110      * @param orderInfoForm                                                                              </span>
<span class="471163069337744535" onmouseenter="enter('471163069337744535');" onmouseout="out('471163069337744535');" style=""> 111      * @param result                                                                                     </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 112      * @return                                                                                           </span>
<span class="8449301783782133383" onmouseenter="enter('8449301783782133383');" onmouseout="out('8449301783782133383');" style=""> 113      * @throws ServiceException                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 114      */                                                                                                  </span>
<span class="7833752547156411123" onmouseenter="enter('7833752547156411123');" onmouseout="out('7833752547156411123');" style=""> 115     public String saveGlobalOrderDetails(HttpServletRequest request, Model model,                        </span>
<span class="2885692691175911068" onmouseenter="enter('2885692691175911068');" onmouseout="out('2885692691175911068');" style=""> 116             OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {                 </span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 117         Order cart = CartState.getCart();                                                                </span>
<span  style=""> 118                                                                                                          </span>
<span class="-4853722722374659261" onmouseenter="enter('-4853722722374659261');" onmouseout="out('-4853722722374659261');" style=""> 119         orderInfoFormValidator.validate(orderInfoForm, result);                                          </span>
<span class="4556169223967360348" onmouseenter="enter('4556169223967360348');" onmouseout="out('4556169223967360348');" style=""> 120         if (result.hasErrors()) {                                                                        </span>
<span class="4925675922142494738" onmouseenter="enter('4925675922142494738');" onmouseout="out('4925675922142494738');" style=""> 121             // We need to clear the email on error in case they are trying to edit it                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 122             try {                                                                                        </span>
<span class="-6542315142466769644" onmouseenter="enter('-6542315142466769644');" onmouseout="out('-6542315142466769644');" style=""> 123                 cart.setEmailAddress(null);                                                              </span>
<span class="2575162925158509166" onmouseenter="enter('2575162925158509166');" onmouseout="out('2575162925158509166');" style=""> 124                 orderService.save(cart, false);                                                          </span>
<span class="-7664829891190352303" onmouseenter="enter('-7664829891190352303');" onmouseout="out('-7664829891190352303');" style=""> 125             } catch (PricingException pe) {                                                              </span>
<span class="-7018185772171393940" onmouseenter="enter('-7018185772171393940');" onmouseout="out('-7018185772171393940');" style=""> 126                 LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127             }                                                                                            </span>
<span  style=""> 128                                                                                                          </span>
<span class="-1086353471713277153" onmouseenter="enter('-1086353471713277153');" onmouseout="out('-1086353471713277153');" style=""> 129             populateModelWithReferenceData(request, model);                                              </span>
<span class="-1859137930126069715" onmouseenter="enter('-1859137930126069715');" onmouseout="out('-1859137930126069715');" style=""> 130             return getCheckoutView();                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 131         }                                                                                                </span>
<span  style=""> 132                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 133         try {                                                                                            </span>
<span class="-4094676742804741694" onmouseenter="enter('-4094676742804741694');" onmouseout="out('-4094676742804741694');" style=""> 134             cart.setEmailAddress(orderInfoForm.getEmailAddress());                                       </span>
<span class="2575162925158509166" onmouseenter="enter('2575162925158509166');" onmouseout="out('2575162925158509166');" style=""> 135             orderService.save(cart, false);                                                              </span>
<span class="-7664829891190352303" onmouseenter="enter('-7664829891190352303');" onmouseout="out('-7664829891190352303');" style=""> 136         } catch (PricingException pe) {                                                                  </span>
<span class="-7018185772171393940" onmouseenter="enter('-7018185772171393940');" onmouseout="out('-7018185772171393940');" style=""> 137             LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 138         }                                                                                                </span>
<span  style=""> 139                                                                                                          </span>
<span class="1317425097473825953" onmouseenter="enter('1317425097473825953');" onmouseout="out('1317425097473825953');" style=""> 140         return getCheckoutPageRedirect();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141     }                                                                                                    </span>
<span  style=""> 142                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 143     /**                                                                                                  </span>
<span class="7448664771981292412" onmouseenter="enter('7448664771981292412');" onmouseout="out('7448664771981292412');" style=""> 144      * Creates a pass-through payment of the PaymentType passed in with                                  </span>
<span class="421012101637192710" onmouseenter="enter('421012101637192710');" onmouseout="out('421012101637192710');" style=""> 145      * an amount equal to the order total after any non-final applied payments.                          </span>
<span class="8025235098781395569" onmouseenter="enter('8025235098781395569');" onmouseout="out('8025235098781395569');" style=""> 146      * (for example gift cards, customer credit, or third party accounts)                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 147      *                                                                                                   </span>
<span class="-6096085412817911554" onmouseenter="enter('-6096085412817911554');" onmouseout="out('-6096085412817911554');" style=""> 148      * This intended to be used in cases like COD and other Payment Types where implementations wish     </span>
<span class="974612727386255560" onmouseenter="enter('974612727386255560');" onmouseout="out('974612727386255560');" style=""> 149      * to just checkout without having to do any payment processing.                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 150      *                                                                                                   </span>
<span class="-7601184109281730645" onmouseenter="enter('-7601184109281730645');" onmouseout="out('-7601184109281730645');" style=""> 151      * This default implementations assumes that the pass-through payment is the only                    </span>
<span class="-4077415547304827420" onmouseenter="enter('-4077415547304827420');" onmouseout="out('-4077415547304827420');" style=""> 152      * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED </span>
<span class="36099180133309792" onmouseenter="enter('36099180133309792');" onmouseout="out('36099180133309792');" style=""><abbr title=" 153      * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 153      * That means that it will look at all transactions on the order payment and see if it has unconfirmeðŸ”µ</abbr></span>
<span class="780949603230510899" onmouseenter="enter('780949603230510899');" onmouseout="out('780949603230510899');" style=""> 154      * If it does, it will not remove it.                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 155      *                                                                                                   </span>
<span class="-2081180607706702192" onmouseenter="enter('-2081180607706702192');" onmouseout="out('-2081180607706702192');" style=""> 156      * Make sure not to expose this method in your extended Controller if you do not wish to             </span>
<span class="-9185284612955559377" onmouseenter="enter('-9185284612955559377');" onmouseout="out('-9185284612955559377');" style=""> 157      * have this feature enabled.                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 158      *                                                                                                   </span>
<span class="9045397892808778291" onmouseenter="enter('9045397892808778291');" onmouseout="out('9045397892808778291');" style=""> 159      * @param redirectAttributes                                                                         </span>
<span class="-6271960972125413074" onmouseenter="enter('-6271960972125413074');" onmouseout="out('-6271960972125413074');" style=""> 160      * @param paymentType                                                                                </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 161      * @return                                                                                           </span>
<span class="2740930998571054578" onmouseenter="enter('2740930998571054578');" onmouseout="out('2740930998571054578');" style=""> 162      * @throws PaymentException                                                                          </span>
<span class="-7962706440062724544" onmouseenter="enter('-7962706440062724544');" onmouseout="out('-7962706440062724544');" style=""> 163      * @throws PricingException                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 164      */                                                                                                  </span>
<span class="-6736963433386757064" onmouseenter="enter('-6736963433386757064');" onmouseout="out('-6736963433386757064');" style=""> 165     public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,                </span>
<span class="-4251657370959523100" onmouseenter="enter('-4251657370959523100');" onmouseout="out('-4251657370959523100');" style=""><abbr title=" 166                                              PaymentType paymentType) throws PaymentException, PricingException {"> 166                                              PaymentType paymentType) throws PaymentException, PricingExcðŸ”µ</abbr></span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 167         Order cart = CartState.getCart();                                                                </span>
<span  style=""> 168                                                                                                          </span>
<span class="8276989610904881201" onmouseenter="enter('8276989610904881201');" onmouseout="out('8276989610904881201');" style=""><abbr title=" 169         //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED"> 169         //Invalidate any payments already on the order that do not have transactions on them that are UNCðŸ”µ</abbr></span>
<span class="-6892905423713233256" onmouseenter="enter('-6892905423713233256');" onmouseout="out('-6892905423713233256');" style=""> 170         List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();                         </span>
<span class="-6512141134753607370" onmouseenter="enter('-6512141134753607370');" onmouseout="out('-6512141134753607370');" style=""> 171         for (OrderPayment payment : cart.getPayments()) {                                                </span>
<span class="2703717333279802826" onmouseenter="enter('2703717333279802826');" onmouseout="out('2703717333279802826');" style=""> 172             if (payment.isActive()) {                                                                    </span>
<span class="1010327443504623706" onmouseenter="enter('1010327443504623706');" onmouseout="out('1010327443504623706');" style=""> 173                 if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {          </span>
<span class="-9174713251656761482" onmouseenter="enter('-9174713251656761482');" onmouseout="out('-9174713251656761482');" style=""> 174                     paymentsToInvalidate.add(payment);                                                   </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 175                 } else {                                                                                 </span>
<span class="4783701959626342440" onmouseenter="enter('4783701959626342440');" onmouseout="out('4783701959626342440');" style=""> 176                     for (PaymentTransaction transaction : payment.getTransactions()) {                   </span>
<span class="1226189291557269996" onmouseenter="enter('1226189291557269996');" onmouseout="out('1226189291557269996');" style=""> 177                         if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {         </span>
<span class="-9174713251656761482" onmouseenter="enter('-9174713251656761482');" onmouseout="out('-9174713251656761482');" style=""> 178                              paymentsToInvalidate.add(payment);                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183         }                                                                                                </span>
<span  style=""> 184                                                                                                          </span>
<span class="2845204764465767604" onmouseenter="enter('2845204764465767604');" onmouseout="out('2845204764465767604');" style=""> 185         for (OrderPayment payment : paymentsToInvalidate) {                                              </span>
<span class="7985051489455715642" onmouseenter="enter('7985051489455715642');" onmouseout="out('7985051489455715642');" style=""> 186             cart.getPayments().remove(payment);                                                          </span>
<span class="2733206040956525892" onmouseenter="enter('2733206040956525892');" onmouseout="out('2733206040956525892');" style=""> 187             if (paymentGatewayCheckoutService != null) {                                                 </span>
<span class="-6402023943636930644" onmouseenter="enter('-6402023943636930644');" onmouseout="out('-6402023943636930644');" style=""> 188                 paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190         }                                                                                                </span>
<span  style=""> 191                                                                                                          </span>
<span class="6556873303965518105" onmouseenter="enter('6556873303965518105');" onmouseout="out('6556873303965518105');" style=""> 192         //Create a new Order Payment of the passed in type                                               </span>
<span class="6833494301693157359" onmouseenter="enter('6833494301693157359');" onmouseout="out('6833494301693157359');" style=""> 193         OrderPayment passthroughPayment = orderPaymentService.create();                                  </span>
<span class="9147888607418772106" onmouseenter="enter('9147888607418772106');" onmouseout="out('9147888607418772106');" style=""> 194         passthroughPayment.setType(paymentType);                                                         </span>
<span class="-2427612793458922324" onmouseenter="enter('-2427612793458922324');" onmouseout="out('-2427612793458922324');" style=""> 195         passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);                        </span>
<span class="5974726468545546735" onmouseenter="enter('5974726468545546735');" onmouseout="out('5974726468545546735');" style=""> 196         passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());                               </span>
<span class="-4386080588835248255" onmouseenter="enter('-4386080588835248255');" onmouseout="out('-4386080588835248255');" style=""> 197         passthroughPayment.setOrder(cart);                                                               </span>
<span  style=""> 198                                                                                                          </span>
<span class="-1563843751557855690" onmouseenter="enter('-1563843751557855690');" onmouseout="out('-1563843751557855690');" style=""> 199         // Create the transaction for the payment                                                        </span>
<span class="-4070171252423561334" onmouseenter="enter('-4070171252423561334');" onmouseout="out('-4070171252423561334');" style=""> 200         PaymentTransaction transaction = orderPaymentService.createTransaction();                        </span>
<span class="-7489203339293438896" onmouseenter="enter('-7489203339293438896');" onmouseout="out('-7489203339293438896');" style=""> 201         transaction.setAmount(cart.getTotalAfterAppliedPayments());                                      </span>
<span class="4158351209072946081" onmouseenter="enter('4158351209072946081');" onmouseout="out('4158351209072946081');" style=""> 202         transaction.setRawResponse(&quot;Passthrough Payment&quot;);                                               </span>
<span class="3734380173590255888" onmouseenter="enter('3734380173590255888');" onmouseout="out('3734380173590255888');" style=""> 203         transaction.setSuccess(true);                                                                    </span>
<span class="1663782738889042400" onmouseenter="enter('1663782738889042400');" onmouseout="out('1663782738889042400');" style=""> 204         transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);                               </span>
<span class="8694399832927225044" onmouseenter="enter('8694399832927225044');" onmouseout="out('8694399832927225044');" style=""><abbr title=" 205         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 205         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymeðŸ”µ</abbr></span>
<span  style=""> 206                                                                                                          </span>
<span class="-6972575699192592583" onmouseenter="enter('-6972575699192592583');" onmouseout="out('-6972575699192592583');" style=""> 207         transaction.setOrderPayment(passthroughPayment);                                                 </span>
<span class="-7763228653556987209" onmouseenter="enter('-7763228653556987209');" onmouseout="out('-7763228653556987209');" style=""> 208         passthroughPayment.addTransaction(transaction);                                                  </span>
<span class="8603709849878582824" onmouseenter="enter('8603709849878582824');" onmouseout="out('8603709849878582824');" style=""> 209         orderService.addPaymentToOrder(cart, passthroughPayment, null);                                  </span>
<span  style=""> 210                                                                                                          </span>
<span class="4560736780407557680" onmouseenter="enter('4560736780407557680');" onmouseout="out('4560736780407557680');" style=""> 211         orderService.save(cart, true);                                                                   </span>
<span  style=""> 212                                                                                                          </span>
<span class="-4135330013633253420" onmouseenter="enter('-4135330013633253420');" onmouseout="out('-4135330013633253420');" style=""> 213         return processCompleteCheckoutOrderFinalized(redirectAttributes);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 214     }                                                                                                    </span>
<span  style=""> 215                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 216     /**                                                                                                  </span>
<span class="5444184320192604762" onmouseenter="enter('5444184320192604762');" onmouseout="out('5444184320192604762');" style=""> 217      * If the order has been finalized. i.e. all the payments have been applied to the order,            </span>
<span class="-4344413587104948495" onmouseenter="enter('-4344413587104948495');" onmouseout="out('-4344413587104948495');" style=""> 218      * then you can go ahead and call checkout using the passed in order id.                             </span>
<span class="1950207948444662969" onmouseenter="enter('1950207948444662969');" onmouseout="out('1950207948444662969');" style=""><abbr title=" 219      * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 219      * This is usually called from a Review Page or if enough Payments have been applied to the Order to ðŸ”µ</abbr></span>
<span class="-3475024975033618642" onmouseenter="enter('-3475024975033618642');" onmouseout="out('-3475024975033618642');" style=""><abbr title=" 220      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or"> 220      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway,ðŸ”µ</abbr></span>
<span class="-6748371112848020818" onmouseenter="enter('-6748371112848020818');" onmouseout="out('-6748371112848020818');" style=""><abbr title=" 221      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)"> 221      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express CheckoutðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 222      *                                                                                                   </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 223      * @return                                                                                           </span>
<span class="3682579759887248937" onmouseenter="enter('3682579759887248937');" onmouseout="out('3682579759887248937');" style=""> 224      * @throws Exception                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 225      */                                                                                                  </span>
<span class="5934204782612418166" onmouseenter="enter('5934204782612418166');" onmouseout="out('5934204782612418166');" style=""><abbr title=" 226     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 226     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throðŸ”µ</abbr></span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 227         Order cart = CartState.getCart();                                                                </span>
<span class="-410038182464695226" onmouseenter="enter('-410038182464695226');" onmouseout="out('-410038182464695226');" style=""> 228         String param = &quot;&quot;;                                                                               </span>
<span class="2369429717891499715" onmouseenter="enter('2369429717891499715');" onmouseout="out('2369429717891499715');" style=""> 229         if (cart != null &amp;&amp; !(cart instanceof NullOrderImpl)) {                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 230             try {                                                                                        </span>
<span class="5077673579105987976" onmouseenter="enter('5077673579105987976');" onmouseout="out('5077673579105987976');" style=""><abbr title=" 231                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 231                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties()ðŸ”µ</abbr></span>
<span class="-8024522286989825000" onmouseenter="enter('-8024522286989825000');" onmouseout="out('-8024522286989825000');" style=""> 232                 if(o!=null &amp;&amp; (Boolean) o){                                                              </span>
<span class="-1469060214097397333" onmouseenter="enter('-1469060214097397333');" onmouseout="out('-1469060214097397333');" style=""><abbr title=" 233                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 233                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order pðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234                 }                                                                                        </span>
<span class="3169004698733361531" onmouseenter="enter('3169004698733361531');" onmouseout="out('3169004698733361531');" style=""> 235                 String orderNumber = initiateCheckout(cart.getId());                                     </span>
<span class="-8482400126440404484" onmouseenter="enter('-8482400126440404484');" onmouseout="out('-8482400126440404484');" style=""> 236                 return getConfirmationViewRedirect(orderNumber);                                         </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 237             } catch (Exception e) {                                                                      </span>
<span class="3063554684989481043" onmouseenter="enter('3063554684989481043');" onmouseout="out('3063554684989481043');" style=""> 238                 handleProcessingException(e, redirectAttributes);                                        </span>
<span class="-6955630417980650572" onmouseenter="enter('-6955630417980650572');" onmouseout="out('-6955630417980650572');" style=""> 239                 if(CustomerState.getCustomer().isAnonymous()){                                           </span>
<span class="-3581136138458844540" onmouseenter="enter('-3581136138458844540');" onmouseout="out('-3581136138458844540');" style=""> 240                     param=&quot;?guest-checkout=true&quot;;                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 241                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 242             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 243         }                                                                                                </span>
<span  style=""> 244                                                                                                          </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 245 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="2502130438452954953" onmouseenter="enter('2502130438452954953');" onmouseout="out('2502130438452954953');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 246         return getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=true&quot; : &quot;&quot;);"> 246         return getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=ðŸ”µ</abbr></span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 247 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248     }                                                                                                    </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249                                                                                                          </span>
<span class="-8815074004281580350" onmouseenter="enter('-8815074004281580350');" onmouseout="out('-8815074004281580350');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250     public String initiateCheckout(Long orderId) throws Exception{                                       </span>
<span class="2438321416231783030" onmouseenter="enter('2438321416231783030');" onmouseout="out('2438321416231783030');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251         if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {                                  </span>
<span class="6065180908645754023" onmouseenter="enter('6065180908645754023');" onmouseout="out('6065180908645754023');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252             return paymentGatewayCheckoutService.initiateCheckout(orderId);                              </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 253 =======                                                                                                  </span>
<span class="-2511614893152452019" onmouseenter="enter('-2511614893152452019');" onmouseout="out('-2511614893152452019');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254         return getCheckoutPageRedirect()+param;                                                          </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 255 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 256     }                                                                                                    </span>
<span  style=""> 257                                                                                                          </span>
<span class="-8815074004281580350" onmouseenter="enter('-8815074004281580350');" onmouseout="out('-8815074004281580350');" style=""> 258     public String initiateCheckout(Long orderId) throws Exception{                                       </span>
<span class="2438321416231783030" onmouseenter="enter('2438321416231783030');" onmouseout="out('2438321416231783030');" style=""> 259         if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {                                  </span>
<span class="6065180908645754023" onmouseenter="enter('6065180908645754023');" onmouseout="out('6065180908645754023');" style=""> 260             return paymentGatewayCheckoutService.initiateCheckout(orderId);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261         }                                                                                                </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 262         return null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 263     }                                                                                                    </span>
<span  style=""> 264                                                                                                          </span>
<span class="-994952694334569484" onmouseenter="enter('-994952694334569484');" onmouseout="out('-994952694334569484');" style=""><abbr title=" 265     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 265     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymðŸ”µ</abbr></span>
<span class="8461701443473900494" onmouseenter="enter('8461701443473900494');" onmouseout="out('8461701443473900494');" style=""><abbr title=" 266         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 266         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect AttribuðŸ”µ</abbr></span>
<span  style=""> 267                                                                                                          </span>
<span class="-6915919722100840508" onmouseenter="enter('-6915919722100840508');" onmouseout="out('-6915919722100840508');" style=""> 268         Throwable cause = e.getCause();                                                                  </span>
<span  style=""> 269                                                                                                          </span>
<span class="4727501192160255118" onmouseenter="enter('4727501192160255118');" onmouseout="out('4727501192160255118');" style=""> 270         if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {         </span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 271             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,   </span>
<span class="-6443240451698207116" onmouseenter="enter('-6443240451698207116');" onmouseout="out('-6443240451698207116');" style=""> 272                     PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());           </span>
<span class="6281078227744959351" onmouseenter="enter('6281078227744959351');" onmouseout="out('6281078227744959351');" style=""><abbr title=" 273         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredException) {"> 273         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferEðŸ”µ</abbr></span>
<span class="5919541454818639441" onmouseenter="enter('5919541454818639441');" onmouseout="out('5919541454818639441');" style=""><abbr title=" 274             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMessage();"> 274             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() ðŸ”µ</abbr></span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 275             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,   </span>
<span class="-463279655468150766" onmouseenter="enter('-463279655468150766');" onmouseout="out('-463279655468150766');" style=""> 276                     message);                                                                            </span>
<span class="-6556537329766607120" onmouseenter="enter('-6556537329766607120');" onmouseout="out('-6556537329766607120');" style=""> 277         } else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferMaxUseExceededException) {            </span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 278             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,   </span>
<span class="-536931781667901612" onmouseenter="enter('-536931781667901612');" onmouseout="out('-536931781667901612');" style=""> 279                     &quot;There was an error during checkout:&quot;+cause.getCause().getMessage());                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 280         } else {                                                                                         </span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 281             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,   </span>
<span class="3844015022951785414" onmouseenter="enter('3844015022951785414');" onmouseout="out('3844015022951785414');" style=""> 282                     PaymentGatewayAbstractController.getProcessingErrorMessage());                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 283         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 284     }                                                                                                    </span>
<span  style=""> 285                                                                                                          </span>
<span class="7031853357863121773" onmouseenter="enter('7031853357863121773');" onmouseout="out('7031853357863121773');" style=""> 286     public String getBaseConfirmationRedirect() {                                                        </span>
<span class="-3466839714243703616" onmouseenter="enter('-3466839714243703616');" onmouseout="out('-3466839714243703616');" style=""> 287         return baseConfirmationRedirect;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 288     }                                                                                                    </span>
<span  style=""> 289                                                                                                          </span>
<span class="4806113959052613483" onmouseenter="enter('4806113959052613483');" onmouseout="out('4806113959052613483');" style=""> 290     protected String getConfirmationViewRedirect(String orderNumber) {                                   </span>
<span class="1954583273870042792" onmouseenter="enter('1954583273870042792');" onmouseout="out('1954583273870042792');" style=""> 291         return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 292     }                                                                                                    </span>
<span  style=""> 293                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 294 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="6211491254187717485" onmouseenter="enter('6211491254187717485');" onmouseout="out('6211491254187717485');" style="">   3  * BroadleafCommerce Framework Web                                                                       </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-8629421599793957064" onmouseenter="enter('-8629421599793957064');" onmouseout="out('-8629421599793957064');" style="">  18 package org.broadleafcommerce.core.web.controller.checkout;                                              </span>
<span  style="">  19                                                                                                          </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  22 import org.broadleafcommerce.common.exception.ServiceException;                                          </span>
<span class="5237224010034497476" onmouseenter="enter('5237224010034497476');" onmouseout="out('5237224010034497476');" style="">  23 import org.broadleafcommerce.common.payment.PaymentGatewayType;                                          </span>
<span class="479407306950343868" onmouseenter="enter('479407306950343868');" onmouseout="out('479407306950343868');" style="">  24 import org.broadleafcommerce.common.payment.PaymentTransactionType;                                      </span>
<span class="7974202605197813097" onmouseenter="enter('7974202605197813097');" onmouseout="out('7974202605197813097');" style="">  25 import org.broadleafcommerce.common.payment.PaymentType;                                                 </span>
<span class="-2982073195956465030" onmouseenter="enter('-2982073195956465030');" onmouseout="out('-2982073195956465030');" style="">  26 import org.broadleafcommerce.common.vendor.service.exception.PaymentException;                           </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  27 import org.broadleafcommerce.common.web.BroadleafRequestContext;                                         </span>
<span class="-1388823727075420947" onmouseenter="enter('-1388823727075420947');" onmouseout="out('-1388823727075420947');" style="">  28 import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;             </span>
<span class="-1537931304336191501" onmouseenter="enter('-1537931304336191501');" onmouseout="out('-1537931304336191501');" style="">  29 import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;                  </span>
<span class="-6326345691456347408" onmouseenter="enter('-6326345691456347408');" onmouseout="out('-6326345691456347408');" style="">  30 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;                                        </span>
<span class="7718612833831637853" onmouseenter="enter('7718612833831637853');" onmouseout="out('7718612833831637853');" style="">  31 import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;                         </span>
<span class="2542407303560298775" onmouseenter="enter('2542407303560298775');" onmouseout="out('2542407303560298775');" style="">  32 import org.broadleafcommerce.core.offer.service.exception.OfferMaxUseExceededException;                  </span>
<span class="6568352354414313904" onmouseenter="enter('6568352354414313904');" onmouseout="out('6568352354414313904');" style="">  33 import org.broadleafcommerce.core.order.domain.NullOrderImpl;                                            </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  34 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-8548142165698551205" onmouseenter="enter('-8548142165698551205');" onmouseout="out('-8548142165698551205');" style="">  35 import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;                 </span>
<span class="-5209046066651310391" onmouseenter="enter('-5209046066651310391');" onmouseout="out('-5209046066651310391');" style="">  36 import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;         </span>
<span class="725806334255742314" onmouseenter="enter('725806334255742314');" onmouseout="out('725806334255742314');" style="">  37 import org.broadleafcommerce.core.payment.domain.OrderPayment;                                           </span>
<span class="-3835471990257693692" onmouseenter="enter('-3835471990257693692');" onmouseout="out('-3835471990257693692');" style="">  38 import org.broadleafcommerce.core.payment.domain.PaymentTransaction;                                     </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  39 import org.broadleafcommerce.core.pricing.service.exception.PricingException;                            </span>
<span class="8867715597751215715" onmouseenter="enter('8867715597751215715');" onmouseout="out('8867715597751215715');" style="">  40 import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;                                      </span>
<span class="-8122138792032766956" onmouseenter="enter('-8122138792032766956');" onmouseout="out('-8122138792032766956');" style="">  41 import org.broadleafcommerce.core.web.order.CartState;                                                   </span>
<span class="-6031821648249405492" onmouseenter="enter('-6031821648249405492');" onmouseout="out('-6031821648249405492');" style="">  42 import org.broadleafcommerce.profile.web.core.CustomerState;                                             </span>
<span class="2230089600625206822" onmouseenter="enter('2230089600625206822');" onmouseout="out('2230089600625206822');" style="">  43 import org.springframework.ui.Model;                                                                     </span>
<span class="-5446610002806720528" onmouseenter="enter('-5446610002806720528');" onmouseout="out('-5446610002806720528');" style="">  44 import org.springframework.validation.BindingResult;                                                     </span>
<span class="4289605998216587359" onmouseenter="enter('4289605998216587359');" onmouseout="out('4289605998216587359');" style="">  45 import org.springframework.web.servlet.mvc.support.RedirectAttributes;                                   </span>
<span  style="">  46                                                                                                          </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  47 import java.util.ArrayList;                                                                              </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  48 import java.util.List;                                                                                   </span>
<span  style="">  49                                                                                                          </span>
<span class="-2972028083581866805" onmouseenter="enter('-2972028083581866805');" onmouseout="out('-2972028083581866805');" style="">  50 import javax.servlet.http.HttpServletRequest;                                                            </span>
<span class="-2247759832438184775" onmouseenter="enter('-2247759832438184775');" onmouseout="out('-2247759832438184775');" style="">  51 import javax.servlet.http.HttpServletResponse;                                                           </span>
<span  style="">  52                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  53 /**                                                                                                      </span>
<span class="8742371521735015235" onmouseenter="enter('8742371521735015235');" onmouseout="out('8742371521735015235');" style="">  54  * In charge of performing the various checkout operations                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  55  *                                                                                                       </span>
<span class="-346667533686466806" onmouseenter="enter('-346667533686466806');" onmouseout="out('-346667533686466806');" style="">  56  * @author Andre Azzolini (apazzolini)                                                                   </span>
<span class="-7691131132890779522" onmouseenter="enter('-7691131132890779522');" onmouseout="out('-7691131132890779522');" style="">  57  * @author Elbert Bautista (elbertbautista)                                                              </span>
<span class="6360699620585460494" onmouseenter="enter('6360699620585460494');" onmouseout="out('6360699620585460494');" style="">  58  * @author Joshua Skorton (jskorton)                                                                     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  59  */                                                                                                      </span>
<span class="7030698850353387546" onmouseenter="enter('7030698850353387546');" onmouseout="out('7030698850353387546');" style="">  60 public class BroadleafCheckoutController extends AbstractCheckoutController {                            </span>
<span  style="">  61                                                                                                          </span>
<span class="-5830014166099721744" onmouseenter="enter('-5830014166099721744');" onmouseout="out('-5830014166099721744');" style="">  62     private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);                 </span>
<span class="6427092946309232849" onmouseenter="enter('6427092946309232849');" onmouseout="out('6427092946309232849');" style="">  63     protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;                         </span>
<span  style="">  64                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  65     /**                                                                                                  </span>
<span class="-5096071225963020400" onmouseenter="enter('-5096071225963020400');" onmouseout="out('-5096071225963020400');" style="">  66      * Renders the default checkout page and allows modules to add variables to the model.               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  67      *                                                                                                   </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style="">  68      * @param request                                                                                    </span>
<span class="592482809986819432" onmouseenter="enter('592482809986819432');" onmouseout="out('592482809986819432');" style="">  69      * @param response                                                                                   </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  70      * @param model                                                                                      </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  71      * @param model                                                                                      </span>
<span class="-2950909643428865356" onmouseenter="enter('-2950909643428865356');" onmouseout="out('-2950909643428865356');" style="">  72      * @return the checkout view path                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  73      */                                                                                                  </span>
<span class="-967467976240534127" onmouseenter="enter('-967467976240534127');" onmouseout="out('-967467976240534127');" style="">  74     public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,        </span>
<span class="696875836648250935" onmouseenter="enter('696875836648250935');" onmouseout="out('696875836648250935');" style="">  75             RedirectAttributes redirectAttributes) {                                                     </span>
<span class="270872852217962230" onmouseenter="enter('270872852217962230');" onmouseout="out('270872852217962230');" style="">  76         preValidateCartOperation(model);                                                                 </span>
<span class="-1086353471713277153" onmouseenter="enter('-1086353471713277153');" onmouseout="out('-1086353471713277153');" style="">  77         populateModelWithReferenceData(request, model);                                                  </span>
<span  style="">  78                                                                                                          </span>
<span class="-1859137930126069715" onmouseenter="enter('-1859137930126069715');" onmouseout="out('-1859137930126069715');" style="">  79         return getCheckoutView();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  80     }                                                                                                    </span>
<span  style="">  81                                                                                                          </span>
<span class="3128862131256497566" onmouseenter="enter('3128862131256497566');" onmouseout="out('3128862131256497566');" style="">  82     protected void preValidateCartOperation(Model model) {                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  83         try {                                                                                            </span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style="">  84             Order cart = CartState.getCart();                                                            </span>
<span class="8317005274507227996" onmouseenter="enter('8317005274507227996');" onmouseout="out('8317005274507227996');" style="">  85             orderService.preValidateCartOperation(cart);                                                 </span>
<span class="-7281640055951108504" onmouseenter="enter('-7281640055951108504');" onmouseout="out('-7281640055951108504');" style="">  86         } catch (IllegalCartOperationException ex) {                                                     </span>
<span class="339425943881620554" onmouseenter="enter('339425943881620554');" onmouseout="out('339425943881620554');" style="">  87             model.addAttribute(&quot;cartRequiresLock&quot;, true);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  88         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  89     }                                                                                                    </span>
<span  style="">  90                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  91     /**                                                                                                  </span>
<span class="1130589780629338932" onmouseenter="enter('1130589780629338932');" onmouseout="out('1130589780629338932');" style="">  92      * Renders checkout stages partial at the requested stage                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  93      *                                                                                                   </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style="">  94      * @param request                                                                                    </span>
<span class="592482809986819432" onmouseenter="enter('592482809986819432');" onmouseout="out('592482809986819432');" style="">  95      * @param response                                                                                   </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  96      * @param model                                                                                      </span>
<span class="4895955032086297450" onmouseenter="enter('4895955032086297450');" onmouseout="out('4895955032086297450');" style="">  97      * @param stage                                                                                      </span>
<span class="-7461455283175296223" onmouseenter="enter('-7461455283175296223');" onmouseout="out('-7461455283175296223');" style="">  98      * @return the checkout stages partial path                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  99      */                                                                                                  </span>
<span class="-7433197152380805769" onmouseenter="enter('-7433197152380805769');" onmouseout="out('-7433197152380805769');" style=""><abbr title=" 100     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,"> 100     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, ModelðŸ”µ</abbr></span>
<span class="2266763686826895306" onmouseenter="enter('2266763686826895306');" onmouseout="out('2266763686826895306');" style=""> 101             String stage, RedirectAttributes redirectAttributes) {                                       </span>
<span class="3963575602163400700" onmouseenter="enter('3963575602163400700');" onmouseout="out('3963575602163400700');" style=""> 102         model.addAttribute(ACTIVE_STAGE, stage);                                                         </span>
<span class="-3680994274736134122" onmouseenter="enter('-3680994274736134122');" onmouseout="out('-3680994274736134122');" style=""> 103         return getCheckoutStagesPartial();                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 104     }                                                                                                    </span>
<span  style=""> 105                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 106     /**                                                                                                  </span>
<span class="6425048121249974617" onmouseenter="enter('6425048121249974617');" onmouseout="out('6425048121249974617');" style=""> 107      * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously             </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style=""> 108      * @param request                                                                                    </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style=""> 109      * @param model                                                                                      </span>
<span class="-4336315843383652520" onmouseenter="enter('-4336315843383652520');" onmouseout="out('-4336315843383652520');" style=""> 110      * @param orderInfoForm                                                                              </span>
<span class="471163069337744535" onmouseenter="enter('471163069337744535');" onmouseout="out('471163069337744535');" style=""> 111      * @param result                                                                                     </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 112      * @return                                                                                           </span>
<span class="8449301783782133383" onmouseenter="enter('8449301783782133383');" onmouseout="out('8449301783782133383');" style=""> 113      * @throws ServiceException                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 114      */                                                                                                  </span>
<span class="7833752547156411123" onmouseenter="enter('7833752547156411123');" onmouseout="out('7833752547156411123');" style=""> 115     public String saveGlobalOrderDetails(HttpServletRequest request, Model model,                        </span>
<span class="2885692691175911068" onmouseenter="enter('2885692691175911068');" onmouseout="out('2885692691175911068');" style=""> 116             OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {                 </span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 117         Order cart = CartState.getCart();                                                                </span>
<span  style=""> 118                                                                                                          </span>
<span class="-4853722722374659261" onmouseenter="enter('-4853722722374659261');" onmouseout="out('-4853722722374659261');" style=""> 119         orderInfoFormValidator.validate(orderInfoForm, result);                                          </span>
<span class="4556169223967360348" onmouseenter="enter('4556169223967360348');" onmouseout="out('4556169223967360348');" style=""> 120         if (result.hasErrors()) {                                                                        </span>
<span class="4925675922142494738" onmouseenter="enter('4925675922142494738');" onmouseout="out('4925675922142494738');" style=""> 121             // We need to clear the email on error in case they are trying to edit it                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 122             try {                                                                                        </span>
<span class="-6542315142466769644" onmouseenter="enter('-6542315142466769644');" onmouseout="out('-6542315142466769644');" style=""> 123                 cart.setEmailAddress(null);                                                              </span>
<span class="2575162925158509166" onmouseenter="enter('2575162925158509166');" onmouseout="out('2575162925158509166');" style=""> 124                 orderService.save(cart, false);                                                          </span>
<span class="-7664829891190352303" onmouseenter="enter('-7664829891190352303');" onmouseout="out('-7664829891190352303');" style=""> 125             } catch (PricingException pe) {                                                              </span>
<span class="-7018185772171393940" onmouseenter="enter('-7018185772171393940');" onmouseout="out('-7018185772171393940');" style=""> 126                 LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127             }                                                                                            </span>
<span  style=""> 128                                                                                                          </span>
<span class="-1086353471713277153" onmouseenter="enter('-1086353471713277153');" onmouseout="out('-1086353471713277153');" style=""> 129             populateModelWithReferenceData(request, model);                                              </span>
<span class="-1859137930126069715" onmouseenter="enter('-1859137930126069715');" onmouseout="out('-1859137930126069715');" style=""> 130             return getCheckoutView();                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 131         }                                                                                                </span>
<span  style=""> 132                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 133         try {                                                                                            </span>
<span class="-4094676742804741694" onmouseenter="enter('-4094676742804741694');" onmouseout="out('-4094676742804741694');" style=""> 134             cart.setEmailAddress(orderInfoForm.getEmailAddress());                                       </span>
<span class="2575162925158509166" onmouseenter="enter('2575162925158509166');" onmouseout="out('2575162925158509166');" style=""> 135             orderService.save(cart, false);                                                              </span>
<span class="-7664829891190352303" onmouseenter="enter('-7664829891190352303');" onmouseout="out('-7664829891190352303');" style=""> 136         } catch (PricingException pe) {                                                                  </span>
<span class="-7018185772171393940" onmouseenter="enter('-7018185772171393940');" onmouseout="out('-7018185772171393940');" style=""> 137             LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 138         }                                                                                                </span>
<span  style=""> 139                                                                                                          </span>
<span class="1317425097473825953" onmouseenter="enter('1317425097473825953');" onmouseout="out('1317425097473825953');" style=""> 140         return getCheckoutPageRedirect();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141     }                                                                                                    </span>
<span  style=""> 142                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 143     /**                                                                                                  </span>
<span class="7448664771981292412" onmouseenter="enter('7448664771981292412');" onmouseout="out('7448664771981292412');" style=""> 144      * Creates a pass-through payment of the PaymentType passed in with                                  </span>
<span class="421012101637192710" onmouseenter="enter('421012101637192710');" onmouseout="out('421012101637192710');" style=""> 145      * an amount equal to the order total after any non-final applied payments.                          </span>
<span class="8025235098781395569" onmouseenter="enter('8025235098781395569');" onmouseout="out('8025235098781395569');" style=""> 146      * (for example gift cards, customer credit, or third party accounts)                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 147      *                                                                                                   </span>
<span class="-6096085412817911554" onmouseenter="enter('-6096085412817911554');" onmouseout="out('-6096085412817911554');" style=""> 148      * This intended to be used in cases like COD and other Payment Types where implementations wish     </span>
<span class="974612727386255560" onmouseenter="enter('974612727386255560');" onmouseout="out('974612727386255560');" style=""> 149      * to just checkout without having to do any payment processing.                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 150      *                                                                                                   </span>
<span class="-7601184109281730645" onmouseenter="enter('-7601184109281730645');" onmouseout="out('-7601184109281730645');" style=""> 151      * This default implementations assumes that the pass-through payment is the only                    </span>
<span class="-4077415547304827420" onmouseenter="enter('-4077415547304827420');" onmouseout="out('-4077415547304827420');" style=""> 152      * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED </span>
<span class="36099180133309792" onmouseenter="enter('36099180133309792');" onmouseout="out('36099180133309792');" style=""><abbr title=" 153      * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 153      * That means that it will look at all transactions on the order payment and see if it has unconfirmeðŸ”µ</abbr></span>
<span class="780949603230510899" onmouseenter="enter('780949603230510899');" onmouseout="out('780949603230510899');" style=""> 154      * If it does, it will not remove it.                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 155      *                                                                                                   </span>
<span class="-2081180607706702192" onmouseenter="enter('-2081180607706702192');" onmouseout="out('-2081180607706702192');" style=""> 156      * Make sure not to expose this method in your extended Controller if you do not wish to             </span>
<span class="-9185284612955559377" onmouseenter="enter('-9185284612955559377');" onmouseout="out('-9185284612955559377');" style=""> 157      * have this feature enabled.                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 158      *                                                                                                   </span>
<span class="9045397892808778291" onmouseenter="enter('9045397892808778291');" onmouseout="out('9045397892808778291');" style=""> 159      * @param redirectAttributes                                                                         </span>
<span class="-6271960972125413074" onmouseenter="enter('-6271960972125413074');" onmouseout="out('-6271960972125413074');" style=""> 160      * @param paymentType                                                                                </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 161      * @return                                                                                           </span>
<span class="2740930998571054578" onmouseenter="enter('2740930998571054578');" onmouseout="out('2740930998571054578');" style=""> 162      * @throws PaymentException                                                                          </span>
<span class="-7962706440062724544" onmouseenter="enter('-7962706440062724544');" onmouseout="out('-7962706440062724544');" style=""> 163      * @throws PricingException                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 164      */                                                                                                  </span>
<span class="-6736963433386757064" onmouseenter="enter('-6736963433386757064');" onmouseout="out('-6736963433386757064');" style=""> 165     public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,                </span>
<span class="-4251657370959523100" onmouseenter="enter('-4251657370959523100');" onmouseout="out('-4251657370959523100');" style=""><abbr title=" 166                                              PaymentType paymentType) throws PaymentException, PricingException {"> 166                                              PaymentType paymentType) throws PaymentException, PricingExcðŸ”µ</abbr></span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 167         Order cart = CartState.getCart();                                                                </span>
<span  style=""> 168                                                                                                          </span>
<span class="8276989610904881201" onmouseenter="enter('8276989610904881201');" onmouseout="out('8276989610904881201');" style=""><abbr title=" 169         //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED"> 169         //Invalidate any payments already on the order that do not have transactions on them that are UNCðŸ”µ</abbr></span>
<span class="-6892905423713233256" onmouseenter="enter('-6892905423713233256');" onmouseout="out('-6892905423713233256');" style=""> 170         List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();                         </span>
<span class="-6512141134753607370" onmouseenter="enter('-6512141134753607370');" onmouseout="out('-6512141134753607370');" style=""> 171         for (OrderPayment payment : cart.getPayments()) {                                                </span>
<span class="2703717333279802826" onmouseenter="enter('2703717333279802826');" onmouseout="out('2703717333279802826');" style=""> 172             if (payment.isActive()) {                                                                    </span>
<span class="1010327443504623706" onmouseenter="enter('1010327443504623706');" onmouseout="out('1010327443504623706');" style=""> 173                 if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {          </span>
<span class="-9174713251656761482" onmouseenter="enter('-9174713251656761482');" onmouseout="out('-9174713251656761482');" style=""> 174                     paymentsToInvalidate.add(payment);                                                   </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 175                 } else {                                                                                 </span>
<span class="4783701959626342440" onmouseenter="enter('4783701959626342440');" onmouseout="out('4783701959626342440');" style=""> 176                     for (PaymentTransaction transaction : payment.getTransactions()) {                   </span>
<span class="1226189291557269996" onmouseenter="enter('1226189291557269996');" onmouseout="out('1226189291557269996');" style=""> 177                         if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {         </span>
<span class="-9174713251656761482" onmouseenter="enter('-9174713251656761482');" onmouseout="out('-9174713251656761482');" style=""> 178                              paymentsToInvalidate.add(payment);                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183         }                                                                                                </span>
<span  style=""> 184                                                                                                          </span>
<span class="2845204764465767604" onmouseenter="enter('2845204764465767604');" onmouseout="out('2845204764465767604');" style=""> 185         for (OrderPayment payment : paymentsToInvalidate) {                                              </span>
<span class="7985051489455715642" onmouseenter="enter('7985051489455715642');" onmouseout="out('7985051489455715642');" style=""> 186             cart.getPayments().remove(payment);                                                          </span>
<span class="2733206040956525892" onmouseenter="enter('2733206040956525892');" onmouseout="out('2733206040956525892');" style=""> 187             if (paymentGatewayCheckoutService != null) {                                                 </span>
<span class="-6402023943636930644" onmouseenter="enter('-6402023943636930644');" onmouseout="out('-6402023943636930644');" style=""> 188                 paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190         }                                                                                                </span>
<span  style=""> 191                                                                                                          </span>
<span class="6556873303965518105" onmouseenter="enter('6556873303965518105');" onmouseout="out('6556873303965518105');" style=""> 192         //Create a new Order Payment of the passed in type                                               </span>
<span class="6833494301693157359" onmouseenter="enter('6833494301693157359');" onmouseout="out('6833494301693157359');" style=""> 193         OrderPayment passthroughPayment = orderPaymentService.create();                                  </span>
<span class="9147888607418772106" onmouseenter="enter('9147888607418772106');" onmouseout="out('9147888607418772106');" style=""> 194         passthroughPayment.setType(paymentType);                                                         </span>
<span class="-2427612793458922324" onmouseenter="enter('-2427612793458922324');" onmouseout="out('-2427612793458922324');" style=""> 195         passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);                        </span>
<span class="5974726468545546735" onmouseenter="enter('5974726468545546735');" onmouseout="out('5974726468545546735');" style=""> 196         passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());                               </span>
<span class="-4386080588835248255" onmouseenter="enter('-4386080588835248255');" onmouseout="out('-4386080588835248255');" style=""> 197         passthroughPayment.setOrder(cart);                                                               </span>
<span  style=""> 198                                                                                                          </span>
<span class="-1563843751557855690" onmouseenter="enter('-1563843751557855690');" onmouseout="out('-1563843751557855690');" style=""> 199         // Create the transaction for the payment                                                        </span>
<span class="-4070171252423561334" onmouseenter="enter('-4070171252423561334');" onmouseout="out('-4070171252423561334');" style=""> 200         PaymentTransaction transaction = orderPaymentService.createTransaction();                        </span>
<span class="-7489203339293438896" onmouseenter="enter('-7489203339293438896');" onmouseout="out('-7489203339293438896');" style=""> 201         transaction.setAmount(cart.getTotalAfterAppliedPayments());                                      </span>
<span class="4158351209072946081" onmouseenter="enter('4158351209072946081');" onmouseout="out('4158351209072946081');" style=""> 202         transaction.setRawResponse(&quot;Passthrough Payment&quot;);                                               </span>
<span class="3734380173590255888" onmouseenter="enter('3734380173590255888');" onmouseout="out('3734380173590255888');" style=""> 203         transaction.setSuccess(true);                                                                    </span>
<span class="1663782738889042400" onmouseenter="enter('1663782738889042400');" onmouseout="out('1663782738889042400');" style=""> 204         transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);                               </span>
<span class="8694399832927225044" onmouseenter="enter('8694399832927225044');" onmouseout="out('8694399832927225044');" style=""><abbr title=" 205         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 205         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymeðŸ”µ</abbr></span>
<span  style=""> 206                                                                                                          </span>
<span class="-6972575699192592583" onmouseenter="enter('-6972575699192592583');" onmouseout="out('-6972575699192592583');" style=""> 207         transaction.setOrderPayment(passthroughPayment);                                                 </span>
<span class="-7763228653556987209" onmouseenter="enter('-7763228653556987209');" onmouseout="out('-7763228653556987209');" style=""> 208         passthroughPayment.addTransaction(transaction);                                                  </span>
<span class="8603709849878582824" onmouseenter="enter('8603709849878582824');" onmouseout="out('8603709849878582824');" style=""> 209         orderService.addPaymentToOrder(cart, passthroughPayment, null);                                  </span>
<span  style=""> 210                                                                                                          </span>
<span class="4560736780407557680" onmouseenter="enter('4560736780407557680');" onmouseout="out('4560736780407557680');" style=""> 211         orderService.save(cart, true);                                                                   </span>
<span  style=""> 212                                                                                                          </span>
<span class="-4135330013633253420" onmouseenter="enter('-4135330013633253420');" onmouseout="out('-4135330013633253420');" style=""> 213         return processCompleteCheckoutOrderFinalized(redirectAttributes);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 214     }                                                                                                    </span>
<span  style=""> 215                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 216     /**                                                                                                  </span>
<span class="5444184320192604762" onmouseenter="enter('5444184320192604762');" onmouseout="out('5444184320192604762');" style=""> 217      * If the order has been finalized. i.e. all the payments have been applied to the order,            </span>
<span class="-4344413587104948495" onmouseenter="enter('-4344413587104948495');" onmouseout="out('-4344413587104948495');" style=""> 218      * then you can go ahead and call checkout using the passed in order id.                             </span>
<span class="1950207948444662969" onmouseenter="enter('1950207948444662969');" onmouseout="out('1950207948444662969');" style=""><abbr title=" 219      * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 219      * This is usually called from a Review Page or if enough Payments have been applied to the Order to ðŸ”µ</abbr></span>
<span class="-3475024975033618642" onmouseenter="enter('-3475024975033618642');" onmouseout="out('-3475024975033618642');" style=""><abbr title=" 220      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or"> 220      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway,ðŸ”µ</abbr></span>
<span class="-6748371112848020818" onmouseenter="enter('-6748371112848020818');" onmouseout="out('-6748371112848020818');" style=""><abbr title=" 221      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)"> 221      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express CheckoutðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 222      *                                                                                                   </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 223      * @return                                                                                           </span>
<span class="3682579759887248937" onmouseenter="enter('3682579759887248937');" onmouseout="out('3682579759887248937');" style=""> 224      * @throws Exception                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 225      */                                                                                                  </span>
<span class="5934204782612418166" onmouseenter="enter('5934204782612418166');" onmouseout="out('5934204782612418166');" style=""><abbr title=" 226     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 226     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throðŸ”µ</abbr></span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 227         Order cart = CartState.getCart();                                                                </span>
<span class="-410038182464695226" onmouseenter="enter('-410038182464695226');" onmouseout="out('-410038182464695226');" style=""> 228         String param = &quot;&quot;;                                                                               </span>
<span class="2369429717891499715" onmouseenter="enter('2369429717891499715');" onmouseout="out('2369429717891499715');" style=""> 229         if (cart != null &amp;&amp; !(cart instanceof NullOrderImpl)) {                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 230             try {                                                                                        </span>
<span class="5077673579105987976" onmouseenter="enter('5077673579105987976');" onmouseout="out('5077673579105987976');" style=""><abbr title=" 231                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 231                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties()ðŸ”µ</abbr></span>
<span class="-8024522286989825000" onmouseenter="enter('-8024522286989825000');" onmouseout="out('-8024522286989825000');" style=""> 232                 if(o!=null &amp;&amp; (Boolean) o){                                                              </span>
<span class="-1469060214097397333" onmouseenter="enter('-1469060214097397333');" onmouseout="out('-1469060214097397333');" style=""><abbr title=" 233                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 233                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order pðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 234                 }                                                                                        </span>
<span class="3169004698733361531" onmouseenter="enter('3169004698733361531');" onmouseout="out('3169004698733361531');" style=""> 235                 String orderNumber = initiateCheckout(cart.getId());                                     </span>
<span class="-8482400126440404484" onmouseenter="enter('-8482400126440404484');" onmouseout="out('-8482400126440404484');" style=""> 236                 return getConfirmationViewRedirect(orderNumber);                                         </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 237             } catch (Exception e) {                                                                      </span>
<span class="3063554684989481043" onmouseenter="enter('3063554684989481043');" onmouseout="out('3063554684989481043');" style=""> 238                 handleProcessingException(e, redirectAttributes);                                        </span>
<span class="-6955630417980650572" onmouseenter="enter('-6955630417980650572');" onmouseout="out('-6955630417980650572');" style=""> 239                 if(CustomerState.getCustomer().isAnonymous()){                                           </span>
<span class="-3581136138458844540" onmouseenter="enter('-3581136138458844540');" onmouseout="out('-3581136138458844540');" style=""> 240                     param=&quot;?guest-checkout=true&quot;;                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 241                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 242             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 243         }                                                                                                </span>
<span  style=""> 244                                                                                                          </span>
<span class="7598536375028459133" onmouseenter="enter('7598536375028459133');" onmouseout="out('7598536375028459133');" style=""> 245 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE                                                                                             </span>
<span class="2502130438452954953" onmouseenter="enter('2502130438452954953');" onmouseout="out('2502130438452954953');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 246         return getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=true&quot; : &quot;&quot;);"> 246         return getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=ðŸ”µ</abbr></span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 247 ||||||| BASE                                                                                             </span>
<span class="1317425097473825953" onmouseenter="enter('1317425097473825953');" onmouseout="out('1317425097473825953');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248         return getCheckoutPageRedirect();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249     }                                                                                                    </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 250 =======                                                                                                  </span>
<span class="-2511614893152452019" onmouseenter="enter('-2511614893152452019');" onmouseout="out('-2511614893152452019');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251         return getCheckoutPageRedirect()+param;                                                          </span>
<span class="-5027112130205478640" onmouseenter="enter('-5027112130205478640');" onmouseout="out('-5027112130205478640');" style=""> 252 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 253     }                                                                                                    </span>
<span  style=""> 254                                                                                                          </span>
<span class="-8815074004281580350" onmouseenter="enter('-8815074004281580350');" onmouseout="out('-8815074004281580350');" style=""> 255     public String initiateCheckout(Long orderId) throws Exception{                                       </span>
<span class="2438321416231783030" onmouseenter="enter('2438321416231783030');" onmouseout="out('2438321416231783030');" style=""> 256         if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {                                  </span>
<span class="6065180908645754023" onmouseenter="enter('6065180908645754023');" onmouseout="out('6065180908645754023');" style=""> 257             return paymentGatewayCheckoutService.initiateCheckout(orderId);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 258         }                                                                                                </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 259         return null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 260     }                                                                                                    </span>
<span  style=""> 261                                                                                                          </span>
<span class="-994952694334569484" onmouseenter="enter('-994952694334569484');" onmouseout="out('-994952694334569484');" style=""><abbr title=" 262     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 262     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymðŸ”µ</abbr></span>
<span class="8461701443473900494" onmouseenter="enter('8461701443473900494');" onmouseout="out('8461701443473900494');" style=""><abbr title=" 263         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 263         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect AttribuðŸ”µ</abbr></span>
<span  style=""> 264                                                                                                          </span>
<span class="-6915919722100840508" onmouseenter="enter('-6915919722100840508');" onmouseout="out('-6915919722100840508');" style=""> 265         Throwable cause = e.getCause();                                                                  </span>
<span  style=""> 266                                                                                                          </span>
<span class="4727501192160255118" onmouseenter="enter('4727501192160255118');" onmouseout="out('4727501192160255118');" style=""> 267         if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {         </span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 268             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,   </span>
<span class="-6443240451698207116" onmouseenter="enter('-6443240451698207116');" onmouseout="out('-6443240451698207116');" style=""> 269                     PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());           </span>
<span class="6281078227744959351" onmouseenter="enter('6281078227744959351');" onmouseout="out('6281078227744959351');" style=""><abbr title=" 270         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredException) {"> 270         }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferEðŸ”µ</abbr></span>
<span class="5919541454818639441" onmouseenter="enter('5919541454818639441');" onmouseout="out('5919541454818639441');" style=""><abbr title=" 271             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMessage();"> 271             String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() ðŸ”µ</abbr></span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 272             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,   </span>
<span class="-463279655468150766" onmouseenter="enter('-463279655468150766');" onmouseout="out('-463279655468150766');" style=""> 273                     message);                                                                            </span>
<span class="-6556537329766607120" onmouseenter="enter('-6556537329766607120');" onmouseout="out('-6556537329766607120');" style=""> 274         } else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferMaxUseExceededException) {            </span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 275             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,   </span>
<span class="-536931781667901612" onmouseenter="enter('-536931781667901612');" onmouseout="out('-536931781667901612');" style=""> 276                     &quot;There was an error during checkout:&quot;+cause.getCause().getMessage());                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 277         } else {                                                                                         </span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 278             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,   </span>
<span class="3844015022951785414" onmouseenter="enter('3844015022951785414');" onmouseout="out('3844015022951785414');" style=""> 279                     PaymentGatewayAbstractController.getProcessingErrorMessage());                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 280         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 281     }                                                                                                    </span>
<span  style=""> 282                                                                                                          </span>
<span class="7031853357863121773" onmouseenter="enter('7031853357863121773');" onmouseout="out('7031853357863121773');" style=""> 283     public String getBaseConfirmationRedirect() {                                                        </span>
<span class="-3466839714243703616" onmouseenter="enter('-3466839714243703616');" onmouseout="out('-3466839714243703616');" style=""> 284         return baseConfirmationRedirect;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285     }                                                                                                    </span>
<span  style=""> 286                                                                                                          </span>
<span class="4806113959052613483" onmouseenter="enter('4806113959052613483');" onmouseout="out('4806113959052613483');" style=""> 287     protected String getConfirmationViewRedirect(String orderNumber) {                                   </span>
<span class="1954583273870042792" onmouseenter="enter('1954583273870042792');" onmouseout="out('1954583273870042792');" style=""> 288         return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 289     }                                                                                                    </span>
<span  style=""> 290                                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 291 }                                                                                                        </span>

</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="6211491254187717485" onmouseenter="enter('6211491254187717485');" onmouseout="out('6211491254187717485');" style="">   3  * BroadleafCommerce Framework Web                                                                       </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-8629421599793957064" onmouseenter="enter('-8629421599793957064');" onmouseout="out('-8629421599793957064');" style="">  18 package org.broadleafcommerce.core.web.controller.checkout;                                              </span>
<span  style="">  19                                                                                                          </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  20 import java.util.ArrayList;                                                                              </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  21 import java.util.List;                                                                                   </span>
<span class="-2972028083581866805" onmouseenter="enter('-2972028083581866805');" onmouseout="out('-2972028083581866805');" style="">  22 import javax.servlet.http.HttpServletRequest;                                                            </span>
<span class="-2247759832438184775" onmouseenter="enter('-2247759832438184775');" onmouseout="out('-2247759832438184775');" style="">  23 import javax.servlet.http.HttpServletResponse;                                                           </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  24 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  25 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  26 import org.broadleafcommerce.common.exception.ServiceException;                                          </span>
<span class="5237224010034497476" onmouseenter="enter('5237224010034497476');" onmouseout="out('5237224010034497476');" style="">  27 import org.broadleafcommerce.common.payment.PaymentGatewayType;                                          </span>
<span class="479407306950343868" onmouseenter="enter('479407306950343868');" onmouseout="out('479407306950343868');" style="">  28 import org.broadleafcommerce.common.payment.PaymentTransactionType;                                      </span>
<span class="7974202605197813097" onmouseenter="enter('7974202605197813097');" onmouseout="out('7974202605197813097');" style="">  29 import org.broadleafcommerce.common.payment.PaymentType;                                                 </span>
<span class="-2982073195956465030" onmouseenter="enter('-2982073195956465030');" onmouseout="out('-2982073195956465030');" style="">  30 import org.broadleafcommerce.common.vendor.service.exception.PaymentException;                           </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  31 import org.broadleafcommerce.common.web.BroadleafRequestContext;                                         </span>
<span class="-1388823727075420947" onmouseenter="enter('-1388823727075420947');" onmouseout="out('-1388823727075420947');" style="">  32 import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;             </span>
<span class="-1537931304336191501" onmouseenter="enter('-1537931304336191501');" onmouseout="out('-1537931304336191501');" style="">  33 import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;                  </span>
<span class="-6326345691456347408" onmouseenter="enter('-6326345691456347408');" onmouseout="out('-6326345691456347408');" style="">  34 import org.broadleafcommerce.core.offer.service.OfferServiceImpl;                                        </span>
<span class="7718612833831637853" onmouseenter="enter('7718612833831637853');" onmouseout="out('7718612833831637853');" style="">  35 import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;                         </span>
<span class="2542407303560298775" onmouseenter="enter('2542407303560298775');" onmouseout="out('2542407303560298775');" style="">  36 import org.broadleafcommerce.core.offer.service.exception.OfferMaxUseExceededException;                  </span>
<span class="6568352354414313904" onmouseenter="enter('6568352354414313904');" onmouseout="out('6568352354414313904');" style="">  37 import org.broadleafcommerce.core.order.domain.NullOrderImpl;                                            </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  38 import org.broadleafcommerce.core.order.domain.Order;                                                    </span>
<span class="-8548142165698551205" onmouseenter="enter('-8548142165698551205');" onmouseout="out('-8548142165698551205');" style="">  39 import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;                 </span>
<span class="-5209046066651310391" onmouseenter="enter('-5209046066651310391');" onmouseout="out('-5209046066651310391');" style="">  40 import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;         </span>
<span class="725806334255742314" onmouseenter="enter('725806334255742314');" onmouseout="out('725806334255742314');" style="">  41 import org.broadleafcommerce.core.payment.domain.OrderPayment;                                           </span>
<span class="-3835471990257693692" onmouseenter="enter('-3835471990257693692');" onmouseout="out('-3835471990257693692');" style="">  42 import org.broadleafcommerce.core.payment.domain.PaymentTransaction;                                     </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  43 import org.broadleafcommerce.core.pricing.service.exception.PricingException;                            </span>
<span class="8867715597751215715" onmouseenter="enter('8867715597751215715');" onmouseout="out('8867715597751215715');" style="">  44 import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;                                      </span>
<span class="-8122138792032766956" onmouseenter="enter('-8122138792032766956');" onmouseout="out('-8122138792032766956');" style="">  45 import org.broadleafcommerce.core.web.order.CartState;                                                   </span>
<span class="-6031821648249405492" onmouseenter="enter('-6031821648249405492');" onmouseout="out('-6031821648249405492');" style="">  46 import org.broadleafcommerce.profile.web.core.CustomerState;                                             </span>
<span class="2230089600625206822" onmouseenter="enter('2230089600625206822');" onmouseout="out('2230089600625206822');" style="">  47 import org.springframework.ui.Model;                                                                     </span>
<span class="-5446610002806720528" onmouseenter="enter('-5446610002806720528');" onmouseout="out('-5446610002806720528');" style="">  48 import org.springframework.validation.BindingResult;                                                     </span>
<span class="4289605998216587359" onmouseenter="enter('4289605998216587359');" onmouseout="out('4289605998216587359');" style="">  49 import org.springframework.web.servlet.mvc.support.RedirectAttributes;                                   </span>
<span  style="">  50                                                                                                          </span>
<span  style="">  51                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  52 /**                                                                                                      </span>
<span class="8742371521735015235" onmouseenter="enter('8742371521735015235');" onmouseout="out('8742371521735015235');" style="">  53  * In charge of performing the various checkout operations                                               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  54  *                                                                                                       </span>
<span class="-346667533686466806" onmouseenter="enter('-346667533686466806');" onmouseout="out('-346667533686466806');" style="">  55  * @author Andre Azzolini (apazzolini)                                                                   </span>
<span class="-7691131132890779522" onmouseenter="enter('-7691131132890779522');" onmouseout="out('-7691131132890779522');" style="">  56  * @author Elbert Bautista (elbertbautista)                                                              </span>
<span class="6360699620585460494" onmouseenter="enter('6360699620585460494');" onmouseout="out('6360699620585460494');" style="">  57  * @author Joshua Skorton (jskorton)                                                                     </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  58  */                                                                                                      </span>
<span class="7030698850353387546" onmouseenter="enter('7030698850353387546');" onmouseout="out('7030698850353387546');" style="">  59 public class BroadleafCheckoutController extends AbstractCheckoutController {                            </span>
<span class="-5830014166099721744" onmouseenter="enter('-5830014166099721744');" onmouseout="out('-5830014166099721744');" style="">  60     private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);                 </span>
<span  style="">  61                                                                                                          </span>
<span class="6427092946309232849" onmouseenter="enter('6427092946309232849');" onmouseout="out('6427092946309232849');" style="">  62     protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;                         </span>
<span  style="">  63                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  64     /**                                                                                                  </span>
<span class="-5096071225963020400" onmouseenter="enter('-5096071225963020400');" onmouseout="out('-5096071225963020400');" style="">  65      * Renders the default checkout page and allows modules to add variables to the model.               </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  66      *                                                                                                   </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style="">  67      * @param request                                                                                    </span>
<span class="592482809986819432" onmouseenter="enter('592482809986819432');" onmouseout="out('592482809986819432');" style="">  68      * @param response                                                                                   </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  69      * @param model                                                                                      </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  70      * @param model                                                                                      </span>
<span class="-2950909643428865356" onmouseenter="enter('-2950909643428865356');" onmouseout="out('-2950909643428865356');" style="">  71      * @return the checkout view path                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  72      */                                                                                                  </span>
<span class="-967467976240534127" onmouseenter="enter('-967467976240534127');" onmouseout="out('-967467976240534127');" style="">  73     public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,        </span>
<span class="696875836648250935" onmouseenter="enter('696875836648250935');" onmouseout="out('696875836648250935');" style="">  74             RedirectAttributes redirectAttributes) {                                                     </span>
<span class="270872852217962230" onmouseenter="enter('270872852217962230');" onmouseout="out('270872852217962230');" style="">  75         preValidateCartOperation(model);                                                                 </span>
<span class="-1086353471713277153" onmouseenter="enter('-1086353471713277153');" onmouseout="out('-1086353471713277153');" style="">  76         populateModelWithReferenceData(request, model);                                                  </span>
<span  style="">  77                                                                                                          </span>
<span class="-1859137930126069715" onmouseenter="enter('-1859137930126069715');" onmouseout="out('-1859137930126069715');" style="">  78         return getCheckoutView();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  79     }                                                                                                    </span>
<span  style="">  80                                                                                                          </span>
<span class="3128862131256497566" onmouseenter="enter('3128862131256497566');" onmouseout="out('3128862131256497566');" style="">  81     protected void preValidateCartOperation(Model model) {                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  82         try {                                                                                            </span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style="">  83             Order cart = CartState.getCart();                                                            </span>
<span class="8317005274507227996" onmouseenter="enter('8317005274507227996');" onmouseout="out('8317005274507227996');" style="">  84             orderService.preValidateCartOperation(cart);                                                 </span>
<span class="-7281640055951108504" onmouseenter="enter('-7281640055951108504');" onmouseout="out('-7281640055951108504');" style="">  85         } catch (IllegalCartOperationException ex) {                                                     </span>
<span class="339425943881620554" onmouseenter="enter('339425943881620554');" onmouseout="out('339425943881620554');" style="">  86             model.addAttribute(&quot;cartRequiresLock&quot;, true);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  87         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  88     }                                                                                                    </span>
<span  style="">  89                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  90     /**                                                                                                  </span>
<span class="1130589780629338932" onmouseenter="enter('1130589780629338932');" onmouseout="out('1130589780629338932');" style="">  91      * Renders checkout stages partial at the requested stage                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  92      *                                                                                                   </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style="">  93      * @param request                                                                                    </span>
<span class="592482809986819432" onmouseenter="enter('592482809986819432');" onmouseout="out('592482809986819432');" style="">  94      * @param response                                                                                   </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  95      * @param model                                                                                      </span>
<span class="4895955032086297450" onmouseenter="enter('4895955032086297450');" onmouseout="out('4895955032086297450');" style="">  96      * @param stage                                                                                      </span>
<span class="-7461455283175296223" onmouseenter="enter('-7461455283175296223');" onmouseout="out('-7461455283175296223');" style="">  97      * @return the checkout stages partial path                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  98      */                                                                                                  </span>
<span class="-7433197152380805769" onmouseenter="enter('-7433197152380805769');" onmouseout="out('-7433197152380805769');" style=""><abbr title="  99     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,">  99     public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, ModelðŸ”µ</abbr></span>
<span class="2266763686826895306" onmouseenter="enter('2266763686826895306');" onmouseout="out('2266763686826895306');" style=""> 100             String stage, RedirectAttributes redirectAttributes) {                                       </span>
<span class="3963575602163400700" onmouseenter="enter('3963575602163400700');" onmouseout="out('3963575602163400700');" style=""> 101         model.addAttribute(ACTIVE_STAGE, stage);                                                         </span>
<span class="-3680994274736134122" onmouseenter="enter('-3680994274736134122');" onmouseout="out('-3680994274736134122');" style=""> 102         return getCheckoutStagesPartial();                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 103     }                                                                                                    </span>
<span  style=""> 104                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 105     /**                                                                                                  </span>
<span class="6425048121249974617" onmouseenter="enter('6425048121249974617');" onmouseout="out('6425048121249974617');" style=""> 106      * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously             </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style=""> 107      * @param request                                                                                    </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style=""> 108      * @param model                                                                                      </span>
<span class="-4336315843383652520" onmouseenter="enter('-4336315843383652520');" onmouseout="out('-4336315843383652520');" style=""> 109      * @param orderInfoForm                                                                              </span>
<span class="471163069337744535" onmouseenter="enter('471163069337744535');" onmouseout="out('471163069337744535');" style=""> 110      * @param result                                                                                     </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 111      * @return                                                                                           </span>
<span class="8449301783782133383" onmouseenter="enter('8449301783782133383');" onmouseout="out('8449301783782133383');" style=""> 112      * @throws ServiceException                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 113      */                                                                                                  </span>
<span class="7833752547156411123" onmouseenter="enter('7833752547156411123');" onmouseout="out('7833752547156411123');" style=""> 114     public String saveGlobalOrderDetails(HttpServletRequest request, Model model,                        </span>
<span class="2885692691175911068" onmouseenter="enter('2885692691175911068');" onmouseout="out('2885692691175911068');" style=""> 115             OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {                 </span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 116         Order cart = CartState.getCart();                                                                </span>
<span  style=""> 117                                                                                                          </span>
<span class="-4853722722374659261" onmouseenter="enter('-4853722722374659261');" onmouseout="out('-4853722722374659261');" style=""> 118         orderInfoFormValidator.validate(orderInfoForm, result);                                          </span>
<span class="4556169223967360348" onmouseenter="enter('4556169223967360348');" onmouseout="out('4556169223967360348');" style=""> 119         if (result.hasErrors()) {                                                                        </span>
<span class="4925675922142494738" onmouseenter="enter('4925675922142494738');" onmouseout="out('4925675922142494738');" style=""> 120             // We need to clear the email on error in case they are trying to edit it                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 121             try {                                                                                        </span>
<span class="-6542315142466769644" onmouseenter="enter('-6542315142466769644');" onmouseout="out('-6542315142466769644');" style=""> 122                 cart.setEmailAddress(null);                                                              </span>
<span class="2575162925158509166" onmouseenter="enter('2575162925158509166');" onmouseout="out('2575162925158509166');" style=""> 123                 orderService.save(cart, false);                                                          </span>
<span class="-7664829891190352303" onmouseenter="enter('-7664829891190352303');" onmouseout="out('-7664829891190352303');" style=""> 124             } catch (PricingException pe) {                                                              </span>
<span class="-7018185772171393940" onmouseenter="enter('-7018185772171393940');" onmouseout="out('-7018185772171393940');" style=""> 125                 LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 126             }                                                                                            </span>
<span  style=""> 127                                                                                                          </span>
<span class="-1086353471713277153" onmouseenter="enter('-1086353471713277153');" onmouseout="out('-1086353471713277153');" style=""> 128             populateModelWithReferenceData(request, model);                                              </span>
<span class="-1859137930126069715" onmouseenter="enter('-1859137930126069715');" onmouseout="out('-1859137930126069715');" style=""> 129             return getCheckoutView();                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 130         }                                                                                                </span>
<span  style=""> 131                                                                                                          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 132         try {                                                                                            </span>
<span class="-4094676742804741694" onmouseenter="enter('-4094676742804741694');" onmouseout="out('-4094676742804741694');" style=""> 133             cart.setEmailAddress(orderInfoForm.getEmailAddress());                                       </span>
<span class="2575162925158509166" onmouseenter="enter('2575162925158509166');" onmouseout="out('2575162925158509166');" style=""> 134             orderService.save(cart, false);                                                              </span>
<span class="-7664829891190352303" onmouseenter="enter('-7664829891190352303');" onmouseout="out('-7664829891190352303');" style=""> 135         } catch (PricingException pe) {                                                                  </span>
<span class="-7018185772171393940" onmouseenter="enter('-7018185772171393940');" onmouseout="out('-7018185772171393940');" style=""> 136             LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137         }                                                                                                </span>
<span  style=""> 138                                                                                                          </span>
<span class="1317425097473825953" onmouseenter="enter('1317425097473825953');" onmouseout="out('1317425097473825953');" style=""> 139         return getCheckoutPageRedirect();                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 140     }                                                                                                    </span>
<span  style=""> 141                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 142     /**                                                                                                  </span>
<span class="7448664771981292412" onmouseenter="enter('7448664771981292412');" onmouseout="out('7448664771981292412');" style=""> 143      * Creates a pass-through payment of the PaymentType passed in with                                  </span>
<span class="421012101637192710" onmouseenter="enter('421012101637192710');" onmouseout="out('421012101637192710');" style=""> 144      * an amount equal to the order total after any non-final applied payments.                          </span>
<span class="8025235098781395569" onmouseenter="enter('8025235098781395569');" onmouseout="out('8025235098781395569');" style=""> 145      * (for example gift cards, customer credit, or third party accounts)                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 146      *                                                                                                   </span>
<span class="-6096085412817911554" onmouseenter="enter('-6096085412817911554');" onmouseout="out('-6096085412817911554');" style=""> 147      * This intended to be used in cases like COD and other Payment Types where implementations wish     </span>
<span class="974612727386255560" onmouseenter="enter('974612727386255560');" onmouseout="out('974612727386255560');" style=""> 148      * to just checkout without having to do any payment processing.                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 149      *                                                                                                   </span>
<span class="-7601184109281730645" onmouseenter="enter('-7601184109281730645');" onmouseout="out('-7601184109281730645');" style=""> 150      * This default implementations assumes that the pass-through payment is the only                    </span>
<span class="-4077415547304827420" onmouseenter="enter('-4077415547304827420');" onmouseout="out('-4077415547304827420');" style=""> 151      * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED </span>
<span class="36099180133309792" onmouseenter="enter('36099180133309792');" onmouseout="out('36099180133309792');" style=""><abbr title=" 152      * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 152      * That means that it will look at all transactions on the order payment and see if it has unconfirmeðŸ”µ</abbr></span>
<span class="780949603230510899" onmouseenter="enter('780949603230510899');" onmouseout="out('780949603230510899');" style=""> 153      * If it does, it will not remove it.                                                                </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 154      *                                                                                                   </span>
<span class="-2081180607706702192" onmouseenter="enter('-2081180607706702192');" onmouseout="out('-2081180607706702192');" style=""> 155      * Make sure not to expose this method in your extended Controller if you do not wish to             </span>
<span class="-9185284612955559377" onmouseenter="enter('-9185284612955559377');" onmouseout="out('-9185284612955559377');" style=""> 156      * have this feature enabled.                                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 157      *                                                                                                   </span>
<span class="9045397892808778291" onmouseenter="enter('9045397892808778291');" onmouseout="out('9045397892808778291');" style=""> 158      * @param redirectAttributes                                                                         </span>
<span class="-6271960972125413074" onmouseenter="enter('-6271960972125413074');" onmouseout="out('-6271960972125413074');" style=""> 159      * @param paymentType                                                                                </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 160      * @return                                                                                           </span>
<span class="2740930998571054578" onmouseenter="enter('2740930998571054578');" onmouseout="out('2740930998571054578');" style=""> 161      * @throws PaymentException                                                                          </span>
<span class="-7962706440062724544" onmouseenter="enter('-7962706440062724544');" onmouseout="out('-7962706440062724544');" style=""> 162      * @throws PricingException                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 163      */                                                                                                  </span>
<span class="-6736963433386757064" onmouseenter="enter('-6736963433386757064');" onmouseout="out('-6736963433386757064');" style=""> 164     public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,                </span>
<span class="-4251657370959523100" onmouseenter="enter('-4251657370959523100');" onmouseout="out('-4251657370959523100');" style=""><abbr title=" 165                                              PaymentType paymentType) throws PaymentException, PricingException {"> 165                                              PaymentType paymentType) throws PaymentException, PricingExcðŸ”µ</abbr></span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 166         Order cart = CartState.getCart();                                                                </span>
<span  style=""> 167                                                                                                          </span>
<span class="8276989610904881201" onmouseenter="enter('8276989610904881201');" onmouseout="out('8276989610904881201');" style=""><abbr title=" 168         //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED"> 168         //Invalidate any payments already on the order that do not have transactions on them that are UNCðŸ”µ</abbr></span>
<span class="-6892905423713233256" onmouseenter="enter('-6892905423713233256');" onmouseout="out('-6892905423713233256');" style=""> 169         List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();                         </span>
<span class="-6512141134753607370" onmouseenter="enter('-6512141134753607370');" onmouseout="out('-6512141134753607370');" style=""> 170         for (OrderPayment payment : cart.getPayments()) {                                                </span>
<span class="2703717333279802826" onmouseenter="enter('2703717333279802826');" onmouseout="out('2703717333279802826');" style=""> 171             if (payment.isActive()) {                                                                    </span>
<span class="1010327443504623706" onmouseenter="enter('1010327443504623706');" onmouseout="out('1010327443504623706');" style=""> 172                 if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {          </span>
<span class="-9174713251656761482" onmouseenter="enter('-9174713251656761482');" onmouseout="out('-9174713251656761482');" style=""> 173                     paymentsToInvalidate.add(payment);                                                   </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 174                 } else {                                                                                 </span>
<span class="4783701959626342440" onmouseenter="enter('4783701959626342440');" onmouseout="out('4783701959626342440');" style=""> 175                     for (PaymentTransaction transaction : payment.getTransactions()) {                   </span>
<span class="1226189291557269996" onmouseenter="enter('1226189291557269996');" onmouseout="out('1226189291557269996');" style=""> 176                         if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {         </span>
<span class="-9174713251656761482" onmouseenter="enter('-9174713251656761482');" onmouseout="out('-9174713251656761482');" style=""> 177                              paymentsToInvalidate.add(payment);                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 178                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182         }                                                                                                </span>
<span  style=""> 183                                                                                                          </span>
<span class="2845204764465767604" onmouseenter="enter('2845204764465767604');" onmouseout="out('2845204764465767604');" style=""> 184         for (OrderPayment payment : paymentsToInvalidate) {                                              </span>
<span class="7985051489455715642" onmouseenter="enter('7985051489455715642');" onmouseout="out('7985051489455715642');" style=""> 185             cart.getPayments().remove(payment);                                                          </span>
<span class="2733206040956525892" onmouseenter="enter('2733206040956525892');" onmouseout="out('2733206040956525892');" style=""> 186             if (paymentGatewayCheckoutService != null) {                                                 </span>
<span class="-6402023943636930644" onmouseenter="enter('-6402023943636930644');" onmouseout="out('-6402023943636930644');" style=""> 187                 paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 188             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189         }                                                                                                </span>
<span  style=""> 190                                                                                                          </span>
<span class="6556873303965518105" onmouseenter="enter('6556873303965518105');" onmouseout="out('6556873303965518105');" style=""> 191         //Create a new Order Payment of the passed in type                                               </span>
<span class="6833494301693157359" onmouseenter="enter('6833494301693157359');" onmouseout="out('6833494301693157359');" style=""> 192         OrderPayment passthroughPayment = orderPaymentService.create();                                  </span>
<span class="9147888607418772106" onmouseenter="enter('9147888607418772106');" onmouseout="out('9147888607418772106');" style=""> 193         passthroughPayment.setType(paymentType);                                                         </span>
<span class="-2427612793458922324" onmouseenter="enter('-2427612793458922324');" onmouseout="out('-2427612793458922324');" style=""> 194         passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);                        </span>
<span class="5974726468545546735" onmouseenter="enter('5974726468545546735');" onmouseout="out('5974726468545546735');" style=""> 195         passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());                               </span>
<span class="-4386080588835248255" onmouseenter="enter('-4386080588835248255');" onmouseout="out('-4386080588835248255');" style=""> 196         passthroughPayment.setOrder(cart);                                                               </span>
<span  style=""> 197                                                                                                          </span>
<span class="-1563843751557855690" onmouseenter="enter('-1563843751557855690');" onmouseout="out('-1563843751557855690');" style=""> 198         // Create the transaction for the payment                                                        </span>
<span class="-4070171252423561334" onmouseenter="enter('-4070171252423561334');" onmouseout="out('-4070171252423561334');" style=""> 199         PaymentTransaction transaction = orderPaymentService.createTransaction();                        </span>
<span class="-7489203339293438896" onmouseenter="enter('-7489203339293438896');" onmouseout="out('-7489203339293438896');" style=""> 200         transaction.setAmount(cart.getTotalAfterAppliedPayments());                                      </span>
<span class="4158351209072946081" onmouseenter="enter('4158351209072946081');" onmouseout="out('4158351209072946081');" style=""> 201         transaction.setRawResponse(&quot;Passthrough Payment&quot;);                                               </span>
<span class="3734380173590255888" onmouseenter="enter('3734380173590255888');" onmouseout="out('3734380173590255888');" style=""> 202         transaction.setSuccess(true);                                                                    </span>
<span class="1663782738889042400" onmouseenter="enter('1663782738889042400');" onmouseout="out('1663782738889042400');" style=""> 203         transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);                               </span>
<span class="8694399832927225044" onmouseenter="enter('8694399832927225044');" onmouseout="out('8694399832927225044');" style=""><abbr title=" 204         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 204         transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymeðŸ”µ</abbr></span>
<span  style=""> 205                                                                                                          </span>
<span class="-6972575699192592583" onmouseenter="enter('-6972575699192592583');" onmouseout="out('-6972575699192592583');" style=""> 206         transaction.setOrderPayment(passthroughPayment);                                                 </span>
<span class="-7763228653556987209" onmouseenter="enter('-7763228653556987209');" onmouseout="out('-7763228653556987209');" style=""> 207         passthroughPayment.addTransaction(transaction);                                                  </span>
<span class="8603709849878582824" onmouseenter="enter('8603709849878582824');" onmouseout="out('8603709849878582824');" style=""> 208         orderService.addPaymentToOrder(cart, passthroughPayment, null);                                  </span>
<span  style=""> 209                                                                                                          </span>
<span class="4560736780407557680" onmouseenter="enter('4560736780407557680');" onmouseout="out('4560736780407557680');" style=""> 210         orderService.save(cart, true);                                                                   </span>
<span  style=""> 211                                                                                                          </span>
<span class="-4135330013633253420" onmouseenter="enter('-4135330013633253420');" onmouseout="out('-4135330013633253420');" style=""> 212         return processCompleteCheckoutOrderFinalized(redirectAttributes);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 213     }                                                                                                    </span>
<span  style=""> 214                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 215     /**                                                                                                  </span>
<span class="5444184320192604762" onmouseenter="enter('5444184320192604762');" onmouseout="out('5444184320192604762');" style=""> 216      * If the order has been finalized. i.e. all the payments have been applied to the order,            </span>
<span class="-4344413587104948495" onmouseenter="enter('-4344413587104948495');" onmouseout="out('-4344413587104948495');" style=""> 217      * then you can go ahead and call checkout using the passed in order id.                             </span>
<span class="1950207948444662969" onmouseenter="enter('1950207948444662969');" onmouseout="out('1950207948444662969');" style=""><abbr title=" 218      * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 218      * This is usually called from a Review Page or if enough Payments have been applied to the Order to ðŸ”µ</abbr></span>
<span class="-3475024975033618642" onmouseenter="enter('-3475024975033618642');" onmouseout="out('-3475024975033618642');" style=""><abbr title=" 219      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or"> 219      * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway,ðŸ”µ</abbr></span>
<span class="-6748371112848020818" onmouseenter="enter('-6748371112848020818');" onmouseout="out('-6748371112848020818');" style=""><abbr title=" 220      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)"> 220      * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express CheckoutðŸ”µ</abbr></span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 221      *                                                                                                   </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 222      * @return                                                                                           </span>
<span class="3682579759887248937" onmouseenter="enter('3682579759887248937');" onmouseout="out('3682579759887248937');" style=""> 223      * @throws Exception                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 224      */                                                                                                  </span>
<span class="5934204782612418166" onmouseenter="enter('5934204782612418166');" onmouseout="out('5934204782612418166');" style=""><abbr title=" 225     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 225     public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throðŸ”µ</abbr></span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 226         Order cart = CartState.getCart();                                                                </span>
<span class="-410038182464695226" onmouseenter="enter('-410038182464695226');" onmouseout="out('-410038182464695226');" style=""> 227         String param = &quot;&quot;;                                                                               </span>
<span class="2044744605960434777" onmouseenter="enter('2044744605960434777');" onmouseout="out('2044744605960434777');" style=""> 228         if ((cart != null) &amp;&amp; (!(cart instanceof NullOrderImpl))) {                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 229             try {                                                                                        </span>
<span class="5077673579105987976" onmouseenter="enter('5077673579105987976');" onmouseout="out('5077673579105987976');" style=""><abbr title=" 230                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 230                 Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties()ðŸ”µ</abbr></span>
<span class="3586598712564634546" onmouseenter="enter('3586598712564634546');" onmouseout="out('3586598712564634546');" style=""> 231                 if ((o != null) &amp;&amp; ((Boolean) (o))) {                                                    </span>
<span class="-1469060214097397333" onmouseenter="enter('-1469060214097397333');" onmouseout="out('-1469060214097397333');" style=""><abbr title=" 232                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 232                     throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order pðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 233                 }                                                                                        </span>
<span class="3169004698733361531" onmouseenter="enter('3169004698733361531');" onmouseout="out('3169004698733361531');" style=""> 234                 String orderNumber = initiateCheckout(cart.getId());                                     </span>
<span class="-8482400126440404484" onmouseenter="enter('-8482400126440404484');" onmouseout="out('-8482400126440404484');" style=""> 235                 return getConfirmationViewRedirect(orderNumber);                                         </span>
<span class="-3589222456918676513" onmouseenter="enter('-3589222456918676513');" onmouseout="out('-3589222456918676513');" style=""> 236             } catch (java.lang.Exception e) {                                                            </span>
<span class="3063554684989481043" onmouseenter="enter('3063554684989481043');" onmouseout="out('3063554684989481043');" style=""> 237                 handleProcessingException(e, redirectAttributes);                                        </span>
<span class="-3608549994385368555" onmouseenter="enter('-3608549994385368555');" onmouseout="out('-3608549994385368555');" style=""> 238                 if (CustomerState.getCustomer().isAnonymous()) {                                         </span>
<span class="4631896438661951415" onmouseenter="enter('4631896438661951415');" onmouseout="out('4631896438661951415');" style=""> 239                     param = &quot;?guest-checkout=true&quot;;                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 240                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 241             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 242         }                                                                                                </span>
<span class="-5451029046232085104" onmouseenter="enter('-5451029046232085104');" onmouseout="out('-5451029046232085104');" style=""> 243         return                                                                                           </span>
<span class="-6681681893462133916" onmouseenter="enter('-6681681893462133916');" onmouseout="out('-6681681893462133916');" style=""> 244 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT                                                                                             </span>
<span class="9047265127958934612" onmouseenter="enter('9047265127958934612');" onmouseout="out('9047265127958934612');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 245 getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=true&quot; : &quot;&quot;)    </span>
<span class="7991106586064342212" onmouseenter="enter('7991106586064342212');" onmouseout="out('7991106586064342212');" style=""> 246 ||||||| BASE                                                                                             </span>
<span class="-3639349873877828882" onmouseenter="enter('-3639349873877828882');" onmouseout="out('-3639349873877828882');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 247 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 247 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 248 =======                                                                                                  </span>
<span  style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249                                                                                                          </span>
<span class="6176541286287188276" onmouseenter="enter('6176541286287188276');" onmouseout="out('6176541286287188276');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250 getCheckoutPageRedirect()+param                                                                          </span>
<span class="-1814092468913316143" onmouseenter="enter('-1814092468913316143');" onmouseout="out('-1814092468913316143');" style=""> 251 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT                                                                                            </span>
<span class="-2934185353411265329" onmouseenter="enter('-2934185353411265329');" onmouseout="out('-2934185353411265329');" style=""> 252         ;                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 253     }                                                                                                    </span>
<span  style=""> 254                                                                                                          </span>
<span class="-8815074004281580350" onmouseenter="enter('-8815074004281580350');" onmouseout="out('-8815074004281580350');" style=""> 255     public String initiateCheckout(Long orderId) throws Exception{                                       </span>
<span class="2438321416231783030" onmouseenter="enter('2438321416231783030');" onmouseout="out('2438321416231783030');" style=""> 256         if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {                                  </span>
<span class="6065180908645754023" onmouseenter="enter('6065180908645754023');" onmouseout="out('6065180908645754023');" style=""> 257             return paymentGatewayCheckoutService.initiateCheckout(orderId);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 258         }                                                                                                </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 259         return null;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 260     }                                                                                                    </span>
<span  style=""> 261                                                                                                          </span>
<span class="-994952694334569484" onmouseenter="enter('-994952694334569484');" onmouseout="out('-994952694334569484');" style=""><abbr title=" 262     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 262     public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymðŸ”µ</abbr></span>
<span class="8461701443473900494" onmouseenter="enter('8461701443473900494');" onmouseout="out('8461701443473900494');" style=""><abbr title=" 263         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 263         LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect AttribuðŸ”µ</abbr></span>
<span class="-6915919722100840508" onmouseenter="enter('-6915919722100840508');" onmouseout="out('-6915919722100840508');" style=""> 264         Throwable cause = e.getCause();                                                                  </span>
<span class="7049134326468387230" onmouseenter="enter('7049134326468387230');" onmouseout="out('7049134326468387230');" style=""> 265         if ((cause != null) &amp;&amp; (cause.getCause() instanceof RequiredAttributeNotProvidedException)) {    </span>
<span class="-2917862096492177345" onmouseenter="enter('-2917862096492177345');" onmouseout="out('-2917862096492177345');" style=""><abbr title=" 266             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());"> 266             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, PaðŸ”µ</abbr></span>
<span class="386536653454936532" onmouseenter="enter('386536653454936532');" onmouseout="out('386536653454936532');" style=""><abbr title=" 267         } else if (((cause != null) &amp;&amp; (cause.getCause() instanceof OfferExpiredException)) || (e instanceof OfferExpiredException)) {"> 267         } else if (((cause != null) &amp;&amp; (cause.getCause() instanceof OfferExpiredException)) || (e instancðŸ”µ</abbr></span>
<span class="-140539628968598155" onmouseenter="enter('-140539628968598155');" onmouseout="out('-140539628968598155');" style=""><abbr title=" 268             String message = ((cause != null) &amp;&amp; (cause.getCause() != null)) ? cause.getCause().getMessage() : e.getMessage();"> 268             String message = ((cause != null) &amp;&amp; (cause.getCause() != null)) ? cause.getCause().getMessagðŸ”µ</abbr></span>
<span class="-8838308748439589023" onmouseenter="enter('-8838308748439589023');" onmouseout="out('-8838308748439589023');" style=""><abbr title=" 269             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, message);"> 269             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, meðŸ”µ</abbr></span>
<span class="3242796474692366438" onmouseenter="enter('3242796474692366438');" onmouseout="out('3242796474692366438');" style=""> 270         } else if ((cause != null) &amp;&amp; (cause.getCause() instanceof OfferMaxUseExceededException)) {      </span>
<span class="3297252057611088493" onmouseenter="enter('3297252057611088493');" onmouseout="out('3297252057611088493');" style=""><abbr title=" 271             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, &quot;There was an error during checkout:&quot; + cause.getCause().getMessage());"> 271             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, &quot;TðŸ”µ</abbr></span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 272         } else {                                                                                         </span>
<span class="-8028226909662518581" onmouseenter="enter('-8028226909662518581');" onmouseout="out('-8028226909662518581');" style=""><abbr title=" 273             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, PaymentGatewayAbstractController.getProcessingErrorMessage());"> 273             redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR, PaðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 274         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 275     }                                                                                                    </span>
<span  style=""> 276                                                                                                          </span>
<span class="7031853357863121773" onmouseenter="enter('7031853357863121773');" onmouseout="out('7031853357863121773');" style=""> 277     public String getBaseConfirmationRedirect() {                                                        </span>
<span class="-3466839714243703616" onmouseenter="enter('-3466839714243703616');" onmouseout="out('-3466839714243703616');" style=""> 278         return baseConfirmationRedirect;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 279     }                                                                                                    </span>
<span  style=""> 280                                                                                                          </span>
<span class="4806113959052613483" onmouseenter="enter('4806113959052613483');" onmouseout="out('4806113959052613483');" style=""> 281     protected String getConfirmationViewRedirect(String orderNumber) {                                   </span>
<span class="1954583273870042792" onmouseenter="enter('1954583273870042792');" onmouseout="out('1954583273870042792');" style=""> 282         return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 283     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 284 }                                                                                                        </span>








</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="6211491254187717485" onmouseenter="enter('6211491254187717485');" onmouseout="out('6211491254187717485');" style="">   3   * BroadleafCommerce Framework Web                                                                                </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-8629421599793957064" onmouseenter="enter('-8629421599793957064');" onmouseout="out('-8629421599793957064');" style="">  18  package org.broadleafcommerce.core.web.controller.checkout;                                                       </span>
<span  style="">  19                                                                                                                    </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  22  import org.broadleafcommerce.common.exception.ServiceException;                                                   </span>
<span class="5237224010034497476" onmouseenter="enter('5237224010034497476');" onmouseout="out('5237224010034497476');" style="">  23  import org.broadleafcommerce.common.payment.PaymentGatewayType;                                                   </span>
<span class="479407306950343868" onmouseenter="enter('479407306950343868');" onmouseout="out('479407306950343868');" style="">  24  import org.broadleafcommerce.common.payment.PaymentTransactionType;                                               </span>
<span class="7974202605197813097" onmouseenter="enter('7974202605197813097');" onmouseout="out('7974202605197813097');" style="">  25  import org.broadleafcommerce.common.payment.PaymentType;                                                          </span>
<span class="-2982073195956465030" onmouseenter="enter('-2982073195956465030');" onmouseout="out('-2982073195956465030');" style="">  26  import org.broadleafcommerce.common.vendor.service.exception.PaymentException;                                    </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  27  import org.broadleafcommerce.common.web.BroadleafRequestContext;                                                  </span>
<span class="-1388823727075420947" onmouseenter="enter('-1388823727075420947');" onmouseout="out('-1388823727075420947');" style="">  28  import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;                      </span>
<span class="-1537931304336191501" onmouseenter="enter('-1537931304336191501');" onmouseout="out('-1537931304336191501');" style="">  29  import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;                           </span>
<span class="-6326345691456347408" onmouseenter="enter('-6326345691456347408');" onmouseout="out('-6326345691456347408');" style="">  30  import org.broadleafcommerce.core.offer.service.OfferServiceImpl;                                                 </span>
<span class="7718612833831637853" onmouseenter="enter('7718612833831637853');" onmouseout="out('7718612833831637853');" style="">  31  import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;                                  </span>

<span class="6568352354414313904" onmouseenter="enter('6568352354414313904');" onmouseout="out('6568352354414313904');" style="">  32  import org.broadleafcommerce.core.order.domain.NullOrderImpl;                                                     </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  33  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="-8548142165698551205" onmouseenter="enter('-8548142165698551205');" onmouseout="out('-8548142165698551205');" style="">  34  import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;                          </span>
<span class="-5209046066651310391" onmouseenter="enter('-5209046066651310391');" onmouseout="out('-5209046066651310391');" style="">  35  import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;                  </span>
<span class="725806334255742314" onmouseenter="enter('725806334255742314');" onmouseout="out('725806334255742314');" style="">  36  import org.broadleafcommerce.core.payment.domain.OrderPayment;                                                    </span>
<span class="-3835471990257693692" onmouseenter="enter('-3835471990257693692');" onmouseout="out('-3835471990257693692');" style="">  37  import org.broadleafcommerce.core.payment.domain.PaymentTransaction;                                              </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  38  import org.broadleafcommerce.core.pricing.service.exception.PricingException;                                     </span>
<span class="8867715597751215715" onmouseenter="enter('8867715597751215715');" onmouseout="out('8867715597751215715');" style="">  39  import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;                                               </span>
<span class="-8122138792032766956" onmouseenter="enter('-8122138792032766956');" onmouseout="out('-8122138792032766956');" style="">  40  import org.broadleafcommerce.core.web.order.CartState;                                                            </span>
<span class="-6031821648249405492" onmouseenter="enter('-6031821648249405492');" onmouseout="out('-6031821648249405492');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  41 +import org.broadleafcommerce.profile.web.core.CustomerState;                                                      </span>
<span class="2230089600625206822" onmouseenter="enter('2230089600625206822');" onmouseout="out('2230089600625206822');" style="">  42  import org.springframework.ui.Model;                                                                              </span>
<span class="-5446610002806720528" onmouseenter="enter('-5446610002806720528');" onmouseout="out('-5446610002806720528');" style="">  43  import org.springframework.validation.BindingResult;                                                              </span>
<span class="4289605998216587359" onmouseenter="enter('4289605998216587359');" onmouseout="out('4289605998216587359');" style="">  44  import org.springframework.web.servlet.mvc.support.RedirectAttributes;                                            </span>
<span  style="">  45                                                                                                                    </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  46  import java.util.ArrayList;                                                                                       </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  47  import java.util.List;                                                                                            </span>
<span  style="">  48                                                                                                                    </span>
<span class="-2972028083581866805" onmouseenter="enter('-2972028083581866805');" onmouseout="out('-2972028083581866805');" style="">  49  import javax.servlet.http.HttpServletRequest;                                                                     </span>
<span class="-2247759832438184775" onmouseenter="enter('-2247759832438184775');" onmouseout="out('-2247759832438184775');" style="">  50  import javax.servlet.http.HttpServletResponse;                                                                    </span>
<span  style="">  51                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  52  /**                                                                                                               </span>
<span class="8742371521735015235" onmouseenter="enter('8742371521735015235');" onmouseout="out('8742371521735015235');" style="">  53   * In charge of performing the various checkout operations                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  54   *                                                                                                                </span>
<span class="-346667533686466806" onmouseenter="enter('-346667533686466806');" onmouseout="out('-346667533686466806');" style="">  55   * @author Andre Azzolini (apazzolini)                                                                            </span>
<span class="-7691131132890779522" onmouseenter="enter('-7691131132890779522');" onmouseout="out('-7691131132890779522');" style="">  56   * @author Elbert Bautista (elbertbautista)                                                                       </span>
<span class="6360699620585460494" onmouseenter="enter('6360699620585460494');" onmouseout="out('6360699620585460494');" style="">  57   * @author Joshua Skorton (jskorton)                                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  58   */                                                                                                               </span>
<span class="7030698850353387546" onmouseenter="enter('7030698850353387546');" onmouseout="out('7030698850353387546');" style="">  59  public class BroadleafCheckoutController extends AbstractCheckoutController {                                     </span>
<span  style="">  60                                                                                                                    </span>
<span class="-5830014166099721744" onmouseenter="enter('-5830014166099721744');" onmouseout="out('-5830014166099721744');" style="">  61      private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);                          </span>
<span class="6427092946309232849" onmouseenter="enter('6427092946309232849');" onmouseout="out('6427092946309232849');" style="">  62      protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;                                  </span>
<span  style="">  63                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  64      /**                                                                                                           </span>
<span class="-5096071225963020400" onmouseenter="enter('-5096071225963020400');" onmouseout="out('-5096071225963020400');" style="">  65       * Renders the default checkout page and allows modules to add variables to the model.                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  66       *                                                                                                            </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style="">  67       * @param request                                                                                             </span>
<span class="592482809986819432" onmouseenter="enter('592482809986819432');" onmouseout="out('592482809986819432');" style="">  68       * @param response                                                                                            </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  69       * @param model                                                                                               </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  70       * @param model                                                                                               </span>
<span class="-2950909643428865356" onmouseenter="enter('-2950909643428865356');" onmouseout="out('-2950909643428865356');" style="">  71       * @return the checkout view path                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  72       */                                                                                                           </span>
<span class="-967467976240534127" onmouseenter="enter('-967467976240534127');" onmouseout="out('-967467976240534127');" style="">  73      public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,                 </span>
<span class="696875836648250935" onmouseenter="enter('696875836648250935');" onmouseout="out('696875836648250935');" style="">  74              RedirectAttributes redirectAttributes) {                                                              </span>
<span class="270872852217962230" onmouseenter="enter('270872852217962230');" onmouseout="out('270872852217962230');" style="">  75          preValidateCartOperation(model);                                                                          </span>
<span class="-1086353471713277153" onmouseenter="enter('-1086353471713277153');" onmouseout="out('-1086353471713277153');" style="">  76          populateModelWithReferenceData(request, model);                                                           </span>
<span  style="">  77                                                                                                                    </span>
<span class="-1859137930126069715" onmouseenter="enter('-1859137930126069715');" onmouseout="out('-1859137930126069715');" style="">  78          return getCheckoutView();                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  79      }                                                                                                             </span>
<span  style="">  80                                                                                                                    </span>
<span class="3128862131256497566" onmouseenter="enter('3128862131256497566');" onmouseout="out('3128862131256497566');" style="">  81      protected void preValidateCartOperation(Model model) {                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  82          try {                                                                                                     </span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style="">  83              Order cart = CartState.getCart();                                                                     </span>
<span class="8317005274507227996" onmouseenter="enter('8317005274507227996');" onmouseout="out('8317005274507227996');" style="">  84              orderService.preValidateCartOperation(cart);                                                          </span>
<span class="-7281640055951108504" onmouseenter="enter('-7281640055951108504');" onmouseout="out('-7281640055951108504');" style="">  85          } catch (IllegalCartOperationException ex) {                                                              </span>
<span class="339425943881620554" onmouseenter="enter('339425943881620554');" onmouseout="out('339425943881620554');" style="">  86              model.addAttribute(&quot;cartRequiresLock&quot;, true);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  87          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  88      }                                                                                                             </span>
<span  style="">  89                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  90      /**                                                                                                           </span>
<span class="1130589780629338932" onmouseenter="enter('1130589780629338932');" onmouseout="out('1130589780629338932');" style="">  91       * Renders checkout stages partial at the requested stage                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  92       *                                                                                                            </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style="">  93       * @param request                                                                                             </span>
<span class="592482809986819432" onmouseenter="enter('592482809986819432');" onmouseout="out('592482809986819432');" style="">  94       * @param response                                                                                            </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  95       * @param model                                                                                               </span>
<span class="4895955032086297450" onmouseenter="enter('4895955032086297450');" onmouseout="out('4895955032086297450');" style="">  96       * @param stage                                                                                               </span>
<span class="-7461455283175296223" onmouseenter="enter('-7461455283175296223');" onmouseout="out('-7461455283175296223');" style="">  97       * @return the checkout stages partial path                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  98       */                                                                                                           </span>
<span class="-7433197152380805769" onmouseenter="enter('-7433197152380805769');" onmouseout="out('-7433197152380805769');" style="">  99      public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,  </span>
<span class="2266763686826895306" onmouseenter="enter('2266763686826895306');" onmouseout="out('2266763686826895306');" style=""> 100              String stage, RedirectAttributes redirectAttributes) {                                                </span>
<span class="3963575602163400700" onmouseenter="enter('3963575602163400700');" onmouseout="out('3963575602163400700');" style=""> 101          model.addAttribute(ACTIVE_STAGE, stage);                                                                  </span>
<span class="-3680994274736134122" onmouseenter="enter('-3680994274736134122');" onmouseout="out('-3680994274736134122');" style=""> 102          return getCheckoutStagesPartial();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 103      }                                                                                                             </span>
<span  style=""> 104                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 105      /**                                                                                                           </span>
<span class="6425048121249974617" onmouseenter="enter('6425048121249974617');" onmouseout="out('6425048121249974617');" style=""> 106       * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously                      </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style=""> 107       * @param request                                                                                             </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style=""> 108       * @param model                                                                                               </span>
<span class="-4336315843383652520" onmouseenter="enter('-4336315843383652520');" onmouseout="out('-4336315843383652520');" style=""> 109       * @param orderInfoForm                                                                                       </span>
<span class="471163069337744535" onmouseenter="enter('471163069337744535');" onmouseout="out('471163069337744535');" style=""> 110       * @param result                                                                                              </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 111       * @return                                                                                                    </span>
<span class="8449301783782133383" onmouseenter="enter('8449301783782133383');" onmouseout="out('8449301783782133383');" style=""> 112       * @throws ServiceException                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 113       */                                                                                                           </span>
<span class="7833752547156411123" onmouseenter="enter('7833752547156411123');" onmouseout="out('7833752547156411123');" style=""> 114      public String saveGlobalOrderDetails(HttpServletRequest request, Model model,                                 </span>
<span class="2885692691175911068" onmouseenter="enter('2885692691175911068');" onmouseout="out('2885692691175911068');" style=""> 115              OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {                          </span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 116          Order cart = CartState.getCart();                                                                         </span>
<span  style=""> 117                                                                                                                    </span>
<span class="-4853722722374659261" onmouseenter="enter('-4853722722374659261');" onmouseout="out('-4853722722374659261');" style=""> 118          orderInfoFormValidator.validate(orderInfoForm, result);                                                   </span>
<span class="4556169223967360348" onmouseenter="enter('4556169223967360348');" onmouseout="out('4556169223967360348');" style=""> 119          if (result.hasErrors()) {                                                                                 </span>
<span class="4925675922142494738" onmouseenter="enter('4925675922142494738');" onmouseout="out('4925675922142494738');" style=""> 120              // We need to clear the email on error in case they are trying to edit it                             </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 121              try {                                                                                                 </span>
<span class="-6542315142466769644" onmouseenter="enter('-6542315142466769644');" onmouseout="out('-6542315142466769644');" style=""> 122                  cart.setEmailAddress(null);                                                                       </span>
<span class="2575162925158509166" onmouseenter="enter('2575162925158509166');" onmouseout="out('2575162925158509166');" style=""> 123                  orderService.save(cart, false);                                                                   </span>
<span class="-7664829891190352303" onmouseenter="enter('-7664829891190352303');" onmouseout="out('-7664829891190352303');" style=""> 124              } catch (PricingException pe) {                                                                       </span>
<span class="-7018185772171393940" onmouseenter="enter('-7018185772171393940');" onmouseout="out('-7018185772171393940');" style=""> 125                  LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 126              }                                                                                                     </span>
<span  style=""> 127                                                                                                                    </span>
<span class="-1086353471713277153" onmouseenter="enter('-1086353471713277153');" onmouseout="out('-1086353471713277153');" style=""> 128              populateModelWithReferenceData(request, model);                                                       </span>
<span class="-1859137930126069715" onmouseenter="enter('-1859137930126069715');" onmouseout="out('-1859137930126069715');" style=""> 129              return getCheckoutView();                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 130          }                                                                                                         </span>
<span  style=""> 131                                                                                                                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 132          try {                                                                                                     </span>
<span class="-4094676742804741694" onmouseenter="enter('-4094676742804741694');" onmouseout="out('-4094676742804741694');" style=""> 133              cart.setEmailAddress(orderInfoForm.getEmailAddress());                                                </span>
<span class="2575162925158509166" onmouseenter="enter('2575162925158509166');" onmouseout="out('2575162925158509166');" style=""> 134              orderService.save(cart, false);                                                                       </span>
<span class="-7664829891190352303" onmouseenter="enter('-7664829891190352303');" onmouseout="out('-7664829891190352303');" style=""> 135          } catch (PricingException pe) {                                                                           </span>
<span class="-7018185772171393940" onmouseenter="enter('-7018185772171393940');" onmouseout="out('-7018185772171393940');" style=""> 136              LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 137          }                                                                                                         </span>
<span  style=""> 138                                                                                                                    </span>
<span class="1317425097473825953" onmouseenter="enter('1317425097473825953');" onmouseout="out('1317425097473825953');" style=""> 139          return getCheckoutPageRedirect();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 140      }                                                                                                             </span>
<span  style=""> 141                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 142      /**                                                                                                           </span>
<span class="7448664771981292412" onmouseenter="enter('7448664771981292412');" onmouseout="out('7448664771981292412');" style=""> 143       * Creates a pass-through payment of the PaymentType passed in with                                           </span>
<span class="421012101637192710" onmouseenter="enter('421012101637192710');" onmouseout="out('421012101637192710');" style=""> 144       * an amount equal to the order total after any non-final applied payments.                                   </span>
<span class="8025235098781395569" onmouseenter="enter('8025235098781395569');" onmouseout="out('8025235098781395569');" style=""> 145       * (for example gift cards, customer credit, or third party accounts)                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 146       *                                                                                                            </span>
<span class="-6096085412817911554" onmouseenter="enter('-6096085412817911554');" onmouseout="out('-6096085412817911554');" style=""> 147       * This intended to be used in cases like COD and other Payment Types where implementations wish              </span>
<span class="974612727386255560" onmouseenter="enter('974612727386255560');" onmouseout="out('974612727386255560');" style=""> 148       * to just checkout without having to do any payment processing.                                              </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 149       *                                                                                                            </span>
<span class="-7601184109281730645" onmouseenter="enter('-7601184109281730645');" onmouseout="out('-7601184109281730645');" style=""> 150       * This default implementations assumes that the pass-through payment is the only                             </span>
<span class="-4077415547304827420" onmouseenter="enter('-4077415547304827420');" onmouseout="out('-4077415547304827420');" style=""> 151       * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED          </span>
<span class="36099180133309792" onmouseenter="enter('36099180133309792');" onmouseout="out('36099180133309792');" style=""><abbr title=" 152       * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 152       * That means that it will look at all transactions on the order payment and see if it has unconfirmed transacðŸ”µ</abbr></span>
<span class="780949603230510899" onmouseenter="enter('780949603230510899');" onmouseout="out('780949603230510899');" style=""> 153       * If it does, it will not remove it.                                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 154       *                                                                                                            </span>
<span class="-2081180607706702192" onmouseenter="enter('-2081180607706702192');" onmouseout="out('-2081180607706702192');" style=""> 155       * Make sure not to expose this method in your extended Controller if you do not wish to                      </span>
<span class="-9185284612955559377" onmouseenter="enter('-9185284612955559377');" onmouseout="out('-9185284612955559377');" style=""> 156       * have this feature enabled.                                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 157       *                                                                                                            </span>
<span class="9045397892808778291" onmouseenter="enter('9045397892808778291');" onmouseout="out('9045397892808778291');" style=""> 158       * @param redirectAttributes                                                                                  </span>
<span class="-6271960972125413074" onmouseenter="enter('-6271960972125413074');" onmouseout="out('-6271960972125413074');" style=""> 159       * @param paymentType                                                                                         </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 160       * @return                                                                                                    </span>
<span class="2740930998571054578" onmouseenter="enter('2740930998571054578');" onmouseout="out('2740930998571054578');" style=""> 161       * @throws PaymentException                                                                                   </span>
<span class="-7962706440062724544" onmouseenter="enter('-7962706440062724544');" onmouseout="out('-7962706440062724544');" style=""> 162       * @throws PricingException                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 163       */                                                                                                           </span>
<span class="-6736963433386757064" onmouseenter="enter('-6736963433386757064');" onmouseout="out('-6736963433386757064');" style=""> 164      public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,                         </span>
<span class="-4251657370959523100" onmouseenter="enter('-4251657370959523100');" onmouseout="out('-4251657370959523100');" style=""> 165                                               PaymentType paymentType) throws PaymentException, PricingException { </span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 166          Order cart = CartState.getCart();                                                                         </span>
<span  style=""> 167                                                                                                                    </span>
<span class="8276989610904881201" onmouseenter="enter('8276989610904881201');" onmouseout="out('8276989610904881201');" style=""> 168          //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED </span>
<span class="-6892905423713233256" onmouseenter="enter('-6892905423713233256');" onmouseout="out('-6892905423713233256');" style=""> 169          List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();                                  </span>
<span class="-6512141134753607370" onmouseenter="enter('-6512141134753607370');" onmouseout="out('-6512141134753607370');" style=""> 170          for (OrderPayment payment : cart.getPayments()) {                                                         </span>
<span class="2703717333279802826" onmouseenter="enter('2703717333279802826');" onmouseout="out('2703717333279802826');" style=""> 171              if (payment.isActive()) {                                                                             </span>
<span class="1010327443504623706" onmouseenter="enter('1010327443504623706');" onmouseout="out('1010327443504623706');" style=""> 172                  if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {                   </span>
<span class="-9174713251656761482" onmouseenter="enter('-9174713251656761482');" onmouseout="out('-9174713251656761482');" style=""> 173                      paymentsToInvalidate.add(payment);                                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 174                  } else {                                                                                          </span>
<span class="4783701959626342440" onmouseenter="enter('4783701959626342440');" onmouseout="out('4783701959626342440');" style=""> 175                      for (PaymentTransaction transaction : payment.getTransactions()) {                            </span>
<span class="1226189291557269996" onmouseenter="enter('1226189291557269996');" onmouseout="out('1226189291557269996');" style=""> 176                          if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {                  </span>
<span class="-9174713251656761482" onmouseenter="enter('-9174713251656761482');" onmouseout="out('-9174713251656761482');" style=""> 177                               paymentsToInvalidate.add(payment);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 178                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182          }                                                                                                         </span>
<span  style=""> 183                                                                                                                    </span>
<span class="2845204764465767604" onmouseenter="enter('2845204764465767604');" onmouseout="out('2845204764465767604');" style=""> 184          for (OrderPayment payment : paymentsToInvalidate) {                                                       </span>
<span class="7985051489455715642" onmouseenter="enter('7985051489455715642');" onmouseout="out('7985051489455715642');" style=""> 185              cart.getPayments().remove(payment);                                                                   </span>
<span class="2733206040956525892" onmouseenter="enter('2733206040956525892');" onmouseout="out('2733206040956525892');" style=""> 186              if (paymentGatewayCheckoutService != null) {                                                          </span>
<span class="-6402023943636930644" onmouseenter="enter('-6402023943636930644');" onmouseout="out('-6402023943636930644');" style=""> 187                  paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 188              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189          }                                                                                                         </span>
<span  style=""> 190                                                                                                                    </span>
<span class="6556873303965518105" onmouseenter="enter('6556873303965518105');" onmouseout="out('6556873303965518105');" style=""> 191          //Create a new Order Payment of the passed in type                                                        </span>
<span class="6833494301693157359" onmouseenter="enter('6833494301693157359');" onmouseout="out('6833494301693157359');" style=""> 192          OrderPayment passthroughPayment = orderPaymentService.create();                                           </span>
<span class="9147888607418772106" onmouseenter="enter('9147888607418772106');" onmouseout="out('9147888607418772106');" style=""> 193          passthroughPayment.setType(paymentType);                                                                  </span>
<span class="-2427612793458922324" onmouseenter="enter('-2427612793458922324');" onmouseout="out('-2427612793458922324');" style=""> 194          passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);                                 </span>
<span class="5974726468545546735" onmouseenter="enter('5974726468545546735');" onmouseout="out('5974726468545546735');" style=""> 195          passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());                                        </span>
<span class="-4386080588835248255" onmouseenter="enter('-4386080588835248255');" onmouseout="out('-4386080588835248255');" style=""> 196          passthroughPayment.setOrder(cart);                                                                        </span>
<span  style=""> 197                                                                                                                    </span>
<span class="-1563843751557855690" onmouseenter="enter('-1563843751557855690');" onmouseout="out('-1563843751557855690');" style=""> 198          // Create the transaction for the payment                                                                 </span>
<span class="-4070171252423561334" onmouseenter="enter('-4070171252423561334');" onmouseout="out('-4070171252423561334');" style=""> 199          PaymentTransaction transaction = orderPaymentService.createTransaction();                                 </span>
<span class="-7489203339293438896" onmouseenter="enter('-7489203339293438896');" onmouseout="out('-7489203339293438896');" style=""> 200          transaction.setAmount(cart.getTotalAfterAppliedPayments());                                               </span>
<span class="4158351209072946081" onmouseenter="enter('4158351209072946081');" onmouseout="out('4158351209072946081');" style=""> 201          transaction.setRawResponse(&quot;Passthrough Payment&quot;);                                                        </span>
<span class="3734380173590255888" onmouseenter="enter('3734380173590255888');" onmouseout="out('3734380173590255888');" style=""> 202          transaction.setSuccess(true);                                                                             </span>
<span class="1663782738889042400" onmouseenter="enter('1663782738889042400');" onmouseout="out('1663782738889042400');" style=""> 203          transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);                                        </span>
<span class="8694399832927225044" onmouseenter="enter('8694399832927225044');" onmouseout="out('8694399832927225044');" style=""><abbr title=" 204          transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 204          transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.geðŸ”µ</abbr></span>
<span  style=""> 205                                                                                                                    </span>
<span class="-6972575699192592583" onmouseenter="enter('-6972575699192592583');" onmouseout="out('-6972575699192592583');" style=""> 206          transaction.setOrderPayment(passthroughPayment);                                                          </span>
<span class="-7763228653556987209" onmouseenter="enter('-7763228653556987209');" onmouseout="out('-7763228653556987209');" style=""> 207          passthroughPayment.addTransaction(transaction);                                                           </span>
<span class="8603709849878582824" onmouseenter="enter('8603709849878582824');" onmouseout="out('8603709849878582824');" style=""> 208          orderService.addPaymentToOrder(cart, passthroughPayment, null);                                           </span>
<span  style=""> 209                                                                                                                    </span>
<span class="4560736780407557680" onmouseenter="enter('4560736780407557680');" onmouseout="out('4560736780407557680');" style=""> 210          orderService.save(cart, true);                                                                            </span>
<span  style=""> 211                                                                                                                    </span>
<span class="-4135330013633253420" onmouseenter="enter('-4135330013633253420');" onmouseout="out('-4135330013633253420');" style=""> 212          return processCompleteCheckoutOrderFinalized(redirectAttributes);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 213      }                                                                                                             </span>
<span  style=""> 214                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 215      /**                                                                                                           </span>
<span class="5444184320192604762" onmouseenter="enter('5444184320192604762');" onmouseout="out('5444184320192604762');" style=""> 216       * If the order has been finalized. i.e. all the payments have been applied to the order,                     </span>
<span class="-4344413587104948495" onmouseenter="enter('-4344413587104948495');" onmouseout="out('-4344413587104948495');" style=""> 217       * then you can go ahead and call checkout using the passed in order id.                                      </span>
<span class="1950207948444662969" onmouseenter="enter('1950207948444662969');" onmouseout="out('1950207948444662969');" style=""><abbr title=" 218       * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 218       * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete ðŸ”µ</abbr></span>
<span class="-3475024975033618642" onmouseenter="enter('-3475024975033618642');" onmouseout="out('-3475024975033618642');" style=""> 219       * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or      </span>
<span class="-6748371112848020818" onmouseenter="enter('-6748371112848020818');" onmouseout="out('-6748371112848020818');" style=""> 220       * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 221       *                                                                                                            </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 222       * @return                                                                                                    </span>
<span class="3682579759887248937" onmouseenter="enter('3682579759887248937');" onmouseout="out('3682579759887248937');" style=""> 223       * @throws Exception                                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 224       */                                                                                                           </span>
<span class="5934204782612418166" onmouseenter="enter('5934204782612418166');" onmouseout="out('5934204782612418166');" style=""><abbr title=" 225      public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 225      public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymenðŸ”µ</abbr></span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 226          Order cart = CartState.getCart();                                                                         </span>
<span  style=""> 227                                                                                                                    </span>

<span class="2369429717891499715" onmouseenter="enter('2369429717891499715');" onmouseout="out('2369429717891499715');" style=""> 228          if (cart != null &amp;&amp; !(cart instanceof NullOrderImpl)) {                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 229              try {                                                                                                 </span>
<span class="5077673579105987976" onmouseenter="enter('5077673579105987976');" onmouseout="out('5077673579105987976');" style=""><abbr title=" 230                  Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 230                  Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OffeðŸ”µ</abbr></span>
<span class="-8024522286989825000" onmouseenter="enter('-8024522286989825000');" onmouseout="out('-8024522286989825000');" style=""> 231                  if(o!=null &amp;&amp; (Boolean) o){                                                                       </span>
<span class="-1469060214097397333" onmouseenter="enter('-1469060214097397333');" onmouseout="out('-1469060214097397333');" style=""><abbr title=" 232                      throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 232                      throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 233                  }                                                                                                 </span>
<span class="3169004698733361531" onmouseenter="enter('3169004698733361531');" onmouseout="out('3169004698733361531');" style=""> 234                  String orderNumber = initiateCheckout(cart.getId());                                              </span>
<span class="-8482400126440404484" onmouseenter="enter('-8482400126440404484');" onmouseout="out('-8482400126440404484');" style=""> 235                  return getConfirmationViewRedirect(orderNumber);                                                  </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 236              } catch (Exception e) {                                                                               </span>
<span class="3063554684989481043" onmouseenter="enter('3063554684989481043');" onmouseout="out('3063554684989481043');" style=""> 237                  handleProcessingException(e, redirectAttributes);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 239          }                                                                                                         </span>
<span  style=""> 240                                                                                                                    </span>
<span class="1317425097473825953" onmouseenter="enter('1317425097473825953');" onmouseout="out('1317425097473825953');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 241 -        return getCheckoutPageRedirect();                                                                         </span>
<span class="2502130438452954953" onmouseenter="enter('2502130438452954953');" onmouseout="out('2502130438452954953');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 242 +        return getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=true&quot; : &quot;&quot;);"> 242 +        return getCheckoutPageRedirect() + (CustomerState.getCustomer().isAnonymous() ? &quot;?guest-checkout=true&quot; : &quot;ðŸ”µ</abbr></span>






<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 243      }                                                                                                             </span>
<span  style=""> 244                                                                                                                    </span>
<span class="-8815074004281580350" onmouseenter="enter('-8815074004281580350');" onmouseout="out('-8815074004281580350');" style=""> 245      public String initiateCheckout(Long orderId) throws Exception{                                                </span>
<span class="2438321416231783030" onmouseenter="enter('2438321416231783030');" onmouseout="out('2438321416231783030');" style=""> 246          if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {                                           </span>
<span class="6065180908645754023" onmouseenter="enter('6065180908645754023');" onmouseout="out('6065180908645754023');" style=""> 247              return paymentGatewayCheckoutService.initiateCheckout(orderId);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 248          }                                                                                                         </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 249          return null;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 250      }                                                                                                             </span>
<span  style=""> 251                                                                                                                    </span>
<span class="-994952694334569484" onmouseenter="enter('-994952694334569484');" onmouseout="out('-994952694334569484');" style=""><abbr title=" 252      public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 252      public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentExceptðŸ”µ</abbr></span>
<span class="8461701443473900494" onmouseenter="enter('8461701443473900494');" onmouseout="out('8461701443473900494');" style=""><abbr title=" 253          LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 253          LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e)ðŸ”µ</abbr></span>
<span  style=""> 254                                                                                                                    </span>
<span class="-6915919722100840508" onmouseenter="enter('-6915919722100840508');" onmouseout="out('-6915919722100840508');" style=""> 255          Throwable cause = e.getCause();                                                                           </span>
<span  style=""> 256                                                                                                                    </span>
<span class="4727501192160255118" onmouseenter="enter('4727501192160255118');" onmouseout="out('4727501192160255118');" style=""> 257          if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {                  </span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 258              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,            </span>
<span class="-6443240451698207116" onmouseenter="enter('-6443240451698207116');" onmouseout="out('-6443240451698207116');" style=""> 259                      PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());                    </span>
<span class="6281078227744959351" onmouseenter="enter('6281078227744959351');" onmouseout="out('6281078227744959351');" style=""><abbr title=" 260          }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredException) {"> 260          }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredExcðŸ”µ</abbr></span>
<span class="5919541454818639441" onmouseenter="enter('5919541454818639441');" onmouseout="out('5919541454818639441');" style=""><abbr title=" 261              String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMessage();"> 261              String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMeðŸ”µ</abbr></span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 262              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,            </span>
<span class="-463279655468150766" onmouseenter="enter('-463279655468150766');" onmouseout="out('-463279655468150766');" style=""> 263                      message);                                                                                     </span>



<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 264          } else {                                                                                                  </span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 265              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,            </span>
<span class="3844015022951785414" onmouseenter="enter('3844015022951785414');" onmouseout="out('3844015022951785414');" style=""> 266                      PaymentGatewayAbstractController.getProcessingErrorMessage());                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 267          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 268      }                                                                                                             </span>
<span  style=""> 269                                                                                                                    </span>
<span class="7031853357863121773" onmouseenter="enter('7031853357863121773');" onmouseout="out('7031853357863121773');" style=""> 270      public String getBaseConfirmationRedirect() {                                                                 </span>
<span class="-3466839714243703616" onmouseenter="enter('-3466839714243703616');" onmouseout="out('-3466839714243703616');" style=""> 271          return baseConfirmationRedirect;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 272      }                                                                                                             </span>
<span  style=""> 273                                                                                                                    </span>
<span class="4806113959052613483" onmouseenter="enter('4806113959052613483');" onmouseout="out('4806113959052613483');" style=""> 274      protected String getConfirmationViewRedirect(String orderNumber) {                                            </span>
<span class="1954583273870042792" onmouseenter="enter('1954583273870042792');" onmouseout="out('1954583273870042792');" style=""> 275          return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 276      }                                                                                                             </span>
<span  style=""> 277                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 278  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="6211491254187717485" onmouseenter="enter('6211491254187717485');" onmouseout="out('6211491254187717485');" style="">   3   * BroadleafCommerce Framework Web                                                                                </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-8629421599793957064" onmouseenter="enter('-8629421599793957064');" onmouseout="out('-8629421599793957064');" style="">  18  package org.broadleafcommerce.core.web.controller.checkout;                                                       </span>
<span  style="">  19                                                                                                                    </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  20  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  21  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="5945096539699516699" onmouseenter="enter('5945096539699516699');" onmouseout="out('5945096539699516699');" style="">  22  import org.broadleafcommerce.common.exception.ServiceException;                                                   </span>
<span class="5237224010034497476" onmouseenter="enter('5237224010034497476');" onmouseout="out('5237224010034497476');" style="">  23  import org.broadleafcommerce.common.payment.PaymentGatewayType;                                                   </span>
<span class="479407306950343868" onmouseenter="enter('479407306950343868');" onmouseout="out('479407306950343868');" style="">  24  import org.broadleafcommerce.common.payment.PaymentTransactionType;                                               </span>
<span class="7974202605197813097" onmouseenter="enter('7974202605197813097');" onmouseout="out('7974202605197813097');" style="">  25  import org.broadleafcommerce.common.payment.PaymentType;                                                          </span>
<span class="-2982073195956465030" onmouseenter="enter('-2982073195956465030');" onmouseout="out('-2982073195956465030');" style="">  26  import org.broadleafcommerce.common.vendor.service.exception.PaymentException;                                    </span>
<span class="8689743329875302887" onmouseenter="enter('8689743329875302887');" onmouseout="out('8689743329875302887');" style="">  27  import org.broadleafcommerce.common.web.BroadleafRequestContext;                                                  </span>
<span class="-1388823727075420947" onmouseenter="enter('-1388823727075420947');" onmouseout="out('-1388823727075420947');" style="">  28  import org.broadleafcommerce.common.web.payment.controller.PaymentGatewayAbstractController;                      </span>
<span class="-1537931304336191501" onmouseenter="enter('-1537931304336191501');" onmouseout="out('-1537931304336191501');" style="">  29  import org.broadleafcommerce.core.checkout.service.gateway.PassthroughPaymentConstants;                           </span>
<span class="-6326345691456347408" onmouseenter="enter('-6326345691456347408');" onmouseout="out('-6326345691456347408');" style="">  30  import org.broadleafcommerce.core.offer.service.OfferServiceImpl;                                                 </span>
<span class="7718612833831637853" onmouseenter="enter('7718612833831637853');" onmouseout="out('7718612833831637853');" style="">  31  import org.broadleafcommerce.core.offer.service.exception.OfferExpiredException;                                  </span>
<span class="2542407303560298775" onmouseenter="enter('2542407303560298775');" onmouseout="out('2542407303560298775');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import org.broadleafcommerce.core.offer.service.exception.OfferMaxUseExceededException;                           </span>
<span class="6568352354414313904" onmouseenter="enter('6568352354414313904');" onmouseout="out('6568352354414313904');" style="">  33  import org.broadleafcommerce.core.order.domain.NullOrderImpl;                                                     </span>
<span class="-6039448701992847179" onmouseenter="enter('-6039448701992847179');" onmouseout="out('-6039448701992847179');" style="">  34  import org.broadleafcommerce.core.order.domain.Order;                                                             </span>
<span class="-8548142165698551205" onmouseenter="enter('-8548142165698551205');" onmouseout="out('-8548142165698551205');" style="">  35  import org.broadleafcommerce.core.order.service.exception.IllegalCartOperationException;                          </span>
<span class="-5209046066651310391" onmouseenter="enter('-5209046066651310391');" onmouseout="out('-5209046066651310391');" style="">  36  import org.broadleafcommerce.core.order.service.exception.RequiredAttributeNotProvidedException;                  </span>
<span class="725806334255742314" onmouseenter="enter('725806334255742314');" onmouseout="out('725806334255742314');" style="">  37  import org.broadleafcommerce.core.payment.domain.OrderPayment;                                                    </span>
<span class="-3835471990257693692" onmouseenter="enter('-3835471990257693692');" onmouseout="out('-3835471990257693692');" style="">  38  import org.broadleafcommerce.core.payment.domain.PaymentTransaction;                                              </span>
<span class="-1629731899052688234" onmouseenter="enter('-1629731899052688234');" onmouseout="out('-1629731899052688234');" style="">  39  import org.broadleafcommerce.core.pricing.service.exception.PricingException;                                     </span>
<span class="8867715597751215715" onmouseenter="enter('8867715597751215715');" onmouseout="out('8867715597751215715');" style="">  40  import org.broadleafcommerce.core.web.checkout.model.OrderInfoForm;                                               </span>
<span class="-8122138792032766956" onmouseenter="enter('-8122138792032766956');" onmouseout="out('-8122138792032766956');" style="">  41  import org.broadleafcommerce.core.web.order.CartState;                                                            </span>
<span class="-6031821648249405492" onmouseenter="enter('-6031821648249405492');" onmouseout="out('-6031821648249405492');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  42 +import org.broadleafcommerce.profile.web.core.CustomerState;                                                      </span>
<span class="2230089600625206822" onmouseenter="enter('2230089600625206822');" onmouseout="out('2230089600625206822');" style="">  43  import org.springframework.ui.Model;                                                                              </span>
<span class="-5446610002806720528" onmouseenter="enter('-5446610002806720528');" onmouseout="out('-5446610002806720528');" style="">  44  import org.springframework.validation.BindingResult;                                                              </span>
<span class="4289605998216587359" onmouseenter="enter('4289605998216587359');" onmouseout="out('4289605998216587359');" style="">  45  import org.springframework.web.servlet.mvc.support.RedirectAttributes;                                            </span>
<span  style="">  46                                                                                                                    </span>
<span class="9191247685397773893" onmouseenter="enter('9191247685397773893');" onmouseout="out('9191247685397773893');" style="">  47  import java.util.ArrayList;                                                                                       </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  48  import java.util.List;                                                                                            </span>
<span  style="">  49                                                                                                                    </span>
<span class="-2972028083581866805" onmouseenter="enter('-2972028083581866805');" onmouseout="out('-2972028083581866805');" style="">  50  import javax.servlet.http.HttpServletRequest;                                                                     </span>
<span class="-2247759832438184775" onmouseenter="enter('-2247759832438184775');" onmouseout="out('-2247759832438184775');" style="">  51  import javax.servlet.http.HttpServletResponse;                                                                    </span>
<span  style="">  52                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  53  /**                                                                                                               </span>
<span class="8742371521735015235" onmouseenter="enter('8742371521735015235');" onmouseout="out('8742371521735015235');" style="">  54   * In charge of performing the various checkout operations                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  55   *                                                                                                                </span>
<span class="-346667533686466806" onmouseenter="enter('-346667533686466806');" onmouseout="out('-346667533686466806');" style="">  56   * @author Andre Azzolini (apazzolini)                                                                            </span>
<span class="-7691131132890779522" onmouseenter="enter('-7691131132890779522');" onmouseout="out('-7691131132890779522');" style="">  57   * @author Elbert Bautista (elbertbautista)                                                                       </span>
<span class="6360699620585460494" onmouseenter="enter('6360699620585460494');" onmouseout="out('6360699620585460494');" style="">  58   * @author Joshua Skorton (jskorton)                                                                              </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  59   */                                                                                                               </span>
<span class="7030698850353387546" onmouseenter="enter('7030698850353387546');" onmouseout="out('7030698850353387546');" style="">  60  public class BroadleafCheckoutController extends AbstractCheckoutController {                                     </span>
<span  style="">  61                                                                                                                    </span>
<span class="-5830014166099721744" onmouseenter="enter('-5830014166099721744');" onmouseout="out('-5830014166099721744');" style="">  62      private static final Log LOG = LogFactory.getLog(BroadleafCheckoutController.class);                          </span>
<span class="6427092946309232849" onmouseenter="enter('6427092946309232849');" onmouseout="out('6427092946309232849');" style="">  63      protected static String baseConfirmationRedirect = &quot;redirect:/confirmation&quot;;                                  </span>
<span  style="">  64                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  65      /**                                                                                                           </span>
<span class="-5096071225963020400" onmouseenter="enter('-5096071225963020400');" onmouseout="out('-5096071225963020400');" style="">  66       * Renders the default checkout page and allows modules to add variables to the model.                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  67       *                                                                                                            </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style="">  68       * @param request                                                                                             </span>
<span class="592482809986819432" onmouseenter="enter('592482809986819432');" onmouseout="out('592482809986819432');" style="">  69       * @param response                                                                                            </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  70       * @param model                                                                                               </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  71       * @param model                                                                                               </span>
<span class="-2950909643428865356" onmouseenter="enter('-2950909643428865356');" onmouseout="out('-2950909643428865356');" style="">  72       * @return the checkout view path                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  73       */                                                                                                           </span>
<span class="-967467976240534127" onmouseenter="enter('-967467976240534127');" onmouseout="out('-967467976240534127');" style="">  74      public String checkout(HttpServletRequest request, HttpServletResponse response, Model model,                 </span>
<span class="696875836648250935" onmouseenter="enter('696875836648250935');" onmouseout="out('696875836648250935');" style="">  75              RedirectAttributes redirectAttributes) {                                                              </span>
<span class="270872852217962230" onmouseenter="enter('270872852217962230');" onmouseout="out('270872852217962230');" style="">  76          preValidateCartOperation(model);                                                                          </span>
<span class="-1086353471713277153" onmouseenter="enter('-1086353471713277153');" onmouseout="out('-1086353471713277153');" style="">  77          populateModelWithReferenceData(request, model);                                                           </span>
<span  style="">  78                                                                                                                    </span>
<span class="-1859137930126069715" onmouseenter="enter('-1859137930126069715');" onmouseout="out('-1859137930126069715');" style="">  79          return getCheckoutView();                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  80      }                                                                                                             </span>
<span  style="">  81                                                                                                                    </span>
<span class="3128862131256497566" onmouseenter="enter('3128862131256497566');" onmouseout="out('3128862131256497566');" style="">  82      protected void preValidateCartOperation(Model model) {                                                        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  83          try {                                                                                                     </span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style="">  84              Order cart = CartState.getCart();                                                                     </span>
<span class="8317005274507227996" onmouseenter="enter('8317005274507227996');" onmouseout="out('8317005274507227996');" style="">  85              orderService.preValidateCartOperation(cart);                                                          </span>
<span class="-7281640055951108504" onmouseenter="enter('-7281640055951108504');" onmouseout="out('-7281640055951108504');" style="">  86          } catch (IllegalCartOperationException ex) {                                                              </span>
<span class="339425943881620554" onmouseenter="enter('339425943881620554');" onmouseout="out('339425943881620554');" style="">  87              model.addAttribute(&quot;cartRequiresLock&quot;, true);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  88          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  89      }                                                                                                             </span>
<span  style="">  90                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  91      /**                                                                                                           </span>
<span class="1130589780629338932" onmouseenter="enter('1130589780629338932');" onmouseout="out('1130589780629338932');" style="">  92       * Renders checkout stages partial at the requested stage                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  93       *                                                                                                            </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style="">  94       * @param request                                                                                             </span>
<span class="592482809986819432" onmouseenter="enter('592482809986819432');" onmouseout="out('592482809986819432');" style="">  95       * @param response                                                                                            </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style="">  96       * @param model                                                                                               </span>
<span class="4895955032086297450" onmouseenter="enter('4895955032086297450');" onmouseout="out('4895955032086297450');" style="">  97       * @param stage                                                                                               </span>
<span class="-7461455283175296223" onmouseenter="enter('-7461455283175296223');" onmouseout="out('-7461455283175296223');" style="">  98       * @return the checkout stages partial path                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  99       */                                                                                                           </span>
<span class="-7433197152380805769" onmouseenter="enter('-7433197152380805769');" onmouseout="out('-7433197152380805769');" style=""> 100      public String getCheckoutStagePartial(HttpServletRequest request, HttpServletResponse response, Model model,  </span>
<span class="2266763686826895306" onmouseenter="enter('2266763686826895306');" onmouseout="out('2266763686826895306');" style=""> 101              String stage, RedirectAttributes redirectAttributes) {                                                </span>
<span class="3963575602163400700" onmouseenter="enter('3963575602163400700');" onmouseout="out('3963575602163400700');" style=""> 102          model.addAttribute(ACTIVE_STAGE, stage);                                                                  </span>
<span class="-3680994274736134122" onmouseenter="enter('-3680994274736134122');" onmouseout="out('-3680994274736134122');" style=""> 103          return getCheckoutStagesPartial();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 104      }                                                                                                             </span>
<span  style=""> 105                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 106      /**                                                                                                           </span>
<span class="6425048121249974617" onmouseenter="enter('6425048121249974617');" onmouseout="out('6425048121249974617');" style=""> 107       * Attempts to attach the user&#x27;s email to the order so that they may proceed anonymously                      </span>
<span class="2683834429188260963" onmouseenter="enter('2683834429188260963');" onmouseout="out('2683834429188260963');" style=""> 108       * @param request                                                                                             </span>
<span class="-7822492205708441341" onmouseenter="enter('-7822492205708441341');" onmouseout="out('-7822492205708441341');" style=""> 109       * @param model                                                                                               </span>
<span class="-4336315843383652520" onmouseenter="enter('-4336315843383652520');" onmouseout="out('-4336315843383652520');" style=""> 110       * @param orderInfoForm                                                                                       </span>
<span class="471163069337744535" onmouseenter="enter('471163069337744535');" onmouseout="out('471163069337744535');" style=""> 111       * @param result                                                                                              </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 112       * @return                                                                                                    </span>
<span class="8449301783782133383" onmouseenter="enter('8449301783782133383');" onmouseout="out('8449301783782133383');" style=""> 113       * @throws ServiceException                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 114       */                                                                                                           </span>
<span class="7833752547156411123" onmouseenter="enter('7833752547156411123');" onmouseout="out('7833752547156411123');" style=""> 115      public String saveGlobalOrderDetails(HttpServletRequest request, Model model,                                 </span>
<span class="2885692691175911068" onmouseenter="enter('2885692691175911068');" onmouseout="out('2885692691175911068');" style=""> 116              OrderInfoForm orderInfoForm, BindingResult result) throws ServiceException {                          </span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 117          Order cart = CartState.getCart();                                                                         </span>
<span  style=""> 118                                                                                                                    </span>
<span class="-4853722722374659261" onmouseenter="enter('-4853722722374659261');" onmouseout="out('-4853722722374659261');" style=""> 119          orderInfoFormValidator.validate(orderInfoForm, result);                                                   </span>
<span class="4556169223967360348" onmouseenter="enter('4556169223967360348');" onmouseout="out('4556169223967360348');" style=""> 120          if (result.hasErrors()) {                                                                                 </span>
<span class="4925675922142494738" onmouseenter="enter('4925675922142494738');" onmouseout="out('4925675922142494738');" style=""> 121              // We need to clear the email on error in case they are trying to edit it                             </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 122              try {                                                                                                 </span>
<span class="-6542315142466769644" onmouseenter="enter('-6542315142466769644');" onmouseout="out('-6542315142466769644');" style=""> 123                  cart.setEmailAddress(null);                                                                       </span>
<span class="2575162925158509166" onmouseenter="enter('2575162925158509166');" onmouseout="out('2575162925158509166');" style=""> 124                  orderService.save(cart, false);                                                                   </span>
<span class="-7664829891190352303" onmouseenter="enter('-7664829891190352303');" onmouseout="out('-7664829891190352303');" style=""> 125              } catch (PricingException pe) {                                                                       </span>
<span class="-7018185772171393940" onmouseenter="enter('-7018185772171393940');" onmouseout="out('-7018185772171393940');" style=""> 126                  LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127              }                                                                                                     </span>
<span  style=""> 128                                                                                                                    </span>
<span class="-1086353471713277153" onmouseenter="enter('-1086353471713277153');" onmouseout="out('-1086353471713277153');" style=""> 129              populateModelWithReferenceData(request, model);                                                       </span>
<span class="-1859137930126069715" onmouseenter="enter('-1859137930126069715');" onmouseout="out('-1859137930126069715');" style=""> 130              return getCheckoutView();                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 131          }                                                                                                         </span>
<span  style=""> 132                                                                                                                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 133          try {                                                                                                     </span>
<span class="-4094676742804741694" onmouseenter="enter('-4094676742804741694');" onmouseout="out('-4094676742804741694');" style=""> 134              cart.setEmailAddress(orderInfoForm.getEmailAddress());                                                </span>
<span class="2575162925158509166" onmouseenter="enter('2575162925158509166');" onmouseout="out('2575162925158509166');" style=""> 135              orderService.save(cart, false);                                                                       </span>
<span class="-7664829891190352303" onmouseenter="enter('-7664829891190352303');" onmouseout="out('-7664829891190352303');" style=""> 136          } catch (PricingException pe) {                                                                           </span>
<span class="-7018185772171393940" onmouseenter="enter('-7018185772171393940');" onmouseout="out('-7018185772171393940');" style=""> 137              LOG.error(&quot;Error when saving the email address for order confirmation to the cart&quot;, pe);              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 138          }                                                                                                         </span>
<span  style=""> 139                                                                                                                    </span>
<span class="1317425097473825953" onmouseenter="enter('1317425097473825953');" onmouseout="out('1317425097473825953');" style=""> 140          return getCheckoutPageRedirect();                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141      }                                                                                                             </span>
<span  style=""> 142                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 143      /**                                                                                                           </span>
<span class="7448664771981292412" onmouseenter="enter('7448664771981292412');" onmouseout="out('7448664771981292412');" style=""> 144       * Creates a pass-through payment of the PaymentType passed in with                                           </span>
<span class="421012101637192710" onmouseenter="enter('421012101637192710');" onmouseout="out('421012101637192710');" style=""> 145       * an amount equal to the order total after any non-final applied payments.                                   </span>
<span class="8025235098781395569" onmouseenter="enter('8025235098781395569');" onmouseout="out('8025235098781395569');" style=""> 146       * (for example gift cards, customer credit, or third party accounts)                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 147       *                                                                                                            </span>
<span class="-6096085412817911554" onmouseenter="enter('-6096085412817911554');" onmouseout="out('-6096085412817911554');" style=""> 148       * This intended to be used in cases like COD and other Payment Types where implementations wish              </span>
<span class="974612727386255560" onmouseenter="enter('974612727386255560');" onmouseout="out('974612727386255560');" style=""> 149       * to just checkout without having to do any payment processing.                                              </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 150       *                                                                                                            </span>
<span class="-7601184109281730645" onmouseenter="enter('-7601184109281730645');" onmouseout="out('-7601184109281730645');" style=""> 151       * This default implementations assumes that the pass-through payment is the only                             </span>
<span class="-4077415547304827420" onmouseenter="enter('-4077415547304827420');" onmouseout="out('-4077415547304827420');" style=""> 152       * &quot;final&quot; payment, as this will remove any payments that are not PaymentTransactionType.UNCONFIRMED          </span>
<span class="36099180133309792" onmouseenter="enter('36099180133309792');" onmouseout="out('36099180133309792');" style=""><abbr title=" 153       * That means that it will look at all transactions on the order payment and see if it has unconfirmed transactions."> 153       * That means that it will look at all transactions on the order payment and see if it has unconfirmed transacðŸ”µ</abbr></span>
<span class="780949603230510899" onmouseenter="enter('780949603230510899');" onmouseout="out('780949603230510899');" style=""> 154       * If it does, it will not remove it.                                                                         </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 155       *                                                                                                            </span>
<span class="-2081180607706702192" onmouseenter="enter('-2081180607706702192');" onmouseout="out('-2081180607706702192');" style=""> 156       * Make sure not to expose this method in your extended Controller if you do not wish to                      </span>
<span class="-9185284612955559377" onmouseenter="enter('-9185284612955559377');" onmouseout="out('-9185284612955559377');" style=""> 157       * have this feature enabled.                                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 158       *                                                                                                            </span>
<span class="9045397892808778291" onmouseenter="enter('9045397892808778291');" onmouseout="out('9045397892808778291');" style=""> 159       * @param redirectAttributes                                                                                  </span>
<span class="-6271960972125413074" onmouseenter="enter('-6271960972125413074');" onmouseout="out('-6271960972125413074');" style=""> 160       * @param paymentType                                                                                         </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 161       * @return                                                                                                    </span>
<span class="2740930998571054578" onmouseenter="enter('2740930998571054578');" onmouseout="out('2740930998571054578');" style=""> 162       * @throws PaymentException                                                                                   </span>
<span class="-7962706440062724544" onmouseenter="enter('-7962706440062724544');" onmouseout="out('-7962706440062724544');" style=""> 163       * @throws PricingException                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 164       */                                                                                                           </span>
<span class="-6736963433386757064" onmouseenter="enter('-6736963433386757064');" onmouseout="out('-6736963433386757064');" style=""> 165      public String processPassthroughCheckout(final RedirectAttributes redirectAttributes,                         </span>
<span class="-4251657370959523100" onmouseenter="enter('-4251657370959523100');" onmouseout="out('-4251657370959523100');" style=""> 166                                               PaymentType paymentType) throws PaymentException, PricingException { </span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 167          Order cart = CartState.getCart();                                                                         </span>
<span  style=""> 168                                                                                                                    </span>
<span class="8276989610904881201" onmouseenter="enter('8276989610904881201');" onmouseout="out('8276989610904881201');" style=""> 169          //Invalidate any payments already on the order that do not have transactions on them that are UNCONFIRMED </span>
<span class="-6892905423713233256" onmouseenter="enter('-6892905423713233256');" onmouseout="out('-6892905423713233256');" style=""> 170          List&lt;OrderPayment&gt; paymentsToInvalidate = new ArrayList&lt;OrderPayment&gt;();                                  </span>
<span class="-6512141134753607370" onmouseenter="enter('-6512141134753607370');" onmouseout="out('-6512141134753607370');" style=""> 171          for (OrderPayment payment : cart.getPayments()) {                                                         </span>
<span class="2703717333279802826" onmouseenter="enter('2703717333279802826');" onmouseout="out('2703717333279802826');" style=""> 172              if (payment.isActive()) {                                                                             </span>
<span class="1010327443504623706" onmouseenter="enter('1010327443504623706');" onmouseout="out('1010327443504623706');" style=""> 173                  if (payment.getTransactions() == null || payment.getTransactions().isEmpty()) {                   </span>
<span class="-9174713251656761482" onmouseenter="enter('-9174713251656761482');" onmouseout="out('-9174713251656761482');" style=""> 174                      paymentsToInvalidate.add(payment);                                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 175                  } else {                                                                                          </span>
<span class="4783701959626342440" onmouseenter="enter('4783701959626342440');" onmouseout="out('4783701959626342440');" style=""> 176                      for (PaymentTransaction transaction : payment.getTransactions()) {                            </span>
<span class="1226189291557269996" onmouseenter="enter('1226189291557269996');" onmouseout="out('1226189291557269996');" style=""> 177                          if (!PaymentTransactionType.UNCONFIRMED.equals(transaction.getType())) {                  </span>
<span class="-9174713251656761482" onmouseenter="enter('-9174713251656761482');" onmouseout="out('-9174713251656761482');" style=""> 178                               paymentsToInvalidate.add(payment);                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 179                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183          }                                                                                                         </span>
<span  style=""> 184                                                                                                                    </span>
<span class="2845204764465767604" onmouseenter="enter('2845204764465767604');" onmouseout="out('2845204764465767604');" style=""> 185          for (OrderPayment payment : paymentsToInvalidate) {                                                       </span>
<span class="7985051489455715642" onmouseenter="enter('7985051489455715642');" onmouseout="out('7985051489455715642');" style=""> 186              cart.getPayments().remove(payment);                                                                   </span>
<span class="2733206040956525892" onmouseenter="enter('2733206040956525892');" onmouseout="out('2733206040956525892');" style=""> 187              if (paymentGatewayCheckoutService != null) {                                                          </span>
<span class="-6402023943636930644" onmouseenter="enter('-6402023943636930644');" onmouseout="out('-6402023943636930644');" style=""> 188                  paymentGatewayCheckoutService.markPaymentAsInvalid(payment.getId());                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190          }                                                                                                         </span>
<span  style=""> 191                                                                                                                    </span>
<span class="6556873303965518105" onmouseenter="enter('6556873303965518105');" onmouseout="out('6556873303965518105');" style=""> 192          //Create a new Order Payment of the passed in type                                                        </span>
<span class="6833494301693157359" onmouseenter="enter('6833494301693157359');" onmouseout="out('6833494301693157359');" style=""> 193          OrderPayment passthroughPayment = orderPaymentService.create();                                           </span>
<span class="9147888607418772106" onmouseenter="enter('9147888607418772106');" onmouseout="out('9147888607418772106');" style=""> 194          passthroughPayment.setType(paymentType);                                                                  </span>
<span class="-2427612793458922324" onmouseenter="enter('-2427612793458922324');" onmouseout="out('-2427612793458922324');" style=""> 195          passthroughPayment.setPaymentGatewayType(PaymentGatewayType.PASSTHROUGH);                                 </span>
<span class="5974726468545546735" onmouseenter="enter('5974726468545546735');" onmouseout="out('5974726468545546735');" style=""> 196          passthroughPayment.setAmount(cart.getTotalAfterAppliedPayments());                                        </span>
<span class="-4386080588835248255" onmouseenter="enter('-4386080588835248255');" onmouseout="out('-4386080588835248255');" style=""> 197          passthroughPayment.setOrder(cart);                                                                        </span>
<span  style=""> 198                                                                                                                    </span>
<span class="-1563843751557855690" onmouseenter="enter('-1563843751557855690');" onmouseout="out('-1563843751557855690');" style=""> 199          // Create the transaction for the payment                                                                 </span>
<span class="-4070171252423561334" onmouseenter="enter('-4070171252423561334');" onmouseout="out('-4070171252423561334');" style=""> 200          PaymentTransaction transaction = orderPaymentService.createTransaction();                                 </span>
<span class="-7489203339293438896" onmouseenter="enter('-7489203339293438896');" onmouseout="out('-7489203339293438896');" style=""> 201          transaction.setAmount(cart.getTotalAfterAppliedPayments());                                               </span>
<span class="4158351209072946081" onmouseenter="enter('4158351209072946081');" onmouseout="out('4158351209072946081');" style=""> 202          transaction.setRawResponse(&quot;Passthrough Payment&quot;);                                                        </span>
<span class="3734380173590255888" onmouseenter="enter('3734380173590255888');" onmouseout="out('3734380173590255888');" style=""> 203          transaction.setSuccess(true);                                                                             </span>
<span class="1663782738889042400" onmouseenter="enter('1663782738889042400');" onmouseout="out('1663782738889042400');" style=""> 204          transaction.setType(PaymentTransactionType.AUTHORIZE_AND_CAPTURE);                                        </span>
<span class="8694399832927225044" onmouseenter="enter('8694399832927225044');" onmouseout="out('8694399832927225044');" style=""><abbr title=" 205          transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.getType());"> 205          transaction.getAdditionalFields().put(PassthroughPaymentConstants.PASSTHROUGH_PAYMENT_TYPE, paymentType.geðŸ”µ</abbr></span>
<span  style=""> 206                                                                                                                    </span>
<span class="-6972575699192592583" onmouseenter="enter('-6972575699192592583');" onmouseout="out('-6972575699192592583');" style=""> 207          transaction.setOrderPayment(passthroughPayment);                                                          </span>
<span class="-7763228653556987209" onmouseenter="enter('-7763228653556987209');" onmouseout="out('-7763228653556987209');" style=""> 208          passthroughPayment.addTransaction(transaction);                                                           </span>
<span class="8603709849878582824" onmouseenter="enter('8603709849878582824');" onmouseout="out('8603709849878582824');" style=""> 209          orderService.addPaymentToOrder(cart, passthroughPayment, null);                                           </span>
<span  style=""> 210                                                                                                                    </span>
<span class="4560736780407557680" onmouseenter="enter('4560736780407557680');" onmouseout="out('4560736780407557680');" style=""> 211          orderService.save(cart, true);                                                                            </span>
<span  style=""> 212                                                                                                                    </span>
<span class="-4135330013633253420" onmouseenter="enter('-4135330013633253420');" onmouseout="out('-4135330013633253420');" style=""> 213          return processCompleteCheckoutOrderFinalized(redirectAttributes);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 214      }                                                                                                             </span>
<span  style=""> 215                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 216      /**                                                                                                           </span>
<span class="5444184320192604762" onmouseenter="enter('5444184320192604762');" onmouseout="out('5444184320192604762');" style=""> 217       * If the order has been finalized. i.e. all the payments have been applied to the order,                     </span>
<span class="-4344413587104948495" onmouseenter="enter('-4344413587104948495');" onmouseout="out('-4344413587104948495');" style=""> 218       * then you can go ahead and call checkout using the passed in order id.                                      </span>
<span class="1950207948444662969" onmouseenter="enter('1950207948444662969');" onmouseout="out('1950207948444662969');" style=""><abbr title=" 219       * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete checkout."> 219       * This is usually called from a Review Page or if enough Payments have been applied to the Order to complete ðŸ”µ</abbr></span>
<span class="-3475024975033618642" onmouseenter="enter('-3475024975033618642');" onmouseout="out('-3475024975033618642');" style=""> 220       * (e.g. Gift Cards cover the entire amount and there is no need to call an external Payment Gateway, or      </span>
<span class="-6748371112848020818" onmouseenter="enter('-6748371112848020818');" onmouseout="out('-6748371112848020818');" style=""> 221       * a Payment from a Hosted Gateway has already been applied to the order like Paypal Express Checkout)        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 222       *                                                                                                            </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 223       * @return                                                                                                    </span>
<span class="3682579759887248937" onmouseenter="enter('3682579759887248937');" onmouseout="out('3682579759887248937');" style=""> 224       * @throws Exception                                                                                          </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 225       */                                                                                                           </span>
<span class="5934204782612418166" onmouseenter="enter('5934204782612418166');" onmouseout="out('5934204782612418166');" style=""><abbr title=" 226      public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymentException {"> 226      public String processCompleteCheckoutOrderFinalized(final RedirectAttributes redirectAttributes) throws PaymenðŸ”µ</abbr></span>
<span class="-6895759499134048698" onmouseenter="enter('-6895759499134048698');" onmouseout="out('-6895759499134048698');" style=""> 227          Order cart = CartState.getCart();                                                                         </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 228 -                                                                                                                  </span>
<span class="-410038182464695226" onmouseenter="enter('-410038182464695226');" onmouseout="out('-410038182464695226');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +        String param = &quot;&quot;;                                                                                        </span>
<span class="2369429717891499715" onmouseenter="enter('2369429717891499715');" onmouseout="out('2369429717891499715');" style=""> 230          if (cart != null &amp;&amp; !(cart instanceof NullOrderImpl)) {                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 231              try {                                                                                                 </span>
<span class="5077673579105987976" onmouseenter="enter('5077673579105987976');" onmouseout="out('5077673579105987976');" style=""><abbr title=" 232                  Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OfferServiceImpl.OFFERS_EXPIRED);"> 232                  Object o = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties().get(OffeðŸ”µ</abbr></span>
<span class="-8024522286989825000" onmouseenter="enter('-8024522286989825000');" onmouseout="out('-8024522286989825000');" style=""> 233                  if(o!=null &amp;&amp; (Boolean) o){                                                                       </span>
<span class="-1469060214097397333" onmouseenter="enter('-1469060214097397333');" onmouseout="out('-1469060214097397333');" style=""><abbr title=" 234                      throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was re-calculated, check order total and try again&quot;);"> 234                      throw new OfferExpiredException(&quot;Offer or offer code was expired and removed, order price was ðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 235                  }                                                                                                 </span>
<span class="3169004698733361531" onmouseenter="enter('3169004698733361531');" onmouseout="out('3169004698733361531');" style=""> 236                  String orderNumber = initiateCheckout(cart.getId());                                              </span>
<span class="-8482400126440404484" onmouseenter="enter('-8482400126440404484');" onmouseout="out('-8482400126440404484');" style=""> 237                  return getConfirmationViewRedirect(orderNumber);                                                  </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 238              } catch (Exception e) {                                                                               </span>
<span class="3063554684989481043" onmouseenter="enter('3063554684989481043');" onmouseout="out('3063554684989481043');" style=""> 239                  handleProcessingException(e, redirectAttributes);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 240 -            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 241 -        }                                                                                                         </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 242 -                                                                                                                  </span>
<span class="1317425097473825953" onmouseenter="enter('1317425097473825953');" onmouseout="out('1317425097473825953');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 243 -        return getCheckoutPageRedirect();                                                                         </span>
<span class="-6955630417980650572" onmouseenter="enter('-6955630417980650572');" onmouseout="out('-6955630417980650572');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +                if(CustomerState.getCustomer().isAnonymous()){                                                    </span>
<span class="-3581136138458844540" onmouseenter="enter('-3581136138458844540');" onmouseout="out('-3581136138458844540');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +                    param=&quot;?guest-checkout=true&quot;;                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +                }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +        }                                                                                                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +                                                                                                                  </span>
<span class="-2511614893152452019" onmouseenter="enter('-2511614893152452019');" onmouseout="out('-2511614893152452019');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +        return getCheckoutPageRedirect()+param;                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251      }                                                                                                             </span>
<span  style=""> 252                                                                                                                    </span>
<span class="-8815074004281580350" onmouseenter="enter('-8815074004281580350');" onmouseout="out('-8815074004281580350');" style=""> 253      public String initiateCheckout(Long orderId) throws Exception{                                                </span>
<span class="2438321416231783030" onmouseenter="enter('2438321416231783030');" onmouseout="out('2438321416231783030');" style=""> 254          if (paymentGatewayCheckoutService != null &amp;&amp; orderId != null) {                                           </span>
<span class="6065180908645754023" onmouseenter="enter('6065180908645754023');" onmouseout="out('6065180908645754023');" style=""> 255              return paymentGatewayCheckoutService.initiateCheckout(orderId);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 256          }                                                                                                         </span>
<span class="-3732568077477539923" onmouseenter="enter('-3732568077477539923');" onmouseout="out('-3732568077477539923');" style=""> 257          return null;                                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 258      }                                                                                                             </span>
<span  style=""> 259                                                                                                                    </span>
<span class="-994952694334569484" onmouseenter="enter('-994952694334569484');" onmouseout="out('-994952694334569484');" style=""><abbr title=" 260      public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentException {"> 260      public void handleProcessingException(Exception e, RedirectAttributes redirectAttributes) throws PaymentExceptðŸ”µ</abbr></span>
<span class="8461701443473900494" onmouseenter="enter('8461701443473900494');" onmouseout="out('8461701443473900494');" style=""><abbr title=" 261          LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e);"> 261          LOG.error(&quot;A Processing Exception Occurred finalizing the order. Adding Error to Redirect Attributes.&quot;, e)ðŸ”µ</abbr></span>
<span  style=""> 262                                                                                                                    </span>
<span class="-6915919722100840508" onmouseenter="enter('-6915919722100840508');" onmouseout="out('-6915919722100840508');" style=""> 263          Throwable cause = e.getCause();                                                                           </span>
<span  style=""> 264                                                                                                                    </span>
<span class="4727501192160255118" onmouseenter="enter('4727501192160255118');" onmouseout="out('4727501192160255118');" style=""> 265          if (cause!= null &amp;&amp; cause.getCause() instanceof RequiredAttributeNotProvidedException) {                  </span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 266              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,            </span>
<span class="-6443240451698207116" onmouseenter="enter('-6443240451698207116');" onmouseout="out('-6443240451698207116');" style=""> 267                      PaymentGatewayAbstractController.getCartReqAttributeNotProvidedMessage());                    </span>
<span class="6281078227744959351" onmouseenter="enter('6281078227744959351');" onmouseout="out('6281078227744959351');" style=""><abbr title=" 268          }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredException) {"> 268          }else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferExpiredException || e instanceof OfferExpiredExcðŸ”µ</abbr></span>
<span class="5919541454818639441" onmouseenter="enter('5919541454818639441');" onmouseout="out('5919541454818639441');" style=""><abbr title=" 269              String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMessage();"> 269              String message = (cause != null &amp;&amp; cause.getCause() != null) ? cause.getCause().getMessage() : e.getMeðŸ”µ</abbr></span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 270              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,            </span>
<span class="-463279655468150766" onmouseenter="enter('-463279655468150766');" onmouseout="out('-463279655468150766');" style=""> 271                      message);                                                                                     </span>
<span class="-6556537329766607120" onmouseenter="enter('-6556537329766607120');" onmouseout="out('-6556537329766607120');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +        } else if(cause !=null &amp;&amp; cause.getCause() instanceof OfferMaxUseExceededException) {                     </span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +            redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,            </span>
<span class="-536931781667901612" onmouseenter="enter('-536931781667901612');" onmouseout="out('-536931781667901612');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +                    &quot;There was an error during checkout:&quot;+cause.getCause().getMessage());                         </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 275          } else {                                                                                                  </span>
<span class="-5323205396200321118" onmouseenter="enter('-5323205396200321118');" onmouseout="out('-5323205396200321118');" style=""> 276              redirectAttributes.addAttribute(PaymentGatewayAbstractController.PAYMENT_PROCESSING_ERROR,            </span>
<span class="3844015022951785414" onmouseenter="enter('3844015022951785414');" onmouseout="out('3844015022951785414');" style=""> 277                      PaymentGatewayAbstractController.getProcessingErrorMessage());                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 278          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 279      }                                                                                                             </span>
<span  style=""> 280                                                                                                                    </span>
<span class="7031853357863121773" onmouseenter="enter('7031853357863121773');" onmouseout="out('7031853357863121773');" style=""> 281      public String getBaseConfirmationRedirect() {                                                                 </span>
<span class="-3466839714243703616" onmouseenter="enter('-3466839714243703616');" onmouseout="out('-3466839714243703616');" style=""> 282          return baseConfirmationRedirect;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 283      }                                                                                                             </span>
<span  style=""> 284                                                                                                                    </span>
<span class="4806113959052613483" onmouseenter="enter('4806113959052613483');" onmouseout="out('4806113959052613483');" style=""> 285      protected String getConfirmationViewRedirect(String orderNumber) {                                            </span>
<span class="1954583273870042792" onmouseenter="enter('1954583273870042792');" onmouseout="out('1954583273870042792');" style=""> 286          return getBaseConfirmationRedirect() + &quot;/&quot; + orderNumber;                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 287      }                                                                                                             </span>
<span  style=""> 288                                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 289  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            