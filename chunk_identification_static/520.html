<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>520</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    520
                    <a href="519.html">prev</a>
                    <a href="521.html">next</a>
                    <a href="520_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e83f8c3a3cbab21ecd8ceab223b0f3539be4b5fd_kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/serialization/CsvCRowSerializationSchema.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e83f8c3a3cbab21ecd8ceab223b0f3539be4b5fd:kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/serialization/CsvCRowSerializationSchema.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e83f8c3a3cbab21ecd8ceab223b0f3539be4b5fd^1:kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/serialization/CsvCRowSerializationSchema.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e83f8c3a3cbab21ecd8ceab223b0f3539be4b5fd^2:kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/serialization/CsvCRowSerializationSchema.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;55715c184d537500eff25ccea853833950100929:kafka-base/kafka-base-sink/src/main/java/com/dtstack/flink/sql/sink/kafka/serialization/CsvCRowSerializationSchema.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   2 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.sink.kafka.serialization;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.apache.flink.annotation.PublicEvolving;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.flink.api.common.serialization.SerializationSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.flink.api.common.typeinfo.BasicArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.flink.api.common.typeinfo.PrimitiveArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.apache.flink.api.common.typeinfo.Types;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.flink.api.java.typeutils.ObjectArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.flink.formats.csv.CsvRowDeserializationSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.apache.flink.formats.csv.CsvRowSchemaConverter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.apache.flink.formats.csv.CsvRowSerializationSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.JsonNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.ObjectWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ArrayNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ContainerNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ObjectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvMapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import org.apache.flink.table.runtime.types.CRowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.io.Serializable;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import java.math.BigDecimal;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import java.math.BigInteger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import java.util.Iterator;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import java.util.Objects;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import java.util.stream.IntStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 import java.util.stream.Stream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58  * Serialization schema that serializes an object of Flink types into a CSV bytes.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60  * &lt;p&gt;Serializes the input row into a {@link ObjectNode} and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61  * converts it into &lt;code&gt;byte[]&lt;/code&gt;.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63  * &lt;p&gt;Result &lt;code&gt;byte[]&lt;/code&gt; messages can be deserialized using {@link CsvRowDeserializationSchema}.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65 @PublicEvolving</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66 public final class CsvCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68 	private static final long serialVersionUID = 2098447220136965L;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 	/** Type information describing the input CSV data. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 	private final RowTypeInfo typeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73 	/** Runtime instance that performs the actual work. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 	private final RuntimeConverter runtimeConverter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76 	/** CsvMapper used to write {@link JsonNode} into bytes. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77 	private final CsvMapper csvMapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 	/** Schema describing the input CSV data. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80 	private CsvSchema csvSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82 	/** Object writer used to write rows. It is configured by {@link CsvSchema}. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83 	private ObjectWriter objectWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85 	/** Reusable object node. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 	private transient ObjectNode root;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88 	private String updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90 	private String retractKey = &quot;retract&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92 	private CsvCRowSerializationSchema(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 			RowTypeInfo typeInfo,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94 			CsvSchema csvSchema,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95 			String updateMode) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 		this.typeInfo = typeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97 		this.runtimeConverter = createRowRuntimeConverter(typeInfo, true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98 		this.csvMapper = new CsvMapper();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99 		this.csvSchema = csvSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101 		this.objectWriter = csvMapper.writer(csvSchema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105 	 * A builder for creating a {@link CsvRowSerializationSchema}.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107 	@PublicEvolving</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108 	public static class Builder {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110 		private final RowTypeInfo typeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111 		private CsvSchema csvSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112 		private String updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114 		/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 		 * Creates a {@link CsvRowSerializationSchema} expecting the given {@link TypeInformation}.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116 		 *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 		 * @param typeInfo type information used to create schema.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118 		 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119 		public Builder(TypeInformation&lt;CRow&gt; typeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120 			Preconditions.checkNotNull(typeInfo, &quot;Type information must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122 			if (!(typeInfo instanceof CRowTypeInfo)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 				throw new IllegalArgumentException(&quot;Row type information expected.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125 			RowTypeInfo rowTypeInfo = ((CRowTypeInfo) typeInfo).rowType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126 			this.typeInfo = rowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127 			this.csvSchema = CsvRowSchemaConverter.convert(rowTypeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130 		public Builder setFieldDelimiter(char c) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131 			this.csvSchema = this.csvSchema.rebuild().setColumnSeparator(c).build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135 		public Builder setLineDelimiter(String delimiter) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137 			if (!delimiter.equals(&quot;\n&quot;) &amp;&amp; !delimiter.equals(&quot;\r&quot;) &amp;&amp; !delimiter.equals(&quot;\r\n&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138 				throw new IllegalArgumentException(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 					&quot;Unsupported new line delimiter. Only \\n, \\r, or \\r\\n are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 			this.csvSchema = this.csvSchema.rebuild().setLineSeparator(delimiter).build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 		public Builder setArrayElementDelimiter(String delimiter) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147 			this.csvSchema = this.csvSchema.rebuild().setArrayElementSeparator(delimiter).build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151 		public Builder setQuoteCharacter(char c) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152 			this.csvSchema = this.csvSchema.rebuild().setQuoteChar(c).build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156 		public Builder setEscapeCharacter(char c) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157 			this.csvSchema = this.csvSchema.rebuild().setEscapeChar(c).build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161 		public Builder setNullLiteral(String s) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 			this.csvSchema = this.csvSchema.rebuild().setNullValue(s).build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 		public Builder setUpdateMode(String updateMode) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167 			this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171 		public CsvCRowSerializationSchema build() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172 			return new CsvCRowSerializationSchema(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173 					typeInfo,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174 					csvSchema,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175 					updateMode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180 	public byte[] serialize(CRow crow) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 		Row row = crow.row();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 		boolean change = crow.change();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183 		if (root == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 			root = csvMapper.createObjectNode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 		try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187 			runtimeConverter.convert(csvMapper, root, row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188 			if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189 				fillRetractField(row, change);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192 			return objectWriter.writeValueAsBytes(root);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193 		} catch (Throwable t) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194 			throw new RuntimeException(&quot;Could not serialize row &#x27;&quot; + row + &quot;&#x27;.&quot;, t);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198 	protected void fillRetractField(Row row, boolean change) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199 		root.put(retractKey, change);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200 		CsvSchema.Builder newBuilder = new CsvSchema.Builder(csvSchema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 202 		CsvSchema.Column retractColumn = new CsvSchema.Column(row.getArity(), retractKey, CsvSchema.ColumnType.BOOLEAN);"> 202 		CsvSchema.Column retractColumn = new CsvSchema.Column(row.getArity(), retractKey, CsvSchema.ColumnType.🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203 		newBuilder.addColumn(retractColumn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204 		csvSchema = newBuilder.build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206 		this.objectWriter = csvMapper.writer(csvSchema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211 	public boolean equals(Object o) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212 		if (o == null || o.getClass() != this.getClass()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213 			return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215 		if (this == o) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216 			return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218 		final CsvCRowSerializationSchema that = (CsvCRowSerializationSchema) o;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219 		final CsvSchema otherSchema = that.csvSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221 		return typeInfo.equals(that.typeInfo) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222 			csvSchema.getColumnSeparator() == otherSchema.getColumnSeparator() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223 			Arrays.equals(csvSchema.getLineSeparator(), otherSchema.getLineSeparator()) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224 			csvSchema.getArrayElementSeparator().equals(otherSchema.getArrayElementSeparator()) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225 			csvSchema.getQuoteChar() == otherSchema.getQuoteChar() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226 			csvSchema.getEscapeChar() == otherSchema.getEscapeChar() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227 			Arrays.equals(csvSchema.getNullValue(), otherSchema.getNullValue());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231 	public int hashCode() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232 		return Objects.hash(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233 			typeInfo,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234 			csvSchema.getColumnSeparator(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235 			csvSchema.getLineSeparator(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236 			csvSchema.getArrayElementSeparator(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237 			csvSchema.getQuoteChar(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238 			csvSchema.getEscapeChar(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239 			csvSchema.getNullValue());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242 	// --------------------------------------------------------------------------------------------</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244 	private interface RuntimeConverter extends Serializable {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245 		JsonNode convert(CsvMapper csvMapper, ContainerNode&lt;?&gt; container, Object obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 	private static RuntimeConverter createRowRuntimeConverter(RowTypeInfo rowTypeInfo, boolean isTopLevel) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249 		final TypeInformation[] fieldTypes = rowTypeInfo.getFieldTypes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250 		final String[] fieldNames = rowTypeInfo.getFieldNames();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252 		final RuntimeConverter[] fieldConverters = createFieldRuntimeConverters(fieldTypes);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254 		return assembleRowRuntimeConverter(isTopLevel, fieldNames, fieldConverters);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257 	private static RuntimeConverter[] createFieldRuntimeConverters(TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258 		final RuntimeConverter[] fieldConverters = new RuntimeConverter[fieldTypes.length];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259 		for (int i = 0; i &lt; fieldTypes.length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260 			fieldConverters[i] = createNullableRuntimeConverter(fieldTypes[i]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262 		return fieldConverters;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265 	private static RuntimeConverter assembleRowRuntimeConverter(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266 			boolean isTopLevel,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267 			String[] fieldNames,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268 			RuntimeConverter[] fieldConverters) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269 		final int rowArity = fieldNames.length;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270 		// top level reuses the object node container</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271 		if (isTopLevel) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272 			return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 				final Row row = (Row) obj;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275 				validateArity(rowArity, row.getArity());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277 				final ObjectNode objectNode = (ObjectNode) container;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278 				for (int i = 0; i &lt; rowArity; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279 					objectNode.set(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280 						fieldNames[i],</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281 						fieldConverters[i].convert(csvMapper, container, row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283 				return objectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 			};</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285 		} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 			return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287 				final Row row = (Row) obj;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289 				validateArity(rowArity, row.getArity());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291 				final ArrayNode arrayNode = csvMapper.createArrayNode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292 				for (int i = 0; i &lt; rowArity; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293 					arrayNode.add(fieldConverters[i].convert(csvMapper, arrayNode, row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295 				return arrayNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296 			};</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300 	private static RuntimeConverter createNullableRuntimeConverter(TypeInformation&lt;?&gt; info) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301 		final RuntimeConverter valueConverter = createRuntimeConverter(info);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302 		return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303 			if (obj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304 				return container.nullNode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306 			return valueConverter.convert(csvMapper, container, obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307 		};</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 	private static RuntimeConverter createRuntimeConverter(TypeInformation&lt;?&gt; info) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311 		if (info.equals(Types.VOID)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312 			return (csvMapper, container, obj) -&gt; container.nullNode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313 		} else if (info.equals(Types.STRING)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314 			return (csvMapper, container, obj) -&gt; container.textNode((String) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315 		} else if (info.equals(Types.BOOLEAN)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316 			return (csvMapper, container, obj) -&gt; container.booleanNode((Boolean) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317 		} else if (info.equals(Types.BYTE)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318 			return (csvMapper, container, obj) -&gt; container.numberNode((Byte) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319 		} else if (info.equals(Types.SHORT)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320 			return (csvMapper, container, obj) -&gt; container.numberNode((Short) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321 		} else if (info.equals(Types.INT)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322 			return (csvMapper, container, obj) -&gt; container.numberNode((Integer) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323 		} else if (info.equals(Types.LONG)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324 			return (csvMapper, container, obj) -&gt; container.numberNode((Long) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325 		} else if (info.equals(Types.FLOAT)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326 			return (csvMapper, container, obj) -&gt; container.numberNode((Float) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327 		} else if (info.equals(Types.DOUBLE)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328 			return (csvMapper, container, obj) -&gt; container.numberNode((Double) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329 		} else if (info.equals(Types.BIG_DEC)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330 			return (csvMapper, container, obj) -&gt; container.numberNode((BigDecimal) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331 		} else if (info.equals(Types.BIG_INT)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332 			return (csvMapper, container, obj) -&gt; container.numberNode((BigInteger) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333 		} else if (info.equals(Types.SQL_DATE)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335 		} else if (info.equals(Types.SQL_TIME)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337 		} else if (info.equals(Types.SQL_TIMESTAMP)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339 		} else if (info instanceof RowTypeInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340 			return createRowRuntimeConverter((RowTypeInfo) info, false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341 		} else if (info instanceof BasicArrayTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342 			return createObjectArrayRuntimeConverter(((BasicArrayTypeInfo) info).getComponentInfo());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343 		} else if (info instanceof ObjectArrayTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344 			return createObjectArrayRuntimeConverter(((ObjectArrayTypeInfo) info).getComponentInfo());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345 		} else if (info instanceof PrimitiveArrayTypeInfo &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346 				((PrimitiveArrayTypeInfo) info).getComponentType() == Types.BYTE) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347 			return createByteArrayRuntimeConverter();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349 		else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350 			throw new RuntimeException(&quot;Unsupported type information &#x27;&quot; + info + &quot;&#x27;.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354 	private static RuntimeConverter createObjectArrayRuntimeConverter(TypeInformation&lt;?&gt; elementType) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355 		final RuntimeConverter elementConverter = createNullableRuntimeConverter(elementType);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356 		return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357 			final Object[] array = (Object[]) obj;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358 			final ArrayNode arrayNode = csvMapper.createArrayNode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359 			for (Object element : array) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360 				arrayNode.add(elementConverter.convert(csvMapper, arrayNode, element));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362 			return arrayNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363 		};</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366 	private static RuntimeConverter createByteArrayRuntimeConverter() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367 		return (csvMapper, container, obj) -&gt; container.binaryNode((byte[]) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370 	private static void validateArity(int expected, int actual) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371 		if (expected != actual) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372 			throw new RuntimeException(&quot;Row length mismatch. &quot; + expected +</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373 				&quot; fields expected but was &quot; + actual + &quot;.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376 }</span>
 377 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396 package com.dtstack.flink.sql.sink.kafka.serialization;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398 import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400 import org.apache.flink.annotation.PublicEvolving;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401 import org.apache.flink.api.common.serialization.SerializationSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402 import org.apache.flink.api.common.typeinfo.BasicArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403 import org.apache.flink.api.common.typeinfo.PrimitiveArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405 import org.apache.flink.api.common.typeinfo.Types;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406 import org.apache.flink.api.java.typeutils.ObjectArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408 import org.apache.flink.formats.csv.CsvRowDeserializationSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 import org.apache.flink.formats.csv.CsvRowSchemaConverter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410 import org.apache.flink.formats.csv.CsvRowSerializationSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.JsonNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.ObjectWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ArrayNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ContainerNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ObjectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvMapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419 import org.apache.flink.table.runtime.types.CRowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 import java.io.Serializable;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 import java.math.BigDecimal;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425 import java.math.BigInteger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427 import java.util.Objects;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430  * Serialization schema that serializes an object of Flink types into a CSV bytes.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432  * &lt;p&gt;Serializes the input row into a {@link ObjectNode} and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433  * converts it into &lt;code&gt;byte[]&lt;/code&gt;.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435  * &lt;p&gt;Result &lt;code&gt;byte[]&lt;/code&gt; messages can be deserialized using {@link CsvRowDeserializationSchema}.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437 @PublicEvolving</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438 public final class CsvCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440 	private static final long serialVersionUID = 2098447220136965L;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442 	/** Type information describing the input CSV data. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443 	private final RowTypeInfo typeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445 	/** Runtime instance that performs the actual work. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446 	private final RuntimeConverter runtimeConverter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448 	/** CsvMapper used to write {@link JsonNode} into bytes. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449 	private final CsvMapper csvMapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451 	/** Schema describing the input CSV data. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452 	private CsvSchema csvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454 	/** Object writer used to write rows. It is configured by {@link CsvSchema}. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455 	private ObjectWriter objectWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457 	/** Reusable object node. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458 	private transient ObjectNode root;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460 	private String updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462 	private String retractKey = &quot;retract&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464 	private CsvCRowSerializationSchema(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465 			RowTypeInfo typeInfo,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466 			CsvSchema csvSchema,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467 			String updateMode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468 		this.typeInfo = typeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469 		this.runtimeConverter = createRowRuntimeConverter(typeInfo, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470 		this.csvMapper = new CsvMapper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471 		this.csvSchema = csvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473 		this.objectWriter = csvMapper.writer(csvSchema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477 	 * A builder for creating a {@link CsvRowSerializationSchema}.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479 	@PublicEvolving</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480 	public static class Builder {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482 		private final RowTypeInfo typeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483 		private CsvSchema csvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484 		private String updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486 		/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487 		 * Creates a {@link CsvRowSerializationSchema} expecting the given {@link TypeInformation}.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488 		 *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489 		 * @param typeInfo type information used to create schema.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490 		 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491 		public Builder(TypeInformation&lt;CRow&gt; typeInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492 			Preconditions.checkNotNull(typeInfo, &quot;Type information must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494 			if (!(typeInfo instanceof CRowTypeInfo)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495 				throw new IllegalArgumentException(&quot;Row type information expected.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497 			RowTypeInfo rowTypeInfo = ((CRowTypeInfo) typeInfo).rowType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498 			this.typeInfo = rowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499 			this.csvSchema = CsvRowSchemaConverter.convert(rowTypeInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502 		public Builder setFieldDelimiter(char c) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503 			this.csvSchema = this.csvSchema.rebuild().setColumnSeparator(c).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507 		public Builder setLineDelimiter(String delimiter) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508 			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509 			if (!(&quot;\n&quot;.equals(delimiter)) &amp;&amp; !(&quot;\r&quot;.equals(delimiter)) &amp;&amp; !(&quot;\r\n&quot;.equals(delimiter))) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510 				throw new IllegalArgumentException(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511 						&quot;Unsupported new line delimiter. Only \\n, \\r, or \\r\\n are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513 			this.csvSchema = this.csvSchema.rebuild().setLineSeparator(delimiter).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517 		public Builder setArrayElementDelimiter(String delimiter) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518 			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519 			this.csvSchema = this.csvSchema.rebuild().setArrayElementSeparator(delimiter).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523 		public Builder setQuoteCharacter(char c) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 			this.csvSchema = this.csvSchema.rebuild().setQuoteChar(c).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528 		public Builder setEscapeCharacter(char c) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529 			this.csvSchema = this.csvSchema.rebuild().setEscapeChar(c).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533 		public Builder setNullLiteral(String s) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534 			this.csvSchema = this.csvSchema.rebuild().setNullValue(s).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538 		public Builder setUpdateMode(String updateMode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539 			this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543 		public CsvCRowSerializationSchema build() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544 			return new CsvCRowSerializationSchema(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545 					typeInfo,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546 					csvSchema,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547 					updateMode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552 	public byte[] serialize(CRow crow) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553 		Row row = crow.row();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554 		boolean change = crow.change();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555 		if (root == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556 			root = csvMapper.createObjectNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558 		try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559 			runtimeConverter.convert(csvMapper, root, row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560 			if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561 				fillRetractField(row, change);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564 			return objectWriter.writeValueAsBytes(root);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565 		} catch (Throwable t) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566 			throw new RuntimeException(&quot;Could not serialize row &#x27;&quot; + row + &quot;&#x27;.&quot;, t);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570 	protected void fillRetractField(Row row, boolean change) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571 		root.put(retractKey, change);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572 		CsvSchema.Builder newBuilder = new CsvSchema.Builder(csvSchema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 574 		CsvSchema.Column retractColumn = new CsvSchema.Column(row.getArity(), retractKey, CsvSchema.ColumnType.BOOLEAN);"> 574 		CsvSchema.Column retractColumn = new CsvSchema.Column(row.getArity(), retractKey, CsvSchema.ColumnType.🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575 		newBuilder.addColumn(retractColumn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576 		csvSchema = newBuilder.build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578 		this.objectWriter = csvMapper.writer(csvSchema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583 	public boolean equals(Object o) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584 		if (o == null || o.getClass() != this.getClass()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585 			return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587 		if (this == o) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588 			return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590 		final CsvCRowSerializationSchema that = (CsvCRowSerializationSchema) o;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591 		final CsvSchema otherSchema = that.csvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593 		return typeInfo.equals(that.typeInfo) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594 			csvSchema.getColumnSeparator() == otherSchema.getColumnSeparator() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595 			Arrays.equals(csvSchema.getLineSeparator(), otherSchema.getLineSeparator()) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596 			csvSchema.getArrayElementSeparator().equals(otherSchema.getArrayElementSeparator()) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597 			csvSchema.getQuoteChar() == otherSchema.getQuoteChar() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598 			csvSchema.getEscapeChar() == otherSchema.getEscapeChar() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599 			Arrays.equals(csvSchema.getNullValue(), otherSchema.getNullValue());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603 	public int hashCode() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604 		return Objects.hash(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605 			typeInfo,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606 			csvSchema.getColumnSeparator(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607 			csvSchema.getLineSeparator(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608 			csvSchema.getArrayElementSeparator(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609 			csvSchema.getQuoteChar(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610 			csvSchema.getEscapeChar(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611 			csvSchema.getNullValue());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614 	// --------------------------------------------------------------------------------------------</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616 	private interface RuntimeConverter extends Serializable {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617 		JsonNode convert(CsvMapper csvMapper, ContainerNode&lt;?&gt; container, Object obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620 	private static RuntimeConverter createRowRuntimeConverter(RowTypeInfo rowTypeInfo, boolean isTopLevel) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621 		final TypeInformation[] fieldTypes = rowTypeInfo.getFieldTypes();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622 		final String[] fieldNames = rowTypeInfo.getFieldNames();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624 		final RuntimeConverter[] fieldConverters = createFieldRuntimeConverters(fieldTypes);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626 		return assembleRowRuntimeConverter(isTopLevel, fieldNames, fieldConverters);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629 	private static RuntimeConverter[] createFieldRuntimeConverters(TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630 		final RuntimeConverter[] fieldConverters = new RuntimeConverter[fieldTypes.length];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631 		for (int i = 0; i &lt; fieldTypes.length; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632 			fieldConverters[i] = createNullableRuntimeConverter(fieldTypes[i]);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634 		return fieldConverters;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637 	private static RuntimeConverter assembleRowRuntimeConverter(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638 			boolean isTopLevel,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639 			String[] fieldNames,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640 			RuntimeConverter[] fieldConverters) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641 		final int rowArity = fieldNames.length;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642 		// top level reuses the object node container</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643 		if (isTopLevel) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644 			return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645 				final Row row = (Row) obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647 				validateArity(rowArity, row.getArity());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649 				final ObjectNode objectNode = (ObjectNode) container;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650 				for (int i = 0; i &lt; rowArity; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651 					objectNode.set(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652 						fieldNames[i],</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653 						fieldConverters[i].convert(csvMapper, container, row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655 				return objectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656 			};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658 			return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659 				final Row row = (Row) obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661 				validateArity(rowArity, row.getArity());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663 				final ArrayNode arrayNode = csvMapper.createArrayNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664 				for (int i = 0; i &lt; rowArity; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665 					arrayNode.add(fieldConverters[i].convert(csvMapper, arrayNode, row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667 				return arrayNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668 			};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672 	private static RuntimeConverter createNullableRuntimeConverter(TypeInformation&lt;?&gt; info) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673 		final RuntimeConverter valueConverter = createRuntimeConverter(info);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674 		return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675 			if (obj == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676 				return container.nullNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678 			return valueConverter.convert(csvMapper, container, obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679 		};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682 	private static RuntimeConverter createRuntimeConverter(TypeInformation&lt;?&gt; info) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683 		if (info.equals(Types.VOID)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684 			return (csvMapper, container, obj) -&gt; container.nullNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685 		} else if (info.equals(Types.STRING)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686 			return (csvMapper, container, obj) -&gt; container.textNode((String) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687 		} else if (info.equals(Types.BOOLEAN)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688 			return (csvMapper, container, obj) -&gt; container.booleanNode((Boolean) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689 		} else if (info.equals(Types.BYTE)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690 			return (csvMapper, container, obj) -&gt; container.numberNode((Byte) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691 		} else if (info.equals(Types.SHORT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692 			return (csvMapper, container, obj) -&gt; container.numberNode((Short) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693 		} else if (info.equals(Types.INT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694 			return (csvMapper, container, obj) -&gt; container.numberNode((Integer) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695 		} else if (info.equals(Types.LONG)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696 			return (csvMapper, container, obj) -&gt; container.numberNode((Long) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697 		} else if (info.equals(Types.FLOAT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698 			return (csvMapper, container, obj) -&gt; container.numberNode((Float) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699 		} else if (info.equals(Types.DOUBLE)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700 			return (csvMapper, container, obj) -&gt; container.numberNode((Double) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701 		} else if (info.equals(Types.BIG_DEC)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702 			return (csvMapper, container, obj) -&gt; container.numberNode((BigDecimal) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703 		} else if (info.equals(Types.BIG_INT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704 			return (csvMapper, container, obj) -&gt; container.numberNode((BigInteger) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705 		} else if (info.equals(Types.SQL_DATE)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707 		} else if (info.equals(Types.SQL_TIME)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709 		} else if (info.equals(Types.SQL_TIMESTAMP)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711 		} else if (info instanceof RowTypeInfo){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712 			return createRowRuntimeConverter((RowTypeInfo) info, false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713 		} else if (info instanceof BasicArrayTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714 			return createObjectArrayRuntimeConverter(((BasicArrayTypeInfo) info).getComponentInfo());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715 		} else if (info instanceof ObjectArrayTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716 			return createObjectArrayRuntimeConverter(((ObjectArrayTypeInfo) info).getComponentInfo());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717 		} else if (info instanceof PrimitiveArrayTypeInfo &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718 				((PrimitiveArrayTypeInfo) info).getComponentType() == Types.BYTE) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719 			return createByteArrayRuntimeConverter();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721 		else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722 			throw new RuntimeException(&quot;Unsupported type information &#x27;&quot; + info + &quot;&#x27;.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726 	private static RuntimeConverter createObjectArrayRuntimeConverter(TypeInformation&lt;?&gt; elementType) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727 		final RuntimeConverter elementConverter = createNullableRuntimeConverter(elementType);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728 		return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729 			final Object[] array = (Object[]) obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730 			final ArrayNode arrayNode = csvMapper.createArrayNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731 			for (Object element : array) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732 				arrayNode.add(elementConverter.convert(csvMapper, arrayNode, element));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734 			return arrayNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735 		};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 738 	private static RuntimeConverter createByteArrayRuntimeConverter() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 739 		return (csvMapper, container, obj) -&gt; container.binaryNode((byte[]) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 740 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 741 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 742 	private static void validateArity(int expected, int actual) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 743 		if (expected != actual) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 744 			throw new RuntimeException(&quot;Row length mismatch. &quot; + expected +</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 745 				&quot; fields expected but was &quot; + actual + &quot;.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 746 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 747 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 748 }</span>
 749 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.sink.kafka.serialization;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.apache.flink.annotation.PublicEvolving;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.flink.api.common.serialization.SerializationSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.flink.api.common.typeinfo.BasicArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.flink.api.common.typeinfo.PrimitiveArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.apache.flink.api.common.typeinfo.Types;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.flink.api.java.typeutils.ObjectArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.flink.formats.csv.CsvRowDeserializationSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.apache.flink.formats.csv.CsvRowSchemaConverter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.apache.flink.formats.csv.CsvRowSerializationSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.JsonNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.ObjectWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ArrayNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ContainerNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ObjectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvMapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import org.apache.flink.table.runtime.types.CRowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.io.Serializable;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import java.math.BigDecimal;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import java.math.BigInteger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import java.util.Iterator;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import java.util.Objects;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import java.util.stream.IntStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 import java.util.stream.Stream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58  * Serialization schema that serializes an object of Flink types into a CSV bytes.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60  * &lt;p&gt;Serializes the input row into a {@link ObjectNode} and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61  * converts it into &lt;code&gt;byte[]&lt;/code&gt;.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63  * &lt;p&gt;Result &lt;code&gt;byte[]&lt;/code&gt; messages can be deserialized using {@link CsvRowDeserializationSchema}.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65 @PublicEvolving</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66 public final class CsvCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68 	private static final long serialVersionUID = 2098447220136965L;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 	/** Type information describing the input CSV data. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71 	private final RowTypeInfo typeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73 	/** Runtime instance that performs the actual work. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74 	private final RuntimeConverter runtimeConverter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76 	/** CsvMapper used to write {@link JsonNode} into bytes. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77 	private final CsvMapper csvMapper;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 	/** Schema describing the input CSV data. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80 	private CsvSchema csvSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82 	/** Object writer used to write rows. It is configured by {@link CsvSchema}. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83 	private ObjectWriter objectWriter;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85 	/** Reusable object node. */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86 	private transient ObjectNode root;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88 	private String updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90 	private String retractKey = &quot;retract&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92 	private CsvCRowSerializationSchema(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 			RowTypeInfo typeInfo,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94 			CsvSchema csvSchema,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95 			String updateMode) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 		this.typeInfo = typeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97 		this.runtimeConverter = createRowRuntimeConverter(typeInfo, true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98 		this.csvMapper = new CsvMapper();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99 		this.csvSchema = csvSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101 		this.objectWriter = csvMapper.writer(csvSchema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104 	/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105 	 * A builder for creating a {@link CsvRowSerializationSchema}.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107 	@PublicEvolving</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108 	public static class Builder {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110 		private final RowTypeInfo typeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111 		private CsvSchema csvSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112 		private String updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114 		/**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115 		 * Creates a {@link CsvRowSerializationSchema} expecting the given {@link TypeInformation}.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116 		 *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 		 * @param typeInfo type information used to create schema.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118 		 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119 		public Builder(TypeInformation&lt;CRow&gt; typeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120 			Preconditions.checkNotNull(typeInfo, &quot;Type information must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122 			if (!(typeInfo instanceof CRowTypeInfo)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 				throw new IllegalArgumentException(&quot;Row type information expected.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125 			RowTypeInfo rowTypeInfo = ((CRowTypeInfo) typeInfo).rowType();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126 			this.typeInfo = rowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127 			this.csvSchema = CsvRowSchemaConverter.convert(rowTypeInfo);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130 		public Builder setFieldDelimiter(char c) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131 			this.csvSchema = this.csvSchema.rebuild().setColumnSeparator(c).build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135 		public Builder setLineDelimiter(String delimiter) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136 			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137 			if (!delimiter.equals(&quot;\n&quot;) &amp;&amp; !delimiter.equals(&quot;\r&quot;) &amp;&amp; !delimiter.equals(&quot;\r\n&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138 				throw new IllegalArgumentException(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139 					&quot;Unsupported new line delimiter. Only \\n, \\r, or \\r\\n are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141 			this.csvSchema = this.csvSchema.rebuild().setLineSeparator(delimiter).build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 		public Builder setArrayElementDelimiter(String delimiter) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147 			this.csvSchema = this.csvSchema.rebuild().setArrayElementSeparator(delimiter).build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151 		public Builder setQuoteCharacter(char c) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152 			this.csvSchema = this.csvSchema.rebuild().setQuoteChar(c).build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156 		public Builder setEscapeCharacter(char c) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157 			this.csvSchema = this.csvSchema.rebuild().setEscapeChar(c).build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161 		public Builder setNullLiteral(String s) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162 			this.csvSchema = this.csvSchema.rebuild().setNullValue(s).build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 		public Builder setUpdateMode(String updateMode) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167 			this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168 			return this;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171 		public CsvCRowSerializationSchema build() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172 			return new CsvCRowSerializationSchema(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173 					typeInfo,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174 					csvSchema,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175 					updateMode);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180 	public byte[] serialize(CRow crow) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181 		Row row = crow.row();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 		boolean change = crow.change();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183 		if (root == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 			root = csvMapper.createObjectNode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 		try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187 			runtimeConverter.convert(csvMapper, root, row);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188 			if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189 				fillRetractField(row, change);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192 			return objectWriter.writeValueAsBytes(root);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193 		} catch (Throwable t) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194 			throw new RuntimeException(&quot;Could not serialize row &#x27;&quot; + row + &quot;&#x27;.&quot;, t);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198 	protected void fillRetractField(Row row, boolean change) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199 		root.put(retractKey, change);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200 		CsvSchema.Builder newBuilder = new CsvSchema.Builder(csvSchema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 202 		CsvSchema.Column retractColumn = new CsvSchema.Column(row.getArity(), retractKey, CsvSchema.ColumnType.BOOLEAN);"> 202 		CsvSchema.Column retractColumn = new CsvSchema.Column(row.getArity(), retractKey, CsvSchema.ColumnType.🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203 		newBuilder.addColumn(retractColumn);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204 		csvSchema = newBuilder.build();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206 		this.objectWriter = csvMapper.writer(csvSchema);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211 	public boolean equals(Object o) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212 		if (o == null || o.getClass() != this.getClass()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213 			return false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215 		if (this == o) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216 			return true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218 		final CsvCRowSerializationSchema that = (CsvCRowSerializationSchema) o;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219 		final CsvSchema otherSchema = that.csvSchema;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221 		return typeInfo.equals(that.typeInfo) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222 			csvSchema.getColumnSeparator() == otherSchema.getColumnSeparator() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223 			Arrays.equals(csvSchema.getLineSeparator(), otherSchema.getLineSeparator()) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224 			csvSchema.getArrayElementSeparator().equals(otherSchema.getArrayElementSeparator()) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225 			csvSchema.getQuoteChar() == otherSchema.getQuoteChar() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226 			csvSchema.getEscapeChar() == otherSchema.getEscapeChar() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227 			Arrays.equals(csvSchema.getNullValue(), otherSchema.getNullValue());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231 	public int hashCode() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232 		return Objects.hash(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 233 			typeInfo,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 234 			csvSchema.getColumnSeparator(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 235 			csvSchema.getLineSeparator(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 236 			csvSchema.getArrayElementSeparator(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 237 			csvSchema.getQuoteChar(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 238 			csvSchema.getEscapeChar(),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 239 			csvSchema.getNullValue());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 240 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 241 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 242 	// --------------------------------------------------------------------------------------------</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 243 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 244 	private interface RuntimeConverter extends Serializable {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 245 		JsonNode convert(CsvMapper csvMapper, ContainerNode&lt;?&gt; container, Object obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 246 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 247 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 248 	private static RuntimeConverter createRowRuntimeConverter(RowTypeInfo rowTypeInfo, boolean isTopLevel) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 249 		final TypeInformation[] fieldTypes = rowTypeInfo.getFieldTypes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 250 		final String[] fieldNames = rowTypeInfo.getFieldNames();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 251 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 252 		final RuntimeConverter[] fieldConverters = createFieldRuntimeConverters(fieldTypes);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254 		return assembleRowRuntimeConverter(isTopLevel, fieldNames, fieldConverters);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257 	private static RuntimeConverter[] createFieldRuntimeConverters(TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258 		final RuntimeConverter[] fieldConverters = new RuntimeConverter[fieldTypes.length];</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259 		for (int i = 0; i &lt; fieldTypes.length; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260 			fieldConverters[i] = createNullableRuntimeConverter(fieldTypes[i]);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262 		return fieldConverters;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 265 	private static RuntimeConverter assembleRowRuntimeConverter(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 266 			boolean isTopLevel,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 267 			String[] fieldNames,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 268 			RuntimeConverter[] fieldConverters) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 269 		final int rowArity = fieldNames.length;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 270 		// top level reuses the object node container</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 271 		if (isTopLevel) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 272 			return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 273 				final Row row = (Row) obj;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 274 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 275 				validateArity(rowArity, row.getArity());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 276 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 277 				final ObjectNode objectNode = (ObjectNode) container;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 278 				for (int i = 0; i &lt; rowArity; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 279 					objectNode.set(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 280 						fieldNames[i],</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 281 						fieldConverters[i].convert(csvMapper, container, row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 282 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 283 				return objectNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 284 			};</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 285 		} else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 286 			return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 287 				final Row row = (Row) obj;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 288 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 289 				validateArity(rowArity, row.getArity());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291 				final ArrayNode arrayNode = csvMapper.createArrayNode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292 				for (int i = 0; i &lt; rowArity; i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293 					arrayNode.add(fieldConverters[i].convert(csvMapper, arrayNode, row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294 				}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295 				return arrayNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296 			};</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300 	private static RuntimeConverter createNullableRuntimeConverter(TypeInformation&lt;?&gt; info) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301 		final RuntimeConverter valueConverter = createRuntimeConverter(info);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302 		return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303 			if (obj == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304 				return container.nullNode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306 			return valueConverter.convert(csvMapper, container, obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307 		};</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310 	private static RuntimeConverter createRuntimeConverter(TypeInformation&lt;?&gt; info) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311 		if (info.equals(Types.VOID)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312 			return (csvMapper, container, obj) -&gt; container.nullNode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313 		} else if (info.equals(Types.STRING)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314 			return (csvMapper, container, obj) -&gt; container.textNode((String) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315 		} else if (info.equals(Types.BOOLEAN)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316 			return (csvMapper, container, obj) -&gt; container.booleanNode((Boolean) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317 		} else if (info.equals(Types.BYTE)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318 			return (csvMapper, container, obj) -&gt; container.numberNode((Byte) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319 		} else if (info.equals(Types.SHORT)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320 			return (csvMapper, container, obj) -&gt; container.numberNode((Short) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321 		} else if (info.equals(Types.INT)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322 			return (csvMapper, container, obj) -&gt; container.numberNode((Integer) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323 		} else if (info.equals(Types.LONG)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324 			return (csvMapper, container, obj) -&gt; container.numberNode((Long) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325 		} else if (info.equals(Types.FLOAT)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326 			return (csvMapper, container, obj) -&gt; container.numberNode((Float) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327 		} else if (info.equals(Types.DOUBLE)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328 			return (csvMapper, container, obj) -&gt; container.numberNode((Double) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329 		} else if (info.equals(Types.BIG_DEC)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330 			return (csvMapper, container, obj) -&gt; container.numberNode((BigDecimal) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331 		} else if (info.equals(Types.BIG_INT)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332 			return (csvMapper, container, obj) -&gt; container.numberNode((BigInteger) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333 		} else if (info.equals(Types.SQL_DATE)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335 		} else if (info.equals(Types.SQL_TIME)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337 		} else if (info.equals(Types.SQL_TIMESTAMP)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339 		} else if (info instanceof RowTypeInfo){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340 			return createRowRuntimeConverter((RowTypeInfo) info, false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341 		} else if (info instanceof BasicArrayTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342 			return createObjectArrayRuntimeConverter(((BasicArrayTypeInfo) info).getComponentInfo());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343 		} else if (info instanceof ObjectArrayTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344 			return createObjectArrayRuntimeConverter(((ObjectArrayTypeInfo) info).getComponentInfo());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345 		} else if (info instanceof PrimitiveArrayTypeInfo &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346 				((PrimitiveArrayTypeInfo) info).getComponentType() == Types.BYTE) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347 			return createByteArrayRuntimeConverter();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349 		else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350 			throw new RuntimeException(&quot;Unsupported type information &#x27;&quot; + info + &quot;&#x27;.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354 	private static RuntimeConverter createObjectArrayRuntimeConverter(TypeInformation&lt;?&gt; elementType) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355 		final RuntimeConverter elementConverter = createNullableRuntimeConverter(elementType);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356 		return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357 			final Object[] array = (Object[]) obj;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358 			final ArrayNode arrayNode = csvMapper.createArrayNode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359 			for (Object element : array) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360 				arrayNode.add(elementConverter.convert(csvMapper, arrayNode, element));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361 			}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362 			return arrayNode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363 		};</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366 	private static RuntimeConverter createByteArrayRuntimeConverter() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367 		return (csvMapper, container, obj) -&gt; container.binaryNode((byte[]) obj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370 	private static void validateArity(int expected, int actual) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371 		if (expected != actual) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372 			throw new RuntimeException(&quot;Row length mismatch. &quot; + expected +</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373 				&quot; fields expected but was &quot; + actual + &quot;.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374 		}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376 }</span>
 377 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396 package com.dtstack.flink.sql.sink.kafka.serialization;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398 import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400 import org.apache.flink.annotation.PublicEvolving;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401 import org.apache.flink.api.common.serialization.SerializationSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402 import org.apache.flink.api.common.typeinfo.BasicArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403 import org.apache.flink.api.common.typeinfo.PrimitiveArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405 import org.apache.flink.api.common.typeinfo.Types;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406 import org.apache.flink.api.java.typeutils.ObjectArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408 import org.apache.flink.formats.csv.CsvRowDeserializationSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409 import org.apache.flink.formats.csv.CsvRowSchemaConverter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410 import org.apache.flink.formats.csv.CsvRowSerializationSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.JsonNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.ObjectWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ArrayNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ContainerNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ObjectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvMapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419 import org.apache.flink.table.runtime.types.CRowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423 import java.io.Serializable;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424 import java.math.BigDecimal;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425 import java.math.BigInteger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427 import java.util.Objects;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430  * Serialization schema that serializes an object of Flink types into a CSV bytes.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432  * &lt;p&gt;Serializes the input row into a {@link ObjectNode} and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433  * converts it into &lt;code&gt;byte[]&lt;/code&gt;.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435  * &lt;p&gt;Result &lt;code&gt;byte[]&lt;/code&gt; messages can be deserialized using {@link CsvRowDeserializationSchema}.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437 @PublicEvolving</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438 public final class CsvCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440 	private static final long serialVersionUID = 2098447220136965L;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442 	/** Type information describing the input CSV data. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443 	private final RowTypeInfo typeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445 	/** Runtime instance that performs the actual work. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446 	private final RuntimeConverter runtimeConverter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448 	/** CsvMapper used to write {@link JsonNode} into bytes. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449 	private final CsvMapper csvMapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451 	/** Schema describing the input CSV data. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452 	private CsvSchema csvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454 	/** Object writer used to write rows. It is configured by {@link CsvSchema}. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455 	private ObjectWriter objectWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457 	/** Reusable object node. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458 	private transient ObjectNode root;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460 	private String updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462 	private String retractKey = &quot;retract&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464 	private CsvCRowSerializationSchema(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465 			RowTypeInfo typeInfo,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466 			CsvSchema csvSchema,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467 			String updateMode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468 		this.typeInfo = typeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469 		this.runtimeConverter = createRowRuntimeConverter(typeInfo, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470 		this.csvMapper = new CsvMapper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471 		this.csvSchema = csvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473 		this.objectWriter = csvMapper.writer(csvSchema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477 	 * A builder for creating a {@link CsvRowSerializationSchema}.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479 	@PublicEvolving</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480 	public static class Builder {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 482 		private final RowTypeInfo typeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 483 		private CsvSchema csvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 484 		private String updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 485 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 486 		/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 487 		 * Creates a {@link CsvRowSerializationSchema} expecting the given {@link TypeInformation}.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 488 		 *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 489 		 * @param typeInfo type information used to create schema.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 490 		 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 491 		public Builder(TypeInformation&lt;CRow&gt; typeInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 492 			Preconditions.checkNotNull(typeInfo, &quot;Type information must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 493 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 494 			if (!(typeInfo instanceof CRowTypeInfo)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 495 				throw new IllegalArgumentException(&quot;Row type information expected.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 496 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 497 			RowTypeInfo rowTypeInfo = ((CRowTypeInfo) typeInfo).rowType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 498 			this.typeInfo = rowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 499 			this.csvSchema = CsvRowSchemaConverter.convert(rowTypeInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 500 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 501 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 502 		public Builder setFieldDelimiter(char c) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 503 			this.csvSchema = this.csvSchema.rebuild().setColumnSeparator(c).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 504 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 505 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507 		public Builder setLineDelimiter(String delimiter) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508 			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509 			if (!(&quot;\n&quot;.equals(delimiter)) &amp;&amp; !(&quot;\r&quot;.equals(delimiter)) &amp;&amp; !(&quot;\r\n&quot;.equals(delimiter))) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510 				throw new IllegalArgumentException(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511 						&quot;Unsupported new line delimiter. Only \\n, \\r, or \\r\\n are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 512 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513 			this.csvSchema = this.csvSchema.rebuild().setLineSeparator(delimiter).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517 		public Builder setArrayElementDelimiter(String delimiter) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518 			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519 			this.csvSchema = this.csvSchema.rebuild().setArrayElementSeparator(delimiter).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523 		public Builder setQuoteCharacter(char c) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524 			this.csvSchema = this.csvSchema.rebuild().setQuoteChar(c).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528 		public Builder setEscapeCharacter(char c) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529 			this.csvSchema = this.csvSchema.rebuild().setEscapeChar(c).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533 		public Builder setNullLiteral(String s) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534 			this.csvSchema = this.csvSchema.rebuild().setNullValue(s).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538 		public Builder setUpdateMode(String updateMode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539 			this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 540 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 541 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 542 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 543 		public CsvCRowSerializationSchema build() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 544 			return new CsvCRowSerializationSchema(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 545 					typeInfo,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 546 					csvSchema,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 547 					updateMode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 548 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 549 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 550 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 551 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 552 	public byte[] serialize(CRow crow) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 553 		Row row = crow.row();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 554 		boolean change = crow.change();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 555 		if (root == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 556 			root = csvMapper.createObjectNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 557 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 558 		try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 559 			runtimeConverter.convert(csvMapper, root, row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 560 			if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 561 				fillRetractField(row, change);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 562 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 564 			return objectWriter.writeValueAsBytes(root);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 565 		} catch (Throwable t) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 566 			throw new RuntimeException(&quot;Could not serialize row &#x27;&quot; + row + &quot;&#x27;.&quot;, t);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 567 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 568 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 569 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 570 	protected void fillRetractField(Row row, boolean change) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 571 		root.put(retractKey, change);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 572 		CsvSchema.Builder newBuilder = new CsvSchema.Builder(csvSchema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 573 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 574 		CsvSchema.Column retractColumn = new CsvSchema.Column(row.getArity(), retractKey, CsvSchema.ColumnType.BOOLEAN);"> 574 		CsvSchema.Column retractColumn = new CsvSchema.Column(row.getArity(), retractKey, CsvSchema.ColumnType.🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 575 		newBuilder.addColumn(retractColumn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 576 		csvSchema = newBuilder.build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 577 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 578 		this.objectWriter = csvMapper.writer(csvSchema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 579 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 580 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 581 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 582 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 583 	public boolean equals(Object o) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 584 		if (o == null || o.getClass() != this.getClass()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 585 			return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 586 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 587 		if (this == o) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 588 			return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 589 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 590 		final CsvCRowSerializationSchema that = (CsvCRowSerializationSchema) o;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 591 		final CsvSchema otherSchema = that.csvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 592 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 593 		return typeInfo.equals(that.typeInfo) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 594 			csvSchema.getColumnSeparator() == otherSchema.getColumnSeparator() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 595 			Arrays.equals(csvSchema.getLineSeparator(), otherSchema.getLineSeparator()) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 596 			csvSchema.getArrayElementSeparator().equals(otherSchema.getArrayElementSeparator()) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 597 			csvSchema.getQuoteChar() == otherSchema.getQuoteChar() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 598 			csvSchema.getEscapeChar() == otherSchema.getEscapeChar() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 599 			Arrays.equals(csvSchema.getNullValue(), otherSchema.getNullValue());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 600 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 601 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 602 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 603 	public int hashCode() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 604 		return Objects.hash(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 605 			typeInfo,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 606 			csvSchema.getColumnSeparator(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 607 			csvSchema.getLineSeparator(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 608 			csvSchema.getArrayElementSeparator(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 609 			csvSchema.getQuoteChar(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 610 			csvSchema.getEscapeChar(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 611 			csvSchema.getNullValue());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 612 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 613 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 614 	// --------------------------------------------------------------------------------------------</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 615 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 616 	private interface RuntimeConverter extends Serializable {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 617 		JsonNode convert(CsvMapper csvMapper, ContainerNode&lt;?&gt; container, Object obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 618 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 619 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 620 	private static RuntimeConverter createRowRuntimeConverter(RowTypeInfo rowTypeInfo, boolean isTopLevel) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 621 		final TypeInformation[] fieldTypes = rowTypeInfo.getFieldTypes();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 622 		final String[] fieldNames = rowTypeInfo.getFieldNames();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 623 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 624 		final RuntimeConverter[] fieldConverters = createFieldRuntimeConverters(fieldTypes);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 625 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 626 		return assembleRowRuntimeConverter(isTopLevel, fieldNames, fieldConverters);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 627 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 628 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 629 	private static RuntimeConverter[] createFieldRuntimeConverters(TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 630 		final RuntimeConverter[] fieldConverters = new RuntimeConverter[fieldTypes.length];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 631 		for (int i = 0; i &lt; fieldTypes.length; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 632 			fieldConverters[i] = createNullableRuntimeConverter(fieldTypes[i]);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 633 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 634 		return fieldConverters;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 635 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 636 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 637 	private static RuntimeConverter assembleRowRuntimeConverter(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 638 			boolean isTopLevel,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 639 			String[] fieldNames,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 640 			RuntimeConverter[] fieldConverters) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 641 		final int rowArity = fieldNames.length;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 642 		// top level reuses the object node container</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 643 		if (isTopLevel) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 644 			return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 645 				final Row row = (Row) obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 646 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 647 				validateArity(rowArity, row.getArity());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 648 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 649 				final ObjectNode objectNode = (ObjectNode) container;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 650 				for (int i = 0; i &lt; rowArity; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 651 					objectNode.set(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 652 						fieldNames[i],</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 653 						fieldConverters[i].convert(csvMapper, container, row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 654 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 655 				return objectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 656 			};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 657 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 658 			return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 659 				final Row row = (Row) obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 660 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 661 				validateArity(rowArity, row.getArity());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 662 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 663 				final ArrayNode arrayNode = csvMapper.createArrayNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 664 				for (int i = 0; i &lt; rowArity; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 665 					arrayNode.add(fieldConverters[i].convert(csvMapper, arrayNode, row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 666 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 667 				return arrayNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 668 			};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 669 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 670 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 671 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 672 	private static RuntimeConverter createNullableRuntimeConverter(TypeInformation&lt;?&gt; info) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 673 		final RuntimeConverter valueConverter = createRuntimeConverter(info);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 674 		return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 675 			if (obj == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 676 				return container.nullNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 677 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 678 			return valueConverter.convert(csvMapper, container, obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 679 		};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 680 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 681 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 682 	private static RuntimeConverter createRuntimeConverter(TypeInformation&lt;?&gt; info) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 683 		if (info.equals(Types.VOID)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 684 			return (csvMapper, container, obj) -&gt; container.nullNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 685 		} else if (info.equals(Types.STRING)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 686 			return (csvMapper, container, obj) -&gt; container.textNode((String) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 687 		} else if (info.equals(Types.BOOLEAN)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 688 			return (csvMapper, container, obj) -&gt; container.booleanNode((Boolean) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 689 		} else if (info.equals(Types.BYTE)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 690 			return (csvMapper, container, obj) -&gt; container.numberNode((Byte) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 691 		} else if (info.equals(Types.SHORT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 692 			return (csvMapper, container, obj) -&gt; container.numberNode((Short) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 693 		} else if (info.equals(Types.INT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 694 			return (csvMapper, container, obj) -&gt; container.numberNode((Integer) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 695 		} else if (info.equals(Types.LONG)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 696 			return (csvMapper, container, obj) -&gt; container.numberNode((Long) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 697 		} else if (info.equals(Types.FLOAT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 698 			return (csvMapper, container, obj) -&gt; container.numberNode((Float) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 699 		} else if (info.equals(Types.DOUBLE)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 700 			return (csvMapper, container, obj) -&gt; container.numberNode((Double) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 701 		} else if (info.equals(Types.BIG_DEC)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 702 			return (csvMapper, container, obj) -&gt; container.numberNode((BigDecimal) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 703 		} else if (info.equals(Types.BIG_INT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 704 			return (csvMapper, container, obj) -&gt; container.numberNode((BigInteger) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 705 		} else if (info.equals(Types.SQL_DATE)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 706 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 707 		} else if (info.equals(Types.SQL_TIME)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 708 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 709 		} else if (info.equals(Types.SQL_TIMESTAMP)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 710 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 711 		} else if (info instanceof RowTypeInfo){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 712 			return createRowRuntimeConverter((RowTypeInfo) info, false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 713 		} else if (info instanceof BasicArrayTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 714 			return createObjectArrayRuntimeConverter(((BasicArrayTypeInfo) info).getComponentInfo());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 715 		} else if (info instanceof ObjectArrayTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 716 			return createObjectArrayRuntimeConverter(((ObjectArrayTypeInfo) info).getComponentInfo());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 717 		} else if (info instanceof PrimitiveArrayTypeInfo &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 718 				((PrimitiveArrayTypeInfo) info).getComponentType() == Types.BYTE) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 719 			return createByteArrayRuntimeConverter();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 720 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 721 		else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 722 			throw new RuntimeException(&quot;Unsupported type information &#x27;&quot; + info + &quot;&#x27;.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 723 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 724 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 725 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 726 	private static RuntimeConverter createObjectArrayRuntimeConverter(TypeInformation&lt;?&gt; elementType) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 727 		final RuntimeConverter elementConverter = createNullableRuntimeConverter(elementType);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 728 		return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 729 			final Object[] array = (Object[]) obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 730 			final ArrayNode arrayNode = csvMapper.createArrayNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 731 			for (Object element : array) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 732 				arrayNode.add(elementConverter.convert(csvMapper, arrayNode, element));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 733 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 734 			return arrayNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 735 		};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 736 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 737 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 738 	private static RuntimeConverter createByteArrayRuntimeConverter() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 739 		return (csvMapper, container, obj) -&gt; container.binaryNode((byte[]) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 740 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 741 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 742 	private static void validateArity(int expected, int actual) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 743 		if (expected != actual) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 744 			throw new RuntimeException(&quot;Row length mismatch. &quot; + expected +</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 745 				&quot; fields expected but was &quot; + actual + &quot;.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 746 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 747 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 748 }</span>
 749 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
   4 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15  *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  19  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  20  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 package com.dtstack.flink.sql.sink.kafka.serialization;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import org.apache.flink.annotation.PublicEvolving;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import org.apache.flink.api.common.serialization.SerializationSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import org.apache.flink.api.common.typeinfo.BasicArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.apache.flink.api.common.typeinfo.PrimitiveArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import org.apache.flink.api.common.typeinfo.Types;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import org.apache.flink.api.java.typeutils.ObjectArrayTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import org.apache.flink.formats.csv.CsvRowDeserializationSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import org.apache.flink.formats.csv.CsvRowSchemaConverter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import org.apache.flink.formats.csv.CsvRowSerializationSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.JsonNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.ObjectWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ArrayNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ContainerNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ObjectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvMapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 import org.apache.flink.table.runtime.types.CRowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49 import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 import java.io.Serializable;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 import java.math.BigDecimal;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53 import java.math.BigInteger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54 import java.util.Arrays;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55 import java.util.Objects;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58  * Serialization schema that serializes an object of Flink types into a CSV bytes.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60  * &lt;p&gt;Serializes the input row into a {@link ObjectNode} and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61  * converts it into &lt;code&gt;byte[]&lt;/code&gt;.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63  * &lt;p&gt;Result &lt;code&gt;byte[]&lt;/code&gt; messages can be deserialized using {@link CsvRowDeserializationSchema}.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65 @PublicEvolving</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66 public final class CsvCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68 	private static final long serialVersionUID = 2098447220136965L;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70 	/** Type information describing the input CSV data. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71 	private final RowTypeInfo typeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73 	/** Runtime instance that performs the actual work. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74 	private final RuntimeConverter runtimeConverter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76 	/** CsvMapper used to write {@link JsonNode} into bytes. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77 	private final CsvMapper csvMapper;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79 	/** Schema describing the input CSV data. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80 	private CsvSchema csvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82 	/** Object writer used to write rows. It is configured by {@link CsvSchema}. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83 	private ObjectWriter objectWriter;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85 	/** Reusable object node. */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86 	private transient ObjectNode root;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88 	private String updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90 	private String retractKey = &quot;retract&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92 	private CsvCRowSerializationSchema(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93 			RowTypeInfo typeInfo,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94 			CsvSchema csvSchema,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95 			String updateMode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96 		this.typeInfo = typeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97 		this.runtimeConverter = createRowRuntimeConverter(typeInfo, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98 		this.csvMapper = new CsvMapper();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99 		this.csvSchema = csvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100 		this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101 		this.objectWriter = csvMapper.writer(csvSchema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104 	/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105 	 * A builder for creating a {@link CsvRowSerializationSchema}.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106 	 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107 	@PublicEvolving</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108 	public static class Builder {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110 		private final RowTypeInfo typeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111 		private CsvSchema csvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112 		private String updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114 		/**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115 		 * Creates a {@link CsvRowSerializationSchema} expecting the given {@link TypeInformation}.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116 		 *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117 		 * @param typeInfo type information used to create schema.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118 		 */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119 		public Builder(TypeInformation&lt;CRow&gt; typeInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120 			Preconditions.checkNotNull(typeInfo, &quot;Type information must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122 			if (!(typeInfo instanceof CRowTypeInfo)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123 				throw new IllegalArgumentException(&quot;Row type information expected.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125 			RowTypeInfo rowTypeInfo = ((CRowTypeInfo) typeInfo).rowType();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126 			this.typeInfo = rowTypeInfo;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127 			this.csvSchema = CsvRowSchemaConverter.convert(rowTypeInfo);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130 		public Builder setFieldDelimiter(char c) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131 			this.csvSchema = this.csvSchema.rebuild().setColumnSeparator(c).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135 		public Builder setLineDelimiter(String delimiter) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136 			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137 			if (!(&quot;\n&quot;.equals(delimiter)) &amp;&amp; !(&quot;\r&quot;.equals(delimiter)) &amp;&amp; !(&quot;\r\n&quot;.equals(delimiter))) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138 				throw new IllegalArgumentException(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139 						&quot;Unsupported new line delimiter. Only \\n, \\r, or \\r\\n are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141 			this.csvSchema = this.csvSchema.rebuild().setLineSeparator(delimiter).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145 		public Builder setArrayElementDelimiter(String delimiter) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146 			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147 			this.csvSchema = this.csvSchema.rebuild().setArrayElementSeparator(delimiter).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151 		public Builder setQuoteCharacter(char c) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152 			this.csvSchema = this.csvSchema.rebuild().setQuoteChar(c).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156 		public Builder setEscapeCharacter(char c) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157 			this.csvSchema = this.csvSchema.rebuild().setEscapeChar(c).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161 		public Builder setNullLiteral(String s) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162 			this.csvSchema = this.csvSchema.rebuild().setNullValue(s).build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166 		public Builder setUpdateMode(String updateMode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 167 			this.updateMode = updateMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168 			return this;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171 		public CsvCRowSerializationSchema build() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172 			return new CsvCRowSerializationSchema(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173 					typeInfo,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174 					csvSchema,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175 					updateMode);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180 	public byte[] serialize(CRow crow) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181 		Row row = crow.row();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182 		boolean change = crow.change();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183 		if (root == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184 			root = csvMapper.createObjectNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186 		try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187 			runtimeConverter.convert(csvMapper, root, row);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 			if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 				fillRetractField(row, change);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192 			return objectWriter.writeValueAsBytes(root);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193 		} catch (Throwable t) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194 			throw new RuntimeException(&quot;Could not serialize row &#x27;&quot; + row + &quot;&#x27;.&quot;, t);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198 	protected void fillRetractField(Row row, boolean change) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199 		root.put(retractKey, change);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200 		CsvSchema.Builder newBuilder = new CsvSchema.Builder(csvSchema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 202 		CsvSchema.Column retractColumn = new CsvSchema.Column(row.getArity(), retractKey, CsvSchema.ColumnType.BOOLEAN);"> 202 		CsvSchema.Column retractColumn = new CsvSchema.Column(row.getArity(), retractKey, CsvSchema.ColumnType.🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 		newBuilder.addColumn(retractColumn);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 		csvSchema = newBuilder.build();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 		this.objectWriter = csvMapper.writer(csvSchema);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 	public boolean equals(Object o) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 		if (o == null || o.getClass() != this.getClass()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 			return false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215 		if (this == o) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216 			return true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218 		final CsvCRowSerializationSchema that = (CsvCRowSerializationSchema) o;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219 		final CsvSchema otherSchema = that.csvSchema;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221 		return typeInfo.equals(that.typeInfo) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 			csvSchema.getColumnSeparator() == otherSchema.getColumnSeparator() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223 			Arrays.equals(csvSchema.getLineSeparator(), otherSchema.getLineSeparator()) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 			csvSchema.getArrayElementSeparator().equals(otherSchema.getArrayElementSeparator()) &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 			csvSchema.getQuoteChar() == otherSchema.getQuoteChar() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 			csvSchema.getEscapeChar() == otherSchema.getEscapeChar() &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227 			Arrays.equals(csvSchema.getNullValue(), otherSchema.getNullValue());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230 	@Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231 	public int hashCode() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232 		return Objects.hash(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233 			typeInfo,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234 			csvSchema.getColumnSeparator(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235 			csvSchema.getLineSeparator(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236 			csvSchema.getArrayElementSeparator(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237 			csvSchema.getQuoteChar(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238 			csvSchema.getEscapeChar(),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239 			csvSchema.getNullValue());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242 	// --------------------------------------------------------------------------------------------</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244 	private interface RuntimeConverter extends Serializable {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245 		JsonNode convert(CsvMapper csvMapper, ContainerNode&lt;?&gt; container, Object obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248 	private static RuntimeConverter createRowRuntimeConverter(RowTypeInfo rowTypeInfo, boolean isTopLevel) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249 		final TypeInformation[] fieldTypes = rowTypeInfo.getFieldTypes();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250 		final String[] fieldNames = rowTypeInfo.getFieldNames();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252 		final RuntimeConverter[] fieldConverters = createFieldRuntimeConverters(fieldTypes);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254 		return assembleRowRuntimeConverter(isTopLevel, fieldNames, fieldConverters);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257 	private static RuntimeConverter[] createFieldRuntimeConverters(TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258 		final RuntimeConverter[] fieldConverters = new RuntimeConverter[fieldTypes.length];</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259 		for (int i = 0; i &lt; fieldTypes.length; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260 			fieldConverters[i] = createNullableRuntimeConverter(fieldTypes[i]);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262 		return fieldConverters;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265 	private static RuntimeConverter assembleRowRuntimeConverter(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266 			boolean isTopLevel,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267 			String[] fieldNames,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268 			RuntimeConverter[] fieldConverters) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269 		final int rowArity = fieldNames.length;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270 		// top level reuses the object node container</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271 		if (isTopLevel) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272 			return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273 				final Row row = (Row) obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275 				validateArity(rowArity, row.getArity());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277 				final ObjectNode objectNode = (ObjectNode) container;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278 				for (int i = 0; i &lt; rowArity; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279 					objectNode.set(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280 						fieldNames[i],</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281 						fieldConverters[i].convert(csvMapper, container, row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283 				return objectNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284 			};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285 		} else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286 			return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287 				final Row row = (Row) obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289 				validateArity(rowArity, row.getArity());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291 				final ArrayNode arrayNode = csvMapper.createArrayNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292 				for (int i = 0; i &lt; rowArity; i++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293 					arrayNode.add(fieldConverters[i].convert(csvMapper, arrayNode, row.getField(i)));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294 				}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295 				return arrayNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296 			};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 297 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300 	private static RuntimeConverter createNullableRuntimeConverter(TypeInformation&lt;?&gt; info) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301 		final RuntimeConverter valueConverter = createRuntimeConverter(info);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302 		return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303 			if (obj == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304 				return container.nullNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306 			return valueConverter.convert(csvMapper, container, obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307 		};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310 	private static RuntimeConverter createRuntimeConverter(TypeInformation&lt;?&gt; info) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311 		if (info.equals(Types.VOID)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312 			return (csvMapper, container, obj) -&gt; container.nullNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313 		} else if (info.equals(Types.STRING)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314 			return (csvMapper, container, obj) -&gt; container.textNode((String) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315 		} else if (info.equals(Types.BOOLEAN)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316 			return (csvMapper, container, obj) -&gt; container.booleanNode((Boolean) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317 		} else if (info.equals(Types.BYTE)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318 			return (csvMapper, container, obj) -&gt; container.numberNode((Byte) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319 		} else if (info.equals(Types.SHORT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320 			return (csvMapper, container, obj) -&gt; container.numberNode((Short) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321 		} else if (info.equals(Types.INT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322 			return (csvMapper, container, obj) -&gt; container.numberNode((Integer) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323 		} else if (info.equals(Types.LONG)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324 			return (csvMapper, container, obj) -&gt; container.numberNode((Long) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325 		} else if (info.equals(Types.FLOAT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326 			return (csvMapper, container, obj) -&gt; container.numberNode((Float) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327 		} else if (info.equals(Types.DOUBLE)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328 			return (csvMapper, container, obj) -&gt; container.numberNode((Double) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329 		} else if (info.equals(Types.BIG_DEC)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330 			return (csvMapper, container, obj) -&gt; container.numberNode((BigDecimal) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331 		} else if (info.equals(Types.BIG_INT)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 332 			return (csvMapper, container, obj) -&gt; container.numberNode((BigInteger) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 333 		} else if (info.equals(Types.SQL_DATE)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 334 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 335 		} else if (info.equals(Types.SQL_TIME)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 336 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 337 		} else if (info.equals(Types.SQL_TIMESTAMP)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 338 			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339 		} else if (info instanceof RowTypeInfo){</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340 			return createRowRuntimeConverter((RowTypeInfo) info, false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341 		} else if (info instanceof BasicArrayTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342 			return createObjectArrayRuntimeConverter(((BasicArrayTypeInfo) info).getComponentInfo());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343 		} else if (info instanceof ObjectArrayTypeInfo) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344 			return createObjectArrayRuntimeConverter(((ObjectArrayTypeInfo) info).getComponentInfo());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345 		} else if (info instanceof PrimitiveArrayTypeInfo &amp;&amp;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346 				((PrimitiveArrayTypeInfo) info).getComponentType() == Types.BYTE) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347 			return createByteArrayRuntimeConverter();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349 		else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350 			throw new RuntimeException(&quot;Unsupported type information &#x27;&quot; + info + &quot;&#x27;.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 353 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354 	private static RuntimeConverter createObjectArrayRuntimeConverter(TypeInformation&lt;?&gt; elementType) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355 		final RuntimeConverter elementConverter = createNullableRuntimeConverter(elementType);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356 		return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357 			final Object[] array = (Object[]) obj;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358 			final ArrayNode arrayNode = csvMapper.createArrayNode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359 			for (Object element : array) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360 				arrayNode.add(elementConverter.convert(csvMapper, arrayNode, element));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361 			}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362 			return arrayNode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363 		};</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366 	private static RuntimeConverter createByteArrayRuntimeConverter() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367 		return (csvMapper, container, obj) -&gt; container.binaryNode((byte[]) obj);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370 	private static void validateArity(int expected, int actual) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371 		if (expected != actual) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372 			throw new RuntimeException(&quot;Row length mismatch. &quot; + expected +</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373 				&quot; fields expected but was &quot; + actual + &quot;.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374 		}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375 	}</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376 }</span>
 377 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * distributed with this work for additional information</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 - * limitations under the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -package com.dtstack.flink.sql.sink.kafka.serialization;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import com.dtstack.flink.sql.enums.EUpdateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import org.apache.flink.annotation.PublicEvolving;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import org.apache.flink.api.common.serialization.SerializationSchema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.apache.flink.api.common.typeinfo.BasicArrayTypeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.apache.flink.api.common.typeinfo.PrimitiveArrayTypeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.apache.flink.api.common.typeinfo.TypeInformation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import org.apache.flink.api.common.typeinfo.Types;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.apache.flink.api.java.typeutils.ObjectArrayTypeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import org.apache.flink.formats.csv.CsvRowDeserializationSchema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import org.apache.flink.formats.csv.CsvRowSchemaConverter;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import org.apache.flink.formats.csv.CsvRowSerializationSchema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.JsonNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.ObjectWriter;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ArrayNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ContainerNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ObjectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvMapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvSchema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import org.apache.flink.table.runtime.types.CRowTypeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import org.apache.flink.types.Row;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import org.apache.flink.util.Preconditions;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import java.io.Serializable;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import java.math.BigDecimal;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import java.math.BigInteger;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import java.util.Arrays;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import java.util.Iterator;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -import java.util.Objects;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import java.util.stream.IntStream;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -import java.util.stream.Stream;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 - * Serialization schema that serializes an object of Flink types into a CSV bytes.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 - * &lt;p&gt;Serializes the input row into a {@link ObjectNode} and</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 - * converts it into &lt;code&gt;byte[]&lt;/code&gt;.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 - * &lt;p&gt;Result &lt;code&gt;byte[]&lt;/code&gt; messages can be deserialized using {@link CsvRowDeserializationSchema}.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -@PublicEvolving</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -public final class CsvCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -	private static final long serialVersionUID = 2098447220136965L;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -	/** Type information describing the input CSV data. */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -	private final RowTypeInfo typeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -	/** Runtime instance that performs the actual work. */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -	private final RuntimeConverter runtimeConverter;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -	/** CsvMapper used to write {@link JsonNode} into bytes. */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -	private final CsvMapper csvMapper;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -	/** Schema describing the input CSV data. */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -	private CsvSchema csvSchema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -	/** Object writer used to write rows. It is configured by {@link CsvSchema}. */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -	private ObjectWriter objectWriter;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -	/** Reusable object node. */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -	private transient ObjectNode root;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -	private String updateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -	private String retractKey = &quot;retract&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -	private CsvCRowSerializationSchema(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -			RowTypeInfo typeInfo,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -			CsvSchema csvSchema,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -			String updateMode) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -		this.typeInfo = typeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -		this.runtimeConverter = createRowRuntimeConverter(typeInfo, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -		this.csvMapper = new CsvMapper();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -		this.csvSchema = csvSchema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -		this.updateMode = updateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -		this.objectWriter = csvMapper.writer(csvSchema);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -	/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -	 * A builder for creating a {@link CsvRowSerializationSchema}.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -	 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -	@PublicEvolving</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -	public static class Builder {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -		private final RowTypeInfo typeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -		private CsvSchema csvSchema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -		private String updateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -		/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -		 * Creates a {@link CsvRowSerializationSchema} expecting the given {@link TypeInformation}.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -		 *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -		 * @param typeInfo type information used to create schema.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -		 */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -		public Builder(TypeInformation&lt;CRow&gt; typeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -			Preconditions.checkNotNull(typeInfo, &quot;Type information must not be null.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -			if (!(typeInfo instanceof CRowTypeInfo)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -				throw new IllegalArgumentException(&quot;Row type information expected.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -			RowTypeInfo rowTypeInfo = ((CRowTypeInfo) typeInfo).rowType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -			this.typeInfo = rowTypeInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -			this.csvSchema = CsvRowSchemaConverter.convert(rowTypeInfo);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -		public Builder setFieldDelimiter(char c) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -			this.csvSchema = this.csvSchema.rebuild().setColumnSeparator(c).build();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -			return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -		public Builder setLineDelimiter(String delimiter) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -			if (!delimiter.equals(&quot;\n&quot;) &amp;&amp; !delimiter.equals(&quot;\r&quot;) &amp;&amp; !delimiter.equals(&quot;\r\n&quot;)) {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -				throw new IllegalArgumentException(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -					&quot;Unsupported new line delimiter. Only \\n, \\r, or \\r\\n are supported.&quot;);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -			this.csvSchema = this.csvSchema.rebuild().setLineSeparator(delimiter).build();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -			return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -		public Builder setArrayElementDelimiter(String delimiter) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -			this.csvSchema = this.csvSchema.rebuild().setArrayElementSeparator(delimiter).build();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -			return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -		public Builder setQuoteCharacter(char c) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -			this.csvSchema = this.csvSchema.rebuild().setQuoteChar(c).build();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -			return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -		public Builder setEscapeCharacter(char c) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -			this.csvSchema = this.csvSchema.rebuild().setEscapeChar(c).build();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -			return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -		public Builder setNullLiteral(String s) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -			this.csvSchema = this.csvSchema.rebuild().setNullValue(s).build();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -			return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -		public Builder setUpdateMode(String updateMode) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -			this.updateMode = updateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -			return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -		public CsvCRowSerializationSchema build() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -			return new CsvCRowSerializationSchema(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -					typeInfo,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -					csvSchema,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -					updateMode);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -	public byte[] serialize(CRow crow) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -		Row row = crow.row();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -		boolean change = crow.change();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -		if (root == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -			root = csvMapper.createObjectNode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 184 -		try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 185 -			runtimeConverter.convert(csvMapper, root, row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 186 -			if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 187 -				fillRetractField(row, change);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -			return objectWriter.writeValueAsBytes(root);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -		} catch (Throwable t) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -			throw new RuntimeException(&quot;Could not serialize row &#x27;&quot; + row + &quot;&#x27;.&quot;, t);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -	protected void fillRetractField(Row row, boolean change) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -		root.put(retractKey, change);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -		CsvSchema.Builder newBuilder = new CsvSchema.Builder(csvSchema);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -		CsvSchema.Column retractColumn = new CsvSchema.Column(row.getArity(), retractKey, CsvSchema.ColumnType.BOOLEAN);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -		newBuilder.addColumn(retractColumn);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -		csvSchema = newBuilder.build();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -		this.objectWriter = csvMapper.writer(csvSchema);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -	public boolean equals(Object o) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -		if (o == null || o.getClass() != this.getClass()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -			return false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -		if (this == o) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -			return true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -		final CsvCRowSerializationSchema that = (CsvCRowSerializationSchema) o;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -		final CsvSchema otherSchema = that.csvSchema;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 219 -		return typeInfo.equals(that.typeInfo) &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 220 -			csvSchema.getColumnSeparator() == otherSchema.getColumnSeparator() &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 221 -			Arrays.equals(csvSchema.getLineSeparator(), otherSchema.getLineSeparator()) &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 222 -			csvSchema.getArrayElementSeparator().equals(otherSchema.getArrayElementSeparator()) &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 223 -			csvSchema.getQuoteChar() == otherSchema.getQuoteChar() &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 224 -			csvSchema.getEscapeChar() == otherSchema.getEscapeChar() &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 225 -			Arrays.equals(csvSchema.getNullValue(), otherSchema.getNullValue());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 226 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 227 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 228 -	@Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -	public int hashCode() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 230 -		return Objects.hash(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 231 -			typeInfo,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 232 -			csvSchema.getColumnSeparator(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 233 -			csvSchema.getLineSeparator(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 234 -			csvSchema.getArrayElementSeparator(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 235 -			csvSchema.getQuoteChar(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 236 -			csvSchema.getEscapeChar(),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 237 -			csvSchema.getNullValue());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 238 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 239 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 240 -	// --------------------------------------------------------------------------------------------</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 241 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 242 -	private interface RuntimeConverter extends Serializable {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 243 -		JsonNode convert(CsvMapper csvMapper, ContainerNode&lt;?&gt; container, Object obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 244 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 245 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 246 -	private static RuntimeConverter createRowRuntimeConverter(RowTypeInfo rowTypeInfo, boolean isTopLevel) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 247 -		final TypeInformation[] fieldTypes = rowTypeInfo.getFieldTypes();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 248 -		final String[] fieldNames = rowTypeInfo.getFieldNames();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 249 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 250 -		final RuntimeConverter[] fieldConverters = createFieldRuntimeConverters(fieldTypes);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 252 -		return assembleRowRuntimeConverter(isTopLevel, fieldNames, fieldConverters);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 253 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 255 -	private static RuntimeConverter[] createFieldRuntimeConverters(TypeInformation&lt;?&gt;[] fieldTypes) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 256 -		final RuntimeConverter[] fieldConverters = new RuntimeConverter[fieldTypes.length];</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 257 -		for (int i = 0; i &lt; fieldTypes.length; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 258 -			fieldConverters[i] = createNullableRuntimeConverter(fieldTypes[i]);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 259 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 260 -		return fieldConverters;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 261 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 262 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 263 -	private static RuntimeConverter assembleRowRuntimeConverter(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 264 -			boolean isTopLevel,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 265 -			String[] fieldNames,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 266 -			RuntimeConverter[] fieldConverters) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 267 -		final int rowArity = fieldNames.length;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 268 -		// top level reuses the object node container</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 269 -		if (isTopLevel) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 270 -			return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -				final Row row = (Row) obj;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -				validateArity(rowArity, row.getArity());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 274 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -				final ObjectNode objectNode = (ObjectNode) container;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 276 -				for (int i = 0; i &lt; rowArity; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 277 -					objectNode.set(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -						fieldNames[i],</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 279 -						fieldConverters[i].convert(csvMapper, container, row.getField(i)));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 280 -				}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 281 -				return objectNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 282 -			};</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -		} else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -			return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -				final Row row = (Row) obj;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -				validateArity(rowArity, row.getArity());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -				final ArrayNode arrayNode = csvMapper.createArrayNode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -				for (int i = 0; i &lt; rowArity; i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -					arrayNode.add(fieldConverters[i].convert(csvMapper, arrayNode, row.getField(i)));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -				}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -				return arrayNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -			};</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 297 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 298 -	private static RuntimeConverter createNullableRuntimeConverter(TypeInformation&lt;?&gt; info) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 299 -		final RuntimeConverter valueConverter = createRuntimeConverter(info);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -		return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 301 -			if (obj == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 302 -				return container.nullNode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 303 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 304 -			return valueConverter.convert(csvMapper, container, obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 305 -		};</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 306 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 307 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -	private static RuntimeConverter createRuntimeConverter(TypeInformation&lt;?&gt; info) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -		if (info.equals(Types.VOID)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -			return (csvMapper, container, obj) -&gt; container.nullNode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -		} else if (info.equals(Types.STRING)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -			return (csvMapper, container, obj) -&gt; container.textNode((String) obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -		} else if (info.equals(Types.BOOLEAN)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -			return (csvMapper, container, obj) -&gt; container.booleanNode((Boolean) obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -		} else if (info.equals(Types.BYTE)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -			return (csvMapper, container, obj) -&gt; container.numberNode((Byte) obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 317 -		} else if (info.equals(Types.SHORT)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -			return (csvMapper, container, obj) -&gt; container.numberNode((Short) obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -		} else if (info.equals(Types.INT)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -			return (csvMapper, container, obj) -&gt; container.numberNode((Integer) obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 321 -		} else if (info.equals(Types.LONG)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -			return (csvMapper, container, obj) -&gt; container.numberNode((Long) obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -		} else if (info.equals(Types.FLOAT)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -			return (csvMapper, container, obj) -&gt; container.numberNode((Float) obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 325 -		} else if (info.equals(Types.DOUBLE)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 326 -			return (csvMapper, container, obj) -&gt; container.numberNode((Double) obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 327 -		} else if (info.equals(Types.BIG_DEC)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 328 -			return (csvMapper, container, obj) -&gt; container.numberNode((BigDecimal) obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 329 -		} else if (info.equals(Types.BIG_INT)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 330 -			return (csvMapper, container, obj) -&gt; container.numberNode((BigInteger) obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 331 -		} else if (info.equals(Types.SQL_DATE)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 332 -			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 333 -		} else if (info.equals(Types.SQL_TIME)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 334 -			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 335 -		} else if (info.equals(Types.SQL_TIMESTAMP)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 336 -			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 337 -		} else if (info instanceof RowTypeInfo){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 338 -			return createRowRuntimeConverter((RowTypeInfo) info, false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 339 -		} else if (info instanceof BasicArrayTypeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 340 -			return createObjectArrayRuntimeConverter(((BasicArrayTypeInfo) info).getComponentInfo());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 341 -		} else if (info instanceof ObjectArrayTypeInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 342 -			return createObjectArrayRuntimeConverter(((ObjectArrayTypeInfo) info).getComponentInfo());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 343 -		} else if (info instanceof PrimitiveArrayTypeInfo &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 344 -				((PrimitiveArrayTypeInfo) info).getComponentType() == Types.BYTE) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 345 -			return createByteArrayRuntimeConverter();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 346 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 347 -		else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 348 -			throw new RuntimeException(&quot;Unsupported type information &#x27;&quot; + info + &quot;&#x27;.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 349 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 350 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 351 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 352 -	private static RuntimeConverter createObjectArrayRuntimeConverter(TypeInformation&lt;?&gt; elementType) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -		final RuntimeConverter elementConverter = createNullableRuntimeConverter(elementType);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 354 -		return (csvMapper, container, obj) -&gt; {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 355 -			final Object[] array = (Object[]) obj;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 356 -			final ArrayNode arrayNode = csvMapper.createArrayNode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 357 -			for (Object element : array) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 358 -				arrayNode.add(elementConverter.convert(csvMapper, arrayNode, element));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 359 -			}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 360 -			return arrayNode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 361 -		};</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 362 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 363 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 364 -	private static RuntimeConverter createByteArrayRuntimeConverter() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 365 -		return (csvMapper, container, obj) -&gt; container.binaryNode((byte[]) obj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 366 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 367 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 368 -	private static void validateArity(int expected, int actual) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -		if (expected != actual) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -			throw new RuntimeException(&quot;Row length mismatch. &quot; + expected +</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -				&quot; fields expected but was &quot; + actual + &quot;.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -		}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -}</span></pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  package com.dtstack.flink.sql.sink.kafka.serialization;
  20  
  21  import com.dtstack.flink.sql.enums.EUpdateMode;
  22  import org.apache.commons.lang3.StringUtils;
  23  import org.apache.flink.annotation.PublicEvolving;
  24  import org.apache.flink.api.common.serialization.SerializationSchema;
  25  import org.apache.flink.api.common.typeinfo.BasicArrayTypeInfo;
  26  import org.apache.flink.api.common.typeinfo.PrimitiveArrayTypeInfo;
  27  import org.apache.flink.api.common.typeinfo.TypeInformation;
  28  import org.apache.flink.api.common.typeinfo.Types;
  29  import org.apache.flink.api.java.typeutils.ObjectArrayTypeInfo;
  30  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  31  import org.apache.flink.formats.csv.CsvRowDeserializationSchema;
  32  import org.apache.flink.formats.csv.CsvRowSchemaConverter;
  33  import org.apache.flink.formats.csv.CsvRowSerializationSchema;
  34  import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.JsonNode;
  35  import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.ObjectWriter;
  36  import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ArrayNode;
  37  import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ContainerNode;
  38  import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.node.ObjectNode;
  39  import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvMapper;
  40  import org.apache.flink.shaded.jackson2.com.fasterxml.jackson.dataformat.csv.CsvSchema;
  41  import org.apache.flink.table.runtime.types.CRow;
  42  import org.apache.flink.table.runtime.types.CRowTypeInfo;
  43  import org.apache.flink.types.Row;
  44  import org.apache.flink.util.Preconditions;
  45  
  46  import java.io.Serializable;
  47  import java.math.BigDecimal;
  48  import java.math.BigInteger;
  49  import java.util.Arrays;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import java.util.Iterator;</span>
  51  import java.util.Objects;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import java.util.stream.IntStream;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -import java.util.stream.Stream;</span>
  54  
  55  /**
  56   * Serialization schema that serializes an object of Flink types into a CSV bytes.
  57   *
  58   * &lt;p&gt;Serializes the input row into a {@link ObjectNode} and
  59   * converts it into &lt;code&gt;byte[]&lt;/code&gt;.
  60   *
  61   * &lt;p&gt;Result &lt;code&gt;byte[]&lt;/code&gt; messages can be deserialized using {@link CsvRowDeserializationSchema}.
  62   */
  63  @PublicEvolving
  64  public final class CsvCRowSerializationSchema implements SerializationSchema&lt;CRow&gt; {
  65  
  66  	private static final long serialVersionUID = 2098447220136965L;
  67  
  68  	/** Type information describing the input CSV data. */
  69  	private final RowTypeInfo typeInfo;
  70  
  71  	/** Runtime instance that performs the actual work. */
  72  	private final RuntimeConverter runtimeConverter;
  73  
  74  	/** CsvMapper used to write {@link JsonNode} into bytes. */
  75  	private final CsvMapper csvMapper;
  76  
  77  	/** Schema describing the input CSV data. */
  78  	private CsvSchema csvSchema;
  79  
  80  	/** Object writer used to write rows. It is configured by {@link CsvSchema}. */
  81  	private ObjectWriter objectWriter;
  82  
  83  	/** Reusable object node. */
  84  	private transient ObjectNode root;
  85  
  86  	private String updateMode;
  87  
  88  	private String retractKey = &quot;retract&quot;;
  89  
  90  	private CsvCRowSerializationSchema(
  91  			RowTypeInfo typeInfo,
  92  			CsvSchema csvSchema,
  93  			String updateMode) {
  94  		this.typeInfo = typeInfo;
  95  		this.runtimeConverter = createRowRuntimeConverter(typeInfo, true);
  96  		this.csvMapper = new CsvMapper();
  97  		this.csvSchema = csvSchema;
  98  		this.updateMode = updateMode;
  99  		this.objectWriter = csvMapper.writer(csvSchema);
 100  	}
 101  
 102  	/**
 103  	 * A builder for creating a {@link CsvRowSerializationSchema}.
 104  	 */
 105  	@PublicEvolving
 106  	public static class Builder {
 107  
 108  		private final RowTypeInfo typeInfo;
 109  		private CsvSchema csvSchema;
 110  		private String updateMode;
 111  
 112  		/**
 113  		 * Creates a {@link CsvRowSerializationSchema} expecting the given {@link TypeInformation}.
 114  		 *
 115  		 * @param typeInfo type information used to create schema.
 116  		 */
 117  		public Builder(TypeInformation&lt;CRow&gt; typeInfo) {
 118  			Preconditions.checkNotNull(typeInfo, &quot;Type information must not be null.&quot;);
 119  
 120  			if (!(typeInfo instanceof CRowTypeInfo)) {
 121  				throw new IllegalArgumentException(&quot;Row type information expected.&quot;);
 122  			}
 123  			RowTypeInfo rowTypeInfo = ((CRowTypeInfo) typeInfo).rowType();
 124  			this.typeInfo = rowTypeInfo;
 125  			this.csvSchema = CsvRowSchemaConverter.convert(rowTypeInfo);
 126  		}
 127  
 128  		public Builder setFieldDelimiter(char c) {
 129  			this.csvSchema = this.csvSchema.rebuild().setColumnSeparator(c).build();
 130  			return this;
 131  		}
 132  
 133  		public Builder setLineDelimiter(String delimiter) {
 134  			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -			if (!delimiter.equals(&quot;\n&quot;) &amp;&amp; !delimiter.equals(&quot;\r&quot;) &amp;&amp; !delimiter.equals(&quot;\r\n&quot;)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +			if (!(&quot;\n&quot;.equals(delimiter)) &amp;&amp; !(&quot;\r&quot;.equals(delimiter)) &amp;&amp; !(&quot;\r\n&quot;.equals(delimiter))) {</span>
 137  				throw new IllegalArgumentException(
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -					&quot;Unsupported new line delimiter. Only \\n, \\r, or \\r\\n are supported.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +						&quot;Unsupported new line delimiter. Only \\n, \\r, or \\r\\n are supported.&quot;);</span>
 140  			}
 141  			this.csvSchema = this.csvSchema.rebuild().setLineSeparator(delimiter).build();
 142  			return this;
 143  		}
 144  
 145  		public Builder setArrayElementDelimiter(String delimiter) {
 146  			Preconditions.checkNotNull(delimiter, &quot;Delimiter must not be null.&quot;);
 147  			this.csvSchema = this.csvSchema.rebuild().setArrayElementSeparator(delimiter).build();
 148  			return this;
 149  		}
 150  
 151  		public Builder setQuoteCharacter(char c) {
 152  			this.csvSchema = this.csvSchema.rebuild().setQuoteChar(c).build();
 153  			return this;
 154  		}
 155  
 156  		public Builder setEscapeCharacter(char c) {
 157  			this.csvSchema = this.csvSchema.rebuild().setEscapeChar(c).build();
 158  			return this;
 159  		}
 160  
 161  		public Builder setNullLiteral(String s) {
 162  			this.csvSchema = this.csvSchema.rebuild().setNullValue(s).build();
 163  			return this;
 164  		}
 165  
 166  		public Builder setUpdateMode(String updateMode) {
 167  			this.updateMode = updateMode;
 168  			return this;
 169  		}
 170  
 171  		public CsvCRowSerializationSchema build() {
 172  			return new CsvCRowSerializationSchema(
 173  					typeInfo,
 174  					csvSchema,
 175  					updateMode);
 176  		}
 177  	}
 178  
 179  	@Override
 180  	public byte[] serialize(CRow crow) {
 181  		Row row = crow.row();
 182  		boolean change = crow.change();
 183  		if (root == null) {
 184  			root = csvMapper.createObjectNode();
 185  		}
 186  		try {
 187  			runtimeConverter.convert(csvMapper, root, row);
 188  			if (StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {
 189  				fillRetractField(row, change);
 190  			}
 191  
 192  			return objectWriter.writeValueAsBytes(root);
 193  		} catch (Throwable t) {
 194  			throw new RuntimeException(&quot;Could not serialize row &#x27;&quot; + row + &quot;&#x27;.&quot;, t);
 195  		}
 196  	}
 197  
 198  	protected void fillRetractField(Row row, boolean change) {
 199  		root.put(retractKey, change);
 200  		CsvSchema.Builder newBuilder = new CsvSchema.Builder(csvSchema);
 201  
 202  		CsvSchema.Column retractColumn = new CsvSchema.Column(row.getArity(), retractKey, CsvSchema.ColumnType.BOOLEAN);
 203  		newBuilder.addColumn(retractColumn);
 204  		csvSchema = newBuilder.build();
 205  
 206  		this.objectWriter = csvMapper.writer(csvSchema);
 207  
 208  	}
 209  
 210  	@Override
 211  	public boolean equals(Object o) {
 212  		if (o == null || o.getClass() != this.getClass()) {
 213  			return false;
 214  		}
 215  		if (this == o) {
 216  			return true;
 217  		}
 218  		final CsvCRowSerializationSchema that = (CsvCRowSerializationSchema) o;
 219  		final CsvSchema otherSchema = that.csvSchema;
 220  
 221  		return typeInfo.equals(that.typeInfo) &amp;&amp;
 222  			csvSchema.getColumnSeparator() == otherSchema.getColumnSeparator() &amp;&amp;
 223  			Arrays.equals(csvSchema.getLineSeparator(), otherSchema.getLineSeparator()) &amp;&amp;
 224  			csvSchema.getArrayElementSeparator().equals(otherSchema.getArrayElementSeparator()) &amp;&amp;
 225  			csvSchema.getQuoteChar() == otherSchema.getQuoteChar() &amp;&amp;
 226  			csvSchema.getEscapeChar() == otherSchema.getEscapeChar() &amp;&amp;
 227  			Arrays.equals(csvSchema.getNullValue(), otherSchema.getNullValue());
 228  	}
 229  
 230  	@Override
 231  	public int hashCode() {
 232  		return Objects.hash(
 233  			typeInfo,
 234  			csvSchema.getColumnSeparator(),
 235  			csvSchema.getLineSeparator(),
 236  			csvSchema.getArrayElementSeparator(),
 237  			csvSchema.getQuoteChar(),
 238  			csvSchema.getEscapeChar(),
 239  			csvSchema.getNullValue());
 240  	}
 241  
 242  	// --------------------------------------------------------------------------------------------
 243  
 244  	private interface RuntimeConverter extends Serializable {
 245  		JsonNode convert(CsvMapper csvMapper, ContainerNode&lt;?&gt; container, Object obj);
 246  	}
 247  
 248  	private static RuntimeConverter createRowRuntimeConverter(RowTypeInfo rowTypeInfo, boolean isTopLevel) {
 249  		final TypeInformation[] fieldTypes = rowTypeInfo.getFieldTypes();
 250  		final String[] fieldNames = rowTypeInfo.getFieldNames();
 251  
 252  		final RuntimeConverter[] fieldConverters = createFieldRuntimeConverters(fieldTypes);
 253  
 254  		return assembleRowRuntimeConverter(isTopLevel, fieldNames, fieldConverters);
 255  	}
 256  
 257  	private static RuntimeConverter[] createFieldRuntimeConverters(TypeInformation&lt;?&gt;[] fieldTypes) {
 258  		final RuntimeConverter[] fieldConverters = new RuntimeConverter[fieldTypes.length];
 259  		for (int i = 0; i &lt; fieldTypes.length; i++) {
 260  			fieldConverters[i] = createNullableRuntimeConverter(fieldTypes[i]);
 261  		}
 262  		return fieldConverters;
 263  	}
 264  
 265  	private static RuntimeConverter assembleRowRuntimeConverter(
 266  			boolean isTopLevel,
 267  			String[] fieldNames,
 268  			RuntimeConverter[] fieldConverters) {
 269  		final int rowArity = fieldNames.length;
 270  		// top level reuses the object node container
 271  		if (isTopLevel) {
 272  			return (csvMapper, container, obj) -&gt; {
 273  				final Row row = (Row) obj;
 274  
 275  				validateArity(rowArity, row.getArity());
 276  
 277  				final ObjectNode objectNode = (ObjectNode) container;
 278  				for (int i = 0; i &lt; rowArity; i++) {
 279  					objectNode.set(
 280  						fieldNames[i],
 281  						fieldConverters[i].convert(csvMapper, container, row.getField(i)));
 282  				}
 283  				return objectNode;
 284  			};
 285  		} else {
 286  			return (csvMapper, container, obj) -&gt; {
 287  				final Row row = (Row) obj;
 288  
 289  				validateArity(rowArity, row.getArity());
 290  
 291  				final ArrayNode arrayNode = csvMapper.createArrayNode();
 292  				for (int i = 0; i &lt; rowArity; i++) {
 293  					arrayNode.add(fieldConverters[i].convert(csvMapper, arrayNode, row.getField(i)));
 294  				}
 295  				return arrayNode;
 296  			};
 297  		}
 298  	}
 299  
 300  	private static RuntimeConverter createNullableRuntimeConverter(TypeInformation&lt;?&gt; info) {
 301  		final RuntimeConverter valueConverter = createRuntimeConverter(info);
 302  		return (csvMapper, container, obj) -&gt; {
 303  			if (obj == null) {
 304  				return container.nullNode();
 305  			}
 306  			return valueConverter.convert(csvMapper, container, obj);
 307  		};
 308  	}
 309  
 310  	private static RuntimeConverter createRuntimeConverter(TypeInformation&lt;?&gt; info) {
 311  		if (info.equals(Types.VOID)) {
 312  			return (csvMapper, container, obj) -&gt; container.nullNode();
 313  		} else if (info.equals(Types.STRING)) {
 314  			return (csvMapper, container, obj) -&gt; container.textNode((String) obj);
 315  		} else if (info.equals(Types.BOOLEAN)) {
 316  			return (csvMapper, container, obj) -&gt; container.booleanNode((Boolean) obj);
 317  		} else if (info.equals(Types.BYTE)) {
 318  			return (csvMapper, container, obj) -&gt; container.numberNode((Byte) obj);
 319  		} else if (info.equals(Types.SHORT)) {
 320  			return (csvMapper, container, obj) -&gt; container.numberNode((Short) obj);
 321  		} else if (info.equals(Types.INT)) {
 322  			return (csvMapper, container, obj) -&gt; container.numberNode((Integer) obj);
 323  		} else if (info.equals(Types.LONG)) {
 324  			return (csvMapper, container, obj) -&gt; container.numberNode((Long) obj);
 325  		} else if (info.equals(Types.FLOAT)) {
 326  			return (csvMapper, container, obj) -&gt; container.numberNode((Float) obj);
 327  		} else if (info.equals(Types.DOUBLE)) {
 328  			return (csvMapper, container, obj) -&gt; container.numberNode((Double) obj);
 329  		} else if (info.equals(Types.BIG_DEC)) {
 330  			return (csvMapper, container, obj) -&gt; container.numberNode((BigDecimal) obj);
 331  		} else if (info.equals(Types.BIG_INT)) {
 332  			return (csvMapper, container, obj) -&gt; container.numberNode((BigInteger) obj);
 333  		} else if (info.equals(Types.SQL_DATE)) {
 334  			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());
 335  		} else if (info.equals(Types.SQL_TIME)) {
 336  			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());
 337  		} else if (info.equals(Types.SQL_TIMESTAMP)) {
 338  			return (csvMapper, container, obj) -&gt; container.textNode(obj.toString());
 339  		} else if (info instanceof RowTypeInfo){
 340  			return createRowRuntimeConverter((RowTypeInfo) info, false);
 341  		} else if (info instanceof BasicArrayTypeInfo) {
 342  			return createObjectArrayRuntimeConverter(((BasicArrayTypeInfo) info).getComponentInfo());
 343  		} else if (info instanceof ObjectArrayTypeInfo) {
 344  			return createObjectArrayRuntimeConverter(((ObjectArrayTypeInfo) info).getComponentInfo());
 345  		} else if (info instanceof PrimitiveArrayTypeInfo &amp;&amp;
 346  				((PrimitiveArrayTypeInfo) info).getComponentType() == Types.BYTE) {
 347  			return createByteArrayRuntimeConverter();
 348  		}
 349  		else {
 350  			throw new RuntimeException(&quot;Unsupported type information &#x27;&quot; + info + &quot;&#x27;.&quot;);
 351  		}
 352  	}
 353  
 354  	private static RuntimeConverter createObjectArrayRuntimeConverter(TypeInformation&lt;?&gt; elementType) {
 355  		final RuntimeConverter elementConverter = createNullableRuntimeConverter(elementType);
 356  		return (csvMapper, container, obj) -&gt; {
 357  			final Object[] array = (Object[]) obj;
 358  			final ArrayNode arrayNode = csvMapper.createArrayNode();
 359  			for (Object element : array) {
 360  				arrayNode.add(elementConverter.convert(csvMapper, arrayNode, element));
 361  			}
 362  			return arrayNode;
 363  		};
 364  	}
 365  
 366  	private static RuntimeConverter createByteArrayRuntimeConverter() {
 367  		return (csvMapper, container, obj) -&gt; container.binaryNode((byte[]) obj);
 368  	}
 369  
 370  	private static void validateArity(int expected, int actual) {
 371  		if (expected != actual) {
 372  			throw new RuntimeException(&quot;Row length mismatch. &quot; + expected +
 373  				&quot; fields expected but was &quot; + actual + &quot;.&quot;);
 374  		}
 375  	}
 376  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            