<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>310</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    310
                    <a href="309.html">prev</a>
                    <a href="311.html">next</a>
                    <a href="310_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_cd7cff12a798c3a68943ad44552e25fb0f98f8d1_admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/server/service/AdminEntityServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/server/service/AdminEntityServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1^1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/server/service/AdminEntityServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1^2:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/server/service/AdminEntityServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;556ac57d12139326e76b29db4638956d93283fb1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/server/service/AdminEntityServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.server.service;
  19 
  20 import org.apache.commons.lang3.ArrayUtils;
  21 import org.apache.commons.lang3.StringUtils;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  25 import org.broadleafcommerce.common.exception.ServiceException;
  26 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  27 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  28 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  29 import org.broadleafcommerce.common.util.BLCMessageUtils;
  30 import org.broadleafcommerce.common.util.BLCSystemProperty;
  31 import org.broadleafcommerce.common.util.dao.DynamicDaoHelper;
  32 import org.broadleafcommerce.common.util.dao.DynamicDaoHelperImpl;
  33 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  34 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  35 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  36 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  37 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  38 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  39 import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  40 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  41 import org.broadleafcommerce.openadmin.dto.Entity;
  42 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  43 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  44 import org.broadleafcommerce.openadmin.dto.GroupMetadata;
  45 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  46 import org.broadleafcommerce.openadmin.dto.MapStructure;
  47 import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  48 import org.broadleafcommerce.openadmin.dto.Property;
  49 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  50 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  51 import org.broadleafcommerce.openadmin.exception.EntityNotFoundException;
  52 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  53 import org.broadleafcommerce.openadmin.server.domain.FetchPageRequest;
  54 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  55 import org.broadleafcommerce.openadmin.server.factory.PersistencePackageFactory;
  56 import org.broadleafcommerce.openadmin.server.service.extension.CriteriaTransferObjectExtensionManager;
  57 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  58 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
  59 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  60 import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  61 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  62 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  63 import org.broadleafcommerce.openadmin.web.form.entity.Tab;
  64 import org.hibernate.exception.ConstraintViolationException;
  65 import org.springframework.stereotype.Service;
  66 
  67 import java.util.ArrayList;
  68 import java.util.Arrays;
  69 import java.util.HashMap;
  70 import java.util.List;
  71 import java.util.ListIterator;
  72 import java.util.Map;
  73 import java.util.Map.Entry;
  74 
  75 import javax.annotation.Resource;
  76 import javax.persistence.EntityManager;
  77 import javax.persistence.PersistenceContext;
  78 
  79 /**
  80  * @author Andre Azzolini (apazzolini)
  81  */
  82 @Service(&quot;blAdminEntityService&quot;)
  83 public class AdminEntityServiceImpl implements AdminEntityService {
  84 
  85     protected static final Log LOG = LogFactory.getLog(AdminEntityServiceImpl.class);
  86 
  87     @Resource(name = &quot;blDynamicEntityRemoteService&quot;)
  88     protected DynamicEntityService service;
  89 
  90     @Resource(name = &quot;blPersistencePackageFactory&quot;)
  91     protected PersistencePackageFactory persistencePackageFactory;
  92 
  93     @PersistenceContext(unitName = &quot;blPU&quot;)
  94     protected EntityManager em;
  95 
  96     @Resource(name = &quot;blEntityConfiguration&quot;)
  97     protected EntityConfiguration entityConfiguration;
  98 
  99     @Resource
 100     protected CriteriaTransferObjectExtensionManager extensionManager;
 101 
 102     protected DynamicDaoHelper dynamicDaoHelper = new DynamicDaoHelperImpl();
 103 
 104     @Override
 105     public PersistenceResponse getClassMetadata(PersistencePackageRequest request)
 106             throws ServiceException {
 107         PersistenceResponse response = inspect(request);
 108         ClassMetadata cmd = response.getDynamicResultSet().getClassMetaData();
 109         cmd.setCeilingType(request.getCeilingEntityClassname());
 110         cmd.setSecurityCeilingType(request.getSecurityCeilingEntityClassname());
 111         return response;
 112     }
 113 
 114     @Override
 115     public PersistenceResponse getRecords(PersistencePackageRequest request) throws ServiceException {
 116         return fetch(request);
 117     }
 118 
 119     @Override
<abbr title=" 120     public PersistenceResponse getRecord(PersistencePackageRequest request, String id, ClassMetadata cmd, boolean isCollectionRequest)"> 120     public PersistenceResponse getRecord(PersistencePackageRequest request, String id, ClassMetadata cmd,ðŸ”µ</abbr>
 121             throws ServiceException {
 122         String idProperty = getIdProperty(cmd);
 123 
 124         FilterAndSortCriteria fasc = new FilterAndSortCriteria(idProperty);
 125         fasc.setFilterValue(id);
 126         request.addFilterAndSortCriteria(fasc);
 127 
 128         PersistenceResponse response = fetch(request);
 129         Entity[] entities = response.getDynamicResultSet().getRecords();
 130         if (ArrayUtils.isEmpty(entities)) {
 131             String celiningEntity = request.getCeilingEntityClassname();
<abbr title=" 132             throw new EntityNotFoundException(String.format(&quot;Could not find Entity %s with ID %s&quot;, celiningEntity, id));"> 132             throw new EntityNotFoundException(String.format(&quot;Could not find Entity %s with ID %s&quot;, celiniðŸ”µ</abbr>
 133         }
 134 
 135         return response;
 136     }
 137 
 138     @Override
<abbr title=" 139     public PersistenceResponse addEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 139     public PersistenceResponse addEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumðŸ”µ</abbr>
<abbr title=" 140         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);"> 140         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb)ðŸ”µ</abbr>
 141         // If the entity form has dynamic forms inside of it, we need to persist those as well.
 142         // They are typically done in their own custom persistence handlers, which will get triggered
 143         // based on the criteria specific in the PersistencePackage.
 144         for (Entry&lt;String, EntityForm&gt; entry : entityForm.getDynamicForms().entrySet()) {
 145             DynamicEntityFormInfo info = entityForm.getDynamicFormInfo(entry.getKey());
 146 
 147             if (info.getCustomCriteriaOverride() != null) {
 148                 customCriteria = info.getCustomCriteriaOverride();
 149             } else {
 150                 String propertyName = info.getPropertyName();
 151                 String propertyValue;
 152                 if (entityForm.getFields().containsKey(propertyName)) {
 153                     propertyValue = entityForm.findField(propertyName).getValue();
 154                 } else {
 155                     propertyValue = info.getPropertyValue();
 156                 }
<abbr title=" 157                 customCriteria = new String[] {info.getCriteriaName(), entityForm.getId(), propertyName, propertyValue};"> 157                 customCriteria = new String[] {info.getCriteriaName(), entityForm.getId(), propertyName, ðŸ”µ</abbr>
 158             }
 159 
<abbr title=" 160             PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectionCrumb);"> 160             PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriterðŸ”µ</abbr>
 161             ppr.addSubRequest(info.getPropertyName(), subRequest);
 162         }
 163         return add(ppr);
 164     }
 165 
 166     @Override
<abbr title=" 167     public PersistenceResponse updateEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 167     public PersistenceResponse updateEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCðŸ”µ</abbr>
<abbr title=" 168         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);"> 168         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb)ðŸ”µ</abbr>
 169         ppr.setRequestingEntityName(entityForm.getMainEntityName());
 170         // If the entity form has dynamic forms inside of it, we need to persist those as well.
 171         // They are typically done in their own custom persistence handlers, which will get triggered
 172         // based on the criteria specific in the PersistencePackage.
 173         for (Entry&lt;String, EntityForm&gt; entry : entityForm.getDynamicForms().entrySet()) {
 174             DynamicEntityFormInfo info = entityForm.getDynamicFormInfo(entry.getKey());
 175 
 176             if (info.getCustomCriteriaOverride() != null) {
 177                 customCriteria = info.getCustomCriteriaOverride();
 178             } else {
 179                 String propertyName = info.getPropertyName();
 180                 String propertyValue = entityForm.findField(propertyName).getValue();
<abbr title=" 181                 customCriteria = new String[] { info.getCriteriaName(), entityForm.getId(), propertyName, propertyValue };"> 181                 customCriteria = new String[] { info.getCriteriaName(), entityForm.getId(), propertyName,ðŸ”µ</abbr>
 182             }
 183 
<abbr title=" 184             PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectionCrumb);"> 184             PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriterðŸ”µ</abbr>
 185             subRequest.withSecurityCeilingEntityClassname(info.getSecurityCeilingClassName());
 186             ppr.addSubRequest(info.getPropertyName(), subRequest);
 187         }
 188         return update(ppr);
 189     }
 190 
 191     @Override
<abbr title=" 192     public PersistenceResponse removeEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb)"> 192     public PersistenceResponse removeEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCðŸ”µ</abbr>
 193             throws ServiceException {
<abbr title=" 194         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);"> 194         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb)ðŸ”µ</abbr>
 195         return remove(ppr);
 196     }
 197 
 198     protected List&lt;Property&gt; getPropertiesFromEntityForm(EntityForm entityForm) {
 199         List&lt;Property&gt; properties = new ArrayList&lt;Property&gt;(entityForm.getFields().size());
 200 
 201         for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
 202             Property p = new Property();
 203             p.setName(entry.getKey());
 204             p.setValue(entry.getValue().getValue());
 205             p.setDisplayValue(entry.getValue().getDisplayValue());
 206             p.setIsDirty(entry.getValue().getIsDirty());
 207             properties.add(p);
 208         }
 209 
 210         return properties;
 211     }
 212 
 213     @Override
<abbr title=" 214     public PersistencePackageRequest getRequestForEntityForm(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumbs) {"> 214     public PersistencePackageRequest getRequestForEntityForm(EntityForm entityForm, String[] customCriterðŸ”µ</abbr>
 215         // Ensure the ID property is on the form
 216         Field idField = entityForm.findField(entityForm.getIdProperty());
 217         if (idField == null) {
 218             idField = new Field();
 219             idField.setName(entityForm.getIdProperty());
 220             idField.setValue(entityForm.getId());
 221             entityForm.getFields().put(entityForm.getIdProperty(), idField);
 222         } else {
 223             idField.setValue(entityForm.getId());
 224         }
 225 
 226         List&lt;Property&gt; propList = getPropertiesFromEntityForm(entityForm);
 227         Property[] properties = new Property[propList.size()];
 228         properties = propList.toArray(properties);
 229 
 230         Entity entity = new Entity();
 231         entity.setProperties(properties);
 232         String entityType = entityForm.getEntityType();
 233         if (StringUtils.isEmpty(entityType)) {
 234             entityType = entityForm.getCeilingEntityClassname();
 235         }
 236         entity.setType(new String[]{entityType});
 237 
 238         PersistencePackageRequest ppr = PersistencePackageRequest.standard()
 239                 .withEntity(entity)
 240                 .withCustomCriteria(customCriteria)
 241                 .withCeilingEntityClassname(entityForm.getCeilingEntityClassname())
 242                 .withSectionCrumbs(sectionCrumbs)
 243                 .withRequestingEntityName(entityForm.getMainEntityName());
 244         return ppr;
 245     }
 246 
 247     @Override
<abbr title=" 248     public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containingEntity,"> 248     public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity ðŸ”µ</abbr>
<abbr title=" 249             Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternateId)"> 249             Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, StrinðŸ”µ</abbr>
 250             throws ServiceException {
<abbr title=" 251         return getAdvancedCollectionRecord(containingClassMetadata, containingEntity, collectionProperty, collectionItemId, sectionCrumbs, alternateId, null);"> 251         return getAdvancedCollectionRecord(containingClassMetadata, containingEntity, collectionProperty,ðŸ”µ</abbr>
 252     }
 253 
 254     @Override
<abbr title=" 255     public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containingEntity,"> 255     public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity ðŸ”µ</abbr>
<abbr title=" 256             Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternateId,"> 256             Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, StrinðŸ”µ</abbr>
 257             String[] customCriteria) throws ServiceException {
<abbr title=" 258         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sectionCrumbs);"> 258         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetaðŸ”µ</abbr>
 259 
 260         ppr.addCustomCriteria(customCriteria);
 261 
 262         FieldMetadata md = collectionProperty.getMetadata();
<abbr title=" 263         String containingEntityId = getContextSpecificRelationshipId(containingClassMetadata, containingEntity,"> 263         String containingEntityId = getContextSpecificRelationshipId(containingClassMetadata, containingEðŸ”µ</abbr>
 264                 collectionProperty.getName());
 265         ppr.setSectionEntityField(collectionProperty.getName());
 266 
 267         PersistenceResponse response;
 268 
 269         if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title=" 270             FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName());"> 270             FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFielðŸ”µ</abbr>
 271             fasc.setFilterValue(containingEntityId);
 272             ppr.addFilterAndSortCriteria(fasc);
 273 
 274             fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName() + &quot;Target&quot;);
 275             fasc.setFilterValue(collectionItemId);
 276             ppr.addFilterAndSortCriteria(fasc);
 277 
 278             if (!StringUtils.isEmpty(alternateId)) {
 279                 fasc = new FilterAndSortCriteria(ppr.getAdornedList().getIdProperty());
 280                 fasc.setFilterValue(alternateId);
 281                 ppr.addFilterAndSortCriteria(fasc);
 282             }
 283 
 284             response = fetch(ppr);
 285             Entity[] entities = response.getDynamicResultSet().getRecords();
 286             if (ArrayUtils.isEmpty(entities)) {
 287                 String altId = (!StringUtils.isEmpty(alternateId)) ? alternateId : &quot;&quot;;
<abbr title=" 288                 throw new EntityNotFoundException(String.format(&quot;Could not find Entity for [%s], field [%s], id [%s], targetId [%s], alternateId [%s] &quot;, "> 288                 throw new EntityNotFoundException(String.format(&quot;Could not find Entity for [%s], field [%ðŸ”µ</abbr>
<abbr title=" 289                         ppr.getCeilingEntityClassname(), ppr.getAdornedList().getCollectionFieldName(), containingEntityId, collectionItemId, altId));"> 289                         ppr.getCeilingEntityClassname(), ppr.getAdornedList().getCollectionFieldName(), cðŸ”µ</abbr>
 290             }
 291         } else if (md instanceof MapMetadata) {
 292             MapMetadata mmd = (MapMetadata) md;
 293             FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 294             fasc.setFilterValue(containingEntityId);
 295             ppr.addFilterAndSortCriteria(fasc);
 296 
 297             response = fetch(ppr);
 298             Entity[] entities = response.getDynamicResultSet().getRecords();
 299             for (Entity e : entities) {
 300                 String idProperty = getIdProperty(containingClassMetadata);
 301                 if (mmd.isSimpleValue()) {
 302                     idProperty = &quot;key&quot;;
 303                 }
 304                 Property p = e.getPMap().get(idProperty);
 305                 if (p.getValue().equals(collectionItemId)) {
 306                     response.setEntity(e);
 307                     break;
 308                 }
 309             }
 310         } else {
<abbr title=" 311             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not an &quot; +"> 311             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] wasðŸ”µ</abbr>
<abbr title=" 312                     &quot;advanced collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingType()));"> 312                     &quot;advanced collection field.&quot;, collectionProperty.getName(), containingClassMetadata.gðŸ”µ</abbr>
 313         }
 314 
 315         return response;
 316     }
 317 
 318     @Override
<abbr title=" 319     public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 319     public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity contðŸ”µ</abbr>
<abbr title=" 320             Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxIndex, List&lt;SectionCrumb&gt; sectionCrumb)"> 320             Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxInðŸ”µ</abbr>
 321             throws ServiceException {
<abbr title=" 322         return getRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fascs, startIndex,"> 322         return getRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fasðŸ”µ</abbr>
 323                 maxIndex, null, sectionCrumb);
 324     }
 325 
 326     @Override
<abbr title=" 327     public PersistenceResponse getPagedRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 327     public PersistenceResponse getPagedRecordsForCollection(ClassMetadata containingClassMetadata, EntityðŸ”µ</abbr>
<abbr title=" 328             Property collectionProperty, FilterAndSortCriteria[] fascs, FetchPageRequest fetchPageRequest,"> 328             Property collectionProperty, FilterAndSortCriteria[] fascs, FetchPageRequest fetchPageRequestðŸ”µ</abbr>
 329             String idValueOverride, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
<abbr title=" 330         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sectionCrumbs)"> 330         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetaðŸ”µ</abbr>
 331             .withFilterAndSortCriteria(fascs)
 332             .withStartIndex(fetchPageRequest.getStartIndex())
 333             .withMaxIndex(fetchPageRequest.getMaxIndex())
 334             .withFirstId(fetchPageRequest.getFirstId())
 335             .withLastId(fetchPageRequest.getLastId())
 336             .withLowerCount(fetchPageRequest.getLowerCount())
 337             .withUpperCount(fetchPageRequest.getUpperCount())
 338             .withPageSize(fetchPageRequest.getPageSize())
 339             .withPresentationFetch(true);
 340 
 341         FilterAndSortCriteria fasc;
 342 
 343         FieldMetadata md = collectionProperty.getMetadata();
 344         String collectionCeilingClass = null;
 345 
 346         if (md instanceof BasicCollectionMetadata) {
 347             fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 348             collectionCeilingClass = ((CollectionMetadata) md).getCollectionCeilingEntity();
 349         } else if (md instanceof AdornedTargetCollectionMetadata) {
 350             fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName());
 351             collectionCeilingClass = ((CollectionMetadata) md).getCollectionCeilingEntity();
 352         } else if (md instanceof MapMetadata) {
 353             fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 354         } else {
<abbr title=" 355             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not a &quot; +"> 355             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] wasðŸ”µ</abbr>
<abbr title=" 356                     &quot;collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingType()));"> 356                     &quot;collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingðŸ”µ</abbr>
 357         }
 358 
 359         String id;
 360         if (idValueOverride == null) {
<abbr title=" 361             id = getContextSpecificRelationshipId(containingClassMetadata, containingEntity, collectionProperty.getName());"> 361             id = getContextSpecificRelationshipId(containingClassMetadata, containingEntity, collectionPrðŸ”µ</abbr>
 362         } else {
 363             id = idValueOverride;
 364         }
 365         fasc.setFilterValue(id);
 366         ppr.addFilterAndSortCriteria(fasc);
 367 
 368         if (collectionCeilingClass != null) {
 369             ppr.setCeilingEntityClassname(collectionCeilingClass);
 370         }
 371         ppr.setSectionEntityField(collectionProperty.getName());
 372 
 373         return fetch(ppr);
 374     }
 375 
 376     @Override
<abbr title=" 377     public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 377     public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity contðŸ”µ</abbr>
<abbr title=" 378             Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxIndex,"> 378             Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxInðŸ”µ</abbr>
 379             String idValueOverride, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
<abbr title=" 380         FetchPageRequest pageRequest = new FetchPageRequest().withStartIndex(startIndex).withMaxIndex(maxIndex);"> 380         FetchPageRequest pageRequest = new FetchPageRequest().withStartIndex(startIndex).withMaxIndex(maxðŸ”µ</abbr>
<abbr title=" 381         return getPagedRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fascs,"> 381         return getPagedRecordsForCollection(containingClassMetadata, containingEntity, collectionPropertyðŸ”µ</abbr>
 382                 pageRequest, idValueOverride, sectionCrumbs);
 383     }
 384 
 385     @Override
<abbr title=" 386     public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity containingEntity, Integer startIndex, Integer maxIndex, List&lt;SectionCrumb&gt; sectionCrumb)"> 386     public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, EnðŸ”µ</abbr>
 387             throws ServiceException {
 388         Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;String, DynamicResultSet&gt;();
 389 
 390         PersistenceResponse response = getClassMetadata(ppr);
 391         ClassMetadata cmd = response.getDynamicResultSet().getClassMetaData();
 392         for (Property p : cmd.getProperties()) {
 393             if (ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), containingEntity.getType()[0])
 394                     &amp;&amp; p.getMetadata() instanceof CollectionMetadata) {
<abbr title=" 395                 PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, startIndex, maxIndex, sectionCrumb);"> 395                 PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, sðŸ”µ</abbr>
 396                 map.put(p.getName(), response2.getDynamicResultSet());
 397             }
 398         }
 399 
 400         return map;
 401     }
 402 
 403     @Override
<abbr title=" 404     public Map&lt;String, DynamicResultSet&gt; getAllRecordsForAllSubCollections(ClassMetadata cmd, Entity containingEntity,"> 404     public Map&lt;String, DynamicResultSet&gt; getAllRecordsForAllSubCollections(ClassMetadata cmd, Entity contðŸ”µ</abbr>
<abbr title=" 405                                                                            List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 405                                                                            List&lt;SectionCrumb&gt; sectionCrumðŸ”µ</abbr>
 406         Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;&gt;();
 407         for (Property p : cmd.getProperties()) {
 408             FieldMetadata fieldMetadata = p.getMetadata();
<abbr title=" 409             boolean fieldAvailable = ArrayUtils.contains(fieldMetadata.getAvailableToTypes(), containingEntity.getType()[0]);"> 409             boolean fieldAvailable = ArrayUtils.contains(fieldMetadata.getAvailableToTypes(), containingEðŸ”µ</abbr>
 410             if (fieldAvailable &amp;&amp; fieldMetadata instanceof CollectionMetadata) {
 411                 FetchPageRequest pageRequest = new FetchPageRequest()
 412                         .withPageSize(Integer.MAX_VALUE);
<abbr title=" 413                 PersistenceResponse resp = getPagedRecordsForCollection(cmd, containingEntity, p, null, pageRequest, null, sectionCrumb);"> 413                 PersistenceResponse resp = getPagedRecordsForCollection(cmd, containingEntity, p, null, pðŸ”µ</abbr>
 414                 map.put(p.getName(), resp.getDynamicResultSet());
 415             }
 416         }
 417         return map;
 418     }
 419 
 420     @Override
<abbr title=" 421     public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity containingEntity, List&lt;SectionCrumb&gt; sectionCrumb)"> 421     public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, EnðŸ”µ</abbr>
 422             throws ServiceException {
 423 
 424         return getRecordsForAllSubCollections(ppr, containingEntity, null, null, sectionCrumb);
 425     }
 426 
 427     @Override
<abbr title=" 428     public Map&lt;String, DynamicResultSet&gt; getRecordsForSelectedTab(ClassMetadata cmd, Entity containingEntity, List&lt;SectionCrumb&gt; sectionCrumb,"> 428     public Map&lt;String, DynamicResultSet&gt; getRecordsForSelectedTab(ClassMetadata cmd, Entity containingEntðŸ”µ</abbr>
 429             String currentTabName) throws ServiceException {
 430         Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;String, DynamicResultSet&gt;();
 431         for (Property p : cmd.getProperties()) {
 432             if (ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), containingEntity.getType()[0])
 433                     &amp;&amp; p.getMetadata() instanceof CollectionMetadata) {
 434 
 435                 CollectionMetadata collectionMetadata = (CollectionMetadata) p.getMetadata();
 436 
<abbr title=" 437                 // Give preference to the Group since EntityForm.addListGrid() gives preference to the Group"> 437                 // Give preference to the Group since EntityForm.addListGrid() gives preference to the GrðŸ”µ</abbr>
 438                 TabMetadata tabMetadata = cmd.getTabMetadataUsingGroupKey(collectionMetadata.getGroup());
 439                 if (tabMetadata == null) {
 440                     tabMetadata = cmd.getTabMetadataUsingTabKey(collectionMetadata.getTab());
 441                 }
 442 
<abbr title=" 443                 String tabName = tabMetadata == null ? collectionMetadata.getTab() : tabMetadata.getTabName();"> 443                 String tabName = tabMetadata == null ? collectionMetadata.getTab() : tabMetadata.getTabNaðŸ”µ</abbr>
<abbr title=" 444                 int tabOrder = tabMetadata == null ? collectionMetadata.getTabOrder() : tabMetadata.getTabOrder();"> 444                 int tabOrder = tabMetadata == null ? collectionMetadata.getTabOrder() : tabMetadata.getTaðŸ”µ</abbr>
 445                 updateTabInfo(collectionMetadata, cmd, tabName, tabOrder);
 446 
 447                 if (collectionMetadata.getLazyFetch() != null &amp;&amp; collectionMetadata.getLazyFetch()
 448                         &amp;&amp; tabName.toUpperCase().startsWith(currentTabName.toUpperCase())
 449                         &amp;&amp; !collectionMetadata.getManualFetch()) {
<abbr title=" 450                     PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, null, sectionCrumb);"> 450                     PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, nulðŸ”µ</abbr>
 451                     map.put(p.getName(), response2.getDynamicResultSet());
<abbr title=" 452                 } else if (collectionMetadata.getLazyFetch() != null &amp;&amp; !collectionMetadata.getLazyFetch()"> 452                 } else if (collectionMetadata.getLazyFetch() != null &amp;&amp; !collectionMetadata.getLazyFetch(ðŸ”µ</abbr>
 453                         &amp;&amp; !collectionMetadata.getManualFetch()) {
<abbr title=" 454                     PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, null, sectionCrumb);"> 454                     PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, nulðŸ”µ</abbr>
 455                     map.put(p.getName(), response2.getDynamicResultSet());
 456                 } else {
 457                     DynamicResultSet drs = new DynamicResultSet();
 458                     Map&lt;String, Tab&gt; tabMap = new HashMap&lt;String, Tab&gt;();
 459                     Tab tab = new Tab();
 460                     tab.setKey(tabName);
 461                     tab.setTitle(BLCMessageUtils.getMessage(tabName));
 462                     tab.setOrder(tabOrder);
 463                     tabMap.put(tab.getTitle(), tab);
 464                     drs.setUnselectedTabMetadata(tabMap);
 465                     drs.setTotalRecords(0);
 466                     drs.setStartIndex(0);
 467                     drs.setBatchId(1);
 468                     drs.setClassMetaData(null);
 469                     drs.setPageSize(1);
 470                     drs.setRecords(new Entity[0]);
 471                     map.put(p.getName(), drs);
 472                 }
 473             }
 474         }
 475 
 476         return map;
 477     }
 478 
<abbr title=" 479     protected void updateTabInfo(CollectionMetadata fmd, ClassMetadata cmd, String tabName, int tabOrder) {"> 479     protected void updateTabInfo(CollectionMetadata fmd, ClassMetadata cmd, String tabName, int tabOrder)ðŸ”µ</abbr>
 480         boolean tabInfoFound = false;
 481         Map&lt;String, TabMetadata&gt; tabMetadataMap = cmd.getTabAndGroupMetadata();
 482         for (String tabKey : tabMetadataMap.keySet()) {
 483             Map&lt;String, GroupMetadata&gt; groupMetadataMap = tabMetadataMap.get(tabKey).getGroupMetadata();
 484             for (String groupKey : groupMetadataMap.keySet()) {
<abbr title=" 485                 if (groupKey.equals(fmd.getGroup()) || groupMetadataMap.get(groupKey).getGroupName().equals(fmd.getGroup())) {"> 485                 if (groupKey.equals(fmd.getGroup()) || groupMetadataMap.get(groupKey).getGroupName().equaðŸ”µ</abbr>
 486                     tabName = tabMetadataMap.get(tabKey).getTabName();
 487                     tabOrder = tabMetadataMap.get(tabKey).getTabOrder();
 488                     tabInfoFound = true;
 489                     break;
 490                 }
 491             }
 492             if (tabInfoFound) {
 493                 break;
 494             }
 495             if (tabKey.equals(tabName) || tabMetadataMap.get(tabKey).getTabName().equals(tabName)) {
 496                 tabName = tabMetadataMap.get(tabKey).getTabName();
 497                 tabOrder = tabMetadataMap.get(tabKey).getTabOrder();
 498             }
 499         }
 500     }
 501 
 502     @Override
<abbr title=" 503     public PersistenceResponse addSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property field,"> 503     public PersistenceResponse addSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, ðŸ”µ</abbr>
 504             Entity parentEntity, List&lt;SectionCrumb&gt; sectionCrumbs)
 505             throws ServiceException, ClassNotFoundException {
 506         // Assemble the properties from the entity form
 507         List&lt;Property&gt; properties = getPropertiesFromEntityForm(entityForm);
 508 
 509         FieldMetadata md = field.getMetadata();
 510 
 511         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 512                 .withEntity(new Entity());
 513         ppr.getEntity().setIsPreAdd(parentEntity.isPreAdd());
 514 
 515         if (md instanceof BasicCollectionMetadata) {
 516             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 517             ppr.getEntity().setType(new String[] { entityForm.getEntityType() });
 518 
 519             // If we&#x27;re looking up an entity instead of trying to create one on the fly, let&#x27;s make sure
<abbr title=" 520             // that we&#x27;re not changing the target entity at all and only creating the association to the id"> 520             // that we&#x27;re not changing the target entity at all and only creating the association to the ðŸ”µ</abbr>
 521             if (fmd.getAddMethodType().equals(AddMethodType.LOOKUP) ||
 522                     fmd.getAddMethodType().equals(AddMethodType.LOOKUP_FOR_UPDATE)) {
 523                 List&lt;String&gt; fieldsToRemove = new ArrayList&lt;String&gt;();
 524 
 525                 String idProp = getIdProperty(mainMetadata);
 526                 for (String key : entityForm.getFields().keySet()) {
 527                     if (!idProp.equals(key)) {
 528                         fieldsToRemove.add(key);
 529                     }
 530                 }
 531 
 532                 for (String key : fieldsToRemove) {
 533                     ListIterator&lt;Property&gt; li = properties.listIterator();
 534                     while (li.hasNext()) {
 535                         if (li.next().getName().equals(key)) {
 536                             li.remove();
 537                         }
 538                     }
 539                 }
 540 
 541                 ppr.setValidateUnsubmittedProperties(false);
 542             }
 543 
 544             if (fmd.getAddMethodType().equals(AddMethodType.LOOKUP_FOR_UPDATE)) {
 545                 ppr.setUpdateLookupType(true);
 546             }
 547 
 548             Property fp = new Property();
 549             fp.setName(ppr.getForeignKey().getManyToField());
 550             fp.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 551             properties.add(fp);
 552         } else if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title=" 553             ppr.getEntity().setType(new String[] { ppr.getAdornedList().getAdornedTargetEntityClassname() });"> 553             ppr.getEntity().setType(new String[] { ppr.getAdornedList().getAdornedTargetEntityClassname()ðŸ”µ</abbr>
 554 
<abbr title=" 555             String[] maintainedFields = ((AdornedTargetCollectionMetadata) md).getMaintainedAdornedTargetFields();"> 555             String[] maintainedFields = ((AdornedTargetCollectionMetadata) md).getMaintainedAdornedTargetðŸ”µ</abbr>
 556             if (maintainedFields == null || maintainedFields.length == 0) {
 557                 ppr.setValidateUnsubmittedProperties(false);
 558             }
 559 
 560             // Fix for an adorned target collection where the link is maintained from a
 561             // ToOne property on a main entity
<abbr title=" 562             String linkedProperty = ppr.getAdornedList().getLinkedObjectPath() + &quot;.&quot; + ppr.getAdornedList().getLinkedIdProperty();"> 562             String linkedProperty = ppr.getAdornedList().getLinkedObjectPath() + &quot;.&quot; + ppr.getAdornedListðŸ”µ</abbr>
 563             for (Property p : properties) {
 564                 if (p.getName().equals(linkedProperty)) {
<abbr title=" 565                     p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));"> 565                     p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getNameðŸ”µ</abbr>
 566                 }
 567             }
 568         } else if (md instanceof MapMetadata) {
 569             ppr.getEntity().setType(new String[] { entityForm.getEntityType() });
 570 
 571             Property p = new Property();
 572             p.setName(&quot;symbolicId&quot;);
 573             p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 574             properties.add(p);
 575         } else {
<abbr title=" 576             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was&quot; +"> 576             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] wasðŸ”µ</abbr>
 577                     &quot; not a collection field.&quot;, field.getName(), mainMetadata.getCeilingType()));
 578         }
 579 
 580         ppr.setCeilingEntityClassname(ppr.getEntity().getType()[0]);
 581         String sectionField = field.getName();
 582         if (sectionField.contains(&quot;.&quot;)) {
 583             sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 584         }
 585         ppr.setSectionEntityField(sectionField);
 586 
 587         Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 588         if (parentNameProp != null) {
 589             ppr.setRequestingEntityName(parentNameProp.getValue());
 590         }else {
 591             Property name = parentEntity.getPMap().get(&quot;name&quot;);
 592             if(name !=null) {
 593                 ppr.setRequestingEntityName(name.getValue());
 594             }
 595         }
 596         Property[] propArr = new Property[properties.size()];
 597         properties.toArray(propArr);
 598         ppr.getEntity().setProperties(propArr);
 599 
 600         return add(ppr);
 601     }
 602 
 603     @Override
<abbr title=" 604     public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property"> 604     public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadatðŸ”µ</abbr>
<abbr title=" 605             field, Entity parentEntity, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException, ClassNotFoundException {"> 605             field, Entity parentEntity, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumb) throws ðŸ”µ</abbr>
<abbr title=" 606         return updateSubCollectionEntity(entityForm, mainMetadata, field, parentEntity, collectionItemId, null, sectionCrumb);"> 606         return updateSubCollectionEntity(entityForm, mainMetadata, field, parentEntity, collectionItemId,ðŸ”µ</abbr>
 607     }
 608 
 609     @Override
<abbr title=" 610     public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property field,"> 610     public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadatðŸ”µ</abbr>
<abbr title=" 611             Entity parentEntity, String collectionItemId, String alternateId, List&lt;SectionCrumb&gt; sectionCrumbs)"> 611             Entity parentEntity, String collectionItemId, String alternateId, List&lt;SectionCrumb&gt; sectionCðŸ”µ</abbr>
 612             throws ServiceException, ClassNotFoundException {
 613         List&lt;Property&gt; properties = getPropertiesFromEntityForm(entityForm);
 614 
 615         FieldMetadata md = field.getMetadata();
 616 
 617         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 618                 .withEntity(new Entity());
 619 
 620         if (md instanceof BasicCollectionMetadata) {
 621             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 622             ppr.setCeilingEntityClassname(fmd.getCollectionCeilingEntity());
 623             ppr.getEntity().setType(new String[] { fmd.getCollectionCeilingEntity() });
 624 
 625             Property fp = new Property();
 626             fp.setName(ppr.getForeignKey().getManyToField());
 627             fp.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 628             if (!properties.contains(fp)) {
 629                 properties.add(fp);
 630             }
 631         } else if (md instanceof AdornedTargetCollectionMetadata) {
 632             String adornedTargetEntityClassname = ppr.getAdornedList().getAdornedTargetEntityClassname();
 633             ppr.setCeilingEntityClassname(adornedTargetEntityClassname);
 634             ppr.getEntity().setType(new String[] {adornedTargetEntityClassname});
 635 
 636             for (Property property : properties) {
 637                 if (property.getName().equals(ppr.getAdornedList().getLinkedObjectPath() +
 638                                     &quot;.&quot; + ppr.getAdornedList().getLinkedIdProperty())) {
 639                     break;
 640                 }
 641             }
 642 
 643             if (!StringUtils.isEmpty(alternateId)) {
 644                 Property p = new Property();
 645                 p.setName(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);
 646                 p.setValue(alternateId);
 647                 if (!properties.contains(p)) {
 648                     properties.add(p);
 649                 }
 650             }
 651         } else if (md instanceof MapMetadata) {
 652             ppr.getEntity().setType(new String[] { entityForm.getEntityType() });
 653 
 654             Property p = new Property();
 655             p.setName(&quot;symbolicId&quot;);
 656             p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 657             properties.add(p);
 658         } else {
<abbr title=" 659             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was&quot; +"> 659             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] wasðŸ”µ</abbr>
 660                     &quot; not a collection field.&quot;, field.getName(), mainMetadata.getCeilingType()));
 661         }
 662 
 663         String sectionField = field.getName();
 664         if (sectionField.contains(&quot;.&quot;)) {
 665             sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 666         }
 667         ppr.setSectionEntityField(sectionField);
 668 
 669         Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 670         if (parentNameProp != null) {
 671             ppr.setRequestingEntityName(parentNameProp.getValue());
 672         }
 673 
 674         Property p = new Property();
 675         p.setName(entityForm.getIdProperty());
 676         p.setValue(collectionItemId);
 677         if (!properties.contains(p)) {
 678             properties.add(p);
 679         }
 680 
 681         Property[] propArr = new Property[properties.size()];
 682         properties.toArray(propArr);
 683         ppr.getEntity().setProperties(propArr);
 684 
 685         return update(ppr);
 686     }
 687 
 688     @Override
<abbr title=" 689     public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentEntity,"> 689     public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, EntiðŸ”µ</abbr>
<abbr title=" 690                 String itemId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {"> 690                 String itemId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceExceptionðŸ”µ</abbr>
<abbr title=" 691         return removeSubCollectionEntity(mainMetadata, field, parentEntity, itemId, null, priorKey, sectionCrumbs);"> 691         return removeSubCollectionEntity(mainMetadata, field, parentEntity, itemId, null, priorKey, sectiðŸ”µ</abbr>
 692     }
 693 
 694     @Override
<abbr title=" 695     public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentEntity,"> 695     public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, EntiðŸ”µ</abbr>
<abbr title=" 696             String itemId, String alternateId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {"> 696             String itemId, String alternateId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ðŸ”µ</abbr>
 697         List&lt;Property&gt; properties = new ArrayList&lt;Property&gt;();
 698 
 699         Property p;
 700         String parentId = getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName());
 701 
<abbr title=" 702         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(field.getMetadata(), sectionCrumbs)"> 702         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(field.getMetadata(), sectiðŸ”µ</abbr>
 703                 .withEntity(new Entity());
 704 
 705         if (field.getMetadata() instanceof BasicCollectionMetadata) {
 706             BasicCollectionMetadata fmd = (BasicCollectionMetadata) field.getMetadata();
 707 
 708             p = new Property();
 709             p.setName(&quot;id&quot;);
 710             p.setValue(itemId);
 711             properties.add(p);
 712 
 713             p = new Property();
 714             p.setName(ppr.getForeignKey().getManyToField());
 715             p.setValue(parentId);
 716             properties.add(p);
 717 
 718             ppr.getEntity().setType(new String[]{fmd.getCollectionCeilingEntity()});
 719         } else if (field.getMetadata() instanceof AdornedTargetCollectionMetadata) {
 720             AdornedTargetList adornedList = ppr.getAdornedList();
 721 
 722             p = new Property();
 723             p.setName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());
 724             p.setValue(parentId);
 725             properties.add(p);
 726 
 727             p = new Property();
 728             p.setName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());
 729             p.setValue(itemId);
 730             properties.add(p);
 731 
 732             if (!StringUtils.isEmpty(alternateId)) {
 733                 p = new Property();
 734                 p.setName(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);
 735                 p.setValue(alternateId);
 736                 properties.add(p);
 737             }
 738 
 739             ppr.getEntity().setType(new String[]{adornedList.getAdornedTargetEntityClassname()});
 740         } else if (field.getMetadata() instanceof MapMetadata) {
 741             MapMetadata fmd = (MapMetadata) field.getMetadata();
 742 
 743             p = new Property();
 744             p.setName(&quot;id&quot;);
 745             p.setValue(itemId);
 746             properties.add(p);
 747 
 748             p = new Property();
 749             p.setName(&quot;symbolicId&quot;);
 750             p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 751             properties.add(p);
 752 
 753             p = new Property();
 754             p.setName(&quot;priorKey&quot;);
 755             p.setValue(priorKey);
 756             properties.add(p);
 757 
 758             MapStructure mapStructure = ppr.getMapStructure();
 759 
 760             p = new Property();
 761             p.setName(mapStructure.getKeyPropertyName());
 762             p.setValue(itemId);
 763             properties.add(p);
 764 
 765             ppr.getEntity().setType(new String[] { fmd.getTargetClass() });
 766         }
 767 
 768         ppr.setCeilingEntityClassname(ppr.getEntity().getType()[0]);
 769         String sectionField = field.getName();
 770         if (sectionField.contains(&quot;.&quot;)) {
 771             sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 772         }
 773         ppr.setSectionEntityField(sectionField);
 774 
 775         Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 776         if (parentNameProp != null) {
 777             ppr.setRequestingEntityName(parentNameProp.getValue());
 778         }
 779 
 780         Property[] propArr = new Property[properties.size()];
 781         properties.toArray(propArr);
 782         ppr.getEntity().setProperties(propArr);
 783 
 784         return remove(ppr);
 785     }
 786 
 787     @Override
<abbr title=" 788     public String getContextSpecificRelationshipId(ClassMetadata cmd, Entity entity, String propertyName) {"> 788     public String getContextSpecificRelationshipId(ClassMetadata cmd, Entity entity, String propertyName)ðŸ”µ</abbr>
 789         String prefix;
 790         if (propertyName.contains(&quot;.&quot;)) {
 791             prefix = propertyName.substring(0, propertyName.lastIndexOf(&quot;.&quot;));
 792         } else {
 793             prefix = &quot;&quot;;
 794         }
 795 
 796         if (prefix.equals(&quot;&quot;)) {
 797             return entity.findProperty(&quot;id&quot;).getValue();
 798         } else {
<abbr title=" 799             //we need to check all the parts of the prefix. For example, the prefix could include an @Embedded class like"> 799             //we need to check all the parts of the prefix. For example, the prefix could include an @EmbðŸ”µ</abbr>
<abbr title=" 800             //defaultSku.dimension. In this case, we want the id from the defaultSku property, since the @Embedded does"> 800             //defaultSku.dimension. In this case, we want the id from the defaultSku property, since the ðŸ”µ</abbr>
 801             //not have an id property - nor should it.
 802             String[] prefixParts = prefix.split(&quot;\\.&quot;);
 803             for (int j = 0; j &lt; prefixParts.length; j++) {
 804                 StringBuilder sb = new StringBuilder();
 805                 for (int x = 0; x &lt; prefixParts.length - j; x++) {
 806                     sb.append(prefixParts[x]);
 807                     if (x &lt; prefixParts.length - j - 1) {
 808                         sb.append(&quot;.&quot;);
 809                     }
 810                 }
 811                 String tempPrefix = sb.toString();
 812 
 813                 for (Property property : entity.getProperties()) {
 814                     if (property.getName().startsWith(tempPrefix)) {
<abbr title=" 815                         //make sure there is only one &#x27;.&#x27; to ensure we are looking at properties on the current prefix level"> 815                         //make sure there is only one &#x27;.&#x27; to ensure we are looking at properties on the cðŸ”µ</abbr>
<abbr title=" 816                         //in the case of the prefix defaultSku, we want defaultSku.id not defaultSku.skuAttributes.id"> 816                         //in the case of the prefix defaultSku, we want defaultSku.id not defaultSku.skuAðŸ”µ</abbr>
<abbr title=" 817                         if (StringUtils.countMatches(property.getName().replace(tempPrefix, &quot;&quot;), &quot;.&quot;) == 1) {"> 817                         if (StringUtils.countMatches(property.getName().replace(tempPrefix, &quot;&quot;), &quot;.&quot;) == ðŸ”µ</abbr>
 818                             if (cmd.getPMap().containsKey(property.getName())) {
<abbr title=" 819                                 BasicFieldMetadata md = (BasicFieldMetadata) cmd.getPMap().get(property.getName()).getMetadata();"> 819                                 BasicFieldMetadata md = (BasicFieldMetadata) cmd.getPMap().get(property.gðŸ”µ</abbr>
 820                                 if (md.getFieldType().equals(SupportedFieldType.ID)) {
 821                                     return property.getValue();
 822                                 }
 823                             }
 824                         }
 825                     }
 826                 }
 827             }
 828         }
 829         if (!prefix.contains(&quot;.&quot;)) {
<abbr title=" 830             //this may be an embedded class directly on the root entity (e.g. embeddablePriceList.restrictedPriceLists on OfferImpl)"> 830             //this may be an embedded class directly on the root entity (e.g. embeddablePriceList.restricðŸ”µ</abbr>
 831             return entity.findProperty(&quot;id&quot;).getValue();
 832         }
 833         throw new RuntimeException(&quot;Unable to establish a relationship id&quot;);
 834     }
 835 
 836     @Override
 837     public String getIdProperty(ClassMetadata cmd) throws ServiceException {
 838         for (Property p : cmd.getProperties()) {
 839             if (p.getMetadata() instanceof BasicFieldMetadata) {
 840                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
<abbr title=" 841                 //check for ID type and also make sure the field we&#x27;re looking at is not a &quot;ToOne&quot; association"> 841                 //check for ID type and also make sure the field we&#x27;re looking at is not a &quot;ToOne&quot; associðŸ”µ</abbr>
 842                 if (SupportedFieldType.ID.equals(fmd.getFieldType()) &amp;&amp; !p.getName().contains(&quot;.&quot;)) {
 843                     return p.getName();
 844                 }
 845             }
 846         }
 847 
 848         throw new ServiceException(&quot;Could not determine ID field for &quot; + cmd.getCeilingType());
 849     }
 850 
 851     @Override
 852     public PersistenceResponse add(PersistencePackageRequest request) throws ServiceException {
 853         return add(request, true);
 854     }
 855 
 856     @Override
<abbr title=" 857     public PersistenceResponse add(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 857     public PersistenceResponse add(PersistencePackageRequest request, boolean transactional) throws ServiðŸ”µ</abbr>
 858         PersistencePackage pkg = persistencePackageFactory.create(request);
 859         try {
 860             if (request.isUpdateLookupType()) {
 861                 if (pkg.getSectionCrumbs() != null &amp;&amp; pkg.getSectionCrumbs().length &gt; 0) {
 862                     SectionCrumb sc = pkg.getSectionCrumbs()[0];
 863                     if (StringUtils.isNotBlank(sc.getSectionIdentifier())) {
 864                         pkg.setSecurityCeilingEntityFullyQualifiedClassname(sc.getSectionIdentifier());
 865                     }
 866                 }
 867                 if (transactional) {
 868                     return service.update(pkg);
 869                 } else {
 870                     return service.nonTransactionalUpdate(pkg);
 871                 }
 872             } else {
 873                 if (transactional) {
 874                     return service.add(pkg);
 875                 } else {
 876                     return service.nonTransactionalAdd(pkg);
 877                 }
 878             }
 879         } catch (ValidationException e) {
 880             ensureEntityMarkedAsValidationFailure(e, request);
 881             return new PersistenceResponse().withEntity(e.getEntity());
 882         }
 883     }
 884 
 885     @Override
 886     public PersistenceResponse update(PersistencePackageRequest request) throws ServiceException {
 887         return update(request, true);
 888     }
 889 
 890     @Override
<abbr title=" 891     public PersistenceResponse update(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 891     public PersistenceResponse update(PersistencePackageRequest request, boolean transactional) throws SeðŸ”µ</abbr>
 892         PersistencePackage pkg = persistencePackageFactory.create(request);
 893         try {
 894             if (transactional) {
 895                 return service.update(pkg);
 896             } else {
 897                 return service.nonTransactionalUpdate(pkg);
 898             }
 899         } catch (ValidationException e) {
 900             ensureEntityMarkedAsValidationFailure(e, request);
 901             return new PersistenceResponse().withEntity(e.getEntity());
 902         }
 903     }
 904 
 905     @Override
 906     public PersistenceResponse inspect(PersistencePackageRequest request)
 907             throws ServiceException {
 908         PersistencePackage pkg = persistencePackageFactory.create(request);
 909         return service.inspect(pkg);
 910     }
 911 
 912     @Override
 913     public PersistenceResponse remove(PersistencePackageRequest request)
 914             throws ServiceException {
 915         return remove(request, true);
 916     }
 917 
 918     @Override
<abbr title=" 919     public PersistenceResponse remove(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 919     public PersistenceResponse remove(PersistencePackageRequest request, boolean transactional) throws SeðŸ”µ</abbr>
 920         PersistencePackage pkg = persistencePackageFactory.create(request);
 921         try {
 922             if (transactional) {
 923                 return service.remove(pkg);
 924             } else {
 925                 return service.nonTransactionalRemove(pkg);
 926             }
 927         } catch (ValidationException e) {
 928             ensureEntityMarkedAsValidationFailure(e, request);
 929             return new PersistenceResponse().withEntity(e.getEntity());
 930         }
 931     }
 932 
 933     /**
 934      * &lt;p&gt;
<abbr title=" 935      * Should be invoked when a {@link ValidationException} is thrown to verify that the {@link Entity} contained within the"> 935      * Should be invoked when a {@link ValidationException} is thrown to verify that the {@link Entity} cðŸ”µ</abbr>
 936      * given &lt;b&gt;originalRequest&lt;/b&gt; has a validationFailure = true
 937      *
 938      * &lt;p&gt;
<abbr title=" 939      * This will also check for a cause of {@link ConstraintViolationException} and add a gloal error to that."> 939      * This will also check for a cause of {@link ConstraintViolationException} and add a gloal error to ðŸ”µ</abbr>
 940      */
<abbr title=" 941     protected void ensureEntityMarkedAsValidationFailure(ValidationException e, PersistencePackageRequest originalRequest) {"> 941     protected void ensureEntityMarkedAsValidationFailure(ValidationException e, PersistencePackageRequestðŸ”µ</abbr>
 942         if (e.containsCause(ConstraintViolationException.class)) {
 943             e.getEntity().addGlobalValidationError(&quot;constraintViolationError&quot;);
 944         } else if (!e.getEntity().isValidationFailure()) {
 945             e.getEntity().setValidationFailure(true);
 946             e.getEntity().addGlobalValidationError(e.getMessage());
 947         }
 948     }
 949 
 950     @Override
 951     public PersistenceResponse fetch(PersistencePackageRequest request)
 952             throws ServiceException {
 953         PersistencePackage pkg = persistencePackageFactory.create(request);
 954 
 955         CriteriaTransferObject cto = getDefaultCto();
 956         if (request.getFilterAndSortCriteria() != null) {
 957             cto.addAll(Arrays.asList(request.getFilterAndSortCriteria()));
 958         }
 959 
 960         if (request.getMaxResults() != null) {
 961             cto.setMaxResults(request.getMaxResults());
 962         }
 963 
 964         if (request.getStartIndex() == null) {
 965             cto.setFirstResult(0);
 966         } else {
 967             cto.setFirstResult(request.getStartIndex());
 968         }
 969 
 970         if (request.getMaxIndex() != null) {
 971             Integer startIndex = request.getStartIndex() != null ? request.getStartIndex() : 0;
 972             int requestedMaxResults = request.getMaxIndex() - startIndex + 1;
 973             if (requestedMaxResults &gt;= 0 &amp;&amp; requestedMaxResults &lt; cto.getMaxResults()) {
 974                 cto.setMaxResults(requestedMaxResults);
 975             }
 976         }
 977 
 978         cto.setLastId(request.getLastId());
 979         cto.setFirstId(request.getFirstId());
 980         cto.setUpperCount(request.getUpperCount());
 981         cto.setLowerCount(request.getLowerCount());
 982         if (request.getPageSize() != null) {
 983             cto.setMaxResults(request.getPageSize());
 984         }
 985         cto.setPresentationFetch(request.getPresentationFetch());
 986 
 987 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 988 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 989         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 990         return service.fetch(pkg, cto);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 991     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 992     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 993     protected CriteriaTransferObject getDefaultCto() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 994         CriteriaTransferObject cto = new CriteriaTransferObject();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 995         cto.setMaxResults(getDefaultMaxResults());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 996         return cto;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 997     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 998     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 999     @Override</span>
1000 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1001         if (request.isFolderedLookup()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1002             cto.setFolderLookup(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1003             cto.setFolderId(request.getFolderId());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1004         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1005 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1006         if (extensionManager != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1007             extensionManager.getProxy().modifyFetchCriteriaTransferObject(request, cto);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1008         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">1009         </span>
1010 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
1011         return service.fetch(pkg, cto);
1012     }
1013 
1014     protected CriteriaTransferObject getDefaultCto() {
1015         CriteriaTransferObject cto = new CriteriaTransferObject();
1016         cto.setMaxResults(getDefaultMaxResults());
1017         return cto;
1018     }
1019 
1020     @Override
1021     public String getForeignEntityName(String owningClass, String id) {
1022         if (owningClass == null || id == null) {
1023             return null;
1024         }
1025 
1026         DynamicEntityDao dynamicEntityDao = getDynamicEntityDao(owningClass);
1027         Class&lt;?&gt; clazz = dynamicEntityDao.getImplClass(owningClass);
1028         Object foreignEntity = dynamicEntityDao.find(clazz, toIdFieldType(id, clazz));
1029 
1030         if (foreignEntity instanceof AdminMainEntity) {
1031             return ((AdminMainEntity) foreignEntity).getMainEntityName();
1032         }
1033 
1034         return null;
1035     }
1036 
1037     protected DynamicEntityDao getDynamicEntityDao(String owningClass) {
1038         return PersistenceManagerFactory.getPersistenceManager(owningClass).getDynamicEntityDao();
1039     }
1040 
1041     protected int getDefaultMaxResults() {
1042         return BLCSystemProperty.resolveIntSystemProperty(&quot;admin.default.max.results&quot;, 50);
1043     }
1044 
1045     protected Object toIdFieldType(String id, Class&lt;?&gt; entityClass) {
1046         Class&lt;?&gt; idFieldClass = dynamicDaoHelper.getIdField(entityClass).getType();
1047         if (Long.class.isAssignableFrom(idFieldClass)) {
1048             return Long.parseLong(id);
1049         } else if (Integer.class.isAssignableFrom(idFieldClass)) {
1050             return Integer.parseInt(id);
1051         }
1052         return id;
1053     }
1054 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.server.service;
  19 
  20 import org.apache.commons.lang3.ArrayUtils;
  21 import org.apache.commons.lang3.StringUtils;
  22 import org.apache.commons.logging.Log;
  23 import org.apache.commons.logging.LogFactory;
  24 import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  25 import org.broadleafcommerce.common.exception.ServiceException;
  26 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  27 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  28 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  29 import org.broadleafcommerce.common.util.BLCMessageUtils;
  30 import org.broadleafcommerce.common.util.BLCSystemProperty;
  31 import org.broadleafcommerce.common.util.dao.DynamicDaoHelper;
  32 import org.broadleafcommerce.common.util.dao.DynamicDaoHelperImpl;
  33 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  34 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  35 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  36 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  37 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  38 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  39 import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  40 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  41 import org.broadleafcommerce.openadmin.dto.Entity;
  42 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  43 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  44 import org.broadleafcommerce.openadmin.dto.GroupMetadata;
  45 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  46 import org.broadleafcommerce.openadmin.dto.MapStructure;
  47 import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  48 import org.broadleafcommerce.openadmin.dto.Property;
  49 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  50 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  51 import org.broadleafcommerce.openadmin.exception.EntityNotFoundException;
  52 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  53 import org.broadleafcommerce.openadmin.server.domain.FetchPageRequest;
  54 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  55 import org.broadleafcommerce.openadmin.server.factory.PersistencePackageFactory;
  56 import org.broadleafcommerce.openadmin.server.service.extension.CriteriaTransferObjectExtensionManager;
  57 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  58 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
  59 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  60 import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  61 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  62 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  63 import org.broadleafcommerce.openadmin.web.form.entity.Tab;
  64 import org.hibernate.exception.ConstraintViolationException;
  65 import org.springframework.stereotype.Service;
  66 
  67 import java.util.ArrayList;
  68 import java.util.Arrays;
  69 import java.util.HashMap;
  70 import java.util.List;
  71 import java.util.ListIterator;
  72 import java.util.Map;
  73 import java.util.Map.Entry;
  74 
  75 import javax.annotation.Resource;
  76 import javax.persistence.EntityManager;
  77 import javax.persistence.PersistenceContext;
  78 
  79 /**
  80  * @author Andre Azzolini (apazzolini)
  81  */
  82 @Service(&quot;blAdminEntityService&quot;)
  83 public class AdminEntityServiceImpl implements AdminEntityService {
  84 
  85     protected static final Log LOG = LogFactory.getLog(AdminEntityServiceImpl.class);
  86 
  87     @Resource(name = &quot;blDynamicEntityRemoteService&quot;)
  88     protected DynamicEntityService service;
  89 
  90     @Resource(name = &quot;blPersistencePackageFactory&quot;)
  91     protected PersistencePackageFactory persistencePackageFactory;
  92 
  93     @PersistenceContext(unitName = &quot;blPU&quot;)
  94     protected EntityManager em;
  95 
  96     @Resource(name = &quot;blEntityConfiguration&quot;)
  97     protected EntityConfiguration entityConfiguration;
  98 
  99     @Resource
 100     protected CriteriaTransferObjectExtensionManager extensionManager;
 101 
 102     protected DynamicDaoHelper dynamicDaoHelper = new DynamicDaoHelperImpl();
 103 
 104     @Override
 105     public PersistenceResponse getClassMetadata(PersistencePackageRequest request)
 106             throws ServiceException {
 107         PersistenceResponse response = inspect(request);
 108         ClassMetadata cmd = response.getDynamicResultSet().getClassMetaData();
 109         cmd.setCeilingType(request.getCeilingEntityClassname());
 110         cmd.setSecurityCeilingType(request.getSecurityCeilingEntityClassname());
 111         return response;
 112     }
 113 
 114     @Override
 115     public PersistenceResponse getRecords(PersistencePackageRequest request) throws ServiceException {
 116         return fetch(request);
 117     }
 118 
 119     @Override
<abbr title=" 120     public PersistenceResponse getRecord(PersistencePackageRequest request, String id, ClassMetadata cmd, boolean isCollectionRequest)"> 120     public PersistenceResponse getRecord(PersistencePackageRequest request, String id, ClassMetadata cmd,ðŸ”µ</abbr>
 121             throws ServiceException {
 122         String idProperty = getIdProperty(cmd);
 123 
 124         FilterAndSortCriteria fasc = new FilterAndSortCriteria(idProperty);
 125         fasc.setFilterValue(id);
 126         request.addFilterAndSortCriteria(fasc);
 127 
 128         PersistenceResponse response = fetch(request);
 129         Entity[] entities = response.getDynamicResultSet().getRecords();
 130         if (ArrayUtils.isEmpty(entities)) {
 131             String celiningEntity = request.getCeilingEntityClassname();
<abbr title=" 132             throw new EntityNotFoundException(String.format(&quot;Could not find Entity %s with ID %s&quot;, celiningEntity, id));"> 132             throw new EntityNotFoundException(String.format(&quot;Could not find Entity %s with ID %s&quot;, celiniðŸ”µ</abbr>
 133         }
 134 
 135         return response;
 136     }
 137 
 138     @Override
<abbr title=" 139     public PersistenceResponse addEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 139     public PersistenceResponse addEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumðŸ”µ</abbr>
<abbr title=" 140         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);"> 140         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb)ðŸ”µ</abbr>
 141         // If the entity form has dynamic forms inside of it, we need to persist those as well.
 142         // They are typically done in their own custom persistence handlers, which will get triggered
 143         // based on the criteria specific in the PersistencePackage.
 144         for (Entry&lt;String, EntityForm&gt; entry : entityForm.getDynamicForms().entrySet()) {
 145             DynamicEntityFormInfo info = entityForm.getDynamicFormInfo(entry.getKey());
 146 
 147             if (info.getCustomCriteriaOverride() != null) {
 148                 customCriteria = info.getCustomCriteriaOverride();
 149             } else {
 150                 String propertyName = info.getPropertyName();
 151                 String propertyValue;
 152                 if (entityForm.getFields().containsKey(propertyName)) {
 153                     propertyValue = entityForm.findField(propertyName).getValue();
 154                 } else {
 155                     propertyValue = info.getPropertyValue();
 156                 }
<abbr title=" 157                 customCriteria = new String[] {info.getCriteriaName(), entityForm.getId(), propertyName, propertyValue};"> 157                 customCriteria = new String[] {info.getCriteriaName(), entityForm.getId(), propertyName, ðŸ”µ</abbr>
 158             }
 159 
<abbr title=" 160             PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectionCrumb);"> 160             PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriterðŸ”µ</abbr>
 161             ppr.addSubRequest(info.getPropertyName(), subRequest);
 162         }
 163         return add(ppr);
 164     }
 165 
 166     @Override
<abbr title=" 167     public PersistenceResponse updateEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 167     public PersistenceResponse updateEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCðŸ”µ</abbr>
<abbr title=" 168         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);"> 168         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb)ðŸ”µ</abbr>
 169         ppr.setRequestingEntityName(entityForm.getMainEntityName());
 170         // If the entity form has dynamic forms inside of it, we need to persist those as well.
 171         // They are typically done in their own custom persistence handlers, which will get triggered
 172         // based on the criteria specific in the PersistencePackage.
 173         for (Entry&lt;String, EntityForm&gt; entry : entityForm.getDynamicForms().entrySet()) {
 174             DynamicEntityFormInfo info = entityForm.getDynamicFormInfo(entry.getKey());
 175 
 176             if (info.getCustomCriteriaOverride() != null) {
 177                 customCriteria = info.getCustomCriteriaOverride();
 178             } else {
 179                 String propertyName = info.getPropertyName();
 180                 String propertyValue = entityForm.findField(propertyName).getValue();
<abbr title=" 181                 customCriteria = new String[] { info.getCriteriaName(), entityForm.getId(), propertyName, propertyValue };"> 181                 customCriteria = new String[] { info.getCriteriaName(), entityForm.getId(), propertyName,ðŸ”µ</abbr>
 182             }
 183 
<abbr title=" 184             PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectionCrumb);"> 184             PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriterðŸ”µ</abbr>
 185             subRequest.withSecurityCeilingEntityClassname(info.getSecurityCeilingClassName());
 186             ppr.addSubRequest(info.getPropertyName(), subRequest);
 187         }
 188         return update(ppr);
 189     }
 190 
 191     @Override
<abbr title=" 192     public PersistenceResponse removeEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb)"> 192     public PersistenceResponse removeEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCðŸ”µ</abbr>
 193             throws ServiceException {
<abbr title=" 194         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);"> 194         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb)ðŸ”µ</abbr>
 195         return remove(ppr);
 196     }
 197 
 198     protected List&lt;Property&gt; getPropertiesFromEntityForm(EntityForm entityForm) {
 199         List&lt;Property&gt; properties = new ArrayList&lt;Property&gt;(entityForm.getFields().size());
 200 
 201         for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
 202             Property p = new Property();
 203             p.setName(entry.getKey());
 204             p.setValue(entry.getValue().getValue());
 205             p.setDisplayValue(entry.getValue().getDisplayValue());
 206             p.setIsDirty(entry.getValue().getIsDirty());
 207             properties.add(p);
 208         }
 209 
 210         return properties;
 211     }
 212 
 213     @Override
<abbr title=" 214 public PersistencePackageRequest getRequestForEntityForm(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumbs) {"> 214 public PersistencePackageRequest getRequestForEntityForm(EntityForm entityForm, String[] customCriteria, ðŸ”µ</abbr>
 215         // Ensure the ID property is on the form
 216         Field idField = entityForm.findField(entityForm.getIdProperty());
 217         if (idField == null) {
 218             idField = new Field();
 219             idField.setName(entityForm.getIdProperty());
 220             idField.setValue(entityForm.getId());
 221             entityForm.getFields().put(entityForm.getIdProperty(), idField);
 222         } else {
 223             idField.setValue(entityForm.getId());
 224         }
 225 
 226         List&lt;Property&gt; propList = getPropertiesFromEntityForm(entityForm);
 227         Property[] properties = new Property[propList.size()];
 228         properties = propList.toArray(properties);
 229 
 230         Entity entity = new Entity();
 231         entity.setProperties(properties);
 232         String entityType = entityForm.getEntityType();
 233         if (StringUtils.isEmpty(entityType)) {
 234             entityType = entityForm.getCeilingEntityClassname();
 235         }
 236         entity.setType(new String[]{entityType});
 237 
 238         PersistencePackageRequest ppr = PersistencePackageRequest.standard()
 239                 .withEntity(entity)
 240                 .withCustomCriteria(customCriteria)
 241                 .withCeilingEntityClassname(entityForm.getCeilingEntityClassname())
 242                 .withSectionCrumbs(sectionCrumbs)
 243                 .withRequestingEntityName(entityForm.getMainEntityName());
 244         return ppr;
 245     }
 246 
 247     @Override
<abbr title=" 248     public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containingEntity,"> 248     public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity ðŸ”µ</abbr>
<abbr title=" 249             Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternateId)"> 249             Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, StrinðŸ”µ</abbr>
 250             throws ServiceException {
<abbr title=" 251         return getAdvancedCollectionRecord(containingClassMetadata, containingEntity, collectionProperty, collectionItemId, sectionCrumbs, alternateId, null);"> 251         return getAdvancedCollectionRecord(containingClassMetadata, containingEntity, collectionProperty,ðŸ”µ</abbr>
 252     }
 253 
 254     @Override
<abbr title=" 255     public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containingEntity,"> 255     public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity ðŸ”µ</abbr>
<abbr title=" 256             Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternateId,"> 256             Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, StrinðŸ”µ</abbr>
 257             String[] customCriteria) throws ServiceException {
<abbr title=" 258         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sectionCrumbs);"> 258         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetaðŸ”µ</abbr>
 259 
 260         ppr.addCustomCriteria(customCriteria);
 261 
 262         FieldMetadata md = collectionProperty.getMetadata();
<abbr title=" 263         String containingEntityId = getContextSpecificRelationshipId(containingClassMetadata, containingEntity,"> 263         String containingEntityId = getContextSpecificRelationshipId(containingClassMetadata, containingEðŸ”µ</abbr>
 264                 collectionProperty.getName());
 265         ppr.setSectionEntityField(collectionProperty.getName());
 266 
 267         PersistenceResponse response;
 268 
 269         if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title=" 270             FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName());"> 270             FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFielðŸ”µ</abbr>
 271             fasc.setFilterValue(containingEntityId);
 272             ppr.addFilterAndSortCriteria(fasc);
 273 
 274             fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName() + &quot;Target&quot;);
 275             fasc.setFilterValue(collectionItemId);
 276             ppr.addFilterAndSortCriteria(fasc);
 277 
 278             if (!StringUtils.isEmpty(alternateId)) {
 279                 fasc = new FilterAndSortCriteria(ppr.getAdornedList().getIdProperty());
 280                 fasc.setFilterValue(alternateId);
 281                 ppr.addFilterAndSortCriteria(fasc);
 282             }
 283 
 284             response = fetch(ppr);
 285             Entity[] entities = response.getDynamicResultSet().getRecords();
 286             if (ArrayUtils.isEmpty(entities)) {
 287                 String altId = (!StringUtils.isEmpty(alternateId)) ? alternateId : &quot;&quot;;
<abbr title=" 288                 throw new EntityNotFoundException(String.format(&quot;Could not find Entity for [%s], field [%s], id [%s], targetId [%s], alternateId [%s] &quot;,"> 288                 throw new EntityNotFoundException(String.format(&quot;Could not find Entity for [%s], field [%ðŸ”µ</abbr>
<abbr title=" 289                         ppr.getCeilingEntityClassname(), ppr.getAdornedList().getCollectionFieldName(), containingEntityId, collectionItemId, altId));"> 289                         ppr.getCeilingEntityClassname(), ppr.getAdornedList().getCollectionFieldName(), cðŸ”µ</abbr>
 290             }
 291         } else if (md instanceof MapMetadata) {
 292             MapMetadata mmd = (MapMetadata) md;
 293             FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 294             fasc.setFilterValue(containingEntityId);
 295             ppr.addFilterAndSortCriteria(fasc);
 296 
 297             response = fetch(ppr);
 298             Entity[] entities = response.getDynamicResultSet().getRecords();
 299             for (Entity e : entities) {
 300                 String idProperty = getIdProperty(containingClassMetadata);
 301                 if (mmd.isSimpleValue()) {
 302                     idProperty = &quot;key&quot;;
 303                 }
 304                 Property p = e.getPMap().get(idProperty);
 305                 if (p.getValue().equals(collectionItemId)) {
 306                     response.setEntity(e);
 307                     break;
 308                 }
 309             }
 310         } else {
<abbr title=" 311             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not an &quot; +"> 311             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] wasðŸ”µ</abbr>
<abbr title=" 312                     &quot;advanced collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingType()));"> 312                     &quot;advanced collection field.&quot;, collectionProperty.getName(), containingClassMetadata.gðŸ”µ</abbr>
 313         }
 314 
 315         return response;
 316     }
 317 
 318     @Override
<abbr title=" 319     public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 319     public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity contðŸ”µ</abbr>
<abbr title=" 320             Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxIndex, List&lt;SectionCrumb&gt; sectionCrumb)"> 320             Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxInðŸ”µ</abbr>
 321             throws ServiceException {
<abbr title=" 322         return getRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fascs, startIndex,"> 322         return getRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fasðŸ”µ</abbr>
 323                 maxIndex, null, sectionCrumb);
 324     }
 325 
 326     @Override
<abbr title=" 327     public PersistenceResponse getPagedRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 327     public PersistenceResponse getPagedRecordsForCollection(ClassMetadata containingClassMetadata, EntityðŸ”µ</abbr>
<abbr title=" 328             Property collectionProperty, FilterAndSortCriteria[] fascs, FetchPageRequest fetchPageRequest,"> 328             Property collectionProperty, FilterAndSortCriteria[] fascs, FetchPageRequest fetchPageRequestðŸ”µ</abbr>
 329             String idValueOverride, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
<abbr title=" 330         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sectionCrumbs)"> 330         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetaðŸ”µ</abbr>
 331             .withFilterAndSortCriteria(fascs)
 332             .withStartIndex(fetchPageRequest.getStartIndex())
 333             .withMaxIndex(fetchPageRequest.getMaxIndex())
 334             .withFirstId(fetchPageRequest.getFirstId())
 335             .withLastId(fetchPageRequest.getLastId())
 336             .withLowerCount(fetchPageRequest.getLowerCount())
 337             .withUpperCount(fetchPageRequest.getUpperCount())
 338             .withPageSize(fetchPageRequest.getPageSize())
 339             .withPresentationFetch(true);
 340 
 341         FilterAndSortCriteria fasc;
 342 
 343         FieldMetadata md = collectionProperty.getMetadata();
 344         String collectionCeilingClass = null;
 345 
 346         if (md instanceof BasicCollectionMetadata) {
 347             fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 348             collectionCeilingClass = ((CollectionMetadata) md).getCollectionCeilingEntity();
 349         } else if (md instanceof AdornedTargetCollectionMetadata) {
 350             fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName());
 351             collectionCeilingClass = ((CollectionMetadata) md).getCollectionCeilingEntity();
 352         } else if (md instanceof MapMetadata) {
 353             fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 354         } else {
<abbr title=" 355             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not a &quot; +"> 355             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] wasðŸ”µ</abbr>
<abbr title=" 356                     &quot;collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingType()));"> 356                     &quot;collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingðŸ”µ</abbr>
 357         }
 358 
 359         String id;
 360         if (idValueOverride == null) {
<abbr title=" 361             id = getContextSpecificRelationshipId(containingClassMetadata, containingEntity, collectionProperty.getName());"> 361             id = getContextSpecificRelationshipId(containingClassMetadata, containingEntity, collectionPrðŸ”µ</abbr>
 362         } else {
 363             id = idValueOverride;
 364         }
 365         fasc.setFilterValue(id);
 366         ppr.addFilterAndSortCriteria(fasc);
 367 
 368         if (collectionCeilingClass != null) {
 369             ppr.setCeilingEntityClassname(collectionCeilingClass);
 370         }
 371         ppr.setSectionEntityField(collectionProperty.getName());
 372 
 373         return fetch(ppr);
 374     }
 375 
 376     @Override
<abbr title=" 377     public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 377     public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity contðŸ”µ</abbr>
<abbr title=" 378             Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxIndex,"> 378             Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxInðŸ”µ</abbr>
 379             String idValueOverride, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
<abbr title=" 380         FetchPageRequest pageRequest = new FetchPageRequest().withStartIndex(startIndex).withMaxIndex(maxIndex);"> 380         FetchPageRequest pageRequest = new FetchPageRequest().withStartIndex(startIndex).withMaxIndex(maxðŸ”µ</abbr>
<abbr title=" 381         return getPagedRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fascs,"> 381         return getPagedRecordsForCollection(containingClassMetadata, containingEntity, collectionPropertyðŸ”µ</abbr>
 382                 pageRequest, idValueOverride, sectionCrumbs);
 383     }
 384 
 385     @Override
<abbr title=" 386     public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity containingEntity, Integer startIndex, Integer maxIndex, List&lt;SectionCrumb&gt; sectionCrumb)"> 386     public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, EnðŸ”µ</abbr>
 387             throws ServiceException {
 388         Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;String, DynamicResultSet&gt;();
 389 
 390         PersistenceResponse response = getClassMetadata(ppr);
 391         ClassMetadata cmd = response.getDynamicResultSet().getClassMetaData();
 392         for (Property p : cmd.getProperties()) {
 393             if (ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), containingEntity.getType()[0])
 394                     &amp;&amp; p.getMetadata() instanceof CollectionMetadata) {
<abbr title=" 395                 PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, startIndex, maxIndex, sectionCrumb);"> 395                 PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, sðŸ”µ</abbr>
 396                 map.put(p.getName(), response2.getDynamicResultSet());
 397             }
 398         }
 399 
 400         return map;
 401     }
 402 
 403     @Override
<abbr title=" 404     public Map&lt;String, DynamicResultSet&gt; getAllRecordsForAllSubCollections(ClassMetadata cmd, Entity containingEntity,"> 404     public Map&lt;String, DynamicResultSet&gt; getAllRecordsForAllSubCollections(ClassMetadata cmd, Entity contðŸ”µ</abbr>
<abbr title=" 405                                                                            List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 405                                                                            List&lt;SectionCrumb&gt; sectionCrumðŸ”µ</abbr>
 406         Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;&gt;();
 407         for (Property p : cmd.getProperties()) {
 408             FieldMetadata fieldMetadata = p.getMetadata();
<abbr title=" 409             boolean fieldAvailable = ArrayUtils.contains(fieldMetadata.getAvailableToTypes(), containingEntity.getType()[0]);"> 409             boolean fieldAvailable = ArrayUtils.contains(fieldMetadata.getAvailableToTypes(), containingEðŸ”µ</abbr>
 410             if (fieldAvailable &amp;&amp; fieldMetadata instanceof CollectionMetadata) {
 411                 FetchPageRequest pageRequest = new FetchPageRequest()
 412                         .withPageSize(Integer.MAX_VALUE);
<abbr title=" 413                 PersistenceResponse resp = getPagedRecordsForCollection(cmd, containingEntity, p, null, pageRequest, null, sectionCrumb);"> 413                 PersistenceResponse resp = getPagedRecordsForCollection(cmd, containingEntity, p, null, pðŸ”µ</abbr>
 414                 map.put(p.getName(), resp.getDynamicResultSet());
 415             }
 416         }
 417         return map;
 418     }
 419 
 420     @Override
<abbr title=" 421     public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity containingEntity, List&lt;SectionCrumb&gt; sectionCrumb)"> 421     public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, EnðŸ”µ</abbr>
 422             throws ServiceException {
 423 
 424         return getRecordsForAllSubCollections(ppr, containingEntity, null, null, sectionCrumb);
 425     }
 426 
 427     @Override
<abbr title=" 428     public Map&lt;String, DynamicResultSet&gt; getRecordsForSelectedTab(ClassMetadata cmd, Entity containingEntity, List&lt;SectionCrumb&gt; sectionCrumb,"> 428     public Map&lt;String, DynamicResultSet&gt; getRecordsForSelectedTab(ClassMetadata cmd, Entity containingEntðŸ”µ</abbr>
 429             String currentTabName) throws ServiceException {
 430         Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;String, DynamicResultSet&gt;();
 431         for (Property p : cmd.getProperties()) {
 432             if (ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), containingEntity.getType()[0])
 433                     &amp;&amp; p.getMetadata() instanceof CollectionMetadata) {
 434 
 435                 CollectionMetadata collectionMetadata = (CollectionMetadata) p.getMetadata();
 436 
<abbr title=" 437                 // Give preference to the Group since EntityForm.addListGrid() gives preference to the Group"> 437                 // Give preference to the Group since EntityForm.addListGrid() gives preference to the GrðŸ”µ</abbr>
 438                 TabMetadata tabMetadata = cmd.getTabMetadataUsingGroupKey(collectionMetadata.getGroup());
 439                 if (tabMetadata == null) {
 440                     tabMetadata = cmd.getTabMetadataUsingTabKey(collectionMetadata.getTab());
 441                 }
 442 
<abbr title=" 443                 String tabName = tabMetadata == null ? collectionMetadata.getTab() : tabMetadata.getTabName();"> 443                 String tabName = tabMetadata == null ? collectionMetadata.getTab() : tabMetadata.getTabNaðŸ”µ</abbr>
<abbr title=" 444                 int tabOrder = tabMetadata == null ? collectionMetadata.getTabOrder() : tabMetadata.getTabOrder();"> 444                 int tabOrder = tabMetadata == null ? collectionMetadata.getTabOrder() : tabMetadata.getTaðŸ”µ</abbr>
 445                 updateTabInfo(collectionMetadata, cmd, tabName, tabOrder);
 446 
 447                 if (collectionMetadata.getLazyFetch() != null &amp;&amp; collectionMetadata.getLazyFetch()
 448                         &amp;&amp; tabName.toUpperCase().startsWith(currentTabName.toUpperCase())
 449                         &amp;&amp; !collectionMetadata.getManualFetch()) {
<abbr title=" 450                     PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, null, sectionCrumb);"> 450                     PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, nulðŸ”µ</abbr>
 451                     map.put(p.getName(), response2.getDynamicResultSet());
<abbr title=" 452                 } else if (collectionMetadata.getLazyFetch() != null &amp;&amp; !collectionMetadata.getLazyFetch()"> 452                 } else if (collectionMetadata.getLazyFetch() != null &amp;&amp; !collectionMetadata.getLazyFetch(ðŸ”µ</abbr>
 453                         &amp;&amp; !collectionMetadata.getManualFetch()) {
<abbr title=" 454                     PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, null, sectionCrumb);"> 454                     PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, nulðŸ”µ</abbr>
 455                     map.put(p.getName(), response2.getDynamicResultSet());
 456                 } else {
 457                     DynamicResultSet drs = new DynamicResultSet();
 458                     Map&lt;String, Tab&gt; tabMap = new HashMap&lt;String, Tab&gt;();
 459                     Tab tab = new Tab();
 460                     tab.setKey(tabName);
 461                     tab.setTitle(BLCMessageUtils.getMessage(tabName));
 462                     tab.setOrder(tabOrder);
 463                     tabMap.put(tab.getTitle(), tab);
 464                     drs.setUnselectedTabMetadata(tabMap);
 465                     drs.setTotalRecords(0);
 466                     drs.setStartIndex(0);
 467                     drs.setBatchId(1);
 468                     drs.setClassMetaData(null);
 469                     drs.setPageSize(1);
 470                     drs.setRecords(new Entity[0]);
 471                     map.put(p.getName(), drs);
 472                 }
 473             }
 474         }
 475 
 476         return map;
 477     }
 478 
<abbr title=" 479     protected void updateTabInfo(CollectionMetadata fmd, ClassMetadata cmd, String tabName, int tabOrder) {"> 479     protected void updateTabInfo(CollectionMetadata fmd, ClassMetadata cmd, String tabName, int tabOrder)ðŸ”µ</abbr>
 480         boolean tabInfoFound = false;
 481         Map&lt;String, TabMetadata&gt; tabMetadataMap = cmd.getTabAndGroupMetadata();
 482         for (String tabKey : tabMetadataMap.keySet()) {
 483             Map&lt;String, GroupMetadata&gt; groupMetadataMap = tabMetadataMap.get(tabKey).getGroupMetadata();
 484             for (String groupKey : groupMetadataMap.keySet()) {
<abbr title=" 485                 if (groupKey.equals(fmd.getGroup()) || groupMetadataMap.get(groupKey).getGroupName().equals(fmd.getGroup())) {"> 485                 if (groupKey.equals(fmd.getGroup()) || groupMetadataMap.get(groupKey).getGroupName().equaðŸ”µ</abbr>
 486                     tabName = tabMetadataMap.get(tabKey).getTabName();
 487                     tabOrder = tabMetadataMap.get(tabKey).getTabOrder();
 488                     tabInfoFound = true;
 489                     break;
 490                 }
 491             }
 492             if (tabInfoFound) {
 493                 break;
 494             }
 495             if (tabKey.equals(tabName) || tabMetadataMap.get(tabKey).getTabName().equals(tabName)) {
 496                 tabName = tabMetadataMap.get(tabKey).getTabName();
 497                 tabOrder = tabMetadataMap.get(tabKey).getTabOrder();
 498             }
 499         }
 500     }
 501 
 502     @Override
<abbr title=" 503     public PersistenceResponse addSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property field,"> 503     public PersistenceResponse addSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, ðŸ”µ</abbr>
 504             Entity parentEntity, List&lt;SectionCrumb&gt; sectionCrumbs)
 505             throws ServiceException, ClassNotFoundException {
 506         // Assemble the properties from the entity form
 507         List&lt;Property&gt; properties = getPropertiesFromEntityForm(entityForm);
 508 
 509         FieldMetadata md = field.getMetadata();
 510 
 511         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 512                 .withEntity(new Entity());
 513         ppr.getEntity().setIsPreAdd(parentEntity.isPreAdd());
 514 
 515         if (md instanceof BasicCollectionMetadata) {
 516             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 517             ppr.getEntity().setType(new String[] { entityForm.getEntityType() });
 518 
 519             // If we&#x27;re looking up an entity instead of trying to create one on the fly, let&#x27;s make sure
<abbr title=" 520             // that we&#x27;re not changing the target entity at all and only creating the association to the id"> 520             // that we&#x27;re not changing the target entity at all and only creating the association to the ðŸ”µ</abbr>
 521             if (fmd.getAddMethodType().equals(AddMethodType.LOOKUP) ||
 522                     fmd.getAddMethodType().equals(AddMethodType.LOOKUP_FOR_UPDATE)) {
 523                 List&lt;String&gt; fieldsToRemove = new ArrayList&lt;String&gt;();
 524 
 525                 String idProp = getIdProperty(mainMetadata);
 526                 for (String key : entityForm.getFields().keySet()) {
 527                     if (!idProp.equals(key)) {
 528                         fieldsToRemove.add(key);
 529                     }
 530                 }
 531 
 532                 for (String key : fieldsToRemove) {
 533                     ListIterator&lt;Property&gt; li = properties.listIterator();
 534                     while (li.hasNext()) {
 535                         if (li.next().getName().equals(key)) {
 536                             li.remove();
 537                         }
 538                     }
 539                 }
 540 
 541                 ppr.setValidateUnsubmittedProperties(false);
 542             }
 543 
 544             if (fmd.getAddMethodType().equals(AddMethodType.LOOKUP_FOR_UPDATE)) {
 545                 ppr.setUpdateLookupType(true);
 546             }
 547 
 548             Property fp = new Property();
 549             fp.setName(ppr.getForeignKey().getManyToField());
 550             fp.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 551             properties.add(fp);
 552         } else if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title=" 553             ppr.getEntity().setType(new String[] { ppr.getAdornedList().getAdornedTargetEntityClassname() });"> 553             ppr.getEntity().setType(new String[] { ppr.getAdornedList().getAdornedTargetEntityClassname()ðŸ”µ</abbr>
 554 
<abbr title=" 555             String[] maintainedFields = ((AdornedTargetCollectionMetadata) md).getMaintainedAdornedTargetFields();"> 555             String[] maintainedFields = ((AdornedTargetCollectionMetadata) md).getMaintainedAdornedTargetðŸ”µ</abbr>
 556             if (maintainedFields == null || maintainedFields.length == 0) {
 557                 ppr.setValidateUnsubmittedProperties(false);
 558             }
 559 
 560             // Fix for an adorned target collection where the link is maintained from a
 561             // ToOne property on a main entity
<abbr title=" 562             String linkedProperty = ppr.getAdornedList().getLinkedObjectPath() + &quot;.&quot; + ppr.getAdornedList().getLinkedIdProperty();"> 562             String linkedProperty = ppr.getAdornedList().getLinkedObjectPath() + &quot;.&quot; + ppr.getAdornedListðŸ”µ</abbr>
 563             for (Property p : properties) {
 564                 if (p.getName().equals(linkedProperty)) {
<abbr title=" 565                     p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));"> 565                     p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getNameðŸ”µ</abbr>
 566                 }
 567             }
 568         } else if (md instanceof MapMetadata) {
 569             ppr.getEntity().setType(new String[] { entityForm.getEntityType() });
 570 
 571             Property p = new Property();
 572             p.setName(&quot;symbolicId&quot;);
 573             p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 574             properties.add(p);
 575         } else {
<abbr title=" 576             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was&quot; +"> 576             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] wasðŸ”µ</abbr>
 577                     &quot; not a collection field.&quot;, field.getName(), mainMetadata.getCeilingType()));
 578         }
 579 
 580         ppr.setCeilingEntityClassname(ppr.getEntity().getType()[0]);
 581         String sectionField = field.getName();
 582         if (sectionField.contains(&quot;.&quot;)) {
 583             sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 584         }
 585         ppr.setSectionEntityField(sectionField);
 586 
 587         Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 588         if (parentNameProp != null) {
 589             ppr.setRequestingEntityName(parentNameProp.getValue());
 590         }else {
 591             Property name = parentEntity.getPMap().get(&quot;name&quot;);
 592             if(name !=null) {
 593                 ppr.setRequestingEntityName(name.getValue());
 594             }
 595         }
 596         Property[] propArr = new Property[properties.size()];
 597         properties.toArray(propArr);
 598         ppr.getEntity().setProperties(propArr);
 599 
 600         return add(ppr);
 601     }
 602 
 603     @Override
<abbr title=" 604     public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property"> 604     public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadatðŸ”µ</abbr>
<abbr title=" 605             field, Entity parentEntity, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException, ClassNotFoundException {"> 605             field, Entity parentEntity, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumb) throws ðŸ”µ</abbr>
<abbr title=" 606         return updateSubCollectionEntity(entityForm, mainMetadata, field, parentEntity, collectionItemId, null, sectionCrumb);"> 606         return updateSubCollectionEntity(entityForm, mainMetadata, field, parentEntity, collectionItemId,ðŸ”µ</abbr>
 607     }
 608 
 609     @Override
<abbr title=" 610     public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property field,"> 610     public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadatðŸ”µ</abbr>
<abbr title=" 611             Entity parentEntity, String collectionItemId, String alternateId, List&lt;SectionCrumb&gt; sectionCrumbs)"> 611             Entity parentEntity, String collectionItemId, String alternateId, List&lt;SectionCrumb&gt; sectionCðŸ”µ</abbr>
 612             throws ServiceException, ClassNotFoundException {
 613         List&lt;Property&gt; properties = getPropertiesFromEntityForm(entityForm);
 614 
 615         FieldMetadata md = field.getMetadata();
 616 
 617         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 618                 .withEntity(new Entity());
 619 
 620         if (md instanceof BasicCollectionMetadata) {
 621             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 622             ppr.setCeilingEntityClassname(fmd.getCollectionCeilingEntity());
 623             ppr.getEntity().setType(new String[] { fmd.getCollectionCeilingEntity() });
 624 
 625             Property fp = new Property();
 626             fp.setName(ppr.getForeignKey().getManyToField());
 627             fp.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 628             if (!properties.contains(fp)) {
 629                 properties.add(fp);
 630             }
 631         } else if (md instanceof AdornedTargetCollectionMetadata) {
 632             String adornedTargetEntityClassname = ppr.getAdornedList().getAdornedTargetEntityClassname();
 633             ppr.setCeilingEntityClassname(adornedTargetEntityClassname);
 634             ppr.getEntity().setType(new String[] {adornedTargetEntityClassname});
 635 
 636             for (Property property : properties) {
 637                 if (property.getName().equals(ppr.getAdornedList().getLinkedObjectPath() +
 638                                     &quot;.&quot; + ppr.getAdornedList().getLinkedIdProperty())) {
 639                     break;
 640                 }
 641             }
 642 
 643             if (!StringUtils.isEmpty(alternateId)) {
 644                 Property p = new Property();
 645                 p.setName(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);
 646                 p.setValue(alternateId);
 647                 if (!properties.contains(p)) {
 648                     properties.add(p);
 649                 }
 650             }
 651         } else if (md instanceof MapMetadata) {
 652             ppr.getEntity().setType(new String[] { entityForm.getEntityType() });
 653 
 654             Property p = new Property();
 655             p.setName(&quot;symbolicId&quot;);
 656             p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 657             properties.add(p);
 658         } else {
<abbr title=" 659             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was&quot; +"> 659             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] wasðŸ”µ</abbr>
 660                     &quot; not a collection field.&quot;, field.getName(), mainMetadata.getCeilingType()));
 661         }
 662 
 663         String sectionField = field.getName();
 664         if (sectionField.contains(&quot;.&quot;)) {
 665             sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 666         }
 667         ppr.setSectionEntityField(sectionField);
 668 
 669         Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 670         if (parentNameProp != null) {
 671             ppr.setRequestingEntityName(parentNameProp.getValue());
 672         }
 673 
 674         Property p = new Property();
 675         p.setName(entityForm.getIdProperty());
 676         p.setValue(collectionItemId);
 677         if (!properties.contains(p)) {
 678             properties.add(p);
 679         }
 680 
 681         Property[] propArr = new Property[properties.size()];
 682         properties.toArray(propArr);
 683         ppr.getEntity().setProperties(propArr);
 684 
 685         return update(ppr);
 686     }
 687 
 688     @Override
<abbr title=" 689     public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentEntity,"> 689     public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, EntiðŸ”µ</abbr>
<abbr title=" 690                 String itemId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {"> 690                 String itemId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceExceptionðŸ”µ</abbr>
<abbr title=" 691         return removeSubCollectionEntity(mainMetadata, field, parentEntity, itemId, null, priorKey, sectionCrumbs);"> 691         return removeSubCollectionEntity(mainMetadata, field, parentEntity, itemId, null, priorKey, sectiðŸ”µ</abbr>
 692     }
 693 
 694     @Override
<abbr title=" 695     public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentEntity,"> 695     public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, EntiðŸ”µ</abbr>
<abbr title=" 696             String itemId, String alternateId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {"> 696             String itemId, String alternateId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ðŸ”µ</abbr>
 697         List&lt;Property&gt; properties = new ArrayList&lt;Property&gt;();
 698 
 699         Property p;
 700         String parentId = getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName());
 701 
<abbr title=" 702         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(field.getMetadata(), sectionCrumbs)"> 702         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(field.getMetadata(), sectiðŸ”µ</abbr>
 703                 .withEntity(new Entity());
 704 
 705         if (field.getMetadata() instanceof BasicCollectionMetadata) {
 706             BasicCollectionMetadata fmd = (BasicCollectionMetadata) field.getMetadata();
 707 
 708             p = new Property();
 709             p.setName(&quot;id&quot;);
 710             p.setValue(itemId);
 711             properties.add(p);
 712 
 713             p = new Property();
 714             p.setName(ppr.getForeignKey().getManyToField());
 715             p.setValue(parentId);
 716             properties.add(p);
 717 
 718             ppr.getEntity().setType(new String[]{fmd.getCollectionCeilingEntity()});
 719         } else if (field.getMetadata() instanceof AdornedTargetCollectionMetadata) {
 720             AdornedTargetList adornedList = ppr.getAdornedList();
 721 
 722             p = new Property();
 723             p.setName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());
 724             p.setValue(parentId);
 725             properties.add(p);
 726 
 727             p = new Property();
 728             p.setName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());
 729             p.setValue(itemId);
 730             properties.add(p);
 731 
 732             if (!StringUtils.isEmpty(alternateId)) {
 733                 p = new Property();
 734                 p.setName(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);
 735                 p.setValue(alternateId);
 736                 properties.add(p);
 737             }
 738 
 739             ppr.getEntity().setType(new String[]{adornedList.getAdornedTargetEntityClassname()});
 740         } else if (field.getMetadata() instanceof MapMetadata) {
 741             MapMetadata fmd = (MapMetadata) field.getMetadata();
 742 
 743             p = new Property();
 744             p.setName(&quot;id&quot;);
 745             p.setValue(itemId);
 746             properties.add(p);
 747 
 748             p = new Property();
 749             p.setName(&quot;symbolicId&quot;);
 750             p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 751             properties.add(p);
 752 
 753             p = new Property();
 754             p.setName(&quot;priorKey&quot;);
 755             p.setValue(priorKey);
 756             properties.add(p);
 757 
 758             MapStructure mapStructure = ppr.getMapStructure();
 759 
 760             p = new Property();
 761             p.setName(mapStructure.getKeyPropertyName());
 762             p.setValue(itemId);
 763             properties.add(p);
 764 
 765             ppr.getEntity().setType(new String[] { fmd.getTargetClass() });
 766         }
 767 
 768         ppr.setCeilingEntityClassname(ppr.getEntity().getType()[0]);
 769         String sectionField = field.getName();
 770         if (sectionField.contains(&quot;.&quot;)) {
 771             sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 772         }
 773         ppr.setSectionEntityField(sectionField);
 774 
 775         Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 776         if (parentNameProp != null) {
 777             ppr.setRequestingEntityName(parentNameProp.getValue());
 778         }
 779 
 780         Property[] propArr = new Property[properties.size()];
 781         properties.toArray(propArr);
 782         ppr.getEntity().setProperties(propArr);
 783 
 784         return remove(ppr);
 785     }
 786 
 787     @Override
<abbr title=" 788     public String getContextSpecificRelationshipId(ClassMetadata cmd, Entity entity, String propertyName) {"> 788     public String getContextSpecificRelationshipId(ClassMetadata cmd, Entity entity, String propertyName)ðŸ”µ</abbr>
 789         String prefix;
 790         if (propertyName.contains(&quot;.&quot;)) {
 791             prefix = propertyName.substring(0, propertyName.lastIndexOf(&quot;.&quot;));
 792         } else {
 793             prefix = &quot;&quot;;
 794         }
 795 
 796         if (prefix.equals(&quot;&quot;)) {
 797             return entity.findProperty(&quot;id&quot;).getValue();
 798         } else {
<abbr title=" 799             //we need to check all the parts of the prefix. For example, the prefix could include an @Embedded class like"> 799             //we need to check all the parts of the prefix. For example, the prefix could include an @EmbðŸ”µ</abbr>
<abbr title=" 800             //defaultSku.dimension. In this case, we want the id from the defaultSku property, since the @Embedded does"> 800             //defaultSku.dimension. In this case, we want the id from the defaultSku property, since the ðŸ”µ</abbr>
 801             //not have an id property - nor should it.
 802             String[] prefixParts = prefix.split(&quot;\\.&quot;);
 803             for (int j = 0; j &lt; prefixParts.length; j++) {
 804                 StringBuilder sb = new StringBuilder();
 805                 for (int x = 0; x &lt; prefixParts.length - j; x++) {
 806                     sb.append(prefixParts[x]);
 807                     if (x &lt; prefixParts.length - j - 1) {
 808                         sb.append(&quot;.&quot;);
 809                     }
 810                 }
 811                 String tempPrefix = sb.toString();
 812 
 813                 for (Property property : entity.getProperties()) {
 814                     if (property.getName().startsWith(tempPrefix)) {
<abbr title=" 815                         //make sure there is only one &#x27;.&#x27; to ensure we are looking at properties on the current prefix level"> 815                         //make sure there is only one &#x27;.&#x27; to ensure we are looking at properties on the cðŸ”µ</abbr>
<abbr title=" 816                         //in the case of the prefix defaultSku, we want defaultSku.id not defaultSku.skuAttributes.id"> 816                         //in the case of the prefix defaultSku, we want defaultSku.id not defaultSku.skuAðŸ”µ</abbr>
<abbr title=" 817                         if (StringUtils.countMatches(property.getName().replace(tempPrefix, &quot;&quot;), &quot;.&quot;) == 1) {"> 817                         if (StringUtils.countMatches(property.getName().replace(tempPrefix, &quot;&quot;), &quot;.&quot;) == ðŸ”µ</abbr>
 818                             if (cmd.getPMap().containsKey(property.getName())) {
<abbr title=" 819                                 BasicFieldMetadata md = (BasicFieldMetadata) cmd.getPMap().get(property.getName()).getMetadata();"> 819                                 BasicFieldMetadata md = (BasicFieldMetadata) cmd.getPMap().get(property.gðŸ”µ</abbr>
 820                                 if (md.getFieldType().equals(SupportedFieldType.ID)) {
 821                                     return property.getValue();
 822                                 }
 823                             }
 824                         }
 825                     }
 826                 }
 827             }
 828         }
 829         if (!prefix.contains(&quot;.&quot;)) {
<abbr title=" 830             //this may be an embedded class directly on the root entity (e.g. embeddablePriceList.restrictedPriceLists on OfferImpl)"> 830             //this may be an embedded class directly on the root entity (e.g. embeddablePriceList.restricðŸ”µ</abbr>
 831             return entity.findProperty(&quot;id&quot;).getValue();
 832         }
 833         throw new RuntimeException(&quot;Unable to establish a relationship id&quot;);
 834     }
 835 
 836     @Override
 837     public String getIdProperty(ClassMetadata cmd) throws ServiceException {
 838         for (Property p : cmd.getProperties()) {
 839             if (p.getMetadata() instanceof BasicFieldMetadata) {
 840                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
<abbr title=" 841                 //check for ID type and also make sure the field we&#x27;re looking at is not a &quot;ToOne&quot; association"> 841                 //check for ID type and also make sure the field we&#x27;re looking at is not a &quot;ToOne&quot; associðŸ”µ</abbr>
 842                 if (SupportedFieldType.ID.equals(fmd.getFieldType()) &amp;&amp; !p.getName().contains(&quot;.&quot;)) {
 843                     return p.getName();
 844                 }
 845             }
 846         }
 847 
 848         throw new ServiceException(&quot;Could not determine ID field for &quot; + cmd.getCeilingType());
 849     }
 850 
 851     @Override
 852     public PersistenceResponse add(PersistencePackageRequest request) throws ServiceException {
 853         return add(request, true);
 854     }
 855 
 856     @Override
<abbr title=" 857     public PersistenceResponse add(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 857     public PersistenceResponse add(PersistencePackageRequest request, boolean transactional) throws ServiðŸ”µ</abbr>
 858         PersistencePackage pkg = persistencePackageFactory.create(request);
 859         try {
 860             if (request.isUpdateLookupType()) {
 861                 if (pkg.getSectionCrumbs() != null &amp;&amp; pkg.getSectionCrumbs().length &gt; 0) {
 862                     SectionCrumb sc = pkg.getSectionCrumbs()[0];
 863                     if (StringUtils.isNotBlank(sc.getSectionIdentifier())) {
 864                         pkg.setSecurityCeilingEntityFullyQualifiedClassname(sc.getSectionIdentifier());
 865                     }
 866                 }
 867                 if (transactional) {
 868                     return service.update(pkg);
 869                 } else {
 870                     return service.nonTransactionalUpdate(pkg);
 871                 }
 872             } else {
 873                 if (transactional) {
 874                     return service.add(pkg);
 875                 } else {
 876                     return service.nonTransactionalAdd(pkg);
 877                 }
 878             }
 879         } catch (ValidationException e) {
 880             ensureEntityMarkedAsValidationFailure(e, request);
 881             return new PersistenceResponse().withEntity(e.getEntity());
 882         }
 883     }
 884 
 885     @Override
 886     public PersistenceResponse update(PersistencePackageRequest request) throws ServiceException {
 887         return update(request, true);
 888     }
 889 
 890     @Override
<abbr title=" 891     public PersistenceResponse update(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 891     public PersistenceResponse update(PersistencePackageRequest request, boolean transactional) throws SeðŸ”µ</abbr>
 892         PersistencePackage pkg = persistencePackageFactory.create(request);
 893         try {
 894             if (transactional) {
 895                 return service.update(pkg);
 896             } else {
 897                 return service.nonTransactionalUpdate(pkg);
 898             }
 899         } catch (ValidationException e) {
 900             ensureEntityMarkedAsValidationFailure(e, request);
 901             return new PersistenceResponse().withEntity(e.getEntity());
 902         }
 903     }
 904 
 905     @Override
 906     public PersistenceResponse inspect(PersistencePackageRequest request)
 907             throws ServiceException {
 908         PersistencePackage pkg = persistencePackageFactory.create(request);
 909         return service.inspect(pkg);
 910     }
 911 
 912     @Override
 913     public PersistenceResponse remove(PersistencePackageRequest request)
 914             throws ServiceException {
 915         return remove(request, true);
 916     }
 917 
 918     @Override
<abbr title=" 919     public PersistenceResponse remove(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 919     public PersistenceResponse remove(PersistencePackageRequest request, boolean transactional) throws SeðŸ”µ</abbr>
 920         PersistencePackage pkg = persistencePackageFactory.create(request);
 921         try {
 922             if (transactional) {
 923                 return service.remove(pkg);
 924             } else {
 925                 return service.nonTransactionalRemove(pkg);
 926             }
 927         } catch (ValidationException e) {
 928             ensureEntityMarkedAsValidationFailure(e, request);
 929             return new PersistenceResponse().withEntity(e.getEntity());
 930         }
 931     }
 932 
 933     /**
 934      * &lt;p&gt;
<abbr title=" 935      * Should be invoked when a {@link ValidationException} is thrown to verify that the {@link Entity} contained within the"> 935      * Should be invoked when a {@link ValidationException} is thrown to verify that the {@link Entity} cðŸ”µ</abbr>
 936      * given &lt;b&gt;originalRequest&lt;/b&gt; has a validationFailure = true
 937      *
 938      * &lt;p&gt;
<abbr title=" 939      * This will also check for a cause of {@link ConstraintViolationException} and add a gloal error to that."> 939      * This will also check for a cause of {@link ConstraintViolationException} and add a gloal error to ðŸ”µ</abbr>
 940      */
<abbr title=" 941     protected void ensureEntityMarkedAsValidationFailure(ValidationException e, PersistencePackageRequest originalRequest) {"> 941     protected void ensureEntityMarkedAsValidationFailure(ValidationException e, PersistencePackageRequestðŸ”µ</abbr>
 942         if (e.containsCause(ConstraintViolationException.class)) {
 943             e.getEntity().addGlobalValidationError(&quot;constraintViolationError&quot;);
 944         } else if (!e.getEntity().isValidationFailure()) {
 945             e.getEntity().setValidationFailure(true);
 946             e.getEntity().addGlobalValidationError(e.getMessage());
 947         }
 948     }
 949 
 950     @Override
 951     public PersistenceResponse fetch(PersistencePackageRequest request)
 952             throws ServiceException {
 953         PersistencePackage pkg = persistencePackageFactory.create(request);
 954 
 955         CriteriaTransferObject cto = getDefaultCto();
 956         if (request.getFilterAndSortCriteria() != null) {
 957             cto.addAll(Arrays.asList(request.getFilterAndSortCriteria()));
 958         }
 959 
 960         if (request.getMaxResults() != null) {
 961             cto.setMaxResults(request.getMaxResults());
 962         }
 963 
 964         if (request.getStartIndex() == null) {
 965             cto.setFirstResult(0);
 966         } else {
 967             cto.setFirstResult(request.getStartIndex());
 968         }
 969 
 970         if (request.getMaxIndex() != null) {
 971             Integer startIndex = request.getStartIndex() != null ? request.getStartIndex() : 0;
 972             int requestedMaxResults = request.getMaxIndex() - startIndex + 1;
 973             if (requestedMaxResults &gt;= 0 &amp;&amp; requestedMaxResults &lt; cto.getMaxResults()) {
 974                 cto.setMaxResults(requestedMaxResults);
 975             }
 976         }
 977 
 978         cto.setLastId(request.getLastId());
 979         cto.setFirstId(request.getFirstId());
 980         cto.setUpperCount(request.getUpperCount());
 981         cto.setLowerCount(request.getLowerCount());
 982         if (request.getPageSize() != null) {
 983             cto.setMaxResults(request.getPageSize());
 984         }
 985         cto.setPresentationFetch(request.getPresentationFetch());
 986 
 987         if (request.isFolderedLookup()) {
 988             cto.setFolderLookup(true);
 989             cto.setFolderId(request.getFolderId());
 990         }
 991 
 992         if (extensionManager != null) {
 993             extensionManager.getProxy().modifyFetchCriteriaTransferObject(request, cto);
 994         }
 995 
 996         return service.fetch(pkg, cto);
 997     }
 998 
 999     protected CriteriaTransferObject getDefaultCto() {
1000         CriteriaTransferObject cto = new CriteriaTransferObject();
1001         cto.setMaxResults(getDefaultMaxResults());
1002         return cto;
1003     }
1004 
1005     @Override
1006     public String getForeignEntityName(String owningClass, String id) {
1007         if (owningClass == null || id == null) {
1008             return null;
1009         }
1010 
1011         DynamicEntityDao dynamicEntityDao = getDynamicEntityDao(owningClass);
1012         Class&lt;?&gt; clazz = dynamicEntityDao.getImplClass(owningClass);
1013         Object foreignEntity = dynamicEntityDao.find(clazz, toIdFieldType(id, clazz));
1014 
1015         if (foreignEntity instanceof AdminMainEntity) {
1016             return ((AdminMainEntity) foreignEntity).getMainEntityName();
1017         }
1018 
1019         return null;
1020     }
1021 
1022     protected DynamicEntityDao getDynamicEntityDao(String owningClass) {
1023         return PersistenceManagerFactory.getPersistenceManager(owningClass).getDynamicEntityDao();
1024     }
1025 
1026     protected int getDefaultMaxResults() {
1027         return BLCSystemProperty.resolveIntSystemProperty(&quot;admin.default.max.results&quot;, 50);
1028     }
1029 
1030     protected Object toIdFieldType(String id, Class&lt;?&gt; entityClass) {
1031         Class&lt;?&gt; idFieldClass = dynamicDaoHelper.getIdField(entityClass).getType();
1032         if (Long.class.isAssignableFrom(idFieldClass)) {
1033             return Long.parseLong(id);
1034         } else if (Integer.class.isAssignableFrom(idFieldClass)) {
1035             return Integer.parseInt(id);
1036         }
1037         return id;
1038     }
1039 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.server.service;
  19 
  20 import java.util.ArrayList;
  21 import java.util.Arrays;
  22 import java.util.HashMap;
  23 import java.util.List;
  24 import java.util.ListIterator;
  25 import java.util.Map.Entry;
  26 import java.util.Map;
  27 import javax.annotation.Resource;
  28 import javax.persistence.EntityManager;
  29 import javax.persistence.PersistenceContext;
  30 import org.apache.commons.lang3.ArrayUtils;
  31 import org.apache.commons.lang3.StringUtils;
  32 import org.apache.commons.logging.Log;
  33 import org.apache.commons.logging.LogFactory;
  34 import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  35 import org.broadleafcommerce.common.exception.ServiceException;
  36 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  37 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  38 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  39 import org.broadleafcommerce.common.util.BLCMessageUtils;
  40 import org.broadleafcommerce.common.util.BLCSystemProperty;
  41 import org.broadleafcommerce.common.util.dao.DynamicDaoHelper;
  42 import org.broadleafcommerce.common.util.dao.DynamicDaoHelperImpl;
  43 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  44 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  45 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  46 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  47 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  48 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  49 import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  50 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  51 import org.broadleafcommerce.openadmin.dto.Entity;
  52 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  53 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  54 import org.broadleafcommerce.openadmin.dto.GroupMetadata;
  55 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  56 import org.broadleafcommerce.openadmin.dto.MapStructure;
  57 import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  58 import org.broadleafcommerce.openadmin.dto.Property;
  59 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  60 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  61 import org.broadleafcommerce.openadmin.exception.EntityNotFoundException;
  62 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  63 import org.broadleafcommerce.openadmin.server.domain.FetchPageRequest;
  64 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  65 import org.broadleafcommerce.openadmin.server.factory.PersistencePackageFactory;
  66 import org.broadleafcommerce.openadmin.server.service.extension.CriteriaTransferObjectExtensionManager;
  67 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  68 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
  69 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  70 import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  71 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  72 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  73 import org.broadleafcommerce.openadmin.web.form.entity.Tab;
  74 import org.hibernate.exception.ConstraintViolationException;
  75 import org.springframework.stereotype.Service;
  76 
  77 
  78 /**
  79  * @author Andre Azzolini (apazzolini)
  80  */
  81 @Service(&quot;blAdminEntityService&quot;)
  82 public class AdminEntityServiceImpl implements AdminEntityService {
  83     protected static final Log LOG = LogFactory.getLog(AdminEntityServiceImpl.class);
  84 
  85     @Resource(name = &quot;blDynamicEntityRemoteService&quot;)
  86     protected DynamicEntityService service;
  87 
  88     @Resource(name = &quot;blPersistencePackageFactory&quot;)
  89     protected PersistencePackageFactory persistencePackageFactory;
  90 
  91     @PersistenceContext(unitName = &quot;blPU&quot;)
  92     protected EntityManager em;
  93 
  94     @Resource(name = &quot;blEntityConfiguration&quot;)
  95     protected EntityConfiguration entityConfiguration;
  96 
  97     @Resource
  98     protected CriteriaTransferObjectExtensionManager extensionManager;
  99 
 100     protected DynamicDaoHelper dynamicDaoHelper = new DynamicDaoHelperImpl();
 101 
 102     @Override
 103     public PersistenceResponse getClassMetadata(PersistencePackageRequest request)
 104             throws ServiceException {
 105         PersistenceResponse response = inspect(request);
 106         ClassMetadata cmd = response.getDynamicResultSet().getClassMetaData();
 107         cmd.setCeilingType(request.getCeilingEntityClassname());
 108         cmd.setSecurityCeilingType(request.getSecurityCeilingEntityClassname());
 109         return response;
 110     }
 111 
 112     @Override
 113     public PersistenceResponse getRecords(PersistencePackageRequest request) throws ServiceException {
 114         return fetch(request);
 115     }
 116 
 117     @Override
<abbr title=" 118     public PersistenceResponse getRecord(PersistencePackageRequest request, String id, ClassMetadata cmd, boolean isCollectionRequest)"> 118     public PersistenceResponse getRecord(PersistencePackageRequest request, String id, ClassMetadata cmd,ðŸ”µ</abbr>
 119             throws ServiceException {
 120         String idProperty = getIdProperty(cmd);
 121 
 122         FilterAndSortCriteria fasc = new FilterAndSortCriteria(idProperty);
 123         fasc.setFilterValue(id);
 124         request.addFilterAndSortCriteria(fasc);
 125 
 126         PersistenceResponse response = fetch(request);
 127         Entity[] entities = response.getDynamicResultSet().getRecords();
 128         if (ArrayUtils.isEmpty(entities)) {
 129             String celiningEntity = request.getCeilingEntityClassname();
<abbr title=" 130             throw new EntityNotFoundException(String.format(&quot;Could not find Entity %s with ID %s&quot;, celiningEntity, id));"> 130             throw new EntityNotFoundException(String.format(&quot;Could not find Entity %s with ID %s&quot;, celiniðŸ”µ</abbr>
 131         }
 132 
 133         return response;
 134     }
 135 
 136     @Override
<abbr title=" 137     public PersistenceResponse addEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 137     public PersistenceResponse addEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumðŸ”µ</abbr>
<abbr title=" 138         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);"> 138         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb)ðŸ”µ</abbr>
 139         // If the entity form has dynamic forms inside of it, we need to persist those as well.
 140         // They are typically done in their own custom persistence handlers, which will get triggered
 141         // based on the criteria specific in the PersistencePackage.
 142         for (Entry&lt;String, EntityForm&gt; entry : entityForm.getDynamicForms().entrySet()) {
 143             DynamicEntityFormInfo info = entityForm.getDynamicFormInfo(entry.getKey());
 144 
 145             if (info.getCustomCriteriaOverride() != null) {
 146                 customCriteria = info.getCustomCriteriaOverride();
 147             } else {
 148                 String propertyName = info.getPropertyName();
 149                 String propertyValue;
 150                 if (entityForm.getFields().containsKey(propertyName)) {
 151                     propertyValue = entityForm.findField(propertyName).getValue();
 152                 } else {
 153                     propertyValue = info.getPropertyValue();
 154                 }
<abbr title=" 155                 customCriteria = new String[] {info.getCriteriaName(), entityForm.getId(), propertyName, propertyValue};"> 155                 customCriteria = new String[] {info.getCriteriaName(), entityForm.getId(), propertyName, ðŸ”µ</abbr>
 156             }
 157 
<abbr title=" 158             PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectionCrumb);"> 158             PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriterðŸ”µ</abbr>
 159             ppr.addSubRequest(info.getPropertyName(), subRequest);
 160         }
 161         return add(ppr);
 162     }
 163 
 164     @Override
<abbr title=" 165     public PersistenceResponse updateEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 165     public PersistenceResponse updateEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCðŸ”µ</abbr>
<abbr title=" 166         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);"> 166         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb)ðŸ”µ</abbr>
 167         ppr.setRequestingEntityName(entityForm.getMainEntityName());
 168         // If the entity form has dynamic forms inside of it, we need to persist those as well.
 169         // They are typically done in their own custom persistence handlers, which will get triggered
 170         // based on the criteria specific in the PersistencePackage.
 171         for (Entry&lt;String, EntityForm&gt; entry : entityForm.getDynamicForms().entrySet()) {
 172             DynamicEntityFormInfo info = entityForm.getDynamicFormInfo(entry.getKey());
 173 
 174             if (info.getCustomCriteriaOverride() != null) {
 175                 customCriteria = info.getCustomCriteriaOverride();
 176             } else {
 177                 String propertyName = info.getPropertyName();
 178                 String propertyValue = entityForm.findField(propertyName).getValue();
<abbr title=" 179                 customCriteria = new String[] { info.getCriteriaName(), entityForm.getId(), propertyName, propertyValue };"> 179                 customCriteria = new String[] { info.getCriteriaName(), entityForm.getId(), propertyName,ðŸ”µ</abbr>
 180             }
 181 
<abbr title=" 182             PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectionCrumb);"> 182             PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriterðŸ”µ</abbr>
 183             subRequest.withSecurityCeilingEntityClassname(info.getSecurityCeilingClassName());
 184             ppr.addSubRequest(info.getPropertyName(), subRequest);
 185         }
 186         return update(ppr);
 187     }
 188 
 189     @Override
<abbr title=" 190     public PersistenceResponse removeEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb)"> 190     public PersistenceResponse removeEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCðŸ”µ</abbr>
 191             throws ServiceException {
<abbr title=" 192         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);"> 192         PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb)ðŸ”µ</abbr>
 193         return remove(ppr);
 194     }
 195 
 196     protected List&lt;Property&gt; getPropertiesFromEntityForm(EntityForm entityForm) {
 197         List&lt;Property&gt; properties = new ArrayList&lt;Property&gt;(entityForm.getFields().size());
 198 
 199         for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
 200             Property p = new Property();
 201             p.setName(entry.getKey());
 202             p.setValue(entry.getValue().getValue());
 203             p.setDisplayValue(entry.getValue().getDisplayValue());
 204             p.setIsDirty(entry.getValue().getIsDirty());
 205             properties.add(p);
 206         }
 207 
 208         return properties;
 209     }
 210 
 211     @Override
<abbr title=" 212     public PersistencePackageRequest getRequestForEntityForm(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumbs) {"> 212     public PersistencePackageRequest getRequestForEntityForm(EntityForm entityForm, String[] customCriterðŸ”µ</abbr>
 213         // Ensure the ID property is on the form
 214         Field idField = entityForm.findField(entityForm.getIdProperty());
 215         if (idField == null) {
 216             idField = new Field();
 217             idField.setName(entityForm.getIdProperty());
 218             idField.setValue(entityForm.getId());
 219             entityForm.getFields().put(entityForm.getIdProperty(), idField);
 220         } else {
 221             idField.setValue(entityForm.getId());
 222         }
 223         List&lt;Property&gt; propList = getPropertiesFromEntityForm(entityForm);
 224         Property[] properties = new Property[propList.size()];
 225         properties = propList.toArray(properties);
 226         Entity entity = new Entity();
 227         entity.setProperties(properties);
 228         String entityType = entityForm.getEntityType();
 229         if (StringUtils.isEmpty(entityType)) {
 230             entityType = entityForm.getCeilingEntityClassname();
 231         }
 232         entity.setType(new String[]{ entityType });
<abbr title=" 233         PersistencePackageRequest ppr = PersistencePackageRequest.standard().withEntity(entity).withCustomCriteria(customCriteria).withCeilingEntityClassname(entityForm.getCeilingEntityClassname()).withSectionCrumbs(sectionCrumbs).withRequestingEntityName(entityForm.getMainEntityName());"> 233         PersistencePackageRequest ppr = PersistencePackageRequest.standard().withEntity(entity).withCustoðŸ”µ</abbr>
 234         return ppr;
 235     }
 236 
 237     @Override
<abbr title=" 238     public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containingEntity,"> 238     public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity ðŸ”µ</abbr>
<abbr title=" 239             Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternateId)"> 239             Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, StrinðŸ”µ</abbr>
 240             throws ServiceException {
<abbr title=" 241         return getAdvancedCollectionRecord(containingClassMetadata, containingEntity, collectionProperty, collectionItemId, sectionCrumbs, alternateId, null);"> 241         return getAdvancedCollectionRecord(containingClassMetadata, containingEntity, collectionProperty,ðŸ”µ</abbr>
 242     }
 243 
 244     @Override
<abbr title=" 245     public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containingEntity,"> 245     public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity ðŸ”µ</abbr>
<abbr title=" 246             Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternateId,"> 246             Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, StrinðŸ”µ</abbr>
 247             String[] customCriteria) throws ServiceException {
<abbr title=" 248         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sectionCrumbs);"> 248         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetaðŸ”µ</abbr>
 249 
 250         ppr.addCustomCriteria(customCriteria);
 251 
 252         FieldMetadata md = collectionProperty.getMetadata();
<abbr title=" 253         String containingEntityId = getContextSpecificRelationshipId(containingClassMetadata, containingEntity,"> 253         String containingEntityId = getContextSpecificRelationshipId(containingClassMetadata, containingEðŸ”µ</abbr>
 254                 collectionProperty.getName());
 255         ppr.setSectionEntityField(collectionProperty.getName());
 256 
 257         PersistenceResponse response;
 258 
 259         if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title=" 260             FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName());"> 260             FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFielðŸ”µ</abbr>
 261             fasc.setFilterValue(containingEntityId);
 262             ppr.addFilterAndSortCriteria(fasc);
 263 
 264             fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName() + &quot;Target&quot;);
 265             fasc.setFilterValue(collectionItemId);
 266             ppr.addFilterAndSortCriteria(fasc);
 267 
 268             if (!StringUtils.isEmpty(alternateId)) {
 269                 fasc = new FilterAndSortCriteria(ppr.getAdornedList().getIdProperty());
 270                 fasc.setFilterValue(alternateId);
 271                 ppr.addFilterAndSortCriteria(fasc);
 272             }
 273 
 274             response = fetch(ppr);
 275             Entity[] entities = response.getDynamicResultSet().getRecords();
 276             if (ArrayUtils.isEmpty(entities)) {
 277                 String altId = (!StringUtils.isEmpty(alternateId)) ? alternateId : &quot;&quot;;
<abbr title=" 278                 throw new EntityNotFoundException(String.format(&quot;Could not find Entity for [%s], field [%s], id [%s], targetId [%s], alternateId [%s] &quot;,"> 278                 throw new EntityNotFoundException(String.format(&quot;Could not find Entity for [%s], field [%ðŸ”µ</abbr>
<abbr title=" 279                         ppr.getCeilingEntityClassname(), ppr.getAdornedList().getCollectionFieldName(), containingEntityId, collectionItemId, altId));"> 279                         ppr.getCeilingEntityClassname(), ppr.getAdornedList().getCollectionFieldName(), cðŸ”µ</abbr>
 280             }
 281         } else if (md instanceof MapMetadata) {
 282             MapMetadata mmd = (MapMetadata) md;
 283             FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 284             fasc.setFilterValue(containingEntityId);
 285             ppr.addFilterAndSortCriteria(fasc);
 286 
 287             response = fetch(ppr);
 288             Entity[] entities = response.getDynamicResultSet().getRecords();
 289             for (Entity e : entities) {
 290                 String idProperty = getIdProperty(containingClassMetadata);
 291                 if (mmd.isSimpleValue()) {
 292                     idProperty = &quot;key&quot;;
 293                 }
 294                 Property p = e.getPMap().get(idProperty);
 295                 if (p.getValue().equals(collectionItemId)) {
 296                     response.setEntity(e);
 297                     break;
 298                 }
 299             }
 300         } else {
<abbr title=" 301             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not an &quot; +"> 301             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] wasðŸ”µ</abbr>
<abbr title=" 302                     &quot;advanced collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingType()));"> 302                     &quot;advanced collection field.&quot;, collectionProperty.getName(), containingClassMetadata.gðŸ”µ</abbr>
 303         }
 304 
 305         return response;
 306     }
 307 
 308     @Override
<abbr title=" 309     public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 309     public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity contðŸ”µ</abbr>
<abbr title=" 310             Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxIndex, List&lt;SectionCrumb&gt; sectionCrumb)"> 310             Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxInðŸ”µ</abbr>
 311             throws ServiceException {
<abbr title=" 312         return getRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fascs, startIndex,"> 312         return getRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fasðŸ”µ</abbr>
 313                 maxIndex, null, sectionCrumb);
 314     }
 315 
 316     @Override
<abbr title=" 317     public PersistenceResponse getPagedRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 317     public PersistenceResponse getPagedRecordsForCollection(ClassMetadata containingClassMetadata, EntityðŸ”µ</abbr>
<abbr title=" 318             Property collectionProperty, FilterAndSortCriteria[] fascs, FetchPageRequest fetchPageRequest,"> 318             Property collectionProperty, FilterAndSortCriteria[] fascs, FetchPageRequest fetchPageRequestðŸ”µ</abbr>
 319             String idValueOverride, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
<abbr title=" 320         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sectionCrumbs)"> 320         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetaðŸ”µ</abbr>
 321             .withFilterAndSortCriteria(fascs)
 322             .withStartIndex(fetchPageRequest.getStartIndex())
 323             .withMaxIndex(fetchPageRequest.getMaxIndex())
 324             .withFirstId(fetchPageRequest.getFirstId())
 325             .withLastId(fetchPageRequest.getLastId())
 326             .withLowerCount(fetchPageRequest.getLowerCount())
 327             .withUpperCount(fetchPageRequest.getUpperCount())
 328             .withPageSize(fetchPageRequest.getPageSize())
 329             .withPresentationFetch(true);
 330 
 331         FilterAndSortCriteria fasc;
 332 
 333         FieldMetadata md = collectionProperty.getMetadata();
 334         String collectionCeilingClass = null;
 335 
 336         if (md instanceof BasicCollectionMetadata) {
 337             fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 338             collectionCeilingClass = ((CollectionMetadata) md).getCollectionCeilingEntity();
 339         } else if (md instanceof AdornedTargetCollectionMetadata) {
 340             fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName());
 341             collectionCeilingClass = ((CollectionMetadata) md).getCollectionCeilingEntity();
 342         } else if (md instanceof MapMetadata) {
 343             fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 344         } else {
<abbr title=" 345             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not a &quot; +"> 345             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] wasðŸ”µ</abbr>
<abbr title=" 346                     &quot;collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingType()));"> 346                     &quot;collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingðŸ”µ</abbr>
 347         }
 348 
 349         String id;
 350         if (idValueOverride == null) {
<abbr title=" 351             id = getContextSpecificRelationshipId(containingClassMetadata, containingEntity, collectionProperty.getName());"> 351             id = getContextSpecificRelationshipId(containingClassMetadata, containingEntity, collectionPrðŸ”µ</abbr>
 352         } else {
 353             id = idValueOverride;
 354         }
 355         fasc.setFilterValue(id);
 356         ppr.addFilterAndSortCriteria(fasc);
 357 
 358         if (collectionCeilingClass != null) {
 359             ppr.setCeilingEntityClassname(collectionCeilingClass);
 360         }
 361         ppr.setSectionEntityField(collectionProperty.getName());
 362 
 363         return fetch(ppr);
 364     }
 365 
 366     @Override
<abbr title=" 367     public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 367     public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity contðŸ”µ</abbr>
<abbr title=" 368             Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxIndex,"> 368             Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxInðŸ”µ</abbr>
 369             String idValueOverride, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
<abbr title=" 370         FetchPageRequest pageRequest = new FetchPageRequest().withStartIndex(startIndex).withMaxIndex(maxIndex);"> 370         FetchPageRequest pageRequest = new FetchPageRequest().withStartIndex(startIndex).withMaxIndex(maxðŸ”µ</abbr>
<abbr title=" 371         return getPagedRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fascs,"> 371         return getPagedRecordsForCollection(containingClassMetadata, containingEntity, collectionPropertyðŸ”µ</abbr>
 372                 pageRequest, idValueOverride, sectionCrumbs);
 373     }
 374 
 375     @Override
<abbr title=" 376     public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity containingEntity, Integer startIndex, Integer maxIndex, List&lt;SectionCrumb&gt; sectionCrumb)"> 376     public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, EnðŸ”µ</abbr>
 377             throws ServiceException {
 378         Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;String, DynamicResultSet&gt;();
 379 
 380         PersistenceResponse response = getClassMetadata(ppr);
 381         ClassMetadata cmd = response.getDynamicResultSet().getClassMetaData();
 382         for (Property p : cmd.getProperties()) {
 383             if (ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), containingEntity.getType()[0])
 384                     &amp;&amp; p.getMetadata() instanceof CollectionMetadata) {
<abbr title=" 385                 PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, startIndex, maxIndex, sectionCrumb);"> 385                 PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, sðŸ”µ</abbr>
 386                 map.put(p.getName(), response2.getDynamicResultSet());
 387             }
 388         }
 389 
 390         return map;
 391     }
 392 
 393     @Override
<abbr title=" 394     public Map&lt;String, DynamicResultSet&gt; getAllRecordsForAllSubCollections(ClassMetadata cmd, Entity containingEntity,"> 394     public Map&lt;String, DynamicResultSet&gt; getAllRecordsForAllSubCollections(ClassMetadata cmd, Entity contðŸ”µ</abbr>
<abbr title=" 395                                                                            List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 395                                                                            List&lt;SectionCrumb&gt; sectionCrumðŸ”µ</abbr>
 396         Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;&gt;();
 397         for (Property p : cmd.getProperties()) {
 398             FieldMetadata fieldMetadata = p.getMetadata();
<abbr title=" 399             boolean fieldAvailable = ArrayUtils.contains(fieldMetadata.getAvailableToTypes(), containingEntity.getType()[0]);"> 399             boolean fieldAvailable = ArrayUtils.contains(fieldMetadata.getAvailableToTypes(), containingEðŸ”µ</abbr>
 400             if (fieldAvailable &amp;&amp; fieldMetadata instanceof CollectionMetadata) {
 401                 FetchPageRequest pageRequest = new FetchPageRequest()
 402                         .withPageSize(Integer.MAX_VALUE);
<abbr title=" 403                 PersistenceResponse resp = getPagedRecordsForCollection(cmd, containingEntity, p, null, pageRequest, null, sectionCrumb);"> 403                 PersistenceResponse resp = getPagedRecordsForCollection(cmd, containingEntity, p, null, pðŸ”µ</abbr>
 404                 map.put(p.getName(), resp.getDynamicResultSet());
 405             }
 406         }
 407         return map;
 408     }
 409 
 410     @Override
<abbr title=" 411     public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity containingEntity, List&lt;SectionCrumb&gt; sectionCrumb)"> 411     public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, EnðŸ”µ</abbr>
 412             throws ServiceException {
 413 
 414         return getRecordsForAllSubCollections(ppr, containingEntity, null, null, sectionCrumb);
 415     }
 416 
 417     @Override
<abbr title=" 418     public Map&lt;String, DynamicResultSet&gt; getRecordsForSelectedTab(ClassMetadata cmd, Entity containingEntity, List&lt;SectionCrumb&gt; sectionCrumb,"> 418     public Map&lt;String, DynamicResultSet&gt; getRecordsForSelectedTab(ClassMetadata cmd, Entity containingEntðŸ”µ</abbr>
 419             String currentTabName) throws ServiceException {
 420         Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;String, DynamicResultSet&gt;();
 421         for (Property p : cmd.getProperties()) {
 422             if (ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), containingEntity.getType()[0])
 423                     &amp;&amp; p.getMetadata() instanceof CollectionMetadata) {
 424 
 425                 CollectionMetadata collectionMetadata = (CollectionMetadata) p.getMetadata();
 426 
<abbr title=" 427                 // Give preference to the Group since EntityForm.addListGrid() gives preference to the Group"> 427                 // Give preference to the Group since EntityForm.addListGrid() gives preference to the GrðŸ”µ</abbr>
 428                 TabMetadata tabMetadata = cmd.getTabMetadataUsingGroupKey(collectionMetadata.getGroup());
 429                 if (tabMetadata == null) {
 430                     tabMetadata = cmd.getTabMetadataUsingTabKey(collectionMetadata.getTab());
 431                 }
 432 
<abbr title=" 433                 String tabName = tabMetadata == null ? collectionMetadata.getTab() : tabMetadata.getTabName();"> 433                 String tabName = tabMetadata == null ? collectionMetadata.getTab() : tabMetadata.getTabNaðŸ”µ</abbr>
<abbr title=" 434                 int tabOrder = tabMetadata == null ? collectionMetadata.getTabOrder() : tabMetadata.getTabOrder();"> 434                 int tabOrder = tabMetadata == null ? collectionMetadata.getTabOrder() : tabMetadata.getTaðŸ”µ</abbr>
 435                 updateTabInfo(collectionMetadata, cmd, tabName, tabOrder);
 436 
 437                 if (collectionMetadata.getLazyFetch() != null &amp;&amp; collectionMetadata.getLazyFetch()
 438                         &amp;&amp; tabName.toUpperCase().startsWith(currentTabName.toUpperCase())
 439                         &amp;&amp; !collectionMetadata.getManualFetch()) {
<abbr title=" 440                     PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, null, sectionCrumb);"> 440                     PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, nulðŸ”µ</abbr>
 441                     map.put(p.getName(), response2.getDynamicResultSet());
<abbr title=" 442                 } else if (collectionMetadata.getLazyFetch() != null &amp;&amp; !collectionMetadata.getLazyFetch()"> 442                 } else if (collectionMetadata.getLazyFetch() != null &amp;&amp; !collectionMetadata.getLazyFetch(ðŸ”µ</abbr>
 443                         &amp;&amp; !collectionMetadata.getManualFetch()) {
<abbr title=" 444                     PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, null, sectionCrumb);"> 444                     PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, nulðŸ”µ</abbr>
 445                     map.put(p.getName(), response2.getDynamicResultSet());
 446                 } else {
 447                     DynamicResultSet drs = new DynamicResultSet();
 448                     Map&lt;String, Tab&gt; tabMap = new HashMap&lt;String, Tab&gt;();
 449                     Tab tab = new Tab();
 450                     tab.setKey(tabName);
 451                     tab.setTitle(BLCMessageUtils.getMessage(tabName));
 452                     tab.setOrder(tabOrder);
 453                     tabMap.put(tab.getTitle(), tab);
 454                     drs.setUnselectedTabMetadata(tabMap);
 455                     drs.setTotalRecords(0);
 456                     drs.setStartIndex(0);
 457                     drs.setBatchId(1);
 458                     drs.setClassMetaData(null);
 459                     drs.setPageSize(1);
 460                     drs.setRecords(new Entity[0]);
 461                     map.put(p.getName(), drs);
 462                 }
 463             }
 464         }
 465 
 466         return map;
 467     }
 468 
<abbr title=" 469     protected void updateTabInfo(CollectionMetadata fmd, ClassMetadata cmd, String tabName, int tabOrder) {"> 469     protected void updateTabInfo(CollectionMetadata fmd, ClassMetadata cmd, String tabName, int tabOrder)ðŸ”µ</abbr>
 470         boolean tabInfoFound = false;
 471         Map&lt;String, TabMetadata&gt; tabMetadataMap = cmd.getTabAndGroupMetadata();
 472         for (String tabKey : tabMetadataMap.keySet()) {
 473             Map&lt;String, GroupMetadata&gt; groupMetadataMap = tabMetadataMap.get(tabKey).getGroupMetadata();
 474             for (String groupKey : groupMetadataMap.keySet()) {
<abbr title=" 475                 if (groupKey.equals(fmd.getGroup()) || groupMetadataMap.get(groupKey).getGroupName().equals(fmd.getGroup())) {"> 475                 if (groupKey.equals(fmd.getGroup()) || groupMetadataMap.get(groupKey).getGroupName().equaðŸ”µ</abbr>
 476                     tabName = tabMetadataMap.get(tabKey).getTabName();
 477                     tabOrder = tabMetadataMap.get(tabKey).getTabOrder();
 478                     tabInfoFound = true;
 479                     break;
 480                 }
 481             }
 482             if (tabInfoFound) {
 483                 break;
 484             }
 485             if (tabKey.equals(tabName) || tabMetadataMap.get(tabKey).getTabName().equals(tabName)) {
 486                 tabName = tabMetadataMap.get(tabKey).getTabName();
 487                 tabOrder = tabMetadataMap.get(tabKey).getTabOrder();
 488             }
 489         }
 490     }
 491 
 492     @Override
<abbr title=" 493     public PersistenceResponse addSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property field, Entity parentEntity, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException, ClassNotFoundException {"> 493     public PersistenceResponse addSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, ðŸ”µ</abbr>
 494         // Assemble the properties from the entity form
 495         List&lt;Property&gt; properties = getPropertiesFromEntityForm(entityForm);
 496         FieldMetadata md = field.getMetadata();
<abbr title=" 497         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs).withEntity(new Entity());"> 497         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs).withEntðŸ”µ</abbr>
 498         ppr.getEntity().setIsPreAdd(parentEntity.isPreAdd());
 499         if (md instanceof BasicCollectionMetadata) {
 500             BasicCollectionMetadata fmd = ((BasicCollectionMetadata) (md));
 501             ppr.getEntity().setType(new String[]{ entityForm.getEntityType() });
 502             // If we&#x27;re looking up an entity instead of trying to create one on the fly, let&#x27;s make sure
<abbr title=" 503             // that we&#x27;re not changing the target entity at all and only creating the association to the id"> 503             // that we&#x27;re not changing the target entity at all and only creating the association to the ðŸ”µ</abbr>
<abbr title=" 504             if (fmd.getAddMethodType().equals(AddMethodType.LOOKUP) || fmd.getAddMethodType().equals(AddMethodType.LOOKUP_FOR_UPDATE)) {"> 504             if (fmd.getAddMethodType().equals(AddMethodType.LOOKUP) || fmd.getAddMethodType().equals(AddMðŸ”µ</abbr>
 505                 List&lt;String&gt; fieldsToRemove = new ArrayList&lt;String&gt;();
 506                 String idProp = getIdProperty(mainMetadata);
 507                 for (String key : entityForm.getFields().keySet()) {
 508                     if (!idProp.equals(key)) {
 509                         fieldsToRemove.add(key);
 510                     }
 511                 }
 512                 for (String key : fieldsToRemove) {
 513                     ListIterator&lt;Property&gt; li = properties.listIterator();
 514                     while (li.hasNext()) {
 515                         if (li.next().getName().equals(key)) {
 516                             li.remove();
 517                         }
 518                     }
 519                 }
 520                 ppr.setValidateUnsubmittedProperties(false);
 521             }
 522             if (fmd.getAddMethodType().equals(AddMethodType.LOOKUP_FOR_UPDATE)) {
 523                 ppr.setUpdateLookupType(true);
 524             }
 525             Property fp = new Property();
 526             fp.setName(ppr.getForeignKey().getManyToField());
 527             fp.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 528             properties.add(fp);
 529         } else if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title=" 530             ppr.getEntity().setType(new String[]{ ppr.getAdornedList().getAdornedTargetEntityClassname() });"> 530             ppr.getEntity().setType(new String[]{ ppr.getAdornedList().getAdornedTargetEntityClassname() ðŸ”µ</abbr>
<abbr title=" 531             String[] maintainedFields = ((AdornedTargetCollectionMetadata) (md)).getMaintainedAdornedTargetFields();"> 531             String[] maintainedFields = ((AdornedTargetCollectionMetadata) (md)).getMaintainedAdornedTargðŸ”µ</abbr>
 532             if ((maintainedFields == null) || (maintainedFields.length == 0)) {
 533                 ppr.setValidateUnsubmittedProperties(false);
 534             }
 535             // Fix for an adorned target collection where the link is maintained from a
 536             // ToOne property on a main entity
<abbr title=" 537             String linkedProperty = (ppr.getAdornedList().getLinkedObjectPath() + &quot;.&quot;) + ppr.getAdornedList().getLinkedIdProperty();"> 537             String linkedProperty = (ppr.getAdornedList().getLinkedObjectPath() + &quot;.&quot;) + ppr.getAdornedLiðŸ”µ</abbr>
 538             for (Property p : properties) {
 539                 if (p.getName().equals(linkedProperty)) {
<abbr title=" 540                     p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));"> 540                     p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getNameðŸ”µ</abbr>
 541                 }
 542             }
 543         } else if (md instanceof MapMetadata) {
 544             ppr.getEntity().setType(new String[]{ entityForm.getEntityType() });
 545             Property p = new Property();
 546             p.setName(&quot;symbolicId&quot;);
 547             p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 548             properties.add(p);
 549         } else {
<abbr title=" 550             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was&quot; + &quot; not a collection field.&quot;, field.getName(), mainMetadata.getCeilingType()));"> 550             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] wasðŸ”µ</abbr>
 551         }
 552         ppr.setCeilingEntityClassname(ppr.getEntity().getType()[0]);
 553         String sectionField = field.getName();
 554         if (sectionField.contains(&quot;.&quot;)) {
 555             sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 556         }
 557         ppr.setSectionEntityField(sectionField);
 558         Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 559         if (parentNameProp != null) {
 560             ppr.setRequestingEntityName(parentNameProp.getValue());
 561         } else {
 562             Property name = parentEntity.getPMap().get(&quot;name&quot;);
 563             if (name != null) {
 564                 ppr.setRequestingEntityName(name.getValue());
 565             }
 566         }
 567         Property[] propArr = new Property[properties.size()];
 568         properties.toArray(propArr);
 569         ppr.getEntity().setProperties(propArr);
 570         return add(ppr);
 571     }
 572 
 573     @Override
<abbr title=" 574     public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property"> 574     public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadatðŸ”µ</abbr>
<abbr title=" 575             field, Entity parentEntity, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException, ClassNotFoundException {"> 575             field, Entity parentEntity, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumb) throws ðŸ”µ</abbr>
<abbr title=" 576         return updateSubCollectionEntity(entityForm, mainMetadata, field, parentEntity, collectionItemId, null, sectionCrumb);"> 576         return updateSubCollectionEntity(entityForm, mainMetadata, field, parentEntity, collectionItemId,ðŸ”µ</abbr>
 577     }
 578 
 579     @Override
<abbr title=" 580     public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property field, Entity parentEntity, String collectionItemId, String alternateId, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException, ClassNotFoundException {"> 580     public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadatðŸ”µ</abbr>
 581         List&lt;Property&gt; properties = getPropertiesFromEntityForm(entityForm);
 582         FieldMetadata md = field.getMetadata();
<abbr title=" 583         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs).withEntity(new Entity());"> 583         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs).withEntðŸ”µ</abbr>
 584         if (md instanceof BasicCollectionMetadata) {
 585             BasicCollectionMetadata fmd = ((BasicCollectionMetadata) (md));
 586             ppr.setCeilingEntityClassname(fmd.getCollectionCeilingEntity());
 587             ppr.getEntity().setType(new String[]{ fmd.getCollectionCeilingEntity() });
 588             Property fp = new Property();
 589             fp.setName(ppr.getForeignKey().getManyToField());
 590             fp.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 591             if (!properties.contains(fp)) {
 592                 properties.add(fp);
 593             }
 594         } else if (md instanceof AdornedTargetCollectionMetadata) {
 595             String adornedTargetEntityClassname = ppr.getAdornedList().getAdornedTargetEntityClassname();
 596             ppr.setCeilingEntityClassname(adornedTargetEntityClassname);
 597             ppr.getEntity().setType(new String[]{ adornedTargetEntityClassname });
 598             for (Property property : properties) {
<abbr title=" 599                 if (property.getName().equals((ppr.getAdornedList().getLinkedObjectPath() + &quot;.&quot;) + ppr.getAdornedList().getLinkedIdProperty())) {"> 599                 if (property.getName().equals((ppr.getAdornedList().getLinkedObjectPath() + &quot;.&quot;) + ppr.geðŸ”µ</abbr>
 600                     break;
 601                 }
 602             }
 603             if (!StringUtils.isEmpty(alternateId)) {
 604                 Property p = new Property();
 605                 p.setName(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);
 606                 p.setValue(alternateId);
 607                 if (!properties.contains(p)) {
 608                     properties.add(p);
 609                 }
 610             }
 611         } else if (md instanceof MapMetadata) {
 612             ppr.getEntity().setType(new String[]{ entityForm.getEntityType() });
 613             Property p = new Property();
 614             p.setName(&quot;symbolicId&quot;);
 615             p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 616             properties.add(p);
 617         } else {
<abbr title=" 618             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was&quot; + &quot; not a collection field.&quot;, field.getName(), mainMetadata.getCeilingType()));"> 618             throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] wasðŸ”µ</abbr>
 619         }
 620         String sectionField = field.getName();
 621         if (sectionField.contains(&quot;.&quot;)) {
 622             sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 623         }
 624         ppr.setSectionEntityField(sectionField);
 625         Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 626         if (parentNameProp != null) {
 627             ppr.setRequestingEntityName(parentNameProp.getValue());
 628         }
 629         Property p = new Property();
 630         p.setName(entityForm.getIdProperty());
 631         p.setValue(collectionItemId);
 632         if (!properties.contains(p)) {
 633             properties.add(p);
 634         }
 635         Property[] propArr = new Property[properties.size()];
 636         properties.toArray(propArr);
 637         ppr.getEntity().setProperties(propArr);
 638         return update(ppr);
 639     }
 640 
 641     @Override
<abbr title=" 642     public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentEntity,"> 642     public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, EntiðŸ”µ</abbr>
<abbr title=" 643                 String itemId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {"> 643                 String itemId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceExceptionðŸ”µ</abbr>
<abbr title=" 644         return removeSubCollectionEntity(mainMetadata, field, parentEntity, itemId, null, priorKey, sectionCrumbs);"> 644         return removeSubCollectionEntity(mainMetadata, field, parentEntity, itemId, null, priorKey, sectiðŸ”µ</abbr>
 645     }
 646 
 647     @Override
<abbr title=" 648     public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentEntity,"> 648     public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, EntiðŸ”µ</abbr>
<abbr title=" 649             String itemId, String alternateId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {"> 649             String itemId, String alternateId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ðŸ”µ</abbr>
 650         List&lt;Property&gt; properties = new ArrayList&lt;Property&gt;();
 651 
 652         Property p;
 653         String parentId = getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName());
 654 
<abbr title=" 655         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(field.getMetadata(), sectionCrumbs)"> 655         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(field.getMetadata(), sectiðŸ”µ</abbr>
 656                 .withEntity(new Entity());
 657 
 658         if (field.getMetadata() instanceof BasicCollectionMetadata) {
 659             BasicCollectionMetadata fmd = (BasicCollectionMetadata) field.getMetadata();
 660 
 661             p = new Property();
 662             p.setName(&quot;id&quot;);
 663             p.setValue(itemId);
 664             properties.add(p);
 665 
 666             p = new Property();
 667             p.setName(ppr.getForeignKey().getManyToField());
 668             p.setValue(parentId);
 669             properties.add(p);
 670 
 671             ppr.getEntity().setType(new String[]{fmd.getCollectionCeilingEntity()});
 672         } else if (field.getMetadata() instanceof AdornedTargetCollectionMetadata) {
 673             AdornedTargetList adornedList = ppr.getAdornedList();
 674 
 675             p = new Property();
 676             p.setName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());
 677             p.setValue(parentId);
 678             properties.add(p);
 679 
 680             p = new Property();
 681             p.setName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());
 682             p.setValue(itemId);
 683             properties.add(p);
 684 
 685             if (!StringUtils.isEmpty(alternateId)) {
 686                 p = new Property();
 687                 p.setName(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);
 688                 p.setValue(alternateId);
 689                 properties.add(p);
 690             }
 691 
 692             ppr.getEntity().setType(new String[]{adornedList.getAdornedTargetEntityClassname()});
 693         } else if (field.getMetadata() instanceof MapMetadata) {
 694             MapMetadata fmd = (MapMetadata) field.getMetadata();
 695 
 696             p = new Property();
 697             p.setName(&quot;id&quot;);
 698             p.setValue(itemId);
 699             properties.add(p);
 700 
 701             p = new Property();
 702             p.setName(&quot;symbolicId&quot;);
 703             p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 704             properties.add(p);
 705 
 706             p = new Property();
 707             p.setName(&quot;priorKey&quot;);
 708             p.setValue(priorKey);
 709             properties.add(p);
 710 
 711             MapStructure mapStructure = ppr.getMapStructure();
 712 
 713             p = new Property();
 714             p.setName(mapStructure.getKeyPropertyName());
 715             p.setValue(itemId);
 716             properties.add(p);
 717 
 718             ppr.getEntity().setType(new String[] { fmd.getTargetClass() });
 719         }
 720 
 721         ppr.setCeilingEntityClassname(ppr.getEntity().getType()[0]);
 722         String sectionField = field.getName();
 723         if (sectionField.contains(&quot;.&quot;)) {
 724             sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 725         }
 726         ppr.setSectionEntityField(sectionField);
 727 
 728         Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 729         if (parentNameProp != null) {
 730             ppr.setRequestingEntityName(parentNameProp.getValue());
 731         }
 732 
 733         Property[] propArr = new Property[properties.size()];
 734         properties.toArray(propArr);
 735         ppr.getEntity().setProperties(propArr);
 736 
 737         return remove(ppr);
 738     }
 739 
 740     @Override
<abbr title=" 741     public String getContextSpecificRelationshipId(ClassMetadata cmd, Entity entity, String propertyName) {"> 741     public String getContextSpecificRelationshipId(ClassMetadata cmd, Entity entity, String propertyName)ðŸ”µ</abbr>
 742         String prefix;
 743         if (propertyName.contains(&quot;.&quot;)) {
 744             prefix = propertyName.substring(0, propertyName.lastIndexOf(&quot;.&quot;));
 745         } else {
 746             prefix = &quot;&quot;;
 747         }
 748 
 749         if (prefix.equals(&quot;&quot;)) {
 750             return entity.findProperty(&quot;id&quot;).getValue();
 751         } else {
<abbr title=" 752             //we need to check all the parts of the prefix. For example, the prefix could include an @Embedded class like"> 752             //we need to check all the parts of the prefix. For example, the prefix could include an @EmbðŸ”µ</abbr>
<abbr title=" 753             //defaultSku.dimension. In this case, we want the id from the defaultSku property, since the @Embedded does"> 753             //defaultSku.dimension. In this case, we want the id from the defaultSku property, since the ðŸ”µ</abbr>
 754             //not have an id property - nor should it.
 755             String[] prefixParts = prefix.split(&quot;\\.&quot;);
 756             for (int j = 0; j &lt; prefixParts.length; j++) {
 757                 StringBuilder sb = new StringBuilder();
 758                 for (int x = 0; x &lt; prefixParts.length - j; x++) {
 759                     sb.append(prefixParts[x]);
 760                     if (x &lt; prefixParts.length - j - 1) {
 761                         sb.append(&quot;.&quot;);
 762                     }
 763                 }
 764                 String tempPrefix = sb.toString();
 765 
 766                 for (Property property : entity.getProperties()) {
 767                     if (property.getName().startsWith(tempPrefix)) {
<abbr title=" 768                         //make sure there is only one &#x27;.&#x27; to ensure we are looking at properties on the current prefix level"> 768                         //make sure there is only one &#x27;.&#x27; to ensure we are looking at properties on the cðŸ”µ</abbr>
<abbr title=" 769                         //in the case of the prefix defaultSku, we want defaultSku.id not defaultSku.skuAttributes.id"> 769                         //in the case of the prefix defaultSku, we want defaultSku.id not defaultSku.skuAðŸ”µ</abbr>
<abbr title=" 770                         if (StringUtils.countMatches(property.getName().replace(tempPrefix, &quot;&quot;), &quot;.&quot;) == 1) {"> 770                         if (StringUtils.countMatches(property.getName().replace(tempPrefix, &quot;&quot;), &quot;.&quot;) == ðŸ”µ</abbr>
 771                             if (cmd.getPMap().containsKey(property.getName())) {
<abbr title=" 772                                 BasicFieldMetadata md = (BasicFieldMetadata) cmd.getPMap().get(property.getName()).getMetadata();"> 772                                 BasicFieldMetadata md = (BasicFieldMetadata) cmd.getPMap().get(property.gðŸ”µ</abbr>
 773                                 if (md.getFieldType().equals(SupportedFieldType.ID)) {
 774                                     return property.getValue();
 775                                 }
 776                             }
 777                         }
 778                     }
 779                 }
 780             }
 781         }
 782         if (!prefix.contains(&quot;.&quot;)) {
<abbr title=" 783             //this may be an embedded class directly on the root entity (e.g. embeddablePriceList.restrictedPriceLists on OfferImpl)"> 783             //this may be an embedded class directly on the root entity (e.g. embeddablePriceList.restricðŸ”µ</abbr>
 784             return entity.findProperty(&quot;id&quot;).getValue();
 785         }
 786         throw new RuntimeException(&quot;Unable to establish a relationship id&quot;);
 787     }
 788 
 789     @Override
 790     public String getIdProperty(ClassMetadata cmd) throws ServiceException {
 791         for (Property p : cmd.getProperties()) {
 792             if (p.getMetadata() instanceof BasicFieldMetadata) {
 793                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
<abbr title=" 794                 //check for ID type and also make sure the field we&#x27;re looking at is not a &quot;ToOne&quot; association"> 794                 //check for ID type and also make sure the field we&#x27;re looking at is not a &quot;ToOne&quot; associðŸ”µ</abbr>
 795                 if (SupportedFieldType.ID.equals(fmd.getFieldType()) &amp;&amp; !p.getName().contains(&quot;.&quot;)) {
 796                     return p.getName();
 797                 }
 798             }
 799         }
 800 
 801         throw new ServiceException(&quot;Could not determine ID field for &quot; + cmd.getCeilingType());
 802     }
 803 
 804     @Override
 805     public PersistenceResponse add(PersistencePackageRequest request) throws ServiceException {
 806         return add(request, true);
 807     }
 808 
 809     @Override
<abbr title=" 810     public PersistenceResponse add(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 810     public PersistenceResponse add(PersistencePackageRequest request, boolean transactional) throws ServiðŸ”µ</abbr>
 811         PersistencePackage pkg = persistencePackageFactory.create(request);
 812         try {
 813             if (request.isUpdateLookupType()) {
 814                 if (pkg.getSectionCrumbs() != null &amp;&amp; pkg.getSectionCrumbs().length &gt; 0) {
 815                     SectionCrumb sc = pkg.getSectionCrumbs()[0];
 816                     if (StringUtils.isNotBlank(sc.getSectionIdentifier())) {
 817                         pkg.setSecurityCeilingEntityFullyQualifiedClassname(sc.getSectionIdentifier());
 818                     }
 819                 }
 820                 if (transactional) {
 821                     return service.update(pkg);
 822                 } else {
 823                     return service.nonTransactionalUpdate(pkg);
 824                 }
 825             } else {
 826                 if (transactional) {
 827                     return service.add(pkg);
 828                 } else {
 829                     return service.nonTransactionalAdd(pkg);
 830                 }
 831             }
 832         } catch (ValidationException e) {
 833             ensureEntityMarkedAsValidationFailure(e, request);
 834             return new PersistenceResponse().withEntity(e.getEntity());
 835         }
 836     }
 837 
 838     @Override
 839     public PersistenceResponse update(PersistencePackageRequest request) throws ServiceException {
 840         return update(request, true);
 841     }
 842 
 843     @Override
<abbr title=" 844     public PersistenceResponse update(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 844     public PersistenceResponse update(PersistencePackageRequest request, boolean transactional) throws SeðŸ”µ</abbr>
 845         PersistencePackage pkg = persistencePackageFactory.create(request);
 846         try {
 847             if (transactional) {
 848                 return service.update(pkg);
 849             } else {
 850                 return service.nonTransactionalUpdate(pkg);
 851             }
 852         } catch (ValidationException e) {
 853             ensureEntityMarkedAsValidationFailure(e, request);
 854             return new PersistenceResponse().withEntity(e.getEntity());
 855         }
 856     }
 857 
 858     @Override
 859     public PersistenceResponse inspect(PersistencePackageRequest request)
 860             throws ServiceException {
 861         PersistencePackage pkg = persistencePackageFactory.create(request);
 862         return service.inspect(pkg);
 863     }
 864 
 865     @Override
 866     public PersistenceResponse remove(PersistencePackageRequest request)
 867             throws ServiceException {
 868         return remove(request, true);
 869     }
 870 
 871     @Override
<abbr title=" 872     public PersistenceResponse remove(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 872     public PersistenceResponse remove(PersistencePackageRequest request, boolean transactional) throws SeðŸ”µ</abbr>
 873         PersistencePackage pkg = persistencePackageFactory.create(request);
 874         try {
 875             if (transactional) {
 876                 return service.remove(pkg);
 877             } else {
 878                 return service.nonTransactionalRemove(pkg);
 879             }
 880         } catch (ValidationException e) {
 881             ensureEntityMarkedAsValidationFailure(e, request);
 882             return new PersistenceResponse().withEntity(e.getEntity());
 883         }
 884     }
 885 
 886     /**
 887      * &lt;p&gt;
<abbr title=" 888      * Should be invoked when a {@link ValidationException} is thrown to verify that the {@link Entity} contained within the"> 888      * Should be invoked when a {@link ValidationException} is thrown to verify that the {@link Entity} cðŸ”µ</abbr>
 889      * given &lt;b&gt;originalRequest&lt;/b&gt; has a validationFailure = true
 890      *
 891      * &lt;p&gt;
<abbr title=" 892      * This will also check for a cause of {@link ConstraintViolationException} and add a gloal error to that."> 892      * This will also check for a cause of {@link ConstraintViolationException} and add a gloal error to ðŸ”µ</abbr>
 893      */
<abbr title=" 894     protected void ensureEntityMarkedAsValidationFailure(ValidationException e, PersistencePackageRequest originalRequest) {"> 894     protected void ensureEntityMarkedAsValidationFailure(ValidationException e, PersistencePackageRequestðŸ”µ</abbr>
 895         if (e.containsCause(ConstraintViolationException.class)) {
 896             e.getEntity().addGlobalValidationError(&quot;constraintViolationError&quot;);
 897         } else if (!e.getEntity().isValidationFailure()) {
 898             e.getEntity().setValidationFailure(true);
 899             e.getEntity().addGlobalValidationError(e.getMessage());
 900         }
 901     }
 902 
 903     @Override
 904     public PersistenceResponse fetch(PersistencePackageRequest request) throws ServiceException {
 905         PersistencePackage pkg = persistencePackageFactory.create(request);
 906         CriteriaTransferObject cto = getDefaultCto();
 907         if (request.getFilterAndSortCriteria() != null) {
 908             cto.addAll(Arrays.asList(request.getFilterAndSortCriteria()));
 909         }
 910         if (request.getMaxResults() != null) {
 911             cto.setMaxResults(request.getMaxResults());
 912         }
 913         if (request.getStartIndex() == null) {
 914             cto.setFirstResult(0);
 915         } else {
 916             cto.setFirstResult(request.getStartIndex());
 917         }
 918         if (request.getMaxIndex() != null) {
 919             Integer startIndex = (request.getStartIndex() != null) ? request.getStartIndex() : 0;
 920             int requestedMaxResults = (request.getMaxIndex() - startIndex) + 1;
 921             if ((requestedMaxResults &gt;= 0) &amp;&amp; (requestedMaxResults &lt; cto.getMaxResults())) {
 922                 cto.setMaxResults(requestedMaxResults);
 923             }
 924         }
 925         cto.setLastId(request.getLastId());
 926         cto.setFirstId(request.getFirstId());
 927         cto.setUpperCount(request.getUpperCount());
 928         cto.setLowerCount(request.getLowerCount());
 929         if (request.getPageSize() != null) {
 930             cto.setMaxResults(request.getPageSize());
 931         }
 932         cto.setPresentationFetch(request.getPresentationFetch());
 933         if (request.isFolderedLookup()) {
 934             cto.setFolderLookup(true);
 935             cto.setFolderId(request.getFolderId());
 936         }
 937         if (extensionManager != null) {
 938             extensionManager.getProxy().modifyFetchCriteriaTransferObject(request, cto);
 939         }
 940         return service.fetch(pkg, cto);
 941     }
 942 
 943     protected CriteriaTransferObject getDefaultCto() {
 944         CriteriaTransferObject cto = new CriteriaTransferObject();
 945         cto.setMaxResults(getDefaultMaxResults());
 946         return cto;
 947     }
 948 
 949     @Override
 950     public String getForeignEntityName(String owningClass, String id) {
 951         if (owningClass == null || id == null) {
 952             return null;
 953         }
 954 
 955         DynamicEntityDao dynamicEntityDao = getDynamicEntityDao(owningClass);
 956         Class&lt;?&gt; clazz = dynamicEntityDao.getImplClass(owningClass);
 957         Object foreignEntity = dynamicEntityDao.find(clazz, toIdFieldType(id, clazz));
 958 
 959         if (foreignEntity instanceof AdminMainEntity) {
 960             return ((AdminMainEntity) foreignEntity).getMainEntityName();
 961         }
 962 
 963         return null;
 964     }
 965 
 966     protected DynamicEntityDao getDynamicEntityDao(String owningClass) {
 967         return PersistenceManagerFactory.getPersistenceManager(owningClass).getDynamicEntityDao();
 968     }
 969 
 970     protected int getDefaultMaxResults() {
 971         return BLCSystemProperty.resolveIntSystemProperty(&quot;admin.default.max.results&quot;, 50);
 972     }
 973 
 974     protected Object toIdFieldType(String id, Class&lt;?&gt; entityClass) {
 975         Class&lt;?&gt; idFieldClass = dynamicDaoHelper.getIdField(entityClass).getType();
 976         if (java.lang.Long.class.isAssignableFrom(idFieldClass)) {
 977             return Long.parseLong(id);
 978         } else if (java.lang.Integer.class.isAssignableFrom(idFieldClass)) {
 979             return Integer.parseInt(id);
 980         }
 981         return id;
 982     }
 983 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.server.service;
  19  
  20  import org.apache.commons.lang3.ArrayUtils;
  21  import org.apache.commons.lang3.StringUtils;
  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
  24  import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  25  import org.broadleafcommerce.common.exception.ServiceException;
  26  import org.broadleafcommerce.common.persistence.EntityConfiguration;
  27  import org.broadleafcommerce.common.presentation.client.AddMethodType;
  28  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  29  import org.broadleafcommerce.common.util.BLCMessageUtils;
  30  import org.broadleafcommerce.common.util.BLCSystemProperty;
  31  import org.broadleafcommerce.common.util.dao.DynamicDaoHelper;
  32  import org.broadleafcommerce.common.util.dao.DynamicDaoHelperImpl;
  33  import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  34  import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  35  import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  36  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  37  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  38  import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  39  import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  40  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  41  import org.broadleafcommerce.openadmin.dto.Entity;
  42  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  43  import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  44  import org.broadleafcommerce.openadmin.dto.GroupMetadata;
  45  import org.broadleafcommerce.openadmin.dto.MapMetadata;
  46  import org.broadleafcommerce.openadmin.dto.MapStructure;
  47  import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  48  import org.broadleafcommerce.openadmin.dto.Property;
  49  import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  50  import org.broadleafcommerce.openadmin.dto.TabMetadata;
  51  import org.broadleafcommerce.openadmin.exception.EntityNotFoundException;
  52  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  53  import org.broadleafcommerce.openadmin.server.domain.FetchPageRequest;
  54  import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  55  import org.broadleafcommerce.openadmin.server.factory.PersistencePackageFactory;

  56  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  57  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
  58  import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  59  import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  60  import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  61  import org.broadleafcommerce.openadmin.web.form.entity.Field;
  62  import org.broadleafcommerce.openadmin.web.form.entity.Tab;
  63  import org.hibernate.exception.ConstraintViolationException;
  64  import org.springframework.stereotype.Service;
  65  
  66  import java.util.ArrayList;
  67  import java.util.Arrays;
  68  import java.util.HashMap;
  69  import java.util.List;
  70  import java.util.ListIterator;
  71  import java.util.Map;
  72  import java.util.Map.Entry;
  73  
  74  import javax.annotation.Resource;
  75  import javax.persistence.EntityManager;
  76  import javax.persistence.PersistenceContext;
  77  
  78  /**
  79   * @author Andre Azzolini (apazzolini)
  80   */
  81  @Service(&quot;blAdminEntityService&quot;)
  82  public class AdminEntityServiceImpl implements AdminEntityService {
  83  
  84      protected static final Log LOG = LogFactory.getLog(AdminEntityServiceImpl.class);
  85  
  86      @Resource(name = &quot;blDynamicEntityRemoteService&quot;)
  87      protected DynamicEntityService service;
  88  
  89      @Resource(name = &quot;blPersistencePackageFactory&quot;)
  90      protected PersistencePackageFactory persistencePackageFactory;
  91  
  92      @PersistenceContext(unitName = &quot;blPU&quot;)
  93      protected EntityManager em;
  94  
  95      @Resource(name = &quot;blEntityConfiguration&quot;)
  96      protected EntityConfiguration entityConfiguration;



  97  
  98      protected DynamicDaoHelper dynamicDaoHelper = new DynamicDaoHelperImpl();
  99  
 100      @Override
 101      public PersistenceResponse getClassMetadata(PersistencePackageRequest request)
 102              throws ServiceException {
 103          PersistenceResponse response = inspect(request);
 104          ClassMetadata cmd = response.getDynamicResultSet().getClassMetaData();
 105          cmd.setCeilingType(request.getCeilingEntityClassname());
 106          cmd.setSecurityCeilingType(request.getSecurityCeilingEntityClassname());
 107          return response;
 108      }
 109  
 110      @Override
 111      public PersistenceResponse getRecords(PersistencePackageRequest request) throws ServiceException {
 112          return fetch(request);
 113      }
 114  
 115      @Override
<abbr title=" 116      public PersistenceResponse getRecord(PersistencePackageRequest request, String id, ClassMetadata cmd, boolean isCollectionRequest)"> 116      public PersistenceResponse getRecord(PersistencePackageRequest request, String id, ClassMetadata cmd, boolean ðŸ”µ</abbr>
 117              throws ServiceException {
 118          String idProperty = getIdProperty(cmd);
 119  
 120          FilterAndSortCriteria fasc = new FilterAndSortCriteria(idProperty);
 121          fasc.setFilterValue(id);
 122          request.addFilterAndSortCriteria(fasc);
 123  
 124          PersistenceResponse response = fetch(request);
 125          Entity[] entities = response.getDynamicResultSet().getRecords();
 126          if (ArrayUtils.isEmpty(entities)) {
 127              String celiningEntity = request.getCeilingEntityClassname();
<abbr title=" 128              throw new EntityNotFoundException(String.format(&quot;Could not find Entity %s with ID %s&quot;, celiningEntity, id));"> 128              throw new EntityNotFoundException(String.format(&quot;Could not find Entity %s with ID %s&quot;, celiningEntity,ðŸ”µ</abbr>
 129          }
 130  
 131          return response;
 132      }
 133  
 134      @Override
<abbr title=" 135      public PersistenceResponse addEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 135      public PersistenceResponse addEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectioðŸ”µ</abbr>
 136          PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);
 137          // If the entity form has dynamic forms inside of it, we need to persist those as well.
 138          // They are typically done in their own custom persistence handlers, which will get triggered
 139          // based on the criteria specific in the PersistencePackage.
 140          for (Entry&lt;String, EntityForm&gt; entry : entityForm.getDynamicForms().entrySet()) {
 141              DynamicEntityFormInfo info = entityForm.getDynamicFormInfo(entry.getKey());
 142  
 143              if (info.getCustomCriteriaOverride() != null) {
 144                  customCriteria = info.getCustomCriteriaOverride();
 145              } else {
 146                  String propertyName = info.getPropertyName();
 147                  String propertyValue;
 148                  if (entityForm.getFields().containsKey(propertyName)) {
 149                      propertyValue = entityForm.findField(propertyName).getValue();
 150                  } else {
 151                      propertyValue = info.getPropertyValue();
 152                  }
<abbr title=" 153                  customCriteria = new String[] {info.getCriteriaName(), entityForm.getId(), propertyName, propertyValue};"> 153                  customCriteria = new String[] {info.getCriteriaName(), entityForm.getId(), propertyName, propertyVðŸ”µ</abbr>
 154              }
 155  
<abbr title=" 156              PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectionCrumb);"> 156              PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectiðŸ”µ</abbr>
 157              ppr.addSubRequest(info.getPropertyName(), subRequest);
 158          }
 159          return add(ppr);
 160      }
 161  
 162      @Override
<abbr title=" 163      public PersistenceResponse updateEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 163      public PersistenceResponse updateEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; secðŸ”µ</abbr>
 164          PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);
 165          ppr.setRequestingEntityName(entityForm.getMainEntityName());
 166          // If the entity form has dynamic forms inside of it, we need to persist those as well.
 167          // They are typically done in their own custom persistence handlers, which will get triggered
 168          // based on the criteria specific in the PersistencePackage.
 169          for (Entry&lt;String, EntityForm&gt; entry : entityForm.getDynamicForms().entrySet()) {
 170              DynamicEntityFormInfo info = entityForm.getDynamicFormInfo(entry.getKey());
 171  
 172              if (info.getCustomCriteriaOverride() != null) {
 173                  customCriteria = info.getCustomCriteriaOverride();
 174              } else {
 175                  String propertyName = info.getPropertyName();
 176                  String propertyValue = entityForm.findField(propertyName).getValue();
<abbr title=" 177                  customCriteria = new String[] { info.getCriteriaName(), entityForm.getId(), propertyName, propertyValue };"> 177                  customCriteria = new String[] { info.getCriteriaName(), entityForm.getId(), propertyName, propertyðŸ”µ</abbr>
 178              }
 179  
<abbr title=" 180              PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectionCrumb);"> 180              PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectiðŸ”µ</abbr>
 181              subRequest.withSecurityCeilingEntityClassname(info.getSecurityCeilingClassName());
 182              ppr.addSubRequest(info.getPropertyName(), subRequest);
 183          }
 184          return update(ppr);
 185      }
 186  
 187      @Override
<abbr title=" 188      public PersistenceResponse removeEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb)"> 188      public PersistenceResponse removeEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; secðŸ”µ</abbr>
 189              throws ServiceException {
 190          PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);
 191          return remove(ppr);
 192      }
 193  
 194      protected List&lt;Property&gt; getPropertiesFromEntityForm(EntityForm entityForm) {
 195          List&lt;Property&gt; properties = new ArrayList&lt;Property&gt;(entityForm.getFields().size());
 196  
 197          for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
 198              Property p = new Property();
 199              p.setName(entry.getKey());
 200              p.setValue(entry.getValue().getValue());
 201              p.setDisplayValue(entry.getValue().getDisplayValue());
 202              p.setIsDirty(entry.getValue().getIsDirty());
 203              properties.add(p);
 204          }
 205  
 206          return properties;
 207      }
 208  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +    @Override</span>
<abbr title=" 210      public PersistencePackageRequest getRequestForEntityForm(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumbs) {"> 210      public PersistencePackageRequest getRequestForEntityForm(EntityForm entityForm, String[] customCriteria, List&lt;ðŸ”µ</abbr>
 211          // Ensure the ID property is on the form
 212          Field idField = entityForm.findField(entityForm.getIdProperty());
 213          if (idField == null) {
 214              idField = new Field();
 215              idField.setName(entityForm.getIdProperty());
 216              idField.setValue(entityForm.getId());
 217              entityForm.getFields().put(entityForm.getIdProperty(), idField);
 218          } else {
 219              idField.setValue(entityForm.getId());
 220          }
 221  
 222          List&lt;Property&gt; propList = getPropertiesFromEntityForm(entityForm);
 223          Property[] properties = new Property[propList.size()];
 224          properties = propList.toArray(properties);
 225  
 226          Entity entity = new Entity();
 227          entity.setProperties(properties);
 228          String entityType = entityForm.getEntityType();
 229          if (StringUtils.isEmpty(entityType)) {
 230              entityType = entityForm.getCeilingEntityClassname();
 231          }
 232          entity.setType(new String[]{entityType});
 233  
 234          PersistencePackageRequest ppr = PersistencePackageRequest.standard()
 235                  .withEntity(entity)
 236                  .withCustomCriteria(customCriteria)
 237                  .withCeilingEntityClassname(entityForm.getCeilingEntityClassname())
 238                  .withSectionCrumbs(sectionCrumbs)
 239                  .withRequestingEntityName(entityForm.getMainEntityName());
 240          return ppr;
 241      }
 242  
 243      @Override
<abbr title=" 244      public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containingEntity,"> 244      public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containinðŸ”µ</abbr>
<abbr title=" 245              Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternateId)"> 245              Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternaðŸ”µ</abbr>
 246              throws ServiceException {
<abbr title=" 247          return getAdvancedCollectionRecord(containingClassMetadata, containingEntity, collectionProperty, collectionItemId, sectionCrumbs, alternateId, null);"> 247          return getAdvancedCollectionRecord(containingClassMetadata, containingEntity, collectionProperty, collectiðŸ”µ</abbr>
 248      }
 249  
 250      @Override
<abbr title=" 251      public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containingEntity,"> 251      public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containinðŸ”µ</abbr>
<abbr title=" 252              Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternateId,"> 252              Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternaðŸ”µ</abbr>
 253              String[] customCriteria) throws ServiceException {
<abbr title=" 254          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sectionCrumbs);"> 254          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sðŸ”µ</abbr>
 255  
 256          ppr.addCustomCriteria(customCriteria);
 257  
 258          FieldMetadata md = collectionProperty.getMetadata();
 259          String containingEntityId = getContextSpecificRelationshipId(containingClassMetadata, containingEntity,
 260                  collectionProperty.getName());
 261          ppr.setSectionEntityField(collectionProperty.getName());
 262  
 263          PersistenceResponse response;
 264  
 265          if (md instanceof AdornedTargetCollectionMetadata) {
 266              FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName());
 267              fasc.setFilterValue(containingEntityId);
 268              ppr.addFilterAndSortCriteria(fasc);
 269  
 270              fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName() + &quot;Target&quot;);
 271              fasc.setFilterValue(collectionItemId);
 272              ppr.addFilterAndSortCriteria(fasc);
 273  
 274              if (!StringUtils.isEmpty(alternateId)) {
 275                  fasc = new FilterAndSortCriteria(ppr.getAdornedList().getIdProperty());
 276                  fasc.setFilterValue(alternateId);
 277                  ppr.addFilterAndSortCriteria(fasc);
 278              }
 279  
 280              response = fetch(ppr);
 281              Entity[] entities = response.getDynamicResultSet().getRecords();
 282              if (ArrayUtils.isEmpty(entities)) {
 283                  String altId = (!StringUtils.isEmpty(alternateId)) ? alternateId : &quot;&quot;;
<abbr title=" 284                  throw new EntityNotFoundException(String.format(&quot;Could not find Entity for [%s], field [%s], id [%s], targetId [%s], alternateId [%s] &quot;,"> 284                  throw new EntityNotFoundException(String.format(&quot;Could not find Entity for [%s], field [%s], id [%ðŸ”µ</abbr>
<abbr title=" 285                          ppr.getCeilingEntityClassname(), ppr.getAdornedList().getCollectionFieldName(), containingEntityId, collectionItemId, altId));"> 285                          ppr.getCeilingEntityClassname(), ppr.getAdornedList().getCollectionFieldName(), containingðŸ”µ</abbr>
 286              }
 287          } else if (md instanceof MapMetadata) {
 288              MapMetadata mmd = (MapMetadata) md;
 289              FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 290              fasc.setFilterValue(containingEntityId);
 291              ppr.addFilterAndSortCriteria(fasc);
 292  
 293              response = fetch(ppr);
 294              Entity[] entities = response.getDynamicResultSet().getRecords();
 295              for (Entity e : entities) {
 296                  String idProperty = getIdProperty(containingClassMetadata);
 297                  if (mmd.isSimpleValue()) {
 298                      idProperty = &quot;key&quot;;
 299                  }
 300                  Property p = e.getPMap().get(idProperty);
 301                  if (p.getValue().equals(collectionItemId)) {
 302                      response.setEntity(e);
 303                      break;
 304                  }
 305              }
 306          } else {
<abbr title=" 307              throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not an &quot; +"> 307              throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not an &quot;ðŸ”µ</abbr>
<abbr title=" 308                      &quot;advanced collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingType()));"> 308                      &quot;advanced collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingðŸ”µ</abbr>
 309          }
 310  
 311          return response;
 312      }
 313  
 314      @Override
<abbr title=" 315      public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 315      public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntðŸ”µ</abbr>
<abbr title=" 316              Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxIndex, List&lt;SectionCrumb&gt; sectionCrumb)"> 316              Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxIndex, ListðŸ”µ</abbr>
 317              throws ServiceException {
<abbr title=" 318          return getRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fascs, startIndex,"> 318          return getRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fascs, startðŸ”µ</abbr>
 319                  maxIndex, null, sectionCrumb);
 320      }
 321  
 322      @Override
<abbr title=" 323      public PersistenceResponse getPagedRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 323      public PersistenceResponse getPagedRecordsForCollection(ClassMetadata containingClassMetadata, Entity containiðŸ”µ</abbr>
 324              Property collectionProperty, FilterAndSortCriteria[] fascs, FetchPageRequest fetchPageRequest,
 325              String idValueOverride, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
<abbr title=" 326          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sectionCrumbs)"> 326          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sðŸ”µ</abbr>
 327              .withFilterAndSortCriteria(fascs)
 328              .withStartIndex(fetchPageRequest.getStartIndex())
 329              .withMaxIndex(fetchPageRequest.getMaxIndex())
 330              .withFirstId(fetchPageRequest.getFirstId())
 331              .withLastId(fetchPageRequest.getLastId())
 332              .withLowerCount(fetchPageRequest.getLowerCount())
 333              .withUpperCount(fetchPageRequest.getUpperCount())
 334              .withPageSize(fetchPageRequest.getPageSize())
 335              .withPresentationFetch(true);
 336  
 337          FilterAndSortCriteria fasc;
 338  
 339          FieldMetadata md = collectionProperty.getMetadata();
 340          String collectionCeilingClass = null;
 341  
 342          if (md instanceof BasicCollectionMetadata) {
 343              fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 344              collectionCeilingClass = ((CollectionMetadata) md).getCollectionCeilingEntity();
 345          } else if (md instanceof AdornedTargetCollectionMetadata) {
 346              fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName());
 347              collectionCeilingClass = ((CollectionMetadata) md).getCollectionCeilingEntity();
 348          } else if (md instanceof MapMetadata) {
 349              fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 350          } else {
<abbr title=" 351              throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not a &quot; +"> 351              throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not a &quot; ðŸ”µ</abbr>
 352                      &quot;collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingType()));
 353          }
 354  
 355          String id;
 356          if (idValueOverride == null) {
<abbr title=" 357              id = getContextSpecificRelationshipId(containingClassMetadata, containingEntity, collectionProperty.getName());"> 357              id = getContextSpecificRelationshipId(containingClassMetadata, containingEntity, collectionProperty.geðŸ”µ</abbr>
 358          } else {
 359              id = idValueOverride;
 360          }
 361          fasc.setFilterValue(id);
 362          ppr.addFilterAndSortCriteria(fasc);
 363  
 364          if (collectionCeilingClass != null) {
 365              ppr.setCeilingEntityClassname(collectionCeilingClass);
 366          }
 367          ppr.setSectionEntityField(collectionProperty.getName());
 368  
 369          return fetch(ppr);
 370      }
 371  
 372      @Override
<abbr title=" 373      public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 373      public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntðŸ”µ</abbr>
 374              Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxIndex,
 375              String idValueOverride, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
 376          FetchPageRequest pageRequest = new FetchPageRequest().withStartIndex(startIndex).withMaxIndex(maxIndex);
 377          return getPagedRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fascs,
 378                  pageRequest, idValueOverride, sectionCrumbs);
 379      }
 380  
 381      @Override
<abbr title=" 382      public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity containingEntity, Integer startIndex, Integer maxIndex, List&lt;SectionCrumb&gt; sectionCrumb)"> 382      public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity contðŸ”µ</abbr>
 383              throws ServiceException {
 384          Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;String, DynamicResultSet&gt;();
 385  
 386          PersistenceResponse response = getClassMetadata(ppr);
 387          ClassMetadata cmd = response.getDynamicResultSet().getClassMetaData();
 388          for (Property p : cmd.getProperties()) {
 389              if (ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), containingEntity.getType()[0])
 390                      &amp;&amp; p.getMetadata() instanceof CollectionMetadata) {
<abbr title=" 391                  PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, startIndex, maxIndex, sectionCrumb);"> 391                  PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, startIndexðŸ”µ</abbr>
 392                  map.put(p.getName(), response2.getDynamicResultSet());
 393              }
 394          }
 395  
 396          return map;
 397      }
 398  
 399      @Override
<abbr title=" 400      public Map&lt;String, DynamicResultSet&gt; getAllRecordsForAllSubCollections(ClassMetadata cmd, Entity containingEntity,"> 400      public Map&lt;String, DynamicResultSet&gt; getAllRecordsForAllSubCollections(ClassMetadata cmd, Entity containingEntðŸ”µ</abbr>
<abbr title=" 401                                                                             List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 401                                                                             List&lt;SectionCrumb&gt; sectionCrumb) throwsðŸ”µ</abbr>
 402          Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;&gt;();
 403          for (Property p : cmd.getProperties()) {
 404              FieldMetadata fieldMetadata = p.getMetadata();
<abbr title=" 405              boolean fieldAvailable = ArrayUtils.contains(fieldMetadata.getAvailableToTypes(), containingEntity.getType()[0]);"> 405              boolean fieldAvailable = ArrayUtils.contains(fieldMetadata.getAvailableToTypes(), containingEntity.getðŸ”µ</abbr>
 406              if (fieldAvailable &amp;&amp; fieldMetadata instanceof CollectionMetadata) {
 407                  FetchPageRequest pageRequest = new FetchPageRequest()
 408                          .withPageSize(Integer.MAX_VALUE);
<abbr title=" 409                  PersistenceResponse resp = getPagedRecordsForCollection(cmd, containingEntity, p, null, pageRequest, null, sectionCrumb);"> 409                  PersistenceResponse resp = getPagedRecordsForCollection(cmd, containingEntity, p, null, pageRequesðŸ”µ</abbr>
 410                  map.put(p.getName(), resp.getDynamicResultSet());
 411              }
 412          }
 413          return map;
 414      }
 415  
 416      @Override
<abbr title=" 417      public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity containingEntity, List&lt;SectionCrumb&gt; sectionCrumb)"> 417      public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity contðŸ”µ</abbr>
 418              throws ServiceException {
 419  
 420          return getRecordsForAllSubCollections(ppr, containingEntity, null, null, sectionCrumb);
 421      }
 422  
 423      @Override
<abbr title=" 424      public Map&lt;String, DynamicResultSet&gt; getRecordsForSelectedTab(ClassMetadata cmd, Entity containingEntity, List&lt;SectionCrumb&gt; sectionCrumb,"> 424      public Map&lt;String, DynamicResultSet&gt; getRecordsForSelectedTab(ClassMetadata cmd, Entity containingEntity, ListðŸ”µ</abbr>
 425              String currentTabName) throws ServiceException {
 426          Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;String, DynamicResultSet&gt;();
 427          for (Property p : cmd.getProperties()) {
 428              if (ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), containingEntity.getType()[0])
 429                      &amp;&amp; p.getMetadata() instanceof CollectionMetadata) {
 430  
 431                  CollectionMetadata collectionMetadata = (CollectionMetadata) p.getMetadata();
 432  
 433                  // Give preference to the Group since EntityForm.addListGrid() gives preference to the Group
 434                  TabMetadata tabMetadata = cmd.getTabMetadataUsingGroupKey(collectionMetadata.getGroup());
 435                  if (tabMetadata == null) {
 436                      tabMetadata = cmd.getTabMetadataUsingTabKey(collectionMetadata.getTab());
 437                  }
 438  
 439                  String tabName = tabMetadata == null ? collectionMetadata.getTab() : tabMetadata.getTabName();
 440                  int tabOrder = tabMetadata == null ? collectionMetadata.getTabOrder() : tabMetadata.getTabOrder();
 441                  updateTabInfo(collectionMetadata, cmd, tabName, tabOrder);
 442  
 443                  if (collectionMetadata.getLazyFetch() != null &amp;&amp; collectionMetadata.getLazyFetch()
 444                          &amp;&amp; tabName.toUpperCase().startsWith(currentTabName.toUpperCase())
 445                          &amp;&amp; !collectionMetadata.getManualFetch()) {
<abbr title=" 446                      PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, null, sectionCrumb);"> 446                      PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, ðŸ”µ</abbr>
 447                      map.put(p.getName(), response2.getDynamicResultSet());
 448                  } else if (collectionMetadata.getLazyFetch() != null &amp;&amp; !collectionMetadata.getLazyFetch()
 449                          &amp;&amp; !collectionMetadata.getManualFetch()) {
<abbr title=" 450                      PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, null, sectionCrumb);"> 450                      PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, ðŸ”µ</abbr>
 451                      map.put(p.getName(), response2.getDynamicResultSet());
 452                  } else {
 453                      DynamicResultSet drs = new DynamicResultSet();
 454                      Map&lt;String, Tab&gt; tabMap = new HashMap&lt;String, Tab&gt;();
 455                      Tab tab = new Tab();
 456                      tab.setKey(tabName);
 457                      tab.setTitle(BLCMessageUtils.getMessage(tabName));
 458                      tab.setOrder(tabOrder);
 459                      tabMap.put(tab.getTitle(), tab);
 460                      drs.setUnselectedTabMetadata(tabMap);
 461                      drs.setTotalRecords(0);
 462                      drs.setStartIndex(0);
 463                      drs.setBatchId(1);
 464                      drs.setClassMetaData(null);
 465                      drs.setPageSize(1);
 466                      drs.setRecords(new Entity[0]);
 467                      map.put(p.getName(), drs);
 468                  }
 469              }
 470          }
 471  
 472          return map;
 473      }
 474  
 475      protected void updateTabInfo(CollectionMetadata fmd, ClassMetadata cmd, String tabName, int tabOrder) {
 476          boolean tabInfoFound = false;
 477          Map&lt;String, TabMetadata&gt; tabMetadataMap = cmd.getTabAndGroupMetadata();
 478          for (String tabKey : tabMetadataMap.keySet()) {
 479              Map&lt;String, GroupMetadata&gt; groupMetadataMap = tabMetadataMap.get(tabKey).getGroupMetadata();
 480              for (String groupKey : groupMetadataMap.keySet()) {
<abbr title=" 481                  if (groupKey.equals(fmd.getGroup()) || groupMetadataMap.get(groupKey).getGroupName().equals(fmd.getGroup())) {"> 481                  if (groupKey.equals(fmd.getGroup()) || groupMetadataMap.get(groupKey).getGroupName().equals(fmd.geðŸ”µ</abbr>
 482                      tabName = tabMetadataMap.get(tabKey).getTabName();
 483                      tabOrder = tabMetadataMap.get(tabKey).getTabOrder();
 484                      tabInfoFound = true;
 485                      break;
 486                  }
 487              }
 488              if (tabInfoFound) {
 489                  break;
 490              }
 491              if (tabKey.equals(tabName) || tabMetadataMap.get(tabKey).getTabName().equals(tabName)) {
 492                  tabName = tabMetadataMap.get(tabKey).getTabName();
 493                  tabOrder = tabMetadataMap.get(tabKey).getTabOrder();
 494              }
 495          }
 496      }
 497  
 498      @Override
<abbr title=" 499      public PersistenceResponse addSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property field,"> 499      public PersistenceResponse addSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property ðŸ”µ</abbr>
 500              Entity parentEntity, List&lt;SectionCrumb&gt; sectionCrumbs)
 501              throws ServiceException, ClassNotFoundException {
 502          // Assemble the properties from the entity form
 503          List&lt;Property&gt; properties = getPropertiesFromEntityForm(entityForm);
 504  
 505          FieldMetadata md = field.getMetadata();
 506  
 507          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 508                  .withEntity(new Entity());
 509          ppr.getEntity().setIsPreAdd(parentEntity.isPreAdd());
 510  
 511          if (md instanceof BasicCollectionMetadata) {
 512              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 513              ppr.getEntity().setType(new String[] { entityForm.getEntityType() });
 514  
 515              // If we&#x27;re looking up an entity instead of trying to create one on the fly, let&#x27;s make sure
 516              // that we&#x27;re not changing the target entity at all and only creating the association to the id
 517              if (fmd.getAddMethodType().equals(AddMethodType.LOOKUP) ||
 518                      fmd.getAddMethodType().equals(AddMethodType.LOOKUP_FOR_UPDATE)) {
 519                  List&lt;String&gt; fieldsToRemove = new ArrayList&lt;String&gt;();
 520  
 521                  String idProp = getIdProperty(mainMetadata);
 522                  for (String key : entityForm.getFields().keySet()) {
 523                      if (!idProp.equals(key)) {
 524                          fieldsToRemove.add(key);
 525                      }
 526                  }
 527  
 528                  for (String key : fieldsToRemove) {
 529                      ListIterator&lt;Property&gt; li = properties.listIterator();
 530                      while (li.hasNext()) {
 531                          if (li.next().getName().equals(key)) {
 532                              li.remove();
 533                          }
 534                      }
 535                  }
 536  
 537                  ppr.setValidateUnsubmittedProperties(false);
 538              }
 539  
 540              if (fmd.getAddMethodType().equals(AddMethodType.LOOKUP_FOR_UPDATE)) {
 541                  ppr.setUpdateLookupType(true);
 542              }
 543  
 544              Property fp = new Property();
 545              fp.setName(ppr.getForeignKey().getManyToField());
 546              fp.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 547              properties.add(fp);
 548          } else if (md instanceof AdornedTargetCollectionMetadata) {
 549              ppr.getEntity().setType(new String[] { ppr.getAdornedList().getAdornedTargetEntityClassname() });
 550  
 551              String[] maintainedFields = ((AdornedTargetCollectionMetadata) md).getMaintainedAdornedTargetFields();
 552              if (maintainedFields == null || maintainedFields.length == 0) {
 553                  ppr.setValidateUnsubmittedProperties(false);
 554              }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 555 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 556 +            // Fix for an adorned target collection where the link is maintained from a</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 557 +            // ToOne property on a main entity</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 558 +            String linkedProperty = ppr.getAdornedList().getLinkedObjectPath() + &quot;.&quot; + ppr.getAdornedList().getLinkedIdProperty();"> 558 +            String linkedProperty = ppr.getAdornedList().getLinkedObjectPath() + &quot;.&quot; + ppr.getAdornedList().getLinðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 559 +            for (Property p : properties) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 560 +                if (p.getName().equals(linkedProperty)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 561 +                    p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 562 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 563 +            }</span>
 564          } else if (md instanceof MapMetadata) {
 565              ppr.getEntity().setType(new String[] { entityForm.getEntityType() });
 566  
 567              Property p = new Property();
 568              p.setName(&quot;symbolicId&quot;);
 569              p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 570              properties.add(p);
 571          } else {
 572              throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was&quot; +
 573                      &quot; not a collection field.&quot;, field.getName(), mainMetadata.getCeilingType()));
 574          }
 575  
 576          ppr.setCeilingEntityClassname(ppr.getEntity().getType()[0]);
 577          String sectionField = field.getName();
 578          if (sectionField.contains(&quot;.&quot;)) {
 579              sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 580          }
 581          ppr.setSectionEntityField(sectionField);
 582  
 583          Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 584          if (parentNameProp != null) {
 585              ppr.setRequestingEntityName(parentNameProp.getValue());
 586          }else {
 587              Property name = parentEntity.getPMap().get(&quot;name&quot;);
 588              if(name !=null) {
 589                  ppr.setRequestingEntityName(name.getValue());
 590              }
 591          }
 592          Property[] propArr = new Property[properties.size()];
 593          properties.toArray(propArr);
 594          ppr.getEntity().setProperties(propArr);
 595  
 596          return add(ppr);
 597      }
 598  
 599      @Override
<abbr title=" 600      public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property"> 600      public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, ProperðŸ”µ</abbr>
<abbr title=" 601              field, Entity parentEntity, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException, ClassNotFoundException {"> 601              field, Entity parentEntity, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceExðŸ”µ</abbr>
<abbr title=" 602          return updateSubCollectionEntity(entityForm, mainMetadata, field, parentEntity, collectionItemId, null, sectionCrumb);"> 602          return updateSubCollectionEntity(entityForm, mainMetadata, field, parentEntity, collectionItemId, null, seðŸ”µ</abbr>
 603      }
 604  
 605      @Override
<abbr title=" 606      public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property field,"> 606      public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, ProperðŸ”µ</abbr>
 607              Entity parentEntity, String collectionItemId, String alternateId, List&lt;SectionCrumb&gt; sectionCrumbs)
 608              throws ServiceException, ClassNotFoundException {
 609          List&lt;Property&gt; properties = getPropertiesFromEntityForm(entityForm);
 610  
 611          FieldMetadata md = field.getMetadata();
 612  
 613          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 614                  .withEntity(new Entity());
 615  
 616          if (md instanceof BasicCollectionMetadata) {
 617              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 618              ppr.setCeilingEntityClassname(fmd.getCollectionCeilingEntity());
 619              ppr.getEntity().setType(new String[] { fmd.getCollectionCeilingEntity() });
 620  
 621              Property fp = new Property();
 622              fp.setName(ppr.getForeignKey().getManyToField());
 623              fp.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 624              if (!properties.contains(fp)) {
 625                  properties.add(fp);
 626              }
 627          } else if (md instanceof AdornedTargetCollectionMetadata) {
 628              String adornedTargetEntityClassname = ppr.getAdornedList().getAdornedTargetEntityClassname();
 629              ppr.setCeilingEntityClassname(adornedTargetEntityClassname);
 630              ppr.getEntity().setType(new String[] {adornedTargetEntityClassname});
 631  
 632              for (Property property : properties) {
 633                  if (property.getName().equals(ppr.getAdornedList().getLinkedObjectPath() +
 634                                      &quot;.&quot; + ppr.getAdornedList().getLinkedIdProperty())) {
 635                      break;
 636                  }
 637              }
 638  
 639              if (!StringUtils.isEmpty(alternateId)) {
 640                  Property p = new Property();
 641                  p.setName(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);
 642                  p.setValue(alternateId);
 643                  if (!properties.contains(p)) {
 644                      properties.add(p);
 645                  }
 646              }
 647          } else if (md instanceof MapMetadata) {
 648              ppr.getEntity().setType(new String[] { entityForm.getEntityType() });
 649  
 650              Property p = new Property();
 651              p.setName(&quot;symbolicId&quot;);
 652              p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 653              properties.add(p);
 654          } else {
 655              throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was&quot; +
 656                      &quot; not a collection field.&quot;, field.getName(), mainMetadata.getCeilingType()));
 657          }
 658  
 659          String sectionField = field.getName();
 660          if (sectionField.contains(&quot;.&quot;)) {
 661              sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 662          }
 663          ppr.setSectionEntityField(sectionField);
 664  
 665          Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 666          if (parentNameProp != null) {
 667              ppr.setRequestingEntityName(parentNameProp.getValue());
 668          } else {
 669              Property name = parentEntity.getPMap().get(&quot;name&quot;);
 670              if(name !=null) {
 671                  ppr.setRequestingEntityName(name.getValue());
 672              }
 673          }
 674  
 675          Property p = new Property();
 676          p.setName(entityForm.getIdProperty());
 677          p.setValue(collectionItemId);
 678          if (!properties.contains(p)) {
 679              properties.add(p);
 680          }
 681  
 682          Property[] propArr = new Property[properties.size()];
 683          properties.toArray(propArr);
 684          ppr.getEntity().setProperties(propArr);
 685  
 686          return update(ppr);
 687      }
 688  
 689      @Override
<abbr title=" 690      public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentEntity,"> 690      public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentðŸ”µ</abbr>
 691                  String itemId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
<abbr title=" 692          return removeSubCollectionEntity(mainMetadata, field, parentEntity, itemId, null, priorKey, sectionCrumbs);"> 692          return removeSubCollectionEntity(mainMetadata, field, parentEntity, itemId, null, priorKey, sectionCrumbs)ðŸ”µ</abbr>
 693      }
 694  
 695      @Override
<abbr title=" 696      public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentEntity,"> 696      public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentðŸ”µ</abbr>
<abbr title=" 697              String itemId, String alternateId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {"> 697              String itemId, String alternateId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceExðŸ”µ</abbr>
 698          List&lt;Property&gt; properties = new ArrayList&lt;Property&gt;();
 699  
 700          Property p;
 701          String parentId = getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName());
 702  
 703          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(field.getMetadata(), sectionCrumbs)
 704                  .withEntity(new Entity());
 705  
 706          if (field.getMetadata() instanceof BasicCollectionMetadata) {
 707              BasicCollectionMetadata fmd = (BasicCollectionMetadata) field.getMetadata();
 708  
 709              p = new Property();
 710              p.setName(&quot;id&quot;);
 711              p.setValue(itemId);
 712              properties.add(p);
 713  
 714              p = new Property();
 715              p.setName(ppr.getForeignKey().getManyToField());
 716              p.setValue(parentId);
 717              properties.add(p);
 718  
 719              ppr.getEntity().setType(new String[]{fmd.getCollectionCeilingEntity()});
 720          } else if (field.getMetadata() instanceof AdornedTargetCollectionMetadata) {
 721              AdornedTargetList adornedList = ppr.getAdornedList();
 722  
 723              p = new Property();
 724              p.setName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());
 725              p.setValue(parentId);
 726              properties.add(p);
 727  
 728              p = new Property();
 729              p.setName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());
 730              p.setValue(itemId);
 731              properties.add(p);
 732  
 733              if (!StringUtils.isEmpty(alternateId)) {
 734                  p = new Property();
 735                  p.setName(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);
 736                  p.setValue(alternateId);
 737                  properties.add(p);
 738              }
 739  
 740              ppr.getEntity().setType(new String[]{adornedList.getAdornedTargetEntityClassname()});
 741          } else if (field.getMetadata() instanceof MapMetadata) {
 742              MapMetadata fmd = (MapMetadata) field.getMetadata();
 743  
 744              p = new Property();
 745              p.setName(&quot;id&quot;);
 746              p.setValue(itemId);
 747              properties.add(p);
 748  
 749              p = new Property();
 750              p.setName(&quot;symbolicId&quot;);
 751              p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 752              properties.add(p);
 753  
 754              p = new Property();
 755              p.setName(&quot;priorKey&quot;);
 756              p.setValue(priorKey);
 757              properties.add(p);
 758  
 759              MapStructure mapStructure = ppr.getMapStructure();
 760  
 761              p = new Property();
 762              p.setName(mapStructure.getKeyPropertyName());
 763              p.setValue(itemId);
 764              properties.add(p);
 765  
 766              ppr.getEntity().setType(new String[] { fmd.getTargetClass() });
 767          }
 768  
 769          ppr.setCeilingEntityClassname(ppr.getEntity().getType()[0]);
 770          String sectionField = field.getName();
 771          if (sectionField.contains(&quot;.&quot;)) {
 772              sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 773          }
 774          ppr.setSectionEntityField(sectionField);
 775  
 776          Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 777          if (parentNameProp != null) {
 778              ppr.setRequestingEntityName(parentNameProp.getValue());
 779          }
 780  
 781          Property[] propArr = new Property[properties.size()];
 782          properties.toArray(propArr);
 783          ppr.getEntity().setProperties(propArr);
 784  
 785          return remove(ppr);
 786      }
 787  
 788      @Override
 789      public String getContextSpecificRelationshipId(ClassMetadata cmd, Entity entity, String propertyName) {
 790          String prefix;
 791          if (propertyName.contains(&quot;.&quot;)) {
 792              prefix = propertyName.substring(0, propertyName.lastIndexOf(&quot;.&quot;));
 793          } else {
 794              prefix = &quot;&quot;;
 795          }
 796  
 797          if (prefix.equals(&quot;&quot;)) {
 798              return entity.findProperty(&quot;id&quot;).getValue();
 799          } else {
<abbr title=" 800              //we need to check all the parts of the prefix. For example, the prefix could include an @Embedded class like"> 800              //we need to check all the parts of the prefix. For example, the prefix could include an @Embedded claðŸ”µ</abbr>
<abbr title=" 801              //defaultSku.dimension. In this case, we want the id from the defaultSku property, since the @Embedded does"> 801              //defaultSku.dimension. In this case, we want the id from the defaultSku property, since the @EmbeddedðŸ”µ</abbr>
 802              //not have an id property - nor should it.
 803              String[] prefixParts = prefix.split(&quot;\\.&quot;);
 804              for (int j = 0; j &lt; prefixParts.length; j++) {
 805                  StringBuilder sb = new StringBuilder();
 806                  for (int x = 0; x &lt; prefixParts.length - j; x++) {
 807                      sb.append(prefixParts[x]);
 808                      if (x &lt; prefixParts.length - j - 1) {
 809                          sb.append(&quot;.&quot;);
 810                      }
 811                  }
 812                  String tempPrefix = sb.toString();
 813  
 814                  for (Property property : entity.getProperties()) {
 815                      if (property.getName().startsWith(tempPrefix)) {
<abbr title=" 816                          //make sure there is only one &#x27;.&#x27; to ensure we are looking at properties on the current prefix level"> 816                          //make sure there is only one &#x27;.&#x27; to ensure we are looking at properties on the current prðŸ”µ</abbr>
<abbr title=" 817                          //in the case of the prefix defaultSku, we want defaultSku.id not defaultSku.skuAttributes.id"> 817                          //in the case of the prefix defaultSku, we want defaultSku.id not defaultSku.skuAttributesðŸ”µ</abbr>
 818                          if (StringUtils.countMatches(property.getName().replace(tempPrefix, &quot;&quot;), &quot;.&quot;) == 1) {
 819                              if (cmd.getPMap().containsKey(property.getName())) {
<abbr title=" 820                                  BasicFieldMetadata md = (BasicFieldMetadata) cmd.getPMap().get(property.getName()).getMetadata();"> 820                                  BasicFieldMetadata md = (BasicFieldMetadata) cmd.getPMap().get(property.getName())ðŸ”µ</abbr>
 821                                  if (md.getFieldType().equals(SupportedFieldType.ID)) {
 822                                      return property.getValue();
 823                                  }
 824                              }
 825                          }
 826                      }
 827                  }
 828              }
 829          }
 830          if (!prefix.contains(&quot;.&quot;)) {
<abbr title=" 831              //this may be an embedded class directly on the root entity (e.g. embeddablePriceList.restrictedPriceLists on OfferImpl)"> 831              //this may be an embedded class directly on the root entity (e.g. embeddablePriceList.restrictedPriceLðŸ”µ</abbr>
 832              return entity.findProperty(&quot;id&quot;).getValue();
 833          }
 834          throw new RuntimeException(&quot;Unable to establish a relationship id&quot;);
 835      }
 836  
 837      @Override
 838      public String getIdProperty(ClassMetadata cmd) throws ServiceException {
 839          for (Property p : cmd.getProperties()) {
 840              if (p.getMetadata() instanceof BasicFieldMetadata) {
 841                  BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
 842                  //check for ID type and also make sure the field we&#x27;re looking at is not a &quot;ToOne&quot; association
 843                  if (SupportedFieldType.ID.equals(fmd.getFieldType()) &amp;&amp; !p.getName().contains(&quot;.&quot;)) {
 844                      return p.getName();
 845                  }
 846              }
 847          }
 848  
 849          throw new ServiceException(&quot;Could not determine ID field for &quot; + cmd.getCeilingType());
 850      }
 851  
 852      @Override
 853      public PersistenceResponse add(PersistencePackageRequest request) throws ServiceException {
 854          return add(request, true);
 855      }
 856  
 857      @Override
<abbr title=" 858      public PersistenceResponse add(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 858      public PersistenceResponse add(PersistencePackageRequest request, boolean transactional) throws ServiceExceptiðŸ”µ</abbr>
 859          PersistencePackage pkg = persistencePackageFactory.create(request);
 860          try {
 861              if (request.isUpdateLookupType()) {
 862                  if (pkg.getSectionCrumbs() != null &amp;&amp; pkg.getSectionCrumbs().length &gt; 0) {
 863                      SectionCrumb sc = pkg.getSectionCrumbs()[0];
 864                      if (StringUtils.isNotBlank(sc.getSectionIdentifier())) {
 865                          pkg.setSecurityCeilingEntityFullyQualifiedClassname(sc.getSectionIdentifier());
 866                      }
 867                  }
 868                  if (transactional) {
 869                      return service.update(pkg);
 870                  } else {
 871                      return service.nonTransactionalUpdate(pkg);
 872                  }
 873              } else {
 874                  if (transactional) {
 875                      return service.add(pkg);
 876                  } else {
 877                      return service.nonTransactionalAdd(pkg);
 878                  }
 879              }
 880          } catch (ValidationException e) {
 881              ensureEntityMarkedAsValidationFailure(e, request);
 882              return new PersistenceResponse().withEntity(e.getEntity());
 883          }
 884      }
 885  
 886      @Override
 887      public PersistenceResponse update(PersistencePackageRequest request) throws ServiceException {
 888          return update(request, true);
 889      }
 890  
 891      @Override
<abbr title=" 892      public PersistenceResponse update(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 892      public PersistenceResponse update(PersistencePackageRequest request, boolean transactional) throws ServiceExceðŸ”µ</abbr>
 893          PersistencePackage pkg = persistencePackageFactory.create(request);
 894          try {
 895              if (transactional) {
 896                  return service.update(pkg);
 897              } else {
 898                  return service.nonTransactionalUpdate(pkg);
 899              }
 900          } catch (ValidationException e) {
 901              ensureEntityMarkedAsValidationFailure(e, request);
 902              return new PersistenceResponse().withEntity(e.getEntity());
 903          }
 904      }
 905  
 906      @Override
 907      public PersistenceResponse inspect(PersistencePackageRequest request)
 908              throws ServiceException {
 909          PersistencePackage pkg = persistencePackageFactory.create(request);
 910          return service.inspect(pkg);
 911      }
 912  
 913      @Override
 914      public PersistenceResponse remove(PersistencePackageRequest request)
 915              throws ServiceException {
 916          return remove(request, true);
 917      }
 918  
 919      @Override
<abbr title=" 920      public PersistenceResponse remove(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 920      public PersistenceResponse remove(PersistencePackageRequest request, boolean transactional) throws ServiceExceðŸ”µ</abbr>
 921          PersistencePackage pkg = persistencePackageFactory.create(request);
 922          try {
 923              if (transactional) {
 924                  return service.remove(pkg);
 925              } else {
 926                  return service.nonTransactionalRemove(pkg);
 927              }
 928          } catch (ValidationException e) {
 929              ensureEntityMarkedAsValidationFailure(e, request);
 930              return new PersistenceResponse().withEntity(e.getEntity());
 931          }
 932      }
 933  
 934      /**
 935       * &lt;p&gt;
<abbr title=" 936       * Should be invoked when a {@link ValidationException} is thrown to verify that the {@link Entity} contained within the"> 936       * Should be invoked when a {@link ValidationException} is thrown to verify that the {@link Entity} contained ðŸ”µ</abbr>
 937       * given &lt;b&gt;originalRequest&lt;/b&gt; has a validationFailure = true
 938       *
 939       * &lt;p&gt;
 940       * This will also check for a cause of {@link ConstraintViolationException} and add a gloal error to that.
 941       */
<abbr title=" 942      protected void ensureEntityMarkedAsValidationFailure(ValidationException e, PersistencePackageRequest originalRequest) {"> 942      protected void ensureEntityMarkedAsValidationFailure(ValidationException e, PersistencePackageRequest originalðŸ”µ</abbr>
 943          if (e.containsCause(ConstraintViolationException.class)) {
 944              e.getEntity().addGlobalValidationError(&quot;constraintViolationError&quot;);
 945          } else if (!e.getEntity().isValidationFailure()) {
 946              e.getEntity().setValidationFailure(true);
 947              e.getEntity().addGlobalValidationError(e.getMessage());
 948          }
 949      }
 950  
 951      @Override
 952      public PersistenceResponse fetch(PersistencePackageRequest request)
 953              throws ServiceException {
 954          PersistencePackage pkg = persistencePackageFactory.create(request);
 955  
 956          CriteriaTransferObject cto = getDefaultCto();
 957          if (request.getFilterAndSortCriteria() != null) {
 958              cto.addAll(Arrays.asList(request.getFilterAndSortCriteria()));
 959          }
 960  
 961          if (request.getMaxResults() != null) {
 962              cto.setMaxResults(request.getMaxResults());
 963          }
 964  
 965          if (request.getStartIndex() == null) {
 966              cto.setFirstResult(0);
 967          } else {
 968              cto.setFirstResult(request.getStartIndex());
 969          }
 970  
 971          if (request.getMaxIndex() != null) {
 972              Integer startIndex = request.getStartIndex() != null ? request.getStartIndex() : 0;
 973              int requestedMaxResults = request.getMaxIndex() - startIndex + 1;
 974              if (requestedMaxResults &gt;= 0 &amp;&amp; requestedMaxResults &lt; cto.getMaxResults()) {
 975                  cto.setMaxResults(requestedMaxResults);
 976              }
 977          }
 978  
 979          cto.setLastId(request.getLastId());
 980          cto.setFirstId(request.getFirstId());
 981          cto.setUpperCount(request.getUpperCount());
 982          cto.setLowerCount(request.getLowerCount());
 983          if (request.getPageSize() != null) {
 984              cto.setMaxResults(request.getPageSize());
 985          }
 986          cto.setPresentationFetch(request.getPresentationFetch());
 987  









 988          return service.fetch(pkg, cto);
 989      }
 990  
 991      protected CriteriaTransferObject getDefaultCto() {
 992          CriteriaTransferObject cto = new CriteriaTransferObject();
 993          cto.setMaxResults(getDefaultMaxResults());
 994          return cto;
 995      }
 996  
 997      @Override
 998      public String getForeignEntityName(String owningClass, String id) {
 999          if (owningClass == null || id == null) {
1000              return null;
1001          }
1002  
1003          DynamicEntityDao dynamicEntityDao = getDynamicEntityDao(owningClass);
1004          Class&lt;?&gt; clazz = dynamicEntityDao.getImplClass(owningClass);
1005          Object foreignEntity = dynamicEntityDao.find(clazz, toIdFieldType(id, clazz));
1006  
1007          if (foreignEntity instanceof AdminMainEntity) {
1008              return ((AdminMainEntity) foreignEntity).getMainEntityName();
1009          }
1010  
1011          return null;
1012      }
1013  
1014      protected DynamicEntityDao getDynamicEntityDao(String owningClass) {
1015          return PersistenceManagerFactory.getPersistenceManager(owningClass).getDynamicEntityDao();
1016      }
1017  
1018      protected int getDefaultMaxResults() {
1019          return BLCSystemProperty.resolveIntSystemProperty(&quot;admin.default.max.results&quot;, 50);
1020      }
1021  
1022      protected Object toIdFieldType(String id, Class&lt;?&gt; entityClass) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1023 -        Class&lt;?&gt; idFieldClass = dynamicDaoHelper.getIdField(entityClass, em).getType();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1024 +        Class&lt;?&gt; idFieldClass = dynamicDaoHelper.getIdField(entityClass).getType();</span>
1025          if (Long.class.isAssignableFrom(idFieldClass)) {
1026              return Long.parseLong(id);
1027          } else if (Integer.class.isAssignableFrom(idFieldClass)) {
1028              return Integer.parseInt(id);
1029          }
1030          return id;
1031      }
1032  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.server.service;
  19  
  20  import org.apache.commons.lang3.ArrayUtils;
  21  import org.apache.commons.lang3.StringUtils;
  22  import org.apache.commons.logging.Log;
  23  import org.apache.commons.logging.LogFactory;
  24  import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  25  import org.broadleafcommerce.common.exception.ServiceException;
  26  import org.broadleafcommerce.common.persistence.EntityConfiguration;
  27  import org.broadleafcommerce.common.presentation.client.AddMethodType;
  28  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  29  import org.broadleafcommerce.common.util.BLCMessageUtils;
  30  import org.broadleafcommerce.common.util.BLCSystemProperty;
  31  import org.broadleafcommerce.common.util.dao.DynamicDaoHelper;
  32  import org.broadleafcommerce.common.util.dao.DynamicDaoHelperImpl;
  33  import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  34  import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  35  import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  36  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  37  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  38  import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  39  import org.broadleafcommerce.openadmin.dto.CriteriaTransferObject;
  40  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  41  import org.broadleafcommerce.openadmin.dto.Entity;
  42  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  43  import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  44  import org.broadleafcommerce.openadmin.dto.GroupMetadata;
  45  import org.broadleafcommerce.openadmin.dto.MapMetadata;
  46  import org.broadleafcommerce.openadmin.dto.MapStructure;
  47  import org.broadleafcommerce.openadmin.dto.PersistencePackage;
  48  import org.broadleafcommerce.openadmin.dto.Property;
  49  import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  50  import org.broadleafcommerce.openadmin.dto.TabMetadata;
  51  import org.broadleafcommerce.openadmin.exception.EntityNotFoundException;
  52  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  53  import org.broadleafcommerce.openadmin.server.domain.FetchPageRequest;
  54  import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  55  import org.broadleafcommerce.openadmin.server.factory.PersistencePackageFactory;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +import org.broadleafcommerce.openadmin.server.service.extension.CriteriaTransferObjectExtensionManager;</span>
  57  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  58  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
  59  import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  60  import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  61  import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  62  import org.broadleafcommerce.openadmin.web.form.entity.Field;
  63  import org.broadleafcommerce.openadmin.web.form.entity.Tab;
  64  import org.hibernate.exception.ConstraintViolationException;
  65  import org.springframework.stereotype.Service;
  66  
  67  import java.util.ArrayList;
  68  import java.util.Arrays;
  69  import java.util.HashMap;
  70  import java.util.List;
  71  import java.util.ListIterator;
  72  import java.util.Map;
  73  import java.util.Map.Entry;
  74  
  75  import javax.annotation.Resource;
  76  import javax.persistence.EntityManager;
  77  import javax.persistence.PersistenceContext;
  78  
  79  /**
  80   * @author Andre Azzolini (apazzolini)
  81   */
  82  @Service(&quot;blAdminEntityService&quot;)
  83  public class AdminEntityServiceImpl implements AdminEntityService {
  84  
  85      protected static final Log LOG = LogFactory.getLog(AdminEntityServiceImpl.class);
  86  
  87      @Resource(name = &quot;blDynamicEntityRemoteService&quot;)
  88      protected DynamicEntityService service;
  89  
  90      @Resource(name = &quot;blPersistencePackageFactory&quot;)
  91      protected PersistencePackageFactory persistencePackageFactory;
  92  
  93      @PersistenceContext(unitName = &quot;blPU&quot;)
  94      protected EntityManager em;
  95  
  96      @Resource(name = &quot;blEntityConfiguration&quot;)
  97      protected EntityConfiguration entityConfiguration;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +    @Resource</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +    protected CriteriaTransferObjectExtensionManager extensionManager;</span>
 101  
 102      protected DynamicDaoHelper dynamicDaoHelper = new DynamicDaoHelperImpl();
 103  
 104      @Override
 105      public PersistenceResponse getClassMetadata(PersistencePackageRequest request)
 106              throws ServiceException {
 107          PersistenceResponse response = inspect(request);
 108          ClassMetadata cmd = response.getDynamicResultSet().getClassMetaData();
 109          cmd.setCeilingType(request.getCeilingEntityClassname());
 110          cmd.setSecurityCeilingType(request.getSecurityCeilingEntityClassname());
 111          return response;
 112      }
 113  
 114      @Override
 115      public PersistenceResponse getRecords(PersistencePackageRequest request) throws ServiceException {
 116          return fetch(request);
 117      }
 118  
 119      @Override
<abbr title=" 120      public PersistenceResponse getRecord(PersistencePackageRequest request, String id, ClassMetadata cmd, boolean isCollectionRequest)"> 120      public PersistenceResponse getRecord(PersistencePackageRequest request, String id, ClassMetadata cmd, boolean ðŸ”µ</abbr>
 121              throws ServiceException {
 122          String idProperty = getIdProperty(cmd);
 123  
 124          FilterAndSortCriteria fasc = new FilterAndSortCriteria(idProperty);
 125          fasc.setFilterValue(id);
 126          request.addFilterAndSortCriteria(fasc);
 127  
 128          PersistenceResponse response = fetch(request);
 129          Entity[] entities = response.getDynamicResultSet().getRecords();
 130          if (ArrayUtils.isEmpty(entities)) {
 131              String celiningEntity = request.getCeilingEntityClassname();
<abbr title=" 132              throw new EntityNotFoundException(String.format(&quot;Could not find Entity %s with ID %s&quot;, celiningEntity, id));"> 132              throw new EntityNotFoundException(String.format(&quot;Could not find Entity %s with ID %s&quot;, celiningEntity,ðŸ”µ</abbr>
 133          }
 134  
 135          return response;
 136      }
 137  
 138      @Override
<abbr title=" 139      public PersistenceResponse addEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 139      public PersistenceResponse addEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectioðŸ”µ</abbr>
 140          PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);
 141          // If the entity form has dynamic forms inside of it, we need to persist those as well.
 142          // They are typically done in their own custom persistence handlers, which will get triggered
 143          // based on the criteria specific in the PersistencePackage.
 144          for (Entry&lt;String, EntityForm&gt; entry : entityForm.getDynamicForms().entrySet()) {
 145              DynamicEntityFormInfo info = entityForm.getDynamicFormInfo(entry.getKey());
 146  
 147              if (info.getCustomCriteriaOverride() != null) {
 148                  customCriteria = info.getCustomCriteriaOverride();
 149              } else {
 150                  String propertyName = info.getPropertyName();
 151                  String propertyValue;
 152                  if (entityForm.getFields().containsKey(propertyName)) {
 153                      propertyValue = entityForm.findField(propertyName).getValue();
 154                  } else {
 155                      propertyValue = info.getPropertyValue();
 156                  }
<abbr title=" 157                  customCriteria = new String[] {info.getCriteriaName(), entityForm.getId(), propertyName, propertyValue};"> 157                  customCriteria = new String[] {info.getCriteriaName(), entityForm.getId(), propertyName, propertyVðŸ”µ</abbr>
 158              }
 159  
<abbr title=" 160              PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectionCrumb);"> 160              PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectiðŸ”µ</abbr>
 161              ppr.addSubRequest(info.getPropertyName(), subRequest);
 162          }
 163          return add(ppr);
 164      }
 165  
 166      @Override
<abbr title=" 167      public PersistenceResponse updateEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 167      public PersistenceResponse updateEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; secðŸ”µ</abbr>
 168          PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);
 169          ppr.setRequestingEntityName(entityForm.getMainEntityName());
 170          // If the entity form has dynamic forms inside of it, we need to persist those as well.
 171          // They are typically done in their own custom persistence handlers, which will get triggered
 172          // based on the criteria specific in the PersistencePackage.
 173          for (Entry&lt;String, EntityForm&gt; entry : entityForm.getDynamicForms().entrySet()) {
 174              DynamicEntityFormInfo info = entityForm.getDynamicFormInfo(entry.getKey());
 175  
 176              if (info.getCustomCriteriaOverride() != null) {
 177                  customCriteria = info.getCustomCriteriaOverride();
 178              } else {
 179                  String propertyName = info.getPropertyName();
 180                  String propertyValue = entityForm.findField(propertyName).getValue();
<abbr title=" 181                  customCriteria = new String[] { info.getCriteriaName(), entityForm.getId(), propertyName, propertyValue };"> 181                  customCriteria = new String[] { info.getCriteriaName(), entityForm.getId(), propertyName, propertyðŸ”µ</abbr>
 182              }
 183  
<abbr title=" 184              PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectionCrumb);"> 184              PersistencePackageRequest subRequest = getRequestForEntityForm(entry.getValue(), customCriteria, sectiðŸ”µ</abbr>
 185              subRequest.withSecurityCeilingEntityClassname(info.getSecurityCeilingClassName());
 186              ppr.addSubRequest(info.getPropertyName(), subRequest);
 187          }
 188          return update(ppr);
 189      }
 190  
 191      @Override
<abbr title=" 192      public PersistenceResponse removeEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumb)"> 192      public PersistenceResponse removeEntity(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; secðŸ”µ</abbr>
 193              throws ServiceException {
 194          PersistencePackageRequest ppr = getRequestForEntityForm(entityForm, customCriteria, sectionCrumb);
 195          return remove(ppr);
 196      }
 197  
 198      protected List&lt;Property&gt; getPropertiesFromEntityForm(EntityForm entityForm) {
 199          List&lt;Property&gt; properties = new ArrayList&lt;Property&gt;(entityForm.getFields().size());
 200  
 201          for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
 202              Property p = new Property();
 203              p.setName(entry.getKey());
 204              p.setValue(entry.getValue().getValue());
 205              p.setDisplayValue(entry.getValue().getDisplayValue());
 206              p.setIsDirty(entry.getValue().getIsDirty());
 207              properties.add(p);
 208          }
 209  
 210          return properties;
 211      }
 212  

<abbr title=" 213      public PersistencePackageRequest getRequestForEntityForm(EntityForm entityForm, String[] customCriteria, List&lt;SectionCrumb&gt; sectionCrumbs) {"> 213      public PersistencePackageRequest getRequestForEntityForm(EntityForm entityForm, String[] customCriteria, List&lt;ðŸ”µ</abbr>
 214          // Ensure the ID property is on the form
 215          Field idField = entityForm.findField(entityForm.getIdProperty());
 216          if (idField == null) {
 217              idField = new Field();
 218              idField.setName(entityForm.getIdProperty());
 219              idField.setValue(entityForm.getId());
 220              entityForm.getFields().put(entityForm.getIdProperty(), idField);
 221          } else {
 222              idField.setValue(entityForm.getId());
 223          }
 224  
 225          List&lt;Property&gt; propList = getPropertiesFromEntityForm(entityForm);
 226          Property[] properties = new Property[propList.size()];
 227          properties = propList.toArray(properties);
 228  
 229          Entity entity = new Entity();
 230          entity.setProperties(properties);
 231          String entityType = entityForm.getEntityType();
 232          if (StringUtils.isEmpty(entityType)) {
 233              entityType = entityForm.getCeilingEntityClassname();
 234          }
 235          entity.setType(new String[]{entityType});
 236  
 237          PersistencePackageRequest ppr = PersistencePackageRequest.standard()
 238                  .withEntity(entity)
 239                  .withCustomCriteria(customCriteria)
 240                  .withCeilingEntityClassname(entityForm.getCeilingEntityClassname())
 241                  .withSectionCrumbs(sectionCrumbs)
 242                  .withRequestingEntityName(entityForm.getMainEntityName());
 243          return ppr;
 244      }
 245  
 246      @Override
<abbr title=" 247      public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containingEntity,"> 247      public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containinðŸ”µ</abbr>
<abbr title=" 248              Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternateId)"> 248              Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternaðŸ”µ</abbr>
 249              throws ServiceException {
<abbr title=" 250          return getAdvancedCollectionRecord(containingClassMetadata, containingEntity, collectionProperty, collectionItemId, sectionCrumbs, alternateId, null);"> 250          return getAdvancedCollectionRecord(containingClassMetadata, containingEntity, collectionProperty, collectiðŸ”µ</abbr>
 251      }
 252  
 253      @Override
<abbr title=" 254      public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containingEntity,"> 254      public PersistenceResponse getAdvancedCollectionRecord(ClassMetadata containingClassMetadata, Entity containinðŸ”µ</abbr>
<abbr title=" 255              Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternateId,"> 255              Property collectionProperty, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumbs, String alternaðŸ”µ</abbr>
 256              String[] customCriteria) throws ServiceException {
<abbr title=" 257          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sectionCrumbs);"> 257          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sðŸ”µ</abbr>
 258  
 259          ppr.addCustomCriteria(customCriteria);
 260  
 261          FieldMetadata md = collectionProperty.getMetadata();
 262          String containingEntityId = getContextSpecificRelationshipId(containingClassMetadata, containingEntity,
 263                  collectionProperty.getName());
 264          ppr.setSectionEntityField(collectionProperty.getName());
 265  
 266          PersistenceResponse response;
 267  
 268          if (md instanceof AdornedTargetCollectionMetadata) {
 269              FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName());
 270              fasc.setFilterValue(containingEntityId);
 271              ppr.addFilterAndSortCriteria(fasc);
 272  
 273              fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName() + &quot;Target&quot;);
 274              fasc.setFilterValue(collectionItemId);
 275              ppr.addFilterAndSortCriteria(fasc);
 276  
 277              if (!StringUtils.isEmpty(alternateId)) {
 278                  fasc = new FilterAndSortCriteria(ppr.getAdornedList().getIdProperty());
 279                  fasc.setFilterValue(alternateId);
 280                  ppr.addFilterAndSortCriteria(fasc);
 281              }
 282  
 283              response = fetch(ppr);
 284              Entity[] entities = response.getDynamicResultSet().getRecords();
 285              if (ArrayUtils.isEmpty(entities)) {
 286                  String altId = (!StringUtils.isEmpty(alternateId)) ? alternateId : &quot;&quot;;
<abbr title=" 287                  throw new EntityNotFoundException(String.format(&quot;Could not find Entity for [%s], field [%s], id [%s], targetId [%s], alternateId [%s] &quot;,"> 287                  throw new EntityNotFoundException(String.format(&quot;Could not find Entity for [%s], field [%s], id [%ðŸ”µ</abbr>
<abbr title=" 288                          ppr.getCeilingEntityClassname(), ppr.getAdornedList().getCollectionFieldName(), containingEntityId, collectionItemId, altId));"> 288                          ppr.getCeilingEntityClassname(), ppr.getAdornedList().getCollectionFieldName(), containingðŸ”µ</abbr>
 289              }
 290          } else if (md instanceof MapMetadata) {
 291              MapMetadata mmd = (MapMetadata) md;
 292              FilterAndSortCriteria fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 293              fasc.setFilterValue(containingEntityId);
 294              ppr.addFilterAndSortCriteria(fasc);
 295  
 296              response = fetch(ppr);
 297              Entity[] entities = response.getDynamicResultSet().getRecords();
 298              for (Entity e : entities) {
 299                  String idProperty = getIdProperty(containingClassMetadata);
 300                  if (mmd.isSimpleValue()) {
 301                      idProperty = &quot;key&quot;;
 302                  }
 303                  Property p = e.getPMap().get(idProperty);
 304                  if (p.getValue().equals(collectionItemId)) {
 305                      response.setEntity(e);
 306                      break;
 307                  }
 308              }
 309          } else {
<abbr title=" 310              throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not an &quot; +"> 310              throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not an &quot;ðŸ”µ</abbr>
<abbr title=" 311                      &quot;advanced collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingType()));"> 311                      &quot;advanced collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingðŸ”µ</abbr>
 312          }
 313  
 314          return response;
 315      }
 316  
 317      @Override
<abbr title=" 318      public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 318      public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntðŸ”µ</abbr>
<abbr title=" 319              Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxIndex, List&lt;SectionCrumb&gt; sectionCrumb)"> 319              Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxIndex, ListðŸ”µ</abbr>
 320              throws ServiceException {
<abbr title=" 321          return getRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fascs, startIndex,"> 321          return getRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fascs, startðŸ”µ</abbr>
 322                  maxIndex, null, sectionCrumb);
 323      }
 324  
 325      @Override
<abbr title=" 326      public PersistenceResponse getPagedRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 326      public PersistenceResponse getPagedRecordsForCollection(ClassMetadata containingClassMetadata, Entity containiðŸ”µ</abbr>
 327              Property collectionProperty, FilterAndSortCriteria[] fascs, FetchPageRequest fetchPageRequest,
 328              String idValueOverride, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
<abbr title=" 329          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sectionCrumbs)"> 329          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(collectionProperty.getMetadata(), sðŸ”µ</abbr>
 330              .withFilterAndSortCriteria(fascs)
 331              .withStartIndex(fetchPageRequest.getStartIndex())
 332              .withMaxIndex(fetchPageRequest.getMaxIndex())
 333              .withFirstId(fetchPageRequest.getFirstId())
 334              .withLastId(fetchPageRequest.getLastId())
 335              .withLowerCount(fetchPageRequest.getLowerCount())
 336              .withUpperCount(fetchPageRequest.getUpperCount())
 337              .withPageSize(fetchPageRequest.getPageSize())
 338              .withPresentationFetch(true);
 339  
 340          FilterAndSortCriteria fasc;
 341  
 342          FieldMetadata md = collectionProperty.getMetadata();
 343          String collectionCeilingClass = null;
 344  
 345          if (md instanceof BasicCollectionMetadata) {
 346              fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 347              collectionCeilingClass = ((CollectionMetadata) md).getCollectionCeilingEntity();
 348          } else if (md instanceof AdornedTargetCollectionMetadata) {
 349              fasc = new FilterAndSortCriteria(ppr.getAdornedList().getCollectionFieldName());
 350              collectionCeilingClass = ((CollectionMetadata) md).getCollectionCeilingEntity();
 351          } else if (md instanceof MapMetadata) {
 352              fasc = new FilterAndSortCriteria(ppr.getForeignKey().getManyToField());
 353          } else {
<abbr title=" 354              throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not a &quot; +"> 354              throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was not a &quot; ðŸ”µ</abbr>
 355                      &quot;collection field.&quot;, collectionProperty.getName(), containingClassMetadata.getCeilingType()));
 356          }
 357  
 358          String id;
 359          if (idValueOverride == null) {
<abbr title=" 360              id = getContextSpecificRelationshipId(containingClassMetadata, containingEntity, collectionProperty.getName());"> 360              id = getContextSpecificRelationshipId(containingClassMetadata, containingEntity, collectionProperty.geðŸ”µ</abbr>
 361          } else {
 362              id = idValueOverride;
 363          }
 364          fasc.setFilterValue(id);
 365          ppr.addFilterAndSortCriteria(fasc);
 366  
 367          if (collectionCeilingClass != null) {
 368              ppr.setCeilingEntityClassname(collectionCeilingClass);
 369          }
 370          ppr.setSectionEntityField(collectionProperty.getName());
 371  
 372          return fetch(ppr);
 373      }
 374  
 375      @Override
<abbr title=" 376      public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntity,"> 376      public PersistenceResponse getRecordsForCollection(ClassMetadata containingClassMetadata, Entity containingEntðŸ”µ</abbr>
 377              Property collectionProperty, FilterAndSortCriteria[] fascs, Integer startIndex, Integer maxIndex,
 378              String idValueOverride, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
 379          FetchPageRequest pageRequest = new FetchPageRequest().withStartIndex(startIndex).withMaxIndex(maxIndex);
 380          return getPagedRecordsForCollection(containingClassMetadata, containingEntity, collectionProperty, fascs,
 381                  pageRequest, idValueOverride, sectionCrumbs);
 382      }
 383  
 384      @Override
<abbr title=" 385      public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity containingEntity, Integer startIndex, Integer maxIndex, List&lt;SectionCrumb&gt; sectionCrumb)"> 385      public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity contðŸ”µ</abbr>
 386              throws ServiceException {
 387          Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;String, DynamicResultSet&gt;();
 388  
 389          PersistenceResponse response = getClassMetadata(ppr);
 390          ClassMetadata cmd = response.getDynamicResultSet().getClassMetaData();
 391          for (Property p : cmd.getProperties()) {
 392              if (ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), containingEntity.getType()[0])
 393                      &amp;&amp; p.getMetadata() instanceof CollectionMetadata) {
<abbr title=" 394                  PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, startIndex, maxIndex, sectionCrumb);"> 394                  PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, startIndexðŸ”µ</abbr>
 395                  map.put(p.getName(), response2.getDynamicResultSet());
 396              }
 397          }
 398  
 399          return map;
 400      }
 401  
 402      @Override
<abbr title=" 403      public Map&lt;String, DynamicResultSet&gt; getAllRecordsForAllSubCollections(ClassMetadata cmd, Entity containingEntity,"> 403      public Map&lt;String, DynamicResultSet&gt; getAllRecordsForAllSubCollections(ClassMetadata cmd, Entity containingEntðŸ”µ</abbr>
<abbr title=" 404                                                                             List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException {"> 404                                                                             List&lt;SectionCrumb&gt; sectionCrumb) throwsðŸ”µ</abbr>
 405          Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;&gt;();
 406          for (Property p : cmd.getProperties()) {
 407              FieldMetadata fieldMetadata = p.getMetadata();
<abbr title=" 408              boolean fieldAvailable = ArrayUtils.contains(fieldMetadata.getAvailableToTypes(), containingEntity.getType()[0]);"> 408              boolean fieldAvailable = ArrayUtils.contains(fieldMetadata.getAvailableToTypes(), containingEntity.getðŸ”µ</abbr>
 409              if (fieldAvailable &amp;&amp; fieldMetadata instanceof CollectionMetadata) {
 410                  FetchPageRequest pageRequest = new FetchPageRequest()
 411                          .withPageSize(Integer.MAX_VALUE);
<abbr title=" 412                  PersistenceResponse resp = getPagedRecordsForCollection(cmd, containingEntity, p, null, pageRequest, null, sectionCrumb);"> 412                  PersistenceResponse resp = getPagedRecordsForCollection(cmd, containingEntity, p, null, pageRequesðŸ”µ</abbr>
 413                  map.put(p.getName(), resp.getDynamicResultSet());
 414              }
 415          }
 416          return map;
 417      }
 418  
 419      @Override
<abbr title=" 420      public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity containingEntity, List&lt;SectionCrumb&gt; sectionCrumb)"> 420      public Map&lt;String, DynamicResultSet&gt; getRecordsForAllSubCollections(PersistencePackageRequest ppr, Entity contðŸ”µ</abbr>
 421              throws ServiceException {
 422  
 423          return getRecordsForAllSubCollections(ppr, containingEntity, null, null, sectionCrumb);
 424      }
 425  
 426      @Override
<abbr title=" 427      public Map&lt;String, DynamicResultSet&gt; getRecordsForSelectedTab(ClassMetadata cmd, Entity containingEntity, List&lt;SectionCrumb&gt; sectionCrumb,"> 427      public Map&lt;String, DynamicResultSet&gt; getRecordsForSelectedTab(ClassMetadata cmd, Entity containingEntity, ListðŸ”µ</abbr>
 428              String currentTabName) throws ServiceException {
 429          Map&lt;String, DynamicResultSet&gt; map = new HashMap&lt;String, DynamicResultSet&gt;();
 430          for (Property p : cmd.getProperties()) {
 431              if (ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), containingEntity.getType()[0])
 432                      &amp;&amp; p.getMetadata() instanceof CollectionMetadata) {
 433  
 434                  CollectionMetadata collectionMetadata = (CollectionMetadata) p.getMetadata();
 435  
 436                  // Give preference to the Group since EntityForm.addListGrid() gives preference to the Group
 437                  TabMetadata tabMetadata = cmd.getTabMetadataUsingGroupKey(collectionMetadata.getGroup());
 438                  if (tabMetadata == null) {
 439                      tabMetadata = cmd.getTabMetadataUsingTabKey(collectionMetadata.getTab());
 440                  }
 441  
 442                  String tabName = tabMetadata == null ? collectionMetadata.getTab() : tabMetadata.getTabName();
 443                  int tabOrder = tabMetadata == null ? collectionMetadata.getTabOrder() : tabMetadata.getTabOrder();
 444                  updateTabInfo(collectionMetadata, cmd, tabName, tabOrder);
 445  
 446                  if (collectionMetadata.getLazyFetch() != null &amp;&amp; collectionMetadata.getLazyFetch()
 447                          &amp;&amp; tabName.toUpperCase().startsWith(currentTabName.toUpperCase())
 448                          &amp;&amp; !collectionMetadata.getManualFetch()) {
<abbr title=" 449                      PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, null, sectionCrumb);"> 449                      PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, ðŸ”µ</abbr>
 450                      map.put(p.getName(), response2.getDynamicResultSet());
 451                  } else if (collectionMetadata.getLazyFetch() != null &amp;&amp; !collectionMetadata.getLazyFetch()
 452                          &amp;&amp; !collectionMetadata.getManualFetch()) {
<abbr title=" 453                      PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, null, sectionCrumb);"> 453                      PersistenceResponse response2 = getRecordsForCollection(cmd, containingEntity, p, null, null, ðŸ”µ</abbr>
 454                      map.put(p.getName(), response2.getDynamicResultSet());
 455                  } else {
 456                      DynamicResultSet drs = new DynamicResultSet();
 457                      Map&lt;String, Tab&gt; tabMap = new HashMap&lt;String, Tab&gt;();
 458                      Tab tab = new Tab();
 459                      tab.setKey(tabName);
 460                      tab.setTitle(BLCMessageUtils.getMessage(tabName));
 461                      tab.setOrder(tabOrder);
 462                      tabMap.put(tab.getTitle(), tab);
 463                      drs.setUnselectedTabMetadata(tabMap);
 464                      drs.setTotalRecords(0);
 465                      drs.setStartIndex(0);
 466                      drs.setBatchId(1);
 467                      drs.setClassMetaData(null);
 468                      drs.setPageSize(1);
 469                      drs.setRecords(new Entity[0]);
 470                      map.put(p.getName(), drs);
 471                  }
 472              }
 473          }
 474  
 475          return map;
 476      }
 477  
 478      protected void updateTabInfo(CollectionMetadata fmd, ClassMetadata cmd, String tabName, int tabOrder) {
 479          boolean tabInfoFound = false;
 480          Map&lt;String, TabMetadata&gt; tabMetadataMap = cmd.getTabAndGroupMetadata();
 481          for (String tabKey : tabMetadataMap.keySet()) {
 482              Map&lt;String, GroupMetadata&gt; groupMetadataMap = tabMetadataMap.get(tabKey).getGroupMetadata();
 483              for (String groupKey : groupMetadataMap.keySet()) {
<abbr title=" 484                  if (groupKey.equals(fmd.getGroup()) || groupMetadataMap.get(groupKey).getGroupName().equals(fmd.getGroup())) {"> 484                  if (groupKey.equals(fmd.getGroup()) || groupMetadataMap.get(groupKey).getGroupName().equals(fmd.geðŸ”µ</abbr>
 485                      tabName = tabMetadataMap.get(tabKey).getTabName();
 486                      tabOrder = tabMetadataMap.get(tabKey).getTabOrder();
 487                      tabInfoFound = true;
 488                      break;
 489                  }
 490              }
 491              if (tabInfoFound) {
 492                  break;
 493              }
 494              if (tabKey.equals(tabName) || tabMetadataMap.get(tabKey).getTabName().equals(tabName)) {
 495                  tabName = tabMetadataMap.get(tabKey).getTabName();
 496                  tabOrder = tabMetadataMap.get(tabKey).getTabOrder();
 497              }
 498          }
 499      }
 500  
 501      @Override
<abbr title=" 502      public PersistenceResponse addSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property field,"> 502      public PersistenceResponse addSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property ðŸ”µ</abbr>
 503              Entity parentEntity, List&lt;SectionCrumb&gt; sectionCrumbs)
 504              throws ServiceException, ClassNotFoundException {
 505          // Assemble the properties from the entity form
 506          List&lt;Property&gt; properties = getPropertiesFromEntityForm(entityForm);
 507  
 508          FieldMetadata md = field.getMetadata();
 509  
 510          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 511                  .withEntity(new Entity());
 512          ppr.getEntity().setIsPreAdd(parentEntity.isPreAdd());
 513  
 514          if (md instanceof BasicCollectionMetadata) {
 515              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 516              ppr.getEntity().setType(new String[] { entityForm.getEntityType() });
 517  
 518              // If we&#x27;re looking up an entity instead of trying to create one on the fly, let&#x27;s make sure
 519              // that we&#x27;re not changing the target entity at all and only creating the association to the id
 520              if (fmd.getAddMethodType().equals(AddMethodType.LOOKUP) ||
 521                      fmd.getAddMethodType().equals(AddMethodType.LOOKUP_FOR_UPDATE)) {
 522                  List&lt;String&gt; fieldsToRemove = new ArrayList&lt;String&gt;();
 523  
 524                  String idProp = getIdProperty(mainMetadata);
 525                  for (String key : entityForm.getFields().keySet()) {
 526                      if (!idProp.equals(key)) {
 527                          fieldsToRemove.add(key);
 528                      }
 529                  }
 530  
 531                  for (String key : fieldsToRemove) {
 532                      ListIterator&lt;Property&gt; li = properties.listIterator();
 533                      while (li.hasNext()) {
 534                          if (li.next().getName().equals(key)) {
 535                              li.remove();
 536                          }
 537                      }
 538                  }
 539  
 540                  ppr.setValidateUnsubmittedProperties(false);
 541              }
 542  
 543              if (fmd.getAddMethodType().equals(AddMethodType.LOOKUP_FOR_UPDATE)) {
 544                  ppr.setUpdateLookupType(true);
 545              }
 546  
 547              Property fp = new Property();
 548              fp.setName(ppr.getForeignKey().getManyToField());
 549              fp.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 550              properties.add(fp);
 551          } else if (md instanceof AdornedTargetCollectionMetadata) {
 552              ppr.getEntity().setType(new String[] { ppr.getAdornedList().getAdornedTargetEntityClassname() });
 553  
 554              String[] maintainedFields = ((AdornedTargetCollectionMetadata) md).getMaintainedAdornedTargetFields();
 555              if (maintainedFields == null || maintainedFields.length == 0) {
 556                  ppr.setValidateUnsubmittedProperties(false);
 557              }









 558          } else if (md instanceof MapMetadata) {
 559              ppr.getEntity().setType(new String[] { entityForm.getEntityType() });
 560  
 561              Property p = new Property();
 562              p.setName(&quot;symbolicId&quot;);
 563              p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 564              properties.add(p);
 565          } else {
 566              throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was&quot; +
 567                      &quot; not a collection field.&quot;, field.getName(), mainMetadata.getCeilingType()));
 568          }
 569  
 570          ppr.setCeilingEntityClassname(ppr.getEntity().getType()[0]);
 571          String sectionField = field.getName();
 572          if (sectionField.contains(&quot;.&quot;)) {
 573              sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 574          }
 575          ppr.setSectionEntityField(sectionField);
 576  
 577          Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 578          if (parentNameProp != null) {
 579              ppr.setRequestingEntityName(parentNameProp.getValue());
 580          }else {
 581              Property name = parentEntity.getPMap().get(&quot;name&quot;);
 582              if(name !=null) {
 583                  ppr.setRequestingEntityName(name.getValue());
 584              }
 585          }
 586          Property[] propArr = new Property[properties.size()];
 587          properties.toArray(propArr);
 588          ppr.getEntity().setProperties(propArr);
 589  
 590          return add(ppr);
 591      }
 592  
 593      @Override
<abbr title=" 594      public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property"> 594      public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, ProperðŸ”µ</abbr>
<abbr title=" 595              field, Entity parentEntity, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceException, ClassNotFoundException {"> 595              field, Entity parentEntity, String collectionItemId, List&lt;SectionCrumb&gt; sectionCrumb) throws ServiceExðŸ”µ</abbr>
<abbr title=" 596          return updateSubCollectionEntity(entityForm, mainMetadata, field, parentEntity, collectionItemId, null, sectionCrumb);"> 596          return updateSubCollectionEntity(entityForm, mainMetadata, field, parentEntity, collectionItemId, null, seðŸ”µ</abbr>
 597      }
 598  
 599      @Override
<abbr title=" 600      public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, Property field,"> 600      public PersistenceResponse updateSubCollectionEntity(EntityForm entityForm, ClassMetadata mainMetadata, ProperðŸ”µ</abbr>
 601              Entity parentEntity, String collectionItemId, String alternateId, List&lt;SectionCrumb&gt; sectionCrumbs)
 602              throws ServiceException, ClassNotFoundException {
 603          List&lt;Property&gt; properties = getPropertiesFromEntityForm(entityForm);
 604  
 605          FieldMetadata md = field.getMetadata();
 606  
 607          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 608                  .withEntity(new Entity());
 609  
 610          if (md instanceof BasicCollectionMetadata) {
 611              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 612              ppr.setCeilingEntityClassname(fmd.getCollectionCeilingEntity());
 613              ppr.getEntity().setType(new String[] { fmd.getCollectionCeilingEntity() });
 614  
 615              Property fp = new Property();
 616              fp.setName(ppr.getForeignKey().getManyToField());
 617              fp.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 618              if (!properties.contains(fp)) {
 619                  properties.add(fp);
 620              }
 621          } else if (md instanceof AdornedTargetCollectionMetadata) {
 622              String adornedTargetEntityClassname = ppr.getAdornedList().getAdornedTargetEntityClassname();
 623              ppr.setCeilingEntityClassname(adornedTargetEntityClassname);
 624              ppr.getEntity().setType(new String[] {adornedTargetEntityClassname});
 625  
 626              for (Property property : properties) {
 627                  if (property.getName().equals(ppr.getAdornedList().getLinkedObjectPath() +
 628                                      &quot;.&quot; + ppr.getAdornedList().getLinkedIdProperty())) {
 629                      break;
 630                  }
 631              }
 632  
 633              if (!StringUtils.isEmpty(alternateId)) {
 634                  Property p = new Property();
 635                  p.setName(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);
 636                  p.setValue(alternateId);
 637                  if (!properties.contains(p)) {
 638                      properties.add(p);
 639                  }
 640              }
 641          } else if (md instanceof MapMetadata) {
 642              ppr.getEntity().setType(new String[] { entityForm.getEntityType() });
 643  
 644              Property p = new Property();
 645              p.setName(&quot;symbolicId&quot;);
 646              p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 647              properties.add(p);
 648          } else {
 649              throw new IllegalArgumentException(String.format(&quot;The specified field [%s] for class [%s] was&quot; +
 650                      &quot; not a collection field.&quot;, field.getName(), mainMetadata.getCeilingType()));
 651          }
 652  
 653          String sectionField = field.getName();
 654          if (sectionField.contains(&quot;.&quot;)) {
 655              sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 656          }
 657          ppr.setSectionEntityField(sectionField);
 658  
 659          Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 660          if (parentNameProp != null) {
 661              ppr.setRequestingEntityName(parentNameProp.getValue());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 662 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 663 -            Property name = parentEntity.getPMap().get(&quot;name&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 664 -            if(name !=null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 665 -                ppr.setRequestingEntityName(name.getValue());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 666 -            }</span>
 667          }
 668  
 669          Property p = new Property();
 670          p.setName(entityForm.getIdProperty());
 671          p.setValue(collectionItemId);
 672          if (!properties.contains(p)) {
 673              properties.add(p);
 674          }
 675  
 676          Property[] propArr = new Property[properties.size()];
 677          properties.toArray(propArr);
 678          ppr.getEntity().setProperties(propArr);
 679  
 680          return update(ppr);
 681      }
 682  
 683      @Override
<abbr title=" 684      public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentEntity,"> 684      public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentðŸ”µ</abbr>
 685                  String itemId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
<abbr title=" 686          return removeSubCollectionEntity(mainMetadata, field, parentEntity, itemId, null, priorKey, sectionCrumbs);"> 686          return removeSubCollectionEntity(mainMetadata, field, parentEntity, itemId, null, priorKey, sectionCrumbs)ðŸ”µ</abbr>
 687      }
 688  
 689      @Override
<abbr title=" 690      public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentEntity,"> 690      public PersistenceResponse removeSubCollectionEntity(ClassMetadata mainMetadata, Property field, Entity parentðŸ”µ</abbr>
<abbr title=" 691              String itemId, String alternateId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {"> 691              String itemId, String alternateId, String priorKey, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceExðŸ”µ</abbr>
 692          List&lt;Property&gt; properties = new ArrayList&lt;Property&gt;();
 693  
 694          Property p;
 695          String parentId = getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName());
 696  
 697          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(field.getMetadata(), sectionCrumbs)
 698                  .withEntity(new Entity());
 699  
 700          if (field.getMetadata() instanceof BasicCollectionMetadata) {
 701              BasicCollectionMetadata fmd = (BasicCollectionMetadata) field.getMetadata();
 702  
 703              p = new Property();
 704              p.setName(&quot;id&quot;);
 705              p.setValue(itemId);
 706              properties.add(p);
 707  
 708              p = new Property();
 709              p.setName(ppr.getForeignKey().getManyToField());
 710              p.setValue(parentId);
 711              properties.add(p);
 712  
 713              ppr.getEntity().setType(new String[]{fmd.getCollectionCeilingEntity()});
 714          } else if (field.getMetadata() instanceof AdornedTargetCollectionMetadata) {
 715              AdornedTargetList adornedList = ppr.getAdornedList();
 716  
 717              p = new Property();
 718              p.setName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());
 719              p.setValue(parentId);
 720              properties.add(p);
 721  
 722              p = new Property();
 723              p.setName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());
 724              p.setValue(itemId);
 725              properties.add(p);
 726  
 727              if (!StringUtils.isEmpty(alternateId)) {
 728                  p = new Property();
 729                  p.setName(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);
 730                  p.setValue(alternateId);
 731                  properties.add(p);
 732              }
 733  
 734              ppr.getEntity().setType(new String[]{adornedList.getAdornedTargetEntityClassname()});
 735          } else if (field.getMetadata() instanceof MapMetadata) {
 736              MapMetadata fmd = (MapMetadata) field.getMetadata();
 737  
 738              p = new Property();
 739              p.setName(&quot;id&quot;);
 740              p.setValue(itemId);
 741              properties.add(p);
 742  
 743              p = new Property();
 744              p.setName(&quot;symbolicId&quot;);
 745              p.setValue(getContextSpecificRelationshipId(mainMetadata, parentEntity, field.getName()));
 746              properties.add(p);
 747  
 748              p = new Property();
 749              p.setName(&quot;priorKey&quot;);
 750              p.setValue(priorKey);
 751              properties.add(p);
 752  
 753              MapStructure mapStructure = ppr.getMapStructure();
 754  
 755              p = new Property();
 756              p.setName(mapStructure.getKeyPropertyName());
 757              p.setValue(itemId);
 758              properties.add(p);
 759  
 760              ppr.getEntity().setType(new String[] { fmd.getTargetClass() });
 761          }
 762  
 763          ppr.setCeilingEntityClassname(ppr.getEntity().getType()[0]);
 764          String sectionField = field.getName();
 765          if (sectionField.contains(&quot;.&quot;)) {
 766              sectionField = sectionField.substring(0, sectionField.lastIndexOf(&quot;.&quot;));
 767          }
 768          ppr.setSectionEntityField(sectionField);
 769  
 770          Property parentNameProp = parentEntity.getPMap().get(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 771          if (parentNameProp != null) {
 772              ppr.setRequestingEntityName(parentNameProp.getValue());
 773          }
 774  
 775          Property[] propArr = new Property[properties.size()];
 776          properties.toArray(propArr);
 777          ppr.getEntity().setProperties(propArr);
 778  
 779          return remove(ppr);
 780      }
 781  
 782      @Override
 783      public String getContextSpecificRelationshipId(ClassMetadata cmd, Entity entity, String propertyName) {
 784          String prefix;
 785          if (propertyName.contains(&quot;.&quot;)) {
 786              prefix = propertyName.substring(0, propertyName.lastIndexOf(&quot;.&quot;));
 787          } else {
 788              prefix = &quot;&quot;;
 789          }
 790  
 791          if (prefix.equals(&quot;&quot;)) {
 792              return entity.findProperty(&quot;id&quot;).getValue();
 793          } else {
<abbr title=" 794              //we need to check all the parts of the prefix. For example, the prefix could include an @Embedded class like"> 794              //we need to check all the parts of the prefix. For example, the prefix could include an @Embedded claðŸ”µ</abbr>
<abbr title=" 795              //defaultSku.dimension. In this case, we want the id from the defaultSku property, since the @Embedded does"> 795              //defaultSku.dimension. In this case, we want the id from the defaultSku property, since the @EmbeddedðŸ”µ</abbr>
 796              //not have an id property - nor should it.
 797              String[] prefixParts = prefix.split(&quot;\\.&quot;);
 798              for (int j = 0; j &lt; prefixParts.length; j++) {
 799                  StringBuilder sb = new StringBuilder();
 800                  for (int x = 0; x &lt; prefixParts.length - j; x++) {
 801                      sb.append(prefixParts[x]);
 802                      if (x &lt; prefixParts.length - j - 1) {
 803                          sb.append(&quot;.&quot;);
 804                      }
 805                  }
 806                  String tempPrefix = sb.toString();
 807  
 808                  for (Property property : entity.getProperties()) {
 809                      if (property.getName().startsWith(tempPrefix)) {
<abbr title=" 810                          //make sure there is only one &#x27;.&#x27; to ensure we are looking at properties on the current prefix level"> 810                          //make sure there is only one &#x27;.&#x27; to ensure we are looking at properties on the current prðŸ”µ</abbr>
<abbr title=" 811                          //in the case of the prefix defaultSku, we want defaultSku.id not defaultSku.skuAttributes.id"> 811                          //in the case of the prefix defaultSku, we want defaultSku.id not defaultSku.skuAttributesðŸ”µ</abbr>
 812                          if (StringUtils.countMatches(property.getName().replace(tempPrefix, &quot;&quot;), &quot;.&quot;) == 1) {
 813                              if (cmd.getPMap().containsKey(property.getName())) {
<abbr title=" 814                                  BasicFieldMetadata md = (BasicFieldMetadata) cmd.getPMap().get(property.getName()).getMetadata();"> 814                                  BasicFieldMetadata md = (BasicFieldMetadata) cmd.getPMap().get(property.getName())ðŸ”µ</abbr>
 815                                  if (md.getFieldType().equals(SupportedFieldType.ID)) {
 816                                      return property.getValue();
 817                                  }
 818                              }
 819                          }
 820                      }
 821                  }
 822              }
 823          }
 824          if (!prefix.contains(&quot;.&quot;)) {
<abbr title=" 825              //this may be an embedded class directly on the root entity (e.g. embeddablePriceList.restrictedPriceLists on OfferImpl)"> 825              //this may be an embedded class directly on the root entity (e.g. embeddablePriceList.restrictedPriceLðŸ”µ</abbr>
 826              return entity.findProperty(&quot;id&quot;).getValue();
 827          }
 828          throw new RuntimeException(&quot;Unable to establish a relationship id&quot;);
 829      }
 830  
 831      @Override
 832      public String getIdProperty(ClassMetadata cmd) throws ServiceException {
 833          for (Property p : cmd.getProperties()) {
 834              if (p.getMetadata() instanceof BasicFieldMetadata) {
 835                  BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
 836                  //check for ID type and also make sure the field we&#x27;re looking at is not a &quot;ToOne&quot; association
 837                  if (SupportedFieldType.ID.equals(fmd.getFieldType()) &amp;&amp; !p.getName().contains(&quot;.&quot;)) {
 838                      return p.getName();
 839                  }
 840              }
 841          }
 842  
 843          throw new ServiceException(&quot;Could not determine ID field for &quot; + cmd.getCeilingType());
 844      }
 845  
 846      @Override
 847      public PersistenceResponse add(PersistencePackageRequest request) throws ServiceException {
 848          return add(request, true);
 849      }
 850  
 851      @Override
<abbr title=" 852      public PersistenceResponse add(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 852      public PersistenceResponse add(PersistencePackageRequest request, boolean transactional) throws ServiceExceptiðŸ”µ</abbr>
 853          PersistencePackage pkg = persistencePackageFactory.create(request);
 854          try {
 855              if (request.isUpdateLookupType()) {
 856                  if (pkg.getSectionCrumbs() != null &amp;&amp; pkg.getSectionCrumbs().length &gt; 0) {
 857                      SectionCrumb sc = pkg.getSectionCrumbs()[0];
 858                      if (StringUtils.isNotBlank(sc.getSectionIdentifier())) {
 859                          pkg.setSecurityCeilingEntityFullyQualifiedClassname(sc.getSectionIdentifier());
 860                      }
 861                  }
 862                  if (transactional) {
 863                      return service.update(pkg);
 864                  } else {
 865                      return service.nonTransactionalUpdate(pkg);
 866                  }
 867              } else {
 868                  if (transactional) {
 869                      return service.add(pkg);
 870                  } else {
 871                      return service.nonTransactionalAdd(pkg);
 872                  }
 873              }
 874          } catch (ValidationException e) {
 875              ensureEntityMarkedAsValidationFailure(e, request);
 876              return new PersistenceResponse().withEntity(e.getEntity());
 877          }
 878      }
 879  
 880      @Override
 881      public PersistenceResponse update(PersistencePackageRequest request) throws ServiceException {
 882          return update(request, true);
 883      }
 884  
 885      @Override
<abbr title=" 886      public PersistenceResponse update(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 886      public PersistenceResponse update(PersistencePackageRequest request, boolean transactional) throws ServiceExceðŸ”µ</abbr>
 887          PersistencePackage pkg = persistencePackageFactory.create(request);
 888          try {
 889              if (transactional) {
 890                  return service.update(pkg);
 891              } else {
 892                  return service.nonTransactionalUpdate(pkg);
 893              }
 894          } catch (ValidationException e) {
 895              ensureEntityMarkedAsValidationFailure(e, request);
 896              return new PersistenceResponse().withEntity(e.getEntity());
 897          }
 898      }
 899  
 900      @Override
 901      public PersistenceResponse inspect(PersistencePackageRequest request)
 902              throws ServiceException {
 903          PersistencePackage pkg = persistencePackageFactory.create(request);
 904          return service.inspect(pkg);
 905      }
 906  
 907      @Override
 908      public PersistenceResponse remove(PersistencePackageRequest request)
 909              throws ServiceException {
 910          return remove(request, true);
 911      }
 912  
 913      @Override
<abbr title=" 914      public PersistenceResponse remove(PersistencePackageRequest request, boolean transactional) throws ServiceException {"> 914      public PersistenceResponse remove(PersistencePackageRequest request, boolean transactional) throws ServiceExceðŸ”µ</abbr>
 915          PersistencePackage pkg = persistencePackageFactory.create(request);
 916          try {
 917              if (transactional) {
 918                  return service.remove(pkg);
 919              } else {
 920                  return service.nonTransactionalRemove(pkg);
 921              }
 922          } catch (ValidationException e) {
 923              ensureEntityMarkedAsValidationFailure(e, request);
 924              return new PersistenceResponse().withEntity(e.getEntity());
 925          }
 926      }
 927  
 928      /**
 929       * &lt;p&gt;
<abbr title=" 930       * Should be invoked when a {@link ValidationException} is thrown to verify that the {@link Entity} contained within the"> 930       * Should be invoked when a {@link ValidationException} is thrown to verify that the {@link Entity} contained ðŸ”µ</abbr>
 931       * given &lt;b&gt;originalRequest&lt;/b&gt; has a validationFailure = true
 932       *
 933       * &lt;p&gt;
 934       * This will also check for a cause of {@link ConstraintViolationException} and add a gloal error to that.
 935       */
<abbr title=" 936      protected void ensureEntityMarkedAsValidationFailure(ValidationException e, PersistencePackageRequest originalRequest) {"> 936      protected void ensureEntityMarkedAsValidationFailure(ValidationException e, PersistencePackageRequest originalðŸ”µ</abbr>
 937          if (e.containsCause(ConstraintViolationException.class)) {
 938              e.getEntity().addGlobalValidationError(&quot;constraintViolationError&quot;);
 939          } else if (!e.getEntity().isValidationFailure()) {
 940              e.getEntity().setValidationFailure(true);
 941              e.getEntity().addGlobalValidationError(e.getMessage());
 942          }
 943      }
 944  
 945      @Override
 946      public PersistenceResponse fetch(PersistencePackageRequest request)
 947              throws ServiceException {
 948          PersistencePackage pkg = persistencePackageFactory.create(request);
 949  
 950          CriteriaTransferObject cto = getDefaultCto();
 951          if (request.getFilterAndSortCriteria() != null) {
 952              cto.addAll(Arrays.asList(request.getFilterAndSortCriteria()));
 953          }
 954  
 955          if (request.getMaxResults() != null) {
 956              cto.setMaxResults(request.getMaxResults());
 957          }
 958  
 959          if (request.getStartIndex() == null) {
 960              cto.setFirstResult(0);
 961          } else {
 962              cto.setFirstResult(request.getStartIndex());
 963          }
 964  
 965          if (request.getMaxIndex() != null) {
 966              Integer startIndex = request.getStartIndex() != null ? request.getStartIndex() : 0;
 967              int requestedMaxResults = request.getMaxIndex() - startIndex + 1;
 968              if (requestedMaxResults &gt;= 0 &amp;&amp; requestedMaxResults &lt; cto.getMaxResults()) {
 969                  cto.setMaxResults(requestedMaxResults);
 970              }
 971          }
 972  
 973          cto.setLastId(request.getLastId());
 974          cto.setFirstId(request.getFirstId());
 975          cto.setUpperCount(request.getUpperCount());
 976          cto.setLowerCount(request.getLowerCount());
 977          if (request.getPageSize() != null) {
 978              cto.setMaxResults(request.getPageSize());
 979          }
 980          cto.setPresentationFetch(request.getPresentationFetch());
 981  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 982 +        if (request.isFolderedLookup()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 983 +            cto.setFolderLookup(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 984 +            cto.setFolderId(request.getFolderId());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 985 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 986 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 987 +        if (extensionManager != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 988 +            extensionManager.getProxy().modifyFetchCriteriaTransferObject(request, cto);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 989 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 990 +</span>
 991          return service.fetch(pkg, cto);
 992      }
 993  
 994      protected CriteriaTransferObject getDefaultCto() {
 995          CriteriaTransferObject cto = new CriteriaTransferObject();
 996          cto.setMaxResults(getDefaultMaxResults());
 997          return cto;
 998      }
 999  
1000      @Override
1001      public String getForeignEntityName(String owningClass, String id) {
1002          if (owningClass == null || id == null) {
1003              return null;
1004          }
1005  
1006          DynamicEntityDao dynamicEntityDao = getDynamicEntityDao(owningClass);
1007          Class&lt;?&gt; clazz = dynamicEntityDao.getImplClass(owningClass);
1008          Object foreignEntity = dynamicEntityDao.find(clazz, toIdFieldType(id, clazz));
1009  
1010          if (foreignEntity instanceof AdminMainEntity) {
1011              return ((AdminMainEntity) foreignEntity).getMainEntityName();
1012          }
1013  
1014          return null;
1015      }
1016  
1017      protected DynamicEntityDao getDynamicEntityDao(String owningClass) {
1018          return PersistenceManagerFactory.getPersistenceManager(owningClass).getDynamicEntityDao();
1019      }
1020  
1021      protected int getDefaultMaxResults() {
1022          return BLCSystemProperty.resolveIntSystemProperty(&quot;admin.default.max.results&quot;, 50);
1023      }
1024  
1025      protected Object toIdFieldType(String id, Class&lt;?&gt; entityClass) {
1026          Class&lt;?&gt; idFieldClass = dynamicDaoHelper.getIdField(entityClass, em).getType();

1027          if (Long.class.isAssignableFrom(idFieldClass)) {
1028              return Long.parseLong(id);
1029          } else if (Integer.class.isAssignableFrom(idFieldClass)) {
1030              return Integer.parseInt(id);
1031          }
1032          return id;
1033      }
1034  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            