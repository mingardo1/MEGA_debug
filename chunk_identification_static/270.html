<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>270</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    270
                    <a href="269.html">prev</a>
                    <a href="271.html">next</a>
                    <a href="270_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_7372a30b9f3190df28e61f8437f110c95d36b4fa_core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/dao/OfferAuditDaoImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;7372a30b9f3190df28e61f8437f110c95d36b4fa:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/dao/OfferAuditDaoImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;7372a30b9f3190df28e61f8437f110c95d36b4fa^1:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/dao/OfferAuditDaoImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;7372a30b9f3190df28e61f8437f110c95d36b4fa^2:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/dao/OfferAuditDaoImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;65989a8b6469e6f21626a6b7292822865b1618ba:core/broadleaf-framework/src/main/java/org/broadleafcommerce/core/offer/dao/OfferAuditDaoImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [j], [s]], subset: [[bj], [s]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.dao;
  19 
  20 import org.apache.commons.logging.Log;
  21 import org.apache.commons.logging.LogFactory;
  22 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  23 import org.broadleafcommerce.common.time.SystemTime;
  24 import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  25 import org.broadleafcommerce.core.offer.domain.OfferAudit;
  26 import org.broadleafcommerce.core.offer.domain.OfferAuditImpl;
  27 import org.broadleafcommerce.core.order.domain.Order;
  28 import org.broadleafcommerce.core.order.domain.OrderImpl;
  29 import org.broadleafcommerce.core.order.service.type.OrderStatus;
  30 import org.springframework.stereotype.Repository;
  31 
  32 import java.util.ArrayList;
  33 import java.util.Calendar;
  34 import java.util.Date;
  35 import java.util.GregorianCalendar;
  36 import java.util.List;
  37 
  38 import javax.annotation.Resource;
  39 import javax.persistence.EntityManager;
  40 import javax.persistence.PersistenceContext;
  41 import javax.persistence.TypedQuery;
  42 import javax.persistence.criteria.CriteriaBuilder;
  43 import javax.persistence.criteria.CriteriaQuery;
  44 import javax.persistence.criteria.Predicate;
  45 import javax.persistence.criteria.Root;
  46 
  47 @Repository(&quot;blOfferAuditDao&quot;)
  48 public class OfferAuditDaoImpl implements OfferAuditDao {
  49     
  50     protected static final Log LOG = LogFactory.getLog(OfferAuditDaoImpl.class);
  51 
  52     private static final Long NULL_ACCOUNT_ID = null;
  53     private static final Long NULL_CUSTOMER_ID = null;
  54 
  55     @PersistenceContext(unitName=&quot;blPU&quot;)
  56     protected EntityManager em;
  57 
  58     @Resource(name=&quot;blEntityConfiguration&quot;)
  59     protected EntityConfiguration entityConfiguration;
  60 
  61     protected Long currentDateResolution = 3600000L;
  62     protected Date cachedDate = SystemTime.asDate();
  63 
  64     protected Date getCurrentDateAfterFactoringInDateResolution() {
<abbr title="  65         Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolution());">  65         Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolutðŸ”µ</abbr>
  66         if (returnDate != cachedDate) {
  67             if (SystemTime.shouldCacheDate()) {
  68                 cachedDate = returnDate;
  69             }
  70         }
  71         return returnDate;
  72     }
  73 
  74     @Override
  75     public OfferAudit create() {
  76         return ((OfferAudit) entityConfiguration.createEntityInstance(OfferAudit.class.getName()));
  77     }
  78 
  79     @Override
  80     public void delete(final OfferAudit offerAudit) {
  81         OfferAudit loa = offerAudit;
  82         
  83         if (!em.contains(loa)) {
  84             loa = readAuditById(offerAudit.getId());
  85         }
  86         
  87         em.remove(loa);
  88     }
  89 
  90     @Override
  91     public OfferAudit save(final OfferAudit offerAudit) {
  92         return em.merge(offerAudit);
  93     }
  94 
  95     @Override
  96     public OfferAudit readAuditById(final Long offerAuditId) {
  97         return em.find(OfferAuditImpl.class, offerAuditId);
  98     }
  99 
 100     @Override
 101     public Long countUsesByCustomer(Order order, Long customerId, Long offerId) {
 102         return countUsesByCustomer(order, customerId, offerId, null);
 103     }
 104 
 105     @Override
 106     public Long countUsesByAccount(Order order, Long accountId, Long offerId) {
 107         return countUsesByAccount(order, accountId, offerId, null);
 108     }
 109 
 110     @Override
 111     public Long countUsesByAccount(Order order, Long accountId, Long offerId, Long minimumDaysPerUsage) {
<abbr title=" 112         return countUsesByAccountOrCustomer(order, NULL_CUSTOMER_ID, accountId, offerId, minimumDaysPerUsage);"> 112         return countUsesByAccountOrCustomer(order, NULL_CUSTOMER_ID, accountId, offerId, minimumDaysPerUsðŸ”µ</abbr>
 113     }
 114 
 115     @Override
<abbr title=" 116     public Long countUsesByCustomer(Order order, Long customerId, Long offerId, Long minimumDaysPerUsage) {"> 116     public Long countUsesByCustomer(Order order, Long customerId, Long offerId, Long minimumDaysPerUsage)ðŸ”µ</abbr>
<abbr title=" 117         return countUsesByAccountOrCustomer(order, customerId, NULL_ACCOUNT_ID, offerId, minimumDaysPerUsage);"> 117         return countUsesByAccountOrCustomer(order, customerId, NULL_ACCOUNT_ID, offerId, minimumDaysPerUsðŸ”µ</abbr>
 118     }
 119 
<abbr title=" 120     protected Long countUsesByAccountOrCustomer(Order order, Long customerId, Long accountId, Long offerId, Long minimumDaysPerUsage) {"> 120     protected Long countUsesByAccountOrCustomer(Order order, Long customerId, Long accountId, Long offerIðŸ”µ</abbr>
 121         CriteriaBuilder builder = em.getCriteriaBuilder();
 122         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 123         Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);
 124         Root&lt;OrderImpl&gt; orderRoot = criteria.from(OrderImpl.class);
 125         criteria.select(builder.count(root));
 126 
 127         Predicate customerOrAccountPredicate = null;
 128 
 129         if (customerId != null) {
 130             customerOrAccountPredicate = builder.equal(root.get(&quot;customerId&quot;), customerId);
 131         } else if (accountId != null) {
 132             customerOrAccountPredicate = builder.equal(root.get(&quot;accountId&quot;), accountId);
 133         } else {
 134             LOG.debug(&quot;Count uses by account or customer called without an account or a customer.&quot;);
 135             return 0L;
 136         }
 137 
 138         List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();
 139         restrictions.add(
 140             builder.and(
 141                         customerOrAccountPredicate, builder.equal(root.get(&quot;offerId&quot;), offerId),
 142                 builder.or(
 143                     builder.notEqual(root.get(&quot;orderId&quot;),  getOrderId(order)),
 144                     builder.isNull(root.get(&quot;orderId&quot;))
 145 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146                         )</span>
 147 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148             )</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149         );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151         criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154             return em.createQuery(criteria).getSingleResult();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156             LOG.error(&quot;Error counting offer uses by customer.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157             return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161     protected Long getOrderId(Order order) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         return order.getId();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167     public Long countUsesByCustomer(Long customerId, Long offerId) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168         TypedQuery&lt;Long&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169                 .addRestriction(&quot;offerAudit.customerId&quot;, &quot;=&quot;, customerId)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170                 .addRestriction(&quot;offerAudit.offerId&quot;, &quot;=&quot;, offerId)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171                 .toCountQuery(em);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173         return query.getSingleResult();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177     public Long countOfferCodeUses(Order order, Long offerCodeId) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178         CriteriaBuilder builder = em.getCriteriaBuilder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180         Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         criteria.select(builder.count(root));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183         List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184         restrictions.add(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185             builder.and(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186                 builder.or(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187                     builder.notEqual(root.get(&quot;orderId&quot;),  getOrderId(order)),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188                     builder.isNull(root.get(&quot;orderId&quot;))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189                 ),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190                 builder.equal(root.get(&quot;offerCodeId&quot;), offerCodeId)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191             )</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192         );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194         criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196         try {</span>
 197 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198                 ),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199                 builder.equal(root.get(&quot;customerId&quot;), customerId),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200                 builder.equal(root.get(&quot;offerId&quot;), offerId),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201                 builder.or(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202                         builder.isNull(root.get(&quot;orderId&quot;)),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203                         builder.and(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 204                                 builder.notEqual(orderRoot.get(&quot;status&quot;),OrderStatus.CANCELLED.getType()),"> 204                                 builder.notEqual(orderRoot.get(&quot;status&quot;),OrderStatus.CANCELLED.getType())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205                                 builder.equal(orderRoot.get(&quot;id&quot;),root.get(&quot;orderId&quot;))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206                         )</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207                 )</span>
 208 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 209             )
 210         );
 211 
 212         if (minimumDaysPerUsage != null &amp;&amp; minimumDaysPerUsage != 0L) {
 213             Date currentDate = getCurrentDateAfterFactoringInDateResolution();
 214 
 215             Calendar previousCalendar = new GregorianCalendar();
 216 
 217             previousCalendar.setTime(currentDate);
 218             previousCalendar.add(Calendar.DAY_OF_YEAR, -minimumDaysPerUsage.intValue());
 219 
<abbr title=" 220             restrictions.add(builder.between(root.&lt;Date&gt;get(&quot;redeemedDate&quot;), previousCalendar.getTime(), currentDate));"> 220             restrictions.add(builder.between(root.&lt;Date&gt;get(&quot;redeemedDate&quot;), previousCalendar.getTime(), ðŸ”µ</abbr>
 221         }
 222 
 223         criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
 224 
 225         try {
 226             return em.createQuery(criteria).getSingleResult();
 227         } catch (Exception e) {
 228             LOG.error(&quot;Error counting offer uses by customer.&quot;, e);
 229             return null;
 230         }
 231     }
 232     
 233     protected Long getOrderId(Order order) {
 234         return order.getId();
 235     }
 236     
 237     @Deprecated
 238     @Override
 239     public Long countUsesByCustomer(Long customerId, Long offerId) {
 240         TypedQuery&lt;Long&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 241                 .addRestriction(&quot;offerAudit.customerId&quot;, &quot;=&quot;, customerId)
 242                 .addRestriction(&quot;offerAudit.offerId&quot;, &quot;=&quot;, offerId)
 243                 .toCountQuery(em);
 244 
 245         return query.getSingleResult();
 246     }
 247 
 248     @Override
 249     public Long countOfferCodeUses(Order order, Long offerCodeId) {
 250         CriteriaBuilder builder = em.getCriteriaBuilder();
 251         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 252         Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);
 253         Root&lt;OrderImpl&gt; orderRoot = criteria.from(OrderImpl.class);
 254         criteria.select(builder.count(root));
 255 
 256         List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();
 257         restrictions.add(
 258             builder.and(
 259                 builder.or(
 260                     builder.notEqual(root.get(&quot;orderId&quot;),  getOrderId(order)),
 261                     builder.isNull(root.get(&quot;orderId&quot;))
 262                 ),
 263                 builder.equal(root.get(&quot;offerCodeId&quot;), offerCodeId),
 264                 builder.or(
 265                         builder.isNull(root.get(&quot;orderId&quot;)),
 266                         builder.and(
<abbr title=" 267                                 builder.notEqual(orderRoot.get(&quot;status&quot;),OrderStatus.CANCELLED.getType()),"> 267                                 builder.notEqual(orderRoot.get(&quot;status&quot;),OrderStatus.CANCELLED.getType())ðŸ”µ</abbr>
 268                                 builder.equal(orderRoot.get(&quot;id&quot;),root.get(&quot;orderId&quot;))
 269                         )
 270                 )
 271             )
 272         );
 273 
 274         criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
 275         
 276         try {
 277             return em.createQuery(criteria).getSingleResult();
 278         } catch (Exception e) {
 279             LOG.error(&quot;Error counting offer code uses.&quot;, e);
 280             return null;
 281         }
 282     }
 283     
 284     @Deprecated
 285     @Override
 286     public Long countOfferCodeUses(Long offerCodeId) {
 287         TypedQuery&lt;Long&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 288                 .addRestriction(&quot;offerAudit.offerCodeId&quot;, &quot;=&quot;, offerCodeId)
 289                 .toCountQuery(em);
 290 
 291         return query.getSingleResult();
 292     }
 293 
 294     @Override
 295     public List&lt;OfferAudit&gt; readOfferAuditsByOrderId(Long orderId) {
 296         TypedQuery&lt;OfferAudit&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 297                 .addRestriction(&quot;offerAudit.orderId&quot;, &quot;=&quot;, orderId)
 298                 .toQuery(em);
 299         
 300         return query.getResultList();
 301     }
 302 
 303 
 304     @Override
 305     public Long getCurrentDateResolution() {
 306         return currentDateResolution;
 307     }
 308 
 309     @Override
 310     public void setCurrentDateResolution(Long currentDateResolution) {
 311         this.currentDateResolution = currentDateResolution;
 312     }
 313 
 314 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.dao;
  19 
  20 import org.apache.commons.logging.Log;
  21 import org.apache.commons.logging.LogFactory;
  22 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  23 import org.broadleafcommerce.common.time.SystemTime;
  24 import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  25 import org.broadleafcommerce.core.offer.domain.OfferAudit;
  26 import org.broadleafcommerce.core.offer.domain.OfferAuditImpl;
  27 import org.broadleafcommerce.core.order.domain.Order;
  28 import org.broadleafcommerce.core.order.domain.OrderImpl;
  29 import org.broadleafcommerce.core.order.service.type.OrderStatus;
  30 import org.springframework.stereotype.Repository;
  31 
  32 import java.util.ArrayList;
  33 import java.util.Calendar;
  34 import java.util.Date;
  35 import java.util.GregorianCalendar;
  36 import java.util.List;
  37 
  38 import javax.annotation.Resource;
  39 import javax.persistence.EntityManager;
  40 import javax.persistence.PersistenceContext;
  41 import javax.persistence.TypedQuery;
  42 import javax.persistence.criteria.CriteriaBuilder;
  43 import javax.persistence.criteria.CriteriaQuery;
  44 import javax.persistence.criteria.Predicate;
  45 import javax.persistence.criteria.Root;
  46 
  47 @Repository(&quot;blOfferAuditDao&quot;)
  48 public class OfferAuditDaoImpl implements OfferAuditDao {
  49 
  50     protected static final Log LOG = LogFactory.getLog(OfferAuditDaoImpl.class);
  51 
  52     private static final Long NULL_ACCOUNT_ID = null;
  53     private static final Long NULL_CUSTOMER_ID = null;
  54 
  55     @PersistenceContext(unitName=&quot;blPU&quot;)
  56     protected EntityManager em;
  57 
  58     @Resource(name=&quot;blEntityConfiguration&quot;)
  59     protected EntityConfiguration entityConfiguration;
  60 
  61     protected Long currentDateResolution = 3600000L;
  62     protected Date cachedDate = SystemTime.asDate();
  63 
  64     protected Date getCurrentDateAfterFactoringInDateResolution() {
<abbr title="  65         Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolution());">  65         Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolutðŸ”µ</abbr>
  66         if (returnDate != cachedDate) {
  67             if (SystemTime.shouldCacheDate()) {
  68                 cachedDate = returnDate;
  69             }
  70         }
  71         return returnDate;
  72     }
  73 
  74     @Override
  75     public OfferAudit create() {
  76         return ((OfferAudit) entityConfiguration.createEntityInstance(OfferAudit.class.getName()));
  77     }
  78 
  79     @Override
  80     public void delete(final OfferAudit offerAudit) {
  81         OfferAudit loa = offerAudit;
  82 
  83         if (!em.contains(loa)) {
  84             loa = readAuditById(offerAudit.getId());
  85         }
  86 
  87         em.remove(loa);
  88     }
  89 
  90     @Override
  91     public OfferAudit save(final OfferAudit offerAudit) {
  92         return em.merge(offerAudit);
  93     }
  94 
  95     @Override
  96     public OfferAudit readAuditById(final Long offerAuditId) {
  97         return em.find(OfferAuditImpl.class, offerAuditId);
  98     }
  99 
 100     @Override
 101     public Long countUsesByCustomer(Order order, Long customerId, Long offerId) {
 102 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 103         return countUsesByCustomer(order, customerId, offerId, null);</span>
 104 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105         CriteriaBuilder builder = em.getCriteriaBuilder();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107         Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         criteria.select(builder.count(root));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         restrictions.add(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112             builder.and(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113                 builder.or(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114                     builder.notEqual(root.get(&quot;orderId&quot;),  getOrderId(order)),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115                     builder.isNull(root.get(&quot;orderId&quot;))</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116                 ),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117                 builder.equal(root.get(&quot;customerId&quot;), customerId),</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118                 builder.equal(root.get(&quot;offerId&quot;), offerId)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119             )</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120         );</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122         criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125             return em.createQuery(criteria).getSingleResult();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127             LOG.error(&quot;Error counting offer uses by customer.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128             return null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130     }</span>
 131 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132         CriteriaBuilder builder = em.getCriteriaBuilder();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134         Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135         Root&lt;OrderImpl&gt; orderRoot = criteria.from(OrderImpl.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136         criteria.select(builder.count(root));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138         List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139         restrictions.add(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140             builder.and(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141                 builder.or(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142                     builder.notEqual(root.get(&quot;orderId&quot;),  getOrderId(order)),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143                     builder.isNull(root.get(&quot;orderId&quot;))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144                 ),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145                 builder.equal(root.get(&quot;customerId&quot;), customerId),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146                 builder.equal(root.get(&quot;offerId&quot;), offerId),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147                 builder.or(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148                         builder.isNull(root.get(&quot;orderId&quot;)),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149                         builder.and(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 150                                 builder.notEqual(orderRoot.get(&quot;status&quot;),OrderStatus.CANCELLED.getType()),"> 150                                 builder.notEqual(orderRoot.get(&quot;status&quot;),OrderStatus.CANCELLED.getType())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151                                 builder.equal(orderRoot.get(&quot;id&quot;),root.get(&quot;orderId&quot;))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152                         )</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153                 )</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154             )</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155         );</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157         criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160             return em.createQuery(criteria).getSingleResult();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161         } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162             LOG.error(&quot;Error counting offer uses by customer.&quot;, e);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163             return null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164         }</span>
 165 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 166     }
 167 
 168     @Override
 169     public Long countUsesByAccount(Order order, Long accountId, Long offerId) {
 170         return countUsesByAccount(order, accountId, offerId, null);
 171     }
 172 
 173     @Override
 174     public Long countUsesByAccount(Order order, Long accountId, Long offerId, Long minimumDaysPerUsage) {
<abbr title=" 175         return countUsesByAccountOrCustomer(order, NULL_CUSTOMER_ID, accountId, offerId, minimumDaysPerUsage);"> 175         return countUsesByAccountOrCustomer(order, NULL_CUSTOMER_ID, accountId, offerId, minimumDaysPerUsðŸ”µ</abbr>
 176     }
 177 
 178     @Override
<abbr title=" 179     public Long countUsesByCustomer(Order order, Long customerId, Long offerId, Long minimumDaysPerUsage) {"> 179     public Long countUsesByCustomer(Order order, Long customerId, Long offerId, Long minimumDaysPerUsage)ðŸ”µ</abbr>
<abbr title=" 180         return countUsesByAccountOrCustomer(order, customerId, NULL_ACCOUNT_ID, offerId, minimumDaysPerUsage);"> 180         return countUsesByAccountOrCustomer(order, customerId, NULL_ACCOUNT_ID, offerId, minimumDaysPerUsðŸ”µ</abbr>
 181     }
 182 
<abbr title=" 183     protected Long countUsesByAccountOrCustomer(Order order, Long customerId, Long accountId, Long offerId, Long minimumDaysPerUsage) {"> 183     protected Long countUsesByAccountOrCustomer(Order order, Long customerId, Long accountId, Long offerIðŸ”µ</abbr>
 184         CriteriaBuilder builder = em.getCriteriaBuilder();
 185         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 186         Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);
 187         criteria.select(builder.count(root));
 188 
 189         Predicate customerOrAccountPredicate = null;
 190 
 191         if (customerId != null) {
 192             customerOrAccountPredicate = builder.equal(root.get(&quot;customerId&quot;), customerId);
 193         } else if (accountId != null) {
 194             customerOrAccountPredicate = builder.equal(root.get(&quot;accountId&quot;), accountId);
 195         } else {
 196             LOG.debug(&quot;Count uses by account or customer called without an account or a customer.&quot;);
 197             return 0L;
 198         }
 199 
 200         List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();
 201         restrictions.add(
 202             builder.and(
 203                         customerOrAccountPredicate, builder.equal(root.get(&quot;offerId&quot;), offerId),
 204                 builder.or(
 205                     builder.notEqual(root.get(&quot;orderId&quot;),  getOrderId(order)),
 206                     builder.isNull(root.get(&quot;orderId&quot;))
 207                         )
 208             )
 209         );
 210 
 211         if (minimumDaysPerUsage != null &amp;&amp; minimumDaysPerUsage != 0L) {
 212             Date currentDate = getCurrentDateAfterFactoringInDateResolution();
 213 
 214             Calendar previousCalendar = new GregorianCalendar();
 215 
 216             previousCalendar.setTime(currentDate);
 217             previousCalendar.add(Calendar.DAY_OF_YEAR, -minimumDaysPerUsage.intValue());
 218 
<abbr title=" 219             restrictions.add(builder.between(root.&lt;Date&gt;get(&quot;redeemedDate&quot;), previousCalendar.getTime(), currentDate));"> 219             restrictions.add(builder.between(root.&lt;Date&gt;get(&quot;redeemedDate&quot;), previousCalendar.getTime(), ðŸ”µ</abbr>
 220         }
 221 
 222         criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
 223 
 224         try {
 225             return em.createQuery(criteria).getSingleResult();
 226         } catch (Exception e) {
 227             LOG.error(&quot;Error counting offer uses by customer.&quot;, e);
 228             return null;
 229         }
 230     }
 231 
 232     protected Long getOrderId(Order order) {
 233         return order.getId();
 234     }
 235 
 236     @Deprecated
 237     @Override
 238     public Long countUsesByCustomer(Long customerId, Long offerId) {
 239         TypedQuery&lt;Long&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 240                 .addRestriction(&quot;offerAudit.customerId&quot;, &quot;=&quot;, customerId)
 241                 .addRestriction(&quot;offerAudit.offerId&quot;, &quot;=&quot;, offerId)
 242                 .toCountQuery(em);
 243 
 244         return query.getSingleResult();
 245     }
 246 
 247     @Override
 248     public Long countOfferCodeUses(Order order, Long offerCodeId) {
 249         CriteriaBuilder builder = em.getCriteriaBuilder();
 250         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 251         Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);
 252         Root&lt;OrderImpl&gt; orderRoot = criteria.from(OrderImpl.class);
 253         criteria.select(builder.count(root));
 254 
 255         List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();
 256         restrictions.add(
 257             builder.and(
 258                 builder.or(
 259                     builder.notEqual(root.get(&quot;orderId&quot;),  getOrderId(order)),
 260                     builder.isNull(root.get(&quot;orderId&quot;))
 261                 ),
 262                 builder.equal(root.get(&quot;offerCodeId&quot;), offerCodeId),
 263                 builder.or(
 264                         builder.isNull(root.get(&quot;orderId&quot;)),
 265                         builder.and(
<abbr title=" 266                                 builder.notEqual(orderRoot.get(&quot;status&quot;),OrderStatus.CANCELLED.getType()),"> 266                                 builder.notEqual(orderRoot.get(&quot;status&quot;),OrderStatus.CANCELLED.getType())ðŸ”µ</abbr>
 267                                 builder.equal(orderRoot.get(&quot;id&quot;),root.get(&quot;orderId&quot;))
 268                         )
 269                 )
 270             )
 271         );
 272 
 273         criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
 274 
 275         try {
 276             return em.createQuery(criteria).getSingleResult();
 277         } catch (Exception e) {
 278             LOG.error(&quot;Error counting offer code uses.&quot;, e);
 279             return null;
 280         }
 281     }
 282 
 283     @Deprecated
 284     @Override
 285     public Long countOfferCodeUses(Long offerCodeId) {
 286         TypedQuery&lt;Long&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 287                 .addRestriction(&quot;offerAudit.offerCodeId&quot;, &quot;=&quot;, offerCodeId)
 288                 .toCountQuery(em);
 289 
 290         return query.getSingleResult();
 291     }
 292 
 293     @Override
 294     public List&lt;OfferAudit&gt; readOfferAuditsByOrderId(Long orderId) {
 295         TypedQuery&lt;OfferAudit&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 296                 .addRestriction(&quot;offerAudit.orderId&quot;, &quot;=&quot;, orderId)
 297                 .toQuery(em);
 298 
 299         return query.getResultList();
 300     }
 301 
 302 
 303     @Override
 304     public Long getCurrentDateResolution() {
 305         return currentDateResolution;
 306     }
 307 
 308     @Override
 309     public void setCurrentDateResolution(Long currentDateResolution) {
 310         this.currentDateResolution = currentDateResolution;
 311     }
 312 
 313 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Framework
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.core.offer.dao;
  19 
  20 import java.util.ArrayList;
  21 import java.util.Calendar;
  22 import java.util.Date;
  23 import java.util.GregorianCalendar;
  24 import java.util.List;
  25 import javax.annotation.Resource;
  26 import javax.persistence.EntityManager;
  27 import javax.persistence.PersistenceContext;
  28 import javax.persistence.TypedQuery;
  29 import javax.persistence.criteria.CriteriaBuilder;
  30 import javax.persistence.criteria.CriteriaQuery;
  31 import javax.persistence.criteria.Predicate;
  32 import javax.persistence.criteria.Root;
  33 import org.apache.commons.logging.Log;
  34 import org.apache.commons.logging.LogFactory;
  35 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  36 import org.broadleafcommerce.common.time.SystemTime;
  37 import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  38 import org.broadleafcommerce.core.offer.domain.OfferAudit;
  39 import org.broadleafcommerce.core.offer.domain.OfferAuditImpl;
  40 import org.broadleafcommerce.core.order.domain.Order;
  41 import org.broadleafcommerce.core.order.domain.OrderImpl;
  42 import org.broadleafcommerce.core.order.service.type.OrderStatus;
  43 import org.springframework.stereotype.Repository;
  44 
  45 
  46 @Repository(&quot;blOfferAuditDao&quot;)
  47 public class OfferAuditDaoImpl implements OfferAuditDao {
  48     protected static final Log LOG = LogFactory.getLog(OfferAuditDaoImpl.class);
  49 
  50     private static final Long NULL_ACCOUNT_ID = null;
  51 
  52     private static final Long NULL_CUSTOMER_ID = null;
  53 
  54     @PersistenceContext(unitName=&quot;blPU&quot;)
  55     protected EntityManager em;
  56 
  57     @Resource(name=&quot;blEntityConfiguration&quot;)
  58     protected EntityConfiguration entityConfiguration;
  59 
  60     protected Long currentDateResolution = 3600000L;
  61 
  62     protected Date cachedDate = SystemTime.asDate();
  63 
  64     protected Date getCurrentDateAfterFactoringInDateResolution() {
<abbr title="  65         Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolution());">  65         Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolutðŸ”µ</abbr>
  66         if (returnDate != cachedDate) {
  67             if (SystemTime.shouldCacheDate()) {
  68                 cachedDate = returnDate;
  69             }
  70         }
  71         return returnDate;
  72     }
  73 
  74     @Override
  75     public OfferAudit create() {
  76         return ((OfferAudit) entityConfiguration.createEntityInstance(OfferAudit.class.getName()));
  77     }
  78 
  79     @Override
  80     public void delete(final OfferAudit offerAudit) {
  81         OfferAudit loa = offerAudit;
  82 
  83         if (!em.contains(loa)) {
  84             loa = readAuditById(offerAudit.getId());
  85         }
  86 
  87         em.remove(loa);
  88     }
  89 
  90     @Override
  91     public OfferAudit save(final OfferAudit offerAudit) {
  92         return em.merge(offerAudit);
  93     }
  94 
  95     @Override
  96     public OfferAudit readAuditById(final Long offerAuditId) {
  97         return em.find(OfferAuditImpl.class, offerAuditId);
  98     }
  99 
 100     @Override
 101     public Long countUsesByCustomer(Order order, Long customerId, Long offerId) {
 102         return countUsesByCustomer(order, customerId, offerId, null);
 103     }
 104 
 105     @Override
 106     public Long countUsesByAccount(Order order, Long accountId, Long offerId) {
 107         return countUsesByAccount(order, accountId, offerId, null);
 108     }
 109 
 110     @Override
 111     public Long countUsesByAccount(Order order, Long accountId, Long offerId, Long minimumDaysPerUsage) {
<abbr title=" 112         return countUsesByAccountOrCustomer(order, NULL_CUSTOMER_ID, accountId, offerId, minimumDaysPerUsage);"> 112         return countUsesByAccountOrCustomer(order, NULL_CUSTOMER_ID, accountId, offerId, minimumDaysPerUsðŸ”µ</abbr>
 113     }
 114 
 115     @Override
<abbr title=" 116     public Long countUsesByCustomer(Order order, Long customerId, Long offerId, Long minimumDaysPerUsage) {"> 116     public Long countUsesByCustomer(Order order, Long customerId, Long offerId, Long minimumDaysPerUsage)ðŸ”µ</abbr>
<abbr title=" 117         return countUsesByAccountOrCustomer(order, customerId, NULL_ACCOUNT_ID, offerId, minimumDaysPerUsage);"> 117         return countUsesByAccountOrCustomer(order, customerId, NULL_ACCOUNT_ID, offerId, minimumDaysPerUsðŸ”µ</abbr>
 118     }
 119 
<abbr title=" 120     protected Long countUsesByAccountOrCustomer(Order order, Long customerId, Long accountId, Long offerId, Long minimumDaysPerUsage) {"> 120     protected Long countUsesByAccountOrCustomer(Order order, Long customerId, Long accountId, Long offerIðŸ”µ</abbr>
 121         CriteriaBuilder builder = em.getCriteriaBuilder();
 122         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(java.lang.Long.class);
 123         Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);
 124         Root&lt;OrderImpl&gt; orderRoot = criteria.from(OrderImpl.class);
 125         criteria.select(builder.count(root));
 126         Predicate customerOrAccountPredicate = null;
 127         if (customerId != null) {
 128             customerOrAccountPredicate = builder.equal(root.get(&quot;customerId&quot;), customerId);
 129         } else if (accountId != null) {
 130             customerOrAccountPredicate = builder.equal(root.get(&quot;accountId&quot;), accountId);
 131         } else {
 132             LOG.debug(&quot;Count uses by account or customer called without an account or a customer.&quot;);
 133             return 0L;
 134         }
 135         List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();
<abbr title=" 136         restrictions.add(builder.and(customerOrAccountPredicate, builder.equal(root.get(&quot;offerId&quot;), offerId),"> 136         restrictions.add(builder.and(customerOrAccountPredicate, builder.equal(root.get(&quot;offerId&quot;), offerðŸ”µ</abbr>
 137 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138                 builder.or(</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139                     builder.notEqual(root.get(&quot;orderId&quot;),  getOrderId(order)),</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140                     builder.isNull(root.get(&quot;orderId&quot;))</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141                 )</span>
 142 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 143 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 143 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 144 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146                 builder.or(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147                         builder.isNull(root.get(&quot;orderId&quot;)),</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148                         builder.and(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 149                                 builder.notEqual(orderRoot.get(&quot;status&quot;),OrderStatus.CANCELLED.getType()),"> 149                                 builder.notEqual(orderRoot.get(&quot;status&quot;),OrderStatus.CANCELLED.getType())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150                                 builder.equal(orderRoot.get(&quot;id&quot;),root.get(&quot;orderId&quot;))</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151                         )</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152                 )</span>
 153 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 154         ));
 155         if ((minimumDaysPerUsage != null) &amp;&amp; (minimumDaysPerUsage != 0L)) {
 156             Date currentDate = getCurrentDateAfterFactoringInDateResolution();
 157             Calendar previousCalendar = new GregorianCalendar();
 158             previousCalendar.setTime(currentDate);
 159             previousCalendar.add(Calendar.DAY_OF_YEAR, -minimumDaysPerUsage.intValue());
<abbr title=" 160             restrictions.add(builder.between(root.&lt;Date&gt;get(&quot;redeemedDate&quot;), previousCalendar.getTime(), currentDate));"> 160             restrictions.add(builder.between(root.&lt;Date&gt;get(&quot;redeemedDate&quot;), previousCalendar.getTime(), ðŸ”µ</abbr>
 161         }
 162         criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
 163         try {
 164             return em.createQuery(criteria).getSingleResult();
 165         } catch (java.lang.Exception e) {
 166             LOG.error(&quot;Error counting offer uses by customer.&quot;, e);
 167             return null;
 168         }
 169     }
 170 
 171     protected Long getOrderId(Order order) {
 172         return order.getId();
 173     }
 174 
 175     @Deprecated
 176     @Override
 177     public Long countUsesByCustomer(Long customerId, Long offerId) {
 178         TypedQuery&lt;Long&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 179                 .addRestriction(&quot;offerAudit.customerId&quot;, &quot;=&quot;, customerId)
 180                 .addRestriction(&quot;offerAudit.offerId&quot;, &quot;=&quot;, offerId)
 181                 .toCountQuery(em);
 182 
 183         return query.getSingleResult();
 184     }
 185 
 186     @Override
 187     public Long countOfferCodeUses(Order order, Long offerCodeId) {
 188         CriteriaBuilder builder = em.getCriteriaBuilder();
 189         CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(java.lang.Long.class);
 190         Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);
 191         Root&lt;OrderImpl&gt; orderRoot = criteria.from(OrderImpl.class);
 192         criteria.select(builder.count(root));
 193         List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();
<abbr title=" 194         restrictions.add(builder.and(builder.or(builder.notEqual(root.get(&quot;orderId&quot;), getOrderId(order)), builder.isNull(root.get(&quot;orderId&quot;))), builder.equal(root.get(&quot;offerCodeId&quot;), offerCodeId), builder.or(builder.isNull(root.get(&quot;orderId&quot;)), builder.and(builder.notEqual(orderRoot.get(&quot;status&quot;), OrderStatus.CANCELLED.getType()), builder.equal(orderRoot.get(&quot;id&quot;), root.get(&quot;orderId&quot;))))));"> 194         restrictions.add(builder.and(builder.or(builder.notEqual(root.get(&quot;orderId&quot;), getOrderId(order)),ðŸ”µ</abbr>
 195         criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
 196         try {
 197             return em.createQuery(criteria).getSingleResult();
 198         } catch (java.lang.Exception e) {
 199             LOG.error(&quot;Error counting offer code uses.&quot;, e);
 200             return null;
 201         }
 202     }
 203 
 204     @Deprecated
 205     @Override
 206     public Long countOfferCodeUses(Long offerCodeId) {
 207         TypedQuery&lt;Long&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 208                 .addRestriction(&quot;offerAudit.offerCodeId&quot;, &quot;=&quot;, offerCodeId)
 209                 .toCountQuery(em);
 210 
 211         return query.getSingleResult();
 212     }
 213 
 214     @Override
 215     public List&lt;OfferAudit&gt; readOfferAuditsByOrderId(Long orderId) {
 216         TypedQuery&lt;OfferAudit&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 217                 .addRestriction(&quot;offerAudit.orderId&quot;, &quot;=&quot;, orderId)
 218                 .toQuery(em);
 219 
 220         return query.getResultList();
 221     }
 222 
 223     @Override
 224     public Long getCurrentDateResolution() {
 225         return currentDateResolution;
 226     }
 227 
 228     @Override
 229     public void setCurrentDateResolution(Long currentDateResolution) {
 230         this.currentDateResolution = currentDateResolution;
 231     }
 232 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.dao;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.persistence.EntityConfiguration;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +import org.broadleafcommerce.common.time.SystemTime;</span>
  24  import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  25  import org.broadleafcommerce.core.offer.domain.OfferAudit;
  26  import org.broadleafcommerce.core.offer.domain.OfferAuditImpl;
  27  import org.broadleafcommerce.core.order.domain.Order;


  28  import org.springframework.stereotype.Repository;
  29  
  30  import java.util.ArrayList;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import java.util.Calendar;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import java.util.Date;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import java.util.GregorianCalendar;</span>
  34  import java.util.List;
  35  
  36  import javax.annotation.Resource;
  37  import javax.persistence.EntityManager;
  38  import javax.persistence.PersistenceContext;
  39  import javax.persistence.TypedQuery;
  40  import javax.persistence.criteria.CriteriaBuilder;
  41  import javax.persistence.criteria.CriteriaQuery;
  42  import javax.persistence.criteria.Predicate;
  43  import javax.persistence.criteria.Root;
  44  
  45  @Repository(&quot;blOfferAuditDao&quot;)
  46  public class OfferAuditDaoImpl implements OfferAuditDao {
  47  
  48      protected static final Log LOG = LogFactory.getLog(OfferAuditDaoImpl.class);
  49  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  50 +    private static final Long NULL_ACCOUNT_ID = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  51 +    private static final Long NULL_CUSTOMER_ID = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  52 +</span>
  53      @PersistenceContext(unitName=&quot;blPU&quot;)
  54      protected EntityManager em;
  55  
  56      @Resource(name=&quot;blEntityConfiguration&quot;)
  57      protected EntityConfiguration entityConfiguration;
  58  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  59 +    protected Long currentDateResolution = 3600000L;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  60 +    protected Date cachedDate = SystemTime.asDate();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  61 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +    protected Date getCurrentDateAfterFactoringInDateResolution() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  63 +        Date returnDate = SystemTime.getCurrentDateWithinTimeResolution(cachedDate, getCurrentDateResolution());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +        if (returnDate != cachedDate) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  65 +            if (SystemTime.shouldCacheDate()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  66 +                cachedDate = returnDate;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +        return returnDate;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +</span>
  72      @Override
  73      public OfferAudit create() {
  74          return ((OfferAudit) entityConfiguration.createEntityInstance(OfferAudit.class.getName()));
  75      }
  76  
  77      @Override
  78      public void delete(final OfferAudit offerAudit) {
  79          OfferAudit loa = offerAudit;
  80  
  81          if (!em.contains(loa)) {
  82              loa = readAuditById(offerAudit.getId());
  83          }
  84  
  85          em.remove(loa);
  86      }
  87  
  88      @Override
  89      public OfferAudit save(final OfferAudit offerAudit) {
  90          return em.merge(offerAudit);
  91      }
  92  
  93      @Override
  94      public OfferAudit readAuditById(final Long offerAuditId) {
  95          return em.find(OfferAuditImpl.class, offerAuditId);
  96      }
  97  
  98      @Override
  99      public Long countUsesByCustomer(Order order, Long customerId, Long offerId) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +        return countUsesByCustomer(order, customerId, offerId, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +    public Long countUsesByAccount(Order order, Long accountId, Long offerId) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +        return countUsesByAccount(order, accountId, offerId, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +    public Long countUsesByAccount(Order order, Long accountId, Long offerId, Long minimumDaysPerUsage) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +        return countUsesByAccountOrCustomer(order, NULL_CUSTOMER_ID, accountId, offerId, minimumDaysPerUsage);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +    public Long countUsesByCustomer(Order order, Long customerId, Long offerId, Long minimumDaysPerUsage) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +        return countUsesByAccountOrCustomer(order, customerId, NULL_ACCOUNT_ID, offerId, minimumDaysPerUsage);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 118 +    protected Long countUsesByAccountOrCustomer(Order order, Long customerId, Long accountId, Long offerId, Long minimumDaysPerUsage) {"> 118 +    protected Long countUsesByAccountOrCustomer(Order order, Long customerId, Long accountId, Long offerId, Long mðŸ”µ</abbr></span>
 119          CriteriaBuilder builder = em.getCriteriaBuilder();
 120          CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 121          Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);

 122          criteria.select(builder.count(root));
 123  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +        Predicate customerOrAccountPredicate = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        if (customerId != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +            customerOrAccountPredicate = builder.equal(root.get(&quot;customerId&quot;), customerId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +        } else if (accountId != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +            customerOrAccountPredicate = builder.equal(root.get(&quot;accountId&quot;), accountId);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +            LOG.debug(&quot;Count uses by account or customer called without an account or a customer.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +            return 0L;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +</span>
 135          List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();
 136          restrictions.add(
 137              builder.and(
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +                        customerOrAccountPredicate, builder.equal(root.get(&quot;offerId&quot;), offerId),</span>
 139                  builder.or(
 140                      builder.notEqual(root.get(&quot;orderId&quot;),  getOrderId(order)),
 141                      builder.isNull(root.get(&quot;orderId&quot;))
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -                ),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -                builder.equal(root.get(&quot;customerId&quot;), customerId),</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                builder.equal(root.get(&quot;offerId&quot;), offerId)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                        )</span>







 146              )
 147          );
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +        if (minimumDaysPerUsage != null &amp;&amp; minimumDaysPerUsage != 0L) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +            Date currentDate = getCurrentDateAfterFactoringInDateResolution();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +            Calendar previousCalendar = new GregorianCalendar();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +            previousCalendar.setTime(currentDate);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +            previousCalendar.add(Calendar.DAY_OF_YEAR, -minimumDaysPerUsage.intValue());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 157 +            restrictions.add(builder.between(root.&lt;Date&gt;get(&quot;redeemedDate&quot;), previousCalendar.getTime(), currentDate));"> 157 +            restrictions.add(builder.between(root.&lt;Date&gt;get(&quot;redeemedDate&quot;), previousCalendar.getTime(), currentDaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +        }</span>
 159  
 160          criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
 161  
 162          try {
 163              return em.createQuery(criteria).getSingleResult();
 164          } catch (Exception e) {
 165              LOG.error(&quot;Error counting offer uses by customer.&quot;, e);
 166              return null;
 167          }
 168      }
 169  
 170      protected Long getOrderId(Order order) {
 171          return order.getId();
 172      }
 173  
 174      @Deprecated
 175      @Override
 176      public Long countUsesByCustomer(Long customerId, Long offerId) {
 177          TypedQuery&lt;Long&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 178                  .addRestriction(&quot;offerAudit.customerId&quot;, &quot;=&quot;, customerId)
 179                  .addRestriction(&quot;offerAudit.offerId&quot;, &quot;=&quot;, offerId)
 180                  .toCountQuery(em);
 181  
 182          return query.getSingleResult();
 183      }
 184  
 185      @Override
 186      public Long countOfferCodeUses(Order order, Long offerCodeId) {
 187          CriteriaBuilder builder = em.getCriteriaBuilder();
 188          CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 189          Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);

 190          criteria.select(builder.count(root));
 191  
 192          List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();
 193          restrictions.add(
 194              builder.and(
 195                  builder.or(
 196                      builder.notEqual(root.get(&quot;orderId&quot;),  getOrderId(order)),
 197                      builder.isNull(root.get(&quot;orderId&quot;))
 198                  ),
 199                  builder.equal(root.get(&quot;offerCodeId&quot;), offerCodeId)








 200              )
 201          );
 202  
 203          criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
 204  
 205          try {
 206              return em.createQuery(criteria).getSingleResult();
 207          } catch (Exception e) {
 208              LOG.error(&quot;Error counting offer code uses.&quot;, e);
 209              return null;
 210          }
 211      }
 212  
 213      @Deprecated
 214      @Override
 215      public Long countOfferCodeUses(Long offerCodeId) {
 216          TypedQuery&lt;Long&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 217                  .addRestriction(&quot;offerAudit.offerCodeId&quot;, &quot;=&quot;, offerCodeId)
 218                  .toCountQuery(em);
 219  
 220          return query.getSingleResult();
 221      }
 222  
 223      @Override
 224      public List&lt;OfferAudit&gt; readOfferAuditsByOrderId(Long orderId) {
 225          TypedQuery&lt;OfferAudit&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 226                  .addRestriction(&quot;offerAudit.orderId&quot;, &quot;=&quot;, orderId)
 227                  .toQuery(em);
 228  
 229          return query.getResultList();
 230      }
 231  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +    public Long getCurrentDateResolution() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +        return currentDateResolution;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +    public void setCurrentDateResolution(Long currentDateResolution) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +        this.currentDateResolution = currentDateResolution;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +</span>
 243  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Framework
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.core.offer.dao;
  19  
  20  import org.apache.commons.logging.Log;
  21  import org.apache.commons.logging.LogFactory;
  22  import org.broadleafcommerce.common.persistence.EntityConfiguration;

  23  import org.broadleafcommerce.common.util.dao.TypedQueryBuilder;
  24  import org.broadleafcommerce.core.offer.domain.OfferAudit;
  25  import org.broadleafcommerce.core.offer.domain.OfferAuditImpl;
  26  import org.broadleafcommerce.core.order.domain.Order;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  27 +import org.broadleafcommerce.core.order.domain.OrderImpl;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import org.broadleafcommerce.core.order.service.type.OrderStatus;</span>
  29  import org.springframework.stereotype.Repository;
  30  
  31  import java.util.ArrayList;



  32  import java.util.List;
  33  
  34  import javax.annotation.Resource;
  35  import javax.persistence.EntityManager;
  36  import javax.persistence.PersistenceContext;
  37  import javax.persistence.TypedQuery;
  38  import javax.persistence.criteria.CriteriaBuilder;
  39  import javax.persistence.criteria.CriteriaQuery;
  40  import javax.persistence.criteria.Predicate;
  41  import javax.persistence.criteria.Root;
  42  
  43  @Repository(&quot;blOfferAuditDao&quot;)
  44  public class OfferAuditDaoImpl implements OfferAuditDao {
  45  
  46      protected static final Log LOG = LogFactory.getLog(OfferAuditDaoImpl.class);
  47  



  48      @PersistenceContext(unitName=&quot;blPU&quot;)
  49      protected EntityManager em;
  50  
  51      @Resource(name=&quot;blEntityConfiguration&quot;)
  52      protected EntityConfiguration entityConfiguration;
  53  













  54      @Override
  55      public OfferAudit create() {
  56          return ((OfferAudit) entityConfiguration.createEntityInstance(OfferAudit.class.getName()));
  57      }
  58  
  59      @Override
  60      public void delete(final OfferAudit offerAudit) {
  61          OfferAudit loa = offerAudit;
  62  
  63          if (!em.contains(loa)) {
  64              loa = readAuditById(offerAudit.getId());
  65          }
  66  
  67          em.remove(loa);
  68      }
  69  
  70      @Override
  71      public OfferAudit save(final OfferAudit offerAudit) {
  72          return em.merge(offerAudit);
  73      }
  74  
  75      @Override
  76      public OfferAudit readAuditById(final Long offerAuditId) {
  77          return em.find(OfferAuditImpl.class, offerAuditId);
  78      }
  79  
  80      @Override
  81      public Long countUsesByCustomer(Order order, Long customerId, Long offerId) {



















  82          CriteriaBuilder builder = em.getCriteriaBuilder();
  83          CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
  84          Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +        Root&lt;OrderImpl&gt; orderRoot = criteria.from(OrderImpl.class);</span>
  86          criteria.select(builder.count(root));
  87  











  88          List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();
  89          restrictions.add(
  90              builder.and(

  91                  builder.or(
  92                      builder.notEqual(root.get(&quot;orderId&quot;),  getOrderId(order)),
  93                      builder.isNull(root.get(&quot;orderId&quot;))
  94                  ),
  95                  builder.equal(root.get(&quot;customerId&quot;), customerId),
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -                builder.equal(root.get(&quot;offerId&quot;), offerId)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +                builder.equal(root.get(&quot;offerId&quot;), offerId),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +                builder.or(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +                        builder.isNull(root.get(&quot;orderId&quot;)),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +                        builder.and(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +                                builder.notEqual(orderRoot.get(&quot;status&quot;),OrderStatus.CANCELLED.getType()),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +                                builder.equal(orderRoot.get(&quot;id&quot;),root.get(&quot;orderId&quot;))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +                        )</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +                )</span>
 105              )
 106          );











 107  
 108          criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
 109  
 110          try {
 111              return em.createQuery(criteria).getSingleResult();
 112          } catch (Exception e) {
 113              LOG.error(&quot;Error counting offer uses by customer.&quot;, e);
 114              return null;
 115          }
 116      }
 117  
 118      protected Long getOrderId(Order order) {
 119          return order.getId();
 120      }
 121  
 122      @Deprecated
 123      @Override
 124      public Long countUsesByCustomer(Long customerId, Long offerId) {
 125          TypedQuery&lt;Long&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 126                  .addRestriction(&quot;offerAudit.customerId&quot;, &quot;=&quot;, customerId)
 127                  .addRestriction(&quot;offerAudit.offerId&quot;, &quot;=&quot;, offerId)
 128                  .toCountQuery(em);
 129  
 130          return query.getSingleResult();
 131      }
 132  
 133      @Override
 134      public Long countOfferCodeUses(Order order, Long offerCodeId) {
 135          CriteriaBuilder builder = em.getCriteriaBuilder();
 136          CriteriaQuery&lt;Long&gt; criteria = builder.createQuery(Long.class);
 137          Root&lt;OfferAuditImpl&gt; root = criteria.from(OfferAuditImpl.class);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +        Root&lt;OrderImpl&gt; orderRoot = criteria.from(OrderImpl.class);</span>
 139          criteria.select(builder.count(root));
 140  
 141          List&lt;Predicate&gt; restrictions = new ArrayList&lt;&gt;();
 142          restrictions.add(
 143              builder.and(
 144                  builder.or(
 145                      builder.notEqual(root.get(&quot;orderId&quot;),  getOrderId(order)),
 146                      builder.isNull(root.get(&quot;orderId&quot;))
 147                  ),
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -                builder.equal(root.get(&quot;offerCodeId&quot;), offerCodeId)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +                builder.equal(root.get(&quot;offerCodeId&quot;), offerCodeId),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +                builder.or(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +                        builder.isNull(root.get(&quot;orderId&quot;)),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                        builder.and(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +                                builder.notEqual(orderRoot.get(&quot;status&quot;),OrderStatus.CANCELLED.getType()),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +                                builder.equal(orderRoot.get(&quot;id&quot;),root.get(&quot;orderId&quot;))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +                        )</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +                )</span>
 157              )
 158          );
 159  
 160          criteria.where(restrictions.toArray(new Predicate[restrictions.size()]));
 161  
 162          try {
 163              return em.createQuery(criteria).getSingleResult();
 164          } catch (Exception e) {
 165              LOG.error(&quot;Error counting offer code uses.&quot;, e);
 166              return null;
 167          }
 168      }
 169  
 170      @Deprecated
 171      @Override
 172      public Long countOfferCodeUses(Long offerCodeId) {
 173          TypedQuery&lt;Long&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 174                  .addRestriction(&quot;offerAudit.offerCodeId&quot;, &quot;=&quot;, offerCodeId)
 175                  .toCountQuery(em);
 176  
 177          return query.getSingleResult();
 178      }
 179  
 180      @Override
 181      public List&lt;OfferAudit&gt; readOfferAuditsByOrderId(Long orderId) {
 182          TypedQuery&lt;OfferAudit&gt; query = new TypedQueryBuilder&lt;&gt;(OfferAudit.class, &quot;offerAudit&quot;)
 183                  .addRestriction(&quot;offerAudit.orderId&quot;, &quot;=&quot;, orderId)
 184                  .toQuery(em);
 185  
 186          return query.getResultList();
 187      }
 188  











 189  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            