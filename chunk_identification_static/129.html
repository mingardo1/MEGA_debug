<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>129</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    129
                    <a href="128.html">prev</a>
                    <a href="130.html">next</a>
                    <a href="129_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_ca7ad284b68b41fd53b2a9e24cafe6fadaee52e8_admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/service/FormBuilderServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ca7ad284b68b41fd53b2a9e24cafe6fadaee52e8:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/service/FormBuilderServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ca7ad284b68b41fd53b2a9e24cafe6fadaee52e8^1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/service/FormBuilderServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ca7ad284b68b41fd53b2a9e24cafe6fadaee52e8^2:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/service/FormBuilderServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;1d8f70a5cd049c3d229a6ef9441390c91fb57271:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/service/FormBuilderServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.service;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.Predicate;
  22 import org.apache.commons.lang.ArrayUtils;
  23 import org.apache.commons.lang.BooleanUtils;
  24 import org.apache.commons.lang3.StringUtils;
  25 import org.apache.commons.logging.Log;
  26 import org.apache.commons.logging.LogFactory;
  27 import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  28 import org.broadleafcommerce.common.exception.ExceptionHelper;
  29 import org.broadleafcommerce.common.exception.SecurityServiceException;
  30 import org.broadleafcommerce.common.exception.ServiceException;
  31 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  32 import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  33 import org.broadleafcommerce.common.i18n.service.TranslationService;
  34 import org.broadleafcommerce.common.locale.service.LocaleService;
  35 import org.broadleafcommerce.common.media.domain.MediaDto;
  36 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  37 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  38 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  39 import org.broadleafcommerce.common.presentation.client.AdornedTargetAddMethodType;
  40 import org.broadleafcommerce.common.presentation.client.LookupType;
  41 import org.broadleafcommerce.common.presentation.client.PersistencePerspectiveItemType;
  42 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  43 import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  44 import org.broadleafcommerce.common.security.service.ExploitProtectionService;
  45 import org.broadleafcommerce.common.util.BLCMessageUtils;
  46 import org.broadleafcommerce.common.util.FormatUtil;
  47 import org.broadleafcommerce.common.util.StringUtil;
  48 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  49 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  50 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  51 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  52 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  53 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  54 import org.broadleafcommerce.openadmin.dto.ClassTree;
  55 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  56 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  57 import org.broadleafcommerce.openadmin.dto.Entity;
  58 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  59 import org.broadleafcommerce.openadmin.dto.ForeignKey;
  60 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  61 import org.broadleafcommerce.openadmin.dto.MapStructure;
  62 import org.broadleafcommerce.openadmin.dto.Property;
  63 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  64 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  65 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  66 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  67 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  68 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  69 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  70 import org.broadleafcommerce.openadmin.server.security.remote.SecurityVerifier;
  71 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifier;
  72 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierConfiguration;
  73 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierData;
  74 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierDataPoint;
  75 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierRequest;
  76 import org.broadleafcommerce.openadmin.server.security.service.ExceptionAwareRowLevelSecurityProvider;
  77 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  78 import org.broadleafcommerce.openadmin.server.security.service.navigation.AdminNavigationService;
  79 import org.broadleafcommerce.openadmin.server.service.AdminEntityService;
  80 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManager;
  81 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  82 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  83 import org.broadleafcommerce.openadmin.server.service.persistence.module.FieldManager;
  84 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  85 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  86 import org.broadleafcommerce.openadmin.web.form.component.ListGridAction;
  87 import org.broadleafcommerce.openadmin.web.form.component.ListGridActionGroup;
  88 import org.broadleafcommerce.openadmin.web.form.component.ListGridRecord;
  89 import org.broadleafcommerce.openadmin.web.form.component.MediaField;
  90 import org.broadleafcommerce.openadmin.web.form.component.RuleBuilderField;
  91 import org.broadleafcommerce.openadmin.web.form.entity.CodeField;
  92 import org.broadleafcommerce.openadmin.web.form.entity.ComboField;
  93 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  94 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  95 import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  96 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  97 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  98 import org.broadleafcommerce.openadmin.web.rulebuilder.DataDTODeserializer;
  99 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataDTO;
 100 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataWrapper;
 101 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldDTO;
 102 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldWrapper;
 103 import org.codehaus.jettison.json.JSONObject;
 104 import org.springframework.beans.factory.annotation.Value;
 105 import org.springframework.context.MessageSource;
 106 import org.springframework.context.NoSuchMessageException;
 107 import org.springframework.stereotype.Service;
 108 
 109 import com.fasterxml.jackson.core.Version;
 110 import com.fasterxml.jackson.databind.ObjectMapper;
 111 import com.fasterxml.jackson.databind.module.SimpleModule;
 112 
 113 import java.io.IOException;
 114 import java.math.BigDecimal;
 115 import java.text.DateFormat;
 116 import java.text.DateFormatSymbols;
 117 import java.text.DecimalFormat;
 118 import java.text.NumberFormat;
 119 import java.text.ParseException;
 120 import java.text.SimpleDateFormat;
 121 import java.util.ArrayList;
 122 import java.util.Arrays;
 123 import java.util.Collections;
 124 import java.util.Date;
 125 import java.util.HashMap;
 126 import java.util.List;
 127 import java.util.Locale;
 128 import java.util.Map;
 129 import java.util.Map.Entry;
 130 import java.util.Set;
 131 
 132 import javax.annotation.Resource;
 133 import javax.persistence.ManyToOne;
 134 import javax.persistence.OneToOne;
 135 import javax.servlet.http.HttpServletRequest;
 136 
 137 
 138 /**
 139  * @author Andre Azzolini (apazzolini)
 140  */
 141 @Service(&quot;blFormBuilderService&quot;)
 142 public class FormBuilderServiceImpl implements FormBuilderService {
 143 
 144     private static final Log LOG = LogFactory.getLog(FormBuilderServiceImpl.class);
 145 
 146     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 147 
 148     @Resource(name = &quot;blAdminEntityService&quot;)
 149     protected AdminEntityService adminEntityService;
 150     
 151     @Resource (name = &quot;blAdminNavigationService&quot;)
 152     protected AdminNavigationService navigationService;
 153     
 154     @Resource(name = &quot;blFormBuilderExtensionManager&quot;)
 155     protected FormBuilderExtensionManager extensionManager;
 156     
 157     @Resource(name=&quot;blEntityConfiguration&quot;)
 158     protected EntityConfiguration entityConfiguration;
 159 
 160     @Resource(name=&quot;blAdminSecurityRemoteService&quot;)
 161     protected SecurityVerifier adminRemoteSecurityService;
 162     
 163     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 164     protected RowLevelSecurityService rowLevelSecurityService;
 165 
 166     @Resource(name = &quot;blMediaBuilderService&quot;)
 167     protected MediaBuilderService mediaBuilderService;
 168     
 169     @Resource(name = &quot;blListGridErrorMessageExtensionManager&quot;)
 170     protected ListGridErrorMessageExtensionManager listGridErrorExtensionManager;
 171 
 172     @Resource(name = &quot;blAdminNavigationService&quot;)
 173     protected AdminNavigationService adminNavigationService;
 174 
 175     @Resource(name = &quot;blEntityDuplicator&quot;)
 176     protected EntityDuplicator duplicator;
 177 
 178     @Resource(name = &quot;blDynamicEntityDao&quot;)
 179     protected DynamicEntityDao dynamicEntityDao;
 180 
 181     @Resource(name = &quot;blLocaleService&quot;)
 182     protected LocaleService localeService;
 183 
 184     @Resource(name = &quot;blTranslationService&quot;)
 185     protected TranslationService translationService;
 186 
 187     @Value(&quot;${use.translation.search:false}&quot;)
 188     protected boolean useTranslationSearch;
 189 
 190 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 191 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193     protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[] { </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194             VisibilityEnum.HIDDEN_ALL, VisibilityEnum.GRID_HIDDEN </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195     };</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 198     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)"> 198     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199             throws ServiceException {</span>
 200 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201     @Resource(name = &quot;blExploitProtectionService&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202     ExploitProtectionService exploitProtectionService;</span>
 203 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 204 
 205     protected static final VisibilityEnum[] FORM_HIDDEN_VISIBILITIES = new VisibilityEnum[] { 
 206             VisibilityEnum.HIDDEN_ALL, VisibilityEnum.FORM_HIDDEN
 207     };
 208     
 209     protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[] { 
 210             VisibilityEnum.HIDDEN_ALL, VisibilityEnum.GRID_HIDDEN 
 211     };
 212 
 213     @Override
<abbr title=" 214     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)"> 214     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SeðŸ”µ</abbr>
 215             throws ServiceException {
 216 
 217         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 218         ListGrid.Type type = ListGrid.Type.MAIN;
 219         String idProperty = &quot;id&quot;;
 220 
 221         FieldWrapper wrapper = new FieldWrapper();
 222         ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 223         for (Property p : cmd.getProperties()) {
 224             if (p.getMetadata() instanceof BasicFieldMetadata) {
 225                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
 226                 
 227                 if (SupportedFieldType.ID.equals(fmd.getFieldType())) {
 228                     idProperty = fmd.getName();
 229                 }
 230                 
 231                 if (fmd.isProminent() != null &amp;&amp; fmd.isProminent() 
 232                         &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), fmd.getVisibility())) {
 233                     Field hf = createHeaderField(p, fmd);
 234                     headerFields.add(hf);
 235                     defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, fmd));
 236                 }
 237 
 238                 if (fmd.getIsFilter() != null &amp;&amp; fmd.getIsFilter()) {
<abbr title=" 239                     wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmd));"> 239                     wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmdðŸ”µ</abbr>
 240                 }
 241             }
 242         }
 243 
 244         if (useTranslationSearch) {
 245             getTranslationSearchField(cmd.getCeilingType(), defaultWrapperFields);
 246         }
 247 
<abbr title=" 248         ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idProperty, sectionCrumbs);"> 248         ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, ðŸ”µ</abbr>
 249         
 250         if (CollectionUtils.isNotEmpty(listGrid.getHeaderFields())) {
 251             // Set the first column to be able to link to the main entity
 252             listGrid.getHeaderFields().iterator().next().setMainEntityLink(true);
 253         } else {
<abbr title=" 254             String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType();"> 254             String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeiðŸ”µ</abbr>
 255             message += &quot;Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 256             LOG.error(message);
 257         }
 258 
 259         Date c = new Date();
 260         String friendlyName = &quot;listGrid&quot; + c.getTime();
 261         // Set up the filter builder params
 262         listGrid.setJsonFieldName(friendlyName + &quot;Json&quot;);
 263         listGrid.setFriendlyName(friendlyName);
 264         listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 265         if (CollectionUtils.isEmpty(wrapper.getFields())) {
 266             wrapper.setFields(defaultWrapperFields);
 267         }
 268         listGrid.setFieldWrapper(wrapper);
 269         listGrid.setHideFriendlyName(true);
 270 
 271         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 272         listGrid.setJson(blankJsonString);
 273         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 274         if (dw != null) {
 275             listGrid.setDataWrapper(dw);
 276         }
 277 
 278         listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 279         listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 280 
 281         extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 282 
 283         return listGrid;
 284     }
 285 
<abbr title=" 286     private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFields) {"> 286     private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFieldsðŸ”µ</abbr>
 287 
 288         TranslatedEntity translatedEntity;
 289 
 290         try {
 291             translatedEntity = translationService.getAssignableEntityType(ceilingEntity);
 292 
 293             FieldDTO localeField = new FieldDTO();
 294             localeField.setId(&quot;translationLocale&quot;);
 295             localeField.setLabel(&quot;Translation locale&quot;);
 296             localeField.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 297             localeField.setInput(&quot;select&quot;);
 298             localeField.setType(&quot;string&quot;);
 299 
<abbr title=" 300             List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocales();"> 300             List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocaleðŸ”µ</abbr>
 301 
 302             Map&lt;String, String&gt; localeMap = new HashMap&lt;String, String&gt;();
 303             for (org.broadleafcommerce.common.locale.domain.Locale l : locales) {
 304                 localeMap.put(l.getLocaleCode(), l.getFriendlyName());
 305             }
 306             localeField.setValues((new JSONObject(localeMap)).toString());
 307 
 308             defaultWrapperFields.add(localeField);
 309         } catch (Exception e) {
 310             translatedEntity = null;
 311         }
 312     }
 313 
 314     protected FieldDTO constructFieldDTOFromFieldData(Field field, BasicFieldMetadata fmd) {
 315         FieldDTO fieldDTO = new FieldDTO();
 316         //translate the label to display
 317         String label = field.getFriendlyName();
 318         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 319         MessageSource messages = context.getMessageSource();
 320         if (messages != null) {
 321             label = messages.getMessage(label, null, label, context.getJavaLocale());
 322         }
 323         fieldDTO.setLabel(label);
 324 
 325         fieldDTO.setId(field.getName());
 326         if (field.getFieldType().equals(&quot;STRING&quot;)) {
 327             fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 328         } else if (field.getFieldType().equals(&quot;DATE&quot;)) {
 329             fieldDTO.setOperators(&quot;blcFilterOperators_Date&quot;);
<abbr title=" 330         } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldType().equals(&quot;DECIMAL&quot;)) {"> 330         } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || fieldðŸ”µ</abbr>
 331             fieldDTO.setOperators(&quot;blcFilterOperators_Numeric&quot;);
 332         } else if (field.getFieldType().equals(&quot;BOOLEAN&quot;)) {
 333             fieldDTO.setOperators(&quot;blcFilterOperators_Boolean&quot;);
 334         } else if (field.getFieldType().equals(&quot;BROADLEAF_ENUMERATION&quot;)) {
 335             fieldDTO.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 336             fieldDTO.setInput(&quot;select&quot;);
 337             fieldDTO.setType(&quot;string&quot;);
 338             String[][] enumerationValues = fmd.getEnumerationValues ();
 339 
 340             //not sure if we need to decode here or not...
 341             for(int i=0; i&lt; enumerationValues.length;i++){
 342                 enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1]);
 343             }
 344 
 345             Map&lt;String, String&gt; enumMap = new HashMap&lt;&gt;();
 346             for (int i = 0; i &lt; enumerationValues.length; i++) {
 347                 enumMap.put(enumerationValues[i][0], enumerationValues[i][1]);
 348             }
 349 
 350             fieldDTO.setValues(new JSONObject(enumMap).toString());
 351         } else if (field.getFieldType().equals(&quot;ADDITIONAL_FOREIGN_KEY&quot;)) {
 352             fieldDTO.setOperators(&quot;blcFilterOperators_Selectize&quot;);
 353             fieldDTO.setType(&quot;string&quot;);
 354 
<abbr title=" 355             AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClass(), null);"> 355             AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeðŸ”µ</abbr>
 356             if (section != null) {
 357                 String sectionKey = section.getUrl().substring(1);
 358                 fieldDTO.setSelectizeSectionKey(sectionKey);
 359             } else {
 360                 fieldDTO.setSelectizeSectionKey(fmd.getForeignKeyClass());
 361             }
 362         } else {
 363             fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 364         }
 365 
 366         return fieldDTO;
 367     }
 368     
 369     protected Field createHeaderField(Property p, BasicFieldMetadata fmd) {
 370         Field hf;
 371         if (fmd.getFieldType().equals(SupportedFieldType.EXPLICIT_ENUMERATION) ||
 372                 fmd.getFieldType().equals(SupportedFieldType.BROADLEAF_ENUMERATION) ||
 373                 fmd.getFieldType().equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION) ||
 374                 fmd.getFieldType().equals(SupportedFieldType.EMPTY_ENUMERATION)) {
 375             hf = new ComboField();
 376             String[][] enumerationValues = fmd.getEnumerationValues();
 377             for(int i=0; i&lt; enumerationValues.length;i++){
 378                 enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1]);
 379             }
 380             ((ComboField) hf).setOptions(enumerationValues);
 381         } else {
 382             hf = new Field();
 383         }
 384         
 385         hf.withName(p.getName())
<abbr title=" 386           .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getName())"> 386           .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getðŸ”µ</abbr>
 387           .withOrder(fmd.getGridOrder())
 388           .withColumnWidth(fmd.getColumnWidth())
 389           .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
 390           .withForeignKeyClass(fmd.getForeignKeyClass())
 391           .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title=" 392           .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClass())"> 392           .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClassðŸ”µ</abbr>
 393           .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity());
 394         String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 395         hf.setFieldType(fieldType);
 396         
 397         return hf;
 398     }
 399 
 400     @Override
<abbr title=" 401     public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property field, "> 401     public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property fieðŸ”µ</abbr>
 402             String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 403             throws ServiceException {
 404         FieldMetadata fmd = field.getMetadata();
 405         // Get the class metadata for this particular field
 406         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 407         if (field != null) {
 408             ppr.setSectionEntityField(field.getName());
 409         }
<abbr title=" 410         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 410         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDaðŸ”µ</abbr>
 411 
 412         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 413         ListGrid.Type type = null;
 414         boolean editable = false;
 415         boolean sortable = false;
 416         boolean readOnly = false;
 417         boolean hideIdColumn = false;
 418         boolean canFilterAndSort = true;
 419         boolean modalSingleSelectable = false;
 420         boolean modalMultiSelectable = false;
 421         boolean selectize = false;
 422         boolean isMedia = false;
 423         boolean isLookup = false;
 424         String sortProperty = null;
 425         FieldWrapper wrapper = new FieldWrapper();
 426         ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 427 
 428 
 429         String idProperty = &quot;id&quot;;
 430         for (Property property : cmd.getProperties()) {
 431             if (property.getMetadata() instanceof BasicFieldMetadata &amp;&amp;
<abbr title=" 432                     SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;&amp;"> 432                     SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;ðŸ”µ</abbr>
 433                     //make sure it&#x27;s a property for this entity - not an association
 434                     !property.getName().contains(&quot;.&quot;)) {
 435                 idProperty = property.getName();
 436                 break;
 437             }
 438         }
<abbr title=" 439         // Get the header fields for this list grid. Note that the header fields are different depending on the"> 439         // Get the header fields for this list grid. Note that the header fields are different depending ðŸ”µ</abbr>
 440         // kind of field this is.
 441         if (fmd instanceof BasicFieldMetadata) {
 442             readOnly = ((BasicFieldMetadata) fmd).getReadOnly();
 443             modalSingleSelectable = true;
 444             for (Property p : cmd.getProperties()) {
 445                 if (p.getMetadata() instanceof BasicFieldMetadata) {
 446                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 447                     
 448                     if (SupportedFieldType.ID.equals(md.getFieldType())) {
 449                         idProperty = md.getName();
 450                     }
 451                     
 452                     if (md.isProminent() != null &amp;&amp; md.isProminent() 
 453                             &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 454                         Field hf = createHeaderField(p, md);
 455                         headerFields.add(hf);
 456                         defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 457                     }
 458 
 459                     if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 460                         Field f = createHeaderField(p, md);
 461                         wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 462                     }
 463                 }
 464             }
 465 
 466             type = ListGrid.Type.TO_ONE;
 467         } else if (fmd instanceof BasicCollectionMetadata) {
 468             BasicCollectionMetadata bcm = (BasicCollectionMetadata) fmd;
 469             readOnly = !bcm.isMutable();
 470 
 471             if(AddMethodType.LOOKUP.equals(bcm.getAddMethodType())) {
 472                 isLookup = true;
 473             }
 474 
 475             if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 476                 Property p = cmd.getPMap().get(bcm.getSelectizeVisibleField());
 477                 if (p != null) {
 478                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 479 
 480                     Field hf = createHeaderField(p, md);
 481                     headerFields.add(hf);
 482                     wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 483                 }
 484             } else {
 485                 for (Property p : cmd.getProperties()) {
 486                     if (p.getMetadata() instanceof BasicFieldMetadata) {
 487                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 488                         if (md.isProminent() != null &amp;&amp; md.isProminent()
<abbr title=" 489                                 &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {"> 489                                 &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility()))ðŸ”µ</abbr>
 490                             Field hf = createHeaderField(p, md);
 491                             headerFields.add(hf);
 492                             defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 493                         }
 494 
 495                         if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 496                             Field f = createHeaderField(p, md);
 497                             wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 498                         }
 499                     }
 500                 }
 501             }
 502 
 503             type = ListGrid.Type.BASIC;
 504             
<abbr title=" 505             if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getAddMethodType())) {"> 505             if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equalðŸ”µ</abbr>
 506                 editable = true;
 507             } else if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 508                 selectize = true;
 509                 modalSingleSelectable = true;
 510             } else {
 511                 modalSingleSelectable = true;
 512             }
 513             sortable = StringUtils.isNotBlank(bcm.getSortProperty());
 514             if (sortable) {
 515                 sortProperty = bcm.getSortProperty();
 516             }
 517         } else if (fmd instanceof AdornedTargetCollectionMetadata) {
 518             modalSingleSelectable = true;
 519             readOnly = !((AdornedTargetCollectionMetadata) fmd).isMutable();
 520             AdornedTargetCollectionMetadata atcmd = (AdornedTargetCollectionMetadata) fmd;
 521 
 522             if(AdornedTargetAddMethodType.LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 523                 isLookup = true;
 524             }
 525 
<abbr title=" 526             if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {"> 526             if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())ðŸ”µ</abbr>
 527                 selectize = true;
 528 
 529                 Property p = cmd.getPMap().get(atcmd.getSelectizeVisibleField());
 530                 if (p != null) {
 531                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 532 
 533                     Field hf = createHeaderField(p, md);
 534                     headerFields.add(hf);
 535                     wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 536                 }
 537             } else {
 538                 for (String fieldName : atcmd.getGridVisibleFields()) {
 539                     Property p = cmd.getPMap().get(fieldName);
 540                     if (p != null) {
 541                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 542 
 543                         Field hf = createHeaderField(p, md);
 544                         headerFields.add(hf);
 545                         wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 546                     }
 547 
 548                 }
 549             }
 550 
 551             type = ListGrid.Type.ADORNED;
 552 
 553             if (atcmd.getMaintainedAdornedTargetFields().length &gt; 0) {
 554                 editable = true;
 555             }
 556             
 557             AdornedTargetList adornedList = (AdornedTargetList) atcmd.getPersistencePerspective()
<abbr title=" 558                     .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);"> 558                     .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLISðŸ”µ</abbr>
 559             sortable = StringUtils.isNotBlank(adornedList.getSortField());
 560             if (sortable) {
 561                 sortProperty = adornedList.getSortField();
 562             }
 563         } else if (fmd instanceof MapMetadata) {
 564             readOnly = !((MapMetadata) fmd).isMutable();
 565             MapMetadata mmd = (MapMetadata) fmd;
 566 
 567             Property p2 = cmd.getPMap().get(&quot;key&quot;);
 568             BasicFieldMetadata keyMd = (BasicFieldMetadata) p2.getMetadata();
 569             keyMd.setFriendlyName(getMapKeyFriendlyName(p2));
 570             Field hf = createHeaderField(p2, keyMd);
 571             headerFields.add(hf);
 572             wrapper.getFields().add(constructFieldDTOFromFieldData(hf, keyMd));
 573 
 574             if (mmd.isSimpleValue()) {
 575                 Property valueProperty = cmd.getPMap().get(&quot;value&quot;);
 576                 BasicFieldMetadata valueMd = (BasicFieldMetadata) valueProperty.getMetadata();
 577                 valueMd.setFriendlyName(&quot;Value&quot;);
 578                 hf = createHeaderField(valueProperty, valueMd);
 579                 headerFields.add(hf);
 580                 wrapper.getFields().add(constructFieldDTOFromFieldData(hf, valueMd));
 581 
 582                 idProperty = &quot;key&quot;;
 583                 hideIdColumn = true;
 584             } else {
 585                 for (Property p : cmd.getProperties()) {
 586                     if (p.getMetadata() instanceof BasicFieldMetadata) {
 587                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 588                         String valueClassName = mmd.getValueClassName();
 589                         if (!StringUtils.isEmpty(mmd.getToOneTargetProperty())) {
 590                             Class&lt;?&gt; clazz;
 591                             try {
 592                                 clazz = Class.forName(mmd.getValueClassName());
 593                             } catch (ClassNotFoundException e) {
 594                                 throw ExceptionHelper.refineException(e);
 595                             }
<abbr title=" 596                             java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTargetProperty());"> 596                             java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.ðŸ”µ</abbr>
 597                             ManyToOne manyToOne = nestedField.getAnnotation(ManyToOne.class);
<abbr title=" 598                             if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getName())) {"> 598                             if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.clasðŸ”µ</abbr>
 599                                 valueClassName = manyToOne.targetEntity().getName();
 600                             } else {
 601                                 OneToOne oneToOne = nestedField.getAnnotation(OneToOne.class);
<abbr title=" 602                                 if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getName())) {"> 602                                 if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.clðŸ”µ</abbr>
 603                                     valueClassName = oneToOne.targetEntity().getName();
 604                                 }
 605                             }
 606                         }
 607                         if (md.getTargetClass().equals(valueClassName)) {
 608                             if (md.isProminent() != null &amp;&amp; md.isProminent() 
<abbr title=" 609                                     &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {"> 609                                     &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibilityðŸ”µ</abbr>
 610                                 hf = createHeaderField(p, md);
 611                                 headerFields.add(hf);
 612                                 defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 613 
 614                                 // Is this a media listgrid
 615                                 if (hf.getFieldType().equals(&quot;ASSET_LOOKUP&quot;)) {
 616                                     isMedia = true;
 617                                 }
 618                             }
 619 
 620                             if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 621                                 wrapper.getFields().add(constructFieldDTOFromFieldData(hf,md));
 622                             }
 623                         }
 624                     }
 625                 }
 626             }
 627 
 628             type = ListGrid.Type.MAP;
 629             editable = true;
 630             canFilterAndSort = false;
 631         }
 632 
 633         String ceilingType = &quot;&quot;;
 634         if (fmd instanceof BasicFieldMetadata) {
 635             ceilingType = cmd.getCeilingType();
 636         } else if (fmd instanceof CollectionMetadata) {
 637             ceilingType = ((CollectionMetadata) fmd).getCollectionCeilingEntity();
 638         }
 639         
 640         if (CollectionUtils.isEmpty(headerFields)) {
<abbr title=" 641             String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; and property &#x27;&quot; +"> 641             String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingTypðŸ”µ</abbr>
 642                     StringUtil.sanitize(field.getName()) + &quot;&#x27;.&quot;;
<abbr title=" 643             if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) {"> 643             if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) ðŸ”µ</abbr>
<abbr title=" 644                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 644                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTaðŸ”µ</abbr>
 645             } else if (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM) {
<abbr title=" 646                 message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 646                 message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetðŸ”µ</abbr>
 647             } else if (selectize &amp;&amp; type == ListGrid.Type.BASIC) {
<abbr title=" 648                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuration&quot;;"> 648                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollectioðŸ”µ</abbr>
 649             } else {
 650                 message += &quot; Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 651             }
 652             LOG.error(message);
 653         }
 654 
<abbr title=" 655         ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProperty, sectionCrumbs, sortProperty);"> 655         ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrderðŸ”µ</abbr>
 656         listGrid.setSubCollectionFieldName(field.getName());
 657         listGrid.setFriendlyName(field.getMetadata().getFriendlyName());
 658         if (StringUtils.isEmpty(listGrid.getFriendlyName())) {
 659             listGrid.setFriendlyName(field.getName());
 660         }
 661         listGrid.setContainingEntityId(containingEntityId);
 662         listGrid.setIsReadOnly(readOnly);
 663         listGrid.setHideIdColumn(hideIdColumn);
 664         listGrid.setCanFilterAndSort(canFilterAndSort);
 665 
 666         // Set up the filter builder params
 667         Date c = new Date();
 668         String friendlyName = field.getMetadata().getFriendlyName();
 669         String jsonFriendlyName = friendlyName.replaceAll(&quot; &quot;, &quot;_&quot;);
 670         listGrid.setJsonFieldName(jsonFriendlyName + c.getTime() + &quot;Json&quot;);
 671         listGrid.setFriendlyName(friendlyName);
 672         listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 673         if (CollectionUtils.isEmpty(wrapper.getFields())) {
 674             wrapper.setFields(defaultWrapperFields);
 675         }
 676         listGrid.setFieldWrapper(wrapper);
 677 
 678         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 679         listGrid.setJson(blankJsonString);
 680         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 681         if (dw != null) {
 682             listGrid.setDataWrapper(dw);
 683         }
 684 
 685         if (editable) {
 686             listGrid.getRowActions().add(DefaultListGridActions.UPDATE);
 687         }
 688         if (readOnly) {
 689             listGrid.getRowActions().add(DefaultListGridActions.VIEW);
 690         }
 691         if (sortable) {
 692             listGrid.setCanFilterAndSort(false);
 693             listGrid.setIsSortable(true);
 694         }
 695 
 696         if (modalSingleSelectable) {
 697             if (readOnly) {
<abbr title=" 698                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(true));"> 698                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReðŸ”µ</abbr>
 699             } else {
 700                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 701 
 702             }
 703         }
 704         listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 705 
 706         if (selectize) {
 707             listGrid.setSelectizeUrl(buildSelectizeUrl(listGrid));
 708             listGrid.setSelectType(ListGrid.SelectType.SELECTIZE);
 709         }
 710 
 711         if (modalMultiSelectable) {
 712             listGrid.addModalRowAction(DefaultListGridActions.MULTI_SELECT);
 713             listGrid.setSelectType(ListGrid.SelectType.MULTI_SELECT);
 714         }
 715         listGrid.getRowActions().add(DefaultListGridActions.REMOVE);
 716 
 717         if (fmd.getManualFetch()) {
 718             listGrid.setManualFetch(true);
 719             listGrid.getToolbarActions().add(DefaultListGridActions.MANUAL_FETCH);
 720         }
 721         if (isMedia) {
 722             listGrid.setListGridType(ListGrid.Type.ASSET_GRID);
 723         }
 724 
 725         extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 726 
<abbr title=" 727         //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface"> 727         //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implemðŸ”µ</abbr>
 728         if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title=" 729             EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();"> 729             EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecðŸ”µ</abbr>
<abbr title=" 730             for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {"> 730             for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguratiðŸ”µ</abbr>
 731                 for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
 732                     if (modifier.isQualified(data.getModifierType())) {
 733                         modifier.modifyListGrid(new EntityFormModifierRequest()
 734                                 .withListGrid(listGrid)
 735                                 .withConfiguration(data)
 736                                 .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
 737                                 .withRowLevelSecurityService(rowLevelSecurityService));
 738                     }
 739                 }
 740             }
 741         }
 742         return listGrid;
 743     }
 744 
 745     protected String getMapKeyFriendlyName(Property property) {
 746         String friendlyNameFromMetadata = property.getMetadata().getFriendlyName();
 747 
 748         return (friendlyNameFromMetadata == null) ? &quot;Key&quot; : friendlyNameFromMetadata;
 749     }
 750 
 751     @Override
<abbr title=" 752     public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, Property field,"> 752     public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet dðŸ”µ</abbr>
 753         String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 754             throws ServiceException {
 755         FieldMetadata fmd = field.getMetadata();
 756         // Get the class metadata for this particular field
 757         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 758         if (field != null) {
 759             ppr.setSectionEntityField(field.getName());
 760         }
<abbr title=" 761         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 761         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDaðŸ”µ</abbr>
 762 
 763         Map&lt;String, Object&gt; result = constructSelectizeOptionMap(drs, cmd);
 764 
 765         AdornedTargetList adornedList = ppr.getAdornedList();
 766         if (adornedList != null &amp;&amp; adornedList.getLinkedObjectPath() != null
 767             &amp;&amp; adornedList.getTargetObjectPath() != null &amp;&amp; adornedList.getLinkedIdProperty() != null
 768             &amp;&amp; adornedList.getTargetIdProperty() != null) {
<abbr title=" 769             result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());"> 769             result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkeðŸ”µ</abbr>
 770             result.put(&quot;linkedObjectId&quot;, containingEntityId);
<abbr title=" 771             result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());"> 771             result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargeðŸ”µ</abbr>
 772         }
 773 
 774         return result;
 775     }
 776 
 777     @Override
 778     public Map&lt;String, Object&gt; constructSelectizeOptionMap(DynamicResultSet drs, ClassMetadata cmd) {
 779         Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
 780         List&lt;Map&lt;String, String&gt;&gt; options = new ArrayList&lt;&gt;();
 781 
 782         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 783         for (Property p : cmd.getProperties()) {
 784             if (p.getMetadata() instanceof BasicFieldMetadata) {
 785                 BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 786                 if (md.isProminent() != null &amp;&amp; md.isProminent()
 787                         &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 788                     Field hf = createHeaderField(p, md);
 789                     headerFields.add(hf);
 790                 }
 791             }
 792         }
 793 
 794         for (Entity e : drs.getRecords()) {
 795             Map&lt;String, String&gt; selectizeOption = new HashMap&lt;&gt;();
 796             for (Field headerField : headerFields) {
 797                 Property p = e.findProperty(headerField.getName());
 798                 if (p != null) {
 799                     selectizeOption.put(&quot;name&quot;, p.getValue());
 800                     break;
 801                 }
 802             }
 803             if (e.findProperty(&quot;id&quot;) != null) {
 804                 selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;id&quot;).getValue());
 805             //  &quot;Locale&quot; entity is a special occasion. Because it have not &quot;ID&quot; column with &quot;Long&quot; type
 806             } else if (e.findProperty(&quot;localeCode&quot;) != null) {
 807                 selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;localeCode&quot;).getValue());
 808             }
 809             if (e.findProperty(ALTERNATE_ID_PROPERTY) != null) {
 810                 selectizeOption.put(&quot;alternateId&quot;, e.findProperty(ALTERNATE_ID_PROPERTY).getValue());
 811             }
 812             options.add(selectizeOption);
 813         }
 814         result.put(&quot;options&quot;, options);
 815 
 816         return result;
 817     }
 818 
 819     protected String buildSelectizeUrl(ListGrid listGrid) {
 820         HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 821         String url = request.getContextPath();
<abbr title=" 822         url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + listGrid.getSectionKey();"> 822         url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() :ðŸ”µ</abbr>
 823         url += &quot;/&quot; + listGrid.getContainingEntityId();
 824         url += &quot;/&quot; + listGrid.getSubCollectionFieldName();
 825         return url;
 826     }
 827 
 828     /**
<abbr title=" 829      * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 829      * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, InteðŸ”µ</abbr>
 830      * @param className
 831      * @param headerFields
 832      * @param type
 833      * @param drs
 834      * @param sectionKey
 835      * @param order
 836      * @param idProperty
 837      * @param sectionCrumbs
 838      * @return
 839      */
 840     @Deprecated
<abbr title=" 841     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs, "> 841     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynðŸ”µ</abbr>
 842             String sectionKey, int order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs) {
<abbr title=" 843        return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,null);"> 843        return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,nuðŸ”µ</abbr>
 844     }
 845 
 846     /**
 847      * Populate a ListGrid with ListGridRecords.
 848      *
 849      * @param className
 850      * @param headerFields
 851      * @param type
 852      * @param drs
 853      * @param sectionKey
 854      * @param order
 855      * @param idProperty
 856      * @param sectionCrumbs
 857      * @param sortPropery
 858      * @return
 859      */
<abbr title=" 860     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 860     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynðŸ”µ</abbr>
<abbr title=" 861             String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropery) {"> 861             String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, StringðŸ”µ</abbr>
 862         // Create the list grid and set some basic attributes
 863         ListGrid listGrid = new ListGrid();
 864         listGrid.setClassName(className);
 865         listGrid.getHeaderFields().addAll(headerFields);
 866         listGrid.setListGridType(type);
 867         listGrid.setSectionCrumbs(sectionCrumbs);
 868         listGrid.setSectionKey(sectionKey);
 869         listGrid.setOrder(order);
 870         listGrid.setIdProperty(idProperty);
 871         listGrid.setStartIndex(drs.getStartIndex());
 872         listGrid.setTotalRecords(drs.getTotalRecords());
 873         listGrid.setPageSize(drs.getPageSize());
 874 
 875         String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
<abbr title=" 876         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier);"> 876         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdðŸ”µ</abbr>
 877         if (section != null) {
 878             listGrid.setExternalEntitySectionKey(section.getUrl());
 879         }
 880 
 881         // format date list grid cells
 882         SimpleDateFormat formatter = new SimpleDateFormat(&quot;MMM d, y @ hh:mma&quot;);
 883         DateFormatSymbols symbols = new DateFormatSymbols(Locale.getDefault());
 884         symbols.setAmPmStrings(new String[] { &quot;am&quot;, &quot;pm&quot; });
 885         formatter.setDateFormatSymbols(symbols);
 886 
 887         // For each of the entities (rows) in the list grid, we need to build the associated
 888         // ListGridRecord and set the required fields on the record. These fields are the same ones
 889         // that are used for the header fields.
 890         for (Entity e : drs.getRecords()) {
 891             ListGridRecord record = new ListGridRecord();
 892             record.setListGrid(listGrid);
 893             record.setDirty(e.isDirty());
 894             record.setEntity(e);
 895             if (StringUtils.isNotBlank(sortPropery) &amp;&amp; e.findProperty(sortPropery) != null) {
 896                 Property sort = e.findProperty(sortPropery);
 897                 record.setDisplayOrder(sort.getValue());
 898             }
 899             if (e.findProperty(&quot;hasError&quot;) != null) {
 900                 Boolean hasError = Boolean.parseBoolean(e.findProperty(&quot;hasError&quot;).getValue());
 901                 record.setIsError(hasError);
 902                 if (hasError) {
 903                     ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 904                             .getProxy().determineErrorMessageForEntity(e, record);
 905 
 906                     if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 907                         record.setErrorKey(&quot;listgrid.record.error&quot;);
 908                     }
 909                 }
 910             }
 911 
 912             if (e.findProperty(&quot;progressStatus&quot;) != null) {
 913                 ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 914                         .getProxy().determineStatusMessageForEntity(e, record);
 915                 if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 916                     record.setStatus(e.findProperty(&quot;progressStatus&quot;).getValue());
 917                     record.setStatusCssClass(&quot;listgrid.record.status&quot;);
 918                 }
 919             }
 920 
 921             if (e.findProperty(idProperty) != null) {
 922                 record.setId(e.findProperty(idProperty).getValue());
 923             }
 924 
 925             for (Field headerField : headerFields) {
 926                 Property p = e.findProperty(headerField.getName());
 927                 if (p != null) {
 928                     Field recordField = new Field().withName(headerField.getName())
 929                             .withFriendlyName(headerField.getFriendlyName())
 930                             .withOrder(p.getMetadata().getOrder());
 931 
 932                     if (headerField instanceof ComboField) {
 933                         recordField.setValue(((ComboField) headerField).getOption(p.getValue()));
 934                         recordField.setDisplayValue(p.getDisplayValue());
 935                     } else {
 936                         if (headerField.getFieldType().equals(&quot;DATE&quot;)) {
 937                             try {
<abbr title=" 938                                 Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue());"> 938                                 Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue(ðŸ”µ</abbr>
 939                                 String newValue = formatter.format(date);
 940                                 recordField.setValue(newValue);
 941                             } catch (Exception ex) {
 942                                 recordField.setValue(p.getValue());
 943                             }
 944                         } else {
 945                             recordField.setValue(p.getValue());
 946                         }
 947                         recordField.setDisplayValue(p.getDisplayValue());
 948                     }
 949 
 950                     recordField.setDerived(isDerivedField(headerField, recordField, p));
 951 
 952                     record.getFields().add(recordField);
 953                 }
 954             }
 955 
 956             if (e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY) != null) {
 957                 Field hiddenField = new Field().withName(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
<abbr title=" 958                 hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue());"> 958                 hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue()ðŸ”µ</abbr>
 959                 record.getHiddenFields().add(hiddenField);
 960             }
 961 
 962             if (e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY) != null) {
 963                 record.setAltId(e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY).getValue());
 964             }
 965 
 966             extensionManager.getProxy().modifyListGridRecord(className, record, e);
 967 
 968             listGrid.getRecords().add(record);
 969         }
 970 
 971         if (drs.getFirstId() != null) {
 972             listGrid.setFirstId(drs.getFirstId());
 973         }
 974         if (drs.getLastId() != null) {
 975             listGrid.setLastId(drs.getLastId());
 976         }
 977         if (drs.getUpperCount() != null) {
 978             listGrid.setUpperCount(drs.getUpperCount());
 979         }
 980         if (drs.getLowerCount() != null) {
 981             listGrid.setLowerCount(drs.getLowerCount());
 982         }
 983         if (drs.getFetchType() != null) {
 984             listGrid.setFetchType(drs.getFetchType().toString());
 985         }
 986         if (drs.getTotalCountLessThanPageSize() != null) {
 987             listGrid.setTotalCountLessThanPageSize(drs.getTotalCountLessThanPageSize());
 988         }
 989         if (drs.getPromptSearch() != null) {
 990             listGrid.setPromptSearch(drs.getPromptSearch());
 991         }
 992 
 993         return listGrid;
 994     }
 995     
 996     /**
<abbr title=" 997      * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasicFieldMetadata}"> 997      * Determines whether or not a particular field in a record is derived. By default this checks the {@ðŸ”µ</abbr>
 998      * for the given Property to see if something on the backend has marked it as derived
 999      * 
1000      * @param headerField the header for this recordField
1001      * @param recordField the recordField being populated
1002      * @param p the property that relates to this recordField
1003      * @return whether or not this field is derived
<abbr title="1004      * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}">1004      * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, StringðŸ”µ</abbr>
1005      */
1006     protected Boolean isDerivedField(Field headerField, Field recordField, Property p) {
1007         return BooleanUtils.isTrue(((BasicFieldMetadata) p.getMetadata()).getIsDerived());
1008     }
1009 
1010     protected void setEntityFormFields(ClassMetadata cmd, EntityForm ef, List&lt;Property&gt; properties) {
1011         List&lt;Field&gt; homelessFields = new ArrayList&lt;&gt;();
1012         List&lt;Field&gt; fieldsWithAssociations = new ArrayList&lt;&gt;();
1013 
1014         for (Property property : properties) {
1015             if (property.getMetadata() instanceof BasicFieldMetadata) {
1016                 BasicFieldMetadata fmd = (BasicFieldMetadata) property.getMetadata();
1017 
1018 
1019                 if (!ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
<abbr title="1020                     // Depending on visibility, field for the particular property is not created on the form">1020                     // Depending on visibility, field for the particular property is not created on the fðŸ”µ</abbr>
1021                     String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
1022                     
1023                     // Create the field and set some basic attributes
1024                     Field f;
1025                     
1026                     if (fieldType.equals(SupportedFieldType.BROADLEAF_ENUMERATION.toString())
1027                             || fieldType.equals(SupportedFieldType.EXPLICIT_ENUMERATION.toString())
1028                             || fieldType.equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION.toString())
1029                             || fieldType.equals(SupportedFieldType.EMPTY_ENUMERATION.toString())) {
<abbr title="1030                         // We&#x27;re dealing with fields that should render as drop-downs, so set their possible values">1030                         // We&#x27;re dealing with fields that should render as drop-downs, so set their possiðŸ”µ</abbr>
1031                         f = new ComboField();
1032 
1033                         String[][] enumerationValues = fmd.getEnumerationValues();
1034                         for(int i=0; i&lt; enumerationValues.length;i++){
<abbr title="1035                             enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1]);">1035                             enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValuðŸ”µ</abbr>
1036                         }
1037                         ((ComboField) f).setOptions(enumerationValues);
<abbr title="1038                         if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValue()">1038                         if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().boðŸ”µ</abbr>
1039                                 &amp;&amp; ((ComboField) f).getOptions().size() == 0) {
1040                             f.setIsVisible(false);
1041                         }
1042                     } else if (fieldType.equals(SupportedFieldType.CODE.toString())) {
1043                         f = new CodeField();
1044                     } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1045                             || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1046                             || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1047                         // We&#x27;re dealing with rule builders, so we&#x27;ll create those specialized fields
1048                         f = new RuleBuilderField();
1049                         ((RuleBuilderField) f).setJsonFieldName(property.getName() + &quot;Json&quot;);
1050                         ((RuleBuilderField) f).setDataWrapper(new DataWrapper());
1051                         ((RuleBuilderField) f).setFieldBuilder(fmd.getRuleIdentifier());
1052                         ((RuleBuilderField) f).setDisplayType(fmd.getDisplayType().toString());
1053 
1054                         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
1055                         ((RuleBuilderField) f).setJson(blankJsonString);
1056                         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
1057                         if (dw != null) {
1058                             ((RuleBuilderField) f).setDataWrapper(dw);
1059                         }
1060                         
1061                         if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())) {
1062                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple&quot;);
1063                         } else if (fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1064                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-with-quantity&quot;);
1065                         } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())) {
1066                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple-time&quot;);
1067                         }
1068                     } else if (LookupType.DROPDOWN.equals(fmd.getLookupType())) {
<abbr title="1069                         // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of in a ">1069                         // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instðŸ”µ</abbr>
<abbr title="1070                         // modal, so we&#x27;ll provision the combo field here. Available options will be set as part of a">1070                         // modal, so we&#x27;ll provision the combo field here. Available options will be set ðŸ”µ</abbr>
1071                         // subsequent operation
1072                         f = new ComboField();
1073                     } else if (fieldType.equals(SupportedFieldType.MEDIA.toString())) {
1074                         f = new MediaField();
1075                     } else {
1076                         // Create a default field since there was no specialized handler
1077                         f = new Field();
1078                     }
1079                     
1080                     Boolean required = fmd.getRequiredOverride();
1081                     if (required == null) {
1082                         required = fmd.getRequired();
1083                     }
1084 
1085                     Boolean allowNoValueEnum = fmd.getAllowNoValueEnumOption();
1086                     if (allowNoValueEnum != null) {
1087                         f.setAllowNoValueEnumOption(allowNoValueEnum);
1088                     }
1089 
1090                     f.withName(property.getName())
1091                      .withFieldType(fieldType)
1092                      .withFieldComponentRenderer(getFieldComponentRenderer(fmd))
1093                      .withGridFieldComponentRenderer(getGridFieldComponentRenderer(fmd))
1094                      .withOrder(fmd.getOrder())
1095                      .withFriendlyName(fmd.getFriendlyName())
1096                      .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
1097                      .withForeignKeyClass(fmd.getForeignKeyClass())
1098                      .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title="1099                      .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromType())">1099                      .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheriðŸ”µ</abbr>
1100                      .withRequired(required)
1101                      .withReadOnly(fmd.getReadOnly())
1102                      .withTranslatable(fmd.getTranslatable())
<abbr title="1103                      .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDERING))">1103                      .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDðŸ”µ</abbr>
1104                      .withLargeEntry(fmd.isLargeEntry())
1105                      .withHint(fmd.getHint())
1106                      .withTooltip(fmd.getTooltip())
1107                      .withHelp(fmd.getHelpText())
1108                      .withTypeaheadEnabled(fmd.getEnableTypeaheadLookup())
1109                      .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity())
1110                      .withAssociatedFieldName(fmd.getAssociatedFieldName());
1111 
1112                     String defaultValue = fmd.getDefaultValue();
1113                     if (defaultValue != null) {
1114                         defaultValue = extractDefaultValueFromFieldData(fieldType, fmd);
1115                         f.withValue(defaultValue);
1116                     }
1117 
1118                     if (StringUtils.isBlank(f.getFriendlyName())) {
1119                         f.setFriendlyName(f.getName());
1120                     }
1121 
1122                     // If is form hidden, set visible to false
1123                     if (VisibilityEnum.FORM_EXPLICITLY_HIDDEN.equals(fmd.getVisibility())) {
1124                         f.setIsVisible(false);
1125                     }
1126 
1127                     if (VisibilityEnum.VISIBLE_ALL.equals(fmd.getVisibility())) {
1128                         f.setIsVisible(true);
1129                     }
1130 
1131                     // Add the field to the appropriate FieldGroup
1132                     if (fmd.getGroup() == null) {
1133                         homelessFields.add(f);
1134                     } else {
<abbr title="1135                         ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabOrder());">1135                         ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabðŸ”µ</abbr>
1136                     }
1137 
1138                     if (StringUtils.isNotEmpty(fmd.getAssociatedFieldName())) {
1139                         fieldsWithAssociations.add(f);
1140                     }
1141                 }
1142             }
1143         }
1144 
1145         for (Field f : homelessFields) {
1146             ef.addField(cmd, f, null, null, null, null);
1147         }
1148 
1149         for (Field f : fieldsWithAssociations) {
1150             Field associatedField = findAssociatedField(ef, f);
1151             if (associatedField != null) {
1152                 associatedField.setShouldRender(false);
1153                 f.setAssociatedFieldName(associatedField.getName());
1154             } else {
1155                 f.setAssociatedFieldName(null);
1156             }
1157         }
1158     }
1159 
1160     protected String getFieldComponentRenderer(BasicFieldMetadata fmd) {
1161         if (StringUtils.isNotBlank(fmd.getFieldComponentRendererTemplate())) {
1162             return fmd.getFieldComponentRendererTemplate();
1163         }
1164         return fmd.getFieldComponentRenderer()==null?null:fmd.getFieldComponentRenderer().toString();
1165     }
1166 
1167     protected String getGridFieldComponentRenderer(BasicFieldMetadata fmd) {
1168         if (StringUtils.isNotBlank(fmd.getGridFieldComponentRendererTemplate())) {
1169             return fmd.getGridFieldComponentRendererTemplate();
1170         }
<abbr title="1171         return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toString();">1171         return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toStrinðŸ”µ</abbr>
1172     }
1173 
1174     private Field findAssociatedField(EntityForm ef, Field f) {
1175         // Try on the parent object
1176         Field associatedField = ef.findField(f.getAssociatedFieldName());
1177 
1178         if (associatedField == null) {
1179             // Check the field&#x27;s path
1180             String[] fieldPathParts = f.getName().split(&quot;\\.&quot;);
1181             String testPath = &quot;&quot;;
1182 
1183             for (String path : fieldPathParts) {
1184                 testPath += path + &quot;.&quot;;
1185 
1186                 associatedField = ef.findField(testPath + f.getAssociatedFieldName());
1187                 if (associatedField != null) {
1188                     break;
1189                 }
1190             }
1191         }
1192         return associatedField;
1193     }
1194 
1195     /**
1196      * This method gets the {@link AdminSection} for the given foreignKeyClass parameter. If none exists,
1197      * it returns the foreignKeyClass.
1198      *
1199      * @param foreignKeyClass the {@link String} class name
1200      * @return the admin section pathname
1201      */
1202     protected String getAdminSectionPath(String foreignKeyClass) {
1203         if (foreignKeyClass != null) {
<abbr title="1204             AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyClass, null);">1204             AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(fðŸ”µ</abbr>
1205             return foreignKeySection != null ? foreignKeySection.getUrl() : foreignKeyClass;
1206         }
1207         return null;
1208     }
1209 
1210     /**
<abbr title="1211      * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal to">1211      * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} iðŸ”µ</abbr>
1212      *  the processed value of another tab.
1213      *
1214      * For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a another tab where
<abbr title="1215      *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;,">1215      *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=ExamðŸ”µ</abbr>
<abbr title="1216      *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; tabs.">1216      *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; taðŸ”µ</abbr>
1217      */
1218     protected void setEntityFormTabsAndGroups(EntityForm ef, Map&lt;String, TabMetadata&gt; tabMetadataMap) {
1219         if (tabMetadataMap != null) {
1220             Set&lt;String&gt; tabMetadataKeySet = tabMetadataMap.keySet();
1221             for (String tabKey : tabMetadataKeySet) {
1222                 TabMetadata tabMetadata = tabMetadataMap.get(tabKey);
<abbr title="1223                 String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySet);">1223                 String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySeðŸ”µ</abbr>
1224 
1225                 if (foundMatchingTab(unprocessedTabName)) {
1226                     if (!tabExists(ef, unprocessedTabName)) {
1227                         TabMetadata originalTabMetadata = tabMetadataMap.get(unprocessedTabName);
1228                         unprocessedTabName = ef.addTabFromTabMetadata(originalTabMetadata);
1229                     }
1230                 } else {
1231                     if (tabExists(ef, tabKey)) {
1232                         unprocessedTabName = tabKey;
1233                     } else {
1234                         unprocessedTabName = ef.addTabFromTabMetadata(tabMetadata);
1235                     }
1236                 }
1237 
1238                 Set&lt;String&gt; groupMetadataKeySet = tabMetadata.getGroupMetadata().keySet();
1239                 for (String groupKey : groupMetadataKeySet) {
<abbr title="1240                     ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName);">1240                     ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocesseðŸ”µ</abbr>
1241                 }
1242             }
1243         }
1244     }
1245 
1246     /**
1247      * Search for any other tab on the target entity that has the same display value
1248      *  as the value provided tab name.
1249      *
<abbr title="1250      * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message property.">1250      * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message propeðŸ”µ</abbr>
<abbr title="1251      *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySet">1251      *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetaðŸ”µ</abbr>
<abbr title="1252      *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method should return">1252      *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method shoulðŸ”µ</abbr>
1253      *  &quot;Example_Tab&quot; which will end up causing the tabs to merge together.
1254      *
<abbr title="1255      * If a tab with the same display value cannot be found, then we should return null to indicate that there">1255      * If a tab with the same display value cannot be found, then we should return null to indicate that ðŸ”µ</abbr>
1256      *  is no matching tab with the same processed tabName value.
1257      */
<abbr title="1258     protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySet) {">1258     protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySðŸ”µ</abbr>
1259         for (String tabKey : tabMetadataKeySet) {
1260             String tabName = tabMetadata.getTabName();
1261 
1262             if (processedTabKeyMatchesTabName(tabName, tabKey)) {
1263                 return tabKey;
1264             }
1265         }
1266 
1267         return null;
1268     }
1269 
1270     protected boolean processedTabKeyMatchesTabName(String tabName, String candidateTabKey) {
1271         try {
1272             String processedCandidateTabKey = BLCMessageUtils.getMessage(candidateTabKey);
<abbr title="1273             boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateTabKey);">1273             boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateðŸ”µ</abbr>
1274 
<abbr title="1275             return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidateTabKey);">1275             return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidatðŸ”µ</abbr>
1276         } catch (NoSuchMessageException e) {
1277             LOG.debug(&quot;No such message exists for &quot; + candidateTabKey, e);
1278 
1279             return false;
1280         }
1281     }
1282 
1283     protected boolean foundMatchingTab(String unprocessedTabName) {
1284         return (unprocessedTabName != null);
1285     }
1286 
1287     protected boolean tabExists(EntityForm ef, String tabKey) {
1288         return (ef.findTab(tabKey) != null);
1289     }
1290 
1291     @Override
1292     public String extractDefaultValueFromFieldData(String fieldType, BasicFieldMetadata fmd) {
1293         String defaultValue = fmd.getDefaultValue();
1294         if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1295                 || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1296                 || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1297             return null;
1298         } else if (fieldType.equals(SupportedFieldType.INTEGER.toString())) {
1299             try {
<abbr title="1300                 DecimalFormat numberFormat = (DecimalFormat) NumberFormat.getInstance(BroadleafRequestContext.getBroadleafRequestContext().getJavaLocale());">1300                 DecimalFormat numberFormat = (DecimalFormat) NumberFormat.getInstance(BroadleafRequestConðŸ”µ</abbr>
1301                 Number parse = numberFormat.parse(defaultValue);
1302             } catch (NumberFormatException | ParseException e) {
<abbr title="1303                 String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defaultValue);">1303                 String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defauðŸ”µ</abbr>
1304                 LOG.debug(msg);
1305                 return null;
1306             }
1307         } else if (fieldType.equals(SupportedFieldType.DECIMAL.toString())
1308                 || fieldType.equals(SupportedFieldType.MONEY.toString())) {
1309             try {
<abbr title="1310                 DecimalFormat numberFormat = (DecimalFormat) NumberFormat.getInstance(BroadleafRequestContext.getBroadleafRequestContext().getJavaLocale());">1310                 DecimalFormat numberFormat = (DecimalFormat) NumberFormat.getInstance(BroadleafRequestConðŸ”µ</abbr>
1311                 numberFormat.setParseBigDecimal(true);
1312                 Number parse = numberFormat.parse(defaultValue);
1313             } catch (NumberFormatException | ParseException e) {
1314                 String msg = buildMsgForDefValException(fieldType.toString(), fmd, defaultValue);
1315                 LOG.debug(msg);
1316                 return null;
1317             }
1318         } else if (fieldType.equals(SupportedFieldType.BOOLEAN.toString())) {
1319             if (!defaultValue.toLowerCase().equals(&quot;true&quot;) &amp;&amp; !defaultValue.toLowerCase().equals(&quot;false&quot;)
<abbr title="1320                     &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)) {">1320                     &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)ðŸ”µ</abbr>
<abbr title="1321                 String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defaultValue);">1321                 String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defauðŸ”µ</abbr>
1322                 LOG.debug(msg);
1323                 return null;
1324             }
1325         } else if (fieldType.equals(SupportedFieldType.DATE.toString())) {
1326             DateFormat format = FormatUtil.getDateFormat();
1327             if (defaultValue.toLowerCase().contains(&quot;today&quot;)) {
1328                 defaultValue = format.format(new Date());
1329             } else {
1330                 try {
1331                     Date date = format.parse(defaultValue);
1332                     defaultValue = format.format(date);
1333                 } catch (ParseException e) {
<abbr title="1334                     String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue);">1334                     String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaðŸ”µ</abbr>
1335                     LOG.debug(msg);
1336                     return null;
1337                 }
1338             }
1339         }
1340         return defaultValue;
1341     }
1342 
<abbr title="1343     protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue) {">1343     protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue)ðŸ”µ</abbr>
<abbr title="1344         return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - Failed to parse &quot; ">1344         return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot;ðŸ”µ</abbr>
<abbr title="1345                 + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue) + &quot; ]&quot;;">1345                 + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue)ðŸ”µ</abbr>
1346     }
1347 
1348     @Override
1349     public void removeNonApplicableFields(ClassMetadata cmd, EntityForm entityForm, String entityType) {
1350         for (Property p : cmd.getProperties()) {
1351             if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entityType)) {
1352                 entityForm.removeField(p.getName());
1353             }
1354         }
1355     }
1356 
1357     @Override
1358     public EntityForm createEntityForm(ClassMetadata cmd, List&lt;SectionCrumb&gt; sectionCrumbs)
1359             throws ServiceException {
1360         EntityForm ef = createStandardEntityForm();
1361         populateEntityForm(cmd, ef, sectionCrumbs);
1362         return ef;
1363     }
1364     
1365     protected String extractSectionIdentifierFromCrumb(List&lt;SectionCrumb&gt; sectionCrumbs) {
1366         if (sectionCrumbs != null &amp;&amp; sectionCrumbs.size() &gt; 0) {
1367             return sectionCrumbs.get(0).getSectionIdentifier();
1368         } else {
1369             return null;
1370         }
1371     }
1372 
1373     @Override
1374     public void populateEntityForm(ClassMetadata cmd, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)
1375             throws ServiceException {
1376         ef.setCeilingEntityClassname(cmd.getCeilingType());
1377         
1378         String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
1379 
<abbr title="1380         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType(),">1380         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType()ðŸ”µ</abbr>
1381                 sectionIdentifier);
1382         if (section != null) {
1383             ef.setSectionKey(section.getUrl());
1384         } else {
1385             ef.setSectionKey(cmd.getCeilingType());
1386         }
1387         ef.setSectionCrumbsImpl(sectionCrumbs);
1388 
1389         setEntityFormTabsAndGroups(ef, cmd.getTabAndGroupMetadata());
1390 
1391         setEntityFormFields(cmd, ef, Arrays.asList(cmd.getProperties()));
1392         
1393         populateDropdownToOneFields(ef, cmd);
1394         
1395         extensionManager.getProxy().modifyUnpopulatedEntityForm(ef);
1396     }
1397     
1398     /**
1399      * This method is invoked when EntityForms are created and is meant to provide a hook to add
1400      * additional entity form actions for implementors of Broadleaf. Broadleaf modules will typically
1401      * leverage {@link FormBuilderExtensionHandler#addAdditionalFormActions(EntityForm)} method.
1402      * @param ef
1403      */
1404     protected void addAdditionalFormActions(EntityForm ef) {
1405         
1406     }
1407     
1408     @Override
<abbr title="1409     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbs)">1409     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbsðŸ”µ</abbr>
1410             throws ServiceException {
1411         EntityForm ef = createStandardEntityForm();
1412         populateEntityForm(cmd, entity, ef, sectionCrumbs);
1413         addAdditionalFormActions(ef);
1414         extensionManager.getProxy().addAdditionalFormActions(ef);
1415         return ef;
1416     }
1417 
1418     @Override
<abbr title="1419     public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1419     public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; seðŸ”µ</abbr>
1420             throws ServiceException {
1421         // Get the empty form with appropriate fields
1422         populateEntityForm(cmd, ef, sectionCrumbs);
1423 
1424         String idProperty = adminEntityService.getIdProperty(cmd);
1425         ef.setId(entity.findProperty(idProperty).getValue());
1426         ef.setEntityType(entity.getType()[0]);
1427 
1428         populateEntityFormFieldValues(cmd, entity, ef);
1429 
1430         Property p = entity.findProperty(BasicPersistenceModule.MAIN_ENTITY_NAME_PROPERTY);
1431         if (p != null) {
1432             ef.setMainEntityName(exploitProtectionService.htmlDecode(p.getValue()));
1433         }
1434         
1435         extensionManager.getProxy().modifyPopulatedEntityForm(ef, entity);
1436     }
1437 
<abbr title="1438     protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef) {">1438     protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef)ðŸ”µ</abbr>
1439         for (Property p : cmd.getProperties()) {
1440             FieldMetadata fmd = p.getMetadata();
1441 
1442             if (shouldHideField(fmd, entity)) {
1443                 if (fmd instanceof CollectionMetadata) {
1444                     ef.removeListGrid(p.getName());
1445                 } else {
1446                     ef.removeField(p.getName());
1447                 }
1448             }
1449         }
1450     }
1451 
1452     protected boolean shouldHideField(FieldMetadata fmd, Entity entity) {
1453         if (fmd == null || fmd.getShowIfFieldEquals() == null) {
1454             return false;
1455         }
1456 
1457         for (String property : fmd.getShowIfFieldEquals().keySet()) {
1458             List&lt;String&gt; values = fmd.getShowIfFieldEquals().get(property);
1459             Property entityProp = entity.findProperty(property);
1460 
1461             if (entityProp == null || values.contains(entityProp.getValue())) {
1462                 return false;
1463             }
1464         }
1465         return true;
1466     }
1467 
1468     @Override
1469     public void populateEntityFormFieldValues(ClassMetadata cmd, Entity entity, EntityForm ef) {
1470         // Set the appropriate property values
1471         for (Property p : cmd.getProperties()) {
1472             if (p.getMetadata() instanceof BasicFieldMetadata) {
1473                 BasicFieldMetadata basicFM = (BasicFieldMetadata) p.getMetadata();
1474 
1475                 Property entityProp = entity.findProperty(p.getName());
1476                 
<abbr title="1477                 boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibility());">1477                 boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibiliðŸ”µ</abbr>
1478                 //always show special map fields
1479                 if (p.getName().equals(&quot;key&quot;) || p.getName().equals(&quot;priorKey&quot;)) {
1480                     explicitlyShown = true;
1481                 }
1482                 
1483                 if (entityProp == null &amp;&amp; explicitlyShown) {
1484                     Field field = ef.findField(p.getName());
1485                     if (field != null) {
1486                         field.setValue(null);
1487                     }
<abbr title="1488                 } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1488                 } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getEðŸ”µ</abbr>
1489                     ef.removeField(p.getName());
1490                 } else {
1491                     Field field = ef.findField(p.getName());
1492                     if (field != null) {
1493                         if (entityProp != null) {
<abbr title="1494                             //protect against null - can happen with password confirmation fields (i.e. admin user)">1494                             //protect against null - can happen with password confirmation fields (i.e. aðŸ”µ</abbr>
1495                             field.setDirty(entityProp.getIsDirty());
1496                         }
1497                         if (basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE
1498                                 || basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE_TIME
1499                                 || basicFM.getFieldType()==SupportedFieldType.RULE_WITH_QUANTITY) {
1500                             RuleBuilderField rbf = (RuleBuilderField) field;
1501                             if (entity.getPMap().containsKey(rbf.getJsonFieldName())) {
1502                                 String json = entity.getPMap().get(rbf.getJsonFieldName()).getValue();
1503                                 rbf.setJson(json);
1504                                 DataWrapper dw = convertJsonToDataWrapper(json);
1505                                 if (dw != null) {
1506                                     rbf.setDataWrapper(dw);
1507                                 }
1508                             }
1509                         } 
1510                         if (basicFM.getFieldType() == SupportedFieldType.MEDIA) {
1511                             field.setValue(exploitProtectionService.htmlDecode(entityProp.getValue()));
1512                             field.setDisplayValue(entityProp.getDisplayValue());
1513                             MediaField mf = (MediaField) field;
<abbr title="1514                             Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(), MediaDto.class);">1514                             Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.gðŸ”µ</abbr>
<abbr title="1515                             mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(), type));">1515                             mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodeðŸ”µ</abbr>
<abbr title="1516                         } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1516                         } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldTyðŸ”µ</abbr>
<abbr title="1517                             field.setValue((basicFM.isLargeEntry() != null &amp;&amp; basicFM.isLargeEntry()) ? entityProp.getValue() : exploitProtectionService.htmlDecode(entityProp.getValue()));">1517                             field.setValue((basicFM.isLargeEntry() != null &amp;&amp; basicFM.isLargeEntry()) ? eðŸ”µ</abbr>
1518                             field.setDisplayValue(entityProp.getDisplayValue());
1519                         }
1520                     }
1521                 }
1522             }
1523         }
1524     }
1525 
1526     /**
1527      * When using Thymeleaf, we need to convert the JSON string back to
1528      * a DataWrapper object because Thymeleaf escapes JSON strings.
1529      * Thymeleaf uses it&#x27;s own object de-serializer
1530      * see: https://github.com/thymeleaf/thymeleaf/issues/84
1531      * see: http://forum.thymeleaf.org/Spring-Javascript-and-escaped-JSON-td4024739.html
1532      * @param json
1533      * @return DataWrapper
1534      * @throws IOException
1535      */
1536     protected DataWrapper convertJsonToDataWrapper(String json) {
1537         ObjectMapper mapper = new ObjectMapper();
1538         DataDTODeserializer dtoDeserializer = new DataDTODeserializer();
<abbr title="1539         SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null));">1539         SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, nuðŸ”µ</abbr>
1540         module.addDeserializer(DataDTO.class, dtoDeserializer);
1541         mapper.registerModule(module);
1542         try {
1543             return mapper.readValue(json, DataWrapper.class);
1544         } catch (IOException e) {
1545             throw new RuntimeException(e);
1546         }
1547     }
1548     
1549     protected void populateDropdownToOneFields(EntityForm ef, ClassMetadata cmd) 
1550             throws ServiceException {
1551         for (Property p : cmd.getProperties()) {
1552             if (p.getMetadata() instanceof BasicFieldMetadata) {
1553                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
1554                 if (LookupType.DROPDOWN.equals(fmd.getLookupType())
1555                         &amp;&amp; !ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
1556                     // Get the records
1557                     PersistencePackageRequest toOnePpr = PersistencePackageRequest.standard()
1558                             .withCeilingEntityClassname(fmd.getForeignKeyClass());
<abbr title="1559                     Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecords();">1559                     Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecoðŸ”µ</abbr>
1560                     
1561                     // Determine the id field
1562                     String idProp = null;
<abbr title="1563                     ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSet().getClassMetaData();">1563                     ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamðŸ”µ</abbr>
1564                     for (Property foreignP : foreignClassMd.getProperties()) {
1565                         if (foreignP.getMetadata() instanceof BasicFieldMetadata) {
1566                             BasicFieldMetadata foreignFmd = (BasicFieldMetadata) foreignP.getMetadata();
1567                             if (SupportedFieldType.ID.equals(foreignFmd.getFieldType())) {
1568                                 idProp = foreignP.getName();
1569                             }
1570                         }
1571                     }
1572                     
1573                     if (idProp == null) {
<abbr title="1574                         throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClass());">1574                         throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeigðŸ”µ</abbr>
1575                     }
1576                     
1577                     // Determine the display field
1578                     String displayProp = fmd.getLookupDisplayProperty();
1579                     
1580                     // Build the options map
1581                     Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
1582                     for (Entity row : rows) {
1583                         Property prop = row.findProperty(displayProp);
1584                         if (prop == null) {
<abbr title="1585                             LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entity [&quot; + ">1585                             LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + ðŸ”µ</abbr>
1586                                     ef.getCeilingEntityClassname() + &quot;]&quot;);
1587                         } else {
1588                             String displayValue = prop.getDisplayValue();
1589                             if (StringUtils.isBlank(displayValue)) {
1590                                 displayValue = prop.getValue();
1591                             }
1592                             options.put(row.findProperty(idProp).getValue(), displayValue);
1593                         }
1594                     }
1595                     
1596                     // Set the options on the entity field
1597                     ComboField cf = (ComboField) ef.findField(p.getName());
1598                     cf.setOptions(options);
1599                 }
1600             }
1601         }
1602     }
1603 
1604     @Override
<abbr title="1605     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, List&lt;SectionCrumb&gt; sectionCrumbs)">1605     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; coðŸ”µ</abbr>
1606             throws ServiceException {
1607         EntityForm ef = createStandardEntityForm();
1608         populateEntityForm(cmd, entity, collectionRecords, ef, sectionCrumbs);
1609         addAdditionalFormActions(ef);
1610         extensionManager.getProxy().addAdditionalFormActions(ef);
1611         return ef;
1612     }
1613     
1614     @Override
<abbr title="1615     public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1615     public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collecðŸ”µ</abbr>
1616             throws ServiceException {
1617         // Get the form with values for this entity
1618         populateEntityForm(cmd, entity, ef, sectionCrumbs);
1619         
1620         // Attach the sub-collection list grids and specialty UI support
1621         for (Property p : cmd.getProperties()) {
1622             if (p.getMetadata() instanceof BasicFieldMetadata) {
1623                 continue;
1624             }
1625             
1626             if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entity.getType()[0])) {
1627                 continue;
1628             }
1629 
1630             if (collectionRecords != null &amp;&amp; !collectionRecords.isEmpty()) {
1631                 DynamicResultSet subCollectionEntities = collectionRecords.get(p.getName());
1632                 String containingEntityId = entity.getPMap().get(ef.getIdProperty()).getValue();
<abbr title="1633                 ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSectionKey(), sectionCrumbs);">1633                 ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p,ðŸ”µ</abbr>
1634 
1635                 CollectionMetadata md = ((CollectionMetadata) p.getMetadata());
1636                 if (md instanceof BasicCollectionMetadata) {
<abbr title="1637                     PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);">1637                     PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCruðŸ”µ</abbr>
<abbr title="1638                     ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1638                     ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResuðŸ”µ</abbr>
1639                     if (collectionCmd.getPolymorphicEntities().getChildren().length != 0) {
<abbr title="1640                         List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTrees();">1640                         List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedðŸ”µ</abbr>
1641                         ListGridActionGroup actionGroup = new ListGridActionGroup().withName(&quot;Add&quot;);
1642                         for (ClassTree entityType : entityTypes) {
1643                             ListGridAction ADD = new ListGridAction(ListGridAction.ADD)
1644                                     .withButtonClass(AddMethodType.PERSIST_EMPTY==
<abbr title="1645                                             ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-grid-add-empty&quot;:&quot;sub-list-grid-add&quot;)">1645                                             ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-gðŸ”µ</abbr>
1646                                     .withActionTargetEntity(entityType.getFullyQualifiedClassname())
1647                                     .withUrlPostfix(&quot;/add&quot;)
1648                                     .withIconClass(&quot;fa fa-plus&quot;)
<abbr title="1649                                     .withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyName()));">1649                                     .withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyNamðŸ”µ</abbr>
1650                             actionGroup.getListGridActions().add(0, ADD);
1651                         }
1652                         listGrid.addToolbarActionGroup(actionGroup);
1653                     } else {
1654                         listGrid.getToolbarActions().add(0, AddMethodType.PERSIST_EMPTY==
<abbr title="1655                                 ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ADD_EMPTY:DefaultListGridActions.ADD);">1655                                 ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ðŸ”µ</abbr>
1656                     }
1657                 } else {
1658                     listGrid.getToolbarActions().add(0, DefaultListGridActions.ADD);
1659                 }
1660 
1661                 if (subCollectionEntities.getUnselectedTabMetadata().get(md.getTab())!=null) {
1662                     ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), true);
1663                 } else {
1664                     ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), false);
1665                 }
1666             }
1667         }
1668 
1669         if (CollectionUtils.isEmpty(ef.getActions())) {
1670             ef.addAction(DefaultEntityFormActions.SAVE);
1671         }
1672         
1673         addDeleteActionIfAllowed(ef, cmd, entity);
1674         addDuplicateActionIfAllowed(ef, cmd);
1675         setReadOnlyState(ef, cmd, entity);
1676 
1677         // check for fields that should be hidden based on annotations
1678         setVisibilityBasedOnShowIfFieldEquals(cmd, entity, ef);
1679 
1680         extensionManager.getProxy().modifyDetailEntityForm(ef);
1681     }
1682     
1683     /**
<abbr title="1684      * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The user can">1684      * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/bðŸ”µ</abbr>
1685      * delete an entity for the following cases:
1686      * &lt;ol&gt;
<abbr title="1687      *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represented by">1687      *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represenðŸ”µ</abbr>
<abbr title="1688      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;">1688      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/lðŸ”µ</abbr>
1689      *  &lt;li&gt;The user has the security necessary to delete the given &lt;b&gt;entity&lt;/b&gt; according to the
1690      *  {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}&lt;/li&gt;
1691      * &lt;/ol&gt;
1692      * 
1693      * @param entityForm the form being generated
1694      * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1695      * @param entity the entity being edited
1696      * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1697      * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1698      * @see {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}
1699      */
1700     protected void addDeleteActionIfAllowed(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1701         if (isDeletionAllowed(entityForm, cmd, entity)) {
1702             entityForm.addAction(DefaultEntityFormActions.DELETE);
1703         }
1704     }
1705     
1706     protected boolean isDeletionAllowed(final EntityForm entityForm, final ClassMetadata cmd, 
1707             final Entity entity) {
1708         try {
1709             String securityEntityClassname = getSecurityClassname(entityForm, cmd);
1710             adminRemoteSecurityService
1711                     .securityCheck(securityEntityClassname, EntityOperationType.REMOVE);
1712         } catch (ServiceException e) {
1713             if (e instanceof SecurityServiceException) {
1714                 return false;
1715             }
1716         }
1717 
1718         final AdminUser persistentAdminUser = adminRemoteSecurityService.getPersistentAdminUser();
1719         
1720         return rowLevelSecurityService.canUpdate(persistentAdminUser, entity)
1721                 &amp;&amp; rowLevelSecurityService.canRemove(persistentAdminUser, entity);
1722     }
1723     
1724     protected void addDuplicateActionIfAllowed(final EntityForm entityForm,
1725             final ClassMetadata cmd) {
1726         if (isDuplicationAllowed(entityForm, cmd)) {
1727             entityForm.addAction(DefaultEntityFormActions.DUPLICATE);
1728         }
1729     }
1730 
1731     protected boolean isDuplicationAllowed(final EntityForm entityForm, final ClassMetadata cmd) {
1732         final String securityClassname = getSecurityClassname(entityForm, cmd);
1733 
1734         try {
1735             adminRemoteSecurityService.securityCheck(securityClassname, EntityOperationType.ADD);
1736         } catch (ServiceException e) {
1737             if (e instanceof SecurityServiceException) {
1738                 return false;
1739             }
1740         }
1741 
1742         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(securityClassname);
1743         
1744         return duplicator.validate(entityClass, Long.valueOf(entityForm.getId())) &amp;&amp; 
1745                 rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), 
1746                         securityClassname, cmd);
1747     }
1748     
1749     /**
1750      * The given &lt;b&gt;entityForm&lt;/b&gt; is marked as readonly for the following cases:
1751      * &lt;ol&gt;
1752      *  &lt;li&gt;All of the properties from &lt;b&gt;cmd&lt;/b&gt; are readonly&lt;/b&gt;&lt;/li&gt;
<abbr title="1753      *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represented by">1753      *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class namðŸ”µ</abbr>
<abbr title="1754      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;">1754      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/lðŸ”µ</abbr>
<abbr title="1755      *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to the">1755      *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to ðŸ”µ</abbr>
1756      *  {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}&lt;/li&gt;
1757      * &lt;/ol&gt;
1758      * 
1759      * @param entityForm the form being generated
1760      * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1761      * @param entity the entity being edited
1762      * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1763      * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1764      * @see {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}
1765      */
1766     protected void setReadOnlyState(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1767         boolean readOnly = true;
1768         
1769         // If all of the fields are read only, we&#x27;ll mark the form as such
1770         for (Property property : cmd.getProperties()) {
1771             FieldMetadata fieldMetadata = property.getMetadata();
1772             if (fieldMetadata instanceof BasicFieldMetadata) {
<abbr title="1773                 readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieldMetadata).getReadOnly();">1773                 readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetaðŸ”µ</abbr>
1774                 if (!readOnly) {
1775                     break;
1776                 }
1777             } else {
1778                 readOnly = ((CollectionMetadata) fieldMetadata).isMutable();
1779                 if (!readOnly) {
1780                     break;
1781                 }
1782             }
1783         }
1784 
1785         if (!readOnly) {
<abbr title="1786             // If the user does not have edit permissions, we will go ahead and make the form read only to prevent confusion">1786             // If the user does not have edit permissions, we will go ahead and make the form read only tðŸ”µ</abbr>
1787             try {
1788                 String securityEntityClassname = getSecurityClassname(entityForm, cmd);
<abbr title="1789                 adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDATE);">1789                 adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDðŸ”µ</abbr>
1790             } catch (ServiceException e) {
1791                 if (e instanceof SecurityServiceException) {
1792                     readOnly = true;
1793                 }
1794             }
1795         }
1796         
<abbr title="1797         // if the normal admin security service has not deemed this readonly and the all of the properties on the entity">1797         // if the normal admin security service has not deemed this readonly and the all of the propertieðŸ”µ</abbr>
1798         // are not readonly, then check the row-level security
1799         if (!readOnly) {
<abbr title="1800             readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1800             readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUsðŸ”µ</abbr>
1801         }
1802 
1803         if (readOnly) {
1804             entityForm.setReadOnly();
<abbr title="1805             //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface">1805             //If someone has replaced RowLevelSecurityService, check here to make sure the replacement imðŸ”µ</abbr>
1806             if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title="1807                 EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();">1807                 EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLeveðŸ”µ</abbr>
<abbr title="1808                 for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {">1808                 for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguðŸ”µ</abbr>
1809                     for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
1810                         if (modifier.isQualified(data.getModifierType())) {
1811                             modifier.modifyEntityForm(new EntityFormModifierRequest()
1812                                     .withEntityForm(entityForm)
1813                                     .withConfiguration(data)
1814                                     .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
1815                                     .withEntity(entity)
1816                                     .withRowLevelSecurityService(rowLevelSecurityService));
1817                         }
1818                     }
1819                 }
1820             }
1821         }
1822     }
1823     
1824     /**
1825      * Obtains the class name suitable for passing along to the {@link SecurityVerifier}
1826      * @param entityForm
1827      * @param cmd
1828      * @return
1829      */
1830     protected String getSecurityClassname(EntityForm entityForm, ClassMetadata cmd) {
1831         String securityEntityClassname = entityForm.getCeilingEntityClassname();
1832 
1833         if (!StringUtils.isEmpty(cmd.getSecurityCeilingType())) {
1834             securityEntityClassname = cmd.getSecurityCeilingType();
1835         } else {
1836             if (entityForm.getDynamicFormInfos() != null) {
1837                 for (DynamicEntityFormInfo info : entityForm.getDynamicFormInfos().values()) {
1838                     if (!StringUtils.isEmpty(info.getSecurityCeilingClassName())) {
1839                         securityEntityClassname = info.getSecurityCeilingClassName();
1840                         break;
1841                     }
1842                 }
1843             }
1844         }
1845         
1846         return securityEntityClassname;
1847     }
1848     
1849     @Override
1850     public void populateEntityFormFields(EntityForm ef, Entity entity) {
1851         populateEntityFormFields(ef, entity, true, true);
1852     }
1853 
1854     @Override
<abbr title="1855     public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean populateId) {">1855     public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean popuðŸ”µ</abbr>
1856         if (populateId) {
1857             ef.setId(entity.findProperty(ef.getIdProperty()).getValue());
1858         }
1859         if (populateType) {
1860             ef.setEntityType(entity.getType()[0]);
1861         }
1862 
1863         for (Entry&lt;String, Field&gt; entry : ef.getFields().entrySet()) {
1864             Property entityProp = entity.findProperty(entry.getKey());
1865             if (entityProp != null) {
1866                 entry.getValue().setValue(entityProp.getValue());
1867                 entry.getValue().setDisplayValue(entityProp.getDisplayValue());
1868             }
1869         }
1870     }
1871 
1872     @Override
<abbr title="1873     public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedList) {">1873     public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedLiðŸ”µ</abbr>
<abbr title="1874         Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());">1874         Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdPropeðŸ”µ</abbr>
1875         Property entityProp = entity.findProperty(ef.getIdProperty());
1876         field.setValue(entityProp.getValue());
1877 
1878         if (StringUtils.isNotBlank(adornedList.getSortField())) {
1879             field = ef.findField(adornedList.getSortField());
1880             entityProp = entity.findProperty(adornedList.getSortField());
1881             if (field != null &amp;&amp; entityProp != null) {
1882                 field.setValue(entityProp.getValue());
1883             }
1884         }
1885     }
1886 
1887     @Override
1888     public void populateMapEntityFormFields(EntityForm ef, Entity entity) {
1889         Field field = ef.findField(&quot;priorKey&quot;);
1890         Property entityProp = entity.findProperty(&quot;key&quot;);
1891         if (field != null &amp;&amp; entityProp != null) {
1892             field.setValue(entityProp.getValue());
1893         }
1894     }
1895 
1896     @Override
<abbr title="1897     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1897     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList aðŸ”µ</abbr>
<abbr title="1898             String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1898             String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdðŸ”µ</abbr>
1899             throws ServiceException {
1900         EntityForm ef = createStandardAdornedEntityForm();
<abbr title="1901         return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAdd);">1901         return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrðŸ”µ</abbr>
1902     }
1903     
1904     @Override
<abbr title="1905     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1905     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList aðŸ”µ</abbr>
<abbr title="1906             String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1906             String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbðŸ”µ</abbr>
1907             throws ServiceException {
1908         ef.setEntityType(adornedList.getAdornedTargetEntityClassname());
1909 
1910         // Get the metadata for this adorned field
1911         PersistencePackageRequest request = PersistencePackageRequest.adorned()
1912                 .withCeilingEntityClassname(adornedMd.getCollectionCeilingEntity())
1913                 .withAdornedList(adornedList)
1914                 .withSectionCrumbs(sectionCrumbs);
1915         request.setAddOperationInspect(isAdd);
<abbr title="1916         ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getClassMetaData();">1916         ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSðŸ”µ</abbr>
1917 
1918         List&lt;Property&gt; entityFormProperties = new ArrayList&lt;&gt;();
1919         if (isViewCollectionItem) {
1920             Collections.addAll(entityFormProperties, collectionMetadata.getProperties());
1921         } else {
1922             // We want our entity form to only render the maintained adorned target fields
1923             for (String targetFieldName : adornedMd.getMaintainedAdornedTargetFields()) {
1924                 Property p = collectionMetadata.getPMap().get(targetFieldName);
<abbr title="1925                 if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExcluded())) {">1925                 if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadatðŸ”µ</abbr>
1926                     ((BasicFieldMetadata) p.getMetadata()).setVisibility(VisibilityEnum.VISIBLE_ALL);
1927                     entityFormProperties.add(p);
1928                 }
1929             }
1930         }
1931 
1932         // Set the maintained fields on the form
1933         setEntityFormFields(collectionMetadata, ef, entityFormProperties);
1934 
1935         // Add these two additional hidden fields that are required for persistence
1936         Field f = new Field()
1937                 .withName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty())
1938                 .withFieldType(SupportedFieldType.HIDDEN.toString())
1939                 .withValue(parentId);
1940         ef.addHiddenField(collectionMetadata, f);
1941 
1942         f = new Field()
1943                 .withName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty())
1944                 .withFieldType(SupportedFieldType.HIDDEN.toString())
1945                 .withIdOverride(&quot;adornedTargetIdProperty&quot;);
1946         ef.addHiddenField(collectionMetadata, f);
1947 
1948         if (StringUtils.isNotBlank(adornedList.getSortField())) {
1949             f = new Field()
1950                     .withName(adornedList.getSortField())
1951                     .withFieldType(SupportedFieldType.HIDDEN.toString());
1952             ef.addHiddenField(collectionMetadata, f);
1953         }
1954 
1955         ef.setParentId(parentId);
1956 
1957         extensionManager.getProxy().addAdditionalAdornedFormActions(ef);
1958 
1959         return ef;
1960     }
1961 
1962 
1963     @Override
<abbr title="1964     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId)">1964     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd,ðŸ”µ</abbr>
1965             throws ServiceException {
1966         EntityForm ef = createStandardEntityForm();
1967         return buildMapForm(mapMd, mapStructure, cmd, parentId, ef);
1968     }
1969     
1970     @Override
<abbr title="1971     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId, EntityForm ef)">1971     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd,ðŸ”µ</abbr>
1972             throws ServiceException {
1973         ForeignKey foreignKey = (ForeignKey) mapMd.getPersistencePerspective()
1974                 .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY);
1975         ef.setEntityType(foreignKey.getForeignKeyClass());
1976 
1977         Field keyField;
1978         if (!mapMd.getForceFreeFormKeys()) {
1979             // We will use a combo field to render the key choices
1980             ComboField temp = new ComboField();
1981             temp.withName(&quot;key&quot;)
1982                     .withFieldType(&quot;combo_field&quot;)
1983                     .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1984             if (mapMd.getKeys() != null) {
1985                 // The keys can be explicitly set in the annotation...
1986                 temp.setOptions(mapMd.getKeys());
1987             } else {
1988                 // Or they could be based on a different entity
1989                 PersistencePackageRequest ppr = PersistencePackageRequest.standard()
1990                         .withCeilingEntityClassname(mapMd.getMapKeyOptionEntityClass());
1991 
1992                 DynamicResultSet drs = adminEntityService.getRecords(ppr).getDynamicResultSet();
1993     
1994                 for (Entity entity : drs.getRecords()) {
<abbr title="1995                     String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getValue();">1995                     String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getVaðŸ”µ</abbr>
<abbr title="1996                     String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getValue();">1996                     String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayFieldðŸ”µ</abbr>
1997                     temp.putOption(keyValue, keyDisplayValue);
1998                 }
1999             }
2000             keyField = temp;
2001         } else {
2002             keyField = new Field().withName(&quot;key&quot;)
2003                                 .withFieldType(SupportedFieldType.STRING.toString())
2004                                 .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
2005         }
2006         keyField.setRequired(true);
2007         ef.addMapKeyField(cmd, keyField);
2008         
2009         // Set the fields for this form
2010         List&lt;Property&gt; mapFormProperties;
2011         if (mapMd.isSimpleValue()) {
2012             ef.setIdProperty(&quot;key&quot;);
2013             mapFormProperties = new ArrayList&lt;&gt;();
2014             Property valueProp = cmd.getPMap().get(&quot;value&quot;);
2015             mapFormProperties.add(valueProp);
2016         } else {
2017             String valueClassName = mapStructure.getValueClassName();
2018             List&lt;String&gt; classNames = getValueClassNames(valueClassName);
2019 
2020             mapFormProperties = new ArrayList&lt;&gt;(Arrays.asList(cmd.getProperties()));
2021             filterMapFormProperties(mapFormProperties, classNames);
2022         }
2023 
2024         setEntityFormFields(cmd, ef, mapFormProperties);
2025 
2026         Field f = new Field()
2027                 .withName(&quot;priorKey&quot;)
2028                 .withFieldType(SupportedFieldType.HIDDEN.toString());
2029         ef.addHiddenField(cmd, f);
2030 
2031         ef.setParentId(parentId);
2032 
2033         return ef;
2034     }
2035 
2036     protected List&lt;String&gt; getValueClassNames(String valueClassName) {
2037         PersistenceManager pm = PersistenceManagerFactory.getPersistenceManager(valueClassName);
2038         List&lt;String&gt; classNames = new ArrayList&lt;&gt;();
2039         try {
2040             Class&lt;?&gt;[] mapEntities = pm.getPolymorphicEntities(valueClassName);
2041             for (Class clazz : mapEntities) {
2042                 classNames.add(clazz.getName());
2043             }
2044         } catch (ClassNotFoundException e) {
2045             classNames.add(valueClassName);
2046         }
2047         return classNames;
2048     }
2049 
<abbr title="2050     protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNames) {">2050     protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNameðŸ”µ</abbr>
2051         CollectionUtils.filter(mapFormProperties, new Predicate() {
2052             @Override
2053             public boolean evaluate(Object object) {
2054                 Property p = (Property) object;
2055                 for (String availType : p.getMetadata().getAvailableToTypes()) {
2056                     if (classNames.contains(availType)) {
2057                         return true;
2058                     }
2059                 }
2060                 return false;
2061             }
2062         });
2063     }
2064 
2065     protected EntityForm createStandardEntityForm() {
2066         EntityForm ef = new EntityForm();
2067         ef.addAction(DefaultEntityFormActions.SAVE);
2068         return ef;
2069     }
2070 
2071     protected EntityForm createStandardAdornedEntityForm() {
2072         EntityForm ef = new EntityForm();
2073         ef.addAction(DefaultAdornedEntityFormActions.Add);
2074         return ef;
2075     }
2076     
2077     protected VisibilityEnum[] getGridHiddenVisibilities() {
2078         return FormBuilderServiceImpl.GRID_HIDDEN_VISIBILITIES;
2079     }
2080     
2081     protected VisibilityEnum[] getFormHiddenVisibilities() {
2082         return FormBuilderServiceImpl.FORM_HIDDEN_VISIBILITIES;
2083     }
2084 
2085 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.service;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.Predicate;
  22 import org.apache.commons.lang.ArrayUtils;
  23 import org.apache.commons.lang.BooleanUtils;
  24 import org.apache.commons.lang3.StringUtils;
  25 import org.apache.commons.logging.Log;
  26 import org.apache.commons.logging.LogFactory;
  27 import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  28 import org.broadleafcommerce.common.exception.ExceptionHelper;
  29 import org.broadleafcommerce.common.exception.SecurityServiceException;
  30 import org.broadleafcommerce.common.exception.ServiceException;
  31 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  32 import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  33 import org.broadleafcommerce.common.i18n.service.TranslationService;
  34 import org.broadleafcommerce.common.locale.service.LocaleService;
  35 import org.broadleafcommerce.common.media.domain.MediaDto;
  36 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  37 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  38 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  39 import org.broadleafcommerce.common.presentation.client.AdornedTargetAddMethodType;
  40 import org.broadleafcommerce.common.presentation.client.LookupType;
  41 import org.broadleafcommerce.common.presentation.client.PersistencePerspectiveItemType;
  42 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  43 import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  44 import org.broadleafcommerce.common.security.service.ExploitProtectionService;
  45 import org.broadleafcommerce.common.util.BLCMessageUtils;
  46 import org.broadleafcommerce.common.util.FormatUtil;
  47 import org.broadleafcommerce.common.util.StringUtil;
  48 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  49 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  50 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  51 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  52 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  53 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  54 import org.broadleafcommerce.openadmin.dto.ClassTree;
  55 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  56 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  57 import org.broadleafcommerce.openadmin.dto.Entity;
  58 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  59 import org.broadleafcommerce.openadmin.dto.ForeignKey;
  60 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  61 import org.broadleafcommerce.openadmin.dto.MapStructure;
  62 import org.broadleafcommerce.openadmin.dto.Property;
  63 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  64 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  65 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  66 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  67 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  68 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  69 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  70 import org.broadleafcommerce.openadmin.server.security.remote.SecurityVerifier;
  71 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifier;
  72 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierConfiguration;
  73 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierData;
  74 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierDataPoint;
  75 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierRequest;
  76 import org.broadleafcommerce.openadmin.server.security.service.ExceptionAwareRowLevelSecurityProvider;
  77 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  78 import org.broadleafcommerce.openadmin.server.security.service.navigation.AdminNavigationService;
  79 import org.broadleafcommerce.openadmin.server.service.AdminEntityService;
  80 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManager;
  81 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  82 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  83 import org.broadleafcommerce.openadmin.server.service.persistence.module.FieldManager;
  84 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  85 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  86 import org.broadleafcommerce.openadmin.web.form.component.ListGridAction;
  87 import org.broadleafcommerce.openadmin.web.form.component.ListGridActionGroup;
  88 import org.broadleafcommerce.openadmin.web.form.component.ListGridRecord;
  89 import org.broadleafcommerce.openadmin.web.form.component.MediaField;
  90 import org.broadleafcommerce.openadmin.web.form.component.RuleBuilderField;
  91 import org.broadleafcommerce.openadmin.web.form.entity.CodeField;
  92 import org.broadleafcommerce.openadmin.web.form.entity.ComboField;
  93 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  94 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  95 import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  96 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  97 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  98 import org.broadleafcommerce.openadmin.web.rulebuilder.DataDTODeserializer;
  99 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataDTO;
 100 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataWrapper;
 101 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldDTO;
 102 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldWrapper;
 103 import org.codehaus.jettison.json.JSONObject;
 104 import org.springframework.beans.factory.annotation.Value;
 105 import org.springframework.context.MessageSource;
 106 import org.springframework.context.NoSuchMessageException;
 107 import org.springframework.stereotype.Service;
 108 
 109 import com.fasterxml.jackson.core.Version;
 110 import com.fasterxml.jackson.databind.ObjectMapper;
 111 import com.fasterxml.jackson.databind.module.SimpleModule;
 112 
 113 import java.io.IOException;
 114 import java.math.BigDecimal;
 115 import java.text.DateFormat;
 116 import java.text.DateFormatSymbols;
 117 import java.text.DecimalFormat;
 118 import java.text.NumberFormat;
 119 import java.text.ParseException;
 120 import java.text.SimpleDateFormat;
 121 import java.util.ArrayList;
 122 import java.util.Arrays;
 123 import java.util.Collections;
 124 import java.util.Date;
 125 import java.util.HashMap;
 126 import java.util.List;
 127 import java.util.Locale;
 128 import java.util.Map;
 129 import java.util.Map.Entry;
 130 import java.util.Set;
 131 
 132 import javax.annotation.Resource;
 133 import javax.persistence.ManyToOne;
 134 import javax.persistence.OneToOne;
 135 import javax.servlet.http.HttpServletRequest;
 136 
 137 
 138 /**
 139  * @author Andre Azzolini (apazzolini)
 140  */
 141 @Service(&quot;blFormBuilderService&quot;)
 142 public class FormBuilderServiceImpl implements FormBuilderService {
 143 
 144     private static final Log LOG = LogFactory.getLog(FormBuilderServiceImpl.class);
 145 
 146     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 147 
 148     @Resource(name = &quot;blAdminEntityService&quot;)
 149     protected AdminEntityService adminEntityService;
 150 
 151     @Resource (name = &quot;blAdminNavigationService&quot;)
 152     protected AdminNavigationService navigationService;
 153 
 154     @Resource(name = &quot;blFormBuilderExtensionManager&quot;)
 155     protected FormBuilderExtensionManager extensionManager;
 156 
 157     @Resource(name=&quot;blEntityConfiguration&quot;)
 158     protected EntityConfiguration entityConfiguration;
 159 
 160     @Resource(name=&quot;blAdminSecurityRemoteService&quot;)
 161     protected SecurityVerifier adminRemoteSecurityService;
 162 
 163     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 164     protected RowLevelSecurityService rowLevelSecurityService;
 165 
 166     @Resource(name = &quot;blMediaBuilderService&quot;)
 167     protected MediaBuilderService mediaBuilderService;
 168 
 169     @Resource(name = &quot;blListGridErrorMessageExtensionManager&quot;)
 170     protected ListGridErrorMessageExtensionManager listGridErrorExtensionManager;
 171 
 172     @Resource(name = &quot;blAdminNavigationService&quot;)
 173     protected AdminNavigationService adminNavigationService;
 174 
 175     @Resource(name = &quot;blEntityDuplicator&quot;)
 176     protected EntityDuplicator duplicator;
 177 
 178     @Resource(name = &quot;blDynamicEntityDao&quot;)
 179     protected DynamicEntityDao dynamicEntityDao;
 180 
 181     @Resource(name = &quot;blLocaleService&quot;)
 182     protected LocaleService localeService;
 183 
 184     @Resource(name = &quot;blTranslationService&quot;)
 185     protected TranslationService translationService;
 186 
 187     @Value(&quot;${use.translation.search:false}&quot;)
 188     protected boolean useTranslationSearch;
 189 
 190     @Resource(name = &quot;blExploitProtectionService&quot;)
 191     ExploitProtectionService exploitProtectionService;
 192 
 193 
 194     protected static final VisibilityEnum[] FORM_HIDDEN_VISIBILITIES = new VisibilityEnum[] {
 195             VisibilityEnum.HIDDEN_ALL, VisibilityEnum.FORM_HIDDEN
 196     };
 197 
 198     protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[] {
 199             VisibilityEnum.HIDDEN_ALL, VisibilityEnum.GRID_HIDDEN
 200     };
 201 
 202     @Override
<abbr title=" 203     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)"> 203     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SeðŸ”µ</abbr>
 204             throws ServiceException {
 205 
 206         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 207         ListGrid.Type type = ListGrid.Type.MAIN;
 208         String idProperty = &quot;id&quot;;
 209 
 210         FieldWrapper wrapper = new FieldWrapper();
 211         ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 212         for (Property p : cmd.getProperties()) {
 213             if (p.getMetadata() instanceof BasicFieldMetadata) {
 214                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
 215 
 216                 if (SupportedFieldType.ID.equals(fmd.getFieldType())) {
 217                     idProperty = fmd.getName();
 218                 }
 219 
 220                 if (fmd.isProminent() != null &amp;&amp; fmd.isProminent()
 221                         &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), fmd.getVisibility())) {
 222                     Field hf = createHeaderField(p, fmd);
 223                     headerFields.add(hf);
 224                     defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, fmd));
 225                 }
 226 
 227                 if (fmd.getIsFilter() != null &amp;&amp; fmd.getIsFilter()) {
<abbr title=" 228                     wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmd));"> 228                     wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmdðŸ”µ</abbr>
 229                 }
 230             }
 231         }
 232 
 233         if (useTranslationSearch) {
 234             getTranslationSearchField(cmd.getCeilingType(), defaultWrapperFields);
 235         }
 236 
<abbr title=" 237         ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idProperty, sectionCrumbs);"> 237         ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, ðŸ”µ</abbr>
 238 
 239         if (CollectionUtils.isNotEmpty(listGrid.getHeaderFields())) {
 240             // Set the first column to be able to link to the main entity
 241             listGrid.getHeaderFields().iterator().next().setMainEntityLink(true);
 242         } else {
<abbr title=" 243             String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType();"> 243             String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeiðŸ”µ</abbr>
 244             message += &quot;Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 245             LOG.error(message);
 246         }
 247 
 248         Date c = new Date();
 249         String friendlyName = &quot;listGrid&quot; + c.getTime();
 250         // Set up the filter builder params
 251         listGrid.setJsonFieldName(friendlyName + &quot;Json&quot;);
 252         listGrid.setFriendlyName(friendlyName);
 253         listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 254         if (CollectionUtils.isEmpty(wrapper.getFields())) {
 255             wrapper.setFields(defaultWrapperFields);
 256         }
 257         listGrid.setFieldWrapper(wrapper);
 258         listGrid.setHideFriendlyName(true);
 259 
 260         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 261         listGrid.setJson(blankJsonString);
 262         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 263         if (dw != null) {
 264             listGrid.setDataWrapper(dw);
 265         }
 266 
 267         listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 268         listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 269 
 270         extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 271 
 272         return listGrid;
 273     }
 274 
<abbr title=" 275     private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFields) {"> 275     private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFieldsðŸ”µ</abbr>
 276 
 277         TranslatedEntity translatedEntity;
 278 
 279         try {
 280             translatedEntity = translationService.getAssignableEntityType(ceilingEntity);
 281 
 282             FieldDTO localeField = new FieldDTO();
 283             localeField.setId(&quot;translationLocale&quot;);
 284             localeField.setLabel(&quot;Translation locale&quot;);
 285             localeField.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 286             localeField.setInput(&quot;select&quot;);
 287             localeField.setType(&quot;string&quot;);
 288 
<abbr title=" 289             List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocales();"> 289             List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocaleðŸ”µ</abbr>
 290 
 291             Map&lt;String, String&gt; localeMap = new HashMap&lt;String, String&gt;();
 292             for (org.broadleafcommerce.common.locale.domain.Locale l : locales) {
 293                 localeMap.put(l.getLocaleCode(), l.getFriendlyName());
 294             }
 295             localeField.setValues((new JSONObject(localeMap)).toString());
 296 
 297             defaultWrapperFields.add(localeField);
 298         } catch (Exception e) {
 299             translatedEntity = null;
 300         }
 301     }
 302 
 303     protected FieldDTO constructFieldDTOFromFieldData(Field field, BasicFieldMetadata fmd) {
 304         FieldDTO fieldDTO = new FieldDTO();
 305         //translate the label to display
 306         String label = field.getFriendlyName();
 307         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 308         MessageSource messages = context.getMessageSource();
 309         if (messages != null) {
 310             label = messages.getMessage(label, null, label, context.getJavaLocale());
 311         }
 312         fieldDTO.setLabel(label);
 313 
 314         fieldDTO.setId(field.getName());
 315         if (field.getFieldType().equals(&quot;STRING&quot;)) {
 316             fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 317         } else if (field.getFieldType().equals(&quot;DATE&quot;)) {
 318             fieldDTO.setOperators(&quot;blcFilterOperators_Date&quot;);
<abbr title=" 319         } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldType().equals(&quot;DECIMAL&quot;)) {"> 319         } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || fieldðŸ”µ</abbr>
 320             fieldDTO.setOperators(&quot;blcFilterOperators_Numeric&quot;);
 321         } else if (field.getFieldType().equals(&quot;BOOLEAN&quot;)) {
 322             fieldDTO.setOperators(&quot;blcFilterOperators_Boolean&quot;);
 323         } else if (field.getFieldType().equals(&quot;BROADLEAF_ENUMERATION&quot;)) {
 324             fieldDTO.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 325             fieldDTO.setInput(&quot;select&quot;);
 326             fieldDTO.setType(&quot;string&quot;);
 327             String[][] enumerationValues = fmd.getEnumerationValues ();
 328 
 329             //not sure if we need to decode here or not...
 330             for(int i=0; i&lt; enumerationValues.length;i++){
 331                 enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1]);
 332             }
 333 
 334             Map&lt;String, String&gt; enumMap = new HashMap&lt;&gt;();
 335             for (int i = 0; i &lt; enumerationValues.length; i++) {
 336                 enumMap.put(enumerationValues[i][0], enumerationValues[i][1]);
 337             }
 338 
 339             fieldDTO.setValues(new JSONObject(enumMap).toString());
 340         } else if (field.getFieldType().equals(&quot;ADDITIONAL_FOREIGN_KEY&quot;)) {
 341             fieldDTO.setOperators(&quot;blcFilterOperators_Selectize&quot;);
 342             fieldDTO.setType(&quot;string&quot;);
 343 
<abbr title=" 344             AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClass(), null);"> 344             AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeðŸ”µ</abbr>
 345             if (section != null) {
 346                 String sectionKey = section.getUrl().substring(1);
 347                 fieldDTO.setSelectizeSectionKey(sectionKey);
 348             } else {
 349                 fieldDTO.setSelectizeSectionKey(fmd.getForeignKeyClass());
 350             }
 351         } else {
 352             fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 353         }
 354 
 355         return fieldDTO;
 356     }
 357 
 358     protected Field createHeaderField(Property p, BasicFieldMetadata fmd) {
 359         Field hf;
 360         if (fmd.getFieldType().equals(SupportedFieldType.EXPLICIT_ENUMERATION) ||
 361                 fmd.getFieldType().equals(SupportedFieldType.BROADLEAF_ENUMERATION) ||
 362                 fmd.getFieldType().equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION) ||
 363                 fmd.getFieldType().equals(SupportedFieldType.EMPTY_ENUMERATION)) {
 364             hf = new ComboField();
 365             String[][] enumerationValues = fmd.getEnumerationValues();
 366             for(int i=0; i&lt; enumerationValues.length;i++){
 367                 enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1]);
 368             }
 369             ((ComboField) hf).setOptions(enumerationValues);
 370         } else {
 371             hf = new Field();
 372         }
 373 
 374         hf.withName(p.getName())
<abbr title=" 375           .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getName())"> 375           .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getðŸ”µ</abbr>
 376           .withOrder(fmd.getGridOrder())
 377           .withColumnWidth(fmd.getColumnWidth())
 378           .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
 379           .withForeignKeyClass(fmd.getForeignKeyClass())
 380           .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title=" 381           .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClass())"> 381           .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClassðŸ”µ</abbr>
 382           .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity());
 383         String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 384         hf.setFieldType(fieldType);
 385 
 386         return hf;
 387     }
 388 
 389     @Override
<abbr title=" 390     public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property field,"> 390     public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property fieðŸ”µ</abbr>
 391             String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 392             throws ServiceException {
 393         FieldMetadata fmd = field.getMetadata();
 394         // Get the class metadata for this particular field
 395         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 396         if (field != null) {
 397             ppr.setSectionEntityField(field.getName());
 398         }
<abbr title=" 399         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 399         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDaðŸ”µ</abbr>
 400 
 401         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 402         ListGrid.Type type = null;
 403         boolean editable = false;
 404         boolean sortable = false;
 405         boolean readOnly = false;
 406         boolean hideIdColumn = false;
 407         boolean canFilterAndSort = true;
 408         boolean modalSingleSelectable = false;
 409         boolean modalMultiSelectable = false;
 410         boolean selectize = false;
 411         boolean isMedia = false;
 412         boolean isLookup = false;
 413         String sortProperty = null;
 414         FieldWrapper wrapper = new FieldWrapper();
 415         ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 416 
 417 
 418         String idProperty = &quot;id&quot;;
 419         for (Property property : cmd.getProperties()) {
 420             if (property.getMetadata() instanceof BasicFieldMetadata &amp;&amp;
<abbr title=" 421                     SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;&amp;"> 421                     SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;ðŸ”µ</abbr>
 422                     //make sure it&#x27;s a property for this entity - not an association
 423                     !property.getName().contains(&quot;.&quot;)) {
 424                 idProperty = property.getName();
 425                 break;
 426             }
 427         }
<abbr title=" 428         // Get the header fields for this list grid. Note that the header fields are different depending on the"> 428         // Get the header fields for this list grid. Note that the header fields are different depending ðŸ”µ</abbr>
 429         // kind of field this is.
 430         if (fmd instanceof BasicFieldMetadata) {
 431             readOnly = ((BasicFieldMetadata) fmd).getReadOnly();
 432             modalSingleSelectable = true;
 433             for (Property p : cmd.getProperties()) {
 434                 if (p.getMetadata() instanceof BasicFieldMetadata) {
 435                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 436 
 437                     if (SupportedFieldType.ID.equals(md.getFieldType())) {
 438                         idProperty = md.getName();
 439                     }
 440 
 441                     if (md.isProminent() != null &amp;&amp; md.isProminent()
 442                             &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 443                         Field hf = createHeaderField(p, md);
 444                         headerFields.add(hf);
 445                         defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 446                     }
 447 
 448                     if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 449                         Field f = createHeaderField(p, md);
 450                         wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 451                     }
 452                 }
 453             }
 454 
 455             type = ListGrid.Type.TO_ONE;
 456         } else if (fmd instanceof BasicCollectionMetadata) {
 457             BasicCollectionMetadata bcm = (BasicCollectionMetadata) fmd;
 458             readOnly = !bcm.isMutable();
 459 
 460             if(AddMethodType.LOOKUP.equals(bcm.getAddMethodType())) {
 461                 isLookup = true;
 462             }
 463 
 464             if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 465                 Property p = cmd.getPMap().get(bcm.getSelectizeVisibleField());
 466                 if (p != null) {
 467                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 468 
 469                     Field hf = createHeaderField(p, md);
 470                     headerFields.add(hf);
 471                     wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 472                 }
 473             } else {
 474                 for (Property p : cmd.getProperties()) {
 475                     if (p.getMetadata() instanceof BasicFieldMetadata) {
 476                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 477                         if (md.isProminent() != null &amp;&amp; md.isProminent()
<abbr title=" 478                                 &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {"> 478                                 &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility()))ðŸ”µ</abbr>
 479                             Field hf = createHeaderField(p, md);
 480                             headerFields.add(hf);
 481                             defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 482                         }
 483 
 484                         if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 485                             Field f = createHeaderField(p, md);
 486                             wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 487                         }
 488                     }
 489                 }
 490             }
 491 
 492             type = ListGrid.Type.BASIC;
 493 
<abbr title=" 494             if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getAddMethodType())) {"> 494             if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equalðŸ”µ</abbr>
 495                 editable = true;
 496             } else if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 497                 selectize = true;
 498                 modalSingleSelectable = true;
 499             } else {
 500                 modalSingleSelectable = true;
 501             }
 502             sortable = StringUtils.isNotBlank(bcm.getSortProperty());
 503             if (sortable) {
 504                 sortProperty = bcm.getSortProperty();
 505             }
 506         } else if (fmd instanceof AdornedTargetCollectionMetadata) {
 507             modalSingleSelectable = true;
 508             readOnly = !((AdornedTargetCollectionMetadata) fmd).isMutable();
 509             AdornedTargetCollectionMetadata atcmd = (AdornedTargetCollectionMetadata) fmd;
 510 
 511             if(AdornedTargetAddMethodType.LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 512                 isLookup = true;
 513             }
 514 
<abbr title=" 515             if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {"> 515             if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())ðŸ”µ</abbr>
 516                 selectize = true;
 517 
 518                 Property p = cmd.getPMap().get(atcmd.getSelectizeVisibleField());
 519                 if (p != null) {
 520                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 521 
 522                     Field hf = createHeaderField(p, md);
 523                     headerFields.add(hf);
 524                     wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 525                 }
 526             } else {
 527                 for (String fieldName : atcmd.getGridVisibleFields()) {
 528                     Property p = cmd.getPMap().get(fieldName);
 529                     if (p != null) {
 530                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 531 
 532                         Field hf = createHeaderField(p, md);
 533                         headerFields.add(hf);
 534                         wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 535                     }
 536 
 537                 }
 538             }
 539 
 540             type = ListGrid.Type.ADORNED;
 541 
 542             if (atcmd.getMaintainedAdornedTargetFields().length &gt; 0) {
 543                 editable = true;
 544             }
 545 
 546             AdornedTargetList adornedList = (AdornedTargetList) atcmd.getPersistencePerspective()
<abbr title=" 547                     .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);"> 547                     .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLISðŸ”µ</abbr>
 548             sortable = StringUtils.isNotBlank(adornedList.getSortField());
 549             if (sortable) {
 550                 sortProperty = adornedList.getSortField();
 551             }
 552         } else if (fmd instanceof MapMetadata) {
 553             readOnly = !((MapMetadata) fmd).isMutable();
 554             MapMetadata mmd = (MapMetadata) fmd;
 555 
 556             Property p2 = cmd.getPMap().get(&quot;key&quot;);
 557             BasicFieldMetadata keyMd = (BasicFieldMetadata) p2.getMetadata();
 558             keyMd.setFriendlyName(getMapKeyFriendlyName(p2));
 559             Field hf = createHeaderField(p2, keyMd);
 560             headerFields.add(hf);
 561             wrapper.getFields().add(constructFieldDTOFromFieldData(hf, keyMd));
 562 
 563             if (mmd.isSimpleValue()) {
 564                 Property valueProperty = cmd.getPMap().get(&quot;value&quot;);
 565                 BasicFieldMetadata valueMd = (BasicFieldMetadata) valueProperty.getMetadata();
 566                 valueMd.setFriendlyName(&quot;Value&quot;);
 567                 hf = createHeaderField(valueProperty, valueMd);
 568                 headerFields.add(hf);
 569                 wrapper.getFields().add(constructFieldDTOFromFieldData(hf, valueMd));
 570 
 571                 idProperty = &quot;key&quot;;
 572                 hideIdColumn = true;
 573             } else {
 574                 for (Property p : cmd.getProperties()) {
 575                     if (p.getMetadata() instanceof BasicFieldMetadata) {
 576                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 577                         String valueClassName = mmd.getValueClassName();
 578                         if (!StringUtils.isEmpty(mmd.getToOneTargetProperty())) {
 579                             Class&lt;?&gt; clazz;
 580                             try {
 581                                 clazz = Class.forName(mmd.getValueClassName());
 582                             } catch (ClassNotFoundException e) {
 583                                 throw ExceptionHelper.refineException(e);
 584                             }
<abbr title=" 585                             java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTargetProperty());"> 585                             java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.ðŸ”µ</abbr>
 586                             ManyToOne manyToOne = nestedField.getAnnotation(ManyToOne.class);
<abbr title=" 587                             if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getName())) {"> 587                             if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.clasðŸ”µ</abbr>
 588                                 valueClassName = manyToOne.targetEntity().getName();
 589                             } else {
 590                                 OneToOne oneToOne = nestedField.getAnnotation(OneToOne.class);
<abbr title=" 591                                 if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getName())) {"> 591                                 if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.clðŸ”µ</abbr>
 592                                     valueClassName = oneToOne.targetEntity().getName();
 593                                 }
 594                             }
 595                         }
 596                         if (md.getTargetClass().equals(valueClassName)) {
 597                             if (md.isProminent() != null &amp;&amp; md.isProminent()
<abbr title=" 598                                     &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {"> 598                                     &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibilityðŸ”µ</abbr>
 599                                 hf = createHeaderField(p, md);
 600                                 headerFields.add(hf);
 601                                 defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 602 
 603                                 // Is this a media listgrid
 604                                 if (hf.getFieldType().equals(&quot;ASSET_LOOKUP&quot;)) {
 605                                     isMedia = true;
 606                                 }
 607                             }
 608 
 609                             if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 610                                 wrapper.getFields().add(constructFieldDTOFromFieldData(hf,md));
 611                             }
 612                         }
 613                     }
 614                 }
 615             }
 616 
 617             type = ListGrid.Type.MAP;
 618             editable = true;
 619             canFilterAndSort = false;
 620         }
 621 
 622         String ceilingType = &quot;&quot;;
 623         if (fmd instanceof BasicFieldMetadata) {
 624             ceilingType = cmd.getCeilingType();
 625         } else if (fmd instanceof CollectionMetadata) {
 626             ceilingType = ((CollectionMetadata) fmd).getCollectionCeilingEntity();
 627         }
 628 
 629         if (CollectionUtils.isEmpty(headerFields)) {
<abbr title=" 630             String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; and property &#x27;&quot; +"> 630             String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingTypðŸ”µ</abbr>
 631                     StringUtil.sanitize(field.getName()) + &quot;&#x27;.&quot;;
<abbr title=" 632             if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) {"> 632             if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) ðŸ”µ</abbr>
<abbr title=" 633                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 633                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTaðŸ”µ</abbr>
 634             } else if (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM) {
<abbr title=" 635                 message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 635                 message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetðŸ”µ</abbr>
 636             } else if (selectize &amp;&amp; type == ListGrid.Type.BASIC) {
<abbr title=" 637                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuration&quot;;"> 637                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollectioðŸ”µ</abbr>
 638             } else {
 639                 message += &quot; Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 640             }
 641             LOG.error(message);
 642         }
 643 
<abbr title=" 644         ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProperty, sectionCrumbs, sortProperty);"> 644         ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrderðŸ”µ</abbr>
 645         listGrid.setSubCollectionFieldName(field.getName());
 646         listGrid.setFriendlyName(field.getMetadata().getFriendlyName());
 647         if (StringUtils.isEmpty(listGrid.getFriendlyName())) {
 648             listGrid.setFriendlyName(field.getName());
 649         }
 650         listGrid.setContainingEntityId(containingEntityId);
 651         listGrid.setIsReadOnly(readOnly);
 652         listGrid.setHideIdColumn(hideIdColumn);
 653         listGrid.setCanFilterAndSort(canFilterAndSort);
 654 
 655         // Set up the filter builder params
 656         Date c = new Date();
 657         String friendlyName = field.getMetadata().getFriendlyName();
 658         String jsonFriendlyName = friendlyName.replaceAll(&quot; &quot;, &quot;_&quot;);
 659         listGrid.setJsonFieldName(jsonFriendlyName + c.getTime() + &quot;Json&quot;);
 660         listGrid.setFriendlyName(friendlyName);
 661         listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 662         if (CollectionUtils.isEmpty(wrapper.getFields())) {
 663             wrapper.setFields(defaultWrapperFields);
 664         }
 665         listGrid.setFieldWrapper(wrapper);
 666 
 667         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 668         listGrid.setJson(blankJsonString);
 669         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 670         if (dw != null) {
 671             listGrid.setDataWrapper(dw);
 672         }
 673 
 674         if (editable) {
 675             listGrid.getRowActions().add(DefaultListGridActions.UPDATE);
 676         }
 677         if (readOnly) {
 678             listGrid.getRowActions().add(DefaultListGridActions.VIEW);
 679         }
 680         if (sortable) {
 681             listGrid.setCanFilterAndSort(false);
 682             listGrid.setIsSortable(true);
 683         }
 684 
 685         if (modalSingleSelectable) {
 686             if (readOnly) {
<abbr title=" 687                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(true));"> 687                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReðŸ”µ</abbr>
 688             } else {
 689                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 690 
 691             }
 692         }
 693         listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 694 
 695         if (selectize) {
 696             listGrid.setSelectizeUrl(buildSelectizeUrl(listGrid));
 697             listGrid.setSelectType(ListGrid.SelectType.SELECTIZE);
 698         }
 699 
 700         if (modalMultiSelectable) {
 701             listGrid.addModalRowAction(DefaultListGridActions.MULTI_SELECT);
 702             listGrid.setSelectType(ListGrid.SelectType.MULTI_SELECT);
 703         }
 704         listGrid.getRowActions().add(DefaultListGridActions.REMOVE);
 705 
 706         if (fmd.getManualFetch()) {
 707             listGrid.setManualFetch(true);
 708             listGrid.getToolbarActions().add(DefaultListGridActions.MANUAL_FETCH);
 709         }
 710         if (isMedia) {
 711             listGrid.setListGridType(ListGrid.Type.ASSET_GRID);
 712         }
 713 
 714         extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 715 
<abbr title=" 716         //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface"> 716         //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implemðŸ”µ</abbr>
 717         if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title=" 718             EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();"> 718             EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecðŸ”µ</abbr>
<abbr title=" 719             for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {"> 719             for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguratiðŸ”µ</abbr>
 720                 for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
 721                     if (modifier.isQualified(data.getModifierType())) {
 722                         modifier.modifyListGrid(new EntityFormModifierRequest()
 723                                 .withListGrid(listGrid)
 724                                 .withConfiguration(data)
 725                                 .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
 726                                 .withRowLevelSecurityService(rowLevelSecurityService));
 727                     }
 728                 }
 729             }
 730         }
 731         return listGrid;
 732     }
 733 
 734     protected String getMapKeyFriendlyName(Property property) {
 735         String friendlyNameFromMetadata = property.getMetadata().getFriendlyName();
 736 
 737         return (friendlyNameFromMetadata == null) ? &quot;Key&quot; : friendlyNameFromMetadata;
 738     }
 739 
 740     @Override
<abbr title=" 741     public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, Property field,"> 741     public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet dðŸ”µ</abbr>
 742         String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 743             throws ServiceException {
 744         FieldMetadata fmd = field.getMetadata();
 745         // Get the class metadata for this particular field
 746         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 747         if (field != null) {
 748             ppr.setSectionEntityField(field.getName());
 749         }
<abbr title=" 750         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 750         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDaðŸ”µ</abbr>
 751 
 752         Map&lt;String, Object&gt; result = constructSelectizeOptionMap(drs, cmd);
 753 
 754         AdornedTargetList adornedList = ppr.getAdornedList();
 755         if (adornedList != null &amp;&amp; adornedList.getLinkedObjectPath() != null
 756             &amp;&amp; adornedList.getTargetObjectPath() != null &amp;&amp; adornedList.getLinkedIdProperty() != null
 757             &amp;&amp; adornedList.getTargetIdProperty() != null) {
<abbr title=" 758             result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());"> 758             result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkeðŸ”µ</abbr>
 759             result.put(&quot;linkedObjectId&quot;, containingEntityId);
<abbr title=" 760             result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());"> 760             result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargeðŸ”µ</abbr>
 761         }
 762 
 763         return result;
 764     }
 765 
 766     @Override
 767     public Map&lt;String, Object&gt; constructSelectizeOptionMap(DynamicResultSet drs, ClassMetadata cmd) {
 768         Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
 769         List&lt;Map&lt;String, String&gt;&gt; options = new ArrayList&lt;&gt;();
 770 
 771         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 772         for (Property p : cmd.getProperties()) {
 773             if (p.getMetadata() instanceof BasicFieldMetadata) {
 774                 BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 775                 if (md.isProminent() != null &amp;&amp; md.isProminent()
 776                         &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 777                     Field hf = createHeaderField(p, md);
 778                     headerFields.add(hf);
 779                 }
 780             }
 781         }
 782 
 783         for (Entity e : drs.getRecords()) {
 784             Map&lt;String, String&gt; selectizeOption = new HashMap&lt;&gt;();
 785             for (Field headerField : headerFields) {
 786                 Property p = e.findProperty(headerField.getName());
 787                 if (p != null) {
 788                     selectizeOption.put(&quot;name&quot;, p.getValue());
 789                     break;
 790                 }
 791             }
 792             if (e.findProperty(&quot;id&quot;) != null) {
 793                 selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;id&quot;).getValue());
 794             //  &quot;Locale&quot; entity is a special occasion. Because it have not &quot;ID&quot; column with &quot;Long&quot; type
 795             } else if (e.findProperty(&quot;localeCode&quot;) != null) {
 796                 selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;localeCode&quot;).getValue());
 797             }
 798             if (e.findProperty(ALTERNATE_ID_PROPERTY) != null) {
 799                 selectizeOption.put(&quot;alternateId&quot;, e.findProperty(ALTERNATE_ID_PROPERTY).getValue());
 800             }
 801             options.add(selectizeOption);
 802         }
 803         result.put(&quot;options&quot;, options);
 804 
 805         return result;
 806     }
 807 
 808     protected String buildSelectizeUrl(ListGrid listGrid) {
 809         HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 810         String url = request.getContextPath();
<abbr title=" 811         url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + listGrid.getSectionKey();"> 811         url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() :ðŸ”µ</abbr>
 812         url += &quot;/&quot; + listGrid.getContainingEntityId();
 813         url += &quot;/&quot; + listGrid.getSubCollectionFieldName();
 814         return url;
 815     }
 816 
 817     /**
<abbr title=" 818      * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 818      * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, InteðŸ”µ</abbr>
 819      * @param className
 820      * @param headerFields
 821      * @param type
 822      * @param drs
 823      * @param sectionKey
 824      * @param order
 825      * @param idProperty
 826      * @param sectionCrumbs
 827      * @return
 828      */
 829     @Deprecated
<abbr title=" 830     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 830     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynðŸ”µ</abbr>
 831             String sectionKey, int order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs) {
<abbr title=" 832        return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,null);"> 832        return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,nuðŸ”µ</abbr>
 833     }
 834 
 835     /**
 836      * Populate a ListGrid with ListGridRecords.
 837      *
 838      * @param className
 839      * @param headerFields
 840      * @param type
 841      * @param drs
 842      * @param sectionKey
 843      * @param order
 844      * @param idProperty
 845      * @param sectionCrumbs
 846      * @param sortPropery
 847      * @return
 848      */
<abbr title=" 849     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 849     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynðŸ”µ</abbr>
<abbr title=" 850             String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropery) {"> 850             String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, StringðŸ”µ</abbr>
 851         // Create the list grid and set some basic attributes
 852         ListGrid listGrid = new ListGrid();
 853         listGrid.setClassName(className);
 854         listGrid.getHeaderFields().addAll(headerFields);
 855         listGrid.setListGridType(type);
 856         listGrid.setSectionCrumbs(sectionCrumbs);
 857         listGrid.setSectionKey(sectionKey);
 858         listGrid.setOrder(order);
 859         listGrid.setIdProperty(idProperty);
 860         listGrid.setStartIndex(drs.getStartIndex());
 861         listGrid.setTotalRecords(drs.getTotalRecords());
 862         listGrid.setPageSize(drs.getPageSize());
 863 
 864         String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
<abbr title=" 865         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier);"> 865         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdðŸ”µ</abbr>
 866         if (section != null) {
 867             listGrid.setExternalEntitySectionKey(section.getUrl());
 868         }
 869 
 870         // format date list grid cells
 871         SimpleDateFormat formatter = new SimpleDateFormat(&quot;MMM d, y @ hh:mma&quot;);
 872         DateFormatSymbols symbols = new DateFormatSymbols(Locale.getDefault());
 873         symbols.setAmPmStrings(new String[] { &quot;am&quot;, &quot;pm&quot; });
 874         formatter.setDateFormatSymbols(symbols);
 875 
 876         // For each of the entities (rows) in the list grid, we need to build the associated
 877         // ListGridRecord and set the required fields on the record. These fields are the same ones
 878         // that are used for the header fields.
 879         for (Entity e : drs.getRecords()) {
 880             ListGridRecord record = new ListGridRecord();
 881             record.setListGrid(listGrid);
 882             record.setDirty(e.isDirty());
 883             record.setEntity(e);
 884             if (StringUtils.isNotBlank(sortPropery) &amp;&amp; e.findProperty(sortPropery) != null) {
 885                 Property sort = e.findProperty(sortPropery);
 886                 record.setDisplayOrder(sort.getValue());
 887             }
 888             if (e.findProperty(&quot;hasError&quot;) != null) {
 889                 Boolean hasError = Boolean.parseBoolean(e.findProperty(&quot;hasError&quot;).getValue());
 890                 record.setIsError(hasError);
 891                 if (hasError) {
 892                     ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 893                             .getProxy().determineErrorMessageForEntity(e, record);
 894 
 895                     if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 896                         record.setErrorKey(&quot;listgrid.record.error&quot;);
 897                     }
 898                 }
 899             }
 900 
 901             if (e.findProperty(&quot;progressStatus&quot;) != null) {
 902                 ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 903                         .getProxy().determineStatusMessageForEntity(e, record);
 904                 if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 905                     record.setStatus(e.findProperty(&quot;progressStatus&quot;).getValue());
 906                     record.setStatusCssClass(&quot;listgrid.record.status&quot;);
 907                 }
 908             }
 909 
 910             if (e.findProperty(idProperty) != null) {
 911                 record.setId(e.findProperty(idProperty).getValue());
 912             }
 913 
 914             for (Field headerField : headerFields) {
 915                 Property p = e.findProperty(headerField.getName());
 916                 if (p != null) {
 917                     Field recordField = new Field().withName(headerField.getName())
 918                             .withFriendlyName(headerField.getFriendlyName())
 919                             .withOrder(p.getMetadata().getOrder());
 920 
 921                     if (headerField instanceof ComboField) {
 922                         recordField.setValue(((ComboField) headerField).getOption(p.getValue()));
 923                         recordField.setDisplayValue(p.getDisplayValue());
 924                     } else {
 925                         if (headerField.getFieldType().equals(&quot;DATE&quot;)) {
 926                             try {
<abbr title=" 927                                 Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue());"> 927                                 Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue(ðŸ”µ</abbr>
 928                                 String newValue = formatter.format(date);
 929                                 recordField.setValue(newValue);
 930                             } catch (Exception ex) {
 931                                 recordField.setValue(p.getValue());
 932                             }
 933                         } else {
 934                             recordField.setValue(p.getValue());
 935                         }
 936                         recordField.setDisplayValue(p.getDisplayValue());
 937                     }
 938 
 939                     recordField.setDerived(isDerivedField(headerField, recordField, p));
 940 
 941                     record.getFields().add(recordField);
 942                 }
 943             }
 944 
 945             if (e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY) != null) {
 946                 Field hiddenField = new Field().withName(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
<abbr title=" 947                 hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue());"> 947                 hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue()ðŸ”µ</abbr>
 948                 record.getHiddenFields().add(hiddenField);
 949             }
 950 
 951             if (e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY) != null) {
 952                 record.setAltId(e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY).getValue());
 953             }
 954 
 955             extensionManager.getProxy().modifyListGridRecord(className, record, e);
 956 
 957             listGrid.getRecords().add(record);
 958         }
 959 
 960         if (drs.getFirstId() != null) {
 961             listGrid.setFirstId(drs.getFirstId());
 962         }
 963         if (drs.getLastId() != null) {
 964             listGrid.setLastId(drs.getLastId());
 965         }
 966         if (drs.getUpperCount() != null) {
 967             listGrid.setUpperCount(drs.getUpperCount());
 968         }
 969         if (drs.getLowerCount() != null) {
 970             listGrid.setLowerCount(drs.getLowerCount());
 971         }
 972         if (drs.getFetchType() != null) {
 973             listGrid.setFetchType(drs.getFetchType().toString());
 974         }
 975         if (drs.getTotalCountLessThanPageSize() != null) {
 976             listGrid.setTotalCountLessThanPageSize(drs.getTotalCountLessThanPageSize());
 977         }
 978         if (drs.getPromptSearch() != null) {
 979             listGrid.setPromptSearch(drs.getPromptSearch());
 980         }
 981 
 982         return listGrid;
 983     }
 984 
 985     /**
<abbr title=" 986      * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasicFieldMetadata}"> 986      * Determines whether or not a particular field in a record is derived. By default this checks the {@ðŸ”µ</abbr>
 987      * for the given Property to see if something on the backend has marked it as derived
 988      *
 989      * @param headerField the header for this recordField
 990      * @param recordField the recordField being populated
 991      * @param p the property that relates to this recordField
 992      * @return whether or not this field is derived
<abbr title=" 993      * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 993      * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, StringðŸ”µ</abbr>
 994      */
 995     protected Boolean isDerivedField(Field headerField, Field recordField, Property p) {
 996         return BooleanUtils.isTrue(((BasicFieldMetadata) p.getMetadata()).getIsDerived());
 997     }
 998 
 999     protected void setEntityFormFields(ClassMetadata cmd, EntityForm ef, List&lt;Property&gt; properties) {
1000         List&lt;Field&gt; homelessFields = new ArrayList&lt;&gt;();
1001         List&lt;Field&gt; fieldsWithAssociations = new ArrayList&lt;&gt;();
1002 
1003         for (Property property : properties) {
1004             if (property.getMetadata() instanceof BasicFieldMetadata) {
1005                 BasicFieldMetadata fmd = (BasicFieldMetadata) property.getMetadata();
1006 
1007 
1008                 if (!ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
<abbr title="1009                     // Depending on visibility, field for the particular property is not created on the form">1009                     // Depending on visibility, field for the particular property is not created on the fðŸ”µ</abbr>
1010                     String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
1011 
1012                     // Create the field and set some basic attributes
1013                     Field f;
1014 
1015                     if (fieldType.equals(SupportedFieldType.BROADLEAF_ENUMERATION.toString())
1016                             || fieldType.equals(SupportedFieldType.EXPLICIT_ENUMERATION.toString())
1017                             || fieldType.equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION.toString())
1018                             || fieldType.equals(SupportedFieldType.EMPTY_ENUMERATION.toString())) {
<abbr title="1019                         // We&#x27;re dealing with fields that should render as drop-downs, so set their possible values">1019                         // We&#x27;re dealing with fields that should render as drop-downs, so set their possiðŸ”µ</abbr>
1020                         f = new ComboField();
1021 
1022                         String[][] enumerationValues = fmd.getEnumerationValues();
1023                         for(int i=0; i&lt; enumerationValues.length;i++){
<abbr title="1024                             enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1]);">1024                             enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValuðŸ”µ</abbr>
1025                         }
1026                         ((ComboField) f).setOptions(enumerationValues);
<abbr title="1027                         if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValue()">1027                         if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().boðŸ”µ</abbr>
1028                                 &amp;&amp; ((ComboField) f).getOptions().size() == 0) {
1029                             f.setIsVisible(false);
1030                         }
1031                     } else if (fieldType.equals(SupportedFieldType.CODE.toString())) {
1032                         f = new CodeField();
1033                     } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1034                             || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1035                             || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1036                         // We&#x27;re dealing with rule builders, so we&#x27;ll create those specialized fields
1037                         f = new RuleBuilderField();
1038                         ((RuleBuilderField) f).setJsonFieldName(property.getName() + &quot;Json&quot;);
1039                         ((RuleBuilderField) f).setDataWrapper(new DataWrapper());
1040                         ((RuleBuilderField) f).setFieldBuilder(fmd.getRuleIdentifier());
1041                         ((RuleBuilderField) f).setDisplayType(fmd.getDisplayType().toString());
1042 
1043                         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
1044                         ((RuleBuilderField) f).setJson(blankJsonString);
1045                         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
1046                         if (dw != null) {
1047                             ((RuleBuilderField) f).setDataWrapper(dw);
1048                         }
1049 
1050                         if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())) {
1051                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple&quot;);
1052                         } else if (fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1053                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-with-quantity&quot;);
1054                         } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())) {
1055                             ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple-time&quot;);
1056                         }
1057                     } else if (LookupType.DROPDOWN.equals(fmd.getLookupType())) {
<abbr title="1058                         // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of in a">1058                         // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instðŸ”µ</abbr>
<abbr title="1059                         // modal, so we&#x27;ll provision the combo field here. Available options will be set as part of a">1059                         // modal, so we&#x27;ll provision the combo field here. Available options will be set ðŸ”µ</abbr>
1060                         // subsequent operation
1061                         f = new ComboField();
1062                     } else if (fieldType.equals(SupportedFieldType.MEDIA.toString())) {
1063                         f = new MediaField();
1064                     } else {
1065                         // Create a default field since there was no specialized handler
1066                         f = new Field();
1067                     }
1068 
1069                     Boolean required = fmd.getRequiredOverride();
1070                     if (required == null) {
1071                         required = fmd.getRequired();
1072                     }
1073 
1074                     Boolean allowNoValueEnum = fmd.getAllowNoValueEnumOption();
1075                     if (allowNoValueEnum != null) {
1076                         f.setAllowNoValueEnumOption(allowNoValueEnum);
1077                     }
1078 
1079                     f.withName(property.getName())
1080                      .withFieldType(fieldType)
1081                      .withFieldComponentRenderer(getFieldComponentRenderer(fmd))
1082                      .withGridFieldComponentRenderer(getGridFieldComponentRenderer(fmd))
1083                      .withOrder(fmd.getOrder())
1084                      .withFriendlyName(fmd.getFriendlyName())
1085                      .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
1086                      .withForeignKeyClass(fmd.getForeignKeyClass())
1087                      .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title="1088                      .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromType())">1088                      .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheriðŸ”µ</abbr>
1089                      .withRequired(required)
1090                      .withReadOnly(fmd.getReadOnly())
1091                      .withTranslatable(fmd.getTranslatable())
<abbr title="1092                      .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDERING))">1092                      .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDðŸ”µ</abbr>
1093                      .withLargeEntry(fmd.isLargeEntry())
1094                      .withHint(fmd.getHint())
1095                      .withTooltip(fmd.getTooltip())
1096                      .withHelp(fmd.getHelpText())
1097                      .withTypeaheadEnabled(fmd.getEnableTypeaheadLookup())
1098                      .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity())
1099                      .withAssociatedFieldName(fmd.getAssociatedFieldName());
1100 
1101                     String defaultValue = fmd.getDefaultValue();
1102                     if (defaultValue != null) {
1103                         defaultValue = extractDefaultValueFromFieldData(fieldType, fmd);
1104                         f.withValue(defaultValue);
1105                     }
1106 
1107                     if (StringUtils.isBlank(f.getFriendlyName())) {
1108                         f.setFriendlyName(f.getName());
1109                     }
1110 
1111                     // If is form hidden, set visible to false
1112                     if (VisibilityEnum.FORM_EXPLICITLY_HIDDEN.equals(fmd.getVisibility())) {
1113                         f.setIsVisible(false);
1114                     }
1115 
1116                     if (VisibilityEnum.VISIBLE_ALL.equals(fmd.getVisibility())) {
1117                         f.setIsVisible(true);
1118                     }
1119 
1120                     // Add the field to the appropriate FieldGroup
1121                     if (fmd.getGroup() == null) {
1122                         homelessFields.add(f);
1123                     } else {
<abbr title="1124                         ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabOrder());">1124                         ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabðŸ”µ</abbr>
1125                     }
1126 
1127                     if (StringUtils.isNotEmpty(fmd.getAssociatedFieldName())) {
1128                         fieldsWithAssociations.add(f);
1129                     }
1130                 }
1131             }
1132         }
1133 
1134         for (Field f : homelessFields) {
1135             ef.addField(cmd, f, null, null, null, null);
1136         }
1137 
1138         for (Field f : fieldsWithAssociations) {
1139             Field associatedField = findAssociatedField(ef, f);
1140             if (associatedField != null) {
1141                 associatedField.setShouldRender(false);
1142                 f.setAssociatedFieldName(associatedField.getName());
1143             } else {
1144                 f.setAssociatedFieldName(null);
1145             }
1146         }
1147     }
1148 
1149     protected String getFieldComponentRenderer(BasicFieldMetadata fmd) {
1150         if (StringUtils.isNotBlank(fmd.getFieldComponentRendererTemplate())) {
1151             return fmd.getFieldComponentRendererTemplate();
1152         }
1153         return fmd.getFieldComponentRenderer()==null?null:fmd.getFieldComponentRenderer().toString();
1154     }
1155 
1156     protected String getGridFieldComponentRenderer(BasicFieldMetadata fmd) {
1157         if (StringUtils.isNotBlank(fmd.getGridFieldComponentRendererTemplate())) {
1158             return fmd.getGridFieldComponentRendererTemplate();
1159         }
<abbr title="1160         return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toString();">1160         return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toStrinðŸ”µ</abbr>
1161     }
1162 
1163     private Field findAssociatedField(EntityForm ef, Field f) {
1164         // Try on the parent object
1165         Field associatedField = ef.findField(f.getAssociatedFieldName());
1166 
1167         if (associatedField == null) {
1168             // Check the field&#x27;s path
1169             String[] fieldPathParts = f.getName().split(&quot;\\.&quot;);
1170             String testPath = &quot;&quot;;
1171 
1172             for (String path : fieldPathParts) {
1173                 testPath += path + &quot;.&quot;;
1174 
1175                 associatedField = ef.findField(testPath + f.getAssociatedFieldName());
1176                 if (associatedField != null) {
1177                     break;
1178                 }
1179             }
1180         }
1181         return associatedField;
1182     }
1183 
1184     /**
1185      * This method gets the {@link AdminSection} for the given foreignKeyClass parameter. If none exists,
1186      * it returns the foreignKeyClass.
1187      *
1188      * @param foreignKeyClass the {@link String} class name
1189      * @return the admin section pathname
1190      */
1191     protected String getAdminSectionPath(String foreignKeyClass) {
1192         if (foreignKeyClass != null) {
<abbr title="1193             AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyClass, null);">1193             AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(fðŸ”µ</abbr>
1194             return foreignKeySection != null ? foreignKeySection.getUrl() : foreignKeyClass;
1195         }
1196         return null;
1197     }
1198 
1199     /**
<abbr title="1200      * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal to">1200      * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} iðŸ”µ</abbr>
1201      *  the processed value of another tab.
1202      *
1203      * For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a another tab where
<abbr title="1204      *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;,">1204      *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=ExamðŸ”µ</abbr>
<abbr title="1205      *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; tabs.">1205      *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; taðŸ”µ</abbr>
1206      */
1207     protected void setEntityFormTabsAndGroups(EntityForm ef, Map&lt;String, TabMetadata&gt; tabMetadataMap) {
1208         if (tabMetadataMap != null) {
1209             Set&lt;String&gt; tabMetadataKeySet = tabMetadataMap.keySet();
1210             for (String tabKey : tabMetadataKeySet) {
1211                 TabMetadata tabMetadata = tabMetadataMap.get(tabKey);
<abbr title="1212                 String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySet);">1212                 String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySeðŸ”µ</abbr>
1213 
1214                 if (foundMatchingTab(unprocessedTabName)) {
1215                     if (!tabExists(ef, unprocessedTabName)) {
1216                         TabMetadata originalTabMetadata = tabMetadataMap.get(unprocessedTabName);
1217                         unprocessedTabName = ef.addTabFromTabMetadata(originalTabMetadata);
1218                     }
1219                 } else {
1220                     if (tabExists(ef, tabKey)) {
1221                         unprocessedTabName = tabKey;
1222                     } else {
1223                         unprocessedTabName = ef.addTabFromTabMetadata(tabMetadata);
1224                     }
1225                 }
1226 
1227                 Set&lt;String&gt; groupMetadataKeySet = tabMetadata.getGroupMetadata().keySet();
1228                 for (String groupKey : groupMetadataKeySet) {
<abbr title="1229                     ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName);">1229                     ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocesseðŸ”µ</abbr>
1230                 }
1231             }
1232         }
1233     }
1234 
1235     /**
1236      * Search for any other tab on the target entity that has the same display value
1237      *  as the value provided tab name.
1238      *
<abbr title="1239      * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message property.">1239      * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message propeðŸ”µ</abbr>
<abbr title="1240      *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySet">1240      *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetaðŸ”µ</abbr>
<abbr title="1241      *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method should return">1241      *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method shoulðŸ”µ</abbr>
1242      *  &quot;Example_Tab&quot; which will end up causing the tabs to merge together.
1243      *
<abbr title="1244      * If a tab with the same display value cannot be found, then we should return null to indicate that there">1244      * If a tab with the same display value cannot be found, then we should return null to indicate that ðŸ”µ</abbr>
1245      *  is no matching tab with the same processed tabName value.
1246      */
<abbr title="1247     protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySet) {">1247     protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySðŸ”µ</abbr>
1248         for (String tabKey : tabMetadataKeySet) {
1249             String tabName = tabMetadata.getTabName();
1250 
1251             if (processedTabKeyMatchesTabName(tabName, tabKey)) {
1252                 return tabKey;
1253             }
1254         }
1255 
1256         return null;
1257     }
1258 
1259     protected boolean processedTabKeyMatchesTabName(String tabName, String candidateTabKey) {
1260         try {
1261             String processedCandidateTabKey = BLCMessageUtils.getMessage(candidateTabKey);
<abbr title="1262             boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateTabKey);">1262             boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateðŸ”µ</abbr>
1263 
<abbr title="1264             return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidateTabKey);">1264             return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidatðŸ”µ</abbr>
1265         } catch (NoSuchMessageException e) {
1266             LOG.debug(&quot;No such message exists for &quot; + candidateTabKey, e);
1267 
1268             return false;
1269         }
1270     }
1271 
1272     protected boolean foundMatchingTab(String unprocessedTabName) {
1273         return (unprocessedTabName != null);
1274     }
1275 
1276     protected boolean tabExists(EntityForm ef, String tabKey) {
1277         return (ef.findTab(tabKey) != null);
1278     }
1279 
1280     @Override
1281     public String extractDefaultValueFromFieldData(String fieldType, BasicFieldMetadata fmd) {
1282         String defaultValue = fmd.getDefaultValue();
1283         if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1284                 || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1285                 || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1286             return null;
1287         } else if (fieldType.equals(SupportedFieldType.INTEGER.toString())) {
1288             try {
<abbr title="1289                 DecimalFormat numberFormat = (DecimalFormat) NumberFormat.getInstance(BroadleafRequestContext.getBroadleafRequestContext().getJavaLocale());">1289                 DecimalFormat numberFormat = (DecimalFormat) NumberFormat.getInstance(BroadleafRequestConðŸ”µ</abbr>
1290                 Number parse = numberFormat.parse(defaultValue);
1291             } catch (NumberFormatException | ParseException e) {
<abbr title="1292                 String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defaultValue);">1292                 String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defauðŸ”µ</abbr>
1293                 LOG.debug(msg);
1294                 return null;
1295             }
1296         } else if (fieldType.equals(SupportedFieldType.DECIMAL.toString())
1297                 || fieldType.equals(SupportedFieldType.MONEY.toString())) {
1298             try {
<abbr title="1299                 DecimalFormat numberFormat = (DecimalFormat) NumberFormat.getInstance(BroadleafRequestContext.getBroadleafRequestContext().getJavaLocale());">1299                 DecimalFormat numberFormat = (DecimalFormat) NumberFormat.getInstance(BroadleafRequestConðŸ”µ</abbr>
1300                 numberFormat.setParseBigDecimal(true);
1301                 Number parse = numberFormat.parse(defaultValue);
1302             } catch (NumberFormatException | ParseException e) {
1303                 String msg = buildMsgForDefValException(fieldType.toString(), fmd, defaultValue);
1304                 LOG.debug(msg);
1305                 return null;
1306             }
1307         } else if (fieldType.equals(SupportedFieldType.BOOLEAN.toString())) {
1308             if (!defaultValue.toLowerCase().equals(&quot;true&quot;) &amp;&amp; !defaultValue.toLowerCase().equals(&quot;false&quot;)
<abbr title="1309                     &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)) {">1309                     &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)ðŸ”µ</abbr>
<abbr title="1310                 String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defaultValue);">1310                 String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defauðŸ”µ</abbr>
1311                 LOG.debug(msg);
1312                 return null;
1313             }
1314         } else if (fieldType.equals(SupportedFieldType.DATE.toString())) {
1315             DateFormat format = FormatUtil.getDateFormat();
1316             if (defaultValue.toLowerCase().contains(&quot;today&quot;)) {
1317                 defaultValue = format.format(new Date());
1318             } else {
1319                 try {
1320                     Date date = format.parse(defaultValue);
1321                     defaultValue = format.format(date);
1322                 } catch (ParseException e) {
<abbr title="1323                     String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue);">1323                     String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaðŸ”µ</abbr>
1324                     LOG.debug(msg);
1325                     return null;
1326                 }
1327             }
1328         }
1329         return defaultValue;
1330     }
1331 
<abbr title="1332     protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue) {">1332     protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue)ðŸ”µ</abbr>
<abbr title="1333         return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - Failed to parse &quot;">1333         return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot;ðŸ”µ</abbr>
<abbr title="1334                 + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue) + &quot; ]&quot;;">1334                 + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue)ðŸ”µ</abbr>
1335     }
1336 
1337     @Override
1338     public void removeNonApplicableFields(ClassMetadata cmd, EntityForm entityForm, String entityType) {
1339         for (Property p : cmd.getProperties()) {
1340             if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entityType)) {
1341                 entityForm.removeField(p.getName());
1342             }
1343         }
1344     }
1345 
1346     @Override
1347     public EntityForm createEntityForm(ClassMetadata cmd, List&lt;SectionCrumb&gt; sectionCrumbs)
1348             throws ServiceException {
1349         EntityForm ef = createStandardEntityForm();
1350         populateEntityForm(cmd, ef, sectionCrumbs);
1351         return ef;
1352     }
1353 
1354     protected String extractSectionIdentifierFromCrumb(List&lt;SectionCrumb&gt; sectionCrumbs) {
1355         if (sectionCrumbs != null &amp;&amp; sectionCrumbs.size() &gt; 0) {
1356             return sectionCrumbs.get(0).getSectionIdentifier();
1357         } else {
1358             return null;
1359         }
1360     }
1361 
1362     @Override
1363     public void populateEntityForm(ClassMetadata cmd, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)
1364             throws ServiceException {
1365         ef.setCeilingEntityClassname(cmd.getCeilingType());
1366 
1367         String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
1368 
<abbr title="1369         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType(),">1369         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType()ðŸ”µ</abbr>
1370                 sectionIdentifier);
1371         if (section != null) {
1372             ef.setSectionKey(section.getUrl());
1373         } else {
1374             ef.setSectionKey(cmd.getCeilingType());
1375         }
1376         ef.setSectionCrumbsImpl(sectionCrumbs);
1377 
1378         setEntityFormTabsAndGroups(ef, cmd.getTabAndGroupMetadata());
1379 
1380         setEntityFormFields(cmd, ef, Arrays.asList(cmd.getProperties()));
1381 
1382         populateDropdownToOneFields(ef, cmd);
1383 
1384         extensionManager.getProxy().modifyUnpopulatedEntityForm(ef);
1385     }
1386 
1387     /**
1388      * This method is invoked when EntityForms are created and is meant to provide a hook to add
1389      * additional entity form actions for implementors of Broadleaf. Broadleaf modules will typically
1390      * leverage {@link FormBuilderExtensionHandler#addAdditionalFormActions(EntityForm)} method.
1391      * @param ef
1392      */
1393     protected void addAdditionalFormActions(EntityForm ef) {
1394 
1395     }
1396 
1397     @Override
<abbr title="1398     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbs)">1398     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbsðŸ”µ</abbr>
1399             throws ServiceException {
1400         EntityForm ef = createStandardEntityForm();
1401         populateEntityForm(cmd, entity, ef, sectionCrumbs);
1402         addAdditionalFormActions(ef);
1403         extensionManager.getProxy().addAdditionalFormActions(ef);
1404         return ef;
1405     }
1406 
1407     @Override
<abbr title="1408     public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1408     public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; seðŸ”µ</abbr>
1409             throws ServiceException {
1410         // Get the empty form with appropriate fields
1411         populateEntityForm(cmd, ef, sectionCrumbs);
1412 
1413         String idProperty = adminEntityService.getIdProperty(cmd);
1414         ef.setId(entity.findProperty(idProperty).getValue());
1415         ef.setEntityType(entity.getType()[0]);
1416 
1417         populateEntityFormFieldValues(cmd, entity, ef);
1418 
1419         Property p = entity.findProperty(BasicPersistenceModule.MAIN_ENTITY_NAME_PROPERTY);
1420         if (p != null) {
1421             ef.setMainEntityName(exploitProtectionService.htmlDecode(p.getValue()));
1422         }
1423 
1424         extensionManager.getProxy().modifyPopulatedEntityForm(ef, entity);
1425     }
1426 
<abbr title="1427     protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef) {">1427     protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef)ðŸ”µ</abbr>
1428         for (Property p : cmd.getProperties()) {
1429             FieldMetadata fmd = p.getMetadata();
1430 
1431             if (shouldHideField(fmd, entity)) {
1432                 if (fmd instanceof CollectionMetadata) {
1433                     ef.removeListGrid(p.getName());
1434                 } else {
1435                     ef.removeField(p.getName());
1436                 }
1437             }
1438         }
1439     }
1440 
1441     protected boolean shouldHideField(FieldMetadata fmd, Entity entity) {
1442         if (fmd == null || fmd.getShowIfFieldEquals() == null) {
1443             return false;
1444         }
1445 
1446         for (String property : fmd.getShowIfFieldEquals().keySet()) {
1447             List&lt;String&gt; values = fmd.getShowIfFieldEquals().get(property);
1448             Property entityProp = entity.findProperty(property);
1449 
1450             if (entityProp == null || values.contains(entityProp.getValue())) {
1451                 return false;
1452             }
1453         }
1454         return true;
1455     }
1456 
1457     @Override
1458     public void populateEntityFormFieldValues(ClassMetadata cmd, Entity entity, EntityForm ef) {
1459         // Set the appropriate property values
1460         for (Property p : cmd.getProperties()) {
1461             if (p.getMetadata() instanceof BasicFieldMetadata) {
1462                 BasicFieldMetadata basicFM = (BasicFieldMetadata) p.getMetadata();
1463 
1464                 Property entityProp = entity.findProperty(p.getName());
1465 
<abbr title="1466                 boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibility());">1466                 boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibiliðŸ”µ</abbr>
1467                 //always show special map fields
1468                 if (p.getName().equals(&quot;key&quot;) || p.getName().equals(&quot;priorKey&quot;)) {
1469                     explicitlyShown = true;
1470                 }
1471 
1472                 if (entityProp == null &amp;&amp; explicitlyShown) {
1473                     Field field = ef.findField(p.getName());
1474                     if (field != null) {
1475                         field.setValue(null);
1476                     }
<abbr title="1477                 } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1477                 } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getEðŸ”µ</abbr>
1478                     ef.removeField(p.getName());
1479                 } else {
1480                     Field field = ef.findField(p.getName());
1481                     if (field != null) {
1482                         if (entityProp != null) {
<abbr title="1483                             //protect against null - can happen with password confirmation fields (i.e. admin user)">1483                             //protect against null - can happen with password confirmation fields (i.e. aðŸ”µ</abbr>
1484                             field.setDirty(entityProp.getIsDirty());
1485                         }
1486                         if (basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE
1487                                 || basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE_TIME
1488                                 || basicFM.getFieldType()==SupportedFieldType.RULE_WITH_QUANTITY) {
1489                             RuleBuilderField rbf = (RuleBuilderField) field;
1490                             if (entity.getPMap().containsKey(rbf.getJsonFieldName())) {
1491                                 String json = entity.getPMap().get(rbf.getJsonFieldName()).getValue();
1492                                 rbf.setJson(json);
1493                                 DataWrapper dw = convertJsonToDataWrapper(json);
1494                                 if (dw != null) {
1495                                     rbf.setDataWrapper(dw);
1496                                 }
1497                             }
1498                         }
1499                         if (basicFM.getFieldType() == SupportedFieldType.MEDIA) {
1500                             field.setValue(exploitProtectionService.htmlDecode(entityProp.getValue()));
1501                             field.setDisplayValue(entityProp.getDisplayValue());
1502                             MediaField mf = (MediaField) field;
<abbr title="1503                             Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(), MediaDto.class);">1503                             Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.gðŸ”µ</abbr>
<abbr title="1504                             mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(), type));">1504                             mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodeðŸ”µ</abbr>
<abbr title="1505                         } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1505                         } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldTyðŸ”µ</abbr>
<abbr title="1506                             field.setValue((basicFM.isLargeEntry() != null &amp;&amp; basicFM.isLargeEntry()) ? entityProp.getValue() : exploitProtectionService.htmlDecode(entityProp.getValue()));">1506                             field.setValue((basicFM.isLargeEntry() != null &amp;&amp; basicFM.isLargeEntry()) ? eðŸ”µ</abbr>
1507                             field.setDisplayValue(entityProp.getDisplayValue());
1508                         }
1509                     }
1510                 }
1511             }
1512         }
1513     }
1514 
1515     /**
1516      * When using Thymeleaf, we need to convert the JSON string back to
1517      * a DataWrapper object because Thymeleaf escapes JSON strings.
1518      * Thymeleaf uses it&#x27;s own object de-serializer
1519      * see: https://github.com/thymeleaf/thymeleaf/issues/84
1520      * see: http://forum.thymeleaf.org/Spring-Javascript-and-escaped-JSON-td4024739.html
1521      * @param json
1522      * @return DataWrapper
1523      * @throws IOException
1524      */
1525     protected DataWrapper convertJsonToDataWrapper(String json) {
1526         ObjectMapper mapper = new ObjectMapper();
1527         DataDTODeserializer dtoDeserializer = new DataDTODeserializer();
<abbr title="1528         SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null));">1528         SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, nuðŸ”µ</abbr>
1529         module.addDeserializer(DataDTO.class, dtoDeserializer);
1530         mapper.registerModule(module);
1531         try {
1532             return mapper.readValue(json, DataWrapper.class);
1533         } catch (IOException e) {
1534             throw new RuntimeException(e);
1535         }
1536     }
1537 
1538     protected void populateDropdownToOneFields(EntityForm ef, ClassMetadata cmd)
1539             throws ServiceException {
1540         for (Property p : cmd.getProperties()) {
1541             if (p.getMetadata() instanceof BasicFieldMetadata) {
1542                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
1543                 if (LookupType.DROPDOWN.equals(fmd.getLookupType())
1544                         &amp;&amp; !ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
1545                     // Get the records
1546                     PersistencePackageRequest toOnePpr = PersistencePackageRequest.standard()
1547                             .withCeilingEntityClassname(fmd.getForeignKeyClass());
<abbr title="1548                     Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecords();">1548                     Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecoðŸ”µ</abbr>
1549 
1550                     // Determine the id field
1551                     String idProp = null;
<abbr title="1552                     ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSet().getClassMetaData();">1552                     ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamðŸ”µ</abbr>
1553                     for (Property foreignP : foreignClassMd.getProperties()) {
1554                         if (foreignP.getMetadata() instanceof BasicFieldMetadata) {
1555                             BasicFieldMetadata foreignFmd = (BasicFieldMetadata) foreignP.getMetadata();
1556                             if (SupportedFieldType.ID.equals(foreignFmd.getFieldType())) {
1557                                 idProp = foreignP.getName();
1558                             }
1559                         }
1560                     }
1561 
1562                     if (idProp == null) {
<abbr title="1563                         throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClass());">1563                         throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeigðŸ”µ</abbr>
1564                     }
1565 
1566                     // Determine the display field
1567                     String displayProp = fmd.getLookupDisplayProperty();
1568 
1569                     // Build the options map
1570                     Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
1571                     for (Entity row : rows) {
1572                         Property prop = row.findProperty(displayProp);
1573                         if (prop == null) {
<abbr title="1574                             LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entity [&quot; +">1574                             LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + ðŸ”µ</abbr>
1575                                     ef.getCeilingEntityClassname() + &quot;]&quot;);
1576                         } else {
1577                             String displayValue = prop.getDisplayValue();
1578                             if (StringUtils.isBlank(displayValue)) {
1579                                 displayValue = prop.getValue();
1580                             }
1581                             options.put(row.findProperty(idProp).getValue(), displayValue);
1582                         }
1583                     }
1584 
1585                     // Set the options on the entity field
1586                     ComboField cf = (ComboField) ef.findField(p.getName());
1587                     cf.setOptions(options);
1588                 }
1589             }
1590         }
1591     }
1592 
1593     @Override
<abbr title="1594     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, List&lt;SectionCrumb&gt; sectionCrumbs)">1594     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; coðŸ”µ</abbr>
1595             throws ServiceException {
1596         EntityForm ef = createStandardEntityForm();
1597         populateEntityForm(cmd, entity, collectionRecords, ef, sectionCrumbs);
1598         addAdditionalFormActions(ef);
1599         extensionManager.getProxy().addAdditionalFormActions(ef);
1600         return ef;
1601     }
1602 
1603     @Override
<abbr title="1604     public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1604     public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collecðŸ”µ</abbr>
1605             throws ServiceException {
1606         // Get the form with values for this entity
1607         populateEntityForm(cmd, entity, ef, sectionCrumbs);
1608 
1609         // Attach the sub-collection list grids and specialty UI support
1610         for (Property p : cmd.getProperties()) {
1611             if (p.getMetadata() instanceof BasicFieldMetadata) {
1612                 continue;
1613             }
1614 
1615             if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entity.getType()[0])) {
1616                 continue;
1617             }
1618 
1619             if (collectionRecords != null &amp;&amp; !collectionRecords.isEmpty()) {
1620                 DynamicResultSet subCollectionEntities = collectionRecords.get(p.getName());
1621                 String containingEntityId = entity.getPMap().get(ef.getIdProperty()).getValue();
<abbr title="1622                 ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSectionKey(), sectionCrumbs);">1622                 ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p,ðŸ”µ</abbr>
1623 
1624                 CollectionMetadata md = ((CollectionMetadata) p.getMetadata());
1625                 if (md instanceof BasicCollectionMetadata) {
<abbr title="1626                     PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);">1626                     PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCruðŸ”µ</abbr>
<abbr title="1627                     ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1627                     ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResuðŸ”µ</abbr>
1628                     if (collectionCmd.getPolymorphicEntities().getChildren().length != 0) {
<abbr title="1629                         List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTrees();">1629                         List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedðŸ”µ</abbr>
1630                         ListGridActionGroup actionGroup = new ListGridActionGroup().withName(&quot;Add&quot;);
1631                         for (ClassTree entityType : entityTypes) {
1632                             ListGridAction ADD = new ListGridAction(ListGridAction.ADD)
1633                                     .withButtonClass(AddMethodType.PERSIST_EMPTY==
<abbr title="1634                                             ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-grid-add-empty&quot;:&quot;sub-list-grid-add&quot;)">1634                                             ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-gðŸ”µ</abbr>
1635                                     .withActionTargetEntity(entityType.getFullyQualifiedClassname())
1636                                     .withUrlPostfix(&quot;/add&quot;)
1637                                     .withIconClass(&quot;fa fa-plus&quot;)
<abbr title="1638                                     .withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyName()));">1638                                     .withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyNamðŸ”µ</abbr>
1639                             actionGroup.getListGridActions().add(0, ADD);
1640                         }
1641                         listGrid.addToolbarActionGroup(actionGroup);
1642                     } else {
1643                         listGrid.getToolbarActions().add(0, AddMethodType.PERSIST_EMPTY==
<abbr title="1644                                 ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ADD_EMPTY:DefaultListGridActions.ADD);">1644                                 ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ðŸ”µ</abbr>
1645                     }
1646                 } else {
1647                     listGrid.getToolbarActions().add(0, DefaultListGridActions.ADD);
1648                 }
1649 
1650                 if (subCollectionEntities.getUnselectedTabMetadata().get(md.getTab())!=null) {
1651                     ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), true);
1652                 } else {
1653                     ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), false);
1654                 }
1655             }
1656         }
1657 
1658         if (CollectionUtils.isEmpty(ef.getActions())) {
1659             ef.addAction(DefaultEntityFormActions.SAVE);
1660         }
1661 
1662         addDeleteActionIfAllowed(ef, cmd, entity);
1663         addDuplicateActionIfAllowed(ef, cmd);
1664         setReadOnlyState(ef, cmd, entity);
1665 
1666         // check for fields that should be hidden based on annotations
1667         setVisibilityBasedOnShowIfFieldEquals(cmd, entity, ef);
1668 
1669         extensionManager.getProxy().modifyDetailEntityForm(ef);
1670     }
1671 
1672     /**
<abbr title="1673      * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The user can">1673      * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/bðŸ”µ</abbr>
1674      * delete an entity for the following cases:
1675      * &lt;ol&gt;
<abbr title="1676      *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represented by">1676      *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represenðŸ”µ</abbr>
<abbr title="1677      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;">1677      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/lðŸ”µ</abbr>
1678      *  &lt;li&gt;The user has the security necessary to delete the given &lt;b&gt;entity&lt;/b&gt; according to the
1679      *  {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}&lt;/li&gt;
1680      * &lt;/ol&gt;
1681      *
1682      * @param entityForm the form being generated
1683      * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1684      * @param entity the entity being edited
1685      * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1686      * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1687      * @see {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}
1688      */
1689     protected void addDeleteActionIfAllowed(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1690         if (isDeletionAllowed(entityForm, cmd, entity)) {
1691             entityForm.addAction(DefaultEntityFormActions.DELETE);
1692         }
1693     }
1694 
1695     protected boolean isDeletionAllowed(final EntityForm entityForm, final ClassMetadata cmd,
1696             final Entity entity) {
1697         try {
1698             String securityEntityClassname = getSecurityClassname(entityForm, cmd);
1699             adminRemoteSecurityService
1700                     .securityCheck(securityEntityClassname, EntityOperationType.REMOVE);
1701         } catch (ServiceException e) {
1702             if (e instanceof SecurityServiceException) {
1703                 return false;
1704             }
1705         }
1706 
1707         final AdminUser persistentAdminUser = adminRemoteSecurityService.getPersistentAdminUser();
1708 
1709         return rowLevelSecurityService.canUpdate(persistentAdminUser, entity)
1710                 &amp;&amp; rowLevelSecurityService.canRemove(persistentAdminUser, entity);
1711     }
1712 
1713     protected void addDuplicateActionIfAllowed(final EntityForm entityForm,
1714             final ClassMetadata cmd) {
1715         if (isDuplicationAllowed(entityForm, cmd)) {
1716             entityForm.addAction(DefaultEntityFormActions.DUPLICATE);
1717         }
1718     }
1719 
1720     protected boolean isDuplicationAllowed(final EntityForm entityForm, final ClassMetadata cmd) {
1721         final String securityClassname = getSecurityClassname(entityForm, cmd);
1722 
1723         try {
1724             adminRemoteSecurityService.securityCheck(securityClassname, EntityOperationType.ADD);
1725         } catch (ServiceException e) {
1726             if (e instanceof SecurityServiceException) {
1727                 return false;
1728             }
1729         }
1730 
1731         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(securityClassname);
1732 
1733         return duplicator.validate(entityClass, Long.valueOf(entityForm.getId())) &amp;&amp;
1734                 rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(),
1735                         securityClassname, cmd);
1736     }
1737 
1738     /**
1739      * The given &lt;b&gt;entityForm&lt;/b&gt; is marked as readonly for the following cases:
1740      * &lt;ol&gt;
1741      *  &lt;li&gt;All of the properties from &lt;b&gt;cmd&lt;/b&gt; are readonly&lt;/b&gt;&lt;/li&gt;
<abbr title="1742      *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represented by">1742      *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class namðŸ”µ</abbr>
<abbr title="1743      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;">1743      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/lðŸ”µ</abbr>
<abbr title="1744      *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to the">1744      *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to ðŸ”µ</abbr>
1745      *  {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}&lt;/li&gt;
1746      * &lt;/ol&gt;
1747      *
1748      * @param entityForm the form being generated
1749      * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1750      * @param entity the entity being edited
1751      * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1752      * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1753      * @see {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}
1754      */
1755     protected void setReadOnlyState(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1756         boolean readOnly = true;
1757 
1758         // If all of the fields are read only, we&#x27;ll mark the form as such
1759         for (Property property : cmd.getProperties()) {
1760             FieldMetadata fieldMetadata = property.getMetadata();
1761             if (fieldMetadata instanceof BasicFieldMetadata) {
<abbr title="1762                 readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieldMetadata).getReadOnly();">1762                 readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetaðŸ”µ</abbr>
1763                 if (!readOnly) {
1764                     break;
1765                 }
1766             } else {
1767                 readOnly = ((CollectionMetadata) fieldMetadata).isMutable();
1768                 if (!readOnly) {
1769                     break;
1770                 }
1771             }
1772         }
1773 
1774         if (!readOnly) {
<abbr title="1775             // If the user does not have edit permissions, we will go ahead and make the form read only to prevent confusion">1775             // If the user does not have edit permissions, we will go ahead and make the form read only tðŸ”µ</abbr>
1776             try {
1777                 String securityEntityClassname = getSecurityClassname(entityForm, cmd);
<abbr title="1778                 adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDATE);">1778                 adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDðŸ”µ</abbr>
1779             } catch (ServiceException e) {
1780                 if (e instanceof SecurityServiceException) {
1781                     readOnly = true;
1782                 }
1783             }
1784         }
1785 
<abbr title="1786         // if the normal admin security service has not deemed this readonly and the all of the properties on the entity">1786         // if the normal admin security service has not deemed this readonly and the all of the propertieðŸ”µ</abbr>
1787         // are not readonly, then check the row-level security
1788         if (!readOnly) {
<abbr title="1789             readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1789             readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUsðŸ”µ</abbr>
1790         }
1791 
1792         if (readOnly) {
1793             entityForm.setReadOnly();
<abbr title="1794             //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface">1794             //If someone has replaced RowLevelSecurityService, check here to make sure the replacement imðŸ”µ</abbr>
1795             if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title="1796                 EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();">1796                 EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLeveðŸ”µ</abbr>
<abbr title="1797                 for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {">1797                 for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguðŸ”µ</abbr>
1798                     for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
1799                         if (modifier.isQualified(data.getModifierType())) {
1800                             modifier.modifyEntityForm(new EntityFormModifierRequest()
1801                                     .withEntityForm(entityForm)
1802                                     .withConfiguration(data)
1803                                     .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
1804                                     .withEntity(entity)
1805                                     .withRowLevelSecurityService(rowLevelSecurityService));
1806                         }
1807                     }
1808                 }
1809             }
1810         }
1811     }
1812 
1813     /**
1814      * Obtains the class name suitable for passing along to the {@link SecurityVerifier}
1815      * @param entityForm
1816      * @param cmd
1817      * @return
1818      */
1819     protected String getSecurityClassname(EntityForm entityForm, ClassMetadata cmd) {
1820         String securityEntityClassname = entityForm.getCeilingEntityClassname();
1821 
1822         if (!StringUtils.isEmpty(cmd.getSecurityCeilingType())) {
1823             securityEntityClassname = cmd.getSecurityCeilingType();
1824         } else {
1825             if (entityForm.getDynamicFormInfos() != null) {
1826                 for (DynamicEntityFormInfo info : entityForm.getDynamicFormInfos().values()) {
1827                     if (!StringUtils.isEmpty(info.getSecurityCeilingClassName())) {
1828                         securityEntityClassname = info.getSecurityCeilingClassName();
1829                         break;
1830                     }
1831                 }
1832             }
1833         }
1834 
1835         return securityEntityClassname;
1836     }
1837 
1838     @Override
1839     public void populateEntityFormFields(EntityForm ef, Entity entity) {
1840         populateEntityFormFields(ef, entity, true, true);
1841     }
1842 
1843     @Override
<abbr title="1844     public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean populateId) {">1844     public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean popuðŸ”µ</abbr>
1845         if (populateId) {
1846             ef.setId(entity.findProperty(ef.getIdProperty()).getValue());
1847         }
1848         if (populateType) {
1849             ef.setEntityType(entity.getType()[0]);
1850         }
1851 
1852         for (Entry&lt;String, Field&gt; entry : ef.getFields().entrySet()) {
1853             Property entityProp = entity.findProperty(entry.getKey());
1854             if (entityProp != null) {
1855                 entry.getValue().setValue(entityProp.getValue());
1856                 entry.getValue().setDisplayValue(entityProp.getDisplayValue());
1857             }
1858         }
1859     }
1860 
1861     @Override
<abbr title="1862     public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedList) {">1862     public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedLiðŸ”µ</abbr>
<abbr title="1863         Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());">1863         Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdPropeðŸ”µ</abbr>
1864         Property entityProp = entity.findProperty(ef.getIdProperty());
1865         field.setValue(entityProp.getValue());
1866 
1867         if (StringUtils.isNotBlank(adornedList.getSortField())) {
1868             field = ef.findField(adornedList.getSortField());
1869             entityProp = entity.findProperty(adornedList.getSortField());
1870             if (field != null &amp;&amp; entityProp != null) {
1871                 field.setValue(entityProp.getValue());
1872             }
1873         }
1874     }
1875 
1876     @Override
1877     public void populateMapEntityFormFields(EntityForm ef, Entity entity) {
1878         Field field = ef.findField(&quot;priorKey&quot;);
1879         Property entityProp = entity.findProperty(&quot;key&quot;);
1880         if (field != null &amp;&amp; entityProp != null) {
1881             field.setValue(entityProp.getValue());
1882         }
1883     }
1884 
1885     @Override
<abbr title="1886     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1886     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList aðŸ”µ</abbr>
<abbr title="1887             String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1887             String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdðŸ”µ</abbr>
1888             throws ServiceException {
1889         EntityForm ef = createStandardAdornedEntityForm();
<abbr title="1890         return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAdd);">1890         return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrðŸ”µ</abbr>
1891     }
1892 
1893     @Override
<abbr title="1894     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1894     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList aðŸ”µ</abbr>
<abbr title="1895             String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1895             String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbðŸ”µ</abbr>
1896             throws ServiceException {
1897         ef.setEntityType(adornedList.getAdornedTargetEntityClassname());
1898 
1899         // Get the metadata for this adorned field
1900         PersistencePackageRequest request = PersistencePackageRequest.adorned()
1901                 .withCeilingEntityClassname(adornedMd.getCollectionCeilingEntity())
1902                 .withAdornedList(adornedList)
1903                 .withSectionCrumbs(sectionCrumbs);
1904         request.setAddOperationInspect(isAdd);
<abbr title="1905         ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getClassMetaData();">1905         ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSðŸ”µ</abbr>
1906 
1907         List&lt;Property&gt; entityFormProperties = new ArrayList&lt;&gt;();
1908         if (isViewCollectionItem) {
1909             Collections.addAll(entityFormProperties, collectionMetadata.getProperties());
1910         } else {
1911             // We want our entity form to only render the maintained adorned target fields
1912             for (String targetFieldName : adornedMd.getMaintainedAdornedTargetFields()) {
1913                 Property p = collectionMetadata.getPMap().get(targetFieldName);
<abbr title="1914                 if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExcluded())) {">1914                 if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadatðŸ”µ</abbr>
1915                     ((BasicFieldMetadata) p.getMetadata()).setVisibility(VisibilityEnum.VISIBLE_ALL);
1916                     entityFormProperties.add(p);
1917                 }
1918             }
1919         }
1920 
1921         // Set the maintained fields on the form
1922         setEntityFormFields(collectionMetadata, ef, entityFormProperties);
1923 
1924         // Add these two additional hidden fields that are required for persistence
1925         Field f = new Field()
1926                 .withName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty())
1927                 .withFieldType(SupportedFieldType.HIDDEN.toString())
1928                 .withValue(parentId);
1929         ef.addHiddenField(collectionMetadata, f);
1930 
1931         f = new Field()
1932                 .withName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty())
1933                 .withFieldType(SupportedFieldType.HIDDEN.toString())
1934                 .withIdOverride(&quot;adornedTargetIdProperty&quot;);
1935         ef.addHiddenField(collectionMetadata, f);
1936 
1937         if (StringUtils.isNotBlank(adornedList.getSortField())) {
1938             f = new Field()
1939                     .withName(adornedList.getSortField())
1940                     .withFieldType(SupportedFieldType.HIDDEN.toString());
1941             ef.addHiddenField(collectionMetadata, f);
1942         }
1943 
1944         ef.setParentId(parentId);
1945 
1946         extensionManager.getProxy().addAdditionalAdornedFormActions(ef);
1947 
1948         return ef;
1949     }
1950 
1951 
1952     @Override
<abbr title="1953     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId)">1953     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd,ðŸ”µ</abbr>
1954             throws ServiceException {
1955         EntityForm ef = createStandardEntityForm();
1956         return buildMapForm(mapMd, mapStructure, cmd, parentId, ef);
1957     }
1958 
1959     @Override
<abbr title="1960     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId, EntityForm ef)">1960     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd,ðŸ”µ</abbr>
1961             throws ServiceException {
1962         ForeignKey foreignKey = (ForeignKey) mapMd.getPersistencePerspective()
1963                 .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY);
1964         ef.setEntityType(foreignKey.getForeignKeyClass());
1965 
1966         Field keyField;
1967         if (!mapMd.getForceFreeFormKeys()) {
1968             // We will use a combo field to render the key choices
1969             ComboField temp = new ComboField();
1970             temp.withName(&quot;key&quot;)
1971                     .withFieldType(&quot;combo_field&quot;)
1972                     .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1973             if (mapMd.getKeys() != null) {
1974                 // The keys can be explicitly set in the annotation...
1975                 temp.setOptions(mapMd.getKeys());
1976             } else {
1977                 // Or they could be based on a different entity
1978                 PersistencePackageRequest ppr = PersistencePackageRequest.standard()
1979                         .withCeilingEntityClassname(mapMd.getMapKeyOptionEntityClass());
1980 
1981                 DynamicResultSet drs = adminEntityService.getRecords(ppr).getDynamicResultSet();
1982 
1983                 for (Entity entity : drs.getRecords()) {
<abbr title="1984                     String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getValue();">1984                     String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getVaðŸ”µ</abbr>
<abbr title="1985                     String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getValue();">1985                     String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayFieldðŸ”µ</abbr>
1986                     temp.putOption(keyValue, keyDisplayValue);
1987                 }
1988             }
1989             keyField = temp;
1990         } else {
1991             keyField = new Field().withName(&quot;key&quot;)
1992                                 .withFieldType(SupportedFieldType.STRING.toString())
1993                                 .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1994         }
1995         keyField.setRequired(true);
1996         ef.addMapKeyField(cmd, keyField);
1997 
1998         // Set the fields for this form
1999         List&lt;Property&gt; mapFormProperties;
2000         if (mapMd.isSimpleValue()) {
2001             ef.setIdProperty(&quot;key&quot;);
2002             mapFormProperties = new ArrayList&lt;&gt;();
2003             Property valueProp = cmd.getPMap().get(&quot;value&quot;);
2004             mapFormProperties.add(valueProp);
2005         } else {
2006             String valueClassName = mapStructure.getValueClassName();
2007             List&lt;String&gt; classNames = getValueClassNames(valueClassName);
2008 
2009             mapFormProperties = new ArrayList&lt;&gt;(Arrays.asList(cmd.getProperties()));
2010             filterMapFormProperties(mapFormProperties, classNames);
2011         }
2012 
2013         setEntityFormFields(cmd, ef, mapFormProperties);
2014 
2015         Field f = new Field()
2016                 .withName(&quot;priorKey&quot;)
2017                 .withFieldType(SupportedFieldType.HIDDEN.toString());
2018         ef.addHiddenField(cmd, f);
2019 
2020         ef.setParentId(parentId);
2021 
2022         return ef;
2023     }
2024 
2025     protected List&lt;String&gt; getValueClassNames(String valueClassName) {
2026         PersistenceManager pm = PersistenceManagerFactory.getPersistenceManager(valueClassName);
2027         List&lt;String&gt; classNames = new ArrayList&lt;&gt;();
2028         try {
2029             Class&lt;?&gt;[] mapEntities = pm.getPolymorphicEntities(valueClassName);
2030             for (Class clazz : mapEntities) {
2031                 classNames.add(clazz.getName());
2032             }
2033         } catch (ClassNotFoundException e) {
2034             classNames.add(valueClassName);
2035         }
2036         return classNames;
2037     }
2038 
<abbr title="2039     protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNames) {">2039     protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNameðŸ”µ</abbr>
2040         CollectionUtils.filter(mapFormProperties, new Predicate() {
2041             @Override
2042             public boolean evaluate(Object object) {
2043                 Property p = (Property) object;
2044                 for (String availType : p.getMetadata().getAvailableToTypes()) {
2045                     if (classNames.contains(availType)) {
2046                         return true;
2047                     }
2048                 }
2049                 return false;
2050             }
2051         });
2052     }
2053 
2054     protected EntityForm createStandardEntityForm() {
2055         EntityForm ef = new EntityForm();
2056         ef.addAction(DefaultEntityFormActions.SAVE);
2057         return ef;
2058     }
2059 
2060     protected EntityForm createStandardAdornedEntityForm() {
2061         EntityForm ef = new EntityForm();
2062         ef.addAction(DefaultAdornedEntityFormActions.Add);
2063         return ef;
2064     }
2065 
2066     protected VisibilityEnum[] getGridHiddenVisibilities() {
2067         return FormBuilderServiceImpl.GRID_HIDDEN_VISIBILITIES;
2068     }
2069 
2070     protected VisibilityEnum[] getFormHiddenVisibilities() {
2071         return FormBuilderServiceImpl.FORM_HIDDEN_VISIBILITIES;
2072     }
2073 
2074 }
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.service;
  19 
  20 import com.fasterxml.jackson.core.Version;
  21 import com.fasterxml.jackson.databind.ObjectMapper;
  22 import com.fasterxml.jackson.databind.module.SimpleModule;
  23 import java.io.IOException;
  24 import java.math.BigDecimal;
  25 import java.text.DateFormat;
  26 import java.text.DateFormatSymbols;
  27 import java.text.DecimalFormat;
  28 import java.text.NumberFormat;
  29 import java.text.ParseException;
  30 import java.text.SimpleDateFormat;
  31 import java.util.ArrayList;
  32 import java.util.Arrays;
  33 import java.util.Collections;
  34 import java.util.Date;
  35 import java.util.HashMap;
  36 import java.util.List;
  37 import java.util.Locale;
  38 import java.util.Map.Entry;
  39 import java.util.Map;
  40 import java.util.Set;
  41 import javax.annotation.Resource;
  42 import javax.persistence.ManyToOne;
  43 import javax.persistence.OneToOne;
  44 import javax.servlet.http.HttpServletRequest;
  45 import org.apache.commons.collections.CollectionUtils;
  46 import org.apache.commons.collections.Predicate;
  47 import org.apache.commons.lang.ArrayUtils;
  48 import org.apache.commons.lang.BooleanUtils;
  49 import org.apache.commons.lang3.StringUtils;
  50 import org.apache.commons.logging.Log;
  51 import org.apache.commons.logging.LogFactory;
  52 import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  53 import org.broadleafcommerce.common.exception.ExceptionHelper;
  54 import org.broadleafcommerce.common.exception.SecurityServiceException;
  55 import org.broadleafcommerce.common.exception.ServiceException;
  56 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  57 import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  58 import org.broadleafcommerce.common.i18n.service.TranslationService;
  59 import org.broadleafcommerce.common.locale.service.LocaleService;
  60 import org.broadleafcommerce.common.media.domain.MediaDto;
  61 import org.broadleafcommerce.common.persistence.EntityConfiguration;
  62 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  63 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  64 import org.broadleafcommerce.common.presentation.client.AdornedTargetAddMethodType;
  65 import org.broadleafcommerce.common.presentation.client.LookupType;
  66 import org.broadleafcommerce.common.presentation.client.PersistencePerspectiveItemType;
  67 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  68 import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
  69 import org.broadleafcommerce.common.security.service.ExploitProtectionService;
  70 import org.broadleafcommerce.common.util.BLCMessageUtils;
  71 import org.broadleafcommerce.common.util.FormatUtil;
  72 import org.broadleafcommerce.common.util.StringUtil;
  73 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  74 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  75 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  76 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  77 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  78 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  79 import org.broadleafcommerce.openadmin.dto.ClassTree;
  80 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  81 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  82 import org.broadleafcommerce.openadmin.dto.Entity;
  83 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  84 import org.broadleafcommerce.openadmin.dto.ForeignKey;
  85 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  86 import org.broadleafcommerce.openadmin.dto.MapStructure;
  87 import org.broadleafcommerce.openadmin.dto.Property;
  88 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  89 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  90 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  91 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  92 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  93 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  94 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  95 import org.broadleafcommerce.openadmin.server.security.remote.SecurityVerifier;
  96 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifier;
  97 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierConfiguration;
  98 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierData;
  99 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierDataPoint;
 100 import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierRequest;
 101 import org.broadleafcommerce.openadmin.server.security.service.ExceptionAwareRowLevelSecurityProvider;
 102 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
 103 import org.broadleafcommerce.openadmin.server.security.service.navigation.AdminNavigationService;
 104 import org.broadleafcommerce.openadmin.server.service.AdminEntityService;
 105 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManager;
 106 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
 107 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
 108 import org.broadleafcommerce.openadmin.server.service.persistence.module.FieldManager;
 109 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
 110 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
 111 import org.broadleafcommerce.openadmin.web.form.component.ListGridAction;
 112 import org.broadleafcommerce.openadmin.web.form.component.ListGridActionGroup;
 113 import org.broadleafcommerce.openadmin.web.form.component.ListGridRecord;
 114 import org.broadleafcommerce.openadmin.web.form.component.MediaField;
 115 import org.broadleafcommerce.openadmin.web.form.component.RuleBuilderField;
 116 import org.broadleafcommerce.openadmin.web.form.entity.CodeField;
 117 import org.broadleafcommerce.openadmin.web.form.entity.ComboField;
 118 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
 119 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
 120 import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
 121 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
 122 import org.broadleafcommerce.openadmin.web.form.entity.Field;
 123 import org.broadleafcommerce.openadmin.web.rulebuilder.DataDTODeserializer;
 124 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataDTO;
 125 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataWrapper;
 126 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldDTO;
 127 import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldWrapper;
 128 import org.codehaus.jettison.json.JSONObject;
 129 import org.springframework.beans.factory.annotation.Value;
 130 import org.springframework.context.MessageSource;
 131 import org.springframework.context.NoSuchMessageException;
 132 import org.springframework.stereotype.Service;
 133 
 134 
 135 /**
 136  * @author Andre Azzolini (apazzolini)
 137  */
 138 @Service(&quot;blFormBuilderService&quot;)
 139 public class FormBuilderServiceImpl implements FormBuilderService {
 140     private static final Log LOG = LogFactory.getLog(FormBuilderServiceImpl.class);
 141 
 142     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 143 
 144     @Resource(name = &quot;blAdminEntityService&quot;)
 145     protected AdminEntityService adminEntityService;
 146 
 147     @Resource (name = &quot;blAdminNavigationService&quot;)
 148     protected AdminNavigationService navigationService;
 149 
 150     @Resource(name = &quot;blFormBuilderExtensionManager&quot;)
 151     protected FormBuilderExtensionManager extensionManager;
 152 
 153     @Resource(name=&quot;blEntityConfiguration&quot;)
 154     protected EntityConfiguration entityConfiguration;
 155 
 156     @Resource(name=&quot;blAdminSecurityRemoteService&quot;)
 157     protected SecurityVerifier adminRemoteSecurityService;
 158 
 159     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 160     protected RowLevelSecurityService rowLevelSecurityService;
 161 
 162     @Resource(name = &quot;blMediaBuilderService&quot;)
 163     protected MediaBuilderService mediaBuilderService;
 164 
 165     @Resource(name = &quot;blListGridErrorMessageExtensionManager&quot;)
 166     protected ListGridErrorMessageExtensionManager listGridErrorExtensionManager;
 167 
 168     @Resource(name = &quot;blAdminNavigationService&quot;)
 169     protected AdminNavigationService adminNavigationService;
 170 
 171     @Resource(name = &quot;blEntityDuplicator&quot;)
 172     protected EntityDuplicator duplicator;
 173 
 174     @Resource(name = &quot;blDynamicEntityDao&quot;)
 175     protected DynamicEntityDao dynamicEntityDao;
 176 
 177     @Resource(name = &quot;blLocaleService&quot;)
 178     protected LocaleService localeService;
 179 
 180     @Resource(name = &quot;blTranslationService&quot;)
 181     protected TranslationService translationService;
 182 
 183     @Value(&quot;${use.translation.search:false}&quot;)
 184     protected boolean useTranslationSearch;
 185 
 186     @Resource(name = &quot;blExploitProtectionService&quot;)
 187     ExploitProtectionService exploitProtectionService;
 188 
<abbr title=" 189     protected static final VisibilityEnum[] FORM_HIDDEN_VISIBILITIES = new VisibilityEnum[]{ VisibilityEnum.HIDDEN_ALL, VisibilityEnum.FORM_HIDDEN };"> 189     protected static final VisibilityEnum[] FORM_HIDDEN_VISIBILITIES = new VisibilityEnum[]{ VisibilityEnðŸ”µ</abbr>
 190 
<abbr title=" 191     protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[]{ VisibilityEnum.HIDDEN_ALL, VisibilityEnum.GRID_HIDDEN };"> 191     protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[]{ VisibilityEnðŸ”µ</abbr>
 192 
 193     @Override
<abbr title=" 194     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)"> 194     public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SeðŸ”µ</abbr>
 195             throws ServiceException {
 196 
 197         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 198         ListGrid.Type type = ListGrid.Type.MAIN;
 199         String idProperty = &quot;id&quot;;
 200 
 201         FieldWrapper wrapper = new FieldWrapper();
 202         ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 203         for (Property p : cmd.getProperties()) {
 204             if (p.getMetadata() instanceof BasicFieldMetadata) {
 205                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
 206 
 207                 if (SupportedFieldType.ID.equals(fmd.getFieldType())) {
 208                     idProperty = fmd.getName();
 209                 }
 210 
 211                 if (fmd.isProminent() != null &amp;&amp; fmd.isProminent()
 212                         &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), fmd.getVisibility())) {
 213                     Field hf = createHeaderField(p, fmd);
 214                     headerFields.add(hf);
 215                     defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, fmd));
 216                 }
 217 
 218                 if (fmd.getIsFilter() != null &amp;&amp; fmd.getIsFilter()) {
<abbr title=" 219                     wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmd));"> 219                     wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmdðŸ”µ</abbr>
 220                 }
 221             }
 222         }
 223 
 224         if (useTranslationSearch) {
 225             getTranslationSearchField(cmd.getCeilingType(), defaultWrapperFields);
 226         }
 227 
<abbr title=" 228         ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idProperty, sectionCrumbs);"> 228         ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, ðŸ”µ</abbr>
 229 
 230         if (CollectionUtils.isNotEmpty(listGrid.getHeaderFields())) {
 231             // Set the first column to be able to link to the main entity
 232             listGrid.getHeaderFields().iterator().next().setMainEntityLink(true);
 233         } else {
<abbr title=" 234             String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType();"> 234             String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeiðŸ”µ</abbr>
 235             message += &quot;Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 236             LOG.error(message);
 237         }
 238 
 239         Date c = new Date();
 240         String friendlyName = &quot;listGrid&quot; + c.getTime();
 241         // Set up the filter builder params
 242         listGrid.setJsonFieldName(friendlyName + &quot;Json&quot;);
 243         listGrid.setFriendlyName(friendlyName);
 244         listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 245         if (CollectionUtils.isEmpty(wrapper.getFields())) {
 246             wrapper.setFields(defaultWrapperFields);
 247         }
 248         listGrid.setFieldWrapper(wrapper);
 249         listGrid.setHideFriendlyName(true);
 250 
 251         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 252         listGrid.setJson(blankJsonString);
 253         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 254         if (dw != null) {
 255             listGrid.setDataWrapper(dw);
 256         }
 257 
 258         listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 259         listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 260 
 261         extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 262 
 263         return listGrid;
 264     }
 265 
<abbr title=" 266     private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFields) {"> 266     private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFieldsðŸ”µ</abbr>
 267 
 268         TranslatedEntity translatedEntity;
 269 
 270         try {
 271             translatedEntity = translationService.getAssignableEntityType(ceilingEntity);
 272 
 273             FieldDTO localeField = new FieldDTO();
 274             localeField.setId(&quot;translationLocale&quot;);
 275             localeField.setLabel(&quot;Translation locale&quot;);
 276             localeField.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 277             localeField.setInput(&quot;select&quot;);
 278             localeField.setType(&quot;string&quot;);
 279 
<abbr title=" 280             List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocales();"> 280             List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocaleðŸ”µ</abbr>
 281 
 282             Map&lt;String, String&gt; localeMap = new HashMap&lt;String, String&gt;();
 283             for (org.broadleafcommerce.common.locale.domain.Locale l : locales) {
 284                 localeMap.put(l.getLocaleCode(), l.getFriendlyName());
 285             }
 286             localeField.setValues((new JSONObject(localeMap)).toString());
 287 
 288             defaultWrapperFields.add(localeField);
 289         } catch (Exception e) {
 290             translatedEntity = null;
 291         }
 292     }
 293 
 294     protected FieldDTO constructFieldDTOFromFieldData(Field field, BasicFieldMetadata fmd) {
 295         FieldDTO fieldDTO = new FieldDTO();
 296         // translate the label to display
 297         String label = field.getFriendlyName();
 298         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 299         MessageSource messages = context.getMessageSource();
 300         if (messages != null) {
 301             label = messages.getMessage(label, null, label, context.getJavaLocale());
 302         }
 303         fieldDTO.setLabel(label);
 304         fieldDTO.setId(field.getName());
 305         if (field.getFieldType().equals(&quot;STRING&quot;)) {
 306             fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 307         } else if (field.getFieldType().equals(&quot;DATE&quot;)) {
 308             fieldDTO.setOperators(&quot;blcFilterOperators_Date&quot;);
<abbr title=" 309         } else if ((field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;)) || field.getFieldType().equals(&quot;DECIMAL&quot;)) {"> 309         } else if ((field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;)) || fieðŸ”µ</abbr>
 310             fieldDTO.setOperators(&quot;blcFilterOperators_Numeric&quot;);
 311         } else if (field.getFieldType().equals(&quot;BOOLEAN&quot;)) {
 312             fieldDTO.setOperators(&quot;blcFilterOperators_Boolean&quot;);
 313         } else if (field.getFieldType().equals(&quot;BROADLEAF_ENUMERATION&quot;)) {
 314             fieldDTO.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 315             fieldDTO.setInput(&quot;select&quot;);
 316             fieldDTO.setType(&quot;string&quot;);
 317             String[][] enumerationValues = fmd.getEnumerationValues();
 318             // not sure if we need to decode here or not...
 319             for (int i = 0; i &lt; enumerationValues.length; i++) {
 320                 enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1]);
 321             }
 322             Map&lt;String, String&gt; enumMap = new HashMap&lt;&gt;();
 323             for (int i = 0; i &lt; enumerationValues.length; i++) {
 324                 enumMap.put(enumerationValues[i][0], enumerationValues[i][1]);
 325             }
 326             fieldDTO.setValues(new JSONObject(enumMap).toString());
 327         } else if (field.getFieldType().equals(&quot;ADDITIONAL_FOREIGN_KEY&quot;)) {
 328             fieldDTO.setOperators(&quot;blcFilterOperators_Selectize&quot;);
 329             fieldDTO.setType(&quot;string&quot;);
<abbr title=" 330             AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClass(), null);"> 330             AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeðŸ”µ</abbr>
 331             if (section != null) {
 332                 String sectionKey = section.getUrl().substring(1);
 333                 fieldDTO.setSelectizeSectionKey(sectionKey);
 334             } else {
 335                 fieldDTO.setSelectizeSectionKey(fmd.getForeignKeyClass());
 336             }
 337         } else {
 338             fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 339         }
 340         return fieldDTO;
 341     }
 342 
 343     protected Field createHeaderField(Property p, BasicFieldMetadata fmd) {
 344         Field hf;
<abbr title=" 345         if (((fmd.getFieldType().equals(SupportedFieldType.EXPLICIT_ENUMERATION) || fmd.getFieldType().equals(SupportedFieldType.BROADLEAF_ENUMERATION)) || fmd.getFieldType().equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION)) || fmd.getFieldType().equals(SupportedFieldType.EMPTY_ENUMERATION)) {"> 345         if (((fmd.getFieldType().equals(SupportedFieldType.EXPLICIT_ENUMERATION) || fmd.getFieldType().eqðŸ”µ</abbr>
 346             hf = new ComboField();
 347             String[][] enumerationValues = fmd.getEnumerationValues();
 348             for (int i = 0; i &lt; enumerationValues.length; i++) {
 349                 enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1]);
 350             }
 351             ((ComboField) (hf)).setOptions(enumerationValues);
 352         } else {
 353             hf = new Field();
 354         }
<abbr title=" 355         hf.withName(p.getName()).withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getName()).withOrder(fmd.getGridOrder()).withColumnWidth(fmd.getColumnWidth()).withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty()).withForeignKeyClass(fmd.getForeignKeyClass()).withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass())).withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClass()).withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity());"> 355         hf.withName(p.getName()).withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getðŸ”µ</abbr>
 356         String fieldType = (fmd.getFieldType() == null) ? null : fmd.getFieldType().toString();
 357         hf.setFieldType(fieldType);
 358         return hf;
 359     }
 360 
 361     @Override
<abbr title=" 362     public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property field,"> 362     public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property fieðŸ”µ</abbr>
 363             String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 364             throws ServiceException {
 365         FieldMetadata fmd = field.getMetadata();
 366         // Get the class metadata for this particular field
 367         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 368         if (field != null) {
 369             ppr.setSectionEntityField(field.getName());
 370         }
<abbr title=" 371         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 371         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDaðŸ”µ</abbr>
 372 
 373         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 374         ListGrid.Type type = null;
 375         boolean editable = false;
 376         boolean sortable = false;
 377         boolean readOnly = false;
 378         boolean hideIdColumn = false;
 379         boolean canFilterAndSort = true;
 380         boolean modalSingleSelectable = false;
 381         boolean modalMultiSelectable = false;
 382         boolean selectize = false;
 383         boolean isMedia = false;
 384         boolean isLookup = false;
 385         String sortProperty = null;
 386         FieldWrapper wrapper = new FieldWrapper();
 387         ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 388 
 389 
 390         String idProperty = &quot;id&quot;;
 391         for (Property property : cmd.getProperties()) {
 392             if (property.getMetadata() instanceof BasicFieldMetadata &amp;&amp;
<abbr title=" 393                     SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;&amp;"> 393                     SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;ðŸ”µ</abbr>
 394                     //make sure it&#x27;s a property for this entity - not an association
 395                     !property.getName().contains(&quot;.&quot;)) {
 396                 idProperty = property.getName();
 397                 break;
 398             }
 399         }
<abbr title=" 400         // Get the header fields for this list grid. Note that the header fields are different depending on the"> 400         // Get the header fields for this list grid. Note that the header fields are different depending ðŸ”µ</abbr>
 401         // kind of field this is.
 402         if (fmd instanceof BasicFieldMetadata) {
 403             readOnly = ((BasicFieldMetadata) fmd).getReadOnly();
 404             modalSingleSelectable = true;
 405             for (Property p : cmd.getProperties()) {
 406                 if (p.getMetadata() instanceof BasicFieldMetadata) {
 407                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 408 
 409                     if (SupportedFieldType.ID.equals(md.getFieldType())) {
 410                         idProperty = md.getName();
 411                     }
 412 
 413                     if (md.isProminent() != null &amp;&amp; md.isProminent()
 414                             &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 415                         Field hf = createHeaderField(p, md);
 416                         headerFields.add(hf);
 417                         defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 418                     }
 419 
 420                     if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 421                         Field f = createHeaderField(p, md);
 422                         wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 423                     }
 424                 }
 425             }
 426 
 427             type = ListGrid.Type.TO_ONE;
 428         } else if (fmd instanceof BasicCollectionMetadata) {
 429             BasicCollectionMetadata bcm = (BasicCollectionMetadata) fmd;
 430             readOnly = !bcm.isMutable();
 431 
 432             if(AddMethodType.LOOKUP.equals(bcm.getAddMethodType())) {
 433                 isLookup = true;
 434             }
 435 
 436             if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 437                 Property p = cmd.getPMap().get(bcm.getSelectizeVisibleField());
 438                 if (p != null) {
 439                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 440 
 441                     Field hf = createHeaderField(p, md);
 442                     headerFields.add(hf);
 443                     wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 444                 }
 445             } else {
 446                 for (Property p : cmd.getProperties()) {
 447                     if (p.getMetadata() instanceof BasicFieldMetadata) {
 448                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 449                         if (md.isProminent() != null &amp;&amp; md.isProminent()
<abbr title=" 450                                 &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {"> 450                                 &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility()))ðŸ”µ</abbr>
 451                             Field hf = createHeaderField(p, md);
 452                             headerFields.add(hf);
 453                             defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 454                         }
 455 
 456                         if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 457                             Field f = createHeaderField(p, md);
 458                             wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 459                         }
 460                     }
 461                 }
 462             }
 463 
 464             type = ListGrid.Type.BASIC;
 465 
<abbr title=" 466             if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getAddMethodType())) {"> 466             if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equalðŸ”µ</abbr>
 467                 editable = true;
 468             } else if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 469                 selectize = true;
 470                 modalSingleSelectable = true;
 471             } else {
 472                 modalSingleSelectable = true;
 473             }
 474             sortable = StringUtils.isNotBlank(bcm.getSortProperty());
 475             if (sortable) {
 476                 sortProperty = bcm.getSortProperty();
 477             }
 478         } else if (fmd instanceof AdornedTargetCollectionMetadata) {
 479             modalSingleSelectable = true;
 480             readOnly = !((AdornedTargetCollectionMetadata) fmd).isMutable();
 481             AdornedTargetCollectionMetadata atcmd = (AdornedTargetCollectionMetadata) fmd;
 482 
 483             if(AdornedTargetAddMethodType.LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 484                 isLookup = true;
 485             }
 486 
<abbr title=" 487             if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {"> 487             if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())ðŸ”µ</abbr>
 488                 selectize = true;
 489 
 490                 Property p = cmd.getPMap().get(atcmd.getSelectizeVisibleField());
 491                 if (p != null) {
 492                     BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 493 
 494                     Field hf = createHeaderField(p, md);
 495                     headerFields.add(hf);
 496                     wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 497                 }
 498             } else {
 499                 for (String fieldName : atcmd.getGridVisibleFields()) {
 500                     Property p = cmd.getPMap().get(fieldName);
 501                     if (p != null) {
 502                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 503 
 504                         Field hf = createHeaderField(p, md);
 505                         headerFields.add(hf);
 506                         wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 507                     }
 508 
 509                 }
 510             }
 511 
 512             type = ListGrid.Type.ADORNED;
 513 
 514             if (atcmd.getMaintainedAdornedTargetFields().length &gt; 0) {
 515                 editable = true;
 516             }
 517 
 518             AdornedTargetList adornedList = (AdornedTargetList) atcmd.getPersistencePerspective()
<abbr title=" 519                     .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);"> 519                     .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLISðŸ”µ</abbr>
 520             sortable = StringUtils.isNotBlank(adornedList.getSortField());
 521             if (sortable) {
 522                 sortProperty = adornedList.getSortField();
 523             }
 524         } else if (fmd instanceof MapMetadata) {
 525             readOnly = !((MapMetadata) fmd).isMutable();
 526             MapMetadata mmd = (MapMetadata) fmd;
 527 
 528             Property p2 = cmd.getPMap().get(&quot;key&quot;);
 529             BasicFieldMetadata keyMd = (BasicFieldMetadata) p2.getMetadata();
 530             keyMd.setFriendlyName(getMapKeyFriendlyName(p2));
 531             Field hf = createHeaderField(p2, keyMd);
 532             headerFields.add(hf);
 533             wrapper.getFields().add(constructFieldDTOFromFieldData(hf, keyMd));
 534 
 535             if (mmd.isSimpleValue()) {
 536                 Property valueProperty = cmd.getPMap().get(&quot;value&quot;);
 537                 BasicFieldMetadata valueMd = (BasicFieldMetadata) valueProperty.getMetadata();
 538                 valueMd.setFriendlyName(&quot;Value&quot;);
 539                 hf = createHeaderField(valueProperty, valueMd);
 540                 headerFields.add(hf);
 541                 wrapper.getFields().add(constructFieldDTOFromFieldData(hf, valueMd));
 542 
 543                 idProperty = &quot;key&quot;;
 544                 hideIdColumn = true;
 545             } else {
 546                 for (Property p : cmd.getProperties()) {
 547                     if (p.getMetadata() instanceof BasicFieldMetadata) {
 548                         BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 549                         String valueClassName = mmd.getValueClassName();
 550                         if (!StringUtils.isEmpty(mmd.getToOneTargetProperty())) {
 551                             Class&lt;?&gt; clazz;
 552                             try {
 553                                 clazz = Class.forName(mmd.getValueClassName());
 554                             } catch (ClassNotFoundException e) {
 555                                 throw ExceptionHelper.refineException(e);
 556                             }
<abbr title=" 557                             java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTargetProperty());"> 557                             java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.ðŸ”µ</abbr>
 558                             ManyToOne manyToOne = nestedField.getAnnotation(ManyToOne.class);
<abbr title=" 559                             if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getName())) {"> 559                             if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.clasðŸ”µ</abbr>
 560                                 valueClassName = manyToOne.targetEntity().getName();
 561                             } else {
 562                                 OneToOne oneToOne = nestedField.getAnnotation(OneToOne.class);
<abbr title=" 563                                 if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getName())) {"> 563                                 if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.clðŸ”µ</abbr>
 564                                     valueClassName = oneToOne.targetEntity().getName();
 565                                 }
 566                             }
 567                         }
 568                         if (md.getTargetClass().equals(valueClassName)) {
 569                             if (md.isProminent() != null &amp;&amp; md.isProminent()
<abbr title=" 570                                     &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {"> 570                                     &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibilityðŸ”µ</abbr>
 571                                 hf = createHeaderField(p, md);
 572                                 headerFields.add(hf);
 573                                 defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 574 
 575                                 // Is this a media listgrid
 576                                 if (hf.getFieldType().equals(&quot;ASSET_LOOKUP&quot;)) {
 577                                     isMedia = true;
 578                                 }
 579                             }
 580 
 581                             if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 582                                 wrapper.getFields().add(constructFieldDTOFromFieldData(hf,md));
 583                             }
 584                         }
 585                     }
 586                 }
 587             }
 588 
 589             type = ListGrid.Type.MAP;
 590             editable = true;
 591             canFilterAndSort = false;
 592         }
 593 
 594         String ceilingType = &quot;&quot;;
 595         if (fmd instanceof BasicFieldMetadata) {
 596             ceilingType = cmd.getCeilingType();
 597         } else if (fmd instanceof CollectionMetadata) {
 598             ceilingType = ((CollectionMetadata) fmd).getCollectionCeilingEntity();
 599         }
 600 
 601         if (CollectionUtils.isEmpty(headerFields)) {
<abbr title=" 602             String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; and property &#x27;&quot; +"> 602             String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingTypðŸ”µ</abbr>
 603                     StringUtil.sanitize(field.getName()) + &quot;&#x27;.&quot;;
<abbr title=" 604             if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) {"> 604             if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) ðŸ”µ</abbr>
<abbr title=" 605                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 605                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTaðŸ”µ</abbr>
 606             } else if (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM) {
<abbr title=" 607                 message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 607                 message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetðŸ”µ</abbr>
 608             } else if (selectize &amp;&amp; type == ListGrid.Type.BASIC) {
<abbr title=" 609                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuration&quot;;"> 609                 message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollectioðŸ”µ</abbr>
 610             } else {
 611                 message += &quot; Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 612             }
 613             LOG.error(message);
 614         }
 615 
<abbr title=" 616         ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProperty, sectionCrumbs, sortProperty);"> 616         ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrderðŸ”µ</abbr>
 617         listGrid.setSubCollectionFieldName(field.getName());
 618         listGrid.setFriendlyName(field.getMetadata().getFriendlyName());
 619         if (StringUtils.isEmpty(listGrid.getFriendlyName())) {
 620             listGrid.setFriendlyName(field.getName());
 621         }
 622         listGrid.setContainingEntityId(containingEntityId);
 623         listGrid.setIsReadOnly(readOnly);
 624         listGrid.setHideIdColumn(hideIdColumn);
 625         listGrid.setCanFilterAndSort(canFilterAndSort);
 626 
 627         // Set up the filter builder params
 628         Date c = new Date();
 629         String friendlyName = field.getMetadata().getFriendlyName();
 630         String jsonFriendlyName = friendlyName.replaceAll(&quot; &quot;, &quot;_&quot;);
 631         listGrid.setJsonFieldName(jsonFriendlyName + c.getTime() + &quot;Json&quot;);
 632         listGrid.setFriendlyName(friendlyName);
 633         listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 634         if (CollectionUtils.isEmpty(wrapper.getFields())) {
 635             wrapper.setFields(defaultWrapperFields);
 636         }
 637         listGrid.setFieldWrapper(wrapper);
 638 
 639         String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 640         listGrid.setJson(blankJsonString);
 641         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 642         if (dw != null) {
 643             listGrid.setDataWrapper(dw);
 644         }
 645 
 646         if (editable) {
 647             listGrid.getRowActions().add(DefaultListGridActions.UPDATE);
 648         }
 649         if (readOnly) {
 650             listGrid.getRowActions().add(DefaultListGridActions.VIEW);
 651         }
 652         if (sortable) {
 653             listGrid.setCanFilterAndSort(false);
 654             listGrid.setIsSortable(true);
 655         }
 656 
 657         if (modalSingleSelectable) {
 658             if (readOnly) {
<abbr title=" 659                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(true));"> 659                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReðŸ”µ</abbr>
 660             } else {
 661                 listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 662 
 663             }
 664         }
 665         listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 666 
 667         if (selectize) {
 668             listGrid.setSelectizeUrl(buildSelectizeUrl(listGrid));
 669             listGrid.setSelectType(ListGrid.SelectType.SELECTIZE);
 670         }
 671 
 672         if (modalMultiSelectable) {
 673             listGrid.addModalRowAction(DefaultListGridActions.MULTI_SELECT);
 674             listGrid.setSelectType(ListGrid.SelectType.MULTI_SELECT);
 675         }
 676         listGrid.getRowActions().add(DefaultListGridActions.REMOVE);
 677 
 678         if (fmd.getManualFetch()) {
 679             listGrid.setManualFetch(true);
 680             listGrid.getToolbarActions().add(DefaultListGridActions.MANUAL_FETCH);
 681         }
 682         if (isMedia) {
 683             listGrid.setListGridType(ListGrid.Type.ASSET_GRID);
 684         }
 685 
 686         extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 687 
<abbr title=" 688         //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface"> 688         //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implemðŸ”µ</abbr>
 689         if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title=" 690             EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();"> 690             EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecðŸ”µ</abbr>
<abbr title=" 691             for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {"> 691             for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguratiðŸ”µ</abbr>
 692                 for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
 693                     if (modifier.isQualified(data.getModifierType())) {
 694                         modifier.modifyListGrid(new EntityFormModifierRequest()
 695                                 .withListGrid(listGrid)
 696                                 .withConfiguration(data)
 697                                 .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
 698                                 .withRowLevelSecurityService(rowLevelSecurityService));
 699                     }
 700                 }
 701             }
 702         }
 703         return listGrid;
 704     }
 705 
 706     protected String getMapKeyFriendlyName(Property property) {
 707         String friendlyNameFromMetadata = property.getMetadata().getFriendlyName();
 708 
 709         return (friendlyNameFromMetadata == null) ? &quot;Key&quot; : friendlyNameFromMetadata;
 710     }
 711 
 712     @Override
<abbr title=" 713     public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, Property field,"> 713     public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet dðŸ”µ</abbr>
 714         String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 715             throws ServiceException {
 716         FieldMetadata fmd = field.getMetadata();
 717         // Get the class metadata for this particular field
 718         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 719         if (field != null) {
 720             ppr.setSectionEntityField(field.getName());
 721         }
<abbr title=" 722         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 722         ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDaðŸ”µ</abbr>
 723 
 724         Map&lt;String, Object&gt; result = constructSelectizeOptionMap(drs, cmd);
 725 
 726         AdornedTargetList adornedList = ppr.getAdornedList();
 727         if (adornedList != null &amp;&amp; adornedList.getLinkedObjectPath() != null
 728             &amp;&amp; adornedList.getTargetObjectPath() != null &amp;&amp; adornedList.getLinkedIdProperty() != null
 729             &amp;&amp; adornedList.getTargetIdProperty() != null) {
<abbr title=" 730             result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());"> 730             result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkeðŸ”µ</abbr>
 731             result.put(&quot;linkedObjectId&quot;, containingEntityId);
<abbr title=" 732             result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());"> 732             result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargeðŸ”µ</abbr>
 733         }
 734 
 735         return result;
 736     }
 737 
 738     @Override
 739     public Map&lt;String, Object&gt; constructSelectizeOptionMap(DynamicResultSet drs, ClassMetadata cmd) {
 740         Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
 741         List&lt;Map&lt;String, String&gt;&gt; options = new ArrayList&lt;&gt;();
 742 
 743         List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 744         for (Property p : cmd.getProperties()) {
 745             if (p.getMetadata() instanceof BasicFieldMetadata) {
 746                 BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 747                 if (md.isProminent() != null &amp;&amp; md.isProminent()
 748                         &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 749                     Field hf = createHeaderField(p, md);
 750                     headerFields.add(hf);
 751                 }
 752             }
 753         }
 754 
 755         for (Entity e : drs.getRecords()) {
 756             Map&lt;String, String&gt; selectizeOption = new HashMap&lt;&gt;();
 757             for (Field headerField : headerFields) {
 758                 Property p = e.findProperty(headerField.getName());
 759                 if (p != null) {
 760                     selectizeOption.put(&quot;name&quot;, p.getValue());
 761                     break;
 762                 }
 763             }
 764             if (e.findProperty(&quot;id&quot;) != null) {
 765                 selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;id&quot;).getValue());
 766             //  &quot;Locale&quot; entity is a special occasion. Because it have not &quot;ID&quot; column with &quot;Long&quot; type
 767             } else if (e.findProperty(&quot;localeCode&quot;) != null) {
 768                 selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;localeCode&quot;).getValue());
 769             }
 770             if (e.findProperty(ALTERNATE_ID_PROPERTY) != null) {
 771                 selectizeOption.put(&quot;alternateId&quot;, e.findProperty(ALTERNATE_ID_PROPERTY).getValue());
 772             }
 773             options.add(selectizeOption);
 774         }
 775         result.put(&quot;options&quot;, options);
 776 
 777         return result;
 778     }
 779 
 780     protected String buildSelectizeUrl(ListGrid listGrid) {
 781         HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 782         String url = request.getContextPath();
<abbr title=" 783         url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + listGrid.getSectionKey();"> 783         url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() :ðŸ”µ</abbr>
 784         url += &quot;/&quot; + listGrid.getContainingEntityId();
 785         url += &quot;/&quot; + listGrid.getSubCollectionFieldName();
 786         return url;
 787     }
 788 
 789     /**
<abbr title=" 790      * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 790      * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, InteðŸ”µ</abbr>
 791      * @param className
 792      * @param headerFields
 793      * @param type
 794      * @param drs
 795      * @param sectionKey
 796      * @param order
 797      * @param idProperty
 798      * @param sectionCrumbs
 799      * @return
 800      */
 801     @Deprecated
<abbr title=" 802     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 802     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynðŸ”µ</abbr>
 803             String sectionKey, int order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs) {
<abbr title=" 804        return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,null);"> 804        return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,nuðŸ”µ</abbr>
 805     }
 806 
 807     /**
 808      * Populate a ListGrid with ListGridRecords.
 809      *
 810      * @param className
 811      * @param headerFields
 812      * @param type
 813      * @param drs
 814      * @param sectionKey
 815      * @param order
 816      * @param idProperty
 817      * @param sectionCrumbs
 818      * @param sortPropery
 819      * @return
 820      */
<abbr title=" 821     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 821     protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynðŸ”µ</abbr>
<abbr title=" 822             String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropery) {"> 822             String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, StringðŸ”µ</abbr>
 823         // Create the list grid and set some basic attributes
 824         ListGrid listGrid = new ListGrid();
 825         listGrid.setClassName(className);
 826         listGrid.getHeaderFields().addAll(headerFields);
 827         listGrid.setListGridType(type);
 828         listGrid.setSectionCrumbs(sectionCrumbs);
 829         listGrid.setSectionKey(sectionKey);
 830         listGrid.setOrder(order);
 831         listGrid.setIdProperty(idProperty);
 832         listGrid.setStartIndex(drs.getStartIndex());
 833         listGrid.setTotalRecords(drs.getTotalRecords());
 834         listGrid.setPageSize(drs.getPageSize());
 835 
 836         String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
<abbr title=" 837         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier);"> 837         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdðŸ”µ</abbr>
 838         if (section != null) {
 839             listGrid.setExternalEntitySectionKey(section.getUrl());
 840         }
 841 
 842         // format date list grid cells
 843         SimpleDateFormat formatter = new SimpleDateFormat(&quot;MMM d, y @ hh:mma&quot;);
 844         DateFormatSymbols symbols = new DateFormatSymbols(Locale.getDefault());
 845         symbols.setAmPmStrings(new String[] { &quot;am&quot;, &quot;pm&quot; });
 846         formatter.setDateFormatSymbols(symbols);
 847 
 848         // For each of the entities (rows) in the list grid, we need to build the associated
 849         // ListGridRecord and set the required fields on the record. These fields are the same ones
 850         // that are used for the header fields.
 851         for (Entity e : drs.getRecords()) {
 852             ListGridRecord record = new ListGridRecord();
 853             record.setListGrid(listGrid);
 854             record.setDirty(e.isDirty());
 855             record.setEntity(e);
 856             if (StringUtils.isNotBlank(sortPropery) &amp;&amp; e.findProperty(sortPropery) != null) {
 857                 Property sort = e.findProperty(sortPropery);
 858                 record.setDisplayOrder(sort.getValue());
 859             }
 860             if (e.findProperty(&quot;hasError&quot;) != null) {
 861                 Boolean hasError = Boolean.parseBoolean(e.findProperty(&quot;hasError&quot;).getValue());
 862                 record.setIsError(hasError);
 863                 if (hasError) {
 864                     ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 865                             .getProxy().determineErrorMessageForEntity(e, record);
 866 
 867                     if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 868                         record.setErrorKey(&quot;listgrid.record.error&quot;);
 869                     }
 870                 }
 871             }
 872 
 873             if (e.findProperty(&quot;progressStatus&quot;) != null) {
 874                 ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 875                         .getProxy().determineStatusMessageForEntity(e, record);
 876                 if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 877                     record.setStatus(e.findProperty(&quot;progressStatus&quot;).getValue());
 878                     record.setStatusCssClass(&quot;listgrid.record.status&quot;);
 879                 }
 880             }
 881 
 882             if (e.findProperty(idProperty) != null) {
 883                 record.setId(e.findProperty(idProperty).getValue());
 884             }
 885 
 886             for (Field headerField : headerFields) {
 887                 Property p = e.findProperty(headerField.getName());
 888                 if (p != null) {
 889                     Field recordField = new Field().withName(headerField.getName())
 890                             .withFriendlyName(headerField.getFriendlyName())
 891                             .withOrder(p.getMetadata().getOrder());
 892 
 893                     if (headerField instanceof ComboField) {
 894                         recordField.setValue(((ComboField) headerField).getOption(p.getValue()));
 895                         recordField.setDisplayValue(p.getDisplayValue());
 896                     } else {
 897                         if (headerField.getFieldType().equals(&quot;DATE&quot;)) {
 898                             try {
<abbr title=" 899                                 Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue());"> 899                                 Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue(ðŸ”µ</abbr>
 900                                 String newValue = formatter.format(date);
 901                                 recordField.setValue(newValue);
 902                             } catch (Exception ex) {
 903                                 recordField.setValue(p.getValue());
 904                             }
 905                         } else {
 906                             recordField.setValue(p.getValue());
 907                         }
 908                         recordField.setDisplayValue(p.getDisplayValue());
 909                     }
 910 
 911                     recordField.setDerived(isDerivedField(headerField, recordField, p));
 912 
 913                     record.getFields().add(recordField);
 914                 }
 915             }
 916 
 917             if (e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY) != null) {
 918                 Field hiddenField = new Field().withName(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
<abbr title=" 919                 hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue());"> 919                 hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue()ðŸ”µ</abbr>
 920                 record.getHiddenFields().add(hiddenField);
 921             }
 922 
 923             if (e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY) != null) {
 924                 record.setAltId(e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY).getValue());
 925             }
 926 
 927             extensionManager.getProxy().modifyListGridRecord(className, record, e);
 928 
 929             listGrid.getRecords().add(record);
 930         }
 931 
 932         if (drs.getFirstId() != null) {
 933             listGrid.setFirstId(drs.getFirstId());
 934         }
 935         if (drs.getLastId() != null) {
 936             listGrid.setLastId(drs.getLastId());
 937         }
 938         if (drs.getUpperCount() != null) {
 939             listGrid.setUpperCount(drs.getUpperCount());
 940         }
 941         if (drs.getLowerCount() != null) {
 942             listGrid.setLowerCount(drs.getLowerCount());
 943         }
 944         if (drs.getFetchType() != null) {
 945             listGrid.setFetchType(drs.getFetchType().toString());
 946         }
 947         if (drs.getTotalCountLessThanPageSize() != null) {
 948             listGrid.setTotalCountLessThanPageSize(drs.getTotalCountLessThanPageSize());
 949         }
 950         if (drs.getPromptSearch() != null) {
 951             listGrid.setPromptSearch(drs.getPromptSearch());
 952         }
 953 
 954         return listGrid;
 955     }
 956 
 957     /**
<abbr title=" 958      * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasicFieldMetadata}"> 958      * Determines whether or not a particular field in a record is derived. By default this checks the {@ðŸ”µ</abbr>
 959      * for the given Property to see if something on the backend has marked it as derived
 960      *
 961      * @param headerField the header for this recordField
 962      * @param recordField the recordField being populated
 963      * @param p the property that relates to this recordField
 964      * @return whether or not this field is derived
<abbr title=" 965      * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 965      * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, StringðŸ”µ</abbr>
 966      */
 967     protected Boolean isDerivedField(Field headerField, Field recordField, Property p) {
 968         return BooleanUtils.isTrue(((BasicFieldMetadata) p.getMetadata()).getIsDerived());
 969     }
 970 
 971     protected void setEntityFormFields(ClassMetadata cmd, EntityForm ef, List&lt;Property&gt; properties) {
 972         List&lt;Field&gt; homelessFields = new ArrayList&lt;&gt;();
 973         List&lt;Field&gt; fieldsWithAssociations = new ArrayList&lt;&gt;();
 974         for (Property property : properties) {
 975             if (property.getMetadata() instanceof BasicFieldMetadata) {
 976                 BasicFieldMetadata fmd = ((BasicFieldMetadata) (property.getMetadata()));
 977                 if (!ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
<abbr title=" 978                     // Depending on visibility, field for the particular property is not created on the form"> 978                     // Depending on visibility, field for the particular property is not created on the fðŸ”µ</abbr>
<abbr title=" 979                     String fieldType = (fmd.getFieldType() == null) ? null : fmd.getFieldType().toString();"> 979                     String fieldType = (fmd.getFieldType() == null) ? null : fmd.getFieldType().toString(ðŸ”µ</abbr>
 980                     // Create the field and set some basic attributes
 981                     Field f;
<abbr title=" 982                     if (((fieldType.equals(SupportedFieldType.BROADLEAF_ENUMERATION.toString()) || fieldType.equals(SupportedFieldType.EXPLICIT_ENUMERATION.toString())) || fieldType.equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION.toString())) || fieldType.equals(SupportedFieldType.EMPTY_ENUMERATION.toString())) {"> 982                     if (((fieldType.equals(SupportedFieldType.BROADLEAF_ENUMERATION.toString()) || fieldTðŸ”µ</abbr>
<abbr title=" 983                         // We&#x27;re dealing with fields that should render as drop-downs, so set their possible values"> 983                         // We&#x27;re dealing with fields that should render as drop-downs, so set their possiðŸ”µ</abbr>
 984                         f = new ComboField();
 985                         String[][] enumerationValues = fmd.getEnumerationValues();
 986                         for (int i = 0; i &lt; enumerationValues.length; i++) {
<abbr title=" 987                             enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1]);"> 987                             enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValuðŸ”µ</abbr>
 988                         }
 989                         ((ComboField) (f)).setOptions(enumerationValues);
<abbr title=" 990                         if (((fmd.getHideEnumerationIfEmpty() != null) &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValue()) &amp;&amp; (((ComboField) (f)).getOptions().size() == 0)) {"> 990                         if (((fmd.getHideEnumerationIfEmpty() != null) &amp;&amp; fmd.getHideEnumerationIfEmpty()ðŸ”µ</abbr>
 991                             f.setIsVisible(false);
 992                         }
 993                     } else if (fieldType.equals(SupportedFieldType.CODE.toString())) {
 994                         f = new CodeField();
<abbr title=" 995                     } else if ((fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString()) || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())) || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {"> 995                     } else if ((fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString()) || fieldType.ðŸ”µ</abbr>
 996                         // We&#x27;re dealing with rule builders, so we&#x27;ll create those specialized fields
 997                         f = new RuleBuilderField();
 998                         ((RuleBuilderField) (f)).setJsonFieldName(property.getName() + &quot;Json&quot;);
 999                         ((RuleBuilderField) (f)).setDataWrapper(new DataWrapper());
1000                         ((RuleBuilderField) (f)).setFieldBuilder(fmd.getRuleIdentifier());
1001                         ((RuleBuilderField) (f)).setDisplayType(fmd.getDisplayType().toString());
1002                         String blankJsonString = &quot;{\&quot;data\&quot;:[]}&quot;;
1003                         ((RuleBuilderField) (f)).setJson(blankJsonString);
1004                         DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
1005                         if (dw != null) {
1006                             ((RuleBuilderField) (f)).setDataWrapper(dw);
1007                         }
1008                         if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())) {
1009                             ((RuleBuilderField) (f)).setRuleType(&quot;rule-builder-simple&quot;);
1010                         } else if (fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1011                             ((RuleBuilderField) (f)).setRuleType(&quot;rule-builder-with-quantity&quot;);
1012                         } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())) {
1013                             ((RuleBuilderField) (f)).setRuleType(&quot;rule-builder-simple-time&quot;);
1014                         }
1015                     } else if (LookupType.DROPDOWN.equals(fmd.getLookupType())) {
<abbr title="1016                         // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of in a">1016                         // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instðŸ”µ</abbr>
<abbr title="1017                         // modal, so we&#x27;ll provision the combo field here. Available options will be set as part of a">1017                         // modal, so we&#x27;ll provision the combo field here. Available options will be set ðŸ”µ</abbr>
1018                         // subsequent operation
1019                         f = new ComboField();
1020                     } else if (fieldType.equals(SupportedFieldType.MEDIA.toString())) {
1021                         f = new MediaField();
1022                     } else {
1023                         // Create a default field since there was no specialized handler
1024                         f = new Field();
1025                     }
1026                     Boolean required = fmd.getRequiredOverride();
1027                     if (required == null) {
1028                         required = fmd.getRequired();
1029                     }
1030                     Boolean allowNoValueEnum = fmd.getAllowNoValueEnumOption();
1031                     if (allowNoValueEnum != null) {
1032                         f.setAllowNoValueEnumOption(allowNoValueEnum);
1033                     }
<abbr title="1034                     f.withName(property.getName()).withFieldType(fieldType).withFieldComponentRenderer(getFieldComponentRenderer(fmd)).withGridFieldComponentRenderer(getGridFieldComponentRenderer(fmd)).withOrder(fmd.getOrder()).withFriendlyName(fmd.getFriendlyName()).withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty()).withForeignKeyClass(fmd.getForeignKeyClass()).withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass())).withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getInheritedFromType()).withRequired(required).withReadOnly(fmd.getReadOnly()).withTranslatable(fmd.getTranslatable()).withAlternateOrdering(((Boolean) (fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDERING)))).withLargeEntry(fmd.isLargeEntry()).withHint(fmd.getHint()).withTooltip(fmd.getTooltip()).withHelp(fmd.getHelpText()).withTypeaheadEnabled(fmd.getEnableTypeaheadLookup()).withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity()).withAssociatedFieldName(fmd.getAssociatedFieldName());">1034                     f.withName(property.getName()).withFieldType(fieldType).withFieldComponentRenderer(geðŸ”µ</abbr>
1035                     String defaultValue = fmd.getDefaultValue();
1036                     if (defaultValue != null) {
1037                         defaultValue = extractDefaultValueFromFieldData(fieldType, fmd);
1038                         f.withValue(defaultValue);
1039                     }
1040                     if (StringUtils.isBlank(f.getFriendlyName())) {
1041                         f.setFriendlyName(f.getName());
1042                     }
1043                     // If is form hidden, set visible to false
1044                     if (VisibilityEnum.FORM_EXPLICITLY_HIDDEN.equals(fmd.getVisibility())) {
1045                         f.setIsVisible(false);
1046                     }
1047                     if (VisibilityEnum.VISIBLE_ALL.equals(fmd.getVisibility())) {
1048                         f.setIsVisible(true);
1049                     }
1050                     // Add the field to the appropriate FieldGroup
1051                     if (fmd.getGroup() == null) {
1052                         homelessFields.add(f);
1053                     } else {
<abbr title="1054                         ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabOrder());">1054                         ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabðŸ”µ</abbr>
1055                     }
1056                     if (StringUtils.isNotEmpty(fmd.getAssociatedFieldName())) {
1057                         fieldsWithAssociations.add(f);
1058                     }
1059                 }
1060             }
1061         }
1062         for (Field f : homelessFields) {
1063             ef.addField(cmd, f, null, null, null, null);
1064         }
1065         for (Field f : fieldsWithAssociations) {
1066             Field associatedField = findAssociatedField(ef, f);
1067             if (associatedField != null) {
1068                 associatedField.setShouldRender(false);
1069                 f.setAssociatedFieldName(associatedField.getName());
1070             } else {
1071                 f.setAssociatedFieldName(null);
1072             }
1073         }
1074     }
1075 
1076     protected String getFieldComponentRenderer(BasicFieldMetadata fmd) {
1077         if (StringUtils.isNotBlank(fmd.getFieldComponentRendererTemplate())) {
1078             return fmd.getFieldComponentRendererTemplate();
1079         }
1080         return fmd.getFieldComponentRenderer()==null?null:fmd.getFieldComponentRenderer().toString();
1081     }
1082 
1083     protected String getGridFieldComponentRenderer(BasicFieldMetadata fmd) {
1084         if (StringUtils.isNotBlank(fmd.getGridFieldComponentRendererTemplate())) {
1085             return fmd.getGridFieldComponentRendererTemplate();
1086         }
<abbr title="1087         return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toString();">1087         return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toStrinðŸ”µ</abbr>
1088     }
1089 
1090     private Field findAssociatedField(EntityForm ef, Field f) {
1091         // Try on the parent object
1092         Field associatedField = ef.findField(f.getAssociatedFieldName());
1093 
1094         if (associatedField == null) {
1095             // Check the field&#x27;s path
1096             String[] fieldPathParts = f.getName().split(&quot;\\.&quot;);
1097             String testPath = &quot;&quot;;
1098 
1099             for (String path : fieldPathParts) {
1100                 testPath += path + &quot;.&quot;;
1101 
1102                 associatedField = ef.findField(testPath + f.getAssociatedFieldName());
1103                 if (associatedField != null) {
1104                     break;
1105                 }
1106             }
1107         }
1108         return associatedField;
1109     }
1110 
1111     /**
1112      * This method gets the {@link AdminSection} for the given foreignKeyClass parameter. If none exists,
1113      * it returns the foreignKeyClass.
1114      *
1115      * @param foreignKeyClass the {@link String} class name
1116      * @return the admin section pathname
1117      */
1118     protected String getAdminSectionPath(String foreignKeyClass) {
1119         if (foreignKeyClass != null) {
<abbr title="1120             AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyClass, null);">1120             AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(fðŸ”µ</abbr>
1121             return foreignKeySection != null ? foreignKeySection.getUrl() : foreignKeyClass;
1122         }
1123         return null;
1124     }
1125 
1126     /**
<abbr title="1127      * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal to">1127      * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} iðŸ”µ</abbr>
1128      *  the processed value of another tab.
1129      *
1130      * For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a another tab where
<abbr title="1131      *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;,">1131      *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=ExamðŸ”µ</abbr>
<abbr title="1132      *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; tabs.">1132      *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; taðŸ”µ</abbr>
1133      */
1134     protected void setEntityFormTabsAndGroups(EntityForm ef, Map&lt;String, TabMetadata&gt; tabMetadataMap) {
1135         if (tabMetadataMap != null) {
1136             Set&lt;String&gt; tabMetadataKeySet = tabMetadataMap.keySet();
1137             for (String tabKey : tabMetadataKeySet) {
1138                 TabMetadata tabMetadata = tabMetadataMap.get(tabKey);
<abbr title="1139                 String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySet);">1139                 String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySeðŸ”µ</abbr>
1140 
1141                 if (foundMatchingTab(unprocessedTabName)) {
1142                     if (!tabExists(ef, unprocessedTabName)) {
1143                         TabMetadata originalTabMetadata = tabMetadataMap.get(unprocessedTabName);
1144                         unprocessedTabName = ef.addTabFromTabMetadata(originalTabMetadata);
1145                     }
1146                 } else {
1147                     if (tabExists(ef, tabKey)) {
1148                         unprocessedTabName = tabKey;
1149                     } else {
1150                         unprocessedTabName = ef.addTabFromTabMetadata(tabMetadata);
1151                     }
1152                 }
1153 
1154                 Set&lt;String&gt; groupMetadataKeySet = tabMetadata.getGroupMetadata().keySet();
1155                 for (String groupKey : groupMetadataKeySet) {
<abbr title="1156                     ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName);">1156                     ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocesseðŸ”µ</abbr>
1157                 }
1158             }
1159         }
1160     }
1161 
1162     /**
1163      * Search for any other tab on the target entity that has the same display value
1164      *  as the value provided tab name.
1165      *
<abbr title="1166      * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message property.">1166      * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message propeðŸ”µ</abbr>
<abbr title="1167      *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySet">1167      *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetaðŸ”µ</abbr>
<abbr title="1168      *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method should return">1168      *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method shoulðŸ”µ</abbr>
1169      *  &quot;Example_Tab&quot; which will end up causing the tabs to merge together.
1170      *
<abbr title="1171      * If a tab with the same display value cannot be found, then we should return null to indicate that there">1171      * If a tab with the same display value cannot be found, then we should return null to indicate that ðŸ”µ</abbr>
1172      *  is no matching tab with the same processed tabName value.
1173      */
<abbr title="1174     protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySet) {">1174     protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySðŸ”µ</abbr>
1175         for (String tabKey : tabMetadataKeySet) {
1176             String tabName = tabMetadata.getTabName();
1177 
1178             if (processedTabKeyMatchesTabName(tabName, tabKey)) {
1179                 return tabKey;
1180             }
1181         }
1182 
1183         return null;
1184     }
1185 
1186     protected boolean processedTabKeyMatchesTabName(String tabName, String candidateTabKey) {
1187         try {
1188             String processedCandidateTabKey = BLCMessageUtils.getMessage(candidateTabKey);
<abbr title="1189             boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateTabKey);">1189             boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateðŸ”µ</abbr>
1190 
<abbr title="1191             return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidateTabKey);">1191             return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidatðŸ”µ</abbr>
1192         } catch (NoSuchMessageException e) {
1193             LOG.debug(&quot;No such message exists for &quot; + candidateTabKey, e);
1194 
1195             return false;
1196         }
1197     }
1198 
1199     protected boolean foundMatchingTab(String unprocessedTabName) {
1200         return (unprocessedTabName != null);
1201     }
1202 
1203     protected boolean tabExists(EntityForm ef, String tabKey) {
1204         return (ef.findTab(tabKey) != null);
1205     }
1206 
1207     @Override
1208     public String extractDefaultValueFromFieldData(String fieldType, BasicFieldMetadata fmd) {
1209         String defaultValue = fmd.getDefaultValue();
<abbr title="1210         if ((fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString()) || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())) || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {">1210         if ((fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString()) || fieldType.equals(SupportedFieðŸ”µ</abbr>
1211             return null;
1212         } else if (fieldType.equals(SupportedFieldType.INTEGER.toString())) {
1213             try {
<abbr title="1214                 DecimalFormat numberFormat = ((DecimalFormat) (NumberFormat.getInstance(BroadleafRequestContext.getBroadleafRequestContext().getJavaLocale())));">1214                 DecimalFormat numberFormat = ((DecimalFormat) (NumberFormat.getInstance(BroadleafRequestCðŸ”µ</abbr>
1215                 Number parse = numberFormat.parse(defaultValue);
1216             } catch (java.lang.NumberFormatException | ParseException e) {
<abbr title="1217                 String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defaultValue);">1217                 String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defauðŸ”µ</abbr>
1218                 LOG.debug(msg);
1219                 return null;
1220             }
<abbr title="1221         } else if (fieldType.equals(SupportedFieldType.DECIMAL.toString()) || fieldType.equals(SupportedFieldType.MONEY.toString())) {">1221         } else if (fieldType.equals(SupportedFieldType.DECIMAL.toString()) || fieldType.equals(SupportedFðŸ”µ</abbr>
1222             try {
<abbr title="1223                 DecimalFormat numberFormat = ((DecimalFormat) (NumberFormat.getInstance(BroadleafRequestContext.getBroadleafRequestContext().getJavaLocale())));">1223                 DecimalFormat numberFormat = ((DecimalFormat) (NumberFormat.getInstance(BroadleafRequestCðŸ”µ</abbr>
1224                 numberFormat.setParseBigDecimal(true);
1225                 Number parse = numberFormat.parse(defaultValue);
1226             } catch (java.lang.NumberFormatException | ParseException e) {
1227                 String msg = buildMsgForDefValException(fieldType.toString(), fmd, defaultValue);
1228                 LOG.debug(msg);
1229                 return null;
1230             }
1231         } else if (fieldType.equals(SupportedFieldType.BOOLEAN.toString())) {
<abbr title="1232             if ((((!defaultValue.toLowerCase().equals(&quot;true&quot;)) &amp;&amp; (!defaultValue.toLowerCase().equals(&quot;false&quot;))) &amp;&amp; (!defaultValue.toUpperCase().equals(&quot;Y&quot;))) &amp;&amp; (!defaultValue.toUpperCase().equals(&quot;N&quot;))) {">1232             if ((((!defaultValue.toLowerCase().equals(&quot;true&quot;)) &amp;&amp; (!defaultValue.toLowerCase().equals(&quot;faðŸ”µ</abbr>
<abbr title="1233                 String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defaultValue);">1233                 String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defauðŸ”µ</abbr>
1234                 LOG.debug(msg);
1235                 return null;
1236             }
1237         } else if (fieldType.equals(SupportedFieldType.DATE.toString())) {
1238             DateFormat format = FormatUtil.getDateFormat();
1239             if (defaultValue.toLowerCase().contains(&quot;today&quot;)) {
1240                 defaultValue = format.format(new Date());
1241             } else {
1242                 try {
1243                     Date date = format.parse(defaultValue);
1244                     defaultValue = format.format(date);
1245                 } catch (ParseException e) {
<abbr title="1246                     String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue);">1246                     String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaðŸ”µ</abbr>
1247                     LOG.debug(msg);
1248                     return null;
1249                 }
1250             }
1251         }
1252         return defaultValue;
1253     }
1254 
<abbr title="1255     protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue) {">1255     protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue)ðŸ”µ</abbr>
<abbr title="1256         return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - Failed to parse &quot;">1256         return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot;ðŸ”µ</abbr>
<abbr title="1257                 + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue) + &quot; ]&quot;;">1257                 + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue)ðŸ”µ</abbr>
1258     }
1259 
1260     @Override
1261     public void removeNonApplicableFields(ClassMetadata cmd, EntityForm entityForm, String entityType) {
1262         for (Property p : cmd.getProperties()) {
1263             if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entityType)) {
1264                 entityForm.removeField(p.getName());
1265             }
1266         }
1267     }
1268 
1269     @Override
1270     public EntityForm createEntityForm(ClassMetadata cmd, List&lt;SectionCrumb&gt; sectionCrumbs)
1271             throws ServiceException {
1272         EntityForm ef = createStandardEntityForm();
1273         populateEntityForm(cmd, ef, sectionCrumbs);
1274         return ef;
1275     }
1276 
1277     protected String extractSectionIdentifierFromCrumb(List&lt;SectionCrumb&gt; sectionCrumbs) {
1278         if (sectionCrumbs != null &amp;&amp; sectionCrumbs.size() &gt; 0) {
1279             return sectionCrumbs.get(0).getSectionIdentifier();
1280         } else {
1281             return null;
1282         }
1283     }
1284 
1285     @Override
1286     public void populateEntityForm(ClassMetadata cmd, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)
1287             throws ServiceException {
1288         ef.setCeilingEntityClassname(cmd.getCeilingType());
1289 
1290         String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
1291 
<abbr title="1292         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType(),">1292         AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType()ðŸ”µ</abbr>
1293                 sectionIdentifier);
1294         if (section != null) {
1295             ef.setSectionKey(section.getUrl());
1296         } else {
1297             ef.setSectionKey(cmd.getCeilingType());
1298         }
1299         ef.setSectionCrumbsImpl(sectionCrumbs);
1300 
1301         setEntityFormTabsAndGroups(ef, cmd.getTabAndGroupMetadata());
1302 
1303         setEntityFormFields(cmd, ef, Arrays.asList(cmd.getProperties()));
1304 
1305         populateDropdownToOneFields(ef, cmd);
1306 
1307         extensionManager.getProxy().modifyUnpopulatedEntityForm(ef);
1308     }
1309 
1310     /**
1311      * This method is invoked when EntityForms are created and is meant to provide a hook to add
1312      * additional entity form actions for implementors of Broadleaf. Broadleaf modules will typically
1313      * leverage {@link FormBuilderExtensionHandler#addAdditionalFormActions(EntityForm)} method.
1314      * @param ef
1315      */
1316     protected void addAdditionalFormActions(EntityForm ef) {
1317 
1318     }
1319 
1320     @Override
<abbr title="1321     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbs)">1321     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbsðŸ”µ</abbr>
1322             throws ServiceException {
1323         EntityForm ef = createStandardEntityForm();
1324         populateEntityForm(cmd, entity, ef, sectionCrumbs);
1325         addAdditionalFormActions(ef);
1326         extensionManager.getProxy().addAdditionalFormActions(ef);
1327         return ef;
1328     }
1329 
1330     @Override
<abbr title="1331     public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {">1331     public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; seðŸ”µ</abbr>
1332         // Get the empty form with appropriate fields
1333         populateEntityForm(cmd, ef, sectionCrumbs);
1334         String idProperty = adminEntityService.getIdProperty(cmd);
1335         ef.setId(entity.findProperty(idProperty).getValue());
1336         ef.setEntityType(entity.getType()[0]);
1337         populateEntityFormFieldValues(cmd, entity, ef);
1338         Property p = entity.findProperty(BasicPersistenceModule.MAIN_ENTITY_NAME_PROPERTY);
1339         if (p != null) {
1340             ef.setMainEntityName(exploitProtectionService.htmlDecode(p.getValue()));
1341         }
1342         extensionManager.getProxy().modifyPopulatedEntityForm(ef, entity);
1343     }
1344 
<abbr title="1345     protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef) {">1345     protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef)ðŸ”µ</abbr>
1346         for (Property p : cmd.getProperties()) {
1347             FieldMetadata fmd = p.getMetadata();
1348 
1349             if (shouldHideField(fmd, entity)) {
1350                 if (fmd instanceof CollectionMetadata) {
1351                     ef.removeListGrid(p.getName());
1352                 } else {
1353                     ef.removeField(p.getName());
1354                 }
1355             }
1356         }
1357     }
1358 
1359     protected boolean shouldHideField(FieldMetadata fmd, Entity entity) {
1360         if (fmd == null || fmd.getShowIfFieldEquals() == null) {
1361             return false;
1362         }
1363 
1364         for (String property : fmd.getShowIfFieldEquals().keySet()) {
1365             List&lt;String&gt; values = fmd.getShowIfFieldEquals().get(property);
1366             Property entityProp = entity.findProperty(property);
1367 
1368             if (entityProp == null || values.contains(entityProp.getValue())) {
1369                 return false;
1370             }
1371         }
1372         return true;
1373     }
1374 
1375     @Override
1376     public void populateEntityFormFieldValues(ClassMetadata cmd, Entity entity, EntityForm ef) {
1377         // Set the appropriate property values
1378         for (Property p : cmd.getProperties()) {
1379             if (p.getMetadata() instanceof BasicFieldMetadata) {
1380                 BasicFieldMetadata basicFM = ((BasicFieldMetadata) (p.getMetadata()));
1381                 Property entityProp = entity.findProperty(p.getName());
<abbr title="1382                 boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibility());">1382                 boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibiliðŸ”µ</abbr>
1383                 // always show special map fields
1384                 if (p.getName().equals(&quot;key&quot;) || p.getName().equals(&quot;priorKey&quot;)) {
1385                     explicitlyShown = true;
1386                 }
1387                 if ((entityProp == null) &amp;&amp; explicitlyShown) {
1388                     Field field = ef.findField(p.getName());
1389                     if (field != null) {
1390                         field.setValue(null);
1391                     }
<abbr title="1392                 } else if ((entityProp == null) &amp;&amp; (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType()))) {">1392                 } else if ((entityProp == null) &amp;&amp; (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.gðŸ”µ</abbr>
1393                     ef.removeField(p.getName());
1394                 } else {
1395                     Field field = ef.findField(p.getName());
1396                     if (field != null) {
1397                         if (entityProp != null) {
<abbr title="1398                             // protect against null - can happen with password confirmation fields (i.e. admin user)">1398                             // protect against null - can happen with password confirmation fields (i.e. ðŸ”µ</abbr>
1399                             field.setDirty(entityProp.getIsDirty());
1400                         }
<abbr title="1401                         if (((basicFM.getFieldType() == SupportedFieldType.RULE_SIMPLE) || (basicFM.getFieldType() == SupportedFieldType.RULE_SIMPLE_TIME)) || (basicFM.getFieldType() == SupportedFieldType.RULE_WITH_QUANTITY)) {">1401                         if (((basicFM.getFieldType() == SupportedFieldType.RULE_SIMPLE) || (basicFM.getFiðŸ”µ</abbr>
1402                             RuleBuilderField rbf = ((RuleBuilderField) (field));
1403                             if (entity.getPMap().containsKey(rbf.getJsonFieldName())) {
1404                                 String json = entity.getPMap().get(rbf.getJsonFieldName()).getValue();
1405                                 rbf.setJson(json);
1406                                 DataWrapper dw = convertJsonToDataWrapper(json);
1407                                 if (dw != null) {
1408                                     rbf.setDataWrapper(dw);
1409                                 }
1410                             }
1411                         }
1412                         if (basicFM.getFieldType() == SupportedFieldType.MEDIA) {
1413                             field.setValue(exploitProtectionService.htmlDecode(entityProp.getValue()));
1414                             field.setDisplayValue(entityProp.getDisplayValue());
1415                             MediaField mf = ((MediaField) (field));
<abbr title="1416                             Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(), MediaDto.class);">1416                             Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.gðŸ”µ</abbr>
<abbr title="1417                             mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(), type));">1417                             mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodeðŸ”µ</abbr>
<abbr title="1418                         } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1418                         } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldTyðŸ”µ</abbr>
<abbr title="1419                             field.setValue((basicFM.isLargeEntry() != null) &amp;&amp; basicFM.isLargeEntry() ? entityProp.getValue() : exploitProtectionService.htmlDecode(entityProp.getValue()));">1419                             field.setValue((basicFM.isLargeEntry() != null) &amp;&amp; basicFM.isLargeEntry() ? eðŸ”µ</abbr>
1420                             field.setDisplayValue(entityProp.getDisplayValue());
1421                         }
1422                     }
1423                 }
1424             }
1425         }
1426     }
1427 
1428     /**
1429      * When using Thymeleaf, we need to convert the JSON string back to
1430      * a DataWrapper object because Thymeleaf escapes JSON strings.
1431      * Thymeleaf uses it&#x27;s own object de-serializer
1432      * see: https://github.com/thymeleaf/thymeleaf/issues/84
1433      * see: http://forum.thymeleaf.org/Spring-Javascript-and-escaped-JSON-td4024739.html
1434      * @param json
1435      * @return DataWrapper
1436      * @throws IOException
1437      */
1438     protected DataWrapper convertJsonToDataWrapper(String json) {
1439         ObjectMapper mapper = new ObjectMapper();
1440         DataDTODeserializer dtoDeserializer = new DataDTODeserializer();
<abbr title="1441         SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null));">1441         SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, nuðŸ”µ</abbr>
1442         module.addDeserializer(DataDTO.class, dtoDeserializer);
1443         mapper.registerModule(module);
1444         try {
1445             return mapper.readValue(json, DataWrapper.class);
1446         } catch (IOException e) {
1447             throw new RuntimeException(e);
1448         }
1449     }
1450 
1451     protected void populateDropdownToOneFields(EntityForm ef, ClassMetadata cmd)
1452             throws ServiceException {
1453         for (Property p : cmd.getProperties()) {
1454             if (p.getMetadata() instanceof BasicFieldMetadata) {
1455                 BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
1456                 if (LookupType.DROPDOWN.equals(fmd.getLookupType())
1457                         &amp;&amp; !ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
1458                     // Get the records
1459                     PersistencePackageRequest toOnePpr = PersistencePackageRequest.standard()
1460                             .withCeilingEntityClassname(fmd.getForeignKeyClass());
<abbr title="1461                     Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecords();">1461                     Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecoðŸ”µ</abbr>
1462 
1463                     // Determine the id field
1464                     String idProp = null;
<abbr title="1465                     ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSet().getClassMetaData();">1465                     ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamðŸ”µ</abbr>
1466                     for (Property foreignP : foreignClassMd.getProperties()) {
1467                         if (foreignP.getMetadata() instanceof BasicFieldMetadata) {
1468                             BasicFieldMetadata foreignFmd = (BasicFieldMetadata) foreignP.getMetadata();
1469                             if (SupportedFieldType.ID.equals(foreignFmd.getFieldType())) {
1470                                 idProp = foreignP.getName();
1471                             }
1472                         }
1473                     }
1474 
1475                     if (idProp == null) {
<abbr title="1476                         throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClass());">1476                         throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeigðŸ”µ</abbr>
1477                     }
1478 
1479                     // Determine the display field
1480                     String displayProp = fmd.getLookupDisplayProperty();
1481 
1482                     // Build the options map
1483                     Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
1484                     for (Entity row : rows) {
1485                         Property prop = row.findProperty(displayProp);
1486                         if (prop == null) {
<abbr title="1487                             LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entity [&quot; +">1487                             LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + ðŸ”µ</abbr>
1488                                     ef.getCeilingEntityClassname() + &quot;]&quot;);
1489                         } else {
1490                             String displayValue = prop.getDisplayValue();
1491                             if (StringUtils.isBlank(displayValue)) {
1492                                 displayValue = prop.getValue();
1493                             }
1494                             options.put(row.findProperty(idProp).getValue(), displayValue);
1495                         }
1496                     }
1497 
1498                     // Set the options on the entity field
1499                     ComboField cf = (ComboField) ef.findField(p.getName());
1500                     cf.setOptions(options);
1501                 }
1502             }
1503         }
1504     }
1505 
1506     @Override
<abbr title="1507     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, List&lt;SectionCrumb&gt; sectionCrumbs)">1507     public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; coðŸ”µ</abbr>
1508             throws ServiceException {
1509         EntityForm ef = createStandardEntityForm();
1510         populateEntityForm(cmd, entity, collectionRecords, ef, sectionCrumbs);
1511         addAdditionalFormActions(ef);
1512         extensionManager.getProxy().addAdditionalFormActions(ef);
1513         return ef;
1514     }
1515 
1516     @Override
<abbr title="1517     public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {">1517     public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collecðŸ”µ</abbr>
1518         // Get the form with values for this entity
1519         populateEntityForm(cmd, entity, ef, sectionCrumbs);
1520         // Attach the sub-collection list grids and specialty UI support
1521         for (Property p : cmd.getProperties()) {
1522             if (p.getMetadata() instanceof BasicFieldMetadata) {
1523                 continue;
1524             }
1525             if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entity.getType()[0])) {
1526                 continue;
1527             }
1528             if ((collectionRecords != null) &amp;&amp; (!collectionRecords.isEmpty())) {
1529                 DynamicResultSet subCollectionEntities = collectionRecords.get(p.getName());
1530                 String containingEntityId = entity.getPMap().get(ef.getIdProperty()).getValue();
<abbr title="1531                 ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSectionKey(), sectionCrumbs);">1531                 ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p,ðŸ”µ</abbr>
1532                 CollectionMetadata md = ((CollectionMetadata) (p.getMetadata()));
1533                 if (md instanceof BasicCollectionMetadata) {
<abbr title="1534                     PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);">1534                     PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCruðŸ”µ</abbr>
<abbr title="1535                     ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1535                     ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResuðŸ”µ</abbr>
1536                     if (collectionCmd.getPolymorphicEntities().getChildren().length != 0) {
<abbr title="1537                         List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTrees();">1537                         List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedðŸ”µ</abbr>
1538                         ListGridActionGroup actionGroup = new ListGridActionGroup().withName(&quot;Add&quot;);
1539                         for (ClassTree entityType : entityTypes) {
<abbr title="1540                             ListGridAction ADD = new ListGridAction(ListGridAction.ADD).withButtonClass(AddMethodType.PERSIST_EMPTY == ((BasicCollectionMetadata) (md)).getAddMethodType() ? &quot;sub-list-grid-add-empty&quot; : &quot;sub-list-grid-add&quot;).withActionTargetEntity(entityType.getFullyQualifiedClassname()).withUrlPostfix(&quot;/add&quot;).withIconClass(&quot;fa fa-plus&quot;).withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyName()));">1540                             ListGridAction ADD = new ListGridAction(ListGridAction.ADD).withButtonClass(AðŸ”µ</abbr>
1541                             actionGroup.getListGridActions().add(0, ADD);
1542                         }
1543                         listGrid.addToolbarActionGroup(actionGroup);
1544                     } else {
<abbr title="1545                         listGrid.getToolbarActions().add(0, AddMethodType.PERSIST_EMPTY == ((BasicCollectionMetadata) (md)).getAddMethodType() ? DefaultListGridActions.ADD_EMPTY : DefaultListGridActions.ADD);">1545                         listGrid.getToolbarActions().add(0, AddMethodType.PERSIST_EMPTY == ((BasicCollectðŸ”µ</abbr>
1546                     }
1547                 } else {
1548                     listGrid.getToolbarActions().add(0, DefaultListGridActions.ADD);
1549                 }
1550                 if (subCollectionEntities.getUnselectedTabMetadata().get(md.getTab()) != null) {
1551                     ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), true);
1552                 } else {
1553                     ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), false);
1554                 }
1555             }
1556         }
1557         if (CollectionUtils.isEmpty(ef.getActions())) {
1558             ef.addAction(DefaultEntityFormActions.SAVE);
1559         }
1560         addDeleteActionIfAllowed(ef, cmd, entity);
1561         addDuplicateActionIfAllowed(ef, cmd);
1562         setReadOnlyState(ef, cmd, entity);
1563         // check for fields that should be hidden based on annotations
1564         setVisibilityBasedOnShowIfFieldEquals(cmd, entity, ef);
1565         extensionManager.getProxy().modifyDetailEntityForm(ef);
1566     }
1567 
1568     /**
<abbr title="1569      * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The user can">1569      * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/bðŸ”µ</abbr>
1570      * delete an entity for the following cases:
1571      * &lt;ol&gt;
<abbr title="1572      *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represented by">1572      *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represenðŸ”µ</abbr>
<abbr title="1573      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;">1573      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/lðŸ”µ</abbr>
1574      *  &lt;li&gt;The user has the security necessary to delete the given &lt;b&gt;entity&lt;/b&gt; according to the
1575      *  {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}&lt;/li&gt;
1576      * &lt;/ol&gt;
1577      *
1578      * @param entityForm the form being generated
1579      * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1580      * @param entity the entity being edited
1581      * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1582      * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1583      * @see {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}
1584      */
1585     protected void addDeleteActionIfAllowed(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1586         if (isDeletionAllowed(entityForm, cmd, entity)) {
1587             entityForm.addAction(DefaultEntityFormActions.DELETE);
1588         }
1589     }
1590 
<abbr title="1591     protected boolean isDeletionAllowed(final EntityForm entityForm, final ClassMetadata cmd, final Entity entity) {">1591     protected boolean isDeletionAllowed(final EntityForm entityForm, final ClassMetadata cmd, final EntitðŸ”µ</abbr>
1592         try {
1593             String securityEntityClassname = getSecurityClassname(entityForm, cmd);
<abbr title="1594             adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.REMOVE);">1594             adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.REMOVE)ðŸ”µ</abbr>
1595         } catch (ServiceException e) {
1596             if (e instanceof SecurityServiceException) {
1597                 return false;
1598             }
1599         }
1600         final AdminUser persistentAdminUser = adminRemoteSecurityService.getPersistentAdminUser();
<abbr title="1601         return rowLevelSecurityService.canUpdate(persistentAdminUser, entity) &amp;&amp; rowLevelSecurityService.canRemove(persistentAdminUser, entity);">1601         return rowLevelSecurityService.canUpdate(persistentAdminUser, entity) &amp;&amp; rowLevelSecurityService.ðŸ”µ</abbr>
1602     }
1603 
1604     protected void addDuplicateActionIfAllowed(final EntityForm entityForm, final ClassMetadata cmd) {
1605         if (isDuplicationAllowed(entityForm, cmd)) {
1606             entityForm.addAction(DefaultEntityFormActions.DUPLICATE);
1607         }
1608     }
1609 
1610     protected boolean isDuplicationAllowed(final EntityForm entityForm, final ClassMetadata cmd) {
1611         final String securityClassname = getSecurityClassname(entityForm, cmd);
1612         try {
1613             adminRemoteSecurityService.securityCheck(securityClassname, EntityOperationType.ADD);
1614         } catch (ServiceException e) {
1615             if (e instanceof SecurityServiceException) {
1616                 return false;
1617             }
1618         }
1619         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(securityClassname);
<abbr title="1620         return duplicator.validate(entityClass, Long.valueOf(entityForm.getId())) &amp;&amp; rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), securityClassname, cmd);">1620         return duplicator.validate(entityClass, Long.valueOf(entityForm.getId())) &amp;&amp; rowLevelSecurityServðŸ”µ</abbr>
1621     }
1622 
1623     /**
1624      * The given &lt;b&gt;entityForm&lt;/b&gt; is marked as readonly for the following cases:
1625      * &lt;ol&gt;
1626      *  &lt;li&gt;All of the properties from &lt;b&gt;cmd&lt;/b&gt; are readonly&lt;/b&gt;&lt;/li&gt;
<abbr title="1627      *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represented by">1627      *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class namðŸ”µ</abbr>
<abbr title="1628      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;">1628      *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/lðŸ”µ</abbr>
<abbr title="1629      *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to the">1629      *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to ðŸ”µ</abbr>
1630      *  {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}&lt;/li&gt;
1631      * &lt;/ol&gt;
1632      *
1633      * @param entityForm the form being generated
1634      * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1635      * @param entity the entity being edited
1636      * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1637      * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1638      * @see {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}
1639      */
1640     protected void setReadOnlyState(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1641         boolean readOnly = true;
1642 
1643         // If all of the fields are read only, we&#x27;ll mark the form as such
1644         for (Property property : cmd.getProperties()) {
1645             FieldMetadata fieldMetadata = property.getMetadata();
1646             if (fieldMetadata instanceof BasicFieldMetadata) {
<abbr title="1647                 readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieldMetadata).getReadOnly();">1647                 readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetaðŸ”µ</abbr>
1648                 if (!readOnly) {
1649                     break;
1650                 }
1651             } else {
1652                 readOnly = ((CollectionMetadata) fieldMetadata).isMutable();
1653                 if (!readOnly) {
1654                     break;
1655                 }
1656             }
1657         }
1658 
1659         if (!readOnly) {
<abbr title="1660             // If the user does not have edit permissions, we will go ahead and make the form read only to prevent confusion">1660             // If the user does not have edit permissions, we will go ahead and make the form read only tðŸ”µ</abbr>
1661             try {
1662                 String securityEntityClassname = getSecurityClassname(entityForm, cmd);
<abbr title="1663                 adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDATE);">1663                 adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDðŸ”µ</abbr>
1664             } catch (ServiceException e) {
1665                 if (e instanceof SecurityServiceException) {
1666                     readOnly = true;
1667                 }
1668             }
1669         }
1670 
<abbr title="1671         // if the normal admin security service has not deemed this readonly and the all of the properties on the entity">1671         // if the normal admin security service has not deemed this readonly and the all of the propertieðŸ”µ</abbr>
1672         // are not readonly, then check the row-level security
1673         if (!readOnly) {
<abbr title="1674             readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1674             readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUsðŸ”µ</abbr>
1675         }
1676 
1677         if (readOnly) {
1678             entityForm.setReadOnly();
<abbr title="1679             //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface">1679             //If someone has replaced RowLevelSecurityService, check here to make sure the replacement imðŸ”µ</abbr>
1680             if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title="1681                 EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();">1681                 EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLeveðŸ”µ</abbr>
<abbr title="1682                 for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {">1682                 for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguðŸ”µ</abbr>
1683                     for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
1684                         if (modifier.isQualified(data.getModifierType())) {
1685                             modifier.modifyEntityForm(new EntityFormModifierRequest()
1686                                     .withEntityForm(entityForm)
1687                                     .withConfiguration(data)
1688                                     .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
1689                                     .withEntity(entity)
1690                                     .withRowLevelSecurityService(rowLevelSecurityService));
1691                         }
1692                     }
1693                 }
1694             }
1695         }
1696     }
1697 
1698     /**
1699      * Obtains the class name suitable for passing along to the {@link SecurityVerifier}
1700      * @param entityForm
1701      * @param cmd
1702      * @return
1703      */
1704     protected String getSecurityClassname(EntityForm entityForm, ClassMetadata cmd) {
1705         String securityEntityClassname = entityForm.getCeilingEntityClassname();
1706 
1707         if (!StringUtils.isEmpty(cmd.getSecurityCeilingType())) {
1708             securityEntityClassname = cmd.getSecurityCeilingType();
1709         } else {
1710             if (entityForm.getDynamicFormInfos() != null) {
1711                 for (DynamicEntityFormInfo info : entityForm.getDynamicFormInfos().values()) {
1712                     if (!StringUtils.isEmpty(info.getSecurityCeilingClassName())) {
1713                         securityEntityClassname = info.getSecurityCeilingClassName();
1714                         break;
1715                     }
1716                 }
1717             }
1718         }
1719 
1720         return securityEntityClassname;
1721     }
1722 
1723     @Override
1724     public void populateEntityFormFields(EntityForm ef, Entity entity) {
1725         populateEntityFormFields(ef, entity, true, true);
1726     }
1727 
1728     @Override
<abbr title="1729     public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean populateId) {">1729     public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean popuðŸ”µ</abbr>
1730         if (populateId) {
1731             ef.setId(entity.findProperty(ef.getIdProperty()).getValue());
1732         }
1733         if (populateType) {
1734             ef.setEntityType(entity.getType()[0]);
1735         }
1736 
1737         for (Entry&lt;String, Field&gt; entry : ef.getFields().entrySet()) {
1738             Property entityProp = entity.findProperty(entry.getKey());
1739             if (entityProp != null) {
1740                 entry.getValue().setValue(entityProp.getValue());
1741                 entry.getValue().setDisplayValue(entityProp.getDisplayValue());
1742             }
1743         }
1744     }
1745 
1746     @Override
<abbr title="1747     public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedList) {">1747     public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedLiðŸ”µ</abbr>
<abbr title="1748         Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());">1748         Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdPropeðŸ”µ</abbr>
1749         Property entityProp = entity.findProperty(ef.getIdProperty());
1750         field.setValue(entityProp.getValue());
1751 
1752         if (StringUtils.isNotBlank(adornedList.getSortField())) {
1753             field = ef.findField(adornedList.getSortField());
1754             entityProp = entity.findProperty(adornedList.getSortField());
1755             if (field != null &amp;&amp; entityProp != null) {
1756                 field.setValue(entityProp.getValue());
1757             }
1758         }
1759     }
1760 
1761     @Override
1762     public void populateMapEntityFormFields(EntityForm ef, Entity entity) {
1763         Field field = ef.findField(&quot;priorKey&quot;);
1764         Property entityProp = entity.findProperty(&quot;key&quot;);
1765         if (field != null &amp;&amp; entityProp != null) {
1766             field.setValue(entityProp.getValue());
1767         }
1768     }
1769 
1770     @Override
<abbr title="1771     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1771     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList aðŸ”µ</abbr>
<abbr title="1772             String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1772             String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdðŸ”µ</abbr>
1773             throws ServiceException {
1774         EntityForm ef = createStandardAdornedEntityForm();
<abbr title="1775         return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAdd);">1775         return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrðŸ”µ</abbr>
1776     }
1777 
1778     @Override
<abbr title="1779     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1779     public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList aðŸ”µ</abbr>
<abbr title="1780             String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1780             String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbðŸ”µ</abbr>
1781             throws ServiceException {
1782         ef.setEntityType(adornedList.getAdornedTargetEntityClassname());
1783 
1784         // Get the metadata for this adorned field
1785         PersistencePackageRequest request = PersistencePackageRequest.adorned()
1786                 .withCeilingEntityClassname(adornedMd.getCollectionCeilingEntity())
1787                 .withAdornedList(adornedList)
1788                 .withSectionCrumbs(sectionCrumbs);
1789         request.setAddOperationInspect(isAdd);
<abbr title="1790         ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getClassMetaData();">1790         ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSðŸ”µ</abbr>
1791 
1792         List&lt;Property&gt; entityFormProperties = new ArrayList&lt;&gt;();
1793         if (isViewCollectionItem) {
1794             Collections.addAll(entityFormProperties, collectionMetadata.getProperties());
1795         } else {
1796             // We want our entity form to only render the maintained adorned target fields
1797             for (String targetFieldName : adornedMd.getMaintainedAdornedTargetFields()) {
1798                 Property p = collectionMetadata.getPMap().get(targetFieldName);
<abbr title="1799                 if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExcluded())) {">1799                 if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadatðŸ”µ</abbr>
1800                     ((BasicFieldMetadata) p.getMetadata()).setVisibility(VisibilityEnum.VISIBLE_ALL);
1801                     entityFormProperties.add(p);
1802                 }
1803             }
1804         }
1805 
1806         // Set the maintained fields on the form
1807         setEntityFormFields(collectionMetadata, ef, entityFormProperties);
1808 
1809         // Add these two additional hidden fields that are required for persistence
1810         Field f = new Field()
1811                 .withName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty())
1812                 .withFieldType(SupportedFieldType.HIDDEN.toString())
1813                 .withValue(parentId);
1814         ef.addHiddenField(collectionMetadata, f);
1815 
1816         f = new Field()
1817                 .withName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty())
1818                 .withFieldType(SupportedFieldType.HIDDEN.toString())
1819                 .withIdOverride(&quot;adornedTargetIdProperty&quot;);
1820         ef.addHiddenField(collectionMetadata, f);
1821 
1822         if (StringUtils.isNotBlank(adornedList.getSortField())) {
1823             f = new Field()
1824                     .withName(adornedList.getSortField())
1825                     .withFieldType(SupportedFieldType.HIDDEN.toString());
1826             ef.addHiddenField(collectionMetadata, f);
1827         }
1828 
1829         ef.setParentId(parentId);
1830 
1831         extensionManager.getProxy().addAdditionalAdornedFormActions(ef);
1832 
1833         return ef;
1834     }
1835 
1836     @Override
<abbr title="1837     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId)">1837     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd,ðŸ”µ</abbr>
1838             throws ServiceException {
1839         EntityForm ef = createStandardEntityForm();
1840         return buildMapForm(mapMd, mapStructure, cmd, parentId, ef);
1841     }
1842 
1843     @Override
<abbr title="1844     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId, EntityForm ef)">1844     public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd,ðŸ”µ</abbr>
1845             throws ServiceException {
1846         ForeignKey foreignKey = (ForeignKey) mapMd.getPersistencePerspective()
1847                 .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY);
1848         ef.setEntityType(foreignKey.getForeignKeyClass());
1849 
1850         Field keyField;
1851         if (!mapMd.getForceFreeFormKeys()) {
1852             // We will use a combo field to render the key choices
1853             ComboField temp = new ComboField();
1854             temp.withName(&quot;key&quot;)
1855                     .withFieldType(&quot;combo_field&quot;)
1856                     .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1857             if (mapMd.getKeys() != null) {
1858                 // The keys can be explicitly set in the annotation...
1859                 temp.setOptions(mapMd.getKeys());
1860             } else {
1861                 // Or they could be based on a different entity
1862                 PersistencePackageRequest ppr = PersistencePackageRequest.standard()
1863                         .withCeilingEntityClassname(mapMd.getMapKeyOptionEntityClass());
1864 
1865                 DynamicResultSet drs = adminEntityService.getRecords(ppr).getDynamicResultSet();
1866 
1867                 for (Entity entity : drs.getRecords()) {
<abbr title="1868                     String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getValue();">1868                     String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getVaðŸ”µ</abbr>
<abbr title="1869                     String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getValue();">1869                     String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayFieldðŸ”µ</abbr>
1870                     temp.putOption(keyValue, keyDisplayValue);
1871                 }
1872             }
1873             keyField = temp;
1874         } else {
1875             keyField = new Field().withName(&quot;key&quot;)
1876                                 .withFieldType(SupportedFieldType.STRING.toString())
1877                                 .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1878         }
1879         keyField.setRequired(true);
1880         ef.addMapKeyField(cmd, keyField);
1881 
1882         // Set the fields for this form
1883         List&lt;Property&gt; mapFormProperties;
1884         if (mapMd.isSimpleValue()) {
1885             ef.setIdProperty(&quot;key&quot;);
1886             mapFormProperties = new ArrayList&lt;&gt;();
1887             Property valueProp = cmd.getPMap().get(&quot;value&quot;);
1888             mapFormProperties.add(valueProp);
1889         } else {
1890             String valueClassName = mapStructure.getValueClassName();
1891             List&lt;String&gt; classNames = getValueClassNames(valueClassName);
1892 
1893             mapFormProperties = new ArrayList&lt;&gt;(Arrays.asList(cmd.getProperties()));
1894             filterMapFormProperties(mapFormProperties, classNames);
1895         }
1896 
1897         setEntityFormFields(cmd, ef, mapFormProperties);
1898 
1899         Field f = new Field()
1900                 .withName(&quot;priorKey&quot;)
1901                 .withFieldType(SupportedFieldType.HIDDEN.toString());
1902         ef.addHiddenField(cmd, f);
1903 
1904         ef.setParentId(parentId);
1905 
1906         return ef;
1907     }
1908 
1909     protected List&lt;String&gt; getValueClassNames(String valueClassName) {
1910         PersistenceManager pm = PersistenceManagerFactory.getPersistenceManager(valueClassName);
1911         List&lt;String&gt; classNames = new ArrayList&lt;&gt;();
1912         try {
1913             Class&lt;?&gt;[] mapEntities = pm.getPolymorphicEntities(valueClassName);
1914             for (Class clazz : mapEntities) {
1915                 classNames.add(clazz.getName());
1916             }
1917         } catch (ClassNotFoundException e) {
1918             classNames.add(valueClassName);
1919         }
1920         return classNames;
1921     }
1922 
<abbr title="1923     protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNames) {">1923     protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNameðŸ”µ</abbr>
1924         CollectionUtils.filter(mapFormProperties, new Predicate() {
1925             @Override
1926             public boolean evaluate(Object object) {
1927                 Property p = (Property) object;
1928                 for (String availType : p.getMetadata().getAvailableToTypes()) {
1929                     if (classNames.contains(availType)) {
1930                         return true;
1931                     }
1932                 }
1933                 return false;
1934             }
1935         });
1936     }
1937 
1938     protected EntityForm createStandardEntityForm() {
1939         EntityForm ef = new EntityForm();
1940         ef.addAction(DefaultEntityFormActions.SAVE);
1941         return ef;
1942     }
1943 
1944     protected EntityForm createStandardAdornedEntityForm() {
1945         EntityForm ef = new EntityForm();
1946         ef.addAction(DefaultAdornedEntityFormActions.Add);
1947         return ef;
1948     }
1949 
1950     protected VisibilityEnum[] getGridHiddenVisibilities() {
1951         return FormBuilderServiceImpl.GRID_HIDDEN_VISIBILITIES;
1952     }
1953 
1954     protected VisibilityEnum[] getFormHiddenVisibilities() {
1955         return FormBuilderServiceImpl.FORM_HIDDEN_VISIBILITIES;
1956     }
1957 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.web.service;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.Predicate;
  22  import org.apache.commons.lang.ArrayUtils;
  23  import org.apache.commons.lang.BooleanUtils;
  24  import org.apache.commons.lang3.StringUtils;
  25  import org.apache.commons.logging.Log;
  26  import org.apache.commons.logging.LogFactory;
  27  import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  28  import org.broadleafcommerce.common.exception.ExceptionHelper;
  29  import org.broadleafcommerce.common.exception.SecurityServiceException;
  30  import org.broadleafcommerce.common.exception.ServiceException;
  31  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  32  import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  33  import org.broadleafcommerce.common.i18n.service.TranslationService;
  34  import org.broadleafcommerce.common.locale.service.LocaleService;
  35  import org.broadleafcommerce.common.media.domain.MediaDto;
  36  import org.broadleafcommerce.common.persistence.EntityConfiguration;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  37 +import org.broadleafcommerce.common.persistence.EntityDuplicator;</span>
  38  import org.broadleafcommerce.common.presentation.client.AddMethodType;
  39  import org.broadleafcommerce.common.presentation.client.AdornedTargetAddMethodType;
  40  import org.broadleafcommerce.common.presentation.client.LookupType;
  41  import org.broadleafcommerce.common.presentation.client.PersistencePerspectiveItemType;
  42  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  43  import org.broadleafcommerce.common.presentation.client.VisibilityEnum;

  44  import org.broadleafcommerce.common.util.BLCMessageUtils;
  45  import org.broadleafcommerce.common.util.FormatUtil;
  46  import org.broadleafcommerce.common.util.StringUtil;
  47  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  48  import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  49  import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  50  import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  51  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  52  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  53  import org.broadleafcommerce.openadmin.dto.ClassTree;
  54  import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  55  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  56  import org.broadleafcommerce.openadmin.dto.Entity;
  57  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  58  import org.broadleafcommerce.openadmin.dto.ForeignKey;
  59  import org.broadleafcommerce.openadmin.dto.MapMetadata;
  60  import org.broadleafcommerce.openadmin.dto.MapStructure;
  61  import org.broadleafcommerce.openadmin.dto.Property;
  62  import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  63  import org.broadleafcommerce.openadmin.dto.TabMetadata;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  64 +import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;</span>
  65  import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  66  import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  67  import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  68  import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  69  import org.broadleafcommerce.openadmin.server.security.remote.SecurityVerifier;
  70  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifier;
  71  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierConfiguration;
  72  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierData;
  73  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierDataPoint;
  74  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierRequest;
  75  import org.broadleafcommerce.openadmin.server.security.service.ExceptionAwareRowLevelSecurityProvider;
  76  import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  77  import org.broadleafcommerce.openadmin.server.security.service.navigation.AdminNavigationService;
  78  import org.broadleafcommerce.openadmin.server.service.AdminEntityService;
  79  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManager;
  80  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  81  import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  82  import org.broadleafcommerce.openadmin.server.service.persistence.module.FieldManager;
  83  import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  84  import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  85  import org.broadleafcommerce.openadmin.web.form.component.ListGridAction;
  86  import org.broadleafcommerce.openadmin.web.form.component.ListGridActionGroup;
  87  import org.broadleafcommerce.openadmin.web.form.component.ListGridRecord;
  88  import org.broadleafcommerce.openadmin.web.form.component.MediaField;
  89  import org.broadleafcommerce.openadmin.web.form.component.RuleBuilderField;
  90  import org.broadleafcommerce.openadmin.web.form.entity.CodeField;
  91  import org.broadleafcommerce.openadmin.web.form.entity.ComboField;
  92  import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  93  import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  94  import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  95  import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  96  import org.broadleafcommerce.openadmin.web.form.entity.Field;
  97  import org.broadleafcommerce.openadmin.web.rulebuilder.DataDTODeserializer;
  98  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataDTO;
  99  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataWrapper;
 100  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldDTO;
 101  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldWrapper;
 102  import org.codehaus.jettison.json.JSONObject;
 103  import org.springframework.beans.factory.annotation.Value;
 104  import org.springframework.context.MessageSource;
 105  import org.springframework.context.NoSuchMessageException;
 106  import org.springframework.stereotype.Service;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +</span>
 108  import com.fasterxml.jackson.core.Version;
 109  import com.fasterxml.jackson.databind.ObjectMapper;
 110  import com.fasterxml.jackson.databind.module.SimpleModule;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +</span>
 112  import java.io.IOException;
 113  import java.math.BigDecimal;
 114  import java.text.DateFormat;
 115  import java.text.DateFormatSymbols;


 116  import java.text.ParseException;
 117  import java.text.SimpleDateFormat;
 118  import java.util.ArrayList;
 119  import java.util.Arrays;
 120  import java.util.Collections;
 121  import java.util.Date;
 122  import java.util.HashMap;
 123  import java.util.List;
 124  import java.util.Locale;
 125  import java.util.Map;
 126  import java.util.Map.Entry;
 127  import java.util.Set;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +</span>
 129  import javax.annotation.Resource;
 130  import javax.persistence.ManyToOne;
 131  import javax.persistence.OneToOne;
 132  import javax.servlet.http.HttpServletRequest;
 133  
 134  
 135  /**
 136   * @author Andre Azzolini (apazzolini)
 137   */
 138  @Service(&quot;blFormBuilderService&quot;)
 139  public class FormBuilderServiceImpl implements FormBuilderService {
 140  
 141      private static final Log LOG = LogFactory.getLog(FormBuilderServiceImpl.class);
 142  
 143      public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 144  
 145      @Resource(name = &quot;blAdminEntityService&quot;)
 146      protected AdminEntityService adminEntityService;
 147  
 148      @Resource (name = &quot;blAdminNavigationService&quot;)
 149      protected AdminNavigationService navigationService;
 150  
 151      @Resource(name = &quot;blFormBuilderExtensionManager&quot;)
 152      protected FormBuilderExtensionManager extensionManager;
 153  
 154      @Resource(name=&quot;blEntityConfiguration&quot;)
 155      protected EntityConfiguration entityConfiguration;
 156  
 157      @Resource(name=&quot;blAdminSecurityRemoteService&quot;)
 158      protected SecurityVerifier adminRemoteSecurityService;
 159  
 160      @Resource(name = &quot;blRowLevelSecurityService&quot;)
 161      protected RowLevelSecurityService rowLevelSecurityService;
 162  
 163      @Resource(name = &quot;blMediaBuilderService&quot;)
 164      protected MediaBuilderService mediaBuilderService;
 165  
 166      @Resource(name = &quot;blListGridErrorMessageExtensionManager&quot;)
 167      protected ListGridErrorMessageExtensionManager listGridErrorExtensionManager;
 168  
 169      @Resource(name = &quot;blAdminNavigationService&quot;)
 170      protected AdminNavigationService adminNavigationService;
 171  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +    @Resource(name = &quot;blEntityDuplicator&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +    protected EntityDuplicator duplicator;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +    @Resource(name = &quot;blDynamicEntityDao&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +    protected DynamicEntityDao dynamicEntityDao;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +</span>
 178      @Resource(name = &quot;blLocaleService&quot;)
 179      protected LocaleService localeService;
 180  
 181      @Resource(name = &quot;blTranslationService&quot;)
 182      protected TranslationService translationService;
 183  
 184      @Value(&quot;${use.translation.search:false}&quot;)
 185      protected boolean useTranslationSearch;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +</span>
 187  



 188      protected static final VisibilityEnum[] FORM_HIDDEN_VISIBILITIES = new VisibilityEnum[] {
 189              VisibilityEnum.HIDDEN_ALL, VisibilityEnum.FORM_HIDDEN
 190      };
 191  
 192      protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[] {
 193              VisibilityEnum.HIDDEN_ALL, VisibilityEnum.GRID_HIDDEN
 194      };
 195  
 196      @Override
<abbr title=" 197      public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)"> 197      public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumðŸ”µ</abbr>
 198              throws ServiceException {
 199  
 200          List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 201          ListGrid.Type type = ListGrid.Type.MAIN;
 202          String idProperty = &quot;id&quot;;
 203  
 204          FieldWrapper wrapper = new FieldWrapper();
 205          ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 206          for (Property p : cmd.getProperties()) {
 207              if (p.getMetadata() instanceof BasicFieldMetadata) {
 208                  BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
 209  
 210                  if (SupportedFieldType.ID.equals(fmd.getFieldType())) {
 211                      idProperty = fmd.getName();
 212                  }
 213  
 214                  if (fmd.isProminent() != null &amp;&amp; fmd.isProminent()
 215                          &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), fmd.getVisibility())) {
 216                      Field hf = createHeaderField(p, fmd);
 217                      headerFields.add(hf);
 218                      defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, fmd));
 219                  }
 220  
 221                  if (fmd.getIsFilter() != null &amp;&amp; fmd.getIsFilter()) {
 222                      wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmd));
 223                  }
 224              }
 225          }
 226  
 227          if (useTranslationSearch) {
 228              getTranslationSearchField(cmd.getCeilingType(), defaultWrapperFields);
 229          }
 230  
<abbr title=" 231          ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idProperty, sectionCrumbs);"> 231          ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idPropertðŸ”µ</abbr>
 232  
 233          if (CollectionUtils.isNotEmpty(listGrid.getHeaderFields())) {
 234              // Set the first column to be able to link to the main entity
 235              listGrid.getHeaderFields().iterator().next().setMainEntityLink(true);
 236          } else {
<abbr title=" 237              String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType();"> 237              String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType(ðŸ”µ</abbr>
 238              message += &quot;Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 239              LOG.error(message);
 240          }
 241  
 242          Date c = new Date();
 243          String friendlyName = &quot;listGrid&quot; + c.getTime();
 244          // Set up the filter builder params
 245          listGrid.setJsonFieldName(friendlyName + &quot;Json&quot;);
 246          listGrid.setFriendlyName(friendlyName);
 247          listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 248          if (CollectionUtils.isEmpty(wrapper.getFields())) {
 249              wrapper.setFields(defaultWrapperFields);
 250          }
 251          listGrid.setFieldWrapper(wrapper);
 252          listGrid.setHideFriendlyName(true);
 253  
 254          String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 255          listGrid.setJson(blankJsonString);
 256          DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 257          if (dw != null) {
 258              listGrid.setDataWrapper(dw);
 259          }
 260  
 261          listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 262          listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 263  
 264          extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 265  
 266          return listGrid;
 267      }
 268  
 269      private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFields) {
 270  
 271          TranslatedEntity translatedEntity;
 272  
 273          try {
 274              translatedEntity = translationService.getAssignableEntityType(ceilingEntity);
 275  
 276              FieldDTO localeField = new FieldDTO();
 277              localeField.setId(&quot;translationLocale&quot;);
 278              localeField.setLabel(&quot;Translation locale&quot;);
 279              localeField.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 280              localeField.setInput(&quot;select&quot;);
 281              localeField.setType(&quot;string&quot;);
 282  
 283              List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocales();
 284  
 285              Map&lt;String, String&gt; localeMap = new HashMap&lt;String, String&gt;();
 286              for (org.broadleafcommerce.common.locale.domain.Locale l : locales) {
 287                  localeMap.put(l.getLocaleCode(), l.getFriendlyName());
 288              }
 289              localeField.setValues((new JSONObject(localeMap)).toString());
 290  
 291              defaultWrapperFields.add(localeField);
 292          } catch (Exception e) {
 293              translatedEntity = null;
 294          }
 295      }
 296  
 297      protected FieldDTO constructFieldDTOFromFieldData(Field field, BasicFieldMetadata fmd) {
 298          FieldDTO fieldDTO = new FieldDTO();
 299          //translate the label to display
 300          String label = field.getFriendlyName();
 301          BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 302          MessageSource messages = context.getMessageSource();
 303          if (messages != null) {
 304              label = messages.getMessage(label, null, label, context.getJavaLocale());
 305          }
 306          fieldDTO.setLabel(label);
 307  
 308          fieldDTO.setId(field.getName());
 309          if (field.getFieldType().equals(&quot;STRING&quot;)) {
 310              fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 311          } else if (field.getFieldType().equals(&quot;DATE&quot;)) {
 312              fieldDTO.setOperators(&quot;blcFilterOperators_Date&quot;);
<abbr title=" 313          } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldType().equals(&quot;DECIMAL&quot;)) {"> 313          } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldðŸ”µ</abbr>
 314              fieldDTO.setOperators(&quot;blcFilterOperators_Numeric&quot;);
 315          } else if (field.getFieldType().equals(&quot;BOOLEAN&quot;)) {
 316              fieldDTO.setOperators(&quot;blcFilterOperators_Boolean&quot;);
 317          } else if (field.getFieldType().equals(&quot;BROADLEAF_ENUMERATION&quot;)) {
 318              fieldDTO.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 319              fieldDTO.setInput(&quot;select&quot;);
 320              fieldDTO.setType(&quot;string&quot;);
 321              String[][] enumerationValues = fmd.getEnumerationValues ();






 322              Map&lt;String, String&gt; enumMap = new HashMap&lt;&gt;();
 323              for (int i = 0; i &lt; enumerationValues.length; i++) {
 324                  enumMap.put(enumerationValues[i][0], enumerationValues[i][1]);
 325              }
 326  
 327              fieldDTO.setValues(new JSONObject(enumMap).toString());
 328          } else if (field.getFieldType().equals(&quot;ADDITIONAL_FOREIGN_KEY&quot;)) {
 329              fieldDTO.setOperators(&quot;blcFilterOperators_Selectize&quot;);
 330              fieldDTO.setType(&quot;string&quot;);
 331  
<abbr title=" 332              AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClass(), null);"> 332              AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClaðŸ”µ</abbr>
 333              if (section != null) {
 334                  String sectionKey = section.getUrl().substring(1);
 335                  fieldDTO.setSelectizeSectionKey(sectionKey);
 336              } else {
 337                  fieldDTO.setSelectizeSectionKey(fmd.getForeignKeyClass());
 338              }
 339          } else {
 340              fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 341          }
 342  
 343          return fieldDTO;
 344      }
 345  
 346      protected Field createHeaderField(Property p, BasicFieldMetadata fmd) {
 347          Field hf;
 348          if (fmd.getFieldType().equals(SupportedFieldType.EXPLICIT_ENUMERATION) ||
 349                  fmd.getFieldType().equals(SupportedFieldType.BROADLEAF_ENUMERATION) ||
 350                  fmd.getFieldType().equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION) ||
 351                  fmd.getFieldType().equals(SupportedFieldType.EMPTY_ENUMERATION)) {
 352              hf = new ComboField();
 353              ((ComboField) hf).setOptions(fmd.getEnumerationValues());





 354          } else {
 355              hf = new Field();
 356          }
 357  
 358          hf.withName(p.getName())
 359            .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getName())
 360            .withOrder(fmd.getGridOrder())
 361            .withColumnWidth(fmd.getColumnWidth())
 362            .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
 363            .withForeignKeyClass(fmd.getForeignKeyClass())
 364            .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
 365            .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClass())
 366            .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity());
 367          String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 368          hf.setFieldType(fieldType);
 369  
 370          return hf;
 371      }
 372  
 373      @Override
 374      public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property field,
 375              String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 376              throws ServiceException {
 377          FieldMetadata fmd = field.getMetadata();
 378          // Get the class metadata for this particular field
 379          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 380          if (field != null) {
 381              ppr.setSectionEntityField(field.getName());
 382          }
 383          ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 384  
 385          List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 386          ListGrid.Type type = null;
 387          boolean editable = false;
 388          boolean sortable = false;
 389          boolean readOnly = false;
 390          boolean hideIdColumn = false;
 391          boolean canFilterAndSort = true;
 392          boolean modalSingleSelectable = false;
 393          boolean modalMultiSelectable = false;
 394          boolean selectize = false;
 395          boolean isMedia = false;
 396          boolean isLookup = false;
 397          String sortProperty = null;
 398          FieldWrapper wrapper = new FieldWrapper();
 399          ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 400  
 401  
 402          String idProperty = &quot;id&quot;;
 403          for (Property property : cmd.getProperties()) {
 404              if (property.getMetadata() instanceof BasicFieldMetadata &amp;&amp;
 405                      SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;&amp;
 406                      //make sure it&#x27;s a property for this entity - not an association
 407                      !property.getName().contains(&quot;.&quot;)) {
 408                  idProperty = property.getName();
 409                  break;
 410              }
 411          }
 412          // Get the header fields for this list grid. Note that the header fields are different depending on the
 413          // kind of field this is.
 414          if (fmd instanceof BasicFieldMetadata) {
 415              readOnly = ((BasicFieldMetadata) fmd).getReadOnly();
 416              modalSingleSelectable = true;
 417              for (Property p : cmd.getProperties()) {
 418                  if (p.getMetadata() instanceof BasicFieldMetadata) {
 419                      BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 420  
 421                      if (SupportedFieldType.ID.equals(md.getFieldType())) {
 422                          idProperty = md.getName();
 423                      }
 424  
 425                      if (md.isProminent() != null &amp;&amp; md.isProminent()
 426                              &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 427                          Field hf = createHeaderField(p, md);
 428                          headerFields.add(hf);
 429                          defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 430                      }
 431  
 432                      if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 433                          Field f = createHeaderField(p, md);
 434                          wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 435                      }
 436                  }
 437              }
 438  
 439              type = ListGrid.Type.TO_ONE;
 440          } else if (fmd instanceof BasicCollectionMetadata) {
 441              BasicCollectionMetadata bcm = (BasicCollectionMetadata) fmd;
 442              readOnly = !bcm.isMutable();
 443  
 444              if(AddMethodType.LOOKUP.equals(bcm.getAddMethodType())) {
 445                  isLookup = true;
 446              }
 447  
 448              if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 449                  Property p = cmd.getPMap().get(bcm.getSelectizeVisibleField());
 450                  if (p != null) {
 451                      BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 452  
 453                      Field hf = createHeaderField(p, md);
 454                      headerFields.add(hf);
 455                      wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 456                  }
 457              } else {
 458                  for (Property p : cmd.getProperties()) {
 459                      if (p.getMetadata() instanceof BasicFieldMetadata) {
 460                          BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 461                          if (md.isProminent() != null &amp;&amp; md.isProminent()
 462                                  &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 463                              Field hf = createHeaderField(p, md);
 464                              headerFields.add(hf);
 465                              defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 466                          }
 467  
 468                          if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 469                              Field f = createHeaderField(p, md);
 470                              wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 471                          }
 472                      }
 473                  }
 474              }
 475  
 476              type = ListGrid.Type.BASIC;
 477  
<abbr title=" 478              if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getAddMethodType())) {"> 478              if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getðŸ”µ</abbr>
 479                  editable = true;
 480              } else if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 481                  selectize = true;
 482                  modalSingleSelectable = true;
 483              } else {
 484                  modalSingleSelectable = true;
 485              }
 486              sortable = StringUtils.isNotBlank(bcm.getSortProperty());
 487              if (sortable) {
 488                  sortProperty = bcm.getSortProperty();
 489              }
 490          } else if (fmd instanceof AdornedTargetCollectionMetadata) {
 491              modalSingleSelectable = true;
 492              readOnly = !((AdornedTargetCollectionMetadata) fmd).isMutable();
 493              AdornedTargetCollectionMetadata atcmd = (AdornedTargetCollectionMetadata) fmd;
 494  
 495              if(AdornedTargetAddMethodType.LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 496                  isLookup = true;
 497              }
 498  
 499              if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 500                  selectize = true;
 501  
 502                  Property p = cmd.getPMap().get(atcmd.getSelectizeVisibleField());
 503                  if (p != null) {
 504                      BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 505  
 506                      Field hf = createHeaderField(p, md);
 507                      headerFields.add(hf);
 508                      wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 509                  }
 510              } else {
 511                  for (String fieldName : atcmd.getGridVisibleFields()) {
 512                      Property p = cmd.getPMap().get(fieldName);
 513                      if (p != null) {
 514                          BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 515  
 516                          Field hf = createHeaderField(p, md);
 517                          headerFields.add(hf);
 518                          wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 519                      }
 520  
 521                  }
 522              }
 523  
 524              type = ListGrid.Type.ADORNED;
 525  
 526              if (atcmd.getMaintainedAdornedTargetFields().length &gt; 0) {
 527                  editable = true;
 528              }
 529  
 530              AdornedTargetList adornedList = (AdornedTargetList) atcmd.getPersistencePerspective()
 531                      .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);
 532              sortable = StringUtils.isNotBlank(adornedList.getSortField());
 533              if (sortable) {
 534                  sortProperty = adornedList.getSortField();
 535              }
 536          } else if (fmd instanceof MapMetadata) {
 537              readOnly = !((MapMetadata) fmd).isMutable();
 538              MapMetadata mmd = (MapMetadata) fmd;
 539  
 540              Property p2 = cmd.getPMap().get(&quot;key&quot;);
 541              BasicFieldMetadata keyMd = (BasicFieldMetadata) p2.getMetadata();
 542              keyMd.setFriendlyName(getMapKeyFriendlyName(p2));
 543              Field hf = createHeaderField(p2, keyMd);
 544              headerFields.add(hf);
 545              wrapper.getFields().add(constructFieldDTOFromFieldData(hf, keyMd));
 546  
 547              if (mmd.isSimpleValue()) {
 548                  Property valueProperty = cmd.getPMap().get(&quot;value&quot;);
 549                  BasicFieldMetadata valueMd = (BasicFieldMetadata) valueProperty.getMetadata();
 550                  valueMd.setFriendlyName(&quot;Value&quot;);
 551                  hf = createHeaderField(valueProperty, valueMd);
 552                  headerFields.add(hf);
 553                  wrapper.getFields().add(constructFieldDTOFromFieldData(hf, valueMd));
 554  
 555                  idProperty = &quot;key&quot;;
 556                  hideIdColumn = true;
 557              } else {
 558                  for (Property p : cmd.getProperties()) {
 559                      if (p.getMetadata() instanceof BasicFieldMetadata) {
 560                          BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 561                          String valueClassName = mmd.getValueClassName();
 562                          if (!StringUtils.isEmpty(mmd.getToOneTargetProperty())) {
 563                              Class&lt;?&gt; clazz;
 564                              try {
 565                                  clazz = Class.forName(mmd.getValueClassName());
 566                              } catch (ClassNotFoundException e) {
 567                                  throw ExceptionHelper.refineException(e);
 568                              }
<abbr title=" 569                              java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTargetProperty());"> 569                              java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTðŸ”µ</abbr>
 570                              ManyToOne manyToOne = nestedField.getAnnotation(ManyToOne.class);
<abbr title=" 571                              if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getName())) {"> 571                              if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getNameðŸ”µ</abbr>
 572                                  valueClassName = manyToOne.targetEntity().getName();
 573                              } else {
 574                                  OneToOne oneToOne = nestedField.getAnnotation(OneToOne.class);
<abbr title=" 575                                  if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getName())) {"> 575                                  if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getNaðŸ”µ</abbr>
 576                                      valueClassName = oneToOne.targetEntity().getName();
 577                                  }
 578                              }
 579                          }
 580                          if (md.getTargetClass().equals(valueClassName)) {
 581                              if (md.isProminent() != null &amp;&amp; md.isProminent()
 582                                      &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 583                                  hf = createHeaderField(p, md);
 584                                  headerFields.add(hf);
 585                                  defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 586  
 587                                  // Is this a media listgrid
 588                                  if (hf.getFieldType().equals(&quot;ASSET_LOOKUP&quot;)) {
 589                                      isMedia = true;
 590                                  }
 591                              }
 592  
 593                              if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 594                                  wrapper.getFields().add(constructFieldDTOFromFieldData(hf,md));
 595                              }
 596                          }
 597                      }
 598                  }
 599              }
 600  
 601              type = ListGrid.Type.MAP;
 602              editable = true;
 603              canFilterAndSort = false;
 604          }
 605  
 606          String ceilingType = &quot;&quot;;
 607          if (fmd instanceof BasicFieldMetadata) {
 608              ceilingType = cmd.getCeilingType();
 609          } else if (fmd instanceof CollectionMetadata) {
 610              ceilingType = ((CollectionMetadata) fmd).getCollectionCeilingEntity();
 611          }
 612  
 613          if (CollectionUtils.isEmpty(headerFields)) {
<abbr title=" 614              String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; and property &#x27;&quot; +"> 614              String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; andðŸ”µ</abbr>
 615                      StringUtil.sanitize(field.getName()) + &quot;&#x27;.&quot;;
 616              if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) {
<abbr title=" 617                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 617                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetColleðŸ”µ</abbr>
 618              } else if (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM) {
<abbr title=" 619                  message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 619                  message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollectioðŸ”µ</abbr>
 620              } else if (selectize &amp;&amp; type == ListGrid.Type.BASIC) {
<abbr title=" 621                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuration&quot;;"> 621                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuðŸ”µ</abbr>
 622              } else {
 623                  message += &quot; Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 624              }
 625              LOG.error(message);
 626          }
 627  
<abbr title=" 628          ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProperty, sectionCrumbs, sortProperty);"> 628          ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProðŸ”µ</abbr>
 629          listGrid.setSubCollectionFieldName(field.getName());
 630          listGrid.setFriendlyName(field.getMetadata().getFriendlyName());
 631          if (StringUtils.isEmpty(listGrid.getFriendlyName())) {
 632              listGrid.setFriendlyName(field.getName());
 633          }
 634          listGrid.setContainingEntityId(containingEntityId);
 635          listGrid.setIsReadOnly(readOnly);
 636          listGrid.setHideIdColumn(hideIdColumn);
 637          listGrid.setCanFilterAndSort(canFilterAndSort);
 638  
 639          // Set up the filter builder params
 640          Date c = new Date();
 641          String friendlyName = field.getMetadata().getFriendlyName();
 642          String jsonFriendlyName = friendlyName.replaceAll(&quot; &quot;, &quot;_&quot;);
 643          listGrid.setJsonFieldName(jsonFriendlyName + c.getTime() + &quot;Json&quot;);
 644          listGrid.setFriendlyName(friendlyName);
 645          listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 646          if (CollectionUtils.isEmpty(wrapper.getFields())) {
 647              wrapper.setFields(defaultWrapperFields);
 648          }
 649          listGrid.setFieldWrapper(wrapper);
 650  
 651          String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 652          listGrid.setJson(blankJsonString);
 653          DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 654          if (dw != null) {
 655              listGrid.setDataWrapper(dw);
 656          }
 657  
 658          if (editable) {
 659              listGrid.getRowActions().add(DefaultListGridActions.UPDATE);
 660          }
 661          if (readOnly) {
 662              listGrid.getRowActions().add(DefaultListGridActions.VIEW);
 663          }
 664          if (sortable) {
 665              listGrid.setCanFilterAndSort(false);
 666              listGrid.setIsSortable(true);
 667          }
 668  
 669          if (modalSingleSelectable) {
 670              if (readOnly) {
<abbr title=" 671                  listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(true));"> 671                  listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(trðŸ”µ</abbr>
 672              } else {
 673                  listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 674  
 675              }
 676          }
 677          listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 678  
 679          if (selectize) {
 680              listGrid.setSelectizeUrl(buildSelectizeUrl(listGrid));
 681              listGrid.setSelectType(ListGrid.SelectType.SELECTIZE);
 682          }
 683  
 684          if (modalMultiSelectable) {
 685              listGrid.addModalRowAction(DefaultListGridActions.MULTI_SELECT);
 686              listGrid.setSelectType(ListGrid.SelectType.MULTI_SELECT);
 687          }
 688          listGrid.getRowActions().add(DefaultListGridActions.REMOVE);
 689  
 690          if (fmd.getManualFetch()) {
 691              listGrid.setManualFetch(true);
 692              listGrid.getToolbarActions().add(DefaultListGridActions.MANUAL_FETCH);
 693          }
 694          if (isMedia) {
 695              listGrid.setListGridType(ListGrid.Type.ASSET_GRID);
 696          }
 697  
 698          extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 699  
<abbr title=" 700          //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface"> 700          //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the ðŸ”µ</abbr>
 701          if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title=" 702              EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();"> 702              EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvðŸ”µ</abbr>
<abbr title=" 703              for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {"> 703              for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getDatðŸ”µ</abbr>
 704                  for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
 705                      if (modifier.isQualified(data.getModifierType())) {
 706                          modifier.modifyListGrid(new EntityFormModifierRequest()
 707                                  .withListGrid(listGrid)
 708                                  .withConfiguration(data)
 709                                  .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
 710                                  .withRowLevelSecurityService(rowLevelSecurityService));
 711                      }
 712                  }
 713              }
 714          }
 715          return listGrid;
 716      }
 717  
 718      protected String getMapKeyFriendlyName(Property property) {
 719          String friendlyNameFromMetadata = property.getMetadata().getFriendlyName();
 720  
 721          return (friendlyNameFromMetadata == null) ? &quot;Key&quot; : friendlyNameFromMetadata;
 722      }
 723  
 724      @Override
<abbr title=" 725      public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, Property field,"> 725      public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, PropeðŸ”µ</abbr>
 726          String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 727              throws ServiceException {
 728          FieldMetadata fmd = field.getMetadata();
 729          // Get the class metadata for this particular field
 730          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 731          if (field != null) {
 732              ppr.setSectionEntityField(field.getName());
 733          }
 734          ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 735  
 736          Map&lt;String, Object&gt; result = constructSelectizeOptionMap(drs, cmd);
 737  
 738          AdornedTargetList adornedList = ppr.getAdornedList();
 739          if (adornedList != null &amp;&amp; adornedList.getLinkedObjectPath() != null
 740              &amp;&amp; adornedList.getTargetObjectPath() != null &amp;&amp; adornedList.getLinkedIdProperty() != null
 741              &amp;&amp; adornedList.getTargetIdProperty() != null) {
<abbr title=" 742              result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());"> 742              result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperðŸ”µ</abbr>
 743              result.put(&quot;linkedObjectId&quot;, containingEntityId);
<abbr title=" 744              result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());"> 744              result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperðŸ”µ</abbr>
 745          }
 746  
 747          return result;
 748      }
 749  
 750      @Override
 751      public Map&lt;String, Object&gt; constructSelectizeOptionMap(DynamicResultSet drs, ClassMetadata cmd) {
 752          Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
 753          List&lt;Map&lt;String, String&gt;&gt; options = new ArrayList&lt;&gt;();
 754  
 755          List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 756          for (Property p : cmd.getProperties()) {
 757              if (p.getMetadata() instanceof BasicFieldMetadata) {
 758                  BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 759                  if (md.isProminent() != null &amp;&amp; md.isProminent()
 760                          &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 761                      Field hf = createHeaderField(p, md);
 762                      headerFields.add(hf);
 763                  }
 764              }
 765          }
 766  
 767          for (Entity e : drs.getRecords()) {
 768              Map&lt;String, String&gt; selectizeOption = new HashMap&lt;&gt;();
 769              for (Field headerField : headerFields) {
 770                  Property p = e.findProperty(headerField.getName());
 771                  if (p != null) {
 772                      selectizeOption.put(&quot;name&quot;, p.getValue());
 773                      break;
 774                  }
 775              }
 776              if (e.findProperty(&quot;id&quot;) != null) {
 777                  selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;id&quot;).getValue());
 778              //  &quot;Locale&quot; entity is a special occasion. Because it have not &quot;ID&quot; column with &quot;Long&quot; type
 779              } else if (e.findProperty(&quot;localeCode&quot;) != null) {
 780                  selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;localeCode&quot;).getValue());
 781              }
 782              if (e.findProperty(ALTERNATE_ID_PROPERTY) != null) {
 783                  selectizeOption.put(&quot;alternateId&quot;, e.findProperty(ALTERNATE_ID_PROPERTY).getValue());
 784              }
 785              options.add(selectizeOption);
 786          }
 787          result.put(&quot;options&quot;, options);
 788  
 789          return result;
 790      }
 791  
 792      protected String buildSelectizeUrl(ListGrid listGrid) {
 793          HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 794          String url = request.getContextPath();
<abbr title=" 795          url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + listGrid.getSectionKey();"> 795          url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + liðŸ”µ</abbr>
 796          url += &quot;/&quot; + listGrid.getContainingEntityId();
 797          url += &quot;/&quot; + listGrid.getSubCollectionFieldName();
 798          return url;
 799      }
 800  
 801      /**
<abbr title=" 802       * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 802       * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, StriðŸ”µ</abbr>
 803       * @param className
 804       * @param headerFields
 805       * @param type
 806       * @param drs
 807       * @param sectionKey
 808       * @param order
 809       * @param idProperty
 810       * @param sectionCrumbs
 811       * @return
 812       */
 813      @Deprecated
<abbr title=" 814      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 814      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResulðŸ”µ</abbr>
 815              String sectionKey, int order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs) {
 816         return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,null);
 817      }
 818  
 819      /**
 820       * Populate a ListGrid with ListGridRecords.
 821       *
 822       * @param className
 823       * @param headerFields
 824       * @param type
 825       * @param drs
 826       * @param sectionKey
 827       * @param order
 828       * @param idProperty
 829       * @param sectionCrumbs
 830       * @param sortPropery
 831       * @return
 832       */
<abbr title=" 833      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 833      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResulðŸ”µ</abbr>
<abbr title=" 834              String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropery) {"> 834              String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropðŸ”µ</abbr>
 835          // Create the list grid and set some basic attributes
 836          ListGrid listGrid = new ListGrid();
 837          listGrid.setClassName(className);
 838          listGrid.getHeaderFields().addAll(headerFields);
 839          listGrid.setListGridType(type);
 840          listGrid.setSectionCrumbs(sectionCrumbs);
 841          listGrid.setSectionKey(sectionKey);
 842          listGrid.setOrder(order);
 843          listGrid.setIdProperty(idProperty);
 844          listGrid.setStartIndex(drs.getStartIndex());
 845          listGrid.setTotalRecords(drs.getTotalRecords());
 846          listGrid.setPageSize(drs.getPageSize());
 847  
 848          String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
<abbr title=" 849          AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier);"> 849          AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier)ðŸ”µ</abbr>
 850          if (section != null) {
 851              listGrid.setExternalEntitySectionKey(section.getUrl());
 852          }
 853  
 854          // format date list grid cells
 855          SimpleDateFormat formatter = new SimpleDateFormat(&quot;MMM d, y @ hh:mma&quot;);
 856          DateFormatSymbols symbols = new DateFormatSymbols(Locale.getDefault());
 857          symbols.setAmPmStrings(new String[] { &quot;am&quot;, &quot;pm&quot; });
 858          formatter.setDateFormatSymbols(symbols);
 859  
 860          // For each of the entities (rows) in the list grid, we need to build the associated
 861          // ListGridRecord and set the required fields on the record. These fields are the same ones
 862          // that are used for the header fields.
 863          for (Entity e : drs.getRecords()) {
 864              ListGridRecord record = new ListGridRecord();
 865              record.setListGrid(listGrid);
 866              record.setDirty(e.isDirty());
 867              record.setEntity(e);
 868              if (StringUtils.isNotBlank(sortPropery) &amp;&amp; e.findProperty(sortPropery) != null) {
 869                  Property sort = e.findProperty(sortPropery);
 870                  record.setDisplayOrder(sort.getValue());
 871              }
 872              if (e.findProperty(&quot;hasError&quot;) != null) {
 873                  Boolean hasError = Boolean.parseBoolean(e.findProperty(&quot;hasError&quot;).getValue());
 874                  record.setIsError(hasError);
 875                  if (hasError) {
 876                      ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 877                              .getProxy().determineErrorMessageForEntity(e, record);
 878  
 879                      if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 880                          record.setErrorKey(&quot;listgrid.record.error&quot;);
 881                      }
 882                  }
 883              }
 884  
 885              if (e.findProperty(&quot;progressStatus&quot;) != null) {
 886                  ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 887                          .getProxy().determineStatusMessageForEntity(e, record);
 888                  if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 889                      record.setStatus(e.findProperty(&quot;progressStatus&quot;).getValue());
 890                      record.setStatusCssClass(&quot;listgrid.record.status&quot;);
 891                  }
 892              }
 893  
 894              if (e.findProperty(idProperty) != null) {
 895                  record.setId(e.findProperty(idProperty).getValue());
 896              }
 897  
 898              for (Field headerField : headerFields) {
 899                  Property p = e.findProperty(headerField.getName());
 900                  if (p != null) {
 901                      Field recordField = new Field().withName(headerField.getName())
 902                              .withFriendlyName(headerField.getFriendlyName())
 903                              .withOrder(p.getMetadata().getOrder());
 904  
 905                      if (headerField instanceof ComboField) {
 906                          recordField.setValue(((ComboField) headerField).getOption(p.getValue()));
 907                          recordField.setDisplayValue(p.getDisplayValue());
 908                      } else {
 909                          if (headerField.getFieldType().equals(&quot;DATE&quot;)) {
 910                              try {
 911                                  Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue());
 912                                  String newValue = formatter.format(date);
 913                                  recordField.setValue(newValue);
 914                              } catch (Exception ex) {
 915                                  recordField.setValue(p.getValue());
 916                              }
 917                          } else {
 918                              recordField.setValue(p.getValue());
 919                          }
 920                          recordField.setDisplayValue(p.getDisplayValue());
 921                      }
 922  
 923                      recordField.setDerived(isDerivedField(headerField, recordField, p));
 924  
 925                      record.getFields().add(recordField);
 926                  }
 927              }
 928  
 929              if (e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY) != null) {
 930                  Field hiddenField = new Field().withName(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 931                  hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue());
 932                  record.getHiddenFields().add(hiddenField);
 933              }
 934  
 935              if (e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY) != null) {
 936                  record.setAltId(e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY).getValue());
 937              }
 938  
 939              extensionManager.getProxy().modifyListGridRecord(className, record, e);
 940  
 941              listGrid.getRecords().add(record);
 942          }
 943  
 944          if (drs.getFirstId() != null) {
 945              listGrid.setFirstId(drs.getFirstId());
 946          }
 947          if (drs.getLastId() != null) {
 948              listGrid.setLastId(drs.getLastId());
 949          }
 950          if (drs.getUpperCount() != null) {
 951              listGrid.setUpperCount(drs.getUpperCount());
 952          }
 953          if (drs.getLowerCount() != null) {
 954              listGrid.setLowerCount(drs.getLowerCount());
 955          }
 956          if (drs.getFetchType() != null) {
 957              listGrid.setFetchType(drs.getFetchType().toString());
 958          }
 959          if (drs.getTotalCountLessThanPageSize() != null) {
 960              listGrid.setTotalCountLessThanPageSize(drs.getTotalCountLessThanPageSize());
 961          }
 962          if (drs.getPromptSearch() != null) {
 963              listGrid.setPromptSearch(drs.getPromptSearch());
 964          }
 965  
 966          return listGrid;
 967      }
 968  
 969      /**
<abbr title=" 970       * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasicFieldMetadata}"> 970       * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasiðŸ”µ</abbr>
 971       * for the given Property to see if something on the backend has marked it as derived
 972       *
 973       * @param headerField the header for this recordField
 974       * @param recordField the recordField being populated
 975       * @param p the property that relates to this recordField
 976       * @return whether or not this field is derived
<abbr title=" 977       * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 977       * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, SðŸ”µ</abbr>
 978       */
 979      protected Boolean isDerivedField(Field headerField, Field recordField, Property p) {
 980          return BooleanUtils.isTrue(((BasicFieldMetadata) p.getMetadata()).getIsDerived());
 981      }
 982  
 983      protected void setEntityFormFields(ClassMetadata cmd, EntityForm ef, List&lt;Property&gt; properties) {
 984          List&lt;Field&gt; homelessFields = new ArrayList&lt;&gt;();
 985          List&lt;Field&gt; fieldsWithAssociations = new ArrayList&lt;&gt;();
 986  
 987          for (Property property : properties) {
 988              if (property.getMetadata() instanceof BasicFieldMetadata) {
 989                  BasicFieldMetadata fmd = (BasicFieldMetadata) property.getMetadata();
 990  
 991  
 992                  if (!ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
 993                      // Depending on visibility, field for the particular property is not created on the form
 994                      String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 995  
 996                      // Create the field and set some basic attributes
 997                      Field f;
 998  
 999                      if (fieldType.equals(SupportedFieldType.BROADLEAF_ENUMERATION.toString())
1000                              || fieldType.equals(SupportedFieldType.EXPLICIT_ENUMERATION.toString())
1001                              || fieldType.equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION.toString())
1002                              || fieldType.equals(SupportedFieldType.EMPTY_ENUMERATION.toString())) {
<abbr title="1003                          // We&#x27;re dealing with fields that should render as drop-downs, so set their possible values">1003                          // We&#x27;re dealing with fields that should render as drop-downs, so set their possible valueðŸ”µ</abbr>
1004                          f = new ComboField();
1005                          ((ComboField) f).setOptions(fmd.getEnumerationValues());






<abbr title="1006                          if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValue()">1006                          if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValuðŸ”µ</abbr>
1007                                  &amp;&amp; ((ComboField) f).getOptions().size() == 0) {
1008                              f.setIsVisible(false);
1009                          }
1010                      } else if (fieldType.equals(SupportedFieldType.CODE.toString())) {
1011                          f = new CodeField();
1012                      } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1013                              || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1014                              || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1015                          // We&#x27;re dealing with rule builders, so we&#x27;ll create those specialized fields
1016                          f = new RuleBuilderField();
1017                          ((RuleBuilderField) f).setJsonFieldName(property.getName() + &quot;Json&quot;);
1018                          ((RuleBuilderField) f).setDataWrapper(new DataWrapper());
1019                          ((RuleBuilderField) f).setFieldBuilder(fmd.getRuleIdentifier());
1020                          ((RuleBuilderField) f).setDisplayType(fmd.getDisplayType().toString());
1021  
1022                          String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
1023                          ((RuleBuilderField) f).setJson(blankJsonString);
1024                          DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
1025                          if (dw != null) {
1026                              ((RuleBuilderField) f).setDataWrapper(dw);
1027                          }
1028  
1029                          if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())) {
1030                              ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple&quot;);
1031                          } else if (fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1032                              ((RuleBuilderField) f).setRuleType(&quot;rule-builder-with-quantity&quot;);
1033                          } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())) {
1034                              ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple-time&quot;);
1035                          }
1036                      } else if (LookupType.DROPDOWN.equals(fmd.getLookupType())) {
<abbr title="1037                          // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of in a">1037                          // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of inðŸ”µ</abbr>
<abbr title="1038                          // modal, so we&#x27;ll provision the combo field here. Available options will be set as part of a">1038                          // modal, so we&#x27;ll provision the combo field here. Available options will be set as part oðŸ”µ</abbr>
1039                          // subsequent operation
1040                          f = new ComboField();
1041                      } else if (fieldType.equals(SupportedFieldType.MEDIA.toString())) {
1042                          f = new MediaField();
1043                      } else {
1044                          // Create a default field since there was no specialized handler
1045                          f = new Field();
1046                      }
1047  
1048                      Boolean required = fmd.getRequiredOverride();
1049                      if (required == null) {
1050                          required = fmd.getRequired();
1051                      }
1052  
1053                      Boolean allowNoValueEnum = fmd.getAllowNoValueEnumOption();
1054                      if (allowNoValueEnum != null) {
1055                          f.setAllowNoValueEnumOption(allowNoValueEnum);
1056                      }
1057  
1058                      f.withName(property.getName())
1059                       .withFieldType(fieldType)
1060                       .withFieldComponentRenderer(getFieldComponentRenderer(fmd))
1061                       .withGridFieldComponentRenderer(getGridFieldComponentRenderer(fmd))
1062                       .withOrder(fmd.getOrder())
1063                       .withFriendlyName(fmd.getFriendlyName())
1064                       .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
1065                       .withForeignKeyClass(fmd.getForeignKeyClass())
1066                       .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title="1067                       .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromType())">1067                       .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromTyðŸ”µ</abbr>
1068                       .withRequired(required)
1069                       .withReadOnly(fmd.getReadOnly())
1070                       .withTranslatable(fmd.getTranslatable())
1071                       .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDERING))
1072                       .withLargeEntry(fmd.isLargeEntry())
1073                       .withHint(fmd.getHint())
1074                       .withTooltip(fmd.getTooltip())
1075                       .withHelp(fmd.getHelpText())
1076                       .withTypeaheadEnabled(fmd.getEnableTypeaheadLookup())
1077                       .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity())
1078                       .withAssociatedFieldName(fmd.getAssociatedFieldName());
1079  
1080                      String defaultValue = fmd.getDefaultValue();
1081                      if (defaultValue != null) {
1082                          defaultValue = extractDefaultValueFromFieldData(fieldType, fmd);
1083                          f.withValue(defaultValue);
1084                      }
1085  
1086                      if (StringUtils.isBlank(f.getFriendlyName())) {
1087                          f.setFriendlyName(f.getName());
1088                      }
1089  
1090                      // If is form hidden, set visible to false
1091                      if (VisibilityEnum.FORM_EXPLICITLY_HIDDEN.equals(fmd.getVisibility())) {
1092                          f.setIsVisible(false);
1093                      }
1094  
1095                      if (VisibilityEnum.VISIBLE_ALL.equals(fmd.getVisibility())) {
1096                          f.setIsVisible(true);
1097                      }
1098  
1099                      // Add the field to the appropriate FieldGroup
1100                      if (fmd.getGroup() == null) {
1101                          homelessFields.add(f);
1102                      } else {
1103                          ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabOrder());
1104                      }
1105  
1106                      if (StringUtils.isNotEmpty(fmd.getAssociatedFieldName())) {
1107                          fieldsWithAssociations.add(f);
1108                      }
1109                  }
1110              }
1111          }
1112  
1113          for (Field f : homelessFields) {
1114              ef.addField(cmd, f, null, null, null, null);
1115          }
1116  
1117          for (Field f : fieldsWithAssociations) {
1118              Field associatedField = findAssociatedField(ef, f);
1119              if (associatedField != null) {
1120                  associatedField.setShouldRender(false);
1121                  f.setAssociatedFieldName(associatedField.getName());
1122              } else {
1123                  f.setAssociatedFieldName(null);
1124              }
1125          }
1126      }
1127  
1128      protected String getFieldComponentRenderer(BasicFieldMetadata fmd) {
1129          if (StringUtils.isNotBlank(fmd.getFieldComponentRendererTemplate())) {
1130              return fmd.getFieldComponentRendererTemplate();
1131          }
1132          return fmd.getFieldComponentRenderer()==null?null:fmd.getFieldComponentRenderer().toString();
1133      }
1134  
1135      protected String getGridFieldComponentRenderer(BasicFieldMetadata fmd) {
1136          if (StringUtils.isNotBlank(fmd.getGridFieldComponentRendererTemplate())) {
1137              return fmd.getGridFieldComponentRendererTemplate();
1138          }
1139          return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toString();
1140      }
1141  
1142      private Field findAssociatedField(EntityForm ef, Field f) {
1143          // Try on the parent object
1144          Field associatedField = ef.findField(f.getAssociatedFieldName());
1145  
1146          if (associatedField == null) {
1147              // Check the field&#x27;s path
1148              String[] fieldPathParts = f.getName().split(&quot;\\.&quot;);
1149              String testPath = &quot;&quot;;
1150  
1151              for (String path : fieldPathParts) {
1152                  testPath += path + &quot;.&quot;;
1153  
1154                  associatedField = ef.findField(testPath + f.getAssociatedFieldName());
1155                  if (associatedField != null) {
1156                      break;
1157                  }
1158              }
1159          }
1160          return associatedField;
1161      }
1162  
1163      /**
1164       * This method gets the {@link AdminSection} for the given foreignKeyClass parameter. If none exists,
1165       * it returns the foreignKeyClass.
1166       *
1167       * @param foreignKeyClass the {@link String} class name
1168       * @return the admin section pathname
1169       */
1170      protected String getAdminSectionPath(String foreignKeyClass) {
1171          if (foreignKeyClass != null) {
<abbr title="1172              AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyClass, null);">1172              AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyðŸ”µ</abbr>
1173              return foreignKeySection != null ? foreignKeySection.getUrl() : foreignKeyClass;
1174          }
1175          return null;
1176      }
1177  
1178      /**
<abbr title="1179       * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal to">1179       * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal tðŸ”µ</abbr>
1180       *  the processed value of another tab.
1181       *
1182       * For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a another tab where
1183       *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;,
1184       *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; tabs.
1185       */
1186      protected void setEntityFormTabsAndGroups(EntityForm ef, Map&lt;String, TabMetadata&gt; tabMetadataMap) {
1187          if (tabMetadataMap != null) {
1188              Set&lt;String&gt; tabMetadataKeySet = tabMetadataMap.keySet();
1189              for (String tabKey : tabMetadataKeySet) {
1190                  TabMetadata tabMetadata = tabMetadataMap.get(tabKey);
1191                  String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySet);
1192  
1193                  if (foundMatchingTab(unprocessedTabName)) {
1194                      if (!tabExists(ef, unprocessedTabName)) {
1195                          TabMetadata originalTabMetadata = tabMetadataMap.get(unprocessedTabName);
1196                          unprocessedTabName = ef.addTabFromTabMetadata(originalTabMetadata);
1197                      }
1198                  } else {
1199                      if (tabExists(ef, tabKey)) {
1200                          unprocessedTabName = tabKey;
1201                      } else {
1202                          unprocessedTabName = ef.addTabFromTabMetadata(tabMetadata);
1203                      }
1204                  }
1205  
1206                  Set&lt;String&gt; groupMetadataKeySet = tabMetadata.getGroupMetadata().keySet();
1207                  for (String groupKey : groupMetadataKeySet) {
<abbr title="1208                      ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName);">1208                      ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName)ðŸ”µ</abbr>
1209                  }
1210              }
1211          }
1212      }
1213  
1214      /**
1215       * Search for any other tab on the target entity that has the same display value
1216       *  as the value provided tab name.
1217       *
1218       * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message property.
<abbr title="1219       *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySet">1219       *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySeðŸ”µ</abbr>
1220       *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method should return
1221       *  &quot;Example_Tab&quot; which will end up causing the tabs to merge together.
1222       *
1223       * If a tab with the same display value cannot be found, then we should return null to indicate that there
1224       *  is no matching tab with the same processed tabName value.
1225       */
1226      protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySet) {
1227          for (String tabKey : tabMetadataKeySet) {
1228              String tabName = tabMetadata.getTabName();
1229  
1230              if (processedTabKeyMatchesTabName(tabName, tabKey)) {
1231                  return tabKey;
1232              }
1233          }
1234  
1235          return null;
1236      }
1237  
1238      protected boolean processedTabKeyMatchesTabName(String tabName, String candidateTabKey) {
1239          try {
1240              String processedCandidateTabKey = BLCMessageUtils.getMessage(candidateTabKey);
1241              boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateTabKey);
1242  
1243              return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidateTabKey);
1244          } catch (NoSuchMessageException e) {
1245              LOG.debug(&quot;No such message exists for &quot; + candidateTabKey, e);
1246  
1247              return false;
1248          }
1249      }
1250  
1251      protected boolean foundMatchingTab(String unprocessedTabName) {
1252          return (unprocessedTabName != null);
1253      }
1254  
1255      protected boolean tabExists(EntityForm ef, String tabKey) {
1256          return (ef.findTab(tabKey) != null);
1257      }
1258  
1259      @Override
1260      public String extractDefaultValueFromFieldData(String fieldType, BasicFieldMetadata fmd) {
1261          String defaultValue = fmd.getDefaultValue();
1262          if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1263                  || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1264                  || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1265              return null;
1266          } else if (fieldType.equals(SupportedFieldType.INTEGER.toString())) {
1267              try {
1268                  Integer.parseInt(defaultValue);
1269              } catch (NumberFormatException  e) {



1270                  String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defaultValue);
1271                  LOG.debug(msg);
1272                  return null;
1273              }
1274          } else if (fieldType.equals(SupportedFieldType.DECIMAL.toString())
1275                  || fieldType.equals(SupportedFieldType.MONEY.toString())) {
1276              try {
1277                  BigDecimal val = new BigDecimal(defaultValue);
1278              } catch (NumberFormatException  e) {




1279                  String msg = buildMsgForDefValException(fieldType.toString(), fmd, defaultValue);
1280                  LOG.debug(msg);
1281                  return null;
1282              }
1283          } else if (fieldType.equals(SupportedFieldType.BOOLEAN.toString())) {
1284              if (!defaultValue.toLowerCase().equals(&quot;true&quot;) &amp;&amp; !defaultValue.toLowerCase().equals(&quot;false&quot;)
1285                      &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)) {
1286                  String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defaultValue);
1287                  LOG.debug(msg);
1288                  return null;
1289              }
1290          } else if (fieldType.equals(SupportedFieldType.DATE.toString())) {
1291              DateFormat format = FormatUtil.getDateFormat();
1292              if (defaultValue.toLowerCase().contains(&quot;today&quot;)) {
1293                  defaultValue = format.format(new Date());
1294              } else {
1295                  try {
1296                      Date date = format.parse(defaultValue);
1297                      defaultValue = format.format(date);
1298                  } catch (ParseException e) {
<abbr title="1299                      String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue);">1299                      String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue)ðŸ”µ</abbr>
1300                      LOG.debug(msg);
1301                      return null;
1302                  }
1303              }
1304          }
1305          return defaultValue;
1306      }
1307  
1308      protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue) {
<abbr title="1309          return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - Failed to parse &quot;">1309          return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - FailedðŸ”µ</abbr>
1310                  + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue) + &quot; ]&quot;;
1311      }
1312  
1313      @Override
1314      public void removeNonApplicableFields(ClassMetadata cmd, EntityForm entityForm, String entityType) {
1315          for (Property p : cmd.getProperties()) {
1316              if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entityType)) {
1317                  entityForm.removeField(p.getName());
1318              }
1319          }
1320      }
1321  
1322      @Override
1323      public EntityForm createEntityForm(ClassMetadata cmd, List&lt;SectionCrumb&gt; sectionCrumbs)
1324              throws ServiceException {
1325          EntityForm ef = createStandardEntityForm();
1326          populateEntityForm(cmd, ef, sectionCrumbs);
1327          return ef;
1328      }
1329  
1330      protected String extractSectionIdentifierFromCrumb(List&lt;SectionCrumb&gt; sectionCrumbs) {
1331          if (sectionCrumbs != null &amp;&amp; sectionCrumbs.size() &gt; 0) {
1332              return sectionCrumbs.get(0).getSectionIdentifier();
1333          } else {
1334              return null;
1335          }
1336      }
1337  
1338      @Override
1339      public void populateEntityForm(ClassMetadata cmd, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)
1340              throws ServiceException {
1341          ef.setCeilingEntityClassname(cmd.getCeilingType());
1342  
1343          String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
1344  
1345          AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType(),
1346                  sectionIdentifier);
1347          if (section != null) {
1348              ef.setSectionKey(section.getUrl());
1349          } else {
1350              ef.setSectionKey(cmd.getCeilingType());
1351          }
1352          ef.setSectionCrumbsImpl(sectionCrumbs);
1353  
1354          setEntityFormTabsAndGroups(ef, cmd.getTabAndGroupMetadata());
1355  
1356          setEntityFormFields(cmd, ef, Arrays.asList(cmd.getProperties()));
1357  
1358          populateDropdownToOneFields(ef, cmd);
1359  
1360          extensionManager.getProxy().modifyUnpopulatedEntityForm(ef);
1361      }
1362  
1363      /**
1364       * This method is invoked when EntityForms are created and is meant to provide a hook to add
1365       * additional entity form actions for implementors of Broadleaf. Broadleaf modules will typically
1366       * leverage {@link FormBuilderExtensionHandler#addAdditionalFormActions(EntityForm)} method.
1367       * @param ef
1368       */
1369      protected void addAdditionalFormActions(EntityForm ef) {
1370  
1371      }
1372  
1373      @Override
1374      public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbs)
1375              throws ServiceException {
1376          EntityForm ef = createStandardEntityForm();
1377          populateEntityForm(cmd, entity, ef, sectionCrumbs);
1378          addAdditionalFormActions(ef);
1379          extensionManager.getProxy().addAdditionalFormActions(ef);
1380          return ef;
1381      }
1382  
1383      @Override
<abbr title="1384      public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1384      public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumðŸ”µ</abbr>
1385              throws ServiceException {
1386          // Get the empty form with appropriate fields
1387          populateEntityForm(cmd, ef, sectionCrumbs);
1388  
1389          String idProperty = adminEntityService.getIdProperty(cmd);
1390          ef.setId(entity.findProperty(idProperty).getValue());
1391          ef.setEntityType(entity.getType()[0]);
1392  
1393          populateEntityFormFieldValues(cmd, entity, ef);
1394  
1395          Property p = entity.findProperty(BasicPersistenceModule.MAIN_ENTITY_NAME_PROPERTY);
1396          if (p != null) {
1397              ef.setMainEntityName(p.getValue());

1398          }
1399  
1400          extensionManager.getProxy().modifyPopulatedEntityForm(ef, entity);
1401      }
1402  
1403      protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef) {
1404          for (Property p : cmd.getProperties()) {
1405              FieldMetadata fmd = p.getMetadata();
1406  
1407              if (shouldHideField(fmd, entity)) {
1408                  if (fmd instanceof CollectionMetadata) {
1409                      ef.removeListGrid(p.getName());
1410                  } else {
1411                      ef.removeField(p.getName());
1412                  }
1413              }
1414          }
1415      }
1416  
1417      protected boolean shouldHideField(FieldMetadata fmd, Entity entity) {
1418          if (fmd == null || fmd.getShowIfFieldEquals() == null) {
1419              return false;
1420          }
1421  
1422          for (String property : fmd.getShowIfFieldEquals().keySet()) {
1423              List&lt;String&gt; values = fmd.getShowIfFieldEquals().get(property);
1424              Property entityProp = entity.findProperty(property);
1425  
1426              if (entityProp == null || values.contains(entityProp.getValue())) {
1427                  return false;
1428              }
1429          }
1430          return true;
1431      }
1432  
1433      @Override
1434      public void populateEntityFormFieldValues(ClassMetadata cmd, Entity entity, EntityForm ef) {
1435          // Set the appropriate property values
1436          for (Property p : cmd.getProperties()) {
1437              if (p.getMetadata() instanceof BasicFieldMetadata) {
1438                  BasicFieldMetadata basicFM = (BasicFieldMetadata) p.getMetadata();
1439  
1440                  Property entityProp = entity.findProperty(p.getName());
1441  
1442                  boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibility());
1443                  //always show special map fields
1444                  if (p.getName().equals(&quot;key&quot;) || p.getName().equals(&quot;priorKey&quot;)) {
1445                      explicitlyShown = true;
1446                  }
1447  
1448                  if (entityProp == null &amp;&amp; explicitlyShown) {
1449                      Field field = ef.findField(p.getName());
1450                      if (field != null) {
1451                          field.setValue(null);
1452                      }
<abbr title="1453                  } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1453                  } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFiðŸ”µ</abbr>
1454                      ef.removeField(p.getName());
1455                  } else {
1456                      Field field = ef.findField(p.getName());
1457                      if (field != null) {
1458                          if (entityProp != null) {
<abbr title="1459                              //protect against null - can happen with password confirmation fields (i.e. admin user)">1459                              //protect against null - can happen with password confirmation fields (i.e. admin userðŸ”µ</abbr>
1460                              field.setDirty(entityProp.getIsDirty());
1461                          }
1462                          if (basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE
1463                                  || basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE_TIME
1464                                  || basicFM.getFieldType()==SupportedFieldType.RULE_WITH_QUANTITY) {
1465                              RuleBuilderField rbf = (RuleBuilderField) field;
1466                              if (entity.getPMap().containsKey(rbf.getJsonFieldName())) {
1467                                  String json = entity.getPMap().get(rbf.getJsonFieldName()).getValue();
1468                                  rbf.setJson(json);
1469                                  DataWrapper dw = convertJsonToDataWrapper(json);
1470                                  if (dw != null) {
1471                                      rbf.setDataWrapper(dw);
1472                                  }
1473                              }
1474                          }
1475                          if (basicFM.getFieldType() == SupportedFieldType.MEDIA) {
1476                              field.setValue(entityProp.getValue());

1477                              field.setDisplayValue(entityProp.getDisplayValue());
1478                              MediaField mf = (MediaField) field;
<abbr title="1479                              Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(), MediaDto.class);">1479                              Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(),ðŸ”µ</abbr>
<abbr title="1480                              mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(), type));">1480                              mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(),ðŸ”µ</abbr>
1481                          } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {
1482                              field.setValue(entityProp.getValue());

1483                              field.setDisplayValue(entityProp.getDisplayValue());
1484                          }
1485                      }
1486                  }
1487              }
1488          }
1489      }
1490  
1491      /**
1492       * When using Thymeleaf, we need to convert the JSON string back to
1493       * a DataWrapper object because Thymeleaf escapes JSON strings.
1494       * Thymeleaf uses it&#x27;s own object de-serializer
1495       * see: https://github.com/thymeleaf/thymeleaf/issues/84
1496       * see: http://forum.thymeleaf.org/Spring-Javascript-and-escaped-JSON-td4024739.html
1497       * @param json
1498       * @return DataWrapper
1499       * @throws IOException
1500       */
1501      protected DataWrapper convertJsonToDataWrapper(String json) {
1502          ObjectMapper mapper = new ObjectMapper();
1503          DataDTODeserializer dtoDeserializer = new DataDTODeserializer();
<abbr title="1504          SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null));">1504          SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null)ðŸ”µ</abbr>
1505          module.addDeserializer(DataDTO.class, dtoDeserializer);
1506          mapper.registerModule(module);
1507          try {
1508              return mapper.readValue(json, DataWrapper.class);
1509          } catch (IOException e) {
1510              throw new RuntimeException(e);
1511          }
1512      }
1513  
1514      protected void populateDropdownToOneFields(EntityForm ef, ClassMetadata cmd)
1515              throws ServiceException {
1516          for (Property p : cmd.getProperties()) {
1517              if (p.getMetadata() instanceof BasicFieldMetadata) {
1518                  BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
1519                  if (LookupType.DROPDOWN.equals(fmd.getLookupType())
1520                          &amp;&amp; !ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
1521                      // Get the records
1522                      PersistencePackageRequest toOnePpr = PersistencePackageRequest.standard()
1523                              .withCeilingEntityClassname(fmd.getForeignKeyClass());
1524                      Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecords();
1525  
1526                      // Determine the id field
1527                      String idProp = null;
<abbr title="1528                      ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSet().getClassMetaData();">1528                      ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSðŸ”µ</abbr>
1529                      for (Property foreignP : foreignClassMd.getProperties()) {
1530                          if (foreignP.getMetadata() instanceof BasicFieldMetadata) {
1531                              BasicFieldMetadata foreignFmd = (BasicFieldMetadata) foreignP.getMetadata();
1532                              if (SupportedFieldType.ID.equals(foreignFmd.getFieldType())) {
1533                                  idProp = foreignP.getName();
1534                              }
1535                          }
1536                      }
1537  
1538                      if (idProp == null) {
<abbr title="1539                          throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClass());">1539                          throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClassðŸ”µ</abbr>
1540                      }
1541  
1542                      // Determine the display field
1543                      String displayProp = fmd.getLookupDisplayProperty();
1544  
1545                      // Build the options map
1546                      Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
1547                      for (Entity row : rows) {
1548                          Property prop = row.findProperty(displayProp);
1549                          if (prop == null) {
<abbr title="1550                              LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entity [&quot; +">1550                              LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entðŸ”µ</abbr>
1551                                      ef.getCeilingEntityClassname() + &quot;]&quot;);
1552                          } else {
1553                              String displayValue = prop.getDisplayValue();
1554                              if (StringUtils.isBlank(displayValue)) {
1555                                  displayValue = prop.getValue();
1556                              }
1557                              options.put(row.findProperty(idProp).getValue(), displayValue);
1558                          }
1559                      }
1560  
1561                      // Set the options on the entity field
1562                      ComboField cf = (ComboField) ef.findField(p.getName());
1563                      cf.setOptions(options);
1564                  }
1565              }
1566          }
1567      }
1568  
1569      @Override
<abbr title="1570      public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, List&lt;SectionCrumb&gt; sectionCrumbs)">1570      public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRðŸ”µ</abbr>
1571              throws ServiceException {
1572          EntityForm ef = createStandardEntityForm();
1573          populateEntityForm(cmd, entity, collectionRecords, ef, sectionCrumbs);
1574          addAdditionalFormActions(ef);
1575          extensionManager.getProxy().addAdditionalFormActions(ef);
1576          return ef;
1577      }
1578  
1579      @Override
<abbr title="1580      public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1580      public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecorðŸ”µ</abbr>
1581              throws ServiceException {
1582          // Get the form with values for this entity
1583          populateEntityForm(cmd, entity, ef, sectionCrumbs);
1584  
1585          // Attach the sub-collection list grids and specialty UI support
1586          for (Property p : cmd.getProperties()) {
1587              if (p.getMetadata() instanceof BasicFieldMetadata) {
1588                  continue;
1589              }
1590  
1591              if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entity.getType()[0])) {
1592                  continue;
1593              }
1594  
1595              if (collectionRecords != null &amp;&amp; !collectionRecords.isEmpty()) {
1596                  DynamicResultSet subCollectionEntities = collectionRecords.get(p.getName());
1597                  String containingEntityId = entity.getPMap().get(ef.getIdProperty()).getValue();
<abbr title="1598                  ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSectionKey(), sectionCrumbs);">1598                  ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSeðŸ”µ</abbr>
1599  
1600                  CollectionMetadata md = ((CollectionMetadata) p.getMetadata());
1601                  if (md instanceof BasicCollectionMetadata) {
1602                      PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1603                      ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1603                      ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().gðŸ”µ</abbr>
1604                      if (collectionCmd.getPolymorphicEntities().getChildren().length != 0) {
<abbr title="1605                          List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTrees();">1605                          List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTreeðŸ”µ</abbr>
1606                          ListGridActionGroup actionGroup = new ListGridActionGroup().withName(&quot;Add&quot;);
1607                          for (ClassTree entityType : entityTypes) {
1608                              ListGridAction ADD = new ListGridAction(ListGridAction.ADD)
1609                                      .withButtonClass(AddMethodType.PERSIST_EMPTY==
<abbr title="1610                                              ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-grid-add-empty&quot;:&quot;sub-list-grid-add&quot;)">1610                                              ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-grid-add-eðŸ”µ</abbr>
1611                                      .withActionTargetEntity(entityType.getFullyQualifiedClassname())
1612                                      .withUrlPostfix(&quot;/add&quot;)
1613                                      .withIconClass(&quot;fa fa-plus&quot;)
1614                                      .withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyName()));
1615                              actionGroup.getListGridActions().add(0, ADD);
1616                          }
1617                          listGrid.addToolbarActionGroup(actionGroup);
1618                      } else {
1619                          listGrid.getToolbarActions().add(0, AddMethodType.PERSIST_EMPTY==
<abbr title="1620                                  ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ADD_EMPTY:DefaultListGridActions.ADD);">1620                                  ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ADD_EMPTYðŸ”µ</abbr>
1621                      }
1622                  } else {
1623                      listGrid.getToolbarActions().add(0, DefaultListGridActions.ADD);
1624                  }
1625  
1626                  if (subCollectionEntities.getUnselectedTabMetadata().get(md.getTab())!=null) {
1627                      ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), true);
1628                  } else {
1629                      ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), false);
1630                  }
1631              }
1632          }
1633  
1634          if (CollectionUtils.isEmpty(ef.getActions())) {
1635              ef.addAction(DefaultEntityFormActions.SAVE);
1636          }
1637  
1638          addDeleteActionIfAllowed(ef, cmd, entity);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1639 +        addDuplicateActionIfAllowed(ef, cmd);</span>
1640          setReadOnlyState(ef, cmd, entity);
1641  
1642          // check for fields that should be hidden based on annotations
1643          setVisibilityBasedOnShowIfFieldEquals(cmd, entity, ef);
1644  
1645          extensionManager.getProxy().modifyDetailEntityForm(ef);
1646      }
1647  
1648      /**
<abbr title="1649       * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The user can">1649       * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The usðŸ”µ</abbr>
1650       * delete an entity for the following cases:
1651       * &lt;ol&gt;
1652       *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represented by
1653       *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;
1654       *  &lt;li&gt;The user has the security necessary to delete the given &lt;b&gt;entity&lt;/b&gt; according to the
1655       *  {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}&lt;/li&gt;
1656       * &lt;/ol&gt;
1657       *
1658       * @param entityForm the form being generated
1659       * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1660       * @param entity the entity being edited
1661       * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1662       * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1663       * @see {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}
1664       */
1665      protected void addDeleteActionIfAllowed(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1666 -        boolean canDelete = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1667 +        if (isDeletionAllowed(entityForm, cmd, entity)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1668 +            entityForm.addAction(DefaultEntityFormActions.DELETE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1669 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1670 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1671 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1672 +    protected boolean isDeletionAllowed(final EntityForm entityForm, final ClassMetadata cmd,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1673 +            final Entity entity) {</span>
1674          try {
1675              String securityEntityClassname = getSecurityClassname(entityForm, cmd);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1676 -            adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.REMOVE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1677 +            adminRemoteSecurityService</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1678 +                    .securityCheck(securityEntityClassname, EntityOperationType.REMOVE);</span>
1679          } catch (ServiceException e) {
1680              if (e instanceof SecurityServiceException) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1681 -                canDelete = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1682 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1683 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1684 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1685 -        // If I cannot update a record then I certainly cannot delete it either</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1686 -        if (canDelete) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1687 -            canDelete = rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1687 -            canDelete = rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1688 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1689 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1690 -        if (canDelete) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1691 -            canDelete = rowLevelSecurityService.canRemove(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1691 -            canDelete = rowLevelSecurityService.canRemove(adminRemoteSecurityService.getPersistentAdminUser(), entðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1692 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1693 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1694 -        if (canDelete) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1695 -            entityForm.addAction(DefaultEntityFormActions.DELETE);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1696 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1697 +                return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1698 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1699 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1700 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1701 +        final AdminUser persistentAdminUser = adminRemoteSecurityService.getPersistentAdminUser();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1702 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1703 +        return rowLevelSecurityService.canUpdate(persistentAdminUser, entity)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1704 +                &amp;&amp; rowLevelSecurityService.canRemove(persistentAdminUser, entity);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1705 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1706 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1707 +    protected void addDuplicateActionIfAllowed(final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1708 +            final ClassMetadata cmd) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1709 +        if (isDuplicationAllowed(entityForm, cmd)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1710 +            entityForm.addAction(DefaultEntityFormActions.DUPLICATE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1711 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1712 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1713 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1714 +    protected boolean isDuplicationAllowed(final EntityForm entityForm, final ClassMetadata cmd) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1715 +        final String securityClassname = getSecurityClassname(entityForm, cmd);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1716 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1717 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1718 +            adminRemoteSecurityService.securityCheck(securityClassname, EntityOperationType.ADD);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1719 +        } catch (ServiceException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1720 +            if (e instanceof SecurityServiceException) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1721 +                return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1722 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1723 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1724 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1725 +        final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(securityClassname);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1726 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1727 +        return duplicator.validate(entityClass, Long.valueOf(entityForm.getId())) &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1728 +                rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1729 +                        securityClassname, cmd);</span>
1730      }
1731  
1732      /**
1733       * The given &lt;b&gt;entityForm&lt;/b&gt; is marked as readonly for the following cases:
1734       * &lt;ol&gt;
1735       *  &lt;li&gt;All of the properties from &lt;b&gt;cmd&lt;/b&gt; are readonly&lt;/b&gt;&lt;/li&gt;
<abbr title="1736       *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represented by">1736       *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represeðŸ”µ</abbr>
1737       *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;
1738       *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to the
1739       *  {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}&lt;/li&gt;
1740       * &lt;/ol&gt;
1741       *
1742       * @param entityForm the form being generated
1743       * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1744       * @param entity the entity being edited
1745       * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1746       * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1747       * @see {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}
1748       */
1749      protected void setReadOnlyState(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1750          boolean readOnly = true;
1751  
1752          // If all of the fields are read only, we&#x27;ll mark the form as such
1753          for (Property property : cmd.getProperties()) {
1754              FieldMetadata fieldMetadata = property.getMetadata();
1755              if (fieldMetadata instanceof BasicFieldMetadata) {
<abbr title="1756                  readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieldMetadata).getReadOnly();">1756                  readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieðŸ”µ</abbr>
1757                  if (!readOnly) {
1758                      break;
1759                  }
1760              } else {
1761                  readOnly = ((CollectionMetadata) fieldMetadata).isMutable();
1762                  if (!readOnly) {
1763                      break;
1764                  }
1765              }
1766          }
1767  
1768          if (!readOnly) {
<abbr title="1769              // If the user does not have edit permissions, we will go ahead and make the form read only to prevent confusion">1769              // If the user does not have edit permissions, we will go ahead and make the form read only to preventðŸ”µ</abbr>
1770              try {
1771                  String securityEntityClassname = getSecurityClassname(entityForm, cmd);
1772                  adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDATE);
1773              } catch (ServiceException e) {
1774                  if (e instanceof SecurityServiceException) {
1775                      readOnly = true;
1776                  }
1777              }
1778          }
1779  
<abbr title="1780          // if the normal admin security service has not deemed this readonly and the all of the properties on the entity">1780          // if the normal admin security service has not deemed this readonly and the all of the properties on the ðŸ”µ</abbr>
1781          // are not readonly, then check the row-level security
1782          if (!readOnly) {
<abbr title="1783              readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1783              readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entðŸ”µ</abbr>
1784          }
1785  
1786          if (readOnly) {
1787              entityForm.setReadOnly();
<abbr title="1788              //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface">1788              //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements ðŸ”µ</abbr>
1789              if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title="1790                  EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();">1790                  EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityðŸ”µ</abbr>
<abbr title="1791                  for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {">1791                  for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.geðŸ”µ</abbr>
1792                      for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
1793                          if (modifier.isQualified(data.getModifierType())) {
1794                              modifier.modifyEntityForm(new EntityFormModifierRequest()
1795                                      .withEntityForm(entityForm)
1796                                      .withConfiguration(data)
1797                                      .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
1798                                      .withEntity(entity)
1799                                      .withRowLevelSecurityService(rowLevelSecurityService));
1800                          }
1801                      }
1802                  }
1803              }
1804          }
1805      }
1806  
1807      /**
1808       * Obtains the class name suitable for passing along to the {@link SecurityVerifier}
1809       * @param entityForm
1810       * @param cmd
1811       * @return
1812       */
1813      protected String getSecurityClassname(EntityForm entityForm, ClassMetadata cmd) {
1814          String securityEntityClassname = entityForm.getCeilingEntityClassname();
1815  
1816          if (!StringUtils.isEmpty(cmd.getSecurityCeilingType())) {
1817              securityEntityClassname = cmd.getSecurityCeilingType();
1818          } else {
1819              if (entityForm.getDynamicFormInfos() != null) {
1820                  for (DynamicEntityFormInfo info : entityForm.getDynamicFormInfos().values()) {
1821                      if (!StringUtils.isEmpty(info.getSecurityCeilingClassName())) {
1822                          securityEntityClassname = info.getSecurityCeilingClassName();
1823                          break;
1824                      }
1825                  }
1826              }
1827          }
1828  
1829          return securityEntityClassname;
1830      }
1831  
1832      @Override
1833      public void populateEntityFormFields(EntityForm ef, Entity entity) {
1834          populateEntityFormFields(ef, entity, true, true);
1835      }
1836  
1837      @Override
1838      public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean populateId) {
1839          if (populateId) {
1840              ef.setId(entity.findProperty(ef.getIdProperty()).getValue());
1841          }
1842          if (populateType) {
1843              ef.setEntityType(entity.getType()[0]);
1844          }
1845  
1846          for (Entry&lt;String, Field&gt; entry : ef.getFields().entrySet()) {
1847              Property entityProp = entity.findProperty(entry.getKey());
1848              if (entityProp != null) {
1849                  entry.getValue().setValue(entityProp.getValue());
1850                  entry.getValue().setDisplayValue(entityProp.getDisplayValue());
1851              }
1852          }
1853      }
1854  
1855      @Override
1856      public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedList) {
1857          Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());
1858          Property entityProp = entity.findProperty(ef.getIdProperty());
1859          field.setValue(entityProp.getValue());
1860  
1861          if (StringUtils.isNotBlank(adornedList.getSortField())) {
1862              field = ef.findField(adornedList.getSortField());
1863              entityProp = entity.findProperty(adornedList.getSortField());
1864              if (field != null &amp;&amp; entityProp != null) {
1865                  field.setValue(entityProp.getValue());
1866              }
1867          }
1868      }
1869  
1870      @Override
1871      public void populateMapEntityFormFields(EntityForm ef, Entity entity) {
1872          Field field = ef.findField(&quot;priorKey&quot;);
1873          Property entityProp = entity.findProperty(&quot;key&quot;);
1874          if (field != null &amp;&amp; entityProp != null) {
1875              field.setValue(entityProp.getValue());
1876          }
1877      }
1878  
1879      @Override
<abbr title="1880      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1880      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedLisðŸ”µ</abbr>
1881              String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)
1882              throws ServiceException {
1883          EntityForm ef = createStandardAdornedEntityForm();
<abbr title="1884          return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAdd);">1884          return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAðŸ”µ</abbr>
1885      }
1886  
1887      @Override
<abbr title="1888      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1888      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedLisðŸ”µ</abbr>
<abbr title="1889              String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1889              String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, booleaðŸ”µ</abbr>
1890              throws ServiceException {
1891          ef.setEntityType(adornedList.getAdornedTargetEntityClassname());
1892  
1893          // Get the metadata for this adorned field
1894          PersistencePackageRequest request = PersistencePackageRequest.adorned()
1895                  .withCeilingEntityClassname(adornedMd.getCollectionCeilingEntity())
1896                  .withAdornedList(adornedList)
1897                  .withSectionCrumbs(sectionCrumbs);
1898          request.setAddOperationInspect(isAdd);
<abbr title="1899          ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getClassMetaData();">1899          ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getCðŸ”µ</abbr>
1900  
1901          List&lt;Property&gt; entityFormProperties = new ArrayList&lt;&gt;();
1902          if (isViewCollectionItem) {
1903              Collections.addAll(entityFormProperties, collectionMetadata.getProperties());
1904          } else {
1905              // We want our entity form to only render the maintained adorned target fields
1906              for (String targetFieldName : adornedMd.getMaintainedAdornedTargetFields()) {
1907                  Property p = collectionMetadata.getPMap().get(targetFieldName);
<abbr title="1908                  if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExcluded())) {">1908                  if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExðŸ”µ</abbr>
1909                      ((BasicFieldMetadata) p.getMetadata()).setVisibility(VisibilityEnum.VISIBLE_ALL);
1910                      entityFormProperties.add(p);
1911                  }
1912              }
1913          }
1914  
1915          // Set the maintained fields on the form
1916          setEntityFormFields(collectionMetadata, ef, entityFormProperties);
1917  
1918          // Add these two additional hidden fields that are required for persistence
1919          Field f = new Field()
1920                  .withName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty())
1921                  .withFieldType(SupportedFieldType.HIDDEN.toString())
1922                  .withValue(parentId);
1923          ef.addHiddenField(collectionMetadata, f);
1924  
1925          f = new Field()
1926                  .withName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty())
1927                  .withFieldType(SupportedFieldType.HIDDEN.toString())
1928                  .withIdOverride(&quot;adornedTargetIdProperty&quot;);
1929          ef.addHiddenField(collectionMetadata, f);
1930  
1931          if (StringUtils.isNotBlank(adornedList.getSortField())) {
1932              f = new Field()
1933                      .withName(adornedList.getSortField())
1934                      .withFieldType(SupportedFieldType.HIDDEN.toString());
1935              ef.addHiddenField(collectionMetadata, f);
1936          }
1937  
1938          ef.setParentId(parentId);
1939  
1940          extensionManager.getProxy().addAdditionalAdornedFormActions(ef);
1941  
1942          return ef;
1943      }
1944  
1945  
1946      @Override
<abbr title="1947      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId)">1947      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String pðŸ”µ</abbr>
1948              throws ServiceException {
1949          EntityForm ef = createStandardEntityForm();
1950          return buildMapForm(mapMd, mapStructure, cmd, parentId, ef);
1951      }
1952  
1953      @Override
<abbr title="1954      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId, EntityForm ef)">1954      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String pðŸ”µ</abbr>
1955              throws ServiceException {
1956          ForeignKey foreignKey = (ForeignKey) mapMd.getPersistencePerspective()
1957                  .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY);
1958          ef.setEntityType(foreignKey.getForeignKeyClass());
1959  
1960          Field keyField;
1961          if (!mapMd.getForceFreeFormKeys()) {
1962              // We will use a combo field to render the key choices
1963              ComboField temp = new ComboField();
1964              temp.withName(&quot;key&quot;)
1965                      .withFieldType(&quot;combo_field&quot;)
1966                      .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1967              if (mapMd.getKeys() != null) {
1968                  // The keys can be explicitly set in the annotation...
1969                  temp.setOptions(mapMd.getKeys());
1970              } else {
1971                  // Or they could be based on a different entity
1972                  PersistencePackageRequest ppr = PersistencePackageRequest.standard()
1973                          .withCeilingEntityClassname(mapMd.getMapKeyOptionEntityClass());
1974  
1975                  DynamicResultSet drs = adminEntityService.getRecords(ppr).getDynamicResultSet();
1976  
1977                  for (Entity entity : drs.getRecords()) {
1978                      String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getValue();
<abbr title="1979                      String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getValue();">1979                      String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getVaðŸ”µ</abbr>
1980                      temp.putOption(keyValue, keyDisplayValue);
1981                  }
1982              }
1983              keyField = temp;
1984          } else {
1985              keyField = new Field().withName(&quot;key&quot;)
1986                                  .withFieldType(SupportedFieldType.STRING.toString())
1987                                  .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1988          }
1989          keyField.setRequired(true);
1990          ef.addMapKeyField(cmd, keyField);
1991  
1992          // Set the fields for this form
1993          List&lt;Property&gt; mapFormProperties;
1994          if (mapMd.isSimpleValue()) {
1995              ef.setIdProperty(&quot;key&quot;);
1996              mapFormProperties = new ArrayList&lt;&gt;();
1997              Property valueProp = cmd.getPMap().get(&quot;value&quot;);
1998              mapFormProperties.add(valueProp);
1999          } else {
2000              String valueClassName = mapStructure.getValueClassName();
2001              List&lt;String&gt; classNames = getValueClassNames(valueClassName);
2002  
2003              mapFormProperties = new ArrayList&lt;&gt;(Arrays.asList(cmd.getProperties()));
2004              filterMapFormProperties(mapFormProperties, classNames);
2005          }
2006  
2007          setEntityFormFields(cmd, ef, mapFormProperties);
2008  
2009          Field f = new Field()
2010                  .withName(&quot;priorKey&quot;)
2011                  .withFieldType(SupportedFieldType.HIDDEN.toString());
2012          ef.addHiddenField(cmd, f);
2013  
2014          ef.setParentId(parentId);
2015  
2016          return ef;
2017      }
2018  
2019      protected List&lt;String&gt; getValueClassNames(String valueClassName) {
2020          PersistenceManager pm = PersistenceManagerFactory.getPersistenceManager(valueClassName);
2021          List&lt;String&gt; classNames = new ArrayList&lt;&gt;();
2022          try {
2023              Class&lt;?&gt;[] mapEntities = pm.getPolymorphicEntities(valueClassName);
2024              for (Class clazz : mapEntities) {
2025                  classNames.add(clazz.getName());
2026              }
2027          } catch (ClassNotFoundException e) {
2028              classNames.add(valueClassName);
2029          }
2030          return classNames;
2031      }
2032  
2033      protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNames) {
2034          CollectionUtils.filter(mapFormProperties, new Predicate() {
2035              @Override
2036              public boolean evaluate(Object object) {
2037                  Property p = (Property) object;
2038                  for (String availType : p.getMetadata().getAvailableToTypes()) {
2039                      if (classNames.contains(availType)) {
2040                          return true;
2041                      }
2042                  }
2043                  return false;
2044              }
2045          });
2046      }
2047  
2048      protected EntityForm createStandardEntityForm() {
2049          EntityForm ef = new EntityForm();
2050          ef.addAction(DefaultEntityFormActions.SAVE);
2051          return ef;
2052      }
2053  
2054      protected EntityForm createStandardAdornedEntityForm() {
2055          EntityForm ef = new EntityForm();
2056          ef.addAction(DefaultAdornedEntityFormActions.Add);
2057          return ef;
2058      }
2059  
2060      protected VisibilityEnum[] getGridHiddenVisibilities() {
2061          return FormBuilderServiceImpl.GRID_HIDDEN_VISIBILITIES;
2062      }
2063  
2064      protected VisibilityEnum[] getFormHiddenVisibilities() {
2065          return FormBuilderServiceImpl.FORM_HIDDEN_VISIBILITIES;
2066      }
2067  
2068  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.web.service;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.Predicate;
  22  import org.apache.commons.lang.ArrayUtils;
  23  import org.apache.commons.lang.BooleanUtils;
  24  import org.apache.commons.lang3.StringUtils;
  25  import org.apache.commons.logging.Log;
  26  import org.apache.commons.logging.LogFactory;
  27  import org.broadleafcommerce.common.admin.domain.AdminMainEntity;
  28  import org.broadleafcommerce.common.exception.ExceptionHelper;
  29  import org.broadleafcommerce.common.exception.SecurityServiceException;
  30  import org.broadleafcommerce.common.exception.ServiceException;
  31  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  32  import org.broadleafcommerce.common.i18n.domain.TranslatedEntity;
  33  import org.broadleafcommerce.common.i18n.service.TranslationService;
  34  import org.broadleafcommerce.common.locale.service.LocaleService;
  35  import org.broadleafcommerce.common.media.domain.MediaDto;
  36  import org.broadleafcommerce.common.persistence.EntityConfiguration;

  37  import org.broadleafcommerce.common.presentation.client.AddMethodType;
  38  import org.broadleafcommerce.common.presentation.client.AdornedTargetAddMethodType;
  39  import org.broadleafcommerce.common.presentation.client.LookupType;
  40  import org.broadleafcommerce.common.presentation.client.PersistencePerspectiveItemType;
  41  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  42  import org.broadleafcommerce.common.presentation.client.VisibilityEnum;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import org.broadleafcommerce.common.security.service.ExploitProtectionService;</span>
  44  import org.broadleafcommerce.common.util.BLCMessageUtils;
  45  import org.broadleafcommerce.common.util.FormatUtil;
  46  import org.broadleafcommerce.common.util.StringUtil;
  47  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  48  import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  49  import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  50  import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  51  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  52  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  53  import org.broadleafcommerce.openadmin.dto.ClassTree;
  54  import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  55  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  56  import org.broadleafcommerce.openadmin.dto.Entity;
  57  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  58  import org.broadleafcommerce.openadmin.dto.ForeignKey;
  59  import org.broadleafcommerce.openadmin.dto.MapMetadata;
  60  import org.broadleafcommerce.openadmin.dto.MapStructure;
  61  import org.broadleafcommerce.openadmin.dto.Property;
  62  import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  63  import org.broadleafcommerce.openadmin.dto.TabMetadata;

  64  import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  65  import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  66  import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  67  import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  68  import org.broadleafcommerce.openadmin.server.security.remote.SecurityVerifier;
  69  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifier;
  70  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierConfiguration;
  71  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierData;
  72  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierDataPoint;
  73  import org.broadleafcommerce.openadmin.server.security.service.EntityFormModifierRequest;
  74  import org.broadleafcommerce.openadmin.server.security.service.ExceptionAwareRowLevelSecurityProvider;
  75  import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  76  import org.broadleafcommerce.openadmin.server.security.service.navigation.AdminNavigationService;
  77  import org.broadleafcommerce.openadmin.server.service.AdminEntityService;
  78  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManager;
  79  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceManagerFactory;
  80  import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  81  import org.broadleafcommerce.openadmin.server.service.persistence.module.FieldManager;
  82  import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  83  import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  84  import org.broadleafcommerce.openadmin.web.form.component.ListGridAction;
  85  import org.broadleafcommerce.openadmin.web.form.component.ListGridActionGroup;
  86  import org.broadleafcommerce.openadmin.web.form.component.ListGridRecord;
  87  import org.broadleafcommerce.openadmin.web.form.component.MediaField;
  88  import org.broadleafcommerce.openadmin.web.form.component.RuleBuilderField;
  89  import org.broadleafcommerce.openadmin.web.form.entity.CodeField;
  90  import org.broadleafcommerce.openadmin.web.form.entity.ComboField;
  91  import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  92  import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  93  import org.broadleafcommerce.openadmin.web.form.entity.DynamicEntityFormInfo;
  94  import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  95  import org.broadleafcommerce.openadmin.web.form.entity.Field;
  96  import org.broadleafcommerce.openadmin.web.rulebuilder.DataDTODeserializer;
  97  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataDTO;
  98  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.DataWrapper;
  99  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldDTO;
 100  import org.broadleafcommerce.openadmin.web.rulebuilder.dto.FieldWrapper;
 101  import org.codehaus.jettison.json.JSONObject;
 102  import org.springframework.beans.factory.annotation.Value;
 103  import org.springframework.context.MessageSource;
 104  import org.springframework.context.NoSuchMessageException;
 105  import org.springframework.stereotype.Service;

 106  import com.fasterxml.jackson.core.Version;
 107  import com.fasterxml.jackson.databind.ObjectMapper;
 108  import com.fasterxml.jackson.databind.module.SimpleModule;

 109  import java.io.IOException;
 110  import java.math.BigDecimal;
 111  import java.text.DateFormat;
 112  import java.text.DateFormatSymbols;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +import java.text.DecimalFormat;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +import java.text.NumberFormat;</span>
 115  import java.text.ParseException;
 116  import java.text.SimpleDateFormat;
 117  import java.util.ArrayList;
 118  import java.util.Arrays;
 119  import java.util.Collections;
 120  import java.util.Date;
 121  import java.util.HashMap;
 122  import java.util.List;
 123  import java.util.Locale;
 124  import java.util.Map;
 125  import java.util.Map.Entry;
 126  import java.util.Set;

 127  import javax.annotation.Resource;
 128  import javax.persistence.ManyToOne;
 129  import javax.persistence.OneToOne;
 130  import javax.servlet.http.HttpServletRequest;
 131  
 132  
 133  /**
 134   * @author Andre Azzolini (apazzolini)
 135   */
 136  @Service(&quot;blFormBuilderService&quot;)
 137  public class FormBuilderServiceImpl implements FormBuilderService {
 138  
 139      private static final Log LOG = LogFactory.getLog(FormBuilderServiceImpl.class);
 140  
 141      public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 142  
 143      @Resource(name = &quot;blAdminEntityService&quot;)
 144      protected AdminEntityService adminEntityService;
 145  
 146      @Resource (name = &quot;blAdminNavigationService&quot;)
 147      protected AdminNavigationService navigationService;
 148  
 149      @Resource(name = &quot;blFormBuilderExtensionManager&quot;)
 150      protected FormBuilderExtensionManager extensionManager;
 151  
 152      @Resource(name=&quot;blEntityConfiguration&quot;)
 153      protected EntityConfiguration entityConfiguration;
 154  
 155      @Resource(name=&quot;blAdminSecurityRemoteService&quot;)
 156      protected SecurityVerifier adminRemoteSecurityService;
 157  
 158      @Resource(name = &quot;blRowLevelSecurityService&quot;)
 159      protected RowLevelSecurityService rowLevelSecurityService;
 160  
 161      @Resource(name = &quot;blMediaBuilderService&quot;)
 162      protected MediaBuilderService mediaBuilderService;
 163  
 164      @Resource(name = &quot;blListGridErrorMessageExtensionManager&quot;)
 165      protected ListGridErrorMessageExtensionManager listGridErrorExtensionManager;
 166  
 167      @Resource(name = &quot;blAdminNavigationService&quot;)
 168      protected AdminNavigationService adminNavigationService;
 169  






 170      @Resource(name = &quot;blLocaleService&quot;)
 171      protected LocaleService localeService;
 172  
 173      @Resource(name = &quot;blTranslationService&quot;)
 174      protected TranslationService translationService;
 175  
 176      @Value(&quot;${use.translation.search:false}&quot;)
 177      protected boolean useTranslationSearch;

 178  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +    @Resource(name = &quot;blExploitProtectionService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +    ExploitProtectionService exploitProtectionService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +</span>
 182      protected static final VisibilityEnum[] FORM_HIDDEN_VISIBILITIES = new VisibilityEnum[] {
 183              VisibilityEnum.HIDDEN_ALL, VisibilityEnum.FORM_HIDDEN
 184      };
 185  
 186      protected static final VisibilityEnum[] GRID_HIDDEN_VISIBILITIES = new VisibilityEnum[] {
 187              VisibilityEnum.HIDDEN_ALL, VisibilityEnum.GRID_HIDDEN
 188      };
 189  
 190      @Override
<abbr title=" 191      public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)"> 191      public ListGrid buildMainListGrid(DynamicResultSet drs, ClassMetadata cmd, String sectionKey, List&lt;SectionCrumðŸ”µ</abbr>
 192              throws ServiceException {
 193  
 194          List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 195          ListGrid.Type type = ListGrid.Type.MAIN;
 196          String idProperty = &quot;id&quot;;
 197  
 198          FieldWrapper wrapper = new FieldWrapper();
 199          ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 200          for (Property p : cmd.getProperties()) {
 201              if (p.getMetadata() instanceof BasicFieldMetadata) {
 202                  BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
 203  
 204                  if (SupportedFieldType.ID.equals(fmd.getFieldType())) {
 205                      idProperty = fmd.getName();
 206                  }
 207  
 208                  if (fmd.isProminent() != null &amp;&amp; fmd.isProminent()
 209                          &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), fmd.getVisibility())) {
 210                      Field hf = createHeaderField(p, fmd);
 211                      headerFields.add(hf);
 212                      defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, fmd));
 213                  }
 214  
 215                  if (fmd.getIsFilter() != null &amp;&amp; fmd.getIsFilter()) {
 216                      wrapper.getFields().add(constructFieldDTOFromFieldData(createHeaderField(p, fmd), fmd));
 217                  }
 218              }
 219          }
 220  
 221          if (useTranslationSearch) {
 222              getTranslationSearchField(cmd.getCeilingType(), defaultWrapperFields);
 223          }
 224  
<abbr title=" 225          ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idProperty, sectionCrumbs);"> 225          ListGrid listGrid = createListGrid(cmd.getCeilingType(), headerFields, type, drs, sectionKey, 0, idPropertðŸ”µ</abbr>
 226  
 227          if (CollectionUtils.isNotEmpty(listGrid.getHeaderFields())) {
 228              // Set the first column to be able to link to the main entity
 229              listGrid.getHeaderFields().iterator().next().setMainEntityLink(true);
 230          } else {
<abbr title=" 231              String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType();"> 231              String message = &quot;There are no listgrid header fields configured for the class &quot; + cmd.getCeilingType(ðŸ”µ</abbr>
 232              message += &quot;Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 233              LOG.error(message);
 234          }
 235  
 236          Date c = new Date();
 237          String friendlyName = &quot;listGrid&quot; + c.getTime();
 238          // Set up the filter builder params
 239          listGrid.setJsonFieldName(friendlyName + &quot;Json&quot;);
 240          listGrid.setFriendlyName(friendlyName);
 241          listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 242          if (CollectionUtils.isEmpty(wrapper.getFields())) {
 243              wrapper.setFields(defaultWrapperFields);
 244          }
 245          listGrid.setFieldWrapper(wrapper);
 246          listGrid.setHideFriendlyName(true);
 247  
 248          String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 249          listGrid.setJson(blankJsonString);
 250          DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 251          if (dw != null) {
 252              listGrid.setDataWrapper(dw);
 253          }
 254  
 255          listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 256          listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 257  
 258          extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 259  
 260          return listGrid;
 261      }
 262  
 263      private void getTranslationSearchField(String ceilingEntity, ArrayList&lt;FieldDTO&gt; defaultWrapperFields) {
 264  
 265          TranslatedEntity translatedEntity;
 266  
 267          try {
 268              translatedEntity = translationService.getAssignableEntityType(ceilingEntity);
 269  
 270              FieldDTO localeField = new FieldDTO();
 271              localeField.setId(&quot;translationLocale&quot;);
 272              localeField.setLabel(&quot;Translation locale&quot;);
 273              localeField.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 274              localeField.setInput(&quot;select&quot;);
 275              localeField.setType(&quot;string&quot;);
 276  
 277              List&lt;org.broadleafcommerce.common.locale.domain.Locale&gt; locales = localeService.findAllLocales();
 278  
 279              Map&lt;String, String&gt; localeMap = new HashMap&lt;String, String&gt;();
 280              for (org.broadleafcommerce.common.locale.domain.Locale l : locales) {
 281                  localeMap.put(l.getLocaleCode(), l.getFriendlyName());
 282              }
 283              localeField.setValues((new JSONObject(localeMap)).toString());
 284  
 285              defaultWrapperFields.add(localeField);
 286          } catch (Exception e) {
 287              translatedEntity = null;
 288          }
 289      }
 290  
 291      protected FieldDTO constructFieldDTOFromFieldData(Field field, BasicFieldMetadata fmd) {
 292          FieldDTO fieldDTO = new FieldDTO();
 293          //translate the label to display
 294          String label = field.getFriendlyName();
 295          BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 296          MessageSource messages = context.getMessageSource();
 297          if (messages != null) {
 298              label = messages.getMessage(label, null, label, context.getJavaLocale());
 299          }
 300          fieldDTO.setLabel(label);
 301  
 302          fieldDTO.setId(field.getName());
 303          if (field.getFieldType().equals(&quot;STRING&quot;)) {
 304              fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 305          } else if (field.getFieldType().equals(&quot;DATE&quot;)) {
 306              fieldDTO.setOperators(&quot;blcFilterOperators_Date&quot;);
<abbr title=" 307          } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldType().equals(&quot;DECIMAL&quot;)) {"> 307          } else if (field.getFieldType().equals(&quot;NUMBER&quot;) || field.getFieldType().equals(&quot;MONEY&quot;) || field.getFieldðŸ”µ</abbr>
 308              fieldDTO.setOperators(&quot;blcFilterOperators_Numeric&quot;);
 309          } else if (field.getFieldType().equals(&quot;BOOLEAN&quot;)) {
 310              fieldDTO.setOperators(&quot;blcFilterOperators_Boolean&quot;);
 311          } else if (field.getFieldType().equals(&quot;BROADLEAF_ENUMERATION&quot;)) {
 312              fieldDTO.setOperators(&quot;blcFilterOperators_Enumeration&quot;);
 313              fieldDTO.setInput(&quot;select&quot;);
 314              fieldDTO.setType(&quot;string&quot;);
 315              String[][] enumerationValues = fmd.getEnumerationValues ();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +            //not sure if we need to decode here or not...</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +            for(int i=0; i&lt; enumerationValues.length;i++){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +                enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +</span>
 322              Map&lt;String, String&gt; enumMap = new HashMap&lt;&gt;();
 323              for (int i = 0; i &lt; enumerationValues.length; i++) {
 324                  enumMap.put(enumerationValues[i][0], enumerationValues[i][1]);
 325              }
 326  
 327              fieldDTO.setValues(new JSONObject(enumMap).toString());
 328          } else if (field.getFieldType().equals(&quot;ADDITIONAL_FOREIGN_KEY&quot;)) {
 329              fieldDTO.setOperators(&quot;blcFilterOperators_Selectize&quot;);
 330              fieldDTO.setType(&quot;string&quot;);
 331  
<abbr title=" 332              AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClass(), null);"> 332              AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(fmd.getForeignKeyClaðŸ”µ</abbr>
 333              if (section != null) {
 334                  String sectionKey = section.getUrl().substring(1);
 335                  fieldDTO.setSelectizeSectionKey(sectionKey);
 336              } else {
 337                  fieldDTO.setSelectizeSectionKey(fmd.getForeignKeyClass());
 338              }
 339          } else {
 340              fieldDTO.setOperators(&quot;blcFilterOperators_Text&quot;);
 341          }
 342  
 343          return fieldDTO;
 344      }
 345  
 346      protected Field createHeaderField(Property p, BasicFieldMetadata fmd) {
 347          Field hf;
 348          if (fmd.getFieldType().equals(SupportedFieldType.EXPLICIT_ENUMERATION) ||
 349                  fmd.getFieldType().equals(SupportedFieldType.BROADLEAF_ENUMERATION) ||
 350                  fmd.getFieldType().equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION) ||
 351                  fmd.getFieldType().equals(SupportedFieldType.EMPTY_ENUMERATION)) {
 352              hf = new ComboField();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 353 -            ((ComboField) hf).setOptions(fmd.getEnumerationValues());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +            String[][] enumerationValues = fmd.getEnumerationValues();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +            for(int i=0; i&lt; enumerationValues.length;i++){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +                enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +            ((ComboField) hf).setOptions(enumerationValues);</span>
 359          } else {
 360              hf = new Field();
 361          }
 362  
 363          hf.withName(p.getName())
 364            .withFriendlyName(StringUtils.isNotEmpty(fmd.getFriendlyName()) ? fmd.getFriendlyName() : p.getName())
 365            .withOrder(fmd.getGridOrder())
 366            .withColumnWidth(fmd.getColumnWidth())
 367            .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
 368            .withForeignKeyClass(fmd.getForeignKeyClass())
 369            .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
 370            .withOwningEntityClass(fmd.getOwningClass() != null ? fmd.getOwningClass() : fmd.getTargetClass())
 371            .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity());
 372          String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
 373          hf.setFieldType(fieldType);
 374  
 375          return hf;
 376      }
 377  
 378      @Override
 379      public ListGrid buildCollectionListGrid(String containingEntityId, DynamicResultSet drs, Property field,
 380              String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 381              throws ServiceException {
 382          FieldMetadata fmd = field.getMetadata();
 383          // Get the class metadata for this particular field
 384          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 385          if (field != null) {
 386              ppr.setSectionEntityField(field.getName());
 387          }
 388          ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 389  
 390          List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 391          ListGrid.Type type = null;
 392          boolean editable = false;
 393          boolean sortable = false;
 394          boolean readOnly = false;
 395          boolean hideIdColumn = false;
 396          boolean canFilterAndSort = true;
 397          boolean modalSingleSelectable = false;
 398          boolean modalMultiSelectable = false;
 399          boolean selectize = false;
 400          boolean isMedia = false;
 401          boolean isLookup = false;
 402          String sortProperty = null;
 403          FieldWrapper wrapper = new FieldWrapper();
 404          ArrayList&lt;FieldDTO&gt; defaultWrapperFields = new ArrayList&lt;&gt;();
 405  
 406  
 407          String idProperty = &quot;id&quot;;
 408          for (Property property : cmd.getProperties()) {
 409              if (property.getMetadata() instanceof BasicFieldMetadata &amp;&amp;
 410                      SupportedFieldType.ID==((BasicFieldMetadata) property.getMetadata()).getFieldType() &amp;&amp;
 411                      //make sure it&#x27;s a property for this entity - not an association
 412                      !property.getName().contains(&quot;.&quot;)) {
 413                  idProperty = property.getName();
 414                  break;
 415              }
 416          }
 417          // Get the header fields for this list grid. Note that the header fields are different depending on the
 418          // kind of field this is.
 419          if (fmd instanceof BasicFieldMetadata) {
 420              readOnly = ((BasicFieldMetadata) fmd).getReadOnly();
 421              modalSingleSelectable = true;
 422              for (Property p : cmd.getProperties()) {
 423                  if (p.getMetadata() instanceof BasicFieldMetadata) {
 424                      BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 425  
 426                      if (SupportedFieldType.ID.equals(md.getFieldType())) {
 427                          idProperty = md.getName();
 428                      }
 429  
 430                      if (md.isProminent() != null &amp;&amp; md.isProminent()
 431                              &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 432                          Field hf = createHeaderField(p, md);
 433                          headerFields.add(hf);
 434                          defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 435                      }
 436  
 437                      if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 438                          Field f = createHeaderField(p, md);
 439                          wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 440                      }
 441                  }
 442              }
 443  
 444              type = ListGrid.Type.TO_ONE;
 445          } else if (fmd instanceof BasicCollectionMetadata) {
 446              BasicCollectionMetadata bcm = (BasicCollectionMetadata) fmd;
 447              readOnly = !bcm.isMutable();
 448  
 449              if(AddMethodType.LOOKUP.equals(bcm.getAddMethodType())) {
 450                  isLookup = true;
 451              }
 452  
 453              if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 454                  Property p = cmd.getPMap().get(bcm.getSelectizeVisibleField());
 455                  if (p != null) {
 456                      BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 457  
 458                      Field hf = createHeaderField(p, md);
 459                      headerFields.add(hf);
 460                      wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 461                  }
 462              } else {
 463                  for (Property p : cmd.getProperties()) {
 464                      if (p.getMetadata() instanceof BasicFieldMetadata) {
 465                          BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 466                          if (md.isProminent() != null &amp;&amp; md.isProminent()
 467                                  &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 468                              Field hf = createHeaderField(p, md);
 469                              headerFields.add(hf);
 470                              defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 471                          }
 472  
 473                          if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 474                              Field f = createHeaderField(p, md);
 475                              wrapper.getFields().add(constructFieldDTOFromFieldData(f, md));
 476                          }
 477                      }
 478                  }
 479              }
 480  
 481              type = ListGrid.Type.BASIC;
 482  
<abbr title=" 483              if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getAddMethodType())) {"> 483              if (AddMethodType.PERSIST.equals(bcm.getAddMethodType()) || AddMethodType.PERSIST_EMPTY.equals(bcm.getðŸ”µ</abbr>
 484                  editable = true;
 485              } else if (AddMethodType.SELECTIZE_LOOKUP.equals(bcm.getAddMethodType())) {
 486                  selectize = true;
 487                  modalSingleSelectable = true;
 488              } else {
 489                  modalSingleSelectable = true;
 490              }
 491              sortable = StringUtils.isNotBlank(bcm.getSortProperty());
 492              if (sortable) {
 493                  sortProperty = bcm.getSortProperty();
 494              }
 495          } else if (fmd instanceof AdornedTargetCollectionMetadata) {
 496              modalSingleSelectable = true;
 497              readOnly = !((AdornedTargetCollectionMetadata) fmd).isMutable();
 498              AdornedTargetCollectionMetadata atcmd = (AdornedTargetCollectionMetadata) fmd;
 499  
 500              if(AdornedTargetAddMethodType.LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 501                  isLookup = true;
 502              }
 503  
 504              if (AdornedTargetAddMethodType.SELECTIZE_LOOKUP.equals(atcmd.getAdornedTargetAddMethodType())) {
 505                  selectize = true;
 506  
 507                  Property p = cmd.getPMap().get(atcmd.getSelectizeVisibleField());
 508                  if (p != null) {
 509                      BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 510  
 511                      Field hf = createHeaderField(p, md);
 512                      headerFields.add(hf);
 513                      wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 514                  }
 515              } else {
 516                  for (String fieldName : atcmd.getGridVisibleFields()) {
 517                      Property p = cmd.getPMap().get(fieldName);
 518                      if (p != null) {
 519                          BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 520  
 521                          Field hf = createHeaderField(p, md);
 522                          headerFields.add(hf);
 523                          wrapper.getFields().add(constructFieldDTOFromFieldData(hf, md));
 524                      }
 525  
 526                  }
 527              }
 528  
 529              type = ListGrid.Type.ADORNED;
 530  
 531              if (atcmd.getMaintainedAdornedTargetFields().length &gt; 0) {
 532                  editable = true;
 533              }
 534  
 535              AdornedTargetList adornedList = (AdornedTargetList) atcmd.getPersistencePerspective()
 536                      .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);
 537              sortable = StringUtils.isNotBlank(adornedList.getSortField());
 538              if (sortable) {
 539                  sortProperty = adornedList.getSortField();
 540              }
 541          } else if (fmd instanceof MapMetadata) {
 542              readOnly = !((MapMetadata) fmd).isMutable();
 543              MapMetadata mmd = (MapMetadata) fmd;
 544  
 545              Property p2 = cmd.getPMap().get(&quot;key&quot;);
 546              BasicFieldMetadata keyMd = (BasicFieldMetadata) p2.getMetadata();
 547              keyMd.setFriendlyName(getMapKeyFriendlyName(p2));
 548              Field hf = createHeaderField(p2, keyMd);
 549              headerFields.add(hf);
 550              wrapper.getFields().add(constructFieldDTOFromFieldData(hf, keyMd));
 551  
 552              if (mmd.isSimpleValue()) {
 553                  Property valueProperty = cmd.getPMap().get(&quot;value&quot;);
 554                  BasicFieldMetadata valueMd = (BasicFieldMetadata) valueProperty.getMetadata();
 555                  valueMd.setFriendlyName(&quot;Value&quot;);
 556                  hf = createHeaderField(valueProperty, valueMd);
 557                  headerFields.add(hf);
 558                  wrapper.getFields().add(constructFieldDTOFromFieldData(hf, valueMd));
 559  
 560                  idProperty = &quot;key&quot;;
 561                  hideIdColumn = true;
 562              } else {
 563                  for (Property p : cmd.getProperties()) {
 564                      if (p.getMetadata() instanceof BasicFieldMetadata) {
 565                          BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 566                          String valueClassName = mmd.getValueClassName();
 567                          if (!StringUtils.isEmpty(mmd.getToOneTargetProperty())) {
 568                              Class&lt;?&gt; clazz;
 569                              try {
 570                                  clazz = Class.forName(mmd.getValueClassName());
 571                              } catch (ClassNotFoundException e) {
 572                                  throw ExceptionHelper.refineException(e);
 573                              }
<abbr title=" 574                              java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTargetProperty());"> 574                              java.lang.reflect.Field nestedField = FieldManager.getSingleField(clazz, mmd.getToOneTðŸ”µ</abbr>
 575                              ManyToOne manyToOne = nestedField.getAnnotation(ManyToOne.class);
<abbr title=" 576                              if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getName())) {"> 576                              if (manyToOne != null &amp;&amp; !manyToOne.targetEntity().getName().equals(void.class.getNameðŸ”µ</abbr>
 577                                  valueClassName = manyToOne.targetEntity().getName();
 578                              } else {
 579                                  OneToOne oneToOne = nestedField.getAnnotation(OneToOne.class);
<abbr title=" 580                                  if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getName())) {"> 580                                  if (oneToOne != null &amp;&amp; !oneToOne.targetEntity().getName().equals(void.class.getNaðŸ”µ</abbr>
 581                                      valueClassName = oneToOne.targetEntity().getName();
 582                                  }
 583                              }
 584                          }
 585                          if (md.getTargetClass().equals(valueClassName)) {
 586                              if (md.isProminent() != null &amp;&amp; md.isProminent()
 587                                      &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 588                                  hf = createHeaderField(p, md);
 589                                  headerFields.add(hf);
 590                                  defaultWrapperFields.add(constructFieldDTOFromFieldData(hf, md));
 591  
 592                                  // Is this a media listgrid
 593                                  if (hf.getFieldType().equals(&quot;ASSET_LOOKUP&quot;)) {
 594                                      isMedia = true;
 595                                  }
 596                              }
 597  
 598                              if (md.getIsFilter() != null &amp;&amp; md.getIsFilter()) {
 599                                  wrapper.getFields().add(constructFieldDTOFromFieldData(hf,md));
 600                              }
 601                          }
 602                      }
 603                  }
 604              }
 605  
 606              type = ListGrid.Type.MAP;
 607              editable = true;
 608              canFilterAndSort = false;
 609          }
 610  
 611          String ceilingType = &quot;&quot;;
 612          if (fmd instanceof BasicFieldMetadata) {
 613              ceilingType = cmd.getCeilingType();
 614          } else if (fmd instanceof CollectionMetadata) {
 615              ceilingType = ((CollectionMetadata) fmd).getCollectionCeilingEntity();
 616          }
 617  
 618          if (CollectionUtils.isEmpty(headerFields)) {
<abbr title=" 619              String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; and property &#x27;&quot; +"> 619              String message = &quot;There are no listgrid header fields configured for the class &quot; + ceilingType + &quot; andðŸ”µ</abbr>
 620                      StringUtil.sanitize(field.getName()) + &quot;&#x27;.&quot;;
 621              if (selectize &amp;&amp; (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM)) {
<abbr title=" 622                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 622                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationAdornedTargetColleðŸ”µ</abbr>
 623              } else if (type == ListGrid.Type.ADORNED || type == ListGrid.Type.ADORNED_WITH_FORM) {
<abbr title=" 624                  message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollection configuration&quot;;"> 624                  message += &quot; Please configure &#x27;gridVisibleFields&#x27; in your @AdminPresentationAdornedTargetCollectioðŸ”µ</abbr>
 625              } else if (selectize &amp;&amp; type == ListGrid.Type.BASIC) {
<abbr title=" 626                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuration&quot;;"> 626                  message += &quot; Please configure &#x27;selectizeVisibleField&#x27; in your @AdminPresentationCollection configuðŸ”µ</abbr>
 627              } else {
 628                  message += &quot; Please mark some @AdminPresentation fields with &#x27;prominent = true&#x27;&quot;;
 629              }
 630              LOG.error(message);
 631          }
 632  
<abbr title=" 633          ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProperty, sectionCrumbs, sortProperty);"> 633          ListGrid listGrid = createListGrid(ceilingType, headerFields, type, drs, sectionKey, fmd.getOrder(), idProðŸ”µ</abbr>
 634          listGrid.setSubCollectionFieldName(field.getName());
 635          listGrid.setFriendlyName(field.getMetadata().getFriendlyName());
 636          if (StringUtils.isEmpty(listGrid.getFriendlyName())) {
 637              listGrid.setFriendlyName(field.getName());
 638          }
 639          listGrid.setContainingEntityId(containingEntityId);
 640          listGrid.setIsReadOnly(readOnly);
 641          listGrid.setHideIdColumn(hideIdColumn);
 642          listGrid.setCanFilterAndSort(canFilterAndSort);
 643  
 644          // Set up the filter builder params
 645          Date c = new Date();
 646          String friendlyName = field.getMetadata().getFriendlyName();
 647          String jsonFriendlyName = friendlyName.replaceAll(&quot; &quot;, &quot;_&quot;);
 648          listGrid.setJsonFieldName(jsonFriendlyName + c.getTime() + &quot;Json&quot;);
 649          listGrid.setFriendlyName(friendlyName);
 650          listGrid.setFieldBuilder(&quot;RULE_SIMPLE&quot;);
 651          if (CollectionUtils.isEmpty(wrapper.getFields())) {
 652              wrapper.setFields(defaultWrapperFields);
 653          }
 654          listGrid.setFieldWrapper(wrapper);
 655  
 656          String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
 657          listGrid.setJson(blankJsonString);
 658          DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
 659          if (dw != null) {
 660              listGrid.setDataWrapper(dw);
 661          }
 662  
 663          if (editable) {
 664              listGrid.getRowActions().add(DefaultListGridActions.UPDATE);
 665          }
 666          if (readOnly) {
 667              listGrid.getRowActions().add(DefaultListGridActions.VIEW);
 668          }
 669          if (sortable) {
 670              listGrid.setCanFilterAndSort(false);
 671              listGrid.setIsSortable(true);
 672          }
 673  
 674          if (modalSingleSelectable) {
 675              if (readOnly) {
<abbr title=" 676                  listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(true));"> 676                  listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT.clone().withForListGridReadOnly(trðŸ”µ</abbr>
 677              } else {
 678                  listGrid.addModalRowAction(DefaultListGridActions.SINGLE_SELECT);
 679  
 680              }
 681          }
 682          listGrid.setSelectType(ListGrid.SelectType.SINGLE_SELECT);
 683  
 684          if (selectize) {
 685              listGrid.setSelectizeUrl(buildSelectizeUrl(listGrid));
 686              listGrid.setSelectType(ListGrid.SelectType.SELECTIZE);
 687          }
 688  
 689          if (modalMultiSelectable) {
 690              listGrid.addModalRowAction(DefaultListGridActions.MULTI_SELECT);
 691              listGrid.setSelectType(ListGrid.SelectType.MULTI_SELECT);
 692          }
 693          listGrid.getRowActions().add(DefaultListGridActions.REMOVE);
 694  
 695          if (fmd.getManualFetch()) {
 696              listGrid.setManualFetch(true);
 697              listGrid.getToolbarActions().add(DefaultListGridActions.MANUAL_FETCH);
 698          }
 699          if (isMedia) {
 700              listGrid.setListGridType(ListGrid.Type.ASSET_GRID);
 701          }
 702  
 703          extensionManager.getProxy().modifyListGrid(listGrid.getClassName(), listGrid);
 704  
<abbr title=" 705          //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface"> 705          //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the ðŸ”µ</abbr>
 706          if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title=" 707              EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();"> 707              EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvðŸ”µ</abbr>
<abbr title=" 708              for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {"> 708              for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getDatðŸ”µ</abbr>
 709                  for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
 710                      if (modifier.isQualified(data.getModifierType())) {
 711                          modifier.modifyListGrid(new EntityFormModifierRequest()
 712                                  .withListGrid(listGrid)
 713                                  .withConfiguration(data)
 714                                  .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
 715                                  .withRowLevelSecurityService(rowLevelSecurityService));
 716                      }
 717                  }
 718              }
 719          }
 720          return listGrid;
 721      }
 722  
 723      protected String getMapKeyFriendlyName(Property property) {
 724          String friendlyNameFromMetadata = property.getMetadata().getFriendlyName();
 725  
 726          return (friendlyNameFromMetadata == null) ? &quot;Key&quot; : friendlyNameFromMetadata;
 727      }
 728  
 729      @Override
<abbr title=" 730      public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, Property field,"> 730      public Map&lt;String, Object&gt; buildSelectizeCollectionInfo(String containingEntityId, DynamicResultSet drs, PropeðŸ”µ</abbr>
 731          String sectionKey, List&lt;SectionCrumb&gt; sectionCrumbs)
 732              throws ServiceException {
 733          FieldMetadata fmd = field.getMetadata();
 734          // Get the class metadata for this particular field
 735          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(fmd, sectionCrumbs);
 736          if (field != null) {
 737              ppr.setSectionEntityField(field.getName());
 738          }
 739          ClassMetadata cmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 740  
 741          Map&lt;String, Object&gt; result = constructSelectizeOptionMap(drs, cmd);
 742  
 743          AdornedTargetList adornedList = ppr.getAdornedList();
 744          if (adornedList != null &amp;&amp; adornedList.getLinkedObjectPath() != null
 745              &amp;&amp; adornedList.getTargetObjectPath() != null &amp;&amp; adornedList.getLinkedIdProperty() != null
 746              &amp;&amp; adornedList.getTargetIdProperty() != null) {
<abbr title=" 747              result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty());"> 747              result.put(&quot;linkedObjectPath&quot;, adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperðŸ”µ</abbr>
 748              result.put(&quot;linkedObjectId&quot;, containingEntityId);
<abbr title=" 749              result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());"> 749              result.put(&quot;targetObjectPath&quot;, adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperðŸ”µ</abbr>
 750          }
 751  
 752          return result;
 753      }
 754  
 755      @Override
 756      public Map&lt;String, Object&gt; constructSelectizeOptionMap(DynamicResultSet drs, ClassMetadata cmd) {
 757          Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
 758          List&lt;Map&lt;String, String&gt;&gt; options = new ArrayList&lt;&gt;();
 759  
 760          List&lt;Field&gt; headerFields = new ArrayList&lt;&gt;();
 761          for (Property p : cmd.getProperties()) {
 762              if (p.getMetadata() instanceof BasicFieldMetadata) {
 763                  BasicFieldMetadata md = (BasicFieldMetadata) p.getMetadata();
 764                  if (md.isProminent() != null &amp;&amp; md.isProminent()
 765                          &amp;&amp; !ArrayUtils.contains(getGridHiddenVisibilities(), md.getVisibility())) {
 766                      Field hf = createHeaderField(p, md);
 767                      headerFields.add(hf);
 768                  }
 769              }
 770          }
 771  
 772          for (Entity e : drs.getRecords()) {
 773              Map&lt;String, String&gt; selectizeOption = new HashMap&lt;&gt;();
 774              for (Field headerField : headerFields) {
 775                  Property p = e.findProperty(headerField.getName());
 776                  if (p != null) {
 777                      selectizeOption.put(&quot;name&quot;, p.getValue());
 778                      break;
 779                  }
 780              }
 781              if (e.findProperty(&quot;id&quot;) != null) {
 782                  selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;id&quot;).getValue());
 783              //  &quot;Locale&quot; entity is a special occasion. Because it have not &quot;ID&quot; column with &quot;Long&quot; type
 784              } else if (e.findProperty(&quot;localeCode&quot;) != null) {
 785                  selectizeOption.put(&quot;id&quot;, e.findProperty(&quot;localeCode&quot;).getValue());
 786              }
 787              if (e.findProperty(ALTERNATE_ID_PROPERTY) != null) {
 788                  selectizeOption.put(&quot;alternateId&quot;, e.findProperty(ALTERNATE_ID_PROPERTY).getValue());
 789              }
 790              options.add(selectizeOption);
 791          }
 792          result.put(&quot;options&quot;, options);
 793  
 794          return result;
 795      }
 796  
 797      protected String buildSelectizeUrl(ListGrid listGrid) {
 798          HttpServletRequest request = BroadleafRequestContext.getBroadleafRequestContext().getRequest();
 799          String url = request.getContextPath();
<abbr title=" 800          url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + listGrid.getSectionKey();"> 800          url += url.endsWith(&quot;/&quot;) || listGrid.getSectionKey().startsWith(&quot;/&quot;) ? listGrid.getSectionKey() : &quot;/&quot; + liðŸ”µ</abbr>
 801          url += &quot;/&quot; + listGrid.getContainingEntityId();
 802          url += &quot;/&quot; + listGrid.getSubCollectionFieldName();
 803          return url;
 804      }
 805  
 806      /**
<abbr title=" 807       * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 807       * @deprecated use {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, StriðŸ”µ</abbr>
 808       * @param className
 809       * @param headerFields
 810       * @param type
 811       * @param drs
 812       * @param sectionKey
 813       * @param order
 814       * @param idProperty
 815       * @param sectionCrumbs
 816       * @return
 817       */
 818      @Deprecated
<abbr title=" 819      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 819      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResulðŸ”µ</abbr>
 820              String sectionKey, int order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs) {
 821         return createListGrid(className,headerFields,type,drs,sectionKey,order,idProperty,sectionCrumbs,null);
 822      }
 823  
 824      /**
 825       * Populate a ListGrid with ListGridRecords.
 826       *
 827       * @param className
 828       * @param headerFields
 829       * @param type
 830       * @param drs
 831       * @param sectionKey
 832       * @param order
 833       * @param idProperty
 834       * @param sectionCrumbs
 835       * @param sortPropery
 836       * @return
 837       */
<abbr title=" 838      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResultSet drs,"> 838      protected ListGrid createListGrid(String className, List&lt;Field&gt; headerFields, ListGrid.Type type, DynamicResulðŸ”µ</abbr>
<abbr title=" 839              String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropery) {"> 839              String sectionKey, Integer order, String idProperty, List&lt;SectionCrumb&gt; sectionCrumbs, String sortPropðŸ”µ</abbr>
 840          // Create the list grid and set some basic attributes
 841          ListGrid listGrid = new ListGrid();
 842          listGrid.setClassName(className);
 843          listGrid.getHeaderFields().addAll(headerFields);
 844          listGrid.setListGridType(type);
 845          listGrid.setSectionCrumbs(sectionCrumbs);
 846          listGrid.setSectionKey(sectionKey);
 847          listGrid.setOrder(order);
 848          listGrid.setIdProperty(idProperty);
 849          listGrid.setStartIndex(drs.getStartIndex());
 850          listGrid.setTotalRecords(drs.getTotalRecords());
 851          listGrid.setPageSize(drs.getPageSize());
 852  
 853          String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
<abbr title=" 854          AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier);"> 854          AdminSection section = navigationService.findAdminSectionByClassAndSectionId(className, sectionIdentifier)ðŸ”µ</abbr>
 855          if (section != null) {
 856              listGrid.setExternalEntitySectionKey(section.getUrl());
 857          }
 858  
 859          // format date list grid cells
 860          SimpleDateFormat formatter = new SimpleDateFormat(&quot;MMM d, y @ hh:mma&quot;);
 861          DateFormatSymbols symbols = new DateFormatSymbols(Locale.getDefault());
 862          symbols.setAmPmStrings(new String[] { &quot;am&quot;, &quot;pm&quot; });
 863          formatter.setDateFormatSymbols(symbols);
 864  
 865          // For each of the entities (rows) in the list grid, we need to build the associated
 866          // ListGridRecord and set the required fields on the record. These fields are the same ones
 867          // that are used for the header fields.
 868          for (Entity e : drs.getRecords()) {
 869              ListGridRecord record = new ListGridRecord();
 870              record.setListGrid(listGrid);
 871              record.setDirty(e.isDirty());
 872              record.setEntity(e);
 873              if (StringUtils.isNotBlank(sortPropery) &amp;&amp; e.findProperty(sortPropery) != null) {
 874                  Property sort = e.findProperty(sortPropery);
 875                  record.setDisplayOrder(sort.getValue());
 876              }
 877              if (e.findProperty(&quot;hasError&quot;) != null) {
 878                  Boolean hasError = Boolean.parseBoolean(e.findProperty(&quot;hasError&quot;).getValue());
 879                  record.setIsError(hasError);
 880                  if (hasError) {
 881                      ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 882                              .getProxy().determineErrorMessageForEntity(e, record);
 883  
 884                      if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 885                          record.setErrorKey(&quot;listgrid.record.error&quot;);
 886                      }
 887                  }
 888              }
 889  
 890              if (e.findProperty(&quot;progressStatus&quot;) != null) {
 891                  ExtensionResultStatusType messageResultStatus = listGridErrorExtensionManager
 892                          .getProxy().determineStatusMessageForEntity(e, record);
 893                  if (ExtensionResultStatusType.NOT_HANDLED.equals(messageResultStatus)) {
 894                      record.setStatus(e.findProperty(&quot;progressStatus&quot;).getValue());
 895                      record.setStatusCssClass(&quot;listgrid.record.status&quot;);
 896                  }
 897              }
 898  
 899              if (e.findProperty(idProperty) != null) {
 900                  record.setId(e.findProperty(idProperty).getValue());
 901              }
 902  
 903              for (Field headerField : headerFields) {
 904                  Property p = e.findProperty(headerField.getName());
 905                  if (p != null) {
 906                      Field recordField = new Field().withName(headerField.getName())
 907                              .withFriendlyName(headerField.getFriendlyName())
 908                              .withOrder(p.getMetadata().getOrder());
 909  
 910                      if (headerField instanceof ComboField) {
 911                          recordField.setValue(((ComboField) headerField).getOption(p.getValue()));
 912                          recordField.setDisplayValue(p.getDisplayValue());
 913                      } else {
 914                          if (headerField.getFieldType().equals(&quot;DATE&quot;)) {
 915                              try {
 916                                  Date date = new SimpleDateFormat(&quot;yyyy.MM.dd HH:mm:ss&quot;).parse(p.getValue());
 917                                  String newValue = formatter.format(date);
 918                                  recordField.setValue(newValue);
 919                              } catch (Exception ex) {
 920                                  recordField.setValue(p.getValue());
 921                              }
 922                          } else {
 923                              recordField.setValue(p.getValue());
 924                          }
 925                          recordField.setDisplayValue(p.getDisplayValue());
 926                      }
 927  
 928                      recordField.setDerived(isDerivedField(headerField, recordField, p));
 929  
 930                      record.getFields().add(recordField);
 931                  }
 932              }
 933  
 934              if (e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY) != null) {
 935                  Field hiddenField = new Field().withName(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY);
 936                  hiddenField.setValue(e.findProperty(AdminMainEntity.MAIN_ENTITY_NAME_PROPERTY).getValue());
 937                  record.getHiddenFields().add(hiddenField);
 938              }
 939  
 940              if (e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY) != null) {
 941                  record.setAltId(e.findProperty(BasicPersistenceModule.ALTERNATE_ID_PROPERTY).getValue());
 942              }
 943  
 944              extensionManager.getProxy().modifyListGridRecord(className, record, e);
 945  
 946              listGrid.getRecords().add(record);
 947          }
 948  
 949          if (drs.getFirstId() != null) {
 950              listGrid.setFirstId(drs.getFirstId());
 951          }
 952          if (drs.getLastId() != null) {
 953              listGrid.setLastId(drs.getLastId());
 954          }
 955          if (drs.getUpperCount() != null) {
 956              listGrid.setUpperCount(drs.getUpperCount());
 957          }
 958          if (drs.getLowerCount() != null) {
 959              listGrid.setLowerCount(drs.getLowerCount());
 960          }
 961          if (drs.getFetchType() != null) {
 962              listGrid.setFetchType(drs.getFetchType().toString());
 963          }
 964          if (drs.getTotalCountLessThanPageSize() != null) {
 965              listGrid.setTotalCountLessThanPageSize(drs.getTotalCountLessThanPageSize());
 966          }
 967          if (drs.getPromptSearch() != null) {
 968              listGrid.setPromptSearch(drs.getPromptSearch());
 969          }
 970  
 971          return listGrid;
 972      }
 973  
 974      /**
<abbr title=" 975       * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasicFieldMetadata}"> 975       * Determines whether or not a particular field in a record is derived. By default this checks the {@link BasiðŸ”µ</abbr>
 976       * for the given Property to see if something on the backend has marked it as derived
 977       *
 978       * @param headerField the header for this recordField
 979       * @param recordField the recordField being populated
 980       * @param p the property that relates to this recordField
 981       * @return whether or not this field is derived
<abbr title=" 982       * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, String)}"> 982       * @see {@link #createListGrid(String, List, ListGrid.Type, DynamicResultSet, String, Integer, String, List, SðŸ”µ</abbr>
 983       */
 984      protected Boolean isDerivedField(Field headerField, Field recordField, Property p) {
 985          return BooleanUtils.isTrue(((BasicFieldMetadata) p.getMetadata()).getIsDerived());
 986      }
 987  
 988      protected void setEntityFormFields(ClassMetadata cmd, EntityForm ef, List&lt;Property&gt; properties) {
 989          List&lt;Field&gt; homelessFields = new ArrayList&lt;&gt;();
 990          List&lt;Field&gt; fieldsWithAssociations = new ArrayList&lt;&gt;();
 991  
 992          for (Property property : properties) {
 993              if (property.getMetadata() instanceof BasicFieldMetadata) {
 994                  BasicFieldMetadata fmd = (BasicFieldMetadata) property.getMetadata();
 995  
 996  
 997                  if (!ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
 998                      // Depending on visibility, field for the particular property is not created on the form
 999                      String fieldType = fmd.getFieldType() == null ? null : fmd.getFieldType().toString();
1000  
1001                      // Create the field and set some basic attributes
1002                      Field f;
1003  
1004                      if (fieldType.equals(SupportedFieldType.BROADLEAF_ENUMERATION.toString())
1005                              || fieldType.equals(SupportedFieldType.EXPLICIT_ENUMERATION.toString())
1006                              || fieldType.equals(SupportedFieldType.DATA_DRIVEN_ENUMERATION.toString())
1007                              || fieldType.equals(SupportedFieldType.EMPTY_ENUMERATION.toString())) {
<abbr title="1008                          // We&#x27;re dealing with fields that should render as drop-downs, so set their possible values">1008                          // We&#x27;re dealing with fields that should render as drop-downs, so set their possible valueðŸ”µ</abbr>
1009                          f = new ComboField();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1010 -                        ((ComboField) f).setOptions(fmd.getEnumerationValues());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1011 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1012 +                        String[][] enumerationValues = fmd.getEnumerationValues();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1013 +                        for(int i=0; i&lt; enumerationValues.length;i++){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="1014 +                            enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1]);">1014 +                            enumerationValues[i][1] = exploitProtectionService.htmlDecode(enumerationValues[i][1])ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1015 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1016 +                        ((ComboField) f).setOptions(enumerationValues);</span>
<abbr title="1017                          if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValue()">1017                          if (fmd.getHideEnumerationIfEmpty() != null &amp;&amp; fmd.getHideEnumerationIfEmpty().booleanValuðŸ”µ</abbr>
1018                                  &amp;&amp; ((ComboField) f).getOptions().size() == 0) {
1019                              f.setIsVisible(false);
1020                          }
1021                      } else if (fieldType.equals(SupportedFieldType.CODE.toString())) {
1022                          f = new CodeField();
1023                      } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1024                              || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1025                              || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1026                          // We&#x27;re dealing with rule builders, so we&#x27;ll create those specialized fields
1027                          f = new RuleBuilderField();
1028                          ((RuleBuilderField) f).setJsonFieldName(property.getName() + &quot;Json&quot;);
1029                          ((RuleBuilderField) f).setDataWrapper(new DataWrapper());
1030                          ((RuleBuilderField) f).setFieldBuilder(fmd.getRuleIdentifier());
1031                          ((RuleBuilderField) f).setDisplayType(fmd.getDisplayType().toString());
1032  
1033                          String blankJsonString =  &quot;{\&quot;data\&quot;:[]}&quot;;
1034                          ((RuleBuilderField) f).setJson(blankJsonString);
1035                          DataWrapper dw = convertJsonToDataWrapper(blankJsonString);
1036                          if (dw != null) {
1037                              ((RuleBuilderField) f).setDataWrapper(dw);
1038                          }
1039  
1040                          if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())) {
1041                              ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple&quot;);
1042                          } else if (fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1043                              ((RuleBuilderField) f).setRuleType(&quot;rule-builder-with-quantity&quot;);
1044                          } else if (fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())) {
1045                              ((RuleBuilderField) f).setRuleType(&quot;rule-builder-simple-time&quot;);
1046                          }
1047                      } else if (LookupType.DROPDOWN.equals(fmd.getLookupType())) {
<abbr title="1048                          // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of in a">1048                          // We&#x27;re dealing with a to-one field that wants to be rendered as a dropdown instead of inðŸ”µ</abbr>
<abbr title="1049                          // modal, so we&#x27;ll provision the combo field here. Available options will be set as part of a">1049                          // modal, so we&#x27;ll provision the combo field here. Available options will be set as part oðŸ”µ</abbr>
1050                          // subsequent operation
1051                          f = new ComboField();
1052                      } else if (fieldType.equals(SupportedFieldType.MEDIA.toString())) {
1053                          f = new MediaField();
1054                      } else {
1055                          // Create a default field since there was no specialized handler
1056                          f = new Field();
1057                      }
1058  
1059                      Boolean required = fmd.getRequiredOverride();
1060                      if (required == null) {
1061                          required = fmd.getRequired();
1062                      }
1063  
1064                      Boolean allowNoValueEnum = fmd.getAllowNoValueEnumOption();
1065                      if (allowNoValueEnum != null) {
1066                          f.setAllowNoValueEnumOption(allowNoValueEnum);
1067                      }
1068  
1069                      f.withName(property.getName())
1070                       .withFieldType(fieldType)
1071                       .withFieldComponentRenderer(getFieldComponentRenderer(fmd))
1072                       .withGridFieldComponentRenderer(getGridFieldComponentRenderer(fmd))
1073                       .withOrder(fmd.getOrder())
1074                       .withFriendlyName(fmd.getFriendlyName())
1075                       .withForeignKeyDisplayValueProperty(fmd.getForeignKeyDisplayValueProperty())
1076                       .withForeignKeyClass(fmd.getForeignKeyClass())
1077                       .withForeignKeySectionPath(getAdminSectionPath(fmd.getForeignKeyClass()))
<abbr title="1078                       .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromType())">1078                       .withOwningEntityClass(fmd.getOwningClass()!=null?fmd.getOwningClass():fmd.getInheritedFromTyðŸ”µ</abbr>
1079                       .withRequired(required)
1080                       .withReadOnly(fmd.getReadOnly())
1081                       .withTranslatable(fmd.getTranslatable())
1082                       .withAlternateOrdering((Boolean) fmd.getAdditionalMetadata().get(Field.ALTERNATE_ORDERING))
1083                       .withLargeEntry(fmd.isLargeEntry())
1084                       .withHint(fmd.getHint())
1085                       .withTooltip(fmd.getTooltip())
1086                       .withHelp(fmd.getHelpText())
1087                       .withTypeaheadEnabled(fmd.getEnableTypeaheadLookup())
1088                       .withCanLinkToExternalEntity(fmd.getCanLinkToExternalEntity())
1089                       .withAssociatedFieldName(fmd.getAssociatedFieldName());
1090  
1091                      String defaultValue = fmd.getDefaultValue();
1092                      if (defaultValue != null) {
1093                          defaultValue = extractDefaultValueFromFieldData(fieldType, fmd);
1094                          f.withValue(defaultValue);
1095                      }
1096  
1097                      if (StringUtils.isBlank(f.getFriendlyName())) {
1098                          f.setFriendlyName(f.getName());
1099                      }
1100  
1101                      // If is form hidden, set visible to false
1102                      if (VisibilityEnum.FORM_EXPLICITLY_HIDDEN.equals(fmd.getVisibility())) {
1103                          f.setIsVisible(false);
1104                      }
1105  
1106                      if (VisibilityEnum.VISIBLE_ALL.equals(fmd.getVisibility())) {
1107                          f.setIsVisible(true);
1108                      }
1109  
1110                      // Add the field to the appropriate FieldGroup
1111                      if (fmd.getGroup() == null) {
1112                          homelessFields.add(f);
1113                      } else {
1114                          ef.addField(cmd, f, fmd.getGroup(), fmd.getGroupOrder(), fmd.getTab(), fmd.getTabOrder());
1115                      }
1116  
1117                      if (StringUtils.isNotEmpty(fmd.getAssociatedFieldName())) {
1118                          fieldsWithAssociations.add(f);
1119                      }
1120                  }
1121              }
1122          }
1123  
1124          for (Field f : homelessFields) {
1125              ef.addField(cmd, f, null, null, null, null);
1126          }
1127  
1128          for (Field f : fieldsWithAssociations) {
1129              Field associatedField = findAssociatedField(ef, f);
1130              if (associatedField != null) {
1131                  associatedField.setShouldRender(false);
1132                  f.setAssociatedFieldName(associatedField.getName());
1133              } else {
1134                  f.setAssociatedFieldName(null);
1135              }
1136          }
1137      }
1138  
1139      protected String getFieldComponentRenderer(BasicFieldMetadata fmd) {
1140          if (StringUtils.isNotBlank(fmd.getFieldComponentRendererTemplate())) {
1141              return fmd.getFieldComponentRendererTemplate();
1142          }
1143          return fmd.getFieldComponentRenderer()==null?null:fmd.getFieldComponentRenderer().toString();
1144      }
1145  
1146      protected String getGridFieldComponentRenderer(BasicFieldMetadata fmd) {
1147          if (StringUtils.isNotBlank(fmd.getGridFieldComponentRendererTemplate())) {
1148              return fmd.getGridFieldComponentRendererTemplate();
1149          }
1150          return fmd.getGridFieldComponentRenderer()==null?null:fmd.getGridFieldComponentRenderer().toString();
1151      }
1152  
1153      private Field findAssociatedField(EntityForm ef, Field f) {
1154          // Try on the parent object
1155          Field associatedField = ef.findField(f.getAssociatedFieldName());
1156  
1157          if (associatedField == null) {
1158              // Check the field&#x27;s path
1159              String[] fieldPathParts = f.getName().split(&quot;\\.&quot;);
1160              String testPath = &quot;&quot;;
1161  
1162              for (String path : fieldPathParts) {
1163                  testPath += path + &quot;.&quot;;
1164  
1165                  associatedField = ef.findField(testPath + f.getAssociatedFieldName());
1166                  if (associatedField != null) {
1167                      break;
1168                  }
1169              }
1170          }
1171          return associatedField;
1172      }
1173  
1174      /**
1175       * This method gets the {@link AdminSection} for the given foreignKeyClass parameter. If none exists,
1176       * it returns the foreignKeyClass.
1177       *
1178       * @param foreignKeyClass the {@link String} class name
1179       * @return the admin section pathname
1180       */
1181      protected String getAdminSectionPath(String foreignKeyClass) {
1182          if (foreignKeyClass != null) {
<abbr title="1183              AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyClass, null);">1183              AdminSection foreignKeySection = adminNavigationService.findAdminSectionByClassAndSectionId(foreignKeyðŸ”µ</abbr>
1184              return foreignKeySection != null ? foreignKeySection.getUrl() : foreignKeyClass;
1185          }
1186          return null;
1187      }
1188  
1189      /**
<abbr title="1190       * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal to">1190       * NOTE: This method will attempt to merge tabs if the unprocessed {@link TabMetadata#getTabName()} is equal tðŸ”µ</abbr>
1191       *  the processed value of another tab.
1192       *
1193       * For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a another tab where
1194       *  {@link TabMetadata#getTabName()} is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;,
1195       *  then the tabs should be merged together, so that we do not end up rendering multiple &quot;Example&quot; tabs.
1196       */
1197      protected void setEntityFormTabsAndGroups(EntityForm ef, Map&lt;String, TabMetadata&gt; tabMetadataMap) {
1198          if (tabMetadataMap != null) {
1199              Set&lt;String&gt; tabMetadataKeySet = tabMetadataMap.keySet();
1200              for (String tabKey : tabMetadataKeySet) {
1201                  TabMetadata tabMetadata = tabMetadataMap.get(tabKey);
1202                  String unprocessedTabName = getUnprocessedNameOfMatchingTab(tabMetadata, tabMetadataKeySet);
1203  
1204                  if (foundMatchingTab(unprocessedTabName)) {
1205                      if (!tabExists(ef, unprocessedTabName)) {
1206                          TabMetadata originalTabMetadata = tabMetadataMap.get(unprocessedTabName);
1207                          unprocessedTabName = ef.addTabFromTabMetadata(originalTabMetadata);
1208                      }
1209                  } else {
1210                      if (tabExists(ef, tabKey)) {
1211                          unprocessedTabName = tabKey;
1212                      } else {
1213                          unprocessedTabName = ef.addTabFromTabMetadata(tabMetadata);
1214                      }
1215                  }
1216  
1217                  Set&lt;String&gt; groupMetadataKeySet = tabMetadata.getGroupMetadata().keySet();
1218                  for (String groupKey : groupMetadataKeySet) {
<abbr title="1219                      ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName);">1219                      ef.addGroupFromGroupMetadata(tabMetadata.getGroupMetadata().get(groupKey), unprocessedTabName)ðŸ”µ</abbr>
1220                  }
1221              }
1222          }
1223      }
1224  
1225      /**
1226       * Search for any other tab on the target entity that has the same display value
1227       *  as the value provided tab name.
1228       *
1229       * This assumes that the {@link TabMetadata#getTabName()} is in the form of a processed message property.
<abbr title="1230       *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySet">1230       *  For example, if {@link TabMetadata#getTabName()} is &quot;Example&quot;, there is a tabKey from the tabMetadataKeySeðŸ”µ</abbr>
1231       *  that is &quot;Example_Tab&quot;, and a message property where &#x27;Example_Tab=Example&#x27;, then this method should return
1232       *  &quot;Example_Tab&quot; which will end up causing the tabs to merge together.
1233       *
1234       * If a tab with the same display value cannot be found, then we should return null to indicate that there
1235       *  is no matching tab with the same processed tabName value.
1236       */
1237      protected String getUnprocessedNameOfMatchingTab(TabMetadata tabMetadata, Set&lt;String&gt; tabMetadataKeySet) {
1238          for (String tabKey : tabMetadataKeySet) {
1239              String tabName = tabMetadata.getTabName();
1240  
1241              if (processedTabKeyMatchesTabName(tabName, tabKey)) {
1242                  return tabKey;
1243              }
1244          }
1245  
1246          return null;
1247      }
1248  
1249      protected boolean processedTabKeyMatchesTabName(String tabName, String candidateTabKey) {
1250          try {
1251              String processedCandidateTabKey = BLCMessageUtils.getMessage(candidateTabKey);
1252              boolean candidateTabKeyWasProcessed = !StringUtils.equals(candidateTabKey, processedCandidateTabKey);
1253  
1254              return candidateTabKeyWasProcessed &amp;&amp; StringUtils.equalsIgnoreCase(tabName, processedCandidateTabKey);
1255          } catch (NoSuchMessageException e) {
1256              LOG.debug(&quot;No such message exists for &quot; + candidateTabKey, e);
1257  
1258              return false;
1259          }
1260      }
1261  
1262      protected boolean foundMatchingTab(String unprocessedTabName) {
1263          return (unprocessedTabName != null);
1264      }
1265  
1266      protected boolean tabExists(EntityForm ef, String tabKey) {
1267          return (ef.findTab(tabKey) != null);
1268      }
1269  
1270      @Override
1271      public String extractDefaultValueFromFieldData(String fieldType, BasicFieldMetadata fmd) {
1272          String defaultValue = fmd.getDefaultValue();
1273          if (fieldType.equals(SupportedFieldType.RULE_SIMPLE.toString())
1274                  || fieldType.equals(SupportedFieldType.RULE_SIMPLE_TIME.toString())
1275                  || fieldType.equals(SupportedFieldType.RULE_WITH_QUANTITY.toString())) {
1276              return null;
1277          } else if (fieldType.equals(SupportedFieldType.INTEGER.toString())) {
1278              try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1279 -                Integer.parseInt(defaultValue);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1280 -            } catch (NumberFormatException  e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="1281 +                DecimalFormat numberFormat = (DecimalFormat) NumberFormat.getInstance(BroadleafRequestContext.getBroadleafRequestContext().getJavaLocale());">1281 +                DecimalFormat numberFormat = (DecimalFormat) NumberFormat.getInstance(BroadleafRequestContext.getBðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1282 +                Number parse = numberFormat.parse(defaultValue);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1283 +            } catch (NumberFormatException | ParseException e) {</span>
1284                  String msg = buildMsgForDefValException(SupportedFieldType.INTEGER.toString(), fmd, defaultValue);
1285                  LOG.debug(msg);
1286                  return null;
1287              }
1288          } else if (fieldType.equals(SupportedFieldType.DECIMAL.toString())
1289                  || fieldType.equals(SupportedFieldType.MONEY.toString())) {
1290              try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1291 -                BigDecimal val = new BigDecimal(defaultValue);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1292 -            } catch (NumberFormatException  e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="1293 +                DecimalFormat numberFormat = (DecimalFormat) NumberFormat.getInstance(BroadleafRequestContext.getBroadleafRequestContext().getJavaLocale());">1293 +                DecimalFormat numberFormat = (DecimalFormat) NumberFormat.getInstance(BroadleafRequestContext.getBðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1294 +                numberFormat.setParseBigDecimal(true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1295 +                Number parse = numberFormat.parse(defaultValue);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1296 +            } catch (NumberFormatException | ParseException e) {</span>
1297                  String msg = buildMsgForDefValException(fieldType.toString(), fmd, defaultValue);
1298                  LOG.debug(msg);
1299                  return null;
1300              }
1301          } else if (fieldType.equals(SupportedFieldType.BOOLEAN.toString())) {
1302              if (!defaultValue.toLowerCase().equals(&quot;true&quot;) &amp;&amp; !defaultValue.toLowerCase().equals(&quot;false&quot;)
1303                      &amp;&amp; !defaultValue.toUpperCase().equals(&quot;Y&quot;) &amp;&amp; !defaultValue.toUpperCase().equals(&quot;N&quot;)) {
1304                  String msg = buildMsgForDefValException(SupportedFieldType.BOOLEAN.toString(), fmd, defaultValue);
1305                  LOG.debug(msg);
1306                  return null;
1307              }
1308          } else if (fieldType.equals(SupportedFieldType.DATE.toString())) {
1309              DateFormat format = FormatUtil.getDateFormat();
1310              if (defaultValue.toLowerCase().contains(&quot;today&quot;)) {
1311                  defaultValue = format.format(new Date());
1312              } else {
1313                  try {
1314                      Date date = format.parse(defaultValue);
1315                      defaultValue = format.format(date);
1316                  } catch (ParseException e) {
<abbr title="1317                      String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue);">1317                      String msg = buildMsgForDefValException(SupportedFieldType.DATE.toString(), fmd, defaultValue)ðŸ”µ</abbr>
1318                      LOG.debug(msg);
1319                      return null;
1320                  }
1321              }
1322          }
1323          return defaultValue;
1324      }
1325  
1326      protected String buildMsgForDefValException(String type, BasicFieldMetadata fmd, String defaultValue) {
<abbr title="1327          return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - Failed to parse &quot;">1327          return StringUtil.sanitize(fmd.getTargetClass()) + &quot; : &quot; + StringUtil.sanitize(fmd.getName()) + &quot; - FailedðŸ”µ</abbr>
1328                  + StringUtil.sanitize(type) + &quot; from DefaultValue [ &quot; + StringUtil.sanitize(defaultValue) + &quot; ]&quot;;
1329      }
1330  
1331      @Override
1332      public void removeNonApplicableFields(ClassMetadata cmd, EntityForm entityForm, String entityType) {
1333          for (Property p : cmd.getProperties()) {
1334              if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entityType)) {
1335                  entityForm.removeField(p.getName());
1336              }
1337          }
1338      }
1339  
1340      @Override
1341      public EntityForm createEntityForm(ClassMetadata cmd, List&lt;SectionCrumb&gt; sectionCrumbs)
1342              throws ServiceException {
1343          EntityForm ef = createStandardEntityForm();
1344          populateEntityForm(cmd, ef, sectionCrumbs);
1345          return ef;
1346      }
1347  
1348      protected String extractSectionIdentifierFromCrumb(List&lt;SectionCrumb&gt; sectionCrumbs) {
1349          if (sectionCrumbs != null &amp;&amp; sectionCrumbs.size() &gt; 0) {
1350              return sectionCrumbs.get(0).getSectionIdentifier();
1351          } else {
1352              return null;
1353          }
1354      }
1355  
1356      @Override
1357      public void populateEntityForm(ClassMetadata cmd, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)
1358              throws ServiceException {
1359          ef.setCeilingEntityClassname(cmd.getCeilingType());
1360  
1361          String sectionIdentifier = extractSectionIdentifierFromCrumb(sectionCrumbs);
1362  
1363          AdminSection section = navigationService.findAdminSectionByClassAndSectionId(cmd.getCeilingType(),
1364                  sectionIdentifier);
1365          if (section != null) {
1366              ef.setSectionKey(section.getUrl());
1367          } else {
1368              ef.setSectionKey(cmd.getCeilingType());
1369          }
1370          ef.setSectionCrumbsImpl(sectionCrumbs);
1371  
1372          setEntityFormTabsAndGroups(ef, cmd.getTabAndGroupMetadata());
1373  
1374          setEntityFormFields(cmd, ef, Arrays.asList(cmd.getProperties()));
1375  
1376          populateDropdownToOneFields(ef, cmd);
1377  
1378          extensionManager.getProxy().modifyUnpopulatedEntityForm(ef);
1379      }
1380  
1381      /**
1382       * This method is invoked when EntityForms are created and is meant to provide a hook to add
1383       * additional entity form actions for implementors of Broadleaf. Broadleaf modules will typically
1384       * leverage {@link FormBuilderExtensionHandler#addAdditionalFormActions(EntityForm)} method.
1385       * @param ef
1386       */
1387      protected void addAdditionalFormActions(EntityForm ef) {
1388  
1389      }
1390  
1391      @Override
1392      public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, List&lt;SectionCrumb&gt; sectionCrumbs)
1393              throws ServiceException {
1394          EntityForm ef = createStandardEntityForm();
1395          populateEntityForm(cmd, entity, ef, sectionCrumbs);
1396          addAdditionalFormActions(ef);
1397          extensionManager.getProxy().addAdditionalFormActions(ef);
1398          return ef;
1399      }
1400  
1401      @Override
<abbr title="1402      public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1402      public void populateEntityForm(ClassMetadata cmd, Entity entity, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumðŸ”µ</abbr>
1403              throws ServiceException {
1404          // Get the empty form with appropriate fields
1405          populateEntityForm(cmd, ef, sectionCrumbs);
1406  
1407          String idProperty = adminEntityService.getIdProperty(cmd);
1408          ef.setId(entity.findProperty(idProperty).getValue());
1409          ef.setEntityType(entity.getType()[0]);
1410  
1411          populateEntityFormFieldValues(cmd, entity, ef);
1412  
1413          Property p = entity.findProperty(BasicPersistenceModule.MAIN_ENTITY_NAME_PROPERTY);
1414          if (p != null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1415 -            ef.setMainEntityName(p.getValue());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1416 +            ef.setMainEntityName(exploitProtectionService.htmlDecode(p.getValue()));</span>
1417          }
1418  
1419          extensionManager.getProxy().modifyPopulatedEntityForm(ef, entity);
1420      }
1421  
1422      protected void setVisibilityBasedOnShowIfFieldEquals(ClassMetadata cmd, Entity entity, EntityForm ef) {
1423          for (Property p : cmd.getProperties()) {
1424              FieldMetadata fmd = p.getMetadata();
1425  
1426              if (shouldHideField(fmd, entity)) {
1427                  if (fmd instanceof CollectionMetadata) {
1428                      ef.removeListGrid(p.getName());
1429                  } else {
1430                      ef.removeField(p.getName());
1431                  }
1432              }
1433          }
1434      }
1435  
1436      protected boolean shouldHideField(FieldMetadata fmd, Entity entity) {
1437          if (fmd == null || fmd.getShowIfFieldEquals() == null) {
1438              return false;
1439          }
1440  
1441          for (String property : fmd.getShowIfFieldEquals().keySet()) {
1442              List&lt;String&gt; values = fmd.getShowIfFieldEquals().get(property);
1443              Property entityProp = entity.findProperty(property);
1444  
1445              if (entityProp == null || values.contains(entityProp.getValue())) {
1446                  return false;
1447              }
1448          }
1449          return true;
1450      }
1451  
1452      @Override
1453      public void populateEntityFormFieldValues(ClassMetadata cmd, Entity entity, EntityForm ef) {
1454          // Set the appropriate property values
1455          for (Property p : cmd.getProperties()) {
1456              if (p.getMetadata() instanceof BasicFieldMetadata) {
1457                  BasicFieldMetadata basicFM = (BasicFieldMetadata) p.getMetadata();
1458  
1459                  Property entityProp = entity.findProperty(p.getName());
1460  
1461                  boolean explicitlyShown = VisibilityEnum.FORM_EXPLICITLY_SHOWN.equals(basicFM.getVisibility());
1462                  //always show special map fields
1463                  if (p.getName().equals(&quot;key&quot;) || p.getName().equals(&quot;priorKey&quot;)) {
1464                      explicitlyShown = true;
1465                  }
1466  
1467                  if (entityProp == null &amp;&amp; explicitlyShown) {
1468                      Field field = ef.findField(p.getName());
1469                      if (field != null) {
1470                          field.setValue(null);
1471                      }
<abbr title="1472                  } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {">1472                  } else if (entityProp == null &amp;&amp; !SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFiðŸ”µ</abbr>
1473                      ef.removeField(p.getName());
1474                  } else {
1475                      Field field = ef.findField(p.getName());
1476                      if (field != null) {
1477                          if (entityProp != null) {
<abbr title="1478                              //protect against null - can happen with password confirmation fields (i.e. admin user)">1478                              //protect against null - can happen with password confirmation fields (i.e. admin userðŸ”µ</abbr>
1479                              field.setDirty(entityProp.getIsDirty());
1480                          }
1481                          if (basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE
1482                                  || basicFM.getFieldType()==SupportedFieldType.RULE_SIMPLE_TIME
1483                                  || basicFM.getFieldType()==SupportedFieldType.RULE_WITH_QUANTITY) {
1484                              RuleBuilderField rbf = (RuleBuilderField) field;
1485                              if (entity.getPMap().containsKey(rbf.getJsonFieldName())) {
1486                                  String json = entity.getPMap().get(rbf.getJsonFieldName()).getValue();
1487                                  rbf.setJson(json);
1488                                  DataWrapper dw = convertJsonToDataWrapper(json);
1489                                  if (dw != null) {
1490                                      rbf.setDataWrapper(dw);
1491                                  }
1492                              }
1493                          }
1494                          if (basicFM.getFieldType() == SupportedFieldType.MEDIA) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1495 -                            field.setValue(entityProp.getValue());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1496 +                            field.setValue(exploitProtectionService.htmlDecode(entityProp.getValue()));</span>
1497                              field.setDisplayValue(entityProp.getDisplayValue());
1498                              MediaField mf = (MediaField) field;
<abbr title="1499                              Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(), MediaDto.class);">1499                              Class&lt;MediaDto&gt; type = entityConfiguration.lookupEntityClass(MediaDto.class.getName(),ðŸ”µ</abbr>
<abbr title="1500                              mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(), type));">1500                              mf.setMedia(mediaBuilderService.convertJsonToMedia(entityProp.getUnHtmlEncodedValue(),ðŸ”µ</abbr>
1501                          } else if (!SupportedFieldType.PASSWORD_CONFIRM.equals(basicFM.getExplicitFieldType())) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1502 -                            field.setValue(entityProp.getValue());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="1503 +                            field.setValue((basicFM.isLargeEntry() != null &amp;&amp; basicFM.isLargeEntry()) ? entityProp.getValue() : exploitProtectionService.htmlDecode(entityProp.getValue()));">1503 +                            field.setValue((basicFM.isLargeEntry() != null &amp;&amp; basicFM.isLargeEntry()) ? entityPropðŸ”µ</abbr></span>
1504                              field.setDisplayValue(entityProp.getDisplayValue());
1505                          }
1506                      }
1507                  }
1508              }
1509          }
1510      }
1511  
1512      /**
1513       * When using Thymeleaf, we need to convert the JSON string back to
1514       * a DataWrapper object because Thymeleaf escapes JSON strings.
1515       * Thymeleaf uses it&#x27;s own object de-serializer
1516       * see: https://github.com/thymeleaf/thymeleaf/issues/84
1517       * see: http://forum.thymeleaf.org/Spring-Javascript-and-escaped-JSON-td4024739.html
1518       * @param json
1519       * @return DataWrapper
1520       * @throws IOException
1521       */
1522      protected DataWrapper convertJsonToDataWrapper(String json) {
1523          ObjectMapper mapper = new ObjectMapper();
1524          DataDTODeserializer dtoDeserializer = new DataDTODeserializer();
<abbr title="1525          SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null));">1525          SimpleModule module = new SimpleModule(&quot;DataDTODeserializerModule&quot;, new Version(1, 0, 0, null, null, null)ðŸ”µ</abbr>
1526          module.addDeserializer(DataDTO.class, dtoDeserializer);
1527          mapper.registerModule(module);
1528          try {
1529              return mapper.readValue(json, DataWrapper.class);
1530          } catch (IOException e) {
1531              throw new RuntimeException(e);
1532          }
1533      }
1534  
1535      protected void populateDropdownToOneFields(EntityForm ef, ClassMetadata cmd)
1536              throws ServiceException {
1537          for (Property p : cmd.getProperties()) {
1538              if (p.getMetadata() instanceof BasicFieldMetadata) {
1539                  BasicFieldMetadata fmd = (BasicFieldMetadata) p.getMetadata();
1540                  if (LookupType.DROPDOWN.equals(fmd.getLookupType())
1541                          &amp;&amp; !ArrayUtils.contains(getFormHiddenVisibilities(), fmd.getVisibility())) {
1542                      // Get the records
1543                      PersistencePackageRequest toOnePpr = PersistencePackageRequest.standard()
1544                              .withCeilingEntityClassname(fmd.getForeignKeyClass());
1545                      Entity[] rows = adminEntityService.getRecords(toOnePpr).getDynamicResultSet().getRecords();
1546  
1547                      // Determine the id field
1548                      String idProp = null;
<abbr title="1549                      ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSet().getClassMetaData();">1549                      ClassMetadata foreignClassMd = adminEntityService.getClassMetadata(toOnePpr).getDynamicResultSðŸ”µ</abbr>
1550                      for (Property foreignP : foreignClassMd.getProperties()) {
1551                          if (foreignP.getMetadata() instanceof BasicFieldMetadata) {
1552                              BasicFieldMetadata foreignFmd = (BasicFieldMetadata) foreignP.getMetadata();
1553                              if (SupportedFieldType.ID.equals(foreignFmd.getFieldType())) {
1554                                  idProp = foreignP.getName();
1555                              }
1556                          }
1557                      }
1558  
1559                      if (idProp == null) {
<abbr title="1560                          throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClass());">1560                          throw new RuntimeException(&quot;Could not determine ID property for &quot; + fmd.getForeignKeyClassðŸ”µ</abbr>
1561                      }
1562  
1563                      // Determine the display field
1564                      String displayProp = fmd.getLookupDisplayProperty();
1565  
1566                      // Build the options map
1567                      Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
1568                      for (Entity row : rows) {
1569                          Property prop = row.findProperty(displayProp);
1570                          if (prop == null) {
<abbr title="1571                              LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entity [&quot; +">1571                              LOG.warn(&quot;Could not find displayProp [&quot; + StringUtil.sanitize(displayProp) + &quot;] on entðŸ”µ</abbr>
1572                                      ef.getCeilingEntityClassname() + &quot;]&quot;);
1573                          } else {
1574                              String displayValue = prop.getDisplayValue();
1575                              if (StringUtils.isBlank(displayValue)) {
1576                                  displayValue = prop.getValue();
1577                              }
1578                              options.put(row.findProperty(idProp).getValue(), displayValue);
1579                          }
1580                      }
1581  
1582                      // Set the options on the entity field
1583                      ComboField cf = (ComboField) ef.findField(p.getName());
1584                      cf.setOptions(options);
1585                  }
1586              }
1587          }
1588      }
1589  
1590      @Override
<abbr title="1591      public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, List&lt;SectionCrumb&gt; sectionCrumbs)">1591      public EntityForm createEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRðŸ”µ</abbr>
1592              throws ServiceException {
1593          EntityForm ef = createStandardEntityForm();
1594          populateEntityForm(cmd, entity, collectionRecords, ef, sectionCrumbs);
1595          addAdditionalFormActions(ef);
1596          extensionManager.getProxy().addAdditionalFormActions(ef);
1597          return ef;
1598      }
1599  
1600      @Override
<abbr title="1601      public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecords, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs)">1601      public void populateEntityForm(ClassMetadata cmd, Entity entity, Map&lt;String, DynamicResultSet&gt; collectionRecorðŸ”µ</abbr>
1602              throws ServiceException {
1603          // Get the form with values for this entity
1604          populateEntityForm(cmd, entity, ef, sectionCrumbs);
1605  
1606          // Attach the sub-collection list grids and specialty UI support
1607          for (Property p : cmd.getProperties()) {
1608              if (p.getMetadata() instanceof BasicFieldMetadata) {
1609                  continue;
1610              }
1611  
1612              if (!ArrayUtils.contains(p.getMetadata().getAvailableToTypes(), entity.getType()[0])) {
1613                  continue;
1614              }
1615  
1616              if (collectionRecords != null &amp;&amp; !collectionRecords.isEmpty()) {
1617                  DynamicResultSet subCollectionEntities = collectionRecords.get(p.getName());
1618                  String containingEntityId = entity.getPMap().get(ef.getIdProperty()).getValue();
<abbr title="1619                  ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSectionKey(), sectionCrumbs);">1619                  ListGrid listGrid = buildCollectionListGrid(containingEntityId, subCollectionEntities, p, ef.getSeðŸ”µ</abbr>
1620  
1621                  CollectionMetadata md = ((CollectionMetadata) p.getMetadata());
1622                  if (md instanceof BasicCollectionMetadata) {
1623                      PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1624                      ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1624                      ClassMetadata collectionCmd = adminEntityService.getClassMetadata(ppr).getDynamicResultSet().gðŸ”µ</abbr>
1625                      if (collectionCmd.getPolymorphicEntities().getChildren().length != 0) {
<abbr title="1626                          List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTrees();">1626                          List&lt;ClassTree&gt; entityTypes = collectionCmd.getPolymorphicEntities().getCollapsedClassTreeðŸ”µ</abbr>
1627                          ListGridActionGroup actionGroup = new ListGridActionGroup().withName(&quot;Add&quot;);
1628                          for (ClassTree entityType : entityTypes) {
1629                              ListGridAction ADD = new ListGridAction(ListGridAction.ADD)
1630                                      .withButtonClass(AddMethodType.PERSIST_EMPTY==
<abbr title="1631                                              ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-grid-add-empty&quot;:&quot;sub-list-grid-add&quot;)">1631                                              ((BasicCollectionMetadata) md).getAddMethodType()?&quot;sub-list-grid-add-eðŸ”µ</abbr>
1632                                      .withActionTargetEntity(entityType.getFullyQualifiedClassname())
1633                                      .withUrlPostfix(&quot;/add&quot;)
1634                                      .withIconClass(&quot;fa fa-plus&quot;)
1635                                      .withDisplayText(BLCMessageUtils.getMessage(entityType.getFriendlyName()));
1636                              actionGroup.getListGridActions().add(0, ADD);
1637                          }
1638                          listGrid.addToolbarActionGroup(actionGroup);
1639                      } else {
1640                          listGrid.getToolbarActions().add(0, AddMethodType.PERSIST_EMPTY==
<abbr title="1641                                  ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ADD_EMPTY:DefaultListGridActions.ADD);">1641                                  ((BasicCollectionMetadata) md).getAddMethodType()?DefaultListGridActions.ADD_EMPTYðŸ”µ</abbr>
1642                      }
1643                  } else {
1644                      listGrid.getToolbarActions().add(0, DefaultListGridActions.ADD);
1645                  }
1646  
1647                  if (subCollectionEntities.getUnselectedTabMetadata().get(md.getTab())!=null) {
1648                      ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), true);
1649                  } else {
1650                      ef.addListGrid(cmd, listGrid, md.getTab(), md.getTabOrder(), md.getGroup(), false);
1651                  }
1652              }
1653          }
1654  
1655          if (CollectionUtils.isEmpty(ef.getActions())) {
1656              ef.addAction(DefaultEntityFormActions.SAVE);
1657          }
1658  
1659          addDeleteActionIfAllowed(ef, cmd, entity);

1660          setReadOnlyState(ef, cmd, entity);
1661  
1662          // check for fields that should be hidden based on annotations
1663          setVisibilityBasedOnShowIfFieldEquals(cmd, entity, ef);
1664  
1665          extensionManager.getProxy().modifyDetailEntityForm(ef);
1666      }
1667  
1668      /**
<abbr title="1669       * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The user can">1669       * Adds the {@link DefaultEntityFormActions#DELETE} if the user is allowed to delete the &lt;b&gt;entity&lt;/b&gt;. The usðŸ”µ</abbr>
1670       * delete an entity for the following cases:
1671       * &lt;ol&gt;
1672       *  &lt;li&gt;The user has the security to {@link EntityOperationType#REMOVE} the given class name represented by
1673       *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;
1674       *  &lt;li&gt;The user has the security necessary to delete the given &lt;b&gt;entity&lt;/b&gt; according to the
1675       *  {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}&lt;/li&gt;
1676       * &lt;/ol&gt;
1677       *
1678       * @param entityForm the form being generated
1679       * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1680       * @param entity the entity being edited
1681       * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1682       * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1683       * @see {@link RowLevelSecurityService#canRemove(AdminUser, Entity)}
1684       */
1685      protected void addDeleteActionIfAllowed(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1686          boolean canDelete = true;







1687          try {
1688              String securityEntityClassname = getSecurityClassname(entityForm, cmd);
1689              adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.REMOVE);


1690          } catch (ServiceException e) {
1691              if (e instanceof SecurityServiceException) {
1692                  canDelete = false;
1693              }
1694          }
1695  
1696          // If I cannot update a record then I certainly cannot delete it either
1697          if (canDelete) {
<abbr title="1698              canDelete = rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1698              canDelete = rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entðŸ”µ</abbr>
1699          }
1700  
1701          if (canDelete) {
<abbr title="1702              canDelete = rowLevelSecurityService.canRemove(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1702              canDelete = rowLevelSecurityService.canRemove(adminRemoteSecurityService.getPersistentAdminUser(), entðŸ”µ</abbr>
1703          }
1704  
1705          if (canDelete) {
1706              entityForm.addAction(DefaultEntityFormActions.DELETE);
1707          }

































1708      }
1709  
1710      /**
1711       * The given &lt;b&gt;entityForm&lt;/b&gt; is marked as readonly for the following cases:
1712       * &lt;ol&gt;
1713       *  &lt;li&gt;All of the properties from &lt;b&gt;cmd&lt;/b&gt; are readonly&lt;/b&gt;&lt;/li&gt;
<abbr title="1714       *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represented by">1714       *  &lt;li&gt;The user does not have the security to {@link EntityOperationType#UPDATE} the given class name represeðŸ”µ</abbr>
1715       *  the &lt;b&gt;entityForm&lt;/b&gt; (determined by {@link #getSecurityClassname(EntityForm, ClassMetadata)})&lt;/li&gt;
1716       *  &lt;li&gt;The user does not have the security necessary to modify the given &lt;b&gt;entity&lt;/b&gt; according to the
1717       *  {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}&lt;/li&gt;
1718       * &lt;/ol&gt;
1719       *
1720       * @param entityForm the form being generated
1721       * @param cmd the metatadata used to build the &lt;b&gt;entityForm&lt;/b&gt; for the &lt;b&gt;entity&lt;/b&gt;
1722       * @param entity the entity being edited
1723       * @see {@link SecurityVerifier#securityCheck(String, EntityOperationType)}
1724       * @see {@link #getSecurityClassname(EntityForm, ClassMetadata)}
1725       * @see {@link RowLevelSecurityService#canUpdate(AdminUser, Entity)}
1726       */
1727      protected void setReadOnlyState(EntityForm entityForm, ClassMetadata cmd, Entity entity) {
1728          boolean readOnly = true;
1729  
1730          // If all of the fields are read only, we&#x27;ll mark the form as such
1731          for (Property property : cmd.getProperties()) {
1732              FieldMetadata fieldMetadata = property.getMetadata();
1733              if (fieldMetadata instanceof BasicFieldMetadata) {
<abbr title="1734                  readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieldMetadata).getReadOnly();">1734                  readOnly = ((BasicFieldMetadata) fieldMetadata).getReadOnly() != null &amp;&amp; ((BasicFieldMetadata) fieðŸ”µ</abbr>
1735                  if (!readOnly) {
1736                      break;
1737                  }
1738              } else {
1739                  readOnly = ((CollectionMetadata) fieldMetadata).isMutable();
1740                  if (!readOnly) {
1741                      break;
1742                  }
1743              }
1744          }
1745  
1746          if (!readOnly) {
<abbr title="1747              // If the user does not have edit permissions, we will go ahead and make the form read only to prevent confusion">1747              // If the user does not have edit permissions, we will go ahead and make the form read only to preventðŸ”µ</abbr>
1748              try {
1749                  String securityEntityClassname = getSecurityClassname(entityForm, cmd);
1750                  adminRemoteSecurityService.securityCheck(securityEntityClassname, EntityOperationType.UPDATE);
1751              } catch (ServiceException e) {
1752                  if (e instanceof SecurityServiceException) {
1753                      readOnly = true;
1754                  }
1755              }
1756          }
1757  
<abbr title="1758          // if the normal admin security service has not deemed this readonly and the all of the properties on the entity">1758          // if the normal admin security service has not deemed this readonly and the all of the properties on the ðŸ”µ</abbr>
1759          // are not readonly, then check the row-level security
1760          if (!readOnly) {
<abbr title="1761              readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entity);">1761              readOnly = !rowLevelSecurityService.canUpdate(adminRemoteSecurityService.getPersistentAdminUser(), entðŸ”µ</abbr>
1762          }
1763  
1764          if (readOnly) {
1765              entityForm.setReadOnly();
<abbr title="1766              //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements the expected interface">1766              //If someone has replaced RowLevelSecurityService, check here to make sure the replacement implements ðŸ”µ</abbr>
1767              if (rowLevelSecurityService instanceof ExceptionAwareRowLevelSecurityProvider) {
<abbr title="1768                  EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityProvider) rowLevelSecurityService).getUpdateDenialExceptions();">1768                  EntityFormModifierConfiguration entityFormModifierConfiguration = ((ExceptionAwareRowLevelSecurityðŸ”µ</abbr>
<abbr title="1769                  for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.getData()) {">1769                  for (EntityFormModifierData&lt;EntityFormModifierDataPoint&gt; data : entityFormModifierConfiguration.geðŸ”µ</abbr>
1770                      for (EntityFormModifier modifier : entityFormModifierConfiguration.getModifier()) {
1771                          if (modifier.isQualified(data.getModifierType())) {
1772                              modifier.modifyEntityForm(new EntityFormModifierRequest()
1773                                      .withEntityForm(entityForm)
1774                                      .withConfiguration(data)
1775                                      .withCurrentUser(adminRemoteSecurityService.getPersistentAdminUser())
1776                                      .withEntity(entity)
1777                                      .withRowLevelSecurityService(rowLevelSecurityService));
1778                          }
1779                      }
1780                  }
1781              }
1782          }
1783      }
1784  
1785      /**
1786       * Obtains the class name suitable for passing along to the {@link SecurityVerifier}
1787       * @param entityForm
1788       * @param cmd
1789       * @return
1790       */
1791      protected String getSecurityClassname(EntityForm entityForm, ClassMetadata cmd) {
1792          String securityEntityClassname = entityForm.getCeilingEntityClassname();
1793  
1794          if (!StringUtils.isEmpty(cmd.getSecurityCeilingType())) {
1795              securityEntityClassname = cmd.getSecurityCeilingType();
1796          } else {
1797              if (entityForm.getDynamicFormInfos() != null) {
1798                  for (DynamicEntityFormInfo info : entityForm.getDynamicFormInfos().values()) {
1799                      if (!StringUtils.isEmpty(info.getSecurityCeilingClassName())) {
1800                          securityEntityClassname = info.getSecurityCeilingClassName();
1801                          break;
1802                      }
1803                  }
1804              }
1805          }
1806  
1807          return securityEntityClassname;
1808      }
1809  
1810      @Override
1811      public void populateEntityFormFields(EntityForm ef, Entity entity) {
1812          populateEntityFormFields(ef, entity, true, true);
1813      }
1814  
1815      @Override
1816      public void populateEntityFormFields(EntityForm ef, Entity entity, boolean populateType, boolean populateId) {
1817          if (populateId) {
1818              ef.setId(entity.findProperty(ef.getIdProperty()).getValue());
1819          }
1820          if (populateType) {
1821              ef.setEntityType(entity.getType()[0]);
1822          }
1823  
1824          for (Entry&lt;String, Field&gt; entry : ef.getFields().entrySet()) {
1825              Property entityProp = entity.findProperty(entry.getKey());
1826              if (entityProp != null) {
1827                  entry.getValue().setValue(entityProp.getValue());
1828                  entry.getValue().setDisplayValue(entityProp.getDisplayValue());
1829              }
1830          }
1831      }
1832  
1833      @Override
1834      public void populateAdornedEntityFormFields(EntityForm ef, Entity entity, AdornedTargetList adornedList) {
1835          Field field = ef.findField(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty());
1836          Property entityProp = entity.findProperty(ef.getIdProperty());
1837          field.setValue(entityProp.getValue());
1838  
1839          if (StringUtils.isNotBlank(adornedList.getSortField())) {
1840              field = ef.findField(adornedList.getSortField());
1841              entityProp = entity.findProperty(adornedList.getSortField());
1842              if (field != null &amp;&amp; entityProp != null) {
1843                  field.setValue(entityProp.getValue());
1844              }
1845          }
1846      }
1847  
1848      @Override
1849      public void populateMapEntityFormFields(EntityForm ef, Entity entity) {
1850          Field field = ef.findField(&quot;priorKey&quot;);
1851          Property entityProp = entity.findProperty(&quot;key&quot;);
1852          if (field != null &amp;&amp; entityProp != null) {
1853              field.setValue(entityProp.getValue());
1854          }
1855      }
1856  
1857      @Override
<abbr title="1858      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1858      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedLisðŸ”µ</abbr>
1859              String parentId, boolean isViewCollectionItem, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)
1860              throws ServiceException {
1861          EntityForm ef = createStandardAdornedEntityForm();
<abbr title="1862          return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAdd);">1862          return buildAdornedListForm(adornedMd, adornedList, parentId, isViewCollectionItem, ef, sectionCrumbs, isAðŸ”µ</abbr>
1863      }
1864  
1865      @Override
<abbr title="1866      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedList,">1866      public EntityForm buildAdornedListForm(AdornedTargetCollectionMetadata adornedMd, AdornedTargetList adornedLisðŸ”µ</abbr>
<abbr title="1867              String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, boolean isAdd)">1867              String parentId, boolean isViewCollectionItem, EntityForm ef, List&lt;SectionCrumb&gt; sectionCrumbs, booleaðŸ”µ</abbr>
1868              throws ServiceException {
1869          ef.setEntityType(adornedList.getAdornedTargetEntityClassname());
1870  
1871          // Get the metadata for this adorned field
1872          PersistencePackageRequest request = PersistencePackageRequest.adorned()
1873                  .withCeilingEntityClassname(adornedMd.getCollectionCeilingEntity())
1874                  .withAdornedList(adornedList)
1875                  .withSectionCrumbs(sectionCrumbs);
1876          request.setAddOperationInspect(isAdd);
<abbr title="1877          ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getClassMetaData();">1877          ClassMetadata collectionMetadata = adminEntityService.getClassMetadata(request).getDynamicResultSet().getCðŸ”µ</abbr>
1878  
1879          List&lt;Property&gt; entityFormProperties = new ArrayList&lt;&gt;();
1880          if (isViewCollectionItem) {
1881              Collections.addAll(entityFormProperties, collectionMetadata.getProperties());
1882          } else {
1883              // We want our entity form to only render the maintained adorned target fields
1884              for (String targetFieldName : adornedMd.getMaintainedAdornedTargetFields()) {
1885                  Property p = collectionMetadata.getPMap().get(targetFieldName);
<abbr title="1886                  if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExcluded())) {">1886                  if (p.getMetadata() instanceof BasicFieldMetadata &amp;&amp; BooleanUtils.isNotTrue( p.getMetadata().getExðŸ”µ</abbr>
1887                      ((BasicFieldMetadata) p.getMetadata()).setVisibility(VisibilityEnum.VISIBLE_ALL);
1888                      entityFormProperties.add(p);
1889                  }
1890              }
1891          }
1892  
1893          // Set the maintained fields on the form
1894          setEntityFormFields(collectionMetadata, ef, entityFormProperties);
1895  
1896          // Add these two additional hidden fields that are required for persistence
1897          Field f = new Field()
1898                  .withName(adornedList.getLinkedObjectPath() + &quot;.&quot; + adornedList.getLinkedIdProperty())
1899                  .withFieldType(SupportedFieldType.HIDDEN.toString())
1900                  .withValue(parentId);
1901          ef.addHiddenField(collectionMetadata, f);
1902  
1903          f = new Field()
1904                  .withName(adornedList.getTargetObjectPath() + &quot;.&quot; + adornedList.getTargetIdProperty())
1905                  .withFieldType(SupportedFieldType.HIDDEN.toString())
1906                  .withIdOverride(&quot;adornedTargetIdProperty&quot;);
1907          ef.addHiddenField(collectionMetadata, f);
1908  
1909          if (StringUtils.isNotBlank(adornedList.getSortField())) {
1910              f = new Field()
1911                      .withName(adornedList.getSortField())
1912                      .withFieldType(SupportedFieldType.HIDDEN.toString());
1913              ef.addHiddenField(collectionMetadata, f);
1914          }
1915  
1916          ef.setParentId(parentId);
1917  
1918          extensionManager.getProxy().addAdditionalAdornedFormActions(ef);
1919  
1920          return ef;
1921      }
1922  
1923  
1924      @Override
<abbr title="1925      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId)">1925      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String pðŸ”µ</abbr>
1926              throws ServiceException {
1927          EntityForm ef = createStandardEntityForm();
1928          return buildMapForm(mapMd, mapStructure, cmd, parentId, ef);
1929      }
1930  
1931      @Override
<abbr title="1932      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String parentId, EntityForm ef)">1932      public EntityForm buildMapForm(MapMetadata mapMd, final MapStructure mapStructure, ClassMetadata cmd, String pðŸ”µ</abbr>
1933              throws ServiceException {
1934          ForeignKey foreignKey = (ForeignKey) mapMd.getPersistencePerspective()
1935                  .getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY);
1936          ef.setEntityType(foreignKey.getForeignKeyClass());
1937  
1938          Field keyField;
1939          if (!mapMd.getForceFreeFormKeys()) {
1940              // We will use a combo field to render the key choices
1941              ComboField temp = new ComboField();
1942              temp.withName(&quot;key&quot;)
1943                      .withFieldType(&quot;combo_field&quot;)
1944                      .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1945              if (mapMd.getKeys() != null) {
1946                  // The keys can be explicitly set in the annotation...
1947                  temp.setOptions(mapMd.getKeys());
1948              } else {
1949                  // Or they could be based on a different entity
1950                  PersistencePackageRequest ppr = PersistencePackageRequest.standard()
1951                          .withCeilingEntityClassname(mapMd.getMapKeyOptionEntityClass());
1952  
1953                  DynamicResultSet drs = adminEntityService.getRecords(ppr).getDynamicResultSet();
1954  
1955                  for (Entity entity : drs.getRecords()) {
1956                      String keyValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityValueField()).getValue();
<abbr title="1957                      String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getValue();">1957                      String keyDisplayValue = entity.getPMap().get(mapMd.getMapKeyOptionEntityDisplayField()).getVaðŸ”µ</abbr>
1958                      temp.putOption(keyValue, keyDisplayValue);
1959                  }
1960              }
1961              keyField = temp;
1962          } else {
1963              keyField = new Field().withName(&quot;key&quot;)
1964                                  .withFieldType(SupportedFieldType.STRING.toString())
1965                                  .withFriendlyName(mapStructure.getKeyPropertyFriendlyName());
1966          }
1967          keyField.setRequired(true);
1968          ef.addMapKeyField(cmd, keyField);
1969  
1970          // Set the fields for this form
1971          List&lt;Property&gt; mapFormProperties;
1972          if (mapMd.isSimpleValue()) {
1973              ef.setIdProperty(&quot;key&quot;);
1974              mapFormProperties = new ArrayList&lt;&gt;();
1975              Property valueProp = cmd.getPMap().get(&quot;value&quot;);
1976              mapFormProperties.add(valueProp);
1977          } else {
1978              String valueClassName = mapStructure.getValueClassName();
1979              List&lt;String&gt; classNames = getValueClassNames(valueClassName);
1980  
1981              mapFormProperties = new ArrayList&lt;&gt;(Arrays.asList(cmd.getProperties()));
1982              filterMapFormProperties(mapFormProperties, classNames);
1983          }
1984  
1985          setEntityFormFields(cmd, ef, mapFormProperties);
1986  
1987          Field f = new Field()
1988                  .withName(&quot;priorKey&quot;)
1989                  .withFieldType(SupportedFieldType.HIDDEN.toString());
1990          ef.addHiddenField(cmd, f);
1991  
1992          ef.setParentId(parentId);
1993  
1994          return ef;
1995      }
1996  
1997      protected List&lt;String&gt; getValueClassNames(String valueClassName) {
1998          PersistenceManager pm = PersistenceManagerFactory.getPersistenceManager(valueClassName);
1999          List&lt;String&gt; classNames = new ArrayList&lt;&gt;();
2000          try {
2001              Class&lt;?&gt;[] mapEntities = pm.getPolymorphicEntities(valueClassName);
2002              for (Class clazz : mapEntities) {
2003                  classNames.add(clazz.getName());
2004              }
2005          } catch (ClassNotFoundException e) {
2006              classNames.add(valueClassName);
2007          }
2008          return classNames;
2009      }
2010  
2011      protected void filterMapFormProperties(List&lt;Property&gt; mapFormProperties, final List&lt;String&gt; classNames) {
2012          CollectionUtils.filter(mapFormProperties, new Predicate() {
2013              @Override
2014              public boolean evaluate(Object object) {
2015                  Property p = (Property) object;
2016                  for (String availType : p.getMetadata().getAvailableToTypes()) {
2017                      if (classNames.contains(availType)) {
2018                          return true;
2019                      }
2020                  }
2021                  return false;
2022              }
2023          });
2024      }
2025  
2026      protected EntityForm createStandardEntityForm() {
2027          EntityForm ef = new EntityForm();
2028          ef.addAction(DefaultEntityFormActions.SAVE);
2029          return ef;
2030      }
2031  
2032      protected EntityForm createStandardAdornedEntityForm() {
2033          EntityForm ef = new EntityForm();
2034          ef.addAction(DefaultAdornedEntityFormActions.Add);
2035          return ef;
2036      }
2037  
2038      protected VisibilityEnum[] getGridHiddenVisibilities() {
2039          return FormBuilderServiceImpl.GRID_HIDDEN_VISIBILITIES;
2040      }
2041  
2042      protected VisibilityEnum[] getFormHiddenVisibilities() {
2043          return FormBuilderServiceImpl.FORM_HIDDEN_VISIBILITIES;
2044      }
2045  
2046  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            