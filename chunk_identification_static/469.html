<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>469</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    469
                    <a href="468.html">prev</a>
                    <a href="470.html">next</a>
                    <a href="469_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e346a804d69c8cd0124b4eb3d35156cfb5cd0779_kafka-base/kafka-base-source/src/main/java/com/dtstack/flink/sql/source/kafka/KafkaDeserializationMetricWrapper.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779:kafka-base/kafka-base-source/src/main/java/com/dtstack/flink/sql/source/kafka/KafkaDeserializationMetricWrapper.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^1:kafka-base/kafka-base-source/src/main/java/com/dtstack/flink/sql/source/kafka/KafkaDeserializationMetricWrapper.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^2:kafka-base/kafka-base-source/src/main/java/com/dtstack/flink/sql/source/kafka/KafkaDeserializationMetricWrapper.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;6e351a99f6e8449c76ad55e517a5da6cbb108379:kafka-base/kafka-base-source/src/main/java/com/dtstack/flink/sql/source/kafka/KafkaDeserializationMetricWrapper.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="3101153502889412828" onmouseenter="enter('3101153502889412828');" onmouseout="out('3101153502889412828');" style="">   2  * Licensed to the Apache Software Foundation (ASF) under one                                            </span>
<span class="-6690800139350779170" onmouseenter="enter('-6690800139350779170');" onmouseout="out('-6690800139350779170');" style="">   3  * or more contributor license agreements.  See the NOTICE file                                          </span>
<span class="4408648408749222780" onmouseenter="enter('4408648408749222780');" onmouseout="out('4408648408749222780');" style="">   4  * distributed with this work for additional information                                                 </span>
<span class="7440871955664702931" onmouseenter="enter('7440871955664702931');" onmouseout="out('7440871955664702931');" style="">   5  * regarding copyright ownership.  The ASF licenses this file                                            </span>
<span class="-7748987699953482767" onmouseenter="enter('-7748987699953482767');" onmouseout="out('-7748987699953482767');" style="">   6  * to you under the Apache License, Version 2.0 (the                                                     </span>
<span class="-7532787339260984706" onmouseenter="enter('-7532787339260984706');" onmouseout="out('-7532787339260984706');" style="">   7  * &quot;License&quot;); you may not use this file except in compliance                                            </span>
<span class="6072654417402056570" onmouseenter="enter('6072654417402056570');" onmouseout="out('6072654417402056570');" style="">   8  * with the License.  You may obtain a copy of the License at                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">  10  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  11  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  12  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  15  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  16  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span  style="">  18                                                                                                          </span>
<span class="-4860059537597571054" onmouseenter="enter('-4860059537597571054');" onmouseout="out('-4860059537597571054');" style="">  19 package com.dtstack.flink.sql.source.kafka;                                                              </span>
<span  style="">  20                                                                                                          </span>
<span class="-6449915967577675590" onmouseenter="enter('-6449915967577675590');" onmouseout="out('-6449915967577675590');" style="">  21 import com.dtstack.flink.sql.format.DeserializationMetricWrapper;                                        </span>
<span class="-8410045274871986963" onmouseenter="enter('-8410045274871986963');" onmouseout="out('-8410045274871986963');" style="">  22 import org.apache.flink.api.common.serialization.DeserializationSchema;                                  </span>
<span class="-4869246525166490693" onmouseenter="enter('-4869246525166490693');" onmouseout="out('-4869246525166490693');" style="">  23 import org.apache.flink.api.common.typeinfo.TypeInformation;                                             </span>
<span class="-4144122941458221156" onmouseenter="enter('-4144122941458221156');" onmouseout="out('-4144122941458221156');" style="">  24 import org.apache.flink.metrics.Gauge;                                                                   </span>
<span class="2890304544990601345" onmouseenter="enter('2890304544990601345');" onmouseout="out('2890304544990601345');" style="">  25 import org.apache.flink.metrics.MetricGroup;                                                             </span>
<span class="-8829928480659738111" onmouseenter="enter('-8829928480659738111');" onmouseout="out('-8829928480659738111');" style="">  26 import org.apache.flink.streaming.connectors.kafka.internal.KafkaConsumerThread;                         </span>
<span class="5227372441575323745" onmouseenter="enter('5227372441575323745');" onmouseout="out('5227372441575323745');" style="">  27 import org.apache.flink.streaming.connectors.kafka.internals.AbstractFetcher;                            </span>
<span class="2962496049409651976" onmouseenter="enter('2962496049409651976');" onmouseout="out('2962496049409651976');" style="">  28 import org.apache.flink.types.Row;                                                                       </span>
<span class="5828926862428595050" onmouseenter="enter('5828926862428595050');" onmouseout="out('5828926862428595050');" style="">  29 import org.apache.kafka.clients.consumer.KafkaConsumer;                                                  </span>
<span class="-6407708023381697992" onmouseenter="enter('-6407708023381697992');" onmouseout="out('-6407708023381697992');" style="">  30 import org.apache.kafka.clients.consumer.internals.SubscriptionState;                                    </span>
<span class="-3566308373389754264" onmouseenter="enter('-3566308373389754264');" onmouseout="out('-3566308373389754264');" style="">  31 import org.apache.kafka.common.TopicPartition;                                                           </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  32 import org.slf4j.Logger;                                                                                 </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  33 import org.slf4j.LoggerFactory;                                                                          </span>
<span  style="">  34                                                                                                          </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  35 import java.io.IOException;                                                                              </span>
<span class="507320133330553151" onmouseenter="enter('507320133330553151');" onmouseout="out('507320133330553151');" style="">  36 import java.lang.reflect.Field;                                                                          </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  37 import java.util.Set;                                                                                    </span>
<span class="-2705241621224930031" onmouseenter="enter('-2705241621224930031');" onmouseout="out('-2705241621224930031');" style="">  38 import java.util.concurrent.atomic.AtomicBoolean;                                                        </span>
<span  style="">  39                                                                                                          </span>
<span class="-7980418243767915169" onmouseenter="enter('-7980418243767915169');" onmouseout="out('-7980418243767915169');" style="">  40 import static com.dtstack.flink.sql.metric.MetricConstant.DT_PARTITION_GROUP;                            </span>
<span class="-1088289402191836116" onmouseenter="enter('-1088289402191836116');" onmouseout="out('-1088289402191836116');" style="">  41 import static com.dtstack.flink.sql.metric.MetricConstant.DT_TOPIC_GROUP;                                </span>
<span class="-726801585448151313" onmouseenter="enter('-726801585448151313');" onmouseout="out('-726801585448151313');" style="">  42 import static com.dtstack.flink.sql.metric.MetricConstant.DT_TOPIC_PARTITION_LAG_GAUGE;                  </span>
<span  style="">  43                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  44 /**                                                                                                      </span>
<span class="2924525055993403783" onmouseenter="enter('2924525055993403783');" onmouseout="out('2924525055993403783');" style="">  45  * add metric for source                                                                                 </span>
<span class="4169512172915751358" onmouseenter="enter('4169512172915751358');" onmouseout="out('4169512172915751358');" style="">  46  * &lt;p&gt;                                                                                                   </span>
<span class="-8729821338350872800" onmouseenter="enter('-8729821338350872800');" onmouseout="out('-8729821338350872800');" style="">  47  * company: www.dtstack.com                                                                              </span>
<span class="855988645286188992" onmouseenter="enter('855988645286188992');" onmouseout="out('855988645286188992');" style="">  48  * @author: toutian                                                                                      </span>
<span class="1450268962912923596" onmouseenter="enter('1450268962912923596');" onmouseout="out('1450268962912923596');" style="">  49  * create: 2019/12/24                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  50  */                                                                                                      </span>
<span class="-2638210892100088482" onmouseenter="enter('-2638210892100088482');" onmouseout="out('-2638210892100088482');" style="">  51 public class KafkaDeserializationMetricWrapper extends DeserializationMetricWrapper {                    </span>
<span  style="">  52                                                                                                          </span>
<span class="5282243304209344831" onmouseenter="enter('5282243304209344831');" onmouseout="out('5282243304209344831');" style="">  53     private static final Logger LOG = LoggerFactory.getLogger(KafkaDeserializationMetricWrapper.class);  </span>
<span  style="">  54                                                                                                          </span>
<span class="-1275427395007637155" onmouseenter="enter('-1275427395007637155');" onmouseout="out('-1275427395007637155');" style="">  55     private AbstractFetcher&lt;Row, ?&gt; fetcher;                                                             </span>
<span class="-4902975925844009580" onmouseenter="enter('-4902975925844009580');" onmouseout="out('-4902975925844009580');" style="">  56     private TypeInformation&lt;Row&gt; typeInfo;                                                               </span>
<span  style="">  57                                                                                                          </span>
<span class="-6236697441540786194" onmouseenter="enter('-6236697441540786194');" onmouseout="out('-6236697441540786194');" style="">  58     private AtomicBoolean firstMsg = new AtomicBoolean(true);                                            </span>
<span  style="">  59                                                                                                          </span>
<span class="-6216421612770850251" onmouseenter="enter('-6216421612770850251');" onmouseout="out('-6216421612770850251');" style="">  60     private Calculate calculate;                                                                         </span>
<span  style="">  61                                                                                                          </span>
<span class="3112986511137480737" onmouseenter="enter('3112986511137480737');" onmouseout="out('3112986511137480737');" style=""><abbr title="  62     public KafkaDeserializationMetricWrapper(TypeInformation&lt;Row&gt; typeInfo, DeserializationSchema&lt;Row&gt; deserializationSchema, Calculate calculate) {">  62     public KafkaDeserializationMetricWrapper(TypeInformation&lt;Row&gt; typeInfo, DeserializationSchema&lt;Row&gt; deðŸ”µ</abbr></span>
<span class="3942214720745795765" onmouseenter="enter('3942214720745795765');" onmouseout="out('3942214720745795765');" style="">  63         super(typeInfo, deserializationSchema);                                                          </span>
<span class="8399279869647336028" onmouseenter="enter('8399279869647336028');" onmouseout="out('8399279869647336028');" style="">  64         this.calculate = calculate;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  65     }                                                                                                    </span>
<span  style="">  66                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  67     @Override                                                                                            </span>
<span class="-1799581248031441833" onmouseenter="enter('-1799581248031441833');" onmouseout="out('-1799581248031441833');" style="">  68     protected void beforeDeserialize() throws IOException {                                              </span>
<span class="4505725127125543648" onmouseenter="enter('4505725127125543648');" onmouseout="out('4505725127125543648');" style="">  69         super.beforeDeserialize();                                                                       </span>
<span class="6523231691793718551" onmouseenter="enter('6523231691793718551');" onmouseout="out('6523231691793718551');" style="">  70         if (firstMsg.compareAndSet(true, false)) {                                                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  71             try {                                                                                        </span>
<span class="4380491174239304819" onmouseenter="enter('4380491174239304819');" onmouseout="out('4380491174239304819');" style="">  72                 registerPtMetric(fetcher);                                                               </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="">  73             } catch (Exception e) {                                                                      </span>
<span class="-2718247249494635911" onmouseenter="enter('-2718247249494635911');" onmouseout="out('-2718247249494635911');" style="">  74                 LOG.error(&quot;register topic partition metric error.&quot;, e);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  75             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  76         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  77     }                                                                                                    </span>
<span  style="">  78                                                                                                          </span>
<span class="-8432425979240803493" onmouseenter="enter('-8432425979240803493');" onmouseout="out('-8432425979240803493');" style="">  79     protected void registerPtMetric(AbstractFetcher&lt;Row, ?&gt; fetcher) throws Exception {                  </span>
<span class="-8191885679416678139" onmouseenter="enter('-8191885679416678139');" onmouseout="out('-8191885679416678139');" style="">  80         Field consumerThreadField = getConsumerThreadField(fetcher);                                     </span>
<span class="-7760031181752894688" onmouseenter="enter('-7760031181752894688');" onmouseout="out('-7760031181752894688');" style="">  81         consumerThreadField.setAccessible(true);                                                         </span>
<span class="-2866192443751632865" onmouseenter="enter('-2866192443751632865');" onmouseout="out('-2866192443751632865');" style="">  82         KafkaConsumerThread consumerThread = (KafkaConsumerThread) consumerThreadField.get(fetcher);     </span>
<span  style="">  83                                                                                                          </span>
<span class="7669891676693203744" onmouseenter="enter('7669891676693203744');" onmouseout="out('7669891676693203744');" style=""><abbr title="  84         Field hasAssignedPartitionsField = consumerThread.getClass().getDeclaredField(&quot;hasAssignedPartitions&quot;);">  84         Field hasAssignedPartitionsField = consumerThread.getClass().getDeclaredField(&quot;hasAssignedPartitiðŸ”µ</abbr></span>
<span class="-6364381604626909996" onmouseenter="enter('-6364381604626909996');" onmouseout="out('-6364381604626909996');" style="">  85         hasAssignedPartitionsField.setAccessible(true);                                                  </span>
<span  style="">  86                                                                                                          </span>
<span class="-3142193783660782670" onmouseenter="enter('-3142193783660782670');" onmouseout="out('-3142193783660782670');" style="">  87         //wait until assignedPartitions                                                                  </span>
<span  style="">  88                                                                                                          </span>
<span class="-7786559209988806161" onmouseenter="enter('-7786559209988806161');" onmouseout="out('-7786559209988806161');" style="">  89         boolean hasAssignedPartitions = (boolean) hasAssignedPartitionsField.get(consumerThread);        </span>
<span  style="">  90                                                                                                          </span>
<span class="-7519647013637839101" onmouseenter="enter('-7519647013637839101');" onmouseout="out('-7519647013637839101');" style="">  91         if (!hasAssignedPartitions) {                                                                    </span>
<span class="-6260707342579154109" onmouseenter="enter('-6260707342579154109');" onmouseout="out('-6260707342579154109');" style="">  92             throw new RuntimeException(&quot;wait 50 secs, but not assignedPartitions&quot;);                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  93         }                                                                                                </span>
<span  style="">  94                                                                                                          </span>
<span class="2892476206881062451" onmouseenter="enter('2892476206881062451');" onmouseout="out('2892476206881062451');" style="">  95         Field consumerField = consumerThread.getClass().getDeclaredField(&quot;consumer&quot;);                    </span>
<span class="-8842902760152032622" onmouseenter="enter('-8842902760152032622');" onmouseout="out('-8842902760152032622');" style="">  96         consumerField.setAccessible(true);                                                               </span>
<span  style="">  97                                                                                                          </span>
<span class="4978140084971031415" onmouseenter="enter('4978140084971031415');" onmouseout="out('4978140084971031415');" style="">  98         KafkaConsumer kafkaConsumer = (KafkaConsumer) consumerField.get(consumerThread);                 </span>
<span class="894227422872580400" onmouseenter="enter('894227422872580400');" onmouseout="out('894227422872580400');" style="">  99         Field subscriptionStateField = kafkaConsumer.getClass().getDeclaredField(&quot;subscriptions&quot;);       </span>
<span class="6389918226736372616" onmouseenter="enter('6389918226736372616');" onmouseout="out('6389918226736372616');" style=""> 100         subscriptionStateField.setAccessible(true);                                                      </span>
<span  style=""> 101                                                                                                          </span>
<span class="3032872518319318392" onmouseenter="enter('3032872518319318392');" onmouseout="out('3032872518319318392');" style=""> 102         //topic partitions lag                                                                           </span>
<span class="4731746494435406121" onmouseenter="enter('4731746494435406121');" onmouseout="out('4731746494435406121');" style=""><abbr title=" 103         SubscriptionState subscriptionState = (SubscriptionState) subscriptionStateField.get(kafkaConsumer);"> 103         SubscriptionState subscriptionState = (SubscriptionState) subscriptionStateField.get(kafkaConsumeðŸ”µ</abbr></span>
<span class="-6107961862663408818" onmouseenter="enter('-6107961862663408818');" onmouseout="out('-6107961862663408818');" style=""> 104         Set&lt;TopicPartition&gt; assignedPartitions = subscriptionState.assignedPartitions();                 </span>
<span  style=""> 105                                                                                                          </span>
<span class="-7441461244274494397" onmouseenter="enter('-7441461244274494397');" onmouseout="out('-7441461244274494397');" style=""> 106         for (TopicPartition topicPartition : assignedPartitions) {                                       </span>
<span class="6044695378852942901" onmouseenter="enter('6044695378852942901');" onmouseout="out('6044695378852942901');" style=""><abbr title=" 107             MetricGroup metricGroup = getRuntimeContext().getMetricGroup().addGroup(DT_TOPIC_GROUP, topicPartition.topic())"> 107             MetricGroup metricGroup = getRuntimeContext().getMetricGroup().addGroup(DT_TOPIC_GROUP, topicðŸ”µ</abbr></span>
<span class="-2843212987053254120" onmouseenter="enter('-2843212987053254120');" onmouseout="out('-2843212987053254120');" style=""> 108                     .addGroup(DT_PARTITION_GROUP, topicPartition.partition() + &quot;&quot;);                      </span>
<span class="-5230433520258489685" onmouseenter="enter('-5230433520258489685');" onmouseout="out('-5230433520258489685');" style=""> 109             metricGroup.gauge(DT_TOPIC_PARTITION_LAG_GAUGE, new Gauge&lt;Long&gt;() {                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 110                 @Override                                                                                </span>
<span class="-2549929678984879043" onmouseenter="enter('-2549929678984879043');" onmouseout="out('-2549929678984879043');" style=""> 111                 public Long getValue() {                                                                 </span>
<span class="1817254173978356394" onmouseenter="enter('1817254173978356394');" onmouseout="out('1817254173978356394');" style=""> 112                     return calculate.calc(subscriptionState, topicPartition);                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113                 }                                                                                        </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 114             });                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 115         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 116     }                                                                                                    </span>
<span  style=""> 117                                                                                                          </span>
<span class="-1208277042475452222" onmouseenter="enter('-1208277042475452222');" onmouseout="out('-1208277042475452222');" style=""> 118     public void setFetcher(AbstractFetcher&lt;Row, ?&gt; fetcher) {                                            </span>
<span class="-3526688709606912170" onmouseenter="enter('-3526688709606912170');" onmouseout="out('-3526688709606912170');" style=""> 119         this.fetcher = fetcher;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120     }                                                                                                    </span>
<span  style=""> 121                                                                                                          </span>
<span class="3952065517656192652" onmouseenter="enter('3952065517656192652');" onmouseout="out('3952065517656192652');" style=""> 122     private Field getConsumerThreadField(AbstractFetcher fetcher) throws NoSuchFieldException {          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 123         try {                                                                                            </span>
<span class="7980630892426567154" onmouseenter="enter('7980630892426567154');" onmouseout="out('7980630892426567154');" style=""> 124             return fetcher.getClass().getDeclaredField(&quot;consumerThread&quot;);                                </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 125         } catch (Exception e) {                                                                          </span>
<span class="7490930883660259674" onmouseenter="enter('7490930883660259674');" onmouseout="out('7490930883660259674');" style=""> 126             return fetcher.getClass().getSuperclass().getDeclaredField(&quot;consumerThread&quot;);                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 128     }                                                                                                    </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style=""> 129 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130                                                                                                          </span>
<span class="-1208277042475452222" onmouseenter="enter('-1208277042475452222');" onmouseout="out('-1208277042475452222');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131     public void setFetcher(AbstractFetcher&lt;Row, ?&gt; fetcher) {                                            </span>
<span class="-3526688709606912170" onmouseenter="enter('-3526688709606912170');" onmouseout="out('-3526688709606912170');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132         this.fetcher = fetcher;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133     }                                                                                                    </span>
<span  style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135     @Override                                                                                            </span>
<span class="985054094574866320" onmouseenter="enter('985054094574866320');" onmouseout="out('985054094574866320');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136     public TypeInformation&lt;Row&gt; getProducedType() {                                                      </span>
<span class="5847422928769084622" onmouseenter="enter('5847422928769084622');" onmouseout="out('5847422928769084622');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137         return typeInfo;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138     }                                                                                                    </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style=""> 139 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="-1208277042475452222" onmouseenter="enter('-1208277042475452222');" onmouseout="out('-1208277042475452222');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140     public void setFetcher(AbstractFetcher&lt;Row, ?&gt; fetcher) {                                            </span>
<span class="-3526688709606912170" onmouseenter="enter('-3526688709606912170');" onmouseout="out('-3526688709606912170');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         this.fetcher = fetcher;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143 }                                                                                                        </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style=""> 144 =======                                                                                                  </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style=""> 145 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 146 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="3101153502889412828" onmouseenter="enter('3101153502889412828');" onmouseout="out('3101153502889412828');" style="">   2  * Licensed to the Apache Software Foundation (ASF) under one                                            </span>
<span class="-6690800139350779170" onmouseenter="enter('-6690800139350779170');" onmouseout="out('-6690800139350779170');" style="">   3  * or more contributor license agreements.  See the NOTICE file                                          </span>
<span class="4408648408749222780" onmouseenter="enter('4408648408749222780');" onmouseout="out('4408648408749222780');" style="">   4  * distributed with this work for additional information                                                 </span>
<span class="7440871955664702931" onmouseenter="enter('7440871955664702931');" onmouseout="out('7440871955664702931');" style="">   5  * regarding copyright ownership.  The ASF licenses this file                                            </span>
<span class="-7748987699953482767" onmouseenter="enter('-7748987699953482767');" onmouseout="out('-7748987699953482767');" style="">   6  * to you under the Apache License, Version 2.0 (the                                                     </span>
<span class="-7532787339260984706" onmouseenter="enter('-7532787339260984706');" onmouseout="out('-7532787339260984706');" style="">   7  * &quot;License&quot;); you may not use this file except in compliance                                            </span>
<span class="6072654417402056570" onmouseenter="enter('6072654417402056570');" onmouseout="out('6072654417402056570');" style="">   8  * with the License.  You may obtain a copy of the License at                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">  10  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  11  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  12  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  15  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  16  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span  style="">  18                                                                                                          </span>
<span class="-4860059537597571054" onmouseenter="enter('-4860059537597571054');" onmouseout="out('-4860059537597571054');" style="">  19 package com.dtstack.flink.sql.source.kafka;                                                              </span>
<span  style="">  20                                                                                                          </span>
<span class="-6449915967577675590" onmouseenter="enter('-6449915967577675590');" onmouseout="out('-6449915967577675590');" style="">  21 import com.dtstack.flink.sql.format.DeserializationMetricWrapper;                                        </span>
<span class="-8410045274871986963" onmouseenter="enter('-8410045274871986963');" onmouseout="out('-8410045274871986963');" style="">  22 import org.apache.flink.api.common.serialization.DeserializationSchema;                                  </span>
<span class="-4869246525166490693" onmouseenter="enter('-4869246525166490693');" onmouseout="out('-4869246525166490693');" style="">  23 import org.apache.flink.api.common.typeinfo.TypeInformation;                                             </span>
<span class="-4144122941458221156" onmouseenter="enter('-4144122941458221156');" onmouseout="out('-4144122941458221156');" style="">  24 import org.apache.flink.metrics.Gauge;                                                                   </span>
<span class="2890304544990601345" onmouseenter="enter('2890304544990601345');" onmouseout="out('2890304544990601345');" style="">  25 import org.apache.flink.metrics.MetricGroup;                                                             </span>
<span class="-8829928480659738111" onmouseenter="enter('-8829928480659738111');" onmouseout="out('-8829928480659738111');" style="">  26 import org.apache.flink.streaming.connectors.kafka.internal.KafkaConsumerThread;                         </span>
<span class="5227372441575323745" onmouseenter="enter('5227372441575323745');" onmouseout="out('5227372441575323745');" style="">  27 import org.apache.flink.streaming.connectors.kafka.internals.AbstractFetcher;                            </span>
<span class="2962496049409651976" onmouseenter="enter('2962496049409651976');" onmouseout="out('2962496049409651976');" style="">  28 import org.apache.flink.types.Row;                                                                       </span>
<span class="5828926862428595050" onmouseenter="enter('5828926862428595050');" onmouseout="out('5828926862428595050');" style="">  29 import org.apache.kafka.clients.consumer.KafkaConsumer;                                                  </span>
<span class="-6407708023381697992" onmouseenter="enter('-6407708023381697992');" onmouseout="out('-6407708023381697992');" style="">  30 import org.apache.kafka.clients.consumer.internals.SubscriptionState;                                    </span>
<span class="-3566308373389754264" onmouseenter="enter('-3566308373389754264');" onmouseout="out('-3566308373389754264');" style="">  31 import org.apache.kafka.common.TopicPartition;                                                           </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  32 import org.slf4j.Logger;                                                                                 </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  33 import org.slf4j.LoggerFactory;                                                                          </span>
<span  style="">  34                                                                                                          </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  35 import java.io.IOException;                                                                              </span>
<span class="507320133330553151" onmouseenter="enter('507320133330553151');" onmouseout="out('507320133330553151');" style="">  36 import java.lang.reflect.Field;                                                                          </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  37 import java.util.Set;                                                                                    </span>
<span class="-2705241621224930031" onmouseenter="enter('-2705241621224930031');" onmouseout="out('-2705241621224930031');" style="">  38 import java.util.concurrent.atomic.AtomicBoolean;                                                        </span>
<span  style="">  39                                                                                                          </span>
<span class="-7980418243767915169" onmouseenter="enter('-7980418243767915169');" onmouseout="out('-7980418243767915169');" style="">  40 import static com.dtstack.flink.sql.metric.MetricConstant.DT_PARTITION_GROUP;                            </span>
<span class="-1088289402191836116" onmouseenter="enter('-1088289402191836116');" onmouseout="out('-1088289402191836116');" style="">  41 import static com.dtstack.flink.sql.metric.MetricConstant.DT_TOPIC_GROUP;                                </span>
<span class="-726801585448151313" onmouseenter="enter('-726801585448151313');" onmouseout="out('-726801585448151313');" style="">  42 import static com.dtstack.flink.sql.metric.MetricConstant.DT_TOPIC_PARTITION_LAG_GAUGE;                  </span>
<span  style="">  43                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  44 /**                                                                                                      </span>
<span class="2924525055993403783" onmouseenter="enter('2924525055993403783');" onmouseout="out('2924525055993403783');" style="">  45  * add metric for source                                                                                 </span>
<span class="4169512172915751358" onmouseenter="enter('4169512172915751358');" onmouseout="out('4169512172915751358');" style="">  46  * &lt;p&gt;                                                                                                   </span>
<span class="-8729821338350872800" onmouseenter="enter('-8729821338350872800');" onmouseout="out('-8729821338350872800');" style="">  47  * company: www.dtstack.com                                                                              </span>
<span class="855988645286188992" onmouseenter="enter('855988645286188992');" onmouseout="out('855988645286188992');" style="">  48  * @author: toutian                                                                                      </span>
<span class="1450268962912923596" onmouseenter="enter('1450268962912923596');" onmouseout="out('1450268962912923596');" style="">  49  * create: 2019/12/24                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  50  */                                                                                                      </span>
<span class="-2638210892100088482" onmouseenter="enter('-2638210892100088482');" onmouseout="out('-2638210892100088482');" style="">  51 public class KafkaDeserializationMetricWrapper extends DeserializationMetricWrapper {                    </span>
<span  style="">  52                                                                                                          </span>
<span class="5282243304209344831" onmouseenter="enter('5282243304209344831');" onmouseout="out('5282243304209344831');" style="">  53     private static final Logger LOG = LoggerFactory.getLogger(KafkaDeserializationMetricWrapper.class);  </span>
<span  style="">  54                                                                                                          </span>
<span class="-1275427395007637155" onmouseenter="enter('-1275427395007637155');" onmouseout="out('-1275427395007637155');" style="">  55     private AbstractFetcher&lt;Row, ?&gt; fetcher;                                                             </span>
<span class="-4902975925844009580" onmouseenter="enter('-4902975925844009580');" onmouseout="out('-4902975925844009580');" style="">  56     private TypeInformation&lt;Row&gt; typeInfo;                                                               </span>
<span  style="">  57                                                                                                          </span>
<span class="-6236697441540786194" onmouseenter="enter('-6236697441540786194');" onmouseout="out('-6236697441540786194');" style="">  58     private AtomicBoolean firstMsg = new AtomicBoolean(true);                                            </span>
<span  style="">  59                                                                                                          </span>
<span class="-6216421612770850251" onmouseenter="enter('-6216421612770850251');" onmouseout="out('-6216421612770850251');" style="">  60     private Calculate calculate;                                                                         </span>
<span  style="">  61                                                                                                          </span>
<span class="3112986511137480737" onmouseenter="enter('3112986511137480737');" onmouseout="out('3112986511137480737');" style=""><abbr title="  62     public KafkaDeserializationMetricWrapper(TypeInformation&lt;Row&gt; typeInfo, DeserializationSchema&lt;Row&gt; deserializationSchema, Calculate calculate) {">  62     public KafkaDeserializationMetricWrapper(TypeInformation&lt;Row&gt; typeInfo, DeserializationSchema&lt;Row&gt; deðŸ”µ</abbr></span>
<span class="3942214720745795765" onmouseenter="enter('3942214720745795765');" onmouseout="out('3942214720745795765');" style="">  63         super(typeInfo, deserializationSchema);                                                          </span>
<span class="8399279869647336028" onmouseenter="enter('8399279869647336028');" onmouseout="out('8399279869647336028');" style="">  64         this.calculate = calculate;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  65     }                                                                                                    </span>
<span  style="">  66                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  67     @Override                                                                                            </span>
<span class="-1799581248031441833" onmouseenter="enter('-1799581248031441833');" onmouseout="out('-1799581248031441833');" style="">  68     protected void beforeDeserialize() throws IOException {                                              </span>
<span class="4505725127125543648" onmouseenter="enter('4505725127125543648');" onmouseout="out('4505725127125543648');" style="">  69         super.beforeDeserialize();                                                                       </span>
<span class="6523231691793718551" onmouseenter="enter('6523231691793718551');" onmouseout="out('6523231691793718551');" style="">  70         if (firstMsg.compareAndSet(true, false)) {                                                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  71             try {                                                                                        </span>
<span class="4380491174239304819" onmouseenter="enter('4380491174239304819');" onmouseout="out('4380491174239304819');" style="">  72                 registerPtMetric(fetcher);                                                               </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="">  73             } catch (Exception e) {                                                                      </span>
<span class="-2718247249494635911" onmouseenter="enter('-2718247249494635911');" onmouseout="out('-2718247249494635911');" style="">  74                 LOG.error(&quot;register topic partition metric error.&quot;, e);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  75             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  76         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  77     }                                                                                                    </span>
<span  style="">  78                                                                                                          </span>
<span class="-8432425979240803493" onmouseenter="enter('-8432425979240803493');" onmouseout="out('-8432425979240803493');" style="">  79     protected void registerPtMetric(AbstractFetcher&lt;Row, ?&gt; fetcher) throws Exception {                  </span>
<span class="-8191885679416678139" onmouseenter="enter('-8191885679416678139');" onmouseout="out('-8191885679416678139');" style="">  80         Field consumerThreadField = getConsumerThreadField(fetcher);                                     </span>
<span class="-7760031181752894688" onmouseenter="enter('-7760031181752894688');" onmouseout="out('-7760031181752894688');" style="">  81         consumerThreadField.setAccessible(true);                                                         </span>
<span class="-2866192443751632865" onmouseenter="enter('-2866192443751632865');" onmouseout="out('-2866192443751632865');" style="">  82         KafkaConsumerThread consumerThread = (KafkaConsumerThread) consumerThreadField.get(fetcher);     </span>
<span  style="">  83                                                                                                          </span>
<span class="7669891676693203744" onmouseenter="enter('7669891676693203744');" onmouseout="out('7669891676693203744');" style=""><abbr title="  84         Field hasAssignedPartitionsField = consumerThread.getClass().getDeclaredField(&quot;hasAssignedPartitions&quot;);">  84         Field hasAssignedPartitionsField = consumerThread.getClass().getDeclaredField(&quot;hasAssignedPartitiðŸ”µ</abbr></span>
<span class="-6364381604626909996" onmouseenter="enter('-6364381604626909996');" onmouseout="out('-6364381604626909996');" style="">  85         hasAssignedPartitionsField.setAccessible(true);                                                  </span>
<span  style="">  86                                                                                                          </span>
<span class="-3142193783660782670" onmouseenter="enter('-3142193783660782670');" onmouseout="out('-3142193783660782670');" style="">  87         //wait until assignedPartitions                                                                  </span>
<span  style="">  88                                                                                                          </span>
<span class="-7786559209988806161" onmouseenter="enter('-7786559209988806161');" onmouseout="out('-7786559209988806161');" style="">  89         boolean hasAssignedPartitions = (boolean) hasAssignedPartitionsField.get(consumerThread);        </span>
<span  style="">  90                                                                                                          </span>
<span class="-7519647013637839101" onmouseenter="enter('-7519647013637839101');" onmouseout="out('-7519647013637839101');" style="">  91         if (!hasAssignedPartitions) {                                                                    </span>
<span class="-6260707342579154109" onmouseenter="enter('-6260707342579154109');" onmouseout="out('-6260707342579154109');" style="">  92             throw new RuntimeException(&quot;wait 50 secs, but not assignedPartitions&quot;);                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  93         }                                                                                                </span>
<span  style="">  94                                                                                                          </span>
<span class="2892476206881062451" onmouseenter="enter('2892476206881062451');" onmouseout="out('2892476206881062451');" style="">  95         Field consumerField = consumerThread.getClass().getDeclaredField(&quot;consumer&quot;);                    </span>
<span class="-8842902760152032622" onmouseenter="enter('-8842902760152032622');" onmouseout="out('-8842902760152032622');" style="">  96         consumerField.setAccessible(true);                                                               </span>
<span  style="">  97                                                                                                          </span>
<span class="4978140084971031415" onmouseenter="enter('4978140084971031415');" onmouseout="out('4978140084971031415');" style="">  98         KafkaConsumer kafkaConsumer = (KafkaConsumer) consumerField.get(consumerThread);                 </span>
<span class="894227422872580400" onmouseenter="enter('894227422872580400');" onmouseout="out('894227422872580400');" style="">  99         Field subscriptionStateField = kafkaConsumer.getClass().getDeclaredField(&quot;subscriptions&quot;);       </span>
<span class="6389918226736372616" onmouseenter="enter('6389918226736372616');" onmouseout="out('6389918226736372616');" style=""> 100         subscriptionStateField.setAccessible(true);                                                      </span>
<span  style=""> 101                                                                                                          </span>
<span class="3032872518319318392" onmouseenter="enter('3032872518319318392');" onmouseout="out('3032872518319318392');" style=""> 102         //topic partitions lag                                                                           </span>
<span class="4731746494435406121" onmouseenter="enter('4731746494435406121');" onmouseout="out('4731746494435406121');" style=""><abbr title=" 103         SubscriptionState subscriptionState = (SubscriptionState) subscriptionStateField.get(kafkaConsumer);"> 103         SubscriptionState subscriptionState = (SubscriptionState) subscriptionStateField.get(kafkaConsumeðŸ”µ</abbr></span>
<span class="-6107961862663408818" onmouseenter="enter('-6107961862663408818');" onmouseout="out('-6107961862663408818');" style=""> 104         Set&lt;TopicPartition&gt; assignedPartitions = subscriptionState.assignedPartitions();                 </span>
<span  style=""> 105                                                                                                          </span>
<span class="-7441461244274494397" onmouseenter="enter('-7441461244274494397');" onmouseout="out('-7441461244274494397');" style=""> 106         for (TopicPartition topicPartition : assignedPartitions) {                                       </span>
<span class="6044695378852942901" onmouseenter="enter('6044695378852942901');" onmouseout="out('6044695378852942901');" style=""><abbr title=" 107             MetricGroup metricGroup = getRuntimeContext().getMetricGroup().addGroup(DT_TOPIC_GROUP, topicPartition.topic())"> 107             MetricGroup metricGroup = getRuntimeContext().getMetricGroup().addGroup(DT_TOPIC_GROUP, topicðŸ”µ</abbr></span>
<span class="-2843212987053254120" onmouseenter="enter('-2843212987053254120');" onmouseout="out('-2843212987053254120');" style=""> 108                     .addGroup(DT_PARTITION_GROUP, topicPartition.partition() + &quot;&quot;);                      </span>
<span class="-5230433520258489685" onmouseenter="enter('-5230433520258489685');" onmouseout="out('-5230433520258489685');" style=""> 109             metricGroup.gauge(DT_TOPIC_PARTITION_LAG_GAUGE, new Gauge&lt;Long&gt;() {                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 110                 @Override                                                                                </span>
<span class="-2549929678984879043" onmouseenter="enter('-2549929678984879043');" onmouseout="out('-2549929678984879043');" style=""> 111                 public Long getValue() {                                                                 </span>
<span class="1817254173978356394" onmouseenter="enter('1817254173978356394');" onmouseout="out('1817254173978356394');" style=""> 112                     return calculate.calc(subscriptionState, topicPartition);                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113                 }                                                                                        </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 114             });                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 115         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 116     }                                                                                                    </span>
<span  style=""> 117                                                                                                          </span>
<span class="3952065517656192652" onmouseenter="enter('3952065517656192652');" onmouseout="out('3952065517656192652');" style=""> 118     private Field getConsumerThreadField(AbstractFetcher fetcher) throws NoSuchFieldException {          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 119         try {                                                                                            </span>
<span class="7980630892426567154" onmouseenter="enter('7980630892426567154');" onmouseout="out('7980630892426567154');" style=""> 120             return fetcher.getClass().getDeclaredField(&quot;consumerThread&quot;);                                </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 121         } catch (Exception e) {                                                                          </span>
<span class="7490930883660259674" onmouseenter="enter('7490930883660259674');" onmouseout="out('7490930883660259674');" style=""> 122             return fetcher.getClass().getSuperclass().getDeclaredField(&quot;consumerThread&quot;);                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 123         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 124     }                                                                                                    </span>
<span  style=""> 125                                                                                                          </span>
<span class="-1208277042475452222" onmouseenter="enter('-1208277042475452222');" onmouseout="out('-1208277042475452222');" style=""> 126     public void setFetcher(AbstractFetcher&lt;Row, ?&gt; fetcher) {                                            </span>
<span class="-3526688709606912170" onmouseenter="enter('-3526688709606912170');" onmouseout="out('-3526688709606912170');" style=""> 127         this.fetcher = fetcher;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 128     }                                                                                                    </span>
<span  style=""> 129                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 130     @Override                                                                                            </span>
<span class="985054094574866320" onmouseenter="enter('985054094574866320');" onmouseout="out('985054094574866320');" style=""> 131     public TypeInformation&lt;Row&gt; getProducedType() {                                                      </span>
<span class="5847422928769084622" onmouseenter="enter('5847422928769084622');" onmouseout="out('5847422928769084622');" style=""> 132         return typeInfo;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 134 }                                                                                                        </span>










</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="3101153502889412828" onmouseenter="enter('3101153502889412828');" onmouseout="out('3101153502889412828');" style="">   2  * Licensed to the Apache Software Foundation (ASF) under one                                            </span>
<span class="-6690800139350779170" onmouseenter="enter('-6690800139350779170');" onmouseout="out('-6690800139350779170');" style="">   3  * or more contributor license agreements.  See the NOTICE file                                          </span>
<span class="4408648408749222780" onmouseenter="enter('4408648408749222780');" onmouseout="out('4408648408749222780');" style="">   4  * distributed with this work for additional information                                                 </span>
<span class="7440871955664702931" onmouseenter="enter('7440871955664702931');" onmouseout="out('7440871955664702931');" style="">   5  * regarding copyright ownership.  The ASF licenses this file                                            </span>
<span class="-7748987699953482767" onmouseenter="enter('-7748987699953482767');" onmouseout="out('-7748987699953482767');" style="">   6  * to you under the Apache License, Version 2.0 (the                                                     </span>
<span class="-7532787339260984706" onmouseenter="enter('-7532787339260984706');" onmouseout="out('-7532787339260984706');" style="">   7  * &quot;License&quot;); you may not use this file except in compliance                                            </span>
<span class="6072654417402056570" onmouseenter="enter('6072654417402056570');" onmouseout="out('6072654417402056570');" style="">   8  * with the License.  You may obtain a copy of the License at                                            </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9  *                                                                                                       </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">  10  *     http://www.apache.org/licenses/LICENSE-2.0                                                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  11  *                                                                                                       </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  12  * Unless required by applicable law or agreed to in writing, software                                   </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                     </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                              </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  15  * See the License for the specific language governing permissions and                                   </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  16  * limitations under the License.                                                                        </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-4860059537597571054" onmouseenter="enter('-4860059537597571054');" onmouseout="out('-4860059537597571054');" style="">  18 package com.dtstack.flink.sql.source.kafka;                                                              </span>
<span  style="">  19                                                                                                          </span>
<span class="-6449915967577675590" onmouseenter="enter('-6449915967577675590');" onmouseout="out('-6449915967577675590');" style="">  20 import com.dtstack.flink.sql.format.DeserializationMetricWrapper;                                        </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  21 import java.io.IOException;                                                                              </span>
<span class="507320133330553151" onmouseenter="enter('507320133330553151');" onmouseout="out('507320133330553151');" style="">  22 import java.lang.reflect.Field;                                                                          </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  23 import java.util.Set;                                                                                    </span>
<span class="-2705241621224930031" onmouseenter="enter('-2705241621224930031');" onmouseout="out('-2705241621224930031');" style="">  24 import java.util.concurrent.atomic.AtomicBoolean;                                                        </span>
<span class="-8410045274871986963" onmouseenter="enter('-8410045274871986963');" onmouseout="out('-8410045274871986963');" style="">  25 import org.apache.flink.api.common.serialization.DeserializationSchema;                                  </span>
<span class="-4869246525166490693" onmouseenter="enter('-4869246525166490693');" onmouseout="out('-4869246525166490693');" style="">  26 import org.apache.flink.api.common.typeinfo.TypeInformation;                                             </span>
<span class="-4144122941458221156" onmouseenter="enter('-4144122941458221156');" onmouseout="out('-4144122941458221156');" style="">  27 import org.apache.flink.metrics.Gauge;                                                                   </span>
<span class="2890304544990601345" onmouseenter="enter('2890304544990601345');" onmouseout="out('2890304544990601345');" style="">  28 import org.apache.flink.metrics.MetricGroup;                                                             </span>
<span class="-8829928480659738111" onmouseenter="enter('-8829928480659738111');" onmouseout="out('-8829928480659738111');" style="">  29 import org.apache.flink.streaming.connectors.kafka.internal.KafkaConsumerThread;                         </span>
<span class="5227372441575323745" onmouseenter="enter('5227372441575323745');" onmouseout="out('5227372441575323745');" style="">  30 import org.apache.flink.streaming.connectors.kafka.internals.AbstractFetcher;                            </span>
<span class="2962496049409651976" onmouseenter="enter('2962496049409651976');" onmouseout="out('2962496049409651976');" style="">  31 import org.apache.flink.types.Row;                                                                       </span>
<span class="5828926862428595050" onmouseenter="enter('5828926862428595050');" onmouseout="out('5828926862428595050');" style="">  32 import org.apache.kafka.clients.consumer.KafkaConsumer;                                                  </span>
<span class="-6407708023381697992" onmouseenter="enter('-6407708023381697992');" onmouseout="out('-6407708023381697992');" style="">  33 import org.apache.kafka.clients.consumer.internals.SubscriptionState;                                    </span>
<span class="-3566308373389754264" onmouseenter="enter('-3566308373389754264');" onmouseout="out('-3566308373389754264');" style="">  34 import org.apache.kafka.common.TopicPartition;                                                           </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  35 import org.slf4j.Logger;                                                                                 </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  36 import org.slf4j.LoggerFactory;                                                                          </span>
<span class="-7980418243767915169" onmouseenter="enter('-7980418243767915169');" onmouseout="out('-7980418243767915169');" style="">  37 import static com.dtstack.flink.sql.metric.MetricConstant.DT_PARTITION_GROUP;                            </span>
<span class="-1088289402191836116" onmouseenter="enter('-1088289402191836116');" onmouseout="out('-1088289402191836116');" style="">  38 import static com.dtstack.flink.sql.metric.MetricConstant.DT_TOPIC_GROUP;                                </span>
<span class="-726801585448151313" onmouseenter="enter('-726801585448151313');" onmouseout="out('-726801585448151313');" style="">  39 import static com.dtstack.flink.sql.metric.MetricConstant.DT_TOPIC_PARTITION_LAG_GAUGE;                  </span>
<span  style="">  40                                                                                                          </span>
<span  style="">  41                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  42 /**                                                                                                      </span>
<span class="2924525055993403783" onmouseenter="enter('2924525055993403783');" onmouseout="out('2924525055993403783');" style="">  43  * add metric for source                                                                                 </span>
<span class="4169512172915751358" onmouseenter="enter('4169512172915751358');" onmouseout="out('4169512172915751358');" style="">  44  * &lt;p&gt;                                                                                                   </span>
<span class="-8729821338350872800" onmouseenter="enter('-8729821338350872800');" onmouseout="out('-8729821338350872800');" style="">  45  * company: www.dtstack.com                                                                              </span>
<span class="855988645286188992" onmouseenter="enter('855988645286188992');" onmouseout="out('855988645286188992');" style="">  46  * @author: toutian                                                                                      </span>
<span class="1450268962912923596" onmouseenter="enter('1450268962912923596');" onmouseout="out('1450268962912923596');" style="">  47  * create: 2019/12/24                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  48  */                                                                                                      </span>
<span class="-2638210892100088482" onmouseenter="enter('-2638210892100088482');" onmouseout="out('-2638210892100088482');" style="">  49 public class KafkaDeserializationMetricWrapper extends DeserializationMetricWrapper {                    </span>
<span class="5282243304209344831" onmouseenter="enter('5282243304209344831');" onmouseout="out('5282243304209344831');" style="">  50     private static final Logger LOG = LoggerFactory.getLogger(KafkaDeserializationMetricWrapper.class);  </span>
<span  style="">  51                                                                                                          </span>
<span class="-1275427395007637155" onmouseenter="enter('-1275427395007637155');" onmouseout="out('-1275427395007637155');" style="">  52     private AbstractFetcher&lt;Row, ?&gt; fetcher;                                                             </span>
<span  style="">  53                                                                                                          </span>
<span class="-4902975925844009580" onmouseenter="enter('-4902975925844009580');" onmouseout="out('-4902975925844009580');" style="">  54     private TypeInformation&lt;Row&gt; typeInfo;                                                               </span>
<span  style="">  55                                                                                                          </span>
<span class="-6236697441540786194" onmouseenter="enter('-6236697441540786194');" onmouseout="out('-6236697441540786194');" style="">  56     private AtomicBoolean firstMsg = new AtomicBoolean(true);                                            </span>
<span  style="">  57                                                                                                          </span>
<span class="-6216421612770850251" onmouseenter="enter('-6216421612770850251');" onmouseout="out('-6216421612770850251');" style="">  58     private Calculate calculate;                                                                         </span>
<span  style="">  59                                                                                                          </span>
<span class="3112986511137480737" onmouseenter="enter('3112986511137480737');" onmouseout="out('3112986511137480737');" style=""><abbr title="  60     public KafkaDeserializationMetricWrapper(TypeInformation&lt;Row&gt; typeInfo, DeserializationSchema&lt;Row&gt; deserializationSchema, Calculate calculate) {">  60     public KafkaDeserializationMetricWrapper(TypeInformation&lt;Row&gt; typeInfo, DeserializationSchema&lt;Row&gt; deðŸ”µ</abbr></span>
<span class="3942214720745795765" onmouseenter="enter('3942214720745795765');" onmouseout="out('3942214720745795765');" style="">  61         super(typeInfo, deserializationSchema);                                                          </span>
<span class="8399279869647336028" onmouseenter="enter('8399279869647336028');" onmouseout="out('8399279869647336028');" style="">  62         this.calculate = calculate;                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  63     }                                                                                                    </span>
<span  style="">  64                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  65     @Override                                                                                            </span>
<span class="-1799581248031441833" onmouseenter="enter('-1799581248031441833');" onmouseout="out('-1799581248031441833');" style="">  66     protected void beforeDeserialize() throws IOException {                                              </span>
<span class="4505725127125543648" onmouseenter="enter('4505725127125543648');" onmouseout="out('4505725127125543648');" style="">  67         super.beforeDeserialize();                                                                       </span>
<span class="6523231691793718551" onmouseenter="enter('6523231691793718551');" onmouseout="out('6523231691793718551');" style="">  68         if (firstMsg.compareAndSet(true, false)) {                                                       </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  69             try {                                                                                        </span>
<span class="4380491174239304819" onmouseenter="enter('4380491174239304819');" onmouseout="out('4380491174239304819');" style="">  70                 registerPtMetric(fetcher);                                                               </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="">  71             } catch (Exception e) {                                                                      </span>
<span class="-2718247249494635911" onmouseenter="enter('-2718247249494635911');" onmouseout="out('-2718247249494635911');" style="">  72                 LOG.error(&quot;register topic partition metric error.&quot;, e);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  73             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  74         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  75     }                                                                                                    </span>
<span  style="">  76                                                                                                          </span>
<span class="-8432425979240803493" onmouseenter="enter('-8432425979240803493');" onmouseout="out('-8432425979240803493');" style="">  77     protected void registerPtMetric(AbstractFetcher&lt;Row, ?&gt; fetcher) throws Exception {                  </span>
<span class="-8191885679416678139" onmouseenter="enter('-8191885679416678139');" onmouseout="out('-8191885679416678139');" style="">  78         Field consumerThreadField = getConsumerThreadField(fetcher);                                     </span>
<span class="-7760031181752894688" onmouseenter="enter('-7760031181752894688');" onmouseout="out('-7760031181752894688');" style="">  79         consumerThreadField.setAccessible(true);                                                         </span>
<span class="8507904666677325012" onmouseenter="enter('8507904666677325012');" onmouseout="out('8507904666677325012');" style="">  80         KafkaConsumerThread consumerThread = ((KafkaConsumerThread) (consumerThreadField.get(fetcher))); </span>
<span class="7669891676693203744" onmouseenter="enter('7669891676693203744');" onmouseout="out('7669891676693203744');" style=""><abbr title="  81         Field hasAssignedPartitionsField = consumerThread.getClass().getDeclaredField(&quot;hasAssignedPartitions&quot;);">  81         Field hasAssignedPartitionsField = consumerThread.getClass().getDeclaredField(&quot;hasAssignedPartitiðŸ”µ</abbr></span>
<span class="-6364381604626909996" onmouseenter="enter('-6364381604626909996');" onmouseout="out('-6364381604626909996');" style="">  82         hasAssignedPartitionsField.setAccessible(true);                                                  </span>
<span class="-366391805437630217" onmouseenter="enter('-366391805437630217');" onmouseout="out('-366391805437630217');" style="">  83         // wait until assignedPartitions                                                                 </span>
<span class="-7299924221762034724" onmouseenter="enter('-7299924221762034724');" onmouseout="out('-7299924221762034724');" style="">  84         boolean hasAssignedPartitions = ((boolean) (hasAssignedPartitionsField.get(consumerThread)));    </span>
<span class="-7519647013637839101" onmouseenter="enter('-7519647013637839101');" onmouseout="out('-7519647013637839101');" style="">  85         if (!hasAssignedPartitions) {                                                                    </span>
<span class="-6260707342579154109" onmouseenter="enter('-6260707342579154109');" onmouseout="out('-6260707342579154109');" style="">  86             throw new RuntimeException(&quot;wait 50 secs, but not assignedPartitions&quot;);                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  87         }                                                                                                </span>
<span class="2892476206881062451" onmouseenter="enter('2892476206881062451');" onmouseout="out('2892476206881062451');" style="">  88         Field consumerField = consumerThread.getClass().getDeclaredField(&quot;consumer&quot;);                    </span>
<span class="-8842902760152032622" onmouseenter="enter('-8842902760152032622');" onmouseout="out('-8842902760152032622');" style="">  89         consumerField.setAccessible(true);                                                               </span>
<span class="-4739589517870064175" onmouseenter="enter('-4739589517870064175');" onmouseout="out('-4739589517870064175');" style="">  90         KafkaConsumer kafkaConsumer = ((KafkaConsumer) (consumerField.get(consumerThread)));             </span>
<span class="894227422872580400" onmouseenter="enter('894227422872580400');" onmouseout="out('894227422872580400');" style="">  91         Field subscriptionStateField = kafkaConsumer.getClass().getDeclaredField(&quot;subscriptions&quot;);       </span>
<span class="6389918226736372616" onmouseenter="enter('6389918226736372616');" onmouseout="out('6389918226736372616');" style="">  92         subscriptionStateField.setAccessible(true);                                                      </span>
<span class="-8417256850495132887" onmouseenter="enter('-8417256850495132887');" onmouseout="out('-8417256850495132887');" style="">  93         // topic partitions lag                                                                          </span>
<span class="-2901633302661925663" onmouseenter="enter('-2901633302661925663');" onmouseout="out('-2901633302661925663');" style=""><abbr title="  94         SubscriptionState subscriptionState = ((SubscriptionState) (subscriptionStateField.get(kafkaConsumer)));">  94         SubscriptionState subscriptionState = ((SubscriptionState) (subscriptionStateField.get(kafkaConsuðŸ”µ</abbr></span>
<span class="-6107961862663408818" onmouseenter="enter('-6107961862663408818');" onmouseout="out('-6107961862663408818');" style="">  95         Set&lt;TopicPartition&gt; assignedPartitions = subscriptionState.assignedPartitions();                 </span>
<span class="-7441461244274494397" onmouseenter="enter('-7441461244274494397');" onmouseout="out('-7441461244274494397');" style="">  96         for (TopicPartition topicPartition : assignedPartitions) {                                       </span>
<span class="-2701399578475818049" onmouseenter="enter('-2701399578475818049');" onmouseout="out('-2701399578475818049');" style=""><abbr title="  97             MetricGroup metricGroup = getRuntimeContext().getMetricGroup().addGroup(DT_TOPIC_GROUP, topicPartition.topic()).addGroup(DT_PARTITION_GROUP, topicPartition.partition() + &quot;&quot;);">  97             MetricGroup metricGroup = getRuntimeContext().getMetricGroup().addGroup(DT_TOPIC_GROUP, topicðŸ”µ</abbr></span>
<span class="-5230433520258489685" onmouseenter="enter('-5230433520258489685');" onmouseout="out('-5230433520258489685');" style="">  98             metricGroup.gauge(DT_TOPIC_PARTITION_LAG_GAUGE, new Gauge&lt;Long&gt;() {                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  99                 @Override                                                                                </span>
<span class="-2549929678984879043" onmouseenter="enter('-2549929678984879043');" onmouseout="out('-2549929678984879043');" style=""> 100                 public Long getValue() {                                                                 </span>
<span class="1817254173978356394" onmouseenter="enter('1817254173978356394');" onmouseout="out('1817254173978356394');" style=""> 101                     return calculate.calc(subscriptionState, topicPartition);                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 102                 }                                                                                        </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 103             });                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 104         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 105     }                                                                                                    </span>
<span  style=""> 106                                                                                                          </span>
<span class="-1208277042475452222" onmouseenter="enter('-1208277042475452222');" onmouseout="out('-1208277042475452222');" style=""> 107     public void setFetcher(AbstractFetcher&lt;Row, ?&gt; fetcher) {                                            </span>
<span class="-3526688709606912170" onmouseenter="enter('-3526688709606912170');" onmouseout="out('-3526688709606912170');" style=""> 108         this.fetcher = fetcher;                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 109     }                                                                                                    </span>
<span  style=""> 110                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 111     @Override                                                                                            </span>
<span class="985054094574866320" onmouseenter="enter('985054094574866320');" onmouseout="out('985054094574866320');" style=""> 112     public TypeInformation&lt;Row&gt; getProducedType() {                                                      </span>
<span class="5847422928769084622" onmouseenter="enter('5847422928769084622');" onmouseout="out('5847422928769084622');" style=""> 113         return typeInfo;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 114     }                                                                                                    </span>
<span  style=""> 115                                                                                                          </span>
<span class="3952065517656192652" onmouseenter="enter('3952065517656192652');" onmouseout="out('3952065517656192652');" style=""> 116     private Field getConsumerThreadField(AbstractFetcher fetcher) throws NoSuchFieldException {          </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 117         try {                                                                                            </span>
<span class="7980630892426567154" onmouseenter="enter('7980630892426567154');" onmouseout="out('7980630892426567154');" style=""> 118             return fetcher.getClass().getDeclaredField(&quot;consumerThread&quot;);                                </span>
<span class="-3589222456918676513" onmouseenter="enter('-3589222456918676513');" onmouseout="out('-3589222456918676513');" style=""> 119         } catch (java.lang.Exception e) {                                                                </span>
<span class="7490930883660259674" onmouseenter="enter('7490930883660259674');" onmouseout="out('7490930883660259674');" style=""> 120             return fetcher.getClass().getSuperclass().getDeclaredField(&quot;consumerThread&quot;);                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 121         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 122     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 123 }                                                                                                        </span>





















</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="3101153502889412828" onmouseenter="enter('3101153502889412828');" onmouseout="out('3101153502889412828');" style="">   2   * Licensed to the Apache Software Foundation (ASF) under one                                                     </span>
<span class="-6690800139350779170" onmouseenter="enter('-6690800139350779170');" onmouseout="out('-6690800139350779170');" style="">   3   * or more contributor license agreements.  See the NOTICE file                                                   </span>
<span class="4408648408749222780" onmouseenter="enter('4408648408749222780');" onmouseout="out('4408648408749222780');" style="">   4   * distributed with this work for additional information                                                          </span>
<span class="7440871955664702931" onmouseenter="enter('7440871955664702931');" onmouseout="out('7440871955664702931');" style="">   5   * regarding copyright ownership.  The ASF licenses this file                                                     </span>
<span class="-7748987699953482767" onmouseenter="enter('-7748987699953482767');" onmouseout="out('-7748987699953482767');" style="">   6   * to you under the Apache License, Version 2.0 (the                                                              </span>
<span class="-7532787339260984706" onmouseenter="enter('-7532787339260984706');" onmouseout="out('-7532787339260984706');" style="">   7   * &quot;License&quot;); you may not use this file except in compliance                                                     </span>
<span class="6072654417402056570" onmouseenter="enter('6072654417402056570');" onmouseout="out('6072654417402056570');" style="">   8   * with the License.  You may obtain a copy of the License at                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">  10   *     http://www.apache.org/licenses/LICENSE-2.0                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  11   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  12   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  15   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  16   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span  style="">  18                                                                                                                    </span>
<span class="-4860059537597571054" onmouseenter="enter('-4860059537597571054');" onmouseout="out('-4860059537597571054');" style="">  19  package com.dtstack.flink.sql.source.kafka;                                                                       </span>
<span  style="">  20                                                                                                                    </span>
<span class="-6449915967577675590" onmouseenter="enter('-6449915967577675590');" onmouseout="out('-6449915967577675590');" style="">  21  import com.dtstack.flink.sql.format.DeserializationMetricWrapper;                                                 </span>
<span class="-8410045274871986963" onmouseenter="enter('-8410045274871986963');" onmouseout="out('-8410045274871986963');" style="">  22  import org.apache.flink.api.common.serialization.DeserializationSchema;                                           </span>
<span class="-4869246525166490693" onmouseenter="enter('-4869246525166490693');" onmouseout="out('-4869246525166490693');" style="">  23  import org.apache.flink.api.common.typeinfo.TypeInformation;                                                      </span>
<span class="-4144122941458221156" onmouseenter="enter('-4144122941458221156');" onmouseout="out('-4144122941458221156');" style="">  24  import org.apache.flink.metrics.Gauge;                                                                            </span>
<span class="2890304544990601345" onmouseenter="enter('2890304544990601345');" onmouseout="out('2890304544990601345');" style="">  25  import org.apache.flink.metrics.MetricGroup;                                                                      </span>
<span class="-8829928480659738111" onmouseenter="enter('-8829928480659738111');" onmouseout="out('-8829928480659738111');" style="">  26  import org.apache.flink.streaming.connectors.kafka.internal.KafkaConsumerThread;                                  </span>
<span class="5227372441575323745" onmouseenter="enter('5227372441575323745');" onmouseout="out('5227372441575323745');" style="">  27  import org.apache.flink.streaming.connectors.kafka.internals.AbstractFetcher;                                     </span>
<span class="2962496049409651976" onmouseenter="enter('2962496049409651976');" onmouseout="out('2962496049409651976');" style="">  28  import org.apache.flink.types.Row;                                                                                </span>
<span class="5828926862428595050" onmouseenter="enter('5828926862428595050');" onmouseout="out('5828926862428595050');" style="">  29  import org.apache.kafka.clients.consumer.KafkaConsumer;                                                           </span>
<span class="-6407708023381697992" onmouseenter="enter('-6407708023381697992');" onmouseout="out('-6407708023381697992');" style="">  30  import org.apache.kafka.clients.consumer.internals.SubscriptionState;                                             </span>
<span class="-3566308373389754264" onmouseenter="enter('-3566308373389754264');" onmouseout="out('-3566308373389754264');" style="">  31  import org.apache.kafka.common.TopicPartition;                                                                    </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  32  import org.slf4j.Logger;                                                                                          </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  33  import org.slf4j.LoggerFactory;                                                                                   </span>
<span  style="">  34                                                                                                                    </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  35  import java.io.IOException;                                                                                       </span>
<span class="507320133330553151" onmouseenter="enter('507320133330553151');" onmouseout="out('507320133330553151');" style="">  36  import java.lang.reflect.Field;                                                                                   </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  37  import java.util.Set;                                                                                             </span>
<span class="-2705241621224930031" onmouseenter="enter('-2705241621224930031');" onmouseout="out('-2705241621224930031');" style="">  38  import java.util.concurrent.atomic.AtomicBoolean;                                                                 </span>
<span  style="">  39                                                                                                                    </span>
<span class="-7980418243767915169" onmouseenter="enter('-7980418243767915169');" onmouseout="out('-7980418243767915169');" style="">  40  import static com.dtstack.flink.sql.metric.MetricConstant.DT_PARTITION_GROUP;                                     </span>
<span class="-1088289402191836116" onmouseenter="enter('-1088289402191836116');" onmouseout="out('-1088289402191836116');" style="">  41  import static com.dtstack.flink.sql.metric.MetricConstant.DT_TOPIC_GROUP;                                         </span>
<span class="-726801585448151313" onmouseenter="enter('-726801585448151313');" onmouseout="out('-726801585448151313');" style="">  42  import static com.dtstack.flink.sql.metric.MetricConstant.DT_TOPIC_PARTITION_LAG_GAUGE;                           </span>
<span  style="">  43                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  44  /**                                                                                                               </span>
<span class="2924525055993403783" onmouseenter="enter('2924525055993403783');" onmouseout="out('2924525055993403783');" style="">  45   * add metric for source                                                                                          </span>
<span class="4169512172915751358" onmouseenter="enter('4169512172915751358');" onmouseout="out('4169512172915751358');" style="">  46   * &lt;p&gt;                                                                                                            </span>
<span class="-8729821338350872800" onmouseenter="enter('-8729821338350872800');" onmouseout="out('-8729821338350872800');" style="">  47   * company: www.dtstack.com                                                                                       </span>
<span class="855988645286188992" onmouseenter="enter('855988645286188992');" onmouseout="out('855988645286188992');" style="">  48   * @author: toutian                                                                                               </span>
<span class="1450268962912923596" onmouseenter="enter('1450268962912923596');" onmouseout="out('1450268962912923596');" style="">  49   * create: 2019/12/24                                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  50   */                                                                                                               </span>
<span class="-2638210892100088482" onmouseenter="enter('-2638210892100088482');" onmouseout="out('-2638210892100088482');" style="">  51  public class KafkaDeserializationMetricWrapper extends DeserializationMetricWrapper {                             </span>
<span  style="">  52                                                                                                                    </span>
<span class="5282243304209344831" onmouseenter="enter('5282243304209344831');" onmouseout="out('5282243304209344831');" style="">  53      private static final Logger LOG = LoggerFactory.getLogger(KafkaDeserializationMetricWrapper.class);           </span>
<span  style="">  54                                                                                                                    </span>
<span class="-1275427395007637155" onmouseenter="enter('-1275427395007637155');" onmouseout="out('-1275427395007637155');" style="">  55      private AbstractFetcher&lt;Row, ?&gt; fetcher;                                                                      </span>
<span class="-4902975925844009580" onmouseenter="enter('-4902975925844009580');" onmouseout="out('-4902975925844009580');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  56 +    private TypeInformation&lt;Row&gt; typeInfo;                                                                        </span>
<span  style="">  57                                                                                                                    </span>
<span class="-6236697441540786194" onmouseenter="enter('-6236697441540786194');" onmouseout="out('-6236697441540786194');" style="">  58      private AtomicBoolean firstMsg = new AtomicBoolean(true);                                                     </span>
<span  style="">  59                                                                                                                    </span>
<span class="-6216421612770850251" onmouseenter="enter('-6216421612770850251');" onmouseout="out('-6216421612770850251');" style="">  60      private Calculate calculate;                                                                                  </span>
<span  style="">  61                                                                                                                    </span>
<span class="3112986511137480737" onmouseenter="enter('3112986511137480737');" onmouseout="out('3112986511137480737');" style=""><abbr title="  62      public KafkaDeserializationMetricWrapper(TypeInformation&lt;Row&gt; typeInfo, DeserializationSchema&lt;Row&gt; deserializationSchema, Calculate calculate) {">  62      public KafkaDeserializationMetricWrapper(TypeInformation&lt;Row&gt; typeInfo, DeserializationSchema&lt;Row&gt; deserializaðŸ”µ</abbr></span>
<span class="3942214720745795765" onmouseenter="enter('3942214720745795765');" onmouseout="out('3942214720745795765');" style="">  63          super(typeInfo, deserializationSchema);                                                                   </span>
<span class="8399279869647336028" onmouseenter="enter('8399279869647336028');" onmouseout="out('8399279869647336028');" style="">  64          this.calculate = calculate;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  65      }                                                                                                             </span>
<span  style="">  66                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  67      @Override                                                                                                     </span>
<span class="-1799581248031441833" onmouseenter="enter('-1799581248031441833');" onmouseout="out('-1799581248031441833');" style="">  68      protected void beforeDeserialize() throws IOException {                                                       </span>
<span class="4505725127125543648" onmouseenter="enter('4505725127125543648');" onmouseout="out('4505725127125543648');" style="">  69          super.beforeDeserialize();                                                                                </span>
<span class="6523231691793718551" onmouseenter="enter('6523231691793718551');" onmouseout="out('6523231691793718551');" style="">  70          if (firstMsg.compareAndSet(true, false)) {                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  71              try {                                                                                                 </span>
<span class="4380491174239304819" onmouseenter="enter('4380491174239304819');" onmouseout="out('4380491174239304819');" style="">  72                  registerPtMetric(fetcher);                                                                        </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="">  73              } catch (Exception e) {                                                                               </span>
<span class="-2718247249494635911" onmouseenter="enter('-2718247249494635911');" onmouseout="out('-2718247249494635911');" style="">  74                  LOG.error(&quot;register topic partition metric error.&quot;, e);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  75              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  76          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  77      }                                                                                                             </span>
<span  style="">  78                                                                                                                    </span>
<span class="-8432425979240803493" onmouseenter="enter('-8432425979240803493');" onmouseout="out('-8432425979240803493');" style="">  79      protected void registerPtMetric(AbstractFetcher&lt;Row, ?&gt; fetcher) throws Exception {                           </span>
<span  style="">  80                                                                                                                    </span>
<span class="-8191885679416678139" onmouseenter="enter('-8191885679416678139');" onmouseout="out('-8191885679416678139');" style="">  81          Field consumerThreadField = getConsumerThreadField(fetcher);                                              </span>
<span class="-7760031181752894688" onmouseenter="enter('-7760031181752894688');" onmouseout="out('-7760031181752894688');" style="">  82          consumerThreadField.setAccessible(true);                                                                  </span>
<span class="-2866192443751632865" onmouseenter="enter('-2866192443751632865');" onmouseout="out('-2866192443751632865');" style="">  83          KafkaConsumerThread consumerThread = (KafkaConsumerThread) consumerThreadField.get(fetcher);              </span>
<span  style="">  84                                                                                                                    </span>
<span class="7669891676693203744" onmouseenter="enter('7669891676693203744');" onmouseout="out('7669891676693203744');" style="">  85          Field hasAssignedPartitionsField = consumerThread.getClass().getDeclaredField(&quot;hasAssignedPartitions&quot;);   </span>
<span class="-6364381604626909996" onmouseenter="enter('-6364381604626909996');" onmouseout="out('-6364381604626909996');" style="">  86          hasAssignedPartitionsField.setAccessible(true);                                                           </span>
<span  style="">  87                                                                                                                    </span>
<span class="-3142193783660782670" onmouseenter="enter('-3142193783660782670');" onmouseout="out('-3142193783660782670');" style="">  88          //wait until assignedPartitions                                                                           </span>
<span  style="">  89                                                                                                                    </span>
<span class="-7786559209988806161" onmouseenter="enter('-7786559209988806161');" onmouseout="out('-7786559209988806161');" style="">  90          boolean hasAssignedPartitions = (boolean) hasAssignedPartitionsField.get(consumerThread);                 </span>
<span  style="">  91                                                                                                                    </span>
<span class="-7519647013637839101" onmouseenter="enter('-7519647013637839101');" onmouseout="out('-7519647013637839101');" style="">  92          if (!hasAssignedPartitions) {                                                                             </span>
<span class="-6260707342579154109" onmouseenter="enter('-6260707342579154109');" onmouseout="out('-6260707342579154109');" style="">  93              throw new RuntimeException(&quot;wait 50 secs, but not assignedPartitions&quot;);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  94          }                                                                                                         </span>
<span  style="">  95                                                                                                                    </span>
<span class="2892476206881062451" onmouseenter="enter('2892476206881062451');" onmouseout="out('2892476206881062451');" style="">  96          Field consumerField = consumerThread.getClass().getDeclaredField(&quot;consumer&quot;);                             </span>
<span class="-8842902760152032622" onmouseenter="enter('-8842902760152032622');" onmouseout="out('-8842902760152032622');" style="">  97          consumerField.setAccessible(true);                                                                        </span>
<span  style="">  98                                                                                                                    </span>
<span class="4978140084971031415" onmouseenter="enter('4978140084971031415');" onmouseout="out('4978140084971031415');" style="">  99          KafkaConsumer kafkaConsumer = (KafkaConsumer) consumerField.get(consumerThread);                          </span>
<span class="894227422872580400" onmouseenter="enter('894227422872580400');" onmouseout="out('894227422872580400');" style=""> 100          Field subscriptionStateField = kafkaConsumer.getClass().getDeclaredField(&quot;subscriptions&quot;);                </span>
<span class="6389918226736372616" onmouseenter="enter('6389918226736372616');" onmouseout="out('6389918226736372616');" style=""> 101          subscriptionStateField.setAccessible(true);                                                               </span>
<span  style=""> 102                                                                                                                    </span>
<span class="3032872518319318392" onmouseenter="enter('3032872518319318392');" onmouseout="out('3032872518319318392');" style=""> 103          //topic partitions lag                                                                                    </span>
<span class="4731746494435406121" onmouseenter="enter('4731746494435406121');" onmouseout="out('4731746494435406121');" style=""> 104          SubscriptionState subscriptionState = (SubscriptionState) subscriptionStateField.get(kafkaConsumer);      </span>
<span class="-6107961862663408818" onmouseenter="enter('-6107961862663408818');" onmouseout="out('-6107961862663408818');" style=""> 105          Set&lt;TopicPartition&gt; assignedPartitions = subscriptionState.assignedPartitions();                          </span>
<span  style=""> 106                                                                                                                    </span>
<span class="-7441461244274494397" onmouseenter="enter('-7441461244274494397');" onmouseout="out('-7441461244274494397');" style=""> 107          for (TopicPartition topicPartition : assignedPartitions) {                                                </span>
<span class="6044695378852942901" onmouseenter="enter('6044695378852942901');" onmouseout="out('6044695378852942901');" style=""><abbr title=" 108              MetricGroup metricGroup = getRuntimeContext().getMetricGroup().addGroup(DT_TOPIC_GROUP, topicPartition.topic())"> 108              MetricGroup metricGroup = getRuntimeContext().getMetricGroup().addGroup(DT_TOPIC_GROUP, topicPartitionðŸ”µ</abbr></span>
<span class="-2843212987053254120" onmouseenter="enter('-2843212987053254120');" onmouseout="out('-2843212987053254120');" style=""> 109                      .addGroup(DT_PARTITION_GROUP, topicPartition.partition() + &quot;&quot;);                               </span>
<span class="-5230433520258489685" onmouseenter="enter('-5230433520258489685');" onmouseout="out('-5230433520258489685');" style=""> 110              metricGroup.gauge(DT_TOPIC_PARTITION_LAG_GAUGE, new Gauge&lt;Long&gt;() {                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 111                  @Override                                                                                         </span>
<span class="-2549929678984879043" onmouseenter="enter('-2549929678984879043');" onmouseout="out('-2549929678984879043');" style=""> 112                  public Long getValue() {                                                                          </span>
<span class="1817254173978356394" onmouseenter="enter('1817254173978356394');" onmouseout="out('1817254173978356394');" style=""> 113                      return calculate.calc(subscriptionState, topicPartition);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 114                  }                                                                                                 </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 115              });                                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 116          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 117      }                                                                                                             </span>
<span  style=""> 118                                                                                                                    </span>
<span class="6788360600509724127" onmouseenter="enter('6788360600509724127');" onmouseout="out('6788360600509724127');" style=""> 119      private Field getConsumerThreadField(AbstractFetcher&lt;Row, ?&gt; fetcher) throws NoSuchFieldException {           </span>





<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 120          try {                                                                                                     </span>
<span class="7980630892426567154" onmouseenter="enter('7980630892426567154');" onmouseout="out('7980630892426567154');" style=""> 121              return fetcher.getClass().getDeclaredField(&quot;consumerThread&quot;);                                         </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 122          } catch (Exception e) {                                                                                   </span>
<span class="7490930883660259674" onmouseenter="enter('7490930883660259674');" onmouseout="out('7490930883660259674');" style=""> 123              return fetcher.getClass().getSuperclass().getDeclaredField(&quot;consumerThread&quot;);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 124          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 125      }                                                                                                             </span>
<span  style=""> 126                                                                                                                    </span>
<span class="-1208277042475452222" onmouseenter="enter('-1208277042475452222');" onmouseout="out('-1208277042475452222');" style=""> 127      public void setFetcher(AbstractFetcher&lt;Row, ?&gt; fetcher) {                                                     </span>
<span class="-3526688709606912170" onmouseenter="enter('-3526688709606912170');" onmouseout="out('-3526688709606912170');" style=""> 128          this.fetcher = fetcher;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129      }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +                                                                                                                  </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +    @Override                                                                                                     </span>
<span class="985054094574866320" onmouseenter="enter('985054094574866320');" onmouseout="out('985054094574866320');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +    public TypeInformation&lt;Row&gt; getProducedType() {                                                               </span>
<span class="5847422928769084622" onmouseenter="enter('5847422928769084622');" onmouseout="out('5847422928769084622');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +        return typeInfo;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +    }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 135  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="3101153502889412828" onmouseenter="enter('3101153502889412828');" onmouseout="out('3101153502889412828');" style="">   2   * Licensed to the Apache Software Foundation (ASF) under one                                                     </span>
<span class="-6690800139350779170" onmouseenter="enter('-6690800139350779170');" onmouseout="out('-6690800139350779170');" style="">   3   * or more contributor license agreements.  See the NOTICE file                                                   </span>
<span class="4408648408749222780" onmouseenter="enter('4408648408749222780');" onmouseout="out('4408648408749222780');" style="">   4   * distributed with this work for additional information                                                          </span>
<span class="7440871955664702931" onmouseenter="enter('7440871955664702931');" onmouseout="out('7440871955664702931');" style="">   5   * regarding copyright ownership.  The ASF licenses this file                                                     </span>
<span class="-7748987699953482767" onmouseenter="enter('-7748987699953482767');" onmouseout="out('-7748987699953482767');" style="">   6   * to you under the Apache License, Version 2.0 (the                                                              </span>
<span class="-7532787339260984706" onmouseenter="enter('-7532787339260984706');" onmouseout="out('-7532787339260984706');" style="">   7   * &quot;License&quot;); you may not use this file except in compliance                                                     </span>
<span class="6072654417402056570" onmouseenter="enter('6072654417402056570');" onmouseout="out('6072654417402056570');" style="">   8   * with the License.  You may obtain a copy of the License at                                                     </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">   9   *                                                                                                                </span>
<span class="-6984878691993713389" onmouseenter="enter('-6984878691993713389');" onmouseout="out('-6984878691993713389');" style="">  10   *     http://www.apache.org/licenses/LICENSE-2.0                                                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  11   *                                                                                                                </span>
<span class="2557607632756179983" onmouseenter="enter('2557607632756179983');" onmouseout="out('2557607632756179983');" style="">  12   * Unless required by applicable law or agreed to in writing, software                                            </span>
<span class="-9189129105512731955" onmouseenter="enter('-9189129105512731955');" onmouseout="out('-9189129105512731955');" style="">  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,                                              </span>
<span class="5781161717946418340" onmouseenter="enter('5781161717946418340');" onmouseout="out('5781161717946418340');" style="">  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                       </span>
<span class="1761562277992059393" onmouseenter="enter('1761562277992059393');" onmouseout="out('1761562277992059393');" style="">  15   * See the License for the specific language governing permissions and                                            </span>
<span class="7217408601297779962" onmouseenter="enter('7217408601297779962');" onmouseout="out('7217408601297779962');" style="">  16   * limitations under the License.                                                                                 </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span  style="">  18                                                                                                                    </span>
<span class="-4860059537597571054" onmouseenter="enter('-4860059537597571054');" onmouseout="out('-4860059537597571054');" style="">  19  package com.dtstack.flink.sql.source.kafka;                                                                       </span>
<span  style="">  20                                                                                                                    </span>
<span class="-6449915967577675590" onmouseenter="enter('-6449915967577675590');" onmouseout="out('-6449915967577675590');" style="">  21  import com.dtstack.flink.sql.format.DeserializationMetricWrapper;                                                 </span>
<span class="-8410045274871986963" onmouseenter="enter('-8410045274871986963');" onmouseout="out('-8410045274871986963');" style="">  22  import org.apache.flink.api.common.serialization.DeserializationSchema;                                           </span>
<span class="-4869246525166490693" onmouseenter="enter('-4869246525166490693');" onmouseout="out('-4869246525166490693');" style="">  23  import org.apache.flink.api.common.typeinfo.TypeInformation;                                                      </span>
<span class="-4144122941458221156" onmouseenter="enter('-4144122941458221156');" onmouseout="out('-4144122941458221156');" style="">  24  import org.apache.flink.metrics.Gauge;                                                                            </span>
<span class="2890304544990601345" onmouseenter="enter('2890304544990601345');" onmouseout="out('2890304544990601345');" style="">  25  import org.apache.flink.metrics.MetricGroup;                                                                      </span>
<span class="-8829928480659738111" onmouseenter="enter('-8829928480659738111');" onmouseout="out('-8829928480659738111');" style="">  26  import org.apache.flink.streaming.connectors.kafka.internal.KafkaConsumerThread;                                  </span>
<span class="5227372441575323745" onmouseenter="enter('5227372441575323745');" onmouseout="out('5227372441575323745');" style="">  27  import org.apache.flink.streaming.connectors.kafka.internals.AbstractFetcher;                                     </span>
<span class="2962496049409651976" onmouseenter="enter('2962496049409651976');" onmouseout="out('2962496049409651976');" style="">  28  import org.apache.flink.types.Row;                                                                                </span>
<span class="5828926862428595050" onmouseenter="enter('5828926862428595050');" onmouseout="out('5828926862428595050');" style="">  29  import org.apache.kafka.clients.consumer.KafkaConsumer;                                                           </span>
<span class="-6407708023381697992" onmouseenter="enter('-6407708023381697992');" onmouseout="out('-6407708023381697992');" style="">  30  import org.apache.kafka.clients.consumer.internals.SubscriptionState;                                             </span>
<span class="-3566308373389754264" onmouseenter="enter('-3566308373389754264');" onmouseout="out('-3566308373389754264');" style="">  31  import org.apache.kafka.common.TopicPartition;                                                                    </span>
<span class="9072327285961251154" onmouseenter="enter('9072327285961251154');" onmouseout="out('9072327285961251154');" style="">  32  import org.slf4j.Logger;                                                                                          </span>
<span class="697043352225962606" onmouseenter="enter('697043352225962606');" onmouseout="out('697043352225962606');" style="">  33  import org.slf4j.LoggerFactory;                                                                                   </span>
<span  style="">  34                                                                                                                    </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  35  import java.io.IOException;                                                                                       </span>
<span class="507320133330553151" onmouseenter="enter('507320133330553151');" onmouseout="out('507320133330553151');" style="">  36  import java.lang.reflect.Field;                                                                                   </span>
<span class="3384353015976675773" onmouseenter="enter('3384353015976675773');" onmouseout="out('3384353015976675773');" style="">  37  import java.util.Set;                                                                                             </span>
<span class="-2705241621224930031" onmouseenter="enter('-2705241621224930031');" onmouseout="out('-2705241621224930031');" style="">  38  import java.util.concurrent.atomic.AtomicBoolean;                                                                 </span>
<span  style="">  39                                                                                                                    </span>
<span class="-7980418243767915169" onmouseenter="enter('-7980418243767915169');" onmouseout="out('-7980418243767915169');" style="">  40  import static com.dtstack.flink.sql.metric.MetricConstant.DT_PARTITION_GROUP;                                     </span>
<span class="-1088289402191836116" onmouseenter="enter('-1088289402191836116');" onmouseout="out('-1088289402191836116');" style="">  41  import static com.dtstack.flink.sql.metric.MetricConstant.DT_TOPIC_GROUP;                                         </span>
<span class="-726801585448151313" onmouseenter="enter('-726801585448151313');" onmouseout="out('-726801585448151313');" style="">  42  import static com.dtstack.flink.sql.metric.MetricConstant.DT_TOPIC_PARTITION_LAG_GAUGE;                           </span>
<span  style="">  43                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  44  /**                                                                                                               </span>
<span class="2924525055993403783" onmouseenter="enter('2924525055993403783');" onmouseout="out('2924525055993403783');" style="">  45   * add metric for source                                                                                          </span>
<span class="4169512172915751358" onmouseenter="enter('4169512172915751358');" onmouseout="out('4169512172915751358');" style="">  46   * &lt;p&gt;                                                                                                            </span>
<span class="-8729821338350872800" onmouseenter="enter('-8729821338350872800');" onmouseout="out('-8729821338350872800');" style="">  47   * company: www.dtstack.com                                                                                       </span>
<span class="855988645286188992" onmouseenter="enter('855988645286188992');" onmouseout="out('855988645286188992');" style="">  48   * @author: toutian                                                                                               </span>
<span class="1450268962912923596" onmouseenter="enter('1450268962912923596');" onmouseout="out('1450268962912923596');" style="">  49   * create: 2019/12/24                                                                                             </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  50   */                                                                                                               </span>
<span class="-2638210892100088482" onmouseenter="enter('-2638210892100088482');" onmouseout="out('-2638210892100088482');" style="">  51  public class KafkaDeserializationMetricWrapper extends DeserializationMetricWrapper {                             </span>
<span  style="">  52                                                                                                                    </span>
<span class="5282243304209344831" onmouseenter="enter('5282243304209344831');" onmouseout="out('5282243304209344831');" style="">  53      private static final Logger LOG = LoggerFactory.getLogger(KafkaDeserializationMetricWrapper.class);           </span>
<span  style="">  54                                                                                                                    </span>
<span class="-1275427395007637155" onmouseenter="enter('-1275427395007637155');" onmouseout="out('-1275427395007637155');" style="">  55      private AbstractFetcher&lt;Row, ?&gt; fetcher;                                                                      </span>

<span  style="">  56                                                                                                                    </span>
<span class="-6236697441540786194" onmouseenter="enter('-6236697441540786194');" onmouseout="out('-6236697441540786194');" style="">  57      private AtomicBoolean firstMsg = new AtomicBoolean(true);                                                     </span>
<span  style="">  58                                                                                                                    </span>
<span class="-6216421612770850251" onmouseenter="enter('-6216421612770850251');" onmouseout="out('-6216421612770850251');" style="">  59      private Calculate calculate;                                                                                  </span>
<span  style="">  60                                                                                                                    </span>
<span class="3112986511137480737" onmouseenter="enter('3112986511137480737');" onmouseout="out('3112986511137480737');" style=""><abbr title="  61      public KafkaDeserializationMetricWrapper(TypeInformation&lt;Row&gt; typeInfo, DeserializationSchema&lt;Row&gt; deserializationSchema, Calculate calculate) {">  61      public KafkaDeserializationMetricWrapper(TypeInformation&lt;Row&gt; typeInfo, DeserializationSchema&lt;Row&gt; deserializaðŸ”µ</abbr></span>
<span class="3942214720745795765" onmouseenter="enter('3942214720745795765');" onmouseout="out('3942214720745795765');" style="">  62          super(typeInfo, deserializationSchema);                                                                   </span>
<span class="8399279869647336028" onmouseenter="enter('8399279869647336028');" onmouseout="out('8399279869647336028');" style="">  63          this.calculate = calculate;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  64      }                                                                                                             </span>
<span  style="">  65                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style="">  66      @Override                                                                                                     </span>
<span class="-1799581248031441833" onmouseenter="enter('-1799581248031441833');" onmouseout="out('-1799581248031441833');" style="">  67      protected void beforeDeserialize() throws IOException {                                                       </span>
<span class="4505725127125543648" onmouseenter="enter('4505725127125543648');" onmouseout="out('4505725127125543648');" style="">  68          super.beforeDeserialize();                                                                                </span>
<span class="6523231691793718551" onmouseenter="enter('6523231691793718551');" onmouseout="out('6523231691793718551');" style="">  69          if (firstMsg.compareAndSet(true, false)) {                                                                </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style="">  70              try {                                                                                                 </span>
<span class="4380491174239304819" onmouseenter="enter('4380491174239304819');" onmouseout="out('4380491174239304819');" style="">  71                  registerPtMetric(fetcher);                                                                        </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style="">  72              } catch (Exception e) {                                                                               </span>
<span class="-2718247249494635911" onmouseenter="enter('-2718247249494635911');" onmouseout="out('-2718247249494635911');" style="">  73                  LOG.error(&quot;register topic partition metric error.&quot;, e);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  74              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  75          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  76      }                                                                                                             </span>
<span  style="">  77                                                                                                                    </span>
<span class="-8432425979240803493" onmouseenter="enter('-8432425979240803493');" onmouseout="out('-8432425979240803493');" style="">  78      protected void registerPtMetric(AbstractFetcher&lt;Row, ?&gt; fetcher) throws Exception {                           </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  79 -                                                                                                                  </span>
<span class="-8191885679416678139" onmouseenter="enter('-8191885679416678139');" onmouseout="out('-8191885679416678139');" style="">  80          Field consumerThreadField = getConsumerThreadField(fetcher);                                              </span>
<span class="-7760031181752894688" onmouseenter="enter('-7760031181752894688');" onmouseout="out('-7760031181752894688');" style="">  81          consumerThreadField.setAccessible(true);                                                                  </span>
<span class="-2866192443751632865" onmouseenter="enter('-2866192443751632865');" onmouseout="out('-2866192443751632865');" style="">  82          KafkaConsumerThread consumerThread = (KafkaConsumerThread) consumerThreadField.get(fetcher);              </span>
<span  style="">  83                                                                                                                    </span>
<span class="7669891676693203744" onmouseenter="enter('7669891676693203744');" onmouseout="out('7669891676693203744');" style="">  84          Field hasAssignedPartitionsField = consumerThread.getClass().getDeclaredField(&quot;hasAssignedPartitions&quot;);   </span>
<span class="-6364381604626909996" onmouseenter="enter('-6364381604626909996');" onmouseout="out('-6364381604626909996');" style="">  85          hasAssignedPartitionsField.setAccessible(true);                                                           </span>
<span  style="">  86                                                                                                                    </span>
<span class="-3142193783660782670" onmouseenter="enter('-3142193783660782670');" onmouseout="out('-3142193783660782670');" style="">  87          //wait until assignedPartitions                                                                           </span>
<span  style="">  88                                                                                                                    </span>
<span class="-7786559209988806161" onmouseenter="enter('-7786559209988806161');" onmouseout="out('-7786559209988806161');" style="">  89          boolean hasAssignedPartitions = (boolean) hasAssignedPartitionsField.get(consumerThread);                 </span>
<span  style="">  90                                                                                                                    </span>
<span class="-7519647013637839101" onmouseenter="enter('-7519647013637839101');" onmouseout="out('-7519647013637839101');" style="">  91          if (!hasAssignedPartitions) {                                                                             </span>
<span class="-6260707342579154109" onmouseenter="enter('-6260707342579154109');" onmouseout="out('-6260707342579154109');" style="">  92              throw new RuntimeException(&quot;wait 50 secs, but not assignedPartitions&quot;);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="">  93          }                                                                                                         </span>
<span  style="">  94                                                                                                                    </span>
<span class="2892476206881062451" onmouseenter="enter('2892476206881062451');" onmouseout="out('2892476206881062451');" style="">  95          Field consumerField = consumerThread.getClass().getDeclaredField(&quot;consumer&quot;);                             </span>
<span class="-8842902760152032622" onmouseenter="enter('-8842902760152032622');" onmouseout="out('-8842902760152032622');" style="">  96          consumerField.setAccessible(true);                                                                        </span>
<span  style="">  97                                                                                                                    </span>
<span class="4978140084971031415" onmouseenter="enter('4978140084971031415');" onmouseout="out('4978140084971031415');" style="">  98          KafkaConsumer kafkaConsumer = (KafkaConsumer) consumerField.get(consumerThread);                          </span>
<span class="894227422872580400" onmouseenter="enter('894227422872580400');" onmouseout="out('894227422872580400');" style="">  99          Field subscriptionStateField = kafkaConsumer.getClass().getDeclaredField(&quot;subscriptions&quot;);                </span>
<span class="6389918226736372616" onmouseenter="enter('6389918226736372616');" onmouseout="out('6389918226736372616');" style=""> 100          subscriptionStateField.setAccessible(true);                                                               </span>
<span  style=""> 101                                                                                                                    </span>
<span class="3032872518319318392" onmouseenter="enter('3032872518319318392');" onmouseout="out('3032872518319318392');" style=""> 102          //topic partitions lag                                                                                    </span>
<span class="4731746494435406121" onmouseenter="enter('4731746494435406121');" onmouseout="out('4731746494435406121');" style=""> 103          SubscriptionState subscriptionState = (SubscriptionState) subscriptionStateField.get(kafkaConsumer);      </span>
<span class="-6107961862663408818" onmouseenter="enter('-6107961862663408818');" onmouseout="out('-6107961862663408818');" style=""> 104          Set&lt;TopicPartition&gt; assignedPartitions = subscriptionState.assignedPartitions();                          </span>
<span  style=""> 105                                                                                                                    </span>
<span class="-7441461244274494397" onmouseenter="enter('-7441461244274494397');" onmouseout="out('-7441461244274494397');" style=""> 106          for (TopicPartition topicPartition : assignedPartitions) {                                                </span>
<span class="6044695378852942901" onmouseenter="enter('6044695378852942901');" onmouseout="out('6044695378852942901');" style=""><abbr title=" 107              MetricGroup metricGroup = getRuntimeContext().getMetricGroup().addGroup(DT_TOPIC_GROUP, topicPartition.topic())"> 107              MetricGroup metricGroup = getRuntimeContext().getMetricGroup().addGroup(DT_TOPIC_GROUP, topicPartitionðŸ”µ</abbr></span>
<span class="-2843212987053254120" onmouseenter="enter('-2843212987053254120');" onmouseout="out('-2843212987053254120');" style=""> 108                      .addGroup(DT_PARTITION_GROUP, topicPartition.partition() + &quot;&quot;);                               </span>
<span class="-5230433520258489685" onmouseenter="enter('-5230433520258489685');" onmouseout="out('-5230433520258489685');" style=""> 109              metricGroup.gauge(DT_TOPIC_PARTITION_LAG_GAUGE, new Gauge&lt;Long&gt;() {                                   </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 110                  @Override                                                                                         </span>
<span class="-2549929678984879043" onmouseenter="enter('-2549929678984879043');" onmouseout="out('-2549929678984879043');" style=""> 111                  public Long getValue() {                                                                          </span>
<span class="1817254173978356394" onmouseenter="enter('1817254173978356394');" onmouseout="out('1817254173978356394');" style=""> 112                      return calculate.calc(subscriptionState, topicPartition);                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 113                  }                                                                                                 </span>
<span class="7938821646327104961" onmouseenter="enter('7938821646327104961');" onmouseout="out('7938821646327104961');" style=""> 114              });                                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 115          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 116      }                                                                                                             </span>
<span  style=""> 117                                                                                                                    </span>
<span class="6788360600509724127" onmouseenter="enter('6788360600509724127');" onmouseout="out('6788360600509724127');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 118 -    private Field getConsumerThreadField(AbstractFetcher&lt;Row, ?&gt; fetcher) throws NoSuchFieldException {           </span>
<span class="-1208277042475452222" onmouseenter="enter('-1208277042475452222');" onmouseout="out('-1208277042475452222');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +    public void setFetcher(AbstractFetcher&lt;Row, ?&gt; fetcher) {                                                     </span>
<span class="-3526688709606912170" onmouseenter="enter('-3526688709606912170');" onmouseout="out('-3526688709606912170');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +        this.fetcher = fetcher;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +                                                                                                                  </span>
<span class="3952065517656192652" onmouseenter="enter('3952065517656192652');" onmouseout="out('3952065517656192652');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +    private Field getConsumerThreadField(AbstractFetcher fetcher) throws NoSuchFieldException {                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 124          try {                                                                                                     </span>
<span class="7980630892426567154" onmouseenter="enter('7980630892426567154');" onmouseout="out('7980630892426567154');" style=""> 125              return fetcher.getClass().getDeclaredField(&quot;consumerThread&quot;);                                         </span>
<span class="2627011698774241688" onmouseenter="enter('2627011698774241688');" onmouseout="out('2627011698774241688');" style=""> 126          } catch (Exception e) {                                                                                   </span>
<span class="7490930883660259674" onmouseenter="enter('7490930883660259674');" onmouseout="out('7490930883660259674');" style=""> 127              return fetcher.getClass().getSuperclass().getDeclaredField(&quot;consumerThread&quot;);                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 128          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129      }                                                                                                             </span>
<span  style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 130 -                                                                                                                  </span>
<span class="-1208277042475452222" onmouseenter="enter('-1208277042475452222');" onmouseout="out('-1208277042475452222');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 131 -    public void setFetcher(AbstractFetcher&lt;Row, ?&gt; fetcher) {                                                     </span>
<span class="-3526688709606912170" onmouseenter="enter('-3526688709606912170');" onmouseout="out('-3526688709606912170');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 132 -        this.fetcher = fetcher;                                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 133 -    }                                                                                                             </span>





<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 134  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            