<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>313</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        .highlighted {
                            background-color: rgba(177, 82, 227, 0.85) !important;
                        }
                    </style>
                    <script>
                        function enter(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.add('highlighted');
                            }
                        }
                        function out(c) {
                            const lines = document.getElementsByClassName(c);
                            for (let i = 0; i < lines.length; i++) {
                               lines.item(i).classList.remove('highlighted');
                            }
                        }
                    </script>
              </head>
              <body>
                <span style="height: 4vh">
                    313
                    <a href="312.html">prev</a>
                    <a href="314.html">next</a>
                    <a href="313_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_5e7616834a9f9c363492a1453124dee15a0c8249_admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/file/service/StaticAssetStorageServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;5e7616834a9f9c363492a1453124dee15a0c8249:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/file/service/StaticAssetStorageServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;5e7616834a9f9c363492a1453124dee15a0c8249^1:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/file/service/StaticAssetStorageServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;5e7616834a9f9c363492a1453124dee15a0c8249^2:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/file/service/StaticAssetStorageServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;52f7d19e4df25237a77fe0e635e773824ee19a7d:admin/broadleaf-contentmanagement-module/src/main/java/org/broadleafcommerce/cms/file/service/StaticAssetStorageServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-6173756248845875922" onmouseenter="enter('-6173756248845875922');" onmouseout="out('-6173756248845875922');" style="">   3  * BroadleafCommerce CMS Module                                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-2980987384224312133" onmouseenter="enter('-2980987384224312133');" onmouseout="out('-2980987384224312133');" style="">  18 package org.broadleafcommerce.cms.file.service;                                                          </span>
<span  style="">  19                                                                                                          </span>
<span class="650718985643898152" onmouseenter="enter('650718985643898152');" onmouseout="out('650718985643898152');" style="">  20 import org.apache.commons.collections4.MapUtils;                                                         </span>
<span class="1592055122970313625" onmouseenter="enter('1592055122970313625');" onmouseout="out('1592055122970313625');" style="">  21 import org.apache.commons.io.FileExistsException;                                                        </span>
<span class="1419696606949779000" onmouseenter="enter('1419696606949779000');" onmouseout="out('1419696606949779000');" style="">  22 import org.apache.commons.io.FileUtils;                                                                  </span>
<span class="-2296051308340473600" onmouseenter="enter('-2296051308340473600');" onmouseout="out('-2296051308340473600');" style="">  23 import org.apache.commons.io.FilenameUtils;                                                              </span>
<span class="-7541571572495339903" onmouseenter="enter('-7541571572495339903');" onmouseout="out('-7541571572495339903');" style="">  24 import org.apache.commons.io.IOUtils;                                                                    </span>
<span class="-7366736394295216840" onmouseenter="enter('-7366736394295216840');" onmouseout="out('-7366736394295216840');" style="">  25 import org.apache.commons.lang.ArrayUtils;                                                               </span>
<span class="-8105670274694144339" onmouseenter="enter('-8105670274694144339');" onmouseout="out('-8105670274694144339');" style="">  26 import org.apache.commons.lang3.StringUtils;                                                             </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  27 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  28 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="6421182070533632471" onmouseenter="enter('6421182070533632471');" onmouseout="out('6421182070533632471');" style="">  29 import org.broadleafcommerce.cms.common.AssetNotFoundException;                                          </span>
<span class="8163806430712317298" onmouseenter="enter('8163806430712317298');" onmouseout="out('8163806430712317298');" style="">  30 import org.broadleafcommerce.cms.field.type.StorageType;                                                 </span>
<span class="-8427882675756262690" onmouseenter="enter('-8427882675756262690');" onmouseout="out('-8427882675756262690');" style="">  31 import org.broadleafcommerce.cms.file.dao.StaticAssetStorageDao;                                         </span>
<span class="1355270185972111851" onmouseenter="enter('1355270185972111851');" onmouseout="out('1355270185972111851');" style="">  32 import org.broadleafcommerce.cms.file.domain.StaticAsset;                                                </span>
<span class="-9103956258218147401" onmouseenter="enter('-9103956258218147401');" onmouseout="out('-9103956258218147401');" style="">  33 import org.broadleafcommerce.cms.file.domain.StaticAssetStorage;                                         </span>
<span class="9188568145725907286" onmouseenter="enter('9188568145725907286');" onmouseout="out('9188568145725907286');" style="">  34 import org.broadleafcommerce.cms.file.service.operation.NamedOperationManager;                           </span>
<span class="-1074856182010318298" onmouseenter="enter('-1074856182010318298');" onmouseout="out('-1074856182010318298');" style="">  35 import org.broadleafcommerce.common.audit.Auditable;                                                     </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  36 import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                     </span>
<span class="-8339254235515724670" onmouseenter="enter('-8339254235515724670');" onmouseout="out('-8339254235515724670');" style="">  37 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;                                 </span>
<span class="-2507677682672524762" onmouseenter="enter('-2507677682672524762');" onmouseout="out('-2507677682672524762');" style="">  38 import org.broadleafcommerce.common.file.domain.FileWorkArea;                                            </span>
<span class="3660177375850747944" onmouseenter="enter('3660177375850747944');" onmouseout="out('3660177375850747944');" style="">  39 import org.broadleafcommerce.common.file.service.BroadleafFileService;                                   </span>
<span class="-6194024147123816671" onmouseenter="enter('-6194024147123816671');" onmouseout="out('-6194024147123816671');" style="">  40 import org.broadleafcommerce.common.file.service.GloballySharedInputStream;                              </span>
<span class="8070124246740049341" onmouseenter="enter('8070124246740049341');" onmouseout="out('8070124246740049341');" style="">  41 import org.broadleafcommerce.common.io.ConcurrentFileOutputStream;                                       </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  42 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                     </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  43 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                </span>
<span class="-32928361580396825" onmouseenter="enter('-32928361580396825');" onmouseout="out('-32928361580396825');" style="">  44 import org.broadleafcommerce.openadmin.server.service.artifact.ArtifactService;                          </span>
<span class="-7077569502978710918" onmouseenter="enter('-7077569502978710918');" onmouseout="out('-7077569502978710918');" style="">  45 import org.broadleafcommerce.openadmin.server.service.artifact.image.Operation;                          </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  46 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-4667942192763773056" onmouseenter="enter('-4667942192763773056');" onmouseout="out('-4667942192763773056');" style="">  47 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours                                                                             </span>
<span class="-1779577819582542853" onmouseenter="enter('-1779577819582542853');" onmouseout="out('-1779577819582542853');" style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  48 import org.springframework.boot.autoconfigure.web.servlet.MultipartProperties;                           </span>
<span class="6741223626729319096" onmouseenter="enter('6741223626729319096');" onmouseout="out('6741223626729319096');" style="">  49 ||||||| GitAnalyzerPlus_base                                                                             </span>
<span class="6709227556361837386" onmouseenter="enter('6709227556361837386');" onmouseout="out('6709227556361837386');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import org.springframework.boot.autoconfigure.web.MultipartProperties;                                   </span>
<span class="2802840430073505079" onmouseenter="enter('2802840430073505079');" onmouseout="out('2802840430073505079');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import org.springframework.core.env.Environment;                                                         </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import org.springframework.stereotype.Service;                                                           </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import org.springframework.transaction.annotation.Transactional;                                         </span>
<span class="4828820138133011218" onmouseenter="enter('4828820138133011218');" onmouseout="out('4828820138133011218');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import org.springframework.web.multipart.MultipartFile;                                                  </span>
<span  style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55                                                                                                          </span>
<span class="-8084092933789958161" onmouseenter="enter('-8084092933789958161');" onmouseout="out('-8084092933789958161');" style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 import java.io.BufferedInputStream;                                                                      </span>
<span class="3796057323931724632" onmouseenter="enter('3796057323931724632');" onmouseout="out('3796057323931724632');" style="">  57 =======                                                                                                  </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="6709227556361837386" onmouseenter="enter('6709227556361837386');" onmouseout="out('6709227556361837386');" style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59 import org.springframework.boot.autoconfigure.web.MultipartProperties;                                   </span>
<span class="-1382546150375666264" onmouseenter="enter('-1382546150375666264');" onmouseout="out('-1382546150375666264');" style="">  60 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs                                                                           </span>
<span class="2802840430073505079" onmouseenter="enter('2802840430073505079');" onmouseout="out('2802840430073505079');" style="">  61 import org.springframework.core.env.Environment;                                                         </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  62 import org.springframework.stereotype.Service;                                                           </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  63 import org.springframework.transaction.annotation.Transactional;                                         </span>
<span class="4828820138133011218" onmouseenter="enter('4828820138133011218');" onmouseout="out('4828820138133011218');" style="">  64 import org.springframework.web.multipart.MultipartFile;                                                  </span>
<span  style="">  65                                                                                                          </span>
<span class="-8084092933789958161" onmouseenter="enter('-8084092933789958161');" onmouseout="out('-8084092933789958161');" style="">  66 import java.io.BufferedInputStream;                                                                      </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  67 import java.io.File;                                                                                     </span>
<span class="-535075201057145249" onmouseenter="enter('-535075201057145249');" onmouseout="out('-535075201057145249');" style="">  68 import java.io.FileInputStream;                                                                          </span>
<span class="4915709264156936957" onmouseenter="enter('4915709264156936957');" onmouseout="out('4915709264156936957');" style="">  69 import java.io.FileOutputStream;                                                                         </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  70 import java.io.IOException;                                                                              </span>
<span class="5631563232245871054" onmouseenter="enter('5631563232245871054');" onmouseout="out('5631563232245871054');" style="">  71 import java.io.InputStream;                                                                              </span>
<span class="4621164050749610193" onmouseenter="enter('4621164050749610193');" onmouseout="out('4621164050749610193');" style="">  72 import java.io.OutputStream;                                                                             </span>
<span class="-40197902381950972" onmouseenter="enter('-40197902381950972');" onmouseout="out('-40197902381950972');" style="">  73 import java.math.BigInteger;                                                                             </span>
<span class="6381430938828950472" onmouseenter="enter('6381430938828950472');" onmouseout="out('6381430938828950472');" style="">  74 import java.security.MessageDigest;                                                                      </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  75 import java.security.NoSuchAlgorithmException;                                                           </span>
<span class="-5709181831744795488" onmouseenter="enter('-5709181831744795488');" onmouseout="out('-5709181831744795488');" style="">  76 import java.sql.Blob;                                                                                    </span>
<span class="-515559982825150111" onmouseenter="enter('-515559982825150111');" onmouseout="out('-515559982825150111');" style="">  77 import java.sql.SQLException;                                                                            </span>
<span class="54331962280914690" onmouseenter="enter('54331962280914690');" onmouseout="out('54331962280914690');" style="">  78 import java.text.SimpleDateFormat;                                                                       </span>
<span class="-28465676010609596" onmouseenter="enter('-28465676010609596');" onmouseout="out('-28465676010609596');" style="">  79 import java.util.Arrays;                                                                                 </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  80 import java.util.HashMap;                                                                                </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  81 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  82 import java.util.Map;                                                                                    </span>
<span  style="">  83                                                                                                          </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  84 import javax.annotation.Resource;                                                                        </span>
<span  style="">  85                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  86 /**                                                                                                      </span>
<span class="5819561638806578074" onmouseenter="enter('5819561638806578074');" onmouseout="out('5819561638806578074');" style="">  87  * @author Jeff Fischer, Brian Polster                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  88  */                                                                                                      </span>
<span class="8555986608199362624" onmouseenter="enter('8555986608199362624');" onmouseout="out('8555986608199362624');" style="">  89 @Service(&quot;blStaticAssetStorageService&quot;)                                                                  </span>
<span class="-5440937737927857026" onmouseenter="enter('-5440937737927857026');" onmouseout="out('-5440937737927857026');" style="">  90 public class StaticAssetStorageServiceImpl implements StaticAssetStorageService {                        </span>
<span  style="">  91                                                                                                          </span>
<span class="2858988269359695714" onmouseenter="enter('2858988269359695714');" onmouseout="out('2858988269359695714');" style="">  92     private static final Log LOG = LogFactory.getLog(StaticAssetStorageServiceImpl.class);               </span>
<span  style="">  93                                                                                                          </span>
<span class="3730583078767808053" onmouseenter="enter('3730583078767808053');" onmouseout="out('3730583078767808053');" style="">  94     protected static final String DEFAULT_ADMIN_IMAGE_EXTENSIONS = &quot;bmp,jpg,jpeg,png,img,tiff,gif&quot;;      </span>
<span  style="">  95                                                                                                          </span>
<span class="-2041789809652164219" onmouseenter="enter('-2041789809652164219');" onmouseout="out('-2041789809652164219');" style="">  96     public static final long DEFAULT_ASSET_UPLOAD_SIZE = 1024 * 1024 * 10;                               </span>
<span  style="">  97                                                                                                          </span>
<span class="-6481771976097152300" onmouseenter="enter('-6481771976097152300');" onmouseout="out('-6481771976097152300');" style="">  98     // 8kb default for the buffer for moving files around                                                </span>
<span class="8173561874988853201" onmouseenter="enter('8173561874988853201');" onmouseout="out('8173561874988853201');" style="">  99     protected static final int DEFAULT_BUFFER_SIZE = 8096;                                               </span>
<span  style=""> 100                                                                                                          </span>
<span class="5800015562641335858" onmouseenter="enter('5800015562641335858');" onmouseout="out('5800015562641335858');" style=""> 101     protected String cacheDirectory;                                                                     </span>
<span  style=""> 102                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style=""> 103     @Autowired                                                                                           </span>
<span class="-7669104425724809181" onmouseenter="enter('-7669104425724809181');" onmouseout="out('-7669104425724809181');" style=""> 104     protected Environment env;                                                                           </span>
<span  style=""> 105                                                                                                          </span>
<span class="6195905131849662055" onmouseenter="enter('6195905131849662055');" onmouseout="out('6195905131849662055');" style=""> 106     @Resource(name=&quot;blStaticAssetService&quot;)                                                               </span>
<span class="5386460834235010869" onmouseenter="enter('5386460834235010869');" onmouseout="out('5386460834235010869');" style=""> 107     protected StaticAssetService staticAssetService;                                                     </span>
<span  style=""> 108                                                                                                          </span>
<span class="1752371454992115000" onmouseenter="enter('1752371454992115000');" onmouseout="out('1752371454992115000');" style=""> 109     @Resource(name = &quot;blFileService&quot;)                                                                    </span>
<span class="-5836282893854406064" onmouseenter="enter('-5836282893854406064');" onmouseout="out('-5836282893854406064');" style=""> 110     protected BroadleafFileService broadleafFileService;                                                 </span>
<span  style=""> 111                                                                                                          </span>
<span class="7856532409026737335" onmouseenter="enter('7856532409026737335');" onmouseout="out('7856532409026737335');" style=""> 112     @Resource(name=&quot;blArtifactService&quot;)                                                                  </span>
<span class="-5802479126948705000" onmouseenter="enter('-5802479126948705000');" onmouseout="out('-5802479126948705000');" style=""> 113     protected ArtifactService artifactService;                                                           </span>
<span  style=""> 114                                                                                                          </span>
<span class="-5691607332624048120" onmouseenter="enter('-5691607332624048120');" onmouseout="out('-5691607332624048120');" style=""> 115     @Resource(name=&quot;blStaticAssetStorageDao&quot;)                                                            </span>
<span class="3341461985908719037" onmouseenter="enter('3341461985908719037');" onmouseout="out('3341461985908719037');" style=""> 116     protected StaticAssetStorageDao staticAssetStorageDao;                                               </span>
<span  style=""> 117                                                                                                          </span>
<span class="-8585007248377894204" onmouseenter="enter('-8585007248377894204');" onmouseout="out('-8585007248377894204');" style=""> 118     @Resource(name=&quot;blNamedOperationManager&quot;)                                                            </span>
<span class="308482009813309658" onmouseenter="enter('308482009813309658');" onmouseout="out('308482009813309658');" style=""> 119     protected NamedOperationManager namedOperationManager;                                               </span>
<span  style=""> 120                                                                                                          </span>
<span class="5483516952021908632" onmouseenter="enter('5483516952021908632');" onmouseout="out('5483516952021908632');" style=""> 121     @Resource(name = &quot;blStaticAssetServiceExtensionManager&quot;)                                             </span>
<span class="51840422594786922" onmouseenter="enter('51840422594786922');" onmouseout="out('51840422594786922');" style=""> 122     protected StaticAssetServiceExtensionManager extensionManager;                                       </span>
<span  style=""> 123                                                                                                          </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 124     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                  </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 125     protected StreamingTransactionCapableUtil transUtil;                                                 </span>
<span  style=""> 126                                                                                                          </span>
<span class="-3151523973433667335" onmouseenter="enter('-3151523973433667335');" onmouseout="out('-3151523973433667335');" style=""> 127     @Value(&quot;${image.artifact.recompress.formats:png}&quot;)                                                   </span>
<span class="4635220678002391487" onmouseenter="enter('4635220678002391487');" onmouseout="out('4635220678002391487');" style=""> 128     protected String recompressFormats = &quot;png&quot;;                                                          </span>
<span  style=""> 129                                                                                                          </span>
<span class="2602789178515286342" onmouseenter="enter('2602789178515286342');" onmouseout="out('2602789178515286342');" style=""> 130     @Autowired(required = false)                                                                         </span>
<span class="8981564986536911591" onmouseenter="enter('8981564986536911591');" onmouseout="out('8981564986536911591');" style=""> 131     protected MultipartProperties defaultMultipartSettings;                                              </span>
<span  style=""> 132                                                                                                          </span>
<span class="-7168779142218193311" onmouseenter="enter('-7168779142218193311');" onmouseout="out('-7168779142218193311');" style=""> 133     @Resource(name = &quot;blConcurrentFileOutputStream&quot;)                                                     </span>
<span class="-2331920133844743339" onmouseenter="enter('-2331920133844743339');" onmouseout="out('-2331920133844743339');" style=""> 134     protected ConcurrentFileOutputStream concurrentFileOutputStream;                                     </span>
<span  style=""> 135                                                                                                          </span>
<span  style=""> 136                                                                                                          </span>
<span class="-6120158187110043675" onmouseenter="enter('-6120158187110043675');" onmouseout="out('-6120158187110043675');" style=""> 137     protected StaticAsset findStaticAsset(String fullUrl) {                                              </span>
<span class="-4171210034184470086" onmouseenter="enter('-4171210034184470086');" onmouseout="out('-4171210034184470086');" style=""> 138         StaticAsset staticAsset = staticAssetService.findStaticAssetByFullUrl(fullUrl);                  </span>
<span  style=""> 139                                                                                                          </span>
<span class="-2128240479658154685" onmouseenter="enter('-2128240479658154685');" onmouseout="out('-2128240479658154685');" style=""> 140         return staticAsset;                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141     }                                                                                                    </span>
<span  style=""> 142                                                                                                          </span>
<span class="1529961503462031347" onmouseenter="enter('1529961503462031347');" onmouseout="out('1529961503462031347');" style=""> 143     protected boolean shouldUseSharedFile(InputStream is) {                                              </span>
<span class="7200698625412718023" onmouseenter="enter('7200698625412718023');" onmouseout="out('7200698625412718023');" style=""> 144         return (is != null &amp;&amp; is instanceof GloballySharedInputStream);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145     }                                                                                                    </span>
<span  style=""> 146                                                                                                          </span>
<span class="1502967799885308477" onmouseenter="enter('1502967799885308477');" onmouseout="out('1502967799885308477');" style=""> 147     protected File getFileFromLocalRepository(String cachedFileName) {                                   </span>
<span class="-5673162797879974066" onmouseenter="enter('-5673162797879974066');" onmouseout="out('-5673162797879974066');" style=""><abbr title=" 148         // Look for a shared file (this represents a file that was based on a file originally in the classpath."> 148         // Look for a shared file (this represents a file that was based on a file originally in the clasðŸ”µ</abbr></span>
<span class="-93446380402546673" onmouseenter="enter('-93446380402546673');" onmouseout="out('-93446380402546673');" style=""> 149         File cacheFile = null;                                                                           </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 150         if (extensionManager != null) {                                                                  </span>
<span class="-8112713965554756916" onmouseenter="enter('-8112713965554756916');" onmouseout="out('-8112713965554756916');" style=""> 151             ExtensionResultHolder holder = new ExtensionResultHolder();                                  </span>
<span class="-435722502969466554" onmouseenter="enter('-435722502969466554');" onmouseout="out('-435722502969466554');" style=""><abbr title=" 152             ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holder);"> 152             ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holðŸ”µ</abbr></span>
<span class="-2043051207329155259" onmouseenter="enter('-2043051207329155259');" onmouseout="out('-2043051207329155259');" style=""> 153             if (ExtensionResultStatusType.HANDLED.equals(result)) {                                      </span>
<span class="7653982040624486223" onmouseenter="enter('7653982040624486223');" onmouseout="out('7653982040624486223');" style=""> 154                 cacheFile = (File) holder.getResult();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 155             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 156         }                                                                                                </span>
<span class="-8813269293199686205" onmouseenter="enter('-8813269293199686205');" onmouseout="out('-8813269293199686205');" style=""> 157         if (cacheFile == null) {                                                                         </span>
<span class="-8910009845238484526" onmouseenter="enter('-8910009845238484526');" onmouseout="out('-8910009845238484526');" style=""> 158             cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159         }                                                                                                </span>
<span class="-2028153032285377680" onmouseenter="enter('-2028153032285377680');" onmouseout="out('-2028153032285377680');" style=""> 160         if (cacheFile.exists()) {                                                                        </span>
<span class="8210317951176929256" onmouseenter="enter('8210317951176929256');" onmouseout="out('8210317951176929256');" style=""> 161             return cacheFile;                                                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 162         } else {                                                                                         </span>
<span class="5496227938366649270" onmouseenter="enter('5496227938366649270');" onmouseout="out('5496227938366649270');" style=""> 163             return broadleafFileService.getLocalResource(cachedFileName);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 164         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 165     }                                                                                                    </span>
<span  style=""> 166                                                                                                          </span>
<span class="-9138520702166900061" onmouseenter="enter('-9138520702166900061');" onmouseout="out('-9138520702166900061');" style=""> 167     protected File lookupAssetAndCreateLocalFile(StaticAsset staticAsset, File baseLocalFile)            </span>
<span class="452573679482946095" onmouseenter="enter('452573679482946095');" onmouseout="out('452573679482946095');" style=""> 168             throws IOException, SQLException {                                                           </span>
<span class="-7742266551317191943" onmouseenter="enter('-7742266551317191943');" onmouseout="out('-7742266551317191943');" style=""> 169         if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {                               </span>
<span class="-4354847567179586644" onmouseenter="enter('-4354847567179586644');" onmouseout="out('-4354847567179586644');" style=""> 170             File returnFile = broadleafFileService.getResource(staticAsset.getFullUrl());                </span>
<span class="8059946160260640624" onmouseenter="enter('8059946160260640624');" onmouseout="out('8059946160260640624');" style=""> 171             if (!returnFile.getAbsolutePath().equals(baseLocalFile.getAbsolutePath())) {                 </span>
<span class="-2191133777668840278" onmouseenter="enter('-2191133777668840278');" onmouseout="out('-2191133777668840278');" style=""> 172                 createLocalFileFromInputStream(new FileInputStream(returnFile), baseLocalFile);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 173             }                                                                                            </span>
<span class="4024427022501975435" onmouseenter="enter('4024427022501975435');" onmouseout="out('4024427022501975435');" style=""> 174             return broadleafFileService.getResource(staticAsset.getFullUrl());                           </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 175         } else {                                                                                         </span>
<span class="-4264495412887169123" onmouseenter="enter('-4264495412887169123');" onmouseout="out('-4264495412887169123');" style=""> 176             StaticAssetStorage storage = readStaticAssetStorageByStaticAssetId(staticAsset.getId());     </span>
<span class="4400092173030817905" onmouseenter="enter('4400092173030817905');" onmouseout="out('4400092173030817905');" style=""> 177             if (storage != null) {                                                                       </span>
<span class="-3012070176633314991" onmouseenter="enter('-3012070176633314991');" onmouseout="out('-3012070176633314991');" style=""> 178                 InputStream is = storage.getFileData().getBinaryStream();                                </span>
<span class="538128314668626861" onmouseenter="enter('538128314668626861');" onmouseout="out('538128314668626861');" style=""> 179                 createLocalFileFromInputStream(is, baseLocalFile);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 180             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181         }                                                                                                </span>
<span class="8385511608933773357" onmouseenter="enter('8385511608933773357');" onmouseout="out('8385511608933773357');" style=""> 182         return baseLocalFile;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183     }                                                                                                    </span>
<span  style=""> 184                                                                                                          </span>
<span class="676971272687988980" onmouseenter="enter('676971272687988980');" onmouseout="out('676971272687988980');" style=""><abbr title=" 185     protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOException {"> 185     protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throðŸ”µ</abbr></span>
<span class="5330873671579735739" onmouseenter="enter('5330873671579735739');" onmouseout="out('5330873671579735739');" style=""> 186         InputStream is = broadleafFileService.getClasspathResource(staticAsset.getFullUrl());            </span>
<span class="538128314668626861" onmouseenter="enter('538128314668626861');" onmouseout="out('538128314668626861');" style=""> 187         createLocalFileFromInputStream(is, baseLocalFile);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 188     }                                                                                                    </span>
<span  style=""> 189                                                                                                          </span>
<span class="-4952056920597128037" onmouseenter="enter('-4952056920597128037');" onmouseout="out('-4952056920597128037');" style=""><abbr title=" 190     protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException {"> 190     protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException ðŸ”µ</abbr></span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 191         try {                                                                                            </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 192             if (!baseLocalFile.getParentFile().exists()) {                                               </span>
<span class="5777296043812209192" onmouseenter="enter('5777296043812209192');" onmouseout="out('5777296043812209192');" style=""> 193                 boolean directoriesCreated = false;                                                      </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 194                 if (!baseLocalFile.getParentFile().exists()) {                                           </span>
<span class="-1950703901965003992" onmouseenter="enter('-1950703901965003992');" onmouseout="out('-1950703901965003992');" style=""> 195                     directoriesCreated = baseLocalFile.getParentFile().mkdirs();                         </span>
<span class="-5835726015694115162" onmouseenter="enter('-5835726015694115162');" onmouseout="out('-5835726015694115162');" style=""> 196                     if (!directoriesCreated) {                                                           </span>
<span class="-440335952408349395" onmouseenter="enter('-440335952408349395');" onmouseout="out('-440335952408349395');" style=""><abbr title=" 197                         // There is a chance that another VM created the directories.   If not, we may not have"> 197                         // There is a chance that another VM created the directories.   If not, we may noðŸ”µ</abbr></span>
<span class="5346057857994506172" onmouseenter="enter('5346057857994506172');" onmouseout="out('5346057857994506172');" style=""> 198                         // proper permissions and this is an error we need to report.                    </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 199                         if (!baseLocalFile.getParentFile().exists()) {                                   </span>
<span class="-3100057651899633278" onmouseenter="enter('-3100057651899633278');" onmouseout="out('-3100057651899633278');" style=""> 200                             throw new RuntimeException(&quot;Unable to create middle directories for file: &quot; +</span>
<span class="-3627057965366514409" onmouseenter="enter('-3627057965366514409');" onmouseout="out('-3627057965366514409');" style=""> 201                                     baseLocalFile.getAbsolutePath());                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 202                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 203                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 204                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 205             }                                                                                            </span>
<span  style=""> 206                                                                                                          </span>
<span class="1058516638336488341" onmouseenter="enter('1058516638336488341');" onmouseout="out('1058516638336488341');" style=""> 207             concurrentFileOutputStream.write(is, baseLocalFile);                                         </span>
<span  style=""> 208                                                                                                          </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 209         } finally {                                                                                      </span>
<span class="-1036224550261950069" onmouseenter="enter('-1036224550261950069');" onmouseout="out('-1036224550261950069');" style=""> 210             IOUtils.closeQuietly(is);                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 211         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 212     }                                                                                                    </span>
<span  style=""> 213                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 214     @Override                                                                                            </span>
<span class="-5764870268385651216" onmouseenter="enter('-5764870268385651216');" onmouseout="out('-5764870268385651216');" style=""><abbr title=" 215     public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws Exception {"> 215     public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throwsðŸ”µ</abbr></span>
<span class="491052228983464108" onmouseenter="enter('491052228983464108');" onmouseout="out('491052228983464108');" style=""> 216         StaticAsset staticAsset = findStaticAsset(fullUrl);                                              </span>
<span class="-3786942395132975147" onmouseenter="enter('-3786942395132975147');" onmouseout="out('-3786942395132975147');" style=""> 217         if (staticAsset == null) {                                                                       </span>
<span class="-676167423781739050" onmouseenter="enter('-676167423781739050');" onmouseout="out('-676167423781739050');" style=""> 218             throw new AssetNotFoundException(&quot;Unable to find an asset for the url (&quot; + fullUrl + &quot;)&quot;);   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 219         }                                                                                                </span>
<span class="-5398322132344119647" onmouseenter="enter('-5398322132344119647');" onmouseout="out('-5398322132344119647');" style=""> 220         String mimeType = staticAsset.getMimeType();                                                     </span>
<span  style=""> 221                                                                                                          </span>
<span class="8252026315203489548" onmouseenter="enter('8252026315203489548');" onmouseout="out('8252026315203489548');" style=""> 222         //extract the values for any named parameters                                                    </span>
<span class="1331021329476510285" onmouseenter="enter('1331021329476510285');" onmouseout="out('1331021329476510285');" style=""> 223         boolean shouldRecompress = shouldRecompress(mimeType);                                           </span>
<span class="5491208348485302910" onmouseenter="enter('5491208348485302910');" onmouseout="out('5491208348485302910');" style=""><abbr title=" 224         Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMap);"> 224         Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMaðŸ”µ</abbr></span>
<span class="1628034097147692048" onmouseenter="enter('1628034097147692048');" onmouseout="out('1628034097147692048');" style=""> 225         if (shouldRecompress &amp;&amp; MapUtils.isEmpty(convertedParameters)) {                                 </span>
<span class="-8260123448707150424" onmouseenter="enter('-8260123448707150424');" onmouseout="out('-8260123448707150424');" style=""> 226             convertedParameters.put(&quot;recompress&quot;,&quot;true&quot;);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 227         }                                                                                                </span>
<span class="-6987211962421403682" onmouseenter="enter('-6987211962421403682');" onmouseout="out('-6987211962421403682');" style=""> 228         String cachedFileName = constructCacheFileName(staticAsset, convertedParameters);                </span>
<span  style=""> 229                                                                                                          </span>
<span class="-4010270241296523972" onmouseenter="enter('-4010270241296523972');" onmouseout="out('-4010270241296523972');" style=""> 230         if (shouldRecompress) {                                                                          </span>
<span class="3725275006012768392" onmouseenter="enter('3725275006012768392');" onmouseout="out('3725275006012768392');" style=""> 231             convertedParameters.remove(&quot;recompress&quot;);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 232         }                                                                                                </span>
<span  style=""> 233                                                                                                          </span>
<span class="-5673162797879974066" onmouseenter="enter('-5673162797879974066');" onmouseout="out('-5673162797879974066');" style=""><abbr title=" 234         // Look for a shared file (this represents a file that was based on a file originally in the classpath."> 234         // Look for a shared file (this represents a file that was based on a file originally in the clasðŸ”µ</abbr></span>
<span class="-744748978496739834" onmouseenter="enter('-744748978496739834');" onmouseout="out('-744748978496739834');" style=""> 235         File cacheFile = getFileFromLocalRepository(cachedFileName);                                     </span>
<span class="-2028153032285377680" onmouseenter="enter('-2028153032285377680');" onmouseout="out('-2028153032285377680');" style=""> 236         if (cacheFile.exists()) {                                                                        </span>
<span class="-5770017993670818757" onmouseenter="enter('-5770017993670818757');" onmouseout="out('-5770017993670818757');" style=""> 237             return buildModel(cacheFile.getAbsolutePath(), mimeType);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238         }                                                                                                </span>
<span  style=""> 239                                                                                                          </span>
<span class="7943467756367013608" onmouseenter="enter('7943467756367013608');" onmouseout="out('7943467756367013608');" style=""> 240         // Obtain the base file (that we may need to convert based on the parameters                     </span>
<span class="-7282961418041278395" onmouseenter="enter('-7282961418041278395');" onmouseout="out('-7282961418041278395');" style=""> 241         String baseCachedFileName = constructCacheFileName(staticAsset, null);                           </span>
<span class="2819718340222738473" onmouseenter="enter('2819718340222738473');" onmouseout="out('2819718340222738473');" style=""> 242         File baseLocalFile = getFileFromLocalRepository(baseCachedFileName);                             </span>
<span  style=""> 243                                                                                                          </span>
<span class="7807331939993150402" onmouseenter="enter('7807331939993150402');" onmouseout="out('7807331939993150402');" style=""> 244         if (! baseLocalFile.exists()) {                                                                  </span>
<span class="-4152796465711126856" onmouseenter="enter('-4152796465711126856');" onmouseout="out('-4152796465711126856');" style=""> 245             if (broadleafFileService.checkForResourceOnClassPath(staticAsset.getFullUrl())) {            </span>
<span class="-8910009845238484526" onmouseenter="enter('-8910009845238484526');" onmouseout="out('-8910009845238484526');" style=""> 246                 cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);                 </span>
<span class="-3411813136412986040" onmouseenter="enter('-3411813136412986040');" onmouseout="out('-3411813136412986040');" style=""> 247                 baseLocalFile = broadleafFileService.getSharedLocalResource(baseCachedFileName);         </span>
<span class="-4235219464337080287" onmouseenter="enter('-4235219464337080287');" onmouseout="out('-4235219464337080287');" style=""> 248                 createLocalFileFromClassPathResource(staticAsset, baseLocalFile);                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 249             } else {                                                                                     </span>
<span class="-4898184433395929673" onmouseenter="enter('-4898184433395929673');" onmouseout="out('-4898184433395929673');" style=""> 250                 baseLocalFile = lookupAssetAndCreateLocalFile(staticAsset, baseLocalFile);               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 251             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 252         }                                                                                                </span>
<span  style=""> 253                                                                                                          </span>
<span  style=""> 254                                                                                                          </span>
<span class="-524316509192333846" onmouseenter="enter('-524316509192333846');" onmouseout="out('-524316509192333846');" style=""> 255         if (!shouldRecompress &amp;&amp; convertedParameters.isEmpty()) {                                        </span>
<span class="1541740886220527868" onmouseenter="enter('1541740886220527868');" onmouseout="out('1541740886220527868');" style=""> 256             return buildModel(baseLocalFile.getAbsolutePath(), mimeType);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 257         }                                                                                                </span>
<span class="4391598042186419731" onmouseenter="enter('4391598042186419731');" onmouseout="out('4391598042186419731');" style=""> 258         else {                                                                                           </span>
<span class="2626429018838635667" onmouseenter="enter('2626429018838635667');" onmouseout="out('2626429018838635667');" style=""> 259             FileInputStream assetStream = new FileInputStream(baseLocalFile);                            </span>
<span class="1559981230759799611" onmouseenter="enter('1559981230759799611');" onmouseout="out('1559981230759799611');" style=""> 260             BufferedInputStream original = new BufferedInputStream(assetStream);                         </span>
<span class="5335072745234046164" onmouseenter="enter('5335072745234046164');" onmouseout="out('5335072745234046164');" style=""> 261             original.mark(0);                                                                            </span>
<span  style=""> 262                                                                                                          </span>
<span class="3271606902025597443" onmouseenter="enter('3271606902025597443');" onmouseout="out('3271606902025597443');" style=""><abbr title=" 263             Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.getMimeType());"> 263             Operation[] operations = artifactService.buildOperations(convertedParameters, original, statiðŸ”µ</abbr></span>
<span class="-4049222348408471473" onmouseenter="enter('-4049222348408471473');" onmouseout="out('-4049222348408471473');" style=""><abbr title=" 264             InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeType());"> 264             InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeTypeðŸ”µ</abbr></span>
<span  style=""> 265                                                                                                          </span>
<span class="-5852373631387772582" onmouseenter="enter('-5852373631387772582');" onmouseout="out('-5852373631387772582');" style=""> 266             createLocalFileFromInputStream(converted, cacheFile);                                        </span>
<span class="8481176371776030575" onmouseenter="enter('8481176371776030575');" onmouseout="out('8481176371776030575');" style=""> 267             if (&quot;image/gif&quot;.equals(mimeType)) {                                                          </span>
<span class="6692235241863720447" onmouseenter="enter('6692235241863720447');" onmouseout="out('6692235241863720447');" style=""> 268                 mimeType = &quot;image/png&quot;;                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 269             }                                                                                            </span>
<span class="-5770017993670818757" onmouseenter="enter('-5770017993670818757');" onmouseout="out('-5770017993670818757');" style=""> 270             return buildModel(cacheFile.getAbsolutePath(), mimeType);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 271         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 272     }                                                                                                    </span>
<span  style=""> 273                                                                                                          </span>
<span class="1436332013455477710" onmouseenter="enter('1436332013455477710');" onmouseout="out('1436332013455477710');" style=""> 274     protected boolean shouldRecompress(String mimeType) {                                                </span>
<span class="-2947492696471387039" onmouseenter="enter('-2947492696471387039');" onmouseout="out('-2947492696471387039');" style=""> 275         String[] formats = null;                                                                         </span>
<span class="3146177423232232799" onmouseenter="enter('3146177423232232799');" onmouseout="out('3146177423232232799');" style=""> 276         if (!StringUtils.isEmpty(recompressFormats)) {                                                   </span>
<span class="-5929026035202084105" onmouseenter="enter('-5929026035202084105');" onmouseout="out('-5929026035202084105');" style=""> 277             formats = recompressFormats.split(&quot;,&quot;);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 278         }                                                                                                </span>
<span class="7342740188292578775" onmouseenter="enter('7342740188292578775');" onmouseout="out('7342740188292578775');" style=""> 279         boolean response = false;                                                                        </span>
<span class="-630918830715510960" onmouseenter="enter('-630918830715510960');" onmouseout="out('-630918830715510960');" style=""> 280         if (!ArrayUtils.isEmpty(formats)) {                                                              </span>
<span class="2272716586254590500" onmouseenter="enter('2272716586254590500');" onmouseout="out('2272716586254590500');" style=""> 281             for (String format : formats) {                                                              </span>
<span class="-250489820996933262" onmouseenter="enter('-250489820996933262');" onmouseout="out('-250489820996933262');" style=""> 282                 if (mimeType.toLowerCase().contains(format.toLowerCase())) {                             </span>
<span class="-7568734358544125355" onmouseenter="enter('-7568734358544125355');" onmouseout="out('-7568734358544125355');" style=""> 283                     response = true;                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 284                     break;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 286             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 287         }                                                                                                </span>
<span class="-1838489616061912436" onmouseenter="enter('-1838489616061912436');" onmouseout="out('-1838489616061912436');" style=""> 288         return response;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 289     }                                                                                                    </span>
<span  style=""> 290                                                                                                          </span>
<span class="-5129110647668669753" onmouseenter="enter('-5129110647668669753');" onmouseout="out('-5129110647668669753');" style=""> 291     protected Map&lt;String, String&gt; buildModel(String returnFilePath, String mimeType) {                   </span>
<span class="-5436835504658380993" onmouseenter="enter('-5436835504658380993');" onmouseout="out('-5436835504658380993');" style=""> 292         Map&lt;String, String&gt; model = new HashMap&lt;String, String&gt;(2);                                      </span>
<span class="-7931157778314956360" onmouseenter="enter('-7931157778314956360');" onmouseout="out('-7931157778314956360');" style=""> 293         model.put(&quot;cacheFilePath&quot;, returnFilePath);                                                      </span>
<span class="-121481178440989733" onmouseenter="enter('-121481178440989733');" onmouseout="out('-121481178440989733');" style=""> 294         model.put(&quot;mimeType&quot;, mimeType);                                                                 </span>
<span  style=""> 295                                                                                                          </span>
<span class="1327412617440986435" onmouseenter="enter('1327412617440986435');" onmouseout="out('1327412617440986435');" style=""> 296         return model;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 297     }                                                                                                    </span>
<span  style=""> 298                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 299     @Override                                                                                            </span>
<span class="-2260190509208115003" onmouseenter="enter('-2260190509208115003');" onmouseout="out('-2260190509208115003');" style=""> 300     public StaticAssetStorage findStaticAssetStorageById(final Long id) {                                </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 301         final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                  </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 302         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 303             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 304             public void execute() {                                                                      </span>
<span class="-2207751287529111136" onmouseenter="enter('-2207751287529111136');" onmouseout="out('-2207751287529111136');" style=""> 305                 storage[0] = staticAssetStorageDao.readStaticAssetStorageById(id);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 306             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 307         }, RuntimeException.class);                                                                      </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 308         return storage[0];                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 309     }                                                                                                    </span>
<span  style=""> 310                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 311     @Override                                                                                            </span>
<span class="-2864285839814759705" onmouseenter="enter('-2864285839814759705');" onmouseout="out('-2864285839814759705');" style=""> 312     public StaticAssetStorage create() {                                                                 </span>
<span class="-1873403527653357243" onmouseenter="enter('-1873403527653357243');" onmouseout="out('-1873403527653357243');" style=""> 313         return staticAssetStorageDao.create();                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 314     }                                                                                                    </span>
<span  style=""> 315                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 316     @Override                                                                                            </span>
<span class="7662571466653582755" onmouseenter="enter('7662571466653582755');" onmouseout="out('7662571466653582755');" style=""> 317     public StaticAssetStorage readStaticAssetStorageByStaticAssetId(final Long id) {                     </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 318         final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                  </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 319         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 320             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 321             public void execute() {                                                                      </span>
<span class="8795705063184424946" onmouseenter="enter('8795705063184424946');" onmouseout="out('8795705063184424946');" style=""> 322                 storage[0] = staticAssetStorageDao.readStaticAssetStorageByStaticAssetId(id);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 323             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 324         }, RuntimeException.class);                                                                      </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 325         return storage[0];                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 326     }                                                                                                    </span>
<span  style=""> 327                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 328     @Override                                                                                            </span>
<span class="6485967695518229819" onmouseenter="enter('6485967695518229819');" onmouseout="out('6485967695518229819');" style=""> 329     public StaticAssetStorage save(final StaticAssetStorage assetStorage) {                              </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 330         final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                  </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 331         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 332             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 333             public void execute() {                                                                      </span>
<span class="-6036718856004453538" onmouseenter="enter('-6036718856004453538');" onmouseout="out('-6036718856004453538');" style=""> 334                 storage[0] = staticAssetStorageDao.save(assetStorage);                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 335             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 336         }, RuntimeException.class);                                                                      </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 337         return storage[0];                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 338     }                                                                                                    </span>
<span  style=""> 339                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 340     @Override                                                                                            </span>
<span class="7860976460954721267" onmouseenter="enter('7860976460954721267');" onmouseout="out('7860976460954721267');" style=""> 341     public void delete(final StaticAssetStorage assetStorage) {                                          </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 342         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 343             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 344             public void execute() {                                                                      </span>
<span class="5167138969991588867" onmouseenter="enter('5167138969991588867');" onmouseout="out('5167138969991588867');" style=""> 345                 staticAssetStorageDao.delete(assetStorage);                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 346             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 347         }, RuntimeException.class);                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 348     }                                                                                                    </span>
<span  style=""> 349                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 350     @Override                                                                                            </span>
<span class="-1910899245286681437" onmouseenter="enter('-1910899245286681437');" onmouseout="out('-1910899245286681437');" style=""> 351     public Blob createBlob(final MultipartFile uploadedFile) throws IOException {                        </span>
<span class="848437443390195780" onmouseenter="enter('848437443390195780');" onmouseout="out('848437443390195780');" style=""> 352         final Blob[] blob = new Blob[1];                                                                 </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 353         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 354             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 355             public void execute() {                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 356                 try {                                                                                    </span>
<span class="3702070050705863788" onmouseenter="enter('3702070050705863788');" onmouseout="out('3702070050705863788');" style=""> 357                     blob[0] = staticAssetStorageDao.createBlob(uploadedFile);                            </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 358                 } catch (IOException e) {                                                                </span>
<span class="5116711708032073694" onmouseenter="enter('5116711708032073694');" onmouseout="out('5116711708032073694');" style=""> 359                     LOG.error(&quot;Unable to create blob from MultipartFile.&quot;, e);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 360                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 361             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 362         }, RuntimeException.class);                                                                      </span>
<span class="-3204915544472573462" onmouseenter="enter('-3204915544472573462');" onmouseout="out('-3204915544472573462');" style=""> 363         return blob[0];                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 364     }                                                                                                    </span>
<span  style=""> 365                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 366     @Override                                                                                            </span>
<span class="4382666547830473388" onmouseenter="enter('4382666547830473388');" onmouseout="out('4382666547830473388');" style=""><abbr title=" 367     public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOException {"> 367     public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOExcepðŸ”µ</abbr></span>
<span class="848437443390195780" onmouseenter="enter('848437443390195780');" onmouseout="out('848437443390195780');" style=""> 368         final Blob[] blob = new Blob[1];                                                                 </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 369         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 370             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 371             public void execute() {                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 372                 try {                                                                                    </span>
<span class="-8405931859176759523" onmouseenter="enter('-8405931859176759523');" onmouseout="out('-8405931859176759523');" style=""> 373                     blob[0] = staticAssetStorageDao.createBlob(uploadedFileInputStream, fileSize);       </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 374                 } catch (IOException e) {                                                                </span>
<span class="10365894759289852" onmouseenter="enter('10365894759289852');" onmouseout="out('10365894759289852');" style=""> 375                     LOG.error(&quot;Unable to create blob from InputStream.&quot;, e);                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 376                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 377             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 378         }, RuntimeException.class);                                                                      </span>
<span class="-3204915544472573462" onmouseenter="enter('-3204915544472573462');" onmouseout="out('-3204915544472573462');" style=""> 379         return blob[0];                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 380     }                                                                                                    </span>
<span  style=""> 381                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 382     /**                                                                                                  </span>
<span class="1204867681485950258" onmouseenter="enter('1204867681485950258');" onmouseout="out('1204867681485950258');" style=""> 383      * Builds a file system path for the passed in static asset and paramaterMap.                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 384      *                                                                                                   </span>
<span class="-8533974154884571802" onmouseenter="enter('-8533974154884571802');" onmouseout="out('-8533974154884571802');" style=""> 385      * @param staticAsset                                                                                </span>
<span class="1550808242639330275" onmouseenter="enter('1550808242639330275');" onmouseout="out('1550808242639330275');" style=""> 386      * @param parameterMap                                                                               </span>
<span class="966966680655938311" onmouseenter="enter('966966680655938311');" onmouseout="out('966966680655938311');" style=""> 387      * @param useSharedFile                                                                              </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 388      * @return                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 389      */                                                                                                  </span>
<span class="9052993107782234324" onmouseenter="enter('9052993107782234324');" onmouseout="out('9052993107782234324');" style=""> 390     protected String constructCacheFileName(StaticAsset staticAsset, Map&lt;String, String&gt; parameterMap) { </span>
<span class="6966748151173677546" onmouseenter="enter('6966748151173677546');" onmouseout="out('6966748151173677546');" style=""> 391         String fileName = staticAsset.getFullUrl();                                                      </span>
<span  style=""> 392                                                                                                          </span>
<span class="-4507417291042206746" onmouseenter="enter('-4507417291042206746');" onmouseout="out('-4507417291042206746');" style=""> 393         StringBuilder sb = new StringBuilder(200);                                                       </span>
<span class="-483528478759561910" onmouseenter="enter('-483528478759561910');" onmouseout="out('-483528478759561910');" style=""> 394         sb.append(fileName.substring(0, fileName.lastIndexOf(&#x27;.&#x27;)));                                     </span>
<span class="4093974766537940594" onmouseenter="enter('4093974766537940594');" onmouseout="out('4093974766537940594');" style=""> 395         sb.append(&quot;---&quot;);                                                                                </span>
<span  style=""> 396                                                                                                          </span>
<span class="3988790927371777098" onmouseenter="enter('3988790927371777098');" onmouseout="out('3988790927371777098');" style=""> 397         StringBuilder sb2 = new StringBuilder(200);                                                      </span>
<span class="1220298265095205393" onmouseenter="enter('1220298265095205393');" onmouseout="out('1220298265095205393');" style=""> 398         SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd-HH-mm-ss&quot;);                           </span>
<span class="8844493969073287544" onmouseenter="enter('8844493969073287544');" onmouseout="out('8844493969073287544');" style=""> 399         if (staticAsset instanceof Auditable) {                                                          </span>
<span class="-4932550937064679086" onmouseenter="enter('-4932550937064679086');" onmouseout="out('-4932550937064679086');" style=""> 400             Auditable auditableStaticAsset = (Auditable) staticAsset;                                    </span>
<span class="2764706875669982552" onmouseenter="enter('2764706875669982552');" onmouseout="out('2764706875669982552');" style=""><abbr title=" 401             sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCreated() : auditableStaticAsset.getDateUpdated()));"> 401             sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAssetðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 402         }                                                                                                </span>
<span  style=""> 403                                                                                                          </span>
<span class="-9176202731662601074" onmouseenter="enter('-9176202731662601074');" onmouseout="out('-9176202731662601074');" style=""> 404         if (parameterMap != null) {                                                                      </span>
<span class="-8466079002823576232" onmouseenter="enter('-8466079002823576232');" onmouseout="out('-8466079002823576232');" style=""> 405             for (Map.Entry&lt;String, String&gt; entry : parameterMap.entrySet()) {                            </span>
<span class="-5538998764085201912" onmouseenter="enter('-5538998764085201912');" onmouseout="out('-5538998764085201912');" style=""> 406                 sb2.append(&#x27;-&#x27;);                                                                         </span>
<span class="2475309890837225957" onmouseenter="enter('2475309890837225957');" onmouseout="out('2475309890837225957');" style=""> 407                 sb2.append(entry.getKey());                                                              </span>
<span class="-5538998764085201912" onmouseenter="enter('-5538998764085201912');" onmouseout="out('-5538998764085201912');" style=""> 408                 sb2.append(&#x27;-&#x27;);                                                                         </span>
<span class="7337918225958425753" onmouseenter="enter('7337918225958425753');" onmouseout="out('7337918225958425753');" style=""> 409                 sb2.append(entry.getValue());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 410             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 411         }                                                                                                </span>
<span  style=""> 412                                                                                                          </span>
<span class="-3611986260301585228" onmouseenter="enter('-3611986260301585228');" onmouseout="out('-3611986260301585228');" style=""> 413         String digest;                                                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 414         try {                                                                                            </span>
<span class="-6955618976542935940" onmouseenter="enter('-6955618976542935940');" onmouseout="out('-6955618976542935940');" style=""> 415             MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);                                         </span>
<span class="-42474679596396087" onmouseenter="enter('-42474679596396087');" onmouseout="out('-42474679596396087');" style=""> 416             byte[] messageDigest = md.digest(sb2.toString().getBytes());                                 </span>
<span class="-5380974963518813864" onmouseenter="enter('-5380974963518813864');" onmouseout="out('-5380974963518813864');" style=""> 417             BigInteger number = new BigInteger(1,messageDigest);                                         </span>
<span class="5844706554126289727" onmouseenter="enter('5844706554126289727');" onmouseout="out('5844706554126289727');" style=""> 418             digest = number.toString(16);                                                                </span>
<span class="-4215171220869553942" onmouseenter="enter('-4215171220869553942');" onmouseout="out('-4215171220869553942');" style=""> 419         } catch(NoSuchAlgorithmException e) {                                                            </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 420             throw new RuntimeException(e);                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 421         }                                                                                                </span>
<span  style=""> 422                                                                                                          </span>
<span class="-5802237960969046083" onmouseenter="enter('-5802237960969046083');" onmouseout="out('-5802237960969046083');" style=""> 423         sb.append(pad(digest, 32, &#x27;0&#x27;));                                                                 </span>
<span class="-4790971325793185911" onmouseenter="enter('-4790971325793185911');" onmouseout="out('-4790971325793185911');" style=""> 424         sb.append(fileName.substring(fileName.lastIndexOf(&#x27;.&#x27;)));                                        </span>
<span  style=""> 425                                                                                                          </span>
<span class="-6276773404435993532" onmouseenter="enter('-6276773404435993532');" onmouseout="out('-6276773404435993532');" style=""> 426         return sb.toString();                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 427     }                                                                                                    </span>
<span  style=""> 428                                                                                                          </span>
<span class="3889823321692711159" onmouseenter="enter('3889823321692711159');" onmouseout="out('3889823321692711159');" style=""> 429     protected String pad(String s, int length, char pad) {                                               </span>
<span class="445211846679573021" onmouseenter="enter('445211846679573021');" onmouseout="out('445211846679573021');" style=""> 430         StringBuilder buffer = new StringBuilder(s);                                                     </span>
<span class="-1767419613255418829" onmouseenter="enter('-1767419613255418829');" onmouseout="out('-1767419613255418829');" style=""> 431         while (buffer.length() &lt; length) {                                                               </span>
<span class="5619102104931061603" onmouseenter="enter('5619102104931061603');" onmouseout="out('5619102104931061603');" style=""> 432             buffer.insert(0, pad);                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 433         }                                                                                                </span>
<span class="-2038716794812902958" onmouseenter="enter('-2038716794812902958');" onmouseout="out('-2038716794812902958');" style=""> 434         return buffer.toString();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 435     }                                                                                                    </span>
<span  style=""> 436                                                                                                          </span>
<span class="8674831860571754100" onmouseenter="enter('8674831860571754100');" onmouseout="out('8674831860571754100');" style=""> 437     @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)                                               </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 438     @Override                                                                                            </span>
<span class="124994076020326784" onmouseenter="enter('124994076020326784');" onmouseout="out('124994076020326784');" style=""><abbr title=" 439     public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOException {"> 439     public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOExðŸ”µ</abbr></span>
<span class="-2118089514208048024" onmouseenter="enter('-2118089514208048024');" onmouseout="out('-2118089514208048024');" style=""> 440         createStaticAssetStorage(file.getInputStream(), staticAsset);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 441     }                                                                                                    </span>
<span  style=""> 442                                                                                                          </span>
<span class="8674831860571754100" onmouseenter="enter('8674831860571754100');" onmouseout="out('8674831860571754100');" style=""> 443     @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)                                               </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 444     @Override                                                                                            </span>
<span class="-850236438741332732" onmouseenter="enter('-850236438741332732');" onmouseout="out('-850236438741332732');" style=""><abbr title=" 445     public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException {"> 445     public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOEðŸ”µ</abbr></span>
<span class="-1403207369962524759" onmouseenter="enter('-1403207369962524759');" onmouseout="out('-1403207369962524759');" style=""> 446         if (StorageType.DATABASE.equals(staticAsset.getStorageType())) {                                 </span>
<span class="-1939605028615766275" onmouseenter="enter('-1939605028615766275');" onmouseout="out('-1939605028615766275');" style=""> 447             StaticAssetStorage storage = create();                                                       </span>
<span class="-204637599683518602" onmouseenter="enter('-204637599683518602');" onmouseout="out('-204637599683518602');" style=""> 448             storage.setStaticAssetId(staticAsset.getId());                                               </span>
<span class="1384418291306141967" onmouseenter="enter('1384418291306141967');" onmouseout="out('1384418291306141967');" style=""> 449             Blob uploadBlob = createBlob(fileInputStream, staticAsset.getFileSize());                    </span>
<span class="6866380704006125127" onmouseenter="enter('6866380704006125127');" onmouseout="out('6866380704006125127');" style=""> 450             storage.setFileData(uploadBlob);                                                             </span>
<span class="-2840973363991180880" onmouseenter="enter('-2840973363991180880');" onmouseout="out('-2840973363991180880');" style=""> 451             save(storage);                                                                               </span>
<span class="-2132857837912478262" onmouseenter="enter('-2132857837912478262');" onmouseout="out('-2132857837912478262');" style=""> 452         } else if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {                        </span>
<span class="-4012729166374721308" onmouseenter="enter('-4012729166374721308');" onmouseout="out('-4012729166374721308');" style=""> 453             FileWorkArea tempWorkArea = broadleafFileService.initializeWorkArea();                       </span>
<span class="-4881648785169426910" onmouseenter="enter('-4881648785169426910');" onmouseout="out('-4881648785169426910');" style=""> 454             // Convert the given URL from the asset to a system-specific suitable file path              </span>
<span class="-6260899414746866851" onmouseenter="enter('-6260899414746866851');" onmouseout="out('-6260899414746866851');" style=""><abbr title=" 455             String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FilenameUtils.separatorsToSystem(staticAsset.getFullUrl()));"> 455             String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separðŸ”µ</abbr></span>
<span  style=""> 456                                                                                                          </span>
<span class="2773091736631403971" onmouseenter="enter('2773091736631403971');" onmouseout="out('2773091736631403971');" style=""> 457             InputStream input = fileInputStream;                                                         </span>
<span class="6832533006494732607" onmouseenter="enter('6832533006494732607');" onmouseout="out('6832533006494732607');" style=""> 458             byte[] buffer = new byte[getFileBufferSize()];                                               </span>
<span  style=""> 459                                                                                                          </span>
<span class="-6502247887775821258" onmouseenter="enter('-6502247887775821258');" onmouseout="out('-6502247887775821258');" style=""> 460             File destFile = new File(destFileName);                                                      </span>
<span class="-695082894467535606" onmouseenter="enter('-695082894467535606');" onmouseout="out('-695082894467535606');" style=""> 461             if (!destFile.getParentFile().exists()) {                                                    </span>
<span class="8653794664879930122" onmouseenter="enter('8653794664879930122');" onmouseout="out('8653794664879930122');" style=""> 462                 if (!destFile.getParentFile().mkdirs()) {                                                </span>
<span class="-695082894467535606" onmouseenter="enter('-695082894467535606');" onmouseout="out('-695082894467535606');" style=""> 463                     if (!destFile.getParentFile().exists()) {                                            </span>
<span class="5433889739361026965" onmouseenter="enter('5433889739361026965');" onmouseout="out('5433889739361026965');" style=""><abbr title=" 464                         throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileName);"> 464                         throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + desðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 465                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 466                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 467             }                                                                                            </span>
<span  style=""> 468                                                                                                          </span>
<span class="6445829042907396164" onmouseenter="enter('6445829042907396164');" onmouseout="out('6445829042907396164');" style=""> 469             OutputStream output = new FileOutputStream(destFile);                                        </span>
<span class="-5038889493716933228" onmouseenter="enter('-5038889493716933228');" onmouseout="out('-5038889493716933228');" style=""> 470             long maxFileSize = getMaxUploadSizeForFile(destFileName);                                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 471             try {                                                                                        </span>
<span class="-7067986891170572893" onmouseenter="enter('-7067986891170572893');" onmouseout="out('-7067986891170572893');" style=""> 472                 int bytesRead;                                                                           </span>
<span class="5297046094019116056" onmouseenter="enter('5297046094019116056');" onmouseout="out('5297046094019116056');" style=""> 473                 int totalBytesRead = 0;                                                                  </span>
<span class="-7676219729156525464" onmouseenter="enter('-7676219729156525464');" onmouseout="out('-7676219729156525464');" style=""> 474                 while ((bytesRead = input.read(buffer)) != -1) {                                         </span>
<span class="-6799238023814913099" onmouseenter="enter('-6799238023814913099');" onmouseout="out('-6799238023814913099');" style=""> 475                     totalBytesRead += bytesRead;                                                         </span>
<span class="775261430666212722" onmouseenter="enter('775261430666212722');" onmouseout="out('775261430666212722');" style=""> 476                     if (totalBytesRead &gt; maxFileSize) {                                                  </span>
<span class="-104032706615660809" onmouseenter="enter('-104032706615660809');" onmouseout="out('-104032706615660809');" style=""> 477                         throw new IOException(&quot;Maximum Upload File Size Exceeded&quot;);                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 478                     }                                                                                    </span>
<span class="6143107777038809767" onmouseenter="enter('6143107777038809767');" onmouseout="out('6143107777038809767');" style=""> 479                     output.write(buffer, 0, bytesRead);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 480                 }                                                                                        </span>
<span  style=""> 481                                                                                                          </span>
<span class="-3636717142636833723" onmouseenter="enter('-3636717142636833723');" onmouseout="out('-3636717142636833723');" style=""> 482                 // close the output file stream prior to moving files around                             </span>
<span class="-7467153277872057229" onmouseenter="enter('-7467153277872057229');" onmouseout="out('-7467153277872057229');" style=""> 483                 output.close();                                                                          </span>
<span class="-7014270169952325099" onmouseenter="enter('-7014270169952325099');" onmouseout="out('-7014270169952325099');" style=""> 484                 broadleafFileService.addOrUpdateResource(tempWorkArea, destFile, false);                 </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 485             } finally {                                                                                  </span>
<span class="4174609820499721765" onmouseenter="enter('4174609820499721765');" onmouseout="out('4174609820499721765');" style=""> 486                 IOUtils.closeQuietly(output);                                                            </span>
<span class="5684068854007703140" onmouseenter="enter('5684068854007703140');" onmouseout="out('5684068854007703140');" style=""> 487                 broadleafFileService.closeWorkArea(tempWorkArea);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 488             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 489         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 490     }                                                                                                    </span>
<span  style=""> 491                                                                                                          </span>
<span class="7880420848062709346" onmouseenter="enter('7880420848062709346');" onmouseout="out('7880420848062709346');" style=""> 492     protected long getMaxUploadSizeForFile(String fileName) {                                            </span>
<span class="-8299331750570909154" onmouseenter="enter('-8299331750570909154');" onmouseout="out('-8299331750570909154');" style=""> 493         if (isImageFile(fileName)) {                                                                     </span>
<span class="-8904535810123442239" onmouseenter="enter('-8904535810123442239');" onmouseout="out('-8904535810123442239');" style=""> 494             return getMaxUploadableImageSize();                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 495         }                                                                                                </span>
<span  style=""> 496                                                                                                          </span>
<span class="7342651561788072273" onmouseenter="enter('7342651561788072273');" onmouseout="out('7342651561788072273');" style=""> 497         return getMaxUploadableFileSize();                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 498     }                                                                                                    </span>
<span  style=""> 499                                                                                                          </span>
<span class="-4256605375867072165" onmouseenter="enter('-4256605375867072165');" onmouseout="out('-4256605375867072165');" style=""> 500     protected boolean isImageFile(String fileName) {                                                     </span>
<span class="-7215778148857055723" onmouseenter="enter('-7215778148857055723');" onmouseout="out('-7215778148857055723');" style=""> 501         String extension = getFileExtension(fileName);                                                   </span>
<span  style=""> 502                                                                                                          </span>
<span class="868046925461100818" onmouseenter="enter('868046925461100818');" onmouseout="out('868046925461100818');" style=""> 503         for (String imageFileExtension : getAdminImageFileExtensions()) {                                </span>
<span class="-1882310683799532334" onmouseenter="enter('-1882310683799532334');" onmouseout="out('-1882310683799532334');" style=""> 504             if (imageFileExtension.equalsIgnoreCase(extension)) {                                        </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 505                 return true;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 506             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 507         }                                                                                                </span>
<span  style=""> 508                                                                                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 509         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 510     }                                                                                                    </span>
<span  style=""> 511                                                                                                          </span>
<span class="-4067859991978763128" onmouseenter="enter('-4067859991978763128');" onmouseout="out('-4067859991978763128');" style=""> 512     protected String getFileExtension(String assetPath) {                                                </span>
<span class="-7365160516150097212" onmouseenter="enter('-7365160516150097212');" onmouseout="out('-7365160516150097212');" style=""> 513         int extensionStartIndex = assetPath.lastIndexOf(&quot;.&quot;) + 1;                                        </span>
<span class="3165050002785748305" onmouseenter="enter('3165050002785748305');" onmouseout="out('3165050002785748305');" style=""> 514         return assetPath.substring(extensionStartIndex);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 515     }                                                                                                    </span>
<span  style=""> 516                                                                                                          </span>
<span class="8520324044054424760" onmouseenter="enter('8520324044054424760');" onmouseout="out('8520324044054424760');" style=""> 517     protected long getMaxUploadableFileSize() {                                                          </span>
<span class="-8242800191702968016" onmouseenter="enter('-8242800191702968016');" onmouseout="out('-8242800191702968016');" style=""> 518         Long blcUploadSize = env.getProperty(&quot;asset.server.max.uploadable.file.size&quot;, Long.class);       </span>
<span class="-6815277628371519591" onmouseenter="enter('-6815277628371519591');" onmouseout="out('-6815277628371519591');" style=""> 519         if (blcUploadSize != null) {                                                                     </span>
<span class="-2122879694774875974" onmouseenter="enter('-2122879694774875974');" onmouseout="out('-2122879694774875974');" style=""> 520             return blcUploadSize;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 521         }                                                                                                </span>
<span  style=""> 522                                                                                                          </span>
<span class="-83413303193047685" onmouseenter="enter('-83413303193047685');" onmouseout="out('-83413303193047685');" style=""> 523         if (defaultMultipartSettings != null) {                                                          </span>
<span class="3781451292667627704" onmouseenter="enter('3781451292667627704');" onmouseout="out('3781451292667627704');" style=""> 524             return defaultMultipartSettings.createMultipartConfig().getMaxFileSize();                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 525         }                                                                                                </span>
<span class="8028643923497516300" onmouseenter="enter('8028643923497516300');" onmouseout="out('8028643923497516300');" style=""> 526         return DEFAULT_ASSET_UPLOAD_SIZE;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 527     }                                                                                                    </span>
<span  style=""> 528                                                                                                          </span>
<span class="-4925501260426057745" onmouseenter="enter('-4925501260426057745');" onmouseout="out('-4925501260426057745');" style=""> 529     protected long getMaxUploadableImageSize() {                                                         </span>
<span class="2537324483761513782" onmouseenter="enter('2537324483761513782');" onmouseout="out('2537324483761513782');" style=""> 530         // backwards-compatibility checks, only use the image-size specific property if it is            </span>
<span class="4617761826312627412" onmouseenter="enter('4617761826312627412');" onmouseout="out('4617761826312627412');" style=""> 531         // not the default value. Otherwise, delegate to the old property                                </span>
<span class="7612408840010340391" onmouseenter="enter('7612408840010340391');" onmouseout="out('7612408840010340391');" style=""> 532         Long maxImgSize = env.getProperty(&quot;asset.server.max.uploadable.image.size&quot;, Long.class);         </span>
<span class="-430636607829496210" onmouseenter="enter('-430636607829496210');" onmouseout="out('-430636607829496210');" style=""> 533         if (maxImgSize == null) {                                                                        </span>
<span class="7342651561788072273" onmouseenter="enter('7342651561788072273');" onmouseout="out('7342651561788072273');" style=""> 534             return getMaxUploadableFileSize();                                                           </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 535         } else {                                                                                         </span>
<span class="-7468174336769267749" onmouseenter="enter('-7468174336769267749');" onmouseout="out('-7468174336769267749');" style=""> 536             return maxImgSize;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 537         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 538     }                                                                                                    </span>
<span  style=""> 539                                                                                                          </span>
<span class="3561631998050563638" onmouseenter="enter('3561631998050563638');" onmouseout="out('3561631998050563638');" style=""> 540     protected int getFileBufferSize() {                                                                  </span>
<span class="6759418199922005006" onmouseenter="enter('6759418199922005006');" onmouseout="out('6759418199922005006');" style=""> 541         return env.getProperty(&quot;asset.server.file.buffer.size&quot;, int.class, DEFAULT_BUFFER_SIZE);         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 542     }                                                                                                    </span>
<span  style=""> 543                                                                                                          </span>
<span class="-7892865232186196236" onmouseenter="enter('-7892865232186196236');" onmouseout="out('-7892865232186196236');" style=""> 544     protected List&lt;String&gt; getAdminImageFileExtensions() {                                               </span>
<span class="4831601876827029435" onmouseenter="enter('4831601876827029435');" onmouseout="out('4831601876827029435');" style=""><abbr title=" 545         String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENSIONS);"> 545         String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMðŸ”µ</abbr></span>
<span class="-1830661333141003565" onmouseenter="enter('-1830661333141003565');" onmouseout="out('-1830661333141003565');" style=""> 546         return Arrays.asList(extensions.split(&quot;,&quot;));                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 547     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 548 }                                                                                                        </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-6173756248845875922" onmouseenter="enter('-6173756248845875922');" onmouseout="out('-6173756248845875922');" style="">   3  * BroadleafCommerce CMS Module                                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-2980987384224312133" onmouseenter="enter('-2980987384224312133');" onmouseout="out('-2980987384224312133');" style="">  18 package org.broadleafcommerce.cms.file.service;                                                          </span>
<span  style="">  19                                                                                                          </span>
<span class="650718985643898152" onmouseenter="enter('650718985643898152');" onmouseout="out('650718985643898152');" style="">  20 import org.apache.commons.collections4.MapUtils;                                                         </span>
<span class="1592055122970313625" onmouseenter="enter('1592055122970313625');" onmouseout="out('1592055122970313625');" style="">  21 import org.apache.commons.io.FileExistsException;                                                        </span>
<span class="1419696606949779000" onmouseenter="enter('1419696606949779000');" onmouseout="out('1419696606949779000');" style="">  22 import org.apache.commons.io.FileUtils;                                                                  </span>
<span class="-2296051308340473600" onmouseenter="enter('-2296051308340473600');" onmouseout="out('-2296051308340473600');" style="">  23 import org.apache.commons.io.FilenameUtils;                                                              </span>
<span class="-7541571572495339903" onmouseenter="enter('-7541571572495339903');" onmouseout="out('-7541571572495339903');" style="">  24 import org.apache.commons.io.IOUtils;                                                                    </span>
<span class="-7366736394295216840" onmouseenter="enter('-7366736394295216840');" onmouseout="out('-7366736394295216840');" style="">  25 import org.apache.commons.lang.ArrayUtils;                                                               </span>
<span class="-8105670274694144339" onmouseenter="enter('-8105670274694144339');" onmouseout="out('-8105670274694144339');" style="">  26 import org.apache.commons.lang3.StringUtils;                                                             </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  27 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  28 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="6421182070533632471" onmouseenter="enter('6421182070533632471');" onmouseout="out('6421182070533632471');" style="">  29 import org.broadleafcommerce.cms.common.AssetNotFoundException;                                          </span>
<span class="8163806430712317298" onmouseenter="enter('8163806430712317298');" onmouseout="out('8163806430712317298');" style="">  30 import org.broadleafcommerce.cms.field.type.StorageType;                                                 </span>
<span class="-8427882675756262690" onmouseenter="enter('-8427882675756262690');" onmouseout="out('-8427882675756262690');" style="">  31 import org.broadleafcommerce.cms.file.dao.StaticAssetStorageDao;                                         </span>
<span class="1355270185972111851" onmouseenter="enter('1355270185972111851');" onmouseout="out('1355270185972111851');" style="">  32 import org.broadleafcommerce.cms.file.domain.StaticAsset;                                                </span>
<span class="-9103956258218147401" onmouseenter="enter('-9103956258218147401');" onmouseout="out('-9103956258218147401');" style="">  33 import org.broadleafcommerce.cms.file.domain.StaticAssetStorage;                                         </span>
<span class="9188568145725907286" onmouseenter="enter('9188568145725907286');" onmouseout="out('9188568145725907286');" style="">  34 import org.broadleafcommerce.cms.file.service.operation.NamedOperationManager;                           </span>
<span class="-1074856182010318298" onmouseenter="enter('-1074856182010318298');" onmouseout="out('-1074856182010318298');" style="">  35 import org.broadleafcommerce.common.audit.Auditable;                                                     </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  36 import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                     </span>
<span class="-8339254235515724670" onmouseenter="enter('-8339254235515724670');" onmouseout="out('-8339254235515724670');" style="">  37 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;                                 </span>
<span class="-2507677682672524762" onmouseenter="enter('-2507677682672524762');" onmouseout="out('-2507677682672524762');" style="">  38 import org.broadleafcommerce.common.file.domain.FileWorkArea;                                            </span>
<span class="3660177375850747944" onmouseenter="enter('3660177375850747944');" onmouseout="out('3660177375850747944');" style="">  39 import org.broadleafcommerce.common.file.service.BroadleafFileService;                                   </span>
<span class="-6194024147123816671" onmouseenter="enter('-6194024147123816671');" onmouseout="out('-6194024147123816671');" style="">  40 import org.broadleafcommerce.common.file.service.GloballySharedInputStream;                              </span>
<span class="8070124246740049341" onmouseenter="enter('8070124246740049341');" onmouseout="out('8070124246740049341');" style="">  41 import org.broadleafcommerce.common.io.ConcurrentFileOutputStream;                                       </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  42 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                     </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  43 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                </span>
<span class="-32928361580396825" onmouseenter="enter('-32928361580396825');" onmouseout="out('-32928361580396825');" style="">  44 import org.broadleafcommerce.openadmin.server.service.artifact.ArtifactService;                          </span>
<span class="-7077569502978710918" onmouseenter="enter('-7077569502978710918');" onmouseout="out('-7077569502978710918');" style="">  45 import org.broadleafcommerce.openadmin.server.service.artifact.image.Operation;                          </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  46 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-1779577819582542853" onmouseenter="enter('-1779577819582542853');" onmouseout="out('-1779577819582542853');" style="">  47 import org.springframework.boot.autoconfigure.web.servlet.MultipartProperties;                           </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  48 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="2802840430073505079" onmouseenter="enter('2802840430073505079');" onmouseout="out('2802840430073505079');" style="">  49 import org.springframework.core.env.Environment;                                                         </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  50 import org.springframework.stereotype.Service;                                                           </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  51 import org.springframework.transaction.annotation.Transactional;                                         </span>
<span class="4828820138133011218" onmouseenter="enter('4828820138133011218');" onmouseout="out('4828820138133011218');" style="">  52 import org.springframework.web.multipart.MultipartFile;                                                  </span>
<span  style="">  53                                                                                                          </span>
<span class="-8084092933789958161" onmouseenter="enter('-8084092933789958161');" onmouseout="out('-8084092933789958161');" style="">  54 import java.io.BufferedInputStream;                                                                      </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  55 import java.io.File;                                                                                     </span>
<span class="-535075201057145249" onmouseenter="enter('-535075201057145249');" onmouseout="out('-535075201057145249');" style="">  56 import java.io.FileInputStream;                                                                          </span>
<span class="4915709264156936957" onmouseenter="enter('4915709264156936957');" onmouseout="out('4915709264156936957');" style="">  57 import java.io.FileOutputStream;                                                                         </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  58 import java.io.IOException;                                                                              </span>
<span class="5631563232245871054" onmouseenter="enter('5631563232245871054');" onmouseout="out('5631563232245871054');" style="">  59 import java.io.InputStream;                                                                              </span>
<span class="4621164050749610193" onmouseenter="enter('4621164050749610193');" onmouseout="out('4621164050749610193');" style="">  60 import java.io.OutputStream;                                                                             </span>
<span class="-40197902381950972" onmouseenter="enter('-40197902381950972');" onmouseout="out('-40197902381950972');" style="">  61 import java.math.BigInteger;                                                                             </span>
<span class="6381430938828950472" onmouseenter="enter('6381430938828950472');" onmouseout="out('6381430938828950472');" style="">  62 import java.security.MessageDigest;                                                                      </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  63 import java.security.NoSuchAlgorithmException;                                                           </span>
<span class="-5709181831744795488" onmouseenter="enter('-5709181831744795488');" onmouseout="out('-5709181831744795488');" style="">  64 import java.sql.Blob;                                                                                    </span>
<span class="-515559982825150111" onmouseenter="enter('-515559982825150111');" onmouseout="out('-515559982825150111');" style="">  65 import java.sql.SQLException;                                                                            </span>
<span class="54331962280914690" onmouseenter="enter('54331962280914690');" onmouseout="out('54331962280914690');" style="">  66 import java.text.SimpleDateFormat;                                                                       </span>
<span class="-28465676010609596" onmouseenter="enter('-28465676010609596');" onmouseout="out('-28465676010609596');" style="">  67 import java.util.Arrays;                                                                                 </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  68 import java.util.HashMap;                                                                                </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  69 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  70 import java.util.Map;                                                                                    </span>
<span  style="">  71                                                                                                          </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  72 import javax.annotation.Resource;                                                                        </span>
<span  style="">  73                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  74 /**                                                                                                      </span>
<span class="5819561638806578074" onmouseenter="enter('5819561638806578074');" onmouseout="out('5819561638806578074');" style="">  75  * @author Jeff Fischer, Brian Polster                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  76  */                                                                                                      </span>
<span class="8555986608199362624" onmouseenter="enter('8555986608199362624');" onmouseout="out('8555986608199362624');" style="">  77 @Service(&quot;blStaticAssetStorageService&quot;)                                                                  </span>
<span class="-5440937737927857026" onmouseenter="enter('-5440937737927857026');" onmouseout="out('-5440937737927857026');" style="">  78 public class StaticAssetStorageServiceImpl implements StaticAssetStorageService {                        </span>
<span  style="">  79                                                                                                          </span>
<span class="2858988269359695714" onmouseenter="enter('2858988269359695714');" onmouseout="out('2858988269359695714');" style="">  80     private static final Log LOG = LogFactory.getLog(StaticAssetStorageServiceImpl.class);               </span>
<span  style="">  81                                                                                                          </span>
<span class="3730583078767808053" onmouseenter="enter('3730583078767808053');" onmouseout="out('3730583078767808053');" style="">  82     protected static final String DEFAULT_ADMIN_IMAGE_EXTENSIONS = &quot;bmp,jpg,jpeg,png,img,tiff,gif&quot;;      </span>
<span  style="">  83                                                                                                          </span>
<span class="-2041789809652164219" onmouseenter="enter('-2041789809652164219');" onmouseout="out('-2041789809652164219');" style="">  84     public static final long DEFAULT_ASSET_UPLOAD_SIZE = 1024 * 1024 * 10;                               </span>
<span  style="">  85                                                                                                          </span>
<span class="-6481771976097152300" onmouseenter="enter('-6481771976097152300');" onmouseout="out('-6481771976097152300');" style="">  86     // 8kb default for the buffer for moving files around                                                </span>
<span class="8173561874988853201" onmouseenter="enter('8173561874988853201');" onmouseout="out('8173561874988853201');" style="">  87     protected static final int DEFAULT_BUFFER_SIZE = 8096;                                               </span>
<span  style="">  88                                                                                                          </span>
<span class="5800015562641335858" onmouseenter="enter('5800015562641335858');" onmouseout="out('5800015562641335858');" style="">  89     protected String cacheDirectory;                                                                     </span>
<span  style="">  90                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="">  91     @Autowired                                                                                           </span>
<span class="-7669104425724809181" onmouseenter="enter('-7669104425724809181');" onmouseout="out('-7669104425724809181');" style="">  92     protected Environment env;                                                                           </span>
<span  style="">  93                                                                                                          </span>
<span class="6195905131849662055" onmouseenter="enter('6195905131849662055');" onmouseout="out('6195905131849662055');" style="">  94     @Resource(name=&quot;blStaticAssetService&quot;)                                                               </span>
<span class="5386460834235010869" onmouseenter="enter('5386460834235010869');" onmouseout="out('5386460834235010869');" style="">  95     protected StaticAssetService staticAssetService;                                                     </span>
<span  style="">  96                                                                                                          </span>
<span class="1752371454992115000" onmouseenter="enter('1752371454992115000');" onmouseout="out('1752371454992115000');" style="">  97     @Resource(name = &quot;blFileService&quot;)                                                                    </span>
<span class="-5836282893854406064" onmouseenter="enter('-5836282893854406064');" onmouseout="out('-5836282893854406064');" style="">  98     protected BroadleafFileService broadleafFileService;                                                 </span>
<span  style="">  99                                                                                                          </span>
<span class="7856532409026737335" onmouseenter="enter('7856532409026737335');" onmouseout="out('7856532409026737335');" style=""> 100     @Resource(name=&quot;blArtifactService&quot;)                                                                  </span>
<span class="-5802479126948705000" onmouseenter="enter('-5802479126948705000');" onmouseout="out('-5802479126948705000');" style=""> 101     protected ArtifactService artifactService;                                                           </span>
<span  style=""> 102                                                                                                          </span>
<span class="-5691607332624048120" onmouseenter="enter('-5691607332624048120');" onmouseout="out('-5691607332624048120');" style=""> 103     @Resource(name=&quot;blStaticAssetStorageDao&quot;)                                                            </span>
<span class="3341461985908719037" onmouseenter="enter('3341461985908719037');" onmouseout="out('3341461985908719037');" style=""> 104     protected StaticAssetStorageDao staticAssetStorageDao;                                               </span>
<span  style=""> 105                                                                                                          </span>
<span class="-8585007248377894204" onmouseenter="enter('-8585007248377894204');" onmouseout="out('-8585007248377894204');" style=""> 106     @Resource(name=&quot;blNamedOperationManager&quot;)                                                            </span>
<span class="308482009813309658" onmouseenter="enter('308482009813309658');" onmouseout="out('308482009813309658');" style=""> 107     protected NamedOperationManager namedOperationManager;                                               </span>
<span  style=""> 108                                                                                                          </span>
<span class="5483516952021908632" onmouseenter="enter('5483516952021908632');" onmouseout="out('5483516952021908632');" style=""> 109     @Resource(name = &quot;blStaticAssetServiceExtensionManager&quot;)                                             </span>
<span class="51840422594786922" onmouseenter="enter('51840422594786922');" onmouseout="out('51840422594786922');" style=""> 110     protected StaticAssetServiceExtensionManager extensionManager;                                       </span>
<span  style=""> 111                                                                                                          </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 112     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                  </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 113     protected StreamingTransactionCapableUtil transUtil;                                                 </span>
<span  style=""> 114                                                                                                          </span>
<span class="-3151523973433667335" onmouseenter="enter('-3151523973433667335');" onmouseout="out('-3151523973433667335');" style=""> 115     @Value(&quot;${image.artifact.recompress.formats:png}&quot;)                                                   </span>
<span class="4635220678002391487" onmouseenter="enter('4635220678002391487');" onmouseout="out('4635220678002391487');" style=""> 116     protected String recompressFormats = &quot;png&quot;;                                                          </span>
<span  style=""> 117                                                                                                          </span>
<span class="2602789178515286342" onmouseenter="enter('2602789178515286342');" onmouseout="out('2602789178515286342');" style=""> 118     @Autowired(required = false)                                                                         </span>
<span class="8981564986536911591" onmouseenter="enter('8981564986536911591');" onmouseout="out('8981564986536911591');" style=""> 119     protected MultipartProperties defaultMultipartSettings;                                              </span>
<span  style=""> 120                                                                                                          </span>
<span class="-7168779142218193311" onmouseenter="enter('-7168779142218193311');" onmouseout="out('-7168779142218193311');" style=""> 121     @Resource(name = &quot;blConcurrentFileOutputStream&quot;)                                                     </span>
<span class="-2331920133844743339" onmouseenter="enter('-2331920133844743339');" onmouseout="out('-2331920133844743339');" style=""> 122     protected ConcurrentFileOutputStream concurrentFileOutputStream;                                     </span>
<span  style=""> 123                                                                                                          </span>
<span  style=""> 124                                                                                                          </span>
<span class="-6120158187110043675" onmouseenter="enter('-6120158187110043675');" onmouseout="out('-6120158187110043675');" style=""> 125     protected StaticAsset findStaticAsset(String fullUrl) {                                              </span>
<span class="-4171210034184470086" onmouseenter="enter('-4171210034184470086');" onmouseout="out('-4171210034184470086');" style=""> 126         StaticAsset staticAsset = staticAssetService.findStaticAssetByFullUrl(fullUrl);                  </span>
<span  style=""> 127                                                                                                          </span>
<span class="-2128240479658154685" onmouseenter="enter('-2128240479658154685');" onmouseout="out('-2128240479658154685');" style=""> 128         return staticAsset;                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129     }                                                                                                    </span>
<span  style=""> 130                                                                                                          </span>
<span class="1529961503462031347" onmouseenter="enter('1529961503462031347');" onmouseout="out('1529961503462031347');" style=""> 131     protected boolean shouldUseSharedFile(InputStream is) {                                              </span>
<span class="7200698625412718023" onmouseenter="enter('7200698625412718023');" onmouseout="out('7200698625412718023');" style=""> 132         return (is != null &amp;&amp; is instanceof GloballySharedInputStream);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133     }                                                                                                    </span>
<span  style=""> 134                                                                                                          </span>
<span class="1502967799885308477" onmouseenter="enter('1502967799885308477');" onmouseout="out('1502967799885308477');" style=""> 135     protected File getFileFromLocalRepository(String cachedFileName) {                                   </span>
<span class="-5673162797879974066" onmouseenter="enter('-5673162797879974066');" onmouseout="out('-5673162797879974066');" style=""><abbr title=" 136         // Look for a shared file (this represents a file that was based on a file originally in the classpath."> 136         // Look for a shared file (this represents a file that was based on a file originally in the clasðŸ”µ</abbr></span>
<span class="-93446380402546673" onmouseenter="enter('-93446380402546673');" onmouseout="out('-93446380402546673');" style=""> 137         File cacheFile = null;                                                                           </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 138         if (extensionManager != null) {                                                                  </span>
<span class="-8112713965554756916" onmouseenter="enter('-8112713965554756916');" onmouseout="out('-8112713965554756916');" style=""> 139             ExtensionResultHolder holder = new ExtensionResultHolder();                                  </span>
<span class="-435722502969466554" onmouseenter="enter('-435722502969466554');" onmouseout="out('-435722502969466554');" style=""><abbr title=" 140             ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holder);"> 140             ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holðŸ”µ</abbr></span>
<span class="-2043051207329155259" onmouseenter="enter('-2043051207329155259');" onmouseout="out('-2043051207329155259');" style=""> 141             if (ExtensionResultStatusType.HANDLED.equals(result)) {                                      </span>
<span class="7653982040624486223" onmouseenter="enter('7653982040624486223');" onmouseout="out('7653982040624486223');" style=""> 142                 cacheFile = (File) holder.getResult();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 143             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 144         }                                                                                                </span>
<span class="-8813269293199686205" onmouseenter="enter('-8813269293199686205');" onmouseout="out('-8813269293199686205');" style=""> 145         if (cacheFile == null) {                                                                         </span>
<span class="-8910009845238484526" onmouseenter="enter('-8910009845238484526');" onmouseout="out('-8910009845238484526');" style=""> 146             cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147         }                                                                                                </span>
<span class="-2028153032285377680" onmouseenter="enter('-2028153032285377680');" onmouseout="out('-2028153032285377680');" style=""> 148         if (cacheFile.exists()) {                                                                        </span>
<span class="8210317951176929256" onmouseenter="enter('8210317951176929256');" onmouseout="out('8210317951176929256');" style=""> 149             return cacheFile;                                                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 150         } else {                                                                                         </span>
<span class="5496227938366649270" onmouseenter="enter('5496227938366649270');" onmouseout="out('5496227938366649270');" style=""> 151             return broadleafFileService.getLocalResource(cachedFileName);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 152         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 153     }                                                                                                    </span>
<span  style=""> 154                                                                                                          </span>
<span class="-9138520702166900061" onmouseenter="enter('-9138520702166900061');" onmouseout="out('-9138520702166900061');" style=""> 155     protected File lookupAssetAndCreateLocalFile(StaticAsset staticAsset, File baseLocalFile)            </span>
<span class="452573679482946095" onmouseenter="enter('452573679482946095');" onmouseout="out('452573679482946095');" style=""> 156             throws IOException, SQLException {                                                           </span>
<span class="-7742266551317191943" onmouseenter="enter('-7742266551317191943');" onmouseout="out('-7742266551317191943');" style=""> 157         if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {                               </span>
<span class="-4354847567179586644" onmouseenter="enter('-4354847567179586644');" onmouseout="out('-4354847567179586644');" style=""> 158             File returnFile = broadleafFileService.getResource(staticAsset.getFullUrl());                </span>
<span class="8059946160260640624" onmouseenter="enter('8059946160260640624');" onmouseout="out('8059946160260640624');" style=""> 159             if (!returnFile.getAbsolutePath().equals(baseLocalFile.getAbsolutePath())) {                 </span>
<span class="-2191133777668840278" onmouseenter="enter('-2191133777668840278');" onmouseout="out('-2191133777668840278');" style=""> 160                 createLocalFileFromInputStream(new FileInputStream(returnFile), baseLocalFile);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161             }                                                                                            </span>
<span class="4024427022501975435" onmouseenter="enter('4024427022501975435');" onmouseout="out('4024427022501975435');" style=""> 162             return broadleafFileService.getResource(staticAsset.getFullUrl());                           </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 163         } else {                                                                                         </span>
<span class="-4264495412887169123" onmouseenter="enter('-4264495412887169123');" onmouseout="out('-4264495412887169123');" style=""> 164             StaticAssetStorage storage = readStaticAssetStorageByStaticAssetId(staticAsset.getId());     </span>
<span class="4400092173030817905" onmouseenter="enter('4400092173030817905');" onmouseout="out('4400092173030817905');" style=""> 165             if (storage != null) {                                                                       </span>
<span class="-3012070176633314991" onmouseenter="enter('-3012070176633314991');" onmouseout="out('-3012070176633314991');" style=""> 166                 InputStream is = storage.getFileData().getBinaryStream();                                </span>
<span class="538128314668626861" onmouseenter="enter('538128314668626861');" onmouseout="out('538128314668626861');" style=""> 167                 createLocalFileFromInputStream(is, baseLocalFile);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169         }                                                                                                </span>
<span class="8385511608933773357" onmouseenter="enter('8385511608933773357');" onmouseout="out('8385511608933773357');" style=""> 170         return baseLocalFile;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 171     }                                                                                                    </span>
<span  style=""> 172                                                                                                          </span>
<span class="676971272687988980" onmouseenter="enter('676971272687988980');" onmouseout="out('676971272687988980');" style=""><abbr title=" 173     protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOException {"> 173     protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throðŸ”µ</abbr></span>
<span class="5330873671579735739" onmouseenter="enter('5330873671579735739');" onmouseout="out('5330873671579735739');" style=""> 174         InputStream is = broadleafFileService.getClasspathResource(staticAsset.getFullUrl());            </span>
<span class="538128314668626861" onmouseenter="enter('538128314668626861');" onmouseout="out('538128314668626861');" style=""> 175         createLocalFileFromInputStream(is, baseLocalFile);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 176     }                                                                                                    </span>
<span  style=""> 177                                                                                                          </span>
<span class="-4952056920597128037" onmouseenter="enter('-4952056920597128037');" onmouseout="out('-4952056920597128037');" style=""><abbr title=" 178     protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException {"> 178     protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException ðŸ”µ</abbr></span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 179         try {                                                                                            </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 180             if (!baseLocalFile.getParentFile().exists()) {                                               </span>
<span class="5777296043812209192" onmouseenter="enter('5777296043812209192');" onmouseout="out('5777296043812209192');" style=""> 181                 boolean directoriesCreated = false;                                                      </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 182                 if (!baseLocalFile.getParentFile().exists()) {                                           </span>
<span class="-1950703901965003992" onmouseenter="enter('-1950703901965003992');" onmouseout="out('-1950703901965003992');" style=""> 183                     directoriesCreated = baseLocalFile.getParentFile().mkdirs();                         </span>
<span class="-5835726015694115162" onmouseenter="enter('-5835726015694115162');" onmouseout="out('-5835726015694115162');" style=""> 184                     if (!directoriesCreated) {                                                           </span>
<span class="-440335952408349395" onmouseenter="enter('-440335952408349395');" onmouseout="out('-440335952408349395');" style=""><abbr title=" 185                         // There is a chance that another VM created the directories.   If not, we may not have"> 185                         // There is a chance that another VM created the directories.   If not, we may noðŸ”µ</abbr></span>
<span class="5346057857994506172" onmouseenter="enter('5346057857994506172');" onmouseout="out('5346057857994506172');" style=""> 186                         // proper permissions and this is an error we need to report.                    </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 187                         if (!baseLocalFile.getParentFile().exists()) {                                   </span>
<span class="-3100057651899633278" onmouseenter="enter('-3100057651899633278');" onmouseout="out('-3100057651899633278');" style=""> 188                             throw new RuntimeException(&quot;Unable to create middle directories for file: &quot; +</span>
<span class="-3627057965366514409" onmouseenter="enter('-3627057965366514409');" onmouseout="out('-3627057965366514409');" style=""> 189                                     baseLocalFile.getAbsolutePath());                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 191                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 192                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193             }                                                                                            </span>
<span  style=""> 194                                                                                                          </span>
<span class="1058516638336488341" onmouseenter="enter('1058516638336488341');" onmouseout="out('1058516638336488341');" style=""> 195             concurrentFileOutputStream.write(is, baseLocalFile);                                         </span>
<span  style=""> 196                                                                                                          </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 197         } finally {                                                                                      </span>
<span class="-1036224550261950069" onmouseenter="enter('-1036224550261950069');" onmouseout="out('-1036224550261950069');" style=""> 198             IOUtils.closeQuietly(is);                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200     }                                                                                                    </span>
<span  style=""> 201                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 202     @Override                                                                                            </span>
<span class="-5764870268385651216" onmouseenter="enter('-5764870268385651216');" onmouseout="out('-5764870268385651216');" style=""><abbr title=" 203     public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws Exception {"> 203     public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throwsðŸ”µ</abbr></span>
<span class="491052228983464108" onmouseenter="enter('491052228983464108');" onmouseout="out('491052228983464108');" style=""> 204         StaticAsset staticAsset = findStaticAsset(fullUrl);                                              </span>
<span class="-3786942395132975147" onmouseenter="enter('-3786942395132975147');" onmouseout="out('-3786942395132975147');" style=""> 205         if (staticAsset == null) {                                                                       </span>
<span class="-676167423781739050" onmouseenter="enter('-676167423781739050');" onmouseout="out('-676167423781739050');" style=""> 206             throw new AssetNotFoundException(&quot;Unable to find an asset for the url (&quot; + fullUrl + &quot;)&quot;);   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 207         }                                                                                                </span>
<span class="-5398322132344119647" onmouseenter="enter('-5398322132344119647');" onmouseout="out('-5398322132344119647');" style=""> 208         String mimeType = staticAsset.getMimeType();                                                     </span>
<span  style=""> 209                                                                                                          </span>
<span class="8252026315203489548" onmouseenter="enter('8252026315203489548');" onmouseout="out('8252026315203489548');" style=""> 210         //extract the values for any named parameters                                                    </span>
<span class="1331021329476510285" onmouseenter="enter('1331021329476510285');" onmouseout="out('1331021329476510285');" style=""> 211         boolean shouldRecompress = shouldRecompress(mimeType);                                           </span>
<span class="5491208348485302910" onmouseenter="enter('5491208348485302910');" onmouseout="out('5491208348485302910');" style=""><abbr title=" 212         Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMap);"> 212         Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMaðŸ”µ</abbr></span>
<span class="1628034097147692048" onmouseenter="enter('1628034097147692048');" onmouseout="out('1628034097147692048');" style=""> 213         if (shouldRecompress &amp;&amp; MapUtils.isEmpty(convertedParameters)) {                                 </span>
<span class="-8260123448707150424" onmouseenter="enter('-8260123448707150424');" onmouseout="out('-8260123448707150424');" style=""> 214             convertedParameters.put(&quot;recompress&quot;,&quot;true&quot;);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 215         }                                                                                                </span>
<span class="-6987211962421403682" onmouseenter="enter('-6987211962421403682');" onmouseout="out('-6987211962421403682');" style=""> 216         String cachedFileName = constructCacheFileName(staticAsset, convertedParameters);                </span>
<span  style=""> 217                                                                                                          </span>
<span class="-4010270241296523972" onmouseenter="enter('-4010270241296523972');" onmouseout="out('-4010270241296523972');" style=""> 218         if (shouldRecompress) {                                                                          </span>
<span class="3725275006012768392" onmouseenter="enter('3725275006012768392');" onmouseout="out('3725275006012768392');" style=""> 219             convertedParameters.remove(&quot;recompress&quot;);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 220         }                                                                                                </span>
<span  style=""> 221                                                                                                          </span>
<span class="-5673162797879974066" onmouseenter="enter('-5673162797879974066');" onmouseout="out('-5673162797879974066');" style=""><abbr title=" 222         // Look for a shared file (this represents a file that was based on a file originally in the classpath."> 222         // Look for a shared file (this represents a file that was based on a file originally in the clasðŸ”µ</abbr></span>
<span class="-744748978496739834" onmouseenter="enter('-744748978496739834');" onmouseout="out('-744748978496739834');" style=""> 223         File cacheFile = getFileFromLocalRepository(cachedFileName);                                     </span>
<span class="-2028153032285377680" onmouseenter="enter('-2028153032285377680');" onmouseout="out('-2028153032285377680');" style=""> 224         if (cacheFile.exists()) {                                                                        </span>
<span class="-5770017993670818757" onmouseenter="enter('-5770017993670818757');" onmouseout="out('-5770017993670818757');" style=""> 225             return buildModel(cacheFile.getAbsolutePath(), mimeType);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 226         }                                                                                                </span>
<span  style=""> 227                                                                                                          </span>
<span class="7943467756367013608" onmouseenter="enter('7943467756367013608');" onmouseout="out('7943467756367013608');" style=""> 228         // Obtain the base file (that we may need to convert based on the parameters                     </span>
<span class="-7282961418041278395" onmouseenter="enter('-7282961418041278395');" onmouseout="out('-7282961418041278395');" style=""> 229         String baseCachedFileName = constructCacheFileName(staticAsset, null);                           </span>
<span class="2819718340222738473" onmouseenter="enter('2819718340222738473');" onmouseout="out('2819718340222738473');" style=""> 230         File baseLocalFile = getFileFromLocalRepository(baseCachedFileName);                             </span>
<span  style=""> 231                                                                                                          </span>
<span class="7807331939993150402" onmouseenter="enter('7807331939993150402');" onmouseout="out('7807331939993150402');" style=""> 232         if (! baseLocalFile.exists()) {                                                                  </span>
<span class="-4152796465711126856" onmouseenter="enter('-4152796465711126856');" onmouseout="out('-4152796465711126856');" style=""> 233             if (broadleafFileService.checkForResourceOnClassPath(staticAsset.getFullUrl())) {            </span>
<span class="-8910009845238484526" onmouseenter="enter('-8910009845238484526');" onmouseout="out('-8910009845238484526');" style=""> 234                 cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);                 </span>
<span class="-3411813136412986040" onmouseenter="enter('-3411813136412986040');" onmouseout="out('-3411813136412986040');" style=""> 235                 baseLocalFile = broadleafFileService.getSharedLocalResource(baseCachedFileName);         </span>
<span class="-4235219464337080287" onmouseenter="enter('-4235219464337080287');" onmouseout="out('-4235219464337080287');" style=""> 236                 createLocalFileFromClassPathResource(staticAsset, baseLocalFile);                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 237             } else {                                                                                     </span>
<span class="-4898184433395929673" onmouseenter="enter('-4898184433395929673');" onmouseout="out('-4898184433395929673');" style=""> 238                 baseLocalFile = lookupAssetAndCreateLocalFile(staticAsset, baseLocalFile);               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 239             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 240         }                                                                                                </span>
<span  style=""> 241                                                                                                          </span>
<span  style=""> 242                                                                                                          </span>
<span class="-524316509192333846" onmouseenter="enter('-524316509192333846');" onmouseout="out('-524316509192333846');" style=""> 243         if (!shouldRecompress &amp;&amp; convertedParameters.isEmpty()) {                                        </span>
<span class="1541740886220527868" onmouseenter="enter('1541740886220527868');" onmouseout="out('1541740886220527868');" style=""> 244             return buildModel(baseLocalFile.getAbsolutePath(), mimeType);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 245         }                                                                                                </span>
<span class="4391598042186419731" onmouseenter="enter('4391598042186419731');" onmouseout="out('4391598042186419731');" style=""> 246         else {                                                                                           </span>
<span class="2626429018838635667" onmouseenter="enter('2626429018838635667');" onmouseout="out('2626429018838635667');" style=""> 247             FileInputStream assetStream = new FileInputStream(baseLocalFile);                            </span>
<span class="1559981230759799611" onmouseenter="enter('1559981230759799611');" onmouseout="out('1559981230759799611');" style=""> 248             BufferedInputStream original = new BufferedInputStream(assetStream);                         </span>
<span class="5335072745234046164" onmouseenter="enter('5335072745234046164');" onmouseout="out('5335072745234046164');" style=""> 249             original.mark(0);                                                                            </span>
<span  style=""> 250                                                                                                          </span>
<span class="3271606902025597443" onmouseenter="enter('3271606902025597443');" onmouseout="out('3271606902025597443');" style=""><abbr title=" 251             Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.getMimeType());"> 251             Operation[] operations = artifactService.buildOperations(convertedParameters, original, statiðŸ”µ</abbr></span>
<span class="-4049222348408471473" onmouseenter="enter('-4049222348408471473');" onmouseout="out('-4049222348408471473');" style=""><abbr title=" 252             InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeType());"> 252             InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeTypeðŸ”µ</abbr></span>
<span  style=""> 253                                                                                                          </span>
<span class="-5852373631387772582" onmouseenter="enter('-5852373631387772582');" onmouseout="out('-5852373631387772582');" style=""> 254             createLocalFileFromInputStream(converted, cacheFile);                                        </span>
<span class="8481176371776030575" onmouseenter="enter('8481176371776030575');" onmouseout="out('8481176371776030575');" style=""> 255             if (&quot;image/gif&quot;.equals(mimeType)) {                                                          </span>
<span class="6692235241863720447" onmouseenter="enter('6692235241863720447');" onmouseout="out('6692235241863720447');" style=""> 256                 mimeType = &quot;image/png&quot;;                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 257             }                                                                                            </span>
<span class="-5770017993670818757" onmouseenter="enter('-5770017993670818757');" onmouseout="out('-5770017993670818757');" style=""> 258             return buildModel(cacheFile.getAbsolutePath(), mimeType);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 259         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 260     }                                                                                                    </span>
<span  style=""> 261                                                                                                          </span>
<span class="1436332013455477710" onmouseenter="enter('1436332013455477710');" onmouseout="out('1436332013455477710');" style=""> 262     protected boolean shouldRecompress(String mimeType) {                                                </span>
<span class="-2947492696471387039" onmouseenter="enter('-2947492696471387039');" onmouseout="out('-2947492696471387039');" style=""> 263         String[] formats = null;                                                                         </span>
<span class="3146177423232232799" onmouseenter="enter('3146177423232232799');" onmouseout="out('3146177423232232799');" style=""> 264         if (!StringUtils.isEmpty(recompressFormats)) {                                                   </span>
<span class="-5929026035202084105" onmouseenter="enter('-5929026035202084105');" onmouseout="out('-5929026035202084105');" style=""> 265             formats = recompressFormats.split(&quot;,&quot;);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 266         }                                                                                                </span>
<span class="7342740188292578775" onmouseenter="enter('7342740188292578775');" onmouseout="out('7342740188292578775');" style=""> 267         boolean response = false;                                                                        </span>
<span class="-630918830715510960" onmouseenter="enter('-630918830715510960');" onmouseout="out('-630918830715510960');" style=""> 268         if (!ArrayUtils.isEmpty(formats)) {                                                              </span>
<span class="2272716586254590500" onmouseenter="enter('2272716586254590500');" onmouseout="out('2272716586254590500');" style=""> 269             for (String format : formats) {                                                              </span>
<span class="-250489820996933262" onmouseenter="enter('-250489820996933262');" onmouseout="out('-250489820996933262');" style=""> 270                 if (mimeType.toLowerCase().contains(format.toLowerCase())) {                             </span>
<span class="-7568734358544125355" onmouseenter="enter('-7568734358544125355');" onmouseout="out('-7568734358544125355');" style=""> 271                     response = true;                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 272                     break;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 273                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 274             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 275         }                                                                                                </span>
<span class="-1838489616061912436" onmouseenter="enter('-1838489616061912436');" onmouseout="out('-1838489616061912436');" style=""> 276         return response;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 277     }                                                                                                    </span>
<span  style=""> 278                                                                                                          </span>
<span class="-5129110647668669753" onmouseenter="enter('-5129110647668669753');" onmouseout="out('-5129110647668669753');" style=""> 279     protected Map&lt;String, String&gt; buildModel(String returnFilePath, String mimeType) {                   </span>
<span class="-5436835504658380993" onmouseenter="enter('-5436835504658380993');" onmouseout="out('-5436835504658380993');" style=""> 280         Map&lt;String, String&gt; model = new HashMap&lt;String, String&gt;(2);                                      </span>
<span class="-7931157778314956360" onmouseenter="enter('-7931157778314956360');" onmouseout="out('-7931157778314956360');" style=""> 281         model.put(&quot;cacheFilePath&quot;, returnFilePath);                                                      </span>
<span class="-121481178440989733" onmouseenter="enter('-121481178440989733');" onmouseout="out('-121481178440989733');" style=""> 282         model.put(&quot;mimeType&quot;, mimeType);                                                                 </span>
<span  style=""> 283                                                                                                          </span>
<span class="1327412617440986435" onmouseenter="enter('1327412617440986435');" onmouseout="out('1327412617440986435');" style=""> 284         return model;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285     }                                                                                                    </span>
<span  style=""> 286                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 287     @Override                                                                                            </span>
<span class="-2260190509208115003" onmouseenter="enter('-2260190509208115003');" onmouseout="out('-2260190509208115003');" style=""> 288     public StaticAssetStorage findStaticAssetStorageById(final Long id) {                                </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 289         final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                  </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 290         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 291             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 292             public void execute() {                                                                      </span>
<span class="-2207751287529111136" onmouseenter="enter('-2207751287529111136');" onmouseout="out('-2207751287529111136');" style=""> 293                 storage[0] = staticAssetStorageDao.readStaticAssetStorageById(id);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 294             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 295         }, RuntimeException.class);                                                                      </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 296         return storage[0];                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 297     }                                                                                                    </span>
<span  style=""> 298                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 299     @Override                                                                                            </span>
<span class="-2864285839814759705" onmouseenter="enter('-2864285839814759705');" onmouseout="out('-2864285839814759705');" style=""> 300     public StaticAssetStorage create() {                                                                 </span>
<span class="-1873403527653357243" onmouseenter="enter('-1873403527653357243');" onmouseout="out('-1873403527653357243');" style=""> 301         return staticAssetStorageDao.create();                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 302     }                                                                                                    </span>
<span  style=""> 303                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 304     @Override                                                                                            </span>
<span class="7662571466653582755" onmouseenter="enter('7662571466653582755');" onmouseout="out('7662571466653582755');" style=""> 305     public StaticAssetStorage readStaticAssetStorageByStaticAssetId(final Long id) {                     </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 306         final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                  </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 307         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 308             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 309             public void execute() {                                                                      </span>
<span class="8795705063184424946" onmouseenter="enter('8795705063184424946');" onmouseout="out('8795705063184424946');" style=""> 310                 storage[0] = staticAssetStorageDao.readStaticAssetStorageByStaticAssetId(id);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 311             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 312         }, RuntimeException.class);                                                                      </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 313         return storage[0];                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 314     }                                                                                                    </span>
<span  style=""> 315                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 316     @Override                                                                                            </span>
<span class="6485967695518229819" onmouseenter="enter('6485967695518229819');" onmouseout="out('6485967695518229819');" style=""> 317     public StaticAssetStorage save(final StaticAssetStorage assetStorage) {                              </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 318         final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                  </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 319         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 320             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 321             public void execute() {                                                                      </span>
<span class="-6036718856004453538" onmouseenter="enter('-6036718856004453538');" onmouseout="out('-6036718856004453538');" style=""> 322                 storage[0] = staticAssetStorageDao.save(assetStorage);                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 323             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 324         }, RuntimeException.class);                                                                      </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 325         return storage[0];                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 326     }                                                                                                    </span>
<span  style=""> 327                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 328     @Override                                                                                            </span>
<span class="7860976460954721267" onmouseenter="enter('7860976460954721267');" onmouseout="out('7860976460954721267');" style=""> 329     public void delete(final StaticAssetStorage assetStorage) {                                          </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 330         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 331             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 332             public void execute() {                                                                      </span>
<span class="5167138969991588867" onmouseenter="enter('5167138969991588867');" onmouseout="out('5167138969991588867');" style=""> 333                 staticAssetStorageDao.delete(assetStorage);                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 334             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 335         }, RuntimeException.class);                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 336     }                                                                                                    </span>
<span  style=""> 337                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 338     @Override                                                                                            </span>
<span class="-1910899245286681437" onmouseenter="enter('-1910899245286681437');" onmouseout="out('-1910899245286681437');" style=""> 339     public Blob createBlob(final MultipartFile uploadedFile) throws IOException {                        </span>
<span class="848437443390195780" onmouseenter="enter('848437443390195780');" onmouseout="out('848437443390195780');" style=""> 340         final Blob[] blob = new Blob[1];                                                                 </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 341         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 342             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 343             public void execute() {                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 344                 try {                                                                                    </span>
<span class="3702070050705863788" onmouseenter="enter('3702070050705863788');" onmouseout="out('3702070050705863788');" style=""> 345                     blob[0] = staticAssetStorageDao.createBlob(uploadedFile);                            </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 346                 } catch (IOException e) {                                                                </span>
<span class="5116711708032073694" onmouseenter="enter('5116711708032073694');" onmouseout="out('5116711708032073694');" style=""> 347                     LOG.error(&quot;Unable to create blob from MultipartFile.&quot;, e);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 348                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 349             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 350         }, RuntimeException.class);                                                                      </span>
<span class="-3204915544472573462" onmouseenter="enter('-3204915544472573462');" onmouseout="out('-3204915544472573462');" style=""> 351         return blob[0];                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 352     }                                                                                                    </span>
<span  style=""> 353                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 354     @Override                                                                                            </span>
<span class="4382666547830473388" onmouseenter="enter('4382666547830473388');" onmouseout="out('4382666547830473388');" style=""><abbr title=" 355     public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOException {"> 355     public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOExcepðŸ”µ</abbr></span>
<span class="848437443390195780" onmouseenter="enter('848437443390195780');" onmouseout="out('848437443390195780');" style=""> 356         final Blob[] blob = new Blob[1];                                                                 </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 357         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 358             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 359             public void execute() {                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 360                 try {                                                                                    </span>
<span class="-8405931859176759523" onmouseenter="enter('-8405931859176759523');" onmouseout="out('-8405931859176759523');" style=""> 361                     blob[0] = staticAssetStorageDao.createBlob(uploadedFileInputStream, fileSize);       </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 362                 } catch (IOException e) {                                                                </span>
<span class="10365894759289852" onmouseenter="enter('10365894759289852');" onmouseout="out('10365894759289852');" style=""> 363                     LOG.error(&quot;Unable to create blob from InputStream.&quot;, e);                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 364                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 365             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 366         }, RuntimeException.class);                                                                      </span>
<span class="-3204915544472573462" onmouseenter="enter('-3204915544472573462');" onmouseout="out('-3204915544472573462');" style=""> 367         return blob[0];                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 368     }                                                                                                    </span>
<span  style=""> 369                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 370     /**                                                                                                  </span>
<span class="1204867681485950258" onmouseenter="enter('1204867681485950258');" onmouseout="out('1204867681485950258');" style=""> 371      * Builds a file system path for the passed in static asset and paramaterMap.                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 372      *                                                                                                   </span>
<span class="-8533974154884571802" onmouseenter="enter('-8533974154884571802');" onmouseout="out('-8533974154884571802');" style=""> 373      * @param staticAsset                                                                                </span>
<span class="1550808242639330275" onmouseenter="enter('1550808242639330275');" onmouseout="out('1550808242639330275');" style=""> 374      * @param parameterMap                                                                               </span>
<span class="966966680655938311" onmouseenter="enter('966966680655938311');" onmouseout="out('966966680655938311');" style=""> 375      * @param useSharedFile                                                                              </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 376      * @return                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 377      */                                                                                                  </span>
<span class="9052993107782234324" onmouseenter="enter('9052993107782234324');" onmouseout="out('9052993107782234324');" style=""> 378     protected String constructCacheFileName(StaticAsset staticAsset, Map&lt;String, String&gt; parameterMap) { </span>
<span class="6966748151173677546" onmouseenter="enter('6966748151173677546');" onmouseout="out('6966748151173677546');" style=""> 379         String fileName = staticAsset.getFullUrl();                                                      </span>
<span  style=""> 380                                                                                                          </span>
<span class="-4507417291042206746" onmouseenter="enter('-4507417291042206746');" onmouseout="out('-4507417291042206746');" style=""> 381         StringBuilder sb = new StringBuilder(200);                                                       </span>
<span class="-483528478759561910" onmouseenter="enter('-483528478759561910');" onmouseout="out('-483528478759561910');" style=""> 382         sb.append(fileName.substring(0, fileName.lastIndexOf(&#x27;.&#x27;)));                                     </span>
<span class="4093974766537940594" onmouseenter="enter('4093974766537940594');" onmouseout="out('4093974766537940594');" style=""> 383         sb.append(&quot;---&quot;);                                                                                </span>
<span  style=""> 384                                                                                                          </span>
<span class="3988790927371777098" onmouseenter="enter('3988790927371777098');" onmouseout="out('3988790927371777098');" style=""> 385         StringBuilder sb2 = new StringBuilder(200);                                                      </span>
<span class="1220298265095205393" onmouseenter="enter('1220298265095205393');" onmouseout="out('1220298265095205393');" style=""> 386         SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd-HH-mm-ss&quot;);                           </span>
<span class="8844493969073287544" onmouseenter="enter('8844493969073287544');" onmouseout="out('8844493969073287544');" style=""> 387         if (staticAsset instanceof Auditable) {                                                          </span>
<span class="-4932550937064679086" onmouseenter="enter('-4932550937064679086');" onmouseout="out('-4932550937064679086');" style=""> 388             Auditable auditableStaticAsset = (Auditable) staticAsset;                                    </span>
<span class="2764706875669982552" onmouseenter="enter('2764706875669982552');" onmouseout="out('2764706875669982552');" style=""><abbr title=" 389             sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCreated() : auditableStaticAsset.getDateUpdated()));"> 389             sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAssetðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 390         }                                                                                                </span>
<span  style=""> 391                                                                                                          </span>
<span class="-9176202731662601074" onmouseenter="enter('-9176202731662601074');" onmouseout="out('-9176202731662601074');" style=""> 392         if (parameterMap != null) {                                                                      </span>
<span class="-8466079002823576232" onmouseenter="enter('-8466079002823576232');" onmouseout="out('-8466079002823576232');" style=""> 393             for (Map.Entry&lt;String, String&gt; entry : parameterMap.entrySet()) {                            </span>
<span class="-5538998764085201912" onmouseenter="enter('-5538998764085201912');" onmouseout="out('-5538998764085201912');" style=""> 394                 sb2.append(&#x27;-&#x27;);                                                                         </span>
<span class="2475309890837225957" onmouseenter="enter('2475309890837225957');" onmouseout="out('2475309890837225957');" style=""> 395                 sb2.append(entry.getKey());                                                              </span>
<span class="-5538998764085201912" onmouseenter="enter('-5538998764085201912');" onmouseout="out('-5538998764085201912');" style=""> 396                 sb2.append(&#x27;-&#x27;);                                                                         </span>
<span class="7337918225958425753" onmouseenter="enter('7337918225958425753');" onmouseout="out('7337918225958425753');" style=""> 397                 sb2.append(entry.getValue());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 398             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 399         }                                                                                                </span>
<span  style=""> 400                                                                                                          </span>
<span class="-3611986260301585228" onmouseenter="enter('-3611986260301585228');" onmouseout="out('-3611986260301585228');" style=""> 401         String digest;                                                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 402         try {                                                                                            </span>
<span class="-6955618976542935940" onmouseenter="enter('-6955618976542935940');" onmouseout="out('-6955618976542935940');" style=""> 403             MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);                                         </span>
<span class="-42474679596396087" onmouseenter="enter('-42474679596396087');" onmouseout="out('-42474679596396087');" style=""> 404             byte[] messageDigest = md.digest(sb2.toString().getBytes());                                 </span>
<span class="-5380974963518813864" onmouseenter="enter('-5380974963518813864');" onmouseout="out('-5380974963518813864');" style=""> 405             BigInteger number = new BigInteger(1,messageDigest);                                         </span>
<span class="5844706554126289727" onmouseenter="enter('5844706554126289727');" onmouseout="out('5844706554126289727');" style=""> 406             digest = number.toString(16);                                                                </span>
<span class="-4215171220869553942" onmouseenter="enter('-4215171220869553942');" onmouseout="out('-4215171220869553942');" style=""> 407         } catch(NoSuchAlgorithmException e) {                                                            </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 408             throw new RuntimeException(e);                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 409         }                                                                                                </span>
<span  style=""> 410                                                                                                          </span>
<span class="-5802237960969046083" onmouseenter="enter('-5802237960969046083');" onmouseout="out('-5802237960969046083');" style=""> 411         sb.append(pad(digest, 32, &#x27;0&#x27;));                                                                 </span>
<span class="-4790971325793185911" onmouseenter="enter('-4790971325793185911');" onmouseout="out('-4790971325793185911');" style=""> 412         sb.append(fileName.substring(fileName.lastIndexOf(&#x27;.&#x27;)));                                        </span>
<span  style=""> 413                                                                                                          </span>
<span class="-6276773404435993532" onmouseenter="enter('-6276773404435993532');" onmouseout="out('-6276773404435993532');" style=""> 414         return sb.toString();                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 415     }                                                                                                    </span>
<span  style=""> 416                                                                                                          </span>
<span class="3889823321692711159" onmouseenter="enter('3889823321692711159');" onmouseout="out('3889823321692711159');" style=""> 417     protected String pad(String s, int length, char pad) {                                               </span>
<span class="445211846679573021" onmouseenter="enter('445211846679573021');" onmouseout="out('445211846679573021');" style=""> 418         StringBuilder buffer = new StringBuilder(s);                                                     </span>
<span class="-1767419613255418829" onmouseenter="enter('-1767419613255418829');" onmouseout="out('-1767419613255418829');" style=""> 419         while (buffer.length() &lt; length) {                                                               </span>
<span class="5619102104931061603" onmouseenter="enter('5619102104931061603');" onmouseout="out('5619102104931061603');" style=""> 420             buffer.insert(0, pad);                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 421         }                                                                                                </span>
<span class="-2038716794812902958" onmouseenter="enter('-2038716794812902958');" onmouseout="out('-2038716794812902958');" style=""> 422         return buffer.toString();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 423     }                                                                                                    </span>
<span  style=""> 424                                                                                                          </span>
<span class="8674831860571754100" onmouseenter="enter('8674831860571754100');" onmouseout="out('8674831860571754100');" style=""> 425     @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)                                               </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 426     @Override                                                                                            </span>
<span class="124994076020326784" onmouseenter="enter('124994076020326784');" onmouseout="out('124994076020326784');" style=""><abbr title=" 427     public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOException {"> 427     public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOExðŸ”µ</abbr></span>
<span class="-2118089514208048024" onmouseenter="enter('-2118089514208048024');" onmouseout="out('-2118089514208048024');" style=""> 428         createStaticAssetStorage(file.getInputStream(), staticAsset);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 429     }                                                                                                    </span>
<span  style=""> 430                                                                                                          </span>
<span class="8674831860571754100" onmouseenter="enter('8674831860571754100');" onmouseout="out('8674831860571754100');" style=""> 431     @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)                                               </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 432     @Override                                                                                            </span>
<span class="-850236438741332732" onmouseenter="enter('-850236438741332732');" onmouseout="out('-850236438741332732');" style=""><abbr title=" 433     public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException {"> 433     public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOEðŸ”µ</abbr></span>
<span class="-1403207369962524759" onmouseenter="enter('-1403207369962524759');" onmouseout="out('-1403207369962524759');" style=""> 434         if (StorageType.DATABASE.equals(staticAsset.getStorageType())) {                                 </span>
<span class="-1939605028615766275" onmouseenter="enter('-1939605028615766275');" onmouseout="out('-1939605028615766275');" style=""> 435             StaticAssetStorage storage = create();                                                       </span>
<span class="-204637599683518602" onmouseenter="enter('-204637599683518602');" onmouseout="out('-204637599683518602');" style=""> 436             storage.setStaticAssetId(staticAsset.getId());                                               </span>
<span class="1384418291306141967" onmouseenter="enter('1384418291306141967');" onmouseout="out('1384418291306141967');" style=""> 437             Blob uploadBlob = createBlob(fileInputStream, staticAsset.getFileSize());                    </span>
<span class="6866380704006125127" onmouseenter="enter('6866380704006125127');" onmouseout="out('6866380704006125127');" style=""> 438             storage.setFileData(uploadBlob);                                                             </span>
<span class="-2840973363991180880" onmouseenter="enter('-2840973363991180880');" onmouseout="out('-2840973363991180880');" style=""> 439             save(storage);                                                                               </span>
<span class="-2132857837912478262" onmouseenter="enter('-2132857837912478262');" onmouseout="out('-2132857837912478262');" style=""> 440         } else if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {                        </span>
<span class="-4012729166374721308" onmouseenter="enter('-4012729166374721308');" onmouseout="out('-4012729166374721308');" style=""> 441             FileWorkArea tempWorkArea = broadleafFileService.initializeWorkArea();                       </span>
<span class="-4881648785169426910" onmouseenter="enter('-4881648785169426910');" onmouseout="out('-4881648785169426910');" style=""> 442             // Convert the given URL from the asset to a system-specific suitable file path              </span>
<span class="-6260899414746866851" onmouseenter="enter('-6260899414746866851');" onmouseout="out('-6260899414746866851');" style=""><abbr title=" 443             String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FilenameUtils.separatorsToSystem(staticAsset.getFullUrl()));"> 443             String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separðŸ”µ</abbr></span>
<span  style=""> 444                                                                                                          </span>
<span class="2773091736631403971" onmouseenter="enter('2773091736631403971');" onmouseout="out('2773091736631403971');" style=""> 445             InputStream input = fileInputStream;                                                         </span>
<span class="6832533006494732607" onmouseenter="enter('6832533006494732607');" onmouseout="out('6832533006494732607');" style=""> 446             byte[] buffer = new byte[getFileBufferSize()];                                               </span>
<span  style=""> 447                                                                                                          </span>
<span class="-6502247887775821258" onmouseenter="enter('-6502247887775821258');" onmouseout="out('-6502247887775821258');" style=""> 448             File destFile = new File(destFileName);                                                      </span>
<span class="-695082894467535606" onmouseenter="enter('-695082894467535606');" onmouseout="out('-695082894467535606');" style=""> 449             if (!destFile.getParentFile().exists()) {                                                    </span>
<span class="8653794664879930122" onmouseenter="enter('8653794664879930122');" onmouseout="out('8653794664879930122');" style=""> 450                 if (!destFile.getParentFile().mkdirs()) {                                                </span>
<span class="-695082894467535606" onmouseenter="enter('-695082894467535606');" onmouseout="out('-695082894467535606');" style=""> 451                     if (!destFile.getParentFile().exists()) {                                            </span>
<span class="5433889739361026965" onmouseenter="enter('5433889739361026965');" onmouseout="out('5433889739361026965');" style=""><abbr title=" 452                         throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileName);"> 452                         throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + desðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 453                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 454                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 455             }                                                                                            </span>
<span  style=""> 456                                                                                                          </span>
<span class="6445829042907396164" onmouseenter="enter('6445829042907396164');" onmouseout="out('6445829042907396164');" style=""> 457             OutputStream output = new FileOutputStream(destFile);                                        </span>
<span class="-5038889493716933228" onmouseenter="enter('-5038889493716933228');" onmouseout="out('-5038889493716933228');" style=""> 458             long maxFileSize = getMaxUploadSizeForFile(destFileName);                                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 459             try {                                                                                        </span>
<span class="-7067986891170572893" onmouseenter="enter('-7067986891170572893');" onmouseout="out('-7067986891170572893');" style=""> 460                 int bytesRead;                                                                           </span>
<span class="5297046094019116056" onmouseenter="enter('5297046094019116056');" onmouseout="out('5297046094019116056');" style=""> 461                 int totalBytesRead = 0;                                                                  </span>
<span class="-7676219729156525464" onmouseenter="enter('-7676219729156525464');" onmouseout="out('-7676219729156525464');" style=""> 462                 while ((bytesRead = input.read(buffer)) != -1) {                                         </span>
<span class="-6799238023814913099" onmouseenter="enter('-6799238023814913099');" onmouseout="out('-6799238023814913099');" style=""> 463                     totalBytesRead += bytesRead;                                                         </span>
<span class="775261430666212722" onmouseenter="enter('775261430666212722');" onmouseout="out('775261430666212722');" style=""> 464                     if (totalBytesRead &gt; maxFileSize) {                                                  </span>
<span class="-104032706615660809" onmouseenter="enter('-104032706615660809');" onmouseout="out('-104032706615660809');" style=""> 465                         throw new IOException(&quot;Maximum Upload File Size Exceeded&quot;);                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 466                     }                                                                                    </span>
<span class="6143107777038809767" onmouseenter="enter('6143107777038809767');" onmouseout="out('6143107777038809767');" style=""> 467                     output.write(buffer, 0, bytesRead);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 468                 }                                                                                        </span>
<span  style=""> 469                                                                                                          </span>
<span class="-3636717142636833723" onmouseenter="enter('-3636717142636833723');" onmouseout="out('-3636717142636833723');" style=""> 470                 // close the output file stream prior to moving files around                             </span>
<span class="-7467153277872057229" onmouseenter="enter('-7467153277872057229');" onmouseout="out('-7467153277872057229');" style=""> 471                 output.close();                                                                          </span>
<span class="-7014270169952325099" onmouseenter="enter('-7014270169952325099');" onmouseout="out('-7014270169952325099');" style=""> 472                 broadleafFileService.addOrUpdateResource(tempWorkArea, destFile, false);                 </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 473             } finally {                                                                                  </span>
<span class="4174609820499721765" onmouseenter="enter('4174609820499721765');" onmouseout="out('4174609820499721765');" style=""> 474                 IOUtils.closeQuietly(output);                                                            </span>
<span class="5684068854007703140" onmouseenter="enter('5684068854007703140');" onmouseout="out('5684068854007703140');" style=""> 475                 broadleafFileService.closeWorkArea(tempWorkArea);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 476             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 477         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 478     }                                                                                                    </span>
<span  style=""> 479                                                                                                          </span>
<span class="7880420848062709346" onmouseenter="enter('7880420848062709346');" onmouseout="out('7880420848062709346');" style=""> 480     protected long getMaxUploadSizeForFile(String fileName) {                                            </span>
<span class="-8299331750570909154" onmouseenter="enter('-8299331750570909154');" onmouseout="out('-8299331750570909154');" style=""> 481         if (isImageFile(fileName)) {                                                                     </span>
<span class="-8904535810123442239" onmouseenter="enter('-8904535810123442239');" onmouseout="out('-8904535810123442239');" style=""> 482             return getMaxUploadableImageSize();                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 483         }                                                                                                </span>
<span  style=""> 484                                                                                                          </span>
<span class="7342651561788072273" onmouseenter="enter('7342651561788072273');" onmouseout="out('7342651561788072273');" style=""> 485         return getMaxUploadableFileSize();                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 486     }                                                                                                    </span>
<span  style=""> 487                                                                                                          </span>
<span class="-4256605375867072165" onmouseenter="enter('-4256605375867072165');" onmouseout="out('-4256605375867072165');" style=""> 488     protected boolean isImageFile(String fileName) {                                                     </span>
<span class="-7215778148857055723" onmouseenter="enter('-7215778148857055723');" onmouseout="out('-7215778148857055723');" style=""> 489         String extension = getFileExtension(fileName);                                                   </span>
<span  style=""> 490                                                                                                          </span>
<span class="868046925461100818" onmouseenter="enter('868046925461100818');" onmouseout="out('868046925461100818');" style=""> 491         for (String imageFileExtension : getAdminImageFileExtensions()) {                                </span>
<span class="-1882310683799532334" onmouseenter="enter('-1882310683799532334');" onmouseout="out('-1882310683799532334');" style=""> 492             if (imageFileExtension.equalsIgnoreCase(extension)) {                                        </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 493                 return true;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 494             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 495         }                                                                                                </span>
<span  style=""> 496                                                                                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 497         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 498     }                                                                                                    </span>
<span  style=""> 499                                                                                                          </span>
<span class="-4067859991978763128" onmouseenter="enter('-4067859991978763128');" onmouseout="out('-4067859991978763128');" style=""> 500     protected String getFileExtension(String assetPath) {                                                </span>
<span class="-7365160516150097212" onmouseenter="enter('-7365160516150097212');" onmouseout="out('-7365160516150097212');" style=""> 501         int extensionStartIndex = assetPath.lastIndexOf(&quot;.&quot;) + 1;                                        </span>
<span class="3165050002785748305" onmouseenter="enter('3165050002785748305');" onmouseout="out('3165050002785748305');" style=""> 502         return assetPath.substring(extensionStartIndex);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 503     }                                                                                                    </span>
<span  style=""> 504                                                                                                          </span>
<span class="8520324044054424760" onmouseenter="enter('8520324044054424760');" onmouseout="out('8520324044054424760');" style=""> 505     protected long getMaxUploadableFileSize() {                                                          </span>
<span class="-8242800191702968016" onmouseenter="enter('-8242800191702968016');" onmouseout="out('-8242800191702968016');" style=""> 506         Long blcUploadSize = env.getProperty(&quot;asset.server.max.uploadable.file.size&quot;, Long.class);       </span>
<span class="-6815277628371519591" onmouseenter="enter('-6815277628371519591');" onmouseout="out('-6815277628371519591');" style=""> 507         if (blcUploadSize != null) {                                                                     </span>
<span class="-2122879694774875974" onmouseenter="enter('-2122879694774875974');" onmouseout="out('-2122879694774875974');" style=""> 508             return blcUploadSize;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 509         }                                                                                                </span>
<span  style=""> 510                                                                                                          </span>
<span class="-83413303193047685" onmouseenter="enter('-83413303193047685');" onmouseout="out('-83413303193047685');" style=""> 511         if (defaultMultipartSettings != null) {                                                          </span>
<span class="3781451292667627704" onmouseenter="enter('3781451292667627704');" onmouseout="out('3781451292667627704');" style=""> 512             return defaultMultipartSettings.createMultipartConfig().getMaxFileSize();                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 513         }                                                                                                </span>
<span class="8028643923497516300" onmouseenter="enter('8028643923497516300');" onmouseout="out('8028643923497516300');" style=""> 514         return DEFAULT_ASSET_UPLOAD_SIZE;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 515     }                                                                                                    </span>
<span  style=""> 516                                                                                                          </span>
<span class="-4925501260426057745" onmouseenter="enter('-4925501260426057745');" onmouseout="out('-4925501260426057745');" style=""> 517     protected long getMaxUploadableImageSize() {                                                         </span>
<span class="2537324483761513782" onmouseenter="enter('2537324483761513782');" onmouseout="out('2537324483761513782');" style=""> 518         // backwards-compatibility checks, only use the image-size specific property if it is            </span>
<span class="4617761826312627412" onmouseenter="enter('4617761826312627412');" onmouseout="out('4617761826312627412');" style=""> 519         // not the default value. Otherwise, delegate to the old property                                </span>
<span class="7612408840010340391" onmouseenter="enter('7612408840010340391');" onmouseout="out('7612408840010340391');" style=""> 520         Long maxImgSize = env.getProperty(&quot;asset.server.max.uploadable.image.size&quot;, Long.class);         </span>
<span class="-430636607829496210" onmouseenter="enter('-430636607829496210');" onmouseout="out('-430636607829496210');" style=""> 521         if (maxImgSize == null) {                                                                        </span>
<span class="7342651561788072273" onmouseenter="enter('7342651561788072273');" onmouseout="out('7342651561788072273');" style=""> 522             return getMaxUploadableFileSize();                                                           </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 523         } else {                                                                                         </span>
<span class="-7468174336769267749" onmouseenter="enter('-7468174336769267749');" onmouseout="out('-7468174336769267749');" style=""> 524             return maxImgSize;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 525         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 526     }                                                                                                    </span>
<span  style=""> 527                                                                                                          </span>
<span class="3561631998050563638" onmouseenter="enter('3561631998050563638');" onmouseout="out('3561631998050563638');" style=""> 528     protected int getFileBufferSize() {                                                                  </span>
<span class="6759418199922005006" onmouseenter="enter('6759418199922005006');" onmouseout="out('6759418199922005006');" style=""> 529         return env.getProperty(&quot;asset.server.file.buffer.size&quot;, int.class, DEFAULT_BUFFER_SIZE);         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 530     }                                                                                                    </span>
<span  style=""> 531                                                                                                          </span>
<span class="-7892865232186196236" onmouseenter="enter('-7892865232186196236');" onmouseout="out('-7892865232186196236');" style=""> 532     protected List&lt;String&gt; getAdminImageFileExtensions() {                                               </span>
<span class="4831601876827029435" onmouseenter="enter('4831601876827029435');" onmouseout="out('4831601876827029435');" style=""><abbr title=" 533         String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENSIONS);"> 533         String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMðŸ”µ</abbr></span>
<span class="-1830661333141003565" onmouseenter="enter('-1830661333141003565');" onmouseout="out('-1830661333141003565');" style=""> 534         return Arrays.asList(extensions.split(&quot;,&quot;));                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 535     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 536 }                                                                                                        </span>










</pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1 /*                                                                                                       </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2  * #%L                                                                                                   </span>
<span class="-6173756248845875922" onmouseenter="enter('-6173756248845875922');" onmouseout="out('-6173756248845875922');" style="">   3  * BroadleafCommerce CMS Module                                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4  * %%                                                                                                    </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                          </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6  * %%                                                                                                    </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                  </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)    </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case    </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10  * the Broadleaf End User License Agreement (EULA), Version 1.1                                          </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt) </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12  * shall apply.                                                                                          </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13  *                                                                                                       </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style=""><abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16  * #L%                                                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17  */                                                                                                      </span>
<span class="-2980987384224312133" onmouseenter="enter('-2980987384224312133');" onmouseout="out('-2980987384224312133');" style="">  18 package org.broadleafcommerce.cms.file.service;                                                          </span>
<span  style="">  19                                                                                                          </span>
<span class="-8084092933789958161" onmouseenter="enter('-8084092933789958161');" onmouseout="out('-8084092933789958161');" style="">  20 import java.io.BufferedInputStream;                                                                      </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  21 import java.io.File;                                                                                     </span>
<span class="-535075201057145249" onmouseenter="enter('-535075201057145249');" onmouseout="out('-535075201057145249');" style="">  22 import java.io.FileInputStream;                                                                          </span>
<span class="4915709264156936957" onmouseenter="enter('4915709264156936957');" onmouseout="out('4915709264156936957');" style="">  23 import java.io.FileOutputStream;                                                                         </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  24 import java.io.IOException;                                                                              </span>
<span class="5631563232245871054" onmouseenter="enter('5631563232245871054');" onmouseout="out('5631563232245871054');" style="">  25 import java.io.InputStream;                                                                              </span>
<span class="4621164050749610193" onmouseenter="enter('4621164050749610193');" onmouseout="out('4621164050749610193');" style="">  26 import java.io.OutputStream;                                                                             </span>
<span class="-40197902381950972" onmouseenter="enter('-40197902381950972');" onmouseout="out('-40197902381950972');" style="">  27 import java.math.BigInteger;                                                                             </span>
<span class="6381430938828950472" onmouseenter="enter('6381430938828950472');" onmouseout="out('6381430938828950472');" style="">  28 import java.security.MessageDigest;                                                                      </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  29 import java.security.NoSuchAlgorithmException;                                                           </span>
<span class="-5709181831744795488" onmouseenter="enter('-5709181831744795488');" onmouseout="out('-5709181831744795488');" style="">  30 import java.sql.Blob;                                                                                    </span>
<span class="-515559982825150111" onmouseenter="enter('-515559982825150111');" onmouseout="out('-515559982825150111');" style="">  31 import java.sql.SQLException;                                                                            </span>
<span class="54331962280914690" onmouseenter="enter('54331962280914690');" onmouseout="out('54331962280914690');" style="">  32 import java.text.SimpleDateFormat;                                                                       </span>
<span class="-28465676010609596" onmouseenter="enter('-28465676010609596');" onmouseout="out('-28465676010609596');" style="">  33 import java.util.Arrays;                                                                                 </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  34 import java.util.HashMap;                                                                                </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  35 import java.util.List;                                                                                   </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  36 import java.util.Map;                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  37 import javax.annotation.Resource;                                                                        </span>
<span class="650718985643898152" onmouseenter="enter('650718985643898152');" onmouseout="out('650718985643898152');" style="">  38 import org.apache.commons.collections4.MapUtils;                                                         </span>
<span class="1592055122970313625" onmouseenter="enter('1592055122970313625');" onmouseout="out('1592055122970313625');" style="">  39 import org.apache.commons.io.FileExistsException;                                                        </span>
<span class="1419696606949779000" onmouseenter="enter('1419696606949779000');" onmouseout="out('1419696606949779000');" style="">  40 import org.apache.commons.io.FileUtils;                                                                  </span>
<span class="-2296051308340473600" onmouseenter="enter('-2296051308340473600');" onmouseout="out('-2296051308340473600');" style="">  41 import org.apache.commons.io.FilenameUtils;                                                              </span>
<span class="-7541571572495339903" onmouseenter="enter('-7541571572495339903');" onmouseout="out('-7541571572495339903');" style="">  42 import org.apache.commons.io.IOUtils;                                                                    </span>
<span class="-7366736394295216840" onmouseenter="enter('-7366736394295216840');" onmouseout="out('-7366736394295216840');" style="">  43 import org.apache.commons.lang.ArrayUtils;                                                               </span>
<span class="-8105670274694144339" onmouseenter="enter('-8105670274694144339');" onmouseout="out('-8105670274694144339');" style="">  44 import org.apache.commons.lang3.StringUtils;                                                             </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  45 import org.apache.commons.logging.Log;                                                                   </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  46 import org.apache.commons.logging.LogFactory;                                                            </span>
<span class="6421182070533632471" onmouseenter="enter('6421182070533632471');" onmouseout="out('6421182070533632471');" style="">  47 import org.broadleafcommerce.cms.common.AssetNotFoundException;                                          </span>
<span class="8163806430712317298" onmouseenter="enter('8163806430712317298');" onmouseout="out('8163806430712317298');" style="">  48 import org.broadleafcommerce.cms.field.type.StorageType;                                                 </span>
<span class="-8427882675756262690" onmouseenter="enter('-8427882675756262690');" onmouseout="out('-8427882675756262690');" style="">  49 import org.broadleafcommerce.cms.file.dao.StaticAssetStorageDao;                                         </span>
<span class="1355270185972111851" onmouseenter="enter('1355270185972111851');" onmouseout="out('1355270185972111851');" style="">  50 import org.broadleafcommerce.cms.file.domain.StaticAsset;                                                </span>
<span class="-9103956258218147401" onmouseenter="enter('-9103956258218147401');" onmouseout="out('-9103956258218147401');" style="">  51 import org.broadleafcommerce.cms.file.domain.StaticAssetStorage;                                         </span>
<span class="9188568145725907286" onmouseenter="enter('9188568145725907286');" onmouseout="out('9188568145725907286');" style="">  52 import org.broadleafcommerce.cms.file.service.operation.NamedOperationManager;                           </span>
<span class="-1074856182010318298" onmouseenter="enter('-1074856182010318298');" onmouseout="out('-1074856182010318298');" style="">  53 import org.broadleafcommerce.common.audit.Auditable;                                                     </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  54 import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                     </span>
<span class="-8339254235515724670" onmouseenter="enter('-8339254235515724670');" onmouseout="out('-8339254235515724670');" style="">  55 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;                                 </span>
<span class="-2507677682672524762" onmouseenter="enter('-2507677682672524762');" onmouseout="out('-2507677682672524762');" style="">  56 import org.broadleafcommerce.common.file.domain.FileWorkArea;                                            </span>
<span class="3660177375850747944" onmouseenter="enter('3660177375850747944');" onmouseout="out('3660177375850747944');" style="">  57 import org.broadleafcommerce.common.file.service.BroadleafFileService;                                   </span>
<span class="-6194024147123816671" onmouseenter="enter('-6194024147123816671');" onmouseout="out('-6194024147123816671');" style="">  58 import org.broadleafcommerce.common.file.service.GloballySharedInputStream;                              </span>
<span class="8070124246740049341" onmouseenter="enter('8070124246740049341');" onmouseout="out('8070124246740049341');" style="">  59 import org.broadleafcommerce.common.io.ConcurrentFileOutputStream;                                       </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  60 import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                     </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  61 import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                </span>
<span class="-32928361580396825" onmouseenter="enter('-32928361580396825');" onmouseout="out('-32928361580396825');" style="">  62 import org.broadleafcommerce.openadmin.server.service.artifact.ArtifactService;                          </span>
<span class="-7077569502978710918" onmouseenter="enter('-7077569502978710918');" onmouseout="out('-7077569502978710918');" style="">  63 import org.broadleafcommerce.openadmin.server.service.artifact.image.Operation;                          </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  64 import org.springframework.beans.factory.annotation.Autowired;                                           </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="">  65 import org.springframework.beans.factory.annotation.Value;                                               </span>
<span class="-1779577819582542853" onmouseenter="enter('-1779577819582542853');" onmouseout="out('-1779577819582542853');" style="">  66 import org.springframework.boot.autoconfigure.web.servlet.MultipartProperties;                           </span>
<span class="2802840430073505079" onmouseenter="enter('2802840430073505079');" onmouseout="out('2802840430073505079');" style="">  67 import org.springframework.core.env.Environment;                                                         </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  68 import org.springframework.stereotype.Service;                                                           </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  69 import org.springframework.transaction.annotation.Transactional;                                         </span>
<span class="4828820138133011218" onmouseenter="enter('4828820138133011218');" onmouseout="out('4828820138133011218');" style="">  70 import org.springframework.web.multipart.MultipartFile;                                                  </span>
<span  style="">  71                                                                                                          </span>
<span  style="">  72                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  73 /**                                                                                                      </span>
<span class="5819561638806578074" onmouseenter="enter('5819561638806578074');" onmouseout="out('5819561638806578074');" style="">  74  * @author Jeff Fischer, Brian Polster                                                                   </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  75  */                                                                                                      </span>
<span class="8555986608199362624" onmouseenter="enter('8555986608199362624');" onmouseout="out('8555986608199362624');" style="">  76 @Service(&quot;blStaticAssetStorageService&quot;)                                                                  </span>
<span class="-5440937737927857026" onmouseenter="enter('-5440937737927857026');" onmouseout="out('-5440937737927857026');" style="">  77 public class StaticAssetStorageServiceImpl implements StaticAssetStorageService {                        </span>
<span class="2858988269359695714" onmouseenter="enter('2858988269359695714');" onmouseout="out('2858988269359695714');" style="">  78     private static final Log LOG = LogFactory.getLog(StaticAssetStorageServiceImpl.class);               </span>
<span  style="">  79                                                                                                          </span>
<span class="3730583078767808053" onmouseenter="enter('3730583078767808053');" onmouseout="out('3730583078767808053');" style="">  80     protected static final String DEFAULT_ADMIN_IMAGE_EXTENSIONS = &quot;bmp,jpg,jpeg,png,img,tiff,gif&quot;;      </span>
<span  style="">  81                                                                                                          </span>
<span class="-2041789809652164219" onmouseenter="enter('-2041789809652164219');" onmouseout="out('-2041789809652164219');" style="">  82     public static final long DEFAULT_ASSET_UPLOAD_SIZE = 1024 * 1024 * 10;                               </span>
<span  style="">  83                                                                                                          </span>
<span class="-6481771976097152300" onmouseenter="enter('-6481771976097152300');" onmouseout="out('-6481771976097152300');" style="">  84     // 8kb default for the buffer for moving files around                                                </span>
<span class="-6481771976097152300" onmouseenter="enter('-6481771976097152300');" onmouseout="out('-6481771976097152300');" style="">  85     // 8kb default for the buffer for moving files around                                                </span>
<span class="8173561874988853201" onmouseenter="enter('8173561874988853201');" onmouseout="out('8173561874988853201');" style="">  86     protected static final int DEFAULT_BUFFER_SIZE = 8096;                                               </span>
<span  style="">  87                                                                                                          </span>
<span class="5800015562641335858" onmouseenter="enter('5800015562641335858');" onmouseout="out('5800015562641335858');" style="">  88     protected String cacheDirectory;                                                                     </span>
<span  style="">  89                                                                                                          </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="">  90     @Autowired                                                                                           </span>
<span class="-7669104425724809181" onmouseenter="enter('-7669104425724809181');" onmouseout="out('-7669104425724809181');" style="">  91     protected Environment env;                                                                           </span>
<span  style="">  92                                                                                                          </span>
<span class="6195905131849662055" onmouseenter="enter('6195905131849662055');" onmouseout="out('6195905131849662055');" style="">  93     @Resource(name=&quot;blStaticAssetService&quot;)                                                               </span>
<span class="5386460834235010869" onmouseenter="enter('5386460834235010869');" onmouseout="out('5386460834235010869');" style="">  94     protected StaticAssetService staticAssetService;                                                     </span>
<span  style="">  95                                                                                                          </span>
<span class="1752371454992115000" onmouseenter="enter('1752371454992115000');" onmouseout="out('1752371454992115000');" style="">  96     @Resource(name = &quot;blFileService&quot;)                                                                    </span>
<span class="-5836282893854406064" onmouseenter="enter('-5836282893854406064');" onmouseout="out('-5836282893854406064');" style="">  97     protected BroadleafFileService broadleafFileService;                                                 </span>
<span  style="">  98                                                                                                          </span>
<span class="7856532409026737335" onmouseenter="enter('7856532409026737335');" onmouseout="out('7856532409026737335');" style="">  99     @Resource(name=&quot;blArtifactService&quot;)                                                                  </span>
<span class="-5802479126948705000" onmouseenter="enter('-5802479126948705000');" onmouseout="out('-5802479126948705000');" style=""> 100     protected ArtifactService artifactService;                                                           </span>
<span  style=""> 101                                                                                                          </span>
<span class="-5691607332624048120" onmouseenter="enter('-5691607332624048120');" onmouseout="out('-5691607332624048120');" style=""> 102     @Resource(name=&quot;blStaticAssetStorageDao&quot;)                                                            </span>
<span class="3341461985908719037" onmouseenter="enter('3341461985908719037');" onmouseout="out('3341461985908719037');" style=""> 103     protected StaticAssetStorageDao staticAssetStorageDao;                                               </span>
<span  style=""> 104                                                                                                          </span>
<span class="-8585007248377894204" onmouseenter="enter('-8585007248377894204');" onmouseout="out('-8585007248377894204');" style=""> 105     @Resource(name=&quot;blNamedOperationManager&quot;)                                                            </span>
<span class="308482009813309658" onmouseenter="enter('308482009813309658');" onmouseout="out('308482009813309658');" style=""> 106     protected NamedOperationManager namedOperationManager;                                               </span>
<span  style=""> 107                                                                                                          </span>
<span class="5483516952021908632" onmouseenter="enter('5483516952021908632');" onmouseout="out('5483516952021908632');" style=""> 108     @Resource(name = &quot;blStaticAssetServiceExtensionManager&quot;)                                             </span>
<span class="51840422594786922" onmouseenter="enter('51840422594786922');" onmouseout="out('51840422594786922');" style=""> 109     protected StaticAssetServiceExtensionManager extensionManager;                                       </span>
<span  style=""> 110                                                                                                          </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 111     @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                  </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 112     protected StreamingTransactionCapableUtil transUtil;                                                 </span>
<span  style=""> 113                                                                                                          </span>
<span class="-3151523973433667335" onmouseenter="enter('-3151523973433667335');" onmouseout="out('-3151523973433667335');" style=""> 114     @Value(&quot;${image.artifact.recompress.formats:png}&quot;)                                                   </span>
<span class="4635220678002391487" onmouseenter="enter('4635220678002391487');" onmouseout="out('4635220678002391487');" style=""> 115     protected String recompressFormats = &quot;png&quot;;                                                          </span>
<span  style=""> 116                                                                                                          </span>
<span class="2602789178515286342" onmouseenter="enter('2602789178515286342');" onmouseout="out('2602789178515286342');" style=""> 117     @Autowired(required = false)                                                                         </span>
<span class="8981564986536911591" onmouseenter="enter('8981564986536911591');" onmouseout="out('8981564986536911591');" style=""> 118     protected MultipartProperties defaultMultipartSettings;                                              </span>
<span  style=""> 119                                                                                                          </span>
<span class="-7168779142218193311" onmouseenter="enter('-7168779142218193311');" onmouseout="out('-7168779142218193311');" style=""> 120     @Resource(name = &quot;blConcurrentFileOutputStream&quot;)                                                     </span>
<span class="-2331920133844743339" onmouseenter="enter('-2331920133844743339');" onmouseout="out('-2331920133844743339');" style=""> 121     protected ConcurrentFileOutputStream concurrentFileOutputStream;                                     </span>
<span  style=""> 122                                                                                                          </span>
<span class="-6120158187110043675" onmouseenter="enter('-6120158187110043675');" onmouseout="out('-6120158187110043675');" style=""> 123     protected StaticAsset findStaticAsset(String fullUrl) {                                              </span>
<span class="-4171210034184470086" onmouseenter="enter('-4171210034184470086');" onmouseout="out('-4171210034184470086');" style=""> 124         StaticAsset staticAsset = staticAssetService.findStaticAssetByFullUrl(fullUrl);                  </span>
<span  style=""> 125                                                                                                          </span>
<span class="-2128240479658154685" onmouseenter="enter('-2128240479658154685');" onmouseout="out('-2128240479658154685');" style=""> 126         return staticAsset;                                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 127     }                                                                                                    </span>
<span  style=""> 128                                                                                                          </span>
<span class="1529961503462031347" onmouseenter="enter('1529961503462031347');" onmouseout="out('1529961503462031347');" style=""> 129     protected boolean shouldUseSharedFile(InputStream is) {                                              </span>
<span class="7200698625412718023" onmouseenter="enter('7200698625412718023');" onmouseout="out('7200698625412718023');" style=""> 130         return (is != null &amp;&amp; is instanceof GloballySharedInputStream);                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 131     }                                                                                                    </span>
<span  style=""> 132                                                                                                          </span>
<span class="1502967799885308477" onmouseenter="enter('1502967799885308477');" onmouseout="out('1502967799885308477');" style=""> 133     protected File getFileFromLocalRepository(String cachedFileName) {                                   </span>
<span class="-5673162797879974066" onmouseenter="enter('-5673162797879974066');" onmouseout="out('-5673162797879974066');" style=""><abbr title=" 134         // Look for a shared file (this represents a file that was based on a file originally in the classpath."> 134         // Look for a shared file (this represents a file that was based on a file originally in the clasðŸ”µ</abbr></span>
<span class="-93446380402546673" onmouseenter="enter('-93446380402546673');" onmouseout="out('-93446380402546673');" style=""> 135         File cacheFile = null;                                                                           </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 136         if (extensionManager != null) {                                                                  </span>
<span class="-8112713965554756916" onmouseenter="enter('-8112713965554756916');" onmouseout="out('-8112713965554756916');" style=""> 137             ExtensionResultHolder holder = new ExtensionResultHolder();                                  </span>
<span class="-435722502969466554" onmouseenter="enter('-435722502969466554');" onmouseout="out('-435722502969466554');" style=""><abbr title=" 138             ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holder);"> 138             ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holðŸ”µ</abbr></span>
<span class="-2043051207329155259" onmouseenter="enter('-2043051207329155259');" onmouseout="out('-2043051207329155259');" style=""> 139             if (ExtensionResultStatusType.HANDLED.equals(result)) {                                      </span>
<span class="7653982040624486223" onmouseenter="enter('7653982040624486223');" onmouseout="out('7653982040624486223');" style=""> 140                 cacheFile = (File) holder.getResult();                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 141             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 142         }                                                                                                </span>
<span class="-8813269293199686205" onmouseenter="enter('-8813269293199686205');" onmouseout="out('-8813269293199686205');" style=""> 143         if (cacheFile == null) {                                                                         </span>
<span class="-8910009845238484526" onmouseenter="enter('-8910009845238484526');" onmouseout="out('-8910009845238484526');" style=""> 144             cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 145         }                                                                                                </span>
<span class="-2028153032285377680" onmouseenter="enter('-2028153032285377680');" onmouseout="out('-2028153032285377680');" style=""> 146         if (cacheFile.exists()) {                                                                        </span>
<span class="8210317951176929256" onmouseenter="enter('8210317951176929256');" onmouseout="out('8210317951176929256');" style=""> 147             return cacheFile;                                                                            </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 148         } else {                                                                                         </span>
<span class="5496227938366649270" onmouseenter="enter('5496227938366649270');" onmouseout="out('5496227938366649270');" style=""> 149             return broadleafFileService.getLocalResource(cachedFileName);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 150         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 151     }                                                                                                    </span>
<span  style=""> 152                                                                                                          </span>
<span class="-9138520702166900061" onmouseenter="enter('-9138520702166900061');" onmouseout="out('-9138520702166900061');" style=""> 153     protected File lookupAssetAndCreateLocalFile(StaticAsset staticAsset, File baseLocalFile)            </span>
<span class="452573679482946095" onmouseenter="enter('452573679482946095');" onmouseout="out('452573679482946095');" style=""> 154             throws IOException, SQLException {                                                           </span>
<span class="-7742266551317191943" onmouseenter="enter('-7742266551317191943');" onmouseout="out('-7742266551317191943');" style=""> 155         if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {                               </span>
<span class="-4354847567179586644" onmouseenter="enter('-4354847567179586644');" onmouseout="out('-4354847567179586644');" style=""> 156             File returnFile = broadleafFileService.getResource(staticAsset.getFullUrl());                </span>
<span class="8059946160260640624" onmouseenter="enter('8059946160260640624');" onmouseout="out('8059946160260640624');" style=""> 157             if (!returnFile.getAbsolutePath().equals(baseLocalFile.getAbsolutePath())) {                 </span>
<span class="-2191133777668840278" onmouseenter="enter('-2191133777668840278');" onmouseout="out('-2191133777668840278');" style=""> 158                 createLocalFileFromInputStream(new FileInputStream(returnFile), baseLocalFile);          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159             }                                                                                            </span>
<span class="4024427022501975435" onmouseenter="enter('4024427022501975435');" onmouseout="out('4024427022501975435');" style=""> 160             return broadleafFileService.getResource(staticAsset.getFullUrl());                           </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 161         } else {                                                                                         </span>
<span class="-4264495412887169123" onmouseenter="enter('-4264495412887169123');" onmouseout="out('-4264495412887169123');" style=""> 162             StaticAssetStorage storage = readStaticAssetStorageByStaticAssetId(staticAsset.getId());     </span>
<span class="4400092173030817905" onmouseenter="enter('4400092173030817905');" onmouseout="out('4400092173030817905');" style=""> 163             if (storage != null) {                                                                       </span>
<span class="-3012070176633314991" onmouseenter="enter('-3012070176633314991');" onmouseout="out('-3012070176633314991');" style=""> 164                 InputStream is = storage.getFileData().getBinaryStream();                                </span>
<span class="538128314668626861" onmouseenter="enter('538128314668626861');" onmouseout="out('538128314668626861');" style=""> 165                 createLocalFileFromInputStream(is, baseLocalFile);                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 166             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 167         }                                                                                                </span>
<span class="8385511608933773357" onmouseenter="enter('8385511608933773357');" onmouseout="out('8385511608933773357');" style=""> 168         return baseLocalFile;                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169     }                                                                                                    </span>
<span  style=""> 170                                                                                                          </span>
<span class="676971272687988980" onmouseenter="enter('676971272687988980');" onmouseout="out('676971272687988980');" style=""><abbr title=" 171     protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOException {"> 171     protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throðŸ”µ</abbr></span>
<span class="5330873671579735739" onmouseenter="enter('5330873671579735739');" onmouseout="out('5330873671579735739');" style=""> 172         InputStream is = broadleafFileService.getClasspathResource(staticAsset.getFullUrl());            </span>
<span class="538128314668626861" onmouseenter="enter('538128314668626861');" onmouseout="out('538128314668626861');" style=""> 173         createLocalFileFromInputStream(is, baseLocalFile);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 174     }                                                                                                    </span>
<span  style=""> 175                                                                                                          </span>
<span class="-4952056920597128037" onmouseenter="enter('-4952056920597128037');" onmouseout="out('-4952056920597128037');" style=""><abbr title=" 176     protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException {"> 176     protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException ðŸ”µ</abbr></span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 177         try {                                                                                            </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 178             if (!baseLocalFile.getParentFile().exists()) {                                               </span>
<span class="5777296043812209192" onmouseenter="enter('5777296043812209192');" onmouseout="out('5777296043812209192');" style=""> 179                 boolean directoriesCreated = false;                                                      </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 180                 if (!baseLocalFile.getParentFile().exists()) {                                           </span>
<span class="-1950703901965003992" onmouseenter="enter('-1950703901965003992');" onmouseout="out('-1950703901965003992');" style=""> 181                     directoriesCreated = baseLocalFile.getParentFile().mkdirs();                         </span>
<span class="-5835726015694115162" onmouseenter="enter('-5835726015694115162');" onmouseout="out('-5835726015694115162');" style=""> 182                     if (!directoriesCreated) {                                                           </span>
<span class="-440335952408349395" onmouseenter="enter('-440335952408349395');" onmouseout="out('-440335952408349395');" style=""><abbr title=" 183                         // There is a chance that another VM created the directories.   If not, we may not have"> 183                         // There is a chance that another VM created the directories.   If not, we may noðŸ”µ</abbr></span>
<span class="5346057857994506172" onmouseenter="enter('5346057857994506172');" onmouseout="out('5346057857994506172');" style=""> 184                         // proper permissions and this is an error we need to report.                    </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 185                         if (!baseLocalFile.getParentFile().exists()) {                                   </span>
<span class="-3100057651899633278" onmouseenter="enter('-3100057651899633278');" onmouseout="out('-3100057651899633278');" style=""> 186                             throw new RuntimeException(&quot;Unable to create middle directories for file: &quot; +</span>
<span class="-3627057965366514409" onmouseenter="enter('-3627057965366514409');" onmouseout="out('-3627057965366514409');" style=""> 187                                     baseLocalFile.getAbsolutePath());                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 188                         }                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 189                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 191             }                                                                                            </span>
<span  style=""> 192                                                                                                          </span>
<span class="1058516638336488341" onmouseenter="enter('1058516638336488341');" onmouseout="out('1058516638336488341');" style=""> 193             concurrentFileOutputStream.write(is, baseLocalFile);                                         </span>
<span  style=""> 194                                                                                                          </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 195         } finally {                                                                                      </span>
<span class="-1036224550261950069" onmouseenter="enter('-1036224550261950069');" onmouseout="out('-1036224550261950069');" style=""> 196             IOUtils.closeQuietly(is);                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 197         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198     }                                                                                                    </span>
<span  style=""> 199                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 200     @Override                                                                                            </span>
<span class="-5764870268385651216" onmouseenter="enter('-5764870268385651216');" onmouseout="out('-5764870268385651216');" style=""><abbr title=" 201     public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws Exception {"> 201     public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throwsðŸ”µ</abbr></span>
<span class="491052228983464108" onmouseenter="enter('491052228983464108');" onmouseout="out('491052228983464108');" style=""> 202         StaticAsset staticAsset = findStaticAsset(fullUrl);                                              </span>
<span class="-3786942395132975147" onmouseenter="enter('-3786942395132975147');" onmouseout="out('-3786942395132975147');" style=""> 203         if (staticAsset == null) {                                                                       </span>
<span class="2473312604294611036" onmouseenter="enter('2473312604294611036');" onmouseout="out('2473312604294611036');" style=""> 204             throw new AssetNotFoundException((&quot;Unable to find an asset for the url (&quot; + fullUrl) + &quot;)&quot;); </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 205         }                                                                                                </span>
<span class="-5398322132344119647" onmouseenter="enter('-5398322132344119647');" onmouseout="out('-5398322132344119647');" style=""> 206         String mimeType = staticAsset.getMimeType();                                                     </span>
<span class="-3975923364870692815" onmouseenter="enter('-3975923364870692815');" onmouseout="out('-3975923364870692815');" style=""> 207         // extract the values for any named parameters                                                   </span>
<span class="1331021329476510285" onmouseenter="enter('1331021329476510285');" onmouseout="out('1331021329476510285');" style=""> 208         boolean shouldRecompress = shouldRecompress(mimeType);                                           </span>
<span class="5491208348485302910" onmouseenter="enter('5491208348485302910');" onmouseout="out('5491208348485302910');" style=""><abbr title=" 209         Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMap);"> 209         Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMaðŸ”µ</abbr></span>
<span class="1628034097147692048" onmouseenter="enter('1628034097147692048');" onmouseout="out('1628034097147692048');" style=""> 210         if (shouldRecompress &amp;&amp; MapUtils.isEmpty(convertedParameters)) {                                 </span>
<span class="5428576316579556577" onmouseenter="enter('5428576316579556577');" onmouseout="out('5428576316579556577');" style=""> 211             convertedParameters.put(&quot;recompress&quot;, &quot;true&quot;);                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 212         }                                                                                                </span>
<span class="-6987211962421403682" onmouseenter="enter('-6987211962421403682');" onmouseout="out('-6987211962421403682');" style=""> 213         String cachedFileName = constructCacheFileName(staticAsset, convertedParameters);                </span>
<span class="-4010270241296523972" onmouseenter="enter('-4010270241296523972');" onmouseout="out('-4010270241296523972');" style=""> 214         if (shouldRecompress) {                                                                          </span>
<span class="3725275006012768392" onmouseenter="enter('3725275006012768392');" onmouseout="out('3725275006012768392');" style=""> 215             convertedParameters.remove(&quot;recompress&quot;);                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 216         }                                                                                                </span>
<span class="-5673162797879974066" onmouseenter="enter('-5673162797879974066');" onmouseout="out('-5673162797879974066');" style=""><abbr title=" 217         // Look for a shared file (this represents a file that was based on a file originally in the classpath."> 217         // Look for a shared file (this represents a file that was based on a file originally in the clasðŸ”µ</abbr></span>
<span class="-744748978496739834" onmouseenter="enter('-744748978496739834');" onmouseout="out('-744748978496739834');" style=""> 218         File cacheFile = getFileFromLocalRepository(cachedFileName);                                     </span>
<span class="-2028153032285377680" onmouseenter="enter('-2028153032285377680');" onmouseout="out('-2028153032285377680');" style=""> 219         if (cacheFile.exists()) {                                                                        </span>
<span class="-5770017993670818757" onmouseenter="enter('-5770017993670818757');" onmouseout="out('-5770017993670818757');" style=""> 220             return buildModel(cacheFile.getAbsolutePath(), mimeType);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 221         }                                                                                                </span>
<span class="7943467756367013608" onmouseenter="enter('7943467756367013608');" onmouseout="out('7943467756367013608');" style=""> 222         // Obtain the base file (that we may need to convert based on the parameters                     </span>
<span class="-7282961418041278395" onmouseenter="enter('-7282961418041278395');" onmouseout="out('-7282961418041278395');" style=""> 223         String baseCachedFileName = constructCacheFileName(staticAsset, null);                           </span>
<span class="2819718340222738473" onmouseenter="enter('2819718340222738473');" onmouseout="out('2819718340222738473');" style=""> 224         File baseLocalFile = getFileFromLocalRepository(baseCachedFileName);                             </span>
<span class="895844451701734054" onmouseenter="enter('895844451701734054');" onmouseout="out('895844451701734054');" style=""> 225         if (!baseLocalFile.exists()) {                                                                   </span>
<span class="-4152796465711126856" onmouseenter="enter('-4152796465711126856');" onmouseout="out('-4152796465711126856');" style=""> 226             if (broadleafFileService.checkForResourceOnClassPath(staticAsset.getFullUrl())) {            </span>
<span class="-8910009845238484526" onmouseenter="enter('-8910009845238484526');" onmouseout="out('-8910009845238484526');" style=""> 227                 cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);                 </span>
<span class="-3411813136412986040" onmouseenter="enter('-3411813136412986040');" onmouseout="out('-3411813136412986040');" style=""> 228                 baseLocalFile = broadleafFileService.getSharedLocalResource(baseCachedFileName);         </span>
<span class="-4235219464337080287" onmouseenter="enter('-4235219464337080287');" onmouseout="out('-4235219464337080287');" style=""> 229                 createLocalFileFromClassPathResource(staticAsset, baseLocalFile);                        </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 230             } else {                                                                                     </span>
<span class="-4898184433395929673" onmouseenter="enter('-4898184433395929673');" onmouseout="out('-4898184433395929673');" style=""> 231                 baseLocalFile = lookupAssetAndCreateLocalFile(staticAsset, baseLocalFile);               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 232             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 233         }                                                                                                </span>
<span class="8333906941197908588" onmouseenter="enter('8333906941197908588');" onmouseout="out('8333906941197908588');" style=""> 234         if ((!shouldRecompress) &amp;&amp; convertedParameters.isEmpty()) {                                      </span>
<span class="1541740886220527868" onmouseenter="enter('1541740886220527868');" onmouseout="out('1541740886220527868');" style=""> 235             return buildModel(baseLocalFile.getAbsolutePath(), mimeType);                                </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 236         } else {                                                                                         </span>
<span class="2626429018838635667" onmouseenter="enter('2626429018838635667');" onmouseout="out('2626429018838635667');" style=""> 237             FileInputStream assetStream = new FileInputStream(baseLocalFile);                            </span>
<span class="1559981230759799611" onmouseenter="enter('1559981230759799611');" onmouseout="out('1559981230759799611');" style=""> 238             BufferedInputStream original = new BufferedInputStream(assetStream);                         </span>
<span class="5335072745234046164" onmouseenter="enter('5335072745234046164');" onmouseout="out('5335072745234046164');" style=""> 239             original.mark(0);                                                                            </span>
<span class="3271606902025597443" onmouseenter="enter('3271606902025597443');" onmouseout="out('3271606902025597443');" style=""><abbr title=" 240             Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.getMimeType());"> 240             Operation[] operations = artifactService.buildOperations(convertedParameters, original, statiðŸ”µ</abbr></span>
<span class="-4049222348408471473" onmouseenter="enter('-4049222348408471473');" onmouseout="out('-4049222348408471473');" style=""><abbr title=" 241             InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeType());"> 241             InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeTypeðŸ”µ</abbr></span>
<span class="-5852373631387772582" onmouseenter="enter('-5852373631387772582');" onmouseout="out('-5852373631387772582');" style=""> 242             createLocalFileFromInputStream(converted, cacheFile);                                        </span>
<span class="8481176371776030575" onmouseenter="enter('8481176371776030575');" onmouseout="out('8481176371776030575');" style=""> 243             if (&quot;image/gif&quot;.equals(mimeType)) {                                                          </span>
<span class="6692235241863720447" onmouseenter="enter('6692235241863720447');" onmouseout="out('6692235241863720447');" style=""> 244                 mimeType = &quot;image/png&quot;;                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 245             }                                                                                            </span>
<span class="-5770017993670818757" onmouseenter="enter('-5770017993670818757');" onmouseout="out('-5770017993670818757');" style=""> 246             return buildModel(cacheFile.getAbsolutePath(), mimeType);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 247         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 248     }                                                                                                    </span>
<span  style=""> 249                                                                                                          </span>
<span class="1436332013455477710" onmouseenter="enter('1436332013455477710');" onmouseout="out('1436332013455477710');" style=""> 250     protected boolean shouldRecompress(String mimeType) {                                                </span>
<span class="-2947492696471387039" onmouseenter="enter('-2947492696471387039');" onmouseout="out('-2947492696471387039');" style=""> 251         String[] formats = null;                                                                         </span>
<span class="3146177423232232799" onmouseenter="enter('3146177423232232799');" onmouseout="out('3146177423232232799');" style=""> 252         if (!StringUtils.isEmpty(recompressFormats)) {                                                   </span>
<span class="-5929026035202084105" onmouseenter="enter('-5929026035202084105');" onmouseout="out('-5929026035202084105');" style=""> 253             formats = recompressFormats.split(&quot;,&quot;);                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 254         }                                                                                                </span>
<span class="7342740188292578775" onmouseenter="enter('7342740188292578775');" onmouseout="out('7342740188292578775');" style=""> 255         boolean response = false;                                                                        </span>
<span class="-630918830715510960" onmouseenter="enter('-630918830715510960');" onmouseout="out('-630918830715510960');" style=""> 256         if (!ArrayUtils.isEmpty(formats)) {                                                              </span>
<span class="2272716586254590500" onmouseenter="enter('2272716586254590500');" onmouseout="out('2272716586254590500');" style=""> 257             for (String format : formats) {                                                              </span>
<span class="-250489820996933262" onmouseenter="enter('-250489820996933262');" onmouseout="out('-250489820996933262');" style=""> 258                 if (mimeType.toLowerCase().contains(format.toLowerCase())) {                             </span>
<span class="-7568734358544125355" onmouseenter="enter('-7568734358544125355');" onmouseout="out('-7568734358544125355');" style=""> 259                     response = true;                                                                     </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style=""> 260                     break;                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 262             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 263         }                                                                                                </span>
<span class="-1838489616061912436" onmouseenter="enter('-1838489616061912436');" onmouseout="out('-1838489616061912436');" style=""> 264         return response;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 265     }                                                                                                    </span>
<span  style=""> 266                                                                                                          </span>
<span class="-5129110647668669753" onmouseenter="enter('-5129110647668669753');" onmouseout="out('-5129110647668669753');" style=""> 267     protected Map&lt;String, String&gt; buildModel(String returnFilePath, String mimeType) {                   </span>
<span class="-5436835504658380993" onmouseenter="enter('-5436835504658380993');" onmouseout="out('-5436835504658380993');" style=""> 268         Map&lt;String, String&gt; model = new HashMap&lt;String, String&gt;(2);                                      </span>
<span class="-7931157778314956360" onmouseenter="enter('-7931157778314956360');" onmouseout="out('-7931157778314956360');" style=""> 269         model.put(&quot;cacheFilePath&quot;, returnFilePath);                                                      </span>
<span class="-121481178440989733" onmouseenter="enter('-121481178440989733');" onmouseout="out('-121481178440989733');" style=""> 270         model.put(&quot;mimeType&quot;, mimeType);                                                                 </span>
<span  style=""> 271                                                                                                          </span>
<span class="1327412617440986435" onmouseenter="enter('1327412617440986435');" onmouseout="out('1327412617440986435');" style=""> 272         return model;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 273     }                                                                                                    </span>
<span  style=""> 274                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 275     @Override                                                                                            </span>
<span class="-2260190509208115003" onmouseenter="enter('-2260190509208115003');" onmouseout="out('-2260190509208115003');" style=""> 276     public StaticAssetStorage findStaticAssetStorageById(final Long id) {                                </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 277         final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                  </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 278         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 279             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 280             public void execute() {                                                                      </span>
<span class="-2207751287529111136" onmouseenter="enter('-2207751287529111136');" onmouseout="out('-2207751287529111136');" style=""> 281                 storage[0] = staticAssetStorageDao.readStaticAssetStorageById(id);                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 282             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 283         }, RuntimeException.class);                                                                      </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 284         return storage[0];                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 285     }                                                                                                    </span>
<span  style=""> 286                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 287     @Override                                                                                            </span>
<span class="-2864285839814759705" onmouseenter="enter('-2864285839814759705');" onmouseout="out('-2864285839814759705');" style=""> 288     public StaticAssetStorage create() {                                                                 </span>
<span class="-1873403527653357243" onmouseenter="enter('-1873403527653357243');" onmouseout="out('-1873403527653357243');" style=""> 289         return staticAssetStorageDao.create();                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 290     }                                                                                                    </span>
<span  style=""> 291                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 292     @Override                                                                                            </span>
<span class="7662571466653582755" onmouseenter="enter('7662571466653582755');" onmouseout="out('7662571466653582755');" style=""> 293     public StaticAssetStorage readStaticAssetStorageByStaticAssetId(final Long id) {                     </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 294         final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                  </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 295         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 296             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 297             public void execute() {                                                                      </span>
<span class="8795705063184424946" onmouseenter="enter('8795705063184424946');" onmouseout="out('8795705063184424946');" style=""> 298                 storage[0] = staticAssetStorageDao.readStaticAssetStorageByStaticAssetId(id);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 299             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 300         }, RuntimeException.class);                                                                      </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 301         return storage[0];                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 302     }                                                                                                    </span>
<span  style=""> 303                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 304     @Override                                                                                            </span>
<span class="6485967695518229819" onmouseenter="enter('6485967695518229819');" onmouseout="out('6485967695518229819');" style=""> 305     public StaticAssetStorage save(final StaticAssetStorage assetStorage) {                              </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 306         final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                  </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 307         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 308             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 309             public void execute() {                                                                      </span>
<span class="-6036718856004453538" onmouseenter="enter('-6036718856004453538');" onmouseout="out('-6036718856004453538');" style=""> 310                 storage[0] = staticAssetStorageDao.save(assetStorage);                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 311             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 312         }, RuntimeException.class);                                                                      </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 313         return storage[0];                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 314     }                                                                                                    </span>
<span  style=""> 315                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 316     @Override                                                                                            </span>
<span class="7860976460954721267" onmouseenter="enter('7860976460954721267');" onmouseout="out('7860976460954721267');" style=""> 317     public void delete(final StaticAssetStorage assetStorage) {                                          </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 318         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 319             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 320             public void execute() {                                                                      </span>
<span class="5167138969991588867" onmouseenter="enter('5167138969991588867');" onmouseout="out('5167138969991588867');" style=""> 321                 staticAssetStorageDao.delete(assetStorage);                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 322             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 323         }, RuntimeException.class);                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 324     }                                                                                                    </span>
<span  style=""> 325                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 326     @Override                                                                                            </span>
<span class="-1910899245286681437" onmouseenter="enter('-1910899245286681437');" onmouseout="out('-1910899245286681437');" style=""> 327     public Blob createBlob(final MultipartFile uploadedFile) throws IOException {                        </span>
<span class="848437443390195780" onmouseenter="enter('848437443390195780');" onmouseout="out('848437443390195780');" style=""> 328         final Blob[] blob = new Blob[1];                                                                 </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 329         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 330             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 331             public void execute() {                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 332                 try {                                                                                    </span>
<span class="3702070050705863788" onmouseenter="enter('3702070050705863788');" onmouseout="out('3702070050705863788');" style=""> 333                     blob[0] = staticAssetStorageDao.createBlob(uploadedFile);                            </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 334                 } catch (IOException e) {                                                                </span>
<span class="5116711708032073694" onmouseenter="enter('5116711708032073694');" onmouseout="out('5116711708032073694');" style=""> 335                     LOG.error(&quot;Unable to create blob from MultipartFile.&quot;, e);                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 336                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 337             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 338         }, RuntimeException.class);                                                                      </span>
<span class="-3204915544472573462" onmouseenter="enter('-3204915544472573462');" onmouseout="out('-3204915544472573462');" style=""> 339         return blob[0];                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 340     }                                                                                                    </span>
<span  style=""> 341                                                                                                          </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 342     @Override                                                                                            </span>
<span class="4382666547830473388" onmouseenter="enter('4382666547830473388');" onmouseout="out('4382666547830473388');" style=""><abbr title=" 343     public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOException {"> 343     public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOExcepðŸ”µ</abbr></span>
<span class="848437443390195780" onmouseenter="enter('848437443390195780');" onmouseout="out('848437443390195780');" style=""> 344         final Blob[] blob = new Blob[1];                                                                 </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 345         transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {           </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 346             @Override                                                                                    </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 347             public void execute() {                                                                      </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 348                 try {                                                                                    </span>
<span class="-8405931859176759523" onmouseenter="enter('-8405931859176759523');" onmouseout="out('-8405931859176759523');" style=""> 349                     blob[0] = staticAssetStorageDao.createBlob(uploadedFileInputStream, fileSize);       </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 350                 } catch (IOException e) {                                                                </span>
<span class="10365894759289852" onmouseenter="enter('10365894759289852');" onmouseout="out('10365894759289852');" style=""> 351                     LOG.error(&quot;Unable to create blob from InputStream.&quot;, e);                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 352                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 353             }                                                                                            </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 354         }, RuntimeException.class);                                                                      </span>
<span class="-3204915544472573462" onmouseenter="enter('-3204915544472573462');" onmouseout="out('-3204915544472573462');" style=""> 355         return blob[0];                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 356     }                                                                                                    </span>
<span  style=""> 357                                                                                                          </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 358     /**                                                                                                  </span>
<span class="1204867681485950258" onmouseenter="enter('1204867681485950258');" onmouseout="out('1204867681485950258');" style=""> 359      * Builds a file system path for the passed in static asset and paramaterMap.                        </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 360      *                                                                                                   </span>
<span class="-8533974154884571802" onmouseenter="enter('-8533974154884571802');" onmouseout="out('-8533974154884571802');" style=""> 361      * @param staticAsset                                                                                </span>
<span class="1550808242639330275" onmouseenter="enter('1550808242639330275');" onmouseout="out('1550808242639330275');" style=""> 362      * @param parameterMap                                                                               </span>
<span class="966966680655938311" onmouseenter="enter('966966680655938311');" onmouseout="out('966966680655938311');" style=""> 363      * @param useSharedFile                                                                              </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 364      * @return                                                                                           </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 365      */                                                                                                  </span>
<span class="9052993107782234324" onmouseenter="enter('9052993107782234324');" onmouseout="out('9052993107782234324');" style=""> 366     protected String constructCacheFileName(StaticAsset staticAsset, Map&lt;String, String&gt; parameterMap) { </span>
<span class="6966748151173677546" onmouseenter="enter('6966748151173677546');" onmouseout="out('6966748151173677546');" style=""> 367         String fileName = staticAsset.getFullUrl();                                                      </span>
<span  style=""> 368                                                                                                          </span>
<span class="-4507417291042206746" onmouseenter="enter('-4507417291042206746');" onmouseout="out('-4507417291042206746');" style=""> 369         StringBuilder sb = new StringBuilder(200);                                                       </span>
<span class="-483528478759561910" onmouseenter="enter('-483528478759561910');" onmouseout="out('-483528478759561910');" style=""> 370         sb.append(fileName.substring(0, fileName.lastIndexOf(&#x27;.&#x27;)));                                     </span>
<span class="4093974766537940594" onmouseenter="enter('4093974766537940594');" onmouseout="out('4093974766537940594');" style=""> 371         sb.append(&quot;---&quot;);                                                                                </span>
<span  style=""> 372                                                                                                          </span>
<span class="3988790927371777098" onmouseenter="enter('3988790927371777098');" onmouseout="out('3988790927371777098');" style=""> 373         StringBuilder sb2 = new StringBuilder(200);                                                      </span>
<span class="1220298265095205393" onmouseenter="enter('1220298265095205393');" onmouseout="out('1220298265095205393');" style=""> 374         SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd-HH-mm-ss&quot;);                           </span>
<span class="8844493969073287544" onmouseenter="enter('8844493969073287544');" onmouseout="out('8844493969073287544');" style=""> 375         if (staticAsset instanceof Auditable) {                                                          </span>
<span class="-4932550937064679086" onmouseenter="enter('-4932550937064679086');" onmouseout="out('-4932550937064679086');" style=""> 376             Auditable auditableStaticAsset = (Auditable) staticAsset;                                    </span>
<span class="2764706875669982552" onmouseenter="enter('2764706875669982552');" onmouseout="out('2764706875669982552');" style=""><abbr title=" 377             sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCreated() : auditableStaticAsset.getDateUpdated()));"> 377             sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAssetðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 378         }                                                                                                </span>
<span  style=""> 379                                                                                                          </span>
<span class="-9176202731662601074" onmouseenter="enter('-9176202731662601074');" onmouseout="out('-9176202731662601074');" style=""> 380         if (parameterMap != null) {                                                                      </span>
<span class="-8466079002823576232" onmouseenter="enter('-8466079002823576232');" onmouseout="out('-8466079002823576232');" style=""> 381             for (Map.Entry&lt;String, String&gt; entry : parameterMap.entrySet()) {                            </span>
<span class="-5538998764085201912" onmouseenter="enter('-5538998764085201912');" onmouseout="out('-5538998764085201912');" style=""> 382                 sb2.append(&#x27;-&#x27;);                                                                         </span>
<span class="2475309890837225957" onmouseenter="enter('2475309890837225957');" onmouseout="out('2475309890837225957');" style=""> 383                 sb2.append(entry.getKey());                                                              </span>
<span class="-5538998764085201912" onmouseenter="enter('-5538998764085201912');" onmouseout="out('-5538998764085201912');" style=""> 384                 sb2.append(&#x27;-&#x27;);                                                                         </span>
<span class="7337918225958425753" onmouseenter="enter('7337918225958425753');" onmouseout="out('7337918225958425753');" style=""> 385                 sb2.append(entry.getValue());                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 386             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 387         }                                                                                                </span>
<span  style=""> 388                                                                                                          </span>
<span class="-3611986260301585228" onmouseenter="enter('-3611986260301585228');" onmouseout="out('-3611986260301585228');" style=""> 389         String digest;                                                                                   </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 390         try {                                                                                            </span>
<span class="-6955618976542935940" onmouseenter="enter('-6955618976542935940');" onmouseout="out('-6955618976542935940');" style=""> 391             MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);                                         </span>
<span class="-42474679596396087" onmouseenter="enter('-42474679596396087');" onmouseout="out('-42474679596396087');" style=""> 392             byte[] messageDigest = md.digest(sb2.toString().getBytes());                                 </span>
<span class="-5380974963518813864" onmouseenter="enter('-5380974963518813864');" onmouseout="out('-5380974963518813864');" style=""> 393             BigInteger number = new BigInteger(1,messageDigest);                                         </span>
<span class="5844706554126289727" onmouseenter="enter('5844706554126289727');" onmouseout="out('5844706554126289727');" style=""> 394             digest = number.toString(16);                                                                </span>
<span class="-4215171220869553942" onmouseenter="enter('-4215171220869553942');" onmouseout="out('-4215171220869553942');" style=""> 395         } catch(NoSuchAlgorithmException e) {                                                            </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 396             throw new RuntimeException(e);                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 397         }                                                                                                </span>
<span  style=""> 398                                                                                                          </span>
<span class="-5802237960969046083" onmouseenter="enter('-5802237960969046083');" onmouseout="out('-5802237960969046083');" style=""> 399         sb.append(pad(digest, 32, &#x27;0&#x27;));                                                                 </span>
<span class="-4790971325793185911" onmouseenter="enter('-4790971325793185911');" onmouseout="out('-4790971325793185911');" style=""> 400         sb.append(fileName.substring(fileName.lastIndexOf(&#x27;.&#x27;)));                                        </span>
<span  style=""> 401                                                                                                          </span>
<span class="-6276773404435993532" onmouseenter="enter('-6276773404435993532');" onmouseout="out('-6276773404435993532');" style=""> 402         return sb.toString();                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 403     }                                                                                                    </span>
<span  style=""> 404                                                                                                          </span>
<span class="3889823321692711159" onmouseenter="enter('3889823321692711159');" onmouseout="out('3889823321692711159');" style=""> 405     protected String pad(String s, int length, char pad) {                                               </span>
<span class="445211846679573021" onmouseenter="enter('445211846679573021');" onmouseout="out('445211846679573021');" style=""> 406         StringBuilder buffer = new StringBuilder(s);                                                     </span>
<span class="-1767419613255418829" onmouseenter="enter('-1767419613255418829');" onmouseout="out('-1767419613255418829');" style=""> 407         while (buffer.length() &lt; length) {                                                               </span>
<span class="5619102104931061603" onmouseenter="enter('5619102104931061603');" onmouseout="out('5619102104931061603');" style=""> 408             buffer.insert(0, pad);                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 409         }                                                                                                </span>
<span class="-2038716794812902958" onmouseenter="enter('-2038716794812902958');" onmouseout="out('-2038716794812902958');" style=""> 410         return buffer.toString();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 411     }                                                                                                    </span>
<span  style=""> 412                                                                                                          </span>
<span class="8674831860571754100" onmouseenter="enter('8674831860571754100');" onmouseout="out('8674831860571754100');" style=""> 413     @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)                                               </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 414     @Override                                                                                            </span>
<span class="124994076020326784" onmouseenter="enter('124994076020326784');" onmouseout="out('124994076020326784');" style=""><abbr title=" 415     public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOException {"> 415     public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOExðŸ”µ</abbr></span>
<span class="-2118089514208048024" onmouseenter="enter('-2118089514208048024');" onmouseout="out('-2118089514208048024');" style=""> 416         createStaticAssetStorage(file.getInputStream(), staticAsset);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417     }                                                                                                    </span>
<span  style=""> 418                                                                                                          </span>
<span class="8674831860571754100" onmouseenter="enter('8674831860571754100');" onmouseout="out('8674831860571754100');" style=""> 419     @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)                                               </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 420     @Override                                                                                            </span>
<span class="-850236438741332732" onmouseenter="enter('-850236438741332732');" onmouseout="out('-850236438741332732');" style=""><abbr title=" 421     public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException {"> 421     public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOEðŸ”µ</abbr></span>
<span class="-1403207369962524759" onmouseenter="enter('-1403207369962524759');" onmouseout="out('-1403207369962524759');" style=""> 422         if (StorageType.DATABASE.equals(staticAsset.getStorageType())) {                                 </span>
<span class="-1939605028615766275" onmouseenter="enter('-1939605028615766275');" onmouseout="out('-1939605028615766275');" style=""> 423             StaticAssetStorage storage = create();                                                       </span>
<span class="-204637599683518602" onmouseenter="enter('-204637599683518602');" onmouseout="out('-204637599683518602');" style=""> 424             storage.setStaticAssetId(staticAsset.getId());                                               </span>
<span class="1384418291306141967" onmouseenter="enter('1384418291306141967');" onmouseout="out('1384418291306141967');" style=""> 425             Blob uploadBlob = createBlob(fileInputStream, staticAsset.getFileSize());                    </span>
<span class="6866380704006125127" onmouseenter="enter('6866380704006125127');" onmouseout="out('6866380704006125127');" style=""> 426             storage.setFileData(uploadBlob);                                                             </span>
<span class="-2840973363991180880" onmouseenter="enter('-2840973363991180880');" onmouseout="out('-2840973363991180880');" style=""> 427             save(storage);                                                                               </span>
<span class="-2132857837912478262" onmouseenter="enter('-2132857837912478262');" onmouseout="out('-2132857837912478262');" style=""> 428         } else if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {                        </span>
<span class="-4012729166374721308" onmouseenter="enter('-4012729166374721308');" onmouseout="out('-4012729166374721308');" style=""> 429             FileWorkArea tempWorkArea = broadleafFileService.initializeWorkArea();                       </span>
<span class="-4881648785169426910" onmouseenter="enter('-4881648785169426910');" onmouseout="out('-4881648785169426910');" style=""> 430             // Convert the given URL from the asset to a system-specific suitable file path              </span>
<span class="-6260899414746866851" onmouseenter="enter('-6260899414746866851');" onmouseout="out('-6260899414746866851');" style=""><abbr title=" 431             String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FilenameUtils.separatorsToSystem(staticAsset.getFullUrl()));"> 431             String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separðŸ”µ</abbr></span>
<span  style=""> 432                                                                                                          </span>
<span class="2773091736631403971" onmouseenter="enter('2773091736631403971');" onmouseout="out('2773091736631403971');" style=""> 433             InputStream input = fileInputStream;                                                         </span>
<span class="6832533006494732607" onmouseenter="enter('6832533006494732607');" onmouseout="out('6832533006494732607');" style=""> 434             byte[] buffer = new byte[getFileBufferSize()];                                               </span>
<span  style=""> 435                                                                                                          </span>
<span class="-6502247887775821258" onmouseenter="enter('-6502247887775821258');" onmouseout="out('-6502247887775821258');" style=""> 436             File destFile = new File(destFileName);                                                      </span>
<span class="-695082894467535606" onmouseenter="enter('-695082894467535606');" onmouseout="out('-695082894467535606');" style=""> 437             if (!destFile.getParentFile().exists()) {                                                    </span>
<span class="8653794664879930122" onmouseenter="enter('8653794664879930122');" onmouseout="out('8653794664879930122');" style=""> 438                 if (!destFile.getParentFile().mkdirs()) {                                                </span>
<span class="-695082894467535606" onmouseenter="enter('-695082894467535606');" onmouseout="out('-695082894467535606');" style=""> 439                     if (!destFile.getParentFile().exists()) {                                            </span>
<span class="5433889739361026965" onmouseenter="enter('5433889739361026965');" onmouseout="out('5433889739361026965');" style=""><abbr title=" 440                         throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileName);"> 440                         throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + desðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 441                     }                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 442                 }                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 443             }                                                                                            </span>
<span  style=""> 444                                                                                                          </span>
<span class="6445829042907396164" onmouseenter="enter('6445829042907396164');" onmouseout="out('6445829042907396164');" style=""> 445             OutputStream output = new FileOutputStream(destFile);                                        </span>
<span class="-5038889493716933228" onmouseenter="enter('-5038889493716933228');" onmouseout="out('-5038889493716933228');" style=""> 446             long maxFileSize = getMaxUploadSizeForFile(destFileName);                                    </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 447             try {                                                                                        </span>
<span class="-7067986891170572893" onmouseenter="enter('-7067986891170572893');" onmouseout="out('-7067986891170572893');" style=""> 448                 int bytesRead;                                                                           </span>
<span class="5297046094019116056" onmouseenter="enter('5297046094019116056');" onmouseout="out('5297046094019116056');" style=""> 449                 int totalBytesRead = 0;                                                                  </span>
<span class="-7676219729156525464" onmouseenter="enter('-7676219729156525464');" onmouseout="out('-7676219729156525464');" style=""> 450                 while ((bytesRead = input.read(buffer)) != -1) {                                         </span>
<span class="-6799238023814913099" onmouseenter="enter('-6799238023814913099');" onmouseout="out('-6799238023814913099');" style=""> 451                     totalBytesRead += bytesRead;                                                         </span>
<span class="775261430666212722" onmouseenter="enter('775261430666212722');" onmouseout="out('775261430666212722');" style=""> 452                     if (totalBytesRead &gt; maxFileSize) {                                                  </span>
<span class="-104032706615660809" onmouseenter="enter('-104032706615660809');" onmouseout="out('-104032706615660809');" style=""> 453                         throw new IOException(&quot;Maximum Upload File Size Exceeded&quot;);                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 454                     }                                                                                    </span>
<span class="6143107777038809767" onmouseenter="enter('6143107777038809767');" onmouseout="out('6143107777038809767');" style=""> 455                     output.write(buffer, 0, bytesRead);                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 456                 }                                                                                        </span>
<span  style=""> 457                                                                                                          </span>
<span class="-3636717142636833723" onmouseenter="enter('-3636717142636833723');" onmouseout="out('-3636717142636833723');" style=""> 458                 // close the output file stream prior to moving files around                             </span>
<span class="-7467153277872057229" onmouseenter="enter('-7467153277872057229');" onmouseout="out('-7467153277872057229');" style=""> 459                 output.close();                                                                          </span>
<span class="-7014270169952325099" onmouseenter="enter('-7014270169952325099');" onmouseout="out('-7014270169952325099');" style=""> 460                 broadleafFileService.addOrUpdateResource(tempWorkArea, destFile, false);                 </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 461             } finally {                                                                                  </span>
<span class="4174609820499721765" onmouseenter="enter('4174609820499721765');" onmouseout="out('4174609820499721765');" style=""> 462                 IOUtils.closeQuietly(output);                                                            </span>
<span class="5684068854007703140" onmouseenter="enter('5684068854007703140');" onmouseout="out('5684068854007703140');" style=""> 463                 broadleafFileService.closeWorkArea(tempWorkArea);                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 464             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 465         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 466     }                                                                                                    </span>
<span  style=""> 467                                                                                                          </span>
<span class="7880420848062709346" onmouseenter="enter('7880420848062709346');" onmouseout="out('7880420848062709346');" style=""> 468     protected long getMaxUploadSizeForFile(String fileName) {                                            </span>
<span class="-8299331750570909154" onmouseenter="enter('-8299331750570909154');" onmouseout="out('-8299331750570909154');" style=""> 469         if (isImageFile(fileName)) {                                                                     </span>
<span class="-8904535810123442239" onmouseenter="enter('-8904535810123442239');" onmouseout="out('-8904535810123442239');" style=""> 470             return getMaxUploadableImageSize();                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 471         }                                                                                                </span>
<span  style=""> 472                                                                                                          </span>
<span class="7342651561788072273" onmouseenter="enter('7342651561788072273');" onmouseout="out('7342651561788072273');" style=""> 473         return getMaxUploadableFileSize();                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 474     }                                                                                                    </span>
<span  style=""> 475                                                                                                          </span>
<span class="-4256605375867072165" onmouseenter="enter('-4256605375867072165');" onmouseout="out('-4256605375867072165');" style=""> 476     protected boolean isImageFile(String fileName) {                                                     </span>
<span class="-7215778148857055723" onmouseenter="enter('-7215778148857055723');" onmouseout="out('-7215778148857055723');" style=""> 477         String extension = getFileExtension(fileName);                                                   </span>
<span  style=""> 478                                                                                                          </span>
<span class="868046925461100818" onmouseenter="enter('868046925461100818');" onmouseout="out('868046925461100818');" style=""> 479         for (String imageFileExtension : getAdminImageFileExtensions()) {                                </span>
<span class="-1882310683799532334" onmouseenter="enter('-1882310683799532334');" onmouseout="out('-1882310683799532334');" style=""> 480             if (imageFileExtension.equalsIgnoreCase(extension)) {                                        </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 481                 return true;                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 482             }                                                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 483         }                                                                                                </span>
<span  style=""> 484                                                                                                          </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 485         return false;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 486     }                                                                                                    </span>
<span  style=""> 487                                                                                                          </span>
<span class="-4067859991978763128" onmouseenter="enter('-4067859991978763128');" onmouseout="out('-4067859991978763128');" style=""> 488     protected String getFileExtension(String assetPath) {                                                </span>
<span class="-7365160516150097212" onmouseenter="enter('-7365160516150097212');" onmouseout="out('-7365160516150097212');" style=""> 489         int extensionStartIndex = assetPath.lastIndexOf(&quot;.&quot;) + 1;                                        </span>
<span class="3165050002785748305" onmouseenter="enter('3165050002785748305');" onmouseout="out('3165050002785748305');" style=""> 490         return assetPath.substring(extensionStartIndex);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 491     }                                                                                                    </span>
<span  style=""> 492                                                                                                          </span>
<span class="8520324044054424760" onmouseenter="enter('8520324044054424760');" onmouseout="out('8520324044054424760');" style=""> 493     protected long getMaxUploadableFileSize() {                                                          </span>
<span class="1140464926219340493" onmouseenter="enter('1140464926219340493');" onmouseout="out('1140464926219340493');" style=""><abbr title=" 494         Long blcUploadSize = env.getProperty(&quot;asset.server.max.uploadable.file.size&quot;, java.lang.Long.class);"> 494         Long blcUploadSize = env.getProperty(&quot;asset.server.max.uploadable.file.size&quot;, java.lang.Long.clasðŸ”µ</abbr></span>
<span class="-6815277628371519591" onmouseenter="enter('-6815277628371519591');" onmouseout="out('-6815277628371519591');" style=""> 495         if (blcUploadSize != null) {                                                                     </span>
<span class="-2122879694774875974" onmouseenter="enter('-2122879694774875974');" onmouseout="out('-2122879694774875974');" style=""> 496             return blcUploadSize;                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 497         }                                                                                                </span>
<span class="-83413303193047685" onmouseenter="enter('-83413303193047685');" onmouseout="out('-83413303193047685');" style=""> 498         if (defaultMultipartSettings != null) {                                                          </span>
<span class="3781451292667627704" onmouseenter="enter('3781451292667627704');" onmouseout="out('3781451292667627704');" style=""> 499             return defaultMultipartSettings.createMultipartConfig().getMaxFileSize();                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 500         }                                                                                                </span>
<span class="8028643923497516300" onmouseenter="enter('8028643923497516300');" onmouseout="out('8028643923497516300');" style=""> 501         return DEFAULT_ASSET_UPLOAD_SIZE;                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 502     }                                                                                                    </span>
<span  style=""> 503                                                                                                          </span>
<span class="-4925501260426057745" onmouseenter="enter('-4925501260426057745');" onmouseout="out('-4925501260426057745');" style=""> 504     protected long getMaxUploadableImageSize() {                                                         </span>
<span class="2537324483761513782" onmouseenter="enter('2537324483761513782');" onmouseout="out('2537324483761513782');" style=""> 505         // backwards-compatibility checks, only use the image-size specific property if it is            </span>
<span class="4617761826312627412" onmouseenter="enter('4617761826312627412');" onmouseout="out('4617761826312627412');" style=""> 506         // not the default value. Otherwise, delegate to the old property                                </span>
<span class="7612408840010340391" onmouseenter="enter('7612408840010340391');" onmouseout="out('7612408840010340391');" style=""> 507         Long maxImgSize = env.getProperty(&quot;asset.server.max.uploadable.image.size&quot;, Long.class);         </span>
<span class="-430636607829496210" onmouseenter="enter('-430636607829496210');" onmouseout="out('-430636607829496210');" style=""> 508         if (maxImgSize == null) {                                                                        </span>
<span class="7342651561788072273" onmouseenter="enter('7342651561788072273');" onmouseout="out('7342651561788072273');" style=""> 509             return getMaxUploadableFileSize();                                                           </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 510         } else {                                                                                         </span>
<span class="-7468174336769267749" onmouseenter="enter('-7468174336769267749');" onmouseout="out('-7468174336769267749');" style=""> 511             return maxImgSize;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 512         }                                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 513     }                                                                                                    </span>
<span  style=""> 514                                                                                                          </span>
<span class="3561631998050563638" onmouseenter="enter('3561631998050563638');" onmouseout="out('3561631998050563638');" style=""> 515     protected int getFileBufferSize() {                                                                  </span>
<span class="6759418199922005006" onmouseenter="enter('6759418199922005006');" onmouseout="out('6759418199922005006');" style=""> 516         return env.getProperty(&quot;asset.server.file.buffer.size&quot;, int.class, DEFAULT_BUFFER_SIZE);         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 517     }                                                                                                    </span>
<span  style=""> 518                                                                                                          </span>
<span class="-7892865232186196236" onmouseenter="enter('-7892865232186196236');" onmouseout="out('-7892865232186196236');" style=""> 519     protected List&lt;String&gt; getAdminImageFileExtensions() {                                               </span>
<span class="4831601876827029435" onmouseenter="enter('4831601876827029435');" onmouseout="out('4831601876827029435');" style=""><abbr title=" 520         String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENSIONS);"> 520         String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMðŸ”µ</abbr></span>
<span class="-1830661333141003565" onmouseenter="enter('-1830661333141003565');" onmouseout="out('-1830661333141003565');" style=""> 521         return Arrays.asList(extensions.split(&quot;,&quot;));                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 522     }                                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 523 }                                                                                                        </span>























</pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-6173756248845875922" onmouseenter="enter('-6173756248845875922');" onmouseout="out('-6173756248845875922');" style="">   3   * BroadleafCommerce CMS Module                                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-2980987384224312133" onmouseenter="enter('-2980987384224312133');" onmouseout="out('-2980987384224312133');" style="">  18  package org.broadleafcommerce.cms.file.service;                                                                   </span>
<span  style="">  19                                                                                                                    </span>



<span class="-2296051308340473600" onmouseenter="enter('-2296051308340473600');" onmouseout="out('-2296051308340473600');" style="">  20  import org.apache.commons.io.FilenameUtils;                                                                       </span>
<span class="-7541571572495339903" onmouseenter="enter('-7541571572495339903');" onmouseout="out('-7541571572495339903');" style="">  21  import org.apache.commons.io.IOUtils;                                                                             </span>


<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  22  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  23  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="6421182070533632471" onmouseenter="enter('6421182070533632471');" onmouseout="out('6421182070533632471');" style="">  24  import org.broadleafcommerce.cms.common.AssetNotFoundException;                                                   </span>
<span class="8163806430712317298" onmouseenter="enter('8163806430712317298');" onmouseout="out('8163806430712317298');" style="">  25  import org.broadleafcommerce.cms.field.type.StorageType;                                                          </span>
<span class="-8427882675756262690" onmouseenter="enter('-8427882675756262690');" onmouseout="out('-8427882675756262690');" style="">  26  import org.broadleafcommerce.cms.file.dao.StaticAssetStorageDao;                                                  </span>
<span class="1355270185972111851" onmouseenter="enter('1355270185972111851');" onmouseout="out('1355270185972111851');" style="">  27  import org.broadleafcommerce.cms.file.domain.StaticAsset;                                                         </span>
<span class="-9103956258218147401" onmouseenter="enter('-9103956258218147401');" onmouseout="out('-9103956258218147401');" style="">  28  import org.broadleafcommerce.cms.file.domain.StaticAssetStorage;                                                  </span>
<span class="9188568145725907286" onmouseenter="enter('9188568145725907286');" onmouseout="out('9188568145725907286');" style="">  29  import org.broadleafcommerce.cms.file.service.operation.NamedOperationManager;                                    </span>
<span class="-1074856182010318298" onmouseenter="enter('-1074856182010318298');" onmouseout="out('-1074856182010318298');" style="">  30  import org.broadleafcommerce.common.audit.Auditable;                                                              </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  31  import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                              </span>
<span class="-8339254235515724670" onmouseenter="enter('-8339254235515724670');" onmouseout="out('-8339254235515724670');" style="">  32  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;                                          </span>
<span class="-2507677682672524762" onmouseenter="enter('-2507677682672524762');" onmouseout="out('-2507677682672524762');" style="">  33  import org.broadleafcommerce.common.file.domain.FileWorkArea;                                                     </span>
<span class="3660177375850747944" onmouseenter="enter('3660177375850747944');" onmouseout="out('3660177375850747944');" style="">  34  import org.broadleafcommerce.common.file.service.BroadleafFileService;                                            </span>
<span class="-6194024147123816671" onmouseenter="enter('-6194024147123816671');" onmouseout="out('-6194024147123816671');" style="">  35  import org.broadleafcommerce.common.file.service.GloballySharedInputStream;                                       </span>
<span class="8070124246740049341" onmouseenter="enter('8070124246740049341');" onmouseout="out('8070124246740049341');" style="">  36  import org.broadleafcommerce.common.io.ConcurrentFileOutputStream;                                                </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  37  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                              </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  38  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                         </span>
<span class="-32928361580396825" onmouseenter="enter('-32928361580396825');" onmouseout="out('-32928361580396825');" style="">  39  import org.broadleafcommerce.openadmin.server.service.artifact.ArtifactService;                                   </span>
<span class="-7077569502978710918" onmouseenter="enter('-7077569502978710918');" onmouseout="out('-7077569502978710918');" style="">  40  import org.broadleafcommerce.openadmin.server.service.artifact.image.Operation;                                   </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  41  import org.springframework.beans.factory.annotation.Autowired;                                                    </span>

<span class="6709227556361837386" onmouseenter="enter('6709227556361837386');" onmouseout="out('6709227556361837386');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0">  42 -import org.springframework.boot.autoconfigure.web.MultipartProperties;                                            </span>
<span class="-1779577819582542853" onmouseenter="enter('-1779577819582542853');" onmouseout="out('-1779577819582542853');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  43 +import org.springframework.boot.autoconfigure.web.servlet.MultipartProperties;                                    </span>
<span class="2802840430073505079" onmouseenter="enter('2802840430073505079');" onmouseout="out('2802840430073505079');" style="">  44  import org.springframework.core.env.Environment;                                                                  </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  45  import org.springframework.stereotype.Service;                                                                    </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  46  import org.springframework.transaction.annotation.Transactional;                                                  </span>
<span class="4828820138133011218" onmouseenter="enter('4828820138133011218');" onmouseout="out('4828820138133011218');" style="">  47  import org.springframework.web.multipart.MultipartFile;                                                           </span>
<span  style="">  48                                                                                                                    </span>
<span class="-8084092933789958161" onmouseenter="enter('-8084092933789958161');" onmouseout="out('-8084092933789958161');" style="">  49  import java.io.BufferedInputStream;                                                                               </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  50  import java.io.File;                                                                                              </span>
<span class="-535075201057145249" onmouseenter="enter('-535075201057145249');" onmouseout="out('-535075201057145249');" style="">  51  import java.io.FileInputStream;                                                                                   </span>
<span class="4915709264156936957" onmouseenter="enter('4915709264156936957');" onmouseout="out('4915709264156936957');" style="">  52  import java.io.FileOutputStream;                                                                                  </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  53  import java.io.IOException;                                                                                       </span>
<span class="5631563232245871054" onmouseenter="enter('5631563232245871054');" onmouseout="out('5631563232245871054');" style="">  54  import java.io.InputStream;                                                                                       </span>
<span class="4621164050749610193" onmouseenter="enter('4621164050749610193');" onmouseout="out('4621164050749610193');" style="">  55  import java.io.OutputStream;                                                                                      </span>
<span class="-40197902381950972" onmouseenter="enter('-40197902381950972');" onmouseout="out('-40197902381950972');" style="">  56  import java.math.BigInteger;                                                                                      </span>
<span class="6381430938828950472" onmouseenter="enter('6381430938828950472');" onmouseout="out('6381430938828950472');" style="">  57  import java.security.MessageDigest;                                                                               </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  58  import java.security.NoSuchAlgorithmException;                                                                    </span>
<span class="-5709181831744795488" onmouseenter="enter('-5709181831744795488');" onmouseout="out('-5709181831744795488');" style="">  59  import java.sql.Blob;                                                                                             </span>
<span class="-515559982825150111" onmouseenter="enter('-515559982825150111');" onmouseout="out('-515559982825150111');" style="">  60  import java.sql.SQLException;                                                                                     </span>
<span class="54331962280914690" onmouseenter="enter('54331962280914690');" onmouseout="out('54331962280914690');" style="">  61  import java.text.SimpleDateFormat;                                                                                </span>
<span class="-28465676010609596" onmouseenter="enter('-28465676010609596');" onmouseout="out('-28465676010609596');" style="">  62  import java.util.Arrays;                                                                                          </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  63  import java.util.HashMap;                                                                                         </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  64  import java.util.List;                                                                                            </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  65  import java.util.Map;                                                                                             </span>
<span  style="">  66                                                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  67  import javax.annotation.Resource;                                                                                 </span>
<span  style="">  68                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  69  /**                                                                                                               </span>
<span class="5819561638806578074" onmouseenter="enter('5819561638806578074');" onmouseout="out('5819561638806578074');" style="">  70   * @author Jeff Fischer, Brian Polster                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  71   */                                                                                                               </span>
<span class="8555986608199362624" onmouseenter="enter('8555986608199362624');" onmouseout="out('8555986608199362624');" style="">  72  @Service(&quot;blStaticAssetStorageService&quot;)                                                                           </span>
<span class="-5440937737927857026" onmouseenter="enter('-5440937737927857026');" onmouseout="out('-5440937737927857026');" style="">  73  public class StaticAssetStorageServiceImpl implements StaticAssetStorageService {                                 </span>
<span  style="">  74                                                                                                                    </span>
<span class="2858988269359695714" onmouseenter="enter('2858988269359695714');" onmouseout="out('2858988269359695714');" style="">  75      private static final Log LOG = LogFactory.getLog(StaticAssetStorageServiceImpl.class);                        </span>
<span  style="">  76                                                                                                                    </span>
<span class="3730583078767808053" onmouseenter="enter('3730583078767808053');" onmouseout="out('3730583078767808053');" style="">  77      protected static final String DEFAULT_ADMIN_IMAGE_EXTENSIONS = &quot;bmp,jpg,jpeg,png,img,tiff,gif&quot;;               </span>
<span  style="">  78                                                                                                                    </span>
<span class="-2041789809652164219" onmouseenter="enter('-2041789809652164219');" onmouseout="out('-2041789809652164219');" style="">  79      public static final long DEFAULT_ASSET_UPLOAD_SIZE = 1024 * 1024 * 10;                                        </span>
<span  style="">  80                                                                                                                    </span>
<span class="-6481771976097152300" onmouseenter="enter('-6481771976097152300');" onmouseout="out('-6481771976097152300');" style="">  81      // 8kb default for the buffer for moving files around                                                         </span>
<span class="8173561874988853201" onmouseenter="enter('8173561874988853201');" onmouseout="out('8173561874988853201');" style="">  82      protected static final int DEFAULT_BUFFER_SIZE = 8096;                                                        </span>
<span  style="">  83                                                                                                                    </span>
<span class="5800015562641335858" onmouseenter="enter('5800015562641335858');" onmouseout="out('5800015562641335858');" style="">  84      protected String cacheDirectory;                                                                              </span>
<span  style="">  85                                                                                                                    </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="">  86      @Autowired                                                                                                    </span>
<span class="-7669104425724809181" onmouseenter="enter('-7669104425724809181');" onmouseout="out('-7669104425724809181');" style="">  87      protected Environment env;                                                                                    </span>
<span  style="">  88                                                                                                                    </span>
<span class="6195905131849662055" onmouseenter="enter('6195905131849662055');" onmouseout="out('6195905131849662055');" style="">  89      @Resource(name=&quot;blStaticAssetService&quot;)                                                                        </span>
<span class="5386460834235010869" onmouseenter="enter('5386460834235010869');" onmouseout="out('5386460834235010869');" style="">  90      protected StaticAssetService staticAssetService;                                                              </span>
<span  style="">  91                                                                                                                    </span>
<span class="1752371454992115000" onmouseenter="enter('1752371454992115000');" onmouseout="out('1752371454992115000');" style="">  92      @Resource(name = &quot;blFileService&quot;)                                                                             </span>
<span class="-5836282893854406064" onmouseenter="enter('-5836282893854406064');" onmouseout="out('-5836282893854406064');" style="">  93      protected BroadleafFileService broadleafFileService;                                                          </span>
<span  style="">  94                                                                                                                    </span>
<span class="7856532409026737335" onmouseenter="enter('7856532409026737335');" onmouseout="out('7856532409026737335');" style="">  95      @Resource(name=&quot;blArtifactService&quot;)                                                                           </span>
<span class="-5802479126948705000" onmouseenter="enter('-5802479126948705000');" onmouseout="out('-5802479126948705000');" style="">  96      protected ArtifactService artifactService;                                                                    </span>
<span  style="">  97                                                                                                                    </span>
<span class="-5691607332624048120" onmouseenter="enter('-5691607332624048120');" onmouseout="out('-5691607332624048120');" style="">  98      @Resource(name=&quot;blStaticAssetStorageDao&quot;)                                                                     </span>
<span class="3341461985908719037" onmouseenter="enter('3341461985908719037');" onmouseout="out('3341461985908719037');" style="">  99      protected StaticAssetStorageDao staticAssetStorageDao;                                                        </span>
<span  style=""> 100                                                                                                                    </span>
<span class="-8585007248377894204" onmouseenter="enter('-8585007248377894204');" onmouseout="out('-8585007248377894204');" style=""> 101      @Resource(name=&quot;blNamedOperationManager&quot;)                                                                     </span>
<span class="308482009813309658" onmouseenter="enter('308482009813309658');" onmouseout="out('308482009813309658');" style=""> 102      protected NamedOperationManager namedOperationManager;                                                        </span>
<span  style=""> 103                                                                                                                    </span>
<span class="5483516952021908632" onmouseenter="enter('5483516952021908632');" onmouseout="out('5483516952021908632');" style=""> 104      @Resource(name = &quot;blStaticAssetServiceExtensionManager&quot;)                                                      </span>
<span class="51840422594786922" onmouseenter="enter('51840422594786922');" onmouseout="out('51840422594786922');" style=""> 105      protected StaticAssetServiceExtensionManager extensionManager;                                                </span>
<span  style=""> 106                                                                                                                    </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 107      @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                           </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 108      protected StreamingTransactionCapableUtil transUtil;                                                          </span>
<span  style=""> 109                                                                                                                    </span>



<span class="2602789178515286342" onmouseenter="enter('2602789178515286342');" onmouseout="out('2602789178515286342');" style=""> 110      @Autowired(required = false)                                                                                  </span>
<span class="8981564986536911591" onmouseenter="enter('8981564986536911591');" onmouseout="out('8981564986536911591');" style=""> 111      protected MultipartProperties defaultMultipartSettings;                                                       </span>
<span  style=""> 112                                                                                                                    </span>
<span class="-7168779142218193311" onmouseenter="enter('-7168779142218193311');" onmouseout="out('-7168779142218193311');" style=""> 113      @Resource(name = &quot;blConcurrentFileOutputStream&quot;)                                                              </span>
<span class="-2331920133844743339" onmouseenter="enter('-2331920133844743339');" onmouseout="out('-2331920133844743339');" style=""> 114      protected ConcurrentFileOutputStream concurrentFileOutputStream;                                              </span>

<span  style=""> 115                                                                                                                    </span>
<span class="-6120158187110043675" onmouseenter="enter('-6120158187110043675');" onmouseout="out('-6120158187110043675');" style=""> 116      protected StaticAsset findStaticAsset(String fullUrl) {                                                       </span>
<span class="-4171210034184470086" onmouseenter="enter('-4171210034184470086');" onmouseout="out('-4171210034184470086');" style=""> 117          StaticAsset staticAsset = staticAssetService.findStaticAssetByFullUrl(fullUrl);                           </span>
<span  style=""> 118                                                                                                                    </span>
<span class="-2128240479658154685" onmouseenter="enter('-2128240479658154685');" onmouseout="out('-2128240479658154685');" style=""> 119          return staticAsset;                                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 120      }                                                                                                             </span>
<span  style=""> 121                                                                                                                    </span>
<span class="1529961503462031347" onmouseenter="enter('1529961503462031347');" onmouseout="out('1529961503462031347');" style=""> 122      protected boolean shouldUseSharedFile(InputStream is) {                                                       </span>
<span class="7200698625412718023" onmouseenter="enter('7200698625412718023');" onmouseout="out('7200698625412718023');" style=""> 123          return (is != null &amp;&amp; is instanceof GloballySharedInputStream);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 124      }                                                                                                             </span>
<span  style=""> 125                                                                                                                    </span>
<span class="1502967799885308477" onmouseenter="enter('1502967799885308477');" onmouseout="out('1502967799885308477');" style=""> 126      protected File getFileFromLocalRepository(String cachedFileName) {                                            </span>
<span class="-5673162797879974066" onmouseenter="enter('-5673162797879974066');" onmouseout="out('-5673162797879974066');" style=""> 127          // Look for a shared file (this represents a file that was based on a file originally in the classpath.   </span>
<span class="-93446380402546673" onmouseenter="enter('-93446380402546673');" onmouseout="out('-93446380402546673');" style=""> 128          File cacheFile = null;                                                                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 129          if (extensionManager != null) {                                                                           </span>
<span class="-8112713965554756916" onmouseenter="enter('-8112713965554756916');" onmouseout="out('-8112713965554756916');" style=""> 130              ExtensionResultHolder holder = new ExtensionResultHolder();                                           </span>
<span class="-435722502969466554" onmouseenter="enter('-435722502969466554');" onmouseout="out('-435722502969466554');" style=""> 131              ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holder);    </span>
<span class="-2043051207329155259" onmouseenter="enter('-2043051207329155259');" onmouseout="out('-2043051207329155259');" style=""> 132              if (ExtensionResultStatusType.HANDLED.equals(result)) {                                               </span>
<span class="7653982040624486223" onmouseenter="enter('7653982040624486223');" onmouseout="out('7653982040624486223');" style=""> 133                  cacheFile = (File) holder.getResult();                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 134              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 135          }                                                                                                         </span>
<span class="-8813269293199686205" onmouseenter="enter('-8813269293199686205');" onmouseout="out('-8813269293199686205');" style=""> 136          if (cacheFile == null) {                                                                                  </span>
<span class="-8910009845238484526" onmouseenter="enter('-8910009845238484526');" onmouseout="out('-8910009845238484526');" style=""> 137              cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 138          }                                                                                                         </span>
<span class="-2028153032285377680" onmouseenter="enter('-2028153032285377680');" onmouseout="out('-2028153032285377680');" style=""> 139          if (cacheFile.exists()) {                                                                                 </span>
<span class="8210317951176929256" onmouseenter="enter('8210317951176929256');" onmouseout="out('8210317951176929256');" style=""> 140              return cacheFile;                                                                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 141          } else {                                                                                                  </span>
<span class="5496227938366649270" onmouseenter="enter('5496227938366649270');" onmouseout="out('5496227938366649270');" style=""> 142              return broadleafFileService.getLocalResource(cachedFileName);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 143          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 144      }                                                                                                             </span>
<span  style=""> 145                                                                                                                    </span>
<span class="-9138520702166900061" onmouseenter="enter('-9138520702166900061');" onmouseout="out('-9138520702166900061');" style=""> 146      protected File lookupAssetAndCreateLocalFile(StaticAsset staticAsset, File baseLocalFile)                     </span>
<span class="452573679482946095" onmouseenter="enter('452573679482946095');" onmouseout="out('452573679482946095');" style=""> 147              throws IOException, SQLException {                                                                    </span>
<span class="-7742266551317191943" onmouseenter="enter('-7742266551317191943');" onmouseout="out('-7742266551317191943');" style=""> 148          if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {                                        </span>
<span class="-4354847567179586644" onmouseenter="enter('-4354847567179586644');" onmouseout="out('-4354847567179586644');" style=""> 149              File returnFile = broadleafFileService.getResource(staticAsset.getFullUrl());                         </span>
<span class="8059946160260640624" onmouseenter="enter('8059946160260640624');" onmouseout="out('8059946160260640624');" style=""> 150              if (!returnFile.getAbsolutePath().equals(baseLocalFile.getAbsolutePath())) {                          </span>
<span class="-2191133777668840278" onmouseenter="enter('-2191133777668840278');" onmouseout="out('-2191133777668840278');" style=""> 151                  createLocalFileFromInputStream(new FileInputStream(returnFile), baseLocalFile);                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 152              }                                                                                                     </span>
<span class="4024427022501975435" onmouseenter="enter('4024427022501975435');" onmouseout="out('4024427022501975435');" style=""> 153              return broadleafFileService.getResource(staticAsset.getFullUrl());                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 154          } else {                                                                                                  </span>
<span class="-4264495412887169123" onmouseenter="enter('-4264495412887169123');" onmouseout="out('-4264495412887169123');" style=""> 155              StaticAssetStorage storage = readStaticAssetStorageByStaticAssetId(staticAsset.getId());              </span>
<span class="4400092173030817905" onmouseenter="enter('4400092173030817905');" onmouseout="out('4400092173030817905');" style=""> 156              if (storage != null) {                                                                                </span>
<span class="-3012070176633314991" onmouseenter="enter('-3012070176633314991');" onmouseout="out('-3012070176633314991');" style=""> 157                  InputStream is = storage.getFileData().getBinaryStream();                                         </span>
<span class="538128314668626861" onmouseenter="enter('538128314668626861');" onmouseout="out('538128314668626861');" style=""> 158                  createLocalFileFromInputStream(is, baseLocalFile);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 159              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 160          }                                                                                                         </span>
<span class="8385511608933773357" onmouseenter="enter('8385511608933773357');" onmouseout="out('8385511608933773357');" style=""> 161          return baseLocalFile;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 162      }                                                                                                             </span>
<span  style=""> 163                                                                                                                    </span>
<span class="676971272687988980" onmouseenter="enter('676971272687988980');" onmouseout="out('676971272687988980');" style=""><abbr title=" 164      protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOException {"> 164      protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOExceðŸ”µ</abbr></span>
<span class="5330873671579735739" onmouseenter="enter('5330873671579735739');" onmouseout="out('5330873671579735739');" style=""> 165          InputStream is = broadleafFileService.getClasspathResource(staticAsset.getFullUrl());                     </span>
<span class="538128314668626861" onmouseenter="enter('538128314668626861');" onmouseout="out('538128314668626861');" style=""> 166          createLocalFileFromInputStream(is, baseLocalFile);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 167      }                                                                                                             </span>
<span  style=""> 168                                                                                                                    </span>
<span class="-4952056920597128037" onmouseenter="enter('-4952056920597128037');" onmouseout="out('-4952056920597128037');" style=""> 169      protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException {        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 170          try {                                                                                                     </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 171              if (!baseLocalFile.getParentFile().exists()) {                                                        </span>
<span class="5777296043812209192" onmouseenter="enter('5777296043812209192');" onmouseout="out('5777296043812209192');" style=""> 172                  boolean directoriesCreated = false;                                                               </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 173                  if (!baseLocalFile.getParentFile().exists()) {                                                    </span>
<span class="-1950703901965003992" onmouseenter="enter('-1950703901965003992');" onmouseout="out('-1950703901965003992');" style=""> 174                      directoriesCreated = baseLocalFile.getParentFile().mkdirs();                                  </span>
<span class="-5835726015694115162" onmouseenter="enter('-5835726015694115162');" onmouseout="out('-5835726015694115162');" style=""> 175                      if (!directoriesCreated) {                                                                    </span>
<span class="-440335952408349395" onmouseenter="enter('-440335952408349395');" onmouseout="out('-440335952408349395');" style=""> 176                          // There is a chance that another VM created the directories.   If not, we may not have   </span>
<span class="5346057857994506172" onmouseenter="enter('5346057857994506172');" onmouseout="out('5346057857994506172');" style=""> 177                          // proper permissions and this is an error we need to report.                             </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 178                          if (!baseLocalFile.getParentFile().exists()) {                                            </span>
<span class="-3100057651899633278" onmouseenter="enter('-3100057651899633278');" onmouseout="out('-3100057651899633278');" style=""> 179                              throw new RuntimeException(&quot;Unable to create middle directories for file: &quot; +         </span>
<span class="-3627057965366514409" onmouseenter="enter('-3627057965366514409');" onmouseout="out('-3627057965366514409');" style=""> 180                                      baseLocalFile.getAbsolutePath());                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 181                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 182                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 183                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 184              }                                                                                                     </span>
<span  style=""> 185                                                                                                                    </span>
<span class="1058516638336488341" onmouseenter="enter('1058516638336488341');" onmouseout="out('1058516638336488341');" style=""> 186              concurrentFileOutputStream.write(is, baseLocalFile);                                                  </span>
<span  style=""> 187                                                                                                                    </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 188          } finally {                                                                                               </span>
<span class="-1036224550261950069" onmouseenter="enter('-1036224550261950069');" onmouseout="out('-1036224550261950069');" style=""> 189              IOUtils.closeQuietly(is);                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 191      }                                                                                                             </span>
<span  style=""> 192                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 193      @Override                                                                                                     </span>
<span class="-5764870268385651216" onmouseenter="enter('-5764870268385651216');" onmouseout="out('-5764870268385651216');" style=""><abbr title=" 194      public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws Exception {"> 194      public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws ExceptioðŸ”µ</abbr></span>
<span class="491052228983464108" onmouseenter="enter('491052228983464108');" onmouseout="out('491052228983464108');" style=""> 195          StaticAsset staticAsset = findStaticAsset(fullUrl);                                                       </span>
<span class="-3786942395132975147" onmouseenter="enter('-3786942395132975147');" onmouseout="out('-3786942395132975147');" style=""> 196          if (staticAsset == null) {                                                                                </span>
<span class="-676167423781739050" onmouseenter="enter('-676167423781739050');" onmouseout="out('-676167423781739050');" style=""> 197              throw new AssetNotFoundException(&quot;Unable to find an asset for the url (&quot; + fullUrl + &quot;)&quot;);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 198          }                                                                                                         </span>
<span class="-5398322132344119647" onmouseenter="enter('-5398322132344119647');" onmouseout="out('-5398322132344119647');" style=""> 199          String mimeType = staticAsset.getMimeType();                                                              </span>
<span  style=""> 200                                                                                                                    </span>
<span class="8252026315203489548" onmouseenter="enter('8252026315203489548');" onmouseout="out('8252026315203489548');" style=""> 201          //extract the values for any named parameters                                                             </span>

<span class="5491208348485302910" onmouseenter="enter('5491208348485302910');" onmouseout="out('5491208348485302910');" style=""> 202          Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMap);      </span>



<span class="-6987211962421403682" onmouseenter="enter('-6987211962421403682');" onmouseout="out('-6987211962421403682');" style=""> 203          String cachedFileName = constructCacheFileName(staticAsset, convertedParameters);                         </span>




<span  style=""> 204                                                                                                                    </span>
<span class="-5673162797879974066" onmouseenter="enter('-5673162797879974066');" onmouseout="out('-5673162797879974066');" style=""> 205          // Look for a shared file (this represents a file that was based on a file originally in the classpath.   </span>
<span class="-744748978496739834" onmouseenter="enter('-744748978496739834');" onmouseout="out('-744748978496739834');" style=""> 206          File cacheFile = getFileFromLocalRepository(cachedFileName);                                              </span>
<span class="-2028153032285377680" onmouseenter="enter('-2028153032285377680');" onmouseout="out('-2028153032285377680');" style=""> 207          if (cacheFile.exists()) {                                                                                 </span>
<span class="-5770017993670818757" onmouseenter="enter('-5770017993670818757');" onmouseout="out('-5770017993670818757');" style=""> 208              return buildModel(cacheFile.getAbsolutePath(), mimeType);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 209          }                                                                                                         </span>
<span  style=""> 210                                                                                                                    </span>
<span class="7943467756367013608" onmouseenter="enter('7943467756367013608');" onmouseout="out('7943467756367013608');" style=""> 211          // Obtain the base file (that we may need to convert based on the parameters                              </span>
<span class="-7282961418041278395" onmouseenter="enter('-7282961418041278395');" onmouseout="out('-7282961418041278395');" style=""> 212          String baseCachedFileName = constructCacheFileName(staticAsset, null);                                    </span>
<span class="2819718340222738473" onmouseenter="enter('2819718340222738473');" onmouseout="out('2819718340222738473');" style=""> 213          File baseLocalFile = getFileFromLocalRepository(baseCachedFileName);                                      </span>
<span  style=""> 214                                                                                                                    </span>
<span class="7807331939993150402" onmouseenter="enter('7807331939993150402');" onmouseout="out('7807331939993150402');" style=""> 215          if (! baseLocalFile.exists()) {                                                                           </span>
<span class="-4152796465711126856" onmouseenter="enter('-4152796465711126856');" onmouseout="out('-4152796465711126856');" style=""> 216              if (broadleafFileService.checkForResourceOnClassPath(staticAsset.getFullUrl())) {                     </span>
<span class="-8910009845238484526" onmouseenter="enter('-8910009845238484526');" onmouseout="out('-8910009845238484526');" style=""> 217                  cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);                          </span>
<span class="-3411813136412986040" onmouseenter="enter('-3411813136412986040');" onmouseout="out('-3411813136412986040');" style=""> 218                  baseLocalFile = broadleafFileService.getSharedLocalResource(baseCachedFileName);                  </span>
<span class="-4235219464337080287" onmouseenter="enter('-4235219464337080287');" onmouseout="out('-4235219464337080287');" style=""> 219                  createLocalFileFromClassPathResource(staticAsset, baseLocalFile);                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 220              } else {                                                                                              </span>
<span class="-4898184433395929673" onmouseenter="enter('-4898184433395929673');" onmouseout="out('-4898184433395929673');" style=""> 221                  baseLocalFile = lookupAssetAndCreateLocalFile(staticAsset, baseLocalFile);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 222              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 223          }                                                                                                         </span>
<span  style=""> 224                                                                                                                    </span>
<span class="5916960396483683926" onmouseenter="enter('5916960396483683926');" onmouseout="out('5916960396483683926');" style=""> 225          if (convertedParameters.isEmpty()) {                                                                      </span>


<span class="1541740886220527868" onmouseenter="enter('1541740886220527868');" onmouseout="out('1541740886220527868');" style=""> 226              return buildModel(baseLocalFile.getAbsolutePath(), mimeType);                                         </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 227          } else {                                                                                                  </span>


<span class="2626429018838635667" onmouseenter="enter('2626429018838635667');" onmouseout="out('2626429018838635667');" style=""> 228              FileInputStream assetStream = new FileInputStream(baseLocalFile);                                     </span>
<span class="1559981230759799611" onmouseenter="enter('1559981230759799611');" onmouseout="out('1559981230759799611');" style=""> 229              BufferedInputStream original = new BufferedInputStream(assetStream);                                  </span>
<span class="5335072745234046164" onmouseenter="enter('5335072745234046164');" onmouseout="out('5335072745234046164');" style=""> 230              original.mark(0);                                                                                     </span>
<span  style=""> 231                                                                                                                    </span>
<span class="3271606902025597443" onmouseenter="enter('3271606902025597443');" onmouseout="out('3271606902025597443');" style=""><abbr title=" 232              Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.getMimeType());"> 232              Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.geðŸ”µ</abbr></span>
<span class="-4049222348408471473" onmouseenter="enter('-4049222348408471473');" onmouseout="out('-4049222348408471473');" style=""> 233              InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeType());     </span>
<span  style=""> 234                                                                                                                    </span>
<span class="-5852373631387772582" onmouseenter="enter('-5852373631387772582');" onmouseout="out('-5852373631387772582');" style=""> 235              createLocalFileFromInputStream(converted, cacheFile);                                                 </span>
<span class="8481176371776030575" onmouseenter="enter('8481176371776030575');" onmouseout="out('8481176371776030575');" style=""> 236              if (&quot;image/gif&quot;.equals(mimeType)) {                                                                   </span>
<span class="6692235241863720447" onmouseenter="enter('6692235241863720447');" onmouseout="out('6692235241863720447');" style=""> 237                  mimeType = &quot;image/png&quot;;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 238              }                                                                                                     </span>
<span class="-5770017993670818757" onmouseenter="enter('-5770017993670818757');" onmouseout="out('-5770017993670818757');" style=""> 239              return buildModel(cacheFile.getAbsolutePath(), mimeType);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 240          }                                                                                                         </span>

















<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 241      }                                                                                                             </span>
<span  style=""> 242                                                                                                                    </span>
<span class="-5129110647668669753" onmouseenter="enter('-5129110647668669753');" onmouseout="out('-5129110647668669753');" style=""> 243      protected Map&lt;String, String&gt; buildModel(String returnFilePath, String mimeType) {                            </span>
<span class="-5436835504658380993" onmouseenter="enter('-5436835504658380993');" onmouseout="out('-5436835504658380993');" style=""> 244          Map&lt;String, String&gt; model = new HashMap&lt;String, String&gt;(2);                                               </span>
<span class="-7931157778314956360" onmouseenter="enter('-7931157778314956360');" onmouseout="out('-7931157778314956360');" style=""> 245          model.put(&quot;cacheFilePath&quot;, returnFilePath);                                                               </span>
<span class="-121481178440989733" onmouseenter="enter('-121481178440989733');" onmouseout="out('-121481178440989733');" style=""> 246          model.put(&quot;mimeType&quot;, mimeType);                                                                          </span>
<span  style=""> 247                                                                                                                    </span>
<span class="1327412617440986435" onmouseenter="enter('1327412617440986435');" onmouseout="out('1327412617440986435');" style=""> 248          return model;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 249      }                                                                                                             </span>
<span  style=""> 250                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 251      @Override                                                                                                     </span>
<span class="-2260190509208115003" onmouseenter="enter('-2260190509208115003');" onmouseout="out('-2260190509208115003');" style=""> 252      public StaticAssetStorage findStaticAssetStorageById(final Long id) {                                         </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 253          final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                           </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 254          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 255              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 256              public void execute() {                                                                               </span>
<span class="-2207751287529111136" onmouseenter="enter('-2207751287529111136');" onmouseout="out('-2207751287529111136');" style=""> 257                  storage[0] = staticAssetStorageDao.readStaticAssetStorageById(id);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 258              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 259          }, RuntimeException.class);                                                                               </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 260          return storage[0];                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261      }                                                                                                             </span>
<span  style=""> 262                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 263      @Override                                                                                                     </span>
<span class="-2864285839814759705" onmouseenter="enter('-2864285839814759705');" onmouseout="out('-2864285839814759705');" style=""> 264      public StaticAssetStorage create() {                                                                          </span>
<span class="-1873403527653357243" onmouseenter="enter('-1873403527653357243');" onmouseout="out('-1873403527653357243');" style=""> 265          return staticAssetStorageDao.create();                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 266      }                                                                                                             </span>
<span  style=""> 267                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 268      @Override                                                                                                     </span>
<span class="7662571466653582755" onmouseenter="enter('7662571466653582755');" onmouseout="out('7662571466653582755');" style=""> 269      public StaticAssetStorage readStaticAssetStorageByStaticAssetId(final Long id) {                              </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 270          final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                           </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 271          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 272              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 273              public void execute() {                                                                               </span>
<span class="8795705063184424946" onmouseenter="enter('8795705063184424946');" onmouseout="out('8795705063184424946');" style=""> 274                  storage[0] = staticAssetStorageDao.readStaticAssetStorageByStaticAssetId(id);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 275              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 276          }, RuntimeException.class);                                                                               </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 277          return storage[0];                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 278      }                                                                                                             </span>
<span  style=""> 279                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 280      @Override                                                                                                     </span>
<span class="6485967695518229819" onmouseenter="enter('6485967695518229819');" onmouseout="out('6485967695518229819');" style=""> 281      public StaticAssetStorage save(final StaticAssetStorage assetStorage) {                                       </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 282          final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                           </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 283          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 284              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 285              public void execute() {                                                                               </span>
<span class="-6036718856004453538" onmouseenter="enter('-6036718856004453538');" onmouseout="out('-6036718856004453538');" style=""> 286                  storage[0] = staticAssetStorageDao.save(assetStorage);                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 287              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 288          }, RuntimeException.class);                                                                               </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 289          return storage[0];                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 290      }                                                                                                             </span>
<span  style=""> 291                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 292      @Override                                                                                                     </span>
<span class="7860976460954721267" onmouseenter="enter('7860976460954721267');" onmouseout="out('7860976460954721267');" style=""> 293      public void delete(final StaticAssetStorage assetStorage) {                                                   </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 294          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 295              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 296              public void execute() {                                                                               </span>
<span class="5167138969991588867" onmouseenter="enter('5167138969991588867');" onmouseout="out('5167138969991588867');" style=""> 297                  staticAssetStorageDao.delete(assetStorage);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 298              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 299          }, RuntimeException.class);                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 300      }                                                                                                             </span>
<span  style=""> 301                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 302      @Override                                                                                                     </span>
<span class="-1910899245286681437" onmouseenter="enter('-1910899245286681437');" onmouseout="out('-1910899245286681437');" style=""> 303      public Blob createBlob(final MultipartFile uploadedFile) throws IOException {                                 </span>
<span class="848437443390195780" onmouseenter="enter('848437443390195780');" onmouseout="out('848437443390195780');" style=""> 304          final Blob[] blob = new Blob[1];                                                                          </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 305          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 306              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 307              public void execute() {                                                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 308                  try {                                                                                             </span>
<span class="3702070050705863788" onmouseenter="enter('3702070050705863788');" onmouseout="out('3702070050705863788');" style=""> 309                      blob[0] = staticAssetStorageDao.createBlob(uploadedFile);                                     </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 310                  } catch (IOException e) {                                                                         </span>
<span class="5116711708032073694" onmouseenter="enter('5116711708032073694');" onmouseout="out('5116711708032073694');" style=""> 311                      LOG.error(&quot;Unable to create blob from MultipartFile.&quot;, e);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 312                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 313              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 314          }, RuntimeException.class);                                                                               </span>
<span class="-3204915544472573462" onmouseenter="enter('-3204915544472573462');" onmouseout="out('-3204915544472573462');" style=""> 315          return blob[0];                                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 316      }                                                                                                             </span>
<span  style=""> 317                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 318      @Override                                                                                                     </span>
<span class="4382666547830473388" onmouseenter="enter('4382666547830473388');" onmouseout="out('4382666547830473388');" style=""> 319      public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOException {   </span>
<span class="848437443390195780" onmouseenter="enter('848437443390195780');" onmouseout="out('848437443390195780');" style=""> 320          final Blob[] blob = new Blob[1];                                                                          </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 321          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 322              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 323              public void execute() {                                                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 324                  try {                                                                                             </span>
<span class="-8405931859176759523" onmouseenter="enter('-8405931859176759523');" onmouseout="out('-8405931859176759523');" style=""> 325                      blob[0] = staticAssetStorageDao.createBlob(uploadedFileInputStream, fileSize);                </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 326                  } catch (IOException e) {                                                                         </span>
<span class="10365894759289852" onmouseenter="enter('10365894759289852');" onmouseout="out('10365894759289852');" style=""> 327                      LOG.error(&quot;Unable to create blob from InputStream.&quot;, e);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 328                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 329              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 330          }, RuntimeException.class);                                                                               </span>
<span class="-3204915544472573462" onmouseenter="enter('-3204915544472573462');" onmouseout="out('-3204915544472573462');" style=""> 331          return blob[0];                                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 332      }                                                                                                             </span>
<span  style=""> 333                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 334      /**                                                                                                           </span>
<span class="1204867681485950258" onmouseenter="enter('1204867681485950258');" onmouseout="out('1204867681485950258');" style=""> 335       * Builds a file system path for the passed in static asset and paramaterMap.                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 336       *                                                                                                            </span>
<span class="-8533974154884571802" onmouseenter="enter('-8533974154884571802');" onmouseout="out('-8533974154884571802');" style=""> 337       * @param staticAsset                                                                                         </span>
<span class="1550808242639330275" onmouseenter="enter('1550808242639330275');" onmouseout="out('1550808242639330275');" style=""> 338       * @param parameterMap                                                                                        </span>
<span class="966966680655938311" onmouseenter="enter('966966680655938311');" onmouseout="out('966966680655938311');" style=""> 339       * @param useSharedFile                                                                                       </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 340       * @return                                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 341       */                                                                                                           </span>
<span class="9052993107782234324" onmouseenter="enter('9052993107782234324');" onmouseout="out('9052993107782234324');" style=""> 342      protected String constructCacheFileName(StaticAsset staticAsset, Map&lt;String, String&gt; parameterMap) {          </span>
<span class="6966748151173677546" onmouseenter="enter('6966748151173677546');" onmouseout="out('6966748151173677546');" style=""> 343          String fileName = staticAsset.getFullUrl();                                                               </span>
<span  style=""> 344                                                                                                                    </span>
<span class="-4507417291042206746" onmouseenter="enter('-4507417291042206746');" onmouseout="out('-4507417291042206746');" style=""> 345          StringBuilder sb = new StringBuilder(200);                                                                </span>
<span class="-483528478759561910" onmouseenter="enter('-483528478759561910');" onmouseout="out('-483528478759561910');" style=""> 346          sb.append(fileName.substring(0, fileName.lastIndexOf(&#x27;.&#x27;)));                                              </span>
<span class="4093974766537940594" onmouseenter="enter('4093974766537940594');" onmouseout="out('4093974766537940594');" style=""> 347          sb.append(&quot;---&quot;);                                                                                         </span>
<span  style=""> 348                                                                                                                    </span>
<span class="3988790927371777098" onmouseenter="enter('3988790927371777098');" onmouseout="out('3988790927371777098');" style=""> 349          StringBuilder sb2 = new StringBuilder(200);                                                               </span>
<span class="1220298265095205393" onmouseenter="enter('1220298265095205393');" onmouseout="out('1220298265095205393');" style=""> 350          SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd-HH-mm-ss&quot;);                                    </span>
<span class="8844493969073287544" onmouseenter="enter('8844493969073287544');" onmouseout="out('8844493969073287544');" style=""> 351          if (staticAsset instanceof Auditable) {                                                                   </span>
<span class="-4932550937064679086" onmouseenter="enter('-4932550937064679086');" onmouseout="out('-4932550937064679086');" style=""> 352              Auditable auditableStaticAsset = (Auditable) staticAsset;                                             </span>
<span class="2764706875669982552" onmouseenter="enter('2764706875669982552');" onmouseout="out('2764706875669982552');" style=""><abbr title=" 353              sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCreated() : auditableStaticAsset.getDateUpdated()));"> 353              sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 354          }                                                                                                         </span>
<span  style=""> 355                                                                                                                    </span>
<span class="-9176202731662601074" onmouseenter="enter('-9176202731662601074');" onmouseout="out('-9176202731662601074');" style=""> 356          if (parameterMap != null) {                                                                               </span>
<span class="-8466079002823576232" onmouseenter="enter('-8466079002823576232');" onmouseout="out('-8466079002823576232');" style=""> 357              for (Map.Entry&lt;String, String&gt; entry : parameterMap.entrySet()) {                                     </span>
<span class="-5538998764085201912" onmouseenter="enter('-5538998764085201912');" onmouseout="out('-5538998764085201912');" style=""> 358                  sb2.append(&#x27;-&#x27;);                                                                                  </span>
<span class="2475309890837225957" onmouseenter="enter('2475309890837225957');" onmouseout="out('2475309890837225957');" style=""> 359                  sb2.append(entry.getKey());                                                                       </span>
<span class="-5538998764085201912" onmouseenter="enter('-5538998764085201912');" onmouseout="out('-5538998764085201912');" style=""> 360                  sb2.append(&#x27;-&#x27;);                                                                                  </span>
<span class="7337918225958425753" onmouseenter="enter('7337918225958425753');" onmouseout="out('7337918225958425753');" style=""> 361                  sb2.append(entry.getValue());                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 362              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 363          }                                                                                                         </span>
<span  style=""> 364                                                                                                                    </span>
<span class="-3611986260301585228" onmouseenter="enter('-3611986260301585228');" onmouseout="out('-3611986260301585228');" style=""> 365          String digest;                                                                                            </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 366          try {                                                                                                     </span>
<span class="-6955618976542935940" onmouseenter="enter('-6955618976542935940');" onmouseout="out('-6955618976542935940');" style=""> 367              MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);                                                  </span>
<span class="-42474679596396087" onmouseenter="enter('-42474679596396087');" onmouseout="out('-42474679596396087');" style=""> 368              byte[] messageDigest = md.digest(sb2.toString().getBytes());                                          </span>
<span class="-5380974963518813864" onmouseenter="enter('-5380974963518813864');" onmouseout="out('-5380974963518813864');" style=""> 369              BigInteger number = new BigInteger(1,messageDigest);                                                  </span>
<span class="5844706554126289727" onmouseenter="enter('5844706554126289727');" onmouseout="out('5844706554126289727');" style=""> 370              digest = number.toString(16);                                                                         </span>
<span class="-4215171220869553942" onmouseenter="enter('-4215171220869553942');" onmouseout="out('-4215171220869553942');" style=""> 371          } catch(NoSuchAlgorithmException e) {                                                                     </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 372              throw new RuntimeException(e);                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 373          }                                                                                                         </span>
<span  style=""> 374                                                                                                                    </span>
<span class="-5802237960969046083" onmouseenter="enter('-5802237960969046083');" onmouseout="out('-5802237960969046083');" style=""> 375          sb.append(pad(digest, 32, &#x27;0&#x27;));                                                                          </span>
<span class="-4790971325793185911" onmouseenter="enter('-4790971325793185911');" onmouseout="out('-4790971325793185911');" style=""> 376          sb.append(fileName.substring(fileName.lastIndexOf(&#x27;.&#x27;)));                                                 </span>
<span  style=""> 377                                                                                                                    </span>
<span class="-6276773404435993532" onmouseenter="enter('-6276773404435993532');" onmouseout="out('-6276773404435993532');" style=""> 378          return sb.toString();                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 379      }                                                                                                             </span>
<span  style=""> 380                                                                                                                    </span>
<span class="3889823321692711159" onmouseenter="enter('3889823321692711159');" onmouseout="out('3889823321692711159');" style=""> 381      protected String pad(String s, int length, char pad) {                                                        </span>
<span class="445211846679573021" onmouseenter="enter('445211846679573021');" onmouseout="out('445211846679573021');" style=""> 382          StringBuilder buffer = new StringBuilder(s);                                                              </span>
<span class="-1767419613255418829" onmouseenter="enter('-1767419613255418829');" onmouseout="out('-1767419613255418829');" style=""> 383          while (buffer.length() &lt; length) {                                                                        </span>
<span class="5619102104931061603" onmouseenter="enter('5619102104931061603');" onmouseout="out('5619102104931061603');" style=""> 384              buffer.insert(0, pad);                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 385          }                                                                                                         </span>
<span class="-2038716794812902958" onmouseenter="enter('-2038716794812902958');" onmouseout="out('-2038716794812902958');" style=""> 386          return buffer.toString();                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 387      }                                                                                                             </span>
<span  style=""> 388                                                                                                                    </span>
<span class="8674831860571754100" onmouseenter="enter('8674831860571754100');" onmouseout="out('8674831860571754100');" style=""> 389      @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)                                                        </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 390      @Override                                                                                                     </span>
<span class="124994076020326784" onmouseenter="enter('124994076020326784');" onmouseout="out('124994076020326784');" style=""> 391      public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOException {</span>
<span class="-2118089514208048024" onmouseenter="enter('-2118089514208048024');" onmouseout="out('-2118089514208048024');" style=""> 392          createStaticAssetStorage(file.getInputStream(), staticAsset);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 393      }                                                                                                             </span>
<span  style=""> 394                                                                                                                    </span>
<span class="8674831860571754100" onmouseenter="enter('8674831860571754100');" onmouseout="out('8674831860571754100');" style=""> 395      @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)                                                        </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 396      @Override                                                                                                     </span>
<span class="-850236438741332732" onmouseenter="enter('-850236438741332732');" onmouseout="out('-850236438741332732');" style=""><abbr title=" 397      public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException {"> 397      public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException ðŸ”µ</abbr></span>
<span class="-1403207369962524759" onmouseenter="enter('-1403207369962524759');" onmouseout="out('-1403207369962524759');" style=""> 398          if (StorageType.DATABASE.equals(staticAsset.getStorageType())) {                                          </span>
<span class="-1939605028615766275" onmouseenter="enter('-1939605028615766275');" onmouseout="out('-1939605028615766275');" style=""> 399              StaticAssetStorage storage = create();                                                                </span>
<span class="-204637599683518602" onmouseenter="enter('-204637599683518602');" onmouseout="out('-204637599683518602');" style=""> 400              storage.setStaticAssetId(staticAsset.getId());                                                        </span>
<span class="1384418291306141967" onmouseenter="enter('1384418291306141967');" onmouseout="out('1384418291306141967');" style=""> 401              Blob uploadBlob = createBlob(fileInputStream, staticAsset.getFileSize());                             </span>
<span class="6866380704006125127" onmouseenter="enter('6866380704006125127');" onmouseout="out('6866380704006125127');" style=""> 402              storage.setFileData(uploadBlob);                                                                      </span>
<span class="-2840973363991180880" onmouseenter="enter('-2840973363991180880');" onmouseout="out('-2840973363991180880');" style=""> 403              save(storage);                                                                                        </span>
<span class="-2132857837912478262" onmouseenter="enter('-2132857837912478262');" onmouseout="out('-2132857837912478262');" style=""> 404          } else if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {                                 </span>
<span class="-4012729166374721308" onmouseenter="enter('-4012729166374721308');" onmouseout="out('-4012729166374721308');" style=""> 405              FileWorkArea tempWorkArea = broadleafFileService.initializeWorkArea();                                </span>
<span class="-4881648785169426910" onmouseenter="enter('-4881648785169426910');" onmouseout="out('-4881648785169426910');" style=""> 406              // Convert the given URL from the asset to a system-specific suitable file path                       </span>
<span class="-6260899414746866851" onmouseenter="enter('-6260899414746866851');" onmouseout="out('-6260899414746866851');" style=""><abbr title=" 407              String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FilenameUtils.separatorsToSystem(staticAsset.getFullUrl()));"> 407              String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FiðŸ”µ</abbr></span>
<span  style=""> 408                                                                                                                    </span>
<span class="2773091736631403971" onmouseenter="enter('2773091736631403971');" onmouseout="out('2773091736631403971');" style=""> 409              InputStream input = fileInputStream;                                                                  </span>
<span class="6832533006494732607" onmouseenter="enter('6832533006494732607');" onmouseout="out('6832533006494732607');" style=""> 410              byte[] buffer = new byte[getFileBufferSize()];                                                        </span>
<span  style=""> 411                                                                                                                    </span>
<span class="-6502247887775821258" onmouseenter="enter('-6502247887775821258');" onmouseout="out('-6502247887775821258');" style=""> 412              File destFile = new File(destFileName);                                                               </span>
<span class="-695082894467535606" onmouseenter="enter('-695082894467535606');" onmouseout="out('-695082894467535606');" style=""> 413              if (!destFile.getParentFile().exists()) {                                                             </span>
<span class="8653794664879930122" onmouseenter="enter('8653794664879930122');" onmouseout="out('8653794664879930122');" style=""> 414                  if (!destFile.getParentFile().mkdirs()) {                                                         </span>
<span class="-695082894467535606" onmouseenter="enter('-695082894467535606');" onmouseout="out('-695082894467535606');" style=""> 415                      if (!destFile.getParentFile().exists()) {                                                     </span>
<span class="5433889739361026965" onmouseenter="enter('5433889739361026965');" onmouseout="out('5433889739361026965');" style=""><abbr title=" 416                          throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileName);"> 416                          throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileNameðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 418                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 419              }                                                                                                     </span>
<span  style=""> 420                                                                                                                    </span>
<span class="6445829042907396164" onmouseenter="enter('6445829042907396164');" onmouseout="out('6445829042907396164');" style=""> 421              OutputStream output = new FileOutputStream(destFile);                                                 </span>
<span class="-5038889493716933228" onmouseenter="enter('-5038889493716933228');" onmouseout="out('-5038889493716933228');" style=""> 422              long maxFileSize = getMaxUploadSizeForFile(destFileName);                                             </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 423              try {                                                                                                 </span>
<span class="-7067986891170572893" onmouseenter="enter('-7067986891170572893');" onmouseout="out('-7067986891170572893');" style=""> 424                  int bytesRead;                                                                                    </span>
<span class="5297046094019116056" onmouseenter="enter('5297046094019116056');" onmouseout="out('5297046094019116056');" style=""> 425                  int totalBytesRead = 0;                                                                           </span>
<span class="-7676219729156525464" onmouseenter="enter('-7676219729156525464');" onmouseout="out('-7676219729156525464');" style=""> 426                  while ((bytesRead = input.read(buffer)) != -1) {                                                  </span>
<span class="-6799238023814913099" onmouseenter="enter('-6799238023814913099');" onmouseout="out('-6799238023814913099');" style=""> 427                      totalBytesRead += bytesRead;                                                                  </span>
<span class="775261430666212722" onmouseenter="enter('775261430666212722');" onmouseout="out('775261430666212722');" style=""> 428                      if (totalBytesRead &gt; maxFileSize) {                                                           </span>
<span class="-104032706615660809" onmouseenter="enter('-104032706615660809');" onmouseout="out('-104032706615660809');" style=""> 429                          throw new IOException(&quot;Maximum Upload File Size Exceeded&quot;);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 430                      }                                                                                             </span>
<span class="6143107777038809767" onmouseenter="enter('6143107777038809767');" onmouseout="out('6143107777038809767');" style=""> 431                      output.write(buffer, 0, bytesRead);                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 432                  }                                                                                                 </span>
<span  style=""> 433                                                                                                                    </span>
<span class="-3636717142636833723" onmouseenter="enter('-3636717142636833723');" onmouseout="out('-3636717142636833723');" style=""> 434                  // close the output file stream prior to moving files around                                      </span>
<span class="-7467153277872057229" onmouseenter="enter('-7467153277872057229');" onmouseout="out('-7467153277872057229');" style=""> 435                  output.close();                                                                                   </span>
<span class="-7014270169952325099" onmouseenter="enter('-7014270169952325099');" onmouseout="out('-7014270169952325099');" style=""> 436                  broadleafFileService.addOrUpdateResource(tempWorkArea, destFile, false);                          </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 437              } finally {                                                                                           </span>
<span class="4174609820499721765" onmouseenter="enter('4174609820499721765');" onmouseout="out('4174609820499721765');" style=""> 438                  IOUtils.closeQuietly(output);                                                                     </span>
<span class="5684068854007703140" onmouseenter="enter('5684068854007703140');" onmouseout="out('5684068854007703140');" style=""> 439                  broadleafFileService.closeWorkArea(tempWorkArea);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 440              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 441          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 442      }                                                                                                             </span>
<span  style=""> 443                                                                                                                    </span>
<span class="7880420848062709346" onmouseenter="enter('7880420848062709346');" onmouseout="out('7880420848062709346');" style=""> 444      protected long getMaxUploadSizeForFile(String fileName) {                                                     </span>
<span class="-8299331750570909154" onmouseenter="enter('-8299331750570909154');" onmouseout="out('-8299331750570909154');" style=""> 445          if (isImageFile(fileName)) {                                                                              </span>
<span class="-8904535810123442239" onmouseenter="enter('-8904535810123442239');" onmouseout="out('-8904535810123442239');" style=""> 446              return getMaxUploadableImageSize();                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 447          }                                                                                                         </span>
<span  style=""> 448                                                                                                                    </span>
<span class="7342651561788072273" onmouseenter="enter('7342651561788072273');" onmouseout="out('7342651561788072273');" style=""> 449          return getMaxUploadableFileSize();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 450      }                                                                                                             </span>
<span  style=""> 451                                                                                                                    </span>
<span class="-4256605375867072165" onmouseenter="enter('-4256605375867072165');" onmouseout="out('-4256605375867072165');" style=""> 452      protected boolean isImageFile(String fileName) {                                                              </span>
<span class="-7215778148857055723" onmouseenter="enter('-7215778148857055723');" onmouseout="out('-7215778148857055723');" style=""> 453          String extension = getFileExtension(fileName);                                                            </span>
<span  style=""> 454                                                                                                                    </span>
<span class="868046925461100818" onmouseenter="enter('868046925461100818');" onmouseout="out('868046925461100818');" style=""> 455          for (String imageFileExtension : getAdminImageFileExtensions()) {                                         </span>
<span class="-1882310683799532334" onmouseenter="enter('-1882310683799532334');" onmouseout="out('-1882310683799532334');" style=""> 456              if (imageFileExtension.equalsIgnoreCase(extension)) {                                                 </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 457                  return true;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 458              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 459          }                                                                                                         </span>
<span  style=""> 460                                                                                                                    </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 461          return false;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 462      }                                                                                                             </span>
<span  style=""> 463                                                                                                                    </span>
<span class="-4067859991978763128" onmouseenter="enter('-4067859991978763128');" onmouseout="out('-4067859991978763128');" style=""> 464      protected String getFileExtension(String assetPath) {                                                         </span>
<span class="-7365160516150097212" onmouseenter="enter('-7365160516150097212');" onmouseout="out('-7365160516150097212');" style=""> 465          int extensionStartIndex = assetPath.lastIndexOf(&quot;.&quot;) + 1;                                                 </span>
<span class="3165050002785748305" onmouseenter="enter('3165050002785748305');" onmouseout="out('3165050002785748305');" style=""> 466          return assetPath.substring(extensionStartIndex);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 467      }                                                                                                             </span>
<span  style=""> 468                                                                                                                    </span>
<span class="8520324044054424760" onmouseenter="enter('8520324044054424760');" onmouseout="out('8520324044054424760');" style=""> 469      protected long getMaxUploadableFileSize() {                                                                   </span>
<span class="-8242800191702968016" onmouseenter="enter('-8242800191702968016');" onmouseout="out('-8242800191702968016');" style=""> 470          Long blcUploadSize = env.getProperty(&quot;asset.server.max.uploadable.file.size&quot;, Long.class);                </span>
<span class="-6815277628371519591" onmouseenter="enter('-6815277628371519591');" onmouseout="out('-6815277628371519591');" style=""> 471          if (blcUploadSize != null) {                                                                              </span>
<span class="-2122879694774875974" onmouseenter="enter('-2122879694774875974');" onmouseout="out('-2122879694774875974');" style=""> 472              return blcUploadSize;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 473          }                                                                                                         </span>
<span  style=""> 474                                                                                                                    </span>
<span class="-83413303193047685" onmouseenter="enter('-83413303193047685');" onmouseout="out('-83413303193047685');" style=""> 475          if (defaultMultipartSettings != null) {                                                                   </span>
<span class="3781451292667627704" onmouseenter="enter('3781451292667627704');" onmouseout="out('3781451292667627704');" style=""> 476              return defaultMultipartSettings.createMultipartConfig().getMaxFileSize();                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 477          }                                                                                                         </span>
<span class="8028643923497516300" onmouseenter="enter('8028643923497516300');" onmouseout="out('8028643923497516300');" style=""> 478          return DEFAULT_ASSET_UPLOAD_SIZE;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 479      }                                                                                                             </span>
<span  style=""> 480                                                                                                                    </span>
<span class="-4925501260426057745" onmouseenter="enter('-4925501260426057745');" onmouseout="out('-4925501260426057745');" style=""> 481      protected long getMaxUploadableImageSize() {                                                                  </span>
<span class="2537324483761513782" onmouseenter="enter('2537324483761513782');" onmouseout="out('2537324483761513782');" style=""> 482          // backwards-compatibility checks, only use the image-size specific property if it is                     </span>
<span class="4617761826312627412" onmouseenter="enter('4617761826312627412');" onmouseout="out('4617761826312627412');" style=""> 483          // not the default value. Otherwise, delegate to the old property                                         </span>
<span class="7612408840010340391" onmouseenter="enter('7612408840010340391');" onmouseout="out('7612408840010340391');" style=""> 484          Long maxImgSize = env.getProperty(&quot;asset.server.max.uploadable.image.size&quot;, Long.class);                  </span>
<span class="-430636607829496210" onmouseenter="enter('-430636607829496210');" onmouseout="out('-430636607829496210');" style=""> 485          if (maxImgSize == null) {                                                                                 </span>
<span class="7342651561788072273" onmouseenter="enter('7342651561788072273');" onmouseout="out('7342651561788072273');" style=""> 486              return getMaxUploadableFileSize();                                                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 487          } else {                                                                                                  </span>
<span class="-7468174336769267749" onmouseenter="enter('-7468174336769267749');" onmouseout="out('-7468174336769267749');" style=""> 488              return maxImgSize;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 489          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 490      }                                                                                                             </span>
<span  style=""> 491                                                                                                                    </span>
<span class="3561631998050563638" onmouseenter="enter('3561631998050563638');" onmouseout="out('3561631998050563638');" style=""> 492      protected int getFileBufferSize() {                                                                           </span>
<span class="6759418199922005006" onmouseenter="enter('6759418199922005006');" onmouseout="out('6759418199922005006');" style=""> 493          return env.getProperty(&quot;asset.server.file.buffer.size&quot;, int.class, DEFAULT_BUFFER_SIZE);                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 494      }                                                                                                             </span>
<span  style=""> 495                                                                                                                    </span>
<span class="-7892865232186196236" onmouseenter="enter('-7892865232186196236');" onmouseout="out('-7892865232186196236');" style=""> 496      protected List&lt;String&gt; getAdminImageFileExtensions() {                                                        </span>
<span class="4831601876827029435" onmouseenter="enter('4831601876827029435');" onmouseout="out('4831601876827029435');" style=""><abbr title=" 497          String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENSIONS);"> 497          String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENðŸ”µ</abbr></span>
<span class="-1830661333141003565" onmouseenter="enter('-1830661333141003565');" onmouseout="out('-1830661333141003565');" style=""> 498          return Arrays.asList(extensions.split(&quot;,&quot;));                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 499      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 500  }                                                                                                                 </span></pre></td>
                            <td><pre><span class="4534359625031764666" onmouseenter="enter('4534359625031764666');" onmouseout="out('4534359625031764666');" style="">   1  /*                                                                                                                </span>
<span class="7283730021202772321" onmouseenter="enter('7283730021202772321');" onmouseout="out('7283730021202772321');" style="">   2   * #%L                                                                                                            </span>
<span class="-6173756248845875922" onmouseenter="enter('-6173756248845875922');" onmouseout="out('-6173756248845875922');" style="">   3   * BroadleafCommerce CMS Module                                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   4   * %%                                                                                                             </span>
<span class="1978304592184257722" onmouseenter="enter('1978304592184257722');" onmouseout="out('1978304592184257722');" style="">   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce                                                                   </span>
<span class="305149960078729975" onmouseenter="enter('305149960078729975');" onmouseout="out('305149960078729975');" style="">   6   * %%                                                                                                             </span>
<span class="4430451662992926684" onmouseenter="enter('4430451662992926684');" onmouseout="out('4430451662992926684');" style="">   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0                                           </span>
<span class="8206099442596739681" onmouseenter="enter('8206099442596739681');" onmouseout="out('8206099442596739681');" style="">   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)             </span>
<span class="-4338570431005413339" onmouseenter="enter('-4338570431005413339');" onmouseout="out('-4338570431005413339');" style="">   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case             </span>
<span class="-5739615313038505012" onmouseenter="enter('-5739615313038505012');" onmouseout="out('-5739615313038505012');" style="">  10   * the Broadleaf End User License Agreement (EULA), Version 1.1                                                   </span>
<span class="-196756316119086558" onmouseenter="enter('-196756316119086558');" onmouseout="out('-196756316119086558');" style="">  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)          </span>
<span class="-3691518077331372763" onmouseenter="enter('-3691518077331372763');" onmouseout="out('-3691518077331372763');" style="">  12   * shall apply.                                                                                                   </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style="">  13   *                                                                                                                </span>
<span class="-3333434530440420199" onmouseenter="enter('-3333434530440420199');" onmouseout="out('-3333434530440420199');" style=""><abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span class="-2556272520656899284" onmouseenter="enter('-2556272520656899284');" onmouseout="out('-2556272520656899284');" style="">  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span class="3739716589509259313" onmouseenter="enter('3739716589509259313');" onmouseout="out('3739716589509259313');" style="">  16   * #L%                                                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  17   */                                                                                                               </span>
<span class="-2980987384224312133" onmouseenter="enter('-2980987384224312133');" onmouseout="out('-2980987384224312133');" style="">  18  package org.broadleafcommerce.cms.file.service;                                                                   </span>
<span  style="">  19                                                                                                                    </span>
<span class="650718985643898152" onmouseenter="enter('650718985643898152');" onmouseout="out('650718985643898152');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  20 +import org.apache.commons.collections4.MapUtils;                                                                  </span>
<span class="1592055122970313625" onmouseenter="enter('1592055122970313625');" onmouseout="out('1592055122970313625');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import org.apache.commons.io.FileExistsException;                                                                 </span>
<span class="1419696606949779000" onmouseenter="enter('1419696606949779000');" onmouseout="out('1419696606949779000');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.apache.commons.io.FileUtils;                                                                           </span>
<span class="-2296051308340473600" onmouseenter="enter('-2296051308340473600');" onmouseout="out('-2296051308340473600');" style="">  23  import org.apache.commons.io.FilenameUtils;                                                                       </span>
<span class="-7541571572495339903" onmouseenter="enter('-7541571572495339903');" onmouseout="out('-7541571572495339903');" style="">  24  import org.apache.commons.io.IOUtils;                                                                             </span>
<span class="-7366736394295216840" onmouseenter="enter('-7366736394295216840');" onmouseout="out('-7366736394295216840');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  25 +import org.apache.commons.lang.ArrayUtils;                                                                        </span>
<span class="-8105670274694144339" onmouseenter="enter('-8105670274694144339');" onmouseout="out('-8105670274694144339');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import org.apache.commons.lang3.StringUtils;                                                                      </span>
<span class="494203924075255110" onmouseenter="enter('494203924075255110');" onmouseout="out('494203924075255110');" style="">  27  import org.apache.commons.logging.Log;                                                                            </span>
<span class="-8227491862907452788" onmouseenter="enter('-8227491862907452788');" onmouseout="out('-8227491862907452788');" style="">  28  import org.apache.commons.logging.LogFactory;                                                                     </span>
<span class="6421182070533632471" onmouseenter="enter('6421182070533632471');" onmouseout="out('6421182070533632471');" style="">  29  import org.broadleafcommerce.cms.common.AssetNotFoundException;                                                   </span>
<span class="8163806430712317298" onmouseenter="enter('8163806430712317298');" onmouseout="out('8163806430712317298');" style="">  30  import org.broadleafcommerce.cms.field.type.StorageType;                                                          </span>
<span class="-8427882675756262690" onmouseenter="enter('-8427882675756262690');" onmouseout="out('-8427882675756262690');" style="">  31  import org.broadleafcommerce.cms.file.dao.StaticAssetStorageDao;                                                  </span>
<span class="1355270185972111851" onmouseenter="enter('1355270185972111851');" onmouseout="out('1355270185972111851');" style="">  32  import org.broadleafcommerce.cms.file.domain.StaticAsset;                                                         </span>
<span class="-9103956258218147401" onmouseenter="enter('-9103956258218147401');" onmouseout="out('-9103956258218147401');" style="">  33  import org.broadleafcommerce.cms.file.domain.StaticAssetStorage;                                                  </span>
<span class="9188568145725907286" onmouseenter="enter('9188568145725907286');" onmouseout="out('9188568145725907286');" style="">  34  import org.broadleafcommerce.cms.file.service.operation.NamedOperationManager;                                    </span>
<span class="-1074856182010318298" onmouseenter="enter('-1074856182010318298');" onmouseout="out('-1074856182010318298');" style="">  35  import org.broadleafcommerce.common.audit.Auditable;                                                              </span>
<span class="-7911969485500261220" onmouseenter="enter('-7911969485500261220');" onmouseout="out('-7911969485500261220');" style="">  36  import org.broadleafcommerce.common.extension.ExtensionResultHolder;                                              </span>
<span class="-8339254235515724670" onmouseenter="enter('-8339254235515724670');" onmouseout="out('-8339254235515724670');" style="">  37  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;                                          </span>
<span class="-2507677682672524762" onmouseenter="enter('-2507677682672524762');" onmouseout="out('-2507677682672524762');" style="">  38  import org.broadleafcommerce.common.file.domain.FileWorkArea;                                                     </span>
<span class="3660177375850747944" onmouseenter="enter('3660177375850747944');" onmouseout="out('3660177375850747944');" style="">  39  import org.broadleafcommerce.common.file.service.BroadleafFileService;                                            </span>
<span class="-6194024147123816671" onmouseenter="enter('-6194024147123816671');" onmouseout="out('-6194024147123816671');" style="">  40  import org.broadleafcommerce.common.file.service.GloballySharedInputStream;                                       </span>
<span class="8070124246740049341" onmouseenter="enter('8070124246740049341');" onmouseout="out('8070124246740049341');" style="">  41  import org.broadleafcommerce.common.io.ConcurrentFileOutputStream;                                                </span>
<span class="5712948414688687719" onmouseenter="enter('5712948414688687719');" onmouseout="out('5712948414688687719');" style="">  42  import org.broadleafcommerce.common.util.StreamCapableTransactionalOperationAdapter;                              </span>
<span class="3798869978454175791" onmouseenter="enter('3798869978454175791');" onmouseout="out('3798869978454175791');" style="">  43  import org.broadleafcommerce.common.util.StreamingTransactionCapableUtil;                                         </span>
<span class="-32928361580396825" onmouseenter="enter('-32928361580396825');" onmouseout="out('-32928361580396825');" style="">  44  import org.broadleafcommerce.openadmin.server.service.artifact.ArtifactService;                                   </span>
<span class="-7077569502978710918" onmouseenter="enter('-7077569502978710918');" onmouseout="out('-7077569502978710918');" style="">  45  import org.broadleafcommerce.openadmin.server.service.artifact.image.Operation;                                   </span>
<span class="-6148326362900055524" onmouseenter="enter('-6148326362900055524');" onmouseout="out('-6148326362900055524');" style="">  46  import org.springframework.beans.factory.annotation.Autowired;                                                    </span>
<span class="-7404358339654927739" onmouseenter="enter('-7404358339654927739');" onmouseout="out('-7404358339654927739');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import org.springframework.beans.factory.annotation.Value;                                                        </span>
<span class="6709227556361837386" onmouseenter="enter('6709227556361837386');" onmouseout="out('6709227556361837386');" style="">  48  import org.springframework.boot.autoconfigure.web.MultipartProperties;                                            </span>

<span class="2802840430073505079" onmouseenter="enter('2802840430073505079');" onmouseout="out('2802840430073505079');" style="">  49  import org.springframework.core.env.Environment;                                                                  </span>
<span class="-5275076188864034753" onmouseenter="enter('-5275076188864034753');" onmouseout="out('-5275076188864034753');" style="">  50  import org.springframework.stereotype.Service;                                                                    </span>
<span class="4419089678332371422" onmouseenter="enter('4419089678332371422');" onmouseout="out('4419089678332371422');" style="">  51  import org.springframework.transaction.annotation.Transactional;                                                  </span>
<span class="4828820138133011218" onmouseenter="enter('4828820138133011218');" onmouseout="out('4828820138133011218');" style="">  52  import org.springframework.web.multipart.MultipartFile;                                                           </span>
<span  style="">  53                                                                                                                    </span>
<span class="-8084092933789958161" onmouseenter="enter('-8084092933789958161');" onmouseout="out('-8084092933789958161');" style="">  54  import java.io.BufferedInputStream;                                                                               </span>
<span class="-3926401431737521278" onmouseenter="enter('-3926401431737521278');" onmouseout="out('-3926401431737521278');" style="">  55  import java.io.File;                                                                                              </span>
<span class="-535075201057145249" onmouseenter="enter('-535075201057145249');" onmouseout="out('-535075201057145249');" style="">  56  import java.io.FileInputStream;                                                                                   </span>
<span class="4915709264156936957" onmouseenter="enter('4915709264156936957');" onmouseout="out('4915709264156936957');" style="">  57  import java.io.FileOutputStream;                                                                                  </span>
<span class="103340661636203254" onmouseenter="enter('103340661636203254');" onmouseout="out('103340661636203254');" style="">  58  import java.io.IOException;                                                                                       </span>
<span class="5631563232245871054" onmouseenter="enter('5631563232245871054');" onmouseout="out('5631563232245871054');" style="">  59  import java.io.InputStream;                                                                                       </span>
<span class="4621164050749610193" onmouseenter="enter('4621164050749610193');" onmouseout="out('4621164050749610193');" style="">  60  import java.io.OutputStream;                                                                                      </span>
<span class="-40197902381950972" onmouseenter="enter('-40197902381950972');" onmouseout="out('-40197902381950972');" style="">  61  import java.math.BigInteger;                                                                                      </span>
<span class="6381430938828950472" onmouseenter="enter('6381430938828950472');" onmouseout="out('6381430938828950472');" style="">  62  import java.security.MessageDigest;                                                                               </span>
<span class="-1748023591259675388" onmouseenter="enter('-1748023591259675388');" onmouseout="out('-1748023591259675388');" style="">  63  import java.security.NoSuchAlgorithmException;                                                                    </span>
<span class="-5709181831744795488" onmouseenter="enter('-5709181831744795488');" onmouseout="out('-5709181831744795488');" style="">  64  import java.sql.Blob;                                                                                             </span>
<span class="-515559982825150111" onmouseenter="enter('-515559982825150111');" onmouseout="out('-515559982825150111');" style="">  65  import java.sql.SQLException;                                                                                     </span>
<span class="54331962280914690" onmouseenter="enter('54331962280914690');" onmouseout="out('54331962280914690');" style="">  66  import java.text.SimpleDateFormat;                                                                                </span>
<span class="-28465676010609596" onmouseenter="enter('-28465676010609596');" onmouseout="out('-28465676010609596');" style="">  67  import java.util.Arrays;                                                                                          </span>
<span class="4169599896190320038" onmouseenter="enter('4169599896190320038');" onmouseout="out('4169599896190320038');" style="">  68  import java.util.HashMap;                                                                                         </span>
<span class="-1786020958497218848" onmouseenter="enter('-1786020958497218848');" onmouseout="out('-1786020958497218848');" style="">  69  import java.util.List;                                                                                            </span>
<span class="6618655971923850695" onmouseenter="enter('6618655971923850695');" onmouseout="out('6618655971923850695');" style="">  70  import java.util.Map;                                                                                             </span>
<span  style="">  71                                                                                                                    </span>
<span class="-5292076237369528758" onmouseenter="enter('-5292076237369528758');" onmouseout="out('-5292076237369528758');" style="">  72  import javax.annotation.Resource;                                                                                 </span>
<span  style="">  73                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style="">  74  /**                                                                                                               </span>
<span class="5819561638806578074" onmouseenter="enter('5819561638806578074');" onmouseout="out('5819561638806578074');" style="">  75   * @author Jeff Fischer, Brian Polster                                                                            </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style="">  76   */                                                                                                               </span>
<span class="8555986608199362624" onmouseenter="enter('8555986608199362624');" onmouseout="out('8555986608199362624');" style="">  77  @Service(&quot;blStaticAssetStorageService&quot;)                                                                           </span>
<span class="-5440937737927857026" onmouseenter="enter('-5440937737927857026');" onmouseout="out('-5440937737927857026');" style="">  78  public class StaticAssetStorageServiceImpl implements StaticAssetStorageService {                                 </span>
<span  style="">  79                                                                                                                    </span>
<span class="2858988269359695714" onmouseenter="enter('2858988269359695714');" onmouseout="out('2858988269359695714');" style="">  80      private static final Log LOG = LogFactory.getLog(StaticAssetStorageServiceImpl.class);                        </span>
<span  style="">  81                                                                                                                    </span>
<span class="3730583078767808053" onmouseenter="enter('3730583078767808053');" onmouseout="out('3730583078767808053');" style="">  82      protected static final String DEFAULT_ADMIN_IMAGE_EXTENSIONS = &quot;bmp,jpg,jpeg,png,img,tiff,gif&quot;;               </span>
<span  style="">  83                                                                                                                    </span>
<span class="-2041789809652164219" onmouseenter="enter('-2041789809652164219');" onmouseout="out('-2041789809652164219');" style="">  84      public static final long DEFAULT_ASSET_UPLOAD_SIZE = 1024 * 1024 * 10;                                        </span>
<span  style="">  85                                                                                                                    </span>
<span class="-6481771976097152300" onmouseenter="enter('-6481771976097152300');" onmouseout="out('-6481771976097152300');" style="">  86      // 8kb default for the buffer for moving files around                                                         </span>
<span class="8173561874988853201" onmouseenter="enter('8173561874988853201');" onmouseout="out('8173561874988853201');" style="">  87      protected static final int DEFAULT_BUFFER_SIZE = 8096;                                                        </span>
<span  style="">  88                                                                                                                    </span>
<span class="5800015562641335858" onmouseenter="enter('5800015562641335858');" onmouseout="out('5800015562641335858');" style="">  89      protected String cacheDirectory;                                                                              </span>
<span  style="">  90                                                                                                                    </span>
<span class="5554564923016007608" onmouseenter="enter('5554564923016007608');" onmouseout="out('5554564923016007608');" style="">  91      @Autowired                                                                                                    </span>
<span class="-7669104425724809181" onmouseenter="enter('-7669104425724809181');" onmouseout="out('-7669104425724809181');" style="">  92      protected Environment env;                                                                                    </span>
<span  style="">  93                                                                                                                    </span>
<span class="6195905131849662055" onmouseenter="enter('6195905131849662055');" onmouseout="out('6195905131849662055');" style="">  94      @Resource(name=&quot;blStaticAssetService&quot;)                                                                        </span>
<span class="5386460834235010869" onmouseenter="enter('5386460834235010869');" onmouseout="out('5386460834235010869');" style="">  95      protected StaticAssetService staticAssetService;                                                              </span>
<span  style="">  96                                                                                                                    </span>
<span class="1752371454992115000" onmouseenter="enter('1752371454992115000');" onmouseout="out('1752371454992115000');" style="">  97      @Resource(name = &quot;blFileService&quot;)                                                                             </span>
<span class="-5836282893854406064" onmouseenter="enter('-5836282893854406064');" onmouseout="out('-5836282893854406064');" style="">  98      protected BroadleafFileService broadleafFileService;                                                          </span>
<span  style="">  99                                                                                                                    </span>
<span class="7856532409026737335" onmouseenter="enter('7856532409026737335');" onmouseout="out('7856532409026737335');" style=""> 100      @Resource(name=&quot;blArtifactService&quot;)                                                                           </span>
<span class="-5802479126948705000" onmouseenter="enter('-5802479126948705000');" onmouseout="out('-5802479126948705000');" style=""> 101      protected ArtifactService artifactService;                                                                    </span>
<span  style=""> 102                                                                                                                    </span>
<span class="-5691607332624048120" onmouseenter="enter('-5691607332624048120');" onmouseout="out('-5691607332624048120');" style=""> 103      @Resource(name=&quot;blStaticAssetStorageDao&quot;)                                                                     </span>
<span class="3341461985908719037" onmouseenter="enter('3341461985908719037');" onmouseout="out('3341461985908719037');" style=""> 104      protected StaticAssetStorageDao staticAssetStorageDao;                                                        </span>
<span  style=""> 105                                                                                                                    </span>
<span class="-8585007248377894204" onmouseenter="enter('-8585007248377894204');" onmouseout="out('-8585007248377894204');" style=""> 106      @Resource(name=&quot;blNamedOperationManager&quot;)                                                                     </span>
<span class="308482009813309658" onmouseenter="enter('308482009813309658');" onmouseout="out('308482009813309658');" style=""> 107      protected NamedOperationManager namedOperationManager;                                                        </span>
<span  style=""> 108                                                                                                                    </span>
<span class="5483516952021908632" onmouseenter="enter('5483516952021908632');" onmouseout="out('5483516952021908632');" style=""> 109      @Resource(name = &quot;blStaticAssetServiceExtensionManager&quot;)                                                      </span>
<span class="51840422594786922" onmouseenter="enter('51840422594786922');" onmouseout="out('51840422594786922');" style=""> 110      protected StaticAssetServiceExtensionManager extensionManager;                                                </span>
<span  style=""> 111                                                                                                                    </span>
<span class="6302352000387574659" onmouseenter="enter('6302352000387574659');" onmouseout="out('6302352000387574659');" style=""> 112      @Resource(name=&quot;blStreamingTransactionCapableUtil&quot;)                                                           </span>
<span class="-8080662791692885473" onmouseenter="enter('-8080662791692885473');" onmouseout="out('-8080662791692885473');" style=""> 113      protected StreamingTransactionCapableUtil transUtil;                                                          </span>
<span  style=""> 114                                                                                                                    </span>
<span class="-3151523973433667335" onmouseenter="enter('-3151523973433667335');" onmouseout="out('-3151523973433667335');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +    @Value(&quot;${image.artifact.recompress.formats:png}&quot;)                                                            </span>
<span class="4635220678002391487" onmouseenter="enter('4635220678002391487');" onmouseout="out('4635220678002391487');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +    protected String recompressFormats = &quot;png&quot;;                                                                   </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +                                                                                                                  </span>
<span class="2602789178515286342" onmouseenter="enter('2602789178515286342');" onmouseout="out('2602789178515286342');" style=""> 118      @Autowired(required = false)                                                                                  </span>
<span class="8981564986536911591" onmouseenter="enter('8981564986536911591');" onmouseout="out('8981564986536911591');" style=""> 119      protected MultipartProperties defaultMultipartSettings;                                                       </span>
<span  style=""> 120                                                                                                                    </span>
<span class="-7168779142218193311" onmouseenter="enter('-7168779142218193311');" onmouseout="out('-7168779142218193311');" style=""> 121      @Resource(name = &quot;blConcurrentFileOutputStream&quot;)                                                              </span>
<span class="-2331920133844743339" onmouseenter="enter('-2331920133844743339');" onmouseout="out('-2331920133844743339');" style=""> 122      protected ConcurrentFileOutputStream concurrentFileOutputStream;                                              </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +                                                                                                                  </span>
<span  style=""> 124                                                                                                                    </span>
<span class="-6120158187110043675" onmouseenter="enter('-6120158187110043675');" onmouseout="out('-6120158187110043675');" style=""> 125      protected StaticAsset findStaticAsset(String fullUrl) {                                                       </span>
<span class="-4171210034184470086" onmouseenter="enter('-4171210034184470086');" onmouseout="out('-4171210034184470086');" style=""> 126          StaticAsset staticAsset = staticAssetService.findStaticAssetByFullUrl(fullUrl);                           </span>
<span  style=""> 127                                                                                                                    </span>
<span class="-2128240479658154685" onmouseenter="enter('-2128240479658154685');" onmouseout="out('-2128240479658154685');" style=""> 128          return staticAsset;                                                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 129      }                                                                                                             </span>
<span  style=""> 130                                                                                                                    </span>
<span class="1529961503462031347" onmouseenter="enter('1529961503462031347');" onmouseout="out('1529961503462031347');" style=""> 131      protected boolean shouldUseSharedFile(InputStream is) {                                                       </span>
<span class="7200698625412718023" onmouseenter="enter('7200698625412718023');" onmouseout="out('7200698625412718023');" style=""> 132          return (is != null &amp;&amp; is instanceof GloballySharedInputStream);                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 133      }                                                                                                             </span>
<span  style=""> 134                                                                                                                    </span>
<span class="1502967799885308477" onmouseenter="enter('1502967799885308477');" onmouseout="out('1502967799885308477');" style=""> 135      protected File getFileFromLocalRepository(String cachedFileName) {                                            </span>
<span class="-5673162797879974066" onmouseenter="enter('-5673162797879974066');" onmouseout="out('-5673162797879974066');" style=""> 136          // Look for a shared file (this represents a file that was based on a file originally in the classpath.   </span>
<span class="-93446380402546673" onmouseenter="enter('-93446380402546673');" onmouseout="out('-93446380402546673');" style=""> 137          File cacheFile = null;                                                                                    </span>
<span class="955805546394053652" onmouseenter="enter('955805546394053652');" onmouseout="out('955805546394053652');" style=""> 138          if (extensionManager != null) {                                                                           </span>
<span class="-8112713965554756916" onmouseenter="enter('-8112713965554756916');" onmouseout="out('-8112713965554756916');" style=""> 139              ExtensionResultHolder holder = new ExtensionResultHolder();                                           </span>
<span class="-435722502969466554" onmouseenter="enter('-435722502969466554');" onmouseout="out('-435722502969466554');" style=""> 140              ExtensionResultStatusType result = extensionManager.getProxy().fileExists(cachedFileName, holder);    </span>
<span class="-2043051207329155259" onmouseenter="enter('-2043051207329155259');" onmouseout="out('-2043051207329155259');" style=""> 141              if (ExtensionResultStatusType.HANDLED.equals(result)) {                                               </span>
<span class="7653982040624486223" onmouseenter="enter('7653982040624486223');" onmouseout="out('7653982040624486223');" style=""> 142                  cacheFile = (File) holder.getResult();                                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 143              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 144          }                                                                                                         </span>
<span class="-8813269293199686205" onmouseenter="enter('-8813269293199686205');" onmouseout="out('-8813269293199686205');" style=""> 145          if (cacheFile == null) {                                                                                  </span>
<span class="-8910009845238484526" onmouseenter="enter('-8910009845238484526');" onmouseout="out('-8910009845238484526');" style=""> 146              cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 147          }                                                                                                         </span>
<span class="-2028153032285377680" onmouseenter="enter('-2028153032285377680');" onmouseout="out('-2028153032285377680');" style=""> 148          if (cacheFile.exists()) {                                                                                 </span>
<span class="8210317951176929256" onmouseenter="enter('8210317951176929256');" onmouseout="out('8210317951176929256');" style=""> 149              return cacheFile;                                                                                     </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 150          } else {                                                                                                  </span>
<span class="5496227938366649270" onmouseenter="enter('5496227938366649270');" onmouseout="out('5496227938366649270');" style=""> 151              return broadleafFileService.getLocalResource(cachedFileName);                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 152          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 153      }                                                                                                             </span>
<span  style=""> 154                                                                                                                    </span>
<span class="-9138520702166900061" onmouseenter="enter('-9138520702166900061');" onmouseout="out('-9138520702166900061');" style=""> 155      protected File lookupAssetAndCreateLocalFile(StaticAsset staticAsset, File baseLocalFile)                     </span>
<span class="452573679482946095" onmouseenter="enter('452573679482946095');" onmouseout="out('452573679482946095');" style=""> 156              throws IOException, SQLException {                                                                    </span>
<span class="-7742266551317191943" onmouseenter="enter('-7742266551317191943');" onmouseout="out('-7742266551317191943');" style=""> 157          if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {                                        </span>
<span class="-4354847567179586644" onmouseenter="enter('-4354847567179586644');" onmouseout="out('-4354847567179586644');" style=""> 158              File returnFile = broadleafFileService.getResource(staticAsset.getFullUrl());                         </span>
<span class="8059946160260640624" onmouseenter="enter('8059946160260640624');" onmouseout="out('8059946160260640624');" style=""> 159              if (!returnFile.getAbsolutePath().equals(baseLocalFile.getAbsolutePath())) {                          </span>
<span class="-2191133777668840278" onmouseenter="enter('-2191133777668840278');" onmouseout="out('-2191133777668840278');" style=""> 160                  createLocalFileFromInputStream(new FileInputStream(returnFile), baseLocalFile);                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 161              }                                                                                                     </span>
<span class="4024427022501975435" onmouseenter="enter('4024427022501975435');" onmouseout="out('4024427022501975435');" style=""> 162              return broadleafFileService.getResource(staticAsset.getFullUrl());                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 163          } else {                                                                                                  </span>
<span class="-4264495412887169123" onmouseenter="enter('-4264495412887169123');" onmouseout="out('-4264495412887169123');" style=""> 164              StaticAssetStorage storage = readStaticAssetStorageByStaticAssetId(staticAsset.getId());              </span>
<span class="4400092173030817905" onmouseenter="enter('4400092173030817905');" onmouseout="out('4400092173030817905');" style=""> 165              if (storage != null) {                                                                                </span>
<span class="-3012070176633314991" onmouseenter="enter('-3012070176633314991');" onmouseout="out('-3012070176633314991');" style=""> 166                  InputStream is = storage.getFileData().getBinaryStream();                                         </span>
<span class="538128314668626861" onmouseenter="enter('538128314668626861');" onmouseout="out('538128314668626861');" style=""> 167                  createLocalFileFromInputStream(is, baseLocalFile);                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 168              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 169          }                                                                                                         </span>
<span class="8385511608933773357" onmouseenter="enter('8385511608933773357');" onmouseout="out('8385511608933773357');" style=""> 170          return baseLocalFile;                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 171      }                                                                                                             </span>
<span  style=""> 172                                                                                                                    </span>
<span class="676971272687988980" onmouseenter="enter('676971272687988980');" onmouseout="out('676971272687988980');" style=""><abbr title=" 173      protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOException {"> 173      protected void createLocalFileFromClassPathResource(StaticAsset staticAsset, File baseLocalFile) throws IOExceðŸ”µ</abbr></span>
<span class="5330873671579735739" onmouseenter="enter('5330873671579735739');" onmouseout="out('5330873671579735739');" style=""> 174          InputStream is = broadleafFileService.getClasspathResource(staticAsset.getFullUrl());                     </span>
<span class="538128314668626861" onmouseenter="enter('538128314668626861');" onmouseout="out('538128314668626861');" style=""> 175          createLocalFileFromInputStream(is, baseLocalFile);                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 176      }                                                                                                             </span>
<span  style=""> 177                                                                                                                    </span>
<span class="-4952056920597128037" onmouseenter="enter('-4952056920597128037');" onmouseout="out('-4952056920597128037');" style=""> 178      protected void createLocalFileFromInputStream(InputStream is, File baseLocalFile) throws IOException {        </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 179          try {                                                                                                     </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 180              if (!baseLocalFile.getParentFile().exists()) {                                                        </span>
<span class="5777296043812209192" onmouseenter="enter('5777296043812209192');" onmouseout="out('5777296043812209192');" style=""> 181                  boolean directoriesCreated = false;                                                               </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 182                  if (!baseLocalFile.getParentFile().exists()) {                                                    </span>
<span class="-1950703901965003992" onmouseenter="enter('-1950703901965003992');" onmouseout="out('-1950703901965003992');" style=""> 183                      directoriesCreated = baseLocalFile.getParentFile().mkdirs();                                  </span>
<span class="-5835726015694115162" onmouseenter="enter('-5835726015694115162');" onmouseout="out('-5835726015694115162');" style=""> 184                      if (!directoriesCreated) {                                                                    </span>
<span class="-440335952408349395" onmouseenter="enter('-440335952408349395');" onmouseout="out('-440335952408349395');" style=""> 185                          // There is a chance that another VM created the directories.   If not, we may not have   </span>
<span class="5346057857994506172" onmouseenter="enter('5346057857994506172');" onmouseout="out('5346057857994506172');" style=""> 186                          // proper permissions and this is an error we need to report.                             </span>
<span class="1691942376685671329" onmouseenter="enter('1691942376685671329');" onmouseout="out('1691942376685671329');" style=""> 187                          if (!baseLocalFile.getParentFile().exists()) {                                            </span>
<span class="-3100057651899633278" onmouseenter="enter('-3100057651899633278');" onmouseout="out('-3100057651899633278');" style=""> 188                              throw new RuntimeException(&quot;Unable to create middle directories for file: &quot; +         </span>
<span class="-3627057965366514409" onmouseenter="enter('-3627057965366514409');" onmouseout="out('-3627057965366514409');" style=""> 189                                      baseLocalFile.getAbsolutePath());                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 190                          }                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 191                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 192                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 193              }                                                                                                     </span>
<span  style=""> 194                                                                                                                    </span>
<span class="1058516638336488341" onmouseenter="enter('1058516638336488341');" onmouseout="out('1058516638336488341');" style=""> 195              concurrentFileOutputStream.write(is, baseLocalFile);                                                  </span>
<span  style=""> 196                                                                                                                    </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 197          } finally {                                                                                               </span>
<span class="-1036224550261950069" onmouseenter="enter('-1036224550261950069');" onmouseout="out('-1036224550261950069');" style=""> 198              IOUtils.closeQuietly(is);                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 199          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 200      }                                                                                                             </span>
<span  style=""> 201                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 202      @Override                                                                                                     </span>
<span class="-5764870268385651216" onmouseenter="enter('-5764870268385651216');" onmouseout="out('-5764870268385651216');" style=""><abbr title=" 203      public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws Exception {"> 203      public Map&lt;String, String&gt; getCacheFileModel(String fullUrl, Map&lt;String, String&gt; parameterMap) throws ExceptioðŸ”µ</abbr></span>
<span class="491052228983464108" onmouseenter="enter('491052228983464108');" onmouseout="out('491052228983464108');" style=""> 204          StaticAsset staticAsset = findStaticAsset(fullUrl);                                                       </span>
<span class="-3786942395132975147" onmouseenter="enter('-3786942395132975147');" onmouseout="out('-3786942395132975147');" style=""> 205          if (staticAsset == null) {                                                                                </span>
<span class="-676167423781739050" onmouseenter="enter('-676167423781739050');" onmouseout="out('-676167423781739050');" style=""> 206              throw new AssetNotFoundException(&quot;Unable to find an asset for the url (&quot; + fullUrl + &quot;)&quot;);            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 207          }                                                                                                         </span>
<span class="-5398322132344119647" onmouseenter="enter('-5398322132344119647');" onmouseout="out('-5398322132344119647');" style=""> 208          String mimeType = staticAsset.getMimeType();                                                              </span>
<span  style=""> 209                                                                                                                    </span>
<span class="8252026315203489548" onmouseenter="enter('8252026315203489548');" onmouseout="out('8252026315203489548');" style=""> 210          //extract the values for any named parameters                                                             </span>
<span class="1331021329476510285" onmouseenter="enter('1331021329476510285');" onmouseout="out('1331021329476510285');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 211 +        boolean shouldRecompress = shouldRecompress(mimeType);                                                    </span>
<span class="5491208348485302910" onmouseenter="enter('5491208348485302910');" onmouseout="out('5491208348485302910');" style=""> 212          Map&lt;String, String&gt; convertedParameters = namedOperationManager.manageNamedParameters(parameterMap);      </span>
<span class="1628034097147692048" onmouseenter="enter('1628034097147692048');" onmouseout="out('1628034097147692048');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 213 +        if (shouldRecompress &amp;&amp; MapUtils.isEmpty(convertedParameters)) {                                          </span>
<span class="-8260123448707150424" onmouseenter="enter('-8260123448707150424');" onmouseout="out('-8260123448707150424');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +            convertedParameters.put(&quot;recompress&quot;,&quot;true&quot;);                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 215 +        }                                                                                                         </span>
<span class="-6987211962421403682" onmouseenter="enter('-6987211962421403682');" onmouseout="out('-6987211962421403682');" style=""> 216          String cachedFileName = constructCacheFileName(staticAsset, convertedParameters);                         </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +                                                                                                                  </span>
<span class="-4010270241296523972" onmouseenter="enter('-4010270241296523972');" onmouseout="out('-4010270241296523972');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +        if (shouldRecompress) {                                                                                   </span>
<span class="3725275006012768392" onmouseenter="enter('3725275006012768392');" onmouseout="out('3725275006012768392');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +            convertedParameters.remove(&quot;recompress&quot;);                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +        }                                                                                                         </span>
<span  style=""> 221                                                                                                                    </span>
<span class="-5673162797879974066" onmouseenter="enter('-5673162797879974066');" onmouseout="out('-5673162797879974066');" style=""> 222          // Look for a shared file (this represents a file that was based on a file originally in the classpath.   </span>
<span class="-744748978496739834" onmouseenter="enter('-744748978496739834');" onmouseout="out('-744748978496739834');" style=""> 223          File cacheFile = getFileFromLocalRepository(cachedFileName);                                              </span>
<span class="-2028153032285377680" onmouseenter="enter('-2028153032285377680');" onmouseout="out('-2028153032285377680');" style=""> 224          if (cacheFile.exists()) {                                                                                 </span>
<span class="-5770017993670818757" onmouseenter="enter('-5770017993670818757');" onmouseout="out('-5770017993670818757');" style=""> 225              return buildModel(cacheFile.getAbsolutePath(), mimeType);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 226          }                                                                                                         </span>
<span  style=""> 227                                                                                                                    </span>
<span class="7943467756367013608" onmouseenter="enter('7943467756367013608');" onmouseout="out('7943467756367013608');" style=""> 228          // Obtain the base file (that we may need to convert based on the parameters                              </span>
<span class="-7282961418041278395" onmouseenter="enter('-7282961418041278395');" onmouseout="out('-7282961418041278395');" style=""> 229          String baseCachedFileName = constructCacheFileName(staticAsset, null);                                    </span>
<span class="2819718340222738473" onmouseenter="enter('2819718340222738473');" onmouseout="out('2819718340222738473');" style=""> 230          File baseLocalFile = getFileFromLocalRepository(baseCachedFileName);                                      </span>
<span  style=""> 231                                                                                                                    </span>
<span class="7807331939993150402" onmouseenter="enter('7807331939993150402');" onmouseout="out('7807331939993150402');" style=""> 232          if (! baseLocalFile.exists()) {                                                                           </span>
<span class="-4152796465711126856" onmouseenter="enter('-4152796465711126856');" onmouseout="out('-4152796465711126856');" style=""> 233              if (broadleafFileService.checkForResourceOnClassPath(staticAsset.getFullUrl())) {                     </span>
<span class="-8910009845238484526" onmouseenter="enter('-8910009845238484526');" onmouseout="out('-8910009845238484526');" style=""> 234                  cacheFile = broadleafFileService.getSharedLocalResource(cachedFileName);                          </span>
<span class="-3411813136412986040" onmouseenter="enter('-3411813136412986040');" onmouseout="out('-3411813136412986040');" style=""> 235                  baseLocalFile = broadleafFileService.getSharedLocalResource(baseCachedFileName);                  </span>
<span class="-4235219464337080287" onmouseenter="enter('-4235219464337080287');" onmouseout="out('-4235219464337080287');" style=""> 236                  createLocalFileFromClassPathResource(staticAsset, baseLocalFile);                                 </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 237              } else {                                                                                              </span>
<span class="-4898184433395929673" onmouseenter="enter('-4898184433395929673');" onmouseout="out('-4898184433395929673');" style=""> 238                  baseLocalFile = lookupAssetAndCreateLocalFile(staticAsset, baseLocalFile);                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 239              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 240          }                                                                                                         </span>
<span  style=""> 241                                                                                                                    </span>
<span class="5916960396483683926" onmouseenter="enter('5916960396483683926');" onmouseout="out('5916960396483683926');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 242 -        if (convertedParameters.isEmpty()) {                                                                      </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +                                                                                                                  </span>
<span class="-524316509192333846" onmouseenter="enter('-524316509192333846');" onmouseout="out('-524316509192333846');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +        if (!shouldRecompress &amp;&amp; convertedParameters.isEmpty()) {                                                 </span>
<span class="1541740886220527868" onmouseenter="enter('1541740886220527868');" onmouseout="out('1541740886220527868');" style=""> 245              return buildModel(baseLocalFile.getAbsolutePath(), mimeType);                                         </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style="background-color: rgba(255, 0, 0, 0.2); margin: 0"> 246 -        } else {                                                                                                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +        }                                                                                                         </span>
<span class="4391598042186419731" onmouseenter="enter('4391598042186419731');" onmouseout="out('4391598042186419731');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +        else {                                                                                                    </span>
<span class="2626429018838635667" onmouseenter="enter('2626429018838635667');" onmouseout="out('2626429018838635667');" style=""> 249              FileInputStream assetStream = new FileInputStream(baseLocalFile);                                     </span>
<span class="1559981230759799611" onmouseenter="enter('1559981230759799611');" onmouseout="out('1559981230759799611');" style=""> 250              BufferedInputStream original = new BufferedInputStream(assetStream);                                  </span>
<span class="5335072745234046164" onmouseenter="enter('5335072745234046164');" onmouseout="out('5335072745234046164');" style=""> 251              original.mark(0);                                                                                     </span>
<span  style=""> 252                                                                                                                    </span>
<span class="3271606902025597443" onmouseenter="enter('3271606902025597443');" onmouseout="out('3271606902025597443');" style=""><abbr title=" 253              Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.getMimeType());"> 253              Operation[] operations = artifactService.buildOperations(convertedParameters, original, staticAsset.geðŸ”µ</abbr></span>
<span class="-4049222348408471473" onmouseenter="enter('-4049222348408471473');" onmouseout="out('-4049222348408471473');" style=""> 254              InputStream converted = artifactService.convert(original, operations, staticAsset.getMimeType());     </span>
<span  style=""> 255                                                                                                                    </span>
<span class="-5852373631387772582" onmouseenter="enter('-5852373631387772582');" onmouseout="out('-5852373631387772582');" style=""> 256              createLocalFileFromInputStream(converted, cacheFile);                                                 </span>
<span class="8481176371776030575" onmouseenter="enter('8481176371776030575');" onmouseout="out('8481176371776030575');" style=""> 257              if (&quot;image/gif&quot;.equals(mimeType)) {                                                                   </span>
<span class="6692235241863720447" onmouseenter="enter('6692235241863720447');" onmouseout="out('6692235241863720447');" style=""> 258                  mimeType = &quot;image/png&quot;;                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 259              }                                                                                                     </span>
<span class="-5770017993670818757" onmouseenter="enter('-5770017993670818757');" onmouseout="out('-5770017993670818757');" style=""> 260              return buildModel(cacheFile.getAbsolutePath(), mimeType);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 261          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +    }                                                                                                             </span>
<span  style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +                                                                                                                  </span>
<span class="1436332013455477710" onmouseenter="enter('1436332013455477710');" onmouseout="out('1436332013455477710');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +    protected boolean shouldRecompress(String mimeType) {                                                         </span>
<span class="-2947492696471387039" onmouseenter="enter('-2947492696471387039');" onmouseout="out('-2947492696471387039');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +        String[] formats = null;                                                                                  </span>
<span class="3146177423232232799" onmouseenter="enter('3146177423232232799');" onmouseout="out('3146177423232232799');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +        if (!StringUtils.isEmpty(recompressFormats)) {                                                            </span>
<span class="-5929026035202084105" onmouseenter="enter('-5929026035202084105');" onmouseout="out('-5929026035202084105');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +            formats = recompressFormats.split(&quot;,&quot;);                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +        }                                                                                                         </span>
<span class="7342740188292578775" onmouseenter="enter('7342740188292578775');" onmouseout="out('7342740188292578775');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +        boolean response = false;                                                                                 </span>
<span class="-630918830715510960" onmouseenter="enter('-630918830715510960');" onmouseout="out('-630918830715510960');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +        if (!ArrayUtils.isEmpty(formats)) {                                                                       </span>
<span class="2272716586254590500" onmouseenter="enter('2272716586254590500');" onmouseout="out('2272716586254590500');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +            for (String format : formats) {                                                                       </span>
<span class="-250489820996933262" onmouseenter="enter('-250489820996933262');" onmouseout="out('-250489820996933262');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +                if (mimeType.toLowerCase().contains(format.toLowerCase())) {                                      </span>
<span class="-7568734358544125355" onmouseenter="enter('-7568734358544125355');" onmouseout="out('-7568734358544125355');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +                    response = true;                                                                              </span>
<span class="-7917104194997868056" onmouseenter="enter('-7917104194997868056');" onmouseout="out('-7917104194997868056');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +                    break;                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +                }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +            }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +        }                                                                                                         </span>
<span class="-1838489616061912436" onmouseenter="enter('-1838489616061912436');" onmouseout="out('-1838489616061912436');" style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +        return response;                                                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 279      }                                                                                                             </span>
<span  style=""> 280                                                                                                                    </span>
<span class="-5129110647668669753" onmouseenter="enter('-5129110647668669753');" onmouseout="out('-5129110647668669753');" style=""> 281      protected Map&lt;String, String&gt; buildModel(String returnFilePath, String mimeType) {                            </span>
<span class="-5436835504658380993" onmouseenter="enter('-5436835504658380993');" onmouseout="out('-5436835504658380993');" style=""> 282          Map&lt;String, String&gt; model = new HashMap&lt;String, String&gt;(2);                                               </span>
<span class="-7931157778314956360" onmouseenter="enter('-7931157778314956360');" onmouseout="out('-7931157778314956360');" style=""> 283          model.put(&quot;cacheFilePath&quot;, returnFilePath);                                                               </span>
<span class="-121481178440989733" onmouseenter="enter('-121481178440989733');" onmouseout="out('-121481178440989733');" style=""> 284          model.put(&quot;mimeType&quot;, mimeType);                                                                          </span>
<span  style=""> 285                                                                                                                    </span>
<span class="1327412617440986435" onmouseenter="enter('1327412617440986435');" onmouseout="out('1327412617440986435');" style=""> 286          return model;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 287      }                                                                                                             </span>
<span  style=""> 288                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 289      @Override                                                                                                     </span>
<span class="-2260190509208115003" onmouseenter="enter('-2260190509208115003');" onmouseout="out('-2260190509208115003');" style=""> 290      public StaticAssetStorage findStaticAssetStorageById(final Long id) {                                         </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 291          final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                           </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 292          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 293              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 294              public void execute() {                                                                               </span>
<span class="-2207751287529111136" onmouseenter="enter('-2207751287529111136');" onmouseout="out('-2207751287529111136');" style=""> 295                  storage[0] = staticAssetStorageDao.readStaticAssetStorageById(id);                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 296              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 297          }, RuntimeException.class);                                                                               </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 298          return storage[0];                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 299      }                                                                                                             </span>
<span  style=""> 300                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 301      @Override                                                                                                     </span>
<span class="-2864285839814759705" onmouseenter="enter('-2864285839814759705');" onmouseout="out('-2864285839814759705');" style=""> 302      public StaticAssetStorage create() {                                                                          </span>
<span class="-1873403527653357243" onmouseenter="enter('-1873403527653357243');" onmouseout="out('-1873403527653357243');" style=""> 303          return staticAssetStorageDao.create();                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 304      }                                                                                                             </span>
<span  style=""> 305                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 306      @Override                                                                                                     </span>
<span class="7662571466653582755" onmouseenter="enter('7662571466653582755');" onmouseout="out('7662571466653582755');" style=""> 307      public StaticAssetStorage readStaticAssetStorageByStaticAssetId(final Long id) {                              </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 308          final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                           </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 309          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 310              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 311              public void execute() {                                                                               </span>
<span class="8795705063184424946" onmouseenter="enter('8795705063184424946');" onmouseout="out('8795705063184424946');" style=""> 312                  storage[0] = staticAssetStorageDao.readStaticAssetStorageByStaticAssetId(id);                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 313              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 314          }, RuntimeException.class);                                                                               </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 315          return storage[0];                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 316      }                                                                                                             </span>
<span  style=""> 317                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 318      @Override                                                                                                     </span>
<span class="6485967695518229819" onmouseenter="enter('6485967695518229819');" onmouseout="out('6485967695518229819');" style=""> 319      public StaticAssetStorage save(final StaticAssetStorage assetStorage) {                                       </span>
<span class="8238101690225450907" onmouseenter="enter('8238101690225450907');" onmouseout="out('8238101690225450907');" style=""> 320          final StaticAssetStorage[] storage = new StaticAssetStorage[1];                                           </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 321          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 322              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 323              public void execute() {                                                                               </span>
<span class="-6036718856004453538" onmouseenter="enter('-6036718856004453538');" onmouseout="out('-6036718856004453538');" style=""> 324                  storage[0] = staticAssetStorageDao.save(assetStorage);                                            </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 325              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 326          }, RuntimeException.class);                                                                               </span>
<span class="2068072242180813039" onmouseenter="enter('2068072242180813039');" onmouseout="out('2068072242180813039');" style=""> 327          return storage[0];                                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 328      }                                                                                                             </span>
<span  style=""> 329                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 330      @Override                                                                                                     </span>
<span class="7860976460954721267" onmouseenter="enter('7860976460954721267');" onmouseout="out('7860976460954721267');" style=""> 331      public void delete(final StaticAssetStorage assetStorage) {                                                   </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 332          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 333              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 334              public void execute() {                                                                               </span>
<span class="5167138969991588867" onmouseenter="enter('5167138969991588867');" onmouseout="out('5167138969991588867');" style=""> 335                  staticAssetStorageDao.delete(assetStorage);                                                       </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 336              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 337          }, RuntimeException.class);                                                                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 338      }                                                                                                             </span>
<span  style=""> 339                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 340      @Override                                                                                                     </span>
<span class="-1910899245286681437" onmouseenter="enter('-1910899245286681437');" onmouseout="out('-1910899245286681437');" style=""> 341      public Blob createBlob(final MultipartFile uploadedFile) throws IOException {                                 </span>
<span class="848437443390195780" onmouseenter="enter('848437443390195780');" onmouseout="out('848437443390195780');" style=""> 342          final Blob[] blob = new Blob[1];                                                                          </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 343          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 344              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 345              public void execute() {                                                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 346                  try {                                                                                             </span>
<span class="3702070050705863788" onmouseenter="enter('3702070050705863788');" onmouseout="out('3702070050705863788');" style=""> 347                      blob[0] = staticAssetStorageDao.createBlob(uploadedFile);                                     </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 348                  } catch (IOException e) {                                                                         </span>
<span class="5116711708032073694" onmouseenter="enter('5116711708032073694');" onmouseout="out('5116711708032073694');" style=""> 349                      LOG.error(&quot;Unable to create blob from MultipartFile.&quot;, e);                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 350                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 351              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 352          }, RuntimeException.class);                                                                               </span>
<span class="-3204915544472573462" onmouseenter="enter('-3204915544472573462');" onmouseout="out('-3204915544472573462');" style=""> 353          return blob[0];                                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 354      }                                                                                                             </span>
<span  style=""> 355                                                                                                                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 356      @Override                                                                                                     </span>
<span class="4382666547830473388" onmouseenter="enter('4382666547830473388');" onmouseout="out('4382666547830473388');" style=""> 357      public Blob createBlob(final InputStream uploadedFileInputStream, final long fileSize) throws IOException {   </span>
<span class="848437443390195780" onmouseenter="enter('848437443390195780');" onmouseout="out('848437443390195780');" style=""> 358          final Blob[] blob = new Blob[1];                                                                          </span>
<span class="-6431713809365788838" onmouseenter="enter('-6431713809365788838');" onmouseout="out('-6431713809365788838');" style=""> 359          transUtil.runTransactionalOperation(new StreamCapableTransactionalOperationAdapter() {                    </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 360              @Override                                                                                             </span>
<span class="2549908796425490219" onmouseenter="enter('2549908796425490219');" onmouseout="out('2549908796425490219');" style=""> 361              public void execute() {                                                                               </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 362                  try {                                                                                             </span>
<span class="-8405931859176759523" onmouseenter="enter('-8405931859176759523');" onmouseout="out('-8405931859176759523');" style=""> 363                      blob[0] = staticAssetStorageDao.createBlob(uploadedFileInputStream, fileSize);                </span>
<span class="7080241092423381085" onmouseenter="enter('7080241092423381085');" onmouseout="out('7080241092423381085');" style=""> 364                  } catch (IOException e) {                                                                         </span>
<span class="10365894759289852" onmouseenter="enter('10365894759289852');" onmouseout="out('10365894759289852');" style=""> 365                      LOG.error(&quot;Unable to create blob from InputStream.&quot;, e);                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 366                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 367              }                                                                                                     </span>
<span class="-3417072119495989863" onmouseenter="enter('-3417072119495989863');" onmouseout="out('-3417072119495989863');" style=""> 368          }, RuntimeException.class);                                                                               </span>
<span class="-3204915544472573462" onmouseenter="enter('-3204915544472573462');" onmouseout="out('-3204915544472573462');" style=""> 369          return blob[0];                                                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 370      }                                                                                                             </span>
<span  style=""> 371                                                                                                                    </span>
<span class="1188357178855945174" onmouseenter="enter('1188357178855945174');" onmouseout="out('1188357178855945174');" style=""> 372      /**                                                                                                           </span>
<span class="1204867681485950258" onmouseenter="enter('1204867681485950258');" onmouseout="out('1204867681485950258');" style=""> 373       * Builds a file system path for the passed in static asset and paramaterMap.                                 </span>
<span class="329605257831645060" onmouseenter="enter('329605257831645060');" onmouseout="out('329605257831645060');" style=""> 374       *                                                                                                            </span>
<span class="-8533974154884571802" onmouseenter="enter('-8533974154884571802');" onmouseout="out('-8533974154884571802');" style=""> 375       * @param staticAsset                                                                                         </span>
<span class="1550808242639330275" onmouseenter="enter('1550808242639330275');" onmouseout="out('1550808242639330275');" style=""> 376       * @param parameterMap                                                                                        </span>
<span class="966966680655938311" onmouseenter="enter('966966680655938311');" onmouseout="out('966966680655938311');" style=""> 377       * @param useSharedFile                                                                                       </span>
<span class="-9165797340485297481" onmouseenter="enter('-9165797340485297481');" onmouseout="out('-9165797340485297481');" style=""> 378       * @return                                                                                                    </span>
<span class="-3478703399357275674" onmouseenter="enter('-3478703399357275674');" onmouseout="out('-3478703399357275674');" style=""> 379       */                                                                                                           </span>
<span class="9052993107782234324" onmouseenter="enter('9052993107782234324');" onmouseout="out('9052993107782234324');" style=""> 380      protected String constructCacheFileName(StaticAsset staticAsset, Map&lt;String, String&gt; parameterMap) {          </span>
<span class="6966748151173677546" onmouseenter="enter('6966748151173677546');" onmouseout="out('6966748151173677546');" style=""> 381          String fileName = staticAsset.getFullUrl();                                                               </span>
<span  style=""> 382                                                                                                                    </span>
<span class="-4507417291042206746" onmouseenter="enter('-4507417291042206746');" onmouseout="out('-4507417291042206746');" style=""> 383          StringBuilder sb = new StringBuilder(200);                                                                </span>
<span class="-483528478759561910" onmouseenter="enter('-483528478759561910');" onmouseout="out('-483528478759561910');" style=""> 384          sb.append(fileName.substring(0, fileName.lastIndexOf(&#x27;.&#x27;)));                                              </span>
<span class="4093974766537940594" onmouseenter="enter('4093974766537940594');" onmouseout="out('4093974766537940594');" style=""> 385          sb.append(&quot;---&quot;);                                                                                         </span>
<span  style=""> 386                                                                                                                    </span>
<span class="3988790927371777098" onmouseenter="enter('3988790927371777098');" onmouseout="out('3988790927371777098');" style=""> 387          StringBuilder sb2 = new StringBuilder(200);                                                               </span>
<span class="1220298265095205393" onmouseenter="enter('1220298265095205393');" onmouseout="out('1220298265095205393');" style=""> 388          SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd-HH-mm-ss&quot;);                                    </span>
<span class="8844493969073287544" onmouseenter="enter('8844493969073287544');" onmouseout="out('8844493969073287544');" style=""> 389          if (staticAsset instanceof Auditable) {                                                                   </span>
<span class="-4932550937064679086" onmouseenter="enter('-4932550937064679086');" onmouseout="out('-4932550937064679086');" style=""> 390              Auditable auditableStaticAsset = (Auditable) staticAsset;                                             </span>
<span class="2764706875669982552" onmouseenter="enter('2764706875669982552');" onmouseout="out('2764706875669982552');" style=""><abbr title=" 391              sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCreated() : auditableStaticAsset.getDateUpdated()));"> 391              sb2.append(format.format(auditableStaticAsset.getDateUpdated() == null ? auditableStaticAsset.getDateCðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 392          }                                                                                                         </span>
<span  style=""> 393                                                                                                                    </span>
<span class="-9176202731662601074" onmouseenter="enter('-9176202731662601074');" onmouseout="out('-9176202731662601074');" style=""> 394          if (parameterMap != null) {                                                                               </span>
<span class="-8466079002823576232" onmouseenter="enter('-8466079002823576232');" onmouseout="out('-8466079002823576232');" style=""> 395              for (Map.Entry&lt;String, String&gt; entry : parameterMap.entrySet()) {                                     </span>
<span class="-5538998764085201912" onmouseenter="enter('-5538998764085201912');" onmouseout="out('-5538998764085201912');" style=""> 396                  sb2.append(&#x27;-&#x27;);                                                                                  </span>
<span class="2475309890837225957" onmouseenter="enter('2475309890837225957');" onmouseout="out('2475309890837225957');" style=""> 397                  sb2.append(entry.getKey());                                                                       </span>
<span class="-5538998764085201912" onmouseenter="enter('-5538998764085201912');" onmouseout="out('-5538998764085201912');" style=""> 398                  sb2.append(&#x27;-&#x27;);                                                                                  </span>
<span class="7337918225958425753" onmouseenter="enter('7337918225958425753');" onmouseout="out('7337918225958425753');" style=""> 399                  sb2.append(entry.getValue());                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 400              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 401          }                                                                                                         </span>
<span  style=""> 402                                                                                                                    </span>
<span class="-3611986260301585228" onmouseenter="enter('-3611986260301585228');" onmouseout="out('-3611986260301585228');" style=""> 403          String digest;                                                                                            </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 404          try {                                                                                                     </span>
<span class="-6955618976542935940" onmouseenter="enter('-6955618976542935940');" onmouseout="out('-6955618976542935940');" style=""> 405              MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);                                                  </span>
<span class="-42474679596396087" onmouseenter="enter('-42474679596396087');" onmouseout="out('-42474679596396087');" style=""> 406              byte[] messageDigest = md.digest(sb2.toString().getBytes());                                          </span>
<span class="-5380974963518813864" onmouseenter="enter('-5380974963518813864');" onmouseout="out('-5380974963518813864');" style=""> 407              BigInteger number = new BigInteger(1,messageDigest);                                                  </span>
<span class="5844706554126289727" onmouseenter="enter('5844706554126289727');" onmouseout="out('5844706554126289727');" style=""> 408              digest = number.toString(16);                                                                         </span>
<span class="-4215171220869553942" onmouseenter="enter('-4215171220869553942');" onmouseout="out('-4215171220869553942');" style=""> 409          } catch(NoSuchAlgorithmException e) {                                                                     </span>
<span class="5897285764286536997" onmouseenter="enter('5897285764286536997');" onmouseout="out('5897285764286536997');" style=""> 410              throw new RuntimeException(e);                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 411          }                                                                                                         </span>
<span  style=""> 412                                                                                                                    </span>
<span class="-5802237960969046083" onmouseenter="enter('-5802237960969046083');" onmouseout="out('-5802237960969046083');" style=""> 413          sb.append(pad(digest, 32, &#x27;0&#x27;));                                                                          </span>
<span class="-4790971325793185911" onmouseenter="enter('-4790971325793185911');" onmouseout="out('-4790971325793185911');" style=""> 414          sb.append(fileName.substring(fileName.lastIndexOf(&#x27;.&#x27;)));                                                 </span>
<span  style=""> 415                                                                                                                    </span>
<span class="-6276773404435993532" onmouseenter="enter('-6276773404435993532');" onmouseout="out('-6276773404435993532');" style=""> 416          return sb.toString();                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 417      }                                                                                                             </span>
<span  style=""> 418                                                                                                                    </span>
<span class="3889823321692711159" onmouseenter="enter('3889823321692711159');" onmouseout="out('3889823321692711159');" style=""> 419      protected String pad(String s, int length, char pad) {                                                        </span>
<span class="445211846679573021" onmouseenter="enter('445211846679573021');" onmouseout="out('445211846679573021');" style=""> 420          StringBuilder buffer = new StringBuilder(s);                                                              </span>
<span class="-1767419613255418829" onmouseenter="enter('-1767419613255418829');" onmouseout="out('-1767419613255418829');" style=""> 421          while (buffer.length() &lt; length) {                                                                        </span>
<span class="5619102104931061603" onmouseenter="enter('5619102104931061603');" onmouseout="out('5619102104931061603');" style=""> 422              buffer.insert(0, pad);                                                                                </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 423          }                                                                                                         </span>
<span class="-2038716794812902958" onmouseenter="enter('-2038716794812902958');" onmouseout="out('-2038716794812902958');" style=""> 424          return buffer.toString();                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 425      }                                                                                                             </span>
<span  style=""> 426                                                                                                                    </span>
<span class="8674831860571754100" onmouseenter="enter('8674831860571754100');" onmouseout="out('8674831860571754100');" style=""> 427      @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)                                                        </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 428      @Override                                                                                                     </span>
<span class="124994076020326784" onmouseenter="enter('124994076020326784');" onmouseout="out('124994076020326784');" style=""> 429      public void createStaticAssetStorageFromFile(MultipartFile file, StaticAsset staticAsset) throws IOException {</span>
<span class="-2118089514208048024" onmouseenter="enter('-2118089514208048024');" onmouseout="out('-2118089514208048024');" style=""> 430          createStaticAssetStorage(file.getInputStream(), staticAsset);                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 431      }                                                                                                             </span>
<span  style=""> 432                                                                                                                    </span>
<span class="8674831860571754100" onmouseenter="enter('8674831860571754100');" onmouseout="out('8674831860571754100');" style=""> 433      @Transactional(&quot;blTransactionManagerAssetStorageInfo&quot;)                                                        </span>
<span class="5563255192340639251" onmouseenter="enter('5563255192340639251');" onmouseout="out('5563255192340639251');" style=""> 434      @Override                                                                                                     </span>
<span class="-850236438741332732" onmouseenter="enter('-850236438741332732');" onmouseout="out('-850236438741332732');" style=""><abbr title=" 435      public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException {"> 435      public void createStaticAssetStorage(InputStream fileInputStream, StaticAsset staticAsset) throws IOException ðŸ”µ</abbr></span>
<span class="-1403207369962524759" onmouseenter="enter('-1403207369962524759');" onmouseout="out('-1403207369962524759');" style=""> 436          if (StorageType.DATABASE.equals(staticAsset.getStorageType())) {                                          </span>
<span class="-1939605028615766275" onmouseenter="enter('-1939605028615766275');" onmouseout="out('-1939605028615766275');" style=""> 437              StaticAssetStorage storage = create();                                                                </span>
<span class="-204637599683518602" onmouseenter="enter('-204637599683518602');" onmouseout="out('-204637599683518602');" style=""> 438              storage.setStaticAssetId(staticAsset.getId());                                                        </span>
<span class="1384418291306141967" onmouseenter="enter('1384418291306141967');" onmouseout="out('1384418291306141967');" style=""> 439              Blob uploadBlob = createBlob(fileInputStream, staticAsset.getFileSize());                             </span>
<span class="6866380704006125127" onmouseenter="enter('6866380704006125127');" onmouseout="out('6866380704006125127');" style=""> 440              storage.setFileData(uploadBlob);                                                                      </span>
<span class="-2840973363991180880" onmouseenter="enter('-2840973363991180880');" onmouseout="out('-2840973363991180880');" style=""> 441              save(storage);                                                                                        </span>
<span class="-2132857837912478262" onmouseenter="enter('-2132857837912478262');" onmouseout="out('-2132857837912478262');" style=""> 442          } else if (StorageType.FILESYSTEM.equals(staticAsset.getStorageType())) {                                 </span>
<span class="-4012729166374721308" onmouseenter="enter('-4012729166374721308');" onmouseout="out('-4012729166374721308');" style=""> 443              FileWorkArea tempWorkArea = broadleafFileService.initializeWorkArea();                                </span>
<span class="-4881648785169426910" onmouseenter="enter('-4881648785169426910');" onmouseout="out('-4881648785169426910');" style=""> 444              // Convert the given URL from the asset to a system-specific suitable file path                       </span>
<span class="-6260899414746866851" onmouseenter="enter('-6260899414746866851');" onmouseout="out('-6260899414746866851');" style=""><abbr title=" 445              String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FilenameUtils.separatorsToSystem(staticAsset.getFullUrl()));"> 445              String destFileName = FilenameUtils.normalize(tempWorkArea.getFilePathLocation() + File.separator + FiðŸ”µ</abbr></span>
<span  style=""> 446                                                                                                                    </span>
<span class="2773091736631403971" onmouseenter="enter('2773091736631403971');" onmouseout="out('2773091736631403971');" style=""> 447              InputStream input = fileInputStream;                                                                  </span>
<span class="6832533006494732607" onmouseenter="enter('6832533006494732607');" onmouseout="out('6832533006494732607');" style=""> 448              byte[] buffer = new byte[getFileBufferSize()];                                                        </span>
<span  style=""> 449                                                                                                                    </span>
<span class="-6502247887775821258" onmouseenter="enter('-6502247887775821258');" onmouseout="out('-6502247887775821258');" style=""> 450              File destFile = new File(destFileName);                                                               </span>
<span class="-695082894467535606" onmouseenter="enter('-695082894467535606');" onmouseout="out('-695082894467535606');" style=""> 451              if (!destFile.getParentFile().exists()) {                                                             </span>
<span class="8653794664879930122" onmouseenter="enter('8653794664879930122');" onmouseout="out('8653794664879930122');" style=""> 452                  if (!destFile.getParentFile().mkdirs()) {                                                         </span>
<span class="-695082894467535606" onmouseenter="enter('-695082894467535606');" onmouseout="out('-695082894467535606');" style=""> 453                      if (!destFile.getParentFile().exists()) {                                                     </span>
<span class="5433889739361026965" onmouseenter="enter('5433889739361026965');" onmouseout="out('5433889739361026965');" style=""><abbr title=" 454                          throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileName);"> 454                          throw new RuntimeException(&quot;Unable to create parent directories for file: &quot; + destFileNameðŸ”µ</abbr></span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 455                      }                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 456                  }                                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 457              }                                                                                                     </span>
<span  style=""> 458                                                                                                                    </span>
<span class="6445829042907396164" onmouseenter="enter('6445829042907396164');" onmouseout="out('6445829042907396164');" style=""> 459              OutputStream output = new FileOutputStream(destFile);                                                 </span>
<span class="-5038889493716933228" onmouseenter="enter('-5038889493716933228');" onmouseout="out('-5038889493716933228');" style=""> 460              long maxFileSize = getMaxUploadSizeForFile(destFileName);                                             </span>
<span class="-2989978199866728989" onmouseenter="enter('-2989978199866728989');" onmouseout="out('-2989978199866728989');" style=""> 461              try {                                                                                                 </span>
<span class="-7067986891170572893" onmouseenter="enter('-7067986891170572893');" onmouseout="out('-7067986891170572893');" style=""> 462                  int bytesRead;                                                                                    </span>
<span class="5297046094019116056" onmouseenter="enter('5297046094019116056');" onmouseout="out('5297046094019116056');" style=""> 463                  int totalBytesRead = 0;                                                                           </span>
<span class="-7676219729156525464" onmouseenter="enter('-7676219729156525464');" onmouseout="out('-7676219729156525464');" style=""> 464                  while ((bytesRead = input.read(buffer)) != -1) {                                                  </span>
<span class="-6799238023814913099" onmouseenter="enter('-6799238023814913099');" onmouseout="out('-6799238023814913099');" style=""> 465                      totalBytesRead += bytesRead;                                                                  </span>
<span class="775261430666212722" onmouseenter="enter('775261430666212722');" onmouseout="out('775261430666212722');" style=""> 466                      if (totalBytesRead &gt; maxFileSize) {                                                           </span>
<span class="-104032706615660809" onmouseenter="enter('-104032706615660809');" onmouseout="out('-104032706615660809');" style=""> 467                          throw new IOException(&quot;Maximum Upload File Size Exceeded&quot;);                               </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 468                      }                                                                                             </span>
<span class="6143107777038809767" onmouseenter="enter('6143107777038809767');" onmouseout="out('6143107777038809767');" style=""> 469                      output.write(buffer, 0, bytesRead);                                                           </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 470                  }                                                                                                 </span>
<span  style=""> 471                                                                                                                    </span>
<span class="-3636717142636833723" onmouseenter="enter('-3636717142636833723');" onmouseout="out('-3636717142636833723');" style=""> 472                  // close the output file stream prior to moving files around                                      </span>
<span class="-7467153277872057229" onmouseenter="enter('-7467153277872057229');" onmouseout="out('-7467153277872057229');" style=""> 473                  output.close();                                                                                   </span>
<span class="-7014270169952325099" onmouseenter="enter('-7014270169952325099');" onmouseout="out('-7014270169952325099');" style=""> 474                  broadleafFileService.addOrUpdateResource(tempWorkArea, destFile, false);                          </span>
<span class="9062373144943479618" onmouseenter="enter('9062373144943479618');" onmouseout="out('9062373144943479618');" style=""> 475              } finally {                                                                                           </span>
<span class="4174609820499721765" onmouseenter="enter('4174609820499721765');" onmouseout="out('4174609820499721765');" style=""> 476                  IOUtils.closeQuietly(output);                                                                     </span>
<span class="5684068854007703140" onmouseenter="enter('5684068854007703140');" onmouseout="out('5684068854007703140');" style=""> 477                  broadleafFileService.closeWorkArea(tempWorkArea);                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 478              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 479          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 480      }                                                                                                             </span>
<span  style=""> 481                                                                                                                    </span>
<span class="7880420848062709346" onmouseenter="enter('7880420848062709346');" onmouseout="out('7880420848062709346');" style=""> 482      protected long getMaxUploadSizeForFile(String fileName) {                                                     </span>
<span class="-8299331750570909154" onmouseenter="enter('-8299331750570909154');" onmouseout="out('-8299331750570909154');" style=""> 483          if (isImageFile(fileName)) {                                                                              </span>
<span class="-8904535810123442239" onmouseenter="enter('-8904535810123442239');" onmouseout="out('-8904535810123442239');" style=""> 484              return getMaxUploadableImageSize();                                                                   </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 485          }                                                                                                         </span>
<span  style=""> 486                                                                                                                    </span>
<span class="7342651561788072273" onmouseenter="enter('7342651561788072273');" onmouseout="out('7342651561788072273');" style=""> 487          return getMaxUploadableFileSize();                                                                        </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 488      }                                                                                                             </span>
<span  style=""> 489                                                                                                                    </span>
<span class="-4256605375867072165" onmouseenter="enter('-4256605375867072165');" onmouseout="out('-4256605375867072165');" style=""> 490      protected boolean isImageFile(String fileName) {                                                              </span>
<span class="-7215778148857055723" onmouseenter="enter('-7215778148857055723');" onmouseout="out('-7215778148857055723');" style=""> 491          String extension = getFileExtension(fileName);                                                            </span>
<span  style=""> 492                                                                                                                    </span>
<span class="868046925461100818" onmouseenter="enter('868046925461100818');" onmouseout="out('868046925461100818');" style=""> 493          for (String imageFileExtension : getAdminImageFileExtensions()) {                                         </span>
<span class="-1882310683799532334" onmouseenter="enter('-1882310683799532334');" onmouseout="out('-1882310683799532334');" style=""> 494              if (imageFileExtension.equalsIgnoreCase(extension)) {                                                 </span>
<span class="-3118901906653197100" onmouseenter="enter('-3118901906653197100');" onmouseout="out('-3118901906653197100');" style=""> 495                  return true;                                                                                      </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 496              }                                                                                                     </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 497          }                                                                                                         </span>
<span  style=""> 498                                                                                                                    </span>
<span class="-5432226360745882584" onmouseenter="enter('-5432226360745882584');" onmouseout="out('-5432226360745882584');" style=""> 499          return false;                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 500      }                                                                                                             </span>
<span  style=""> 501                                                                                                                    </span>
<span class="-4067859991978763128" onmouseenter="enter('-4067859991978763128');" onmouseout="out('-4067859991978763128');" style=""> 502      protected String getFileExtension(String assetPath) {                                                         </span>
<span class="-7365160516150097212" onmouseenter="enter('-7365160516150097212');" onmouseout="out('-7365160516150097212');" style=""> 503          int extensionStartIndex = assetPath.lastIndexOf(&quot;.&quot;) + 1;                                                 </span>
<span class="3165050002785748305" onmouseenter="enter('3165050002785748305');" onmouseout="out('3165050002785748305');" style=""> 504          return assetPath.substring(extensionStartIndex);                                                          </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 505      }                                                                                                             </span>
<span  style=""> 506                                                                                                                    </span>
<span class="8520324044054424760" onmouseenter="enter('8520324044054424760');" onmouseout="out('8520324044054424760');" style=""> 507      protected long getMaxUploadableFileSize() {                                                                   </span>
<span class="-8242800191702968016" onmouseenter="enter('-8242800191702968016');" onmouseout="out('-8242800191702968016');" style=""> 508          Long blcUploadSize = env.getProperty(&quot;asset.server.max.uploadable.file.size&quot;, Long.class);                </span>
<span class="-6815277628371519591" onmouseenter="enter('-6815277628371519591');" onmouseout="out('-6815277628371519591');" style=""> 509          if (blcUploadSize != null) {                                                                              </span>
<span class="-2122879694774875974" onmouseenter="enter('-2122879694774875974');" onmouseout="out('-2122879694774875974');" style=""> 510              return blcUploadSize;                                                                                 </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 511          }                                                                                                         </span>
<span  style=""> 512                                                                                                                    </span>
<span class="-83413303193047685" onmouseenter="enter('-83413303193047685');" onmouseout="out('-83413303193047685');" style=""> 513          if (defaultMultipartSettings != null) {                                                                   </span>
<span class="3781451292667627704" onmouseenter="enter('3781451292667627704');" onmouseout="out('3781451292667627704');" style=""> 514              return defaultMultipartSettings.createMultipartConfig().getMaxFileSize();                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 515          }                                                                                                         </span>
<span class="8028643923497516300" onmouseenter="enter('8028643923497516300');" onmouseout="out('8028643923497516300');" style=""> 516          return DEFAULT_ASSET_UPLOAD_SIZE;                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 517      }                                                                                                             </span>
<span  style=""> 518                                                                                                                    </span>
<span class="-4925501260426057745" onmouseenter="enter('-4925501260426057745');" onmouseout="out('-4925501260426057745');" style=""> 519      protected long getMaxUploadableImageSize() {                                                                  </span>
<span class="2537324483761513782" onmouseenter="enter('2537324483761513782');" onmouseout="out('2537324483761513782');" style=""> 520          // backwards-compatibility checks, only use the image-size specific property if it is                     </span>
<span class="4617761826312627412" onmouseenter="enter('4617761826312627412');" onmouseout="out('4617761826312627412');" style=""> 521          // not the default value. Otherwise, delegate to the old property                                         </span>
<span class="7612408840010340391" onmouseenter="enter('7612408840010340391');" onmouseout="out('7612408840010340391');" style=""> 522          Long maxImgSize = env.getProperty(&quot;asset.server.max.uploadable.image.size&quot;, Long.class);                  </span>
<span class="-430636607829496210" onmouseenter="enter('-430636607829496210');" onmouseout="out('-430636607829496210');" style=""> 523          if (maxImgSize == null) {                                                                                 </span>
<span class="7342651561788072273" onmouseenter="enter('7342651561788072273');" onmouseout="out('7342651561788072273');" style=""> 524              return getMaxUploadableFileSize();                                                                    </span>
<span class="-6023928394739582014" onmouseenter="enter('-6023928394739582014');" onmouseout="out('-6023928394739582014');" style=""> 525          } else {                                                                                                  </span>
<span class="-7468174336769267749" onmouseenter="enter('-7468174336769267749');" onmouseout="out('-7468174336769267749');" style=""> 526              return maxImgSize;                                                                                    </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 527          }                                                                                                         </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 528      }                                                                                                             </span>
<span  style=""> 529                                                                                                                    </span>
<span class="3561631998050563638" onmouseenter="enter('3561631998050563638');" onmouseout="out('3561631998050563638');" style=""> 530      protected int getFileBufferSize() {                                                                           </span>
<span class="6759418199922005006" onmouseenter="enter('6759418199922005006');" onmouseout="out('6759418199922005006');" style=""> 531          return env.getProperty(&quot;asset.server.file.buffer.size&quot;, int.class, DEFAULT_BUFFER_SIZE);                  </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 532      }                                                                                                             </span>
<span  style=""> 533                                                                                                                    </span>
<span class="-7892865232186196236" onmouseenter="enter('-7892865232186196236');" onmouseout="out('-7892865232186196236');" style=""> 534      protected List&lt;String&gt; getAdminImageFileExtensions() {                                                        </span>
<span class="4831601876827029435" onmouseenter="enter('4831601876827029435');" onmouseout="out('4831601876827029435');" style=""><abbr title=" 535          String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENSIONS);"> 535          String extensions = env.getProperty(&quot;admin.image.file.extensions&quot;, String.class, DEFAULT_ADMIN_IMAGE_EXTENðŸ”µ</abbr></span>
<span class="-1830661333141003565" onmouseenter="enter('-1830661333141003565');" onmouseout="out('-1830661333141003565');" style=""> 536          return Arrays.asList(extensions.split(&quot;,&quot;));                                                              </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 537      }                                                                                                             </span>
<span class="-1659227874853751674" onmouseenter="enter('-1659227874853751674');" onmouseout="out('-1659227874853751674');" style=""> 538  }                                                                                                                 </span></pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            