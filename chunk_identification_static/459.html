<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>459</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    459
                    <a href="458.html">prev</a>
                    <a href="460.html">next</a>
                    <a href="459_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    CyanogenMod/android_packages_apps_Trebuchet_9e5d50c6de67b17c01b486a66e3c25070b456ebc_src/com/android/launcher3/LauncherClings.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;9e5d50c6de67b17c01b486a66e3c25070b456ebc:src/com/android/launcher3/LauncherClings.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;9e5d50c6de67b17c01b486a66e3c25070b456ebc^1:src/com/android/launcher3/LauncherClings.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;9e5d50c6de67b17c01b486a66e3c25070b456ebc^2:src/com/android/launcher3/LauncherClings.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;a4d0ef3c84cb5a9951d7d967c2c99d54d573f927:src/com/android/launcher3/LauncherClings.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Copyright (C) 2008 The Android Open Source Project
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.android.launcher3;
  18 
  19 import android.accounts.Account;
  20 import android.accounts.AccountManager;
  21 import android.animation.Animator;
  22 import android.animation.AnimatorListenerAdapter;
  23 import android.app.ActivityManager;
  24 import android.content.Context;
  25 import android.content.SharedPreferences;
  26 import android.graphics.Rect;
  27 import android.os.Bundle;
  28 import android.os.UserManager;
  29 import android.view.LayoutInflater;
  30 import android.view.View;
  31 import android.view.ViewGroup;
  32 import android.view.accessibility.AccessibilityManager;
  33 import android.widget.TextView;
  34 
  35 class LauncherClings {
  36     private static final String FIRST_RUN_CLING_DISMISSED_KEY = &quot;cling_gel.first_run.dismissed&quot;;
  37     private static final String MIGRATION_CLING_DISMISSED_KEY = &quot;cling_gel.migration.dismissed&quot;;
  38     private static final String MIGRATION_WORKSPACE_CLING_DISMISSED_KEY =
  39             &quot;cling_gel.migration_workspace.dismissed&quot;;
  40     private static final String WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.workspace.dismissed&quot;;
  41     private static final String FOLDER_CLING_DISMISSED_KEY = &quot;cling_gel.folder.dismissed&quot;;
  42 
  43     private static final boolean DISABLE_CLINGS = false;
  44     private static final boolean DISABLE_CUSTOM_CLINGS = true;
  45 
  46     private static final int SHOW_CLING_DURATION = 250;
  47     private static final int DISMISS_CLING_DURATION = 200;
  48 
  49     private Launcher mLauncher;
  50     private LayoutInflater mInflater;
  51     private HideFromAccessibilityHelper mHideFromAccessibilityHelper
  52             = new HideFromAccessibilityHelper();
  53 
  54     /** Ctor */
  55     public LauncherClings(Launcher launcher) {
  56         mLauncher = launcher;
  57         mInflater = mLauncher.getLayoutInflater();
  58     }
  59 
  60     /** Initializes a cling */
  61     private Cling initCling(int clingId, int scrimId, boolean animate,
  62                             boolean dimNavBarVisibilty) {
  63         Cling cling = (Cling) mLauncher.findViewById(clingId);
  64         View scrim = null;
  65         if (scrimId &gt; 0) {
  66             scrim = mLauncher.findViewById(scrimId);
  67         }
  68         if (cling != null) {
  69             cling.init(mLauncher, scrim);
  70             cling.show(animate, SHOW_CLING_DURATION);
  71 
  72             if (dimNavBarVisibilty) {
  73                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() |
  74                         View.SYSTEM_UI_FLAG_LOW_PROFILE);
  75             }
  76         }
  77         return cling;
  78     }
  79 
  80     /** Returns whether the clings are enabled or should be shown */
  81     private boolean areClingsEnabled() {
  82         if (DISABLE_CLINGS) {
  83             return false;
  84         }
  85 
  86         // disable clings when running in a test harness
  87         if(ActivityManager.isRunningInTestHarness()) return false;
  88 
  89         // Disable clings for accessibility when explore by touch is enabled
  90         final AccessibilityManager a11yManager = (AccessibilityManager) mLauncher.getSystemService(
  91                 Launcher.ACCESSIBILITY_SERVICE);
  92         if (a11yManager.isTouchExplorationEnabled()) {
  93             return false;
  94         }
  95 
  96         // Restricted secondary users (child mode) will potentially have very few apps
  97         // seeded when they start up for the first time. Clings won&#x27;t work well with that
  98         boolean supportsLimitedUsers =
  99                 android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.JELLY_BEAN_MR2;
 100         Account[] accounts = AccountManager.get(mLauncher).getAccounts();
 101         if (supportsLimitedUsers &amp;&amp; accounts.length == 0) {
 102             UserManager um = (UserManager) mLauncher.getSystemService(Context.USER_SERVICE);
 103             Bundle restrictions = um.getUserRestrictions();
 104             if (restrictions.getBoolean(UserManager.DISALLOW_MODIFY_ACCOUNTS, false)) {
 105                 return false;
 106             }
 107         }
 108         return true;
 109     }
 110 
 111     /** Returns whether the folder cling is visible. */
 112     public boolean isFolderClingVisible() {
 113         Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 114         if (cling != null) {
 115             return cling.getVisibility() == View.VISIBLE;
 116         }
 117         return false;
 118     }
 119 
 120     private boolean skipCustomClingIfNoAccounts() {
 121         Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 122         boolean customCling = cling.getDrawIdentifier().equals(&quot;workspace_custom&quot;);
 123         if (customCling) {
 124             AccountManager am = AccountManager.get(mLauncher);
 125             if (am == null) return false;
 126             Account[] accounts = am.getAccountsByType(&quot;com.google&quot;);
 127             return accounts.length == 0;
 128         }
 129         return false;
 130     }
 131 
 132     /** Updates the first run cling custom content hint */
 133     private void setCustomContentHintVisibility(Cling cling, String ccHintStr, boolean visible,
 134                                                 boolean animate) {
 135         final TextView ccHint = (TextView) cling.findViewById(R.id.custom_content_hint);
 136         if (ccHint != null) {
 137             if (visible &amp;&amp; !ccHintStr.isEmpty()) {
 138                 ccHint.setText(ccHintStr);
 139                 ccHint.setVisibility(View.VISIBLE);
 140                 if (animate) {
 141                     ccHint.setAlpha(0f);
 142                     ccHint.animate().alpha(1f)
 143                             .setDuration(SHOW_CLING_DURATION)
 144                             .start();
 145                 } else {
 146                     ccHint.setAlpha(1f);
 147                 }
 148             } else {
 149                 if (animate) {
 150                     ccHint.animate().alpha(0f)
 151                             .setDuration(SHOW_CLING_DURATION)
 152                             .setListener(new AnimatorListenerAdapter() {
 153                                 @Override
 154                                 public void onAnimationEnd(Animator animation) {
 155                                     ccHint.setVisibility(View.GONE);
 156                                 }
 157                             })
 158                             .start();
 159                 } else {
 160                     ccHint.setAlpha(0f);
 161                     ccHint.setVisibility(View.GONE);
 162                 }
 163             }
 164         }
 165     }
 166 
 167     /** Updates the first run cling custom content hint */
 168     public void updateCustomContentHintVisibility() {
 169         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 170         String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 171 
 172         if (mLauncher.getWorkspace().hasCustomContent()) {
 173             // Show the custom content hint if ccHintStr is not empty
 174             if (cling != null) {
 175                 setCustomContentHintVisibility(cling, ccHintStr, true, true);
 176             }
 177         } else {
 178             // Hide the custom content hint
 179             if (cling != null) {
 180                 setCustomContentHintVisibility(cling, ccHintStr, false, true);
 181             }
 182         }
 183     }
 184 
 185     /** Updates the first run cling search bar hint. */
 186     public void updateSearchBarHint(String hint) {
 187         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 188         if (cling != null &amp;&amp; cling.getVisibility() == View.VISIBLE &amp;&amp; !hint.isEmpty()) {
 189             TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 190             sbHint.setText(hint);
 191             sbHint.setVisibility(View.VISIBLE);
 192         }
 193     }
 194 
 195     public boolean shouldShowFirstRunOrMigrationClings() {
 196         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 197         return areClingsEnabled() &amp;&amp;
 198             !sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false) &amp;&amp;
 199             !sharedPrefs.getBoolean(MIGRATION_CLING_DISMISSED_KEY, false) &amp;&amp;
 200             LauncherAppState.getLauncherProvider().wasNewDbCreated();
 201     }
 202 
 203     public void removeFirstRunAndMigrationClings() {
 204         removeCling(R.id.first_run_cling);
 205         removeCling(R.id.migration_cling);
 206     }
 207 
 208     /**
 209      * Shows the first run cling.
 210      *
 211      * This flow is mutually exclusive with showMigrationCling, and only runs if this Launcher
 212      * package was preinstalled or there is no db to migrate from.
 213      */
 214     public void showFirstRunCling() {
 215         if (!skipCustomClingIfNoAccounts()) {
 216             SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 217             // If we&#x27;re not using the default workspace layout, replace workspace cling
 218             // with a custom workspace cling (usually specified in an overlay)
 219             // For now, only do this on tablets
 220             if (!DISABLE_CUSTOM_CLINGS) {
 221                 if (sharedPrefs.getInt(LauncherProvider.DEFAULT_WORKSPACE_RESOURCE_ID, 0) != 0 &amp;&amp;
 222                         mLauncher.getResources().getBoolean(R.bool.config_useCustomClings)) {
 223                     // Use a custom cling
 224                     View cling = mLauncher.findViewById(R.id.workspace_cling);
 225                     ViewGroup clingParent = (ViewGroup) cling.getParent();
 226                     int clingIndex = clingParent.indexOfChild(cling);
 227                     clingParent.removeViewAt(clingIndex);
 228                     View customCling = mInflater.inflate(R.layout.custom_workspace_cling,
 229                             clingParent, false);
 230                     clingParent.addView(customCling, clingIndex);
 231                     customCling.setId(R.id.workspace_cling);
 232                 }
 233             }
 234             Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 235             if (cling != null) {
 236                 String sbHintStr = mLauncher.getFirstRunClingSearchBarHint();
 237                 String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 238                 if (!sbHintStr.isEmpty()) {
 239                     TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 240                     sbHint.setText(sbHintStr);
 241                     sbHint.setVisibility(View.VISIBLE);
 242                 }
 243                 setCustomContentHintVisibility(cling, ccHintStr, true, false);
 244             }
 245             initCling(R.id.first_run_cling, 0, false, true);
 246         } else {
 247             removeFirstRunAndMigrationClings();
 248         }
 249     }
 250 
 251     /**
 252      * Shows the migration cling.
 253      *
 254      * This flow is mutually exclusive with showFirstRunCling, and only runs if this Launcher
 255      * package was not preinstalled and there exists a db to migrate from.
 256      */
 257     public void showMigrationCling() {
 258         mLauncher.hideWorkspaceSearchAndHotseat();
 259 
 260         Cling c = initCling(R.id.migration_cling, 0, false, true);
 261         c.bringScrimToFront();
 262         c.bringToFront();
 263     }
 264 
 265     public void showMigrationWorkspaceCling() {
 266         // Enable the clings only if they have not been dismissed before
 267         if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 268                 MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, false)) {
 269             Cling c = initCling(R.id.migration_workspace_cling, 0, false, true);
 270             c.updateMigrationWorkspaceBubblePosition();
 271             c.bringScrimToFront();
 272             c.bringToFront();
 273         } else {
 274             removeCling(R.id.migration_workspace_cling);
 275         }
 276     }
 277 
 278     public void showWorkspaceCling() {
 279         // Enable the clings only if they have not been dismissed before
 280         if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 281                 WORKSPACE_CLING_DISMISSED_KEY, false)) {
 282             Cling c = initCling(R.id.workspace_cling, 0, false, true);
 283             c.updateWorkspaceBubblePosition();
 284 
 285             // Set the focused hotseat app if there is one
 286             c.setFocusedHotseatApp(mLauncher.getFirstRunFocusedHotseatAppDrawableId(),
 287                     mLauncher.getFirstRunFocusedHotseatAppRank(),
 288                     mLauncher.getFirstRunFocusedHotseatAppComponentName(),
 289                     mLauncher.getFirstRunFocusedHotseatAppBubbleTitle(),
 290                     mLauncher.getFirstRunFocusedHotseatAppBubbleDescription());
 291         } else {
 292             removeCling(R.id.workspace_cling);
 293         }
 294     }
 295     public Cling showFoldersCling() {
 296         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 297         // Enable the clings only if they have not been dismissed before
 298         if (areClingsEnabled() &amp;&amp;
 299                 !sharedPrefs.getBoolean(FOLDER_CLING_DISMISSED_KEY, false) &amp;&amp;
 300                 !sharedPrefs.getBoolean(Launcher.USER_HAS_MIGRATED, false)) {
 301             Cling cling = initCling(R.id.folder_cling, R.id.cling_scrim,
 302                     true, true);
 303             Folder openFolder = mLauncher.getWorkspace().getOpenFolder();
 304             if (openFolder != null) {
 305                 Rect openFolderRect = new Rect();
 306                 openFolder.getHitRect(openFolderRect);
 307                 cling.setOpenFolderRect(openFolderRect);
 308                 openFolder.bringToFront();
 309             }
 310             return cling;
 311         } else {
 312             removeCling(R.id.folder_cling);
 313             return null;
 314         }
 315     }
 316 
 317 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 318 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319     public static void synchonouslyMarkFirstRunClingDismissed(Context ctx) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320         SharedPreferences prefs = ctx.getSharedPreferences(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321                 LauncherAppState.getSharedPreferencesKey(),Context.MODE_PRIVATE);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322         SharedPreferences.Editor editor = prefs.edit();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323         editor.putBoolean(LauncherClings.FIRST_RUN_CLING_DISMISSED_KEY, true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324         editor.commit();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327     /** Removes the cling outright from the DragLayer */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328     private void removeCling(int id) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329         final View cling = mLauncher.findViewById(id);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330         if (cling != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331             final ViewGroup parent = (ViewGroup) cling.getParent();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332             parent.post(new Runnable() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333                 @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334                 public void run() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335                     parent.removeView(cling);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337             });</span>
 338 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 339     public static void synchonouslyMarkFirstRunClingDismissed(Context ctx) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 340         SharedPreferences prefs = ctx.getSharedPreferences(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 341                 LauncherAppState.getSharedPreferencesKey(), Context.MODE_PRIVATE);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 342         SharedPreferences.Editor editor = prefs.edit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 343         editor.putBoolean(LauncherClings.FIRST_RUN_CLING_DISMISSED_KEY, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 344         editor.commit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 345     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 346 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 347     public void markFolderClingDismissed() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 348         SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 349         editor.putBoolean(LauncherClings.FOLDER_CLING_DISMISSED_KEY, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 350         editor.apply();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 351     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 352 </span>
 353 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 354     /** Removes the cling outright from the DragLayer */
 355     private void removeCling(int id) {
 356         final View cling = mLauncher.findViewById(id);
 357         if (cling != null) {
 358             final ViewGroup parent = (ViewGroup) cling.getParent();
 359             parent.post(new Runnable() {
 360                 @Override
 361                 public void run() {
 362                     parent.removeView(cling);
 363                 }
 364             });
 365             mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 366         }
 367     }
 368 
 369     /** Hides the specified Cling */
 370     private void dismissCling(final Cling cling, final Runnable postAnimationCb,
 371                               final String flag, int duration, boolean restoreNavBarVisibilty) {
 372         // To catch cases where siblings of top-level views are made invisible, just check whether
 373         // the cling is directly set to GONE before dismissing it.
 374         if (cling != null &amp;&amp; cling.getVisibility() != View.GONE) {
 375             final Runnable cleanUpClingCb = new Runnable() {
 376                 public void run() {
 377                     cling.cleanup();
 378                     SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();
 379                     editor.putBoolean(flag, true);
 380                     editor.apply();
 381                     if (postAnimationCb != null) {
 382                         postAnimationCb.run();
 383                     }
 384                 }
 385             };
 386             if (duration &lt;= 0) {
 387                 cleanUpClingCb.run();
 388             } else {
 389                 cling.hide(duration, cleanUpClingCb);
 390             }
 391             mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 392 
 393             if (restoreNavBarVisibilty) {
 394                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() &amp;
 395                         ~View.SYSTEM_UI_FLAG_LOW_PROFILE);
 396             }
 397         }
 398     }
 399 
 400     public void dismissFirstRunCling(View v) {
 401         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 402         Runnable cb = new Runnable() {
 403             public void run() {
 404                 // Show the workspace cling next
 405                 showWorkspaceCling();
 406             }
 407         };
 408         dismissCling(cling, cb, FIRST_RUN_CLING_DISMISSED_KEY,
 409                 DISMISS_CLING_DURATION, false);
 410 
 411         // Fade out the search bar for the workspace cling coming up
 412         mLauncher.getSearchBar().hideSearchBar(true);
 413     }
 414 
 415     private void dismissMigrationCling() {
 416         mLauncher.showWorkspaceSearchAndHotseat();
 417         Runnable dismissCb = new Runnable() {
 418             public void run() {
 419                 Cling cling = (Cling) mLauncher.findViewById(R.id.migration_cling);
 420                 Runnable cb = new Runnable() {
 421                     public void run() {
 422                         // Show the migration workspace cling next
 423                         showMigrationWorkspaceCling();
 424                     }
 425                 };
 426                 dismissCling(cling, cb, MIGRATION_CLING_DISMISSED_KEY,
 427                         DISMISS_CLING_DURATION, true);
 428             }
 429         };
 430         mLauncher.getWorkspace().post(dismissCb);
 431     }
 432 
 433     private void dismissAnyWorkspaceCling(Cling cling, String key, View v) {
 434         Runnable cb = null;
 435         if (v == null) {
 436             cb = new Runnable() {
 437                 public void run() {
 438                     mLauncher.getWorkspace().enterOverviewMode();
 439                 }
 440             };
 441         }
 442         dismissCling(cling, cb, key, DISMISS_CLING_DURATION, true);
 443 
 444         // Fade in the search bar
 445         mLauncher.getSearchBar().showSearchBar(true);
 446     }
 447 
 448     public void dismissMigrationClingCopyApps(View v) {
 449         // Copy the shortcuts from the old database
 450         LauncherModel model = mLauncher.getModel();
 451         model.resetLoadedState(false, true);
 452         model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 453                 LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE
 454                         | LauncherModel.LOADER_FLAG_MIGRATE_SHORTCUTS);
 455 
 456         // Set the flag to skip the folder cling
 457         String spKey = LauncherAppState.getSharedPreferencesKey();
 458         SharedPreferences sp = mLauncher.getSharedPreferences(spKey, Context.MODE_PRIVATE);
 459         SharedPreferences.Editor editor = sp.edit();
 460         editor.putBoolean(Launcher.USER_HAS_MIGRATED, true);
 461         editor.apply();
 462 
 463         // Disable the migration cling
 464         dismissMigrationCling();
 465     }
 466 
 467     public void dismissMigrationClingUseDefault(View v) {
 468         // Clear the workspace
 469         LauncherModel model = mLauncher.getModel();
 470         model.resetLoadedState(false, true);
 471         model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 472                 LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE);
 473 
 474         // Disable the migration cling
 475         dismissMigrationCling();
 476     }
 477 
 478     public void dismissMigrationWorkspaceCling(View v) {
 479         Cling cling = (Cling) mLauncher.findViewById(R.id.migration_workspace_cling);
 480         dismissAnyWorkspaceCling(cling, MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, v);
 481     }
 482 
 483     public void dismissWorkspaceCling(View v) {
 484         Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 485         dismissAnyWorkspaceCling(cling, WORKSPACE_CLING_DISMISSED_KEY, v);
 486     }
 487 
 488     public void dismissFolderCling(View v) {
 489         Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 490         dismissCling(cling, null, FOLDER_CLING_DISMISSED_KEY,
 491                 DISMISS_CLING_DURATION, true);
 492     }
 493 }</pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2008 The Android Open Source Project
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.android.launcher3;
  18 
  19 import android.accounts.Account;
  20 import android.accounts.AccountManager;
  21 import android.animation.Animator;
  22 import android.animation.AnimatorListenerAdapter;
  23 import android.app.ActivityManager;
  24 import android.content.Context;
  25 import android.content.SharedPreferences;
  26 import android.graphics.Rect;
  27 import android.os.Bundle;
  28 import android.os.UserManager;
  29 import android.view.LayoutInflater;
  30 import android.view.View;
  31 import android.view.ViewGroup;
  32 import android.view.accessibility.AccessibilityManager;
  33 import android.widget.TextView;
  34 
  35 class LauncherClings {
  36     private static final String FIRST_RUN_CLING_DISMISSED_KEY = &quot;cling_gel.first_run.dismissed&quot;;
  37     private static final String MIGRATION_CLING_DISMISSED_KEY = &quot;cling_gel.migration.dismissed&quot;;
  38     private static final String MIGRATION_WORKSPACE_CLING_DISMISSED_KEY =
  39             &quot;cling_gel.migration_workspace.dismissed&quot;;
  40     private static final String WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.workspace.dismissed&quot;;
  41     private static final String FOLDER_CLING_DISMISSED_KEY = &quot;cling_gel.folder.dismissed&quot;;
  42 
  43     private static final boolean DISABLE_CLINGS = false;
  44     private static final boolean DISABLE_CUSTOM_CLINGS = true;
  45 
  46     private static final int SHOW_CLING_DURATION = 250;
  47     private static final int DISMISS_CLING_DURATION = 200;
  48 
  49     private Launcher mLauncher;
  50     private LayoutInflater mInflater;
  51     private HideFromAccessibilityHelper mHideFromAccessibilityHelper
  52             = new HideFromAccessibilityHelper();
  53 
  54     /** Ctor */
  55     public LauncherClings(Launcher launcher) {
  56         mLauncher = launcher;
  57         mInflater = mLauncher.getLayoutInflater();
  58     }
  59 
  60     /** Initializes a cling */
  61     private Cling initCling(int clingId, int scrimId, boolean animate,
  62                             boolean dimNavBarVisibilty) {
  63         Cling cling = (Cling) mLauncher.findViewById(clingId);
  64         View scrim = null;
  65         if (scrimId &gt; 0) {
  66             scrim = mLauncher.findViewById(scrimId);
  67         }
  68         if (cling != null) {
  69             cling.init(mLauncher, scrim);
  70             cling.show(animate, SHOW_CLING_DURATION);
  71 
  72             if (dimNavBarVisibilty) {
  73                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() |
  74                         View.SYSTEM_UI_FLAG_LOW_PROFILE);
  75             }
  76         }
  77         return cling;
  78     }
  79 
  80     /** Returns whether the clings are enabled or should be shown */
  81     private boolean areClingsEnabled() {
  82         if (DISABLE_CLINGS) {
  83             return false;
  84         }
  85 
  86         // disable clings when running in a test harness
  87         if(ActivityManager.isRunningInTestHarness()) return false;
  88 
  89         // Disable clings for accessibility when explore by touch is enabled
  90         final AccessibilityManager a11yManager = (AccessibilityManager) mLauncher.getSystemService(
  91                 Launcher.ACCESSIBILITY_SERVICE);
  92         if (a11yManager.isTouchExplorationEnabled()) {
  93             return false;
  94         }
  95 
  96         // Restricted secondary users (child mode) will potentially have very few apps
  97         // seeded when they start up for the first time. Clings won&#x27;t work well with that
  98         boolean supportsLimitedUsers =
  99                 android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.JELLY_BEAN_MR2;
 100         Account[] accounts = AccountManager.get(mLauncher).getAccounts();
 101         if (supportsLimitedUsers &amp;&amp; accounts.length == 0) {
 102             UserManager um = (UserManager) mLauncher.getSystemService(Context.USER_SERVICE);
 103             Bundle restrictions = um.getUserRestrictions();
 104             if (restrictions.getBoolean(UserManager.DISALLOW_MODIFY_ACCOUNTS, false)) {
 105                 return false;
 106             }
 107         }
 108         return true;
 109     }
 110 
 111     /** Returns whether the folder cling is visible. */
 112     public boolean isFolderClingVisible() {
 113         Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 114         if (cling != null) {
 115             return cling.getVisibility() == View.VISIBLE;
 116         }
 117         return false;
 118     }
 119 
 120     private boolean skipCustomClingIfNoAccounts() {
 121         Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 122         boolean customCling = cling.getDrawIdentifier().equals(&quot;workspace_custom&quot;);
 123         if (customCling) {
 124             AccountManager am = AccountManager.get(mLauncher);
 125             if (am == null) return false;
 126             Account[] accounts = am.getAccountsByType(&quot;com.google&quot;);
 127             return accounts.length == 0;
 128         }
 129         return false;
 130     }
 131 
 132     /** Updates the first run cling custom content hint */
 133     private void setCustomContentHintVisibility(Cling cling, String ccHintStr, boolean visible,
 134                                                 boolean animate) {
 135         final TextView ccHint = (TextView) cling.findViewById(R.id.custom_content_hint);
 136         if (ccHint != null) {
 137             if (visible &amp;&amp; !ccHintStr.isEmpty()) {
 138                 ccHint.setText(ccHintStr);
 139                 ccHint.setVisibility(View.VISIBLE);
 140                 if (animate) {
 141                     ccHint.setAlpha(0f);
 142                     ccHint.animate().alpha(1f)
 143                             .setDuration(SHOW_CLING_DURATION)
 144                             .start();
 145                 } else {
 146                     ccHint.setAlpha(1f);
 147                 }
 148             } else {
 149                 if (animate) {
 150                     ccHint.animate().alpha(0f)
 151                             .setDuration(SHOW_CLING_DURATION)
 152                             .setListener(new AnimatorListenerAdapter() {
 153                                 @Override
 154                                 public void onAnimationEnd(Animator animation) {
 155                                     ccHint.setVisibility(View.GONE);
 156                                 }
 157                             })
 158                             .start();
 159                 } else {
 160                     ccHint.setAlpha(0f);
 161                     ccHint.setVisibility(View.GONE);
 162                 }
 163             }
 164         }
 165     }
 166 
 167     /** Updates the first run cling custom content hint */
 168     public void updateCustomContentHintVisibility() {
 169         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 170         String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 171 
 172         if (mLauncher.getWorkspace().hasCustomContent()) {
 173             // Show the custom content hint if ccHintStr is not empty
 174             if (cling != null) {
 175                 setCustomContentHintVisibility(cling, ccHintStr, true, true);
 176             }
 177         } else {
 178             // Hide the custom content hint
 179             if (cling != null) {
 180                 setCustomContentHintVisibility(cling, ccHintStr, false, true);
 181             }
 182         }
 183     }
 184 
 185     /** Updates the first run cling search bar hint. */
 186     public void updateSearchBarHint(String hint) {
 187         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 188         if (cling != null &amp;&amp; cling.getVisibility() == View.VISIBLE &amp;&amp; !hint.isEmpty()) {
 189             TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 190             sbHint.setText(hint);
 191             sbHint.setVisibility(View.VISIBLE);
 192         }
 193     }
 194 
 195     public boolean shouldShowFirstRunOrMigrationClings() {
 196         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 197         return areClingsEnabled() &amp;&amp;
 198             !sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false) &amp;&amp;
 199             !sharedPrefs.getBoolean(MIGRATION_CLING_DISMISSED_KEY, false) &amp;&amp;
 200             LauncherAppState.getLauncherProvider().wasNewDbCreated();
 201     }
 202 
 203     public void removeFirstRunAndMigrationClings() {
 204         removeCling(R.id.first_run_cling);
 205         removeCling(R.id.migration_cling);
 206     }
 207 
 208     /**
 209      * Shows the first run cling.
 210      *
 211      * This flow is mutually exclusive with showMigrationCling, and only runs if this Launcher
 212      * package was preinstalled or there is no db to migrate from.
 213      */
 214     public void showFirstRunCling() {
 215         if (!skipCustomClingIfNoAccounts()) {
 216             SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 217             // If we&#x27;re not using the default workspace layout, replace workspace cling
 218             // with a custom workspace cling (usually specified in an overlay)
 219             // For now, only do this on tablets
 220             if (!DISABLE_CUSTOM_CLINGS) {
 221                 if (sharedPrefs.getInt(LauncherProvider.DEFAULT_WORKSPACE_RESOURCE_ID, 0) != 0 &amp;&amp;
 222                         mLauncher.getResources().getBoolean(R.bool.config_useCustomClings)) {
 223                     // Use a custom cling
 224                     View cling = mLauncher.findViewById(R.id.workspace_cling);
 225                     ViewGroup clingParent = (ViewGroup) cling.getParent();
 226                     int clingIndex = clingParent.indexOfChild(cling);
 227                     clingParent.removeViewAt(clingIndex);
 228                     View customCling = mInflater.inflate(R.layout.custom_workspace_cling,
 229                             clingParent, false);
 230                     clingParent.addView(customCling, clingIndex);
 231                     customCling.setId(R.id.workspace_cling);
 232                 }
 233             }
 234             Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 235             if (cling != null) {
 236                 String sbHintStr = mLauncher.getFirstRunClingSearchBarHint();
 237                 String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 238                 if (!sbHintStr.isEmpty()) {
 239                     TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 240                     sbHint.setText(sbHintStr);
 241                     sbHint.setVisibility(View.VISIBLE);
 242                 }
 243                 setCustomContentHintVisibility(cling, ccHintStr, true, false);
 244             }
 245             initCling(R.id.first_run_cling, 0, false, true);
 246         } else {
 247             removeFirstRunAndMigrationClings();
 248         }
 249     }
 250 
 251     /**
 252      * Shows the migration cling.
 253      *
 254      * This flow is mutually exclusive with showFirstRunCling, and only runs if this Launcher
 255      * package was not preinstalled and there exists a db to migrate from.
 256      */
 257     public void showMigrationCling() {
 258         mLauncher.hideWorkspaceSearchAndHotseat();
 259 
 260         Cling c = initCling(R.id.migration_cling, 0, false, true);
 261         c.bringScrimToFront();
 262         c.bringToFront();
 263     }
 264 
 265     public void showMigrationWorkspaceCling() {
 266         // Enable the clings only if they have not been dismissed before
 267         if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 268                 MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, false)) {
 269             Cling c = initCling(R.id.migration_workspace_cling, 0, false, true);
 270             c.updateMigrationWorkspaceBubblePosition();
 271             c.bringScrimToFront();
 272             c.bringToFront();
 273         } else {
 274             removeCling(R.id.migration_workspace_cling);
 275         }
 276     }
 277 
 278     public void showWorkspaceCling() {
 279         // Enable the clings only if they have not been dismissed before
 280         if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 281                 WORKSPACE_CLING_DISMISSED_KEY, false)) {
 282             Cling c = initCling(R.id.workspace_cling, 0, false, true);
 283             c.updateWorkspaceBubblePosition();
 284 
 285             // Set the focused hotseat app if there is one
 286             c.setFocusedHotseatApp(mLauncher.getFirstRunFocusedHotseatAppDrawableId(),
 287                     mLauncher.getFirstRunFocusedHotseatAppRank(),
 288                     mLauncher.getFirstRunFocusedHotseatAppComponentName(),
 289                     mLauncher.getFirstRunFocusedHotseatAppBubbleTitle(),
 290                     mLauncher.getFirstRunFocusedHotseatAppBubbleDescription());
 291         } else {
 292             removeCling(R.id.workspace_cling);
 293         }
 294     }
 295     public Cling showFoldersCling() {
 296         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 297         // Enable the clings only if they have not been dismissed before
 298         if (areClingsEnabled() &amp;&amp;
 299                 !sharedPrefs.getBoolean(FOLDER_CLING_DISMISSED_KEY, false) &amp;&amp;
 300                 !sharedPrefs.getBoolean(Launcher.USER_HAS_MIGRATED, false)) {
 301             Cling cling = initCling(R.id.folder_cling, R.id.cling_scrim,
 302                     true, true);
 303             Folder openFolder = mLauncher.getWorkspace().getOpenFolder();
 304             if (openFolder != null) {
 305                 Rect openFolderRect = new Rect();
 306                 openFolder.getHitRect(openFolderRect);
 307                 cling.setOpenFolderRect(openFolderRect);
 308                 openFolder.bringToFront();
 309             }
 310             return cling;
 311         } else {
 312             removeCling(R.id.folder_cling);
 313             return null;
 314         }
 315     }
 316 
 317     public void markFolderClingDismissed() {
 318         SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();
 319         editor.putBoolean(LauncherClings.FOLDER_CLING_DISMISSED_KEY, true);
 320         editor.apply();
 321     }
 322 
 323     /** Removes the cling outright from the DragLayer */
 324     private void removeCling(int id) {
 325         final View cling = mLauncher.findViewById(id);
 326         if (cling != null) {
 327             final ViewGroup parent = (ViewGroup) cling.getParent();
 328             parent.post(new Runnable() {
 329                 @Override
 330                 public void run() {
 331                     parent.removeView(cling);
 332                 }
 333             });
 334             mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 335         }
 336     }
 337 
 338     /** Hides the specified Cling */
 339     private void dismissCling(final Cling cling, final Runnable postAnimationCb,
 340                               final String flag, int duration, boolean restoreNavBarVisibilty) {
 341         // To catch cases where siblings of top-level views are made invisible, just check whether
 342         // the cling is directly set to GONE before dismissing it.
 343         if (cling != null &amp;&amp; cling.getVisibility() != View.GONE) {
 344             final Runnable cleanUpClingCb = new Runnable() {
 345                 public void run() {
 346                     cling.cleanup();
 347                     SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();
 348                     editor.putBoolean(flag, true);
 349                     editor.apply();
 350                     if (postAnimationCb != null) {
 351                         postAnimationCb.run();
 352                     }
 353                 }
 354             };
 355             if (duration &lt;= 0) {
 356                 cleanUpClingCb.run();
 357             } else {
 358                 cling.hide(duration, cleanUpClingCb);
 359             }
 360             mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 361 
 362             if (restoreNavBarVisibilty) {
 363                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() &amp;
 364                         ~View.SYSTEM_UI_FLAG_LOW_PROFILE);
 365             }
 366         }
 367     }
 368 
 369     public void dismissFirstRunCling(View v) {
 370         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 371         Runnable cb = new Runnable() {
 372             public void run() {
 373                 // Show the workspace cling next
 374                 showWorkspaceCling();
 375             }
 376         };
 377         dismissCling(cling, cb, FIRST_RUN_CLING_DISMISSED_KEY,
 378                 DISMISS_CLING_DURATION, false);
 379 
 380         // Fade out the search bar for the workspace cling coming up
 381         mLauncher.getSearchBar().hideSearchBar(true);
 382     }
 383 
 384     private void dismissMigrationCling() {
 385         mLauncher.showWorkspaceSearchAndHotseat();
 386         Runnable dismissCb = new Runnable() {
 387             public void run() {
 388                 Cling cling = (Cling) mLauncher.findViewById(R.id.migration_cling);
 389                 Runnable cb = new Runnable() {
 390                     public void run() {
 391                         // Show the migration workspace cling next
 392                         showMigrationWorkspaceCling();
 393                     }
 394                 };
 395                 dismissCling(cling, cb, MIGRATION_CLING_DISMISSED_KEY,
 396                         DISMISS_CLING_DURATION, true);
 397             }
 398         };
 399         mLauncher.getWorkspace().post(dismissCb);
 400     }
 401 
 402     private void dismissAnyWorkspaceCling(Cling cling, String key, View v) {
 403         Runnable cb = null;
 404         if (v == null) {
 405             cb = new Runnable() {
 406                 public void run() {
 407                     mLauncher.getWorkspace().enterOverviewMode();
 408                 }
 409             };
 410         }
 411         dismissCling(cling, cb, key, DISMISS_CLING_DURATION, true);
 412 
 413         // Fade in the search bar
 414         mLauncher.getSearchBar().showSearchBar(true);
 415     }
 416 
 417     public void dismissMigrationClingCopyApps(View v) {
 418         // Copy the shortcuts from the old database
 419         LauncherModel model = mLauncher.getModel();
 420         model.resetLoadedState(false, true);
 421         model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 422                 LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE
 423                         | LauncherModel.LOADER_FLAG_MIGRATE_SHORTCUTS);
 424 
 425         // Set the flag to skip the folder cling
 426         String spKey = LauncherAppState.getSharedPreferencesKey();
 427         SharedPreferences sp = mLauncher.getSharedPreferences(spKey, Context.MODE_PRIVATE);
 428         SharedPreferences.Editor editor = sp.edit();
 429         editor.putBoolean(Launcher.USER_HAS_MIGRATED, true);
 430         editor.apply();
 431 
 432         // Disable the migration cling
 433         dismissMigrationCling();
 434     }
 435 
 436     public void dismissMigrationClingUseDefault(View v) {
 437         // Clear the workspace
 438         LauncherModel model = mLauncher.getModel();
 439         model.resetLoadedState(false, true);
 440         model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 441                 LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE);
 442 
 443         // Disable the migration cling
 444         dismissMigrationCling();
 445     }
 446 
 447     public void dismissMigrationWorkspaceCling(View v) {
 448         Cling cling = (Cling) mLauncher.findViewById(R.id.migration_workspace_cling);
 449         dismissAnyWorkspaceCling(cling, MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, v);
 450     }
 451 
 452     public void dismissWorkspaceCling(View v) {
 453         Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 454         dismissAnyWorkspaceCling(cling, WORKSPACE_CLING_DISMISSED_KEY, v);
 455     }
 456 
 457     public void dismissFolderCling(View v) {
 458         Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 459         dismissCling(cling, null, FOLDER_CLING_DISMISSED_KEY,
 460                 DISMISS_CLING_DURATION, true);
 461     }
 462 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2008 The Android Open Source Project
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.android.launcher3;
  17 
  18 import android.accounts.Account;
  19 import android.accounts.AccountManager;
  20 import android.animation.Animator;
  21 import android.animation.AnimatorListenerAdapter;
  22 import android.app.ActivityManager;
  23 import android.content.Context;
  24 import android.content.SharedPreferences;
  25 import android.graphics.Rect;
  26 import android.os.Bundle;
  27 import android.os.UserManager;
  28 import android.view.LayoutInflater;
  29 import android.view.View;
  30 import android.view.ViewGroup;
  31 import android.view.accessibility.AccessibilityManager;
  32 import android.widget.TextView;
  33 
  34 
  35 class LauncherClings {
  36     private static final String FIRST_RUN_CLING_DISMISSED_KEY = &quot;cling_gel.first_run.dismissed&quot;;
  37 
  38     private static final String MIGRATION_CLING_DISMISSED_KEY = &quot;cling_gel.migration.dismissed&quot;;
  39 
  40     private static final String MIGRATION_WORKSPACE_CLING_DISMISSED_KEY =
  41             &quot;cling_gel.migration_workspace.dismissed&quot;;
  42 
  43     private static final String WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.workspace.dismissed&quot;;
  44 
  45     private static final String FOLDER_CLING_DISMISSED_KEY = &quot;cling_gel.folder.dismissed&quot;;
  46 
  47     private static final boolean DISABLE_CLINGS = false;
  48 
  49     private static final boolean DISABLE_CUSTOM_CLINGS = true;
  50 
  51     private static final int SHOW_CLING_DURATION = 250;
  52 
  53     private static final int DISMISS_CLING_DURATION = 200;
  54 
  55     private Launcher mLauncher;
  56 
  57     private LayoutInflater mInflater;
  58 
  59     private HideFromAccessibilityHelper mHideFromAccessibilityHelper
  60             = new HideFromAccessibilityHelper();
  61 
  62     /**
  63      * Ctor
  64      */
  65     public LauncherClings(Launcher launcher) {
  66         mLauncher = launcher;
  67         mInflater = mLauncher.getLayoutInflater();
  68     }
  69 
  70     /** Initializes a cling */
  71     private Cling initCling(int clingId, int scrimId, boolean animate,
  72                             boolean dimNavBarVisibilty) {
  73         Cling cling = (Cling) mLauncher.findViewById(clingId);
  74         View scrim = null;
  75         if (scrimId &gt; 0) {
  76             scrim = mLauncher.findViewById(scrimId);
  77         }
  78         if (cling != null) {
  79             cling.init(mLauncher, scrim);
  80             cling.show(animate, SHOW_CLING_DURATION);
  81 
  82             if (dimNavBarVisibilty) {
  83                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() |
  84                         View.SYSTEM_UI_FLAG_LOW_PROFILE);
  85             }
  86         }
  87         return cling;
  88     }
  89 
  90     /** Returns whether the clings are enabled or should be shown */
  91     private boolean areClingsEnabled() {
  92         if (DISABLE_CLINGS) {
  93             return false;
  94         }
  95 
  96         // disable clings when running in a test harness
  97         if(ActivityManager.isRunningInTestHarness()) return false;
  98 
  99         // Disable clings for accessibility when explore by touch is enabled
 100         final AccessibilityManager a11yManager = (AccessibilityManager) mLauncher.getSystemService(
 101                 Launcher.ACCESSIBILITY_SERVICE);
 102         if (a11yManager.isTouchExplorationEnabled()) {
 103             return false;
 104         }
 105 
 106         // Restricted secondary users (child mode) will potentially have very few apps
 107         // seeded when they start up for the first time. Clings won&#x27;t work well with that
 108         boolean supportsLimitedUsers =
 109                 android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.JELLY_BEAN_MR2;
 110         Account[] accounts = AccountManager.get(mLauncher).getAccounts();
 111         if (supportsLimitedUsers &amp;&amp; accounts.length == 0) {
 112             UserManager um = (UserManager) mLauncher.getSystemService(Context.USER_SERVICE);
 113             Bundle restrictions = um.getUserRestrictions();
 114             if (restrictions.getBoolean(UserManager.DISALLOW_MODIFY_ACCOUNTS, false)) {
 115                 return false;
 116             }
 117         }
 118         return true;
 119     }
 120 
 121     /** Returns whether the folder cling is visible. */
 122     public boolean isFolderClingVisible() {
 123         Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 124         if (cling != null) {
 125             return cling.getVisibility() == View.VISIBLE;
 126         }
 127         return false;
 128     }
 129 
 130     private boolean skipCustomClingIfNoAccounts() {
 131         Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 132         boolean customCling = cling.getDrawIdentifier().equals(&quot;workspace_custom&quot;);
 133         if (customCling) {
 134             AccountManager am = AccountManager.get(mLauncher);
 135             if (am == null) return false;
 136             Account[] accounts = am.getAccountsByType(&quot;com.google&quot;);
 137             return accounts.length == 0;
 138         }
 139         return false;
 140     }
 141 
 142     /** Updates the first run cling custom content hint */
 143     private void setCustomContentHintVisibility(Cling cling, String ccHintStr, boolean visible,
 144                                                 boolean animate) {
 145         final TextView ccHint = (TextView) cling.findViewById(R.id.custom_content_hint);
 146         if (ccHint != null) {
 147             if (visible &amp;&amp; !ccHintStr.isEmpty()) {
 148                 ccHint.setText(ccHintStr);
 149                 ccHint.setVisibility(View.VISIBLE);
 150                 if (animate) {
 151                     ccHint.setAlpha(0f);
 152                     ccHint.animate().alpha(1f)
 153                             .setDuration(SHOW_CLING_DURATION)
 154                             .start();
 155                 } else {
 156                     ccHint.setAlpha(1f);
 157                 }
 158             } else {
 159                 if (animate) {
 160                     ccHint.animate().alpha(0f)
 161                             .setDuration(SHOW_CLING_DURATION)
 162                             .setListener(new AnimatorListenerAdapter() {
 163                                 @Override
 164                                 public void onAnimationEnd(Animator animation) {
 165                                     ccHint.setVisibility(View.GONE);
 166                                 }
 167                             })
 168                             .start();
 169                 } else {
 170                     ccHint.setAlpha(0f);
 171                     ccHint.setVisibility(View.GONE);
 172                 }
 173             }
 174         }
 175     }
 176 
 177     /** Updates the first run cling custom content hint */
 178     public void updateCustomContentHintVisibility() {
 179         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 180         String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 181 
 182         if (mLauncher.getWorkspace().hasCustomContent()) {
 183             // Show the custom content hint if ccHintStr is not empty
 184             if (cling != null) {
 185                 setCustomContentHintVisibility(cling, ccHintStr, true, true);
 186             }
 187         } else {
 188             // Hide the custom content hint
 189             if (cling != null) {
 190                 setCustomContentHintVisibility(cling, ccHintStr, false, true);
 191             }
 192         }
 193     }
 194 
 195     /** Updates the first run cling search bar hint. */
 196     public void updateSearchBarHint(String hint) {
 197         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 198         if (cling != null &amp;&amp; cling.getVisibility() == View.VISIBLE &amp;&amp; !hint.isEmpty()) {
 199             TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 200             sbHint.setText(hint);
 201             sbHint.setVisibility(View.VISIBLE);
 202         }
 203     }
 204 
 205     public boolean shouldShowFirstRunOrMigrationClings() {
 206         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
<abbr title=" 207         return ((areClingsEnabled() &amp;&amp; (!sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false))) &amp;&amp; (!sharedPrefs.getBoolean(MIGRATION_CLING_DISMISSED_KEY, false))) &amp;&amp; LauncherAppState.getLauncherProvider().wasNewDbCreated();"> 207         return ((areClingsEnabled() &amp;&amp; (!sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false))) &amp;</abbr>
 208     }
 209 
 210     public void removeFirstRunAndMigrationClings() {
 211         removeCling(R.id.first_run_cling);
 212         removeCling(R.id.migration_cling);
 213     }
 214 
 215     /**
 216      * Shows the first run cling.
 217      *
 218      * This flow is mutually exclusive with showMigrationCling, and only runs if this Launcher
 219      * package was preinstalled or there is no db to migrate from.
 220      */
 221     public void showFirstRunCling() {
 222         if (!skipCustomClingIfNoAccounts()) {
 223             SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 224             // If we&#x27;re not using the default workspace layout, replace workspace cling
 225             // with a custom workspace cling (usually specified in an overlay)
 226             // For now, only do this on tablets
 227             if (!DISABLE_CUSTOM_CLINGS) {
<abbr title=" 228                 if ((sharedPrefs.getInt(LauncherProvider.DEFAULT_WORKSPACE_RESOURCE_ID, 0) != 0) &amp;&amp; mLauncher.getResources().getBoolean(R.bool.config_useCustomClings)) {"> 228                 if ((sharedPrefs.getInt(LauncherProvider.DEFAULT_WORKSPACE_RESOURCE_ID, 0) != 0) &amp;&amp; mLaun</abbr>
 229                     // Use a custom cling
 230                     View cling = mLauncher.findViewById(R.id.workspace_cling);
 231                     ViewGroup clingParent = ((ViewGroup) (cling.getParent()));
 232                     int clingIndex = clingParent.indexOfChild(cling);
 233                     clingParent.removeViewAt(clingIndex);
<abbr title=" 234                     View customCling = mInflater.inflate(R.layout.custom_workspace_cling, clingParent, false);"> 234                     View customCling = mInflater.inflate(R.layout.custom_workspace_cling, clingParent, fa</abbr>
 235                     clingParent.addView(customCling, clingIndex);
 236                     customCling.setId(R.id.workspace_cling);
 237                 }
 238             }
 239             Cling cling = ((Cling) (mLauncher.findViewById(R.id.first_run_cling)));
 240             if (cling != null) {
 241                 String sbHintStr = mLauncher.getFirstRunClingSearchBarHint();
 242                 String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 243                 if (!sbHintStr.isEmpty()) {
 244                     TextView sbHint = ((TextView) (cling.findViewById(R.id.search_bar_hint)));
 245                     sbHint.setText(sbHintStr);
 246                     sbHint.setVisibility(View.VISIBLE);
 247                 }
 248                 setCustomContentHintVisibility(cling, ccHintStr, true, false);
 249             }
 250             initCling(R.id.first_run_cling, 0, false, true);
 251         } else {
 252             removeFirstRunAndMigrationClings();
 253         }
 254     }
 255 
 256     /**
 257      * Shows the migration cling.
 258      *
 259      * This flow is mutually exclusive with showFirstRunCling, and only runs if this Launcher
 260      * package was not preinstalled and there exists a db to migrate from.
 261      */
 262     public void showMigrationCling() {
 263         mLauncher.hideWorkspaceSearchAndHotseat();
 264 
 265         Cling c = initCling(R.id.migration_cling, 0, false, true);
 266         c.bringScrimToFront();
 267         c.bringToFront();
 268     }
 269 
 270     public void showMigrationWorkspaceCling() {
 271         // Enable the clings only if they have not been dismissed before
 272         if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 273                 MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, false)) {
 274             Cling c = initCling(R.id.migration_workspace_cling, 0, false, true);
 275             c.updateMigrationWorkspaceBubblePosition();
 276             c.bringScrimToFront();
 277             c.bringToFront();
 278         } else {
 279             removeCling(R.id.migration_workspace_cling);
 280         }
 281     }
 282 
 283     public void showWorkspaceCling() {
 284         // Enable the clings only if they have not been dismissed before
 285         if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 286                 WORKSPACE_CLING_DISMISSED_KEY, false)) {
 287             Cling c = initCling(R.id.workspace_cling, 0, false, true);
 288             c.updateWorkspaceBubblePosition();
 289 
 290             // Set the focused hotseat app if there is one
 291             c.setFocusedHotseatApp(mLauncher.getFirstRunFocusedHotseatAppDrawableId(),
 292                     mLauncher.getFirstRunFocusedHotseatAppRank(),
 293                     mLauncher.getFirstRunFocusedHotseatAppComponentName(),
 294                     mLauncher.getFirstRunFocusedHotseatAppBubbleTitle(),
 295                     mLauncher.getFirstRunFocusedHotseatAppBubbleDescription());
 296         } else {
 297             removeCling(R.id.workspace_cling);
 298         }
 299     }
 300 
 301     public Cling showFoldersCling() {
 302         SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 303         // Enable the clings only if they have not been dismissed before
 304         if (areClingsEnabled() &amp;&amp;
 305                 !sharedPrefs.getBoolean(FOLDER_CLING_DISMISSED_KEY, false) &amp;&amp;
 306                 !sharedPrefs.getBoolean(Launcher.USER_HAS_MIGRATED, false)) {
 307             Cling cling = initCling(R.id.folder_cling, R.id.cling_scrim,
 308                     true, true);
 309             Folder openFolder = mLauncher.getWorkspace().getOpenFolder();
 310             if (openFolder != null) {
 311                 Rect openFolderRect = new Rect();
 312                 openFolder.getHitRect(openFolderRect);
 313                 cling.setOpenFolderRect(openFolderRect);
 314                 openFolder.bringToFront();
 315             }
 316             return cling;
 317         } else {
 318             removeCling(R.id.folder_cling);
 319             return null;
 320         }
 321     }
 322 
 323     public void markFolderClingDismissed() {
 324         SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();
 325         editor.putBoolean(LauncherClings.FOLDER_CLING_DISMISSED_KEY, true);
 326         editor.apply();
 327     }
 328 
 329     /** Removes the cling outright from the DragLayer */
 330     private void removeCling(int id) {
 331         final View cling = mLauncher.findViewById(id);
 332         if (cling != null) {
 333             final ViewGroup parent = (ViewGroup) cling.getParent();
 334             parent.post(new Runnable() {
 335                 @Override
 336                 public void run() {
 337                     parent.removeView(cling);
 338                 }
 339             });
 340             mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 341         }
 342     }
 343 
 344     /** Hides the specified Cling */
 345     private void dismissCling(final Cling cling, final Runnable postAnimationCb,
 346                               final String flag, int duration, boolean restoreNavBarVisibilty) {
 347         // To catch cases where siblings of top-level views are made invisible, just check whether
 348         // the cling is directly set to GONE before dismissing it.
 349         if (cling != null &amp;&amp; cling.getVisibility() != View.GONE) {
 350             final Runnable cleanUpClingCb = new Runnable() {
 351                 public void run() {
 352                     cling.cleanup();
 353                     SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();
 354                     editor.putBoolean(flag, true);
 355                     editor.apply();
 356                     if (postAnimationCb != null) {
 357                         postAnimationCb.run();
 358                     }
 359                 }
 360             };
 361             if (duration &lt;= 0) {
 362                 cleanUpClingCb.run();
 363             } else {
 364                 cling.hide(duration, cleanUpClingCb);
 365             }
 366             mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 367 
 368             if (restoreNavBarVisibilty) {
 369                 cling.setSystemUiVisibility(cling.getSystemUiVisibility() &amp;
 370                         ~View.SYSTEM_UI_FLAG_LOW_PROFILE);
 371             }
 372         }
 373     }
 374 
 375     public void dismissFirstRunCling(View v) {
 376         Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 377         Runnable cb = new Runnable() {
 378             public void run() {
 379                 // Show the workspace cling next
 380                 showWorkspaceCling();
 381             }
 382         };
 383         dismissCling(cling, cb, FIRST_RUN_CLING_DISMISSED_KEY,
 384                 DISMISS_CLING_DURATION, false);
 385 
 386         // Fade out the search bar for the workspace cling coming up
 387         mLauncher.getSearchBar().hideSearchBar(true);
 388     }
 389 
 390     private void dismissMigrationCling() {
 391         mLauncher.showWorkspaceSearchAndHotseat();
 392         Runnable dismissCb = new Runnable() {
 393             public void run() {
 394                 Cling cling = (Cling) mLauncher.findViewById(R.id.migration_cling);
 395                 Runnable cb = new Runnable() {
 396                     public void run() {
 397                         // Show the migration workspace cling next
 398                         showMigrationWorkspaceCling();
 399                     }
 400                 };
 401                 dismissCling(cling, cb, MIGRATION_CLING_DISMISSED_KEY,
 402                         DISMISS_CLING_DURATION, true);
 403             }
 404         };
 405         mLauncher.getWorkspace().post(dismissCb);
 406     }
 407 
 408     private void dismissAnyWorkspaceCling(Cling cling, String key, View v) {
 409         Runnable cb = null;
 410         if (v == null) {
 411             cb = new Runnable() {
 412                 public void run() {
 413                     mLauncher.getWorkspace().enterOverviewMode();
 414                 }
 415             };
 416         }
 417         dismissCling(cling, cb, key, DISMISS_CLING_DURATION, true);
 418 
 419         // Fade in the search bar
 420         mLauncher.getSearchBar().showSearchBar(true);
 421     }
 422 
 423     public void dismissMigrationClingCopyApps(View v) {
 424         // Copy the shortcuts from the old database
 425         LauncherModel model = mLauncher.getModel();
 426         model.resetLoadedState(false, true);
 427         model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 428                 LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE
 429                         | LauncherModel.LOADER_FLAG_MIGRATE_SHORTCUTS);
 430 
 431         // Set the flag to skip the folder cling
 432         String spKey = LauncherAppState.getSharedPreferencesKey();
 433         SharedPreferences sp = mLauncher.getSharedPreferences(spKey, Context.MODE_PRIVATE);
 434         SharedPreferences.Editor editor = sp.edit();
 435         editor.putBoolean(Launcher.USER_HAS_MIGRATED, true);
 436         editor.apply();
 437 
 438         // Disable the migration cling
 439         dismissMigrationCling();
 440     }
 441 
 442     public void dismissMigrationClingUseDefault(View v) {
 443         // Clear the workspace
 444         LauncherModel model = mLauncher.getModel();
 445         model.resetLoadedState(false, true);
 446         model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 447                 LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE);
 448 
 449         // Disable the migration cling
 450         dismissMigrationCling();
 451     }
 452 
 453     public void dismissMigrationWorkspaceCling(View v) {
 454         Cling cling = (Cling) mLauncher.findViewById(R.id.migration_workspace_cling);
 455         dismissAnyWorkspaceCling(cling, MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, v);
 456     }
 457 
 458     public void dismissWorkspaceCling(View v) {
 459         Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 460         dismissAnyWorkspaceCling(cling, WORKSPACE_CLING_DISMISSED_KEY, v);
 461     }
 462 
 463     public void dismissFolderCling(View v) {
 464         Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 465         dismissCling(cling, null, FOLDER_CLING_DISMISSED_KEY,
 466                 DISMISS_CLING_DURATION, true);
 467     }
 468 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Copyright (C) 2008 The Android Open Source Project
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.android.launcher3;
  18  
  19  import android.accounts.Account;
  20  import android.accounts.AccountManager;
  21  import android.animation.Animator;
  22  import android.animation.AnimatorListenerAdapter;
  23  import android.app.ActivityManager;
  24  import android.content.Context;
  25  import android.content.SharedPreferences;
  26  import android.graphics.Rect;
  27  import android.os.Bundle;
  28  import android.os.UserManager;
  29  import android.view.LayoutInflater;
  30  import android.view.View;
  31  import android.view.ViewGroup;
  32  import android.view.accessibility.AccessibilityManager;
  33  import android.widget.TextView;
  34  
  35  class LauncherClings {
  36      private static final String FIRST_RUN_CLING_DISMISSED_KEY = &quot;cling_gel.first_run.dismissed&quot;;
  37      private static final String MIGRATION_CLING_DISMISSED_KEY = &quot;cling_gel.migration.dismissed&quot;;
  38      private static final String MIGRATION_WORKSPACE_CLING_DISMISSED_KEY =
  39              &quot;cling_gel.migration_workspace.dismissed&quot;;
  40      private static final String WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.workspace.dismissed&quot;;
  41      private static final String FOLDER_CLING_DISMISSED_KEY = &quot;cling_gel.folder.dismissed&quot;;
  42  
  43      private static final boolean DISABLE_CLINGS = false;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +    private static final boolean DISABLE_CUSTOM_CLINGS = true;</span>
  45  
  46      private static final int SHOW_CLING_DURATION = 250;
  47      private static final int DISMISS_CLING_DURATION = 200;
  48  
  49      private Launcher mLauncher;
  50      private LayoutInflater mInflater;
  51      private HideFromAccessibilityHelper mHideFromAccessibilityHelper
  52              = new HideFromAccessibilityHelper();
  53  
  54      /** Ctor */
  55      public LauncherClings(Launcher launcher) {
  56          mLauncher = launcher;
  57          mInflater = mLauncher.getLayoutInflater();
  58      }
  59  
  60      /** Initializes a cling */
  61      private Cling initCling(int clingId, int scrimId, boolean animate,
  62                              boolean dimNavBarVisibilty) {
  63          Cling cling = (Cling) mLauncher.findViewById(clingId);
  64          View scrim = null;
  65          if (scrimId &gt; 0) {
  66              scrim = mLauncher.findViewById(scrimId);
  67          }
  68          if (cling != null) {
  69              cling.init(mLauncher, scrim);
  70              cling.show(animate, SHOW_CLING_DURATION);
  71  
  72              if (dimNavBarVisibilty) {
  73                  cling.setSystemUiVisibility(cling.getSystemUiVisibility() |
  74                          View.SYSTEM_UI_FLAG_LOW_PROFILE);
  75              }
  76          }
  77          return cling;
  78      }
  79  
  80      /** Returns whether the clings are enabled or should be shown */
  81      private boolean areClingsEnabled() {
  82          if (DISABLE_CLINGS) {
  83              return false;
  84          }
  85  
  86          // disable clings when running in a test harness
  87          if(ActivityManager.isRunningInTestHarness()) return false;
  88  
  89          // Disable clings for accessibility when explore by touch is enabled
  90          final AccessibilityManager a11yManager = (AccessibilityManager) mLauncher.getSystemService(
  91                  Launcher.ACCESSIBILITY_SERVICE);
  92          if (a11yManager.isTouchExplorationEnabled()) {
  93              return false;
  94          }
  95  
  96          // Restricted secondary users (child mode) will potentially have very few apps
  97          // seeded when they start up for the first time. Clings won&#x27;t work well with that
  98          boolean supportsLimitedUsers =
  99                  android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.JELLY_BEAN_MR2;
 100          Account[] accounts = AccountManager.get(mLauncher).getAccounts();
 101          if (supportsLimitedUsers &amp;&amp; accounts.length == 0) {
 102              UserManager um = (UserManager) mLauncher.getSystemService(Context.USER_SERVICE);
 103              Bundle restrictions = um.getUserRestrictions();
 104              if (restrictions.getBoolean(UserManager.DISALLOW_MODIFY_ACCOUNTS, false)) {
 105                  return false;
 106              }
 107          }
 108          return true;
 109      }
 110  
 111      /** Returns whether the folder cling is visible. */
 112      public boolean isFolderClingVisible() {
 113          Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 114          if (cling != null) {
 115              return cling.getVisibility() == View.VISIBLE;
 116          }
 117          return false;
 118      }
 119  
 120      private boolean skipCustomClingIfNoAccounts() {
 121          Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 122          boolean customCling = cling.getDrawIdentifier().equals(&quot;workspace_custom&quot;);
 123          if (customCling) {
 124              AccountManager am = AccountManager.get(mLauncher);
 125              if (am == null) return false;
 126              Account[] accounts = am.getAccountsByType(&quot;com.google&quot;);
 127              return accounts.length == 0;
 128          }
 129          return false;
 130      }
 131  
 132      /** Updates the first run cling custom content hint */
 133      private void setCustomContentHintVisibility(Cling cling, String ccHintStr, boolean visible,
 134                                                  boolean animate) {
 135          final TextView ccHint = (TextView) cling.findViewById(R.id.custom_content_hint);
 136          if (ccHint != null) {
 137              if (visible &amp;&amp; !ccHintStr.isEmpty()) {
 138                  ccHint.setText(ccHintStr);
 139                  ccHint.setVisibility(View.VISIBLE);
 140                  if (animate) {
 141                      ccHint.setAlpha(0f);
 142                      ccHint.animate().alpha(1f)
 143                              .setDuration(SHOW_CLING_DURATION)
 144                              .start();
 145                  } else {
 146                      ccHint.setAlpha(1f);
 147                  }
 148              } else {
 149                  if (animate) {
 150                      ccHint.animate().alpha(0f)
 151                              .setDuration(SHOW_CLING_DURATION)
 152                              .setListener(new AnimatorListenerAdapter() {
 153                                  @Override
 154                                  public void onAnimationEnd(Animator animation) {
 155                                      ccHint.setVisibility(View.GONE);
 156                                  }
 157                              })
 158                              .start();
 159                  } else {
 160                      ccHint.setAlpha(0f);
 161                      ccHint.setVisibility(View.GONE);
 162                  }
 163              }
 164          }
 165      }
 166  
 167      /** Updates the first run cling custom content hint */
 168      public void updateCustomContentHintVisibility() {
 169          Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 170          String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 171  
 172          if (mLauncher.getWorkspace().hasCustomContent()) {
 173              // Show the custom content hint if ccHintStr is not empty
 174              if (cling != null) {
 175                  setCustomContentHintVisibility(cling, ccHintStr, true, true);
 176              }
 177          } else {
 178              // Hide the custom content hint
 179              if (cling != null) {
 180                  setCustomContentHintVisibility(cling, ccHintStr, false, true);
 181              }
 182          }
 183      }
 184  
 185      /** Updates the first run cling search bar hint. */
 186      public void updateSearchBarHint(String hint) {
 187          Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 188          if (cling != null &amp;&amp; cling.getVisibility() == View.VISIBLE &amp;&amp; !hint.isEmpty()) {
 189              TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 190              sbHint.setText(hint);
 191              sbHint.setVisibility(View.VISIBLE);
 192          }
 193      }
 194  
 195      public boolean shouldShowFirstRunOrMigrationClings() {
 196          SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 197          return areClingsEnabled() &amp;&amp;
 198              !sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false) &amp;&amp;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -            !sharedPrefs.getBoolean(MIGRATION_CLING_DISMISSED_KEY, false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 200 +            !sharedPrefs.getBoolean(MIGRATION_CLING_DISMISSED_KEY, false) &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 201 +            LauncherAppState.getLauncherProvider().wasNewDbCreated();</span>
 202      }
 203  
 204      public void removeFirstRunAndMigrationClings() {
 205          removeCling(R.id.first_run_cling);
 206          removeCling(R.id.migration_cling);
 207      }
 208  
 209      /**
 210       * Shows the first run cling.
 211       *
 212       * This flow is mutually exclusive with showMigrationCling, and only runs if this Launcher
 213       * package was preinstalled or there is no db to migrate from.
 214       */
 215      public void showFirstRunCling() {
 216          if (!skipCustomClingIfNoAccounts()) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 217 +            SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 218 +            // If we&#x27;re not using the default workspace layout, replace workspace cling</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +            // with a custom workspace cling (usually specified in an overlay)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +            // For now, only do this on tablets</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +            if (!DISABLE_CUSTOM_CLINGS) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +                if (sharedPrefs.getInt(LauncherProvider.DEFAULT_WORKSPACE_RESOURCE_ID, 0) != 0 &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +                        mLauncher.getResources().getBoolean(R.bool.config_useCustomClings)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +                    // Use a custom cling</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +                    View cling = mLauncher.findViewById(R.id.workspace_cling);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +                    ViewGroup clingParent = (ViewGroup) cling.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +                    int clingIndex = clingParent.indexOfChild(cling);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +                    clingParent.removeViewAt(clingIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +                    View customCling = mInflater.inflate(R.layout.custom_workspace_cling,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                            clingParent, false);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +                    clingParent.addView(customCling, clingIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +                    customCling.setId(R.id.workspace_cling);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +            }</span>
 235              Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 236              if (cling != null) {
 237                  String sbHintStr = mLauncher.getFirstRunClingSearchBarHint();
 238                  String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 239                  if (!sbHintStr.isEmpty()) {
 240                      TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 241                      sbHint.setText(sbHintStr);
 242                      sbHint.setVisibility(View.VISIBLE);
 243                  }
 244                  setCustomContentHintVisibility(cling, ccHintStr, true, false);
 245              }
 246              initCling(R.id.first_run_cling, 0, false, true);
 247          } else {
 248              removeFirstRunAndMigrationClings();
 249          }
 250      }
 251  
 252      /**
 253       * Shows the migration cling.
 254       *
 255       * This flow is mutually exclusive with showFirstRunCling, and only runs if this Launcher
 256       * package was not preinstalled and there exists a db to migrate from.
 257       */
 258      public void showMigrationCling() {
 259          mLauncher.hideWorkspaceSearchAndHotseat();
 260  
 261          Cling c = initCling(R.id.migration_cling, 0, false, true);
 262          c.bringScrimToFront();
 263          c.bringToFront();
 264      }
 265  
 266      public void showMigrationWorkspaceCling() {
 267          // Enable the clings only if they have not been dismissed before
 268          if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 269                  MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, false)) {
 270              Cling c = initCling(R.id.migration_workspace_cling, 0, false, true);
 271              c.updateMigrationWorkspaceBubblePosition();
 272              c.bringScrimToFront();
 273              c.bringToFront();
 274          } else {
 275              removeCling(R.id.migration_workspace_cling);
 276          }
 277      }
 278  
 279      public void showWorkspaceCling() {
 280          // Enable the clings only if they have not been dismissed before
 281          if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 282                  WORKSPACE_CLING_DISMISSED_KEY, false)) {
 283              Cling c = initCling(R.id.workspace_cling, 0, false, true);
 284              c.updateWorkspaceBubblePosition();
 285  
 286              // Set the focused hotseat app if there is one
 287              c.setFocusedHotseatApp(mLauncher.getFirstRunFocusedHotseatAppDrawableId(),
 288                      mLauncher.getFirstRunFocusedHotseatAppRank(),
 289                      mLauncher.getFirstRunFocusedHotseatAppComponentName(),
 290                      mLauncher.getFirstRunFocusedHotseatAppBubbleTitle(),
 291                      mLauncher.getFirstRunFocusedHotseatAppBubbleDescription());
 292          } else {
 293              removeCling(R.id.workspace_cling);
 294          }
 295      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -</span>
 297      public Cling showFoldersCling() {
 298          SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 299          // Enable the clings only if they have not been dismissed before
 300          if (areClingsEnabled() &amp;&amp;
 301                  !sharedPrefs.getBoolean(FOLDER_CLING_DISMISSED_KEY, false) &amp;&amp;
 302                  !sharedPrefs.getBoolean(Launcher.USER_HAS_MIGRATED, false)) {
 303              Cling cling = initCling(R.id.folder_cling, R.id.cling_scrim,
 304                      true, true);
 305              Folder openFolder = mLauncher.getWorkspace().getOpenFolder();
 306              if (openFolder != null) {
 307                  Rect openFolderRect = new Rect();
 308                  openFolder.getHitRect(openFolderRect);
 309                  cling.setOpenFolderRect(openFolderRect);
 310                  openFolder.bringToFront();
 311              }
 312              return cling;
 313          } else {
 314              removeCling(R.id.folder_cling);
 315              return null;
 316          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 317 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 319 -    public static void synchonouslyMarkFirstRunClingDismissed(Context ctx) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -        SharedPreferences prefs = ctx.getSharedPreferences(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 321 -                LauncherAppState.getSharedPreferencesKey(),Context.MODE_PRIVATE);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -        SharedPreferences.Editor editor = prefs.edit();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 323 -        editor.putBoolean(LauncherClings.FIRST_RUN_CLING_DISMISSED_KEY, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 324 -        editor.commit();</span>






 325      }
 326  
 327      /** Removes the cling outright from the DragLayer */
 328      private void removeCling(int id) {
 329          final View cling = mLauncher.findViewById(id);
 330          if (cling != null) {
 331              final ViewGroup parent = (ViewGroup) cling.getParent();
 332              parent.post(new Runnable() {
 333                  @Override
 334                  public void run() {
 335                      parent.removeView(cling);
 336                  }
 337              });
 338              mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 339          }
 340      }
 341  
 342      /** Hides the specified Cling */
 343      private void dismissCling(final Cling cling, final Runnable postAnimationCb,
 344                                final String flag, int duration, boolean restoreNavBarVisibilty) {
 345          // To catch cases where siblings of top-level views are made invisible, just check whether
 346          // the cling is directly set to GONE before dismissing it.
 347          if (cling != null &amp;&amp; cling.getVisibility() != View.GONE) {
 348              final Runnable cleanUpClingCb = new Runnable() {
 349                  public void run() {
 350                      cling.cleanup();
 351                      SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();
 352                      editor.putBoolean(flag, true);
 353                      editor.apply();
 354                      if (postAnimationCb != null) {
 355                          postAnimationCb.run();
 356                      }
 357                  }
 358              };
 359              if (duration &lt;= 0) {
 360                  cleanUpClingCb.run();
 361              } else {
 362                  cling.hide(duration, cleanUpClingCb);
 363              }
 364              mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 365  
 366              if (restoreNavBarVisibilty) {
 367                  cling.setSystemUiVisibility(cling.getSystemUiVisibility() &amp;
 368                          ~View.SYSTEM_UI_FLAG_LOW_PROFILE);
 369              }
 370          }
 371      }
 372  
 373      public void dismissFirstRunCling(View v) {
 374          Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 375          Runnable cb = new Runnable() {
 376              public void run() {
 377                  // Show the workspace cling next
 378                  showWorkspaceCling();
 379              }
 380          };
 381          dismissCling(cling, cb, FIRST_RUN_CLING_DISMISSED_KEY,
 382                  DISMISS_CLING_DURATION, false);
 383  
 384          // Fade out the search bar for the workspace cling coming up
 385          mLauncher.getSearchBar().hideSearchBar(true);
 386      }
 387  
 388      private void dismissMigrationCling() {
 389          mLauncher.showWorkspaceSearchAndHotseat();
 390          Runnable dismissCb = new Runnable() {
 391              public void run() {
 392                  Cling cling = (Cling) mLauncher.findViewById(R.id.migration_cling);
 393                  Runnable cb = new Runnable() {
 394                      public void run() {
 395                          // Show the migration workspace cling next
 396                          showMigrationWorkspaceCling();
 397                      }
 398                  };
 399                  dismissCling(cling, cb, MIGRATION_CLING_DISMISSED_KEY,
 400                          DISMISS_CLING_DURATION, true);
 401              }
 402          };
 403          mLauncher.getWorkspace().post(dismissCb);
 404      }
 405  
 406      private void dismissAnyWorkspaceCling(Cling cling, String key, View v) {
 407          Runnable cb = null;
 408          if (v == null) {
 409              cb = new Runnable() {
 410                  public void run() {
 411                      mLauncher.getWorkspace().enterOverviewMode();
 412                  }
 413              };
 414          }
 415          dismissCling(cling, cb, key, DISMISS_CLING_DURATION, true);
 416  
 417          // Fade in the search bar
 418          mLauncher.getSearchBar().showSearchBar(true);
 419      }
 420  
 421      public void dismissMigrationClingCopyApps(View v) {
 422          // Copy the shortcuts from the old database
 423          LauncherModel model = mLauncher.getModel();
 424          model.resetLoadedState(false, true);
 425          model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 426                  LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE
 427                          | LauncherModel.LOADER_FLAG_MIGRATE_SHORTCUTS);
 428  
 429          // Set the flag to skip the folder cling
 430          String spKey = LauncherAppState.getSharedPreferencesKey();
 431          SharedPreferences sp = mLauncher.getSharedPreferences(spKey, Context.MODE_PRIVATE);
 432          SharedPreferences.Editor editor = sp.edit();
 433          editor.putBoolean(Launcher.USER_HAS_MIGRATED, true);
 434          editor.apply();
 435  
 436          // Disable the migration cling
 437          dismissMigrationCling();
 438      }
 439  
 440      public void dismissMigrationClingUseDefault(View v) {
 441          // Clear the workspace
 442          LauncherModel model = mLauncher.getModel();
 443          model.resetLoadedState(false, true);
 444          model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 445                  LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE);
 446  
 447          // Disable the migration cling
 448          dismissMigrationCling();
 449      }
 450  
 451      public void dismissMigrationWorkspaceCling(View v) {
 452          Cling cling = (Cling) mLauncher.findViewById(R.id.migration_workspace_cling);
 453          dismissAnyWorkspaceCling(cling, MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, v);
 454      }
 455  
 456      public void dismissWorkspaceCling(View v) {
 457          Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 458          dismissAnyWorkspaceCling(cling, WORKSPACE_CLING_DISMISSED_KEY, v);
 459      }
 460  
 461      public void dismissFolderCling(View v) {
 462          Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 463          dismissCling(cling, null, FOLDER_CLING_DISMISSED_KEY,
 464                  DISMISS_CLING_DURATION, true);
 465      }
 466  }</pre></td>
                            <td><pre>   1  /*
   2   * Copyright (C) 2008 The Android Open Source Project
   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.android.launcher3;
  18  
  19  import android.accounts.Account;
  20  import android.accounts.AccountManager;
  21  import android.animation.Animator;
  22  import android.animation.AnimatorListenerAdapter;
  23  import android.app.ActivityManager;
  24  import android.content.Context;
  25  import android.content.SharedPreferences;
  26  import android.graphics.Rect;
  27  import android.os.Bundle;
  28  import android.os.UserManager;
  29  import android.view.LayoutInflater;
  30  import android.view.View;
  31  import android.view.ViewGroup;
  32  import android.view.accessibility.AccessibilityManager;
  33  import android.widget.TextView;
  34  
  35  class LauncherClings {
  36      private static final String FIRST_RUN_CLING_DISMISSED_KEY = &quot;cling_gel.first_run.dismissed&quot;;
  37      private static final String MIGRATION_CLING_DISMISSED_KEY = &quot;cling_gel.migration.dismissed&quot;;
  38      private static final String MIGRATION_WORKSPACE_CLING_DISMISSED_KEY =
  39              &quot;cling_gel.migration_workspace.dismissed&quot;;
  40      private static final String WORKSPACE_CLING_DISMISSED_KEY = &quot;cling_gel.workspace.dismissed&quot;;
  41      private static final String FOLDER_CLING_DISMISSED_KEY = &quot;cling_gel.folder.dismissed&quot;;
  42  
  43      private static final boolean DISABLE_CLINGS = false;

  44  
  45      private static final int SHOW_CLING_DURATION = 250;
  46      private static final int DISMISS_CLING_DURATION = 200;
  47  
  48      private Launcher mLauncher;
  49      private LayoutInflater mInflater;
  50      private HideFromAccessibilityHelper mHideFromAccessibilityHelper
  51              = new HideFromAccessibilityHelper();
  52  
  53      /** Ctor */
  54      public LauncherClings(Launcher launcher) {
  55          mLauncher = launcher;
  56          mInflater = mLauncher.getLayoutInflater();
  57      }
  58  
  59      /** Initializes a cling */
  60      private Cling initCling(int clingId, int scrimId, boolean animate,
  61                              boolean dimNavBarVisibilty) {
  62          Cling cling = (Cling) mLauncher.findViewById(clingId);
  63          View scrim = null;
  64          if (scrimId &gt; 0) {
  65              scrim = mLauncher.findViewById(scrimId);
  66          }
  67          if (cling != null) {
  68              cling.init(mLauncher, scrim);
  69              cling.show(animate, SHOW_CLING_DURATION);
  70  
  71              if (dimNavBarVisibilty) {
  72                  cling.setSystemUiVisibility(cling.getSystemUiVisibility() |
  73                          View.SYSTEM_UI_FLAG_LOW_PROFILE);
  74              }
  75          }
  76          return cling;
  77      }
  78  
  79      /** Returns whether the clings are enabled or should be shown */
  80      private boolean areClingsEnabled() {
  81          if (DISABLE_CLINGS) {
  82              return false;
  83          }
  84  
  85          // disable clings when running in a test harness
  86          if(ActivityManager.isRunningInTestHarness()) return false;
  87  
  88          // Disable clings for accessibility when explore by touch is enabled
  89          final AccessibilityManager a11yManager = (AccessibilityManager) mLauncher.getSystemService(
  90                  Launcher.ACCESSIBILITY_SERVICE);
  91          if (a11yManager.isTouchExplorationEnabled()) {
  92              return false;
  93          }
  94  
  95          // Restricted secondary users (child mode) will potentially have very few apps
  96          // seeded when they start up for the first time. Clings won&#x27;t work well with that
  97          boolean supportsLimitedUsers =
  98                  android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.JELLY_BEAN_MR2;
  99          Account[] accounts = AccountManager.get(mLauncher).getAccounts();
 100          if (supportsLimitedUsers &amp;&amp; accounts.length == 0) {
 101              UserManager um = (UserManager) mLauncher.getSystemService(Context.USER_SERVICE);
 102              Bundle restrictions = um.getUserRestrictions();
 103              if (restrictions.getBoolean(UserManager.DISALLOW_MODIFY_ACCOUNTS, false)) {
 104                  return false;
 105              }
 106          }
 107          return true;
 108      }
 109  
 110      /** Returns whether the folder cling is visible. */
 111      public boolean isFolderClingVisible() {
 112          Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 113          if (cling != null) {
 114              return cling.getVisibility() == View.VISIBLE;
 115          }
 116          return false;
 117      }
 118  
 119      private boolean skipCustomClingIfNoAccounts() {
 120          Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 121          boolean customCling = cling.getDrawIdentifier().equals(&quot;workspace_custom&quot;);
 122          if (customCling) {
 123              AccountManager am = AccountManager.get(mLauncher);
 124              if (am == null) return false;
 125              Account[] accounts = am.getAccountsByType(&quot;com.google&quot;);
 126              return accounts.length == 0;
 127          }
 128          return false;
 129      }
 130  
 131      /** Updates the first run cling custom content hint */
 132      private void setCustomContentHintVisibility(Cling cling, String ccHintStr, boolean visible,
 133                                                  boolean animate) {
 134          final TextView ccHint = (TextView) cling.findViewById(R.id.custom_content_hint);
 135          if (ccHint != null) {
 136              if (visible &amp;&amp; !ccHintStr.isEmpty()) {
 137                  ccHint.setText(ccHintStr);
 138                  ccHint.setVisibility(View.VISIBLE);
 139                  if (animate) {
 140                      ccHint.setAlpha(0f);
 141                      ccHint.animate().alpha(1f)
 142                              .setDuration(SHOW_CLING_DURATION)
 143                              .start();
 144                  } else {
 145                      ccHint.setAlpha(1f);
 146                  }
 147              } else {
 148                  if (animate) {
 149                      ccHint.animate().alpha(0f)
 150                              .setDuration(SHOW_CLING_DURATION)
 151                              .setListener(new AnimatorListenerAdapter() {
 152                                  @Override
 153                                  public void onAnimationEnd(Animator animation) {
 154                                      ccHint.setVisibility(View.GONE);
 155                                  }
 156                              })
 157                              .start();
 158                  } else {
 159                      ccHint.setAlpha(0f);
 160                      ccHint.setVisibility(View.GONE);
 161                  }
 162              }
 163          }
 164      }
 165  
 166      /** Updates the first run cling custom content hint */
 167      public void updateCustomContentHintVisibility() {
 168          Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 169          String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 170  
 171          if (mLauncher.getWorkspace().hasCustomContent()) {
 172              // Show the custom content hint if ccHintStr is not empty
 173              if (cling != null) {
 174                  setCustomContentHintVisibility(cling, ccHintStr, true, true);
 175              }
 176          } else {
 177              // Hide the custom content hint
 178              if (cling != null) {
 179                  setCustomContentHintVisibility(cling, ccHintStr, false, true);
 180              }
 181          }
 182      }
 183  
 184      /** Updates the first run cling search bar hint. */
 185      public void updateSearchBarHint(String hint) {
 186          Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 187          if (cling != null &amp;&amp; cling.getVisibility() == View.VISIBLE &amp;&amp; !hint.isEmpty()) {
 188              TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 189              sbHint.setText(hint);
 190              sbHint.setVisibility(View.VISIBLE);
 191          }
 192      }
 193  
 194      public boolean shouldShowFirstRunOrMigrationClings() {
 195          SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 196          return areClingsEnabled() &amp;&amp;
 197              !sharedPrefs.getBoolean(FIRST_RUN_CLING_DISMISSED_KEY, false) &amp;&amp;
 198              !sharedPrefs.getBoolean(MIGRATION_CLING_DISMISSED_KEY, false);


 199      }
 200  
 201      public void removeFirstRunAndMigrationClings() {
 202          removeCling(R.id.first_run_cling);
 203          removeCling(R.id.migration_cling);
 204      }
 205  
 206      /**
 207       * Shows the first run cling.
 208       *
 209       * This flow is mutually exclusive with showMigrationCling, and only runs if this Launcher
 210       * package was preinstalled or there is no db to migrate from.
 211       */
 212      public void showFirstRunCling() {
 213          if (!skipCustomClingIfNoAccounts()) {


















 214              Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 215              if (cling != null) {
 216                  String sbHintStr = mLauncher.getFirstRunClingSearchBarHint();
 217                  String ccHintStr = mLauncher.getFirstRunCustomContentHint();
 218                  if (!sbHintStr.isEmpty()) {
 219                      TextView sbHint = (TextView) cling.findViewById(R.id.search_bar_hint);
 220                      sbHint.setText(sbHintStr);
 221                      sbHint.setVisibility(View.VISIBLE);
 222                  }
 223                  setCustomContentHintVisibility(cling, ccHintStr, true, false);
 224              }
 225              initCling(R.id.first_run_cling, 0, false, true);
 226          } else {
 227              removeFirstRunAndMigrationClings();
 228          }
 229      }
 230  
 231      /**
 232       * Shows the migration cling.
 233       *
 234       * This flow is mutually exclusive with showFirstRunCling, and only runs if this Launcher
 235       * package was not preinstalled and there exists a db to migrate from.
 236       */
 237      public void showMigrationCling() {
 238          mLauncher.hideWorkspaceSearchAndHotseat();
 239  
 240          Cling c = initCling(R.id.migration_cling, 0, false, true);
 241          c.bringScrimToFront();
 242          c.bringToFront();
 243      }
 244  
 245      public void showMigrationWorkspaceCling() {
 246          // Enable the clings only if they have not been dismissed before
 247          if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 248                  MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, false)) {
 249              Cling c = initCling(R.id.migration_workspace_cling, 0, false, true);
 250              c.updateMigrationWorkspaceBubblePosition();
 251              c.bringScrimToFront();
 252              c.bringToFront();
 253          } else {
 254              removeCling(R.id.migration_workspace_cling);
 255          }
 256      }
 257  
 258      public void showWorkspaceCling() {
 259          // Enable the clings only if they have not been dismissed before
 260          if (areClingsEnabled() &amp;&amp; !mLauncher.getSharedPrefs().getBoolean(
 261                  WORKSPACE_CLING_DISMISSED_KEY, false)) {
 262              Cling c = initCling(R.id.workspace_cling, 0, false, true);
 263              c.updateWorkspaceBubblePosition();
 264  
 265              // Set the focused hotseat app if there is one
 266              c.setFocusedHotseatApp(mLauncher.getFirstRunFocusedHotseatAppDrawableId(),
 267                      mLauncher.getFirstRunFocusedHotseatAppRank(),
 268                      mLauncher.getFirstRunFocusedHotseatAppComponentName(),
 269                      mLauncher.getFirstRunFocusedHotseatAppBubbleTitle(),
 270                      mLauncher.getFirstRunFocusedHotseatAppBubbleDescription());
 271          } else {
 272              removeCling(R.id.workspace_cling);
 273          }
 274      }
 275  
 276      public Cling showFoldersCling() {
 277          SharedPreferences sharedPrefs = mLauncher.getSharedPrefs();
 278          // Enable the clings only if they have not been dismissed before
 279          if (areClingsEnabled() &amp;&amp;
 280                  !sharedPrefs.getBoolean(FOLDER_CLING_DISMISSED_KEY, false) &amp;&amp;
 281                  !sharedPrefs.getBoolean(Launcher.USER_HAS_MIGRATED, false)) {
 282              Cling cling = initCling(R.id.folder_cling, R.id.cling_scrim,
 283                      true, true);
 284              Folder openFolder = mLauncher.getWorkspace().getOpenFolder();
 285              if (openFolder != null) {
 286                  Rect openFolderRect = new Rect();
 287                  openFolder.getHitRect(openFolderRect);
 288                  cling.setOpenFolderRect(openFolderRect);
 289                  openFolder.bringToFront();
 290              }
 291              return cling;
 292          } else {
 293              removeCling(R.id.folder_cling);
 294              return null;
 295          }
 296      }
 297  
 298      public static void synchonouslyMarkFirstRunClingDismissed(Context ctx) {
 299          SharedPreferences prefs = ctx.getSharedPreferences(
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 300 -                LauncherAppState.getSharedPreferencesKey(),Context.MODE_PRIVATE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +                LauncherAppState.getSharedPreferencesKey(), Context.MODE_PRIVATE);</span>
 302          SharedPreferences.Editor editor = prefs.edit();
 303          editor.putBoolean(LauncherClings.FIRST_RUN_CLING_DISMISSED_KEY, true);
 304          editor.commit();
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +    public void markFolderClingDismissed() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +        SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +        editor.putBoolean(LauncherClings.FOLDER_CLING_DISMISSED_KEY, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +        editor.apply();</span>
 311      }
 312  
 313      /** Removes the cling outright from the DragLayer */
 314      private void removeCling(int id) {
 315          final View cling = mLauncher.findViewById(id);
 316          if (cling != null) {
 317              final ViewGroup parent = (ViewGroup) cling.getParent();
 318              parent.post(new Runnable() {
 319                  @Override
 320                  public void run() {
 321                      parent.removeView(cling);
 322                  }
 323              });
 324              mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 325          }
 326      }
 327  
 328      /** Hides the specified Cling */
 329      private void dismissCling(final Cling cling, final Runnable postAnimationCb,
 330                                final String flag, int duration, boolean restoreNavBarVisibilty) {
 331          // To catch cases where siblings of top-level views are made invisible, just check whether
 332          // the cling is directly set to GONE before dismissing it.
 333          if (cling != null &amp;&amp; cling.getVisibility() != View.GONE) {
 334              final Runnable cleanUpClingCb = new Runnable() {
 335                  public void run() {
 336                      cling.cleanup();
 337                      SharedPreferences.Editor editor = mLauncher.getSharedPrefs().edit();
 338                      editor.putBoolean(flag, true);
 339                      editor.apply();
 340                      if (postAnimationCb != null) {
 341                          postAnimationCb.run();
 342                      }
 343                  }
 344              };
 345              if (duration &lt;= 0) {
 346                  cleanUpClingCb.run();
 347              } else {
 348                  cling.hide(duration, cleanUpClingCb);
 349              }
 350              mHideFromAccessibilityHelper.restoreImportantForAccessibility(mLauncher.getDragLayer());
 351  
 352              if (restoreNavBarVisibilty) {
 353                  cling.setSystemUiVisibility(cling.getSystemUiVisibility() &amp;
 354                          ~View.SYSTEM_UI_FLAG_LOW_PROFILE);
 355              }
 356          }
 357      }
 358  
 359      public void dismissFirstRunCling(View v) {
 360          Cling cling = (Cling) mLauncher.findViewById(R.id.first_run_cling);
 361          Runnable cb = new Runnable() {
 362              public void run() {
 363                  // Show the workspace cling next
 364                  showWorkspaceCling();
 365              }
 366          };
 367          dismissCling(cling, cb, FIRST_RUN_CLING_DISMISSED_KEY,
 368                  DISMISS_CLING_DURATION, false);
 369  
 370          // Fade out the search bar for the workspace cling coming up
 371          mLauncher.getSearchBar().hideSearchBar(true);
 372      }
 373  
 374      private void dismissMigrationCling() {
 375          mLauncher.showWorkspaceSearchAndHotseat();
 376          Runnable dismissCb = new Runnable() {
 377              public void run() {
 378                  Cling cling = (Cling) mLauncher.findViewById(R.id.migration_cling);
 379                  Runnable cb = new Runnable() {
 380                      public void run() {
 381                          // Show the migration workspace cling next
 382                          showMigrationWorkspaceCling();
 383                      }
 384                  };
 385                  dismissCling(cling, cb, MIGRATION_CLING_DISMISSED_KEY,
 386                          DISMISS_CLING_DURATION, true);
 387              }
 388          };
 389          mLauncher.getWorkspace().post(dismissCb);
 390      }
 391  
 392      private void dismissAnyWorkspaceCling(Cling cling, String key, View v) {
 393          Runnable cb = null;
 394          if (v == null) {
 395              cb = new Runnable() {
 396                  public void run() {
 397                      mLauncher.getWorkspace().enterOverviewMode();
 398                  }
 399              };
 400          }
 401          dismissCling(cling, cb, key, DISMISS_CLING_DURATION, true);
 402  
 403          // Fade in the search bar
 404          mLauncher.getSearchBar().showSearchBar(true);
 405      }
 406  
 407      public void dismissMigrationClingCopyApps(View v) {
 408          // Copy the shortcuts from the old database
 409          LauncherModel model = mLauncher.getModel();
 410          model.resetLoadedState(false, true);
 411          model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 412                  LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE
 413                          | LauncherModel.LOADER_FLAG_MIGRATE_SHORTCUTS);
 414  
 415          // Set the flag to skip the folder cling
 416          String spKey = LauncherAppState.getSharedPreferencesKey();
 417          SharedPreferences sp = mLauncher.getSharedPreferences(spKey, Context.MODE_PRIVATE);
 418          SharedPreferences.Editor editor = sp.edit();
 419          editor.putBoolean(Launcher.USER_HAS_MIGRATED, true);
 420          editor.apply();
 421  
 422          // Disable the migration cling
 423          dismissMigrationCling();
 424      }
 425  
 426      public void dismissMigrationClingUseDefault(View v) {
 427          // Clear the workspace
 428          LauncherModel model = mLauncher.getModel();
 429          model.resetLoadedState(false, true);
 430          model.startLoader(false, PagedView.INVALID_RESTORE_PAGE,
 431                  LauncherModel.LOADER_FLAG_CLEAR_WORKSPACE);
 432  
 433          // Disable the migration cling
 434          dismissMigrationCling();
 435      }
 436  
 437      public void dismissMigrationWorkspaceCling(View v) {
 438          Cling cling = (Cling) mLauncher.findViewById(R.id.migration_workspace_cling);
 439          dismissAnyWorkspaceCling(cling, MIGRATION_WORKSPACE_CLING_DISMISSED_KEY, v);
 440      }
 441  
 442      public void dismissWorkspaceCling(View v) {
 443          Cling cling = (Cling) mLauncher.findViewById(R.id.workspace_cling);
 444          dismissAnyWorkspaceCling(cling, WORKSPACE_CLING_DISMISSED_KEY, v);
 445      }
 446  
 447      public void dismissFolderCling(View v) {
 448          Cling cling = (Cling) mLauncher.findViewById(R.id.folder_cling);
 449          dismissCling(cling, null, FOLDER_CLING_DISMISSED_KEY,
 450                  DISMISS_CLING_DURATION, true);
 451      }
 452  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            