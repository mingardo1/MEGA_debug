<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>481</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    481
                    <a href="480.html">prev</a>
                    <a href="482.html">next</a>
                    <a href="481_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_e346a804d69c8cd0124b4eb3d35156cfb5cd0779_hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779:hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^1:hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;e346a804d69c8cd0124b4eb3d35156cfb5cd0779^2:hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;6e351a99f6e8449c76ad55e517a5da6cbb108379:hbase/hbase-side/hbase-async-side/src/main/java/com/dtstack/flink/sql/side/hbase/HbaseAsyncReqRow.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [j]], subset: [[b], [b], [b], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19  
  20 
  21 package com.dtstack.flink.sql.side.hbase;
  22 
  23 import com.dtstack.flink.sql.enums.ECacheContentType;
  24 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  25 import com.dtstack.flink.sql.side.FieldInfo;
  26 import com.dtstack.flink.sql.side.JoinInfo;
  27 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  28 import com.dtstack.flink.sql.side.cache.CacheObj;
  29 import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  30 import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  31 import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  32 import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  33 import com.dtstack.flink.sql.factory.DTThreadFactory;
  34 import com.google.common.collect.Maps;
  35 import com.stumbleupon.async.Deferred;
  36 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  37 import org.apache.flink.api.java.tuple.Tuple2;</span>
  38 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.apache.flink.api.java.typeutils.RowTypeInfo;</span>
  40 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 import org.apache.commons.lang3.StringUtils;</span>
  42 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  43 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  44 import org.apache.flink.configuration.Configuration;
  45 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  46 import org.apache.flink.types.Row;
  47 import org.hbase.async.HBaseClient;
  48 import org.slf4j.Logger;
  49 import org.slf4j.LoggerFactory;
  50 
  51 import java.util.Collections;
  52 import java.util.List;
  53 import java.util.Map;
  54 import java.util.concurrent.ExecutorService;
  55 import java.util.concurrent.LinkedBlockingQueue;
  56 import java.util.concurrent.ThreadPoolExecutor;
  57 import java.util.concurrent.TimeUnit;
  58 
  59 /**
  60  * Date: 2018/8/21
  61  * Company: www.dtstack.com
  62  * @author xuchao
  63  */
  64 
  65 public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  66 
  67     private static final long serialVersionUID = 2098635104857937717L;
  68 
  69     private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  70 
  71     //match to the rule of netty3
  72     private static final int DEFAULT_BOSS_THREADS = 1;
  73 
  74     private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  75 
  76     private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  77 
  78     private transient HBaseClient hBaseClient;
  79 
  80     private transient AbstractRowKeyModeDealer rowKeyMode;
  81 
  82     private String tableName;
  83 
  84     private String[] colNames;
  85 
<abbr title="  86     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  86     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  87         super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  88 
  89         tableName = ((HbaseSideTableInfo)sideTableInfo).getTableName();
  90         colNames =  StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
  91     }
  92 
  93 
  94     @Override
  95     public void open(Configuration parameters) throws Exception {
  96         super.open(parameters);
  97         AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();
  98         HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;
  99         ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,
 100                 0L, TimeUnit.MILLISECONDS,
 101                 new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));
 102 
<abbr title=" 103         hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorService);"> 103         hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), execuðŸ”µ</abbr>
 104 
 105         try {
 106             Deferred deferred = hBaseClient.ensureTableExists(tableName)
<abbr title=" 107                     .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()));"> 107                     .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toSðŸ”µ</abbr>
 108 
 109             CheckResult result = (CheckResult) deferred.join();
 110             if(!result.isConnect()){
 111                 throw new RuntimeException(result.getExceptionMsg());
 112             }
 113 
 114         } catch (Exception e) {
 115             throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 116         }
 117 
 118         HbaseAsyncSideInfo hbaseAsyncSideInfo = (HbaseAsyncSideInfo) sideInfo;
 119         if(hbaseSideTableInfo.isPreRowKey()){
<abbr title=" 120             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,"> 120             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBasðŸ”µ</abbr>
 121                     openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 122                     sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 123         }else{
<abbr title=" 124             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,"> 124             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseCliðŸ”µ</abbr>
 125                     openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 126                     sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 127         }
 128     }
 129 
 130     @Override
 131 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 132     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 132     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) thðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133         Tuple2&lt;Boolean,Row&gt; inputCopy = Tuple2.of(input.f0,input.f1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134         Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137             Object equalObj = inputCopy.f1.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138             if(equalObj == null){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142             refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143         }</span>
 144 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149         Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156             }</span>
 157 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 158     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 158     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 159         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 159         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160     }</span>
 161 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 162 
 163 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164         String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166         //get from cache</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167         if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168             CacheObj val = getFromCache(rowKeyStr);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169             if (val != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 172                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 173                 } else if (ECacheContentType.SingleLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 174                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 175                         Row row = fillData(inputCopy.f1, val);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 176                         resultFuture.complete(Collections.singleton(Tuple2.of(inputCopy.f0,row)));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 177                     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 178                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 179                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 180                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 181                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 182                         for (Object one : (List) val.getContent()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 183                             Row row = fillData(inputCopy.f1, one);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 184                             resultFuture.complete(Collections.singleton(Tuple2.of(inputCopy.f0,row)));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 185                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 186                     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 187                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 188                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 189                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 190                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 191             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 192         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 193 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 194         rowKeyMode.asyncGetData(tableName, rowKeyStr, inputCopy, resultFuture, sideInfo.getSideCache());</span>
 195 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200             refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203         String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205         //get from cache</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 207             CacheObj val = getFromCache(rowKeyStr);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212                 } else if (ECacheContentType.SingleLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214                         Row row = fillData(inputCopy.row(), val);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215                         resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 220                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221                         for (Object one : (List) val.getContent()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222                             Row row = fillData(inputCopy.row(), one);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 223                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));"> 223                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 229                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231         }</span>
 232 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235         return ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(inputParams);</span>
 236 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 237     }
 238 
 239     @Override
 240     public Row fillData(Row input, Object sideInput){
 241         List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 242         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 243         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 244             Object obj = input.getField(entry.getValue());
 245             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 246             row.setField(entry.getKey(), obj);
 247         }
 248 
 249         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 250             if(sideInputList == null){
 251                 row.setField(entry.getKey(), null);
 252             }else{
 253                 row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 254             }
 255         }
 256 
 257         return row;
 258     }
 259 
 260     @Override
 261     public void close() throws Exception {
 262         super.close();
 263         hBaseClient.shutdown();
 264     }
 265 
 266 
 267     class CheckResult{
 268 
 269         private boolean connect;
 270 
 271         private String exceptionMsg;
 272 
 273         CheckResult(boolean connect, String msg){
 274             this.connect = connect;
 275             this.exceptionMsg = msg;
 276         }
 277 
 278         public boolean isConnect() {
 279             return connect;
 280         }
 281 
 282         public void setConnect(boolean connect) {
 283             this.connect = connect;
 284         }
 285 
 286         public String getExceptionMsg() {
 287             return exceptionMsg;
 288         }
 289 
 290         public void setExceptionMsg(String exceptionMsg) {
 291             this.exceptionMsg = exceptionMsg;
 292         }
 293     }
 294 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 
  21 package com.dtstack.flink.sql.side.hbase;
  22 
  23 import com.dtstack.flink.sql.enums.ECacheContentType;
  24 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  25 import com.dtstack.flink.sql.side.FieldInfo;
  26 import com.dtstack.flink.sql.side.JoinInfo;
  27 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  28 import com.dtstack.flink.sql.side.cache.CacheObj;
  29 import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  30 import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  31 import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  32 import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  33 import com.dtstack.flink.sql.factory.DTThreadFactory;
  34 import com.google.common.collect.Maps;
  35 import com.stumbleupon.async.Deferred;
  36 import org.apache.flink.api.java.tuple.Tuple2;
  37 import org.apache.commons.lang3.StringUtils;
  38 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  39 import org.apache.flink.configuration.Configuration;
  40 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  41 import org.apache.flink.types.Row;
  42 import org.hbase.async.HBaseClient;
  43 import org.slf4j.Logger;
  44 import org.slf4j.LoggerFactory;
  45 
  46 import java.util.Collections;
  47 import java.util.List;
  48 import java.util.Map;
  49 import java.util.concurrent.ExecutorService;
  50 import java.util.concurrent.LinkedBlockingQueue;
  51 import java.util.concurrent.ThreadPoolExecutor;
  52 import java.util.concurrent.TimeUnit;
  53 
  54 /**
  55  * Date: 2018/8/21
  56  * Company: www.dtstack.com
  57  * @author xuchao
  58  */
  59 
  60 public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  61 
  62     private static final long serialVersionUID = 2098635104857937717L;
  63 
  64     private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  65 
  66     //match to the rule of netty3
  67     private static final int DEFAULT_BOSS_THREADS = 1;
  68 
  69     private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  70 
  71     private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  72 
  73     private transient HBaseClient hBaseClient;
  74 
  75     private transient AbstractRowKeyModeDealer rowKeyMode;
  76 
  77     private String tableName;
  78 
  79     private String[] colNames;
  80 
<abbr title="  81     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  81     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  82         super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  83 
  84         tableName = ((HbaseSideTableInfo)sideTableInfo).getTableName();
  85         colNames =  StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
  86     }
  87 
  88 
  89     @Override
  90     public void open(Configuration parameters) throws Exception {
  91         super.open(parameters);
  92         AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();
  93         HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;
  94         ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,
  95                 0L, TimeUnit.MILLISECONDS,
  96                 new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));
  97 
<abbr title="  98         hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorService);">  98         hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), execuðŸ”µ</abbr>
  99 
 100         try {
 101             Deferred deferred = hBaseClient.ensureTableExists(tableName)
<abbr title=" 102                     .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()));"> 102                     .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toSðŸ”µ</abbr>
 103 
 104             CheckResult result = (CheckResult) deferred.join();
 105             if(!result.isConnect()){
 106                 throw new RuntimeException(result.getExceptionMsg());
 107             }
 108 
 109         } catch (Exception e) {
 110             throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 111         }
 112 
 113         HbaseAsyncSideInfo hbaseAsyncSideInfo = (HbaseAsyncSideInfo) sideInfo;
 114         if(hbaseSideTableInfo.isPreRowKey()){
<abbr title=" 115             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,"> 115             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBasðŸ”µ</abbr>
 116                     openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 117                     sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 118         }else{
<abbr title=" 119             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,"> 119             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseCliðŸ”µ</abbr>
 120                     openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 121                     sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 122         }
 123     }
 124 
 125 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126     @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 127     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 127     public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) thðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128         Tuple2&lt;Boolean,Row&gt; inputCopy = Tuple2.of(input.f0,input.f1);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129         Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132             Object equalObj = inputCopy.f1.getField(conValIndex);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 133             if(equalObj == null){</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 134                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 135                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 136             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 137             refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 138         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 139 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 140         String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 141 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 142         //get from cache</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 143         if (openCache()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 144             CacheObj val = getFromCache(rowKeyStr);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 145             if (val != null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 146                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 147                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 148                     return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 149                 } else if (ECacheContentType.SingleLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 150                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 151                         Row row = fillData(inputCopy.f1, val);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 152                         resultFuture.complete(Collections.singleton(Tuple2.of(inputCopy.f0,row)));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 153                     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 154                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 155                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 156                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 157                     try {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 158                         for (Object one : (List) val.getContent()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 159                             Row row = fillData(inputCopy.f1, one);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 160                             resultFuture.complete(Collections.singleton(Tuple2.of(inputCopy.f0,row)));</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 161                         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 162                     } catch (Exception e) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 163                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 164                     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 165                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 166                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 167             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 168         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 169 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 170         rowKeyMode.asyncGetData(tableName, rowKeyStr, inputCopy, resultFuture, sideInfo.getSideCache());</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 171     }</span>
 172 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174     public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175         CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176         Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179             Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             if(equalObj == null){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181                 dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184             refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 185         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 186 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 187         String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 188 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 189         //get from cache</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 190         if (openCache()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 191             CacheObj val = getFromCache(rowKeyStr);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 192             if (val != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 193                 if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 194                     dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 195                     return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 196                 } else if (ECacheContentType.SingleLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 197                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 198                         Row row = fillData(inputCopy.row(), val);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 199                         resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203                 } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204                     try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 205                         for (Object one : (List) val.getContent()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 206                             Row row = fillData(inputCopy.row(), one);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 207                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));"> 207                             resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 208                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 209                     } catch (Exception e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 210                         dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 211                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 212                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 213                 return;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 214             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 215         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 216 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217         rowKeyMode.asyncGetData(tableName, rowKeyStr, inputCopy, resultFuture, sideInfo.getSideCache());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218     }</span>
 219 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 </span>
 221 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 222 
 223     @Override
<abbr title=" 224     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 224     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFðŸ”µ</abbr>
<abbr title=" 225         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 225         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSðŸ”µ</abbr>
 226     }
 227 
 228     @Override
 229     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 230         return ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(inputParams);
 231     }
 232 
 233     @Override
 234     public Row fillData(Row input, Object sideInput){
 235         List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 236         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 237         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 238             Object obj = input.getField(entry.getValue());
 239             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 240             row.setField(entry.getKey(), obj);
 241         }
 242 
 243         for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 244             if(sideInputList == null){
 245                 row.setField(entry.getKey(), null);
 246             }else{
 247                 row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 248             }
 249         }
 250 
 251         return row;
 252     }
 253 
 254     @Override
 255     public void close() throws Exception {
 256         super.close();
 257         hBaseClient.shutdown();
 258     }
 259 
 260 
 261     class CheckResult{
 262 
 263         private boolean connect;
 264 
 265         private String exceptionMsg;
 266 
 267         CheckResult(boolean connect, String msg){
 268             this.connect = connect;
 269             this.exceptionMsg = msg;
 270         }
 271 
 272         public boolean isConnect() {
 273             return connect;
 274         }
 275 
 276         public void setConnect(boolean connect) {
 277             this.connect = connect;
 278         }
 279 
 280         public String getExceptionMsg() {
 281             return exceptionMsg;
 282         }
 283 
 284         public void setExceptionMsg(String exceptionMsg) {
 285             this.exceptionMsg = exceptionMsg;
 286         }
 287     }
 288 }
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.side.hbase;
  19 
  20 import com.dtstack.flink.sql.enums.ECacheContentType;
  21 import com.dtstack.flink.sql.factory.DTThreadFactory;
  22 import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  23 import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  24 import com.dtstack.flink.sql.side.FieldInfo;
  25 import com.dtstack.flink.sql.side.JoinInfo;
  26 import com.dtstack.flink.sql.side.cache.CacheObj;
  27 import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  28 import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  29 import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  30 import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  31 import com.google.common.collect.Maps;
  32 import com.stumbleupon.async.Deferred;
  33 import java.util.Collections;
  34 import java.util.List;
  35 import java.util.Map;
  36 import java.util.concurrent.ExecutorService;
  37 import java.util.concurrent.LinkedBlockingQueue;
  38 import java.util.concurrent.ThreadPoolExecutor;
  39 import java.util.concurrent.TimeUnit;
  40 import org.apache.commons.lang3.StringUtils;
  41 import org.apache.flink.api.java.tuple.Tuple2;
  42 import org.apache.flink.api.java.typeutils.RowTypeInfo;
  43 import org.apache.flink.configuration.Configuration;
  44 import org.apache.flink.streaming.api.functions.async.ResultFuture;
  45 import org.apache.flink.types.Row;
  46 import org.hbase.async.HBaseClient;
  47 import org.slf4j.Logger;
  48 import org.slf4j.LoggerFactory;
  49 
  50 
  51 /**
  52  * Date: 2018/8/21
  53  * Company: www.dtstack.com
  54  * @author xuchao
  55  */
  56 public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  57     private static final long serialVersionUID = 2098635104857937717L;
  58 
  59     private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  60 
  61     //match to the rule of netty3
  62     //match to the rule of netty3
  63     private static final int DEFAULT_BOSS_THREADS = 1;
  64 
  65     private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  66 
  67     private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  68 
  69     private transient HBaseClient hBaseClient;
  70 
  71     private transient AbstractRowKeyModeDealer rowKeyMode;
  72 
  73     private String tableName;
  74 
  75     private String[] colNames;
  76 
<abbr title="  77     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  77     public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList,ðŸ”µ</abbr>
  78         super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  79         tableName = ((HbaseSideTableInfo) (sideTableInfo)).getTableName();
  80         colNames = StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);
  81     }
  82 
  83     @Override
  84     public void open(Configuration parameters) throws Exception {
  85         super.open(parameters);
  86         AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();
  87         HbaseSideTableInfo hbaseSideTableInfo = ((HbaseSideTableInfo) (sideTableInfo));
<abbr title="  88         ExecutorService executorService = new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));">  88         ExecutorService executorService = new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE, 0LðŸ”µ</abbr>
<abbr title="  89         hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorService);">  89         hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), execuðŸ”µ</abbr>
  90         try {
<abbr title="  91             Deferred deferred = hBaseClient.ensureTableExists(tableName).addCallbacks(( arg) -&gt; new CheckResult(true, &quot;&quot;), ( arg) -&gt; new CheckResult(false, arg.toString()));">  91             Deferred deferred = hBaseClient.ensureTableExists(tableName).addCallbacks(( arg) -&gt; new CheckðŸ”µ</abbr>
  92             CheckResult result = ((CheckResult) (deferred.join()));
  93             if (!result.isConnect()) {
  94                 throw new RuntimeException(result.getExceptionMsg());
  95             }
  96         } catch (java.lang.Exception e) {
  97             throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
  98         }
  99         HbaseAsyncSideInfo hbaseAsyncSideInfo = ((HbaseAsyncSideInfo) (sideInfo));
 100         if (hbaseSideTableInfo.isPreRowKey()) {
<abbr title=" 101             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient, openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(), sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());"> 101             rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBasðŸ”µ</abbr>
 102         } else {
<abbr title=" 103             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient, openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(), sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());"> 103             rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseCliðŸ”µ</abbr>
 104         }
 105     }
 106 
 107     @Override
<abbr title=" 108     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Tuple2&lt;Boolean, Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean, Row&gt;&gt; resultFuture) throws Exception {"> 108     public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, Tuple2&lt;Boolean, Row&gt; input, ResultFutuðŸ”µ</abbr>
<abbr title=" 109         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 109         rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSðŸ”µ</abbr>
 110     }
 111 
 112     @Override
 113     public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {
 114         return ((HbaseAsyncSideInfo) (sideInfo)).getRowKeyBuilder().getRowKey(inputParams);
 115     }
 116 
 117     @Override
 118     public Row fillData(Row input, Object sideInput) {
 119         List&lt;Object&gt; sideInputList = ((List&lt;Object&gt;) (sideInput));
 120         Row row = new Row(sideInfo.getOutFieldInfoList().size());
 121         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()) {
 122             Object obj = input.getField(entry.getValue());
 123             obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);
 124             row.setField(entry.getKey(), obj);
 125         }
 126         for (Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()) {
 127             if (sideInputList == null) {
 128                 row.setField(entry.getKey(), null);
 129             } else {
 130                 row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 131             }
 132         }
 133         return row;
 134     }
 135 
 136     @Override
 137     public void close() throws Exception {
 138         super.close();
 139         hBaseClient.shutdown();
 140     }
 141 
 142     class CheckResult {
 143         private boolean connect;
 144 
 145         private String exceptionMsg;
 146 
 147         CheckResult(boolean connect, String msg) {
 148             this.connect = connect;
 149             this.exceptionMsg = msg;
 150         }
 151 
 152         public boolean isConnect() {
 153             return connect;
 154         }
 155 
 156         public void setConnect(boolean connect) {
 157             this.connect = connect;
 158         }
 159 
 160         public String getExceptionMsg() {
 161             return exceptionMsg;
 162         }
 163 
 164         public void setExceptionMsg(String exceptionMsg) {
 165             this.exceptionMsg = exceptionMsg;
 166         }
 167     }
 168 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.side.hbase;
  22  
  23  import com.dtstack.flink.sql.enums.ECacheContentType;
  24  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  25  import com.dtstack.flink.sql.side.FieldInfo;
  26  import com.dtstack.flink.sql.side.JoinInfo;
  27  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  28  import com.dtstack.flink.sql.side.cache.CacheObj;
  29  import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  30  import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  31  import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  32  import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  33  import com.dtstack.flink.sql.factory.DTThreadFactory;
  34  import com.google.common.collect.Maps;
  35  import com.stumbleupon.async.Deferred;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import org.apache.flink.api.java.tuple.Tuple2;</span>
  37  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  38  import org.apache.flink.configuration.Configuration;
  39  import org.apache.flink.streaming.api.functions.async.ResultFuture;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -import org.apache.flink.table.runtime.types.CRow;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;</span>
  42  import org.apache.flink.types.Row;
  43  import org.hbase.async.HBaseClient;
  44  import org.slf4j.Logger;
  45  import org.slf4j.LoggerFactory;
  46  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import java.sql.Timestamp;</span>
  48  import java.util.Collections;
  49  import java.util.List;
  50  import java.util.Map;
  51  import java.util.concurrent.ExecutorService;
  52  import java.util.concurrent.LinkedBlockingQueue;
  53  import java.util.concurrent.ThreadPoolExecutor;
  54  import java.util.concurrent.TimeUnit;
  55  
  56  /**
  57   * Date: 2018/8/21
  58   * Company: www.dtstack.com
  59   * @author xuchao
  60   */
  61  
  62  public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  63  
  64      private static final long serialVersionUID = 2098635104857937717L;
  65  
  66      private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  67  
  68      //match to the rule of netty3
  69      private static final int DEFAULT_BOSS_THREADS = 1;
  70  
  71      private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  72  
  73      private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  74  
  75      private transient HBaseClient hBaseClient;
  76  
  77      private transient AbstractRowKeyModeDealer rowKeyMode;
  78  
  79      private String tableName;
  80  
  81      private String[] colNames;
  82  
<abbr title="  83      public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  83      public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractðŸ”µ</abbr>
  84          super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  85  
  86          tableName = ((HbaseSideTableInfo)sideTableInfo).getTableName();
  87          colNames = ((HbaseSideTableInfo)sideTableInfo).getColumnRealNames();

  88      }
  89  
  90  
  91      @Override
  92      public void open(Configuration parameters) throws Exception {

  93          AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();
  94          HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;
  95          ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,
  96                  0L, TimeUnit.MILLISECONDS,
  97                  new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));
  98  
<abbr title="  99          hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorService);">  99          hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorServicðŸ”µ</abbr>
 100  
 101          try {
 102              Deferred deferred = hBaseClient.ensureTableExists(tableName)
<abbr title=" 103                      .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()));"> 103                      .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()))ðŸ”µ</abbr>
 104  
 105              CheckResult result = (CheckResult) deferred.join();
 106              if(!result.isConnect()){
 107                  throw new RuntimeException(result.getExceptionMsg());
 108              }
 109  
 110          } catch (Exception e) {
 111              throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 112          }
 113  
 114          HbaseAsyncSideInfo hbaseAsyncSideInfo = (HbaseAsyncSideInfo) sideInfo;
 115          if(hbaseSideTableInfo.isPreRowKey()){
 116              rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,
 117                      openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 118                      sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 119          }else{
 120              rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,
 121                      openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 122                      sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 123          }
 124      }
 125  
 126      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -        CRow inputCopy = new CRow(input.row(), input.change());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 129 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws Exception {"> 129 +    public void asyncInvoke(Tuple2&lt;Boolean,Row&gt; input, ResultFuture&lt;Tuple2&lt;Boolean,Row&gt;&gt; resultFuture) throws ExceðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +        Tuple2&lt;Boolean,Row&gt; inputCopy = Tuple2.of(input.f0,input.f1);</span>
 131          Map&lt;String, Object&gt; refData = Maps.newHashMap();
 132          for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {
 133              Integer conValIndex = sideInfo.getEqualValIndex().get(i);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -            Object equalObj = inputCopy.row().getField(conValIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +            Object equalObj = inputCopy.f1.getField(conValIndex);</span>
 136              if(equalObj == null){
 137                  dealMissKey(inputCopy, resultFuture);
 138                  return;
 139              }
 140              refData.put(sideInfo.getEqualFieldList().get(i), equalObj);
 141          }



 142  
 143          String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);
 144  
 145          //get from cache
 146          if (openCache()) {
 147              CacheObj val = getFromCache(rowKeyStr);
 148              if (val != null) {
 149                  if (ECacheContentType.MissVal == val.getType()) {
 150                      dealMissKey(inputCopy, resultFuture);
 151                      return;
 152                  } else if (ECacheContentType.SingleLine == val.getType()) {
 153                      try {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -                        Row row = fillData(inputCopy.row(), val);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -                        resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +                        Row row = fillData(inputCopy.f1, val);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +                        resultFuture.complete(Collections.singleton(Tuple2.of(inputCopy.f0,row)));</span>
 158                      } catch (Exception e) {
 159                          dealFillDataError(resultFuture, e, inputCopy);
 160                      }
 161                  } else if (ECacheContentType.MultiLine == val.getType()) {
 162                      try {
 163                          for (Object one : (List) val.getContent()) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -                            Row row = fillData(inputCopy.row(), one);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -                            resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +                            Row row = fillData(inputCopy.f1, one);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +                            resultFuture.complete(Collections.singleton(Tuple2.of(inputCopy.f0,row)));</span>
 168                          }
 169                      } catch (Exception e) {
 170                          dealFillDataError(resultFuture, e, inputCopy);
 171                      }
 172                  }
 173                  return;
 174              }
 175          }
 176  
 177          rowKeyMode.asyncGetData(tableName, rowKeyStr, inputCopy, resultFuture, sideInfo.getSideCache());



 178      }
 179  
 180      @Override
 181      public Row fillData(Row input, Object sideInput){
 182  
 183          List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 184          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 185          for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 186              Object obj = input.getField(entry.getValue());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 187 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 187 -            boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 188 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 189 -            if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 190 -                obj = ((Timestamp)obj).getTime();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +            obj = convertTimeIndictorTypeInfo(entry.getValue(), obj);</span>
 194              row.setField(entry.getKey(), obj);
 195          }
 196  
 197          for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 198              if(sideInputList == null){
 199                  row.setField(entry.getKey(), null);
 200              }else{
 201                  row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 202              }
 203          }
 204  
 205          return row;
 206      }
 207  
 208      @Override
 209      public void close() throws Exception {
 210          super.close();
 211          hBaseClient.shutdown();
 212      }
 213  
 214  
 215      class CheckResult{
 216  
 217          private boolean connect;
 218  
 219          private String exceptionMsg;
 220  
 221          CheckResult(boolean connect, String msg){
 222              this.connect = connect;
 223              this.exceptionMsg = msg;
 224          }
 225  
 226          public boolean isConnect() {
 227              return connect;
 228          }
 229  
 230          public void setConnect(boolean connect) {
 231              this.connect = connect;
 232          }
 233  
 234          public String getExceptionMsg() {
 235              return exceptionMsg;
 236          }
 237  
 238          public void setExceptionMsg(String exceptionMsg) {
 239              this.exceptionMsg = exceptionMsg;
 240          }
 241      }
 242  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.side.hbase;
  22  
  23  import com.dtstack.flink.sql.enums.ECacheContentType;
  24  import com.dtstack.flink.sql.side.BaseAsyncReqRow;
  25  import com.dtstack.flink.sql.side.FieldInfo;
  26  import com.dtstack.flink.sql.side.JoinInfo;
  27  import com.dtstack.flink.sql.side.AbstractSideTableInfo;
  28  import com.dtstack.flink.sql.side.cache.CacheObj;
  29  import com.dtstack.flink.sql.side.hbase.rowkeydealer.AbstractRowKeyModeDealer;
  30  import com.dtstack.flink.sql.side.hbase.rowkeydealer.PreRowKeyModeDealerDealer;
  31  import com.dtstack.flink.sql.side.hbase.rowkeydealer.RowKeyEqualModeDealer;
  32  import com.dtstack.flink.sql.side.hbase.table.HbaseSideTableInfo;
  33  import com.dtstack.flink.sql.factory.DTThreadFactory;
  34  import com.google.common.collect.Maps;
  35  import com.stumbleupon.async.Deferred;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  36 +import org.apache.commons.lang3.StringUtils;</span>
  37  import org.apache.flink.api.java.typeutils.RowTypeInfo;
  38  import org.apache.flink.configuration.Configuration;
  39  import org.apache.flink.streaming.api.functions.async.ResultFuture;
  40  import org.apache.flink.table.runtime.types.CRow;
  41  import org.apache.flink.table.typeutils.TimeIndicatorTypeInfo;
  42  import org.apache.flink.types.Row;
  43  import org.hbase.async.HBaseClient;
  44  import org.slf4j.Logger;
  45  import org.slf4j.LoggerFactory;
  46  
  47  import java.sql.Timestamp;
  48  import java.util.Collections;
  49  import java.util.List;
  50  import java.util.Map;
  51  import java.util.concurrent.ExecutorService;
  52  import java.util.concurrent.LinkedBlockingQueue;
  53  import java.util.concurrent.ThreadPoolExecutor;
  54  import java.util.concurrent.TimeUnit;
  55  
  56  /**
  57   * Date: 2018/8/21
  58   * Company: www.dtstack.com
  59   * @author xuchao
  60   */
  61  
  62  public class HbaseAsyncReqRow extends BaseAsyncReqRow {
  63  
  64      private static final long serialVersionUID = 2098635104857937717L;
  65  
  66      private static final Logger LOG = LoggerFactory.getLogger(HbaseAsyncReqRow.class);
  67  
  68      //match to the rule of netty3
  69      private static final int DEFAULT_BOSS_THREADS = 1;
  70  
  71      private static final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * 2;
  72  
  73      private static final int DEFAULT_POOL_SIZE = DEFAULT_IO_THREADS + DEFAULT_BOSS_THREADS;
  74  
  75      private transient HBaseClient hBaseClient;
  76  
  77      private transient AbstractRowKeyModeDealer rowKeyMode;
  78  
  79      private String tableName;
  80  
  81      private String[] colNames;
  82  
<abbr title="  83      public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractSideTableInfo sideTableInfo) {">  83      public HbaseAsyncReqRow(RowTypeInfo rowTypeInfo, JoinInfo joinInfo, List&lt;FieldInfo&gt; outFieldInfoList, AbstractðŸ”µ</abbr>
  84          super(new HbaseAsyncSideInfo(rowTypeInfo, joinInfo, outFieldInfoList, sideTableInfo));
  85  
  86          tableName = ((HbaseSideTableInfo)sideTableInfo).getTableName();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -        colNames = ((HbaseSideTableInfo)sideTableInfo).getColumnRealNames();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +        colNames =  StringUtils.split(sideInfo.getSideSelectFields(), &quot;,&quot;);</span>
  89      }
  90  
  91  
  92      @Override
  93      public void open(Configuration parameters) throws Exception {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +        super.open(parameters);</span>
  95          AbstractSideTableInfo sideTableInfo = sideInfo.getSideTableInfo();
  96          HbaseSideTableInfo hbaseSideTableInfo = (HbaseSideTableInfo) sideTableInfo;
  97          ExecutorService executorService =new ThreadPoolExecutor(DEFAULT_POOL_SIZE, DEFAULT_POOL_SIZE,
  98                  0L, TimeUnit.MILLISECONDS,
  99                  new LinkedBlockingQueue&lt;&gt;(), new DTThreadFactory(&quot;hbase-aysnc&quot;));
 100  
<abbr title=" 101          hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorService);"> 101          hBaseClient = new HBaseClient(hbaseSideTableInfo.getHost(), hbaseSideTableInfo.getParent(), executorServicðŸ”µ</abbr>
 102  
 103          try {
 104              Deferred deferred = hBaseClient.ensureTableExists(tableName)
<abbr title=" 105                      .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()));"> 105                      .addCallbacks(arg -&gt; new CheckResult(true, &quot;&quot;), arg -&gt; new CheckResult(false, arg.toString()))ðŸ”µ</abbr>
 106  
 107              CheckResult result = (CheckResult) deferred.join();
 108              if(!result.isConnect()){
 109                  throw new RuntimeException(result.getExceptionMsg());
 110              }
 111  
 112          } catch (Exception e) {
 113              throw new RuntimeException(&quot;create hbase connection fail:&quot;, e);
 114          }
 115  
 116          HbaseAsyncSideInfo hbaseAsyncSideInfo = (HbaseAsyncSideInfo) sideInfo;
 117          if(hbaseSideTableInfo.isPreRowKey()){
 118              rowKeyMode = new PreRowKeyModeDealerDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,
 119                      openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 120                      sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 121          }else{
 122              rowKeyMode = new RowKeyEqualModeDealer(hbaseAsyncSideInfo.getColRefType(), colNames, hBaseClient,
 123                      openCache(), sideInfo.getJoinType(), sideInfo.getOutFieldInfoList(),
 124                      sideInfo.getInFieldIndex(), sideInfo.getSideFieldIndex());
 125          }
 126      }
 127  
 128      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -    public void asyncInvoke(CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -        CRow inputCopy = new CRow(input.row(), input.change());</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -        Map&lt;String, Object&gt; refData = Maps.newHashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -        for (int i = 0; i &lt; sideInfo.getEqualValIndex().size(); i++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -            Integer conValIndex = sideInfo.getEqualValIndex().get(i);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -            Object equalObj = inputCopy.row().getField(conValIndex);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -            if(equalObj == null){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -                dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -            refData.put(sideInfo.getEqualFieldList().get(i), equalObj);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 141 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) throws Exception {"> 141 +    public void handleAsyncInvoke(Map&lt;String, Object&gt; inputParams, CRow input, ResultFuture&lt;CRow&gt; resultFuture) thðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 142 +        rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache());"> 142 +        rowKeyMode.asyncGetData(tableName, buildCacheKey(inputParams), input, resultFuture, sideInfo.getSideCache(ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +    }</span>
 144  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -        String rowKeyStr = ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(refData);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -        //get from cache</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -        if (openCache()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -            CacheObj val = getFromCache(rowKeyStr);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -            if (val != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -                if (ECacheContentType.MissVal == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -                    dealMissKey(inputCopy, resultFuture);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -                    return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -                } else if (ECacheContentType.SingleLine == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -                        Row row = fillData(inputCopy.row(), val);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -                        resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -                    } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -                        dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -                } else if (ECacheContentType.MultiLine == val.getType()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -                    try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -                        for (Object one : (List) val.getContent()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -                            Row row = fillData(inputCopy.row(), one);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -                            resultFuture.complete(Collections.singleton(new CRow(row, inputCopy.change())));</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -                    } catch (Exception e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -                        dealFillDataError(resultFuture, e, inputCopy);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -                return;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -        rowKeyMode.asyncGetData(tableName, rowKeyStr, inputCopy, resultFuture, sideInfo.getSideCache());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +    public String buildCacheKey(Map&lt;String, Object&gt; inputParams) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +        return ((HbaseAsyncSideInfo)sideInfo).getRowKeyBuilder().getRowKey(inputParams);</span>
 179      }
 180  
 181      @Override
 182      public Row fillData(Row input, Object sideInput){
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -</span>
 184          List&lt;Object&gt; sideInputList = (List&lt;Object&gt;) sideInput;
 185          Row row = new Row(sideInfo.getOutFieldInfoList().size());
 186          for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getInFieldIndex().entrySet()){
 187              Object obj = input.getField(entry.getValue());
<abbr title=" 188              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfo().getTypeAt(entry.getValue()).getClass());"> 188              boolean isTimeIndicatorTypeInfo = TimeIndicatorTypeInfo.class.isAssignableFrom(sideInfo.getRowTypeInfoðŸ”µ</abbr>
 189  
 190              if(obj instanceof Timestamp &amp;&amp; isTimeIndicatorTypeInfo){
 191                  obj = ((Timestamp)obj).getTime();
 192              }
 193  

 194              row.setField(entry.getKey(), obj);
 195          }
 196  
 197          for(Map.Entry&lt;Integer, Integer&gt; entry : sideInfo.getSideFieldIndex().entrySet()){
 198              if(sideInputList == null){
 199                  row.setField(entry.getKey(), null);
 200              }else{
 201                  row.setField(entry.getKey(), sideInputList.get(entry.getValue()));
 202              }
 203          }
 204  
 205          return row;
 206      }
 207  
 208      @Override
 209      public void close() throws Exception {
 210          super.close();
 211          hBaseClient.shutdown();
 212      }
 213  
 214  
 215      class CheckResult{
 216  
 217          private boolean connect;
 218  
 219          private String exceptionMsg;
 220  
 221          CheckResult(boolean connect, String msg){
 222              this.connect = connect;
 223              this.exceptionMsg = msg;
 224          }
 225  
 226          public boolean isConnect() {
 227              return connect;
 228          }
 229  
 230          public void setConnect(boolean connect) {
 231              this.connect = connect;
 232          }
 233  
 234          public String getExceptionMsg() {
 235              return exceptionMsg;
 236          }
 237  
 238          public void setExceptionMsg(String exceptionMsg) {
 239              this.exceptionMsg = exceptionMsg;
 240          }
 241      }
 242  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            