<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>193</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    193
                    <a href="192.html">prev</a>
                    <a href="194.html">next</a>
                    <a href="193_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    CyanogenMod/android_packages_apps_Trebuchet_eabf77ca9621393a0a32e16e7640888de08f1ea9_src/com/android/launcher3/FocusHelper.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;eabf77ca9621393a0a32e16e7640888de08f1ea9:src/com/android/launcher3/FocusHelper.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;eabf77ca9621393a0a32e16e7640888de08f1ea9^1:src/com/android/launcher3/FocusHelper.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;eabf77ca9621393a0a32e16e7640888de08f1ea9^2:src/com/android/launcher3/FocusHelper.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\CyanogenMod\android_packages_apps_Trebuchet show &quot;c3d4553d462521bc77b719109ea8cf5b5812d471:src/com/android/launcher3/FocusHelper.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [j]], subset: [[b], [j]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Copyright (C) 2015 The Android Open Source Project
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.android.launcher3;
  18 
  19 import android.util.Log;
  20 import android.view.KeyEvent;
  21 import android.view.SoundEffectConstants;
  22 import android.view.View;
  23 import android.view.ViewGroup;
  24 
  25 import com.android.launcher3.util.FocusLogic;
  26 import com.android.launcher3.util.Thunk;
  27 
  28 /**
  29  * A keyboard listener we set on all the workspace icons.
  30  */
  31 class IconKeyEventListener implements View.OnKeyListener {
  32     @Override
  33     public boolean onKey(View v, int keyCode, KeyEvent event) {
  34         return FocusHelper.handleIconKeyEvent(v, keyCode, event);
  35     }
  36 }
  37 
  38 /**
  39  * A keyboard listener we set on all the hotseat buttons.
  40  */
  41 class HotseatIconKeyEventListener implements View.OnKeyListener {
  42     @Override
  43     public boolean onKey(View v, int keyCode, KeyEvent event) {
  44         return FocusHelper.handleHotseatButtonKeyEvent(v, keyCode, event);
  45     }
  46 }
  47 
  48 public class FocusHelper {
  49 
  50     private static final String TAG = &quot;FocusHelper&quot;;
  51     private static final boolean DEBUG = false;
  52 
  53     /**
  54      * Handles key events in paged folder.
  55      */
  56     public static class PagedFolderKeyEventListener implements View.OnKeyListener {
  57 
  58         private final Folder mFolder;
  59 
  60         public PagedFolderKeyEventListener(Folder folder) {
  61             mFolder = folder;
  62         }
  63 
  64         @Override
  65         public boolean onKey(View v, int keyCode, KeyEvent e) {
  66             boolean consume = FocusLogic.shouldConsume(keyCode);
  67             if (e.getAction() == KeyEvent.ACTION_UP) {
  68                 return consume;
  69             }
  70             if (DEBUG) {
  71                 Log.v(TAG, String.format(&quot;Handle ALL Folders keyevent=[%s].&quot;,
  72                         KeyEvent.keyCodeToString(keyCode)));
  73             }
  74 
  75 
  76             if (!(v.getParent() instanceof ShortcutAndWidgetContainer)) {
  77                 if (LauncherAppState.isDogfoodBuild()) {
  78                     throw new IllegalStateException(&quot;Parent of the focused item is not supported.&quot;);
  79                 } else {
  80                     return false;
  81                 }
  82             }
  83 
  84             // Initialize variables.
  85             final ShortcutAndWidgetContainer itemContainer = (ShortcutAndWidgetContainer) v.getParent();
  86             final CellLayout cellLayout = (CellLayout) itemContainer.getParent();
  87             final int countX = cellLayout.getCountX();
  88             final int countY = cellLayout.getCountY();
  89 
  90             final int iconIndex = itemContainer.indexOfChild(v);
  91             final FolderPagedView pagedView = (FolderPagedView) cellLayout.getParent();
  92 
  93             final int pageIndex = pagedView.indexOfChild(cellLayout);
  94             final int pageCount = pagedView.getPageCount();
  95             final boolean isLayoutRtl = Utilities.isRtl(v.getResources());
  96 
  97             int[][] matrix = FocusLogic.createSparseMatrix(cellLayout);
  98             // Process focus.
  99             int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX,
 100                     countY, matrix, iconIndex, pageIndex, pageCount, isLayoutRtl);
 101             if (newIconIndex == FocusLogic.NOOP) {
 102                 handleNoopKey(keyCode, v);
 103                 return consume;
 104             }
 105             ShortcutAndWidgetContainer newParent = null;
 106             View child = null;
 107 
 108             switch (newIconIndex) {
 109                 case FocusLogic.PREVIOUS_PAGE_RIGHT_COLUMN:
 110                 case FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN:
 111                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex - 1);
 112                     if (newParent != null) {
 113                         int row = ((CellLayout.LayoutParams) v.getLayoutParams()).cellY;
 114                         pagedView.snapToPage(pageIndex - 1);
 115                         child = newParent.getChildAt(
 116                                 ((newIconIndex == FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN)
 117                                     ^ newParent.invertLayoutHorizontally()) ? 0 : countX - 1, row);
 118                     }
 119                     break;
 120                 case FocusLogic.PREVIOUS_PAGE_FIRST_ITEM:
 121                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex - 1);
 122                     if (newParent != null) {
 123                         pagedView.snapToPage(pageIndex - 1);
 124                         child = newParent.getChildAt(0, 0);
 125                     }
 126                     break;
 127                 case FocusLogic.PREVIOUS_PAGE_LAST_ITEM:
 128                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex - 1);
 129                     if (newParent != null) {
 130                         pagedView.snapToPage(pageIndex - 1);
 131                         child = newParent.getChildAt(countX - 1, countY - 1);
 132                     }
 133                     break;
 134                 case FocusLogic.NEXT_PAGE_FIRST_ITEM:
 135                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex + 1);
 136                     if (newParent != null) {
 137                         pagedView.snapToPage(pageIndex + 1);
 138                         child = newParent.getChildAt(0, 0);
 139                     }
 140                     break;
 141                 case FocusLogic.NEXT_PAGE_LEFT_COLUMN:
 142                 case FocusLogic.NEXT_PAGE_RIGHT_COLUMN:
 143                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex + 1);
 144                     if (newParent != null) {
 145                         pagedView.snapToPage(pageIndex + 1);
 146                         child = FocusLogic.getAdjacentChildInNextPage(newParent, v, newIconIndex);
 147                     }
 148                     break;
 149                 case FocusLogic.CURRENT_PAGE_FIRST_ITEM:
 150                     child = cellLayout.getChildAt(0, 0);
 151                     break;
 152                 case FocusLogic.CURRENT_PAGE_LAST_ITEM:
 153                     child = pagedView.getLastItem();
 154                     break;
 155                 default: // Go to some item on the current page.
 156                     child = itemContainer.getChildAt(newIconIndex);
 157                     break;
 158             }
 159             if (child != null) {
 160                 child.requestFocus();
 161                 playSoundEffect(keyCode, v);
 162             } else {
 163                 handleNoopKey(keyCode, v);
 164             }
 165             return consume;
 166         }
 167 
 168         public void handleNoopKey(int keyCode, View v) {
 169             if (keyCode == KeyEvent.KEYCODE_DPAD_DOWN) {
 170                 mFolder.mFolderName.requestFocus();
 171                 playSoundEffect(keyCode, v);
 172             }
 173         }
 174     }
 175 
 176     /**
 177      * Handles key events in the workspace hot seat (bottom of the screen).
 178      * &lt;p&gt;Currently we don&#x27;t special case for the phone UI in different orientations, even though
 179      * the hotseat is on the side in landscape mode. This is to ensure that accessibility
 180      * consistency is maintained across rotations.
 181      */
 182     static boolean handleHotseatButtonKeyEvent(View v, int keyCode, KeyEvent e) {
 183         boolean consume = FocusLogic.shouldConsume(keyCode);
 184         if (e.getAction() == KeyEvent.ACTION_UP || !consume) {
 185             return consume;
 186         }
 187 
 188         DeviceProfile profile = ((Launcher) v.getContext()).getDeviceProfile();
 189 
 190         if (DEBUG) {
 191             Log.v(TAG, String.format(
 192                     &quot;Handle HOTSEAT BUTTONS keyevent=[%s] on hotseat buttons, isVertical=%s&quot;,
 193                     KeyEvent.keyCodeToString(keyCode), profile.isVerticalBarLayout()));
 194         }
 195 
 196         // Initialize the variables.
 197         final ShortcutAndWidgetContainer hotseatParent = (ShortcutAndWidgetContainer) v.getParent();
 198         final CellLayout hotseatLayout = (CellLayout) hotseatParent.getParent();
 199         Hotseat hotseat = (Hotseat) hotseatLayout.getParent();
 200 
 201         Workspace workspace = (Workspace) v.getRootView().findViewById(R.id.workspace);
 202         int pageIndex = workspace.getNextPage();
 203         int pageCount = workspace.getChildCount();
 204         int countX = -1;
 205         int countY = -1;
 206         int iconIndex = hotseatParent.indexOfChild(v);
 207         int iconRank = ((CellLayout.LayoutParams) hotseatLayout.getShortcutsAndWidgets()
 208                 .getChildAt(iconIndex).getLayoutParams()).cellX;
 209 
 210         final CellLayout iconLayout = (CellLayout) workspace.getChildAt(pageIndex);
 211         if (iconLayout == null) {
 212             // This check is to guard against cases where key strokes rushes in when workspace
 213             // child creation/deletion is still in flux. (e.g., during drop or fling
 214             // animation.)
 215             return consume;
 216         }
 217         final ViewGroup iconParent = iconLayout.getShortcutsAndWidgets();
 218 
 219         ViewGroup parent = null;
 220         int[][] matrix = null;
 221 
 222         if (keyCode == KeyEvent.KEYCODE_DPAD_UP &amp;&amp;
 223                 !profile.isVerticalBarLayout()) {
 224             matrix = FocusLogic.createSparseMatrix(iconLayout, hotseatLayout,
 225                     true /* hotseat horizontal */, hotseat.getAllAppsButtonRank(),
 226                     iconRank == hotseat.getAllAppsButtonRank() /* include all apps icon */);
 227             iconIndex += iconParent.getChildCount();
 228             countX = iconLayout.getCountX();
 229             countY = iconLayout.getCountY() + hotseatLayout.getCountY();
 230             parent = iconParent;
 231         } else if (keyCode == KeyEvent.KEYCODE_DPAD_LEFT &amp;&amp;
 232                 profile.isVerticalBarLayout()) {
 233             matrix = FocusLogic.createSparseMatrix(iconLayout, hotseatLayout,
 234                     false /* hotseat horizontal */, hotseat.getAllAppsButtonRank(),
 235                     iconRank == hotseat.getAllAppsButtonRank() /* include all apps icon */);
 236             iconIndex += iconParent.getChildCount();
 237             countX = iconLayout.getCountX() + hotseatLayout.getCountX();
 238             countY = iconLayout.getCountY();
 239             parent = iconParent;
 240         } else if (keyCode == KeyEvent.KEYCODE_DPAD_RIGHT &amp;&amp;
 241                 profile.isVerticalBarLayout()) {
 242             keyCode = KeyEvent.KEYCODE_PAGE_DOWN;
 243         }else {
 244             // For other KEYCODE_DPAD_LEFT and KEYCODE_DPAD_RIGHT navigation, do not use the
 245             // matrix extended with hotseat.
 246             matrix = FocusLogic.createSparseMatrix(hotseatLayout);
 247             countX = hotseatLayout.getCountX();
 248             countY = hotseatLayout.getCountY();
 249             parent = hotseatParent;
 250         }
 251 
 252         // Process the focus.
 253         int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX,
 254                 countY, matrix, iconIndex, pageIndex, pageCount, Utilities.isRtl(v.getResources()));
 255 
 256         View newIcon = null;
 257         if (newIconIndex == FocusLogic.NEXT_PAGE_FIRST_ITEM) {
 258             parent = getCellLayoutChildrenForIndex(workspace, pageIndex + 1);
 259             newIcon = parent.getChildAt(0);
 260             // TODO(hyunyoungs): handle cases where the child is not an icon but
 261             // a folder or a widget.
 262             workspace.snapToPage(pageIndex + 1);
 263         }
 264         if (parent == iconParent &amp;&amp; newIconIndex &gt;= iconParent.getChildCount()) {
 265             newIconIndex -= iconParent.getChildCount();
 266         }
 267         if (parent != null) {
 268             if (newIcon == null &amp;&amp; newIconIndex &gt;=0) {
 269                 newIcon = parent.getChildAt(newIconIndex);
 270             }
 271             if (newIcon != null) {
 272                 newIcon.requestFocus();
 273                 playSoundEffect(keyCode, v);
 274             }
 275         }
 276         return consume;
 277     }
 278 
 279     /**
 280      * Handles key events in a workspace containing icons.
 281      */
 282     static boolean handleIconKeyEvent(View v, int keyCode, KeyEvent e) {
 283         boolean consume = FocusLogic.shouldConsume(keyCode);
 284         if (e.getAction() == KeyEvent.ACTION_UP || !consume) {
 285             return consume;
 286         }
 287 
 288         Launcher launcher = (Launcher) v.getContext();
 289         DeviceProfile profile = launcher.getDeviceProfile();
 290 
 291         if (DEBUG) {
 292             Log.v(TAG, String.format(&quot;Handle WORKSPACE ICONS keyevent=[%s] isVerticalBar=%s&quot;,
 293                     KeyEvent.keyCodeToString(keyCode), profile.isVerticalBarLayout()));
 294         }
 295 
 296         // Initialize the variables.
 297         ShortcutAndWidgetContainer parent = (ShortcutAndWidgetContainer) v.getParent();
 298         CellLayout iconLayout = (CellLayout) parent.getParent();
 299         final Workspace workspace = (Workspace) iconLayout.getParent();
 300         final ViewGroup dragLayer = (ViewGroup) workspace.getParent();
 301         final ViewGroup tabs = (ViewGroup) dragLayer.findViewById(R.id.search_drop_target_bar);
 302         final Hotseat hotseat = (Hotseat) dragLayer.findViewById(R.id.hotseat);
 303 
 304 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 305         final int iconIndex = parent.indexOfChild(v);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 306         final int pageIndex = workspace.indexOfChild(iconLayout);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 307         final int pageCount = workspace.getChildCount();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 308         int countX = iconLayout.getCountX();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 309         int countY = iconLayout.getCountY();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 310 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 311         CellLayout hotseatLayout = (CellLayout) hotseat.getChildAt(0);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 312         ShortcutAndWidgetContainer hotseatParent = hotseatLayout.getShortcutsAndWidgets();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 313         int[][] matrix;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 314 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 315         // KEYCODE_DPAD_DOWN in portrait (KEYCODE_DPAD_RIGHT in landscape) is the only key allowed</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 316         // to take a user to the hotseat. For other dpad navigation, do not use the matrix extended</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 317         // with the hotseat.</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 318         if (keyCode == KeyEvent.KEYCODE_DPAD_DOWN &amp;&amp; !profile.isVerticalBarLayout()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 319             matrix = FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, true /* horizontal */,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 320                     hotseat.getAllAppsButtonRank(),</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 321                     !hotseat.hasIcons() /* ignore all apps icon, unless there are no other icons */);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 322             countY = countY + 1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 323         } else if (keyCode == KeyEvent.KEYCODE_DPAD_RIGHT &amp;&amp;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 324                 profile.isVerticalBarLayout()) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 325             matrix = FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, false /* horizontal */,</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 326                     hotseat.getAllAppsButtonRank(),</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 327                     !hotseat.hasIcons() /* ignore all apps icon, unless there are no other icons */);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 328             countX = countX + 1;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 329         } else if (keyCode == KeyEvent.KEYCODE_DEL || keyCode == KeyEvent.KEYCODE_FORWARD_DEL) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 330             workspace.removeWorkspaceItem(v);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 331             return consume;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 332         } else {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 333             matrix = FocusLogic.createSparseMatrix(iconLayout);</span>
 334 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335         // NOTE: currently we don&#x27;t special case for the phone UI in different</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336         // orientations, even though the hotseat is on the side in landscape mode. This</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337         // is to ensure that accessibility consistency is maintained across rotations.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338         final int action = e.getAction();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339         final boolean handleKeyEvent = (action != KeyEvent.ACTION_UP);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340         boolean wasHandled = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341         switch (keyCode) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342             case KeyEvent.KEYCODE_DPAD_LEFT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343                 if (handleKeyEvent) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344                     ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345                     int myIndex = views.indexOf(v);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346                     // Select the previous button, otherwise do nothing</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347                     if (myIndex &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348                         views.get(myIndex - 1).requestFocus();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349                         v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 353                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 354             case KeyEvent.KEYCODE_DPAD_RIGHT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 355                 if (handleKeyEvent) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 356                     ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 357                     int myIndex = views.indexOf(v);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 358                     // Select the next button, otherwise do nothing</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 359                     if (myIndex &lt; views.size() - 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 360                         views.get(myIndex + 1).requestFocus();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 361                         v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 362                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 363                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 364                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 365                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 366             case KeyEvent.KEYCODE_DPAD_UP:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 367                 if (handleKeyEvent) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 368                     final Workspace workspace = (Workspace)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 369                             v.getRootView().findViewById(R.id.workspace);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 370                     if (workspace != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 371                         int pageIndex = workspace.getCurrentPage();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 372                         CellLayout topLayout = (CellLayout) workspace.getChildAt(pageIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 373                         ShortcutAndWidgetContainer children = topLayout.getShortcutsAndWidgets();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 374                         final View newIcon = getIconInDirection(layout, children, -1, 1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 375                         // Select the first bubble text view in the current page of the workspace</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 376                         if (newIcon != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 377                             newIcon.requestFocus();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 378                             v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 379                         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 380                             workspace.requestFocus();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 381                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 382                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 383                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 384                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 385                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 386             case KeyEvent.KEYCODE_DPAD_DOWN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 387                 // Do nothing</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 388                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 389                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 390             default: break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 391         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 392         return wasHandled;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 393     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 394 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 395     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 396      * Private helper method to get the CellLayoutChildren given a CellLayout index.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 397      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 398     private static ShortcutAndWidgetContainer getCellLayoutChildrenForIndex(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 399             ViewGroup container, int i) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 400         CellLayout parent = (CellLayout) container.getChildAt(i);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 401         return parent.getShortcutsAndWidgets();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 402     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 403 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 404     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 405      * Private helper method to sort all the CellLayout children in order of their (x,y) spatially</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 406      * from top left to bottom right.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 407      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 408     private static ArrayList&lt;View&gt; getCellLayoutChildrenSortedSpatially(CellLayout layout,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 409             ViewGroup parent) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 410         // First we order each the CellLayout children by their x,y coordinates</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 411         final int cellCountX = layout.getCountX();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 412         final int count = parent.getChildCount();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 413         ArrayList&lt;View&gt; views = new ArrayList&lt;View&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 414         for (int j = 0; j &lt; count; ++j) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 415             views.add(parent.getChildAt(j));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 416         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 417         Collections.sort(views, new Comparator&lt;View&gt;() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 418             @Override</span>
 419 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420         // NOTE: currently we don&#x27;t special case for the phone UI in different</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421         // orientations, even though the hotseat is on the side in landscape mode. This</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422         // is to ensure that accessibility consistency is maintained across rotations.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 423         final int action = e.getAction();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 424         final boolean handleKeyEvent = (action != KeyEvent.ACTION_UP);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 425         boolean wasHandled = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 426         switch (keyCode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 427             case KeyEvent.KEYCODE_DPAD_LEFT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 428                 if (handleKeyEvent) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 429                     ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 430                     int myIndex = views.indexOf(v);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 431                     // Select the previous button, otherwise do nothing</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 432                     if (myIndex &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 433                         views.get(myIndex - 1).requestFocus();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 434                         v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 435                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 436                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 437                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 438                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 439             case KeyEvent.KEYCODE_DPAD_RIGHT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 440                 if (handleKeyEvent) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 441                     ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 442                     int myIndex = views.indexOf(v);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 443                     // Select the next button, otherwise do nothing</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 444                     if (myIndex &lt; views.size() - 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 445                         views.get(myIndex + 1).requestFocus();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 446                         v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 447                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 448                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 449                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 450                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 451             case KeyEvent.KEYCODE_DPAD_UP:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 452                 if (handleKeyEvent) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 453                     final Workspace workspace = (Workspace)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 454                             v.getRootView().findViewById(R.id.workspace);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 455                     if (workspace != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 456                         int pageIndex = workspace.getCurrentPage();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 457                         CellLayout topLayout = (CellLayout) workspace.getChildAt(pageIndex);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 458                         if (topLayout == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 459                             // This is to guard against monkey actor test where the cell layout</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 460                             // of the new pageIndex is null monkey issuing commands while</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 461                             // animations happen.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 462                             return wasHandled;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 463                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 464                         ShortcutAndWidgetContainer children = topLayout.getShortcutsAndWidgets();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 465                         final View newIcon = getIconInDirection(layout, children, -1, 1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 466                         // Select the first bubble text view in the current page of the workspace</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 467                         if (newIcon != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 468                             newIcon.requestFocus();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 469                             v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 470                         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 471                             workspace.requestFocus();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 472                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 473                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 474                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 475                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 476                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 477             case KeyEvent.KEYCODE_DPAD_DOWN:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 478                 // Do nothing</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 479                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 480                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 481             default: break;</span>
 482 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 483         }
 484 
 485         // Process the focus.
 486         int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX,
 487                 countY, matrix, iconIndex, pageIndex, pageCount, Utilities.isRtl(v.getResources()));
 488         View newIcon = null;
 489         switch (newIconIndex) {
 490             case FocusLogic.NOOP:
 491                 if (keyCode == KeyEvent.KEYCODE_DPAD_UP) {
 492                     newIcon = tabs;
 493                 }
 494                 break;
 495             case FocusLogic.PREVIOUS_PAGE_RIGHT_COLUMN:
 496             case FocusLogic.NEXT_PAGE_RIGHT_COLUMN:
 497                 int newPageIndex = pageIndex - 1;
 498                 if (newIconIndex == FocusLogic.NEXT_PAGE_RIGHT_COLUMN) {
 499                     newPageIndex = pageIndex + 1;
 500                 }
 501                 int row = ((CellLayout.LayoutParams) v.getLayoutParams()).cellY;
 502                 parent = getCellLayoutChildrenForIndex(workspace, newPageIndex);
 503                 workspace.snapToPage(newPageIndex);
 504                 if (parent != null) {
 505                     workspace.snapToPage(newPageIndex);
 506                     iconLayout = (CellLayout) parent.getParent();
 507                     matrix = FocusLogic.createSparseMatrix(iconLayout,
 508                         iconLayout.getCountX(), row);
 509                     newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX + 1, countY,
 510                             matrix, FocusLogic.PIVOT, newPageIndex, pageCount,
 511                             Utilities.isRtl(v.getResources()));
 512                     newIcon = parent.getChildAt(newIconIndex);
 513                 }
 514                 break;
 515             case FocusLogic.PREVIOUS_PAGE_FIRST_ITEM:
 516                 parent = getCellLayoutChildrenForIndex(workspace, pageIndex - 1);
 517                 newIcon = parent.getChildAt(0);
 518                 workspace.snapToPage(pageIndex - 1);
 519                 break;
 520             case FocusLogic.PREVIOUS_PAGE_LAST_ITEM:
 521                 parent = getCellLayoutChildrenForIndex(workspace, pageIndex - 1);
 522                 newIcon = parent.getChildAt(parent.getChildCount() - 1);
 523                 workspace.snapToPage(pageIndex - 1);
 524                 break;
 525             case FocusLogic.NEXT_PAGE_FIRST_ITEM:
 526                 parent = getCellLayoutChildrenForIndex(workspace, pageIndex + 1);
 527                 newIcon = parent.getChildAt(0);
 528                 workspace.snapToPage(pageIndex + 1);
 529                 break;
 530             case FocusLogic.NEXT_PAGE_LEFT_COLUMN:
 531             case FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN:
 532                 newPageIndex = pageIndex + 1;
 533                 if (newIconIndex == FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN) {
 534                     newPageIndex = pageIndex - 1;
 535                 }
 536                 workspace.snapToPage(newPageIndex);
 537                 row = ((CellLayout.LayoutParams) v.getLayoutParams()).cellY;
 538                 parent = getCellLayoutChildrenForIndex(workspace, newPageIndex);
 539                 if (parent != null) {
 540                     workspace.snapToPage(newPageIndex);
 541                     iconLayout = (CellLayout) parent.getParent();
 542                     matrix = FocusLogic.createSparseMatrix(iconLayout, -1, row);
 543                     newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX + 1, countY,
 544                             matrix, FocusLogic.PIVOT, newPageIndex, pageCount,
 545                             Utilities.isRtl(v.getResources()));
 546                     newIcon = parent.getChildAt(newIconIndex);
 547                 }
 548                 break;
 549             case FocusLogic.CURRENT_PAGE_FIRST_ITEM:
 550                 newIcon = parent.getChildAt(0);
 551                 break;
 552             case FocusLogic.CURRENT_PAGE_LAST_ITEM:
 553                 newIcon = parent.getChildAt(parent.getChildCount() - 1);
 554                 break;
 555             default:
 556                 // current page, some item.
 557                 if (0 &lt;= newIconIndex &amp;&amp; newIconIndex &lt; parent.getChildCount()) {
 558                     newIcon = parent.getChildAt(newIconIndex);
 559                 } else if (parent.getChildCount() &lt;= newIconIndex &amp;&amp;
 560                         newIconIndex &lt; parent.getChildCount() + hotseatParent.getChildCount()) {
 561                     newIcon = hotseatParent.getChildAt(newIconIndex - parent.getChildCount());
 562                 }
 563                 break;
 564         }
 565         if (newIcon != null) {
 566             newIcon.requestFocus();
 567             playSoundEffect(keyCode, v);
 568         }
 569         return consume;
 570     }
 571 
 572     //
 573     // Helper methods.
 574     //
 575 
 576     /**
 577      * Private helper method to get the CellLayoutChildren given a CellLayout index.
 578      */
 579     private static ShortcutAndWidgetContainer getCellLayoutChildrenForIndex(
 580             ViewGroup container, int i) {
 581         CellLayout parent = (CellLayout) container.getChildAt(i);
 582         return parent.getShortcutsAndWidgets();
 583     }
 584 
 585     /**
 586      * Helper method to be used for playing sound effects.
 587      */
 588     @Thunk static void playSoundEffect(int keyCode, View v) {
 589         switch (keyCode) {
 590             case KeyEvent.KEYCODE_DPAD_LEFT:
 591                 v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);
 592                 break;
 593             case KeyEvent.KEYCODE_DPAD_RIGHT:
 594                 v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);
 595                 break;
 596             case KeyEvent.KEYCODE_DPAD_DOWN:
 597             case KeyEvent.KEYCODE_PAGE_DOWN:
 598             case KeyEvent.KEYCODE_MOVE_END:
 599                 v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 600                 break;
 601             case KeyEvent.KEYCODE_DPAD_UP:
 602             case KeyEvent.KEYCODE_PAGE_UP:
 603             case KeyEvent.KEYCODE_MOVE_HOME:
 604                 v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 605                 break;
 606             default:
 607                 break;
 608         }
 609     }
 610 }</pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2015 The Android Open Source Project
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 
  17 package com.android.launcher3;
  18 
  19 import android.util.Log;
  20 import android.view.KeyEvent;
  21 import android.view.SoundEffectConstants;
  22 import android.view.View;
  23 import android.view.ViewGroup;
  24 
  25 import com.android.launcher3.util.FocusLogic;
  26 import com.android.launcher3.util.Thunk;
  27 
  28 /**
  29  * A keyboard listener we set on all the workspace icons.
  30  */
  31 
  32 
  33 /**
  34  * A keyboard listener we set on all the workspace icons.
  35  */
  36 class IconKeyEventListener implements View.OnKeyListener {
  37     @Override
  38 public boolean onKey(View v, int keyCode, KeyEvent event) {
  39         return FocusHelper.handleIconKeyEvent(v, keyCode, event);
  40     }
  41 }
  42 
  43 /**
  44  * A keyboard listener we set on all the hotseat buttons.
  45  */
  46 
  47 
  48 /**
  49  * A keyboard listener we set on all the hotseat buttons.
  50  */
  51 class HotseatIconKeyEventListener implements View.OnKeyListener {
  52     @Override
  53 public boolean onKey(View v, int keyCode, KeyEvent event) {
  54         return FocusHelper.handleHotseatButtonKeyEvent(v, keyCode, event);
  55     }
  56 }
  57 
  58 public class FocusHelper {
  59 
  60     private static final String TAG = &quot;FocusHelper&quot;;
  61     private static final boolean DEBUG = false;
  62 
  63     /**
  64      * Handles key events in paged folder.
  65      */
  66     public static class PagedFolderKeyEventListener implements View.OnKeyListener {
  67 
  68         private final Folder mFolder;
  69 
  70         public PagedFolderKeyEventListener(Folder folder) {
  71             mFolder = folder;
  72         }
  73 
  74         @Override
  75         public boolean onKey(View v, int keyCode, KeyEvent e) {
  76             boolean consume = FocusLogic.shouldConsume(keyCode);
  77             if (e.getAction() == KeyEvent.ACTION_UP) {
  78                 return consume;
  79             }
  80             if (DEBUG) {
  81                 Log.v(TAG, String.format(&quot;Handle ALL Folders keyevent=[%s].&quot;,
  82                         KeyEvent.keyCodeToString(keyCode)));
  83             }
  84 
  85 
  86             if (!(v.getParent() instanceof ShortcutAndWidgetContainer)) {
  87                 if (LauncherAppState.isDogfoodBuild()) {
  88                     throw new IllegalStateException(&quot;Parent of the focused item is not supported.&quot;);
  89                 } else {
  90                     return false;
  91                 }
  92             }
  93 
  94             // Initialize variables.
  95             final ShortcutAndWidgetContainer itemContainer = (ShortcutAndWidgetContainer) v.getParent();
  96             final CellLayout cellLayout = (CellLayout) itemContainer.getParent();
  97             final int countX = cellLayout.getCountX();
  98             final int countY = cellLayout.getCountY();
  99 
 100             final int iconIndex = itemContainer.indexOfChild(v);
 101             final FolderPagedView pagedView = (FolderPagedView) cellLayout.getParent();
 102 
 103             final int pageIndex = pagedView.indexOfChild(cellLayout);
 104             final int pageCount = pagedView.getPageCount();
 105             final boolean isLayoutRtl = Utilities.isRtl(v.getResources());
 106 
 107             int[][] matrix = FocusLogic.createSparseMatrix(cellLayout);
 108             // Process focus.
 109             int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX,
 110                     countY, matrix, iconIndex, pageIndex, pageCount, isLayoutRtl);
 111             if (newIconIndex == FocusLogic.NOOP) {
 112                 handleNoopKey(keyCode, v);
 113                 return consume;
 114             }
 115             ShortcutAndWidgetContainer newParent = null;
 116             View child = null;
 117 
 118             switch (newIconIndex) {
 119                 case FocusLogic.PREVIOUS_PAGE_RIGHT_COLUMN:
 120                 case FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN:
 121                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex - 1);
 122                     if (newParent != null) {
 123                         int row = ((CellLayout.LayoutParams) v.getLayoutParams()).cellY;
 124                         pagedView.snapToPage(pageIndex - 1);
 125                         child = newParent.getChildAt(
 126                                 ((newIconIndex == FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN)
 127                                     ^ newParent.invertLayoutHorizontally()) ? 0 : countX - 1, row);
 128                     }
 129                     break;
 130                 case FocusLogic.PREVIOUS_PAGE_FIRST_ITEM:
 131                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex - 1);
 132                     if (newParent != null) {
 133                         pagedView.snapToPage(pageIndex - 1);
 134                         child = newParent.getChildAt(0, 0);
 135                     }
 136                     break;
 137                 case FocusLogic.PREVIOUS_PAGE_LAST_ITEM:
 138                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex - 1);
 139                     if (newParent != null) {
 140                         pagedView.snapToPage(pageIndex - 1);
 141                         child = newParent.getChildAt(countX - 1, countY - 1);
 142                     }
 143                     break;
 144                 case FocusLogic.NEXT_PAGE_FIRST_ITEM:
 145                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex + 1);
 146                     if (newParent != null) {
 147                         pagedView.snapToPage(pageIndex + 1);
 148                         child = newParent.getChildAt(0, 0);
 149                     }
 150                     break;
 151                 case FocusLogic.NEXT_PAGE_LEFT_COLUMN:
 152                 case FocusLogic.NEXT_PAGE_RIGHT_COLUMN:
 153                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex + 1);
 154                     if (newParent != null) {
 155                         pagedView.snapToPage(pageIndex + 1);
 156                         child = FocusLogic.getAdjacentChildInNextPage(newParent, v, newIconIndex);
 157                     }
 158                     break;
 159                 case FocusLogic.CURRENT_PAGE_FIRST_ITEM:
 160                     child = cellLayout.getChildAt(0, 0);
 161                     break;
 162                 case FocusLogic.CURRENT_PAGE_LAST_ITEM:
 163                     child = pagedView.getLastItem();
 164                     break;
 165                 default: // Go to some item on the current page.
 166                     child = itemContainer.getChildAt(newIconIndex);
 167                     break;
 168             }
 169             if (child != null) {
 170                 child.requestFocus();
 171                 playSoundEffect(keyCode, v);
 172             } else {
 173                 handleNoopKey(keyCode, v);
 174             }
 175             return consume;
 176         }
 177 
 178         public void handleNoopKey(int keyCode, View v) {
 179             if (keyCode == KeyEvent.KEYCODE_DPAD_DOWN) {
 180                 mFolder.mFolderName.requestFocus();
 181                 playSoundEffect(keyCode, v);
 182             }
 183         }
 184     }
 185 
 186     /**
 187      * Handles key events in the workspace hot seat (bottom of the screen).
 188      * &lt;p&gt;Currently we don&#x27;t special case for the phone UI in different orientations, even though
 189      * the hotseat is on the side in landscape mode. This is to ensure that accessibility
 190      * consistency is maintained across rotations.
 191      */
 192     static boolean handleHotseatButtonKeyEvent(View v, int keyCode, KeyEvent e) {
 193         boolean consume = FocusLogic.shouldConsume(keyCode);
 194         if (e.getAction() == KeyEvent.ACTION_UP || !consume) {
 195             return consume;
 196         }
 197 
 198         DeviceProfile profile = ((Launcher) v.getContext()).getDeviceProfile();
 199 
 200         if (DEBUG) {
 201             Log.v(TAG, String.format(
 202                     &quot;Handle HOTSEAT BUTTONS keyevent=[%s] on hotseat buttons, isVertical=%s&quot;,
 203                     KeyEvent.keyCodeToString(keyCode), profile.isVerticalBarLayout()));
 204         }
 205 
 206         // Initialize the variables.
 207         final ShortcutAndWidgetContainer hotseatParent = (ShortcutAndWidgetContainer) v.getParent();
 208         final CellLayout hotseatLayout = (CellLayout) hotseatParent.getParent();
 209         Hotseat hotseat = (Hotseat) hotseatLayout.getParent();
 210 
 211         Workspace workspace = (Workspace) v.getRootView().findViewById(R.id.workspace);
 212         int pageIndex = workspace.getNextPage();
 213         int pageCount = workspace.getChildCount();
 214         int countX = -1;
 215         int countY = -1;
 216         int iconIndex = hotseatParent.indexOfChild(v);
 217         int iconRank = ((CellLayout.LayoutParams) hotseatLayout.getShortcutsAndWidgets()
 218                 .getChildAt(iconIndex).getLayoutParams()).cellX;
 219 
 220         final CellLayout iconLayout = (CellLayout) workspace.getChildAt(pageIndex);
 221         if (iconLayout == null) {
 222             // This check is to guard against cases where key strokes rushes in when workspace
 223             // child creation/deletion is still in flux. (e.g., during drop or fling
 224             // animation.)
 225             return consume;
 226         }
 227         final ViewGroup iconParent = iconLayout.getShortcutsAndWidgets();
 228 
 229         ViewGroup parent = null;
 230         int[][] matrix = null;
 231 
 232         if (keyCode == KeyEvent.KEYCODE_DPAD_UP &amp;&amp;
 233                 !profile.isVerticalBarLayout()) {
 234             matrix = FocusLogic.createSparseMatrix(iconLayout, hotseatLayout,
 235                     true /* hotseat horizontal */, hotseat.getAllAppsButtonRank(),
 236                     iconRank == hotseat.getAllAppsButtonRank() /* include all apps icon */);
 237             iconIndex += iconParent.getChildCount();
 238             countX = iconLayout.getCountX();
 239             countY = iconLayout.getCountY() + hotseatLayout.getCountY();
 240             parent = iconParent;
 241         } else if (keyCode == KeyEvent.KEYCODE_DPAD_LEFT &amp;&amp;
 242                 profile.isVerticalBarLayout()) {
 243             matrix = FocusLogic.createSparseMatrix(iconLayout, hotseatLayout,
 244                     false /* hotseat horizontal */, hotseat.getAllAppsButtonRank(),
 245                     iconRank == hotseat.getAllAppsButtonRank() /* include all apps icon */);
 246             iconIndex += iconParent.getChildCount();
 247             countX = iconLayout.getCountX() + hotseatLayout.getCountX();
 248             countY = iconLayout.getCountY();
 249             parent = iconParent;
 250         } else if (keyCode == KeyEvent.KEYCODE_DPAD_RIGHT &amp;&amp;
 251                 profile.isVerticalBarLayout()) {
 252             keyCode = KeyEvent.KEYCODE_PAGE_DOWN;
 253         }else {
 254             // For other KEYCODE_DPAD_LEFT and KEYCODE_DPAD_RIGHT navigation, do not use the
 255             // matrix extended with hotseat.
 256             matrix = FocusLogic.createSparseMatrix(hotseatLayout);
 257             countX = hotseatLayout.getCountX();
 258             countY = hotseatLayout.getCountY();
 259             parent = hotseatParent;
 260         }
 261 
 262         // Process the focus.
 263         int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX,
 264                 countY, matrix, iconIndex, pageIndex, pageCount, Utilities.isRtl(v.getResources()));
 265 
 266         View newIcon = null;
 267         if (newIconIndex == FocusLogic.NEXT_PAGE_FIRST_ITEM) {
 268             parent = getCellLayoutChildrenForIndex(workspace, pageIndex + 1);
 269             newIcon = parent.getChildAt(0);
 270             // TODO(hyunyoungs): handle cases where the child is not an icon but
 271             // a folder or a widget.
 272             workspace.snapToPage(pageIndex + 1);
 273         }
 274         if (parent == iconParent &amp;&amp; newIconIndex &gt;= iconParent.getChildCount()) {
 275             newIconIndex -= iconParent.getChildCount();
 276         }
 277         if (parent != null) {
 278             if (newIcon == null &amp;&amp; newIconIndex &gt;=0) {
 279                 newIcon = parent.getChildAt(newIconIndex);
 280             }
 281             if (newIcon != null) {
 282                 newIcon.requestFocus();
 283                 playSoundEffect(keyCode, v);
 284             }
 285         }
 286         return consume;
 287     }
 288 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 289 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 290 static boolean handleHotseatButtonKeyEvent(View v, int keyCode, KeyEvent e, int orientation) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 291         ShortcutAndWidgetContainer parent = (ShortcutAndWidgetContainer) v.getParent();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 292         final CellLayout layout = (CellLayout) parent.getParent();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 293 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 294         // NOTE: currently we don&#x27;t special case for the phone UI in different</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 295         // orientations, even though the hotseat is on the side in landscape mode. This</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 296         // is to ensure that accessibility consistency is maintained across rotations.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 297         final int action = e.getAction();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 298         final boolean handleKeyEvent = (action != KeyEvent.ACTION_UP);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 299         boolean wasHandled = false;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 300         switch (keyCode) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 301             case KeyEvent.KEYCODE_DPAD_LEFT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 302                 if (handleKeyEvent) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 303                     ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 304                     int myIndex = views.indexOf(v);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 305                     // Select the previous button, otherwise do nothing</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 306                     if (myIndex &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 307                         views.get(myIndex - 1).requestFocus();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 308                         v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 309                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 310                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 311                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 312                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 313             case KeyEvent.KEYCODE_DPAD_RIGHT:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 314                 if (handleKeyEvent) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 315                     ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 316                     int myIndex = views.indexOf(v);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 317                     // Select the next button, otherwise do nothing</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 318                     if (myIndex &lt; views.size() - 1) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 319                         views.get(myIndex + 1).requestFocus();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 320                         v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 321                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 322                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 323                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 324                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 325             case KeyEvent.KEYCODE_DPAD_UP:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 326                 if (handleKeyEvent) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 327                     final Workspace workspace = (Workspace)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 328                             v.getRootView().findViewById(R.id.workspace);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 329                     if (workspace != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 330                         int pageIndex = workspace.getCurrentPage();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 331                         CellLayout topLayout = (CellLayout) workspace.getChildAt(pageIndex);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 332                         ShortcutAndWidgetContainer children = topLayout.getShortcutsAndWidgets();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 333                         final View newIcon = getIconInDirection(layout, children, -1, 1);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 334                         // Select the first bubble text view in the current page of the workspace</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 335                         if (newIcon != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 336                             newIcon.requestFocus();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 337                             v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 338                         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 339                             workspace.requestFocus();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 340                         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 341                     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 342                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 343                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 344                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 345             case KeyEvent.KEYCODE_DPAD_DOWN:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 346                 // Do nothing</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 347                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 348                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 349             default: break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 350         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 351         return wasHandled;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 352     }</span>
 353 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 354 static boolean handleHotseatButtonKeyEvent(View v, int keyCode, KeyEvent e, int orientation) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 355         ShortcutAndWidgetContainer parent = (ShortcutAndWidgetContainer) v.getParent();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 356         final CellLayout layout = (CellLayout) parent.getParent();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 357 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 358         // NOTE: currently we don&#x27;t special case for the phone UI in different</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 359         // orientations, even though the hotseat is on the side in landscape mode. This</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 360         // is to ensure that accessibility consistency is maintained across rotations.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 361         final int action = e.getAction();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 362         final boolean handleKeyEvent = (action != KeyEvent.ACTION_UP);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 363         boolean wasHandled = false;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 364         switch (keyCode) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 365             case KeyEvent.KEYCODE_DPAD_LEFT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 366                 if (handleKeyEvent) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 367                     ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 368                     int myIndex = views.indexOf(v);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 369                     // Select the previous button, otherwise do nothing</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 370                     if (myIndex &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 371                         views.get(myIndex - 1).requestFocus();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 372                         v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 373                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 374                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 375                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 376                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 377             case KeyEvent.KEYCODE_DPAD_RIGHT:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 378                 if (handleKeyEvent) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 379                     ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 380                     int myIndex = views.indexOf(v);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 381                     // Select the next button, otherwise do nothing</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 382                     if (myIndex &lt; views.size() - 1) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 383                         views.get(myIndex + 1).requestFocus();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 384                         v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 385                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 386                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 387                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 388                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 389             case KeyEvent.KEYCODE_DPAD_UP:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 390                 if (handleKeyEvent) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 391                     final Workspace workspace = (Workspace)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 392                             v.getRootView().findViewById(R.id.workspace);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 393                     if (workspace != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 394                         int pageIndex = workspace.getCurrentPage();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 395                         CellLayout topLayout = (CellLayout) workspace.getChildAt(pageIndex);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 396                         if (topLayout == null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 397                             // This is to guard against monkey actor test where the cell layout</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 398                             // of the new pageIndex is null monkey issuing commands while</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 399                             // animations happen.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 400                             return wasHandled;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 401                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 402                         ShortcutAndWidgetContainer children = topLayout.getShortcutsAndWidgets();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 403                         final View newIcon = getIconInDirection(layout, children, -1, 1);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 404                         // Select the first bubble text view in the current page of the workspace</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 405                         if (newIcon != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 406                             newIcon.requestFocus();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 407                             v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 408                         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 409                             workspace.requestFocus();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 410                         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 411                     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 412                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 413                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 414                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 415             case KeyEvent.KEYCODE_DPAD_DOWN:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 416                 // Do nothing</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 417                 wasHandled = true;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 418                 break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 419             default: break;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 420         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 421         return wasHandled;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 422     }</span>
 423 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 424 
 425 
 426     //
 427     // Helper methods.
 428     //
 429 
 430     /**
 431      * Private helper method to get the CellLayoutChildren given a CellLayout index.
 432      */
 433     private static ShortcutAndWidgetContainer getCellLayoutChildrenForIndex(
 434             ViewGroup container, int i) {
 435         CellLayout parent = (CellLayout) container.getChildAt(i);
 436         return parent.getShortcutsAndWidgets();
 437     }
 438 
 439     /**
 440      * Helper method to be used for playing sound effects.
 441      */
 442     @Thunk static void playSoundEffect(int keyCode, View v) {
 443         switch (keyCode) {
 444             case KeyEvent.KEYCODE_DPAD_LEFT:
 445                 v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);
 446                 break;
 447             case KeyEvent.KEYCODE_DPAD_RIGHT:
 448                 v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);
 449                 break;
 450             case KeyEvent.KEYCODE_DPAD_DOWN:
 451             case KeyEvent.KEYCODE_PAGE_DOWN:
 452             case KeyEvent.KEYCODE_MOVE_END:
 453                 v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 454                 break;
 455             case KeyEvent.KEYCODE_DPAD_UP:
 456             case KeyEvent.KEYCODE_PAGE_UP:
 457             case KeyEvent.KEYCODE_MOVE_HOME:
 458                 v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 459                 break;
 460             default:
 461                 break;
 462         }
 463     }
 464 
 465     /**
 466      * Handles key events in a workspace containing icons.
 467      */
 468     static boolean handleIconKeyEvent(View v, int keyCode, KeyEvent e) {
 469         boolean consume = FocusLogic.shouldConsume(keyCode);
 470         if (e.getAction() == KeyEvent.ACTION_UP || !consume) {
 471             return consume;
 472         }
 473 
 474         Launcher launcher = (Launcher) v.getContext();
 475         DeviceProfile profile = launcher.getDeviceProfile();
 476 
 477         if (DEBUG) {
 478             Log.v(TAG, String.format(&quot;Handle WORKSPACE ICONS keyevent=[%s] isVerticalBar=%s&quot;,
 479                     KeyEvent.keyCodeToString(keyCode), profile.isVerticalBarLayout()));
 480         }
 481 
 482         // Initialize the variables.
 483         ShortcutAndWidgetContainer parent = (ShortcutAndWidgetContainer) v.getParent();
 484         CellLayout iconLayout = (CellLayout) parent.getParent();
 485         final Workspace workspace = (Workspace) iconLayout.getParent();
 486         final ViewGroup dragLayer = (ViewGroup) workspace.getParent();
 487         final ViewGroup tabs = (ViewGroup) dragLayer.findViewById(R.id.search_drop_target_bar);
 488         final Hotseat hotseat = (Hotseat) dragLayer.findViewById(R.id.hotseat);
 489 
 490         final int iconIndex = parent.indexOfChild(v);
 491         final int pageIndex = workspace.indexOfChild(iconLayout);
 492         final int pageCount = workspace.getChildCount();
 493         int countX = iconLayout.getCountX();
 494         int countY = iconLayout.getCountY();
 495 
 496         CellLayout hotseatLayout = (CellLayout) hotseat.getChildAt(0);
 497         ShortcutAndWidgetContainer hotseatParent = hotseatLayout.getShortcutsAndWidgets();
 498         int[][] matrix;
 499 
 500         // KEYCODE_DPAD_DOWN in portrait (KEYCODE_DPAD_RIGHT in landscape) is the only key allowed
 501         // to take a user to the hotseat. For other dpad navigation, do not use the matrix extended
 502         // with the hotseat.
 503         if (keyCode == KeyEvent.KEYCODE_DPAD_DOWN &amp;&amp; !profile.isVerticalBarLayout()) {
 504             matrix = FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, true /* horizontal */,
 505                     hotseat.getAllAppsButtonRank(),
 506                     !hotseat.hasIcons() /* ignore all apps icon, unless there are no other icons */);
 507             countY = countY + 1;
 508         } else if (keyCode == KeyEvent.KEYCODE_DPAD_RIGHT &amp;&amp;
 509                 profile.isVerticalBarLayout()) {
 510             matrix = FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, false /* horizontal */,
 511                     hotseat.getAllAppsButtonRank(),
 512                     !hotseat.hasIcons() /* ignore all apps icon, unless there are no other icons */);
 513             countX = countX + 1;
 514         } else if (keyCode == KeyEvent.KEYCODE_DEL || keyCode == KeyEvent.KEYCODE_FORWARD_DEL) {
 515             workspace.removeWorkspaceItem(v);
 516             return consume;
 517                     } else {
 518             matrix = FocusLogic.createSparseMatrix(iconLayout);
 519         }
 520 
 521         // Process the focus.
 522         int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX,
 523                 countY, matrix, iconIndex, pageIndex, pageCount, Utilities.isRtl(v.getResources()));
 524         View newIcon = null;
 525         switch (newIconIndex) {
 526             case FocusLogic.NOOP:
 527                 if (keyCode == KeyEvent.KEYCODE_DPAD_UP) {
 528                     newIcon = tabs;
 529                 }
 530                 break;
 531             case FocusLogic.PREVIOUS_PAGE_RIGHT_COLUMN:
 532             case FocusLogic.NEXT_PAGE_RIGHT_COLUMN:
 533                 int newPageIndex = pageIndex - 1;
 534                 if (newIconIndex == FocusLogic.NEXT_PAGE_RIGHT_COLUMN) {
 535                     newPageIndex = pageIndex + 1;
 536                 }
 537                 int row = ((CellLayout.LayoutParams) v.getLayoutParams()).cellY;
 538                 parent = getCellLayoutChildrenForIndex(workspace, newPageIndex);
 539                 workspace.snapToPage(newPageIndex);
 540                 if (parent != null) {
 541                     workspace.snapToPage(newPageIndex);
 542                     iconLayout = (CellLayout) parent.getParent();
 543                     matrix = FocusLogic.createSparseMatrix(iconLayout,
 544                         iconLayout.getCountX(), row);
 545                     newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX + 1, countY,
 546                             matrix, FocusLogic.PIVOT, newPageIndex, pageCount,
 547                             Utilities.isRtl(v.getResources()));
 548                     newIcon = parent.getChildAt(newIconIndex);
 549                 }
 550                 break;
 551             case FocusLogic.PREVIOUS_PAGE_FIRST_ITEM:
 552                             parent = getCellLayoutChildrenForIndex(workspace, pageIndex - 1);
 553                 newIcon = parent.getChildAt(0);
 554                                 workspace.snapToPage(pageIndex - 1);
 555                 break;
 556             case FocusLogic.PREVIOUS_PAGE_LAST_ITEM:
 557                         parent = getCellLayoutChildrenForIndex(workspace, pageIndex - 1);
 558                 newIcon = parent.getChildAt(parent.getChildCount() - 1);
 559                             workspace.snapToPage(pageIndex - 1);
 560                 break;
 561             case FocusLogic.NEXT_PAGE_FIRST_ITEM:
 562                         parent = getCellLayoutChildrenForIndex(workspace, pageIndex + 1);
 563                 newIcon = parent.getChildAt(0);
 564                             workspace.snapToPage(pageIndex + 1);
 565                 break;
 566             case FocusLogic.NEXT_PAGE_LEFT_COLUMN:
 567             case FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN:
 568                 newPageIndex = pageIndex + 1;
 569                 if (newIconIndex == FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN) {
 570                     newPageIndex = pageIndex - 1;
 571                         }
 572                 workspace.snapToPage(newPageIndex);
 573                 row = ((CellLayout.LayoutParams) v.getLayoutParams()).cellY;
 574                 parent = getCellLayoutChildrenForIndex(workspace, newPageIndex);
 575                 if (parent != null) {
 576                     workspace.snapToPage(newPageIndex);
 577                     iconLayout = (CellLayout) parent.getParent();
 578                     matrix = FocusLogic.createSparseMatrix(iconLayout, -1, row);
 579                     newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX + 1, countY,
 580                             matrix, FocusLogic.PIVOT, newPageIndex, pageCount,
 581                             Utilities.isRtl(v.getResources()));
 582                     newIcon = parent.getChildAt(newIconIndex);
 583                 }
 584                 break;
 585             case FocusLogic.CURRENT_PAGE_FIRST_ITEM:
 586                 newIcon = parent.getChildAt(0);
 587                 break;
 588             case FocusLogic.CURRENT_PAGE_LAST_ITEM:
 589                 newIcon = parent.getChildAt(parent.getChildCount() - 1);
 590                 break;
 591             default:
 592                 // current page, some item.
 593                 if (0 &lt;= newIconIndex &amp;&amp; newIconIndex &lt; parent.getChildCount()) {
 594                     newIcon = parent.getChildAt(newIconIndex);
 595                 } else if (parent.getChildCount() &lt;= newIconIndex &amp;&amp;
 596                         newIconIndex &lt; parent.getChildCount() + hotseatParent.getChildCount()) {
 597                     newIcon = hotseatParent.getChildAt(newIconIndex - parent.getChildCount());
 598                 }
 599                 break;
 600         }
 601                         if (newIcon != null) {
 602                             newIcon.requestFocus();
 603             playSoundEffect(keyCode, v);
 604                         }
 605         return consume;
 606     }
 607 }
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Copyright (C) 2015 The Android Open Source Project
   3  *
   4  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5  * you may not use this file except in compliance with the License.
   6  * You may obtain a copy of the License at
   7  *
   8  *      http://www.apache.org/licenses/LICENSE-2.0
   9  *
  10  * Unless required by applicable law or agreed to in writing, software
  11  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13  * See the License for the specific language governing permissions and
  14  * limitations under the License.
  15  */
  16 package com.android.launcher3;
  17 
  18 import android.util.Log;
  19 import android.view.KeyEvent;
  20 import android.view.SoundEffectConstants;
  21 import android.view.View;
  22 import android.view.ViewGroup;
  23 import com.android.launcher3.util.FocusLogic;
  24 import com.android.launcher3.util.Thunk;
  25 
  26 
  27 public class FocusHelper {
  28     private static final String TAG = &quot;FocusHelper&quot;;
  29 
  30     private static final boolean DEBUG = false;
  31 
  32     /**
  33      * Handles key events in paged folder.
  34      */
  35     public static class PagedFolderKeyEventListener implements View.OnKeyListener {
  36         private final Folder mFolder;
  37 
  38         public PagedFolderKeyEventListener(Folder folder) {
  39             mFolder = folder;
  40         }
  41 
  42         @Override
  43         public boolean onKey(View v, int keyCode, KeyEvent e) {
  44             boolean consume = FocusLogic.shouldConsume(keyCode);
  45             if (e.getAction() == KeyEvent.ACTION_UP) {
  46                 return consume;
  47             }
  48             if (DEBUG) {
<abbr title="  49                 Log.v(TAG, String.format(&quot;Handle ALL Folders keyevent=[%s].&quot;, KeyEvent.keyCodeToString(keyCode)));">  49                 Log.v(TAG, String.format(&quot;Handle ALL Folders keyevent=[%s].&quot;, KeyEvent.keyCodeToString(ke🔵</abbr>
  50             }
  51             if (!(v.getParent() instanceof ShortcutAndWidgetContainer)) {
  52                 if (LauncherAppState.isDogfoodBuild()) {
  53                     throw new IllegalStateException(&quot;Parent of the focused item is not supported.&quot;);
  54                 } else {
  55                     return false;
  56                 }
  57             }
  58             // Initialize variables.
<abbr title="  59             final ShortcutAndWidgetContainer itemContainer = ((ShortcutAndWidgetContainer) (v.getParent()));">  59             final ShortcutAndWidgetContainer itemContainer = ((ShortcutAndWidgetContainer) (v.getParent()🔵</abbr>
  60             final CellLayout cellLayout = ((CellLayout) (itemContainer.getParent()));
  61             final int countX = cellLayout.getCountX();
  62             final int countY = cellLayout.getCountY();
  63             final int iconIndex = itemContainer.indexOfChild(v);
  64             final FolderPagedView pagedView = ((FolderPagedView) (cellLayout.getParent()));
  65             final int pageIndex = pagedView.indexOfChild(cellLayout);
  66             final int pageCount = pagedView.getPageCount();
  67             final boolean isLayoutRtl = Utilities.isRtl(v.getResources());
  68             int[][] matrix = FocusLogic.createSparseMatrix(cellLayout);
  69             // Process focus.
<abbr title="  70             int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX, countY, matrix, iconIndex, pageIndex, pageCount, isLayoutRtl);">  70             int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX, countY, matrix, iconIndex, page🔵</abbr>
  71             if (newIconIndex == FocusLogic.NOOP) {
  72                 handleNoopKey(keyCode, v);
  73                 return consume;
  74             }
  75             ShortcutAndWidgetContainer newParent = null;
  76             View child = null;
  77             switch (newIconIndex) {
  78                 case FocusLogic.PREVIOUS_PAGE_RIGHT_COLUMN :
  79                 case FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN :
  80                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex - 1);
  81                     if (newParent != null) {
  82                         int row = ((CellLayout.LayoutParams) (v.getLayoutParams())).cellY;
  83                         pagedView.snapToPage(pageIndex - 1);
<abbr title="  84                         child = newParent.getChildAt((newIconIndex == FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN) ^ newParent.invertLayoutHorizontally() ? 0 : countX - 1, row);">  84                         child = newParent.getChildAt((newIconIndex == FocusLogic.PREVIOUS_PAGE_LEFT_COLUM🔵</abbr>
  85                     }
  86                     break;
  87                 case FocusLogic.PREVIOUS_PAGE_FIRST_ITEM :
  88                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex - 1);
  89                     if (newParent != null) {
  90                         pagedView.snapToPage(pageIndex - 1);
  91                         child = newParent.getChildAt(0, 0);
  92                     }
  93                     break;
  94                 case FocusLogic.PREVIOUS_PAGE_LAST_ITEM :
  95                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex - 1);
  96                     if (newParent != null) {
  97                         pagedView.snapToPage(pageIndex - 1);
  98                         child = newParent.getChildAt(countX - 1, countY - 1);
  99                     }
 100                     break;
 101                 case FocusLogic.NEXT_PAGE_FIRST_ITEM :
 102                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex + 1);
 103                     if (newParent != null) {
 104                         pagedView.snapToPage(pageIndex + 1);
 105                         child = newParent.getChildAt(0, 0);
 106                     }
 107                     break;
 108                 case FocusLogic.NEXT_PAGE_LEFT_COLUMN :
 109                 case FocusLogic.NEXT_PAGE_RIGHT_COLUMN :
 110                     newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex + 1);
 111                     if (newParent != null) {
 112                         pagedView.snapToPage(pageIndex + 1);
 113                         child = FocusLogic.getAdjacentChildInNextPage(newParent, v, newIconIndex);
 114                     }
 115                     break;
 116                 case FocusLogic.CURRENT_PAGE_FIRST_ITEM :
 117                     child = cellLayout.getChildAt(0, 0);
 118                     break;
 119                 case FocusLogic.CURRENT_PAGE_LAST_ITEM :
 120                     child = pagedView.getLastItem();
 121                     break;
 122                 default :
 123                     // Go to some item on the current page.
 124                     child = itemContainer.getChildAt(newIconIndex);
 125                     break;
 126             }
 127             if (child != null) {
 128                 child.requestFocus();
 129                 playSoundEffect(keyCode, v);
 130             } else {
 131                 handleNoopKey(keyCode, v);
 132             }
 133             return consume;
 134         }
 135 
 136         public void handleNoopKey(int keyCode, View v) {
 137             if (keyCode == KeyEvent.KEYCODE_DPAD_DOWN) {
 138                 mFolder.mFolderName.requestFocus();
 139                 playSoundEffect(keyCode, v);
 140             }
 141         }
 142     }
 143 
 144     /**
 145      * Handles key events in the workspace hot seat (bottom of the screen).
 146      * &lt;p&gt;Currently we don&#x27;t special case for the phone UI in different orientations, even though
 147      * the hotseat is on the side in landscape mode. This is to ensure that accessibility
 148      * consistency is maintained across rotations.
 149      */
 150     static boolean handleHotseatButtonKeyEvent(View v, int keyCode, KeyEvent e) {
 151         boolean consume = FocusLogic.shouldConsume(keyCode);
 152         if ((e.getAction() == KeyEvent.ACTION_UP) || (!consume)) {
 153             return consume;
 154         }
 155         DeviceProfile profile = ((Launcher) (v.getContext())).getDeviceProfile();
 156         if (DEBUG) {
<abbr title=" 157             Log.v(TAG, String.format(&quot;Handle HOTSEAT BUTTONS keyevent=[%s] on hotseat buttons, isVertical=%s&quot;, KeyEvent.keyCodeToString(keyCode), profile.isVerticalBarLayout()));"> 157             Log.v(TAG, String.format(&quot;Handle HOTSEAT BUTTONS keyevent=[%s] on hotseat buttons, isVertical🔵</abbr>
 158         }
 159         // Initialize the variables.
 160         final ShortcutAndWidgetContainer hotseatParent = ((ShortcutAndWidgetContainer) (v.getParent()));
 161         final CellLayout hotseatLayout = ((CellLayout) (hotseatParent.getParent()));
 162         Hotseat hotseat = ((Hotseat) (hotseatLayout.getParent()));
 163         Workspace workspace = ((Workspace) (v.getRootView().findViewById(R.id.workspace)));
 164         int pageIndex = workspace.getNextPage();
 165         int pageCount = workspace.getChildCount();
 166         int countX = -1;
 167         int countY = -1;
 168         int iconIndex = hotseatParent.indexOfChild(v);
<abbr title=" 169         int iconRank = ((CellLayout.LayoutParams) (hotseatLayout.getShortcutsAndWidgets().getChildAt(iconIndex).getLayoutParams())).cellX;"> 169         int iconRank = ((CellLayout.LayoutParams) (hotseatLayout.getShortcutsAndWidgets().getChildAt(icon🔵</abbr>
 170         final CellLayout iconLayout = ((CellLayout) (workspace.getChildAt(pageIndex)));
 171         if (iconLayout == null) {
 172             // This check is to guard against cases where key strokes rushes in when workspace
 173             // child creation/deletion is still in flux. (e.g., during drop or fling
 174             // animation.)
 175             return consume;
 176         }
 177         final ViewGroup iconParent = iconLayout.getShortcutsAndWidgets();
 178         ViewGroup parent = null;
 179         int[][] matrix = null;
 180         if ((keyCode == KeyEvent.KEYCODE_DPAD_UP) &amp;&amp; (!profile.isVerticalBarLayout())) {
 181             matrix = /* hotseat horizontal */
 182             /* include all apps icon */
<abbr title=" 183             FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, true, hotseat.getAllAppsButtonRank(), iconRank == hotseat.getAllAppsButtonRank());"> 183             FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, true, hotseat.getAllAppsButtonRank()🔵</abbr>
 184             iconIndex += iconParent.getChildCount();
 185             countX = iconLayout.getCountX();
 186             countY = iconLayout.getCountY() + hotseatLayout.getCountY();
 187             parent = iconParent;
 188         } else if ((keyCode == KeyEvent.KEYCODE_DPAD_LEFT) &amp;&amp; profile.isVerticalBarLayout()) {
 189             matrix = /* hotseat horizontal */
 190             /* include all apps icon */
<abbr title=" 191             FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, false, hotseat.getAllAppsButtonRank(), iconRank == hotseat.getAllAppsButtonRank());"> 191             FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, false, hotseat.getAllAppsButtonRank(🔵</abbr>
 192             iconIndex += iconParent.getChildCount();
 193             countX = iconLayout.getCountX() + hotseatLayout.getCountX();
 194             countY = iconLayout.getCountY();
 195             parent = iconParent;
 196         } else if ((keyCode == KeyEvent.KEYCODE_DPAD_RIGHT) &amp;&amp; profile.isVerticalBarLayout()) {
 197             keyCode = KeyEvent.KEYCODE_PAGE_DOWN;
 198         } else {
 199             // For other KEYCODE_DPAD_LEFT and KEYCODE_DPAD_RIGHT navigation, do not use the
 200             // matrix extended with hotseat.
 201             matrix = FocusLogic.createSparseMatrix(hotseatLayout);
 202             countX = hotseatLayout.getCountX();
 203             countY = hotseatLayout.getCountY();
 204             parent = hotseatParent;
 205         }
 206         // Process the focus.
<abbr title=" 207         int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX, countY, matrix, iconIndex, pageIndex, pageCount, Utilities.isRtl(v.getResources()));"> 207         int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX, countY, matrix, iconIndex, pageInde🔵</abbr>
 208         View newIcon = null;
 209         if (newIconIndex == FocusLogic.NEXT_PAGE_FIRST_ITEM) {
 210             parent = getCellLayoutChildrenForIndex(workspace, pageIndex + 1);
 211             newIcon = parent.getChildAt(0);
 212             // TODO(hyunyoungs): handle cases where the child is not an icon but
 213             // a folder or a widget.
 214             workspace.snapToPage(pageIndex + 1);
 215         }
 216         if ((parent == iconParent) &amp;&amp; (newIconIndex &gt;= iconParent.getChildCount())) {
 217             newIconIndex -= iconParent.getChildCount();
 218         }
 219         if (parent != null) {
 220             if ((newIcon == null) &amp;&amp; (newIconIndex &gt;= 0)) {
 221                 newIcon = parent.getChildAt(newIconIndex);
 222             }
 223             if (newIcon != null) {
 224                 newIcon.requestFocus();
 225                 playSoundEffect(keyCode, v);
 226             }
 227         }
 228         return consume;
 229     }
 230 
 231     /**
 232      * Handles key events in a workspace containing icons.
 233      */
 234     static boolean handleIconKeyEvent(View v, int keyCode, KeyEvent e) {
 235         boolean consume = FocusLogic.shouldConsume(keyCode);
 236         if ((e.getAction() == KeyEvent.ACTION_UP) || (!consume)) {
 237             return consume;
 238         }
 239         Launcher launcher = ((Launcher) (v.getContext()));
 240         DeviceProfile profile = launcher.getDeviceProfile();
 241         if (DEBUG) {
<abbr title=" 242             Log.v(TAG, String.format(&quot;Handle WORKSPACE ICONS keyevent=[%s] isVerticalBar=%s&quot;, KeyEvent.keyCodeToString(keyCode), profile.isVerticalBarLayout()));"> 242             Log.v(TAG, String.format(&quot;Handle WORKSPACE ICONS keyevent=[%s] isVerticalBar=%s&quot;, KeyEvent.ke🔵</abbr>
 243         }
 244         // Initialize the variables.
 245         ShortcutAndWidgetContainer parent = ((ShortcutAndWidgetContainer) (v.getParent()));
 246         CellLayout iconLayout = ((CellLayout) (parent.getParent()));
 247         final Workspace workspace = ((Workspace) (iconLayout.getParent()));
 248         final ViewGroup dragLayer = ((ViewGroup) (workspace.getParent()));
 249         final ViewGroup tabs = ((ViewGroup) (dragLayer.findViewById(R.id.search_drop_target_bar)));
 250         final Hotseat hotseat = ((Hotseat) (dragLayer.findViewById(R.id.hotseat)));
 251         final int iconIndex = parent.indexOfChild(v);
 252         final int pageIndex = workspace.indexOfChild(iconLayout);
 253         final int pageCount = workspace.getChildCount();
 254         int countX = iconLayout.getCountX();
 255         int countY = iconLayout.getCountY();
 256         CellLayout hotseatLayout = ((CellLayout) (hotseat.getChildAt(0)));
 257         ShortcutAndWidgetContainer hotseatParent = hotseatLayout.getShortcutsAndWidgets();
 258         int[][] matrix;
 259         // KEYCODE_DPAD_DOWN in portrait (KEYCODE_DPAD_RIGHT in landscape) is the only key allowed
 260         // to take a user to the hotseat. For other dpad navigation, do not use the matrix extended
 261         // with the hotseat.
 262         if ((keyCode == KeyEvent.KEYCODE_DPAD_DOWN) &amp;&amp; (!profile.isVerticalBarLayout())) {
 263             matrix = /* horizontal */
 264             /* ignore all apps icon, unless there are no other icons */
<abbr title=" 265             FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, true, hotseat.getAllAppsButtonRank(), !hotseat.hasIcons());"> 265             FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, true, hotseat.getAllAppsButtonRank()🔵</abbr>
 266             countY = countY + 1;
 267         } else if ((keyCode == KeyEvent.KEYCODE_DPAD_RIGHT) &amp;&amp; profile.isVerticalBarLayout()) {
 268             matrix = /* horizontal */
 269             /* ignore all apps icon, unless there are no other icons */
<abbr title=" 270             FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, false, hotseat.getAllAppsButtonRank(), !hotseat.hasIcons());"> 270             FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, false, hotseat.getAllAppsButtonRank(🔵</abbr>
 271             countX = countX + 1;
 272         } else if ((keyCode == KeyEvent.KEYCODE_DEL) || (keyCode == KeyEvent.KEYCODE_FORWARD_DEL)) {
 273             workspace.removeWorkspaceItem(v);
 274             return consume;
 275         } else {
 276             matrix = FocusLogic.createSparseMatrix(iconLayout);
 277         }
 278         // Process the focus.
<abbr title=" 279         int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX, countY, matrix, iconIndex, pageIndex, pageCount, Utilities.isRtl(v.getResources()));"> 279         int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX, countY, matrix, iconIndex, pageInde🔵</abbr>
 280         View newIcon = null;
 281         switch (newIconIndex) {
 282             case FocusLogic.NOOP :
 283                 if (keyCode == KeyEvent.KEYCODE_DPAD_UP) {
 284                     newIcon = tabs;
 285                 }
 286                 break;
 287             case FocusLogic.PREVIOUS_PAGE_RIGHT_COLUMN :
 288             case FocusLogic.NEXT_PAGE_RIGHT_COLUMN :
 289                 int newPageIndex = pageIndex - 1;
 290                 if (newIconIndex == FocusLogic.NEXT_PAGE_RIGHT_COLUMN) {
 291                     newPageIndex = pageIndex + 1;
 292                 }
 293                 int row = ((CellLayout.LayoutParams) (v.getLayoutParams())).cellY;
 294                 parent = getCellLayoutChildrenForIndex(workspace, newPageIndex);
 295                 workspace.snapToPage(newPageIndex);
 296                 if (parent != null) {
 297                     workspace.snapToPage(newPageIndex);
 298                     iconLayout = ((CellLayout) (parent.getParent()));
 299                     matrix = FocusLogic.createSparseMatrix(iconLayout, iconLayout.getCountX(), row);
<abbr title=" 300                     newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX + 1, countY, matrix, FocusLogic.PIVOT, newPageIndex, pageCount, Utilities.isRtl(v.getResources()));"> 300                     newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX + 1, countY, matrix, FocusLo🔵</abbr>
 301                     newIcon = parent.getChildAt(newIconIndex);
 302                 }
 303                 break;
 304             case FocusLogic.PREVIOUS_PAGE_FIRST_ITEM :
 305                 parent = getCellLayoutChildrenForIndex(workspace, pageIndex - 1);
 306                 newIcon = parent.getChildAt(0);
 307                 workspace.snapToPage(pageIndex - 1);
 308                 break;
 309             case FocusLogic.PREVIOUS_PAGE_LAST_ITEM :
 310                 parent = getCellLayoutChildrenForIndex(workspace, pageIndex - 1);
 311                 newIcon = parent.getChildAt(parent.getChildCount() - 1);
 312                 workspace.snapToPage(pageIndex - 1);
 313                 break;
 314             case FocusLogic.NEXT_PAGE_FIRST_ITEM :
 315                 parent = getCellLayoutChildrenForIndex(workspace, pageIndex + 1);
 316                 newIcon = parent.getChildAt(0);
 317                 workspace.snapToPage(pageIndex + 1);
 318                 break;
 319             case FocusLogic.NEXT_PAGE_LEFT_COLUMN :
 320             case FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN :
 321                 newPageIndex = pageIndex + 1;
 322                 if (newIconIndex == FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN) {
 323                     newPageIndex = pageIndex - 1;
 324                 }
 325                 workspace.snapToPage(newPageIndex);
 326                 row = ((CellLayout.LayoutParams) (v.getLayoutParams())).cellY;
 327                 parent = getCellLayoutChildrenForIndex(workspace, newPageIndex);
 328                 if (parent != null) {
 329                     workspace.snapToPage(newPageIndex);
 330                     iconLayout = ((CellLayout) (parent.getParent()));
 331                     matrix = FocusLogic.createSparseMatrix(iconLayout, -1, row);
<abbr title=" 332                     newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX + 1, countY, matrix, FocusLogic.PIVOT, newPageIndex, pageCount, Utilities.isRtl(v.getResources()));"> 332                     newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX + 1, countY, matrix, FocusLo🔵</abbr>
 333                     newIcon = parent.getChildAt(newIconIndex);
 334                 }
 335                 break;
 336             case FocusLogic.CURRENT_PAGE_FIRST_ITEM :
 337                 newIcon = parent.getChildAt(0);
 338                 break;
 339             case FocusLogic.CURRENT_PAGE_LAST_ITEM :
 340                 newIcon = parent.getChildAt(parent.getChildCount() - 1);
 341                 break;
 342             default :
 343                 // current page, some item.
 344                 if ((0 &lt;= newIconIndex) &amp;&amp; (newIconIndex &lt; parent.getChildCount())) {
 345                     newIcon = parent.getChildAt(newIconIndex);
<abbr title=" 346                 } else if ((parent.getChildCount() &lt;= newIconIndex) &amp;&amp; (newIconIndex &lt; (parent.getChildCount() + hotseatParent.getChildCount()))) {"> 346                 } else if ((parent.getChildCount() &lt;= newIconIndex) &amp;&amp; (newIconIndex &lt; (parent.getChildCo🔵</abbr>
 347                     newIcon = hotseatParent.getChildAt(newIconIndex - parent.getChildCount());
 348                 }
 349                 break;
 350         }
 351         if (newIcon != null) {
 352             newIcon.requestFocus();
 353             playSoundEffect(keyCode, v);
 354         }
 355         return consume;
 356     }
 357 
 358     //
 359     // Helper methods.
 360     //
 361     /**
 362      * Private helper method to get the CellLayoutChildren given a CellLayout index.
 363      */
 364     private static ShortcutAndWidgetContainer getCellLayoutChildrenForIndex(ViewGroup container, int i) {
 365         CellLayout parent = ((CellLayout) (container.getChildAt(i)));
 366         return parent.getShortcutsAndWidgets();
 367     }
 368 
 369     /**
 370      * Helper method to be used for playing sound effects.
 371      */
 372     @Thunk
 373     static void playSoundEffect(int keyCode, View v) {
 374         switch (keyCode) {
 375             case KeyEvent.KEYCODE_DPAD_LEFT :
 376                 v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);
 377                 break;
 378             case KeyEvent.KEYCODE_DPAD_RIGHT :
 379                 v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);
 380                 break;
 381             case KeyEvent.KEYCODE_DPAD_DOWN :
 382             case KeyEvent.KEYCODE_PAGE_DOWN :
 383             case KeyEvent.KEYCODE_MOVE_END :
 384                 v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 385                 break;
 386             case KeyEvent.KEYCODE_DPAD_UP :
 387             case KeyEvent.KEYCODE_PAGE_UP :
 388             case KeyEvent.KEYCODE_MOVE_HOME :
 389                 v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 390                 break;
 391             default :
 392                 break;
 393         }
 394     }
 395 }
 396 
 397 /**
 398  * A keyboard listener we set on all the hotseat buttons.
 399  */
 400 class HotseatIconKeyEventListener implements View.OnKeyListener {
 401     @Override
 402     public boolean onKey(View v, int keyCode, KeyEvent event) {
 403         return FocusHelper.handleHotseatButtonKeyEvent(v, keyCode, event);
 404     }
 405 }
 406 
 407 /**
 408  * A keyboard listener we set on all the workspace icons.
 409  */
 410 class IconKeyEventListener implements View.OnKeyListener {
 411     @Override
 412     public boolean onKey(View v, int keyCode, KeyEvent event) {
 413         return FocusHelper.handleIconKeyEvent(v, keyCode, event);
 414     }
 415 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * Copyright (C) 2011 The Android Open Source Project</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   3 + * Copyright (C) 2015 The Android Open Source Project</span>
   4   *
   5   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   6   * you may not use this file except in compliance with the License.
   7   * You may obtain a copy of the License at
   8   *
   9   *      http://www.apache.org/licenses/LICENSE-2.0
  10   *
  11   * Unless required by applicable law or agreed to in writing, software
  12   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  13   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  14   * See the License for the specific language governing permissions and
  15   * limitations under the License.
  16   */
  17  
  18  package com.android.launcher3;
  19  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import android.content.res.Configuration;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  21 +import android.util.Log;</span>
  22  import android.view.KeyEvent;
  23  import android.view.SoundEffectConstants;
  24  import android.view.View;
  25  import android.view.ViewGroup;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import android.widget.ScrollView;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import java.util.ArrayList;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import java.util.Collections;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import java.util.Comparator;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  32 +import com.android.launcher3.util.FocusLogic;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import com.android.launcher3.util.Thunk;</span>
  34  
  35  /**
  36   * A keyboard listener we set on all the workspace icons.
  37   */
  38  class IconKeyEventListener implements View.OnKeyListener {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  39 +    @Override</span>
  40      public boolean onKey(View v, int keyCode, KeyEvent event) {
  41          return FocusHelper.handleIconKeyEvent(v, keyCode, event);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 - * A keyboard listener we set on all the workspace icons.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -class FolderKeyEventListener implements View.OnKeyListener {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -    public boolean onKey(View v, int keyCode, KeyEvent event) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -        return FocusHelper.handleFolderKeyEvent(v, keyCode, event);</span>
  51      }
  52  }
  53  
  54  /**
  55   * A keyboard listener we set on all the hotseat buttons.
  56   */
  57  class HotseatIconKeyEventListener implements View.OnKeyListener {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  58 +    @Override</span>
  59      public boolean onKey(View v, int keyCode, KeyEvent event) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -        final Configuration configuration = v.getResources().getConfiguration();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -        return FocusHelper.handleHotseatButtonKeyEvent(v, keyCode, event, configuration.orientation);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  62 +        return FocusHelper.handleHotseatButtonKeyEvent(v, keyCode, event);</span>
  63      }
  64  }
  65  
  66  public class FocusHelper {
  67  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +    private static final String TAG = &quot;FocusHelper&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    private static final boolean DEBUG = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +</span>
  71      /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -     * Returns the Viewgroup containing page contents for the page at the index specified.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +     * Handles key events in paged folder.</span>
  74       */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -    private static ViewGroup getAppsCustomizePage(ViewGroup container, int index) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -        ViewGroup page = (ViewGroup) ((PagedView) container).getPageAt(index);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -        if (page instanceof CellLayout) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -            // There are two layers, a PagedViewCellLayout and PagedViewCellLayoutChildren</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -            page = ((CellLayout) page).getShortcutsAndWidgets();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -        return page;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +    public static class PagedFolderKeyEventListener implements View.OnKeyListener {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  84 +        private final Folder mFolder;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +        public PagedFolderKeyEventListener(Folder folder) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +            mFolder = folder;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  89 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  90 +        @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  91 +        public boolean onKey(View v, int keyCode, KeyEvent e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +            boolean consume = FocusLogic.shouldConsume(keyCode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  93 +            if (e.getAction() == KeyEvent.ACTION_UP) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +                return consume;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +            if (DEBUG) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +                Log.v(TAG, String.format(&quot;Handle ALL Folders keyevent=[%s].&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +                        KeyEvent.keyCodeToString(keyCode)));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +            if (!(v.getParent() instanceof ShortcutAndWidgetContainer)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +                if (LauncherAppState.isDogfoodBuild()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +                    throw new IllegalStateException(&quot;Parent of the focused item is not supported.&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +                } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +                    return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +            // Initialize variables.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +            final ShortcutAndWidgetContainer itemContainer = (ShortcutAndWidgetContainer) v.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +            final CellLayout cellLayout = (CellLayout) itemContainer.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +            final int countX = cellLayout.getCountX();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +            final int countY = cellLayout.getCountY();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +            final int iconIndex = itemContainer.indexOfChild(v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +            final FolderPagedView pagedView = (FolderPagedView) cellLayout.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +            final int pageIndex = pagedView.indexOfChild(cellLayout);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +            final int pageCount = pagedView.getPageCount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +            final boolean isLayoutRtl = Utilities.isRtl(v.getResources());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +            int[][] matrix = FocusLogic.createSparseMatrix(cellLayout);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +            // Process focus.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +            int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +                    countY, matrix, iconIndex, pageIndex, pageCount, isLayoutRtl);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +            if (newIconIndex == FocusLogic.NOOP) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +                handleNoopKey(keyCode, v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +                return consume;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +            ShortcutAndWidgetContainer newParent = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +            View child = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +            switch (newIconIndex) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +                case FocusLogic.PREVIOUS_PAGE_RIGHT_COLUMN:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +                case FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +                    newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +                    if (newParent != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +                        int row = ((CellLayout.LayoutParams) v.getLayoutParams()).cellY;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +                        pagedView.snapToPage(pageIndex - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +                        child = newParent.getChildAt(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +                                ((newIconIndex == FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +                                    ^ newParent.invertLayoutHorizontally()) ? 0 : countX - 1, row);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +                case FocusLogic.PREVIOUS_PAGE_FIRST_ITEM:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +                    newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +                    if (newParent != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +                        pagedView.snapToPage(pageIndex - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +                        child = newParent.getChildAt(0, 0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +                case FocusLogic.PREVIOUS_PAGE_LAST_ITEM:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +                    newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +                    if (newParent != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +                        pagedView.snapToPage(pageIndex - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +                        child = newParent.getChildAt(countX - 1, countY - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +                case FocusLogic.NEXT_PAGE_FIRST_ITEM:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                    newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex + 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +                    if (newParent != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +                        pagedView.snapToPage(pageIndex + 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +                        child = newParent.getChildAt(0, 0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 165 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 166 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +                case FocusLogic.NEXT_PAGE_LEFT_COLUMN:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 168 +                case FocusLogic.NEXT_PAGE_RIGHT_COLUMN:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 169 +                    newParent = getCellLayoutChildrenForIndex(pagedView, pageIndex + 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +                    if (newParent != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +                        pagedView.snapToPage(pageIndex + 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 172 +                        child = FocusLogic.getAdjacentChildInNextPage(newParent, v, newIconIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 173 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 174 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 175 +                case FocusLogic.CURRENT_PAGE_FIRST_ITEM:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +                    child = cellLayout.getChildAt(0, 0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 178 +                case FocusLogic.CURRENT_PAGE_LAST_ITEM:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 179 +                    child = pagedView.getLastItem();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 180 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +                default: // Go to some item on the current page.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 182 +                    child = itemContainer.getChildAt(newIconIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 183 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 185 +            if (child != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 186 +                child.requestFocus();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 187 +                playSoundEffect(keyCode, v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 188 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 189 +                handleNoopKey(keyCode, v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 190 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 191 +            return consume;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 192 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 193 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 194 +        public void handleNoopKey(int keyCode, View v) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +            if (keyCode == KeyEvent.KEYCODE_DPAD_DOWN) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 196 +                mFolder.mFolderName.requestFocus();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 197 +                playSoundEffect(keyCode, v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 198 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 199 +        }</span>
 200      }
 201  
 202      /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -     * Handles key events in a PageViewCellLayout containing PagedViewIcons.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +     * Handles key events in the workspace hot seat (bottom of the screen).</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +     * &lt;p&gt;Currently we don&#x27;t special case for the phone UI in different orientations, even though</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +     * the hotseat is on the side in landscape mode. This is to ensure that accessibility</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +     * consistency is maintained across rotations.</span>
 208       */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -    static boolean handleAppsCustomizeKeyEvent(View v, int keyCode, KeyEvent e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -        ViewGroup parentLayout;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -        ViewGroup itemContainer;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -        int countX;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -        int countY;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -        if (v.getParent() instanceof ShortcutAndWidgetContainer) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -            itemContainer = (ViewGroup) v.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -            parentLayout = (ViewGroup) itemContainer.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -            countX = ((CellLayout) parentLayout).getCountX();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -            countY = ((CellLayout) parentLayout).getCountY();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +    static boolean handleHotseatButtonKeyEvent(View v, int keyCode, KeyEvent e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +        boolean consume = FocusLogic.shouldConsume(keyCode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 221 +        if (e.getAction() == KeyEvent.ACTION_UP || !consume) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 222 +            return consume;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 223 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 224 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 225 +        DeviceProfile profile = ((Launcher) v.getContext()).getDeviceProfile();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 226 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 227 +        if (DEBUG) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 228 +            Log.v(TAG, String.format(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 229 +                    &quot;Handle HOTSEAT BUTTONS keyevent=[%s] on hotseat buttons, isVertical=%s&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +                    KeyEvent.keyCodeToString(keyCode), profile.isVerticalBarLayout()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 231 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 232 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 233 +        // Initialize the variables.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 234 +        final ShortcutAndWidgetContainer hotseatParent = (ShortcutAndWidgetContainer) v.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 235 +        final CellLayout hotseatLayout = (CellLayout) hotseatParent.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 236 +        Hotseat hotseat = (Hotseat) hotseatLayout.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 237 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 238 +        Workspace workspace = (Workspace) v.getRootView().findViewById(R.id.workspace);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 239 +        int pageIndex = workspace.getNextPage();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 240 +        int pageCount = workspace.getChildCount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 241 +        int countX = -1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 242 +        int countY = -1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 243 +        int iconIndex = hotseatParent.indexOfChild(v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 244 +        int iconRank = ((CellLayout.LayoutParams) hotseatLayout.getShortcutsAndWidgets()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 245 +                .getChildAt(iconIndex).getLayoutParams()).cellX;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 246 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 247 +        final CellLayout iconLayout = (CellLayout) workspace.getChildAt(pageIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 248 +        if (iconLayout == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 249 +            // This check is to guard against cases where key strokes rushes in when workspace</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 250 +            // child creation/deletion is still in flux. (e.g., during drop or fling</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 251 +            // animation.)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +            return consume;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 253 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 254 +        final ViewGroup iconParent = iconLayout.getShortcutsAndWidgets();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 256 +        ViewGroup parent = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 257 +        int[][] matrix = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 258 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 259 +        if (keyCode == KeyEvent.KEYCODE_DPAD_UP &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 260 +                !profile.isVerticalBarLayout()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 261 +            matrix = FocusLogic.createSparseMatrix(iconLayout, hotseatLayout,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 262 +                    true /* hotseat horizontal */, hotseat.getAllAppsButtonRank(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 263 +                    iconRank == hotseat.getAllAppsButtonRank() /* include all apps icon */);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 264 +            iconIndex += iconParent.getChildCount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 265 +            countX = iconLayout.getCountX();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 266 +            countY = iconLayout.getCountY() + hotseatLayout.getCountY();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 267 +            parent = iconParent;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 268 +        } else if (keyCode == KeyEvent.KEYCODE_DPAD_LEFT &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 269 +                profile.isVerticalBarLayout()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 270 +            matrix = FocusLogic.createSparseMatrix(iconLayout, hotseatLayout,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 271 +                    false /* hotseat horizontal */, hotseat.getAllAppsButtonRank(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 272 +                    iconRank == hotseat.getAllAppsButtonRank() /* include all apps icon */);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 273 +            iconIndex += iconParent.getChildCount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +            countX = iconLayout.getCountX() + hotseatLayout.getCountX();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 275 +            countY = iconLayout.getCountY();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +            parent = iconParent;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 277 +        } else if (keyCode == KeyEvent.KEYCODE_DPAD_RIGHT &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 278 +                profile.isVerticalBarLayout()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 279 +            keyCode = KeyEvent.KEYCODE_PAGE_DOWN;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 280 +        }else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 281 +            // For other KEYCODE_DPAD_LEFT and KEYCODE_DPAD_RIGHT navigation, do not use the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 282 +            // matrix extended with hotseat.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 283 +            matrix = FocusLogic.createSparseMatrix(hotseatLayout);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 284 +            countX = hotseatLayout.getCountX();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 285 +            countY = hotseatLayout.getCountY();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 286 +            parent = hotseatParent;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +        // Process the focus.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +        int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +                countY, matrix, iconIndex, pageIndex, pageCount, Utilities.isRtl(v.getResources()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 293 +        View newIcon = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 294 +        if (newIconIndex == FocusLogic.NEXT_PAGE_FIRST_ITEM) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 295 +            parent = getCellLayoutChildrenForIndex(workspace, pageIndex + 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 296 +            newIcon = parent.getChildAt(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +            // TODO(hyunyoungs): handle cases where the child is not an icon but</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +            // a folder or a widget.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +            workspace.snapToPage(pageIndex + 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +        if (parent == iconParent &amp;&amp; newIconIndex &gt;= iconParent.getChildCount()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +            newIconIndex -= iconParent.getChildCount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +        if (parent != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +            if (newIcon == null &amp;&amp; newIconIndex &gt;=0) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +                newIcon = parent.getChildAt(newIconIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +            if (newIcon != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +                newIcon.requestFocus();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +                playSoundEffect(keyCode, v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 313 +        return consume;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 314 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 315 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 316 +    /**</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 317 +     * Handles key events in a workspace containing icons.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 318 +     */</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 319 +    static boolean handleIconKeyEvent(View v, int keyCode, KeyEvent e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 320 +        boolean consume = FocusLogic.shouldConsume(keyCode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 321 +        if (e.getAction() == KeyEvent.ACTION_UP || !consume) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 322 +            return consume;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +        Launcher launcher = (Launcher) v.getContext();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +        DeviceProfile profile = launcher.getDeviceProfile();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +        if (DEBUG) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +            Log.v(TAG, String.format(&quot;Handle WORKSPACE ICONS keyevent=[%s] isVerticalBar=%s&quot;,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +                    KeyEvent.keyCodeToString(keyCode), profile.isVerticalBarLayout()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +        // Initialize the variables.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +        ShortcutAndWidgetContainer parent = (ShortcutAndWidgetContainer) v.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +        CellLayout iconLayout = (CellLayout) parent.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +        final Workspace workspace = (Workspace) iconLayout.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +        final ViewGroup dragLayer = (ViewGroup) workspace.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +        final ViewGroup tabs = (ViewGroup) dragLayer.findViewById(R.id.search_drop_target_bar);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +        final Hotseat hotseat = (Hotseat) dragLayer.findViewById(R.id.hotseat);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +        final int iconIndex = parent.indexOfChild(v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +        final int pageIndex = workspace.indexOfChild(iconLayout);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +        final int pageCount = workspace.getChildCount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +        int countX = iconLayout.getCountX();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +        int countY = iconLayout.getCountY();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +        CellLayout hotseatLayout = (CellLayout) hotseat.getChildAt(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +        ShortcutAndWidgetContainer hotseatParent = hotseatLayout.getShortcutsAndWidgets();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +        int[][] matrix;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +        // KEYCODE_DPAD_DOWN in portrait (KEYCODE_DPAD_RIGHT in landscape) is the only key allowed</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +        // to take a user to the hotseat. For other dpad navigation, do not use the matrix extended</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +        // with the hotseat.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +        if (keyCode == KeyEvent.KEYCODE_DPAD_DOWN &amp;&amp; !profile.isVerticalBarLayout()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +            matrix = FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, true /* horizontal */,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +                    hotseat.getAllAppsButtonRank(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +                    !hotseat.hasIcons() /* ignore all apps icon, unless there are no other icons */);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +            countY = countY + 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +        } else if (keyCode == KeyEvent.KEYCODE_DPAD_RIGHT &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +                profile.isVerticalBarLayout()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +            matrix = FocusLogic.createSparseMatrix(iconLayout, hotseatLayout, false /* horizontal */,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +                    hotseat.getAllAppsButtonRank(),</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +                    !hotseat.hasIcons() /* ignore all apps icon, unless there are no other icons */);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +            countX = countX + 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +        } else if (keyCode == KeyEvent.KEYCODE_DEL || keyCode == KeyEvent.KEYCODE_FORWARD_DEL) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +            workspace.removeWorkspaceItem(v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +            return consume;</span>
 368          } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -            itemContainer = parentLayout = (ViewGroup) v.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -            countX = ((PagedViewGridLayout) parentLayout).getCellCountX();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 371 -            countY = ((PagedViewGridLayout) parentLayout).getCellCountY();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 372 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 373 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 374 -        // Note we have an extra parent because of the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -        // PagedViewCellLayout/PagedViewCellLayoutChildren relationship</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -        final PagedView container = (PagedView) parentLayout.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -        final int iconIndex = itemContainer.indexOfChild(v);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -        final int itemCount = itemContainer.getChildCount();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 379 -        final int pageIndex = ((PagedView) container).indexToPage(container.indexOfChild(parentLayout));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 380 -        final int pageCount = container.getChildCount();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 381 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 382 -        final int x = iconIndex % countX;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 383 -        final int y = iconIndex / countX;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 384 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 385 -        final int action = e.getAction();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 386 -        final boolean handleKeyEvent = (action != KeyEvent.ACTION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 387 -        ViewGroup newParent = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 388 -        // Side pages do not always load synchronously, so check before focusing child siblings</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 389 -        // willy-nilly</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 390 -        View child = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 391 -        boolean wasHandled = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 392 -        switch (keyCode) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 393 -            case KeyEvent.KEYCODE_DPAD_LEFT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -                    // Select the previous icon or the last icon on the previous page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -                    if (iconIndex &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -                        itemContainer.getChildAt(iconIndex - 1).requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -                        if (pageIndex &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -                            newParent = getAppsCustomizePage(container, pageIndex - 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -                            if (newParent != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -                                container.snapToPage(pageIndex - 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -                                child = newParent.getChildAt(newParent.getChildCount() - 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -                                if (child != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -                                    child.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -                                    v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -                                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -            case KeyEvent.KEYCODE_DPAD_RIGHT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 417 -                    // Select the next icon or the first icon on the next page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 418 -                    if (iconIndex &lt; (itemCount - 1)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -                        itemContainer.getChildAt(iconIndex + 1).requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 420 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 421 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 422 -                        if (pageIndex &lt; (pageCount - 1)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 423 -                            newParent = getAppsCustomizePage(container, pageIndex + 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 424 -                            if (newParent != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 425 -                                container.snapToPage(pageIndex + 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 426 -                                child = newParent.getChildAt(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 427 -                                if (child != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 428 -                                    child.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 429 -                                    v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 430 -                                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 431 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 432 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 433 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 434 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 435 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 436 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 437 -            case KeyEvent.KEYCODE_DPAD_UP:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 438 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 439 -                    // Select the closest icon in the previous row, otherwise select the tab bar</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 440 -                    if (y &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 441 -                        int newiconIndex = ((y - 1) * countX) + x;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 442 -                        itemContainer.getChildAt(newiconIndex).requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 444 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 445 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 446 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 447 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 448 -            case KeyEvent.KEYCODE_DPAD_DOWN:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 449 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 450 -                    // Select the closest icon in the next row, otherwise do nothing</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 451 -                    if (y &lt; (countY - 1)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 452 -                        int newiconIndex = Math.min(itemCount - 1, ((y + 1) * countX) + x);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 453 -                        int newIconY = newiconIndex / countX;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 454 -                        if (newIconY != y) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 455 -                            itemContainer.getChildAt(newiconIndex).requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 456 -                            v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 457 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 458 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 459 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 460 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 461 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 462 -            case KeyEvent.KEYCODE_PAGE_UP:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 463 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 464 -                    // Select the first icon on the previous page, or the first icon on this page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 465 -                    // if there is no previous page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 466 -                    if (pageIndex &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 467 -                        newParent = getAppsCustomizePage(container, pageIndex - 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 468 -                        if (newParent != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 469 -                            container.snapToPage(pageIndex - 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 470 -                            child = newParent.getChildAt(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 471 -                            if (child != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 472 -                                child.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 473 -                                v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 474 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 475 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 476 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 477 -                        itemContainer.getChildAt(0).requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 478 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 479 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 480 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 481 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 482 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 483 -            case KeyEvent.KEYCODE_PAGE_DOWN:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 484 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 485 -                    // Select the first icon on the next page, or the last icon on this page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 486 -                    // if there is no next page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 487 -                    if (pageIndex &lt; (pageCount - 1)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 488 -                        newParent = getAppsCustomizePage(container, pageIndex + 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 489 -                        if (newParent != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 490 -                            container.snapToPage(pageIndex + 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 491 -                            child = newParent.getChildAt(0);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 492 -                            if (child != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 493 -                                child.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 494 -                                v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 495 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 496 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 497 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 498 -                        itemContainer.getChildAt(itemCount - 1).requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 499 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 500 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 501 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 502 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 503 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 504 -            case KeyEvent.KEYCODE_MOVE_HOME:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 505 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 506 -                    // Select the first icon on this page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 507 -                    itemContainer.getChildAt(0).requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 508 -                    v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 509 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 510 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 511 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 512 -            case KeyEvent.KEYCODE_MOVE_END:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 513 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 514 -                    // Select the last icon on this page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 515 -                    itemContainer.getChildAt(itemCount - 1).requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 516 -                    v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 517 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 518 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 519 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 520 -            default: break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 521 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 522 -        return wasHandled;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 523 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 524 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 525 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 526 -     * Handles key events in the workspace hotseat (bottom of the screen).</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 527 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 528 -    static boolean handleHotseatButtonKeyEvent(View v, int keyCode, KeyEvent e, int orientation) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 529 -        ShortcutAndWidgetContainer parent = (ShortcutAndWidgetContainer) v.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 530 -        final CellLayout layout = (CellLayout) parent.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 531 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 532 -        // NOTE: currently we don&#x27;t special case for the phone UI in different</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 533 -        // orientations, even though the hotseat is on the side in landscape mode. This</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 534 -        // is to ensure that accessibility consistency is maintained across rotations.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 535 -        final int action = e.getAction();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 536 -        final boolean handleKeyEvent = (action != KeyEvent.ACTION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 537 -        boolean wasHandled = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 538 -        switch (keyCode) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 539 -            case KeyEvent.KEYCODE_DPAD_LEFT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 540 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 541 -                    ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 542 -                    int myIndex = views.indexOf(v);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 543 -                    // Select the previous button, otherwise do nothing</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 544 -                    if (myIndex &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 545 -                        views.get(myIndex - 1).requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 546 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 547 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 548 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 549 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 550 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 551 -            case KeyEvent.KEYCODE_DPAD_RIGHT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 552 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 553 -                    ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 554 -                    int myIndex = views.indexOf(v);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 555 -                    // Select the next button, otherwise do nothing</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 556 -                    if (myIndex &lt; views.size() - 1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 557 -                        views.get(myIndex + 1).requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 558 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 559 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 560 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 561 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 562 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 563 -            case KeyEvent.KEYCODE_DPAD_UP:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 564 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 565 -                    final Workspace workspace = (Workspace)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 566 -                            v.getRootView().findViewById(R.id.workspace);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 567 -                    if (workspace != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 568 -                        int pageIndex = workspace.getCurrentPage();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 569 -                        CellLayout topLayout = (CellLayout) workspace.getChildAt(pageIndex);</span>






<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 570 -                        ShortcutAndWidgetContainer children = topLayout.getShortcutsAndWidgets();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 571 -                        final View newIcon = getIconInDirection(layout, children, -1, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 572 -                        // Select the first bubble text view in the current page of the workspace</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 573 -                        if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 574 -                            newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 575 -                            v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 576 -                        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 577 -                            workspace.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 578 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 579 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 580 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 581 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 582 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 583 -            case KeyEvent.KEYCODE_DPAD_DOWN:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 584 -                // Do nothing</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 585 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 586 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 587 -            default: break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 588 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 589 -        return wasHandled;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 590 -    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 591 +            matrix = FocusLogic.createSparseMatrix(iconLayout);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 592 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 593 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 594 +        // Process the focus.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 595 +        int newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 596 +                countY, matrix, iconIndex, pageIndex, pageCount, Utilities.isRtl(v.getResources()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 597 +        View newIcon = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 598 +        switch (newIconIndex) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 599 +            case FocusLogic.NOOP:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 600 +                if (keyCode == KeyEvent.KEYCODE_DPAD_UP) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 601 +                    newIcon = tabs;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 602 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 603 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 604 +            case FocusLogic.PREVIOUS_PAGE_RIGHT_COLUMN:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 605 +            case FocusLogic.NEXT_PAGE_RIGHT_COLUMN:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 606 +                int newPageIndex = pageIndex - 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 607 +                if (newIconIndex == FocusLogic.NEXT_PAGE_RIGHT_COLUMN) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 608 +                    newPageIndex = pageIndex + 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 609 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 610 +                int row = ((CellLayout.LayoutParams) v.getLayoutParams()).cellY;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 611 +                parent = getCellLayoutChildrenForIndex(workspace, newPageIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 612 +                workspace.snapToPage(newPageIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 613 +                if (parent != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 614 +                    workspace.snapToPage(newPageIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 615 +                    iconLayout = (CellLayout) parent.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 616 +                    matrix = FocusLogic.createSparseMatrix(iconLayout,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 617 +                        iconLayout.getCountX(), row);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 618 +                    newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX + 1, countY,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 619 +                            matrix, FocusLogic.PIVOT, newPageIndex, pageCount,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 620 +                            Utilities.isRtl(v.getResources()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 621 +                    newIcon = parent.getChildAt(newIconIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 622 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 623 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 624 +            case FocusLogic.PREVIOUS_PAGE_FIRST_ITEM:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 625 +                parent = getCellLayoutChildrenForIndex(workspace, pageIndex - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 626 +                newIcon = parent.getChildAt(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 627 +                workspace.snapToPage(pageIndex - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 628 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 629 +            case FocusLogic.PREVIOUS_PAGE_LAST_ITEM:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 630 +                parent = getCellLayoutChildrenForIndex(workspace, pageIndex - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 631 +                newIcon = parent.getChildAt(parent.getChildCount() - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 632 +                workspace.snapToPage(pageIndex - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 633 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 634 +            case FocusLogic.NEXT_PAGE_FIRST_ITEM:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 635 +                parent = getCellLayoutChildrenForIndex(workspace, pageIndex + 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 636 +                newIcon = parent.getChildAt(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 637 +                workspace.snapToPage(pageIndex + 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 638 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 639 +            case FocusLogic.NEXT_PAGE_LEFT_COLUMN:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 640 +            case FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 641 +                newPageIndex = pageIndex + 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 642 +                if (newIconIndex == FocusLogic.PREVIOUS_PAGE_LEFT_COLUMN) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 643 +                    newPageIndex = pageIndex - 1;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 644 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 645 +                workspace.snapToPage(newPageIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 646 +                row = ((CellLayout.LayoutParams) v.getLayoutParams()).cellY;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 647 +                parent = getCellLayoutChildrenForIndex(workspace, newPageIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 648 +                if (parent != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 649 +                    workspace.snapToPage(newPageIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 650 +                    iconLayout = (CellLayout) parent.getParent();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 651 +                    matrix = FocusLogic.createSparseMatrix(iconLayout, -1, row);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 652 +                    newIconIndex = FocusLogic.handleKeyEvent(keyCode, countX + 1, countY,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 653 +                            matrix, FocusLogic.PIVOT, newPageIndex, pageCount,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 654 +                            Utilities.isRtl(v.getResources()));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 655 +                    newIcon = parent.getChildAt(newIconIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 656 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 657 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 658 +            case FocusLogic.CURRENT_PAGE_FIRST_ITEM:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 659 +                newIcon = parent.getChildAt(0);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 660 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 661 +            case FocusLogic.CURRENT_PAGE_LAST_ITEM:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 662 +                newIcon = parent.getChildAt(parent.getChildCount() - 1);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 663 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 664 +            default:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 665 +                // current page, some item.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 666 +                if (0 &lt;= newIconIndex &amp;&amp; newIconIndex &lt; parent.getChildCount()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 667 +                    newIcon = parent.getChildAt(newIconIndex);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 668 +                } else if (parent.getChildCount() &lt;= newIconIndex &amp;&amp;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 669 +                        newIconIndex &lt; parent.getChildCount() + hotseatParent.getChildCount()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 670 +                    newIcon = hotseatParent.getChildAt(newIconIndex - parent.getChildCount());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 671 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 672 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 673 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 674 +        if (newIcon != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 675 +            newIcon.requestFocus();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 676 +            playSoundEffect(keyCode, v);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 677 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 678 +        return consume;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 679 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 680 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 681 +    //</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 682 +    // Helper methods.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 683 +    //</span>
 684  
 685      /**
 686       * Private helper method to get the CellLayoutChildren given a CellLayout index.
 687       */
 688      private static ShortcutAndWidgetContainer getCellLayoutChildrenForIndex(
 689              ViewGroup container, int i) {
 690          CellLayout parent = (CellLayout) container.getChildAt(i);
 691          return parent.getShortcutsAndWidgets();
 692      }
 693  
 694      /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 695 -     * Private helper method to sort all the CellLayout children in order of their (x,y) spatially</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 696 -     * from top left to bottom right.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 697 +     * Helper method to be used for playing sound effects.</span>
 698       */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 699 -    private static ArrayList&lt;View&gt; getCellLayoutChildrenSortedSpatially(CellLayout layout,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 700 -            ViewGroup parent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 701 -        // First we order each the CellLayout children by their x,y coordinates</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 702 -        final int cellCountX = layout.getCountX();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 703 -        final int count = parent.getChildCount();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 704 -        ArrayList&lt;View&gt; views = new ArrayList&lt;View&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 705 -        for (int j = 0; j &lt; count; ++j) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 706 -            views.add(parent.getChildAt(j));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 707 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 708 -        Collections.sort(views, new Comparator&lt;View&gt;() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 709 -            @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 710 -            public int compare(View lhs, View rhs) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 711 -                CellLayout.LayoutParams llp = (CellLayout.LayoutParams) lhs.getLayoutParams();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 712 -                CellLayout.LayoutParams rlp = (CellLayout.LayoutParams) rhs.getLayoutParams();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 713 -                int lvIndex = (llp.cellY * cellCountX) + llp.cellX;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 714 -                int rvIndex = (rlp.cellY * cellCountX) + rlp.cellX;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 715 -                return lvIndex - rvIndex;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 716 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 717 -        });</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 718 -        return views;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 719 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 720 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 721 -     * Private helper method to find the index of the next BubbleTextView or FolderIcon in the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 722 -     * direction delta.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 723 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 724 -     * @param delta either -1 or 1 depending on the direction we want to search</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 725 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 726 -    private static View findIndexOfIcon(ArrayList&lt;View&gt; views, int i, int delta) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 727 -        // Then we find the next BubbleTextView offset by delta from i</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 728 -        final int count = views.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 729 -        int newI = i + delta;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 730 -        while (0 &lt;= newI &amp;&amp; newI &lt; count) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 731 -            View newV = views.get(newI);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 732 -            if (newV instanceof BubbleTextView || newV instanceof FolderIcon) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 733 -                return newV;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 734 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 735 -            newI += delta;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 736 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 737 -        return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 738 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 739 -    private static View getIconInDirection(CellLayout layout, ViewGroup parent, int i,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 740 -            int delta) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 741 -        final ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 742 -        return findIndexOfIcon(views, i, delta);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 743 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 744 -    private static View getIconInDirection(CellLayout layout, ViewGroup parent, View v,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 745 -            int delta) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 746 -        final ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 747 -        return findIndexOfIcon(views, views.indexOf(v), delta);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 748 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 749 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 750 -     * Private helper method to find the next closest BubbleTextView or FolderIcon in the direction</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 751 -     * delta on the next line.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 752 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 753 -     * @param delta either -1 or 1 depending on the line and direction we want to search</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 754 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 755 -    private static View getClosestIconOnLine(CellLayout layout, ViewGroup parent, View v,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 756 -            int lineDelta) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 757 -        final ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 758 -        final CellLayout.LayoutParams lp = (CellLayout.LayoutParams) v.getLayoutParams();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 759 -        final int cellCountY = layout.getCountY();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 760 -        final int row = lp.cellY;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 761 -        final int newRow = row + lineDelta;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 762 -        if (0 &lt;= newRow &amp;&amp; newRow &lt; cellCountY) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 763 -            float closestDistance = Float.MAX_VALUE;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 764 -            int closestIndex = -1;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 765 -            int index = views.indexOf(v);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 766 -            int endIndex = (lineDelta &lt; 0) ? -1 : views.size();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 767 -            while (index != endIndex) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 768 -                View newV = views.get(index);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 769 -                CellLayout.LayoutParams tmpLp = (CellLayout.LayoutParams) newV.getLayoutParams();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 770 -                boolean satisfiesRow = (lineDelta &lt; 0) ? (tmpLp.cellY &lt; row) : (tmpLp.cellY &gt; row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 771 -                if (satisfiesRow &amp;&amp;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 772 -                        (newV instanceof BubbleTextView || newV instanceof FolderIcon)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 773 -                    float tmpDistance = (float) Math.sqrt(Math.pow(tmpLp.cellX - lp.cellX, 2) +</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 774 -                            Math.pow(tmpLp.cellY - lp.cellY, 2));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 775 -                    if (tmpDistance &lt; closestDistance) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 776 -                        closestIndex = index;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 777 -                        closestDistance = tmpDistance;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 778 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 779 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 780 -                if (index &lt;= endIndex) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 781 -                    ++index;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 782 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 783 -                    --index;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 784 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 785 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 786 -            if (closestIndex &gt; -1) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 787 -                return views.get(closestIndex);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 788 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 789 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 790 -        return null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 791 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 792 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 793 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 794 -     * Handles key events in a Workspace containing.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 795 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 796 -    static boolean handleIconKeyEvent(View v, int keyCode, KeyEvent e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 797 -        ShortcutAndWidgetContainer parent = (ShortcutAndWidgetContainer) v.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 798 -        final CellLayout layout = (CellLayout) parent.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 799 -        final Workspace workspace = (Workspace) layout.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 800 -        final ViewGroup launcher = (ViewGroup) workspace.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 801 -        final ViewGroup tabs = (ViewGroup) launcher.findViewById(R.id.search_drop_target_bar);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 802 -        final ViewGroup hotseat = (ViewGroup) launcher.findViewById(R.id.hotseat);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 803 -        int pageIndex = workspace.indexOfChild(layout);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 804 -        int pageCount = workspace.getChildCount();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 805 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 806 -        final int action = e.getAction();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 807 -        final boolean handleKeyEvent = (action != KeyEvent.ACTION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 808 -        boolean wasHandled = false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 809 +    @Thunk static void playSoundEffect(int keyCode, View v) {</span>
 810          switch (keyCode) {
 811              case KeyEvent.KEYCODE_DPAD_LEFT:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 812 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 813 -                    // Select the previous icon or the last icon on the previous page if possible</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 814 -                    View newIcon = getIconInDirection(layout, parent, v, -1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 815 -                    if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 816 -                        newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 817 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 818 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 819 -                        if (pageIndex &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 820 -                            parent = getCellLayoutChildrenForIndex(workspace, pageIndex - 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 821 -                            newIcon = getIconInDirection(layout, parent,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 822 -                                    parent.getChildCount(), -1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 823 -                            if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 824 -                                newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 825 -                            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 826 -                                // Snap to the previous page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 827 -                                workspace.snapToPage(pageIndex - 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 828 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 829 -                            v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 830 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 831 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 832 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 833 -                wasHandled = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 834 +                v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);</span>
 835                  break;
 836              case KeyEvent.KEYCODE_DPAD_RIGHT:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 837 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 838 -                    // Select the next icon or the first icon on the next page if possible</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 839 -                    View newIcon = getIconInDirection(layout, parent, v, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 840 -                    if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 841 -                        newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 842 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 843 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 844 -                        if (pageIndex &lt; (pageCount - 1)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 845 -                            parent = getCellLayoutChildrenForIndex(workspace, pageIndex + 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 846 -                            newIcon = getIconInDirection(layout, parent, -1, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 847 -                            if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 848 -                                newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 849 -                            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 850 -                                // Snap to the next page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 851 -                                workspace.snapToPage(pageIndex + 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 852 -                            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 853 -                            v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 854 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 855 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 856 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 857 -                wasHandled = true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 858 +                v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 859 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 860 +            case KeyEvent.KEYCODE_DPAD_DOWN:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 861 +            case KeyEvent.KEYCODE_PAGE_DOWN:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 862 +            case KeyEvent.KEYCODE_MOVE_END:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 863 +                v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);</span>
 864                  break;
 865              case KeyEvent.KEYCODE_DPAD_UP:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 866 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 867 -                    // Select the closest icon in the previous line, otherwise select the tab bar</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 868 -                    View newIcon = getClosestIconOnLine(layout, parent, v, -1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 869 -                    if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 870 -                        newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 871 -                        wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 872 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 873 -                        tabs.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 874 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 875 -                    v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 876 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 877 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 878 -            case KeyEvent.KEYCODE_DPAD_DOWN:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 879 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 880 -                    // Select the closest icon in the next line, otherwise select the button bar</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 881 -                    View newIcon = getClosestIconOnLine(layout, parent, v, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 882 -                    if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 883 -                        newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 884 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 885 -                        wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 886 -                    } else if (hotseat != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 887 -                        hotseat.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 888 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 889 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 890 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 891 -                break;</span>
 892              case KeyEvent.KEYCODE_PAGE_UP:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 893 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 894 -                    // Select the first icon on the previous page or the first icon on this page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 895 -                    // if there is no previous page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 896 -                    if (pageIndex &gt; 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 897 -                        parent = getCellLayoutChildrenForIndex(workspace, pageIndex - 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 898 -                        View newIcon = getIconInDirection(layout, parent, -1, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 899 -                        if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 900 -                            newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 901 -                        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 902 -                            // Snap to the previous page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 903 -                            workspace.snapToPage(pageIndex - 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 904 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 905 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 906 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 907 -                        View newIcon = getIconInDirection(layout, parent, -1, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 908 -                        if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 909 -                            newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 910 -                            v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 911 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 912 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 913 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 914 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 915 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 916 -            case KeyEvent.KEYCODE_PAGE_DOWN:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 917 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 918 -                    // Select the first icon on the next page or the last icon on this page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 919 -                    // if there is no previous page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 920 -                    if (pageIndex &lt; (pageCount - 1)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 921 -                        parent = getCellLayoutChildrenForIndex(workspace, pageIndex + 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 922 -                        View newIcon = getIconInDirection(layout, parent, -1, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 923 -                        if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 924 -                            newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 925 -                        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 926 -                            // Snap to the next page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 927 -                            workspace.snapToPage(pageIndex + 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 928 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 929 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 930 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 931 -                        View newIcon = getIconInDirection(layout, parent,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 932 -                                parent.getChildCount(), -1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 933 -                        if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 934 -                            newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 935 -                            v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 936 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 937 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 938 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 939 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 940 -                break;</span>
 941              case KeyEvent.KEYCODE_MOVE_HOME:
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 942 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 943 -                    // Select the first icon on this page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 944 -                    View newIcon = getIconInDirection(layout, parent, -1, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 945 -                    if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 946 -                        newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 947 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 948 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 949 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 950 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 951 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 952 -            case KeyEvent.KEYCODE_MOVE_END:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 953 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 954 -                    // Select the last icon on this page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 955 -                    View newIcon = getIconInDirection(layout, parent,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 956 -                            parent.getChildCount(), -1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 957 -                    if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 958 -                        newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 959 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 960 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 961 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 962 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 963 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 964 -            default: break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 965 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 966 -        return wasHandled;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 967 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 968 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 969 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 970 -     * Handles key events for items in a Folder.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 971 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 972 -    static boolean handleFolderKeyEvent(View v, int keyCode, KeyEvent e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 973 -        ShortcutAndWidgetContainer parent = (ShortcutAndWidgetContainer) v.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 974 -        final CellLayout layout = (CellLayout) parent.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 975 -        final ScrollView scrollView = (ScrollView) layout.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 976 -        final Folder folder = (Folder) scrollView.getParent();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 977 -        View title = folder.mFolderName;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 978 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 979 -        final int action = e.getAction();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 980 -        final boolean handleKeyEvent = (action != KeyEvent.ACTION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 981 -        boolean wasHandled = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 982 -        switch (keyCode) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 983 -            case KeyEvent.KEYCODE_DPAD_LEFT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 984 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 985 -                    // Select the previous icon</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 986 -                    View newIcon = getIconInDirection(layout, parent, v, -1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 987 -                    if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 988 -                        newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 989 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 990 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 991 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 992 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 993 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 994 -            case KeyEvent.KEYCODE_DPAD_RIGHT:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 995 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 996 -                    // Select the next icon</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 997 -                    View newIcon = getIconInDirection(layout, parent, v, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 998 -                    if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 999 -                        newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1000 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1001 -                        title.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1002 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1003 -                    v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1004 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1005 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1006 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1007 -            case KeyEvent.KEYCODE_DPAD_UP:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1008 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1009 -                    // Select the closest icon in the previous line</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1010 -                    View newIcon = getClosestIconOnLine(layout, parent, v, -1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1011 -                    if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1012 -                        newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1013 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1014 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1015 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1016 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1017 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1018 -            case KeyEvent.KEYCODE_DPAD_DOWN:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1019 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1020 -                    // Select the closest icon in the next line</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1021 -                    View newIcon = getClosestIconOnLine(layout, parent, v, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1022 -                    if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1023 -                        newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1024 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1025 -                        title.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1026 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1027 -                    v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1028 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1029 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1030 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1031 -            case KeyEvent.KEYCODE_MOVE_HOME:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1032 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1033 -                    // Select the first icon on this page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1034 -                    View newIcon = getIconInDirection(layout, parent, -1, 1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1035 -                    if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1036 -                        newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1037 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1038 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1039 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1040 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1041 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1042 -            case KeyEvent.KEYCODE_MOVE_END:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1043 -                if (handleKeyEvent) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1044 -                    // Select the last icon on this page</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1045 -                    View newIcon = getIconInDirection(layout, parent,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1046 -                            parent.getChildCount(), -1);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1047 -                    if (newIcon != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1048 -                        newIcon.requestFocus();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1049 -                        v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1050 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1051 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1052 -                wasHandled = true;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1053 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1054 -            default: break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1055 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1056 -        return wasHandled;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1057 +                v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1058 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1059 +            default:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1060 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1061 +        }</span>
1062      }
1063  }</pre></td>
                            <td><pre>   1  /*
   2   * Copyright (C) 2011 The Android Open Source Project

   3   *
   4   * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   5   * you may not use this file except in compliance with the License.
   6   * You may obtain a copy of the License at
   7   *
   8   *      http://www.apache.org/licenses/LICENSE-2.0
   9   *
  10   * Unless required by applicable law or agreed to in writing, software
  11   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  12   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  13   * See the License for the specific language governing permissions and
  14   * limitations under the License.
  15   */
  16  
  17  package com.android.launcher3;
  18  
  19  import android.content.res.Configuration;

  20  import android.view.KeyEvent;
  21  import android.view.SoundEffectConstants;
  22  import android.view.View;
  23  import android.view.ViewGroup;
  24  import android.widget.ScrollView;
  25  
  26  import java.util.ArrayList;
  27  import java.util.Collections;
  28  import java.util.Comparator;



  29  
  30  /**
  31   * A keyboard listener we set on all the workspace icons.
  32   */
  33  class IconKeyEventListener implements View.OnKeyListener {

  34      public boolean onKey(View v, int keyCode, KeyEvent event) {
  35          return FocusHelper.handleIconKeyEvent(v, keyCode, event);
  36      }
  37  }
  38  
  39  /**
  40   * A keyboard listener we set on all the workspace icons.
  41   */
  42  class FolderKeyEventListener implements View.OnKeyListener {
  43      public boolean onKey(View v, int keyCode, KeyEvent event) {
  44          return FocusHelper.handleFolderKeyEvent(v, keyCode, event);
  45      }
  46  }
  47  
  48  /**
  49   * A keyboard listener we set on all the hotseat buttons.
  50   */
  51  class HotseatIconKeyEventListener implements View.OnKeyListener {

  52      public boolean onKey(View v, int keyCode, KeyEvent event) {
  53          final Configuration configuration = v.getResources().getConfiguration();
  54          return FocusHelper.handleHotseatButtonKeyEvent(v, keyCode, event, configuration.orientation);

  55      }
  56  }
  57  
  58  public class FocusHelper {
  59  



  60      /**
  61       * Returns the Viewgroup containing page contents for the page at the index specified.

  62       */
  63      private static ViewGroup getAppsCustomizePage(ViewGroup container, int index) {
  64          ViewGroup page = (ViewGroup) ((PagedView) container).getPageAt(index);
  65          if (page instanceof CellLayout) {
  66              // There are two layers, a PagedViewCellLayout and PagedViewCellLayoutChildren
  67              page = ((CellLayout) page).getShortcutsAndWidgets();
  68          }
  69          return page;






















































































































  70      }
  71  
  72      /**
  73       * Handles key events in a PageViewCellLayout containing PagedViewIcons.




  74       */
  75      static boolean handleAppsCustomizeKeyEvent(View v, int keyCode, KeyEvent e) {
  76          ViewGroup parentLayout;
  77          ViewGroup itemContainer;
  78          int countX;
  79          int countY;
  80          if (v.getParent() instanceof ShortcutAndWidgetContainer) {
  81              itemContainer = (ViewGroup) v.getParent();
  82              parentLayout = (ViewGroup) itemContainer.getParent();
  83              countX = ((CellLayout) parentLayout).getCountX();
  84              countY = ((CellLayout) parentLayout).getCountY();





















































































































































  85          } else {
  86              itemContainer = parentLayout = (ViewGroup) v.getParent();
  87              countX = ((PagedViewGridLayout) parentLayout).getCellCountX();
  88              countY = ((PagedViewGridLayout) parentLayout).getCellCountY();
  89          }
  90  
  91          // Note we have an extra parent because of the
  92          // PagedViewCellLayout/PagedViewCellLayoutChildren relationship
  93          final PagedView container = (PagedView) parentLayout.getParent();
  94          final int iconIndex = itemContainer.indexOfChild(v);
  95          final int itemCount = itemContainer.getChildCount();
  96          final int pageIndex = ((PagedView) container).indexToPage(container.indexOfChild(parentLayout));
  97          final int pageCount = container.getChildCount();
  98  
  99          final int x = iconIndex % countX;
 100          final int y = iconIndex / countX;
 101  
 102          final int action = e.getAction();
 103          final boolean handleKeyEvent = (action != KeyEvent.ACTION_UP);
 104          ViewGroup newParent = null;
 105          // Side pages do not always load synchronously, so check before focusing child siblings
 106          // willy-nilly
 107          View child = null;
 108          boolean wasHandled = false;
 109          switch (keyCode) {
 110              case KeyEvent.KEYCODE_DPAD_LEFT:
 111                  if (handleKeyEvent) {
 112                      // Select the previous icon or the last icon on the previous page
 113                      if (iconIndex &gt; 0) {
 114                          itemContainer.getChildAt(iconIndex - 1).requestFocus();
 115                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);
 116                      } else {
 117                          if (pageIndex &gt; 0) {
 118                              newParent = getAppsCustomizePage(container, pageIndex - 1);
 119                              if (newParent != null) {
 120                                  container.snapToPage(pageIndex - 1);
 121                                  child = newParent.getChildAt(newParent.getChildCount() - 1);
 122                                  if (child != null) {
 123                                      child.requestFocus();
 124                                      v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);
 125                                  }
 126                              }
 127                          }
 128                      }
 129                  }
 130                  wasHandled = true;
 131                  break;
 132              case KeyEvent.KEYCODE_DPAD_RIGHT:
 133                  if (handleKeyEvent) {
 134                      // Select the next icon or the first icon on the next page
 135                      if (iconIndex &lt; (itemCount - 1)) {
 136                          itemContainer.getChildAt(iconIndex + 1).requestFocus();
 137                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);
 138                      } else {
 139                          if (pageIndex &lt; (pageCount - 1)) {
 140                              newParent = getAppsCustomizePage(container, pageIndex + 1);
 141                              if (newParent != null) {
 142                                  container.snapToPage(pageIndex + 1);
 143                                  child = newParent.getChildAt(0);
 144                                  if (child != null) {
 145                                      child.requestFocus();
 146                                      v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);
 147                                  }
 148                              }
 149                          }
 150                      }
 151                  }
 152                  wasHandled = true;
 153                  break;
 154              case KeyEvent.KEYCODE_DPAD_UP:
 155                  if (handleKeyEvent) {
 156                      // Select the closest icon in the previous row, otherwise select the tab bar
 157                      if (y &gt; 0) {
 158                          int newiconIndex = ((y - 1) * countX) + x;
 159                          itemContainer.getChildAt(newiconIndex).requestFocus();
 160                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 161                      }
 162                  }
 163                  wasHandled = true;
 164                  break;
 165              case KeyEvent.KEYCODE_DPAD_DOWN:
 166                  if (handleKeyEvent) {
 167                      // Select the closest icon in the next row, otherwise do nothing
 168                      if (y &lt; (countY - 1)) {
 169                          int newiconIndex = Math.min(itemCount - 1, ((y + 1) * countX) + x);
 170                          int newIconY = newiconIndex / countX;
 171                          if (newIconY != y) {
 172                              itemContainer.getChildAt(newiconIndex).requestFocus();
 173                              v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 174                          }
 175                      }
 176                  }
 177                  wasHandled = true;
 178                  break;
 179              case KeyEvent.KEYCODE_PAGE_UP:
 180                  if (handleKeyEvent) {
 181                      // Select the first icon on the previous page, or the first icon on this page
 182                      // if there is no previous page
 183                      if (pageIndex &gt; 0) {
 184                          newParent = getAppsCustomizePage(container, pageIndex - 1);
 185                          if (newParent != null) {
 186                              container.snapToPage(pageIndex - 1);
 187                              child = newParent.getChildAt(0);
 188                              if (child != null) {
 189                                  child.requestFocus();
 190                                  v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 191                              }
 192                          }
 193                      } else {
 194                          itemContainer.getChildAt(0).requestFocus();
 195                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 196                      }
 197                  }
 198                  wasHandled = true;
 199                  break;
 200              case KeyEvent.KEYCODE_PAGE_DOWN:
 201                  if (handleKeyEvent) {
 202                      // Select the first icon on the next page, or the last icon on this page
 203                      // if there is no next page
 204                      if (pageIndex &lt; (pageCount - 1)) {
 205                          newParent = getAppsCustomizePage(container, pageIndex + 1);
 206                          if (newParent != null) {
 207                              container.snapToPage(pageIndex + 1);
 208                              child = newParent.getChildAt(0);
 209                              if (child != null) {
 210                                  child.requestFocus();
 211                                  v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 212                              }
 213                          }
 214                      } else {
 215                          itemContainer.getChildAt(itemCount - 1).requestFocus();
 216                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 217                      }
 218                  }
 219                  wasHandled = true;
 220                  break;
 221              case KeyEvent.KEYCODE_MOVE_HOME:
 222                  if (handleKeyEvent) {
 223                      // Select the first icon on this page
 224                      itemContainer.getChildAt(0).requestFocus();
 225                      v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 226                  }
 227                  wasHandled = true;
 228                  break;
 229              case KeyEvent.KEYCODE_MOVE_END:
 230                  if (handleKeyEvent) {
 231                      // Select the last icon on this page
 232                      itemContainer.getChildAt(itemCount - 1).requestFocus();
 233                      v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 234                  }
 235                  wasHandled = true;
 236                  break;
 237              default: break;
 238          }
 239          return wasHandled;
 240      }
 241  
 242      /**
 243       * Handles key events in the workspace hotseat (bottom of the screen).
 244       */
 245      static boolean handleHotseatButtonKeyEvent(View v, int keyCode, KeyEvent e, int orientation) {
 246          ShortcutAndWidgetContainer parent = (ShortcutAndWidgetContainer) v.getParent();
 247          final CellLayout layout = (CellLayout) parent.getParent();
 248  
 249          // NOTE: currently we don&#x27;t special case for the phone UI in different
 250          // orientations, even though the hotseat is on the side in landscape mode. This
 251          // is to ensure that accessibility consistency is maintained across rotations.
 252          final int action = e.getAction();
 253          final boolean handleKeyEvent = (action != KeyEvent.ACTION_UP);
 254          boolean wasHandled = false;
 255          switch (keyCode) {
 256              case KeyEvent.KEYCODE_DPAD_LEFT:
 257                  if (handleKeyEvent) {
 258                      ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);
 259                      int myIndex = views.indexOf(v);
 260                      // Select the previous button, otherwise do nothing
 261                      if (myIndex &gt; 0) {
 262                          views.get(myIndex - 1).requestFocus();
 263                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);
 264                      }
 265                  }
 266                  wasHandled = true;
 267                  break;
 268              case KeyEvent.KEYCODE_DPAD_RIGHT:
 269                  if (handleKeyEvent) {
 270                      ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);
 271                      int myIndex = views.indexOf(v);
 272                      // Select the next button, otherwise do nothing
 273                      if (myIndex &lt; views.size() - 1) {
 274                          views.get(myIndex + 1).requestFocus();
 275                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);
 276                      }
 277                  }
 278                  wasHandled = true;
 279                  break;
 280              case KeyEvent.KEYCODE_DPAD_UP:
 281                  if (handleKeyEvent) {
 282                      final Workspace workspace = (Workspace)
 283                              v.getRootView().findViewById(R.id.workspace);
 284                      if (workspace != null) {
 285                          int pageIndex = workspace.getCurrentPage();
 286                          CellLayout topLayout = (CellLayout) workspace.getChildAt(pageIndex);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 287 +                        if (topLayout == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 288 +                            // This is to guard against monkey actor test where the cell layout</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 289 +                            // of the new pageIndex is null monkey issuing commands while</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 290 +                            // animations happen.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 291 +                            return wasHandled;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 292 +                        }</span>
 293                          ShortcutAndWidgetContainer children = topLayout.getShortcutsAndWidgets();
 294                          final View newIcon = getIconInDirection(layout, children, -1, 1);
 295                          // Select the first bubble text view in the current page of the workspace
 296                          if (newIcon != null) {
 297                              newIcon.requestFocus();
 298                              v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 299                          } else {
 300                              workspace.requestFocus();
 301                          }
 302                      }
 303                  }
 304                  wasHandled = true;
 305                  break;
 306              case KeyEvent.KEYCODE_DPAD_DOWN:
 307                  // Do nothing
 308                  wasHandled = true;
 309                  break;
 310              default: break;
 311          }
 312          return wasHandled;
 313      }





























































































 314  
 315      /**
 316       * Private helper method to get the CellLayoutChildren given a CellLayout index.
 317       */
 318      private static ShortcutAndWidgetContainer getCellLayoutChildrenForIndex(
 319              ViewGroup container, int i) {
 320          CellLayout parent = (CellLayout) container.getChildAt(i);
 321          return parent.getShortcutsAndWidgets();
 322      }
 323  
 324      /**
 325       * Private helper method to sort all the CellLayout children in order of their (x,y) spatially
 326       * from top left to bottom right.

 327       */
 328      private static ArrayList&lt;View&gt; getCellLayoutChildrenSortedSpatially(CellLayout layout,
 329              ViewGroup parent) {
 330          // First we order each the CellLayout children by their x,y coordinates
 331          final int cellCountX = layout.getCountX();
 332          final int count = parent.getChildCount();
 333          ArrayList&lt;View&gt; views = new ArrayList&lt;View&gt;();
 334          for (int j = 0; j &lt; count; ++j) {
 335              views.add(parent.getChildAt(j));
 336          }
 337          Collections.sort(views, new Comparator&lt;View&gt;() {
 338              @Override
 339              public int compare(View lhs, View rhs) {
 340                  CellLayout.LayoutParams llp = (CellLayout.LayoutParams) lhs.getLayoutParams();
 341                  CellLayout.LayoutParams rlp = (CellLayout.LayoutParams) rhs.getLayoutParams();
 342                  int lvIndex = (llp.cellY * cellCountX) + llp.cellX;
 343                  int rvIndex = (rlp.cellY * cellCountX) + rlp.cellX;
 344                  return lvIndex - rvIndex;
 345              }
 346          });
 347          return views;
 348      }
 349      /**
 350       * Private helper method to find the index of the next BubbleTextView or FolderIcon in the
 351       * direction delta.
 352       *
 353       * @param delta either -1 or 1 depending on the direction we want to search
 354       */
 355      private static View findIndexOfIcon(ArrayList&lt;View&gt; views, int i, int delta) {
 356          // Then we find the next BubbleTextView offset by delta from i
 357          final int count = views.size();
 358          int newI = i + delta;
 359          while (0 &lt;= newI &amp;&amp; newI &lt; count) {
 360              View newV = views.get(newI);
 361              if (newV instanceof BubbleTextView || newV instanceof FolderIcon) {
 362                  return newV;
 363              }
 364              newI += delta;
 365          }
 366          return null;
 367      }
 368      private static View getIconInDirection(CellLayout layout, ViewGroup parent, int i,
 369              int delta) {
 370          final ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);
 371          return findIndexOfIcon(views, i, delta);
 372      }
 373      private static View getIconInDirection(CellLayout layout, ViewGroup parent, View v,
 374              int delta) {
 375          final ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);
 376          return findIndexOfIcon(views, views.indexOf(v), delta);
 377      }
 378      /**
 379       * Private helper method to find the next closest BubbleTextView or FolderIcon in the direction
 380       * delta on the next line.
 381       *
 382       * @param delta either -1 or 1 depending on the line and direction we want to search
 383       */
 384      private static View getClosestIconOnLine(CellLayout layout, ViewGroup parent, View v,
 385              int lineDelta) {
 386          final ArrayList&lt;View&gt; views = getCellLayoutChildrenSortedSpatially(layout, parent);
 387          final CellLayout.LayoutParams lp = (CellLayout.LayoutParams) v.getLayoutParams();
 388          final int cellCountY = layout.getCountY();
 389          final int row = lp.cellY;
 390          final int newRow = row + lineDelta;
 391          if (0 &lt;= newRow &amp;&amp; newRow &lt; cellCountY) {
 392              float closestDistance = Float.MAX_VALUE;
 393              int closestIndex = -1;
 394              int index = views.indexOf(v);
 395              int endIndex = (lineDelta &lt; 0) ? -1 : views.size();
 396              while (index != endIndex) {
 397                  View newV = views.get(index);
 398                  CellLayout.LayoutParams tmpLp = (CellLayout.LayoutParams) newV.getLayoutParams();
 399                  boolean satisfiesRow = (lineDelta &lt; 0) ? (tmpLp.cellY &lt; row) : (tmpLp.cellY &gt; row);
 400                  if (satisfiesRow &amp;&amp;
 401                          (newV instanceof BubbleTextView || newV instanceof FolderIcon)) {
 402                      float tmpDistance = (float) Math.sqrt(Math.pow(tmpLp.cellX - lp.cellX, 2) +
 403                              Math.pow(tmpLp.cellY - lp.cellY, 2));
 404                      if (tmpDistance &lt; closestDistance) {
 405                          closestIndex = index;
 406                          closestDistance = tmpDistance;
 407                      }
 408                  }
 409                  if (index &lt;= endIndex) {
 410                      ++index;
 411                  } else {
 412                      --index;
 413                  }
 414              }
 415              if (closestIndex &gt; -1) {
 416                  return views.get(closestIndex);
 417              }
 418          }
 419          return null;
 420      }
 421  
 422      /**
 423       * Handles key events in a Workspace containing.
 424       */
 425      static boolean handleIconKeyEvent(View v, int keyCode, KeyEvent e) {
 426          ShortcutAndWidgetContainer parent = (ShortcutAndWidgetContainer) v.getParent();
 427          final CellLayout layout = (CellLayout) parent.getParent();
 428          final Workspace workspace = (Workspace) layout.getParent();
 429          final ViewGroup launcher = (ViewGroup) workspace.getParent();
 430          final ViewGroup tabs = (ViewGroup) launcher.findViewById(R.id.search_drop_target_bar);
 431          final ViewGroup hotseat = (ViewGroup) launcher.findViewById(R.id.hotseat);
 432          int pageIndex = workspace.indexOfChild(layout);
 433          int pageCount = workspace.getChildCount();
 434  
 435          final int action = e.getAction();
 436          final boolean handleKeyEvent = (action != KeyEvent.ACTION_UP);
 437          boolean wasHandled = false;

 438          switch (keyCode) {
 439              case KeyEvent.KEYCODE_DPAD_LEFT:
 440                  if (handleKeyEvent) {
 441                      // Select the previous icon or the last icon on the previous page if possible
 442                      View newIcon = getIconInDirection(layout, parent, v, -1);
 443                      if (newIcon != null) {
 444                          newIcon.requestFocus();
 445                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);
 446                      } else {
 447                          if (pageIndex &gt; 0) {
 448                              parent = getCellLayoutChildrenForIndex(workspace, pageIndex - 1);
 449                              newIcon = getIconInDirection(layout, parent,
 450                                      parent.getChildCount(), -1);
 451                              if (newIcon != null) {
 452                                  newIcon.requestFocus();
 453                              } else {
 454                                  // Snap to the previous page
 455                                  workspace.snapToPage(pageIndex - 1);
 456                              }
 457                              v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);
 458                          }
 459                      }
 460                  }
 461                  wasHandled = true;

 462                  break;
 463              case KeyEvent.KEYCODE_DPAD_RIGHT:
 464                  if (handleKeyEvent) {
 465                      // Select the next icon or the first icon on the next page if possible
 466                      View newIcon = getIconInDirection(layout, parent, v, 1);
 467                      if (newIcon != null) {
 468                          newIcon.requestFocus();
 469                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);
 470                      } else {
 471                          if (pageIndex &lt; (pageCount - 1)) {
 472                              parent = getCellLayoutChildrenForIndex(workspace, pageIndex + 1);
 473                              newIcon = getIconInDirection(layout, parent, -1, 1);
 474                              if (newIcon != null) {
 475                                  newIcon.requestFocus();
 476                              } else {
 477                                  // Snap to the next page
 478                                  workspace.snapToPage(pageIndex + 1);
 479                              }
 480                              v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);
 481                          }
 482                      }
 483                  }
 484                  wasHandled = true;






 485                  break;
 486              case KeyEvent.KEYCODE_DPAD_UP:
 487                  if (handleKeyEvent) {
 488                      // Select the closest icon in the previous line, otherwise select the tab bar
 489                      View newIcon = getClosestIconOnLine(layout, parent, v, -1);
 490                      if (newIcon != null) {
 491                          newIcon.requestFocus();
 492                          wasHandled = true;
 493                      } else {
 494                          tabs.requestFocus();
 495                      }
 496                      v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 497                  }
 498                  break;
 499              case KeyEvent.KEYCODE_DPAD_DOWN:
 500                  if (handleKeyEvent) {
 501                      // Select the closest icon in the next line, otherwise select the button bar
 502                      View newIcon = getClosestIconOnLine(layout, parent, v, 1);
 503                      if (newIcon != null) {
 504                          newIcon.requestFocus();
 505                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 506                          wasHandled = true;
 507                      } else if (hotseat != null) {
 508                          hotseat.requestFocus();
 509                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 510                      }
 511                  }
 512                  break;
 513              case KeyEvent.KEYCODE_PAGE_UP:
 514                  if (handleKeyEvent) {
 515                      // Select the first icon on the previous page or the first icon on this page
 516                      // if there is no previous page
 517                      if (pageIndex &gt; 0) {
 518                          parent = getCellLayoutChildrenForIndex(workspace, pageIndex - 1);
 519                          View newIcon = getIconInDirection(layout, parent, -1, 1);
 520                          if (newIcon != null) {
 521                              newIcon.requestFocus();
 522                          } else {
 523                              // Snap to the previous page
 524                              workspace.snapToPage(pageIndex - 1);
 525                          }
 526                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 527                      } else {
 528                          View newIcon = getIconInDirection(layout, parent, -1, 1);
 529                          if (newIcon != null) {
 530                              newIcon.requestFocus();
 531                              v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 532                          }
 533                      }
 534                  }
 535                  wasHandled = true;
 536                  break;
 537              case KeyEvent.KEYCODE_PAGE_DOWN:
 538                  if (handleKeyEvent) {
 539                      // Select the first icon on the next page or the last icon on this page
 540                      // if there is no previous page
 541                      if (pageIndex &lt; (pageCount - 1)) {
 542                          parent = getCellLayoutChildrenForIndex(workspace, pageIndex + 1);
 543                          View newIcon = getIconInDirection(layout, parent, -1, 1);
 544                          if (newIcon != null) {
 545                              newIcon.requestFocus();
 546                          } else {
 547                              // Snap to the next page
 548                              workspace.snapToPage(pageIndex + 1);
 549                          }
 550                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 551                      } else {
 552                          View newIcon = getIconInDirection(layout, parent,
 553                                  parent.getChildCount(), -1);
 554                          if (newIcon != null) {
 555                              newIcon.requestFocus();
 556                              v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 557                          }
 558                      }
 559                  }
 560                  wasHandled = true;
 561                  break;
 562              case KeyEvent.KEYCODE_MOVE_HOME:
 563                  if (handleKeyEvent) {
 564                      // Select the first icon on this page
 565                      View newIcon = getIconInDirection(layout, parent, -1, 1);
 566                      if (newIcon != null) {
 567                          newIcon.requestFocus();
 568                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 569                      }
 570                  }
 571                  wasHandled = true;
 572                  break;
 573              case KeyEvent.KEYCODE_MOVE_END:
 574                  if (handleKeyEvent) {
 575                      // Select the last icon on this page
 576                      View newIcon = getIconInDirection(layout, parent,
 577                              parent.getChildCount(), -1);
 578                      if (newIcon != null) {
 579                          newIcon.requestFocus();
 580                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 581                      }
 582                  }
 583                  wasHandled = true;
 584                  break;
 585              default: break;
 586          }
 587          return wasHandled;
 588      }
 589  
 590      /**
 591       * Handles key events for items in a Folder.
 592       */
 593      static boolean handleFolderKeyEvent(View v, int keyCode, KeyEvent e) {
 594          ShortcutAndWidgetContainer parent = (ShortcutAndWidgetContainer) v.getParent();
 595          final CellLayout layout = (CellLayout) parent.getParent();
 596          final ScrollView scrollView = (ScrollView) layout.getParent();
 597          final Folder folder = (Folder) scrollView.getParent();
 598          View title = folder.mFolderName;
 599  
 600          final int action = e.getAction();
 601          final boolean handleKeyEvent = (action != KeyEvent.ACTION_UP);
 602          boolean wasHandled = false;
 603          switch (keyCode) {
 604              case KeyEvent.KEYCODE_DPAD_LEFT:
 605                  if (handleKeyEvent) {
 606                      // Select the previous icon
 607                      View newIcon = getIconInDirection(layout, parent, v, -1);
 608                      if (newIcon != null) {
 609                          newIcon.requestFocus();
 610                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_LEFT);
 611                      }
 612                  }
 613                  wasHandled = true;
 614                  break;
 615              case KeyEvent.KEYCODE_DPAD_RIGHT:
 616                  if (handleKeyEvent) {
 617                      // Select the next icon
 618                      View newIcon = getIconInDirection(layout, parent, v, 1);
 619                      if (newIcon != null) {
 620                          newIcon.requestFocus();
 621                      } else {
 622                          title.requestFocus();
 623                      }
 624                      v.playSoundEffect(SoundEffectConstants.NAVIGATION_RIGHT);
 625                  }
 626                  wasHandled = true;
 627                  break;
 628              case KeyEvent.KEYCODE_DPAD_UP:
 629                  if (handleKeyEvent) {
 630                      // Select the closest icon in the previous line
 631                      View newIcon = getClosestIconOnLine(layout, parent, v, -1);
 632                      if (newIcon != null) {
 633                          newIcon.requestFocus();
 634                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 635                      }
 636                  }
 637                  wasHandled = true;
 638                  break;
 639              case KeyEvent.KEYCODE_DPAD_DOWN:
 640                  if (handleKeyEvent) {
 641                      // Select the closest icon in the next line
 642                      View newIcon = getClosestIconOnLine(layout, parent, v, 1);
 643                      if (newIcon != null) {
 644                          newIcon.requestFocus();
 645                      } else {
 646                          title.requestFocus();
 647                      }
 648                      v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 649                  }
 650                  wasHandled = true;
 651                  break;
 652              case KeyEvent.KEYCODE_MOVE_HOME:
 653                  if (handleKeyEvent) {
 654                      // Select the first icon on this page
 655                      View newIcon = getIconInDirection(layout, parent, -1, 1);
 656                      if (newIcon != null) {
 657                          newIcon.requestFocus();
 658                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_UP);
 659                      }
 660                  }
 661                  wasHandled = true;
 662                  break;
 663              case KeyEvent.KEYCODE_MOVE_END:
 664                  if (handleKeyEvent) {
 665                      // Select the last icon on this page
 666                      View newIcon = getIconInDirection(layout, parent,
 667                              parent.getChildCount(), -1);
 668                      if (newIcon != null) {
 669                          newIcon.requestFocus();
 670                          v.playSoundEffect(SoundEffectConstants.NAVIGATION_DOWN);
 671                      }
 672                  }
 673                  wasHandled = true;
 674                  break;
 675              default: break;
 676          }
 677          return wasHandled;





 678      }
 679  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            