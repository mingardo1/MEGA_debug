<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>46</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    46
                    <a href="45.html">prev</a>
                    <a href="47.html">next</a>
                    <a href="46_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_425050c76a1d31f05dc4bdb210e13e931e2c01ff_Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;425050c76a1d31f05dc4bdb210e13e931e2c01ff:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;425050c76a1d31f05dc4bdb210e13e931e2c01ff^1:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;425050c76a1d31f05dc4bdb210e13e931e2c01ff^2:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;67f60111a7061fecb6de519ac2562187367d1b2c:Simplenote/src/main/java/com/automattic/simplenote/PreferencesFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.Context;
   6 import android.content.DialogInterface;
   7 import android.content.Intent;
   8 import android.net.Uri;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.ParcelFileDescriptor;
  12 import android.widget.Toast;
  13 
  14 import androidx.appcompat.app.AlertDialog;
  15 import androidx.appcompat.view.ContextThemeWrapper;
  16 import androidx.core.app.ShareCompat;
  17 import androidx.core.content.ContextCompat;
  18 import androidx.fragment.app.FragmentActivity;
  19 import androidx.preference.ListPreference;
  20 import androidx.preference.Preference;
  21 import androidx.preference.PreferenceFragmentCompat;
  22 import androidx.preference.SwitchPreferenceCompat;
  23 
  24 import com.automattic.simplenote.analytics.AnalyticsTracker;
  25 import com.automattic.simplenote.authentication.SimplenoteAuthenticationActivity;
  26 import com.automattic.simplenote.models.Note;
  27 import com.automattic.simplenote.models.Preferences;
  28 import com.automattic.simplenote.utils.AccountNetworkUtils;
  29 import com.automattic.simplenote.utils.AccountNetworkUtils.DeleteAccountRequestHandler;
  30 import com.automattic.simplenote.utils.AppLog;
  31 import com.automattic.simplenote.utils.AppLog.Type;
  32 import com.automattic.simplenote.utils.AuthUtils;
  33 import com.automattic.simplenote.utils.BrowserUtils;
  34 import com.automattic.simplenote.utils.CrashUtils;
  35 import com.automattic.simplenote.utils.DialogUtils;
  36 import com.automattic.simplenote.utils.HtmlCompat;
  37 import com.automattic.simplenote.utils.PrefUtils;
  38 import com.automattic.simplenote.utils.SimplenoteProgressDialogFragment;
  39 import com.simperium.Simperium;
  40 import com.simperium.android.ProgressDialogFragment;
  41 import com.simperium.client.Bucket;
  42 import com.simperium.client.BucketObjectMissingException;
  43 import com.simperium.client.BucketObjectNameInvalid;
  44 import com.simperium.client.User;
  45 
  46 import org.json.JSONArray;
  47 import org.json.JSONObject;
  48 
  49 import java.io.FileOutputStream;
  50 import java.lang.ref.WeakReference;
  51 import java.util.Collections;
  52 import java.util.Comparator;
  53 import java.util.List;
  54 
  55 import static android.app.Activity.RESULT_OK;
  56 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  57 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING;
  58 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING_LABEL;
  59 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING;
  60 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING_LABEL;
  61 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING;
  62 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING_LABEL;
  63 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING;
  64 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING_LABEL;
  65 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING;
  66 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING_LABEL;
  67 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING;
  68 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING_LABEL;
  69 
  70 /**
  71  * A simple {@link Fragment} subclass.
  72  */
<abbr title="  73 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.OnUserCreatedListener {">  73 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, SðŸ”µ</abbr>
  74     public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  75 
  76     private static final int REQUEST_EXPORT_DATA = 9001;
  77     private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  78     private static final int REQUEST_IMPORT_DATA = 9003;
  79 
  80     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  81     private SwitchPreferenceCompat mAnalyticsSwitch;
  82     private SimplenoteProgressDialogFragment mProgressDialogFragment;
  83 
  84     public PreferencesFragment() {
  85         // Required empty public constructor
  86     }
  87 
  88     @Override
  89     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  90         addPreferencesFromResource(R.xml.preferences);
  91     }
  92 
  93     @Override
  94     public void onActivityCreated(Bundle savedInstanceState) {
  95         super.onActivityCreated(savedInstanceState);
  96 
  97         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  98         Simplenote currentApp = (Simplenote) getActivity().getApplication();
  99         Simperium simperium = currentApp.getSimperium();
 100         simperium.setUserStatusChangeListener(this);
 101         simperium.setOnUserCreatedListener(this);
 102         mPreferencesBucket = currentApp.getPreferencesBucket();
 103 
 104         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
 105         if (simperium.needsAuthorization()) {
 106             authenticatePreference.setTitle(R.string.log_in);
 107         } else {
 108             authenticatePreference.setTitle(R.string.log_out);
 109         }
 110 
 111         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 112             @Override
 113             public boolean onPreferenceClick(Preference preference) {
 114                 if (!isAdded()) {
 115                     return false;
 116                 }
 117 
 118                 Simplenote currentApp = (Simplenote) getActivity().getApplication();
 119                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 120                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);"> 120                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
 121                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 122                 } else {
 123                     new LogOutTask(PreferencesFragment.this).execute();
 124                 }
 125                 return true;
 126             }
 127         });
 128 
 129         Preference deleteAppPreference = findPreference(&quot;pref_key_delete_account&quot;);
 130         deleteAppPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 131             @Override
 132             public boolean onPreferenceClick(Preference preference) {
 133                 showDeleteAccountDialog();
 134                 return true;
 135             }
 136         });
 137 
<abbr title=" 138         findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 138         findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 139             @Override
 140             public boolean onPreferenceClick(Preference preference) {
 141                 try {
<abbr title=" 142                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;);"> 142                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;ðŸ”µ</abbr>
 143                 } catch (Exception e) {
 144                     toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 145                 }
 146                 return true;
 147             }
 148         });
 149 
<abbr title=" 150         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 150         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
 151             @Override
 152             public boolean onPreferenceClick(Preference preference) {
 153                 try {
 154                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 155                 } catch (Exception e) {
 156                     toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 157                 }
 158                 return true;
 159             }
 160         });
 161 
<abbr title=" 162         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 162         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 163             @Override
 164             public boolean onPreferenceClick(Preference preference) {
 165                 startActivity(new Intent(getActivity(), AboutActivity.class));
 166                 return true;
 167             }
 168         });
 169 
<abbr title=" 170         findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 170         findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 171             @Override
 172             public boolean onPreferenceClick(Preference preference) {
 173                 Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 174                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 175                 intent.setType(&quot;*/*&quot;);
 176                 intent.putExtra(Intent.EXTRA_MIME_TYPES, new String[]{&quot;text/*&quot;, &quot;application/json&quot;});
 177                 startActivityForResult(intent, REQUEST_IMPORT_DATA);
 178                 return true;
 179             }
 180         });
 181 
<abbr title=" 182         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 182         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 183             @Override
 184             public boolean onPreferenceClick(Preference preference) {
 185                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 186                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 187                 intent.setType(&quot;application/json&quot;);
 188                 intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 189                 startActivityForResult(intent, REQUEST_EXPORT_DATA);
 190                 return true;
 191             }
 192         });
 193 
 194         final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 195         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 196             @Override
 197             public boolean onPreferenceChange(Preference preference, Object newValue) {
 198                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 199                 return true;
 200             }
 201 
 202             private void updateTheme(Activity activity, int index) {
 203                 CharSequence[] entries = themePreference.getEntries();
 204                 themePreference.setSummary(entries[index]);
 205 
 206                 AnalyticsTracker.track(
 207                         AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 208                         AnalyticsTracker.CATEGORY_USER,
 209                         &quot;theme_preference&quot;
 210                 );
 211             }
 212         });
 213 
 214         final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
 215         stylePreference.setSummary(
 216             PrefUtils.isPremium(requireContext()) ?
 217                 PrefUtils.getStyleNameFromIndexSelected(requireContext()) :
 218                 PrefUtils.getStyleNameDefault(requireContext())
 219         );
 220         stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 221             @Override
 222             public boolean onPreferenceClick(Preference preference) {
 223                 startActivity(new Intent(requireContext(), StyleActivity.class));
 224                 return true;
 225             }
 226         });
 227 
 228         final Preference membershipPreference = findPreference(&quot;pref_key_membership&quot;);
 229         membershipPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 230             @Override
 231             public boolean onPreferenceClick(Preference preference) {
 232                 ((PreferencesActivity) requireActivity()).openBrowserForMembership(getView());
 233                 return true;
 234             }
 235         });
 236 
 237         if (PrefUtils.isPremium(requireContext())) {
 238             membershipPreference.setLayoutResource(R.layout.preference_default);
 239             membershipPreference.setSummary(R.string.membership_premium);
 240         } else {
 241             membershipPreference.setLayoutResource(R.layout.preference_button);
 242             membershipPreference.setSummary(R.string.membership_free);
 243         }
 244 
 245         final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 246         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 247             @Override
 248             public boolean onPreferenceChange(Preference preference, Object newValue) {
 249                 int index = Integer.parseInt(newValue.toString());
 250                 CharSequence[] entries = sortPreference.getEntries();
 251                 sortPreference.setSummary(entries[index]);
 252 
 253                 if (!sortPreference.getValue().equals(newValue)) {
 254                     switch (index) {
 255                         case ALPHABETICAL_ASCENDING:
 256                             trackSortOrder(ALPHABETICAL_ASCENDING_LABEL);
 257                             break;
 258                         case ALPHABETICAL_DESCENDING:
 259                             trackSortOrder(ALPHABETICAL_DESCENDING_LABEL);
 260                             break;
 261                         case DATE_CREATED_ASCENDING:
 262                             trackSortOrder(DATE_CREATED_ASCENDING_LABEL);
 263                             break;
 264                         case DATE_CREATED_DESCENDING:
 265                             trackSortOrder(DATE_CREATED_DESCENDING_LABEL);
 266                             break;
 267                         case DATE_MODIFIED_ASCENDING:
 268                             trackSortOrder(DATE_MODIFIED_ASCENDING_LABEL);
 269                             break;
 270                         case DATE_MODIFIED_DESCENDING:
 271                             trackSortOrder(DATE_MODIFIED_DESCENDING_LABEL);
 272                             break;
 273                     }
 274                 }
 275 
 276                 return true;
 277             }
 278         });
 279 
 280         SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 281         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 282             @Override
 283             public boolean onPreferenceChange(Preference preference, Object o) {
 284                 if (((SwitchPreferenceCompat) preference).isChecked()) {
 285                     AnalyticsTracker.track(
 286                             AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 287                             AnalyticsTracker.CATEGORY_USER,
 288                             &quot;condensed_list_preference&quot;
 289                     );
 290                 }
 291 
 292                 return true;
 293             }
 294         });
 295 
 296         // Add the hyperlink to the analytics summary
 297         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 298         String formattedSummary = String.format(
 299                 getString(R.string.share_analytics_summary),
 300                 &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 301                 &quot;&lt;/a&gt;&quot;
 302         );
 303         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 304 
 305         mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 306         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 307             @Override
 308             public boolean onPreferenceChange(Preference preference, Object newValue) {
 309                 try {
 310                     boolean isChecked = (boolean)newValue;
 311                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 312                     prefs.setAnalyticsEnabled(isChecked);
 313                     prefs.save();
 314                 } catch (BucketObjectMissingException e) {
 315                     e.printStackTrace();
 316                 }
 317 
 318                 return true;
 319             }
 320         });
 321 
 322         updateAnalyticsSwitchState();
 323 
<abbr title=" 324         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 324         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 325             @Override
 326             public boolean onPreferenceClick(Preference preference) {
 327                 startActivity(
 328                     ShareCompat.IntentBuilder.from(requireActivity())
 329                         .setText(AppLog.get())
 330                         .setType(&quot;text/plain&quot;)
 331                         .createChooserIntent()
 332                 );
 333                 return true;
 334             }
 335         });
 336     }
 337 
 338     private void showProgressDialogDeleteAccount() {
 339         FragmentActivity activity = getActivity();
 340         if (activity == null) {
 341             return;
 342         }
 343 
<abbr title=" 344         mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requesting_message));"> 344         mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requestðŸ”µ</abbr>
 345         mProgressDialogFragment.show(activity.getSupportFragmentManager(), ProgressDialogFragment.TAG);
 346     }
 347 
 348     private void closeProgressDialogDeleteAccount() {
 349         if (mProgressDialogFragment != null &amp;&amp; !mProgressDialogFragment.isHidden()) {
 350             mProgressDialogFragment.dismiss();
 351             mProgressDialogFragment = null;
 352         }
 353     }
 354 
 355     private void showDeleteAccountDialog() {
 356         Context context = getContext();
 357         if (context == null) {
 358             return;
 359         }
 360 
<abbr title=" 361         final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(this);"> 361         final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(thisðŸ”µ</abbr>
 362 
<abbr title=" 363         final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, R.style.Dialog))"> 363         final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, ðŸ”µ</abbr>
 364                 .setTitle(R.string.delete_account)
 365                 .setMessage(R.string.delete_account_message)
 366                 .setPositiveButton(R.string.delete_account, new DialogInterface.OnClickListener() {
 367                         @Override
 368                         public void onClick(DialogInterface dialogInterface, int i) {
 369                             FragmentActivity activity = getActivity();
 370                             if (activity == null) {
 371                                 return;
 372                             }
 373 
 374                             showProgressDialogDeleteAccount();
 375 
 376                             Simplenote currentApp = (Simplenote) activity.getApplication();
 377                             Simperium simperium = currentApp.getSimperium();
 378                             String userEmail = simperium.getUser().getEmail();
 379                             String userToken = simperium.getUser().getAccessToken();
 380 
 381                             // makeDeleteAccountRequest can throw an exception when it cannot build
 382                             // the JSON object. In those cases, we show the error dialog since
 383                             // it can be related to memory constraints or something else that is
 384                             // just a transient fault
 385                             try {
 386                                 AppLog.add(Type.ACCOUNT, &quot;Making request to delete account&quot;);
 387 
 388                                 AccountNetworkUtils.makeDeleteAccountRequest(
 389                                         userEmail,
 390                                         userToken,
 391                                         deleteAccountHandler);
 392                             } catch (IllegalArgumentException exception) {
 393                                 AppLog.add(Type.ACCOUNT, &quot;Error trying to make request &quot; +
 394                                         &quot;to delete account. Error: &quot; + exception.getMessage());
 395 
 396                                 showDialogDeleteAccountError();
 397                             }
 398                         }
 399                     }
 400                 )
 401                 .setNegativeButton(R.string.cancel, null)
 402                 .create();
 403 
 404         dialogDeleteAccount.setOnShowListener(new DialogInterface.OnShowListener() {
 405             @Override
 406             public void onShow(DialogInterface dialog) {
 407                 FragmentActivity activity = getActivity();
 408                 if (activity == null) {
 409                     return;
 410                 }
 411 
 412                 int colorRed = ContextCompat.getColor(activity, R.color.text_button_red);
 413                 dialogDeleteAccount
 414                         .getButton(AlertDialog.BUTTON_POSITIVE)
 415                         .setTextColor(colorRed);
 416             }
 417         });
 418         dialogDeleteAccount.show();
 419     }
 420 
 421     private void showDialogDeleteAccountError() {
 422         Context context = getContext();
 423         if (context == null) {
 424             return;
 425         }
 426 
 427         DialogUtils.showDialogWithEmail(
 428                 context,
 429                 getString(R.string.error_ocurred_message)
 430         );
 431     }
 432 
 433     private void showDeleteAccountConfirmationDialog() {
 434         FragmentActivity activity = getActivity();
 435         if (activity == null) {
 436             return;
 437         }
 438 
 439         Simplenote currentApp = (Simplenote) activity.getApplication();
 440         Simperium simperium = currentApp.getSimperium();
 441         String userEmail = simperium.getUser().getEmail();
 442 
 443         AlertDialog dialogDeleteAccountConfirmation = new AlertDialog.Builder(
 444                 new ContextThemeWrapper(activity, R.style.Dialog))
 445                 .setTitle(R.string.request_received)
 446                 .setMessage(getString(R.string.account_deletion_message, userEmail))
 447                 .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {
 448                             @Override
 449                             public void onClick(DialogInterface dialogInterface, int i) {
 450                                 dialogInterface.dismiss();
 451                             }
 452                         }
 453                 )
 454                 .create();
 455 
 456         dialogDeleteAccountConfirmation.show();
 457     }
 458 
 459     @Override
 460     public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 461         if (resultCode != RESULT_OK || resultData == null) {
 462             return;
 463         }
 464 
 465         if (resultData.getData() == null) {
 466             toast(R.string.export_message_failure);
 467             return;
 468         }
 469 
 470         switch (requestCode) {
 471             case REQUEST_EXPORT_DATA:
 472                 exportData(resultData.getData(), false);
 473                 break;
 474             case REQUEST_EXPORT_UNSYNCED:
 475                 exportData(resultData.getData(), true);
 476                 break;
 477             case REQUEST_IMPORT_DATA:
 478                 importData(resultData.getData());
 479                 break;
 480         }
 481     }
 482 
 483     private boolean hasUnsyncedNotes() {
 484         Simplenote application = (Simplenote) getActivity().getApplication();
 485         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 486         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 487         while (notesCursor.moveToNext()) {
 488             Note note = notesCursor.getObject();
 489             if (note.isNew() || note.isModified()) {
 490                 return true;
 491             }
 492         }
 493 
 494         return false;
 495     }
 496 
 497     private void logOut() {
 498         AppLog.add(Type.ACTION, &quot;Tapped logout button (PreferencesFragment)&quot;);
 499         AnalyticsTracker.track(
 500                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 501                 AnalyticsTracker.CATEGORY_USER,
 502                 &quot;preferences_sign_out_button&quot;
 503         );
 504 
 505         AuthUtils.logOut((Simplenote) requireActivity().getApplication());
 506 
 507         getActivity().finish();
 508     }
 509 
 510     @Override
 511     public void onUserStatusChange(User.Status status) {
 512         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 513             // User signed in
 514             getActivity().runOnUiThread(new Runnable() {
 515                 public void run() {
 516                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 517                     authenticatePreference.setTitle(R.string.log_out);
 518                 }
 519             });
 520 
 521             Simplenote app = (Simplenote) getActivity().getApplication();
 522             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 523             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 524 
 525             AnalyticsTracker.track(
 526                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 527                     AnalyticsTracker.CATEGORY_USER,
 528                     &quot;signed_in_from_preferences_activity&quot;
 529             );
 530         }
 531     }
 532 
 533     @Override
 534     public void onUserCreated(User user) {
 535         AnalyticsTracker.track(
 536                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 537                 AnalyticsTracker.CATEGORY_USER,
 538                 &quot;account_created_from_preferences_activity&quot;
 539         );
 540     }
 541 
 542     private void exportData(Uri uri, boolean isUnsyncedNotes) {
 543         Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 544         Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 545         JSONObject account = new JSONObject();
 546         Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 547 
 548         try {
 549             JSONArray activeNotes = new JSONArray();
 550             JSONArray trashedNotes = new JSONArray();
 551             Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 552                 @Override
 553                 public int compare(String text1, String text2) {
 554                     return text1.compareToIgnoreCase(text2);
 555                 }
 556             };
 557 
 558             while (cursor.moveToNext()) {
 559                 Note note = cursor.getObject();
 560 
 561                 if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 562                     continue;
 563                 }
 564 
 565                 JSONObject noteJson = new JSONObject();
 566 
 567                 noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 568                 noteJson.put(&quot;content&quot;, note.getContent());
 569                 noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 570                 noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 571 
 572                 if (note.isPinned()) {
 573                     noteJson.put(&quot;pinned&quot;, note.isPinned());
 574                 }
 575 
 576                 if (note.isMarkdownEnabled()) {
 577                     noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 578                 }
 579 
 580                 if (note.getTags().size() &gt; 0) {
 581                     List&lt;String&gt; tags = note.getTags();
 582                     Collections.sort(tags, comparator);
 583                     noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 584                 }
 585 
 586                 if (!note.getPublishedUrl().isEmpty()) {
 587                     noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 588                 }
 589 
 590                 if (note.isDeleted()) {
 591                     trashedNotes.put(noteJson);
 592                 } else {
 593                     activeNotes.put(noteJson);
 594                 }
 595             }
 596 
 597             account.put(&quot;activeNotes&quot;, activeNotes);
 598             account.put(&quot;trashedNotes&quot;, trashedNotes);
 599 
<abbr title=" 600             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 600             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDesðŸ”µ</abbr>
 601 
 602             if (parcelFileDescriptor != null) {
<abbr title=" 603                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 603                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescðŸ”µ</abbr>
 604                 fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 605                 parcelFileDescriptor.close();
 606                 toast(R.string.export_message_success);
 607             } else {
 608                 toast(R.string.export_message_failure);
 609             }
 610         } catch (Exception e) {
 611             toast(R.string.export_message_failure);
 612         }
 613     }
 614 
 615     private void importData(Uri uri) {
 616         try {
 617             Importer.fromUri(this, uri);
 618             toast(R.string.import_message_success);
 619         } catch (Importer.ImportException e) {
 620             switch (e.getReason()) {
 621                 case FileError:
 622                     toast(R.string.import_error_file);
 623                     break;
 624                 case ParseError:
 625                     toast(R.string.import_error_parse);
 626                     break;
 627                 case UnknownExportType:
 628                     toast(R.string.import_unknown);
 629                     break;
 630             }
 631         }
 632     }
 633 
 634     private void trackSortOrder(String label) {
 635         AnalyticsTracker.track(
 636             AnalyticsTracker.Stat.SETTINGS_SEARCH_SORT_MODE,
 637             AnalyticsTracker.CATEGORY_SETTING,
 638             label
 639         );
 640     }
 641 
 642     private void updateAnalyticsSwitchState() {
 643         try {
 644             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 645             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 646         } catch (BucketObjectMissingException e) {
 647             // The preferences object doesn&#x27;t exist for this user yet, create it
 648             try {
 649                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 650                 prefs.setAnalyticsEnabled(true);
 651                 prefs.save();
 652             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 653                 bucketObjectNameInvalid.printStackTrace();
 654             }
 655         }
 656     }
 657 
 658     private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 659         private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 660 
 661         LogOutTask(PreferencesFragment fragment) {
 662             mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 663         }
 664 
 665         @Override
 666         protected Boolean doInBackground(Void... voids) {
 667             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 668             return fragment == null || fragment.hasUnsyncedNotes();
 669         }
 670 
 671         @Override
 672         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 673             final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 674 
 675             if (fragment == null) {
 676                 return;
 677             }
 678 
 679             // Safety first! Check if any notes are unsynced and warn the user if so.
 680             if (hasUnsyncedNotes) {
<abbr title=" 681                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))"> 681                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 682                     .setTitle(R.string.unsynced_notes)
 683                     .setMessage(R.string.unsynced_notes_message)
 684                     .setPositiveButton(R.string.log_out_anyway,
 685                         new DialogInterface.OnClickListener() {
 686                             @Override
 687                             public void onClick(DialogInterface dialogInterface, int i) {
 688                                 fragment.logOut();
 689                             }
 690                         }
 691                     )
 692                     .setNeutralButton(R.string.export_unsynced_notes,
 693                         new DialogInterface.OnClickListener() {
 694                             @Override
 695                             public void onClick(DialogInterface dialogInterface, int i) {
 696                                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 697                                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 698                                 intent.setType(&quot;application/json&quot;);
<abbr title=" 699                                 intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));"> 699                                 intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_fiðŸ”µ</abbr>
 700                                 fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 701                             }
 702                         }
 703                     )
 704                     .setNegativeButton(R.string.cancel, null)
 705                     .show();
 706             } else {
 707                 fragment.logOut();
 708             }
 709         }
 710     }
 711 
 712 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 713     static class DeleteAccountRequestHandlerImpl implements DeleteAccountRequestHandler {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 714         final WeakReference&lt;PreferencesFragment&gt; preferencesFragment;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 715 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 716         DeleteAccountRequestHandlerImpl(PreferencesFragment fragment) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 717             this.preferencesFragment = new WeakReference&lt;&gt;(fragment);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 718         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 719 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 720         @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 721         public void onSuccess() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 722             final PreferencesFragment fragment = preferencesFragment.get();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 723             if (fragment == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 724                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 725             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 726 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 727             FragmentActivity activity = fragment.getActivity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 728             if (activity == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 729                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 730             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 731 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 732             AppLog.add(Type.ACCOUNT, &quot;Request to delete account was successful&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 733 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 734             activity.runOnUiThread(new Runnable() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 735                 @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 736                 public void run() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 737                     fragment.closeProgressDialogDeleteAccount();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 738                     fragment.showDeleteAccountConfirmationDialog();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 739                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 740             });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 741         }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 742 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 743         @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 744         public void onFailure() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 745             final PreferencesFragment fragment = preferencesFragment.get();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 746             if (fragment == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 747                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 748             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 749 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 750             FragmentActivity activity = fragment.getActivity();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 751             if (activity == null) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 752                 return;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 753             }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 754 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 755             AppLog.add(Type.ACCOUNT, &quot;Failure while calling server to delete account&quot;);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 756 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 757             activity.runOnUiThread(new Runnable() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 758                 @Override</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 759                 public void run() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 760                     fragment.closeProgressDialogDeleteAccount();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 761                     fragment.showDialogDeleteAccountError();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 762                 }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 763             });</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 764         }</span>
 765 ||||||| GitAnalyzerPlus_base
 766 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 767     private void toast(int stringId) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 768         toast(stringId, Toast.LENGTH_SHORT);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 769     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 770 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 771     private void toast(int stringId, int length) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 772         Toast.makeText(requireContext(), getString(stringId), length).show();</span>
 773 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 774     }
 775 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.Context;
   6 import android.content.DialogInterface;
   7 import android.content.Intent;
   8 import android.net.Uri;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.ParcelFileDescriptor;
  12 import android.widget.Toast;
  13 
  14 import androidx.appcompat.app.AlertDialog;
  15 import androidx.appcompat.view.ContextThemeWrapper;
  16 import androidx.core.app.ShareCompat;
  17 import androidx.core.content.ContextCompat;
  18 import androidx.fragment.app.FragmentActivity;
  19 import androidx.preference.ListPreference;
  20 import androidx.preference.Preference;
  21 import androidx.preference.PreferenceFragmentCompat;
  22 import androidx.preference.SwitchPreferenceCompat;
  23 
  24 import com.automattic.simplenote.analytics.AnalyticsTracker;
  25 import com.automattic.simplenote.authentication.SimplenoteAuthenticationActivity;
  26 import com.automattic.simplenote.models.Note;
  27 import com.automattic.simplenote.models.Preferences;
  28 import com.automattic.simplenote.utils.AccountNetworkUtils;
  29 import com.automattic.simplenote.utils.AccountNetworkUtils.DeleteAccountRequestHandler;
  30 import com.automattic.simplenote.utils.AppLog;
  31 import com.automattic.simplenote.utils.AppLog.Type;
  32 import com.automattic.simplenote.utils.AuthUtils;
  33 import com.automattic.simplenote.utils.BrowserUtils;
  34 import com.automattic.simplenote.utils.CrashUtils;
  35 import com.automattic.simplenote.utils.DialogUtils;
  36 import com.automattic.simplenote.utils.HtmlCompat;
  37 import com.automattic.simplenote.utils.PrefUtils;
  38 import com.automattic.simplenote.utils.SimplenoteProgressDialogFragment;
  39 import com.simperium.Simperium;
  40 import com.simperium.android.ProgressDialogFragment;
  41 import com.simperium.client.Bucket;
  42 import com.simperium.client.BucketObjectMissingException;
  43 import com.simperium.client.BucketObjectNameInvalid;
  44 import com.simperium.client.User;
  45 
  46 import org.json.JSONArray;
  47 import org.json.JSONObject;
  48 
  49 import java.io.FileOutputStream;
  50 import java.lang.ref.WeakReference;
  51 import java.util.Collections;
  52 import java.util.Comparator;
  53 import java.util.List;
  54 
  55 import static android.app.Activity.RESULT_OK;
  56 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  57 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING;
  58 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING_LABEL;
  59 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING;
  60 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING_LABEL;
  61 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING;
  62 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING_LABEL;
  63 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING;
  64 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING_LABEL;
  65 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING;
  66 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING_LABEL;
  67 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING;
  68 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING_LABEL;
  69 
  70 /**
  71  * A simple {@link Fragment} subclass.
  72  */
<abbr title="  73 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.OnUserCreatedListener {">  73 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, SðŸ”µ</abbr>
  74     public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  75 
  76     private static final int REQUEST_EXPORT_DATA = 9001;
  77     private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  78     private static final int REQUEST_IMPORT_DATA = 9003;
  79 
  80     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  81     private SwitchPreferenceCompat mAnalyticsSwitch;
  82     private SimplenoteProgressDialogFragment mProgressDialogFragment;
  83 
  84     public PreferencesFragment() {
  85         // Required empty public constructor
  86     }
  87 
  88     @Override
  89     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  90         addPreferencesFromResource(R.xml.preferences);
  91     }
  92 
  93     @Override
  94     public void onActivityCreated(Bundle savedInstanceState) {
  95         super.onActivityCreated(savedInstanceState);
  96 
  97         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  98         Simplenote currentApp = (Simplenote) getActivity().getApplication();
  99         Simperium simperium = currentApp.getSimperium();
 100         simperium.setUserStatusChangeListener(this);
 101         simperium.setOnUserCreatedListener(this);
 102         mPreferencesBucket = currentApp.getPreferencesBucket();
 103 
 104         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
 105         if (simperium.needsAuthorization()) {
 106             authenticatePreference.setTitle(R.string.log_in);
 107         } else {
 108             authenticatePreference.setTitle(R.string.log_out);
 109         }
 110 
 111         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 112             @Override
 113             public boolean onPreferenceClick(Preference preference) {
 114                 if (!isAdded()) {
 115                     return false;
 116                 }
 117 
 118                 Simplenote currentApp = (Simplenote) getActivity().getApplication();
 119                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 120                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);"> 120                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
 121                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 122                 } else {
 123                     new LogOutTask(PreferencesFragment.this).execute();
 124                 }
 125                 return true;
 126             }
 127         });
 128 
 129         Preference deleteAppPreference = findPreference(&quot;pref_key_delete_account&quot;);
 130         deleteAppPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 131             @Override
 132             public boolean onPreferenceClick(Preference preference) {
 133                 showDeleteAccountDialog();
 134                 return true;
 135             }
 136         });
 137 
<abbr title=" 138         findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 138         findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 139             @Override
 140             public boolean onPreferenceClick(Preference preference) {
 141                 try {
<abbr title=" 142                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;);"> 142                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;ðŸ”µ</abbr>
 143                 } catch (Exception e) {
 144                     toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 145                 }
 146                 return true;
 147             }
 148         });
 149 
<abbr title=" 150         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 150         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
 151             @Override
 152             public boolean onPreferenceClick(Preference preference) {
 153                 try {
 154                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 155                 } catch (Exception e) {
 156                     toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 157                 }
 158                 return true;
 159             }
 160         });
 161 
<abbr title=" 162         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 162         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 163             @Override
 164             public boolean onPreferenceClick(Preference preference) {
 165                 startActivity(new Intent(getActivity(), AboutActivity.class));
 166                 return true;
 167             }
 168         });
 169 
<abbr title=" 170         findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 170         findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 171             @Override
 172             public boolean onPreferenceClick(Preference preference) {
 173                 Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 174                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 175                 intent.setType(&quot;*/*&quot;);
 176                 intent.putExtra(Intent.EXTRA_MIME_TYPES, new String[]{&quot;text/*&quot;, &quot;application/json&quot;});
 177                 startActivityForResult(intent, REQUEST_IMPORT_DATA);
 178                 return true;
 179             }
 180         });
 181 
<abbr title=" 182         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 182         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 183             @Override
 184             public boolean onPreferenceClick(Preference preference) {
 185                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 186                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 187                 intent.setType(&quot;application/json&quot;);
 188                 intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 189                 startActivityForResult(intent, REQUEST_EXPORT_DATA);
 190                 return true;
 191             }
 192         });
 193 
 194         final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 195         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 196             @Override
 197             public boolean onPreferenceChange(Preference preference, Object newValue) {
 198                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 199                 return true;
 200             }
 201 
 202             private void updateTheme(Activity activity, int index) {
 203                 CharSequence[] entries = themePreference.getEntries();
 204                 themePreference.setSummary(entries[index]);
 205 
 206                 AnalyticsTracker.track(
 207                         AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 208                         AnalyticsTracker.CATEGORY_USER,
 209                         &quot;theme_preference&quot;
 210                 );
 211             }
 212         });
 213 
 214         final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
 215         stylePreference.setSummary(
 216             PrefUtils.isPremium(requireContext()) ?
 217                 PrefUtils.getStyleNameFromIndexSelected(requireContext()) :
 218                 PrefUtils.getStyleNameDefault(requireContext())
 219         );
 220         stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 221             @Override
 222             public boolean onPreferenceClick(Preference preference) {
 223                 startActivity(new Intent(requireContext(), StyleActivity.class));
 224                 return true;
 225             }
 226         });
 227 
 228         final Preference membershipPreference = findPreference(&quot;pref_key_membership&quot;);
 229         membershipPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 230             @Override
 231             public boolean onPreferenceClick(Preference preference) {
 232                 ((PreferencesActivity) requireActivity()).openBrowserForMembership(getView());
 233                 return true;
 234             }
 235         });
 236 
 237         if (PrefUtils.isPremium(requireContext())) {
 238             membershipPreference.setLayoutResource(R.layout.preference_default);
 239             membershipPreference.setSummary(R.string.membership_premium);
 240         } else {
 241             membershipPreference.setLayoutResource(R.layout.preference_button);
 242             membershipPreference.setSummary(R.string.membership_free);
 243         }
 244 
 245         final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 246         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 247             @Override
 248             public boolean onPreferenceChange(Preference preference, Object newValue) {
 249                 int index = Integer.parseInt(newValue.toString());
 250                 CharSequence[] entries = sortPreference.getEntries();
 251                 sortPreference.setSummary(entries[index]);
 252 
 253                 if (!sortPreference.getValue().equals(newValue)) {
 254                     switch (index) {
 255                         case ALPHABETICAL_ASCENDING:
 256                             trackSortOrder(ALPHABETICAL_ASCENDING_LABEL);
 257                             break;
 258                         case ALPHABETICAL_DESCENDING:
 259                             trackSortOrder(ALPHABETICAL_DESCENDING_LABEL);
 260                             break;
 261                         case DATE_CREATED_ASCENDING:
 262                             trackSortOrder(DATE_CREATED_ASCENDING_LABEL);
 263                             break;
 264                         case DATE_CREATED_DESCENDING:
 265                             trackSortOrder(DATE_CREATED_DESCENDING_LABEL);
 266                             break;
 267                         case DATE_MODIFIED_ASCENDING:
 268                             trackSortOrder(DATE_MODIFIED_ASCENDING_LABEL);
 269                             break;
 270                         case DATE_MODIFIED_DESCENDING:
 271                             trackSortOrder(DATE_MODIFIED_DESCENDING_LABEL);
 272                             break;
 273                     }
 274                 }
 275 
 276                 return true;
 277             }
 278         });
 279 
 280         SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 281         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 282             @Override
 283             public boolean onPreferenceChange(Preference preference, Object o) {
 284                 if (((SwitchPreferenceCompat) preference).isChecked()) {
 285                     AnalyticsTracker.track(
 286                             AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 287                             AnalyticsTracker.CATEGORY_USER,
 288                             &quot;condensed_list_preference&quot;
 289                     );
 290                 }
 291 
 292                 return true;
 293             }
 294         });
 295 
 296         // Add the hyperlink to the analytics summary
 297         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 298         String formattedSummary = String.format(
 299                 getString(R.string.share_analytics_summary),
 300                 &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 301                 &quot;&lt;/a&gt;&quot;
 302         );
 303         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 304 
 305         mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 306         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 307             @Override
 308             public boolean onPreferenceChange(Preference preference, Object newValue) {
 309                 try {
 310                     boolean isChecked = (boolean)newValue;
 311                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 312                     prefs.setAnalyticsEnabled(isChecked);
 313                     prefs.save();
 314                 } catch (BucketObjectMissingException e) {
 315                     e.printStackTrace();
 316                 }
 317 
 318                 return true;
 319             }
 320         });
 321 
 322         updateAnalyticsSwitchState();
 323 
<abbr title=" 324         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 324         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 325             @Override
 326             public boolean onPreferenceClick(Preference preference) {
 327                 startActivity(
 328                     ShareCompat.IntentBuilder.from(requireActivity())
 329                         .setText(AppLog.get())
 330                         .setType(&quot;text/plain&quot;)
 331                         .createChooserIntent()
 332                 );
 333                 return true;
 334             }
 335         });
 336     }
 337 
 338     private void showProgressDialogDeleteAccount() {
 339         FragmentActivity activity = getActivity();
 340         if (activity == null) {
 341             return;
 342         }
 343 
<abbr title=" 344         mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requesting_message));"> 344         mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requestðŸ”µ</abbr>
 345         mProgressDialogFragment.show(activity.getSupportFragmentManager(), ProgressDialogFragment.TAG);
 346     }
 347 
 348     private void closeProgressDialogDeleteAccount() {
 349         if (mProgressDialogFragment != null &amp;&amp; !mProgressDialogFragment.isHidden()) {
 350             mProgressDialogFragment.dismiss();
 351             mProgressDialogFragment = null;
 352         }
 353     }
 354 
 355     private void showDeleteAccountDialog() {
 356         Context context = getContext();
 357         if (context == null) {
 358             return;
 359         }
 360 
<abbr title=" 361         final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(this);"> 361         final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(thisðŸ”µ</abbr>
 362 
<abbr title=" 363         final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, R.style.Dialog))"> 363         final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, ðŸ”µ</abbr>
 364                 .setTitle(R.string.delete_account)
 365                 .setMessage(R.string.delete_account_message)
 366                 .setPositiveButton(R.string.delete_account, new DialogInterface.OnClickListener() {
 367                         @Override
 368                         public void onClick(DialogInterface dialogInterface, int i) {
 369                             FragmentActivity activity = getActivity();
 370                             if (activity == null) {
 371                                 return;
 372                             }
 373 
 374                             showProgressDialogDeleteAccount();
 375 
 376                             Simplenote currentApp = (Simplenote) activity.getApplication();
 377                             Simperium simperium = currentApp.getSimperium();
 378                             String userEmail = simperium.getUser().getEmail();
 379                             String userToken = simperium.getUser().getAccessToken();
 380 
 381                             // makeDeleteAccountRequest can throw an exception when it cannot build
 382                             // the JSON object. In those cases, we show the error dialog since
 383                             // it can be related to memory constraints or something else that is
 384                             // just a transient fault
 385                             try {
 386                                 AppLog.add(Type.ACCOUNT, &quot;Making request to delete account&quot;);
 387 
 388                                 AccountNetworkUtils.makeDeleteAccountRequest(
 389                                         userEmail,
 390                                         userToken,
 391                                         deleteAccountHandler);
 392                             } catch (IllegalArgumentException exception) {
 393                                 AppLog.add(Type.ACCOUNT, &quot;Error trying to make request &quot; +
 394                                         &quot;to delete account. Error: &quot; + exception.getMessage());
 395 
 396                                 showDialogDeleteAccountError();
 397                             }
 398                         }
 399                     }
 400                 )
 401                 .setNegativeButton(R.string.cancel, null)
 402                 .create();
 403 
 404         dialogDeleteAccount.setOnShowListener(new DialogInterface.OnShowListener() {
 405             @Override
 406             public void onShow(DialogInterface dialog) {
 407                 FragmentActivity activity = getActivity();
 408                 if (activity == null) {
 409                     return;
 410                 }
 411 
 412                 int colorRed = ContextCompat.getColor(activity, R.color.text_button_red);
 413                 dialogDeleteAccount
 414                         .getButton(AlertDialog.BUTTON_POSITIVE)
 415                         .setTextColor(colorRed);
 416             }
 417         });
 418         dialogDeleteAccount.show();
 419     }
 420 
 421     private void showDialogDeleteAccountError() {
 422         Context context = getContext();
 423         if (context == null) {
 424             return;
 425         }
 426 
 427         DialogUtils.showDialogWithEmail(
 428                 context,
 429                 getString(R.string.error_ocurred_message)
 430         );
 431     }
 432 
 433     private void showDeleteAccountConfirmationDialog() {
 434         FragmentActivity activity = getActivity();
 435         if (activity == null) {
 436             return;
 437         }
 438 
 439         Simplenote currentApp = (Simplenote) activity.getApplication();
 440         Simperium simperium = currentApp.getSimperium();
 441         String userEmail = simperium.getUser().getEmail();
 442 
 443         AlertDialog dialogDeleteAccountConfirmation = new AlertDialog.Builder(
 444                 new ContextThemeWrapper(activity, R.style.Dialog))
 445                 .setTitle(R.string.request_received)
 446                 .setMessage(getString(R.string.account_deletion_message, userEmail))
 447                 .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {
 448                             @Override
 449                             public void onClick(DialogInterface dialogInterface, int i) {
 450                                 dialogInterface.dismiss();
 451                             }
 452                         }
 453                 )
 454                 .create();
 455 
 456         dialogDeleteAccountConfirmation.show();
 457     }
 458 
 459     @Override
 460     public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 461         if (resultCode != RESULT_OK || resultData == null) {
 462             return;
 463         }
 464 
 465         if (resultData.getData() == null) {
 466             toast(R.string.export_message_failure);
 467             return;
 468         }
 469 
 470         switch (requestCode) {
 471             case REQUEST_EXPORT_DATA:
 472                 exportData(resultData.getData(), false);
 473                 break;
 474             case REQUEST_EXPORT_UNSYNCED:
 475                 exportData(resultData.getData(), true);
 476                 break;
 477             case REQUEST_IMPORT_DATA:
 478                 importData(resultData.getData());
 479                 break;
 480         }
 481     }
 482 
 483     private boolean hasUnsyncedNotes() {
 484         Simplenote application = (Simplenote) getActivity().getApplication();
 485         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 486         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 487         while (notesCursor.moveToNext()) {
 488             Note note = notesCursor.getObject();
 489             if (note.isNew() || note.isModified()) {
 490                 return true;
 491             }
 492         }
 493 
 494         return false;
 495     }
 496 
 497     private void logOut() {
 498         AppLog.add(Type.ACTION, &quot;Tapped logout button (PreferencesFragment)&quot;);
 499         AnalyticsTracker.track(
 500                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 501                 AnalyticsTracker.CATEGORY_USER,
 502                 &quot;preferences_sign_out_button&quot;
 503         );
 504 
 505         AuthUtils.logOut((Simplenote) requireActivity().getApplication());
 506 
 507         getActivity().finish();
 508     }
 509 
 510     @Override
 511     public void onUserStatusChange(User.Status status) {
 512         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 513             // User signed in
 514             getActivity().runOnUiThread(new Runnable() {
 515                 public void run() {
 516                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 517                     authenticatePreference.setTitle(R.string.log_out);
 518                 }
 519             });
 520 
 521             Simplenote app = (Simplenote) getActivity().getApplication();
 522             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 523             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 524 
 525             AnalyticsTracker.track(
 526                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 527                     AnalyticsTracker.CATEGORY_USER,
 528                     &quot;signed_in_from_preferences_activity&quot;
 529             );
 530         }
 531     }
 532 
 533     @Override
 534     public void onUserCreated(User user) {
 535         AnalyticsTracker.track(
 536                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 537                 AnalyticsTracker.CATEGORY_USER,
 538                 &quot;account_created_from_preferences_activity&quot;
 539         );
 540     }
 541 
 542     private void exportData(Uri uri, boolean isUnsyncedNotes) {
 543         Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 544         Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 545         JSONObject account = new JSONObject();
 546         Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 547 
 548         try {
 549             JSONArray activeNotes = new JSONArray();
 550             JSONArray trashedNotes = new JSONArray();
 551             Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 552                 @Override
 553                 public int compare(String text1, String text2) {
 554                     return text1.compareToIgnoreCase(text2);
 555                 }
 556             };
 557 
 558             while (cursor.moveToNext()) {
 559                 Note note = cursor.getObject();
 560 
 561                 if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 562                     continue;
 563                 }
 564 
 565                 JSONObject noteJson = new JSONObject();
 566 
 567                 noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 568                 noteJson.put(&quot;content&quot;, note.getContent());
 569                 noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 570                 noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 571 
 572                 if (note.isPinned()) {
 573                     noteJson.put(&quot;pinned&quot;, note.isPinned());
 574                 }
 575 
 576                 if (note.isMarkdownEnabled()) {
 577                     noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 578                 }
 579 
 580                 if (note.getTags().size() &gt; 0) {
 581                     List&lt;String&gt; tags = note.getTags();
 582                     Collections.sort(tags, comparator);
 583                     noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 584                 }
 585 
 586                 if (!note.getPublishedUrl().isEmpty()) {
 587                     noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 588                 }
 589 
 590                 if (note.isDeleted()) {
 591                     trashedNotes.put(noteJson);
 592                 } else {
 593                     activeNotes.put(noteJson);
 594                 }
 595             }
 596 
 597             account.put(&quot;activeNotes&quot;, activeNotes);
 598             account.put(&quot;trashedNotes&quot;, trashedNotes);
 599 
<abbr title=" 600             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 600             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDesðŸ”µ</abbr>
 601 
 602             if (parcelFileDescriptor != null) {
<abbr title=" 603                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 603                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescðŸ”µ</abbr>
 604                 fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 605                 parcelFileDescriptor.close();
 606                 toast(R.string.export_message_success);
 607             } else {
 608                 toast(R.string.export_message_failure);
 609             }
 610         } catch (Exception e) {
 611             toast(R.string.export_message_failure);
 612         }
 613     }
 614 
 615     private void importData(Uri uri) {
 616         try {
 617             Importer.fromUri(this, uri);
 618             toast(R.string.import_message_success);
 619         } catch (Importer.ImportException e) {
 620             switch (e.getReason()) {
 621                 case FileError:
 622                     toast(R.string.import_error_file);
 623                     break;
 624                 case ParseError:
 625                     toast(R.string.import_error_parse);
 626                     break;
 627                 case UnknownExportType:
 628                     toast(R.string.import_unknown);
 629                     break;
 630             }
 631         }
 632     }
 633 
 634     private void trackSortOrder(String label) {
 635         AnalyticsTracker.track(
 636             AnalyticsTracker.Stat.SETTINGS_SEARCH_SORT_MODE,
 637             AnalyticsTracker.CATEGORY_SETTING,
 638             label
 639         );
 640     }
 641 
 642     private void updateAnalyticsSwitchState() {
 643         try {
 644             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 645             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 646         } catch (BucketObjectMissingException e) {
 647             // The preferences object doesn&#x27;t exist for this user yet, create it
 648             try {
 649                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 650                 prefs.setAnalyticsEnabled(true);
 651                 prefs.save();
 652             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 653                 bucketObjectNameInvalid.printStackTrace();
 654             }
 655         }
 656     }
 657 
 658     private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 659         private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 660 
 661         LogOutTask(PreferencesFragment fragment) {
 662             mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 663         }
 664 
 665         @Override
 666         protected Boolean doInBackground(Void... voids) {
 667             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 668             return fragment == null || fragment.hasUnsyncedNotes();
 669         }
 670 
 671         @Override
 672         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 673             final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 674 
 675             if (fragment == null) {
 676                 return;
 677             }
 678 
 679             // Safety first! Check if any notes are unsynced and warn the user if so.
 680             if (hasUnsyncedNotes) {
<abbr title=" 681                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))"> 681                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 682                     .setTitle(R.string.unsynced_notes)
 683                     .setMessage(R.string.unsynced_notes_message)
 684                     .setPositiveButton(R.string.log_out_anyway,
 685                         new DialogInterface.OnClickListener() {
 686                             @Override
 687                             public void onClick(DialogInterface dialogInterface, int i) {
 688                                 fragment.logOut();
 689                             }
 690                         }
 691                     )
 692                     .setNeutralButton(R.string.export_unsynced_notes,
 693                         new DialogInterface.OnClickListener() {
 694                             @Override
 695                             public void onClick(DialogInterface dialogInterface, int i) {
 696                                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 697                                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 698                                 intent.setType(&quot;application/json&quot;);
<abbr title=" 699                                 intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));"> 699                                 intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_fiðŸ”µ</abbr>
 700                                 fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 701                             }
 702                         }
 703                     )
 704                     .setNegativeButton(R.string.cancel, null)
 705                     .show();
 706             } else {
 707                 fragment.logOut();
 708             }
 709         }
 710     }
 711 
 712     static class DeleteAccountRequestHandlerImpl implements DeleteAccountRequestHandler {
 713         final WeakReference&lt;PreferencesFragment&gt; preferencesFragment;
 714 
 715         DeleteAccountRequestHandlerImpl(PreferencesFragment fragment) {
 716             this.preferencesFragment = new WeakReference&lt;&gt;(fragment);
 717         }
 718 
 719         @Override
 720         public void onSuccess() {
 721             final PreferencesFragment fragment = preferencesFragment.get();
 722             if (fragment == null) {
 723                 return;
 724             }
 725 
 726             FragmentActivity activity = fragment.getActivity();
 727             if (activity == null) {
 728                 return;
 729             }
 730 
 731             AppLog.add(Type.ACCOUNT, &quot;Request to delete account was successful&quot;);
 732 
 733             activity.runOnUiThread(new Runnable() {
 734                 @Override
 735                 public void run() {
 736                     fragment.closeProgressDialogDeleteAccount();
 737                     fragment.showDeleteAccountConfirmationDialog();
 738                 }
 739             });
 740         }
 741 
 742         @Override
 743         public void onFailure() {
 744             final PreferencesFragment fragment = preferencesFragment.get();
 745             if (fragment == null) {
 746                 return;
 747             }
 748 
 749             FragmentActivity activity = fragment.getActivity();
 750             if (activity == null) {
 751                 return;
 752             }
 753 
 754             AppLog.add(Type.ACCOUNT, &quot;Failure while calling server to delete account&quot;);
 755 
 756             activity.runOnUiThread(new Runnable() {
 757                 @Override
 758                 public void run() {
 759                     fragment.closeProgressDialogDeleteAccount();
 760                     fragment.showDialogDeleteAccountError();
 761                 }
 762             });
 763         }
 764     }
 765 
 766     private void toast(int stringId) {
 767         toast(stringId, Toast.LENGTH_SHORT);
 768     }
 769 
 770     private void toast(int stringId, int length) {
 771         Toast.makeText(requireContext(), getString(stringId), length).show();
 772     }
 773 }
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.Fragment;
   5 import android.content.Context;
   6 import android.content.DialogInterface;
   7 import android.content.Intent;
   8 import android.net.Uri;
   9 import android.os.AsyncTask;
  10 import android.os.Bundle;
  11 import android.os.ParcelFileDescriptor;
  12 import android.widget.Toast;
  13 import androidx.appcompat.app.AlertDialog;
  14 import androidx.appcompat.view.ContextThemeWrapper;
  15 import androidx.core.app.ShareCompat;
  16 import androidx.core.content.ContextCompat;
  17 import androidx.fragment.app.FragmentActivity;
  18 import androidx.preference.ListPreference;
  19 import androidx.preference.Preference;
  20 import androidx.preference.PreferenceFragmentCompat;
  21 import androidx.preference.SwitchPreferenceCompat;
  22 import com.automattic.simplenote.analytics.AnalyticsTracker;
  23 import com.automattic.simplenote.authentication.SimplenoteAuthenticationActivity;
  24 import com.automattic.simplenote.models.Note;
  25 import com.automattic.simplenote.models.Preferences;
  26 import com.automattic.simplenote.utils.AccountNetworkUtils.DeleteAccountRequestHandler;
  27 import com.automattic.simplenote.utils.AccountNetworkUtils;
  28 import com.automattic.simplenote.utils.AppLog.Type;
  29 import com.automattic.simplenote.utils.AppLog;
  30 import com.automattic.simplenote.utils.AuthUtils;
  31 import com.automattic.simplenote.utils.BrowserUtils;
  32 import com.automattic.simplenote.utils.CrashUtils;
  33 import com.automattic.simplenote.utils.DialogUtils;
  34 import com.automattic.simplenote.utils.HtmlCompat;
  35 import com.automattic.simplenote.utils.PrefUtils;
  36 import com.automattic.simplenote.utils.SimplenoteProgressDialogFragment;
  37 import com.simperium.Simperium;
  38 import com.simperium.android.ProgressDialogFragment;
  39 import com.simperium.client.Bucket;
  40 import com.simperium.client.BucketObjectMissingException;
  41 import com.simperium.client.BucketObjectNameInvalid;
  42 import com.simperium.client.User;
  43 import java.io.FileOutputStream;
  44 import java.lang.ref.WeakReference;
  45 import java.util.Collections;
  46 import java.util.Comparator;
  47 import java.util.List;
  48 import org.json.JSONArray;
  49 import org.json.JSONObject;
  50 import static android.app.Activity.RESULT_OK;
  51 import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  52 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING;
  53 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING_LABEL;
  54 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING;
  55 import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING_LABEL;
  56 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING;
  57 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING_LABEL;
  58 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING;
  59 import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING_LABEL;
  60 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING;
  61 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING_LABEL;
  62 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING;
  63 import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING_LABEL;
  64 
  65 
  66 /**
  67  * A simple {@link Fragment} subclass.
  68  */
<abbr title="  69 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener , Simperium.OnUserCreatedListener {">  69 public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener , ðŸ”µ</abbr>
  70     public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  71 
  72     private static final int REQUEST_EXPORT_DATA = 9001;
  73 
  74     private static final int REQUEST_EXPORT_UNSYNCED = 9002;
  75 
  76     private static final int REQUEST_IMPORT_DATA = 9003;
  77 
  78     private Bucket&lt;Preferences&gt; mPreferencesBucket;
  79 
  80     private SwitchPreferenceCompat mAnalyticsSwitch;
  81 
  82     private SimplenoteProgressDialogFragment mProgressDialogFragment;
  83 
  84     public PreferencesFragment() {
  85         // Required empty public constructor
  86     }
  87 
  88     @Override
  89     public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  90         addPreferencesFromResource(R.xml.preferences);
  91     }
  92 
  93     @Override
  94     public void onActivityCreated(Bundle savedInstanceState) {
  95         super.onActivityCreated(savedInstanceState);
  96         Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  97         Simplenote currentApp = ((Simplenote) (getActivity().getApplication()));
  98         Simperium simperium = currentApp.getSimperium();
  99         simperium.setUserStatusChangeListener(this);
 100         simperium.setOnUserCreatedListener(this);
 101         mPreferencesBucket = currentApp.getPreferencesBucket();
 102         authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
 103         if (simperium.needsAuthorization()) {
 104             authenticatePreference.setTitle(R.string.log_in);
 105         } else {
 106             authenticatePreference.setTitle(R.string.log_out);
 107         }
 108         authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 109             @Override
 110             public boolean onPreferenceClick(Preference preference) {
 111                 if (!isAdded()) {
 112                     return false;
 113                 }
 114                 Simplenote currentApp = ((Simplenote) (getActivity().getApplication()));
 115                 if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 116                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);"> 116                     Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.classðŸ”µ</abbr>
 117                     startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 118                 } else {
 119                     new LogOutTask(PreferencesFragment.this).execute();
 120                 }
 121                 return true;
 122             }
 123         });
 124         Preference deleteAppPreference = findPreference(&quot;pref_key_delete_account&quot;);
 125         deleteAppPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 126             @Override
 127             public boolean onPreferenceClick(Preference preference) {
 128                 showDeleteAccountDialog();
 129                 return true;
 130             }
 131         });
<abbr title=" 132         findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 132         findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 133             @Override
 134             public boolean onPreferenceClick(Preference preference) {
 135                 try {
<abbr title=" 136                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;);"> 136                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;ðŸ”µ</abbr>
 137                 } catch (java.lang.Exception e) {
 138                     toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 139                 }
 140                 return true;
 141             }
 142         });
<abbr title=" 143         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 143         findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLðŸ”µ</abbr>
 144             @Override
 145             public boolean onPreferenceClick(Preference preference) {
 146                 try {
 147                     BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 148                 } catch (java.lang.Exception e) {
 149                     toast(R.string.no_browser_available, Toast.LENGTH_LONG);
 150                 }
 151                 return true;
 152             }
 153         });
<abbr title=" 154         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 154         findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLisðŸ”µ</abbr>
 155             @Override
 156             public boolean onPreferenceClick(Preference preference) {
 157                 startActivity(new Intent(getActivity(), AboutActivity.class));
 158                 return true;
 159             }
 160         });
<abbr title=" 161         findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 161         findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 162             @Override
 163             public boolean onPreferenceClick(Preference preference) {
 164                 Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
 165                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 166                 intent.setType(&quot;*/*&quot;);
 167                 intent.putExtra(Intent.EXTRA_MIME_TYPES, new String[]{ &quot;text/*&quot;, &quot;application/json&quot; });
 168                 startActivityForResult(intent, REQUEST_IMPORT_DATA);
 169                 return true;
 170             }
 171         });
<abbr title=" 172         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 172         findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickLiðŸ”µ</abbr>
 173             @Override
 174             public boolean onPreferenceClick(Preference preference) {
 175                 Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 176                 intent.addCategory(Intent.CATEGORY_OPENABLE);
 177                 intent.setType(&quot;application/json&quot;);
 178                 intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 179                 startActivityForResult(intent, REQUEST_EXPORT_DATA);
 180                 return true;
 181             }
 182         });
 183         final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 184         themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 185             @Override
 186             public boolean onPreferenceChange(Preference preference, Object newValue) {
 187                 updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 188                 return true;
 189             }
 190 
 191             private void updateTheme(Activity activity, int index) {
 192                 CharSequence[] entries = themePreference.getEntries();
 193                 themePreference.setSummary(entries[index]);
<abbr title=" 194                 AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED, AnalyticsTracker.CATEGORY_USER, &quot;theme_preference&quot;);"> 194                 AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED, AnalyticsTracker.CATðŸ”µ</abbr>
 195             }
 196         });
 197         final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
<abbr title=" 198         stylePreference.setSummary(PrefUtils.isPremium(requireContext()) ? PrefUtils.getStyleNameFromIndexSelected(requireContext()) : PrefUtils.getStyleNameDefault(requireContext()));"> 198         stylePreference.setSummary(PrefUtils.isPremium(requireContext()) ? PrefUtils.getStyleNameFromIndeðŸ”µ</abbr>
 199         stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 200             @Override
 201             public boolean onPreferenceClick(Preference preference) {
 202                 startActivity(new Intent(requireContext(), StyleActivity.class));
 203                 return true;
 204             }
 205         });
 206         final Preference membershipPreference = findPreference(&quot;pref_key_membership&quot;);
 207         membershipPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 208             @Override
 209             public boolean onPreferenceClick(Preference preference) {
 210                 ((PreferencesActivity) (requireActivity())).openBrowserForMembership(getView());
 211                 return true;
 212             }
 213         });
 214         if (PrefUtils.isPremium(requireContext())) {
 215             membershipPreference.setLayoutResource(R.layout.preference_default);
 216             membershipPreference.setSummary(R.string.membership_premium);
 217         } else {
 218             membershipPreference.setLayoutResource(R.layout.preference_button);
 219             membershipPreference.setSummary(R.string.membership_free);
 220         }
 221         final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 222         sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 223             @Override
 224             public boolean onPreferenceChange(Preference preference, Object newValue) {
 225                 int index = Integer.parseInt(newValue.toString());
 226                 CharSequence[] entries = sortPreference.getEntries();
 227                 sortPreference.setSummary(entries[index]);
 228                 if (!sortPreference.getValue().equals(newValue)) {
 229                     switch (index) {
 230                         case ALPHABETICAL_ASCENDING :
 231                             trackSortOrder(ALPHABETICAL_ASCENDING_LABEL);
 232                             break;
 233                         case ALPHABETICAL_DESCENDING :
 234                             trackSortOrder(ALPHABETICAL_DESCENDING_LABEL);
 235                             break;
 236                         case DATE_CREATED_ASCENDING :
 237                             trackSortOrder(DATE_CREATED_ASCENDING_LABEL);
 238                             break;
 239                         case DATE_CREATED_DESCENDING :
 240                             trackSortOrder(DATE_CREATED_DESCENDING_LABEL);
 241                             break;
 242                         case DATE_MODIFIED_ASCENDING :
 243                             trackSortOrder(DATE_MODIFIED_ASCENDING_LABEL);
 244                             break;
 245                         case DATE_MODIFIED_DESCENDING :
 246                             trackSortOrder(DATE_MODIFIED_DESCENDING_LABEL);
 247                             break;
 248                     }
 249                 }
 250                 return true;
 251             }
 252         });
 253         SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 254         switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 255             @Override
 256             public boolean onPreferenceChange(Preference preference, Object o) {
 257                 if (((SwitchPreferenceCompat) (preference)).isChecked()) {
<abbr title=" 258                     AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED, AnalyticsTracker.CATEGORY_USER, &quot;condensed_list_preference&quot;);"> 258                     AnalyticsTracker.track(AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED, AnalytiðŸ”µ</abbr>
 259                 }
 260                 return true;
 261             }
 262         });
 263         // Add the hyperlink to the analytics summary
 264         Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
<abbr title=" 265         String formattedSummary = String.format(getString(R.string.share_analytics_summary), &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;, &quot;&lt;/a&gt;&quot;);"> 265         String formattedSummary = String.format(getString(R.string.share_analytics_summary), &quot;&lt;a href=\&quot;hðŸ”µ</abbr>
 266         analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 267         mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 268         mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 269             @Override
 270             public boolean onPreferenceChange(Preference preference, Object newValue) {
 271                 try {
 272                     boolean isChecked = ((boolean) (newValue));
 273                     Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 274                     prefs.setAnalyticsEnabled(isChecked);
 275                     prefs.save();
 276                 } catch (BucketObjectMissingException e) {
 277                     e.printStackTrace();
 278                 }
 279                 return true;
 280             }
 281         });
 282         updateAnalyticsSwitchState();
<abbr title=" 283         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 283         findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListðŸ”µ</abbr>
 284             @Override
 285             public boolean onPreferenceClick(Preference preference) {
<abbr title=" 286                 startActivity(ShareCompat.IntentBuilder.from(requireActivity()).setText(AppLog.get()).setType(&quot;text/plain&quot;).createChooserIntent());"> 286                 startActivity(ShareCompat.IntentBuilder.from(requireActivity()).setText(AppLog.get()).setðŸ”µ</abbr>
 287                 return true;
 288             }
 289         });
 290     }
 291 
 292     private void showProgressDialogDeleteAccount() {
 293         FragmentActivity activity = getActivity();
 294         if (activity == null) {
 295             return;
 296         }
 297 
<abbr title=" 298         mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requesting_message));"> 298         mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requestðŸ”µ</abbr>
 299         mProgressDialogFragment.show(activity.getSupportFragmentManager(), ProgressDialogFragment.TAG);
 300     }
 301 
 302     private void closeProgressDialogDeleteAccount() {
 303         if (mProgressDialogFragment != null &amp;&amp; !mProgressDialogFragment.isHidden()) {
 304             mProgressDialogFragment.dismiss();
 305             mProgressDialogFragment = null;
 306         }
 307     }
 308 
 309     private void showDeleteAccountDialog() {
 310         Context context = getContext();
 311         if (context == null) {
 312             return;
 313         }
 314 
<abbr title=" 315         final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(this);"> 315         final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(thisðŸ”µ</abbr>
 316 
<abbr title=" 317         final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, R.style.Dialog))"> 317         final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, ðŸ”µ</abbr>
 318                 .setTitle(R.string.delete_account)
 319                 .setMessage(R.string.delete_account_message)
 320                 .setPositiveButton(R.string.delete_account, new DialogInterface.OnClickListener() {
 321                         @Override
 322                         public void onClick(DialogInterface dialogInterface, int i) {
 323                             FragmentActivity activity = getActivity();
 324                             if (activity == null) {
 325                                 return;
 326                             }
 327 
 328                             showProgressDialogDeleteAccount();
 329 
 330                             Simplenote currentApp = (Simplenote) activity.getApplication();
 331                             Simperium simperium = currentApp.getSimperium();
 332                             String userEmail = simperium.getUser().getEmail();
 333                             String userToken = simperium.getUser().getAccessToken();
 334 
 335                             // makeDeleteAccountRequest can throw an exception when it cannot build
 336                             // the JSON object. In those cases, we show the error dialog since
 337                             // it can be related to memory constraints or something else that is
 338                             // just a transient fault
 339                             try {
 340                                 AppLog.add(Type.ACCOUNT, &quot;Making request to delete account&quot;);
 341 
 342                                 AccountNetworkUtils.makeDeleteAccountRequest(
 343                                         userEmail,
 344                                         userToken,
 345                                         deleteAccountHandler);
 346                             } catch (IllegalArgumentException exception) {
 347                                 AppLog.add(Type.ACCOUNT, &quot;Error trying to make request &quot; +
 348                                         &quot;to delete account. Error: &quot; + exception.getMessage());
 349 
 350                                 showDialogDeleteAccountError();
 351                             }
 352                         }
 353                     }
 354                 )
 355                 .setNegativeButton(R.string.cancel, null)
 356                 .create();
 357 
 358         dialogDeleteAccount.setOnShowListener(new DialogInterface.OnShowListener() {
 359             @Override
 360             public void onShow(DialogInterface dialog) {
 361                 FragmentActivity activity = getActivity();
 362                 if (activity == null) {
 363                     return;
 364                 }
 365 
 366                 int colorRed = ContextCompat.getColor(activity, R.color.text_button_red);
 367                 dialogDeleteAccount
 368                         .getButton(AlertDialog.BUTTON_POSITIVE)
 369                         .setTextColor(colorRed);
 370             }
 371         });
 372         dialogDeleteAccount.show();
 373     }
 374 
 375     private void showDialogDeleteAccountError() {
 376         Context context = getContext();
 377         if (context == null) {
 378             return;
 379         }
 380 
 381         DialogUtils.showDialogWithEmail(
 382                 context,
 383                 getString(R.string.error_ocurred_message)
 384         );
 385     }
 386 
 387     private void showDeleteAccountConfirmationDialog() {
 388         FragmentActivity activity = getActivity();
 389         if (activity == null) {
 390             return;
 391         }
 392 
 393         Simplenote currentApp = (Simplenote) activity.getApplication();
 394         Simperium simperium = currentApp.getSimperium();
 395         String userEmail = simperium.getUser().getEmail();
 396 
 397         AlertDialog dialogDeleteAccountConfirmation = new AlertDialog.Builder(
 398                 new ContextThemeWrapper(activity, R.style.Dialog))
 399                 .setTitle(R.string.request_received)
 400                 .setMessage(getString(R.string.account_deletion_message, userEmail))
 401                 .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {
 402                             @Override
 403                             public void onClick(DialogInterface dialogInterface, int i) {
 404                                 dialogInterface.dismiss();
 405                             }
 406                         }
 407                 )
 408                 .create();
 409 
 410         dialogDeleteAccountConfirmation.show();
 411     }
 412 
 413     @Override
 414     public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 415         if ((resultCode != RESULT_OK) || (resultData == null)) {
 416             return;
 417         }
 418         if (resultData.getData() == null) {
 419             toast(R.string.export_message_failure);
 420             return;
 421         }
 422         switch (requestCode) {
 423             case REQUEST_EXPORT_DATA :
 424                 exportData(resultData.getData(), false);
 425                 break;
 426             case REQUEST_EXPORT_UNSYNCED :
 427                 exportData(resultData.getData(), true);
 428                 break;
 429             case REQUEST_IMPORT_DATA :
 430                 importData(resultData.getData());
 431                 break;
 432         }
 433     }
 434 
 435     private boolean hasUnsyncedNotes() {
 436         Simplenote application = (Simplenote) getActivity().getApplication();
 437         Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 438         Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 439         while (notesCursor.moveToNext()) {
 440             Note note = notesCursor.getObject();
 441             if (note.isNew() || note.isModified()) {
 442                 return true;
 443             }
 444         }
 445 
 446         return false;
 447     }
 448 
 449     private void logOut() {
 450         AppLog.add(Type.ACTION, &quot;Tapped logout button (PreferencesFragment)&quot;);
 451         AnalyticsTracker.track(
 452                 AnalyticsTracker.Stat.USER_SIGNED_OUT,
 453                 AnalyticsTracker.CATEGORY_USER,
 454                 &quot;preferences_sign_out_button&quot;
 455         );
 456 
 457         AuthUtils.logOut((Simplenote) requireActivity().getApplication());
 458 
 459         getActivity().finish();
 460     }
 461 
 462     @Override
 463     public void onUserStatusChange(User.Status status) {
 464         if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 465             // User signed in
 466             getActivity().runOnUiThread(new Runnable() {
 467                 public void run() {
 468                     Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 469                     authenticatePreference.setTitle(R.string.log_out);
 470                 }
 471             });
 472 
 473             Simplenote app = (Simplenote) getActivity().getApplication();
 474             AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 475             CrashUtils.setCurrentUser(app.getSimperium().getUser());
 476 
 477             AnalyticsTracker.track(
 478                     AnalyticsTracker.Stat.USER_SIGNED_IN,
 479                     AnalyticsTracker.CATEGORY_USER,
 480                     &quot;signed_in_from_preferences_activity&quot;
 481             );
 482         }
 483     }
 484 
 485     @Override
 486     public void onUserCreated(User user) {
 487         AnalyticsTracker.track(
 488                 AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 489                 AnalyticsTracker.CATEGORY_USER,
 490                 &quot;account_created_from_preferences_activity&quot;
 491         );
 492     }
 493 
 494     private void exportData(Uri uri, boolean isUnsyncedNotes) {
 495         Simplenote currentApp = ((Simplenote) (requireActivity().getApplication()));
 496         Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 497         JSONObject account = new JSONObject();
 498         Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 499         try {
 500             JSONArray activeNotes = new JSONArray();
 501             JSONArray trashedNotes = new JSONArray();
 502             Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 503                 @Override
 504                 public int compare(String text1, String text2) {
 505                     return text1.compareToIgnoreCase(text2);
 506                 }
 507             };
 508             while (cursor.moveToNext()) {
 509                 Note note = cursor.getObject();
 510                 if ((isUnsyncedNotes &amp;&amp; (!note.isNew())) &amp;&amp; (!note.isModified())) {
 511                     continue;
 512                 }
 513                 JSONObject noteJson = new JSONObject();
 514                 noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 515                 noteJson.put(&quot;content&quot;, note.getContent());
 516                 noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 517                 noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 518                 if (note.isPinned()) {
 519                     noteJson.put(&quot;pinned&quot;, note.isPinned());
 520                 }
 521                 if (note.isMarkdownEnabled()) {
 522                     noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 523                 }
 524                 if (note.getTags().size() &gt; 0) {
 525                     List&lt;String&gt; tags = note.getTags();
 526                     Collections.sort(tags, comparator);
 527                     noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 528                 }
 529                 if (!note.getPublishedUrl().isEmpty()) {
 530                     noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 531                 }
 532                 if (note.isDeleted()) {
 533                     trashedNotes.put(noteJson);
 534                 } else {
 535                     activeNotes.put(noteJson);
 536                 }
 537             }
 538             account.put(&quot;activeNotes&quot;, activeNotes);
 539             account.put(&quot;trashedNotes&quot;, trashedNotes);
<abbr title=" 540             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 540             ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDesðŸ”µ</abbr>
 541             if (parcelFileDescriptor != null) {
<abbr title=" 542                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 542                 FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescðŸ”µ</abbr>
 543                 fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;, &quot;/&quot;).getBytes());
 544                 parcelFileDescriptor.close();
 545                 toast(R.string.export_message_success);
 546             } else {
 547                 toast(R.string.export_message_failure);
 548             }
 549         } catch (java.lang.Exception e) {
 550             toast(R.string.export_message_failure);
 551         }
 552     }
 553 
 554     private void importData(Uri uri) {
 555         try {
 556             Importer.fromUri(this, uri);
 557             toast(R.string.import_message_success);
 558         } catch (Importer.ImportException e) {
 559             switch (e.getReason()) {
 560                 case FileError:
 561                     toast(R.string.import_error_file);
 562                     break;
 563                 case ParseError:
 564                     toast(R.string.import_error_parse);
 565                     break;
 566                 case UnknownExportType:
 567                     toast(R.string.import_unknown);
 568                     break;
 569             }
 570         }
 571     }
 572 
 573     private void trackSortOrder(String label) {
 574         AnalyticsTracker.track(
 575             AnalyticsTracker.Stat.SETTINGS_SEARCH_SORT_MODE,
 576             AnalyticsTracker.CATEGORY_SETTING,
 577             label
 578         );
 579     }
 580 
 581     private void updateAnalyticsSwitchState() {
 582         try {
 583             Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 584             mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 585         } catch (BucketObjectMissingException e) {
 586             // The preferences object doesn&#x27;t exist for this user yet, create it
 587             try {
 588                 Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 589                 prefs.setAnalyticsEnabled(true);
 590                 prefs.save();
 591             } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 592                 bucketObjectNameInvalid.printStackTrace();
 593             }
 594         }
 595     }
 596 
 597     private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 598         private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 599 
 600         LogOutTask(PreferencesFragment fragment) {
 601             mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 602         }
 603 
 604         @Override
 605         protected Boolean doInBackground(Void... voids) {
 606             PreferencesFragment fragment = mPreferencesFragmentReference.get();
 607             return (fragment == null) || fragment.hasUnsyncedNotes();
 608         }
 609 
 610         @Override
 611         protected void onPostExecute(Boolean hasUnsyncedNotes) {
 612             final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 613             if (fragment == null) {
 614                 return;
 615             }
 616             // Safety first! Check if any notes are unsynced and warn the user if so.
 617             if (hasUnsyncedNotes) {
<abbr title=" 618                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog)).setTitle(R.string.unsynced_notes).setMessage(R.string.unsynced_notes_message).setPositiveButton(R.string.log_out_anyway, new DialogInterface.OnClickListener() {"> 618                 new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.DialogðŸ”µ</abbr>
 619                     @Override
 620                     public void onClick(DialogInterface dialogInterface, int i) {
 621                         fragment.logOut();
 622                     }
<abbr title=" 623                 }).setNeutralButton(R.string.export_unsynced_notes, new DialogInterface.OnClickListener() {"> 623                 }).setNeutralButton(R.string.export_unsynced_notes, new DialogInterface.OnClickListener()ðŸ”µ</abbr>
 624                     @Override
 625                     public void onClick(DialogInterface dialogInterface, int i) {
 626                         Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 627                         intent.addCategory(Intent.CATEGORY_OPENABLE);
 628                         intent.setType(&quot;application/json&quot;);
 629                         intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));
 630                         fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 631                     }
 632                 }).setNegativeButton(R.string.cancel, null).show();
 633             } else {
 634                 fragment.logOut();
 635             }
 636         }
 637     }
 638 
 639     static class DeleteAccountRequestHandlerImpl implements DeleteAccountRequestHandler {
 640         final WeakReference&lt;PreferencesFragment&gt; preferencesFragment;
 641 
 642         DeleteAccountRequestHandlerImpl(PreferencesFragment fragment) {
 643             this.preferencesFragment = new WeakReference&lt;&gt;(fragment);
 644         }
 645 
 646         @Override
 647         public void onSuccess() {
 648             final PreferencesFragment fragment = preferencesFragment.get();
 649             if (fragment == null) {
 650                 return;
 651             }
 652             FragmentActivity activity = fragment.getActivity();
 653             if (activity == null) {
 654                 return;
 655             }
 656             AppLog.add(Type.ACCOUNT, &quot;Request to delete account was successful&quot;);
 657             activity.runOnUiThread(new Runnable() {
 658                 @Override
 659                 public void run() {
 660                     fragment.closeProgressDialogDeleteAccount();
 661                     fragment.showDeleteAccountConfirmationDialog();
 662                 }
 663             });
 664         }
 665 
 666         @Override
 667         public void onFailure() {
 668             final PreferencesFragment fragment = preferencesFragment.get();
 669             if (fragment == null) {
 670                 return;
 671             }
 672             FragmentActivity activity = fragment.getActivity();
 673             if (activity == null) {
 674                 return;
 675             }
 676             AppLog.add(Type.ACCOUNT, &quot;Failure while calling server to delete account&quot;);
 677             activity.runOnUiThread(new Runnable() {
 678                 @Override
 679                 public void run() {
 680                     fragment.closeProgressDialogDeleteAccount();
 681                     fragment.showDialogDeleteAccountError();
 682                 }
 683             });
 684         }
 685     }
 686 
 687     private void toast(int stringId) {
 688         toast(stringId, Toast.LENGTH_SHORT);
 689     }
 690 
 691     private void toast(int stringId, int length) {
 692         Toast.makeText(requireContext(), getString(stringId), length).show();
 693     }
 694 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.Fragment;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   5 +import android.content.Context;</span>
   6  import android.content.DialogInterface;
   7  import android.content.Intent;
   8  import android.net.Uri;
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;
  11  import android.os.ParcelFileDescriptor;
  12  import android.widget.Toast;
  13  
  14  import androidx.appcompat.app.AlertDialog;
  15  import androidx.appcompat.view.ContextThemeWrapper;
  16  import androidx.core.app.ShareCompat;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  17 +import androidx.core.content.ContextCompat;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  18 +import androidx.fragment.app.FragmentActivity;</span>
  19  import androidx.preference.ListPreference;
  20  import androidx.preference.Preference;
  21  import androidx.preference.PreferenceFragmentCompat;
  22  import androidx.preference.SwitchPreferenceCompat;
  23  
  24  import com.automattic.simplenote.analytics.AnalyticsTracker;
  25  import com.automattic.simplenote.authentication.SimplenoteAuthenticationActivity;
  26  import com.automattic.simplenote.models.Note;
  27  import com.automattic.simplenote.models.Preferences;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  28 +import com.automattic.simplenote.utils.AccountNetworkUtils;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import com.automattic.simplenote.utils.AccountNetworkUtils.DeleteAccountRequestHandler;</span>
  30  import com.automattic.simplenote.utils.AppLog;
  31  import com.automattic.simplenote.utils.AppLog.Type;
  32  import com.automattic.simplenote.utils.AuthUtils;
  33  import com.automattic.simplenote.utils.BrowserUtils;
  34  import com.automattic.simplenote.utils.CrashUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  35 +import com.automattic.simplenote.utils.DialogUtils;</span>
  36  import com.automattic.simplenote.utils.HtmlCompat;
  37  import com.automattic.simplenote.utils.PrefUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  38 +import com.automattic.simplenote.utils.SimplenoteProgressDialogFragment;</span>
  39  import com.simperium.Simperium;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import com.simperium.android.ProgressDialogFragment;</span>
  41  import com.simperium.client.Bucket;
  42  import com.simperium.client.BucketObjectMissingException;
  43  import com.simperium.client.BucketObjectNameInvalid;
  44  import com.simperium.client.User;
  45  
  46  import org.json.JSONArray;
  47  import org.json.JSONObject;
  48  
  49  import java.io.FileOutputStream;
  50  import java.lang.ref.WeakReference;
  51  import java.util.Collections;
  52  import java.util.Comparator;
  53  import java.util.List;
  54  
  55  import static android.app.Activity.RESULT_OK;
  56  import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  57  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING;
  58  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING_LABEL;
  59  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING;
  60  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING_LABEL;
  61  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING;
  62  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING_LABEL;
  63  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING;
  64  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING_LABEL;
  65  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING;
  66  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING_LABEL;
  67  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING;
  68  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING_LABEL;
  69  
  70  /**
  71   * A simple {@link Fragment} subclass.
  72   */
<abbr title="  73  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.OnUserCreatedListener {">  73  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.ðŸ”µ</abbr>
  74      public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  75  
  76      private static final int REQUEST_EXPORT_DATA = 9001;
  77      private static final int REQUEST_EXPORT_UNSYNCED = 9002;

  78  
  79      private Bucket&lt;Preferences&gt; mPreferencesBucket;
  80      private SwitchPreferenceCompat mAnalyticsSwitch;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +    private SimplenoteProgressDialogFragment mProgressDialogFragment;</span>
  82  
  83      public PreferencesFragment() {
  84          // Required empty public constructor
  85      }
  86  
  87      @Override
  88      public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  89          addPreferencesFromResource(R.xml.preferences);
  90      }
  91  
  92      @Override
  93      public void onActivityCreated(Bundle savedInstanceState) {
  94          super.onActivityCreated(savedInstanceState);
  95  
  96          Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  97          Simplenote currentApp = (Simplenote) getActivity().getApplication();
  98          Simperium simperium = currentApp.getSimperium();
  99          simperium.setUserStatusChangeListener(this);
 100          simperium.setOnUserCreatedListener(this);
 101          mPreferencesBucket = currentApp.getPreferencesBucket();
 102  
 103          authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
 104          if (simperium.needsAuthorization()) {
 105              authenticatePreference.setTitle(R.string.log_in);
 106          } else {
 107              authenticatePreference.setTitle(R.string.log_out);
 108          }
 109  
 110          authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 111              @Override
 112              public boolean onPreferenceClick(Preference preference) {
 113                  if (!isAdded()) {
 114                      return false;
 115                  }
 116  
 117                  Simplenote currentApp = (Simplenote) getActivity().getApplication();
 118                  if (currentApp.getSimperium().needsAuthorization()) {
 119                      Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);
 120                      startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 121                  } else {
 122                      new LogOutTask(PreferencesFragment.this).execute();
 123                  }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +        Preference deleteAppPreference = findPreference(&quot;pref_key_delete_account&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        deleteAppPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +            public boolean onPreferenceClick(Preference preference) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +                showDeleteAccountDialog();</span>
 133                  return true;
 134              }
 135          });
 136  
 137          findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 138              @Override
 139              public boolean onPreferenceClick(Preference preference) {
 140                  try {
 141                      BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;);
 142                  } catch (Exception e) {
 143                      Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();

 144                  }
 145                  return true;
 146              }
 147          });
 148  
<abbr title=" 149          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 149          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener()ðŸ”µ</abbr>
 150              @Override
 151              public boolean onPreferenceClick(Preference preference) {
 152                  try {
 153                      BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 154                  } catch (Exception e) {
 155                      Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();

 156                  }
 157                  return true;
 158              }
 159          });
 160  
 161          findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 162              @Override
 163              public boolean onPreferenceClick(Preference preference) {
 164                  startActivity(new Intent(getActivity(), AboutActivity.class));












 165                  return true;
 166              }
 167          });
 168  
<abbr title=" 169          findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 169          findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() ðŸ”µ</abbr>
 170              @Override
 171              public boolean onPreferenceClick(Preference preference) {
 172                  Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 173                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 174                  intent.setType(&quot;application/json&quot;);
 175                  intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 176                  startActivityForResult(intent, REQUEST_EXPORT_DATA);
 177                  return true;
 178              }
 179          });
 180  
 181          final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 182          themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 183              @Override
 184              public boolean onPreferenceChange(Preference preference, Object newValue) {
 185                  updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 186                  return true;
 187              }
 188  
 189              private void updateTheme(Activity activity, int index) {
 190                  CharSequence[] entries = themePreference.getEntries();
 191                  themePreference.setSummary(entries[index]);
 192  
 193                  AnalyticsTracker.track(
 194                          AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 195                          AnalyticsTracker.CATEGORY_USER,
 196                          &quot;theme_preference&quot;
 197                  );
 198              }
 199          });
 200  
 201          final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
 202          stylePreference.setSummary(
 203              PrefUtils.isPremium(requireContext()) ?
 204                  PrefUtils.getStyleNameFromIndexSelected(requireContext()) :
 205                  PrefUtils.getStyleNameDefault(requireContext())
 206          );
 207          stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 208              @Override
 209              public boolean onPreferenceClick(Preference preference) {
 210                  startActivity(new Intent(requireContext(), StyleActivity.class));
 211                  return true;
 212              }
 213          });
 214  
 215          final Preference membershipPreference = findPreference(&quot;pref_key_membership&quot;);
 216          membershipPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 217              @Override
 218              public boolean onPreferenceClick(Preference preference) {
 219                  ((PreferencesActivity) requireActivity()).openBrowserForMembership(getView());
 220                  return true;
 221              }
 222          });
 223  
 224          if (PrefUtils.isPremium(requireContext())) {
 225              membershipPreference.setLayoutResource(R.layout.preference_default);
 226              membershipPreference.setSummary(R.string.membership_premium);
 227          } else {
 228              membershipPreference.setLayoutResource(R.layout.preference_button);
 229              membershipPreference.setSummary(R.string.membership_free);
 230          }
 231  
 232          final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 233          sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 234              @Override
 235              public boolean onPreferenceChange(Preference preference, Object newValue) {
 236                  int index = Integer.parseInt(newValue.toString());
 237                  CharSequence[] entries = sortPreference.getEntries();
 238                  sortPreference.setSummary(entries[index]);
 239  
 240                  if (!sortPreference.getValue().equals(newValue)) {
 241                      switch (index) {
 242                          case ALPHABETICAL_ASCENDING:
 243                              trackSortOrder(ALPHABETICAL_ASCENDING_LABEL);
 244                              break;
 245                          case ALPHABETICAL_DESCENDING:
 246                              trackSortOrder(ALPHABETICAL_DESCENDING_LABEL);
 247                              break;
 248                          case DATE_CREATED_ASCENDING:
 249                              trackSortOrder(DATE_CREATED_ASCENDING_LABEL);
 250                              break;
 251                          case DATE_CREATED_DESCENDING:
 252                              trackSortOrder(DATE_CREATED_DESCENDING_LABEL);
 253                              break;
 254                          case DATE_MODIFIED_ASCENDING:
 255                              trackSortOrder(DATE_MODIFIED_ASCENDING_LABEL);
 256                              break;
 257                          case DATE_MODIFIED_DESCENDING:
 258                              trackSortOrder(DATE_MODIFIED_DESCENDING_LABEL);
 259                              break;
 260                      }
 261                  }
 262  
 263                  return true;
 264              }
 265          });
 266  
 267          SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 268          switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 269              @Override
 270              public boolean onPreferenceChange(Preference preference, Object o) {
 271                  if (((SwitchPreferenceCompat) preference).isChecked()) {
 272                      AnalyticsTracker.track(
 273                              AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 274                              AnalyticsTracker.CATEGORY_USER,
 275                              &quot;condensed_list_preference&quot;
 276                      );
 277                  }
 278  
 279                  return true;
 280              }
 281          });
 282  
 283          // Add the hyperlink to the analytics summary
 284          Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 285          String formattedSummary = String.format(
 286                  getString(R.string.share_analytics_summary),
 287                  &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 288                  &quot;&lt;/a&gt;&quot;
 289          );
 290          analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 291  
 292          mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 293          mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 294              @Override
 295              public boolean onPreferenceChange(Preference preference, Object newValue) {
 296                  try {
 297                      boolean isChecked = (boolean)newValue;
 298                      Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 299                      prefs.setAnalyticsEnabled(isChecked);
 300                      prefs.save();
 301                  } catch (BucketObjectMissingException e) {
 302                      e.printStackTrace();
 303                  }
 304  
 305                  return true;
 306              }
 307          });
 308  
 309          updateAnalyticsSwitchState();
 310  
 311          findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 312              @Override
 313              public boolean onPreferenceClick(Preference preference) {
 314                  startActivity(
 315                      ShareCompat.IntentBuilder.from(requireActivity())
 316                          .setText(AppLog.get())
 317                          .setType(&quot;text/plain&quot;)
 318                          .createChooserIntent()
 319                  );
 320                  return true;
 321              }
 322          });
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +    private void showProgressDialogDeleteAccount() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +        FragmentActivity activity = getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +        if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 331 +        mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requesting_message));"> 331 +        mProgressDialogFragment = SimplenoteProgressDialogFragment.newInstance(getString(R.string.requesting_messaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +        mProgressDialogFragment.show(activity.getSupportFragmentManager(), ProgressDialogFragment.TAG);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +    private void closeProgressDialogDeleteAccount() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +        if (mProgressDialogFragment != null &amp;&amp; !mProgressDialogFragment.isHidden()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +            mProgressDialogFragment.dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +            mProgressDialogFragment = null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +    private void showDeleteAccountDialog() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +        Context context = getContext();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +        if (context == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +        final DeleteAccountRequestHandler deleteAccountHandler = new DeleteAccountRequestHandlerImpl(this);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 350 +        final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, R.style.Dialog))"> 350 +        final AlertDialog dialogDeleteAccount = new AlertDialog.Builder(new ContextThemeWrapper(context, R.style.DðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +                .setTitle(R.string.delete_account)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +                .setMessage(R.string.delete_account_message)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +                .setPositiveButton(R.string.delete_account, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +                        @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +                        public void onClick(DialogInterface dialogInterface, int i) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +                            FragmentActivity activity = getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +                            if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +                                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +                            showProgressDialogDeleteAccount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +                            Simplenote currentApp = (Simplenote) activity.getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +                            Simperium simperium = currentApp.getSimperium();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +                            String userEmail = simperium.getUser().getEmail();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +                            String userToken = simperium.getUser().getAccessToken();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +                            // makeDeleteAccountRequest can throw an exception when it cannot build</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +                            // the JSON object. In those cases, we show the error dialog since</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 370 +                            // it can be related to memory constraints or something else that is</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 371 +                            // just a transient fault</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 372 +                            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 373 +                                AppLog.add(Type.ACCOUNT, &quot;Making request to delete account&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 374 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +                                AccountNetworkUtils.makeDeleteAccountRequest(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 376 +                                        userEmail,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +                                        userToken,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +                                        deleteAccountHandler);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +                            } catch (IllegalArgumentException exception) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +                                AppLog.add(Type.ACCOUNT, &quot;Error trying to make request &quot; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +                                        &quot;to delete account. Error: &quot; + exception.getMessage());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +                                showDialogDeleteAccountError();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 386 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 387 +                )</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 388 +                .setNegativeButton(R.string.cancel, null)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +                .create();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +        dialogDeleteAccount.setOnShowListener(new DialogInterface.OnShowListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +            public void onShow(DialogInterface dialog) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +                FragmentActivity activity = getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +                if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +                    return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 398 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 399 +                int colorRed = ContextCompat.getColor(activity, R.color.text_button_red);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +                dialogDeleteAccount</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +                        .getButton(AlertDialog.BUTTON_POSITIVE)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +                        .setTextColor(colorRed);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 404 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +        dialogDeleteAccount.show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 407 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 408 +    private void showDialogDeleteAccountError() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +        Context context = getContext();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 410 +        if (context == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 414 +        DialogUtils.showDialogWithEmail(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 415 +                context,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 416 +                getString(R.string.error_ocurred_message)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +        );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 420 +    private void showDeleteAccountConfirmationDialog() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 421 +        FragmentActivity activity = getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +        if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +            return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 424 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 425 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 426 +        Simplenote currentApp = (Simplenote) activity.getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 427 +        Simperium simperium = currentApp.getSimperium();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 428 +        String userEmail = simperium.getUser().getEmail();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 429 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 430 +        AlertDialog dialogDeleteAccountConfirmation = new AlertDialog.Builder(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 431 +                new ContextThemeWrapper(activity, R.style.Dialog))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 432 +                .setTitle(R.string.request_received)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 433 +                .setMessage(getString(R.string.account_deletion_message, userEmail))</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 434 +                .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 435 +                            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 436 +                            public void onClick(DialogInterface dialogInterface, int i) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 437 +                                dialogInterface.dismiss();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 438 +                            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 439 +                        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 440 +                )</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 441 +                .create();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 442 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 443 +        dialogDeleteAccountConfirmation.show();</span>
 444      }
 445  
 446      @Override
 447      public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 448          if (resultCode != RESULT_OK || resultData == null) {
 449              return;
 450          }
 451  
 452          if (resultData.getData() == null) {
<abbr title=" 453              Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 453              Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show(ðŸ”µ</abbr>

 454              return;
 455          }
 456  
 457          switch (requestCode) {
 458              case REQUEST_EXPORT_DATA:
 459                  exportData(resultData.getData(), false);
 460                  break;
 461              case REQUEST_EXPORT_UNSYNCED:
 462                  exportData(resultData.getData(), true);



 463                  break;
 464          }
 465      }
 466  
 467      private boolean hasUnsyncedNotes() {
 468          Simplenote application = (Simplenote) getActivity().getApplication();
 469          Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 470          Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 471          while (notesCursor.moveToNext()) {
 472              Note note = notesCursor.getObject();
 473              if (note.isNew() || note.isModified()) {
 474                  return true;
 475              }
 476          }
 477  
 478          return false;
 479      }
 480  
 481      private void logOut() {
 482          AppLog.add(Type.ACTION, &quot;Tapped logout button (PreferencesFragment)&quot;);
 483          AnalyticsTracker.track(
 484                  AnalyticsTracker.Stat.USER_SIGNED_OUT,
 485                  AnalyticsTracker.CATEGORY_USER,
 486                  &quot;preferences_sign_out_button&quot;
 487          );
 488  
 489          AuthUtils.logOut((Simplenote) requireActivity().getApplication());
 490  
 491          getActivity().finish();
 492      }
 493  
 494      @Override
 495      public void onUserStatusChange(User.Status status) {
 496          if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 497              // User signed in
 498              getActivity().runOnUiThread(new Runnable() {
 499                  public void run() {
 500                      Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 501                      authenticatePreference.setTitle(R.string.log_out);
 502                  }
 503              });
 504  
 505              Simplenote app = (Simplenote) getActivity().getApplication();
 506              AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 507              CrashUtils.setCurrentUser(app.getSimperium().getUser());
 508  
 509              AnalyticsTracker.track(
 510                      AnalyticsTracker.Stat.USER_SIGNED_IN,
 511                      AnalyticsTracker.CATEGORY_USER,
 512                      &quot;signed_in_from_preferences_activity&quot;
 513              );
 514          }
 515      }
 516  
 517      @Override
 518      public void onUserCreated(User user) {
 519          AnalyticsTracker.track(
 520                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 521                  AnalyticsTracker.CATEGORY_USER,
 522                  &quot;account_created_from_preferences_activity&quot;
 523          );
 524      }
 525  
 526      private void exportData(Uri uri, boolean isUnsyncedNotes) {
 527          Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 528          Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 529          JSONObject account = new JSONObject();
 530          Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 531  
 532          try {
 533              JSONArray activeNotes = new JSONArray();
 534              JSONArray trashedNotes = new JSONArray();
 535              Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 536                  @Override
 537                  public int compare(String text1, String text2) {
 538                      return text1.compareToIgnoreCase(text2);
 539                  }
 540              };
 541  
 542              while (cursor.moveToNext()) {
 543                  Note note = cursor.getObject();
 544  
 545                  if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 546                      continue;
 547                  }
 548  
 549                  JSONObject noteJson = new JSONObject();
 550  
 551                  noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 552                  noteJson.put(&quot;content&quot;, note.getContent());
 553                  noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 554                  noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 555  
 556                  if (note.isPinned()) {
 557                      noteJson.put(&quot;pinned&quot;, note.isPinned());
 558                  }
 559  
 560                  if (note.isMarkdownEnabled()) {
 561                      noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 562                  }
 563  
 564                  if (note.getTags().size() &gt; 0) {
 565                      List&lt;String&gt; tags = note.getTags();
 566                      Collections.sort(tags, comparator);
 567                      noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 568                  }
 569  
 570                  if (!note.getPublishedUrl().isEmpty()) {
 571                      noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 572                  }
 573  
 574                  if (note.isDeleted()) {
 575                      trashedNotes.put(noteJson);
 576                  } else {
 577                      activeNotes.put(noteJson);
 578                  }
 579              }
 580  
 581              account.put(&quot;activeNotes&quot;, activeNotes);
 582              account.put(&quot;trashedNotes&quot;, trashedNotes);
 583  
<abbr title=" 584              ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 584              ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uðŸ”µ</abbr>
 585  
 586              if (parcelFileDescriptor != null) {
<abbr title=" 587                  FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 587                  FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor())ðŸ”µ</abbr>
 588                  fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 589                  parcelFileDescriptor.close();
<abbr title=" 590                  Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTH_SHORT).show();"> 590                  Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTH_SHORT).sðŸ”µ</abbr>

 591              } else {
<abbr title=" 592                  Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 592                  Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).sðŸ”µ</abbr>

 593              }
 594          } catch (Exception e) {
<abbr title=" 595              Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 595              Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show(ðŸ”µ</abbr>




















 596          }
 597      }
 598  
 599      private void trackSortOrder(String label) {
 600          AnalyticsTracker.track(
 601              AnalyticsTracker.Stat.SETTINGS_SEARCH_SORT_MODE,
 602              AnalyticsTracker.CATEGORY_SETTING,
 603              label
 604          );
 605      }
 606  
 607      private void updateAnalyticsSwitchState() {
 608          try {
 609              Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 610              mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 611          } catch (BucketObjectMissingException e) {
 612              // The preferences object doesn&#x27;t exist for this user yet, create it
 613              try {
 614                  Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 615                  prefs.setAnalyticsEnabled(true);
 616                  prefs.save();
 617              } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 618                  bucketObjectNameInvalid.printStackTrace();
 619              }
 620          }
 621      }
 622  
 623      private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 624          private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 625  
 626          LogOutTask(PreferencesFragment fragment) {
 627              mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 628          }
 629  
 630          @Override
 631          protected Boolean doInBackground(Void... voids) {
 632              PreferencesFragment fragment = mPreferencesFragmentReference.get();
 633              return fragment == null || fragment.hasUnsyncedNotes();
 634          }
 635  
 636          @Override
 637          protected void onPostExecute(Boolean hasUnsyncedNotes) {
 638              final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 639  
 640              if (fragment == null) {
 641                  return;
 642              }
 643  
 644              // Safety first! Check if any notes are unsynced and warn the user if so.
 645              if (hasUnsyncedNotes) {
 646                  new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))
 647                      .setTitle(R.string.unsynced_notes)
 648                      .setMessage(R.string.unsynced_notes_message)
 649                      .setPositiveButton(R.string.log_out_anyway,
 650                          new DialogInterface.OnClickListener() {
 651                              @Override
 652                              public void onClick(DialogInterface dialogInterface, int i) {
 653                                  fragment.logOut();
 654                              }
 655                          }
 656                      )
 657                      .setNeutralButton(R.string.export_unsynced_notes,
 658                          new DialogInterface.OnClickListener() {
 659                              @Override
 660                              public void onClick(DialogInterface dialogInterface, int i) {
 661                                  Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 662                                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 663                                  intent.setType(&quot;application/json&quot;);
 664                                  intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));
 665                                  fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 666                              }
 667                          }
 668                      )
 669                      .setNegativeButton(R.string.cancel, null)
 670                      .show();
 671              } else {
 672                  fragment.logOut();
 673              }
 674          }
 675      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 676 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 677 +    static class DeleteAccountRequestHandlerImpl implements DeleteAccountRequestHandler {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 678 +        final WeakReference&lt;PreferencesFragment&gt; preferencesFragment;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 679 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 680 +        DeleteAccountRequestHandlerImpl(PreferencesFragment fragment) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 681 +            this.preferencesFragment = new WeakReference&lt;&gt;(fragment);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 682 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 683 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 684 +        @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 685 +        public void onSuccess() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 686 +            final PreferencesFragment fragment = preferencesFragment.get();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 687 +            if (fragment == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 688 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 689 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 690 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 691 +            FragmentActivity activity = fragment.getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 692 +            if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 693 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 694 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 695 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 696 +            AppLog.add(Type.ACCOUNT, &quot;Request to delete account was successful&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 697 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 698 +            activity.runOnUiThread(new Runnable() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 699 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 700 +                public void run() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 701 +                    fragment.closeProgressDialogDeleteAccount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 702 +                    fragment.showDeleteAccountConfirmationDialog();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 703 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 704 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 705 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 706 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 707 +        @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 708 +        public void onFailure() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 709 +            final PreferencesFragment fragment = preferencesFragment.get();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 710 +            if (fragment == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 711 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 712 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 713 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 714 +            FragmentActivity activity = fragment.getActivity();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 715 +            if (activity == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 716 +                return;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 717 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 718 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 719 +            AppLog.add(Type.ACCOUNT, &quot;Failure while calling server to delete account&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 720 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 721 +            activity.runOnUiThread(new Runnable() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 722 +                @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 723 +                public void run() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 724 +                    fragment.closeProgressDialogDeleteAccount();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 725 +                    fragment.showDialogDeleteAccountError();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 726 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 727 +            });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 728 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 729 +    }</span>
 730  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.Fragment;

   5  import android.content.DialogInterface;
   6  import android.content.Intent;
   7  import android.net.Uri;
   8  import android.os.AsyncTask;
   9  import android.os.Bundle;
  10  import android.os.ParcelFileDescriptor;
  11  import android.widget.Toast;
  12  
  13  import androidx.appcompat.app.AlertDialog;
  14  import androidx.appcompat.view.ContextThemeWrapper;
  15  import androidx.core.app.ShareCompat;


  16  import androidx.preference.ListPreference;
  17  import androidx.preference.Preference;
  18  import androidx.preference.PreferenceFragmentCompat;
  19  import androidx.preference.SwitchPreferenceCompat;
  20  
  21  import com.automattic.simplenote.analytics.AnalyticsTracker;
  22  import com.automattic.simplenote.authentication.SimplenoteAuthenticationActivity;
  23  import com.automattic.simplenote.models.Note;
  24  import com.automattic.simplenote.models.Preferences;


  25  import com.automattic.simplenote.utils.AppLog;
  26  import com.automattic.simplenote.utils.AppLog.Type;
  27  import com.automattic.simplenote.utils.AuthUtils;
  28  import com.automattic.simplenote.utils.BrowserUtils;
  29  import com.automattic.simplenote.utils.CrashUtils;

  30  import com.automattic.simplenote.utils.HtmlCompat;
  31  import com.automattic.simplenote.utils.PrefUtils;

  32  import com.simperium.Simperium;

  33  import com.simperium.client.Bucket;
  34  import com.simperium.client.BucketObjectMissingException;
  35  import com.simperium.client.BucketObjectNameInvalid;
  36  import com.simperium.client.User;
  37  
  38  import org.json.JSONArray;
  39  import org.json.JSONObject;
  40  
  41  import java.io.FileOutputStream;
  42  import java.lang.ref.WeakReference;
  43  import java.util.Collections;
  44  import java.util.Comparator;
  45  import java.util.List;
  46  
  47  import static android.app.Activity.RESULT_OK;
  48  import static com.automattic.simplenote.models.Preferences.PREFERENCES_OBJECT_KEY;
  49  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING;
  50  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_ASCENDING_LABEL;
  51  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING;
  52  import static com.automattic.simplenote.utils.PrefUtils.ALPHABETICAL_DESCENDING_LABEL;
  53  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING;
  54  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_ASCENDING_LABEL;
  55  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING;
  56  import static com.automattic.simplenote.utils.PrefUtils.DATE_CREATED_DESCENDING_LABEL;
  57  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING;
  58  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_ASCENDING_LABEL;
  59  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING;
  60  import static com.automattic.simplenote.utils.PrefUtils.DATE_MODIFIED_DESCENDING_LABEL;
  61  
  62  /**
  63   * A simple {@link Fragment} subclass.
  64   */
<abbr title="  65  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.OnUserCreatedListener {">  65  public class PreferencesFragment extends PreferenceFragmentCompat implements User.StatusChangeListener, Simperium.ðŸ”µ</abbr>
  66      public static final String WEB_APP_URL = &quot;https://app.simplenote.com&quot;;
  67  
  68      private static final int REQUEST_EXPORT_DATA = 9001;
  69      private static final int REQUEST_EXPORT_UNSYNCED = 9002;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +    private static final int REQUEST_IMPORT_DATA = 9003;</span>
  71  
  72      private Bucket&lt;Preferences&gt; mPreferencesBucket;
  73      private SwitchPreferenceCompat mAnalyticsSwitch;

  74  
  75      public PreferencesFragment() {
  76          // Required empty public constructor
  77      }
  78  
  79      @Override
  80      public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
  81          addPreferencesFromResource(R.xml.preferences);
  82      }
  83  
  84      @Override
  85      public void onActivityCreated(Bundle savedInstanceState) {
  86          super.onActivityCreated(savedInstanceState);
  87  
  88          Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
  89          Simplenote currentApp = (Simplenote) getActivity().getApplication();
  90          Simperium simperium = currentApp.getSimperium();
  91          simperium.setUserStatusChangeListener(this);
  92          simperium.setOnUserCreatedListener(this);
  93          mPreferencesBucket = currentApp.getPreferencesBucket();
  94  
  95          authenticatePreference.setSummary(currentApp.getSimperium().getUser().getEmail());
  96          if (simperium.needsAuthorization()) {
  97              authenticatePreference.setTitle(R.string.log_in);
  98          } else {
  99              authenticatePreference.setTitle(R.string.log_out);
 100          }
 101  
 102          authenticatePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 103              @Override
 104              public boolean onPreferenceClick(Preference preference) {
 105                  if (!isAdded()) {
 106                      return false;
 107                  }
 108  
 109                  Simplenote currentApp = (Simplenote) getActivity().getApplication();
 110                  if (currentApp.getSimperium().needsAuthorization()) {
 111                      Intent loginIntent = new Intent(getActivity(), SimplenoteAuthenticationActivity.class);
 112                      startActivityForResult(loginIntent, Simperium.SIGNUP_SIGNIN_REQUEST);
 113                  } else {
 114                      new LogOutTask(PreferencesFragment.this).execute();
 115                  }









 116                  return true;
 117              }
 118          });
 119  
 120          findPreference(&quot;pref_key_help&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 121              @Override
 122              public boolean onPreferenceClick(Preference preference) {
 123                  try {
 124                      BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;https://simplenote.com/help&quot;);
 125                  } catch (Exception e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -                    Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +                    toast(R.string.no_browser_available, Toast.LENGTH_LONG);</span>
 128                  }
 129                  return true;
 130              }
 131          });
 132  
<abbr title=" 133          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 133          findPreference(&quot;pref_key_website&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener()ðŸ”µ</abbr>
 134              @Override
 135              public boolean onPreferenceClick(Preference preference) {
 136                  try {
 137                      BrowserUtils.launchBrowserOrShowError(requireContext(), &quot;http://simplenote.com&quot;);
 138                  } catch (Exception e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -                    Toast.makeText(getActivity(), R.string.no_browser_available, Toast.LENGTH_LONG).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +                    toast(R.string.no_browser_available, Toast.LENGTH_LONG);</span>
 141                  }
 142                  return true;
 143              }
 144          });
 145  
 146          findPreference(&quot;pref_key_about&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 147              @Override
 148              public boolean onPreferenceClick(Preference preference) {
 149                  startActivity(new Intent(getActivity(), AboutActivity.class));
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +                return true;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 154 +        findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 154 +        findPreference(&quot;pref_key_import&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +            public boolean onPreferenceClick(Preference preference) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +                Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +                intent.addCategory(Intent.CATEGORY_OPENABLE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +                intent.setType(&quot;*/*&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 160 +                intent.putExtra(Intent.EXTRA_MIME_TYPES, new String[]{&quot;text/*&quot;, &quot;application/json&quot;});</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 161 +                startActivityForResult(intent, REQUEST_IMPORT_DATA);</span>
 162                  return true;
 163              }
 164          });
 165  
<abbr title=" 166          findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {"> 166          findPreference(&quot;pref_key_export&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() ðŸ”µ</abbr>
 167              @Override
 168              public boolean onPreferenceClick(Preference preference) {
 169                  Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 170                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 171                  intent.setType(&quot;application/json&quot;);
 172                  intent.putExtra(Intent.EXTRA_TITLE, getString(R.string.export_file));
 173                  startActivityForResult(intent, REQUEST_EXPORT_DATA);
 174                  return true;
 175              }
 176          });
 177  
 178          final ListPreference themePreference = findPreference(PrefUtils.PREF_THEME);
 179          themePreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 180              @Override
 181              public boolean onPreferenceChange(Preference preference, Object newValue) {
 182                  updateTheme(requireActivity(), Integer.parseInt(newValue.toString()));
 183                  return true;
 184              }
 185  
 186              private void updateTheme(Activity activity, int index) {
 187                  CharSequence[] entries = themePreference.getEntries();
 188                  themePreference.setSummary(entries[index]);
 189  
 190                  AnalyticsTracker.track(
 191                          AnalyticsTracker.Stat.SETTINGS_THEME_UPDATED,
 192                          AnalyticsTracker.CATEGORY_USER,
 193                          &quot;theme_preference&quot;
 194                  );
 195              }
 196          });
 197  
 198          final Preference stylePreference = findPreference(&quot;pref_key_style&quot;);
 199          stylePreference.setSummary(
 200              PrefUtils.isPremium(requireContext()) ?
 201                  PrefUtils.getStyleNameFromIndexSelected(requireContext()) :
 202                  PrefUtils.getStyleNameDefault(requireContext())
 203          );
 204          stylePreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 205              @Override
 206              public boolean onPreferenceClick(Preference preference) {
 207                  startActivity(new Intent(requireContext(), StyleActivity.class));
 208                  return true;
 209              }
 210          });
 211  
 212          final Preference membershipPreference = findPreference(&quot;pref_key_membership&quot;);
 213          membershipPreference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 214              @Override
 215              public boolean onPreferenceClick(Preference preference) {
 216                  ((PreferencesActivity) requireActivity()).openBrowserForMembership(getView());
 217                  return true;
 218              }
 219          });
 220  
 221          if (PrefUtils.isPremium(requireContext())) {
 222              membershipPreference.setLayoutResource(R.layout.preference_default);
 223              membershipPreference.setSummary(R.string.membership_premium);
 224          } else {
 225              membershipPreference.setLayoutResource(R.layout.preference_button);
 226              membershipPreference.setSummary(R.string.membership_free);
 227          }
 228  
 229          final ListPreference sortPreference = findPreference(PrefUtils.PREF_SORT_ORDER);
 230          sortPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 231              @Override
 232              public boolean onPreferenceChange(Preference preference, Object newValue) {
 233                  int index = Integer.parseInt(newValue.toString());
 234                  CharSequence[] entries = sortPreference.getEntries();
 235                  sortPreference.setSummary(entries[index]);
 236  
 237                  if (!sortPreference.getValue().equals(newValue)) {
 238                      switch (index) {
 239                          case ALPHABETICAL_ASCENDING:
 240                              trackSortOrder(ALPHABETICAL_ASCENDING_LABEL);
 241                              break;
 242                          case ALPHABETICAL_DESCENDING:
 243                              trackSortOrder(ALPHABETICAL_DESCENDING_LABEL);
 244                              break;
 245                          case DATE_CREATED_ASCENDING:
 246                              trackSortOrder(DATE_CREATED_ASCENDING_LABEL);
 247                              break;
 248                          case DATE_CREATED_DESCENDING:
 249                              trackSortOrder(DATE_CREATED_DESCENDING_LABEL);
 250                              break;
 251                          case DATE_MODIFIED_ASCENDING:
 252                              trackSortOrder(DATE_MODIFIED_ASCENDING_LABEL);
 253                              break;
 254                          case DATE_MODIFIED_DESCENDING:
 255                              trackSortOrder(DATE_MODIFIED_DESCENDING_LABEL);
 256                              break;
 257                      }
 258                  }
 259  
 260                  return true;
 261              }
 262          });
 263  
 264          SwitchPreferenceCompat switchPreference = findPreference(&quot;pref_key_condensed_note_list&quot;);
 265          switchPreference.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 266              @Override
 267              public boolean onPreferenceChange(Preference preference, Object o) {
 268                  if (((SwitchPreferenceCompat) preference).isChecked()) {
 269                      AnalyticsTracker.track(
 270                              AnalyticsTracker.Stat.SETTINGS_LIST_CONDENSED_ENABLED,
 271                              AnalyticsTracker.CATEGORY_USER,
 272                              &quot;condensed_list_preference&quot;
 273                      );
 274                  }
 275  
 276                  return true;
 277              }
 278          });
 279  
 280          // Add the hyperlink to the analytics summary
 281          Preference analyticsSummaryPreference = findPreference(&quot;pref_key_analytics_enabled_summary&quot;);
 282          String formattedSummary = String.format(
 283                  getString(R.string.share_analytics_summary),
 284                  &quot;&lt;a href=\&quot;https://automattic.com/cookies\&quot;&gt;&quot;,
 285                  &quot;&lt;/a&gt;&quot;
 286          );
 287          analyticsSummaryPreference.setSummary(HtmlCompat.fromHtml(formattedSummary));
 288  
 289          mAnalyticsSwitch = findPreference(&quot;pref_key_analytics_switch&quot;);
 290          mAnalyticsSwitch.setOnPreferenceChangeListener(new Preference.OnPreferenceChangeListener() {
 291              @Override
 292              public boolean onPreferenceChange(Preference preference, Object newValue) {
 293                  try {
 294                      boolean isChecked = (boolean)newValue;
 295                      Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 296                      prefs.setAnalyticsEnabled(isChecked);
 297                      prefs.save();
 298                  } catch (BucketObjectMissingException e) {
 299                      e.printStackTrace();
 300                  }
 301  
 302                  return true;
 303              }
 304          });
 305  
 306          updateAnalyticsSwitchState();
 307  
 308          findPreference(&quot;pref_key_logs&quot;).setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
 309              @Override
 310              public boolean onPreferenceClick(Preference preference) {
 311                  startActivity(
 312                      ShareCompat.IntentBuilder.from(requireActivity())
 313                          .setText(AppLog.get())
 314                          .setType(&quot;text/plain&quot;)
 315                          .createChooserIntent()
 316                  );
 317                  return true;
 318              }
 319          });

























































































































 320      }
 321  
 322      @Override
 323      public void onActivityResult(int requestCode, int resultCode, Intent resultData) {
 324          if (resultCode != RESULT_OK || resultData == null) {
 325              return;
 326          }
 327  
 328          if (resultData.getData() == null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 329 -            Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 329 -            Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show(ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +            toast(R.string.export_message_failure);</span>
 331              return;
 332          }
 333  
 334          switch (requestCode) {
 335              case REQUEST_EXPORT_DATA:
 336                  exportData(resultData.getData(), false);
 337                  break;
 338              case REQUEST_EXPORT_UNSYNCED:
 339                  exportData(resultData.getData(), true);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +                break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +            case REQUEST_IMPORT_DATA:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +                importData(resultData.getData());</span>
 343                  break;
 344          }
 345      }
 346  
 347      private boolean hasUnsyncedNotes() {
 348          Simplenote application = (Simplenote) getActivity().getApplication();
 349          Bucket&lt;Note&gt; notesBucket = application.getNotesBucket();
 350          Bucket.ObjectCursor&lt;Note&gt; notesCursor = notesBucket.allObjects();
 351          while (notesCursor.moveToNext()) {
 352              Note note = notesCursor.getObject();
 353              if (note.isNew() || note.isModified()) {
 354                  return true;
 355              }
 356          }
 357  
 358          return false;
 359      }
 360  
 361      private void logOut() {
 362          AppLog.add(Type.ACTION, &quot;Tapped logout button (PreferencesFragment)&quot;);
 363          AnalyticsTracker.track(
 364                  AnalyticsTracker.Stat.USER_SIGNED_OUT,
 365                  AnalyticsTracker.CATEGORY_USER,
 366                  &quot;preferences_sign_out_button&quot;
 367          );
 368  
 369          AuthUtils.logOut((Simplenote) requireActivity().getApplication());
 370  
 371          getActivity().finish();
 372      }
 373  
 374      @Override
 375      public void onUserStatusChange(User.Status status) {
 376          if (isAdded() &amp;&amp; status == User.Status.AUTHORIZED) {
 377              // User signed in
 378              getActivity().runOnUiThread(new Runnable() {
 379                  public void run() {
 380                      Preference authenticatePreference = findPreference(&quot;pref_key_authenticate&quot;);
 381                      authenticatePreference.setTitle(R.string.log_out);
 382                  }
 383              });
 384  
 385              Simplenote app = (Simplenote) getActivity().getApplication();
 386              AnalyticsTracker.refreshMetadata(app.getSimperium().getUser().getEmail());
 387              CrashUtils.setCurrentUser(app.getSimperium().getUser());
 388  
 389              AnalyticsTracker.track(
 390                      AnalyticsTracker.Stat.USER_SIGNED_IN,
 391                      AnalyticsTracker.CATEGORY_USER,
 392                      &quot;signed_in_from_preferences_activity&quot;
 393              );
 394          }
 395      }
 396  
 397      @Override
 398      public void onUserCreated(User user) {
 399          AnalyticsTracker.track(
 400                  AnalyticsTracker.Stat.USER_ACCOUNT_CREATED,
 401                  AnalyticsTracker.CATEGORY_USER,
 402                  &quot;account_created_from_preferences_activity&quot;
 403          );
 404      }
 405  
 406      private void exportData(Uri uri, boolean isUnsyncedNotes) {
 407          Simplenote currentApp = (Simplenote) requireActivity().getApplication();
 408          Bucket&lt;Note&gt; noteBucket = currentApp.getNotesBucket();
 409          JSONObject account = new JSONObject();
 410          Bucket.ObjectCursor&lt;Note&gt; cursor = noteBucket.allObjects();
 411  
 412          try {
 413              JSONArray activeNotes = new JSONArray();
 414              JSONArray trashedNotes = new JSONArray();
 415              Comparator&lt;String&gt; comparator = new Comparator&lt;String&gt;() {
 416                  @Override
 417                  public int compare(String text1, String text2) {
 418                      return text1.compareToIgnoreCase(text2);
 419                  }
 420              };
 421  
 422              while (cursor.moveToNext()) {
 423                  Note note = cursor.getObject();
 424  
 425                  if (isUnsyncedNotes &amp;&amp; !note.isNew() &amp;&amp; !note.isModified()) {
 426                      continue;
 427                  }
 428  
 429                  JSONObject noteJson = new JSONObject();
 430  
 431                  noteJson.put(&quot;id&quot;, note.getSimperiumKey());
 432                  noteJson.put(&quot;content&quot;, note.getContent());
 433                  noteJson.put(&quot;creationDate&quot;, note.getCreationDateString());
 434                  noteJson.put(&quot;lastModified&quot;, note.getModificationDateString());
 435  
 436                  if (note.isPinned()) {
 437                      noteJson.put(&quot;pinned&quot;, note.isPinned());
 438                  }
 439  
 440                  if (note.isMarkdownEnabled()) {
 441                      noteJson.put(&quot;markdown&quot;, note.isMarkdownEnabled());
 442                  }
 443  
 444                  if (note.getTags().size() &gt; 0) {
 445                      List&lt;String&gt; tags = note.getTags();
 446                      Collections.sort(tags, comparator);
 447                      noteJson.put(&quot;tags&quot;, new JSONArray(tags));
 448                  }
 449  
 450                  if (!note.getPublishedUrl().isEmpty()) {
 451                      noteJson.put(&quot;publicURL&quot;, note.getPublishedUrl());
 452                  }
 453  
 454                  if (note.isDeleted()) {
 455                      trashedNotes.put(noteJson);
 456                  } else {
 457                      activeNotes.put(noteJson);
 458                  }
 459              }
 460  
 461              account.put(&quot;activeNotes&quot;, activeNotes);
 462              account.put(&quot;trashedNotes&quot;, trashedNotes);
 463  
<abbr title=" 464              ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uri, &quot;w&quot;);"> 464              ParcelFileDescriptor parcelFileDescriptor = requireContext().getContentResolver().openFileDescriptor(uðŸ”µ</abbr>
 465  
 466              if (parcelFileDescriptor != null) {
<abbr title=" 467                  FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor());"> 467                  FileOutputStream fileOutputStream = new FileOutputStream(parcelFileDescriptor.getFileDescriptor())ðŸ”µ</abbr>
 468                  fileOutputStream.write(account.toString(2).replace(&quot;\\/&quot;,&quot;/&quot;).getBytes());
 469                  parcelFileDescriptor.close();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 470 -                Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTH_SHORT).show();"> 470 -                Toast.makeText(requireContext(), getString(R.string.export_message_success), Toast.LENGTH_SHORT).sðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 471 +                toast(R.string.export_message_success);</span>
 472              } else {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 473 -                Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 473 -                Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).sðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 474 +                toast(R.string.export_message_failure);</span>
 475              }
 476          } catch (Exception e) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 477 -            Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show();"> 477 -            Toast.makeText(requireContext(), getString(R.string.export_message_failure), Toast.LENGTH_SHORT).show(ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 478 +            toast(R.string.export_message_failure);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 479 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 480 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 481 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 482 +    private void importData(Uri uri) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 483 +        try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 484 +            Importer.fromUri(this, uri);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 485 +            toast(R.string.import_message_success);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 486 +        } catch (Importer.ImportException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 487 +            switch (e.getReason()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 488 +                case FileError:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 489 +                    toast(R.string.import_error_file);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 490 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 491 +                case ParseError:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 492 +                    toast(R.string.import_error_parse);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 493 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 494 +                case UnknownExportType:</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 495 +                    toast(R.string.import_unknown);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 496 +                    break;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 497 +            }</span>
 498          }
 499      }
 500  
 501      private void trackSortOrder(String label) {
 502          AnalyticsTracker.track(
 503              AnalyticsTracker.Stat.SETTINGS_SEARCH_SORT_MODE,
 504              AnalyticsTracker.CATEGORY_SETTING,
 505              label
 506          );
 507      }
 508  
 509      private void updateAnalyticsSwitchState() {
 510          try {
 511              Preferences prefs = mPreferencesBucket.get(PREFERENCES_OBJECT_KEY);
 512              mAnalyticsSwitch.setChecked(prefs.getAnalyticsEnabled());
 513          } catch (BucketObjectMissingException e) {
 514              // The preferences object doesn&#x27;t exist for this user yet, create it
 515              try {
 516                  Preferences prefs = mPreferencesBucket.newObject(PREFERENCES_OBJECT_KEY);
 517                  prefs.setAnalyticsEnabled(true);
 518                  prefs.save();
 519              } catch (BucketObjectNameInvalid bucketObjectNameInvalid) {
 520                  bucketObjectNameInvalid.printStackTrace();
 521              }
 522          }
 523      }
 524  
 525      private static class LogOutTask extends AsyncTask&lt;Void, Void, Boolean&gt; {
 526          private WeakReference&lt;PreferencesFragment&gt; mPreferencesFragmentReference;
 527  
 528          LogOutTask(PreferencesFragment fragment) {
 529              mPreferencesFragmentReference = new WeakReference&lt;&gt;(fragment);
 530          }
 531  
 532          @Override
 533          protected Boolean doInBackground(Void... voids) {
 534              PreferencesFragment fragment = mPreferencesFragmentReference.get();
 535              return fragment == null || fragment.hasUnsyncedNotes();
 536          }
 537  
 538          @Override
 539          protected void onPostExecute(Boolean hasUnsyncedNotes) {
 540              final PreferencesFragment fragment = mPreferencesFragmentReference.get();
 541  
 542              if (fragment == null) {
 543                  return;
 544              }
 545  
 546              // Safety first! Check if any notes are unsynced and warn the user if so.
 547              if (hasUnsyncedNotes) {
 548                  new AlertDialog.Builder(new ContextThemeWrapper(fragment.requireContext(), R.style.Dialog))
 549                      .setTitle(R.string.unsynced_notes)
 550                      .setMessage(R.string.unsynced_notes_message)
 551                      .setPositiveButton(R.string.log_out_anyway,
 552                          new DialogInterface.OnClickListener() {
 553                              @Override
 554                              public void onClick(DialogInterface dialogInterface, int i) {
 555                                  fragment.logOut();
 556                              }
 557                          }
 558                      )
 559                      .setNeutralButton(R.string.export_unsynced_notes,
 560                          new DialogInterface.OnClickListener() {
 561                              @Override
 562                              public void onClick(DialogInterface dialogInterface, int i) {
 563                                  Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
 564                                  intent.addCategory(Intent.CATEGORY_OPENABLE);
 565                                  intent.setType(&quot;application/json&quot;);
 566                                  intent.putExtra(Intent.EXTRA_TITLE, fragment.getString(R.string.export_file));
 567                                  fragment.startActivityForResult(intent, REQUEST_EXPORT_UNSYNCED);
 568                              }
 569                          }
 570                      )
 571                      .setNegativeButton(R.string.cancel, null)
 572                      .show();
 573              } else {
 574                  fragment.logOut();
 575              }
 576          }
 577      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 578 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 579 +    private void toast(int stringId) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 580 +        toast(stringId, Toast.LENGTH_SHORT);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 581 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 582 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 583 +    private void toast(int stringId, int length) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 584 +        Toast.makeText(requireContext(), getString(stringId), length).show();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 585 +    }</span>














































 586  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            