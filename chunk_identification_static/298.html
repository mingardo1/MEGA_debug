<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>298</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    298
                    <a href="297.html">prev</a>
                    <a href="299.html">next</a>
                    <a href="298_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_cd7cff12a798c3a68943ad44552e25fb0f98f8d1_admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/server/security/service/AdminSecurityServiceImpl.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/server/security/service/AdminSecurityServiceImpl.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1^1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/server/security/service/AdminSecurityServiceImpl.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1^2:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/server/security/service/AdminSecurityServiceImpl.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;556ac57d12139326e76b29db4638956d93283fb1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/server/security/service/AdminSecurityServiceImpl.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [b], [b], [bs], [s]], subset: [[b], [b], [b], [b], [bs], [s]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.server.security.service;
  19 
  20 import org.apache.commons.collections4.CollectionUtils;
  21 import org.apache.commons.lang3.BooleanUtils;
  22 import org.apache.commons.lang3.StringUtils;
  23 import org.apache.commons.logging.Log;
  24 import org.apache.commons.logging.LogFactory;
  25 import org.broadleafcommerce.common.email.service.EmailService;
  26 import org.broadleafcommerce.common.email.service.info.EmailInfo;
  27 import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;
  28 import org.broadleafcommerce.common.security.util.PasswordChange;
  29 import org.broadleafcommerce.common.security.util.PasswordUtils;
  30 import org.broadleafcommerce.common.service.GenericResponse;
  31 import org.broadleafcommerce.common.time.SystemTime;
  32 import org.broadleafcommerce.common.util.BLCSystemProperty;
  33 import org.broadleafcommerce.common.util.StringUtil;
  34 import org.broadleafcommerce.openadmin.server.security.dao.AdminPermissionDao;
  35 import org.broadleafcommerce.openadmin.server.security.dao.AdminRoleDao;
  36 import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  37 import org.broadleafcommerce.openadmin.server.security.dao.ForgotPasswordSecurityTokenDao;
  38 import org.broadleafcommerce.openadmin.server.security.domain.AdminPermission;
  39 import org.broadleafcommerce.openadmin.server.security.domain.AdminRole;
  40 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  41 import org.broadleafcommerce.openadmin.server.security.domain.ForgotPasswordSecurityToken;
  42 import org.broadleafcommerce.openadmin.server.security.domain.ForgotPasswordSecurityTokenImpl;
  43 import org.broadleafcommerce.openadmin.server.security.event.AdminForgotPasswordEvent;
  44 import org.broadleafcommerce.openadmin.server.security.event.AdminForgotUsernameEvent;
  45 import org.broadleafcommerce.openadmin.server.security.service.type.PermissionType;
  46 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  47 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import org.broadleafcommerce.openadmin.server.security.domain.ForgotPasswordSecurityToken;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import org.broadleafcommerce.openadmin.server.security.domain.ForgotPasswordSecurityTokenImpl;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 import org.broadleafcommerce.openadmin.server.security.service.type.PermissionType;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 import org.broadleafcommerce.openadmin.server.security.service.user.AdminUserDetails;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53 import org.springframework.beans.factory.NoSuchBeanDefinitionException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54 import org.springframework.beans.factory.annotation.Autowired;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55 import org.springframework.beans.factory.annotation.Qualifier;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56 import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57 import org.springframework.security.authentication.dao.SaltSource;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 import org.springframework.security.core.Authentication;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 import org.springframework.security.core.GrantedAuthority;</span>
  60 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61 import org.broadleafcommerce.openadmin.server.security.service.user.AdminUserDetails;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62 import org.springframework.beans.factory.NoSuchBeanDefinitionException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63 import org.springframework.beans.factory.annotation.Autowired;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64 import org.springframework.beans.factory.annotation.Qualifier;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65 import org.springframework.context.ApplicationContext;</span>
  66 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  67 import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
  68 import org.springframework.security.core.Authentication;
  69 import org.springframework.security.core.context.SecurityContextHolder;
  70 import org.springframework.security.crypto.password.PasswordEncoder;
  71 import org.springframework.stereotype.Service;
  72 import org.springframework.transaction.annotation.Transactional;
  73 
  74 import java.util.ArrayList;
  75 import java.util.Date;
  76 import java.util.List;
  77 
  78 import javax.annotation.Resource;
  79 
  80 import net.sf.ehcache.Cache;
  81 import net.sf.ehcache.CacheManager;
  82 import net.sf.ehcache.Element;
  83 
  84 /**
  85  *
  86  * @author jfischer
  87  *
  88  */
  89 @Service(&quot;blAdminSecurityService&quot;)
  90 public class AdminSecurityServiceImpl implements AdminSecurityService {
  91 
  92     private static final Log LOG = LogFactory.getLog(AdminSecurityServiceImpl.class);
  93 
  94     private static int TEMP_PASSWORD_LENGTH = 12;
  95     private static final int FULL_PASSWORD_LENGTH = 16;
  96 
  97     @Autowired
  98     @Qualifier(&quot;blApplicationEventPublisher&quot;)
  99     protected BroadleafApplicationEventPublisher eventPublisher;
 100 
 101     @Resource(name = &quot;blAdminRoleDao&quot;)
 102     protected AdminRoleDao adminRoleDao;
 103 
 104     @Resource(name = &quot;blAdminUserDao&quot;)
 105     protected AdminUserDao adminUserDao;
 106 
 107     @Resource(name = &quot;blForgotPasswordSecurityTokenDao&quot;)
 108     protected ForgotPasswordSecurityTokenDao forgotPasswordSecurityTokenDao;
 109 
 110     @Resource(name = &quot;blAdminPermissionDao&quot;)
 111     protected AdminPermissionDao adminPermissionDao;
 112 
 113     protected static String CACHE_NAME = &quot;blSecurityElements&quot;;
 114     protected static String CACHE_KEY_PREFIX = &quot;security:&quot;;
 115     protected Cache cache = CacheManager.getInstance().getCache(CACHE_NAME);
 116 
 117     /**
<abbr title=" 118      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using the"> 118      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;rðŸ”µ</abbr>
<abbr title=" 119      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}"> 119      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.eðŸ”µ</abbr>
 120      */
 121     @Resource(name=&quot;blAdminPasswordEncoder&quot;)
 122     protected PasswordEncoder passwordEncoderBean;
 123 
 124 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 125     @Resource(name=&quot;blEmailService&quot;)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 126     protected EmailService emailService;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 127 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 128     @Resource(name=&quot;blSendAdminResetPasswordEmail&quot;)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 129     protected EmailInfo resetPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 130 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 131     @Resource(name=&quot;blSendAdminUsernameEmailInfo&quot;)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 132     protected EmailInfo sendUsernameEmailInfo;</span>
 133 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 135     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136     protected org.springframework.security.authentication.encoding.PasswordEncoder passwordEncoder;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 139      * &lt;p&gt;Set by {@link #setupPasswordEncoder()} if the blPasswordEncoder bean provided is the new version."> 139      * &lt;p&gt;Set by {@link #setupPasswordEncoder()} if the blPasswordEncoder bean provided is the new versioðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141     protected PasswordEncoder passwordEncoderNew;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143     protected static String CACHE_NAME = &quot;blSecurityElements&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144     protected static String CACHE_KEY_PREFIX = &quot;security:&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145     protected Cache cache = CacheManager.getInstance().getCache(CACHE_NAME);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 148      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using the"> 148      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;rðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 149      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}"> 149      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.eðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151     @Resource(name=&quot;blAdminPasswordEncoder&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152     protected Object passwordEncoderBean;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155      * Optional password salt to be used with the passwordEncoder</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157      * @deprecated use {@link #saltSource} instead, this will be removed in 4.2</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160     protected String salt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163      * Use a Salt Source ONLY if there&#x27;s one configured</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164      *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 165      * @deprecated the new {@link PasswordEncoder} handles salting internally, this will be removed in 4.2"> 165      * @deprecated the new {@link PasswordEncoder} handles salting internally, this will be removed in 4.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 168     @Autowired(required=false)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169     @Qualifier(&quot;blAdminSaltSource&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170     protected SaltSource saltSource;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172     @Resource(name=&quot;blEmailService&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173     protected EmailService emailService;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175     @Resource(name=&quot;blSendAdminResetPasswordEmail&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176     protected EmailInfo resetPasswordEmailInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177 </span>
 178 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180      * Optional password salt to be used with the passwordEncoder</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182      * @deprecated use {@link #saltSource} instead, this will be removed in 4.2</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185     protected String salt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188      * Use a Salt Source ONLY if there&#x27;s one configured</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 190      * @deprecated the new {@link PasswordEncoder} handles salting internally, this will be removed in 4.2"> 190      * @deprecated the new {@link PasswordEncoder} handles salting internally, this will be removed in 4.ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193     @Autowired(required=false)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194     @Qualifier(&quot;blAdminSaltSource&quot;)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195     protected SaltSource saltSource;</span>
 196 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 197 
 198     protected int getTokenExpiredMinutes() {
 199         return BLCSystemProperty.resolveIntSystemProperty(&quot;tokenExpiredMinutes&quot;);
 200     }
 201 
 202     protected String getResetPasswordURL() {
 203         return BLCSystemProperty.resolveSystemProperty(&quot;resetPasswordURL&quot;);
 204     }
 205 
 206     @Override
 207     @Transactional(&quot;blTransactionManager&quot;)
 208     public void deleteAdminPermission(AdminPermission permission) {
 209         adminPermissionDao.deleteAdminPermission(permission);
 210         clearAdminSecurityCache();
 211     }
 212 
 213     @Override
 214     @Transactional(&quot;blTransactionManager&quot;)
 215     public void deleteAdminRole(AdminRole role) {
 216         adminRoleDao.deleteAdminRole(role);
 217         clearAdminSecurityCache();
 218     }
 219 
 220     @Override
 221     @Transactional(&quot;blTransactionManager&quot;)
 222     public void deleteAdminUser(AdminUser user) {
 223         adminUserDao.deleteAdminUser(user);
 224         clearAdminSecurityCache();
 225     }
 226 
 227     @Override
 228     public AdminPermission readAdminPermissionById(Long id) {
 229         return adminPermissionDao.readAdminPermissionById(id);
 230     }
 231 
 232     @Override
 233     public AdminRole readAdminRoleById(Long id) {
 234         return adminRoleDao.readAdminRoleById(id);
 235     }
 236 
 237     @Override
 238     public AdminUser readAdminUserById(Long id) {
 239         return adminUserDao.readAdminUserById(id);
 240     }
 241 
 242     @Override
 243     @Transactional(&quot;blTransactionManager&quot;)
 244     public AdminPermission saveAdminPermission(AdminPermission permission) {
 245         permission = adminPermissionDao.saveAdminPermission(permission);
 246         clearAdminSecurityCache();
 247         return permission;
 248     }
 249 
 250     @Override
 251     @Transactional(&quot;blTransactionManager&quot;)
 252     public AdminRole saveAdminRole(AdminRole role) {
 253         role = adminRoleDao.saveAdminRole(role);
 254         clearAdminSecurityCache();
 255         return role;
 256     }
 257 
 258     @Override
 259     @Transactional(&quot;blTransactionManager&quot;)
 260     public AdminUser saveAdminUser(AdminUser user) {
 261         boolean encodePasswordNeeded = false;
 262         String unencodedPassword = user.getUnencodedPassword();
 263 
 264         if (user.getUnencodedPassword() != null) {
 265             encodePasswordNeeded = true;
 266             user.setPassword(unencodedPassword);
 267         }
 268 
 269         // If no password is set, default to a secure password.
 270         if (user.getPassword() == null) {
 271             user.setPassword(generateSecurePassword());
 272         }
 273 
 274         AdminUser returnUser = adminUserDao.saveAdminUser(user);
 275 
 276         if (encodePasswordNeeded) {
 277             returnUser.setPassword(encodePassword(unencodedPassword));
 278         }
 279 
 280         returnUser = adminUserDao.saveAdminUser(returnUser);
 281         clearAdminSecurityCache();
 282         return returnUser;
 283     }
 284 
 285     @Override
 286     public void clearAdminSecurityCache() {
 287         if (LOG.isTraceEnabled()) {
 288             LOG.trace(&quot;Admin Security Cache DELETE&quot;);
 289         }
 290         cache.removeAll();
 291     }
 292 
 293     protected String generateSecurePassword() {
 294         return PasswordUtils.generateSecurePassword(FULL_PASSWORD_LENGTH);
 295     }
 296 
 297     @Override
 298     @Transactional(&quot;blTransactionManager&quot;)
 299     public AdminUser changePassword(PasswordChange passwordChange) {
 300         AdminUser user = readAdminUserByUserName(passwordChange.getUsername());
 301         user.setUnencodedPassword(passwordChange.getNewPassword());
 302         user = saveAdminUser(user);
 303         Authentication auth = SecurityContextHolder.getContext().getAuthentication();
<abbr title=" 304         UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(passwordChange.getUsername(), passwordChange.getNewPassword(), auth.getAuthorities());"> 304         UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(passworðŸ”µ</abbr>
 305         SecurityContextHolder.getContext().setAuthentication(authRequest);
 306         auth.setAuthenticated(false);
 307         return user;
 308     }
 309 
 310     @Override
<abbr title=" 311     public boolean isUserQualifiedForOperationOnCeilingEntity(AdminUser adminUser, PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 311     public boolean isUserQualifiedForOperationOnCeilingEntity(AdminUser adminUser, PermissionType permissðŸ”µ</abbr>
 312         Boolean response = null;
 313         String cacheKey = buildCacheKey(adminUser, permissionType, ceilingEntityFullyQualifiedName);
 314         Element cacheElement = cache.get(cacheKey);
 315 
 316         if (cacheElement != null) {
 317             response = (Boolean) cacheElement.getObjectValue();
 318 
 319             if (LOG.isTraceEnabled()) {
 320                 LOG.trace(&quot;Admin Security Cache GET For: \&quot;&quot; + cacheKey + &quot;\&quot; = &quot; + response);
 321             }
 322         }
 323 
 324         if (response == null) {
<abbr title=" 325             response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntity(adminUser, permissionType, ceilingEntityFullyQualifiedName);"> 325             response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntity(adminUser, permissioðŸ”µ</abbr>
 326 
 327             if (!response) {
<abbr title=" 328                 response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntityViaDefaultPermissions(ceilingEntityFullyQualifiedName);"> 328                 response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntityViaDefaultPermissðŸ”µ</abbr>
 329             }
 330 
 331             cacheElement = new Element(cacheKey, response);
 332             cache.put(cacheElement);
 333 
 334             if (LOG.isTraceEnabled()) {
 335                 LOG.trace(&quot;Admin Security Cache PUT For: \&quot;&quot; + cacheKey + &quot;\&quot; = &quot; + response);
 336             }
 337         }
 338 
 339         return response;
 340     }
 341 
<abbr title=" 342     protected String buildCacheKey(AdminUser adminUser, PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 342     protected String buildCacheKey(AdminUser adminUser, PermissionType permissionType, String ceilingEntiðŸ”µ</abbr>
 343         return CACHE_KEY_PREFIX
 344                + &quot;user:&quot; + adminUser.getId() + &quot;,&quot;
 345                + &quot;permType:&quot; + permissionType.getFriendlyType() + &quot;,&quot;
 346                + &quot;ceiling:&quot; + ceilingEntityFullyQualifiedName;
 347     }
 348 
 349     @Override
<abbr title=" 350     public boolean doesOperationExistForCeilingEntity(PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 350     public boolean doesOperationExistForCeilingEntity(PermissionType permissionType, String ceilingEntityðŸ”µ</abbr>
<abbr title=" 351         return adminPermissionDao.doesOperationExistForCeilingEntity(permissionType, ceilingEntityFullyQualifiedName);"> 351         return adminPermissionDao.doesOperationExistForCeilingEntity(permissionType, ceilingEntityFullyQuðŸ”µ</abbr>
 352     }
 353 
 354     @Override
 355     public AdminUser readAdminUserByUserName(String userName) {
 356         return adminUserDao.readAdminUserByUserName(userName);
 357     }
 358 
 359     @Override
 360     public List&lt;AdminUser&gt; readAdminUsersByEmail(String email) {
 361         return adminUserDao.readAdminUserByEmail(email);
 362     }
 363 
 364     @Override
 365     public List&lt;AdminUser&gt; readAllAdminUsers() {
 366         return adminUserDao.readAllAdminUsers();
 367     }
 368 
 369     @Override
 370     public List&lt;AdminRole&gt; readAllAdminRoles() {
 371         return adminRoleDao.readAllAdminRoles();
 372     }
 373 
 374     @Override
 375     public List&lt;AdminPermission&gt; readAllAdminPermissions() {
 376         return adminPermissionDao.readAllAdminPermissions();
 377     }
 378 
 379     @Override
 380     @Transactional(&quot;blTransactionManager&quot;)
 381     public GenericResponse sendForgotUsernameNotification(String emailAddress) {
 382         GenericResponse response = new GenericResponse();
 383         List&lt;AdminUser&gt; users = null;
 384         if (emailAddress != null) {
 385             users = adminUserDao.readAdminUserByEmail(emailAddress);
 386         }
 387         if (CollectionUtils.isEmpty(users)) {
 388             response.addErrorCode(&quot;notFound&quot;);
 389         } else {
 390             List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();
 391             for (AdminUser user : users) {
 392                 if (user.getActiveStatusFlag()) {
 393                     activeUsernames.add(user.getLogin());
 394                 }
 395             }
 396 
 397             if (activeUsernames.size() &gt; 0) {
<abbr title=" 398                 eventPublisher.publishEvent(new AdminForgotUsernameEvent(this, emailAddress, null, activeUsernames));"> 398                 eventPublisher.publishEvent(new AdminForgotUsernameEvent(this, emailAddress, null, activeðŸ”µ</abbr>
 399             } else {
 400                 // send inactive username found email.
 401                 response.addErrorCode(&quot;inactiveUser&quot;);
 402             }
 403         }
 404         return response;
 405     }
 406 
 407     @Override
 408     @Transactional(&quot;blTransactionManager&quot;)
 409     public GenericResponse sendResetPasswordNotification(String username) {
 410         GenericResponse response = new GenericResponse();
 411         AdminUser user = null;
 412 
 413         if (username != null) {
 414             user = adminUserDao.readAdminUserByUserName(username);
 415         }
 416 
 417         checkUser(user,response);
 418 
 419         if (! response.getHasErrors()) {
 420             String token = PasswordUtils.generateSecurePassword(TEMP_PASSWORD_LENGTH);
 421             token = token.toLowerCase();
 422 
 423             ForgotPasswordSecurityToken fpst = new ForgotPasswordSecurityTokenImpl();
 424             fpst.setAdminUserId(user.getId());
 425             fpst.setToken(encodePassword(token));
 426             fpst.setCreateDate(SystemTime.asDate());
 427             forgotPasswordSecurityTokenDao.saveToken(fpst);
 428 
 429 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 430             HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 431             vars.put(&quot;token&quot;, token);</span>
 432 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 433     public List&lt;AdminRole&gt; readAllAdminRoles() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 434         return adminRoleDao.readAllAdminRoles();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 435     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 436 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 437     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 438     public List&lt;AdminPermission&gt; readAllAdminPermissions() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 439         return adminPermissionDao.readAllAdminPermissions();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 440     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 441 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 442     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 443     @Transactional(&quot;blTransactionManager&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 444     public GenericResponse sendForgotUsernameNotification(String emailAddress) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 445         GenericResponse response = new GenericResponse();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 446         List&lt;AdminUser&gt; users = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 447         if (emailAddress != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 448             users = adminUserDao.readAdminUserByEmail(emailAddress);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 449         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 450         if (CollectionUtils.isEmpty(users)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 451             response.addErrorCode(&quot;notFound&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 452         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 453             List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 454             for (AdminUser user : users) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 455                 if (user.getActiveStatusFlag()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 456                     activeUsernames.add(user.getLogin());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 457                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 458             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 459 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 460             if (activeUsernames.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 461                 HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 462                 vars.put(&quot;accountNames&quot;, activeUsernames);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 463                 emailService.sendTemplateEmail(emailAddress, getSendUsernameEmailInfo(), vars);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 464             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 465                 // send inactive username found email.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 466                 response.addErrorCode(&quot;inactiveUser&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 467             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 468         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 469         return response;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 470     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 471 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 472     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 473     @Transactional(&quot;blTransactionManager&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 474     public GenericResponse sendResetPasswordNotification(String username) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 475         GenericResponse response = new GenericResponse();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 476         AdminUser user = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 477         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 478         if (username != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 479             user = adminUserDao.readAdminUserByUserName(username);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 480         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 481         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 482         checkUser(user,response);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 483         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 484         if (! response.getHasErrors()) {        </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 485             String token = PasswordUtils.generateSecurePassword(TEMP_PASSWORD_LENGTH);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 486             token = token.toLowerCase();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 487 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 488             ForgotPasswordSecurityToken fpst = new ForgotPasswordSecurityTokenImpl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 489             fpst.setAdminUserId(user.getId());</span>
 490 =======
 491 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 492             String resetPasswordUrl = getResetPasswordURL();
 493             if (!StringUtils.isEmpty(resetPasswordUrl)) {
 494                 if (resetPasswordUrl.contains(&quot;?&quot;)) {
 495                     resetPasswordUrl=resetPasswordUrl+&quot;&amp;token=&quot;+token;
 496                 } else {
 497                     resetPasswordUrl=resetPasswordUrl+&quot;?token=&quot;+token;
 498                 }
 499             }
 500 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 501             vars.put(&quot;resetPasswordUrl&quot;, resetPasswordUrl);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 502             emailService.sendTemplateEmail(user.getEmail(), getResetPasswordEmailInfo(), vars);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 503 </span>
 504 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 505     @Transactional(&quot;blTransactionManager&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 506     public GenericResponse sendForgotUsernameNotification(String emailAddress) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 507         GenericResponse response = new GenericResponse();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 508         List&lt;AdminUser&gt; users = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 509         if (emailAddress != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 510             users = adminUserDao.readAdminUserByEmail(emailAddress);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 511         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 512         if (CollectionUtils.isEmpty(users)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 513             response.addErrorCode(&quot;notFound&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 514         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 515             List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 516             for (AdminUser user : users) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 517                 if (user.getActiveStatusFlag()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 518                     activeUsernames.add(user.getLogin());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 519                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 520             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 521 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 522             if (activeUsernames.size() &gt; 0) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 523                 HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 524                 vars.put(&quot;accountNames&quot;, activeUsernames);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 525                 emailService.sendTemplateEmail(emailAddress, getSendUsernameEmailInfo(), vars);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 526             } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 527                 // send inactive username found email.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 528                 response.addErrorCode(&quot;inactiveUser&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 529             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 530         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 531         return response;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 532     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 533 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 534     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 535     @Transactional(&quot;blTransactionManager&quot;)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 536     public GenericResponse sendResetPasswordNotification(String username) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 537         GenericResponse response = new GenericResponse();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 538         AdminUser user = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 539         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 540         if (username != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 541             user = adminUserDao.readAdminUserByUserName(username);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 542         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 543         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 544         checkUser(user,response);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 545         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 546         if (! response.getHasErrors()) {        </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 547             String token = PasswordUtils.generateSecurePassword(TEMP_PASSWORD_LENGTH);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 548             token = token.toLowerCase();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 549 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 550             ForgotPasswordSecurityToken fpst = new ForgotPasswordSecurityTokenImpl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 551             fpst.setAdminUserId(user.getId());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 552             fpst.setToken(encodePassword(token, null));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 553             fpst.setCreateDate(SystemTime.asDate());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 554             forgotPasswordSecurityTokenDao.saveToken(fpst);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 555             </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 556             HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 557             vars.put(&quot;token&quot;, token);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 558             String resetPasswordUrl = getResetPasswordURL();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 559             if (!StringUtils.isEmpty(resetPasswordUrl)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 560                 if (resetPasswordUrl.contains(&quot;?&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 561                     resetPasswordUrl=resetPasswordUrl+&quot;&amp;token=&quot;+token;</span>
 562 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 563 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 564             eventPublisher.publishEvent(new AdminForgotPasswordEvent(this, user.getId(), token, resetPasswordUrl));"> 564             eventPublisher.publishEvent(new AdminForgotPasswordEvent(this, user.getId(), token, resetPassðŸ”µ</abbr></span>
 565 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 566         }
 567         return response;
 568     }
 569 
 570     @Override
 571     @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 572     public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPassword) {"> 572     public GenericResponse resetPasswordUsingToken(String username, String token, String password, StringðŸ”µ</abbr>
 573         GenericResponse response = new GenericResponse();
 574         AdminUser user = null;
 575         if (username != null) {
 576             user = adminUserDao.readAdminUserByUserName(username);
 577         }
 578         checkUser(user, response);
 579         checkPassword(password, confirmPassword, response);
 580         if (StringUtils.isBlank(token)) {
 581             response.addErrorCode(&quot;invalidToken&quot;);
 582         }
 583 
 584         ForgotPasswordSecurityToken fpst = null;
 585         if (! response.getHasErrors()) {
 586             token = token.toLowerCase();
<abbr title=" 587             List&lt;ForgotPasswordSecurityToken&gt; fpstoks = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(user.getId());"> 587             List&lt;ForgotPasswordSecurityToken&gt; fpstoks = forgotPasswordSecurityTokenDao.readUnusedTokensByðŸ”µ</abbr>
 588             for (ForgotPasswordSecurityToken fpstok : fpstoks) {
 589                 if (isPasswordValid(fpstok.getToken(), token)) {
 590                     fpst = fpstok;
 591                     break;
 592                 }
 593             }
 594             if (fpst == null) {
 595                 response.addErrorCode(&quot;invalidToken&quot;);
 596             } else if (fpst.isTokenUsedFlag()) {
 597                 response.addErrorCode(&quot;tokenUsed&quot;);
 598             } else if (isTokenExpired(fpst)) {
 599                 response.addErrorCode(&quot;tokenExpired&quot;);
 600             }
 601         }
 602 
 603         if (! response.getHasErrors()) {
 604             if (! user.getId().equals(fpst.getAdminUserId())) {
 605                 if (LOG.isWarnEnabled()) {
<abbr title=" 606                     LOG.warn(&quot;Password reset attempt tried with mismatched user and token &quot; + user.getId() + &quot;, &quot; + StringUtil.sanitize(token));"> 606                     LOG.warn(&quot;Password reset attempt tried with mismatched user and token &quot; + user.getId(ðŸ”µ</abbr>
 607                 }
 608                 response.addErrorCode(&quot;invalidToken&quot;);
 609             }
 610         }
 611 
 612         if (! response.getHasErrors()) {
 613             user.setUnencodedPassword(password);
 614             saveAdminUser(user);
 615             invalidateAllTokensForAdminUser(user);
 616         }
 617 
 618         return response;
 619     }
 620 
 621     protected void invalidateAllTokensForAdminUser(AdminUser user) {
<abbr title=" 622         List&lt;ForgotPasswordSecurityToken&gt; tokens = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(user.getId());"> 622         List&lt;ForgotPasswordSecurityToken&gt; tokens = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminðŸ”µ</abbr>
 623         for (ForgotPasswordSecurityToken token : tokens) {
 624             token.setTokenUsedFlag(true);
 625             forgotPasswordSecurityTokenDao.saveToken(token);
 626         }
 627     }
 628 
 629     protected void checkUser(AdminUser user, GenericResponse response) {
 630         if (user == null) {
 631             response.addErrorCode(&quot;invalidUser&quot;);
 632         } else if (StringUtils.isBlank(user.getEmail())) {
 633             response.addErrorCode(&quot;emailNotFound&quot;);
 634         } else if (BooleanUtils.isNotTrue(user.getActiveStatusFlag())) {
 635             response.addErrorCode(&quot;inactiveUser&quot;);
 636         }
 637     }
 638 
 639     protected void checkPassword(String password, String confirmPassword, GenericResponse response) {
 640         if (StringUtils.isBlank(password) || StringUtils.isBlank(confirmPassword)) {
 641             response.addErrorCode(&quot;invalidPassword&quot;);
 642         } else if (! password.equals(confirmPassword)) {
 643             response.addErrorCode(&quot;passwordMismatch&quot;);
 644         }
 645     }
 646 
<abbr title=" 647     protected void checkExistingPassword(String unencodedPassword, AdminUser user, GenericResponse response) {"> 647     protected void checkExistingPassword(String unencodedPassword, AdminUser user, GenericResponse responðŸ”µ</abbr>
 648         if (!isPasswordValid(user.getPassword(), unencodedPassword)) {
 649             response.addErrorCode(&quot;invalidPassword&quot;);
 650         }
 651     }
 652 
 653     protected boolean isTokenExpired(ForgotPasswordSecurityToken fpst) {
 654         Date now = SystemTime.asDate();
 655         long currentTimeInMillis = now.getTime();
 656         long tokenSaveTimeInMillis = fpst.getCreateDate().getTime();
 657         long minutesSinceSave = (currentTimeInMillis - tokenSaveTimeInMillis)/60000;
 658         return minutesSinceSave &gt; getTokenExpiredMinutes();
 659     }
 660 
 661     public static int getPASSWORD_TOKEN_LENGTH() {
 662         return TEMP_PASSWORD_LENGTH;
 663     }
 664 
 665     public static void setPASSWORD_TOKEN_LENGTH(int PASSWORD_TOKEN_LENGTH) {
 666         AdminSecurityServiceImpl.TEMP_PASSWORD_LENGTH = PASSWORD_TOKEN_LENGTH;
 667     }
 668 
 669 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 670     public EmailInfo getSendUsernameEmailInfo() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 671         return sendUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 672     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 673 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 674     public void setSendUsernameEmailInfo(EmailInfo sendUsernameEmailInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 675         this.sendUsernameEmailInfo = sendUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 676     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 677 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 678     public EmailInfo getResetPasswordEmailInfo() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 679         return resetPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 680     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 681 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 682     public void setResetPasswordEmailInfo(EmailInfo resetPasswordEmailInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 683         this.resetPasswordEmailInfo = resetPasswordEmailInfo;</span>
 684 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 685                 response.addErrorCode(&quot;invalidToken&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 686             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 687         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 688 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 689         if (! response.getHasErrors()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 690             user.setUnencodedPassword(password);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 691             saveAdminUser(user);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 692             invalidateAllTokensForAdminUser(user);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 693         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 694 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 695         return response;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 696     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 697 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 698     protected void invalidateAllTokensForAdminUser(AdminUser user) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 699         List&lt;ForgotPasswordSecurityToken&gt; tokens = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(user.getId());"> 699         List&lt;ForgotPasswordSecurityToken&gt; tokens = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 700         for (ForgotPasswordSecurityToken token : tokens) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 701             token.setTokenUsedFlag(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 702             forgotPasswordSecurityTokenDao.saveToken(token);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 703         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 704     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 705 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 706     protected void checkUser(AdminUser user, GenericResponse response) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 707         if (user == null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 708             response.addErrorCode(&quot;invalidUser&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 709         } else if (StringUtils.isBlank(user.getEmail())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 710             response.addErrorCode(&quot;emailNotFound&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 711         } else if (BooleanUtils.isNotTrue(user.getActiveStatusFlag())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 712             response.addErrorCode(&quot;inactiveUser&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 713         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 714     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 715     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 716     protected void checkPassword(String password, String confirmPassword, GenericResponse response) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 717         if (StringUtils.isBlank(password) || StringUtils.isBlank(confirmPassword)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 718             response.addErrorCode(&quot;invalidPassword&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 719         } else if (! password.equals(confirmPassword)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 720             response.addErrorCode(&quot;passwordMismatch&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 721         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 722     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 723 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 724     protected void checkExistingPassword(String unencodedPassword, AdminUser user, GenericResponse response) {"> 724     protected void checkExistingPassword(String unencodedPassword, AdminUser user, GenericResponse responðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 725         if (!isPasswordValid(user.getPassword(), unencodedPassword, getSalt(user, unencodedPassword))) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 726             response.addErrorCode(&quot;invalidPassword&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 727         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 728     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 729 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 730     protected boolean isTokenExpired(ForgotPasswordSecurityToken fpst) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 731         Date now = SystemTime.asDate();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 732         long currentTimeInMillis = now.getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 733         long tokenSaveTimeInMillis = fpst.getCreateDate().getTime();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 734         long minutesSinceSave = (currentTimeInMillis - tokenSaveTimeInMillis)/60000;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 735         return minutesSinceSave &gt; getTokenExpiredMinutes();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 736     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 737 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 738     public static int getPASSWORD_TOKEN_LENGTH() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 739         return TEMP_PASSWORD_LENGTH;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 740     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 741 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 742     public static void setPASSWORD_TOKEN_LENGTH(int PASSWORD_TOKEN_LENGTH) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 743         AdminSecurityServiceImpl.TEMP_PASSWORD_LENGTH = PASSWORD_TOKEN_LENGTH;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 744     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 745 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 746     public EmailInfo getSendUsernameEmailInfo() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 747         return sendUsernameEmailInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 748     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 749 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 750     public void setSendUsernameEmailInfo(EmailInfo sendUsernameEmailInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 751         this.sendUsernameEmailInfo = sendUsernameEmailInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 752     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 753 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 754     public EmailInfo getResetPasswordEmailInfo() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 755         return resetPasswordEmailInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 756     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 757 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 758     public void setResetPasswordEmailInfo(EmailInfo resetPasswordEmailInfo) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 759         this.resetPasswordEmailInfo = resetPasswordEmailInfo;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 760     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 761 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 762     @Deprecated</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 763     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 764     public Object getSalt(AdminUser user, String unencodedPassword) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 765         Object salt = null;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 766         if (saltSource != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 767             salt = saltSource.getSalt(new AdminUserDetails(user.getId(), user.getLogin(), unencodedPassword, new ArrayList&lt;GrantedAuthority&gt;()));"> 767             salt = saltSource.getSalt(new AdminUserDetails(user.getId(), user.getLogin(), unencodedPasswoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 768         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 769         return salt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 770     }</span>
 771 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 772     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 773     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 774     public Object getSalt(AdminUser user, String unencodedPassword) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 775         Object salt = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 776         if (saltSource != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 777             salt = saltSource.getSalt(new AdminUserDetails(user.getId(), user.getLogin(), unencodedPassword, new ArrayList&lt;GrantedAuthority&gt;()));"> 777             salt = saltSource.getSalt(new AdminUserDetails(user.getId(), user.getLogin(), unencodedPasswoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 778         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 779         return salt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 780     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 781 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 782     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 783     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 784     public String getSalt() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 785         return salt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 786     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 787 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 788     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 789     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 790     public void setSalt(String salt) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 791         this.salt = salt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 792     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 793 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 794     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 795     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 796     public SaltSource getSaltSource() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 797         return saltSource;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 798     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 799 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 800     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 801     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 802     public void setSaltSource(SaltSource saltSource) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 803         this.saltSource = saltSource;</span>
 804 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 805     }
 806 
 807     @Override
 808     @Transactional(&quot;blTransactionManager&quot;)
 809     public GenericResponse changePassword(String username,
 810             String oldPassword, String password, String confirmPassword) {
 811         GenericResponse response = new GenericResponse();
 812         AdminUser user = null;
 813         if (username != null) {
 814             user = adminUserDao.readAdminUserByUserName(username);
 815         }
 816         checkUser(user, response);
 817         checkPassword(password, confirmPassword, response);
 818 
 819         if (!response.getHasErrors()) {
 820             checkExistingPassword(oldPassword, user, response);
 821         }
 822 
 823         if (!response.getHasErrors()) {
 824             user.setUnencodedPassword(password);
 825             saveAdminUser(user);
 826 
 827         }
 828 
 829         return response;
 830 
 831     }
 832 
 833     /**
<abbr title=" 834      * Determines if a password is valid by comparing it to the encoded string, salting is handled internally to the {@link PasswordEncoder}."> 834      * Determines if a password is valid by comparing it to the encoded string, salting is handled internðŸ”µ</abbr>
 835      * &lt;p&gt;
<abbr title=" 836      * This method must always be called to verify if a password is valid after the original encoded password is generated"> 836      * This method must always be called to verify if a password is valid after the original encoded passðŸ”µ</abbr>
<abbr title=" 837      * due to {@link PasswordEncoder} randomly generating salts internally and appending them to the resulting hash."> 837      * due to {@link PasswordEncoder} randomly generating salts internally and appending them to the resuðŸ”µ</abbr>
 838      *
 839      * @param encodedPassword the encoded password
 840      * @param rawPassword the raw password to check against the encoded password
 841      * @return true if rawPassword matches the encodedPassword, false otherwise
 842      */
 843     protected boolean isPasswordValid(String encodedPassword, String rawPassword) {
 844         return passwordEncoderBean.matches(rawPassword, encodedPassword);
 845     }
 846 
 847     /**
 848      * Generate an encoded password from a raw password
 849      * &lt;p&gt;
<abbr title=" 850      * This method can only be called once per password. The salt is randomly generated internally in the {@link PasswordEncoder}"> 850      * This method can only be called once per password. The salt is randomly generated internally in theðŸ”µ</abbr>
<abbr title=" 851      * and appended to the hash to provide the resulting encoded password. Once this has been called on a password,"> 851      * and appended to the hash to provide the resulting encoded password. Once this has been called on aðŸ”µ</abbr>
<abbr title=" 852      * going forward all checks for authenticity must be done by {@link #isPasswordValid(String, String)} as encoding the"> 852      * going forward all checks for authenticity must be done by {@link #isPasswordValid(String, String)}ðŸ”µ</abbr>
 853      * same password twice will result in different encoded passwords.
 854      *
 855      * @param rawPassword the unencoded password to encode
 856      * @return the encoded password
 857      */
 858     protected String encodePassword(String rawPassword) {
 859         return passwordEncoderBean.encode(rawPassword);
 860     }
 861 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.server.security.service;
  19 
  20 import net.sf.ehcache.Cache;
  21 import net.sf.ehcache.CacheManager;
  22 import net.sf.ehcache.Element;
  23 
  24 import org.apache.commons.collections4.CollectionUtils;
  25 import org.apache.commons.lang3.BooleanUtils;
  26 import org.apache.commons.lang3.StringUtils;
  27 import org.apache.commons.logging.Log;
  28 import org.apache.commons.logging.LogFactory;
  29 import org.broadleafcommerce.common.email.service.EmailService;
  30 import org.broadleafcommerce.common.email.service.info.EmailInfo;
  31 import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;
  32 import org.broadleafcommerce.common.security.util.PasswordChange;
  33 import org.broadleafcommerce.common.security.util.PasswordUtils;
  34 import org.broadleafcommerce.common.service.GenericResponse;
  35 import org.broadleafcommerce.common.time.SystemTime;
  36 import org.broadleafcommerce.common.util.BLCSystemProperty;
  37 import org.broadleafcommerce.common.util.StringUtil;
  38 import org.broadleafcommerce.openadmin.server.security.dao.AdminPermissionDao;
  39 import org.broadleafcommerce.openadmin.server.security.dao.AdminRoleDao;
  40 import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  41 import org.broadleafcommerce.openadmin.server.security.dao.ForgotPasswordSecurityTokenDao;
  42 import org.broadleafcommerce.openadmin.server.security.domain.AdminPermission;
  43 import org.broadleafcommerce.openadmin.server.security.domain.AdminRole;
  44 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  45 import org.broadleafcommerce.openadmin.server.security.domain.ForgotPasswordSecurityToken;
  46 import org.broadleafcommerce.openadmin.server.security.domain.ForgotPasswordSecurityTokenImpl;
  47 import org.broadleafcommerce.openadmin.server.security.event.AdminForgotPasswordEvent;
  48 import org.broadleafcommerce.openadmin.server.security.event.AdminForgotUsernameEvent;
  49 import org.broadleafcommerce.openadmin.server.security.service.type.PermissionType;
  50 import org.springframework.context.ApplicationContext;
  51 import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
  52 import org.springframework.security.core.Authentication;
  53 import org.springframework.security.core.context.SecurityContextHolder;
  54 import org.springframework.security.crypto.password.PasswordEncoder;
  55 import org.springframework.stereotype.Service;
  56 import org.springframework.transaction.annotation.Transactional;
  57 
  58 import java.util.ArrayList;
  59 import java.util.Date;
  60 import java.util.List;
  61 
  62 import javax.annotation.Resource;
  63 
  64 /**
  65  *
  66  * @author jfischer
  67  *
  68  */
  69 @Service(&quot;blAdminSecurityService&quot;)
  70 public class AdminSecurityServiceImpl implements AdminSecurityService {
  71 
  72     private static final Log LOG = LogFactory.getLog(AdminSecurityServiceImpl.class);
  73 
  74     private static int TEMP_PASSWORD_LENGTH = 12;
  75     private static final int FULL_PASSWORD_LENGTH = 16;
  76 
  77     @Autowired
  78     @Qualifier(&quot;blApplicationEventPublisher&quot;)
  79     protected BroadleafApplicationEventPublisher eventPublisher;
  80 
  81     @Resource(name = &quot;blAdminRoleDao&quot;)
  82     protected AdminRoleDao adminRoleDao;
  83 
  84     @Resource(name = &quot;blAdminUserDao&quot;)
  85     protected AdminUserDao adminUserDao;
  86 
  87     @Resource(name = &quot;blForgotPasswordSecurityTokenDao&quot;)
  88     protected ForgotPasswordSecurityTokenDao forgotPasswordSecurityTokenDao;
  89 
  90     @Resource(name = &quot;blAdminPermissionDao&quot;)
  91     protected AdminPermissionDao adminPermissionDao;
  92 
  93     protected static String CACHE_NAME = &quot;blSecurityElements&quot;;
  94     protected static String CACHE_KEY_PREFIX = &quot;security:&quot;;
  95     protected Cache cache = CacheManager.getInstance().getCache(CACHE_NAME);
  96 
  97     /**
<abbr title="  98      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using the">  98      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;rðŸ”µ</abbr>
<abbr title="  99      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}">  99      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.eðŸ”µ</abbr>
 100      */
 101     @Resource(name=&quot;blAdminPasswordEncoder&quot;)
 102     protected PasswordEncoder passwordEncoderBean;
 103 
 104     protected int getTokenExpiredMinutes() {
 105         return BLCSystemProperty.resolveIntSystemProperty(&quot;tokenExpiredMinutes&quot;);
 106     }
 107 
 108     protected String getResetPasswordURL() {
 109         return BLCSystemProperty.resolveSystemProperty(&quot;resetPasswordURL&quot;);
 110     }
 111 
 112     @Override
 113     @Transactional(&quot;blTransactionManager&quot;)
 114     public void deleteAdminPermission(AdminPermission permission) {
 115         adminPermissionDao.deleteAdminPermission(permission);
 116         clearAdminSecurityCache();
 117     }
 118 
 119     @Override
 120     @Transactional(&quot;blTransactionManager&quot;)
 121     public void deleteAdminRole(AdminRole role) {
 122         adminRoleDao.deleteAdminRole(role);
 123         clearAdminSecurityCache();
 124     }
 125 
 126     @Override
 127     @Transactional(&quot;blTransactionManager&quot;)
 128     public void deleteAdminUser(AdminUser user) {
 129         adminUserDao.deleteAdminUser(user);
 130         clearAdminSecurityCache();
 131     }
 132 
 133     @Override
 134     public AdminPermission readAdminPermissionById(Long id) {
 135         return adminPermissionDao.readAdminPermissionById(id);
 136     }
 137 
 138     @Override
 139     public AdminRole readAdminRoleById(Long id) {
 140         return adminRoleDao.readAdminRoleById(id);
 141     }
 142 
 143     @Override
 144     public AdminUser readAdminUserById(Long id) {
 145         return adminUserDao.readAdminUserById(id);
 146     }
 147 
 148     @Override
 149     @Transactional(&quot;blTransactionManager&quot;)
 150     public AdminPermission saveAdminPermission(AdminPermission permission) {
 151         permission = adminPermissionDao.saveAdminPermission(permission);
 152         clearAdminSecurityCache();
 153         return permission;
 154     }
 155 
 156     @Override
 157     @Transactional(&quot;blTransactionManager&quot;)
 158     public AdminRole saveAdminRole(AdminRole role) {
 159         role = adminRoleDao.saveAdminRole(role);
 160         clearAdminSecurityCache();
 161         return role;
 162     }
 163 
 164     @Override
 165     @Transactional(&quot;blTransactionManager&quot;)
 166     public AdminUser saveAdminUser(AdminUser user) {
 167         boolean encodePasswordNeeded = false;
 168         String unencodedPassword = user.getUnencodedPassword();
 169 
 170         if (user.getUnencodedPassword() != null) {
 171             encodePasswordNeeded = true;
 172             user.setPassword(unencodedPassword);
 173         }
 174 
 175         // If no password is set, default to a secure password.
 176         if (user.getPassword() == null) {
 177             user.setPassword(generateSecurePassword());
 178         }
 179 
 180         AdminUser returnUser = adminUserDao.saveAdminUser(user);
 181 
 182         if (encodePasswordNeeded) {
 183             returnUser.setPassword(encodePassword(unencodedPassword));
 184         }
 185 
 186         returnUser = adminUserDao.saveAdminUser(returnUser);
 187         clearAdminSecurityCache();
 188         return returnUser;
 189     }
 190 
 191     @Override
 192     public void clearAdminSecurityCache() {
 193         if (LOG.isTraceEnabled()) {
 194             LOG.trace(&quot;Admin Security Cache DELETE&quot;);
 195         }
 196         cache.removeAll();
 197     }
 198 
 199     protected String generateSecurePassword() {
 200         return PasswordUtils.generateSecurePassword(FULL_PASSWORD_LENGTH);
 201     }
 202 
 203     @Override
 204     @Transactional(&quot;blTransactionManager&quot;)
 205     public AdminUser changePassword(PasswordChange passwordChange) {
 206         AdminUser user = readAdminUserByUserName(passwordChange.getUsername());
 207         user.setUnencodedPassword(passwordChange.getNewPassword());
 208         user = saveAdminUser(user);
 209         Authentication auth = SecurityContextHolder.getContext().getAuthentication();
<abbr title=" 210         UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(passwordChange.getUsername(), passwordChange.getNewPassword(), auth.getAuthorities());"> 210         UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(passworðŸ”µ</abbr>
 211         SecurityContextHolder.getContext().setAuthentication(authRequest);
 212         auth.setAuthenticated(false);
 213         return user;
 214     }
 215 
 216     @Override
<abbr title=" 217     public boolean isUserQualifiedForOperationOnCeilingEntity(AdminUser adminUser, PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 217     public boolean isUserQualifiedForOperationOnCeilingEntity(AdminUser adminUser, PermissionType permissðŸ”µ</abbr>
 218         Boolean response = null;
 219         String cacheKey = buildCacheKey(adminUser, permissionType, ceilingEntityFullyQualifiedName);
 220         Element cacheElement = cache.get(cacheKey);
 221 
 222         if (cacheElement != null) {
 223             response = (Boolean) cacheElement.getObjectValue();
 224 
 225             if (LOG.isTraceEnabled()) {
 226                 LOG.trace(&quot;Admin Security Cache GET For: \&quot;&quot; + cacheKey + &quot;\&quot; = &quot; + response);
 227             }
 228         }
 229 
 230         if (response == null) {
<abbr title=" 231             response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntity(adminUser, permissionType, ceilingEntityFullyQualifiedName);"> 231             response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntity(adminUser, permissioðŸ”µ</abbr>
 232 
 233             if (!response) {
<abbr title=" 234                 response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntityViaDefaultPermissions(ceilingEntityFullyQualifiedName);"> 234                 response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntityViaDefaultPermissðŸ”µ</abbr>
 235             }
 236 
 237             cacheElement = new Element(cacheKey, response);
 238             cache.put(cacheElement);
 239 
 240             if (LOG.isTraceEnabled()) {
 241                 LOG.trace(&quot;Admin Security Cache PUT For: \&quot;&quot; + cacheKey + &quot;\&quot; = &quot; + response);
 242             }
 243         }
 244 
 245         return response;
 246     }
 247 
<abbr title=" 248     protected String buildCacheKey(AdminUser adminUser, PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 248     protected String buildCacheKey(AdminUser adminUser, PermissionType permissionType, String ceilingEntiðŸ”µ</abbr>
 249         return CACHE_KEY_PREFIX
 250                + &quot;user:&quot; + adminUser.getId() + &quot;,&quot;
 251                + &quot;permType:&quot; + permissionType.getFriendlyType() + &quot;,&quot;
 252                + &quot;ceiling:&quot; + ceilingEntityFullyQualifiedName;
 253     }
 254 
 255     @Override
<abbr title=" 256     public boolean doesOperationExistForCeilingEntity(PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 256     public boolean doesOperationExistForCeilingEntity(PermissionType permissionType, String ceilingEntityðŸ”µ</abbr>
<abbr title=" 257         return adminPermissionDao.doesOperationExistForCeilingEntity(permissionType, ceilingEntityFullyQualifiedName);"> 257         return adminPermissionDao.doesOperationExistForCeilingEntity(permissionType, ceilingEntityFullyQuðŸ”µ</abbr>
 258     }
 259 
 260     @Override
 261     public AdminUser readAdminUserByUserName(String userName) {
 262         return adminUserDao.readAdminUserByUserName(userName);
 263     }
 264 
 265     @Override
 266     public List&lt;AdminUser&gt; readAdminUsersByEmail(String email) {
 267         return adminUserDao.readAdminUserByEmail(email);
 268     }
 269 
 270     @Override
 271     public List&lt;AdminUser&gt; readAllAdminUsers() {
 272         return adminUserDao.readAllAdminUsers();
 273     }
 274 
 275     @Override
 276     public List&lt;AdminRole&gt; readAllAdminRoles() {
 277         return adminRoleDao.readAllAdminRoles();
 278     }
 279 
 280     @Override
 281     public List&lt;AdminPermission&gt; readAllAdminPermissions() {
 282         return adminPermissionDao.readAllAdminPermissions();
 283     }
 284 
 285     @Override
 286     @Transactional(&quot;blTransactionManager&quot;)
 287     public GenericResponse sendForgotUsernameNotification(String emailAddress) {
 288         GenericResponse response = new GenericResponse();
 289         List&lt;AdminUser&gt; users = null;
 290         if (emailAddress != null) {
 291             users = adminUserDao.readAdminUserByEmail(emailAddress);
 292         }
 293         if (CollectionUtils.isEmpty(users)) {
 294             response.addErrorCode(&quot;notFound&quot;);
 295         } else {
 296             List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();
 297             for (AdminUser user : users) {
 298                 if (user.getActiveStatusFlag()) {
 299                     activeUsernames.add(user.getLogin());
 300                 }
 301             }
 302 
 303             if (activeUsernames.size() &gt; 0) {
<abbr title=" 304                 eventPublisher.publishEvent(new AdminForgotUsernameEvent(this, emailAddress, null, activeUsernames));"> 304                 eventPublisher.publishEvent(new AdminForgotUsernameEvent(this, emailAddress, null, activeðŸ”µ</abbr>
 305             } else {
 306                 // send inactive username found email.
 307                 response.addErrorCode(&quot;inactiveUser&quot;);
 308             }
 309         }
 310         return response;
 311     }
 312 
 313     @Override
 314     @Transactional(&quot;blTransactionManager&quot;)
 315     public GenericResponse sendResetPasswordNotification(String username) {
 316         GenericResponse response = new GenericResponse();
 317         AdminUser user = null;
 318 
 319         if (username != null) {
 320             user = adminUserDao.readAdminUserByUserName(username);
 321         }
 322 
 323         checkUser(user,response);
 324 
 325         if (! response.getHasErrors()) {
 326             String token = PasswordUtils.generateSecurePassword(TEMP_PASSWORD_LENGTH);
 327             token = token.toLowerCase();
 328 
 329             ForgotPasswordSecurityToken fpst = new ForgotPasswordSecurityTokenImpl();
 330             fpst.setAdminUserId(user.getId());
 331             fpst.setToken(encodePassword(token));
 332             fpst.setCreateDate(SystemTime.asDate());
 333             forgotPasswordSecurityTokenDao.saveToken(fpst);
 334 
 335             String resetPasswordUrl = getResetPasswordURL();
 336             if (!StringUtils.isEmpty(resetPasswordUrl)) {
 337                 if (resetPasswordUrl.contains(&quot;?&quot;)) {
 338                     resetPasswordUrl=resetPasswordUrl+&quot;&amp;token=&quot;+token;
 339                 } else {
 340                     resetPasswordUrl=resetPasswordUrl+&quot;?token=&quot;+token;
 341                 }
 342             }
 343 
<abbr title=" 344             eventPublisher.publishEvent(new AdminForgotPasswordEvent(this, user.getId(), token, resetPasswordUrl));"> 344             eventPublisher.publishEvent(new AdminForgotPasswordEvent(this, user.getId(), token, resetPassðŸ”µ</abbr>
 345         }
 346         return response;
 347     }
 348 
 349     @Override
 350     @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 351     public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPassword) {"> 351     public GenericResponse resetPasswordUsingToken(String username, String token, String password, StringðŸ”µ</abbr>
 352         GenericResponse response = new GenericResponse();
 353         AdminUser user = null;
 354         if (username != null) {
 355             user = adminUserDao.readAdminUserByUserName(username);
 356         }
 357         checkUser(user, response);
 358         checkPassword(password, confirmPassword, response);
 359         if (StringUtils.isBlank(token)) {
 360             response.addErrorCode(&quot;invalidToken&quot;);
 361         }
 362 
 363         ForgotPasswordSecurityToken fpst = null;
 364         if (! response.getHasErrors()) {
 365             token = token.toLowerCase();
<abbr title=" 366             List&lt;ForgotPasswordSecurityToken&gt; fpstoks = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(user.getId());"> 366             List&lt;ForgotPasswordSecurityToken&gt; fpstoks = forgotPasswordSecurityTokenDao.readUnusedTokensByðŸ”µ</abbr>
 367             for (ForgotPasswordSecurityToken fpstok : fpstoks) {
 368                 if (isPasswordValid(fpstok.getToken(), token)) {
 369                     fpst = fpstok;
 370                     break;
 371                 }
 372             }
 373             if (fpst == null) {
 374                 response.addErrorCode(&quot;invalidToken&quot;);
 375             } else if (fpst.isTokenUsedFlag()) {
 376                 response.addErrorCode(&quot;tokenUsed&quot;);
 377             } else if (isTokenExpired(fpst)) {
 378                 response.addErrorCode(&quot;tokenExpired&quot;);
 379             }
 380         }
 381 
 382         if (! response.getHasErrors()) {
 383             if (! user.getId().equals(fpst.getAdminUserId())) {
 384                 if (LOG.isWarnEnabled()) {
<abbr title=" 385                     LOG.warn(&quot;Password reset attempt tried with mismatched user and token &quot; + user.getId() + &quot;, &quot; + StringUtil.sanitize(token));"> 385                     LOG.warn(&quot;Password reset attempt tried with mismatched user and token &quot; + user.getId(ðŸ”µ</abbr>
 386                 }
 387                 response.addErrorCode(&quot;invalidToken&quot;);
 388             }
 389         }
 390 
 391         if (! response.getHasErrors()) {
 392             user.setUnencodedPassword(password);
 393             saveAdminUser(user);
 394             invalidateAllTokensForAdminUser(user);
 395         }
 396 
 397         return response;
 398     }
 399 
 400     protected void invalidateAllTokensForAdminUser(AdminUser user) {
<abbr title=" 401         List&lt;ForgotPasswordSecurityToken&gt; tokens = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(user.getId());"> 401         List&lt;ForgotPasswordSecurityToken&gt; tokens = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminðŸ”µ</abbr>
 402         for (ForgotPasswordSecurityToken token : tokens) {
 403             token.setTokenUsedFlag(true);
 404             forgotPasswordSecurityTokenDao.saveToken(token);
 405         }
 406     }
 407 
 408     protected void checkUser(AdminUser user, GenericResponse response) {
 409         if (user == null) {
 410             response.addErrorCode(&quot;invalidUser&quot;);
 411         } else if (StringUtils.isBlank(user.getEmail())) {
 412             response.addErrorCode(&quot;emailNotFound&quot;);
 413         } else if (BooleanUtils.isNotTrue(user.getActiveStatusFlag())) {
 414             response.addErrorCode(&quot;inactiveUser&quot;);
 415         }
 416     }
 417 
 418     protected void checkPassword(String password, String confirmPassword, GenericResponse response) {
 419         if (StringUtils.isBlank(password) || StringUtils.isBlank(confirmPassword)) {
 420             response.addErrorCode(&quot;invalidPassword&quot;);
 421         } else if (! password.equals(confirmPassword)) {
 422             response.addErrorCode(&quot;passwordMismatch&quot;);
 423         }
 424     }
 425 
<abbr title=" 426     protected void checkExistingPassword(String unencodedPassword, AdminUser user, GenericResponse response) {"> 426     protected void checkExistingPassword(String unencodedPassword, AdminUser user, GenericResponse responðŸ”µ</abbr>
 427         if (!isPasswordValid(user.getPassword(), unencodedPassword)) {
 428             response.addErrorCode(&quot;invalidPassword&quot;);
 429         }
 430     }
 431 
 432     protected boolean isTokenExpired(ForgotPasswordSecurityToken fpst) {
 433         Date now = SystemTime.asDate();
 434         long currentTimeInMillis = now.getTime();
 435         long tokenSaveTimeInMillis = fpst.getCreateDate().getTime();
 436         long minutesSinceSave = (currentTimeInMillis - tokenSaveTimeInMillis)/60000;
 437         return minutesSinceSave &gt; getTokenExpiredMinutes();
 438     }
 439 
 440     public static int getPASSWORD_TOKEN_LENGTH() {
 441         return TEMP_PASSWORD_LENGTH;
 442     }
 443 
 444     public static void setPASSWORD_TOKEN_LENGTH(int PASSWORD_TOKEN_LENGTH) {
 445         AdminSecurityServiceImpl.TEMP_PASSWORD_LENGTH = PASSWORD_TOKEN_LENGTH;
 446     }
 447 
 448     @Override
 449     @Transactional(&quot;blTransactionManager&quot;)
 450     public GenericResponse changePassword(String username,
 451             String oldPassword, String password, String confirmPassword) {
 452         GenericResponse response = new GenericResponse();
 453         AdminUser user = null;
 454         if (username != null) {
 455             user = adminUserDao.readAdminUserByUserName(username);
 456         }
 457         checkUser(user, response);
 458         checkPassword(password, confirmPassword, response);
 459 
 460         if (!response.getHasErrors()) {
 461             checkExistingPassword(oldPassword, user, response);
 462         }
 463 
 464         if (!response.getHasErrors()) {
 465             user.setUnencodedPassword(password);
 466             saveAdminUser(user);
 467 
 468         }
 469 
 470         return response;
 471 
 472     }
 473 
 474     /**
<abbr title=" 475      * Determines if a password is valid by comparing it to the encoded string, salting is handled internally to the {@link PasswordEncoder}."> 475      * Determines if a password is valid by comparing it to the encoded string, salting is handled internðŸ”µ</abbr>
 476      * &lt;p&gt;
<abbr title=" 477      * This method must always be called to verify if a password is valid after the original encoded password is generated"> 477      * This method must always be called to verify if a password is valid after the original encoded passðŸ”µ</abbr>
<abbr title=" 478      * due to {@link PasswordEncoder} randomly generating salts internally and appending them to the resulting hash."> 478      * due to {@link PasswordEncoder} randomly generating salts internally and appending them to the resuðŸ”µ</abbr>
 479      *
 480      * @param encodedPassword the encoded password
 481      * @param rawPassword the raw password to check against the encoded password
 482      * @return true if rawPassword matches the encodedPassword, false otherwise
 483      */
 484     protected boolean isPasswordValid(String encodedPassword, String rawPassword) {
 485         return passwordEncoderBean.matches(rawPassword, encodedPassword);
 486     }
 487 
 488     /**
 489      * Generate an encoded password from a raw password
 490      * &lt;p&gt;
<abbr title=" 491      * This method can only be called once per password. The salt is randomly generated internally in the {@link PasswordEncoder}"> 491      * This method can only be called once per password. The salt is randomly generated internally in theðŸ”µ</abbr>
<abbr title=" 492      * and appended to the hash to provide the resulting encoded password. Once this has been called on a password,"> 492      * and appended to the hash to provide the resulting encoded password. Once this has been called on aðŸ”µ</abbr>
<abbr title=" 493      * going forward all checks for authenticity must be done by {@link #isPasswordValid(String, String)} as encoding the"> 493      * going forward all checks for authenticity must be done by {@link #isPasswordValid(String, String)}ðŸ”µ</abbr>
 494      * same password twice will result in different encoded passwords.
 495      *
 496      * @param rawPassword the unencoded password to encode
 497      * @return the encoded password
 498      */
 499     protected String encodePassword(String rawPassword) {
 500         return passwordEncoderBean.encode(rawPassword);
 501     }
 502 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.server.security.service;
  19 
  20 import java.util.ArrayList;
  21 import java.util.Date;
  22 import java.util.List;
  23 import javax.annotation.Resource;
  24 import net.sf.ehcache.Cache;
  25 import net.sf.ehcache.CacheManager;
  26 import net.sf.ehcache.Element;
  27 import org.apache.commons.collections4.CollectionUtils;
  28 import org.apache.commons.lang3.BooleanUtils;
  29 import org.apache.commons.lang3.StringUtils;
  30 import org.apache.commons.logging.Log;
  31 import org.apache.commons.logging.LogFactory;
  32 import org.broadleafcommerce.common.email.service.EmailService;
  33 import org.broadleafcommerce.common.email.service.info.EmailInfo;
  34 import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;
  35 import org.broadleafcommerce.common.security.util.PasswordChange;
  36 import org.broadleafcommerce.common.security.util.PasswordUtils;
  37 import org.broadleafcommerce.common.service.GenericResponse;
  38 import org.broadleafcommerce.common.time.SystemTime;
  39 import org.broadleafcommerce.common.util.BLCSystemProperty;
  40 import org.broadleafcommerce.common.util.StringUtil;
  41 import org.broadleafcommerce.openadmin.server.security.dao.AdminPermissionDao;
  42 import org.broadleafcommerce.openadmin.server.security.dao.AdminRoleDao;
  43 import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  44 import org.broadleafcommerce.openadmin.server.security.dao.ForgotPasswordSecurityTokenDao;
  45 import org.broadleafcommerce.openadmin.server.security.domain.AdminPermission;
  46 import org.broadleafcommerce.openadmin.server.security.domain.AdminRole;
  47 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  48 import org.broadleafcommerce.openadmin.server.security.domain.ForgotPasswordSecurityToken;
  49 import org.broadleafcommerce.openadmin.server.security.domain.ForgotPasswordSecurityTokenImpl;
  50 import org.broadleafcommerce.openadmin.server.security.event.AdminForgotPasswordEvent;
  51 import org.broadleafcommerce.openadmin.server.security.event.AdminForgotUsernameEvent;
  52 import org.broadleafcommerce.openadmin.server.security.service.type.PermissionType;
  53 import org.springframework.context.ApplicationContext;
  54 import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
  55 import org.springframework.security.core.Authentication;
  56 import org.springframework.security.core.context.SecurityContextHolder;
  57 import org.springframework.security.crypto.password.PasswordEncoder;
  58 import org.springframework.stereotype.Service;
  59 import org.springframework.transaction.annotation.Transactional;
  60 
  61 
  62 /**
  63  *
  64  * @author jfischer
  65  *
  66  */
  67 @Service(&quot;blAdminSecurityService&quot;)
  68 public class AdminSecurityServiceImpl implements AdminSecurityService {
  69 
  70     private static final Log LOG = LogFactory.getLog(AdminSecurityServiceImpl.class);
  71 
  72     private static int TEMP_PASSWORD_LENGTH = 12;
  73     private static final int FULL_PASSWORD_LENGTH = 16;
  74 
  75     @Autowired
  76     @Qualifier(&quot;blApplicationEventPublisher&quot;)
  77     protected BroadleafApplicationEventPublisher eventPublisher;
  78 
  79     @Resource(name = &quot;blAdminRoleDao&quot;)
  80     protected AdminRoleDao adminRoleDao;
  81 
  82     @Resource(name = &quot;blAdminUserDao&quot;)
  83     protected AdminUserDao adminUserDao;
  84 
  85     @Resource(name = &quot;blForgotPasswordSecurityTokenDao&quot;)
  86     protected ForgotPasswordSecurityTokenDao forgotPasswordSecurityTokenDao;
  87 
  88     @Resource(name = &quot;blAdminPermissionDao&quot;)
  89     protected AdminPermissionDao adminPermissionDao;
  90 
  91     protected static String CACHE_NAME = &quot;blSecurityElements&quot;;
  92     protected static String CACHE_KEY_PREFIX = &quot;security:&quot;;
  93     protected Cache cache = CacheManager.getInstance().getCache(CACHE_NAME);
  94 
  95     /**
<abbr title="  96      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using the">  96      * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;rðŸ”µ</abbr>
<abbr title="  97      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}">  97      * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.eðŸ”µ</abbr>
  98      */
  99     @Resource(name=&quot;blAdminPasswordEncoder&quot;)
 100     protected PasswordEncoder passwordEncoderBean;
 101 
 102 
 103 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 104     @Resource(name=&quot;blEmailService&quot;)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 105     protected EmailService emailService;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 107     @Resource(name=&quot;blSendAdminResetPasswordEmail&quot;)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 108     protected EmailInfo resetPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 109 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 110     @Resource(name=&quot;blSendAdminUsernameEmailInfo&quot;)</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 111     protected EmailInfo sendUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 112 </span>
 113 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 114 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 114 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 115 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 118      * &lt;p&gt;Sets either {@link #passwordEncoder} or {@link #passwordEncoderNew} based on the type of {@link #passwordEncoderBean}"> 118      * &lt;p&gt;Sets either {@link #passwordEncoder} or {@link #passwordEncoderNew} based on the type of {@linkðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 119      * in order to provide bean configuration backwards compatibility with the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder} bean."> 119      * in order to provide bean configuration backwards compatibility with the deprecated {@link org.spriðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121      * &lt;p&gt;{@link #passwordEncoderBean} is set by the bean defined as &quot;blPasswordEncoder&quot;.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 123      * &lt;p&gt;This class will utilize either the new or deprecated PasswordEncoder type depending on which is not null."> 123      * &lt;p&gt;This class will utilize either the new or deprecated PasswordEncoder type depending on which isðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124      *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 125      * @throws NoSuchBeanDefinitionException if {@link #passwordEncoderBean} is null or not an instance of either PasswordEncoder"> 125      * @throws NoSuchBeanDefinitionException if {@link #passwordEncoderBean} is null or not an instance oðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127     @PostConstruct</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128     protected void setupPasswordEncoder() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129         passwordEncoderNew = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130         passwordEncoder = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131         if (passwordEncoderBean instanceof PasswordEncoder) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132             passwordEncoderNew = (PasswordEncoder) passwordEncoderBean;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 133         } else if (passwordEncoderBean instanceof org.springframework.security.authentication.encoding.PasswordEncoder) {"> 133         } else if (passwordEncoderBean instanceof org.springframework.security.authentication.encoding.PaðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 134             passwordEncoder = (org.springframework.security.authentication.encoding.PasswordEncoder) passwordEncoderBean;"> 134             passwordEncoder = (org.springframework.security.authentication.encoding.PasswordEncoder) passðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 135         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136             throw new NoSuchBeanDefinitionException(&quot;No PasswordEncoder bean is defined&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139 </span>
 140 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 141 
 142     protected int getTokenExpiredMinutes() {
 143         return BLCSystemProperty.resolveIntSystemProperty(&quot;tokenExpiredMinutes&quot;);
 144     }
 145 
 146     protected String getResetPasswordURL() {
 147         return BLCSystemProperty.resolveSystemProperty(&quot;resetPasswordURL&quot;);
 148     }
 149 
 150     @Override
 151     @Transactional(&quot;blTransactionManager&quot;)
 152     public void deleteAdminPermission(AdminPermission permission) {
 153         adminPermissionDao.deleteAdminPermission(permission);
 154         clearAdminSecurityCache();
 155     }
 156 
 157     @Override
 158     @Transactional(&quot;blTransactionManager&quot;)
 159     public void deleteAdminRole(AdminRole role) {
 160         adminRoleDao.deleteAdminRole(role);
 161         clearAdminSecurityCache();
 162     }
 163 
 164     @Override
 165     @Transactional(&quot;blTransactionManager&quot;)
 166     public void deleteAdminUser(AdminUser user) {
 167         adminUserDao.deleteAdminUser(user);
 168         clearAdminSecurityCache();
 169     }
 170 
 171     @Override
 172     public AdminPermission readAdminPermissionById(Long id) {
 173         return adminPermissionDao.readAdminPermissionById(id);
 174     }
 175 
 176     @Override
 177     public AdminRole readAdminRoleById(Long id) {
 178         return adminRoleDao.readAdminRoleById(id);
 179     }
 180 
 181     @Override
 182     public AdminUser readAdminUserById(Long id) {
 183         return adminUserDao.readAdminUserById(id);
 184     }
 185 
 186     @Override
 187     @Transactional(&quot;blTransactionManager&quot;)
 188     public AdminPermission saveAdminPermission(AdminPermission permission) {
 189         permission = adminPermissionDao.saveAdminPermission(permission);
 190         clearAdminSecurityCache();
 191         return permission;
 192     }
 193 
 194     @Override
 195     @Transactional(&quot;blTransactionManager&quot;)
 196     public AdminRole saveAdminRole(AdminRole role) {
 197         role = adminRoleDao.saveAdminRole(role);
 198         clearAdminSecurityCache();
 199         return role;
 200     }
 201 
 202     @Override
 203     @Transactional(&quot;blTransactionManager&quot;)
 204     public AdminUser saveAdminUser(AdminUser user) {
 205         boolean encodePasswordNeeded = false;
 206         String unencodedPassword = user.getUnencodedPassword();
 207 
 208         if (user.getUnencodedPassword() != null) {
 209             encodePasswordNeeded = true;
 210             user.setPassword(unencodedPassword);
 211         }
 212 
 213         // If no password is set, default to a secure password.
 214         if (user.getPassword() == null) {
 215             user.setPassword(generateSecurePassword());
 216         }
 217 
 218         AdminUser returnUser = adminUserDao.saveAdminUser(user);
 219 
 220         if (encodePasswordNeeded) {
 221             returnUser.setPassword(encodePassword(unencodedPassword));
 222         }
 223 
 224         returnUser = adminUserDao.saveAdminUser(returnUser);
 225         clearAdminSecurityCache();
 226         return returnUser;
 227     }
 228 
 229     @Override
 230     public void clearAdminSecurityCache() {
 231         if (LOG.isTraceEnabled()) {
 232             LOG.trace(&quot;Admin Security Cache DELETE&quot;);
 233         }
 234         cache.removeAll();
 235     }
 236 
 237     protected String generateSecurePassword() {
 238         return PasswordUtils.generateSecurePassword(FULL_PASSWORD_LENGTH);
 239     }
 240 
 241     @Override
 242     @Transactional(&quot;blTransactionManager&quot;)
 243     public AdminUser changePassword(PasswordChange passwordChange) {
 244         AdminUser user = readAdminUserByUserName(passwordChange.getUsername());
 245         user.setUnencodedPassword(passwordChange.getNewPassword());
 246         user = saveAdminUser(user);
 247         Authentication auth = SecurityContextHolder.getContext().getAuthentication();
<abbr title=" 248         UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(passwordChange.getUsername(), passwordChange.getNewPassword(), auth.getAuthorities());"> 248         UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(passworðŸ”µ</abbr>
 249         SecurityContextHolder.getContext().setAuthentication(authRequest);
 250         auth.setAuthenticated(false);
 251         return user;
 252     }
 253 
 254     @Override
<abbr title=" 255     public boolean isUserQualifiedForOperationOnCeilingEntity(AdminUser adminUser, PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 255     public boolean isUserQualifiedForOperationOnCeilingEntity(AdminUser adminUser, PermissionType permissðŸ”µ</abbr>
 256         Boolean response = null;
 257         String cacheKey = buildCacheKey(adminUser, permissionType, ceilingEntityFullyQualifiedName);
 258         Element cacheElement = cache.get(cacheKey);
 259 
 260         if (cacheElement != null) {
 261             response = (Boolean) cacheElement.getObjectValue();
 262 
 263             if (LOG.isTraceEnabled()) {
 264                 LOG.trace(&quot;Admin Security Cache GET For: \&quot;&quot; + cacheKey + &quot;\&quot; = &quot; + response);
 265             }
 266         }
 267 
 268         if (response == null) {
<abbr title=" 269             response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntity(adminUser, permissionType, ceilingEntityFullyQualifiedName);"> 269             response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntity(adminUser, permissioðŸ”µ</abbr>
 270 
 271             if (!response) {
<abbr title=" 272                 response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntityViaDefaultPermissions(ceilingEntityFullyQualifiedName);"> 272                 response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntityViaDefaultPermissðŸ”µ</abbr>
 273             }
 274 
 275             cacheElement = new Element(cacheKey, response);
 276             cache.put(cacheElement);
 277 
 278             if (LOG.isTraceEnabled()) {
 279                 LOG.trace(&quot;Admin Security Cache PUT For: \&quot;&quot; + cacheKey + &quot;\&quot; = &quot; + response);
 280             }
 281         }
 282 
 283         return response;
 284     }
 285 
<abbr title=" 286     protected String buildCacheKey(AdminUser adminUser, PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 286     protected String buildCacheKey(AdminUser adminUser, PermissionType permissionType, String ceilingEntiðŸ”µ</abbr>
 287         return CACHE_KEY_PREFIX
 288                + &quot;user:&quot; + adminUser.getId() + &quot;,&quot;
 289                + &quot;permType:&quot; + permissionType.getFriendlyType() + &quot;,&quot;
 290                + &quot;ceiling:&quot; + ceilingEntityFullyQualifiedName;
 291     }
 292 
 293     @Override
<abbr title=" 294     public boolean doesOperationExistForCeilingEntity(PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 294     public boolean doesOperationExistForCeilingEntity(PermissionType permissionType, String ceilingEntityðŸ”µ</abbr>
<abbr title=" 295         return adminPermissionDao.doesOperationExistForCeilingEntity(permissionType, ceilingEntityFullyQualifiedName);"> 295         return adminPermissionDao.doesOperationExistForCeilingEntity(permissionType, ceilingEntityFullyQuðŸ”µ</abbr>
 296     }
 297 
 298     @Override
 299     public AdminUser readAdminUserByUserName(String userName) {
 300         return adminUserDao.readAdminUserByUserName(userName);
 301     }
 302 
 303     @Override
 304     public List&lt;AdminUser&gt; readAdminUsersByEmail(String email) {
 305         return adminUserDao.readAdminUserByEmail(email);
 306     }
 307 
 308     @Override
 309     public List&lt;AdminUser&gt; readAllAdminUsers() {
 310         return adminUserDao.readAllAdminUsers();
 311     }
 312 
 313     @Override
 314     public List&lt;AdminRole&gt; readAllAdminRoles() {
 315         return adminRoleDao.readAllAdminRoles();
 316     }
 317 
 318     @Override
 319     public List&lt;AdminPermission&gt; readAllAdminPermissions() {
 320         return adminPermissionDao.readAllAdminPermissions();
 321     }
 322 
 323     @Override
 324     @Transactional(&quot;blTransactionManager&quot;)
 325     public GenericResponse sendForgotUsernameNotification(String emailAddress) {
 326         GenericResponse response = new GenericResponse();
 327         List&lt;AdminUser&gt; users = null;
 328         if (emailAddress != null) {
 329             users = adminUserDao.readAdminUserByEmail(emailAddress);
 330         }
 331         if (CollectionUtils.isEmpty(users)) {
 332             response.addErrorCode(&quot;notFound&quot;);
 333         } else {
 334             List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();
 335             for (AdminUser user : users) {
 336                 if (user.getActiveStatusFlag()) {
 337                     activeUsernames.add(user.getLogin());
 338                 }
 339             }
 340 
 341             if (activeUsernames.size() &gt; 0) {
<abbr title=" 342                 eventPublisher.publishEvent(new AdminForgotUsernameEvent(this, emailAddress, null, activeUsernames));"> 342                 eventPublisher.publishEvent(new AdminForgotUsernameEvent(this, emailAddress, null, activeðŸ”µ</abbr>
 343             } else {
 344                 // send inactive username found email.
 345                 response.addErrorCode(&quot;inactiveUser&quot;);
 346             }
 347         }
 348         return response;
 349     }
 350 
 351     @Override
 352     @Transactional(&quot;blTransactionManager&quot;)
 353     public GenericResponse sendResetPasswordNotification(String username) {
 354         GenericResponse response = new GenericResponse();
 355         AdminUser user = null;
 356 
 357         if (username != null) {
 358             user = adminUserDao.readAdminUserByUserName(username);
 359         }
 360 
 361         checkUser(user,response);
 362 
 363         if (! response.getHasErrors()) {
 364             String token = PasswordUtils.generateSecurePassword(TEMP_PASSWORD_LENGTH);
 365             token = token.toLowerCase();
 366 
 367             ForgotPasswordSecurityToken fpst = new ForgotPasswordSecurityTokenImpl();
 368             fpst.setAdminUserId(user.getId());
 369             fpst.setToken(encodePassword(token));
 370             fpst.setCreateDate(SystemTime.asDate());
 371             forgotPasswordSecurityTokenDao.saveToken(fpst);
 372 
 373             String resetPasswordUrl = getResetPasswordURL();
 374             if (!StringUtils.isEmpty(resetPasswordUrl)) {
 375                 if (resetPasswordUrl.contains(&quot;?&quot;)) {
 376                     resetPasswordUrl=resetPasswordUrl+&quot;&amp;token=&quot;+token;
 377                 } else {
 378                     resetPasswordUrl=resetPasswordUrl+&quot;?token=&quot;+token;
 379                 }
 380             }
 381 
<abbr title=" 382             eventPublisher.publishEvent(new AdminForgotPasswordEvent(this, user.getId(), token, resetPasswordUrl));"> 382             eventPublisher.publishEvent(new AdminForgotPasswordEvent(this, user.getId(), token, resetPassðŸ”µ</abbr>
 383         }
 384         return response;
 385     }
 386 
 387     @Override
 388     @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 389     public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPassword) {"> 389     public GenericResponse resetPasswordUsingToken(String username, String token, String password, StringðŸ”µ</abbr>
 390         GenericResponse response = new GenericResponse();
 391         AdminUser user = null;
 392         if (username != null) {
 393             user = adminUserDao.readAdminUserByUserName(username);
 394         }
 395         checkUser(user, response);
 396         checkPassword(password, confirmPassword, response);
 397         if (StringUtils.isBlank(token)) {
 398             response.addErrorCode(&quot;invalidToken&quot;);
 399         }
 400 
 401         ForgotPasswordSecurityToken fpst = null;
 402         if (! response.getHasErrors()) {
 403             token = token.toLowerCase();
<abbr title=" 404             List&lt;ForgotPasswordSecurityToken&gt; fpstoks = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(user.getId());"> 404             List&lt;ForgotPasswordSecurityToken&gt; fpstoks = forgotPasswordSecurityTokenDao.readUnusedTokensByðŸ”µ</abbr>
 405             for (ForgotPasswordSecurityToken fpstok : fpstoks) {
 406                 if (isPasswordValid(fpstok.getToken(), token)) {
 407                     fpst = fpstok;
 408                     break;
 409                 }
 410             }
 411             if (fpst == null) {
 412                 response.addErrorCode(&quot;invalidToken&quot;);
 413             } else if (fpst.isTokenUsedFlag()) {
 414                 response.addErrorCode(&quot;tokenUsed&quot;);
 415             } else if (isTokenExpired(fpst)) {
 416                 response.addErrorCode(&quot;tokenExpired&quot;);
 417             }
 418         }
 419 
 420         if (! response.getHasErrors()) {
 421             if (! user.getId().equals(fpst.getAdminUserId())) {
 422                 if (LOG.isWarnEnabled()) {
<abbr title=" 423                     LOG.warn(&quot;Password reset attempt tried with mismatched user and token &quot; + user.getId() + &quot;, &quot; + StringUtil.sanitize(token));"> 423                     LOG.warn(&quot;Password reset attempt tried with mismatched user and token &quot; + user.getId(ðŸ”µ</abbr>
 424                 }
 425                 response.addErrorCode(&quot;invalidToken&quot;);
 426             }
 427         }
 428 
 429         if (! response.getHasErrors()) {
 430             user.setUnencodedPassword(password);
 431             saveAdminUser(user);
 432             invalidateAllTokensForAdminUser(user);
 433         }
 434 
 435         return response;
 436     }
 437 
 438     protected void invalidateAllTokensForAdminUser(AdminUser user) {
<abbr title=" 439         List&lt;ForgotPasswordSecurityToken&gt; tokens = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(user.getId());"> 439         List&lt;ForgotPasswordSecurityToken&gt; tokens = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminðŸ”µ</abbr>
 440         for (ForgotPasswordSecurityToken token : tokens) {
 441             token.setTokenUsedFlag(true);
 442             forgotPasswordSecurityTokenDao.saveToken(token);
 443         }
 444     }
 445 
 446     protected void checkUser(AdminUser user, GenericResponse response) {
 447         if (user == null) {
 448             response.addErrorCode(&quot;invalidUser&quot;);
 449         } else if (StringUtils.isBlank(user.getEmail())) {
 450             response.addErrorCode(&quot;emailNotFound&quot;);
 451         } else if (BooleanUtils.isNotTrue(user.getActiveStatusFlag())) {
 452             response.addErrorCode(&quot;inactiveUser&quot;);
 453         }
 454     }
 455 
 456     protected void checkPassword(String password, String confirmPassword, GenericResponse response) {
 457         if (StringUtils.isBlank(password) || StringUtils.isBlank(confirmPassword)) {
 458             response.addErrorCode(&quot;invalidPassword&quot;);
 459         } else if (! password.equals(confirmPassword)) {
 460             response.addErrorCode(&quot;passwordMismatch&quot;);
 461         }
 462     }
 463 
<abbr title=" 464     protected void checkExistingPassword(String unencodedPassword, AdminUser user, GenericResponse response) {"> 464     protected void checkExistingPassword(String unencodedPassword, AdminUser user, GenericResponse responðŸ”µ</abbr>
 465         if (!isPasswordValid(user.getPassword(), unencodedPassword)) {
 466             response.addErrorCode(&quot;invalidPassword&quot;);
 467         }
 468     }
 469 
 470     protected boolean isTokenExpired(ForgotPasswordSecurityToken fpst) {
 471         Date now = SystemTime.asDate();
 472         long currentTimeInMillis = now.getTime();
 473         long tokenSaveTimeInMillis = fpst.getCreateDate().getTime();
 474         long minutesSinceSave = (currentTimeInMillis - tokenSaveTimeInMillis)/60000;
 475         return minutesSinceSave &gt; getTokenExpiredMinutes();
 476     }
 477 
 478     public static int getPASSWORD_TOKEN_LENGTH() {
 479         return TEMP_PASSWORD_LENGTH;
 480     }
 481 
 482     public static void setPASSWORD_TOKEN_LENGTH(int PASSWORD_TOKEN_LENGTH) {
 483         AdminSecurityServiceImpl.TEMP_PASSWORD_LENGTH = PASSWORD_TOKEN_LENGTH;
 484     }
 485 
 486 
 487 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 488     public EmailInfo getSendUsernameEmailInfo() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 489         return sendUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 490     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 491 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 492     public void setSendUsernameEmailInfo(EmailInfo sendUsernameEmailInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 493         this.sendUsernameEmailInfo = sendUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 494     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 495 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 496     public EmailInfo getResetPasswordEmailInfo() {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 497         return resetPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 498     }</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 499 </span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 500     public void setResetPasswordEmailInfo(EmailInfo resetPasswordEmailInfo) {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 501         this.resetPasswordEmailInfo = resetPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 502 </span>
 503 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 504 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 504 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 505 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 506 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 507     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 508     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 509     public Object getSalt(AdminUser user, String unencodedPassword) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 510         Object salt = null;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 511         if (saltSource != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 512             salt = saltSource.getSalt(new AdminUserDetails(user.getId(), user.getLogin(), unencodedPassword, new ArrayList&lt;GrantedAuthority&gt;()));"> 512             salt = saltSource.getSalt(new AdminUserDetails(user.getId(), user.getLogin(), unencodedPasswoðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 513         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 514         return salt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 515     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 516 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 517     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 518     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 519     public String getSalt() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 520         return salt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 521     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 522 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 523     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 524     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 525     public void setSalt(String salt) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 526         this.salt = salt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 527     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 528 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 529     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 530     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 531     public SaltSource getSaltSource() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 532         return saltSource;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 533     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 534 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 535     @Deprecated</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 536     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 537     public void setSaltSource(SaltSource saltSource) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 538         this.saltSource = saltSource;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 539 </span>
 540 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 541     }
 542 
 543     @Override
 544     @Transactional(&quot;blTransactionManager&quot;)
 545     public GenericResponse changePassword(String username,
 546             String oldPassword, String password, String confirmPassword) {
 547         GenericResponse response = new GenericResponse();
 548         AdminUser user = null;
 549         if (username != null) {
 550             user = adminUserDao.readAdminUserByUserName(username);
 551         }
 552         checkUser(user, response);
 553         checkPassword(password, confirmPassword, response);
 554 
 555         if (!response.getHasErrors()) {
 556             checkExistingPassword(oldPassword, user, response);
 557         }
 558 
 559         if (!response.getHasErrors()) {
 560             user.setUnencodedPassword(password);
 561             saveAdminUser(user);
 562 
 563         }
 564 
 565         return response;
 566 
 567     }
 568 
 569     /**
<abbr title=" 570      * Determines if a password is valid by comparing it to the encoded string, salting is handled internally to the {@link PasswordEncoder}."> 570      * Determines if a password is valid by comparing it to the encoded string, salting is handled internðŸ”µ</abbr>
 571      * &lt;p&gt;
<abbr title=" 572      * This method must always be called to verify if a password is valid after the original encoded password is generated"> 572      * This method must always be called to verify if a password is valid after the original encoded passðŸ”µ</abbr>
<abbr title=" 573      * due to {@link PasswordEncoder} randomly generating salts internally and appending them to the resulting hash."> 573      * due to {@link PasswordEncoder} randomly generating salts internally and appending them to the resuðŸ”µ</abbr>
 574      *
 575      * @param encodedPassword the encoded password
 576      * @param rawPassword the raw password to check against the encoded password
 577      * @return true if rawPassword matches the encodedPassword, false otherwise
 578      */
 579     protected boolean isPasswordValid(String encodedPassword, String rawPassword) {
 580         return passwordEncoderBean.matches(rawPassword, encodedPassword);
 581     }
 582 
 583     /**
 584      * Generate an encoded password from a raw password
 585      * &lt;p&gt;
<abbr title=" 586      * This method can only be called once per password. The salt is randomly generated internally in the {@link PasswordEncoder}"> 586      * This method can only be called once per password. The salt is randomly generated internally in theðŸ”µ</abbr>
<abbr title=" 587      * and appended to the hash to provide the resulting encoded password. Once this has been called on a password,"> 587      * and appended to the hash to provide the resulting encoded password. Once this has been called on aðŸ”µ</abbr>
<abbr title=" 588      * going forward all checks for authenticity must be done by {@link #isPasswordValid(String, String)} as encoding the"> 588      * going forward all checks for authenticity must be done by {@link #isPasswordValid(String, String)}ðŸ”µ</abbr>
 589      * same password twice will result in different encoded passwords.
 590      *
 591      * @param rawPassword the unencoded password to encode
 592      * @return the encoded password
 593      */
 594     protected String encodePassword(String rawPassword) {
 595         return passwordEncoderBean.encode(rawPassword);
 596     }
 597 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.server.security.service;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import net.sf.ehcache.Cache;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import net.sf.ehcache.CacheManager;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import net.sf.ehcache.Element;</span>
  23  
  24  import org.apache.commons.collections4.CollectionUtils;
  25  import org.apache.commons.lang3.BooleanUtils;
  26  import org.apache.commons.lang3.StringUtils;
  27  import org.apache.commons.logging.Log;
  28  import org.apache.commons.logging.LogFactory;
  29  import org.broadleafcommerce.common.email.service.EmailService;
  30  import org.broadleafcommerce.common.email.service.info.EmailInfo;

  31  import org.broadleafcommerce.common.security.util.PasswordChange;
  32  import org.broadleafcommerce.common.security.util.PasswordUtils;
  33  import org.broadleafcommerce.common.service.GenericResponse;
  34  import org.broadleafcommerce.common.time.SystemTime;
  35  import org.broadleafcommerce.common.util.BLCSystemProperty;
  36  import org.broadleafcommerce.common.util.StringUtil;
  37  import org.broadleafcommerce.openadmin.server.security.dao.AdminPermissionDao;
  38  import org.broadleafcommerce.openadmin.server.security.dao.AdminRoleDao;
  39  import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  40  import org.broadleafcommerce.openadmin.server.security.dao.ForgotPasswordSecurityTokenDao;
  41  import org.broadleafcommerce.openadmin.server.security.domain.AdminPermission;
  42  import org.broadleafcommerce.openadmin.server.security.domain.AdminRole;
  43  import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  44  import org.broadleafcommerce.openadmin.server.security.domain.ForgotPasswordSecurityToken;
  45  import org.broadleafcommerce.openadmin.server.security.domain.ForgotPasswordSecurityTokenImpl;


  46  import org.broadleafcommerce.openadmin.server.security.service.type.PermissionType;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import org.broadleafcommerce.openadmin.server.security.service.user.AdminUserDetails;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import org.springframework.beans.factory.NoSuchBeanDefinitionException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -import org.springframework.beans.factory.annotation.Autowired;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -import org.springframework.beans.factory.annotation.Qualifier;</span>

  51  import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -import org.springframework.security.authentication.dao.SaltSource;</span>
  53  import org.springframework.security.core.Authentication;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -import org.springframework.security.core.GrantedAuthority;</span>
  55  import org.springframework.security.core.context.SecurityContextHolder;
  56  import org.springframework.security.crypto.password.PasswordEncoder;
  57  import org.springframework.stereotype.Service;
  58  import org.springframework.transaction.annotation.Transactional;
  59  
  60  import java.util.ArrayList;
  61  import java.util.Date;
  62  import java.util.HashMap;
  63  import java.util.List;
  64  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -import javax.annotation.PostConstruct;</span>
  66  import javax.annotation.Resource;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +import net.sf.ehcache.Cache;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +import net.sf.ehcache.CacheManager;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +import net.sf.ehcache.Element;</span>
  71  
  72  /**
  73   *
  74   * @author jfischer
  75   *
  76   */
  77  @Service(&quot;blAdminSecurityService&quot;)
  78  public class AdminSecurityServiceImpl implements AdminSecurityService {
  79  
  80      private static final Log LOG = LogFactory.getLog(AdminSecurityServiceImpl.class);
  81  
  82      private static int TEMP_PASSWORD_LENGTH = 12;
  83      private static final int FULL_PASSWORD_LENGTH = 16;
  84  




  85      @Resource(name = &quot;blAdminRoleDao&quot;)
  86      protected AdminRoleDao adminRoleDao;
  87  
  88      @Resource(name = &quot;blAdminUserDao&quot;)
  89      protected AdminUserDao adminUserDao;
  90  
  91      @Resource(name = &quot;blForgotPasswordSecurityTokenDao&quot;)
  92      protected ForgotPasswordSecurityTokenDao forgotPasswordSecurityTokenDao;
  93  
  94      @Resource(name = &quot;blAdminPermissionDao&quot;)
  95      protected AdminPermissionDao adminPermissionDao;
  96  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -     * &lt;p&gt;Set by {@link #setupPasswordEncoder()} if the blPasswordEncoder bean provided is the deprecated version.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -     * @deprecated Spring Security has deprecated this encoder interface, this will be removed in 4.2</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -    protected org.springframework.security.authentication.encoding.PasswordEncoder passwordEncoder;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -     * &lt;p&gt;Set by {@link #setupPasswordEncoder()} if the blPasswordEncoder bean provided is the new version.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -    protected PasswordEncoder passwordEncoderNew;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -</span>
 110      protected static String CACHE_NAME = &quot;blSecurityElements&quot;;
 111      protected static String CACHE_KEY_PREFIX = &quot;security:&quot;;
 112      protected Cache cache = CacheManager.getInstance().getCache(CACHE_NAME);
 113  
 114      /**
<abbr title=" 115       * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using the"> 115       * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using tðŸ”µ</abbr>
<abbr title=" 116       * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}"> 116       * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PðŸ”µ</abbr>
 117       */
 118      @Resource(name=&quot;blAdminPasswordEncoder&quot;)
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -    protected Object passwordEncoderBean;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -     * Optional password salt to be used with the passwordEncoder</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -     * @deprecated use {@link #saltSource} instead, this will be removed in 4.2</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -    protected String salt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -     * Use a Salt Source ONLY if there&#x27;s one configured</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -     * @deprecated the new {@link PasswordEncoder} handles salting internally, this will be removed in 4.2</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -    @Autowired(required=false)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -    @Qualifier(&quot;blAdminSaltSource&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -    protected SaltSource saltSource;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +    protected PasswordEncoder passwordEncoderBean;</span>
 139  
 140      @Resource(name=&quot;blEmailService&quot;)
 141      protected EmailService emailService;
 142  
 143      @Resource(name=&quot;blSendAdminResetPasswordEmail&quot;)
 144      protected EmailInfo resetPasswordEmailInfo;
 145  
 146      @Resource(name=&quot;blSendAdminUsernameEmailInfo&quot;)
 147      protected EmailInfo sendUsernameEmailInfo;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 150 -     * &lt;p&gt;Sets either {@link #passwordEncoder} or {@link #passwordEncoderNew} based on the type of {@link #passwordEncoderBean}"> 150 -     * &lt;p&gt;Sets either {@link #passwordEncoder} or {@link #passwordEncoderNew} based on the type of {@link #passworðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 151 -     * in order to provide bean configuration backwards compatibility with the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder} bean."> 151 -     * in order to provide bean configuration backwards compatibility with the deprecated {@link org.springframewoðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -     * &lt;p&gt;{@link #passwordEncoderBean} is set by the bean defined as &quot;blPasswordEncoder&quot;.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 155 -     * &lt;p&gt;This class will utilize either the new or deprecated PasswordEncoder type depending on which is not null."> 155 -     * &lt;p&gt;This class will utilize either the new or deprecated PasswordEncoder type depending on which is not nullðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 157 -     * @throws NoSuchBeanDefinitionException if {@link #passwordEncoderBean} is null or not an instance of either PasswordEncoder"> 157 -     * @throws NoSuchBeanDefinitionException if {@link #passwordEncoderBean} is null or not an instance of either ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -    @PostConstruct</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -    protected void setupPasswordEncoder() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -        passwordEncoderNew = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -        passwordEncoder = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -        if (passwordEncoderBean instanceof PasswordEncoder) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -            passwordEncoderNew = (PasswordEncoder) passwordEncoderBean;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 165 -        } else if (passwordEncoderBean instanceof org.springframework.security.authentication.encoding.PasswordEncoder) {"> 165 -        } else if (passwordEncoderBean instanceof org.springframework.security.authentication.encoding.PasswordEncðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 166 -            passwordEncoder = (org.springframework.security.authentication.encoding.PasswordEncoder) passwordEncoderBean;"> 166 -            passwordEncoder = (org.springframework.security.authentication.encoding.PasswordEncoder) passwordEncodðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -            throw new NoSuchBeanDefinitionException(&quot;No PasswordEncoder bean is defined&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -    }</span>
 171  
 172      protected int getTokenExpiredMinutes() {
 173          return BLCSystemProperty.resolveIntSystemProperty(&quot;tokenExpiredMinutes&quot;);
 174      }
 175  
 176      protected String getResetPasswordURL() {
 177          return BLCSystemProperty.resolveSystemProperty(&quot;resetPasswordURL&quot;);
 178      }
 179  
 180      @Override
 181      @Transactional(&quot;blTransactionManager&quot;)
 182      public void deleteAdminPermission(AdminPermission permission) {
 183          adminPermissionDao.deleteAdminPermission(permission);
 184          clearAdminSecurityCache();
 185      }
 186  
 187      @Override
 188      @Transactional(&quot;blTransactionManager&quot;)
 189      public void deleteAdminRole(AdminRole role) {
 190          adminRoleDao.deleteAdminRole(role);
 191          clearAdminSecurityCache();
 192      }
 193  
 194      @Override
 195      @Transactional(&quot;blTransactionManager&quot;)
 196      public void deleteAdminUser(AdminUser user) {
 197          adminUserDao.deleteAdminUser(user);
 198          clearAdminSecurityCache();
 199      }
 200  
 201      @Override
 202      public AdminPermission readAdminPermissionById(Long id) {
 203          return adminPermissionDao.readAdminPermissionById(id);
 204      }
 205  
 206      @Override
 207      public AdminRole readAdminRoleById(Long id) {
 208          return adminRoleDao.readAdminRoleById(id);
 209      }
 210  
 211      @Override
 212      public AdminUser readAdminUserById(Long id) {
 213          return adminUserDao.readAdminUserById(id);
 214      }
 215  
 216      @Override
 217      @Transactional(&quot;blTransactionManager&quot;)
 218      public AdminPermission saveAdminPermission(AdminPermission permission) {
 219          permission = adminPermissionDao.saveAdminPermission(permission);
 220          clearAdminSecurityCache();
 221          return permission;
 222      }
 223  
 224      @Override
 225      @Transactional(&quot;blTransactionManager&quot;)
 226      public AdminRole saveAdminRole(AdminRole role) {
 227          role = adminRoleDao.saveAdminRole(role);
 228          clearAdminSecurityCache();
 229          return role;
 230      }
 231  
 232      @Override
 233      @Transactional(&quot;blTransactionManager&quot;)
 234      public AdminUser saveAdminUser(AdminUser user) {
 235          boolean encodePasswordNeeded = false;
 236          String unencodedPassword = user.getUnencodedPassword();
 237  
 238          if (user.getUnencodedPassword() != null) {
 239              encodePasswordNeeded = true;
 240              user.setPassword(unencodedPassword);
 241          }
 242  
 243          // If no password is set, default to a secure password.
 244          if (user.getPassword() == null) {
 245              user.setPassword(generateSecurePassword());
 246          }
 247  
 248          AdminUser returnUser = adminUserDao.saveAdminUser(user);
 249  
 250          if (encodePasswordNeeded) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 251 -            returnUser.setPassword(encodePassword(unencodedPassword, getSalt(returnUser, unencodedPassword)));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 252 +            returnUser.setPassword(encodePassword(unencodedPassword));</span>
 253          }
 254  
 255          returnUser = adminUserDao.saveAdminUser(returnUser);
 256          clearAdminSecurityCache();
 257          return returnUser;
 258      }
 259  
 260      @Override
 261      public void clearAdminSecurityCache() {
 262          if (LOG.isTraceEnabled()) {
 263              LOG.trace(&quot;Admin Security Cache DELETE&quot;);
 264          }
 265          cache.removeAll();
 266      }
 267  
 268      protected String generateSecurePassword() {
 269          return PasswordUtils.generateSecurePassword(FULL_PASSWORD_LENGTH);
 270      }
 271  
 272      @Override
 273      @Transactional(&quot;blTransactionManager&quot;)
 274      public AdminUser changePassword(PasswordChange passwordChange) {
 275          AdminUser user = readAdminUserByUserName(passwordChange.getUsername());
 276          user.setUnencodedPassword(passwordChange.getNewPassword());
 277          user = saveAdminUser(user);
 278          Authentication auth = SecurityContextHolder.getContext().getAuthentication();
<abbr title=" 279          UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(passwordChange.getUsername(), passwordChange.getNewPassword(), auth.getAuthorities());"> 279          UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(passwordChange.gðŸ”µ</abbr>
 280          SecurityContextHolder.getContext().setAuthentication(authRequest);
 281          auth.setAuthenticated(false);
 282          return user;
 283      }
 284  
 285      @Override
<abbr title=" 286      public boolean isUserQualifiedForOperationOnCeilingEntity(AdminUser adminUser, PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 286      public boolean isUserQualifiedForOperationOnCeilingEntity(AdminUser adminUser, PermissionType permissionType, ðŸ”µ</abbr>
 287          Boolean response = null;
 288          String cacheKey = buildCacheKey(adminUser, permissionType, ceilingEntityFullyQualifiedName);
 289          Element cacheElement = cache.get(cacheKey);
 290  
 291          if (cacheElement != null) {
 292              response = (Boolean) cacheElement.getObjectValue();
 293  
 294              if (LOG.isTraceEnabled()) {
 295                  LOG.trace(&quot;Admin Security Cache GET For: \&quot;&quot; + cacheKey + &quot;\&quot; = &quot; + response);
 296              }
 297          }
 298  
 299          if (response == null) {
<abbr title=" 300              response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntity(adminUser, permissionType, ceilingEntityFullyQualifiedName);"> 300              response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntity(adminUser, permissionType, ceðŸ”µ</abbr>
 301  
 302              if (!response) {
<abbr title=" 303                  response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntityViaDefaultPermissions(ceilingEntityFullyQualifiedName);"> 303                  response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntityViaDefaultPermissions(ceilðŸ”µ</abbr>
 304              }
 305  
 306              cacheElement = new Element(cacheKey, response);
 307              cache.put(cacheElement);
 308  
 309              if (LOG.isTraceEnabled()) {
 310                  LOG.trace(&quot;Admin Security Cache PUT For: \&quot;&quot; + cacheKey + &quot;\&quot; = &quot; + response);
 311              }
 312          }
 313  
 314          return response;
 315      }
 316  
<abbr title=" 317      protected String buildCacheKey(AdminUser adminUser, PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 317      protected String buildCacheKey(AdminUser adminUser, PermissionType permissionType, String ceilingEntityFullyQuðŸ”µ</abbr>
 318          return CACHE_KEY_PREFIX
 319                 + &quot;user:&quot; + adminUser.getId() + &quot;,&quot;
 320                 + &quot;permType:&quot; + permissionType.getFriendlyType() + &quot;,&quot;
 321                 + &quot;ceiling:&quot; + ceilingEntityFullyQualifiedName;
 322      }
 323  
 324      @Override
<abbr title=" 325      public boolean doesOperationExistForCeilingEntity(PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 325      public boolean doesOperationExistForCeilingEntity(PermissionType permissionType, String ceilingEntityFullyQualðŸ”µ</abbr>
<abbr title=" 326          return adminPermissionDao.doesOperationExistForCeilingEntity(permissionType, ceilingEntityFullyQualifiedName);"> 326          return adminPermissionDao.doesOperationExistForCeilingEntity(permissionType, ceilingEntityFullyQualifiedNaðŸ”µ</abbr>
 327      }
 328  
 329      @Override
 330      public AdminUser readAdminUserByUserName(String userName) {
 331          return adminUserDao.readAdminUserByUserName(userName);
 332      }
 333  
 334      @Override
 335      public List&lt;AdminUser&gt; readAdminUsersByEmail(String email) {
 336          return adminUserDao.readAdminUserByEmail(email);
 337      }
 338  
 339      @Override
 340      public List&lt;AdminUser&gt; readAllAdminUsers() {
 341          return adminUserDao.readAllAdminUsers();
 342      }
 343  
 344      @Override
 345      public List&lt;AdminRole&gt; readAllAdminRoles() {
 346          return adminRoleDao.readAllAdminRoles();
 347      }
 348  
 349      @Override
 350      public List&lt;AdminPermission&gt; readAllAdminPermissions() {
 351          return adminPermissionDao.readAllAdminPermissions();
 352      }
 353  
 354      @Override
 355      @Transactional(&quot;blTransactionManager&quot;)
 356      public GenericResponse sendForgotUsernameNotification(String emailAddress) {
 357          GenericResponse response = new GenericResponse();
 358          List&lt;AdminUser&gt; users = null;
 359          if (emailAddress != null) {
 360              users = adminUserDao.readAdminUserByEmail(emailAddress);
 361          }
 362          if (CollectionUtils.isEmpty(users)) {
 363              response.addErrorCode(&quot;notFound&quot;);
 364          } else {
 365              List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();
 366              for (AdminUser user : users) {
 367                  if (user.getActiveStatusFlag()) {
 368                      activeUsernames.add(user.getLogin());
 369                  }
 370              }
 371  
 372              if (activeUsernames.size() &gt; 0) {
 373                  HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();
 374                  vars.put(&quot;accountNames&quot;, activeUsernames);
 375                  emailService.sendTemplateEmail(emailAddress, getSendUsernameEmailInfo(), vars);

 376              } else {
 377                  // send inactive username found email.
 378                  response.addErrorCode(&quot;inactiveUser&quot;);
 379              }
 380          }
 381          return response;
 382      }
 383  
 384      @Override
 385      @Transactional(&quot;blTransactionManager&quot;)
 386      public GenericResponse sendResetPasswordNotification(String username) {
 387          GenericResponse response = new GenericResponse();
 388          AdminUser user = null;
 389  
 390          if (username != null) {
 391              user = adminUserDao.readAdminUserByUserName(username);
 392          }
 393  
 394          checkUser(user,response);
 395  
 396          if (! response.getHasErrors()) {
 397              String token = PasswordUtils.generateSecurePassword(TEMP_PASSWORD_LENGTH);
 398              token = token.toLowerCase();
 399  
 400              ForgotPasswordSecurityToken fpst = new ForgotPasswordSecurityTokenImpl();
 401              fpst.setAdminUserId(user.getId());
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -            fpst.setToken(encodePassword(token, null));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +            fpst.setToken(encodePassword(token));</span>
 404              fpst.setCreateDate(SystemTime.asDate());
 405              forgotPasswordSecurityTokenDao.saveToken(fpst);
 406  
 407              HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();
 408              vars.put(&quot;token&quot;, token);
 409              String resetPasswordUrl = getResetPasswordURL();
 410              if (!StringUtils.isEmpty(resetPasswordUrl)) {
 411                  if (resetPasswordUrl.contains(&quot;?&quot;)) {
 412                      resetPasswordUrl=resetPasswordUrl+&quot;&amp;token=&quot;+token;
 413                  } else {
 414                      resetPasswordUrl=resetPasswordUrl+&quot;?token=&quot;+token;
 415                  }
 416              }
 417              vars.put(&quot;resetPasswordUrl&quot;, resetPasswordUrl);
 418              emailService.sendTemplateEmail(user.getEmail(), getResetPasswordEmailInfo(), vars);
 419  


 420          }
 421          return response;
 422      }
 423  
 424      @Override
 425      @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 426      public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPassword) {"> 426      public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPðŸ”µ</abbr>
 427          GenericResponse response = new GenericResponse();
 428          AdminUser user = null;
 429          if (username != null) {
 430              user = adminUserDao.readAdminUserByUserName(username);
 431          }
 432          checkUser(user, response);
 433          checkPassword(password, confirmPassword, response);
 434          if (StringUtils.isBlank(token)) {
 435              response.addErrorCode(&quot;invalidToken&quot;);
 436          }
 437  
 438          ForgotPasswordSecurityToken fpst = null;
 439          if (! response.getHasErrors()) {
 440              token = token.toLowerCase();
<abbr title=" 441              List&lt;ForgotPasswordSecurityToken&gt; fpstoks = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(user.getId());"> 441              List&lt;ForgotPasswordSecurityToken&gt; fpstoks = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserðŸ”µ</abbr>
 442              for (ForgotPasswordSecurityToken fpstok : fpstoks) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 443 -                if (isPasswordValid(fpstok.getToken(), token, null)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 444 +                if (isPasswordValid(fpstok.getToken(), token)) {</span>
 445                      fpst = fpstok;
 446                      break;
 447                  }
 448              }
 449              if (fpst == null) {
 450                  response.addErrorCode(&quot;invalidToken&quot;);
 451              } else if (fpst.isTokenUsedFlag()) {
 452                  response.addErrorCode(&quot;tokenUsed&quot;);
 453              } else if (isTokenExpired(fpst)) {
 454                  response.addErrorCode(&quot;tokenExpired&quot;);
 455              }
 456          }
 457  
 458          if (! response.getHasErrors()) {
 459              if (! user.getId().equals(fpst.getAdminUserId())) {
 460                  if (LOG.isWarnEnabled()) {
<abbr title=" 461                      LOG.warn(&quot;Password reset attempt tried with mismatched user and token &quot; + user.getId() + &quot;, &quot; + StringUtil.sanitize(token));"> 461                      LOG.warn(&quot;Password reset attempt tried with mismatched user and token &quot; + user.getId() + &quot;, &quot; ðŸ”µ</abbr>
 462                  }
 463                  response.addErrorCode(&quot;invalidToken&quot;);
 464              }
 465          }
 466  
 467          if (! response.getHasErrors()) {
 468              user.setUnencodedPassword(password);
 469              saveAdminUser(user);
 470              invalidateAllTokensForAdminUser(user);
 471          }
 472  
 473          return response;
 474      }
 475  
 476      protected void invalidateAllTokensForAdminUser(AdminUser user) {
<abbr title=" 477          List&lt;ForgotPasswordSecurityToken&gt; tokens = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(user.getId());"> 477          List&lt;ForgotPasswordSecurityToken&gt; tokens = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(usðŸ”µ</abbr>
 478          for (ForgotPasswordSecurityToken token : tokens) {
 479              token.setTokenUsedFlag(true);
 480              forgotPasswordSecurityTokenDao.saveToken(token);
 481          }
 482      }
 483  
 484      protected void checkUser(AdminUser user, GenericResponse response) {
 485          if (user == null) {
 486              response.addErrorCode(&quot;invalidUser&quot;);
 487          } else if (StringUtils.isBlank(user.getEmail())) {
 488              response.addErrorCode(&quot;emailNotFound&quot;);
 489          } else if (BooleanUtils.isNotTrue(user.getActiveStatusFlag())) {
 490              response.addErrorCode(&quot;inactiveUser&quot;);
 491          }
 492      }
 493  
 494      protected void checkPassword(String password, String confirmPassword, GenericResponse response) {
 495          if (StringUtils.isBlank(password) || StringUtils.isBlank(confirmPassword)) {
 496              response.addErrorCode(&quot;invalidPassword&quot;);
 497          } else if (! password.equals(confirmPassword)) {
 498              response.addErrorCode(&quot;passwordMismatch&quot;);
 499          }
 500      }
 501  
 502      protected void checkExistingPassword(String unencodedPassword, AdminUser user, GenericResponse response) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 503 -        if (!isPasswordValid(user.getPassword(), unencodedPassword, getSalt(user, unencodedPassword))) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 504 +        if (!isPasswordValid(user.getPassword(), unencodedPassword)) {</span>
 505              response.addErrorCode(&quot;invalidPassword&quot;);
 506          }
 507      }
 508  
 509      protected boolean isTokenExpired(ForgotPasswordSecurityToken fpst) {
 510          Date now = SystemTime.asDate();
 511          long currentTimeInMillis = now.getTime();
 512          long tokenSaveTimeInMillis = fpst.getCreateDate().getTime();
 513          long minutesSinceSave = (currentTimeInMillis - tokenSaveTimeInMillis)/60000;
 514          return minutesSinceSave &gt; getTokenExpiredMinutes();
 515      }
 516  
 517      public static int getPASSWORD_TOKEN_LENGTH() {
 518          return TEMP_PASSWORD_LENGTH;
 519      }
 520  
 521      public static void setPASSWORD_TOKEN_LENGTH(int PASSWORD_TOKEN_LENGTH) {
 522          AdminSecurityServiceImpl.TEMP_PASSWORD_LENGTH = PASSWORD_TOKEN_LENGTH;
 523      }
 524  
 525      public EmailInfo getSendUsernameEmailInfo() {
 526          return sendUsernameEmailInfo;
 527      }
 528  
 529      public void setSendUsernameEmailInfo(EmailInfo sendUsernameEmailInfo) {
 530          this.sendUsernameEmailInfo = sendUsernameEmailInfo;
 531      }
 532  
 533      public EmailInfo getResetPasswordEmailInfo() {
 534          return resetPasswordEmailInfo;
 535      }
 536  
 537      public void setResetPasswordEmailInfo(EmailInfo resetPasswordEmailInfo) {
 538          this.resetPasswordEmailInfo = resetPasswordEmailInfo;
 539      }
 540  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 541 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 542 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 543 -    public Object getSalt(AdminUser user, String unencodedPassword) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 544 -        Object salt = null;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 545 -        if (saltSource != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 546 -            salt = saltSource.getSalt(new AdminUserDetails(user.getId(), user.getLogin(), unencodedPassword, new ArrayList&lt;GrantedAuthority&gt;()));"> 546 -            salt = saltSource.getSalt(new AdminUserDetails(user.getId(), user.getLogin(), unencodedPassword, new AðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 547 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 548 -        return salt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 549 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 550 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 551 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 552 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 553 -    public String getSalt() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 554 -        return salt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 555 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 556 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 557 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 558 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 559 -    public void setSalt(String salt) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 560 -        this.salt = salt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 561 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 562 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 563 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 564 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 565 -    public SaltSource getSaltSource() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 566 -        return saltSource;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 567 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 568 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 569 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 570 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 571 -    public void setSaltSource(SaltSource saltSource) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 572 -        this.saltSource = saltSource;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 573 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 574 -</span>
 575      @Override
 576      @Transactional(&quot;blTransactionManager&quot;)
 577      public GenericResponse changePassword(String username,
 578              String oldPassword, String password, String confirmPassword) {
 579          GenericResponse response = new GenericResponse();
 580          AdminUser user = null;
 581          if (username != null) {
 582              user = adminUserDao.readAdminUserByUserName(username);
 583          }
 584          checkUser(user, response);
 585          checkPassword(password, confirmPassword, response);
 586  
 587          if (!response.getHasErrors()) {
 588              checkExistingPassword(oldPassword, user, response);
 589          }
 590  
 591          if (!response.getHasErrors()) {
 592              user.setUnencodedPassword(password);
 593              saveAdminUser(user);
 594  
 595          }
 596  
 597          return response;
 598  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 599 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 600 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 601 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 602 -     * Determines if a password is valid by comparing it to the encoded string, optionally using a salt.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 603 -     * &lt;p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 604 -     * The externally salted {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder} support is"> 604 -     * The externally salted {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 605 -     * being deprecated, following in Spring Security&#x27;s footsteps, in order to move towards self salting hashing algorithms such as bcrypt."> 605 -     * being deprecated, following in Spring Security&#x27;s footsteps, in order to move towards self salting hashing aðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 606 -     * Bcrypt is a superior hashing algorithm that randomly generates a salt per password in order to protect against rainbow table attacks"> 606 -     * Bcrypt is a superior hashing algorithm that randomly generates a salt per password in order to protect agaiðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 607 -     * and is an intentionally expensive algorithm to further guard against brute force attempts to crack hashed passwords."> 607 -     * and is an intentionally expensive algorithm to further guard against brute force attempts to crack hashed pðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 608 -     * Additionally, having the encoding algorithm handle the salt internally reduces code complexity and dependencies such as {@link SaltSource}."> 608 -     * Additionally, having the encoding algorithm handle the salt internally reduces code complexity and dependenðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 609 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 610 -     * @deprecated the new {@link PasswordEncoder} handles salting internally, this will be removed in 4.2</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 611 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 612 -     * @param encodedPassword the encoded password</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 613 -     * @param rawPassword the unencoded password</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 614 -     * @param salt the optional salt</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 615 -     * @return true if rawPassword matches the encodedPassword, false otherwise</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 616 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 617 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 618 -    protected boolean isPasswordValid(String encodedPassword, String rawPassword, Object salt) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 619 -        if (usingDeprecatedPasswordEncoder()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 620 -            return passwordEncoder.isPasswordValid(encodedPassword, rawPassword, salt);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 621 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 622 -            return isPasswordValid(encodedPassword, rawPassword);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 623 -        }</span>
 624      }
 625  
 626      /**
<abbr title=" 627       * Determines if a password is valid by comparing it to the encoded string, salting is handled internally to the {@link PasswordEncoder}."> 627       * Determines if a password is valid by comparing it to the encoded string, salting is handled internally to tðŸ”µ</abbr>
 628       * &lt;p&gt;
<abbr title=" 629       * This method must always be called to verify if a password is valid after the original encoded password is generated"> 629       * This method must always be called to verify if a password is valid after the original encoded password is gðŸ”µ</abbr>
<abbr title=" 630       * due to {@link PasswordEncoder} randomly generating salts internally and appending them to the resulting hash."> 630       * due to {@link PasswordEncoder} randomly generating salts internally and appending them to the resulting hasðŸ”µ</abbr>
 631       *
 632       * @param encodedPassword the encoded password
 633       * @param rawPassword the raw password to check against the encoded password
 634       * @return true if rawPassword matches the encodedPassword, false otherwise
 635       */
 636      protected boolean isPasswordValid(String encodedPassword, String rawPassword) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 637 -        return passwordEncoderNew.matches(rawPassword, encodedPassword);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 638 +        return passwordEncoderBean.matches(rawPassword, encodedPassword);</span>
 639      }
 640  
 641      /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 642 -     * Generate an encoded password from a raw password, optionally using a salt.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 643 -     * &lt;p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 644 -     * The externally salted {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder} support is"> 644 -     * The externally salted {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 645 -     * being deprecated, following in Spring Security&#x27;s footsteps, in order to move towards self salting hashing algorithms such as bcrypt."> 645 -     * being deprecated, following in Spring Security&#x27;s footsteps, in order to move towards self salting hashing aðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 646 -     * Bcrypt is a superior hashing algorithm that randomly generates a salt per password in order to protect against rainbow table attacks"> 646 -     * Bcrypt is a superior hashing algorithm that randomly generates a salt per password in order to protect agaiðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 647 -     * and is an intentionally expensive algorithm to further guard against brute force attempts to crack hashed passwords."> 647 -     * and is an intentionally expensive algorithm to further guard against brute force attempts to crack hashed pðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 648 -     * Additionally, having the encoding algorithm handle the salt internally reduces code complexity and dependencies such as {@link SaltSource}."> 648 -     * Additionally, having the encoding algorithm handle the salt internally reduces code complexity and dependenðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 649 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 650 -     * @deprecated the new {@link PasswordEncoder} handles salting internally, this will be removed in 4.2</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 651 -     *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 652 -     * @param rawPassword</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 653 -     * @param salt</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 654 -     * @return</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 655 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 656 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 657 -    protected String encodePassword(String rawPassword, Object salt) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 658 -        if (usingDeprecatedPasswordEncoder()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 659 -            return passwordEncoder.encodePassword(rawPassword, salt);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 660 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 661 -            return encodePassword(rawPassword);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 662 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 663 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 664 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 665 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 666 -     * Generate an encoded password from a raw password, salting is handled internally to the {@link PasswordEncoder}."> 666 -     * Generate an encoded password from a raw password, salting is handled internally to the {@link PasswordEncodðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 667 +     * Generate an encoded password from a raw password</span>
 668       * &lt;p&gt;
<abbr title=" 669       * This method can only be called once per password. The salt is randomly generated internally in the {@link PasswordEncoder}"> 669       * This method can only be called once per password. The salt is randomly generated internally in the {@link PðŸ”µ</abbr>
<abbr title=" 670       * and appended to the hash to provide the resulting encoded password. Once this has been called on a password,"> 670       * and appended to the hash to provide the resulting encoded password. Once this has been called on a passwordðŸ”µ</abbr>
<abbr title=" 671       * going forward all checks for authenticity must be done by {@link #isPasswordValid(String, String)} as encoding the"> 671       * going forward all checks for authenticity must be done by {@link #isPasswordValid(String, String)} as encodðŸ”µ</abbr>
 672       * same password twice will result in different encoded passwords.
 673       *
 674       * @param rawPassword the unencoded password to encode
 675       * @return the encoded password
 676       */
 677      protected String encodePassword(String rawPassword) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 678 -        return passwordEncoderNew.encode(rawPassword);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 679 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 680 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 681 -    @Deprecated</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 682 -    protected boolean usingDeprecatedPasswordEncoder() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 683 -        return passwordEncoder != null;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 684 +        return passwordEncoderBean.encode(rawPassword);</span>
 685      }
 686  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.server.security.service;
  19  
  20  import net.sf.ehcache.Cache;
  21  import net.sf.ehcache.CacheManager;
  22  import net.sf.ehcache.Element;
  23  
  24  import org.apache.commons.collections4.CollectionUtils;
  25  import org.apache.commons.lang3.BooleanUtils;
  26  import org.apache.commons.lang3.StringUtils;
  27  import org.apache.commons.logging.Log;
  28  import org.apache.commons.logging.LogFactory;
  29  import org.broadleafcommerce.common.email.service.EmailService;
  30  import org.broadleafcommerce.common.email.service.info.EmailInfo;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import org.broadleafcommerce.common.event.BroadleafApplicationEventPublisher;</span>
  32  import org.broadleafcommerce.common.security.util.PasswordChange;
  33  import org.broadleafcommerce.common.security.util.PasswordUtils;
  34  import org.broadleafcommerce.common.service.GenericResponse;
  35  import org.broadleafcommerce.common.time.SystemTime;
  36  import org.broadleafcommerce.common.util.BLCSystemProperty;
  37  import org.broadleafcommerce.common.util.StringUtil;
  38  import org.broadleafcommerce.openadmin.server.security.dao.AdminPermissionDao;
  39  import org.broadleafcommerce.openadmin.server.security.dao.AdminRoleDao;
  40  import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  41  import org.broadleafcommerce.openadmin.server.security.dao.ForgotPasswordSecurityTokenDao;
  42  import org.broadleafcommerce.openadmin.server.security.domain.AdminPermission;
  43  import org.broadleafcommerce.openadmin.server.security.domain.AdminRole;
  44  import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  45  import org.broadleafcommerce.openadmin.server.security.domain.ForgotPasswordSecurityToken;
  46  import org.broadleafcommerce.openadmin.server.security.domain.ForgotPasswordSecurityTokenImpl;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import org.broadleafcommerce.openadmin.server.security.event.AdminForgotPasswordEvent;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  48 +import org.broadleafcommerce.openadmin.server.security.event.AdminForgotUsernameEvent;</span>
  49  import org.broadleafcommerce.openadmin.server.security.service.type.PermissionType;
  50  import org.broadleafcommerce.openadmin.server.security.service.user.AdminUserDetails;
  51  import org.springframework.beans.factory.NoSuchBeanDefinitionException;
  52  import org.springframework.beans.factory.annotation.Autowired;
  53  import org.springframework.beans.factory.annotation.Qualifier;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  54 +import org.springframework.context.ApplicationContext;</span>
  55  import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
  56  import org.springframework.security.authentication.dao.SaltSource;
  57  import org.springframework.security.core.Authentication;
  58  import org.springframework.security.core.GrantedAuthority;
  59  import org.springframework.security.core.context.SecurityContextHolder;
  60  import org.springframework.security.crypto.password.PasswordEncoder;
  61  import org.springframework.stereotype.Service;
  62  import org.springframework.transaction.annotation.Transactional;
  63  
  64  import java.util.ArrayList;
  65  import java.util.Date;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -import java.util.HashMap;</span>
  67  import java.util.List;
  68  
  69  import javax.annotation.PostConstruct;
  70  import javax.annotation.Resource;




  71  
  72  /**
  73   *
  74   * @author jfischer
  75   *
  76   */
  77  @Service(&quot;blAdminSecurityService&quot;)
  78  public class AdminSecurityServiceImpl implements AdminSecurityService {
  79  
  80      private static final Log LOG = LogFactory.getLog(AdminSecurityServiceImpl.class);
  81  
  82      private static int TEMP_PASSWORD_LENGTH = 12;
  83      private static final int FULL_PASSWORD_LENGTH = 16;
  84  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  85 +    @Autowired</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  86 +    @Qualifier(&quot;blApplicationEventPublisher&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +    protected BroadleafApplicationEventPublisher eventPublisher;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +</span>
  89      @Resource(name = &quot;blAdminRoleDao&quot;)
  90      protected AdminRoleDao adminRoleDao;
  91  
  92      @Resource(name = &quot;blAdminUserDao&quot;)
  93      protected AdminUserDao adminUserDao;
  94  
  95      @Resource(name = &quot;blForgotPasswordSecurityTokenDao&quot;)
  96      protected ForgotPasswordSecurityTokenDao forgotPasswordSecurityTokenDao;
  97  
  98      @Resource(name = &quot;blAdminPermissionDao&quot;)
  99      protected AdminPermissionDao adminPermissionDao;
 100  
 101      /**
 102       * &lt;p&gt;Set by {@link #setupPasswordEncoder()} if the blPasswordEncoder bean provided is the deprecated version.
 103       *
 104       * @deprecated Spring Security has deprecated this encoder interface, this will be removed in 4.2
 105       */
 106      @Deprecated
 107      protected org.springframework.security.authentication.encoding.PasswordEncoder passwordEncoder;
 108  
 109      /**
 110       * &lt;p&gt;Set by {@link #setupPasswordEncoder()} if the blPasswordEncoder bean provided is the new version.
 111       */
 112      protected PasswordEncoder passwordEncoderNew;
 113  
 114      protected static String CACHE_NAME = &quot;blSecurityElements&quot;;
 115      protected static String CACHE_KEY_PREFIX = &quot;security:&quot;;
 116      protected Cache cache = CacheManager.getInstance().getCache(CACHE_NAME);
 117  
 118      /**
<abbr title=" 119       * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using the"> 119       * &lt;p&gt;This is simply a placeholder to be used by {@link #setupPasswordEncoder()} to determine if we&#x27;re using tðŸ”µ</abbr>
<abbr title=" 120       * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder}"> 120       * new {@link PasswordEncoder} or the deprecated {@link org.springframework.security.authentication.encoding.PðŸ”µ</abbr>
 121       */
 122      @Resource(name=&quot;blAdminPasswordEncoder&quot;)
 123      protected Object passwordEncoderBean;
 124  
 125      /**
 126       * Optional password salt to be used with the passwordEncoder
 127       *
 128       * @deprecated use {@link #saltSource} instead, this will be removed in 4.2
 129       */
 130      @Deprecated
 131      protected String salt;
 132  
 133      /**
 134       * Use a Salt Source ONLY if there&#x27;s one configured
 135       *
 136       * @deprecated the new {@link PasswordEncoder} handles salting internally, this will be removed in 4.2
 137       */
 138      @Deprecated
 139      @Autowired(required=false)
 140      @Qualifier(&quot;blAdminSaltSource&quot;)
 141      protected SaltSource saltSource;

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -    @Resource(name=&quot;blEmailService&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -    protected EmailService emailService;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -    @Resource(name=&quot;blSendAdminResetPasswordEmail&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -    protected EmailInfo resetPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -    @Resource(name=&quot;blSendAdminUsernameEmailInfo&quot;)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -    protected EmailInfo sendUsernameEmailInfo;</span>
 151  
 152      /**
<abbr title=" 153       * &lt;p&gt;Sets either {@link #passwordEncoder} or {@link #passwordEncoderNew} based on the type of {@link #passwordEncoderBean}"> 153       * &lt;p&gt;Sets either {@link #passwordEncoder} or {@link #passwordEncoderNew} based on the type of {@link #passworðŸ”µ</abbr>
<abbr title=" 154       * in order to provide bean configuration backwards compatibility with the deprecated {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder} bean."> 154       * in order to provide bean configuration backwards compatibility with the deprecated {@link org.springframewoðŸ”µ</abbr>
 155       *
 156       * &lt;p&gt;{@link #passwordEncoderBean} is set by the bean defined as &quot;blPasswordEncoder&quot;.
 157       *
<abbr title=" 158       * &lt;p&gt;This class will utilize either the new or deprecated PasswordEncoder type depending on which is not null."> 158       * &lt;p&gt;This class will utilize either the new or deprecated PasswordEncoder type depending on which is not nullðŸ”µ</abbr>
 159       *
<abbr title=" 160       * @throws NoSuchBeanDefinitionException if {@link #passwordEncoderBean} is null or not an instance of either PasswordEncoder"> 160       * @throws NoSuchBeanDefinitionException if {@link #passwordEncoderBean} is null or not an instance of either ðŸ”µ</abbr>
 161       */
 162      @PostConstruct
 163      protected void setupPasswordEncoder() {
 164          passwordEncoderNew = null;
 165          passwordEncoder = null;
 166          if (passwordEncoderBean instanceof PasswordEncoder) {
 167              passwordEncoderNew = (PasswordEncoder) passwordEncoderBean;
<abbr title=" 168          } else if (passwordEncoderBean instanceof org.springframework.security.authentication.encoding.PasswordEncoder) {"> 168          } else if (passwordEncoderBean instanceof org.springframework.security.authentication.encoding.PasswordEncðŸ”µ</abbr>
<abbr title=" 169              passwordEncoder = (org.springframework.security.authentication.encoding.PasswordEncoder) passwordEncoderBean;"> 169              passwordEncoder = (org.springframework.security.authentication.encoding.PasswordEncoder) passwordEncodðŸ”µ</abbr>
 170          } else {
 171              throw new NoSuchBeanDefinitionException(&quot;No PasswordEncoder bean is defined&quot;);
 172          }
 173      }
 174  
 175      protected int getTokenExpiredMinutes() {
 176          return BLCSystemProperty.resolveIntSystemProperty(&quot;tokenExpiredMinutes&quot;);
 177      }
 178  
 179      protected String getResetPasswordURL() {
 180          return BLCSystemProperty.resolveSystemProperty(&quot;resetPasswordURL&quot;);
 181      }
 182  
 183      @Override
 184      @Transactional(&quot;blTransactionManager&quot;)
 185      public void deleteAdminPermission(AdminPermission permission) {
 186          adminPermissionDao.deleteAdminPermission(permission);
 187          clearAdminSecurityCache();
 188      }
 189  
 190      @Override
 191      @Transactional(&quot;blTransactionManager&quot;)
 192      public void deleteAdminRole(AdminRole role) {
 193          adminRoleDao.deleteAdminRole(role);
 194          clearAdminSecurityCache();
 195      }
 196  
 197      @Override
 198      @Transactional(&quot;blTransactionManager&quot;)
 199      public void deleteAdminUser(AdminUser user) {
 200          adminUserDao.deleteAdminUser(user);
 201          clearAdminSecurityCache();
 202      }
 203  
 204      @Override
 205      public AdminPermission readAdminPermissionById(Long id) {
 206          return adminPermissionDao.readAdminPermissionById(id);
 207      }
 208  
 209      @Override
 210      public AdminRole readAdminRoleById(Long id) {
 211          return adminRoleDao.readAdminRoleById(id);
 212      }
 213  
 214      @Override
 215      public AdminUser readAdminUserById(Long id) {
 216          return adminUserDao.readAdminUserById(id);
 217      }
 218  
 219      @Override
 220      @Transactional(&quot;blTransactionManager&quot;)
 221      public AdminPermission saveAdminPermission(AdminPermission permission) {
 222          permission = adminPermissionDao.saveAdminPermission(permission);
 223          clearAdminSecurityCache();
 224          return permission;
 225      }
 226  
 227      @Override
 228      @Transactional(&quot;blTransactionManager&quot;)
 229      public AdminRole saveAdminRole(AdminRole role) {
 230          role = adminRoleDao.saveAdminRole(role);
 231          clearAdminSecurityCache();
 232          return role;
 233      }
 234  
 235      @Override
 236      @Transactional(&quot;blTransactionManager&quot;)
 237      public AdminUser saveAdminUser(AdminUser user) {
 238          boolean encodePasswordNeeded = false;
 239          String unencodedPassword = user.getUnencodedPassword();
 240  
 241          if (user.getUnencodedPassword() != null) {
 242              encodePasswordNeeded = true;
 243              user.setPassword(unencodedPassword);
 244          }
 245  
 246          // If no password is set, default to a secure password.
 247          if (user.getPassword() == null) {
 248              user.setPassword(generateSecurePassword());
 249          }
 250  
 251          AdminUser returnUser = adminUserDao.saveAdminUser(user);
 252  
 253          if (encodePasswordNeeded) {
 254              returnUser.setPassword(encodePassword(unencodedPassword, getSalt(returnUser, unencodedPassword)));

 255          }
 256  
 257          returnUser = adminUserDao.saveAdminUser(returnUser);
 258          clearAdminSecurityCache();
 259          return returnUser;
 260      }
 261  
 262      @Override
 263      public void clearAdminSecurityCache() {
 264          if (LOG.isTraceEnabled()) {
 265              LOG.trace(&quot;Admin Security Cache DELETE&quot;);
 266          }
 267          cache.removeAll();
 268      }
 269  
 270      protected String generateSecurePassword() {
 271          return PasswordUtils.generateSecurePassword(FULL_PASSWORD_LENGTH);
 272      }
 273  
 274      @Override
 275      @Transactional(&quot;blTransactionManager&quot;)
 276      public AdminUser changePassword(PasswordChange passwordChange) {
 277          AdminUser user = readAdminUserByUserName(passwordChange.getUsername());
 278          user.setUnencodedPassword(passwordChange.getNewPassword());
 279          user = saveAdminUser(user);
 280          Authentication auth = SecurityContextHolder.getContext().getAuthentication();
<abbr title=" 281          UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(passwordChange.getUsername(), passwordChange.getNewPassword(), auth.getAuthorities());"> 281          UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(passwordChange.gðŸ”µ</abbr>
 282          SecurityContextHolder.getContext().setAuthentication(authRequest);
 283          auth.setAuthenticated(false);
 284          return user;
 285      }
 286  
 287      @Override
<abbr title=" 288      public boolean isUserQualifiedForOperationOnCeilingEntity(AdminUser adminUser, PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 288      public boolean isUserQualifiedForOperationOnCeilingEntity(AdminUser adminUser, PermissionType permissionType, ðŸ”µ</abbr>
 289          Boolean response = null;
 290          String cacheKey = buildCacheKey(adminUser, permissionType, ceilingEntityFullyQualifiedName);
 291          Element cacheElement = cache.get(cacheKey);
 292  
 293          if (cacheElement != null) {
 294              response = (Boolean) cacheElement.getObjectValue();
 295  
 296              if (LOG.isTraceEnabled()) {
 297                  LOG.trace(&quot;Admin Security Cache GET For: \&quot;&quot; + cacheKey + &quot;\&quot; = &quot; + response);
 298              }
 299          }
 300  
 301          if (response == null) {
<abbr title=" 302              response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntity(adminUser, permissionType, ceilingEntityFullyQualifiedName);"> 302              response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntity(adminUser, permissionType, ceðŸ”µ</abbr>
 303  
 304              if (!response) {
<abbr title=" 305                  response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntityViaDefaultPermissions(ceilingEntityFullyQualifiedName);"> 305                  response = adminPermissionDao.isUserQualifiedForOperationOnCeilingEntityViaDefaultPermissions(ceilðŸ”µ</abbr>
 306              }
 307  
 308              cacheElement = new Element(cacheKey, response);
 309              cache.put(cacheElement);
 310  
 311              if (LOG.isTraceEnabled()) {
 312                  LOG.trace(&quot;Admin Security Cache PUT For: \&quot;&quot; + cacheKey + &quot;\&quot; = &quot; + response);
 313              }
 314          }
 315  
 316          return response;
 317      }
 318  
<abbr title=" 319      protected String buildCacheKey(AdminUser adminUser, PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 319      protected String buildCacheKey(AdminUser adminUser, PermissionType permissionType, String ceilingEntityFullyQuðŸ”µ</abbr>
 320          return CACHE_KEY_PREFIX
 321                 + &quot;user:&quot; + adminUser.getId() + &quot;,&quot;
 322                 + &quot;permType:&quot; + permissionType.getFriendlyType() + &quot;,&quot;
 323                 + &quot;ceiling:&quot; + ceilingEntityFullyQualifiedName;
 324      }
 325  
 326      @Override
<abbr title=" 327      public boolean doesOperationExistForCeilingEntity(PermissionType permissionType, String ceilingEntityFullyQualifiedName) {"> 327      public boolean doesOperationExistForCeilingEntity(PermissionType permissionType, String ceilingEntityFullyQualðŸ”µ</abbr>
<abbr title=" 328          return adminPermissionDao.doesOperationExistForCeilingEntity(permissionType, ceilingEntityFullyQualifiedName);"> 328          return adminPermissionDao.doesOperationExistForCeilingEntity(permissionType, ceilingEntityFullyQualifiedNaðŸ”µ</abbr>
 329      }
 330  
 331      @Override
 332      public AdminUser readAdminUserByUserName(String userName) {
 333          return adminUserDao.readAdminUserByUserName(userName);
 334      }
 335  
 336      @Override
 337      public List&lt;AdminUser&gt; readAdminUsersByEmail(String email) {
 338          return adminUserDao.readAdminUserByEmail(email);
 339      }
 340  
 341      @Override
 342      public List&lt;AdminUser&gt; readAllAdminUsers() {
 343          return adminUserDao.readAllAdminUsers();
 344      }
 345  
 346      @Override
 347      public List&lt;AdminRole&gt; readAllAdminRoles() {
 348          return adminRoleDao.readAllAdminRoles();
 349      }
 350  
 351      @Override
 352      public List&lt;AdminPermission&gt; readAllAdminPermissions() {
 353          return adminPermissionDao.readAllAdminPermissions();
 354      }
 355  
 356      @Override
 357      @Transactional(&quot;blTransactionManager&quot;)
 358      public GenericResponse sendForgotUsernameNotification(String emailAddress) {
 359          GenericResponse response = new GenericResponse();
 360          List&lt;AdminUser&gt; users = null;
 361          if (emailAddress != null) {
 362              users = adminUserDao.readAdminUserByEmail(emailAddress);
 363          }
 364          if (CollectionUtils.isEmpty(users)) {
 365              response.addErrorCode(&quot;notFound&quot;);
 366          } else {
 367              List&lt;String&gt; activeUsernames = new ArrayList&lt;String&gt;();
 368              for (AdminUser user : users) {
 369                  if (user.getActiveStatusFlag()) {
 370                      activeUsernames.add(user.getLogin());
 371                  }
 372              }
 373  
 374              if (activeUsernames.size() &gt; 0) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 375 -                HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 376 -                vars.put(&quot;accountNames&quot;, activeUsernames);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 377 -                emailService.sendTemplateEmail(emailAddress, getSendUsernameEmailInfo(), vars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 378 +                eventPublisher.publishEvent(new AdminForgotUsernameEvent(this, emailAddress, null, activeUsernames));"> 378 +                eventPublisher.publishEvent(new AdminForgotUsernameEvent(this, emailAddress, null, activeUsernamesðŸ”µ</abbr></span>
 379              } else {
 380                  // send inactive username found email.
 381                  response.addErrorCode(&quot;inactiveUser&quot;);
 382              }
 383          }
 384          return response;
 385      }
 386  
 387      @Override
 388      @Transactional(&quot;blTransactionManager&quot;)
 389      public GenericResponse sendResetPasswordNotification(String username) {
 390          GenericResponse response = new GenericResponse();
 391          AdminUser user = null;
 392  
 393          if (username != null) {
 394              user = adminUserDao.readAdminUserByUserName(username);
 395          }
 396  
 397          checkUser(user,response);
 398  
 399          if (! response.getHasErrors()) {
 400              String token = PasswordUtils.generateSecurePassword(TEMP_PASSWORD_LENGTH);
 401              token = token.toLowerCase();
 402  
 403              ForgotPasswordSecurityToken fpst = new ForgotPasswordSecurityTokenImpl();
 404              fpst.setAdminUserId(user.getId());
 405              fpst.setToken(encodePassword(token, null));

 406              fpst.setCreateDate(SystemTime.asDate());
 407              forgotPasswordSecurityTokenDao.saveToken(fpst);
 408  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -            HashMap&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -            vars.put(&quot;token&quot;, token);</span>
 411              String resetPasswordUrl = getResetPasswordURL();
 412              if (!StringUtils.isEmpty(resetPasswordUrl)) {
 413                  if (resetPasswordUrl.contains(&quot;?&quot;)) {
 414                      resetPasswordUrl=resetPasswordUrl+&quot;&amp;token=&quot;+token;
 415                  } else {
 416                      resetPasswordUrl=resetPasswordUrl+&quot;?token=&quot;+token;
 417                  }
 418              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 419 -            vars.put(&quot;resetPasswordUrl&quot;, resetPasswordUrl);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 420 -            emailService.sendTemplateEmail(user.getEmail(), getResetPasswordEmailInfo(), vars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 421 -</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 423 +            eventPublisher.publishEvent(new AdminForgotPasswordEvent(this, user.getId(), token, resetPasswordUrl));"> 423 +            eventPublisher.publishEvent(new AdminForgotPasswordEvent(this, user.getId(), token, resetPasswordUrl))ðŸ”µ</abbr></span>
 424          }
 425          return response;
 426      }
 427  
 428      @Override
 429      @Transactional(&quot;blTransactionManager&quot;)
<abbr title=" 430      public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPassword) {"> 430      public GenericResponse resetPasswordUsingToken(String username, String token, String password, String confirmPðŸ”µ</abbr>
 431          GenericResponse response = new GenericResponse();
 432          AdminUser user = null;
 433          if (username != null) {
 434              user = adminUserDao.readAdminUserByUserName(username);
 435          }
 436          checkUser(user, response);
 437          checkPassword(password, confirmPassword, response);
 438          if (StringUtils.isBlank(token)) {
 439              response.addErrorCode(&quot;invalidToken&quot;);
 440          }
 441  
 442          ForgotPasswordSecurityToken fpst = null;
 443          if (! response.getHasErrors()) {
 444              token = token.toLowerCase();
<abbr title=" 445              List&lt;ForgotPasswordSecurityToken&gt; fpstoks = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(user.getId());"> 445              List&lt;ForgotPasswordSecurityToken&gt; fpstoks = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserðŸ”µ</abbr>
 446              for (ForgotPasswordSecurityToken fpstok : fpstoks) {
 447                  if (isPasswordValid(fpstok.getToken(), token, null)) {

 448                      fpst = fpstok;
 449                      break;
 450                  }
 451              }
 452              if (fpst == null) {
 453                  response.addErrorCode(&quot;invalidToken&quot;);
 454              } else if (fpst.isTokenUsedFlag()) {
 455                  response.addErrorCode(&quot;tokenUsed&quot;);
 456              } else if (isTokenExpired(fpst)) {
 457                  response.addErrorCode(&quot;tokenExpired&quot;);
 458              }
 459          }
 460  
 461          if (! response.getHasErrors()) {
 462              if (! user.getId().equals(fpst.getAdminUserId())) {
 463                  if (LOG.isWarnEnabled()) {
<abbr title=" 464                      LOG.warn(&quot;Password reset attempt tried with mismatched user and token &quot; + user.getId() + &quot;, &quot; + StringUtil.sanitize(token));"> 464                      LOG.warn(&quot;Password reset attempt tried with mismatched user and token &quot; + user.getId() + &quot;, &quot; ðŸ”µ</abbr>
 465                  }
 466                  response.addErrorCode(&quot;invalidToken&quot;);
 467              }
 468          }
 469  
 470          if (! response.getHasErrors()) {
 471              user.setUnencodedPassword(password);
 472              saveAdminUser(user);
 473              invalidateAllTokensForAdminUser(user);
 474          }
 475  
 476          return response;
 477      }
 478  
 479      protected void invalidateAllTokensForAdminUser(AdminUser user) {
<abbr title=" 480          List&lt;ForgotPasswordSecurityToken&gt; tokens = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(user.getId());"> 480          List&lt;ForgotPasswordSecurityToken&gt; tokens = forgotPasswordSecurityTokenDao.readUnusedTokensByAdminUserId(usðŸ”µ</abbr>
 481          for (ForgotPasswordSecurityToken token : tokens) {
 482              token.setTokenUsedFlag(true);
 483              forgotPasswordSecurityTokenDao.saveToken(token);
 484          }
 485      }
 486  
 487      protected void checkUser(AdminUser user, GenericResponse response) {
 488          if (user == null) {
 489              response.addErrorCode(&quot;invalidUser&quot;);
 490          } else if (StringUtils.isBlank(user.getEmail())) {
 491              response.addErrorCode(&quot;emailNotFound&quot;);
 492          } else if (BooleanUtils.isNotTrue(user.getActiveStatusFlag())) {
 493              response.addErrorCode(&quot;inactiveUser&quot;);
 494          }
 495      }
 496  
 497      protected void checkPassword(String password, String confirmPassword, GenericResponse response) {
 498          if (StringUtils.isBlank(password) || StringUtils.isBlank(confirmPassword)) {
 499              response.addErrorCode(&quot;invalidPassword&quot;);
 500          } else if (! password.equals(confirmPassword)) {
 501              response.addErrorCode(&quot;passwordMismatch&quot;);
 502          }
 503      }
 504  
 505      protected void checkExistingPassword(String unencodedPassword, AdminUser user, GenericResponse response) {
 506          if (!isPasswordValid(user.getPassword(), unencodedPassword, getSalt(user, unencodedPassword))) {

 507              response.addErrorCode(&quot;invalidPassword&quot;);
 508          }
 509      }
 510  
 511      protected boolean isTokenExpired(ForgotPasswordSecurityToken fpst) {
 512          Date now = SystemTime.asDate();
 513          long currentTimeInMillis = now.getTime();
 514          long tokenSaveTimeInMillis = fpst.getCreateDate().getTime();
 515          long minutesSinceSave = (currentTimeInMillis - tokenSaveTimeInMillis)/60000;
 516          return minutesSinceSave &gt; getTokenExpiredMinutes();
 517      }
 518  
 519      public static int getPASSWORD_TOKEN_LENGTH() {
 520          return TEMP_PASSWORD_LENGTH;
 521      }
 522  
 523      public static void setPASSWORD_TOKEN_LENGTH(int PASSWORD_TOKEN_LENGTH) {
 524          AdminSecurityServiceImpl.TEMP_PASSWORD_LENGTH = PASSWORD_TOKEN_LENGTH;
 525      }
 526  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 527 -    public EmailInfo getSendUsernameEmailInfo() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 528 -        return sendUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 529 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 530 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 531 -    public void setSendUsernameEmailInfo(EmailInfo sendUsernameEmailInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 532 -        this.sendUsernameEmailInfo = sendUsernameEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 533 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 534 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 535 -    public EmailInfo getResetPasswordEmailInfo() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 536 -        return resetPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 537 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 538 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 539 -    public void setResetPasswordEmailInfo(EmailInfo resetPasswordEmailInfo) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 540 -        this.resetPasswordEmailInfo = resetPasswordEmailInfo;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 541 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 542 -</span>
 543      @Deprecated
 544      @Override
 545      public Object getSalt(AdminUser user, String unencodedPassword) {
 546          Object salt = null;
 547          if (saltSource != null) {
<abbr title=" 548              salt = saltSource.getSalt(new AdminUserDetails(user.getId(), user.getLogin(), unencodedPassword, new ArrayList&lt;GrantedAuthority&gt;()));"> 548              salt = saltSource.getSalt(new AdminUserDetails(user.getId(), user.getLogin(), unencodedPassword, new AðŸ”µ</abbr>
 549          }
 550          return salt;
 551      }
 552  
 553      @Deprecated
 554      @Override
 555      public String getSalt() {
 556          return salt;
 557      }
 558  
 559      @Deprecated
 560      @Override
 561      public void setSalt(String salt) {
 562          this.salt = salt;
 563      }
 564  
 565      @Deprecated
 566      @Override
 567      public SaltSource getSaltSource() {
 568          return saltSource;
 569      }
 570  
 571      @Deprecated
 572      @Override
 573      public void setSaltSource(SaltSource saltSource) {
 574          this.saltSource = saltSource;
 575      }
 576  
 577      @Override
 578      @Transactional(&quot;blTransactionManager&quot;)
 579      public GenericResponse changePassword(String username,
 580              String oldPassword, String password, String confirmPassword) {
 581          GenericResponse response = new GenericResponse();
 582          AdminUser user = null;
 583          if (username != null) {
 584              user = adminUserDao.readAdminUserByUserName(username);
 585          }
 586          checkUser(user, response);
 587          checkPassword(password, confirmPassword, response);
 588  
 589          if (!response.getHasErrors()) {
 590              checkExistingPassword(oldPassword, user, response);
 591          }
 592  
 593          if (!response.getHasErrors()) {
 594              user.setUnencodedPassword(password);
 595              saveAdminUser(user);
 596  
 597          }
 598  
 599          return response;
 600  
 601      }
 602  
 603      /**
 604       * Determines if a password is valid by comparing it to the encoded string, optionally using a salt.
 605       * &lt;p&gt;
<abbr title=" 606       * The externally salted {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder} support is"> 606       * The externally salted {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEðŸ”µ</abbr>
<abbr title=" 607       * being deprecated, following in Spring Security&#x27;s footsteps, in order to move towards self salting hashing algorithms such as bcrypt."> 607       * being deprecated, following in Spring Security&#x27;s footsteps, in order to move towards self salting hashing aðŸ”µ</abbr>
<abbr title=" 608       * Bcrypt is a superior hashing algorithm that randomly generates a salt per password in order to protect against rainbow table attacks"> 608       * Bcrypt is a superior hashing algorithm that randomly generates a salt per password in order to protect agaiðŸ”µ</abbr>
<abbr title=" 609       * and is an intentionally expensive algorithm to further guard against brute force attempts to crack hashed passwords."> 609       * and is an intentionally expensive algorithm to further guard against brute force attempts to crack hashed pðŸ”µ</abbr>
<abbr title=" 610       * Additionally, having the encoding algorithm handle the salt internally reduces code complexity and dependencies such as {@link SaltSource}."> 610       * Additionally, having the encoding algorithm handle the salt internally reduces code complexity and dependenðŸ”µ</abbr>
 611       *
 612       * @deprecated the new {@link PasswordEncoder} handles salting internally, this will be removed in 4.2
 613       *
 614       * @param encodedPassword the encoded password
 615       * @param rawPassword the unencoded password
 616       * @param salt the optional salt
 617       * @return true if rawPassword matches the encodedPassword, false otherwise
 618       */
 619      @Deprecated
 620      protected boolean isPasswordValid(String encodedPassword, String rawPassword, Object salt) {
 621          if (usingDeprecatedPasswordEncoder()) {
 622              return passwordEncoder.isPasswordValid(encodedPassword, rawPassword, salt);
 623          } else {
 624              return isPasswordValid(encodedPassword, rawPassword);
 625          }
 626      }
 627  
 628      /**
<abbr title=" 629       * Determines if a password is valid by comparing it to the encoded string, salting is handled internally to the {@link PasswordEncoder}."> 629       * Determines if a password is valid by comparing it to the encoded string, salting is handled internally to tðŸ”µ</abbr>
 630       * &lt;p&gt;
<abbr title=" 631       * This method must always be called to verify if a password is valid after the original encoded password is generated"> 631       * This method must always be called to verify if a password is valid after the original encoded password is gðŸ”µ</abbr>
<abbr title=" 632       * due to {@link PasswordEncoder} randomly generating salts internally and appending them to the resulting hash."> 632       * due to {@link PasswordEncoder} randomly generating salts internally and appending them to the resulting hasðŸ”µ</abbr>
 633       *
 634       * @param encodedPassword the encoded password
 635       * @param rawPassword the raw password to check against the encoded password
 636       * @return true if rawPassword matches the encodedPassword, false otherwise
 637       */
 638      protected boolean isPasswordValid(String encodedPassword, String rawPassword) {
 639          return passwordEncoderNew.matches(rawPassword, encodedPassword);

 640      }
 641  
 642      /**
 643       * Generate an encoded password from a raw password, optionally using a salt.
 644       * &lt;p&gt;
<abbr title=" 645       * The externally salted {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEncoder} support is"> 645       * The externally salted {@link org.springframework.security.authentication.encoding.PasswordEncoder PasswordEðŸ”µ</abbr>
<abbr title=" 646       * being deprecated, following in Spring Security&#x27;s footsteps, in order to move towards self salting hashing algorithms such as bcrypt."> 646       * being deprecated, following in Spring Security&#x27;s footsteps, in order to move towards self salting hashing aðŸ”µ</abbr>
<abbr title=" 647       * Bcrypt is a superior hashing algorithm that randomly generates a salt per password in order to protect against rainbow table attacks"> 647       * Bcrypt is a superior hashing algorithm that randomly generates a salt per password in order to protect agaiðŸ”µ</abbr>
<abbr title=" 648       * and is an intentionally expensive algorithm to further guard against brute force attempts to crack hashed passwords."> 648       * and is an intentionally expensive algorithm to further guard against brute force attempts to crack hashed pðŸ”µ</abbr>
<abbr title=" 649       * Additionally, having the encoding algorithm handle the salt internally reduces code complexity and dependencies such as {@link SaltSource}."> 649       * Additionally, having the encoding algorithm handle the salt internally reduces code complexity and dependenðŸ”µ</abbr>
 650       *
 651       * @deprecated the new {@link PasswordEncoder} handles salting internally, this will be removed in 4.2
 652       *
 653       * @param rawPassword
 654       * @param salt
 655       * @return
 656       */
 657      @Deprecated
 658      protected String encodePassword(String rawPassword, Object salt) {
 659          if (usingDeprecatedPasswordEncoder()) {
 660              return passwordEncoder.encodePassword(rawPassword, salt);
 661          } else {
 662              return encodePassword(rawPassword);
 663          }
 664      }
 665  
 666      /**
<abbr title=" 667       * Generate an encoded password from a raw password, salting is handled internally to the {@link PasswordEncoder}."> 667       * Generate an encoded password from a raw password, salting is handled internally to the {@link PasswordEncodðŸ”µ</abbr>

 668       * &lt;p&gt;
<abbr title=" 669       * This method can only be called once per password. The salt is randomly generated internally in the {@link PasswordEncoder}"> 669       * This method can only be called once per password. The salt is randomly generated internally in the {@link PðŸ”µ</abbr>
<abbr title=" 670       * and appended to the hash to provide the resulting encoded password. Once this has been called on a password,"> 670       * and appended to the hash to provide the resulting encoded password. Once this has been called on a passwordðŸ”µ</abbr>
<abbr title=" 671       * going forward all checks for authenticity must be done by {@link #isPasswordValid(String, String)} as encoding the"> 671       * going forward all checks for authenticity must be done by {@link #isPasswordValid(String, String)} as encodðŸ”µ</abbr>
 672       * same password twice will result in different encoded passwords.
 673       *
 674       * @param rawPassword the unencoded password to encode
 675       * @return the encoded password
 676       */
 677      protected String encodePassword(String rawPassword) {
 678          return passwordEncoderNew.encode(rawPassword);
 679      }
 680  
 681      @Deprecated
 682      protected boolean usingDeprecatedPasswordEncoder() {
 683          return passwordEncoder != null;

 684      }
 685  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            