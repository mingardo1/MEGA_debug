<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>356</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    356
                    <a href="355.html">prev</a>
                    <a href="357.html">next</a>
                    <a href="356_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_296f212b688307caed07340a18589621a66963a6_hbase/hbase-sink/src/main/java/com/dtstack/flink/sql/sink/hbase/HbaseOutputFormat.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;296f212b688307caed07340a18589621a66963a6:hbase/hbase-sink/src/main/java/com/dtstack/flink/sql/sink/hbase/HbaseOutputFormat.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;296f212b688307caed07340a18589621a66963a6^1:hbase/hbase-sink/src/main/java/com/dtstack/flink/sql/sink/hbase/HbaseOutputFormat.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;296f212b688307caed07340a18589621a66963a6^2:hbase/hbase-sink/src/main/java/com/dtstack/flink/sql/sink/hbase/HbaseOutputFormat.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;31f1ea14a44dc5df28823b0897609031044a15b1:hbase/hbase-sink/src/main/java/com/dtstack/flink/sql/sink/hbase/HbaseOutputFormat.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19  
  20 
  21 package com.dtstack.flink.sql.sink.hbase;
  22 
  23 import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
  24 import com.google.common.collect.Maps;
  25 import org.apache.commons.lang3.StringUtils;
  26 import org.apache.flink.api.java.tuple.Tuple2;
  27 import org.apache.flink.configuration.Configuration;
  28 import org.apache.flink.types.Row;
  29 import org.apache.flink.util.Preconditions;
  30 import org.apache.hadoop.hbase.*;
  31 import org.apache.hadoop.hbase.client.Connection;
  32 import org.apache.hadoop.hbase.client.ConnectionFactory;
  33 import org.apache.hadoop.hbase.client.Put;
  34 import org.apache.hadoop.hbase.client.Table;
  35 import org.apache.hadoop.security.UserGroupInformation;
  36 import org.slf4j.Logger;
  37 import org.slf4j.LoggerFactory;
  38 
  39 import java.io.File;
  40 import java.io.IOException;
  41 import java.security.PrivilegedAction;
  42 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  43 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.io.IOException;</span>
  46 &lt;&lt;&lt;&lt;&lt;&lt;&lt; OURS
  47 =======
  48 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49 import java.util.List;</span>
  50 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  51 import java.util.Map;
  52 import java.util.Set;
  53 
  54 /**
  55  * @author: jingzhen@dtstack.com
  56  * date: 2017-6-29
  57  */
  58 public class HbaseOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&gt; {
  59 
  60     private static final Logger LOG = LoggerFactory.getLogger(HbaseOutputFormat.class);
  61 
  62     private String host;
  63     private String zkParent;
  64     private String rowkey;
  65     private String tableName;
  66     private String[] columnNames;
  67     private String updateMode;
  68     private String[] columnTypes;
  69     private Map&lt;String, String&gt; columnNameFamily;
  70 
  71     private boolean kerberosAuthEnable;
  72     private String regionserverKeytabFile;
  73     private String regionserverPrincipal;
  74     private String securityKrb5Conf;
  75     private String zookeeperSaslClient;
  76     private String clientPrincipal;
  77     private String clientKeytabFile;
  78 
  79     private String[] families;
  80     private String[] qualifiers;
  81 
  82     private transient org.apache.hadoop.conf.Configuration conf;
  83     private transient Connection conn;
  84     private transient Table table;
  85 
  86     private transient ChoreService choreService;
  87 
  88     @Override
  89     public void configure(Configuration parameters) {
  90         LOG.warn(&quot;---configure---&quot;);
  91         conf = HBaseConfiguration.create();
  92     }
  93 
  94     @Override
  95     public void open(int taskNumber, int numTasks) throws IOException {
  96         LOG.warn(&quot;---open---&quot;);
  97         openConn();
  98         table = conn.getTable(TableName.valueOf(tableName));
  99         LOG.warn(&quot;---open end(get table from hbase) ---&quot;);
 100         initMetric();
 101     }
 102 
 103     private void openConn(){
 104         try{
 105             if (kerberosAuthEnable) {
 106                 LOG.info(&quot;open kerberos conn&quot;);
 107                 openKerberosConn();
 108             } else {
 109                 LOG.info(&quot;open conn&quot;);
 110                 conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 111                 conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 112                 conn = ConnectionFactory.createConnection(conf);
 113             }
 114         }catch (Exception e){
 115             throw new RuntimeException(e);
 116         }
 117 
 118     }
 119     private void openKerberosConn() throws IOException {
 120         conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 121         conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 122 
 123         LOG.info(&quot;kerberos config:{}&quot;, this.toString());
 124         Preconditions.checkArgument(!StringUtils.isEmpty(clientPrincipal), &quot; clientPrincipal not null!&quot;);
<abbr title=" 125         Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;);"> 125         Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;ðŸ”µ</abbr>
 126 
 127         fillSyncKerberosConfig(conf, regionserverPrincipal, zookeeperSaslClient, securityKrb5Conf);
 128 
 129         clientKeytabFile = System.getProperty(&quot;user.dir&quot;) + File.separator + clientKeytabFile;
<abbr title=" 130         clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal;"> 130         clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipalðŸ”µ</abbr>
 131 
 132         conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KEYTAB_FILE, clientKeytabFile);
 133         conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KERBEROS_PRINCIPAL, clientPrincipal);
 134 
<abbr title=" 135         UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clientKeytabFile);"> 135         UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrinciðŸ”µ</abbr>
 136         org.apache.hadoop.conf.Configuration finalConf = conf;
 137         conn = userGroupInformation.doAs(new PrivilegedAction&lt;Connection&gt;() {
 138             @Override
 139             public Connection run() {
 140                 try {
 141                     ScheduledChore authChore = AuthUtil.getAuthChore(finalConf);
 142                     if (authChore != null) {
 143                         choreService = new ChoreService(&quot;hbaseKerberosSink&quot;);
 144                         choreService.scheduleChore(authChore);
 145                     }
 146 
 147                     return ConnectionFactory.createConnection(finalConf);
 148                 } catch (IOException e) {
 149                     LOG.error(&quot;Get connection fail with config:{}&quot;, finalConf);
 150                     throw new RuntimeException(e);
 151                 }
 152             }
 153         });
 154     }
 155 
 156 
 157 
 158     @Override
 159     public void writeRecord(Tuple2 tuple2) {
 160         Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;
 161         Row row = tupleTrans.f1;
 162         dealInsert(row);
 163     }
 164 
 165     protected void dealInsert(Row record) {
 166         Put put = getPutByRow(record);
 167         if (put == null || put.isEmpty()) {
 168             outDirtyRecords.inc();
 169             return;
 170         }
 171 
 172         try {
 173             table.put(put);
 174         } catch (Exception e) {
 175             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {
 176                 LOG.error(&quot;record insert failed ..{}&quot;, record.toString());
 177                 LOG.error(&quot;&quot;, e);
 178             }
 179             outDirtyRecords.inc();
 180         }
 181 
 182         if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 183             LOG.info(record.toString());
 184         }
 185         outRecords.inc();
 186     }
 187 
 188     private Put getPutByRow(Row record) {
 189         String rowKey = buildRowKey(record);
 190         if (StringUtils.isEmpty(rowKey)) {
 191             return null;
 192         }
 193         Put put = new Put(rowKey.getBytes());
 194         for (int i = 0; i &lt; record.getArity(); ++i) {
 195             Object fieldVal = record.getField(i);
 196             if (fieldVal == null) {
 197                 continue;
 198             }
 199             byte[] val = HbaseUtil.toByte(fieldVal);
 200             byte[] cf = families[i].getBytes();
 201             byte[] qualifier = qualifiers[i].getBytes();
 202 
 203             put.addColumn(cf, qualifier, val);
 204         }
 205         return put;
 206     }
 207 
 208     private String buildRowKey(Row record) {
 209         String rowKeyValues = getRowKeyValues(record);
 210         // all rowkey not null
 211         if (StringUtils.isBlank(rowKeyValues)) {
 212             LOG.error(&quot;row key value must not null,record is ..{}&quot;, record);
 213             outDirtyRecords.inc();
 214             return &quot;&quot;;
 215         }
 216         return rowKeyValues;
 217     }
 218 
 219     private String getRowKeyValues(Row record) {
 220         Map&lt;String, Object&gt; row = rowConvertMap(record);
 221         RowKeyBuilder rowKeyBuilder = new RowKeyBuilder();
 222         rowKeyBuilder.init(rowkey);
 223         return rowKeyBuilder.getRowKey(row);
 224     }
 225 
 226     private Map&lt;String, Object&gt; rowConvertMap(Row record){
 227         Map&lt;String, Object&gt; rowValue = Maps.newHashMap();
 228         for(int i = 0; i &lt; columnNames.length; i++){
 229             rowValue.put(columnNames[i], record.getField(i));
 230         }
 231         return rowValue;
 232     }
 233 
 234     @Override
 235     public void close() throws IOException {
 236         if (conn != null) {
 237             conn.close();
 238             conn = null;
 239         }
 240     }
 241     private HbaseOutputFormat() {
 242     }
 243 
 244     public static HbaseOutputFormatBuilder buildHbaseOutputFormat() {
 245         return new HbaseOutputFormatBuilder();
 246     }
 247 
 248     public static class HbaseOutputFormatBuilder {
 249 
 250         private HbaseOutputFormat format;
 251 
 252         private HbaseOutputFormatBuilder() {
 253             format = new HbaseOutputFormat();
 254         }
 255 
 256         public HbaseOutputFormatBuilder setHost(String host) {
 257             format.host = host;
 258             return this;
 259         }
 260 
 261         public HbaseOutputFormatBuilder setZkParent(String parent) {
 262             format.zkParent = parent;
 263             return this;
 264         }
 265 
 266 
 267         public HbaseOutputFormatBuilder setTable(String tableName) {
 268             format.tableName = tableName;
 269             return this;
 270         }
 271 
 272         public HbaseOutputFormatBuilder setRowkey(String rowkey) {
 273             format.rowkey = rowkey;
 274             return this;
 275         }
 276 
 277         public HbaseOutputFormatBuilder setColumnNames(String[] columnNames) {
 278             format.columnNames = columnNames;
 279             return this;
 280         }
 281 
 282         public HbaseOutputFormatBuilder setColumnTypes(String[] columnTypes) {
 283             format.columnTypes = columnTypes;
 284             return this;
 285         }
 286 
 287         public HbaseOutputFormatBuilder setColumnNameFamily(Map&lt;String, String&gt; columnNameFamily) {
 288             format.columnNameFamily = columnNameFamily;
 289             return this;
 290         }
 291 
 292         public HbaseOutputFormatBuilder setKerberosAuthEnable(boolean kerberosAuthEnable) {
 293             format.kerberosAuthEnable = kerberosAuthEnable;
 294             return this;
 295         }
 296 
 297         public HbaseOutputFormatBuilder setRegionserverKeytabFile(String regionserverKeytabFile) {
 298             format.regionserverKeytabFile = regionserverKeytabFile;
 299             return this;
 300         }
 301 
 302         public HbaseOutputFormatBuilder setRegionserverPrincipal(String regionserverPrincipal) {
 303             format.regionserverPrincipal = regionserverPrincipal;
 304             return this;
 305         }
 306 
 307         public HbaseOutputFormatBuilder setSecurityKrb5Conf(String securityKrb5Conf) {
 308             format.securityKrb5Conf = securityKrb5Conf;
 309             return this;
 310         }
 311 
 312         public HbaseOutputFormatBuilder setZookeeperSaslClient(String zookeeperSaslClient) {
 313             format.zookeeperSaslClient = zookeeperSaslClient;
 314             return this;
 315         }
 316 
 317         public HbaseOutputFormatBuilder setClientPrincipal(String clientPrincipal) {
 318             format.clientPrincipal = clientPrincipal;
 319             return this;
 320         }
 321 
 322         public HbaseOutputFormatBuilder setClientKeytabFile(String clientKeytabFile) {
 323             format.clientKeytabFile = clientKeytabFile;
 324             return this;
 325         }
 326 
 327 
 328         public HbaseOutputFormat finish() {
 329             Preconditions.checkNotNull(format.host, &quot;zookeeperQuorum should be specified&quot;);
 330             Preconditions.checkNotNull(format.tableName, &quot;tableName should be specified&quot;);
 331             Preconditions.checkNotNull(format.columnNames, &quot;columnNames should be specified&quot;);
<abbr title=" 332             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be zero&quot;);"> 332             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not beðŸ”µ</abbr>
 333 
 334             String[] families = new String[format.columnNames.length];
 335             String[] qualifiers = new String[format.columnNames.length];
 336 
 337             if (format.columnNameFamily != null) {
 338                 Set&lt;String&gt; keySet = format.columnNameFamily.keySet();
 339                 String[] columns = keySet.toArray(new String[keySet.size()]);
 340                 for (int i = 0; i &lt; columns.length; ++i) {
 341                     String col = columns[i];
 342                     String[] part = col.split(&quot;:&quot;);
 343                     families[i] = part[0];
 344                     qualifiers[i] = part[1];
 345                 }
 346             }
 347             format.families = families;
 348             format.qualifiers = qualifiers;
 349 
 350             return format;
 351         }
 352 
 353     }
 354 
<abbr title=" 355     private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config, String regionserverPrincipal,"> 355     private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config, String regionserverPðŸ”µ</abbr>
<abbr title=" 356                                         String zookeeperSaslClient, String securityKrb5Conf) throws IOException {"> 356                                         String zookeeperSaslClient, String securityKrb5Conf) throws IOExcðŸ”µ</abbr>
 357         if (StringUtils.isEmpty(regionserverPrincipal)) {
<abbr title=" 358             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos&quot;);"> 358             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication isðŸ”µ</abbr>
 359         }
 360         config.set(HbaseConfigUtils.KEY_HBASE_MASTER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 361         config.set(HbaseConfigUtils.KEY_HBASE_REGIONSERVER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 362         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHORIZATION, &quot;true&quot;);
 363         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHENTICATION, &quot;kerberos&quot;);
 364 
 365 
 366         if (!StringUtils.isEmpty(zookeeperSaslClient)) {
 367             System.setProperty(HbaseConfigUtils.KEY_ZOOKEEPER_SASL_CLIENT, zookeeperSaslClient);
 368         }
 369 
 370         if (!StringUtils.isEmpty(securityKrb5Conf)) {
 371             String krb5ConfPath = System.getProperty(&quot;user.dir&quot;) + File.separator + securityKrb5Conf;
 372             LOG.info(&quot;krb5ConfPath:{}&quot;, krb5ConfPath);
 373             System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_KRB5_CONF, krb5ConfPath);
 374         }
 375     }
 376 
 377     @Override
 378     public String toString() {
 379         return &quot;HbaseOutputFormat kerberos{&quot; +
 380                 &quot;kerberosAuthEnable=&quot; + kerberosAuthEnable +
 381                 &quot;, regionserverKeytabFile=&#x27;&quot; + regionserverKeytabFile + &#x27;\&#x27;&#x27; +
 382                 &quot;, regionserverPrincipal=&#x27;&quot; + regionserverPrincipal + &#x27;\&#x27;&#x27; +
 383                 &quot;, securityKrb5Conf=&#x27;&quot; + securityKrb5Conf + &#x27;\&#x27;&#x27; +
 384                 &quot;, zookeeperSaslClient=&#x27;&quot; + zookeeperSaslClient + &#x27;\&#x27;&#x27; +
 385                 &quot;, clientPrincipal=&#x27;&quot; + clientPrincipal + &#x27;\&#x27;&#x27; +
 386                 &quot;, clientKeytabFile=&#x27;&quot; + clientKeytabFile + &#x27;\&#x27;&#x27; +
 387                 &#x27;}&#x27;;
 388     }
 389 
 390 }</pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 
  19 
  20 
  21 package com.dtstack.flink.sql.sink.hbase;
  22 
  23 import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
  24 import com.google.common.collect.Maps;
  25 import org.apache.commons.lang3.StringUtils;
  26 import org.apache.flink.api.java.tuple.Tuple2;
  27 import org.apache.flink.configuration.Configuration;
  28 import org.apache.flink.types.Row;
  29 import org.apache.flink.util.Preconditions;
  30 import org.apache.hadoop.hbase.*;
  31 import org.apache.hadoop.hbase.client.Connection;
  32 import org.apache.hadoop.hbase.client.ConnectionFactory;
  33 import org.apache.hadoop.hbase.client.Put;
  34 import org.apache.hadoop.hbase.client.Table;
  35 import org.apache.hadoop.security.UserGroupInformation;
  36 import org.slf4j.Logger;
  37 import org.slf4j.LoggerFactory;
  38 
  39 import java.io.File;
  40 import java.io.IOException;
  41 import java.security.PrivilegedAction;
  42 import java.util.List;
  43 import java.util.Map;
  44 import java.util.Set;
  45 
  46 /**
  47  * @author: jingzhen@dtstack.com
  48  * date: 2017-6-29
  49  */
  50 public class HbaseOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&gt; {
  51 
  52     private static final Logger LOG = LoggerFactory.getLogger(HbaseOutputFormat.class);
  53 
  54     private String host;
  55     private String zkParent;
  56     private String rowkey;
  57     private String tableName;
  58     private String[] columnNames;
  59     private String updateMode;
  60     private String[] columnTypes;
  61     private Map&lt;String, String&gt; columnNameFamily;
  62 
  63     private boolean kerberosAuthEnable;
  64     private String regionserverKeytabFile;
  65     private String regionserverPrincipal;
  66     private String securityKrb5Conf;
  67     private String zookeeperSaslClient;
  68     private String clientPrincipal;
  69     private String clientKeytabFile;
  70 
  71     private String[] families;
  72     private String[] qualifiers;
  73 
  74     private transient org.apache.hadoop.conf.Configuration conf;
  75     private transient Connection conn;
  76     private transient Table table;
  77 
  78     private transient ChoreService choreService;
  79 
  80     @Override
  81     public void configure(Configuration parameters) {
  82         LOG.warn(&quot;---configure---&quot;);
  83         conf = HBaseConfiguration.create();
  84     }
  85 
  86     @Override
  87     public void open(int taskNumber, int numTasks) throws IOException {
  88         LOG.warn(&quot;---open---&quot;);
  89         openConn();
  90         table = conn.getTable(TableName.valueOf(tableName));
  91         LOG.warn(&quot;---open end(get table from hbase) ---&quot;);
  92         initMetric();
  93     }
  94 
  95     private void openConn(){
  96         try{
  97             if (kerberosAuthEnable) {
  98                 LOG.info(&quot;open kerberos conn&quot;);
  99                 openKerberosConn();
 100             } else {
 101                 LOG.info(&quot;open conn&quot;);
 102                 conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 103                 conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 104                 conn = ConnectionFactory.createConnection(conf);
 105             }
 106         }catch (Exception e){
 107             throw new RuntimeException(e);
 108         }
 109 
 110     }
 111     private void openKerberosConn() throws IOException {
 112         conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 113         conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 114 
 115         LOG.info(&quot;kerberos config:{}&quot;, this.toString());
 116         Preconditions.checkArgument(!StringUtils.isEmpty(clientPrincipal), &quot; clientPrincipal not null!&quot;);
<abbr title=" 117         Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;);"> 117         Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;ðŸ”µ</abbr>
 118 
 119         fillSyncKerberosConfig(conf, regionserverPrincipal, zookeeperSaslClient, securityKrb5Conf);
 120 
 121         clientKeytabFile = System.getProperty(&quot;user.dir&quot;) + File.separator + clientKeytabFile;
<abbr title=" 122         clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal;"> 122         clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipalðŸ”µ</abbr>
 123 
 124         conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KEYTAB_FILE, clientKeytabFile);
 125         conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KERBEROS_PRINCIPAL, clientPrincipal);
 126 
<abbr title=" 127         UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clientKeytabFile);"> 127         UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrinciðŸ”µ</abbr>
 128         org.apache.hadoop.conf.Configuration finalConf = conf;
 129         conn = userGroupInformation.doAs(new PrivilegedAction&lt;Connection&gt;() {
 130             @Override
 131             public Connection run() {
 132                 try {
 133                     ScheduledChore authChore = AuthUtil.getAuthChore(finalConf);
 134                     if (authChore != null) {
 135                         choreService = new ChoreService(&quot;hbaseKerberosSink&quot;);
 136                         choreService.scheduleChore(authChore);
 137                     }
 138 
 139                     return ConnectionFactory.createConnection(finalConf);
 140                 } catch (IOException e) {
 141                     LOG.error(&quot;Get connection fail with config:{}&quot;, finalConf);
 142                     throw new RuntimeException(e);
 143                 }
 144             }
 145         });
 146     }
 147 
 148 
 149 
 150     @Override
 151     public void writeRecord(Tuple2 tuple2) {
 152         Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;
 153         Row row = tupleTrans.f1;
 154             dealInsert(row);
 155     }
 156 
 157     protected void dealInsert(Row record) {
 158         Put put = getPutByRow(record);
 159         if (put == null || put.isEmpty()) {
 160             outDirtyRecords.inc();
 161             return;
 162         }
 163 
 164             try {
 165             table.put(put);
 166         } catch (Exception e) {
 167                 if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {
 168                     LOG.error(&quot;record insert failed ..{}&quot;, record.toString());
 169                     LOG.error(&quot;&quot;, e);
 170                 }
 171                 outDirtyRecords.inc();
 172             }
 173 
 174             if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 175                 LOG.info(record.toString());
 176             }
 177             outRecords.inc();
 178         }
 179 
 180     private Put getPutByRow(Row record) {
 181         String rowKey = buildRowKey(record);
 182         if (StringUtils.isEmpty(rowKey)) {
 183             return null;
 184         }
 185         Put put = new Put(rowKey.getBytes());
 186         for (int i = 0; i &lt; record.getArity(); ++i) {
 187             Object fieldVal = record.getField(i);
 188             if (fieldVal == null) {
 189                 continue;
 190             }
 191             byte[] val = HbaseUtil.toByte(fieldVal);
 192             byte[] cf = families[i].getBytes();
 193             byte[] qualifier = qualifiers[i].getBytes();
 194 
 195             put.addColumn(cf, qualifier, val);
 196         }
 197         return put;
 198     }
 199 
 200     private String buildRowKey(Row record) {
 201         String rowKeyValues = getRowKeyValues(record);
 202         // all rowkey not null
 203         if (StringUtils.isBlank(rowKeyValues)) {
 204             LOG.error(&quot;row key value must not null,record is ..{}&quot;, record);
 205             outDirtyRecords.inc();
 206             return &quot;&quot;;
 207         }
 208         return rowKeyValues;
 209     }
 210 
 211     private String getRowKeyValues(Row record) {
 212         Map&lt;String, Object&gt; row = rowConvertMap(record);
 213         RowKeyBuilder rowKeyBuilder = new RowKeyBuilder();
 214         rowKeyBuilder.init(rowkey);
 215         return rowKeyBuilder.getRowKey(row);
 216     }
 217 
 218     private Map&lt;String, Object&gt; rowConvertMap(Row record){
 219         Map&lt;String, Object&gt; rowValue = Maps.newHashMap();
 220         for(int i = 0; i &lt; columnNames.length; i++){
 221             rowValue.put(columnNames[i], record.getField(i));
 222         }
 223         return rowValue;
 224     }
 225 
 226     @Override
 227     public void close() throws IOException {
 228         if (conn != null) {
 229             conn.close();
 230             conn = null;
 231         }
 232     }
 233     private HbaseOutputFormat() {
 234     }
 235 
 236     public static HbaseOutputFormatBuilder buildHbaseOutputFormat() {
 237         return new HbaseOutputFormatBuilder();
 238     }
 239 
 240     public static class HbaseOutputFormatBuilder {
 241 
 242         private HbaseOutputFormat format;
 243 
 244         private HbaseOutputFormatBuilder() {
 245             format = new HbaseOutputFormat();
 246         }
 247 
 248         public HbaseOutputFormatBuilder setHost(String host) {
 249             format.host = host;
 250             return this;
 251         }
 252 
 253         public HbaseOutputFormatBuilder setZkParent(String parent) {
 254             format.zkParent = parent;
 255             return this;
 256         }
 257 
 258 
 259         public HbaseOutputFormatBuilder setTable(String tableName) {
 260             format.tableName = tableName;
 261             return this;
 262         }
 263 
 264         public HbaseOutputFormatBuilder setRowkey(String rowkey) {
 265             format.rowkey = rowkey;
 266             return this;
 267         }
 268 
 269         public HbaseOutputFormatBuilder setColumnNames(String[] columnNames) {
 270             format.columnNames = columnNames;
 271             return this;
 272         }
 273 
 274         public HbaseOutputFormatBuilder setColumnTypes(String[] columnTypes) {
 275             format.columnTypes = columnTypes;
 276             return this;
 277         }
 278 
 279         public HbaseOutputFormatBuilder setColumnNameFamily(Map&lt;String, String&gt; columnNameFamily) {
 280             format.columnNameFamily = columnNameFamily;
 281             return this;
 282         }
 283 
 284         public HbaseOutputFormatBuilder setKerberosAuthEnable(boolean kerberosAuthEnable) {
 285             format.kerberosAuthEnable = kerberosAuthEnable;
 286             return this;
 287         }
 288 
 289         public HbaseOutputFormatBuilder setRegionserverKeytabFile(String regionserverKeytabFile) {
 290             format.regionserverKeytabFile = regionserverKeytabFile;
 291             return this;
 292         }
 293 
 294         public HbaseOutputFormatBuilder setRegionserverPrincipal(String regionserverPrincipal) {
 295             format.regionserverPrincipal = regionserverPrincipal;
 296             return this;
 297         }
 298 
 299         public HbaseOutputFormatBuilder setSecurityKrb5Conf(String securityKrb5Conf) {
 300             format.securityKrb5Conf = securityKrb5Conf;
 301             return this;
 302         }
 303 
 304         public HbaseOutputFormatBuilder setZookeeperSaslClient(String zookeeperSaslClient) {
 305             format.zookeeperSaslClient = zookeeperSaslClient;
 306             return this;
 307         }
 308 
 309         public HbaseOutputFormatBuilder setClientPrincipal(String clientPrincipal) {
 310             format.clientPrincipal = clientPrincipal;
 311             return this;
 312         }
 313 
 314         public HbaseOutputFormatBuilder setClientKeytabFile(String clientKeytabFile) {
 315             format.clientKeytabFile = clientKeytabFile;
 316             return this;
 317         }
 318 
 319 
 320         public HbaseOutputFormat finish() {
 321             Preconditions.checkNotNull(format.host, &quot;zookeeperQuorum should be specified&quot;);
 322             Preconditions.checkNotNull(format.tableName, &quot;tableName should be specified&quot;);
 323             Preconditions.checkNotNull(format.columnNames, &quot;columnNames should be specified&quot;);
<abbr title=" 324             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be zero&quot;);"> 324             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not beðŸ”µ</abbr>
 325 
 326             String[] families = new String[format.columnNames.length];
 327             String[] qualifiers = new String[format.columnNames.length];
 328 
 329             if (format.columnNameFamily != null) {
 330                 Set&lt;String&gt; keySet = format.columnNameFamily.keySet();
 331                 String[] columns = keySet.toArray(new String[keySet.size()]);
 332                 for (int i = 0; i &lt; columns.length; ++i) {
 333                     String col = columns[i];
 334                     String[] part = col.split(&quot;:&quot;);
 335                     families[i] = part[0];
 336                     qualifiers[i] = part[1];
 337                 }
 338             }
 339             format.families = families;
 340             format.qualifiers = qualifiers;
 341 
 342             return format;
 343         }
 344 
 345     }
 346 
<abbr title=" 347     private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config, String regionserverPrincipal,"> 347     private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config, String regionserverPðŸ”µ</abbr>
<abbr title=" 348                                         String zookeeperSaslClient, String securityKrb5Conf) throws IOException {"> 348                                         String zookeeperSaslClient, String securityKrb5Conf) throws IOExcðŸ”µ</abbr>
 349         if (StringUtils.isEmpty(regionserverPrincipal)) {
<abbr title=" 350             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos&quot;);"> 350             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication isðŸ”µ</abbr>
 351         }
 352         config.set(HbaseConfigUtils.KEY_HBASE_MASTER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 353         config.set(HbaseConfigUtils.KEY_HBASE_REGIONSERVER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 354         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHORIZATION, &quot;true&quot;);
 355         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHENTICATION, &quot;kerberos&quot;);
 356 
 357 
 358         if (!StringUtils.isEmpty(zookeeperSaslClient)) {
 359             System.setProperty(HbaseConfigUtils.KEY_ZOOKEEPER_SASL_CLIENT, zookeeperSaslClient);
 360         }
 361 
 362         if (!StringUtils.isEmpty(securityKrb5Conf)) {
 363             String krb5ConfPath = System.getProperty(&quot;user.dir&quot;) + File.separator + securityKrb5Conf;
 364             LOG.info(&quot;krb5ConfPath:{}&quot;, krb5ConfPath);
 365             System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_KRB5_CONF, krb5ConfPath);
 366         }
 367     }
 368 
 369     @Override
 370     public String toString() {
 371         return &quot;HbaseOutputFormat kerberos{&quot; +
 372                 &quot;kerberosAuthEnable=&quot; + kerberosAuthEnable +
 373                 &quot;, regionserverKeytabFile=&#x27;&quot; + regionserverKeytabFile + &#x27;\&#x27;&#x27; +
 374                 &quot;, regionserverPrincipal=&#x27;&quot; + regionserverPrincipal + &#x27;\&#x27;&#x27; +
 375                 &quot;, securityKrb5Conf=&#x27;&quot; + securityKrb5Conf + &#x27;\&#x27;&#x27; +
 376                 &quot;, zookeeperSaslClient=&#x27;&quot; + zookeeperSaslClient + &#x27;\&#x27;&#x27; +
 377                 &quot;, clientPrincipal=&#x27;&quot; + clientPrincipal + &#x27;\&#x27;&#x27; +
 378                 &quot;, clientKeytabFile=&#x27;&quot; + clientKeytabFile + &#x27;\&#x27;&#x27; +
 379                 &#x27;}&#x27;;
 380     }
 381 
 382 }
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * Licensed to the Apache Software Foundation (ASF) under one
   3  * or more contributor license agreements.  See the NOTICE file
   4  * distributed with this work for additional information
   5  * regarding copyright ownership.  The ASF licenses this file
   6  * to you under the Apache License, Version 2.0 (the
   7  * &quot;License&quot;); you may not use this file except in compliance
   8  * with the License.  You may obtain a copy of the License at
   9  *
  10  *     http://www.apache.org/licenses/LICENSE-2.0
  11  *
  12  * Unless required by applicable law or agreed to in writing, software
  13  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15  * See the License for the specific language governing permissions and
  16  * limitations under the License.
  17  */
  18 package com.dtstack.flink.sql.sink.hbase;
  19 
  20 import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
  21 import com.google.common.collect.Maps;
  22 import java.io.File;
  23 import java.io.IOException;
  24 import java.security.PrivilegedAction;
  25 import java.util.List;
  26 import java.util.Map;
  27 import java.util.Set;
  28 import org.apache.commons.lang3.StringUtils;
  29 import org.apache.flink.api.java.tuple.Tuple2;
  30 import org.apache.flink.configuration.Configuration;
  31 import org.apache.flink.types.Row;
  32 import org.apache.flink.util.Preconditions;
  33 import org.apache.hadoop.hbase.*;
  34 import org.apache.hadoop.hbase.client.Connection;
  35 import org.apache.hadoop.hbase.client.ConnectionFactory;
  36 import org.apache.hadoop.hbase.client.Put;
  37 import org.apache.hadoop.hbase.client.Table;
  38 import org.apache.hadoop.security.UserGroupInformation;
  39 import org.slf4j.Logger;
  40 import org.slf4j.LoggerFactory;
  41 
  42 
  43 /**
  44  * @author: jingzhen@dtstack.com
  45  * date: 2017-6-29
  46  */
  47 public class HbaseOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&gt; {
  48 
  49     private static final Logger LOG = LoggerFactory.getLogger(HbaseOutputFormat.class);
  50 
  51     private String host;
  52     private String zkParent;
  53     private String rowkey;
  54     private String tableName;
  55     private String[] columnNames;
  56     private String updateMode;
  57     private String[] columnTypes;
  58     private Map&lt;String, String&gt; columnNameFamily;
  59 
  60     private boolean kerberosAuthEnable;
  61     private String regionserverKeytabFile;
  62     private String regionserverPrincipal;
  63     private String securityKrb5Conf;
  64     private String zookeeperSaslClient;
  65     private String clientPrincipal;
  66     private String clientKeytabFile;
  67 
  68     private String[] families;
  69     private String[] qualifiers;
  70 
  71     private transient org.apache.hadoop.conf.Configuration conf;
  72     private transient Connection conn;
  73     private transient Table table;
  74 
  75     private transient ChoreService choreService;
  76 
  77     @Override
  78     public void configure(Configuration parameters) {
  79         LOG.warn(&quot;---configure---&quot;);
  80         conf = HBaseConfiguration.create();
  81     }
  82 
  83     @Override
  84     public void open(int taskNumber, int numTasks) throws IOException {
  85         LOG.warn(&quot;---open---&quot;);
  86         openConn();
  87         table = conn.getTable(TableName.valueOf(tableName));
  88         LOG.warn(&quot;---open end(get table from hbase) ---&quot;);
  89         initMetric();
  90     }
  91 
  92     private void openConn(){
  93         try{
  94             if (kerberosAuthEnable) {
  95                 LOG.info(&quot;open kerberos conn&quot;);
  96                 openKerberosConn();
  97             } else {
  98                 LOG.info(&quot;open conn&quot;);
  99                 conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 100                 conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 101                 conn = ConnectionFactory.createConnection(conf);
 102             }
 103         }catch (Exception e){
 104             throw new RuntimeException(e);
 105         }
 106 
 107     }
 108     private void openKerberosConn() throws IOException {
 109         conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);
 110         conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);
 111 
 112         LOG.info(&quot;kerberos config:{}&quot;, this.toString());
 113         Preconditions.checkArgument(!StringUtils.isEmpty(clientPrincipal), &quot; clientPrincipal not null!&quot;);
<abbr title=" 114         Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;);"> 114         Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;ðŸ”µ</abbr>
 115 
 116         fillSyncKerberosConfig(conf, regionserverPrincipal, zookeeperSaslClient, securityKrb5Conf);
 117 
 118         clientKeytabFile = System.getProperty(&quot;user.dir&quot;) + File.separator + clientKeytabFile;
<abbr title=" 119         clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal;"> 119         clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipalðŸ”µ</abbr>
 120 
 121         conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KEYTAB_FILE, clientKeytabFile);
 122         conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KERBEROS_PRINCIPAL, clientPrincipal);
 123 
<abbr title=" 124         UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clientKeytabFile);"> 124         UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrinciðŸ”µ</abbr>
 125         org.apache.hadoop.conf.Configuration finalConf = conf;
 126         conn = userGroupInformation.doAs(new PrivilegedAction&lt;Connection&gt;() {
 127             @Override
 128             public Connection run() {
 129                 try {
 130                     ScheduledChore authChore = AuthUtil.getAuthChore(finalConf);
 131                     if (authChore != null) {
 132                         choreService = new ChoreService(&quot;hbaseKerberosSink&quot;);
 133                         choreService.scheduleChore(authChore);
 134                     }
 135 
 136                     return ConnectionFactory.createConnection(finalConf);
 137                 } catch (IOException e) {
 138                     LOG.error(&quot;Get connection fail with config:{}&quot;, finalConf);
 139                     throw new RuntimeException(e);
 140                 }
 141             }
 142         });
 143     }
 144 
 145 
 146 
 147     @Override
 148     public void writeRecord(Tuple2 tuple2) {
 149         Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;
 150         Row row = tupleTrans.f1;
 151         dealInsert(row);
 152     }
 153 
 154     protected void dealInsert(Row record) {
 155         Put put = getPutByRow(record);
 156         if (put == null || put.isEmpty()) {
 157             outDirtyRecords.inc();
 158             return;
 159         }
 160 
 161         try {
 162             table.put(put);
 163         } catch (Exception e) {
 164             if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {
 165                 LOG.error(&quot;record insert failed ..{}&quot;, record.toString());
 166                 LOG.error(&quot;&quot;, e);
 167             }
 168             outDirtyRecords.inc();
 169         }
 170 
 171         if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 172             LOG.info(record.toString());
 173         }
 174         outRecords.inc();
 175     }
 176 
 177     private Put getPutByRow(Row record) {
 178         String rowKey = buildRowKey(record);
 179         if (StringUtils.isEmpty(rowKey)) {
 180             return null;
 181         }
 182         Put put = new Put(rowKey.getBytes());
 183         for (int i = 0; i &lt; record.getArity(); ++i) {
 184             Object fieldVal = record.getField(i);
 185             if (fieldVal == null) {
 186                 continue;
 187             }
 188             byte[] val = HbaseUtil.toByte(fieldVal);
 189             byte[] cf = families[i].getBytes();
 190             byte[] qualifier = qualifiers[i].getBytes();
 191 
 192             put.addColumn(cf, qualifier, val);
 193         }
 194         return put;
 195     }
 196 
 197     private String buildRowKey(Row record) {
 198         String rowKeyValues = getRowKeyValues(record);
 199         // all rowkey not null
 200         if (StringUtils.isBlank(rowKeyValues)) {
 201             LOG.error(&quot;row key value must not null,record is ..{}&quot;, record);
 202             outDirtyRecords.inc();
 203             return &quot;&quot;;
 204         }
 205         return rowKeyValues;
 206     }
 207 
 208     private String getRowKeyValues(Row record) {
 209         Map&lt;String, Object&gt; row = rowConvertMap(record);
 210         RowKeyBuilder rowKeyBuilder = new RowKeyBuilder();
 211         rowKeyBuilder.init(rowkey);
 212         return rowKeyBuilder.getRowKey(row);
 213     }
 214 
 215     private Map&lt;String, Object&gt; rowConvertMap(Row record){
 216         Map&lt;String, Object&gt; rowValue = Maps.newHashMap();
 217         for(int i = 0; i &lt; columnNames.length; i++){
 218             rowValue.put(columnNames[i], record.getField(i));
 219         }
 220         return rowValue;
 221     }
 222 
 223     @Override
 224     public void close() throws IOException {
 225         if (conn != null) {
 226             conn.close();
 227             conn = null;
 228         }
 229     }
 230     private HbaseOutputFormat() {
 231     }
 232 
 233     public static HbaseOutputFormatBuilder buildHbaseOutputFormat() {
 234         return new HbaseOutputFormatBuilder();
 235     }
 236 
 237     public static class HbaseOutputFormatBuilder {
 238 
 239         private HbaseOutputFormat format;
 240 
 241         private HbaseOutputFormatBuilder() {
 242             format = new HbaseOutputFormat();
 243         }
 244 
 245         public HbaseOutputFormatBuilder setHost(String host) {
 246             format.host = host;
 247             return this;
 248         }
 249 
 250         public HbaseOutputFormatBuilder setZkParent(String parent) {
 251             format.zkParent = parent;
 252             return this;
 253         }
 254 
 255 
 256         public HbaseOutputFormatBuilder setTable(String tableName) {
 257             format.tableName = tableName;
 258             return this;
 259         }
 260 
 261         public HbaseOutputFormatBuilder setRowkey(String rowkey) {
 262             format.rowkey = rowkey;
 263             return this;
 264         }
 265 
 266         public HbaseOutputFormatBuilder setColumnNames(String[] columnNames) {
 267             format.columnNames = columnNames;
 268             return this;
 269         }
 270 
 271         public HbaseOutputFormatBuilder setColumnTypes(String[] columnTypes) {
 272             format.columnTypes = columnTypes;
 273             return this;
 274         }
 275 
 276         public HbaseOutputFormatBuilder setColumnNameFamily(Map&lt;String, String&gt; columnNameFamily) {
 277             format.columnNameFamily = columnNameFamily;
 278             return this;
 279         }
 280 
 281         public HbaseOutputFormatBuilder setKerberosAuthEnable(boolean kerberosAuthEnable) {
 282             format.kerberosAuthEnable = kerberosAuthEnable;
 283             return this;
 284         }
 285 
 286         public HbaseOutputFormatBuilder setRegionserverKeytabFile(String regionserverKeytabFile) {
 287             format.regionserverKeytabFile = regionserverKeytabFile;
 288             return this;
 289         }
 290 
 291         public HbaseOutputFormatBuilder setRegionserverPrincipal(String regionserverPrincipal) {
 292             format.regionserverPrincipal = regionserverPrincipal;
 293             return this;
 294         }
 295 
 296         public HbaseOutputFormatBuilder setSecurityKrb5Conf(String securityKrb5Conf) {
 297             format.securityKrb5Conf = securityKrb5Conf;
 298             return this;
 299         }
 300 
 301         public HbaseOutputFormatBuilder setZookeeperSaslClient(String zookeeperSaslClient) {
 302             format.zookeeperSaslClient = zookeeperSaslClient;
 303             return this;
 304         }
 305 
 306         public HbaseOutputFormatBuilder setClientPrincipal(String clientPrincipal) {
 307             format.clientPrincipal = clientPrincipal;
 308             return this;
 309         }
 310 
 311         public HbaseOutputFormatBuilder setClientKeytabFile(String clientKeytabFile) {
 312             format.clientKeytabFile = clientKeytabFile;
 313             return this;
 314         }
 315 
 316 
 317         public HbaseOutputFormat finish() {
 318             Preconditions.checkNotNull(format.host, &quot;zookeeperQuorum should be specified&quot;);
 319             Preconditions.checkNotNull(format.tableName, &quot;tableName should be specified&quot;);
 320             Preconditions.checkNotNull(format.columnNames, &quot;columnNames should be specified&quot;);
<abbr title=" 321             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be zero&quot;);"> 321             Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not beðŸ”µ</abbr>
 322 
 323             String[] families = new String[format.columnNames.length];
 324             String[] qualifiers = new String[format.columnNames.length];
 325 
 326             if (format.columnNameFamily != null) {
 327                 Set&lt;String&gt; keySet = format.columnNameFamily.keySet();
 328                 String[] columns = keySet.toArray(new String[keySet.size()]);
 329                 for (int i = 0; i &lt; columns.length; ++i) {
 330                     String col = columns[i];
 331                     String[] part = col.split(&quot;:&quot;);
 332                     families[i] = part[0];
 333                     qualifiers[i] = part[1];
 334                 }
 335             }
 336             format.families = families;
 337             format.qualifiers = qualifiers;
 338 
 339             return format;
 340         }
 341 
 342     }
 343 
<abbr title=" 344     private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config, String regionserverPrincipal,"> 344     private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config, String regionserverPðŸ”µ</abbr>
<abbr title=" 345                                         String zookeeperSaslClient, String securityKrb5Conf) throws IOException {"> 345                                         String zookeeperSaslClient, String securityKrb5Conf) throws IOExcðŸ”µ</abbr>
 346         if (StringUtils.isEmpty(regionserverPrincipal)) {
<abbr title=" 347             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos&quot;);"> 347             throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication isðŸ”µ</abbr>
 348         }
 349         config.set(HbaseConfigUtils.KEY_HBASE_MASTER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 350         config.set(HbaseConfigUtils.KEY_HBASE_REGIONSERVER_KERBEROS_PRINCIPAL, regionserverPrincipal);
 351         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHORIZATION, &quot;true&quot;);
 352         config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHENTICATION, &quot;kerberos&quot;);
 353 
 354 
 355         if (!StringUtils.isEmpty(zookeeperSaslClient)) {
 356             System.setProperty(HbaseConfigUtils.KEY_ZOOKEEPER_SASL_CLIENT, zookeeperSaslClient);
 357         }
 358 
 359         if (!StringUtils.isEmpty(securityKrb5Conf)) {
 360             String krb5ConfPath = System.getProperty(&quot;user.dir&quot;) + File.separator + securityKrb5Conf;
 361             LOG.info(&quot;krb5ConfPath:{}&quot;, krb5ConfPath);
 362             System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_KRB5_CONF, krb5ConfPath);
 363         }
 364     }
 365 
 366     @Override
 367     public String toString() {
 368         return &quot;HbaseOutputFormat kerberos{&quot; +
 369                 &quot;kerberosAuthEnable=&quot; + kerberosAuthEnable +
 370                 &quot;, regionserverKeytabFile=&#x27;&quot; + regionserverKeytabFile + &#x27;\&#x27;&#x27; +
 371                 &quot;, regionserverPrincipal=&#x27;&quot; + regionserverPrincipal + &#x27;\&#x27;&#x27; +
 372                 &quot;, securityKrb5Conf=&#x27;&quot; + securityKrb5Conf + &#x27;\&#x27;&#x27; +
 373                 &quot;, zookeeperSaslClient=&#x27;&quot; + zookeeperSaslClient + &#x27;\&#x27;&#x27; +
 374                 &quot;, clientPrincipal=&#x27;&quot; + clientPrincipal + &#x27;\&#x27;&#x27; +
 375                 &quot;, clientKeytabFile=&#x27;&quot; + clientKeytabFile + &#x27;\&#x27;&#x27; +
 376                 &#x27;}&#x27;;
 377     }
 378 
 379 }
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.sink.hbase;
  22  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.enums.EUpdateMode;</span>
  24  import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
  25  import com.google.common.collect.Maps;
  26  import org.apache.commons.lang3.StringUtils;
  27  import org.apache.flink.api.java.tuple.Tuple2;
  28  import org.apache.flink.configuration.Configuration;
  29  import org.apache.flink.types.Row;
  30  import org.apache.flink.util.Preconditions;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import org.apache.hadoop.hbase.HBaseConfiguration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import org.apache.hadoop.hbase.TableName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.apache.hadoop.hbase.*;</span>
  34  import org.apache.hadoop.hbase.client.Connection;
  35  import org.apache.hadoop.hbase.client.ConnectionFactory;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import org.apache.hadoop.hbase.client.Delete;</span>
  37  import org.apache.hadoop.hbase.client.Put;
  38  import org.apache.hadoop.hbase.client.Table;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import org.apache.hadoop.hbase.util.Bytes;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import org.apache.hadoop.security.UserGroupInformation;</span>
  41  import org.slf4j.Logger;
  42  import org.slf4j.LoggerFactory;
  43  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +import java.io.File;</span>
  45  import java.io.IOException;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import java.security.PrivilegedAction;</span>

  47  import java.util.Map;
  48  import java.util.Set;
  49  
  50  /**
  51   * @author: jingzhen@dtstack.com
  52   * date: 2017-6-29
  53   */
  54  public class HbaseOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&gt; {
  55  
  56      private static final Logger LOG = LoggerFactory.getLogger(HbaseOutputFormat.class);
  57  
  58      private String host;
  59      private String zkParent;
  60      private String rowkey;
  61      private String tableName;
  62      private String[] columnNames;
  63      private String updateMode;
  64      private String[] columnTypes;
  65      private Map&lt;String, String&gt; columnNameFamily;
  66  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  67 +    private boolean kerberosAuthEnable;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +    private String regionserverKeytabFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    private String regionserverPrincipal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +    private String securityKrb5Conf;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +    private String zookeeperSaslClient;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +    private String clientPrincipal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +    private String clientKeytabFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +</span>
  75      private String[] families;
  76      private String[] qualifiers;
  77  
  78      private transient org.apache.hadoop.conf.Configuration conf;
  79      private transient Connection conn;
  80      private transient Table table;


  81  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +    private transient ChoreService choreService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +</span>
  84      @Override
  85      public void configure(Configuration parameters) {
  86          LOG.warn(&quot;---configure---&quot;);
  87          conf = HBaseConfiguration.create();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        conf.set(&quot;hbase.zookeeper.quorum&quot;, host);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -        if (zkParent != null &amp;&amp; !&quot;&quot;.equals(zkParent)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -            conf.set(&quot;zookeeper.znode.parent&quot;, zkParent);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        LOG.warn(&quot;---configure end ---&quot;);</span>
  93      }
  94  
  95      @Override
  96      public void open(int taskNumber, int numTasks) throws IOException {
  97          LOG.warn(&quot;---open---&quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -        conn = ConnectionFactory.createConnection(conf);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +        openConn();</span>
 100          table = conn.getTable(TableName.valueOf(tableName));
 101          LOG.warn(&quot;---open end(get table from hbase) ---&quot;);
 102          initMetric();
 103      }























































 104  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +    private void openConn(){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +        try{</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +            if (kerberosAuthEnable) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +                LOG.info(&quot;open kerberos conn&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +                openKerberosConn();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +                LOG.info(&quot;open conn&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +                conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +                conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +                conn = ConnectionFactory.createConnection(conf);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +        }catch (Exception e){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +            throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +    private void openKerberosConn() throws IOException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +        conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +        conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +        LOG.info(&quot;kerberos config:{}&quot;, this.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        Preconditions.checkArgument(!StringUtils.isEmpty(clientPrincipal), &quot; clientPrincipal not null!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +        Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +        fillSyncKerberosConfig(conf, regionserverPrincipal, zookeeperSaslClient, securityKrb5Conf);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +        clientKeytabFile = System.getProperty(&quot;user.dir&quot;) + File.separator + clientKeytabFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +        clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +        conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KEYTAB_FILE, clientKeytabFile);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +        conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KERBEROS_PRINCIPAL, clientPrincipal);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 137 +        UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clientKeytabFile);"> 137 +        UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clieðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 138 +        org.apache.hadoop.conf.Configuration finalConf = conf;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +        conn = userGroupInformation.doAs(new PrivilegedAction&lt;Connection&gt;() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +            public Connection run() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +                try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +                    ScheduledChore authChore = AuthUtil.getAuthChore(finalConf);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +                    if (authChore != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                        choreService = new ChoreService(&quot;hbaseKerberosSink&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +                        choreService.scheduleChore(authChore);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +                    return ConnectionFactory.createConnection(finalConf);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +                } catch (IOException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +                    LOG.error(&quot;Get connection fail with config:{}&quot;, finalConf);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                    throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +</span>
 160      @Override
 161      public void writeRecord(Tuple2 tuple2) {
 162          Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -        Boolean retract = tupleTrans.f0;</span>
 164          Row row = tupleTrans.f1;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -        if (retract) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -            dealInsert(row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -        } else if (!retract &amp;&amp; StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -            dealDelete(row);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 170 +        dealInsert(row);</span>
 171      }
 172  
 173      protected void dealInsert(Row record) {
 174          Put put = getPutByRow(record);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -        if (put == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +        if (put == null || put.isEmpty()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +            outDirtyRecords.inc();</span>
 178              return;
 179          }
 180  
 181          try {
 182              table.put(put);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -        } catch (IOException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +        } catch (Exception e) {</span>
 185              if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {
 186                  LOG.error(&quot;record insert failed ..{}&quot;, record.toString());
 187                  LOG.error(&quot;&quot;, e);
 188              }
 189              outDirtyRecords.inc();
 190          }
 191  
 192          if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 193              LOG.info(record.toString());
 194          }
 195          outRecords.inc();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 197 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 198 -    protected void dealDelete(Row record) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 199 -        String rowKey = buildRowKey(record);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 200 -        if (!StringUtils.isEmpty(rowKey)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -            Delete delete = new Delete(Bytes.toBytes(rowKey));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -            try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -                table.delete(delete);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -            } catch (IOException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 205 -                if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 206 -                    LOG.error(&quot;record insert failed ..{}&quot;, record.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 207 -                    LOG.error(&quot;&quot;, e);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 208 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 209 -                outDirtyRecords.inc();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 210 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 211 -            if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -                LOG.info(record.toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 214 -            outRecords.inc();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -        }</span>
 216      }
 217  
 218      private Put getPutByRow(Row record) {
 219          String rowKey = buildRowKey(record);
 220          if (StringUtils.isEmpty(rowKey)) {
 221              return null;
 222          }
 223          Put put = new Put(rowKey.getBytes());
 224          for (int i = 0; i &lt; record.getArity(); ++i) {
 225              Object fieldVal = record.getField(i);
 226              if (fieldVal == null) {
 227                  continue;
 228              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 229 -            byte[] val = fieldVal.toString().getBytes();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 230 +            byte[] val = HbaseUtil.toByte(fieldVal);</span>
 231              byte[] cf = families[i].getBytes();
 232              byte[] qualifier = qualifiers[i].getBytes();
 233  
 234              put.addColumn(cf, qualifier, val);
 235          }
 236          return put;
 237      }
 238  
 239      private String buildRowKey(Row record) {
 240          String rowKeyValues = getRowKeyValues(record);
 241          // all rowkey not null
 242          if (StringUtils.isBlank(rowKeyValues)) {
 243              LOG.error(&quot;row key value must not null,record is ..{}&quot;, record);
 244              outDirtyRecords.inc();
 245              return &quot;&quot;;
 246          }
 247          return rowKeyValues;
 248      }
 249  
 250      private String getRowKeyValues(Row record) {
 251          Map&lt;String, Object&gt; row = rowConvertMap(record);
 252          RowKeyBuilder rowKeyBuilder = new RowKeyBuilder();
 253          rowKeyBuilder.init(rowkey);
 254          return rowKeyBuilder.getRowKey(row);
 255      }
 256  
 257      private Map&lt;String, Object&gt; rowConvertMap(Row record){
 258          Map&lt;String, Object&gt; rowValue = Maps.newHashMap();
 259          for(int i = 0; i &lt; columnNames.length; i++){
 260              rowValue.put(columnNames[i], record.getField(i));
 261          }
 262          return rowValue;
 263      }
 264  
 265      @Override
 266      public void close() throws IOException {
 267          if (conn != null) {
 268              conn.close();
 269              conn = null;
 270          }
 271      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 272 -</span>
 273      private HbaseOutputFormat() {
 274      }
 275  
 276      public static HbaseOutputFormatBuilder buildHbaseOutputFormat() {
 277          return new HbaseOutputFormatBuilder();
 278      }
 279  
 280      public static class HbaseOutputFormatBuilder {
 281  
 282          private HbaseOutputFormat format;
 283  
 284          private HbaseOutputFormatBuilder() {
 285              format = new HbaseOutputFormat();
 286          }
 287  
 288          public HbaseOutputFormatBuilder setHost(String host) {
 289              format.host = host;
 290              return this;
 291          }
 292  
 293          public HbaseOutputFormatBuilder setZkParent(String parent) {
 294              format.zkParent = parent;
 295              return this;
 296          }
 297  
 298  
 299          public HbaseOutputFormatBuilder setTable(String tableName) {
 300              format.tableName = tableName;
 301              return this;
 302          }
 303  
 304          public HbaseOutputFormatBuilder setRowkey(String rowkey) {
 305              format.rowkey = rowkey;
 306              return this;
 307          }
 308  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -        public HbaseOutputFormatBuilder setUpdateMode(String updateMode) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -            format.updateMode = updateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 313 -</span>
 314          public HbaseOutputFormatBuilder setColumnNames(String[] columnNames) {
 315              format.columnNames = columnNames;
 316              return this;
 317          }
 318  
 319          public HbaseOutputFormatBuilder setColumnTypes(String[] columnTypes) {
 320              format.columnTypes = columnTypes;
 321              return this;
 322          }
 323  
 324          public HbaseOutputFormatBuilder setColumnNameFamily(Map&lt;String, String&gt; columnNameFamily) {
 325              format.columnNameFamily = columnNameFamily;
 326              return this;
 327          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +        public HbaseOutputFormatBuilder setKerberosAuthEnable(boolean kerberosAuthEnable) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +            format.kerberosAuthEnable = kerberosAuthEnable;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +        public HbaseOutputFormatBuilder setRegionserverKeytabFile(String regionserverKeytabFile) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +            format.regionserverKeytabFile = regionserverKeytabFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +        public HbaseOutputFormatBuilder setRegionserverPrincipal(String regionserverPrincipal) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +            format.regionserverPrincipal = regionserverPrincipal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +        public HbaseOutputFormatBuilder setSecurityKrb5Conf(String securityKrb5Conf) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +            format.securityKrb5Conf = securityKrb5Conf;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +        public HbaseOutputFormatBuilder setZookeeperSaslClient(String zookeeperSaslClient) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +            format.zookeeperSaslClient = zookeeperSaslClient;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +        public HbaseOutputFormatBuilder setClientPrincipal(String clientPrincipal) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +            format.clientPrincipal = clientPrincipal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +        public HbaseOutputFormatBuilder setClientKeytabFile(String clientKeytabFile) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +            format.clientKeytabFile = clientKeytabFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +</span>
 364  
 365          public HbaseOutputFormat finish() {
 366              Preconditions.checkNotNull(format.host, &quot;zookeeperQuorum should be specified&quot;);
 367              Preconditions.checkNotNull(format.tableName, &quot;tableName should be specified&quot;);
 368              Preconditions.checkNotNull(format.columnNames, &quot;columnNames should be specified&quot;);
 369              Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be zero&quot;);
 370  
 371              String[] families = new String[format.columnNames.length];
 372              String[] qualifiers = new String[format.columnNames.length];
 373  
 374              if (format.columnNameFamily != null) {
 375                  Set&lt;String&gt; keySet = format.columnNameFamily.keySet();
 376                  String[] columns = keySet.toArray(new String[keySet.size()]);
 377                  for (int i = 0; i &lt; columns.length; ++i) {
 378                      String col = columns[i];
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 379 -                    String[] part = StringUtils.split(col, &quot;:&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +                    String[] part = col.split(&quot;:&quot;);</span>
 381                      families[i] = part[0];
 382                      qualifiers[i] = part[1];
 383                  }
 384              }
 385              format.families = families;
 386              format.qualifiers = qualifiers;
 387  
 388              return format;
 389          }
 390  
 391      }
 392  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +    private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config, String regionserverPrincipal,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +                                        String zookeeperSaslClient, String securityKrb5Conf) throws IOException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +        if (StringUtils.isEmpty(regionserverPrincipal)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 396 +            throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos&quot;);"> 396 +            throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is KerberosðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 398 +        config.set(HbaseConfigUtils.KEY_HBASE_MASTER_KERBEROS_PRINCIPAL, regionserverPrincipal);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 399 +        config.set(HbaseConfigUtils.KEY_HBASE_REGIONSERVER_KERBEROS_PRINCIPAL, regionserverPrincipal);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +        config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHORIZATION, &quot;true&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +        config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHENTICATION, &quot;kerberos&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 404 +        if (!StringUtils.isEmpty(zookeeperSaslClient)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +            System.setProperty(HbaseConfigUtils.KEY_ZOOKEEPER_SASL_CLIENT, zookeeperSaslClient);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 407 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 408 +        if (!StringUtils.isEmpty(securityKrb5Conf)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +            String krb5ConfPath = System.getProperty(&quot;user.dir&quot;) + File.separator + securityKrb5Conf;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 410 +            LOG.info(&quot;krb5ConfPath:{}&quot;, krb5ConfPath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +            System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_KRB5_CONF, krb5ConfPath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 414 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 415 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 416 +    public String toString() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +        return &quot;HbaseOutputFormat kerberos{&quot; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +                &quot;kerberosAuthEnable=&quot; + kerberosAuthEnable +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +                &quot;, regionserverKeytabFile=&#x27;&quot; + regionserverKeytabFile + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 420 +                &quot;, regionserverPrincipal=&#x27;&quot; + regionserverPrincipal + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 421 +                &quot;, securityKrb5Conf=&#x27;&quot; + securityKrb5Conf + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +                &quot;, zookeeperSaslClient=&#x27;&quot; + zookeeperSaslClient + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +                &quot;, clientPrincipal=&#x27;&quot; + clientPrincipal + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 424 +                &quot;, clientKeytabFile=&#x27;&quot; + clientKeytabFile + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 425 +                &#x27;}&#x27;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 426 +    }</span>
 427  
 428  }</pre></td>
                            <td><pre>   1  /*
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
   9   *
  10   *     http://www.apache.org/licenses/LICENSE-2.0
  11   *
  12   * Unless required by applicable law or agreed to in writing, software
  13   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  14   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  15   * See the License for the specific language governing permissions and
  16   * limitations under the License.
  17   */
  18  
  19  
  20  
  21  package com.dtstack.flink.sql.sink.hbase;
  22  
  23  import com.dtstack.flink.sql.enums.EUpdateMode;
  24  import com.dtstack.flink.sql.outputformat.AbstractDtRichOutputFormat;
  25  import com.google.common.collect.Maps;
  26  import org.apache.commons.lang3.StringUtils;
  27  import org.apache.flink.api.java.tuple.Tuple2;
  28  import org.apache.flink.configuration.Configuration;
  29  import org.apache.flink.types.Row;
  30  import org.apache.flink.util.Preconditions;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import org.apache.hadoop.hbase.HBaseConfiguration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import org.apache.hadoop.hbase.TableName;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.apache.hadoop.hbase.*;</span>
  34  import org.apache.hadoop.hbase.client.Connection;
  35  import org.apache.hadoop.hbase.client.ConnectionFactory;
  36  import org.apache.hadoop.hbase.client.Delete;
  37  import org.apache.hadoop.hbase.client.Put;
  38  import org.apache.hadoop.hbase.client.Table;
  39  import org.apache.hadoop.hbase.util.Bytes;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import org.apache.hadoop.security.UserGroupInformation;</span>
  41  import org.slf4j.Logger;
  42  import org.slf4j.LoggerFactory;
  43  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  44 +import java.io.File;</span>
  45  import java.io.IOException;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import java.security.PrivilegedAction;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import java.util.List;</span>
  48  import java.util.Map;
  49  import java.util.Set;
  50  
  51  /**
  52   * @author: jingzhen@dtstack.com
  53   * date: 2017-6-29
  54   */
  55  public class HbaseOutputFormat extends AbstractDtRichOutputFormat&lt;Tuple2&gt; {
  56  
  57      private static final Logger LOG = LoggerFactory.getLogger(HbaseOutputFormat.class);
  58  
  59      private String host;
  60      private String zkParent;
  61      private String rowkey;
  62      private String tableName;
  63      private String[] columnNames;
  64      private String updateMode;
  65      private String[] columnTypes;
  66      private Map&lt;String, String&gt; columnNameFamily;
  67  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  68 +    private boolean kerberosAuthEnable;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  69 +    private String regionserverKeytabFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  70 +    private String regionserverPrincipal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  71 +    private String securityKrb5Conf;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  72 +    private String zookeeperSaslClient;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  73 +    private String clientPrincipal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +    private String clientKeytabFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +</span>
  76      private String[] families;
  77      private String[] qualifiers;
  78  
  79      private transient org.apache.hadoop.conf.Configuration conf;
  80      private transient Connection conn;
  81      private transient Table table;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  82 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  83 +    private transient ChoreService choreService;</span>
  84  


  85      @Override
  86      public void configure(Configuration parameters) {
  87          LOG.warn(&quot;---configure---&quot;);
  88          conf = HBaseConfiguration.create();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -        conf.set(&quot;hbase.zookeeper.quorum&quot;, host);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -        if (zkParent != null &amp;&amp; !&quot;&quot;.equals(zkParent)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -            conf.set(&quot;zookeeper.znode.parent&quot;, zkParent);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -        LOG.warn(&quot;---configure end ---&quot;);</span>
  94      }
  95  
  96      @Override
  97      public void open(int taskNumber, int numTasks) throws IOException {
  98          LOG.warn(&quot;---open---&quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        conn = ConnectionFactory.createConnection(conf);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +        openConn();</span>
 101          table = conn.getTable(TableName.valueOf(tableName));
 102          LOG.warn(&quot;---open end(get table from hbase) ---&quot;);
 103          initMetric();
 104      }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 105 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 106 +    private void openConn(){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 107 +        try{</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 108 +            if (kerberosAuthEnable) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 109 +                LOG.info(&quot;open kerberos conn&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 110 +                openKerberosConn();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 111 +            } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 112 +                LOG.info(&quot;open conn&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 +                conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 +                conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 +                conn = ConnectionFactory.createConnection(conf);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 116 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 117 +        }catch (Exception e){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 118 +            throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 120 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 121 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 122 +    private void openKerberosConn() throws IOException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 123 +        conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_QUORUM, host);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 124 +        conf.set(HbaseConfigUtils.KEY_HBASE_ZOOKEEPER_ZNODE_QUORUM, zkParent);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 125 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 126 +        LOG.info(&quot;kerberos config:{}&quot;, this.toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +        Preconditions.checkArgument(!StringUtils.isEmpty(clientPrincipal), &quot; clientPrincipal not null!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 128 +        Preconditions.checkArgument(!StringUtils.isEmpty(clientKeytabFile), &quot; clientKeytabFile not null!&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 129 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 130 +        fillSyncKerberosConfig(conf, regionserverPrincipal, zookeeperSaslClient, securityKrb5Conf);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 131 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 132 +        clientKeytabFile = System.getProperty(&quot;user.dir&quot;) + File.separator + clientKeytabFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +        clientPrincipal = !StringUtils.isEmpty(clientPrincipal) ? clientPrincipal : regionserverPrincipal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 134 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 135 +        conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KEYTAB_FILE, clientKeytabFile);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 136 +        conf.set(HbaseConfigUtils.KEY_HBASE_CLIENT_KERBEROS_PRINCIPAL, clientPrincipal);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 138 +        UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clientKeytabFile);"> 138 +        UserGroupInformation userGroupInformation = HbaseConfigUtils.loginAndReturnUGI(conf, clientPrincipal, clieðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 139 +        org.apache.hadoop.conf.Configuration finalConf = conf;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +        conn = userGroupInformation.doAs(new PrivilegedAction&lt;Connection&gt;() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +            @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 142 +            public Connection run() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +                try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +                    ScheduledChore authChore = AuthUtil.getAuthChore(finalConf);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                    if (authChore != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +                        choreService = new ChoreService(&quot;hbaseKerberosSink&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +                        choreService.scheduleChore(authChore);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +                    return ConnectionFactory.createConnection(finalConf);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +                } catch (IOException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +                    LOG.error(&quot;Get connection fail with config:{}&quot;, finalConf);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +                    throw new RuntimeException(e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 154 +                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 155 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +        });</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 157 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 158 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 159 +</span>
 160  























































 161      @Override
 162      public void writeRecord(Tuple2 tuple2) {
 163          Tuple2&lt;Boolean, Row&gt; tupleTrans = tuple2;
 164          Boolean retract = tupleTrans.f0;
 165          Row row = tupleTrans.f1;
 166          if (retract) {
 167              dealInsert(row);
 168          } else if (!retract &amp;&amp; StringUtils.equalsIgnoreCase(updateMode, EUpdateMode.UPSERT.name())) {
 169              dealDelete(row);
 170          }

 171      }
 172  
 173      protected void dealInsert(Row record) {
 174          Put put = getPutByRow(record);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -        if (put == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 176 +        if (put == null || put.isEmpty()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 177 +            outDirtyRecords.inc();</span>
 178              return;
 179          }
 180  
 181          try {
 182              table.put(put);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 183 -        } catch (IOException e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 184 +        } catch (Exception e) {</span>
 185              if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {
 186                  LOG.error(&quot;record insert failed ..{}&quot;, record.toString());
 187                  LOG.error(&quot;&quot;, e);
 188              }
 189              outDirtyRecords.inc();
 190          }
 191  
 192          if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 193              LOG.info(record.toString());
 194          }
 195          outRecords.inc();
 196      }
 197  
 198      protected void dealDelete(Row record) {
 199          String rowKey = buildRowKey(record);
 200          if (!StringUtils.isEmpty(rowKey)) {
 201              Delete delete = new Delete(Bytes.toBytes(rowKey));
 202              try {
 203                  table.delete(delete);
 204              } catch (IOException e) {
 205                  if (outDirtyRecords.getCount() % DIRTY_PRINT_FREQUENCY == 0 || LOG.isDebugEnabled()) {
 206                      LOG.error(&quot;record insert failed ..{}&quot;, record.toString());
 207                      LOG.error(&quot;&quot;, e);
 208                  }
 209                  outDirtyRecords.inc();
 210              }
 211              if (outRecords.getCount() % ROW_PRINT_FREQUENCY == 0) {
 212                  LOG.info(record.toString());
 213              }
 214              outRecords.inc();
 215          }
 216      }
 217  
 218      private Put getPutByRow(Row record) {
 219          String rowKey = buildRowKey(record);
 220          if (StringUtils.isEmpty(rowKey)) {
 221              return null;
 222          }
 223          Put put = new Put(rowKey.getBytes());
 224          for (int i = 0; i &lt; record.getArity(); ++i) {
 225              Object fieldVal = record.getField(i);
 226              if (fieldVal == null) {
 227                  continue;
 228              }
 229              byte[] val = fieldVal.toString().getBytes();

 230              byte[] cf = families[i].getBytes();
 231              byte[] qualifier = qualifiers[i].getBytes();
 232  
 233              put.addColumn(cf, qualifier, val);
 234          }
 235          return put;
 236      }
 237  
 238      private String buildRowKey(Row record) {
 239          String rowKeyValues = getRowKeyValues(record);
 240          // all rowkey not null
 241          if (StringUtils.isBlank(rowKeyValues)) {
 242              LOG.error(&quot;row key value must not null,record is ..{}&quot;, record);
 243              outDirtyRecords.inc();
 244              return &quot;&quot;;
 245          }
 246          return rowKeyValues;
 247      }
 248  
 249      private String getRowKeyValues(Row record) {
 250          Map&lt;String, Object&gt; row = rowConvertMap(record);
 251          RowKeyBuilder rowKeyBuilder = new RowKeyBuilder();
 252          rowKeyBuilder.init(rowkey);
 253          return rowKeyBuilder.getRowKey(row);
 254      }
 255  
 256      private Map&lt;String, Object&gt; rowConvertMap(Row record){
 257          Map&lt;String, Object&gt; rowValue = Maps.newHashMap();
 258          for(int i = 0; i &lt; columnNames.length; i++){
 259              rowValue.put(columnNames[i], record.getField(i));
 260          }
 261          return rowValue;
 262      }
 263  
 264      @Override
 265      public void close() throws IOException {
 266          if (conn != null) {
 267              conn.close();
 268              conn = null;
 269          }
 270      }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 271 -</span>
 272      private HbaseOutputFormat() {
 273      }
 274  
 275      public static HbaseOutputFormatBuilder buildHbaseOutputFormat() {
 276          return new HbaseOutputFormatBuilder();
 277      }
 278  
 279      public static class HbaseOutputFormatBuilder {
 280  
 281          private HbaseOutputFormat format;
 282  
 283          private HbaseOutputFormatBuilder() {
 284              format = new HbaseOutputFormat();
 285          }
 286  
 287          public HbaseOutputFormatBuilder setHost(String host) {
 288              format.host = host;
 289              return this;
 290          }
 291  
 292          public HbaseOutputFormatBuilder setZkParent(String parent) {
 293              format.zkParent = parent;
 294              return this;
 295          }
 296  
 297  
 298          public HbaseOutputFormatBuilder setTable(String tableName) {
 299              format.tableName = tableName;
 300              return this;
 301          }
 302  
 303          public HbaseOutputFormatBuilder setRowkey(String rowkey) {
 304              format.rowkey = rowkey;
 305              return this;
 306          }
 307  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 308 -        public HbaseOutputFormatBuilder setUpdateMode(String updateMode) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 309 -            format.updateMode = updateMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 310 -            return this;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 311 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 312 -</span>
 313          public HbaseOutputFormatBuilder setColumnNames(String[] columnNames) {
 314              format.columnNames = columnNames;
 315              return this;
 316          }
 317  
 318          public HbaseOutputFormatBuilder setColumnTypes(String[] columnTypes) {
 319              format.columnTypes = columnTypes;
 320              return this;
 321          }
 322  
 323          public HbaseOutputFormatBuilder setColumnNameFamily(Map&lt;String, String&gt; columnNameFamily) {
 324              format.columnNameFamily = columnNameFamily;
 325              return this;
 326          }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 327 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 328 +        public HbaseOutputFormatBuilder setKerberosAuthEnable(boolean kerberosAuthEnable) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 329 +            format.kerberosAuthEnable = kerberosAuthEnable;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 330 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 331 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 332 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 333 +        public HbaseOutputFormatBuilder setRegionserverKeytabFile(String regionserverKeytabFile) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 334 +            format.regionserverKeytabFile = regionserverKeytabFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 335 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 336 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 337 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 338 +        public HbaseOutputFormatBuilder setRegionserverPrincipal(String regionserverPrincipal) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 339 +            format.regionserverPrincipal = regionserverPrincipal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 341 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 342 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 343 +        public HbaseOutputFormatBuilder setSecurityKrb5Conf(String securityKrb5Conf) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 344 +            format.securityKrb5Conf = securityKrb5Conf;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 345 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 346 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 347 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 348 +        public HbaseOutputFormatBuilder setZookeeperSaslClient(String zookeeperSaslClient) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 349 +            format.zookeeperSaslClient = zookeeperSaslClient;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 350 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 351 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 352 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 353 +        public HbaseOutputFormatBuilder setClientPrincipal(String clientPrincipal) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 354 +            format.clientPrincipal = clientPrincipal;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +        public HbaseOutputFormatBuilder setClientKeytabFile(String clientKeytabFile) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +            format.clientKeytabFile = clientKeytabFile;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +            return this;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +</span>
 363  
 364          public HbaseOutputFormat finish() {
 365              Preconditions.checkNotNull(format.host, &quot;zookeeperQuorum should be specified&quot;);
 366              Preconditions.checkNotNull(format.tableName, &quot;tableName should be specified&quot;);
 367              Preconditions.checkNotNull(format.columnNames, &quot;columnNames should be specified&quot;);
 368              Preconditions.checkArgument(format.columnNames.length != 0, &quot;columnNames length should not be zero&quot;);
 369  
 370              String[] families = new String[format.columnNames.length];
 371              String[] qualifiers = new String[format.columnNames.length];
 372  
 373              if (format.columnNameFamily != null) {
 374                  Set&lt;String&gt; keySet = format.columnNameFamily.keySet();
 375                  String[] columns = keySet.toArray(new String[keySet.size()]);
 376                  for (int i = 0; i &lt; columns.length; ++i) {
 377                      String col = columns[i];
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 378 -                    String[] part = StringUtils.split(col, &quot;:&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +                    String[] part = col.split(&quot;:&quot;);</span>
 380                      families[i] = part[0];
 381                      qualifiers[i] = part[1];
 382                  }
 383              }
 384              format.families = families;
 385              format.qualifiers = qualifiers;
 386  
 387              return format;
 388          }
 389  
 390      }
 391  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +    private void fillSyncKerberosConfig(org.apache.hadoop.conf.Configuration config, String regionserverPrincipal,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +                                        String zookeeperSaslClient, String securityKrb5Conf) throws IOException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +        if (StringUtils.isEmpty(regionserverPrincipal)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 395 +            throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is Kerberos&quot;);"> 395 +            throw new IllegalArgumentException(&quot;Must provide regionserverPrincipal when authentication is KerberosðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +        config.set(HbaseConfigUtils.KEY_HBASE_MASTER_KERBEROS_PRINCIPAL, regionserverPrincipal);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 398 +        config.set(HbaseConfigUtils.KEY_HBASE_REGIONSERVER_KERBEROS_PRINCIPAL, regionserverPrincipal);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 399 +        config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHORIZATION, &quot;true&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 400 +        config.set(HbaseConfigUtils.KEY_HBASE_SECURITY_AUTHENTICATION, &quot;kerberos&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 401 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 402 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 403 +        if (!StringUtils.isEmpty(zookeeperSaslClient)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 404 +            System.setProperty(HbaseConfigUtils.KEY_ZOOKEEPER_SASL_CLIENT, zookeeperSaslClient);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 405 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 407 +        if (!StringUtils.isEmpty(securityKrb5Conf)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 408 +            String krb5ConfPath = System.getProperty(&quot;user.dir&quot;) + File.separator + securityKrb5Conf;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 409 +            LOG.info(&quot;krb5ConfPath:{}&quot;, krb5ConfPath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 410 +            System.setProperty(HbaseConfigUtils.KEY_JAVA_SECURITY_KRB5_CONF, krb5ConfPath);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 411 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 412 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 413 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 414 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 415 +    public String toString() {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 416 +        return &quot;HbaseOutputFormat kerberos{&quot; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +                &quot;kerberosAuthEnable=&quot; + kerberosAuthEnable +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 418 +                &quot;, regionserverKeytabFile=&#x27;&quot; + regionserverKeytabFile + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 419 +                &quot;, regionserverPrincipal=&#x27;&quot; + regionserverPrincipal + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 420 +                &quot;, securityKrb5Conf=&#x27;&quot; + securityKrb5Conf + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 421 +                &quot;, zookeeperSaslClient=&#x27;&quot; + zookeeperSaslClient + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 422 +                &quot;, clientPrincipal=&#x27;&quot; + clientPrincipal + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 423 +                &quot;, clientKeytabFile=&#x27;&quot; + clientKeytabFile + &#x27;\&#x27;&#x27; +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 424 +                &#x27;}&#x27;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 425 +    }</span>
 426  
 427  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            