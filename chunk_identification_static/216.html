<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>216</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    216
                    <a href="215.html">prev</a>
                    <a href="217.html">next</a>
                    <a href="216_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_85784acfd63b348aa9271a84368432c2699a9d67_common/src/main/java/org/broadleafcommerce/common/util/UpdateExecutor.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;85784acfd63b348aa9271a84368432c2699a9d67:common/src/main/java/org/broadleafcommerce/common/util/UpdateExecutor.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;85784acfd63b348aa9271a84368432c2699a9d67^1:common/src/main/java/org/broadleafcommerce/common/util/UpdateExecutor.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;85784acfd63b348aa9271a84368432c2699a9d67^2:common/src/main/java/org/broadleafcommerce/common/util/UpdateExecutor.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;ce5c9279711e306f5901899835666ffa510d85bd:common/src/main/java/org/broadleafcommerce/common/util/UpdateExecutor.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.util;
  19 
  20 import org.apache.commons.lang.ArrayUtils;
  21 import org.apache.commons.lang3.StringUtils;
  22 import org.broadleafcommerce.common.util.dao.HibernateMappingProvider;
  23 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  24 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.hibernate.SQLQuery;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.hibernate.Session;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.hibernate.cache.spi.UpdateTimestampsCache;</span>
  28 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import org.hibernate.FlushMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.hibernate.SQLQuery;</span>
  32 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  33 import org.hibernate.Session;
  34 import org.hibernate.cache.spi.UpdateTimestampsCache;
  35 import org.hibernate.engine.spi.CacheImplementor;
  36 import org.hibernate.engine.spi.SharedSessionContractImplementor;
  37 import org.hibernate.mapping.PersistentClass;
  38 import org.hibernate.query.NativeQuery;
  39 import org.hibernate.type.LongType;
  40 import org.hibernate.type.Type;
  41 
  42 import java.io.Serializable;
  43 import java.util.ArrayList;
  44 import java.util.Arrays;
  45 import java.util.List;
  46 
  47 import javax.persistence.EntityManager;
  48 
  49 /**
<abbr title="  50  * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on Hibernate filtered">  50  * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updateðŸ”µ</abbr>
  51  * entities (such as sandboxable and multi-tenant entities).
  52  * &lt;/p&gt;
<abbr title="  53  * This class takes an interesting approach to the use of update queries. To explain, a bit of background is required.">  53  * This class takes an interesting approach to the use of update queries. To explain, a bit of backgroundðŸ”µ</abbr>
<abbr title="  54  * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs an HQL UPDATE">  54  * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it eðŸ”µ</abbr>
<abbr title="  55  * query. However, it will only create this temporary table when the target entity has Hibernate filters applied">  55  * query. However, it will only create this temporary table when the target entity has Hibernate filters ðŸ”µ</abbr>
<abbr title="  56  * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is used to">  56  * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectðŸ”µ</abbr>
<abbr title="  57  * populate the values. It is my understanding that this ends up creating some locks on the original table. Because of">  57  * populate the values. It is my understanding that this ends up creating some locks on the original tablðŸ”µ</abbr>
<abbr title="  58  * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to avoid">  58  * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to ðŸ”µ</abbr>
<abbr title="  59  * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) and then">  59  * the temporary table creation. We did this by first selecting for ids (so that the filters were still hðŸ”µ</abbr>
<abbr title="  60  * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needs to be basic">  60  * using a simple, native sql statement to execute the update on entities matching those ids. The native ðŸ”µ</abbr>
  61  * enough that itâ€™s portable across platforms.
  62  * &lt;/p&gt;
<abbr title="  63  * This class is responsible for building the native sql based on a template String. It does it in a way using a standard">  63  * This class is responsible for building the native sql based on a template String. It does it in a way ðŸ”µ</abbr>
<abbr title="  64  * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection exploit.">  64  * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection eðŸ”µ</abbr>
  65  * &lt;/p&gt;
<abbr title="  66  * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoid maximum">  66  * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoidðŸ”µ</abbr>
  67  * IN clause lengths enforced by some database platforms.
  68  *
  69  * @author Jeff Fischer
  70  */
  71 public class UpdateExecutor {
  72 
  73     /**
<abbr title="  74      * Perform an update query using a String template and params. Note, this is only intended for special">  74      * Perform an update query using a String template and params. Note, this is only intended for speciaðŸ”µ</abbr>
<abbr title="  75      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session">  75      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate SeðŸ”µ</abbr>
  76      * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
  77      * &lt;/p&gt;
<abbr title="  78      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;">  78      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEðŸ”µ</abbr>
  79      *
<abbr title="  80      * @deprecated Highly recommended not to use this method. This method results in global L2 cache region clearing. Use {@link #executeUpdateQuery(EntityManager, String, String, Object[], Type[], List)} instead.">  80      * @deprecated Highly recommended not to use this method. This method results in global L2 cache regiðŸ”µ</abbr>
  81      * @param em The entity manager to use for the persistence operation
<abbr title="  82      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.">  82      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;ðŸ”µ</abbr>
<abbr title="  83      * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null.">  83      * @param params any other params that are present in the sql template, other than the IN clause. ShoðŸ”µ</abbr>
<abbr title="  84      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null.">  84      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params.ðŸ”µ</abbr>
  85      * @param ids the ids to include in the IN clause.
  86      * @return the total number of records updated in the database
  87      */
  88     @Deprecated
<abbr title="  89     public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;Long&gt; ids) {">  89     public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] typesðŸ”µ</abbr>
  90         int response = 0;
  91         List&lt;Long[]&gt; runs = buildRuns(ids);
  92         for (Long[] run : runs) {
  93             String queryString = String.format(template, buildInClauseTemplate(run.length));
  94             NativeQuery&lt;?&gt; query = em.unwrap(Session.class).createSQLQuery(queryString);
  95             int counter = 1;
  96             if (!ArrayUtils.isEmpty(params)) {
  97                 for (Object param : params) {
  98                     query.setParameter(counter, param, types[counter - 1]);
  99                     counter++;
 100                 }
 101             }
 102             for (Long id : run) {
 103                 query.setParameter(counter, id, LongType.INSTANCE);
 104                 counter++;
 105             }
 106             FlushMode mode = em.unwrap(Session.class).getHibernateFlushMode();
 107             em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);
 108             try {
 109                 response += query.executeUpdate();
 110             } finally {
 111                 em.unwrap(Session.class).setFlushMode(mode);
 112             }
 113         }
 114         return response;
 115     }
 116 
 117     /**
<abbr title=" 118      * Perform an update query using a String template and params. Note, this is only intended for special"> 118      * Perform an update query using a String template and params. Note, this is only intended for speciaðŸ”µ</abbr>
<abbr title=" 119      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session"> 119      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate SeðŸ”µ</abbr>
 120      * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
 121      * &lt;/p&gt;
<abbr title=" 122      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;"> 122      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEðŸ”µ</abbr>
 123      *
 124      * @param em The entity manager to use for the persistence operation
<abbr title=" 125      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;."> 125      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;ðŸ”µ</abbr>
<abbr title=" 126      * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate to limit the scope of cache region invalidation. Otherwise, if left null, Hibernate will invalidate every cache region, which is generally not desirable. An empty String can be used to signify that no region should be invalidated."> 126      * @param tableSpace optionally provide the table being impacted by this query. This value allows HibðŸ”µ</abbr>
<abbr title=" 127      * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null."> 127      * @param params any other params that are present in the sql template, other than the IN clause. ShoðŸ”µ</abbr>
<abbr title=" 128      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null."> 128      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params.ðŸ”µ</abbr>
 129      * @param ids the ids to include in the IN clause.
 130      * @return the total number of records updated in the database
 131      */
<abbr title=" 132     public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, Type[] types, List&lt;Long&gt; ids) {"> 132     public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] pðŸ”µ</abbr>
 133         int response = 0;
 134         List&lt;Long[]&gt; runs = buildRuns(ids);
 135         for (Long[] run : runs) {
 136             String queryString = String.format(template, buildInClauseTemplate(run.length));
 137             NativeQuery&lt;?&gt; query = em.unwrap(Session.class).createSQLQuery(queryString);
 138             //only check for null - an empty string is a valid value for tableSpace
 139             if (tableSpace != null) {
 140                 query.addSynchronizedQuerySpace(tableSpace);
 141             }
 142             int counter = 1;
 143             if (!ArrayUtils.isEmpty(params)) {
 144                 for (Object param : params) {
 145                     query.setParameter(counter, param, types[counter - 1]);
 146                     counter++;
 147                 }
 148             }
 149             for (Long id : run) {
 150                 query.setParameter(counter, id, LongType.INSTANCE);
 151                 counter++;
 152             }
 153             FlushMode mode = em.unwrap(Session.class).getHibernateFlushMode();
 154             em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);
 155             try {
 156                 response += query.executeUpdate();
 157             } finally {
 158                 em.unwrap(Session.class).setFlushMode(mode);
 159             }
 160         }
 161         return response;
 162     }
 163 
 164     /**
 165      *
 166      * @param em
 167      * @param entityType
 168      * @param ids
 169      */
<abbr title=" 170     public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt; ids) {"> 170     public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt;ðŸ”µ</abbr>
 171         SharedSessionContractImplementor session = em.unwrap(SharedSessionContractImplementor.class);
 172         CacheImplementor hibernateCache = session.getFactory().getCache();
 173         for (Long id : ids) {
 174             hibernateCache.evictEntity(entityType, id);
 175         }
 176         //update the timestamp cache for the table so that queries will be refreshed
 177         PersistentClass metadata = HibernateMappingProvider.getMapping(entityType.getName());
 178         String tableName = metadata.getTable().getName();
 179         UpdateTimestampsCache timestampsCache = hibernateCache.getUpdateTimestampsCache();
 180         if (timestampsCache != null) {
 181             timestampsCache.invalidate(new Serializable[]{tableName}, session);
 182         }
 183     }
 184 
 185     /**
 186      * Quickly build up the sql IN clause template
 187      *
 188      * @param length
 189      * @return
 190      */
 191     private static String buildInClauseTemplate(int length) {
 192         String[] temp = new String[length];
 193         Arrays.fill(temp, &quot;?&quot;);
 194         return StringUtils.join(temp, &quot;,&quot;);
 195     }
 196 
 197     /**
 198      * This breaks up our IN clause into multiple runs of 800 or less in order
<abbr title=" 199      * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there are more"> 199      * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there arðŸ”µ</abbr>
 200      * than a 1000 entries in an sql IN clause).
 201      *
 202      * @param ids
 203      * @return
 204      */
 205     private static List&lt;Long[]&gt; buildRuns(List&lt;Long&gt; ids) {
 206         List&lt;Long[]&gt; runs = new ArrayList&lt;Long[]&gt;();
 207         Long[] all = ids.toArray(new Long[ids.size()]);
 208         int test = all.length;
 209         int pos = 0;
 210         boolean eof = false;
 211         while (!eof) {
 212             int arraySize;
 213             if (test &lt; 800) {
 214                 arraySize = test;
 215                 eof = true;
 216             } else {
 217                 arraySize = 800;
 218                 test -= arraySize;
 219                 if (test == 0) {
 220                     eof = true;
 221                 }
 222             }
 223             Long[] temp = new Long[arraySize];
 224             System.arraycopy(all, pos, temp, 0, arraySize);
 225             pos += arraySize;
 226             runs.add(temp);
 227         }
 228         return runs;
 229     }
 230 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.util;
  19 
  20 import org.apache.commons.lang.ArrayUtils;
  21 import org.apache.commons.lang3.StringUtils;
  22 import org.broadleafcommerce.common.util.dao.HibernateMappingProvider;
  23 
  24 import org.hibernate.FlushMode;
  25 import org.hibernate.Session;
  26 import org.hibernate.cache.spi.UpdateTimestampsCache;
  27 import org.hibernate.engine.spi.CacheImplementor;
  28 import org.hibernate.engine.spi.SharedSessionContractImplementor;
  29 import org.hibernate.mapping.PersistentClass;
  30 import org.hibernate.query.NativeQuery;
  31 import org.hibernate.type.LongType;
  32 import org.hibernate.type.Type;
  33 
  34 import java.io.Serializable;
  35 import java.util.ArrayList;
  36 import java.util.Arrays;
  37 import java.util.List;
  38 
  39 import javax.persistence.EntityManager;
  40 
  41 /**
<abbr title="  42  * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on Hibernate filtered">  42  * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updateðŸ”µ</abbr>
  43  * entities (such as sandboxable and multi-tenant entities).
  44  * &lt;/p&gt;
<abbr title="  45  * This class takes an interesting approach to the use of update queries. To explain, a bit of background is required.">  45  * This class takes an interesting approach to the use of update queries. To explain, a bit of backgroundðŸ”µ</abbr>
<abbr title="  46  * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs an HQL UPDATE">  46  * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it eðŸ”µ</abbr>
<abbr title="  47  * query. However, it will only create this temporary table when the target entity has Hibernate filters applied">  47  * query. However, it will only create this temporary table when the target entity has Hibernate filters ðŸ”µ</abbr>
<abbr title="  48  * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is used to">  48  * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectðŸ”µ</abbr>
<abbr title="  49  * populate the values. It is my understanding that this ends up creating some locks on the original table. Because of">  49  * populate the values. It is my understanding that this ends up creating some locks on the original tablðŸ”µ</abbr>
<abbr title="  50  * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to avoid">  50  * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to ðŸ”µ</abbr>
<abbr title="  51  * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) and then">  51  * the temporary table creation. We did this by first selecting for ids (so that the filters were still hðŸ”µ</abbr>
<abbr title="  52  * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needs to be basic">  52  * using a simple, native sql statement to execute the update on entities matching those ids. The native ðŸ”µ</abbr>
  53  * enough that itâ€™s portable across platforms.
  54  * &lt;/p&gt;
<abbr title="  55  * This class is responsible for building the native sql based on a template String. It does it in a way using a standard">  55  * This class is responsible for building the native sql based on a template String. It does it in a way ðŸ”µ</abbr>
<abbr title="  56  * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection exploit.">  56  * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection eðŸ”µ</abbr>
  57  * &lt;/p&gt;
<abbr title="  58  * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoid maximum">  58  * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoidðŸ”µ</abbr>
  59  * IN clause lengths enforced by some database platforms.
  60  *
  61  * @author Jeff Fischer
  62  */
  63 public class UpdateExecutor {
  64 
  65     /**
<abbr title="  66      * Perform an update query using a String template and params. Note, this is only intended for special">  66      * Perform an update query using a String template and params. Note, this is only intended for speciaðŸ”µ</abbr>
<abbr title="  67      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session">  67      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate SeðŸ”µ</abbr>
  68      * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
  69      * &lt;/p&gt;
<abbr title="  70      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;">  70      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEðŸ”µ</abbr>
  71      *
<abbr title="  72      * @deprecated Highly recommended not to use this method. This method results in global L2 cache region clearing. Use {@link #executeUpdateQuery(EntityManager, String, String, Object[], Type[], List)} instead.">  72      * @deprecated Highly recommended not to use this method. This method results in global L2 cache regiðŸ”µ</abbr>
  73      * @param em The entity manager to use for the persistence operation
<abbr title="  74      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.">  74      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;ðŸ”µ</abbr>
<abbr title="  75      * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null.">  75      * @param params any other params that are present in the sql template, other than the IN clause. ShoðŸ”µ</abbr>
<abbr title="  76      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null.">  76      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params.ðŸ”µ</abbr>
  77      * @param ids the ids to include in the IN clause.
  78      * @return the total number of records updated in the database
  79      */
  80     @Deprecated
<abbr title="  81     public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;Long&gt; ids) {">  81     public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] typesðŸ”µ</abbr>
  82         int response = 0;
  83         List&lt;Long[]&gt; runs = buildRuns(ids);
  84         for (Long[] run : runs) {
  85             String queryString = String.format(template, buildInClauseTemplate(run.length));
  86             NativeQuery&lt;?&gt; query = em.unwrap(Session.class).createSQLQuery(queryString);
  87             int counter = 1;
  88             if (!ArrayUtils.isEmpty(params)) {
  89                 for (Object param : params) {
  90                     query.setParameter(counter, param, types[counter - 1]);
  91                     counter++;
  92                 }
  93             }
  94             for (Long id : run) {
  95                 query.setParameter(counter, id, LongType.INSTANCE);
  96                 counter++;
  97             }
  98             FlushMode mode = em.unwrap(Session.class).getHibernateFlushMode();
  99             em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);
 100             try {
 101             response += query.executeUpdate();
 102             } finally {
 103                 em.unwrap(Session.class).setFlushMode(mode);
 104             }
 105         }
 106         return response;
 107     }
 108 
 109     /**
<abbr title=" 110      * Perform an update query using a String template and params. Note, this is only intended for special"> 110      * Perform an update query using a String template and params. Note, this is only intended for speciaðŸ”µ</abbr>
<abbr title=" 111      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session"> 111      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate SeðŸ”µ</abbr>
 112      * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
 113      * &lt;/p&gt;
<abbr title=" 114      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;"> 114      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEðŸ”µ</abbr>
 115      *
 116      * @param em The entity manager to use for the persistence operation
<abbr title=" 117      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;."> 117      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;ðŸ”µ</abbr>
<abbr title=" 118      * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate to limit the scope of cache region invalidation. Otherwise, if left null, Hibernate will invalidate every cache region, which is generally not desirable. An empty String can be used to signify that no region should be invalidated."> 118      * @param tableSpace optionally provide the table being impacted by this query. This value allows HibðŸ”µ</abbr>
<abbr title=" 119      * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null."> 119      * @param params any other params that are present in the sql template, other than the IN clause. ShoðŸ”µ</abbr>
<abbr title=" 120      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null."> 120      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params.ðŸ”µ</abbr>
 121      * @param ids the ids to include in the IN clause.
 122      * @return the total number of records updated in the database
 123      */
<abbr title=" 124     public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, Type[] types, List&lt;Long&gt; ids) {"> 124     public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] pðŸ”µ</abbr>
 125         int response = 0;
 126         List&lt;Long[]&gt; runs = buildRuns(ids);
 127         for (Long[] run : runs) {
 128             String queryString = String.format(template, buildInClauseTemplate(run.length));
 129             NativeQuery&lt;?&gt; query = em.unwrap(Session.class).createSQLQuery(queryString);
 130             //only check for null - an empty string is a valid value for tableSpace
 131             if (tableSpace != null) {
 132                 query.addSynchronizedQuerySpace(tableSpace);
 133             }
 134             int counter = 1;
 135             if (!ArrayUtils.isEmpty(params)) {
 136                 for (Object param : params) {
 137                     query.setParameter(counter, param, types[counter - 1]);
 138                     counter++;
 139                 }
 140             }
 141             for (Long id : run) {
 142                 query.setParameter(counter, id, LongType.INSTANCE);
 143                 counter++;
 144             }
 145             FlushMode mode = em.unwrap(Session.class).getHibernateFlushMode();
 146             em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);
 147             try {
 148             response += query.executeUpdate();
 149             } finally {
 150                 em.unwrap(Session.class).setFlushMode(mode);
 151             }
 152         }
 153         return response;
 154     }
 155 
 156     /**
 157      *
 158      * @param em
 159      * @param entityType
 160      * @param ids
 161      */
<abbr title=" 162     public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt; ids) {"> 162     public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt;ðŸ”µ</abbr>
 163         SharedSessionContractImplementor session = em.unwrap(SharedSessionContractImplementor.class);
 164         CacheImplementor hibernateCache = session.getFactory().getCache();
 165         for (Long id : ids) {
 166             hibernateCache.evictEntity(entityType, id);
 167         }
 168         //update the timestamp cache for the table so that queries will be refreshed
 169         PersistentClass metadata = HibernateMappingProvider.getMapping(entityType.getName());
 170         String tableName = metadata.getTable().getName();
 171         UpdateTimestampsCache timestampsCache = hibernateCache.getUpdateTimestampsCache();
 172         if (timestampsCache != null) {
 173             timestampsCache.invalidate(new Serializable[]{tableName}, session);
 174         }
 175     }
 176 
 177     /**
 178      * Quickly build up the sql IN clause template
 179      *
 180      * @param length
 181      * @return
 182      */
 183     private static String buildInClauseTemplate(int length) {
 184         String[] temp = new String[length];
 185         Arrays.fill(temp, &quot;?&quot;);
 186         return StringUtils.join(temp, &quot;,&quot;);
 187     }
 188 
 189     /**
 190      * This breaks up our IN clause into multiple runs of 800 or less in order
<abbr title=" 191      * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there are more"> 191      * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there arðŸ”µ</abbr>
 192      * than a 1000 entries in an sql IN clause).
 193      *
 194      * @param ids
 195      * @return
 196      */
 197     private static List&lt;Long[]&gt; buildRuns(List&lt;Long&gt; ids) {
 198         List&lt;Long[]&gt; runs = new ArrayList&lt;Long[]&gt;();
 199         Long[] all = ids.toArray(new Long[ids.size()]);
 200         int test = all.length;
 201         int pos = 0;
 202         boolean eof = false;
 203         while (!eof) {
 204             int arraySize;
 205             if (test &lt; 800) {
 206                 arraySize = test;
 207                 eof = true;
 208             } else {
 209                 arraySize = 800;
 210                 test -= arraySize;
 211                 if (test == 0) {
 212                     eof = true;
 213                 }
 214             }
 215             Long[] temp = new Long[arraySize];
 216             System.arraycopy(all, pos, temp, 0, arraySize);
 217             pos += arraySize;
 218             runs.add(temp);
 219         }
 220         return runs;
 221     }
 222 }
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.util;
  19 
  20 import java.io.Serializable;
  21 import java.util.ArrayList;
  22 import java.util.Arrays;
  23 import java.util.List;
  24 import javax.persistence.EntityManager;
  25 import org.apache.commons.lang.ArrayUtils;
  26 import org.apache.commons.lang3.StringUtils;
  27 import org.broadleafcommerce.common.util.dao.HibernateMappingProvider;
  28 import org.hibernate.FlushMode;
  29 import org.hibernate.Session;
  30 import org.hibernate.cache.spi.UpdateTimestampsCache;
  31 import org.hibernate.engine.spi.CacheImplementor;
  32 import org.hibernate.engine.spi.SharedSessionContractImplementor;
  33 import org.hibernate.mapping.PersistentClass;
  34 import org.hibernate.query.NativeQuery;
  35 import org.hibernate.type.LongType;
  36 import org.hibernate.type.Type;
  37 
  38 
  39 /**
<abbr title="  40  * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on Hibernate filtered">  40  * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updateðŸ”µ</abbr>
  41  * entities (such as sandboxable and multi-tenant entities).
  42  * &lt;/p&gt;
<abbr title="  43  * This class takes an interesting approach to the use of update queries. To explain, a bit of background is required.">  43  * This class takes an interesting approach to the use of update queries. To explain, a bit of backgroundðŸ”µ</abbr>
<abbr title="  44  * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs an HQL UPDATE">  44  * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it eðŸ”µ</abbr>
<abbr title="  45  * query. However, it will only create this temporary table when the target entity has Hibernate filters applied">  45  * query. However, it will only create this temporary table when the target entity has Hibernate filters ðŸ”µ</abbr>
<abbr title="  46  * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is used to">  46  * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectðŸ”µ</abbr>
<abbr title="  47  * populate the values. It is my understanding that this ends up creating some locks on the original table. Because of">  47  * populate the values. It is my understanding that this ends up creating some locks on the original tablðŸ”µ</abbr>
<abbr title="  48  * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to avoid">  48  * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to ðŸ”µ</abbr>
<abbr title="  49  * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) and then">  49  * the temporary table creation. We did this by first selecting for ids (so that the filters were still hðŸ”µ</abbr>
<abbr title="  50  * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needs to be basic">  50  * using a simple, native sql statement to execute the update on entities matching those ids. The native ðŸ”µ</abbr>
  51  * enough that itâ€™s portable across platforms.
  52  * &lt;/p&gt;
<abbr title="  53  * This class is responsible for building the native sql based on a template String. It does it in a way using a standard">  53  * This class is responsible for building the native sql based on a template String. It does it in a way ðŸ”µ</abbr>
<abbr title="  54  * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection exploit.">  54  * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection eðŸ”µ</abbr>
  55  * &lt;/p&gt;
<abbr title="  56  * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoid maximum">  56  * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoidðŸ”µ</abbr>
  57  * IN clause lengths enforced by some database platforms.
  58  *
  59  * @author Jeff Fischer
  60  */
  61 public class UpdateExecutor {
  62     /**
<abbr title="  63      * Perform an update query using a String template and params. Note, this is only intended for special">  63      * Perform an update query using a String template and params. Note, this is only intended for speciaðŸ”µ</abbr>
<abbr title="  64      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session">  64      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate SeðŸ”µ</abbr>
  65      * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
  66      * &lt;/p&gt;
<abbr title="  67      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;">  67      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEðŸ”µ</abbr>
  68      *
<abbr title="  69      * @deprecated Highly recommended not to use this method. This method results in global L2 cache region clearing. Use {@link #executeUpdateQuery(EntityManager, String, String, Object[], Type[], List)} instead.">  69      * @deprecated Highly recommended not to use this method. This method results in global L2 cache regiðŸ”µ</abbr>
  70      * @param em The entity manager to use for the persistence operation
<abbr title="  71      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.">  71      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;ðŸ”µ</abbr>
<abbr title="  72      * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null.">  72      * @param params any other params that are present in the sql template, other than the IN clause. ShoðŸ”µ</abbr>
<abbr title="  73      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null.">  73      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params.ðŸ”µ</abbr>
  74      * @param ids the ids to include in the IN clause.
  75      * @return the total number of records updated in the database
  76      */
  77     @Deprecated
<abbr title="  78     public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;Long&gt; ids) {">  78     public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] typesðŸ”µ</abbr>
  79         int response = 0;
  80         List&lt;Long[]&gt; runs = buildRuns(ids);
  81         for (Long[] run : runs) {
  82             String queryString = String.format(template, buildInClauseTemplate(run.length));
  83             NativeQuery&lt;?&gt; query = em.unwrap(Session.class).createSQLQuery(queryString);
  84             int counter = 1;
  85             if (!ArrayUtils.isEmpty(params)) {
  86                 for (Object param : params) {
  87                     query.setParameter(counter, param, types[counter - 1]);
  88                     counter++;
  89                 }
  90             }
  91             for (Long id : run) {
  92                 query.setParameter(counter, id, LongType.INSTANCE);
  93                 counter++;
  94             }
  95             FlushMode mode = em.unwrap(Session.class).getHibernateFlushMode();
  96             em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);
  97             try {
  98                 response += query.executeUpdate();
  99             } finally {
 100                 em.unwrap(Session.class).setFlushMode(mode);
 101             }
 102         }
 103         return response;
 104     }
 105 
 106     /**
<abbr title=" 107      * Perform an update query using a String template and params. Note, this is only intended for special"> 107      * Perform an update query using a String template and params. Note, this is only intended for speciaðŸ”µ</abbr>
<abbr title=" 108      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session"> 108      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate SeðŸ”µ</abbr>
 109      * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
 110      * &lt;/p&gt;
<abbr title=" 111      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;"> 111      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEðŸ”µ</abbr>
 112      *
 113      * @param em The entity manager to use for the persistence operation
<abbr title=" 114      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;."> 114      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;ðŸ”µ</abbr>
<abbr title=" 115      * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate to limit the scope of cache region invalidation. Otherwise, if left null, Hibernate will invalidate every cache region, which is generally not desirable. An empty String can be used to signify that no region should be invalidated."> 115      * @param tableSpace optionally provide the table being impacted by this query. This value allows HibðŸ”µ</abbr>
<abbr title=" 116      * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null."> 116      * @param params any other params that are present in the sql template, other than the IN clause. ShoðŸ”µ</abbr>
<abbr title=" 117      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null."> 117      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params.ðŸ”µ</abbr>
 118      * @param ids the ids to include in the IN clause.
 119      * @return the total number of records updated in the database
 120      */
<abbr title=" 121     public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, Type[] types, List&lt;Long&gt; ids) {"> 121     public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] pðŸ”µ</abbr>
 122         int response = 0;
 123         List&lt;Long[]&gt; runs = buildRuns(ids);
 124         for (Long[] run : runs) {
 125             String queryString = String.format(template, buildInClauseTemplate(run.length));
 126             NativeQuery&lt;?&gt; query = em.unwrap(Session.class).createSQLQuery(queryString);
 127             //only check for null - an empty string is a valid value for tableSpace
 128             if (tableSpace != null) {
 129                 query.addSynchronizedQuerySpace(tableSpace);
 130             }
 131             int counter = 1;
 132             if (!ArrayUtils.isEmpty(params)) {
 133                 for (Object param : params) {
 134                     query.setParameter(counter, param, types[counter - 1]);
 135                     counter++;
 136                 }
 137             }
 138             for (Long id : run) {
 139                 query.setParameter(counter, id, LongType.INSTANCE);
 140                 counter++;
 141             }
 142             FlushMode mode = em.unwrap(Session.class).getHibernateFlushMode();
 143             em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);
 144             try {
 145                 response += query.executeUpdate();
 146             } finally {
 147                 em.unwrap(Session.class).setFlushMode(mode);
 148             }
 149         }
 150         return response;
 151     }
 152 
 153     /**
 154      *
 155      * @param em
 156      * @param entityType
 157      * @param ids
 158      */
<abbr title=" 159     public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt; ids) {"> 159     public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt;ðŸ”µ</abbr>
 160         SharedSessionContractImplementor session = em.unwrap(SharedSessionContractImplementor.class);
 161         CacheImplementor hibernateCache = session.getFactory().getCache();
 162         for (Long id : ids) {
 163             hibernateCache.evictEntity(entityType, id);
 164         }
 165         //update the timestamp cache for the table so that queries will be refreshed
 166         PersistentClass metadata = HibernateMappingProvider.getMapping(entityType.getName());
 167         String tableName = metadata.getTable().getName();
 168         UpdateTimestampsCache timestampsCache = hibernateCache.getUpdateTimestampsCache();
 169         if (timestampsCache != null) {
 170             timestampsCache.invalidate(new Serializable[]{tableName}, session);
 171         }
 172     }
 173 
 174     /**
 175      * Quickly build up the sql IN clause template
 176      *
 177      * @param length
 178      * @return
 179      */
 180     private static String buildInClauseTemplate(int length) {
 181         String[] temp = new String[length];
 182         Arrays.fill(temp, &quot;?&quot;);
 183         return StringUtils.join(temp, &quot;,&quot;);
 184     }
 185 
 186     /**
 187      * This breaks up our IN clause into multiple runs of 800 or less in order
<abbr title=" 188      * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there are more"> 188      * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there arðŸ”µ</abbr>
 189      * than a 1000 entries in an sql IN clause).
 190      *
 191      * @param ids
 192      * @return
 193      */
 194     private static List&lt;Long[]&gt; buildRuns(List&lt;Long&gt; ids) {
 195         List&lt;Long[]&gt; runs = new ArrayList&lt;Long[]&gt;();
 196         Long[] all = ids.toArray(new Long[ids.size()]);
 197         int test = all.length;
 198         int pos = 0;
 199         boolean eof = false;
 200         while (!eof) {
 201             int arraySize;
 202             if (test &lt; 800) {
 203                 arraySize = test;
 204                 eof = true;
 205             } else {
 206                 arraySize = 800;
 207                 test -= arraySize;
 208                 if (test == 0) {
 209                     eof = true;
 210                 }
 211             }
 212             Long[] temp = new Long[arraySize];
 213             System.arraycopy(all, pos, temp, 0, arraySize);
 214             pos += arraySize;
 215             runs.add(temp);
 216         }
 217         return runs;
 218     }
 219 }
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.util;
  19  
  20  import org.apache.commons.lang.ArrayUtils;
  21  import org.apache.commons.lang3.StringUtils;
  22  import org.broadleafcommerce.common.util.dao.HibernateMappingProvider;


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import org.hibernate.SQLQuery;</span>
  24  import org.hibernate.Session;
  25  import org.hibernate.cache.spi.UpdateTimestampsCache;
  26  import org.hibernate.engine.spi.CacheImplementor;
  27  import org.hibernate.engine.spi.SharedSessionContractImplementor;
  28  import org.hibernate.mapping.PersistentClass;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import org.hibernate.query.NativeQuery;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import org.hibernate.type.LongType;</span>
  31  import org.hibernate.type.Type;
  32  
  33  import java.io.Serializable;
  34  import java.util.ArrayList;
  35  import java.util.Arrays;
  36  import java.util.List;
  37  
  38  import javax.persistence.EntityManager;
  39  
  40  /**
<abbr title="  41   * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on Hibernate filtered">  41   * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on HibeðŸ”µ</abbr>
  42   * entities (such as sandboxable and multi-tenant entities).
  43   * &lt;/p&gt;
<abbr title="  44   * This class takes an interesting approach to the use of update queries. To explain, a bit of background is required.">  44   * This class takes an interesting approach to the use of update queries. To explain, a bit of background is requiðŸ”µ</abbr>
<abbr title="  45   * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs an HQL UPDATE">  45   * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs anðŸ”µ</abbr>
  46   * query. However, it will only create this temporary table when the target entity has Hibernate filters applied
<abbr title="  47   * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is used to">  47   * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is usedðŸ”µ</abbr>
<abbr title="  48   * populate the values. It is my understanding that this ends up creating some locks on the original table. Because of">  48   * populate the values. It is my understanding that this ends up creating some locks on the original table. BecausðŸ”µ</abbr>
  49   * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to avoid
<abbr title="  50   * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) and then">  50   * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) aðŸ”µ</abbr>
<abbr title="  51   * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needs to be basic">  51   * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needsðŸ”µ</abbr>
  52   * enough that itâ€™s portable across platforms.
  53   * &lt;/p&gt;
<abbr title="  54   * This class is responsible for building the native sql based on a template String. It does it in a way using a standard">  54   * This class is responsible for building the native sql based on a template String. It does it in a way using a sðŸ”µ</abbr>
  55   * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection exploit.
  56   * &lt;/p&gt;
  57   * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoid maximum
  58   * IN clause lengths enforced by some database platforms.
  59   *
  60   * @author Jeff Fischer
  61   */
  62  public class UpdateExecutor {
  63  
  64      /**
  65       * Perform an update query using a String template and params. Note, this is only intended for special
  66       * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session
  67       * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
  68       * &lt;/p&gt;
<abbr title="  69       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;">  69       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (ðŸ”µ</abbr>
  70       *
<abbr title="  71       * @deprecated Highly recommended not to use this method. This method results in global L2 cache region clearing. Use {@link #executeUpdateQuery(EntityManager, String, String, Object[], Type[], List)} instead.">  71       * @deprecated Highly recommended not to use this method. This method results in global L2 cache region cleariðŸ”µ</abbr>
  72       * @param em The entity manager to use for the persistence operation
  73       * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.
<abbr title="  74       * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null.">  74       * @param params any other params that are present in the sql template, other than the IN clause. Should be wrðŸ”µ</abbr>
<abbr title="  75       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null.">  75       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should bðŸ”µ</abbr>
  76       * @param ids the ids to include in the IN clause.
  77       * @return the total number of records updated in the database
  78       */
  79      @Deprecated
<abbr title="  80      public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;Long&gt; ids) {">  80      public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;LoðŸ”µ</abbr>
  81          int response = 0;
  82          List&lt;Long[]&gt; runs = buildRuns(ids);
  83          for (Long[] run : runs) {
  84              String queryString = String.format(template, buildInClauseTemplate(run.length));
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -            SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -            int counter = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +            NativeQuery&lt;?&gt; query = em.unwrap(Session.class).createSQLQuery(queryString);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  88 +            int counter = 1;</span>
  89              if (!ArrayUtils.isEmpty(params)) {
  90                  for (Object param : params) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -                    query.setParameter(counter, param, types[counter]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +                    query.setParameter(counter, param, types[counter - 1]);</span>
  93                      counter++;
  94                  }
  95              }
  96              for (Long id : run) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -                query.setLong(counter, id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +                query.setParameter(counter, id, LongType.INSTANCE);</span>
  99                  counter++;
 100              }
 101              response += query.executeUpdate();







 102          }
 103          return response;
 104      }
 105  
 106      /**
 107       * Perform an update query using a String template and params. Note, this is only intended for special
 108       * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session
 109       * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
 110       * &lt;/p&gt;
<abbr title=" 111       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;"> 111       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (ðŸ”µ</abbr>
 112       *
 113       * @param em The entity manager to use for the persistence operation
 114       * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.
<abbr title=" 115       * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate to limit the scope of cache region invalidation. Otherwise, if left null, Hibernate will invalidate every cache region, which is generally not desirable. An empty String can be used to signify that no region should be invalidated."> 115       * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate toðŸ”µ</abbr>
<abbr title=" 116       * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null."> 116       * @param params any other params that are present in the sql template, other than the IN clause. Should be wrðŸ”µ</abbr>
<abbr title=" 117       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null."> 117       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should bðŸ”µ</abbr>
 118       * @param ids the ids to include in the IN clause.
 119       * @return the total number of records updated in the database
 120       */
<abbr title=" 121      public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, Type[] types, List&lt;Long&gt; ids) {"> 121      public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, TyðŸ”µ</abbr>
 122          int response = 0;
 123          List&lt;Long[]&gt; runs = buildRuns(ids);
 124          for (Long[] run : runs) {
 125              String queryString = String.format(template, buildInClauseTemplate(run.length));
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -            SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 127 +            NativeQuery&lt;?&gt; query = em.unwrap(Session.class).createSQLQuery(queryString);</span>
 128              //only check for null - an empty string is a valid value for tableSpace
 129              if (tableSpace != null) {
 130                  query.addSynchronizedQuerySpace(tableSpace);
 131              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -            int counter = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 133 +            int counter = 1;</span>
 134              if (!ArrayUtils.isEmpty(params)) {
 135                  for (Object param : params) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -                    query.setParameter(counter, param, types[counter]);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 137 +                    query.setParameter(counter, param, types[counter - 1]);</span>
 138                      counter++;
 139                  }
 140              }
 141              for (Long id : run) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -                query.setLong(counter, id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 143 +                query.setParameter(counter, id, LongType.INSTANCE);</span>
 144                  counter++;
 145              }
 146              response += query.executeUpdate();







 147          }
 148          return response;
 149      }
 150  
 151      /**
 152       *
 153       * @param em
 154       * @param entityType
 155       * @param ids
 156       */
 157      public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt; ids) {
 158          SharedSessionContractImplementor session = em.unwrap(SharedSessionContractImplementor.class);
 159          CacheImplementor hibernateCache = session.getFactory().getCache();
 160          for (Long id : ids) {
 161              hibernateCache.evictEntity(entityType, id);
 162          }
 163          //update the timestamp cache for the table so that queries will be refreshed
 164          PersistentClass metadata = HibernateMappingProvider.getMapping(entityType.getName());
 165          String tableName = metadata.getTable().getName();
 166          UpdateTimestampsCache timestampsCache = hibernateCache.getUpdateTimestampsCache();
 167          if (timestampsCache != null) {
 168              timestampsCache.invalidate(new Serializable[]{tableName}, session);
 169          }
 170      }
 171  
 172      /**
 173       * Quickly build up the sql IN clause template
 174       *
 175       * @param length
 176       * @return
 177       */
 178      private static String buildInClauseTemplate(int length) {
 179          String[] temp = new String[length];
 180          Arrays.fill(temp, &quot;?&quot;);
 181          return StringUtils.join(temp, &quot;,&quot;);
 182      }
 183  
 184      /**
 185       * This breaks up our IN clause into multiple runs of 800 or less in order
 186       * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there are more
 187       * than a 1000 entries in an sql IN clause).
 188       *
 189       * @param ids
 190       * @return
 191       */
 192      private static List&lt;Long[]&gt; buildRuns(List&lt;Long&gt; ids) {
 193          List&lt;Long[]&gt; runs = new ArrayList&lt;Long[]&gt;();
 194          Long[] all = ids.toArray(new Long[ids.size()]);
 195          int test = all.length;
 196          int pos = 0;
 197          boolean eof = false;
 198          while (!eof) {
 199              int arraySize;
 200              if (test &lt; 800) {
 201                  arraySize = test;
 202                  eof = true;
 203              } else {
 204                  arraySize = 800;
 205                  test -= arraySize;
 206                  if (test == 0) {
 207                      eof = true;
 208                  }
 209              }
 210              Long[] temp = new Long[arraySize];
 211              System.arraycopy(all, pos, temp, 0, arraySize);
 212              pos += arraySize;
 213              runs.add(temp);
 214          }
 215          return runs;
 216      }
 217  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.util;
  19  
  20  import org.apache.commons.lang.ArrayUtils;
  21  import org.apache.commons.lang3.StringUtils;
  22  import org.broadleafcommerce.common.util.dao.HibernateMappingProvider;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  23 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  24 +import org.hibernate.FlushMode;</span>
  25  import org.hibernate.SQLQuery;
  26  import org.hibernate.Session;
  27  import org.hibernate.cache.spi.UpdateTimestampsCache;
  28  import org.hibernate.engine.spi.CacheImplementor;
  29  import org.hibernate.engine.spi.SharedSessionContractImplementor;
  30  import org.hibernate.mapping.PersistentClass;


  31  import org.hibernate.type.Type;
  32  
  33  import java.io.Serializable;
  34  import java.util.ArrayList;
  35  import java.util.Arrays;
  36  import java.util.List;
  37  
  38  import javax.persistence.EntityManager;
  39  
  40  /**
<abbr title="  41   * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on Hibernate filtered">  41   * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on HibeðŸ”µ</abbr>
  42   * entities (such as sandboxable and multi-tenant entities).
  43   * &lt;/p&gt;
<abbr title="  44   * This class takes an interesting approach to the use of update queries. To explain, a bit of background is required.">  44   * This class takes an interesting approach to the use of update queries. To explain, a bit of background is requiðŸ”µ</abbr>
<abbr title="  45   * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs an HQL UPDATE">  45   * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs anðŸ”µ</abbr>
  46   * query. However, it will only create this temporary table when the target entity has Hibernate filters applied
<abbr title="  47   * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is used to">  47   * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is usedðŸ”µ</abbr>
<abbr title="  48   * populate the values. It is my understanding that this ends up creating some locks on the original table. Because of">  48   * populate the values. It is my understanding that this ends up creating some locks on the original table. BecausðŸ”µ</abbr>
  49   * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to avoid
<abbr title="  50   * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) and then">  50   * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) aðŸ”µ</abbr>
<abbr title="  51   * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needs to be basic">  51   * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needsðŸ”µ</abbr>
  52   * enough that itâ€™s portable across platforms.
  53   * &lt;/p&gt;
<abbr title="  54   * This class is responsible for building the native sql based on a template String. It does it in a way using a standard">  54   * This class is responsible for building the native sql based on a template String. It does it in a way using a sðŸ”µ</abbr>
  55   * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection exploit.
  56   * &lt;/p&gt;
  57   * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoid maximum
  58   * IN clause lengths enforced by some database platforms.
  59   *
  60   * @author Jeff Fischer
  61   */
  62  public class UpdateExecutor {
  63  
  64      /**
  65       * Perform an update query using a String template and params. Note, this is only intended for special
  66       * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session
  67       * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
  68       * &lt;/p&gt;
<abbr title="  69       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;">  69       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (ðŸ”µ</abbr>
  70       *
<abbr title="  71       * @deprecated Highly recommended not to use this method. This method results in global L2 cache region clearing. Use {@link #executeUpdateQuery(EntityManager, String, String, Object[], Type[], List)} instead.">  71       * @deprecated Highly recommended not to use this method. This method results in global L2 cache region cleariðŸ”µ</abbr>
  72       * @param em The entity manager to use for the persistence operation
  73       * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.
<abbr title="  74       * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null.">  74       * @param params any other params that are present in the sql template, other than the IN clause. Should be wrðŸ”µ</abbr>
<abbr title="  75       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null.">  75       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should bðŸ”µ</abbr>
  76       * @param ids the ids to include in the IN clause.
  77       * @return the total number of records updated in the database
  78       */
  79      @Deprecated
<abbr title="  80      public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;Long&gt; ids) {">  80      public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;LoðŸ”µ</abbr>
  81          int response = 0;
  82          List&lt;Long[]&gt; runs = buildRuns(ids);
  83          for (Long[] run : runs) {
  84              String queryString = String.format(template, buildInClauseTemplate(run.length));
  85              SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);
  86              int counter = 0;


  87              if (!ArrayUtils.isEmpty(params)) {
  88                  for (Object param : params) {
  89                      query.setParameter(counter, param, types[counter]);

  90                      counter++;
  91                  }
  92              }
  93              for (Long id : run) {
  94                  query.setLong(counter, id);

  95                  counter++;
  96              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -            response += query.executeUpdate();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +            FlushMode mode = em.unwrap(Session.class).getHibernateFlushMode();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +            em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +                response += query.executeUpdate();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +            } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 103 +                em.unwrap(Session.class).setFlushMode(mode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +            }</span>
 105          }
 106          return response;
 107      }
 108  
 109      /**
 110       * Perform an update query using a String template and params. Note, this is only intended for special
 111       * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session
 112       * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
 113       * &lt;/p&gt;
<abbr title=" 114       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;"> 114       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (ðŸ”µ</abbr>
 115       *
 116       * @param em The entity manager to use for the persistence operation
 117       * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.
<abbr title=" 118       * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate to limit the scope of cache region invalidation. Otherwise, if left null, Hibernate will invalidate every cache region, which is generally not desirable. An empty String can be used to signify that no region should be invalidated."> 118       * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate toðŸ”µ</abbr>
<abbr title=" 119       * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null."> 119       * @param params any other params that are present in the sql template, other than the IN clause. Should be wrðŸ”µ</abbr>
<abbr title=" 120       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null."> 120       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should bðŸ”µ</abbr>
 121       * @param ids the ids to include in the IN clause.
 122       * @return the total number of records updated in the database
 123       */
<abbr title=" 124      public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, Type[] types, List&lt;Long&gt; ids) {"> 124      public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, TyðŸ”µ</abbr>
 125          int response = 0;
 126          List&lt;Long[]&gt; runs = buildRuns(ids);
 127          for (Long[] run : runs) {
 128              String queryString = String.format(template, buildInClauseTemplate(run.length));
 129              SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);

 130              //only check for null - an empty string is a valid value for tableSpace
 131              if (tableSpace != null) {
 132                  query.addSynchronizedQuerySpace(tableSpace);
 133              }
 134              int counter = 0;

 135              if (!ArrayUtils.isEmpty(params)) {
 136                  for (Object param : params) {
 137                      query.setParameter(counter, param, types[counter]);

 138                      counter++;
 139                  }
 140              }
 141              for (Long id : run) {
 142                  query.setLong(counter, id);

 143                  counter++;
 144              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -            response += query.executeUpdate();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +            FlushMode mode = em.unwrap(Session.class).getHibernateFlushMode();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +            em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +                response += query.executeUpdate();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +            } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 151 +                em.unwrap(Session.class).setFlushMode(mode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +            }</span>
 153          }
 154          return response;
 155      }
 156  
 157      /**
 158       *
 159       * @param em
 160       * @param entityType
 161       * @param ids
 162       */
 163      public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt; ids) {
 164          SharedSessionContractImplementor session = em.unwrap(SharedSessionContractImplementor.class);
 165          CacheImplementor hibernateCache = session.getFactory().getCache();
 166          for (Long id : ids) {
 167              hibernateCache.evictEntity(entityType, id);
 168          }
 169          //update the timestamp cache for the table so that queries will be refreshed
 170          PersistentClass metadata = HibernateMappingProvider.getMapping(entityType.getName());
 171          String tableName = metadata.getTable().getName();
 172          UpdateTimestampsCache timestampsCache = hibernateCache.getUpdateTimestampsCache();
 173          if (timestampsCache != null) {
 174              timestampsCache.invalidate(new Serializable[]{tableName}, session);
 175          }
 176      }
 177  
 178      /**
 179       * Quickly build up the sql IN clause template
 180       *
 181       * @param length
 182       * @return
 183       */
 184      private static String buildInClauseTemplate(int length) {
 185          String[] temp = new String[length];
 186          Arrays.fill(temp, &quot;?&quot;);
 187          return StringUtils.join(temp, &quot;,&quot;);
 188      }
 189  
 190      /**
 191       * This breaks up our IN clause into multiple runs of 800 or less in order
 192       * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there are more
 193       * than a 1000 entries in an sql IN clause).
 194       *
 195       * @param ids
 196       * @return
 197       */
 198      private static List&lt;Long[]&gt; buildRuns(List&lt;Long&gt; ids) {
 199          List&lt;Long[]&gt; runs = new ArrayList&lt;Long[]&gt;();
 200          Long[] all = ids.toArray(new Long[ids.size()]);
 201          int test = all.length;
 202          int pos = 0;
 203          boolean eof = false;
 204          while (!eof) {
 205              int arraySize;
 206              if (test &lt; 800) {
 207                  arraySize = test;
 208                  eof = true;
 209              } else {
 210                  arraySize = 800;
 211                  test -= arraySize;
 212                  if (test == 0) {
 213                      eof = true;
 214                  }
 215              }
 216              Long[] temp = new Long[arraySize];
 217              System.arraycopy(all, pos, temp, 0, arraySize);
 218              pos += arraySize;
 219              runs.add(temp);
 220          }
 221          return runs;
 222      }
 223  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            