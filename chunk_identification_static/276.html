<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>276</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    276
                    <a href="275.html">prev</a>
                    <a href="277.html">next</a>
                    <a href="276_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    Automattic/simplenote-android_bf5cd5502f24a0f8a529769c227437509b0ec9f5_Simplenote/src/main/java/com/automattic/simplenote/NoteListFragment.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;bf5cd5502f24a0f8a529769c227437509b0ec9f5:Simplenote/src/main/java/com/automattic/simplenote/NoteListFragment.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;bf5cd5502f24a0f8a529769c227437509b0ec9f5^1:Simplenote/src/main/java/com/automattic/simplenote/NoteListFragment.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;bf5cd5502f24a0f8a529769c227437509b0ec9f5^2:Simplenote/src/main/java/com/automattic/simplenote/NoteListFragment.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\Automattic\simplenote-android show &quot;15b2b25d8ceda8d613f23f9846fd7ddbea717acb:Simplenote/src/main/java/com/automattic/simplenote/NoteListFragment.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b], [b], [bj], [bj], [s]], subset: [[b], [b], [bj], [sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.ListFragment;
   5 import android.content.Context;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.database.Cursor;
   9 import android.database.sqlite.SQLiteException;
  10 import android.os.AsyncTask;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.preference.PreferenceManager;
  14 import android.support.annotation.NonNull;
  15 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
  16 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17 import android.text.SpannableString;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18 import android.text.style.TextAppearanceSpan;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19 import android.util.SparseBooleanArray;</span>
  20 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21 import android.support.v4.app.ActivityCompat;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22 import android.support.v4.app.ActivityOptionsCompat;</span>
  23 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  24 import android.text.Html;
  25 import android.text.SpannableString;
  26 import android.text.style.TextAppearanceSpan;
  27 import android.util.SparseBooleanArray;
  28 import android.util.TypedValue;
  29 import android.view.ActionMode;
  30 import android.view.LayoutInflater;
  31 import android.view.Menu;
  32 import android.view.MenuInflater;
  33 import android.view.MenuItem;
  34 import android.view.View;
  35 import android.view.ViewGroup;
  36 import android.webkit.WebSettings;
  37 import android.widget.AbsListView;
  38 import android.widget.AdapterView;
  39 import android.widget.Button;
  40 import android.widget.CursorAdapter;
  41 import android.widget.ImageView;
  42 import android.widget.LinearLayout;
  43 import android.widget.ListView;
  44 import android.widget.TextView;
  45 import android.widget.ViewSwitcher;
  46 
  47 import com.automattic.simplenote.models.Note;
  48 import com.automattic.simplenote.utils.DisplayUtils;
  49 import com.automattic.simplenote.utils.PrefUtils;
  50 import com.automattic.simplenote.utils.SearchSnippetFormatter;
  51 import com.automattic.simplenote.utils.SearchTokenizer;
  52 import com.automattic.simplenote.utils.StrUtils;
  53 import com.automattic.simplenote.utils.TextHighlighter;
  54 import com.google.android.gms.analytics.HitBuilders;
  55 import com.google.android.gms.analytics.Tracker;
  56 import com.simperium.client.Bucket;
  57 import com.simperium.client.Bucket.ObjectCursor;
  58 import com.simperium.client.Query;
  59 import com.simperium.client.Query.SortType;
  60 
  61 import java.util.ArrayList;
  62 import java.util.Calendar;
  63 import java.util.List;
  64 
  65 /**
  66  * A list fragment representing a list of Notes. This fragment also supports
  67  * tablet devices by allowing list items to be given an &#x27;activated&#x27; state upon
  68  * selection. This helps indicate which item is currently being viewed in a
  69  * {@link NoteEditorFragment}.
  70  * &lt;p&gt;
  71  * Activities containing this fragment MUST implement the {@link Callbacks}
  72  * interface.
  73  */
<abbr title="  74 public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsListView.MultiChoiceModeListener {">  74 public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsLisðŸ”µ</abbr>
  75 
  76     private ActionMode mActionMode;
  77 
  78 	protected NotesCursorAdapter mNotesAdapter;
  79     private TextView mEmptyListTextView;
  80     private LinearLayout mDividerShadow;
  81 	private int mNumPreviewLines;
  82     protected String mSearchString;
  83     private ViewSwitcher mWelcomeViewSwitcher;
  84     private String mSelectedNoteId;
  85     private refreshListTask mRefreshListTask;
  86 
  87 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  88     private int mTitleFontSize;</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  89     private int mPreviewFontSize;</span>
  90 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91 	 */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92 	private static final String STATE_ACTIVATED_POSITION = &quot;activated_position&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93     private static final String TAG_BUTTON_SIGNIN = &quot;sign_in&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94     private static final String TAG_BUTTON_SIGNUP = &quot;sign_up&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 	/**</span>
  97 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98     private Tracker mTracker;</span>
  99 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 100 
 101 	/**
 102 	 * The preferences key representing the activated item position. Only used on tablets.
 103 	 */
 104 	private static final String STATE_ACTIVATED_POSITION = &quot;activated_position&quot;;
 105     private static final String TAG_BUTTON_SIGNIN = &quot;sign_in&quot;;
 106     private static final String TAG_BUTTON_SIGNUP = &quot;sign_up&quot;;
 107 
 108 	/**
 109 	 * The fragment&#x27;s current callback object, which is notified of list item
 110 	 * clicks.
 111 	 */
 112 	private Callbacks mCallbacks = sCallbacks;
 113 
 114 	/**
 115 	 * The current activated item position. Only used on tablets.
 116 	 */
 117 	private int mActivatedPosition = ListView.INVALID_POSITION;
 118 
 119     public void setEmptyListViewClickable(boolean isClickable) {
 120         if (mEmptyListTextView != null) {
 121             mEmptyListTextView.setClickable(isClickable);
 122         }
 123     }
 124 
 125     @Override
 126     public boolean onItemLongClick(AdapterView&lt;?&gt; adapterView, View view, int position, long l) {
 127         getListView().setChoiceMode(ListView.CHOICE_MODE_MULTIPLE_MODAL);
 128         getListView().setItemChecked(position, true);
 129         if (mActionMode == null)
 130             getActivity().startActionMode(this);
 131         return true;
 132     }
 133 
 134     @Override
 135     public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 136         MenuInflater inflater = actionMode.getMenuInflater();
 137         inflater.inflate(R.menu.bulk_edit, menu);
 138         mActionMode = actionMode;
 139         return true;
 140     }
 141 
 142     @Override
 143     public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 144         return false;
 145     }
 146 
 147     @Override
 148     public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 149         if (getListView().getCheckedItemIds().length &gt; 0 &amp;&amp; item.getItemId() == R.id.menu_delete)
 150             new trashNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 151         return false;
 152     }
 153 
 154     @Override
 155     public void onDestroyActionMode(ActionMode mode) {
 156         mActionMode = null;
 157         new Handler().post(new Runnable() {
 158             @Override
 159             public void run() {
 160                 if (getActivity() != null) {
 161                     NotesActivity notesActivity = (NotesActivity) getActivity();
 162                     setActivateOnItemClick(DisplayUtils.isLargeLandscape(notesActivity));
 163                     notesActivity.showDetailPlaceholder();
 164                 }
 165             }
 166         });
 167     }
 168 
 169     @Override
<abbr title=" 170     public void onItemCheckedStateChanged(ActionMode actionMode, int position, long id, boolean checked) {"> 170     public void onItemCheckedStateChanged(ActionMode actionMode, int position, long id, boolean checked) ðŸ”µ</abbr>
 171         int checkedCount = getListView().getCheckedItemCount();
 172         if (checkedCount == 0)
 173             actionMode.setTitle(&quot;&quot;);
 174         else
<abbr title=" 175             actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, checkedCount));"> 175             actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, ðŸ”µ</abbr>
 176     }
 177 
 178     /**
 179 	 * A callback interface that all activities containing this fragment must
 180 	 * implement. This mechanism allows activities to be notified of item
 181 	 * selections.
 182 	 */
 183 	public interface Callbacks {
 184 		/**
 185 		 * Callback for when a note has been selected.
 186 		 */
 187 		public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets);
 188 	}
 189 
 190 	/**
 191 	 * A dummy implementation of the {@link Callbacks} interface that does
 192 	 * nothing. Used only when this fragment is not attached to an activity.
 193 	 */
 194 	private static Callbacks sCallbacks = new Callbacks() {
 195 		@Override
 196 		public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets) {
 197 		}
 198 	};
 199 
 200 	/**
 201 	 * Mandatory empty constructor for the fragment manager to instantiate the
 202 	 * fragment (e.g. upon screen orientation changes).
 203 	 */
 204 	public NoteListFragment() {
 205 	}
 206 
 207 	@Override
 208 	public void onCreate(Bundle savedInstanceState) {
 209 		super.onCreate(savedInstanceState);
 210 
 211 		mNotesAdapter = new NotesCursorAdapter(getActivity().getBaseContext(), null, 0);
 212 		setListAdapter(mNotesAdapter);
 213 	}
 214 
 215 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
 216 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 217 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 218     // nbradbury - load values from preferences</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 219 	protected void getPrefs() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 220         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, false);"> 220         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, falseðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 221 		mNumPreviewLines = (condensedList) ? 0 : 2;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 222 	}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 224     @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 225     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 226     {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 227         View view = inflater.inflate(R.layout.notes_list, container, false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 228         return view;</span>
 229 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230     @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231     public void onActivityCreated(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232         super.onActivityCreated(savedInstanceState);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234         Simplenote application = (Simplenote) getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235         mTracker = application.getTracker();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237 </span>
 238 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 239     // nbradbury - load values from preferences
 240 	protected void getPrefs() {
<abbr title=" 241         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, false);"> 241         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, falseðŸ”µ</abbr>
 242 		mNumPreviewLines = (condensedList) ? 0 : 2;
 243         mPreviewFontSize = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 18);
 244         mTitleFontSize = Math.round(mPreviewFontSize + mPreviewFontSize * 0.222f);
 245 	}
 246 
 247     @Override
 248 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 249     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)"> 249     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 250     {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 251         return inflater.inflate(R.layout.notes_list, container, false);</span>
 252 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 253     {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 254         View view = inflater.inflate(R.layout.notes_list, container, false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 255         return view;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 256     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 257 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 258 	@Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 259 	public void onViewCreated(View view, Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 260 		super.onViewCreated(view, savedInstanceState);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 261 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 262         NotesActivity notesActivity = (NotesActivity)getActivity();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 263 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 264         LinearLayout emptyView = (LinearLayout)view.findViewById(android.R.id.empty);</span>
 265 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 266     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {"> 266     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267         return inflater.inflate(R.layout.fragment_notes_list, container, false);</span>
 268 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 269     }
 270 
 271 	@Override
 272 	public void onViewCreated(View view, Bundle savedInstanceState) {
 273 		super.onViewCreated(view, savedInstanceState);
 274 
 275         NotesActivity notesActivity = (NotesActivity)getActivity();
 276 
 277         LinearLayout emptyView = (LinearLayout)view.findViewById(android.R.id.empty);
 278         emptyView.setVisibility(View.GONE);
 279         mEmptyListTextView = (TextView)view.findViewById(R.id.empty_message);
 280         mEmptyListTextView.setOnClickListener(new View.OnClickListener() {
 281             @Override
 282             public void onClick(View v) {
 283                 addNote();
 284             }
 285         });
<abbr title=" 286         setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 286         setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.fðŸ”µ</abbr>
 287         mDividerShadow = (LinearLayout)view.findViewById(R.id.divider_shadow);
 288         mWelcomeViewSwitcher = (ViewSwitcher)view.findViewById(R.id.welcome_view_switcher);
 289 
 290         TextView welcomeTextView = (TextView)view.findViewById(R.id.welcome_textview);
<abbr title=" 291         welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.use_simplenote_account) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 291         welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(ðŸ”µ</abbr>
 292         TextView laterTextView = (TextView)view.findViewById(R.id.welcome_later_textview);
<abbr title=" 293         laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_try_app) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 293         laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.strinðŸ”µ</abbr>
 294 
 295         TextView signInButton = (TextView)view.findViewById(R.id.welcome_sign_in);
 296         signInButton.setTag(TAG_BUTTON_SIGNIN);
 297         signInButton.setOnClickListener(signInClickListener);
 298         TextView signUpButton = (TextView)view.findViewById(R.id.welcome_sign_up);
 299         signUpButton.setTag(TAG_BUTTON_SIGNUP);
 300         signUpButton.setOnClickListener(signInClickListener);
 301 
 302         if (DisplayUtils.isLargeLandscape(notesActivity)) {
 303             setActivateOnItemClick(true);
 304             mDividerShadow.setVisibility(View.VISIBLE);
 305         }
 306 
 307         welcomeTextView.setOnClickListener(new View.OnClickListener() {
 308             @Override
 309             public void onClick(View v) {
 310                 mWelcomeViewSwitcher.showNext();
 311             }
 312         });
 313         laterTextView.setOnClickListener(new View.OnClickListener() {
 314             @Override
 315             public void onClick(View v) {
 316                 mWelcomeViewSwitcher.showNext();
<abbr title=" 317                 SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivity());"> 317                 SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivityðŸ”µ</abbr>
 318                 SharedPreferences.Editor editor = preferences.edit();
 319                 editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 320                 editor.apply();
 321             }
 322         });
 323 
 324         getListView().setOnItemLongClickListener(this);
 325         getListView().setMultiChoiceModeListener(this);
 326 	}
 327 
 328 	@Override
 329 	public void onAttach(Activity activity) {
 330 		super.onAttach(activity);
 331 
 332 		// Activities containing this fragment must implement its callbacks.
 333 		if (!(activity instanceof Callbacks)) {
 334 			throw new IllegalStateException(&quot;Activity must implement fragment&#x27;s callbacks.&quot;);
 335 		}
 336 
 337 		mCallbacks = (Callbacks) activity;
 338 	}
 339 
 340 	@Override
 341 	public void onResume() {
 342 		super.onResume();
 343         getPrefs();
 344 
 345         setWelcomeViewVisibility();
 346 
 347         refreshList();
 348 
 349         if (!PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_APP_TRIAL, false)) {
 350             new Handler().postDelayed(new Runnable() {
 351                 @Override
 352                 public void run() {
 353                     mWelcomeViewSwitcher.showNext();
 354                 }
 355             }, 100);
 356         }
 357 	}
 358 
 359     public void setWelcomeViewVisibility() {
 360         if (mWelcomeViewSwitcher != null &amp;&amp; getActivity() != null) {
 361             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 362             if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 363                 int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().getDisplayMetrics());"> 363                 int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResðŸ”µ</abbr>
<abbr title=" 364                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();"> 364                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutðŸ”µ</abbr>
 365                 mlp.setMargins(0, 0, 0, bottomMargin);
 366                 getListView().getEmptyView().setLayoutParams(mlp);
 367                 mWelcomeViewSwitcher.setVisibility(View.VISIBLE);
 368             } else {
 369                 mWelcomeViewSwitcher.setVisibility(View.GONE);
<abbr title=" 370                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();"> 370                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutðŸ”µ</abbr>
 371                 mlp.setMargins(0, 0, 0, 0);
 372                 getListView().getEmptyView().setLayoutParams(mlp);
 373             }
 374         }
 375     }
 376 
 377     public void hideWelcomeView() {
 378         if (mWelcomeViewSwitcher != null)
 379             mWelcomeViewSwitcher.setVisibility(View.GONE);
 380     }
 381 
 382     private Button.OnClickListener signInClickListener = new Button.OnClickListener() {
 383         @Override
 384         public void onClick(View v) {
 385             ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN));
 386         }
 387     };
 388 
 389 	@Override
 390 	public void onDetach() {
 391 		super.onDetach();
 392 
 393 		// Reset the active callbacks interface to the dummy implementation.
 394 		mCallbacks = sCallbacks;
 395 	}
 396 
 397     @Override
 398     public void onDestroy(){
 399         super.onDestroy();
 400     }
 401 
 402     public void setEmptyListMessage(String message) {
 403         if (mEmptyListTextView != null &amp;&amp; message != null)
 404             mEmptyListTextView.setText(Html.fromHtml(message));
 405     }
 406 
 407 	@Override
 408 	public void onListItemClick(ListView listView, View view, int position, long id) {
 409         if (!isAdded()) return;
 410 		super.onListItemClick(listView, view, position, id);
 411 
 412         NoteViewHolder holder = (NoteViewHolder)view.getTag();
 413         String noteID = holder.getNoteId();
 414 
 415         if (DisplayUtils.isLargeLandscape(getActivity())) {
 416             if (noteID != null) {
 417                 mCallbacks.onNoteSelected(noteID, position, false, holder.matchOffsets);
 418             }
 419         } else {
 420             Bundle arguments = new Bundle();
 421             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 422 
 423             Intent editNoteIntent = new Intent(getActivity(), NoteEditorActivity.class);
 424             editNoteIntent.putExtras(arguments);
 425 
<abbr title=" 426             ActivityOptionsCompat options = ActivityOptionsCompat.makeSceneTransitionAnimation(getActivity(), view, &quot;transition_editor&quot;);"> 426             ActivityOptionsCompat options = ActivityOptionsCompat.makeSceneTransitionAnimation(getActivitðŸ”µ</abbr>
<abbr title=" 427             ActivityCompat.startActivityForResult(getActivity(), editNoteIntent, Simplenote.INTENT_EDIT_NOTE, options.toBundle());"> 427             ActivityCompat.startActivityForResult(getActivity(), editNoteIntent, Simplenote.INTENT_EDIT_NðŸ”µ</abbr>
 428         }
 429 
 430         mActivatedPosition = position;
 431 
 432         mTracker.send(
 433                 new HitBuilders.EventBuilder()
 434                         .setCategory(&quot;note&quot;)
 435                         .setAction(&quot;viewed_note&quot;)
 436                         .setLabel(&quot;note_list_row_tap&quot;)
 437                         .build()
 438         );
 439     }
 440 
 441     /**
 442      * Selects first row in the list if available
 443      */
 444     public void selectFirstNote() {
 445         if (mNotesAdapter.getCount() &gt; 0) {
 446             Note selectedNote = mNotesAdapter.getItem(0);
 447             mCallbacks.onNoteSelected(selectedNote.getSimperiumKey(), 0, false, null);
 448         }
 449     }
 450 
 451     @Override
 452     public void onSaveInstanceState(Bundle outState) {
 453         super.onSaveInstanceState(outState);
 454         if (mActivatedPosition != ListView.INVALID_POSITION) {
 455             // Serialize and persist the activated item position.
 456             outState.putInt(STATE_ACTIVATED_POSITION, mActivatedPosition);
 457         }
 458     }
 459 
 460 	/**
 461 	 * Turns on activate-on-click mode. When this mode is on, list items will be
 462 	 * given the &#x27;activated&#x27; state when touched.
 463 	 */
 464 	public void setActivateOnItemClick(boolean activateOnItemClick) {
 465 		// When setting CHOICE_MODE_SINGLE, ListView will automatically
 466 		// give items the &#x27;activated&#x27; state when touched.
<abbr title=" 467 		getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NONE);"> 467 		getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NOðŸ”µ</abbr>
 468 	}
 469 
 470 	public void setActivatedPosition(int position) {
 471         if (getListView() != null) {
 472             if (position == ListView.INVALID_POSITION) {
 473                 getListView().setItemChecked(mActivatedPosition, false);
 474             } else {
 475                 getListView().setItemChecked(position, true);
 476             }
 477 
 478             mActivatedPosition = position;
 479         }
 480 	}
 481 
 482     public void setDividerVisible(boolean visible) {
 483         if (visible)
 484             mDividerShadow.setVisibility(View.VISIBLE);
 485         else
 486             mDividerShadow.setVisibility(View.GONE);
 487     }
 488 
 489 	public void refreshList() {
 490         refreshList(false);
 491 	}
 492 
 493     public void refreshList(boolean fromNav) {
 494         if (mRefreshListTask != null &amp;&amp; mRefreshListTask.getStatus() != AsyncTask.Status.FINISHED)
 495             mRefreshListTask.cancel(true);
 496 
 497         mRefreshListTask = new refreshListTask();
 498         mRefreshListTask.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, fromNav);
 499     }
 500 
 501     public void refreshListFromNavSelect() {
 502         refreshList(true);
 503     }
 504 
 505     public ObjectCursor&lt;Note&gt; queryNotes(){
 506         NotesActivity notesActivity = (NotesActivity)getActivity();
 507         Query&lt;Note&gt; query = notesActivity.getSelectedTag().query();
 508 
 509         if (hasSearchQuery()) {
 510             query.where(new Query.FullTextMatch(new SearchTokenizer(mSearchString)));
 511             query.include(new Query.FullTextOffsets(&quot;match_offsets&quot;));
<abbr title=" 512             query.include(new Query.FullTextSnippet(Note.MATCHED_TITLE_INDEX_NAME, Note.TITLE_INDEX_NAME));"> 512             query.include(new Query.FullTextSnippet(Note.MATCHED_TITLE_INDEX_NAME, Note.TITLE_INDEX_NAME)ðŸ”µ</abbr>
<abbr title=" 513             query.include(new Query.FullTextSnippet(Note.MATCHED_CONTENT_INDEX_NAME, Note.CONTENT_PROPERTY));"> 513             query.include(new Query.FullTextSnippet(Note.MATCHED_CONTENT_INDEX_NAME, Note.CONTENT_PROPERTðŸ”µ</abbr>
 514             query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 515         } else {
 516             query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 517         }
 518 
 519         query.include(Note.PINNED_INDEX_NAME);
 520 
 521         sortNoteQuery(query);
 522 
 523         return query.execute();
 524     }
 525 
 526 	public void addNote() {
 527 
 528         // Prevents jarring &#x27;New note...&#x27; from showing in the list view when creating a new note
 529         NotesActivity notesActivity = (NotesActivity)getActivity();
 530         if (!DisplayUtils.isLargeLandscape(notesActivity))
 531             notesActivity.stopListeningToNotesBucket();
 532 
 533 		// Create &amp; save new note
 534 		Simplenote simplenote = (Simplenote) getActivity().getApplication();
 535 		Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 536 		Note note = notesBucket.newObject();
 537         note.setCreationDate(Calendar.getInstance());
 538         note.setModificationDate(note.getCreationDate());
 539 
 540         if (notesActivity.getSelectedTag() != null &amp;&amp; notesActivity.getSelectedTag().name != null) {
 541             String tagName = notesActivity.getSelectedTag().name;
 542             if (!tagName.equals(getString(R.string.notes)) &amp;&amp; !tagName.equals(getString(R.string.trash)))
 543                 note.setTagString(tagName);
 544         }
 545 
 546 		note.save();
 547 
 548         if (DisplayUtils.isLargeLandscape(getActivity())) {
 549             mCallbacks.onNoteSelected(note.getSimperiumKey(), 0, true, null);
 550         } else {
 551             Bundle arguments = new Bundle();
 552             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, note.getSimperiumKey());
 553             arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, true);
 554             Intent editNoteIntent = new Intent(getActivity(), NoteEditorActivity.class);
 555             editNoteIntent.putExtras(arguments);
 556 
 557             getActivity().startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 558         }
 559 	}
 560 
 561     public void setNoteSelected(String selectedNoteID) {
 562         // Loop through notes and set note selected if found
 563         ObjectCursor&lt;Note&gt; cursor = (ObjectCursor&lt;Note&gt;) mNotesAdapter.getCursor();
 564         if (cursor != null) {
 565             for (int i = 0; i &lt; cursor.getCount(); i++) {
 566                 cursor.moveToPosition(i);
 567                 String noteKey = cursor.getSimperiumKey();
 568                 if (noteKey != null &amp;&amp; noteKey.equals(selectedNoteID)) {
 569                     setActivatedPosition(i);
 570                     return;
 571                 }
 572             }
 573         }
 574 
 575         // Didn&#x27;t find the note, let&#x27;s try again after the cursor updates (see refreshListTask)
 576         mSelectedNoteId = selectedNoteID;
 577     }
 578 
 579 	public class NotesCursorAdapter extends CursorAdapter {
 580         private ObjectCursor&lt;Note&gt; mCursor;
 581 
<abbr title=" 582         private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(),"> 582         private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(ðŸ”µ</abbr>
 583             R.attr.listSearchHighlightForegroundColor, R.attr.listSearchHighlightBackgroundColor);
 584 
 585         public NotesCursorAdapter(Context context, ObjectCursor&lt;Note&gt; c, int flags) {
 586             super(context, c, flags);
 587             mCursor = c;
 588         }
 589 
 590         public void changeCursor(ObjectCursor&lt;Note&gt; cursor){
 591             mCursor = cursor;
 592             super.changeCursor(cursor);
 593         }
 594 
 595         @Override
 596         public Note getItem(int position) {
 597             mCursor.moveToPosition(position);
 598             return mCursor.getObject();
 599         }
 600 
 601         /*
 602         *  nbradbury - implemented &quot;holder pattern&quot; to boost performance with large note lists
 603         */
 604 		@Override
 605 		public View getView(int position, View view, ViewGroup parent) {
 606 
 607 			NoteViewHolder holder;
 608 			if (view == null) {
 609 				view = View.inflate(getActivity().getBaseContext(), R.layout.note_list_row, null);
 610 				holder = new NoteViewHolder();
 611 				holder.titleTextView = (TextView) view.findViewById(R.id.note_title);
 612 				holder.contentTextView = (TextView) view.findViewById(R.id.note_content);
 613 				holder.pinImageView = (ImageView) view.findViewById(R.id.note_pin);
 614 				view.setTag(holder);
 615 			} else {
 616 				holder = (NoteViewHolder) view.getTag();
 617 			}
 618 
 619             if (holder.titleTextView.getTextSize() != mTitleFontSize) {
 620                 holder.titleTextView.setTextSize(TypedValue.COMPLEX_UNIT_SP, mTitleFontSize);
 621                 holder.contentTextView.setTextSize(TypedValue.COMPLEX_UNIT_SP, mPreviewFontSize);
 622             }
 623 
 624             if (position == getListView().getCheckedItemPosition())
 625                 view.setActivated(true);
 626             else
 627                 view.setActivated(false);
 628 
 629             // for performance reasons we are going to get indexed values
 630             // from the cursor instead of instantiating the entire bucket object
 631             holder.contentTextView.setVisibility(View.VISIBLE);
 632             holder.contentTextView.setMaxLines(mNumPreviewLines);
 633             mCursor.moveToPosition(position);
 634             holder.setNoteId(mCursor.getSimperiumKey());
 635             int pinned = mCursor.getInt(mCursor.getColumnIndex(Note.PINNED_INDEX_NAME));
 636             holder.pinImageView.setVisibility(pinned == 1 ? View.VISIBLE : View.GONE);
 637 
 638             String title = mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME));
 639 
 640             if (title == null || title.equals(&quot;&quot;)) {
 641                 SpannableString untitled = new SpannableString(getString(R.string.new_note_list));
<abbr title=" 642                 untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0, untitled.length(), 0x0);"> 642                 untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0ðŸ”µ</abbr>
 643                 holder.titleTextView.setText(untitled);
 644             } else {
 645                 holder.titleTextView.setText(title);
 646             }
 647 
 648             holder.matchOffsets = null;
 649 
 650             int matchOffsetsIndex = mCursor.getColumnIndex(&quot;match_offsets&quot;);
 651             if (hasSearchQuery() &amp;&amp; matchOffsetsIndex != -1) {
 652                 title = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_TITLE_INDEX_NAME));
<abbr title=" 653                 String snippet = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_CONTENT_INDEX_NAME));"> 653                 String snippet = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_CONTENT_INDEX_NAMEðŸ”µ</abbr>
 654 
 655                 holder.matchOffsets = mCursor.getString(matchOffsetsIndex);
 656 
 657                 try {
<abbr title=" 658                     holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlighter));"> 658                     holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHðŸ”µ</abbr>
<abbr title=" 659                     holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlighter));"> 659                     holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlðŸ”µ</abbr>
 660                 } catch (NullPointerException e) {
<abbr title=" 661                     title = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME)));"> 661                     title = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEXðŸ”µ</abbr>
 662                     holder.titleTextView.setText(title);
<abbr title=" 663                     String matchedContentPreview = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME)));"> 663                     String matchedContentPreview = StrUtils.notNullStr(mCursor.getString(mCursor.getColumðŸ”µ</abbr>
 664                     holder.contentTextView.setText(matchedContentPreview);
 665                 }
 666             } else if (mNumPreviewLines &gt; 0) {
<abbr title=" 667                 String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));"> 667                 String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDðŸ”µ</abbr>
<abbr title=" 668                 if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_note_list)))"> 668                 if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_ðŸ”µ</abbr>
 669                     holder.contentTextView.setVisibility(View.GONE);
 670                 else
 671                     holder.contentTextView.setText(contentPreview);
 672             }
 673 			
 674 			return view;
 675 		}
 676 
 677         @Override
 678         public View newView(Context context, Cursor cursor, ViewGroup viewGroup) {
 679             return null;
 680         }
 681 
 682         @Override
 683         public void bindView(View view, Context context, Cursor cursor) {
 684 
 685         }
 686 
 687 	}
 688 
 689 	// view holder for NotesCursorAdapter
 690 	private static class NoteViewHolder {
 691 		TextView titleTextView;
 692 		TextView contentTextView;
 693 		ImageView pinImageView;
 694         public String matchOffsets;
 695         private String mNoteId;
 696 
 697         public void setNoteId(String noteId) {
 698             mNoteId = noteId;
 699         }
 700 
 701         public String getNoteId() {
 702             return mNoteId;
 703         }
 704 	}
 705 
 706 	public void searchNotes(String searchString) {
 707         if (!searchString.equals(mSearchString)){
 708             mSearchString = searchString;
 709             refreshList();
 710         }
 711 	}
 712 
 713     /**
 714      * Clear search and load all notes
 715      */
 716     public void clearSearch() {
 717         if (mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;)){
 718             mSearchString = null;
 719             refreshList();
 720         }
 721     }
 722 
 723     public boolean hasSearchQuery(){
 724         return mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;);
 725     }
 726 
 727     public void sortNoteQuery(Query&lt;Note&gt; noteQuery){
 728         noteQuery.order(&quot;pinned&quot;, SortType.DESCENDING);
 729 		int sortPref = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_SORT_ORDER);
 730 		switch (sortPref) {
 731         case 0:
 732             noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.DESCENDING);
 733             break;
 734 		case 1:
 735             noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.ASCENDING);
 736 			break;
 737 		case 2:
 738             noteQuery.order(Note.CREATED_INDEX_NAME, SortType.DESCENDING);
 739 			break;
 740 		case 3:
 741             noteQuery.order(Note.CREATED_INDEX_NAME, SortType.ASCENDING);
 742 			break;
 743 		case 4:
 744             noteQuery.order(Note.CONTENT_PROPERTY, SortType.ASCENDING);
 745 			break;
 746 		case 5:
 747             noteQuery.order(Note.CONTENT_PROPERTY, SortType.DESCENDING);
 748 			break;
 749 		}
 750     }
 751 
 752     private class refreshListTask extends AsyncTask&lt;Boolean, Void, ObjectCursor&lt;Note&gt;&gt; {
 753         boolean mIsFromNavSelect;
 754 
 755         @Override
 756         protected ObjectCursor&lt;Note&gt; doInBackground(Boolean ... args) {
 757             mIsFromNavSelect = args[0];
 758             return queryNotes();
 759         }
 760 
 761         @Override
 762         protected void onPostExecute(ObjectCursor&lt;Note&gt; cursor) {
 763             if (getActivity() == null || getActivity().isFinishing())
 764                 return;
 765 
<abbr title=" 766             // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error and clear the cursor"> 766             // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error anðŸ”µ</abbr>
 767             int count;
 768             try {
 769                 mNotesAdapter.changeCursor(cursor);
 770                 count = mNotesAdapter.getCount();
 771             } catch (SQLiteException e) {
 772                 count = 0;
 773                 android.util.Log.e(Simplenote.TAG, &quot;Invalid SQL statement&quot;, e);
 774                 mNotesAdapter.changeCursor(null);
 775             }
 776 
 777             NotesActivity notesActivity = (NotesActivity)getActivity();
 778             if (notesActivity != null) {
 779                 if (mIsFromNavSelect &amp;&amp; DisplayUtils.isLargeLandscape(notesActivity)) {
 780                         if (count == 0) {
 781                             notesActivity.showDetailPlaceholder();
 782                         } else {
 783                             // Select the first note
 784                             selectFirstNote();
 785                         }
 786                 }
 787                 notesActivity.updateTrashMenuItem();
 788             }
 789 
 790             if (mSelectedNoteId != null) {
 791                 setNoteSelected(mSelectedNoteId);
 792                 mSelectedNoteId = null;
 793             }
 794         }
 795     }
 796 
 797     private class trashNotesTask extends AsyncTask&lt;Void, Void, Void&gt; {
 798 
 799         List&lt;String&gt; deletedNotesIds = new ArrayList&lt;String&gt;();
 800 
 801         @Override
 802         protected Void doInBackground(Void... args) {
 803             SparseBooleanArray selectedRows = getListView().getCheckedItemPositions();
 804 
 805             // Get the checked notes and add them to the deletedNotesList
 806             // We can&#x27;t modify the note in this loop because the adapter could change
 807             List&lt;Note&gt; deletedNotesList = new ArrayList&lt;&gt;();
 808             for (int i = 0; i &lt; selectedRows.size(); i++) {
 809                 if (selectedRows.valueAt(i)) {
 810                     deletedNotesList.add(mNotesAdapter.getItem(selectedRows.keyAt(i)));
 811                 }
 812             }
 813 
 814             // Now loop through the notes list and mark them as deleted
 815             for (Note deletedNote : deletedNotesList) {
 816                 deletedNotesIds.add(deletedNote.getSimperiumKey());
 817                 deletedNote.setDeleted(!deletedNote.isDeleted());
 818                 deletedNote.setModificationDate(Calendar.getInstance());
 819                 deletedNote.save();
 820             }
 821 
 822             return null;
 823         }
 824 
 825         @Override
 826         protected void onPostExecute(Void aVoid) {
 827             NotesActivity notesActivity = ((NotesActivity) getActivity());
 828             if (notesActivity != null)
 829                 notesActivity.showUndoBarWithNoteIds(deletedNotesIds);
 830 
 831             refreshList();
 832         }
 833     }
 834 }</pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.ListFragment;
   5 import android.content.Context;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.database.Cursor;
   9 import android.database.sqlite.SQLiteException;
  10 import android.os.AsyncTask;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.preference.PreferenceManager;
  14 import android.support.annotation.NonNull;
  15 import android.support.v4.app.ActivityCompat;
  16 import android.support.v4.app.ActivityOptionsCompat;
  17 import android.text.Html;
  18 import android.text.SpannableString;
  19 import android.text.style.TextAppearanceSpan;
  20 import android.util.SparseBooleanArray;
  21 import android.util.TypedValue;
  22 import android.view.ActionMode;
  23 import android.view.LayoutInflater;
  24 import android.view.Menu;
  25 import android.view.MenuInflater;
  26 import android.view.MenuItem;
  27 import android.view.View;
  28 import android.view.ViewGroup;
  29 import android.webkit.WebSettings;
  30 import android.widget.AbsListView;
  31 import android.widget.AdapterView;
  32 import android.widget.Button;
  33 import android.widget.CursorAdapter;
  34 import android.widget.ImageView;
  35 import android.widget.LinearLayout;
  36 import android.widget.ListView;
  37 import android.widget.TextView;
  38 import android.widget.ViewSwitcher;
  39 
  40 import com.automattic.simplenote.models.Note;
  41 import com.automattic.simplenote.utils.DisplayUtils;
  42 import com.automattic.simplenote.utils.PrefUtils;
  43 import com.automattic.simplenote.utils.SearchSnippetFormatter;
  44 import com.automattic.simplenote.utils.SearchTokenizer;
  45 import com.automattic.simplenote.utils.StrUtils;
  46 import com.automattic.simplenote.utils.TextHighlighter;
  47 import com.google.android.gms.analytics.HitBuilders;
  48 import com.google.android.gms.analytics.Tracker;
  49 import com.simperium.client.Bucket;
  50 import com.simperium.client.Bucket.ObjectCursor;
  51 import com.simperium.client.Query;
  52 import com.simperium.client.Query.SortType;
  53 
  54 import java.util.ArrayList;
  55 import java.util.Calendar;
  56 import java.util.List;
  57 
  58 /**
  59  * A list fragment representing a list of Notes. This fragment also supports
  60  * tablet devices by allowing list items to be given an &#x27;activated&#x27; state upon
  61  * selection. This helps indicate which item is currently being viewed in a
  62  * {@link NoteEditorFragment}.
  63  * &lt;p&gt;
  64  * Activities containing this fragment MUST implement the {@link Callbacks}
  65  * interface.
  66  */
<abbr title="  67 public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsListView.MultiChoiceModeListener {">  67 public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsLisðŸ”µ</abbr>
  68 
  69     private ActionMode mActionMode;
  70 
  71 	protected NotesCursorAdapter mNotesAdapter;
  72     private TextView mEmptyListTextView;
  73     private LinearLayout mDividerShadow;
  74 	private int mNumPreviewLines;
  75     protected String mSearchString;
  76     private ViewSwitcher mWelcomeViewSwitcher;
  77     private String mSelectedNoteId;
  78     private refreshListTask mRefreshListTask;
  79 
  80     private int mTitleFontSize;
  81     private int mPreviewFontSize;
  82 
  83     private Tracker mTracker;
  84 
  85 	/**
  86 	 * The preferences key representing the activated item position. Only used on tablets.
  87 	 */
  88 	private static final String STATE_ACTIVATED_POSITION = &quot;activated_position&quot;;
  89     private static final String TAG_BUTTON_SIGNIN = &quot;sign_in&quot;;
  90     private static final String TAG_BUTTON_SIGNUP = &quot;sign_up&quot;;
  91 
  92 	/**
  93 	 * The fragment&#x27;s current callback object, which is notified of list item
  94 	 * clicks.
  95 	 */
  96 	private Callbacks mCallbacks = sCallbacks;
  97 
  98 	/**
  99 	 * The current activated item position. Only used on tablets.
 100 	 */
 101 	private int mActivatedPosition = ListView.INVALID_POSITION;
 102 
 103     public void setEmptyListViewClickable(boolean isClickable) {
 104         if (mEmptyListTextView != null) {
 105             mEmptyListTextView.setClickable(isClickable);
 106         }
 107     }
 108 
 109     @Override
 110     public boolean onItemLongClick(AdapterView&lt;?&gt; adapterView, View view, int position, long l) {
 111         getListView().setChoiceMode(ListView.CHOICE_MODE_MULTIPLE_MODAL);
 112         getListView().setItemChecked(position, true);
 113         if (mActionMode == null)
 114             getActivity().startActionMode(this);
 115         return true;
 116     }
 117 
 118     @Override
 119     public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 120         MenuInflater inflater = actionMode.getMenuInflater();
 121         inflater.inflate(R.menu.bulk_edit, menu);
 122         mActionMode = actionMode;
 123         return true;
 124     }
 125 
 126     @Override
 127     public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 128         return false;
 129     }
 130 
 131     @Override
 132     public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 133         if (getListView().getCheckedItemIds().length &gt; 0 &amp;&amp; item.getItemId() == R.id.menu_delete)
 134             new trashNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 135         return false;
 136     }
 137 
 138     @Override
 139     public void onDestroyActionMode(ActionMode mode) {
 140         mActionMode = null;
 141         new Handler().post(new Runnable() {
 142             @Override
 143             public void run() {
 144                 if (getActivity() != null) {
 145                     NotesActivity notesActivity = (NotesActivity) getActivity();
 146                     setActivateOnItemClick(DisplayUtils.isLargeLandscape(notesActivity));
 147                     notesActivity.showDetailPlaceholder();
 148                 }
 149             }
 150         });
 151     }
 152 
 153     @Override
<abbr title=" 154     public void onItemCheckedStateChanged(ActionMode actionMode, int position, long id, boolean checked) {"> 154     public void onItemCheckedStateChanged(ActionMode actionMode, int position, long id, boolean checked) ðŸ”µ</abbr>
 155         int checkedCount = getListView().getCheckedItemCount();
 156         if (checkedCount == 0)
 157             actionMode.setTitle(&quot;&quot;);
 158         else
<abbr title=" 159             actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, checkedCount));"> 159             actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, ðŸ”µ</abbr>
 160     }
 161 
 162     /**
 163 	 * A callback interface that all activities containing this fragment must
 164 	 * implement. This mechanism allows activities to be notified of item
 165 	 * selections.
 166 	 */
 167 	public interface Callbacks {
 168 		/**
 169 		 * Callback for when a note has been selected.
 170 		 */
 171 		public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets);
 172 	}
 173 
 174 	/**
 175 	 * A dummy implementation of the {@link Callbacks} interface that does
 176 	 * nothing. Used only when this fragment is not attached to an activity.
 177 	 */
 178 	private static Callbacks sCallbacks = new Callbacks() {
 179 		@Override
 180 		public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets) {
 181 		}
 182 	};
 183 
 184 	/**
 185 	 * Mandatory empty constructor for the fragment manager to instantiate the
 186 	 * fragment (e.g. upon screen orientation changes).
 187 	 */
 188 	public NoteListFragment() {
 189 	}
 190 
 191 	@Override
 192 	public void onCreate(Bundle savedInstanceState) {
 193 		super.onCreate(savedInstanceState);
 194 
 195 		mNotesAdapter = new NotesCursorAdapter(getActivity().getBaseContext(), null, 0);
 196 		setListAdapter(mNotesAdapter);
 197 	}
 198 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
 199 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 200 @Override</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 201     public void onActivityCreated(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 202         super.onActivityCreated(savedInstanceState);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 203 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 204     }</span>
 205 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 @Override</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207     public void onActivityCreated(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208         super.onActivityCreated(savedInstanceState);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210         Simplenote application = (Simplenote) getActivity().getApplication();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211         mTracker = application.getTracker();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212     }</span>
 213 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 214 
 215 
 216     // nbradbury - load values from preferences
 217 	protected void getPrefs() {
<abbr title=" 218         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, false);"> 218         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, falseðŸ”µ</abbr>
 219 		mNumPreviewLines = (condensedList) ? 0 : 2;
 220         mPreviewFontSize = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 18);
 221         mTitleFontSize = Math.round(mPreviewFontSize + mPreviewFontSize * 0.222f);
 222 	}
 223 
 224     @Override
 225 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"><abbr title=" 226     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)"> 226     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 227     {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 228         return inflater.inflate(R.layout.notes_list, container, false);</span>
 229 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 230     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 231     {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 232         View view = inflater.inflate(R.layout.notes_list, container, false);</span>
 233 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 234     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {"> 234     public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceSðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235         return inflater.inflate(R.layout.fragment_notes_list, container, false);</span>
 236 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS
 237     }
 238 
 239 	@Override
 240 	public void onViewCreated(View view, Bundle savedInstanceState) {
 241 		super.onViewCreated(view, savedInstanceState);
 242 
 243         NotesActivity notesActivity = (NotesActivity)getActivity();
 244 
 245         LinearLayout emptyView = (LinearLayout)view.findViewById(android.R.id.empty);
 246         emptyView.setVisibility(View.GONE);
 247         mEmptyListTextView = (TextView)view.findViewById(R.id.empty_message);
 248         mEmptyListTextView.setOnClickListener(new View.OnClickListener() {
 249             @Override
 250             public void onClick(View v) {
 251                 addNote();
 252             }
 253         });
<abbr title=" 254         setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 254         setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.fðŸ”µ</abbr>
 255         mDividerShadow = (LinearLayout)view.findViewById(R.id.divider_shadow);
 256         mWelcomeViewSwitcher = (ViewSwitcher)view.findViewById(R.id.welcome_view_switcher);
 257 
 258         TextView welcomeTextView = (TextView)view.findViewById(R.id.welcome_textview);
<abbr title=" 259         welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.use_simplenote_account) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 259         welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(ðŸ”µ</abbr>
 260         TextView laterTextView = (TextView)view.findViewById(R.id.welcome_later_textview);
<abbr title=" 261         laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_try_app) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 261         laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.strinðŸ”µ</abbr>
 262 
 263         TextView signInButton = (TextView)view.findViewById(R.id.welcome_sign_in);
 264         signInButton.setTag(TAG_BUTTON_SIGNIN);
 265         signInButton.setOnClickListener(signInClickListener);
 266         TextView signUpButton = (TextView)view.findViewById(R.id.welcome_sign_up);
 267         signUpButton.setTag(TAG_BUTTON_SIGNUP);
 268         signUpButton.setOnClickListener(signInClickListener);
 269 
 270         if (DisplayUtils.isLargeLandscape(notesActivity)) {
 271             setActivateOnItemClick(true);
 272             mDividerShadow.setVisibility(View.VISIBLE);
 273         }
 274 
 275         welcomeTextView.setOnClickListener(new View.OnClickListener() {
 276             @Override
 277             public void onClick(View v) {
 278                 mWelcomeViewSwitcher.showNext();
 279             }
 280         });
 281         laterTextView.setOnClickListener(new View.OnClickListener() {
 282             @Override
 283             public void onClick(View v) {
 284                 mWelcomeViewSwitcher.showNext();
<abbr title=" 285                 SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivity());"> 285                 SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivityðŸ”µ</abbr>
 286                 SharedPreferences.Editor editor = preferences.edit();
 287                 editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 288                 editor.apply();
 289             }
 290         });
 291 
 292         getListView().setOnItemLongClickListener(this);
 293         getListView().setMultiChoiceModeListener(this);
 294 	}
 295 
 296 	@Override
 297 	public void onAttach(Activity activity) {
 298 		super.onAttach(activity);
 299 
 300 		// Activities containing this fragment must implement its callbacks.
 301 		if (!(activity instanceof Callbacks)) {
 302 			throw new IllegalStateException(&quot;Activity must implement fragment&#x27;s callbacks.&quot;);
 303 		}
 304 
 305 		mCallbacks = (Callbacks) activity;
 306 	}
 307 
 308 	@Override
 309 	public void onResume() {
 310 		super.onResume();
 311         getPrefs();
 312 
 313         setWelcomeViewVisibility();
 314 
 315         refreshList();
 316 
 317         if (!PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_APP_TRIAL, false)) {
 318             new Handler().postDelayed(new Runnable() {
 319                 @Override
 320                 public void run() {
 321                     mWelcomeViewSwitcher.showNext();
 322                 }
 323             }, 100);
 324         }
 325 	}
 326 
 327     public void setWelcomeViewVisibility() {
 328         if (mWelcomeViewSwitcher != null &amp;&amp; getActivity() != null) {
 329             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 330             if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 331                 int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().getDisplayMetrics());"> 331                 int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResðŸ”µ</abbr>
<abbr title=" 332                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();"> 332                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutðŸ”µ</abbr>
 333                 mlp.setMargins(0, 0, 0, bottomMargin);
 334                 getListView().getEmptyView().setLayoutParams(mlp);
 335                 mWelcomeViewSwitcher.setVisibility(View.VISIBLE);
 336             } else {
 337                 mWelcomeViewSwitcher.setVisibility(View.GONE);
<abbr title=" 338                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();"> 338                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutðŸ”µ</abbr>
 339                 mlp.setMargins(0, 0, 0, 0);
 340                 getListView().getEmptyView().setLayoutParams(mlp);
 341             }
 342         }
 343     }
 344 
 345     public void hideWelcomeView() {
 346         if (mWelcomeViewSwitcher != null)
 347             mWelcomeViewSwitcher.setVisibility(View.GONE);
 348     }
 349 
 350     private Button.OnClickListener signInClickListener = new Button.OnClickListener() {
 351         @Override
 352         public void onClick(View v) {
 353             ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN));
 354         }
 355     };
 356 
 357 	@Override
 358 	public void onDetach() {
 359 		super.onDetach();
 360 
 361 		// Reset the active callbacks interface to the dummy implementation.
 362 		mCallbacks = sCallbacks;
 363 	}
 364 
 365     @Override
 366     public void onDestroy(){
 367         super.onDestroy();
 368     }
 369 
 370     public void setEmptyListMessage(String message) {
 371         if (mEmptyListTextView != null &amp;&amp; message != null)
 372             mEmptyListTextView.setText(Html.fromHtml(message));
 373     }
 374 
 375 	@Override
 376 	public void onListItemClick(ListView listView, View view, int position, long id) {
 377         if (!isAdded()) return;
 378 		super.onListItemClick(listView, view, position, id);
 379 
 380         NoteViewHolder holder = (NoteViewHolder)view.getTag();
 381         String noteID = holder.getNoteId();
 382 
 383         if (DisplayUtils.isLargeLandscape(getActivity())) {
 384             if (noteID != null) {
 385                 mCallbacks.onNoteSelected(noteID, position, false, holder.matchOffsets);
 386             }
 387         } else {
 388             Bundle arguments = new Bundle();
 389             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 390 
 391             Intent editNoteIntent = new Intent(getActivity(), NoteEditorActivity.class);
 392             editNoteIntent.putExtras(arguments);
 393 
<abbr title=" 394             ActivityOptionsCompat options = ActivityOptionsCompat.makeSceneTransitionAnimation(getActivity(), view, &quot;transition_editor&quot;);"> 394             ActivityOptionsCompat options = ActivityOptionsCompat.makeSceneTransitionAnimation(getActivitðŸ”µ</abbr>
<abbr title=" 395             ActivityCompat.startActivityForResult(getActivity(), editNoteIntent, Simplenote.INTENT_EDIT_NOTE, options.toBundle());"> 395             ActivityCompat.startActivityForResult(getActivity(), editNoteIntent, Simplenote.INTENT_EDIT_NðŸ”µ</abbr>
 396         }
 397 
 398         mActivatedPosition = position;
 399 
 400         mTracker.send(
 401                 new HitBuilders.EventBuilder()
 402                         .setCategory(&quot;note&quot;)
 403                         .setAction(&quot;viewed_note&quot;)
 404                         .setLabel(&quot;note_list_row_tap&quot;)
 405                         .build()
 406         );
 407 	}
 408 
 409     /**
 410      * Selects first row in the list if available
 411      */
 412     public void selectFirstNote() {
 413         if (mNotesAdapter.getCount() &gt; 0) {
 414             Note selectedNote = mNotesAdapter.getItem(0);
 415             mCallbacks.onNoteSelected(selectedNote.getSimperiumKey(), 0, false, null);
 416         }
 417     }
 418 
 419     @Override
 420     public void onSaveInstanceState(Bundle outState) {
 421         super.onSaveInstanceState(outState);
 422         if (mActivatedPosition != ListView.INVALID_POSITION) {
 423             // Serialize and persist the activated item position.
 424             outState.putInt(STATE_ACTIVATED_POSITION, mActivatedPosition);
 425         }
 426     }
 427 
 428 	/**
 429 	 * Turns on activate-on-click mode. When this mode is on, list items will be
 430 	 * given the &#x27;activated&#x27; state when touched.
 431 	 */
 432 	public void setActivateOnItemClick(boolean activateOnItemClick) {
 433 		// When setting CHOICE_MODE_SINGLE, ListView will automatically
 434 		// give items the &#x27;activated&#x27; state when touched.
<abbr title=" 435 		getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NONE);"> 435 		getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NOðŸ”µ</abbr>
 436 	}
 437 
 438 	public void setActivatedPosition(int position) {
 439         if (getListView() != null) {
 440             if (position == ListView.INVALID_POSITION) {
 441                 getListView().setItemChecked(mActivatedPosition, false);
 442             } else {
 443                 getListView().setItemChecked(position, true);
 444             }
 445 
 446             mActivatedPosition = position;
 447         }
 448 	}
 449 
 450     public void setDividerVisible(boolean visible) {
 451         if (visible)
 452             mDividerShadow.setVisibility(View.VISIBLE);
 453         else
 454             mDividerShadow.setVisibility(View.GONE);
 455     }
 456 
 457 	public void refreshList() {
 458         refreshList(false);
 459 	}
 460 
 461     public void refreshList(boolean fromNav) {
 462         if (mRefreshListTask != null &amp;&amp; mRefreshListTask.getStatus() != AsyncTask.Status.FINISHED)
 463             mRefreshListTask.cancel(true);
 464 
 465         mRefreshListTask = new refreshListTask();
 466         mRefreshListTask.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, fromNav);
 467     }
 468 
 469     public void refreshListFromNavSelect() {
 470         refreshList(true);
 471     }
 472 
 473     public ObjectCursor&lt;Note&gt; queryNotes(){
 474         NotesActivity notesActivity = (NotesActivity)getActivity();
 475         Query&lt;Note&gt; query = notesActivity.getSelectedTag().query();
 476 
 477         if (hasSearchQuery()) {
 478             query.where(new Query.FullTextMatch(new SearchTokenizer(mSearchString)));
 479             query.include(new Query.FullTextOffsets(&quot;match_offsets&quot;));
<abbr title=" 480             query.include(new Query.FullTextSnippet(Note.MATCHED_TITLE_INDEX_NAME, Note.TITLE_INDEX_NAME));"> 480             query.include(new Query.FullTextSnippet(Note.MATCHED_TITLE_INDEX_NAME, Note.TITLE_INDEX_NAME)ðŸ”µ</abbr>
<abbr title=" 481             query.include(new Query.FullTextSnippet(Note.MATCHED_CONTENT_INDEX_NAME, Note.CONTENT_PROPERTY));"> 481             query.include(new Query.FullTextSnippet(Note.MATCHED_CONTENT_INDEX_NAME, Note.CONTENT_PROPERTðŸ”µ</abbr>
 482             query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 483         } else {
 484             query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 485         }
 486 
 487         query.include(Note.PINNED_INDEX_NAME);
 488 
 489         sortNoteQuery(query);
 490 
 491         return query.execute();
 492     }
 493 
 494 	public void addNote() {
 495 
 496         // Prevents jarring &#x27;New note...&#x27; from showing in the list view when creating a new note
 497         NotesActivity notesActivity = (NotesActivity)getActivity();
 498         if (!DisplayUtils.isLargeLandscape(notesActivity))
 499             notesActivity.stopListeningToNotesBucket();
 500 
 501 		// Create &amp; save new note
 502 		Simplenote simplenote = (Simplenote) getActivity().getApplication();
 503 		Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 504 		Note note = notesBucket.newObject();
 505         note.setCreationDate(Calendar.getInstance());
 506         note.setModificationDate(note.getCreationDate());
 507 
 508         if (notesActivity.getSelectedTag() != null &amp;&amp; notesActivity.getSelectedTag().name != null) {
 509             String tagName = notesActivity.getSelectedTag().name;
 510             if (!tagName.equals(getString(R.string.notes)) &amp;&amp; !tagName.equals(getString(R.string.trash)))
 511                 note.setTagString(tagName);
 512         }
 513 
 514 		note.save();
 515 
 516         if (DisplayUtils.isLargeLandscape(getActivity())) {
 517             mCallbacks.onNoteSelected(note.getSimperiumKey(), 0, true, null);
 518         } else {
 519             Bundle arguments = new Bundle();
 520             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, note.getSimperiumKey());
 521             arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, true);
 522             Intent editNoteIntent = new Intent(getActivity(), NoteEditorActivity.class);
 523             editNoteIntent.putExtras(arguments);
 524 
 525             getActivity().startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 526         }
 527 	}
 528 
 529     public void setNoteSelected(String selectedNoteID) {
 530         // Loop through notes and set note selected if found
 531         ObjectCursor&lt;Note&gt; cursor = (ObjectCursor&lt;Note&gt;) mNotesAdapter.getCursor();
 532         if (cursor != null) {
 533             for (int i = 0; i &lt; cursor.getCount(); i++) {
 534                 cursor.moveToPosition(i);
 535                 String noteKey = cursor.getSimperiumKey();
 536                 if (noteKey != null &amp;&amp; noteKey.equals(selectedNoteID)) {
 537                     setActivatedPosition(i);
 538                     return;
 539                 }
 540             }
 541         }
 542 
 543         // Didn&#x27;t find the note, let&#x27;s try again after the cursor updates (see refreshListTask)
 544         mSelectedNoteId = selectedNoteID;
 545     }
 546 
 547 	public class NotesCursorAdapter extends CursorAdapter {
 548         private ObjectCursor&lt;Note&gt; mCursor;
 549 
<abbr title=" 550         private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(),"> 550         private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(ðŸ”µ</abbr>
 551             R.attr.listSearchHighlightForegroundColor, R.attr.listSearchHighlightBackgroundColor);
 552 
 553         public NotesCursorAdapter(Context context, ObjectCursor&lt;Note&gt; c, int flags) {
 554             super(context, c, flags);
 555             mCursor = c;
 556         }
 557 
 558         public void changeCursor(ObjectCursor&lt;Note&gt; cursor){
 559             mCursor = cursor;
 560             super.changeCursor(cursor);
 561         }
 562 
 563         @Override
 564         public Note getItem(int position) {
 565             mCursor.moveToPosition(position);
 566             return mCursor.getObject();
 567         }
 568 
 569         /*
 570         *  nbradbury - implemented &quot;holder pattern&quot; to boost performance with large note lists
 571         */
 572 		@Override
 573 		public View getView(int position, View view, ViewGroup parent) {
 574 
 575 			NoteViewHolder holder;
 576 			if (view == null) {
 577 				view = View.inflate(getActivity().getBaseContext(), R.layout.note_list_row, null);
 578 				holder = new NoteViewHolder();
 579 				holder.titleTextView = (TextView) view.findViewById(R.id.note_title);
 580 				holder.contentTextView = (TextView) view.findViewById(R.id.note_content);
 581 				holder.pinImageView = (ImageView) view.findViewById(R.id.note_pin);
 582 				view.setTag(holder);
 583 			} else {
 584 				holder = (NoteViewHolder) view.getTag();
 585 			}
 586 
 587             if (holder.titleTextView.getTextSize() != mTitleFontSize) {
 588                 holder.titleTextView.setTextSize(TypedValue.COMPLEX_UNIT_SP, mTitleFontSize);
 589                 holder.contentTextView.setTextSize(TypedValue.COMPLEX_UNIT_SP, mPreviewFontSize);
 590             }
 591 
 592             if (position == getListView().getCheckedItemPosition())
 593                 view.setActivated(true);
 594             else
 595                 view.setActivated(false);
 596 
 597             // for performance reasons we are going to get indexed values
 598             // from the cursor instead of instantiating the entire bucket object
 599             holder.contentTextView.setVisibility(View.VISIBLE);
 600             holder.contentTextView.setMaxLines(mNumPreviewLines);
 601             mCursor.moveToPosition(position);
 602             holder.setNoteId(mCursor.getSimperiumKey());
 603             int pinned = mCursor.getInt(mCursor.getColumnIndex(Note.PINNED_INDEX_NAME));
 604             holder.pinImageView.setVisibility(pinned == 1 ? View.VISIBLE : View.GONE);
 605 
 606             String title = mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME));
 607 
 608             if (title == null || title.equals(&quot;&quot;)) {
 609                 SpannableString untitled = new SpannableString(getString(R.string.new_note_list));
<abbr title=" 610                 untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0, untitled.length(), 0x0);"> 610                 untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0ðŸ”µ</abbr>
 611                 holder.titleTextView.setText(untitled);
 612             } else {
 613                 holder.titleTextView.setText(title);
 614             }
 615 
 616             holder.matchOffsets = null;
 617 
 618             int matchOffsetsIndex = mCursor.getColumnIndex(&quot;match_offsets&quot;);
 619             if (hasSearchQuery() &amp;&amp; matchOffsetsIndex != -1) {
 620                 title = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_TITLE_INDEX_NAME));
<abbr title=" 621                 String snippet = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_CONTENT_INDEX_NAME));"> 621                 String snippet = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_CONTENT_INDEX_NAMEðŸ”µ</abbr>
 622 
 623                 holder.matchOffsets = mCursor.getString(matchOffsetsIndex);
 624 
 625                 try {
<abbr title=" 626                     holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlighter));"> 626                     holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHðŸ”µ</abbr>
<abbr title=" 627                     holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlighter));"> 627                     holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlðŸ”µ</abbr>
 628                 } catch (NullPointerException e) {
<abbr title=" 629                     title = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME)));"> 629                     title = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEXðŸ”µ</abbr>
 630                     holder.titleTextView.setText(title);
<abbr title=" 631                     String matchedContentPreview = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME)));"> 631                     String matchedContentPreview = StrUtils.notNullStr(mCursor.getString(mCursor.getColumðŸ”µ</abbr>
 632                     holder.contentTextView.setText(matchedContentPreview);
 633                 }
 634             } else if (mNumPreviewLines &gt; 0) {
<abbr title=" 635                 String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));"> 635                 String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDðŸ”µ</abbr>
<abbr title=" 636                 if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_note_list)))"> 636                 if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_ðŸ”µ</abbr>
 637                     holder.contentTextView.setVisibility(View.GONE);
 638                 else
 639                     holder.contentTextView.setText(contentPreview);
 640             }
 641 
 642 			return view;
 643 		}
 644 
 645         @Override
 646         public View newView(Context context, Cursor cursor, ViewGroup viewGroup) {
 647             return null;
 648         }
 649 
 650         @Override
 651         public void bindView(View view, Context context, Cursor cursor) {
 652 
 653         }
 654 
 655 	}
 656 
 657 	// view holder for NotesCursorAdapter
 658 	private static class NoteViewHolder {
 659 		TextView titleTextView;
 660 		TextView contentTextView;
 661 		ImageView pinImageView;
 662         public String matchOffsets;
 663         private String mNoteId;
 664 
 665         public void setNoteId(String noteId) {
 666             mNoteId = noteId;
 667         }
 668 
 669         public String getNoteId() {
 670             return mNoteId;
 671         }
 672 	}
 673 
 674 	public void searchNotes(String searchString) {
 675         if (!searchString.equals(mSearchString)){
 676             mSearchString = searchString;
 677             refreshList();
 678         }
 679 	}
 680 
 681     /**
 682      * Clear search and load all notes
 683      */
 684     public void clearSearch() {
 685         if (mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;)){
 686             mSearchString = null;
 687             refreshList();
 688         }
 689     }
 690 
 691     public boolean hasSearchQuery(){
 692         return mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;);
 693     }
 694 
 695     public void sortNoteQuery(Query&lt;Note&gt; noteQuery){
 696         noteQuery.order(&quot;pinned&quot;, SortType.DESCENDING);
 697 		int sortPref = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_SORT_ORDER);
 698 		switch (sortPref) {
 699         case 0:
 700             noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.DESCENDING);
 701             break;
 702 		case 1:
 703             noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.ASCENDING);
 704 			break;
 705 		case 2:
 706             noteQuery.order(Note.CREATED_INDEX_NAME, SortType.DESCENDING);
 707 			break;
 708 		case 3:
 709             noteQuery.order(Note.CREATED_INDEX_NAME, SortType.ASCENDING);
 710 			break;
 711 		case 4:
 712             noteQuery.order(Note.CONTENT_PROPERTY, SortType.ASCENDING);
 713 			break;
 714 		case 5:
 715             noteQuery.order(Note.CONTENT_PROPERTY, SortType.DESCENDING);
 716 			break;
 717 		}
 718     }
 719 
 720     private class refreshListTask extends AsyncTask&lt;Boolean, Void, ObjectCursor&lt;Note&gt;&gt; {
 721         boolean mIsFromNavSelect;
 722 
 723         @Override
 724         protected ObjectCursor&lt;Note&gt; doInBackground(Boolean ... args) {
 725             mIsFromNavSelect = args[0];
 726             return queryNotes();
 727         }
 728 
 729         @Override
 730         protected void onPostExecute(ObjectCursor&lt;Note&gt; cursor) {
 731             if (getActivity() == null || getActivity().isFinishing())
 732                 return;
 733 
<abbr title=" 734             // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error and clear the cursor"> 734             // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error anðŸ”µ</abbr>
 735             int count;
 736             try {
 737                 mNotesAdapter.changeCursor(cursor);
 738                 count = mNotesAdapter.getCount();
 739             } catch (SQLiteException e) {
 740                 count = 0;
 741                 android.util.Log.e(Simplenote.TAG, &quot;Invalid SQL statement&quot;, e);
 742                 mNotesAdapter.changeCursor(null);
 743             }
 744 
 745             NotesActivity notesActivity = (NotesActivity)getActivity();
 746             if (notesActivity != null) {
 747                 if (mIsFromNavSelect &amp;&amp; DisplayUtils.isLargeLandscape(notesActivity)) {
 748                         if (count == 0) {
 749                             notesActivity.showDetailPlaceholder();
 750                         } else {
 751                             // Select the first note
 752                             selectFirstNote();
 753                         }
 754                 }
 755                 notesActivity.updateTrashMenuItem();
 756             }
 757 
 758             if (mSelectedNoteId != null) {
 759                 setNoteSelected(mSelectedNoteId);
 760                 mSelectedNoteId = null;
 761             }
 762         }
 763     }
 764 
 765     private class trashNotesTask extends AsyncTask&lt;Void, Void, Void&gt; {
 766 
 767         List&lt;String&gt; deletedNotesIds = new ArrayList&lt;String&gt;();
 768 
 769         @Override
 770         protected Void doInBackground(Void... args) {
 771             SparseBooleanArray selectedRows = getListView().getCheckedItemPositions();
 772 
 773             // Get the checked notes and add them to the deletedNotesList
 774             // We can&#x27;t modify the note in this loop because the adapter could change
 775             List&lt;Note&gt; deletedNotesList = new ArrayList&lt;&gt;();
 776             for (int i = 0; i &lt; selectedRows.size(); i++) {
 777                 if (selectedRows.valueAt(i)) {
 778                     deletedNotesList.add(mNotesAdapter.getItem(selectedRows.keyAt(i)));
 779                 }
 780             }
 781 
 782             // Now loop through the notes list and mark them as deleted
 783             for (Note deletedNote : deletedNotesList) {
 784                 deletedNotesIds.add(deletedNote.getSimperiumKey());
 785                 deletedNote.setDeleted(!deletedNote.isDeleted());
 786                 deletedNote.setModificationDate(Calendar.getInstance());
 787                 deletedNote.save();
 788             }
 789 
 790             return null;
 791         }
 792 
 793         @Override
 794         protected void onPostExecute(Void aVoid) {
 795             NotesActivity notesActivity = ((NotesActivity) getActivity());
 796             if (notesActivity != null)
 797                 notesActivity.showUndoBarWithNoteIds(deletedNotesIds);
 798 
 799             refreshList();
 800         }
 801     }
 802 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 package com.automattic.simplenote;
   2 
   3 import android.app.Activity;
   4 import android.app.ListFragment;
   5 import android.content.Context;
   6 import android.content.Intent;
   7 import android.content.SharedPreferences;
   8 import android.database.Cursor;
   9 import android.database.sqlite.SQLiteException;
  10 import android.os.AsyncTask;
  11 import android.os.Bundle;
  12 import android.os.Handler;
  13 import android.preference.PreferenceManager;
  14 import android.support.annotation.NonNull;
  15 import android.support.v4.app.ActivityCompat;
  16 import android.support.v4.app.ActivityOptionsCompat;
  17 import android.text.Html;
  18 import android.text.SpannableString;
  19 import android.text.style.TextAppearanceSpan;
  20 import android.util.SparseBooleanArray;
  21 import android.util.TypedValue;
  22 import android.view.ActionMode;
  23 import android.view.LayoutInflater;
  24 import android.view.Menu;
  25 import android.view.MenuInflater;
  26 import android.view.MenuItem;
  27 import android.view.View;
  28 import android.view.ViewGroup;
  29 import android.webkit.WebSettings;
  30 import android.widget.AbsListView;
  31 import android.widget.AdapterView;
  32 import android.widget.Button;
  33 import android.widget.CursorAdapter;
  34 import android.widget.ImageView;
  35 import android.widget.LinearLayout;
  36 import android.widget.ListView;
  37 import android.widget.TextView;
  38 import android.widget.ViewSwitcher;
  39 import com.automattic.simplenote.models.Note;
  40 import com.automattic.simplenote.utils.DisplayUtils;
  41 import com.automattic.simplenote.utils.PrefUtils;
  42 import com.automattic.simplenote.utils.SearchSnippetFormatter;
  43 import com.automattic.simplenote.utils.SearchTokenizer;
  44 import com.automattic.simplenote.utils.StrUtils;
  45 import com.automattic.simplenote.utils.TextHighlighter;
  46 import com.google.android.gms.analytics.HitBuilders;
  47 import com.google.android.gms.analytics.Tracker;
  48 import com.simperium.client.Bucket.ObjectCursor;
  49 import com.simperium.client.Bucket;
  50 import com.simperium.client.Query.SortType;
  51 import com.simperium.client.Query;
  52 import java.util.ArrayList;
  53 import java.util.Calendar;
  54 import java.util.List;
  55 
  56 
  57 /**
  58  * A list fragment representing a list of Notes. This fragment also supports
  59  * tablet devices by allowing list items to be given an &#x27;activated&#x27; state upon
  60  * selection. This helps indicate which item is currently being viewed in a
  61  * {@link NoteEditorFragment}.
  62  * &lt;p&gt;
  63  * Activities containing this fragment MUST implement the {@link Callbacks}
  64  * interface.
  65  */
<abbr title="  66 public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener , AbsListView.MultiChoiceModeListener {">  66 public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener , AbsLiðŸ”µ</abbr>
  67     private ActionMode mActionMode;
  68 
  69 protected NotesCursorAdapter mNotesAdapter;
  70 
  71     private TextView mEmptyListTextView;
  72 
  73     private LinearLayout mDividerShadow;
  74 
  75 private int mNumPreviewLines;
  76 
  77     protected String mSearchString;
  78 
  79     private ViewSwitcher mWelcomeViewSwitcher;
  80 
  81     private String mSelectedNoteId;
  82 
  83     private refreshListTask mRefreshListTask;
  84 
  85     private int mTitleFontSize;
  86 
  87     private int mPreviewFontSize;
  88 
  89     private Tracker mTracker;
  90 
  91 /**
  92  * The preferences key representing the activated item position. Only used on tablets.
  93  */
  94 private static final String STATE_ACTIVATED_POSITION = &quot;activated_position&quot;;
  95 
  96     private static final String TAG_BUTTON_SIGNIN = &quot;sign_in&quot;;
  97 
  98     private static final String TAG_BUTTON_SIGNUP = &quot;sign_up&quot;;
  99 
 100     /**
 101      * The fragment&#x27;s current callback object, which is notified of list item
 102      * clicks.
 103      */
 104     private Callbacks mCallbacks = sCallbacks;
 105 
 106 /**
 107  * The current activated item position. Only used on tablets.
 108  */
 109 private int mActivatedPosition = ListView.INVALID_POSITION;
 110 
 111     public void setEmptyListViewClickable(boolean isClickable) {
 112         if (mEmptyListTextView != null) {
 113             mEmptyListTextView.setClickable(isClickable);
 114         }
 115     }
 116 
 117     @Override
 118     public boolean onItemLongClick(AdapterView&lt;?&gt; adapterView, View view, int position, long l) {
 119         getListView().setChoiceMode(ListView.CHOICE_MODE_MULTIPLE_MODAL);
 120         getListView().setItemChecked(position, true);
 121         if (mActionMode == null)
 122             getActivity().startActionMode(this);
 123         return true;
 124     }
 125 
 126     @Override
 127     public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 128         MenuInflater inflater = actionMode.getMenuInflater();
 129         inflater.inflate(R.menu.bulk_edit, menu);
 130         mActionMode = actionMode;
 131         return true;
 132     }
 133 
 134     @Override
 135     public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 136         return false;
 137     }
 138 
 139     @Override
 140     public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 141         if (getListView().getCheckedItemIds().length &gt; 0 &amp;&amp; item.getItemId() == R.id.menu_delete)
 142             new trashNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 143         return false;
 144     }
 145 
 146     @Override
 147     public void onDestroyActionMode(ActionMode mode) {
 148         mActionMode = null;
 149         new Handler().post(new Runnable() {
 150             @Override
 151             public void run() {
 152                 if (getActivity() != null) {
 153                     NotesActivity notesActivity = ((NotesActivity) (getActivity()));
 154                     setActivateOnItemClick(DisplayUtils.isLargeLandscape(notesActivity));
 155                     notesActivity.showDetailPlaceholder();
 156                 }
 157             }
 158         });
 159     }
 160 
 161     @Override
<abbr title=" 162     public void onItemCheckedStateChanged(ActionMode actionMode, int position, long id, boolean checked) {"> 162     public void onItemCheckedStateChanged(ActionMode actionMode, int position, long id, boolean checked) ðŸ”µ</abbr>
 163         int checkedCount = getListView().getCheckedItemCount();
 164         if (checkedCount == 0)
 165             actionMode.setTitle(&quot;&quot;);
 166         else
<abbr title=" 167             actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, checkedCount));"> 167             actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, ðŸ”µ</abbr>
 168     }
 169 
 170     /**
 171     	 * A callback interface that all activities containing this fragment must
 172     	 * implement. This mechanism allows activities to be notified of item
 173     	 * selections.
 174     	 */
 175     public interface Callbacks {
 176 /**
 177  * Callback for when a note has been selected.
 178  */
<abbr title=" 179         public abstract void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets);"> 179         public abstract void onNoteSelected(String noteID, int position, boolean isNew, String matchOffseðŸ”µ</abbr>
 180     }
 181 
 182 /**
 183  * A dummy implementation of the {@link Callbacks} interface that does
 184  * nothing. Used only when this fragment is not attached to an activity.
 185  */
 186     private static Callbacks sCallbacks = new Callbacks() {
 187         @Override
 188         public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets) {
 189         }
 190     };
 191 
 192     /**
 193      * Mandatory empty constructor for the fragment manager to instantiate the
 194      * fragment (e.g. upon screen orientation changes).
 195      */
 196     public NoteListFragment() {
 197     }
 198 
 199 @Override
 200 public void onCreate(Bundle savedInstanceState) {
 201 	super.onCreate(savedInstanceState);
 202 
 203 	mNotesAdapter = new NotesCursorAdapter(getActivity().getBaseContext(), null, 0);
 204 	setListAdapter(mNotesAdapter);
 205 }
 206 
 207     // nbradbury - load values from preferences
 208     protected void getPrefs() {
<abbr title=" 209         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, false);"> 209         boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, falseðŸ”µ</abbr>
 210         mNumPreviewLines = (condensedList) ? 0 : 2;
 211         mPreviewFontSize = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 18);
 212         mTitleFontSize = Math.round(mPreviewFontSize + (mPreviewFontSize * 0.222F));
 213     }
 214 
 215     @Override
 216     public View onCreateView(@NonNull
 217     LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)
 218 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 219     {</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 220         return inflater.inflate(R.layout.notes_list, container, false);</span>
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 221 </span>
 222 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 223 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/"> 223 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
 224 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226     {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227         return inflater.inflate(R.layout.fragment_notes_list, container, false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 </span>
 229 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 230     }
 231 
 232     @Override
 233     public void onViewCreated(View view, Bundle savedInstanceState) {
 234         super.onViewCreated(view, savedInstanceState);
 235         NotesActivity notesActivity = ((NotesActivity) (getActivity()));
 236         LinearLayout emptyView = ((LinearLayout) (view.findViewById(android.R.id.empty)));
 237         emptyView.setVisibility(View.GONE);
 238         mEmptyListTextView = ((TextView) (view.findViewById(R.id.empty_message)));
 239         mEmptyListTextView.setOnClickListener(new View.OnClickListener() {
 240             @Override
 241             public void onClick(View v) {
 242                 addNote();
 243             }
 244         });
<abbr title=" 245         setEmptyListMessage(((&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here)) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot;) + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 245         setEmptyListMessage(((&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here)) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot;) + StriðŸ”µ</abbr>
 246         mDividerShadow = ((LinearLayout) (view.findViewById(R.id.divider_shadow)));
 247         mWelcomeViewSwitcher = ((ViewSwitcher) (view.findViewById(R.id.welcome_view_switcher)));
 248         TextView welcomeTextView = ((TextView) (view.findViewById(R.id.welcome_textview)));
<abbr title=" 249         welcomeTextView.setText(Html.fromHtml(((getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot;) + getString(R.string.use_simplenote_account)) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 249         welcomeTextView.setText(Html.fromHtml(((getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot;) + getStriðŸ”µ</abbr>
 250         TextView laterTextView = ((TextView) (view.findViewById(R.id.welcome_later_textview)));
<abbr title=" 251         laterTextView.setText(Html.fromHtml(((getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot;) + getString(R.string.just_try_app)) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 251         laterTextView.setText(Html.fromHtml(((getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot;) + getString(R.stðŸ”µ</abbr>
 252         TextView signInButton = ((TextView) (view.findViewById(R.id.welcome_sign_in)));
 253         signInButton.setTag(TAG_BUTTON_SIGNIN);
 254         signInButton.setOnClickListener(signInClickListener);
 255         TextView signUpButton = ((TextView) (view.findViewById(R.id.welcome_sign_up)));
 256         signUpButton.setTag(TAG_BUTTON_SIGNUP);
 257         signUpButton.setOnClickListener(signInClickListener);
 258         if (DisplayUtils.isLargeLandscape(notesActivity)) {
 259             setActivateOnItemClick(true);
 260             mDividerShadow.setVisibility(View.VISIBLE);
 261         }
 262         welcomeTextView.setOnClickListener(new View.OnClickListener() {
 263             @Override
 264             public void onClick(View v) {
 265                 mWelcomeViewSwitcher.showNext();
 266             }
 267         });
 268         laterTextView.setOnClickListener(new View.OnClickListener() {
 269             @Override
 270             public void onClick(View v) {
 271                 mWelcomeViewSwitcher.showNext();
<abbr title=" 272                 SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivity());"> 272                 SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivityðŸ”µ</abbr>
 273                 SharedPreferences.Editor editor = preferences.edit();
 274                 editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 275                 editor.apply();
 276             }
 277         });
 278         getListView().setOnItemLongClickListener(this);
 279         getListView().setMultiChoiceModeListener(this);
 280     }
 281 
 282 @Override
 283 public void onAttach(Activity activity) {
 284 	super.onAttach(activity);
 285 
 286 	// Activities containing this fragment must implement its callbacks.
 287 	if (!(activity instanceof Callbacks)) {
 288 		throw new IllegalStateException(&quot;Activity must implement fragment&#x27;s callbacks.&quot;);
 289 	}
 290 
 291 	mCallbacks = (Callbacks) activity;
 292 }
 293 
 294 @Override
 295 public void onResume() {
 296 	super.onResume();
 297        getPrefs();
 298 
 299        setWelcomeViewVisibility();
 300 
 301        refreshList();
 302 
 303        if (!PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_APP_TRIAL, false)) {
 304            new Handler().postDelayed(new Runnable() {
 305                @Override
 306                public void run() {
 307                    mWelcomeViewSwitcher.showNext();
 308                }
 309            }, 100);
 310        }
 311 }
 312 
 313     public void setWelcomeViewVisibility() {
 314         if (mWelcomeViewSwitcher != null &amp;&amp; getActivity() != null) {
 315             Simplenote currentApp = (Simplenote) getActivity().getApplication();
 316             if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 317                 int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().getDisplayMetrics());"> 317                 int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResðŸ”µ</abbr>
<abbr title=" 318                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();"> 318                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutðŸ”µ</abbr>
 319                 mlp.setMargins(0, 0, 0, bottomMargin);
 320                 getListView().getEmptyView().setLayoutParams(mlp);
 321                 mWelcomeViewSwitcher.setVisibility(View.VISIBLE);
 322             } else {
 323                 mWelcomeViewSwitcher.setVisibility(View.GONE);
<abbr title=" 324                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();"> 324                 ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutðŸ”µ</abbr>
 325                 mlp.setMargins(0, 0, 0, 0);
 326                 getListView().getEmptyView().setLayoutParams(mlp);
 327             }
 328         }
 329     }
 330 
 331     public void hideWelcomeView() {
 332         if (mWelcomeViewSwitcher != null)
 333             mWelcomeViewSwitcher.setVisibility(View.GONE);
 334     }
 335 
 336     private Button.OnClickListener signInClickListener = new Button.OnClickListener() {
 337         @Override
 338         public void onClick(View v) {
 339             ((NotesActivity) (getActivity())).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN));
 340         }
 341     };
 342 
 343 @Override
 344 public void onDetach() {
 345 	super.onDetach();
 346 
 347 	// Reset the active callbacks interface to the dummy implementation.
 348 	mCallbacks = sCallbacks;
 349 }
 350 
 351     @Override
 352     public void onDestroy(){
 353         super.onDestroy();
 354     }
 355 
 356     public void setEmptyListMessage(String message) {
 357         if (mEmptyListTextView != null &amp;&amp; message != null)
 358             mEmptyListTextView.setText(Html.fromHtml(message));
 359     }
 360 
 361     @Override
 362     public void onListItemClick(ListView listView, View view, int position, long id) {
 363         if (!isAdded()) {
 364             return;
 365         }
 366         super.onListItemClick(listView, view, position, id);
 367         NoteViewHolder holder = ((NoteViewHolder) (view.getTag()));
 368         String noteID = holder.getNoteId();
 369         if (DisplayUtils.isLargeLandscape(getActivity())) {
 370             if (noteID != null) {
 371                 mCallbacks.onNoteSelected(noteID, position, false, holder.matchOffsets);
 372             }
 373         } else {
 374             Bundle arguments = new Bundle();
 375             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);
 376             Intent editNoteIntent = new Intent(getActivity(), NoteEditorActivity.class);
 377             editNoteIntent.putExtras(arguments);
<abbr title=" 378             ActivityOptionsCompat options = ActivityOptionsCompat.makeSceneTransitionAnimation(getActivity(), view, &quot;transition_editor&quot;);"> 378             ActivityOptionsCompat options = ActivityOptionsCompat.makeSceneTransitionAnimation(getActivitðŸ”µ</abbr>
<abbr title=" 379             ActivityCompat.startActivityForResult(getActivity(), editNoteIntent, Simplenote.INTENT_EDIT_NOTE, options.toBundle());"> 379             ActivityCompat.startActivityForResult(getActivity(), editNoteIntent, Simplenote.INTENT_EDIT_NðŸ”µ</abbr>
 380         }
 381         mActivatedPosition = position;
<abbr title=" 382         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;viewed_note&quot;).setLabel(&quot;note_list_row_tap&quot;).build());"> 382         mTracker.send(new HitBuilders.EventBuilder().setCategory(&quot;note&quot;).setAction(&quot;viewed_note&quot;).setLabeðŸ”µ</abbr>
 383     }
 384 
 385     /**
 386      * Selects first row in the list if available
 387      */
 388     public void selectFirstNote() {
 389         if (mNotesAdapter.getCount() &gt; 0) {
 390             Note selectedNote = mNotesAdapter.getItem(0);
 391             mCallbacks.onNoteSelected(selectedNote.getSimperiumKey(), 0, false, null);
 392         }
 393     }
 394 
 395     @Override
 396     public void onSaveInstanceState(Bundle outState) {
 397         super.onSaveInstanceState(outState);
 398         if (mActivatedPosition != ListView.INVALID_POSITION) {
 399             // Serialize and persist the activated item position.
 400             outState.putInt(STATE_ACTIVATED_POSITION, mActivatedPosition);
 401         }
 402     }
 403 
 404 /**
 405  * Turns on activate-on-click mode. When this mode is on, list items will be
 406  * given the &#x27;activated&#x27; state when touched.
 407  */
 408 public void setActivateOnItemClick(boolean activateOnItemClick) {
 409 	// When setting CHOICE_MODE_SINGLE, ListView will automatically
 410 	// give items the &#x27;activated&#x27; state when touched.
<abbr title=" 411 	getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NONE);"> 411 	getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NONðŸ”µ</abbr>
 412 }
 413 
 414 public void setActivatedPosition(int position) {
 415        if (getListView() != null) {
 416            if (position == ListView.INVALID_POSITION) {
 417                getListView().setItemChecked(mActivatedPosition, false);
 418            } else {
 419                getListView().setItemChecked(position, true);
 420            }
 421 
 422            mActivatedPosition = position;
 423        }
 424 }
 425 
 426     public void setDividerVisible(boolean visible) {
 427         if (visible)
 428             mDividerShadow.setVisibility(View.VISIBLE);
 429         else
 430             mDividerShadow.setVisibility(View.GONE);
 431     }
 432 
 433 public void refreshList() {
 434        refreshList(false);
 435 }
 436 
 437     public void refreshList(boolean fromNav) {
 438         if (mRefreshListTask != null &amp;&amp; mRefreshListTask.getStatus() != AsyncTask.Status.FINISHED)
 439             mRefreshListTask.cancel(true);
 440 
 441         mRefreshListTask = new refreshListTask();
 442         mRefreshListTask.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, fromNav);
 443     }
 444 
 445     public void refreshListFromNavSelect() {
 446         refreshList(true);
 447     }
 448 
 449     public ObjectCursor&lt;Note&gt; queryNotes(){
 450         NotesActivity notesActivity = (NotesActivity)getActivity();
 451         Query&lt;Note&gt; query = notesActivity.getSelectedTag().query();
 452 
 453         if (hasSearchQuery()) {
 454             query.where(new Query.FullTextMatch(new SearchTokenizer(mSearchString)));
 455             query.include(new Query.FullTextOffsets(&quot;match_offsets&quot;));
<abbr title=" 456             query.include(new Query.FullTextSnippet(Note.MATCHED_TITLE_INDEX_NAME, Note.TITLE_INDEX_NAME));"> 456             query.include(new Query.FullTextSnippet(Note.MATCHED_TITLE_INDEX_NAME, Note.TITLE_INDEX_NAME)ðŸ”µ</abbr>
<abbr title=" 457             query.include(new Query.FullTextSnippet(Note.MATCHED_CONTENT_INDEX_NAME, Note.CONTENT_PROPERTY));"> 457             query.include(new Query.FullTextSnippet(Note.MATCHED_CONTENT_INDEX_NAME, Note.CONTENT_PROPERTðŸ”µ</abbr>
 458             query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 459         } else {
 460             query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 461         }
 462 
 463         query.include(Note.PINNED_INDEX_NAME);
 464 
 465         sortNoteQuery(query);
 466 
 467         return query.execute();
 468     }
 469 
 470     public void addNote() {
 471         // Prevents jarring &#x27;New note...&#x27; from showing in the list view when creating a new note
 472         NotesActivity notesActivity = ((NotesActivity) (getActivity()));
 473         if (!DisplayUtils.isLargeLandscape(notesActivity)) {
 474             notesActivity.stopListeningToNotesBucket();
 475         }
 476         // Create &amp; save new note
 477         Simplenote simplenote = ((Simplenote) (getActivity().getApplication()));
 478         Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 479         Note note = notesBucket.newObject();
 480         note.setCreationDate(Calendar.getInstance());
 481         note.setModificationDate(note.getCreationDate());
 482         if ((notesActivity.getSelectedTag() != null) &amp;&amp; (notesActivity.getSelectedTag().name != null)) {
 483             String tagName = notesActivity.getSelectedTag().name;
<abbr title=" 484             if ((!tagName.equals(getString(R.string.notes))) &amp;&amp; (!tagName.equals(getString(R.string.trash)))) {"> 484             if ((!tagName.equals(getString(R.string.notes))) &amp;&amp; (!tagName.equals(getString(R.string.trashðŸ”µ</abbr>
 485                 note.setTagString(tagName);
 486             }
 487         }
 488         note.save();
 489         if (DisplayUtils.isLargeLandscape(getActivity())) {
 490             mCallbacks.onNoteSelected(note.getSimperiumKey(), 0, true, null);
 491         } else {
 492             Bundle arguments = new Bundle();
 493             arguments.putString(NoteEditorFragment.ARG_ITEM_ID, note.getSimperiumKey());
 494             arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, true);
 495             Intent editNoteIntent = new Intent(getActivity(), NoteEditorActivity.class);
 496             editNoteIntent.putExtras(arguments);
 497             getActivity().startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);
 498         }
 499     }
 500 
 501     public void setNoteSelected(String selectedNoteID) {
 502         // Loop through notes and set note selected if found
 503         ObjectCursor&lt;Note&gt; cursor = (ObjectCursor&lt;Note&gt;) mNotesAdapter.getCursor();
 504         if (cursor != null) {
 505             for (int i = 0; i &lt; cursor.getCount(); i++) {
 506                 cursor.moveToPosition(i);
 507                 String noteKey = cursor.getSimperiumKey();
 508                 if (noteKey != null &amp;&amp; noteKey.equals(selectedNoteID)) {
 509                     setActivatedPosition(i);
 510                     return;
 511                 }
 512             }
 513         }
 514 
 515         // Didn&#x27;t find the note, let&#x27;s try again after the cursor updates (see refreshListTask)
 516         mSelectedNoteId = selectedNoteID;
 517     }
 518 
 519     public class NotesCursorAdapter extends CursorAdapter {
 520         private ObjectCursor&lt;Note&gt; mCursor;
 521 
<abbr title=" 522         private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(), R.attr.listSearchHighlightForegroundColor, R.attr.listSearchHighlightBackgroundColor);"> 522         private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(ðŸ”µ</abbr>
 523 
 524         public NotesCursorAdapter(Context context, ObjectCursor&lt;Note&gt; c, int flags) {
 525             super(context, c, flags);
 526             mCursor = c;
 527         }
 528 
 529         public void changeCursor(ObjectCursor&lt;Note&gt; cursor){
 530             mCursor = cursor;
 531             super.changeCursor(cursor);
 532         }
 533 
 534         @Override
 535         public Note getItem(int position) {
 536             mCursor.moveToPosition(position);
 537             return mCursor.getObject();
 538         }
 539 
 540         /*
 541         *  nbradbury - implemented &quot;holder pattern&quot; to boost performance with large note lists
 542         */
 543         @Override
 544         public View getView(int position, View view, ViewGroup parent) {
 545             NoteViewHolder holder;
 546             if (view == null) {
 547                 view = View.inflate(getActivity().getBaseContext(), R.layout.note_list_row, null);
 548                 holder = new NoteViewHolder();
 549                 holder.titleTextView = ((TextView) (view.findViewById(R.id.note_title)));
 550                 holder.contentTextView = ((TextView) (view.findViewById(R.id.note_content)));
 551                 holder.pinImageView = ((ImageView) (view.findViewById(R.id.note_pin)));
 552                 view.setTag(holder);
 553             } else {
 554                 holder = ((NoteViewHolder) (view.getTag()));
 555             }
 556             if (holder.titleTextView.getTextSize() != mTitleFontSize) {
 557                 holder.titleTextView.setTextSize(TypedValue.COMPLEX_UNIT_SP, mTitleFontSize);
 558                 holder.contentTextView.setTextSize(TypedValue.COMPLEX_UNIT_SP, mPreviewFontSize);
 559             }
 560             if (position == getListView().getCheckedItemPosition()) {
 561                 view.setActivated(true);
 562             } else {
 563                 view.setActivated(false);
 564             }
 565             // for performance reasons we are going to get indexed values
 566             // from the cursor instead of instantiating the entire bucket object
 567             holder.contentTextView.setVisibility(View.VISIBLE);
 568             holder.contentTextView.setMaxLines(mNumPreviewLines);
 569             mCursor.moveToPosition(position);
 570             holder.setNoteId(mCursor.getSimperiumKey());
 571             int pinned = mCursor.getInt(mCursor.getColumnIndex(Note.PINNED_INDEX_NAME));
 572             holder.pinImageView.setVisibility(pinned == 1 ? View.VISIBLE : View.GONE);
 573             String title = mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME));
 574             if ((title == null) || title.equals(&quot;&quot;)) {
 575                 SpannableString untitled = new SpannableString(getString(R.string.new_note_list));
<abbr title=" 576                 untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0, untitled.length(), 0x0);"> 576                 untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0ðŸ”µ</abbr>
 577                 holder.titleTextView.setText(untitled);
 578             } else {
 579                 holder.titleTextView.setText(title);
 580             }
 581             holder.matchOffsets = null;
 582             int matchOffsetsIndex = mCursor.getColumnIndex(&quot;match_offsets&quot;);
 583             if (hasSearchQuery() &amp;&amp; (matchOffsetsIndex != (-1))) {
 584                 title = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_TITLE_INDEX_NAME));
<abbr title=" 585                 String snippet = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_CONTENT_INDEX_NAME));"> 585                 String snippet = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_CONTENT_INDEX_NAMEðŸ”µ</abbr>
 586                 holder.matchOffsets = mCursor.getString(matchOffsetsIndex);
 587                 try {
<abbr title=" 588                     holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlighter));"> 588                     holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHðŸ”µ</abbr>
<abbr title=" 589                     holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlighter));"> 589                     holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlðŸ”µ</abbr>
 590                 } catch (java.lang.NullPointerException e) {
<abbr title=" 591                     title = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME)));"> 591                     title = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEXðŸ”µ</abbr>
 592                     holder.titleTextView.setText(title);
<abbr title=" 593                     String matchedContentPreview = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME)));"> 593                     String matchedContentPreview = StrUtils.notNullStr(mCursor.getString(mCursor.getColumðŸ”µ</abbr>
 594                     holder.contentTextView.setText(matchedContentPreview);
 595                 }
 596             } else if (mNumPreviewLines &gt; 0) {
<abbr title=" 597                 String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));"> 597                 String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDðŸ”µ</abbr>
<abbr title=" 598                 if (((title == null) || title.equals(contentPreview)) || title.equals(getString(R.string.new_note_list))) {"> 598                 if (((title == null) || title.equals(contentPreview)) || title.equals(getString(R.string.ðŸ”µ</abbr>
 599                     holder.contentTextView.setVisibility(View.GONE);
 600                 } else {
 601                     holder.contentTextView.setText(contentPreview);
 602                 }
 603             }
 604             return view;
 605         }
 606 
 607         @Override
 608         public View newView(Context context, Cursor cursor, ViewGroup viewGroup) {
 609             return null;
 610         }
 611 
 612         @Override
 613         public void bindView(View view, Context context, Cursor cursor) {
 614 
 615         }
 616     }
 617 
 618     // view holder for NotesCursorAdapter
 619     private static class NoteViewHolder {
 620         TextView titleTextView;
 621 
 622         TextView contentTextView;
 623 
 624         ImageView pinImageView;
 625 
 626         public String matchOffsets;
 627 
 628         private String mNoteId;
 629 
 630         public void setNoteId(String noteId) {
 631             mNoteId = noteId;
 632         }
 633 
 634         public String getNoteId() {
 635             return mNoteId;
 636         }
 637     }
 638 
 639 public void searchNotes(String searchString) {
 640        if (!searchString.equals(mSearchString)){
 641            mSearchString = searchString;
 642            refreshList();
 643        }
 644 }
 645 
 646     /**
 647      * Clear search and load all notes
 648      */
 649     public void clearSearch() {
 650         if (mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;)){
 651             mSearchString = null;
 652             refreshList();
 653         }
 654     }
 655 
 656     public boolean hasSearchQuery(){
 657         return mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;);
 658     }
 659 
 660     public void sortNoteQuery(Query&lt;Note&gt; noteQuery){
 661         noteQuery.order(&quot;pinned&quot;, SortType.DESCENDING);
 662     		int sortPref = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_SORT_ORDER);
 663     		switch (sortPref) {
 664         case 0:
 665             noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.DESCENDING);
 666             break;
 667     		case 1:
 668             noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.ASCENDING);
 669     			break;
 670     		case 2:
 671             noteQuery.order(Note.CREATED_INDEX_NAME, SortType.DESCENDING);
 672     			break;
 673     		case 3:
 674             noteQuery.order(Note.CREATED_INDEX_NAME, SortType.ASCENDING);
 675     			break;
 676     		case 4:
 677             noteQuery.order(Note.CONTENT_PROPERTY, SortType.ASCENDING);
 678     			break;
 679     		case 5:
 680             noteQuery.order(Note.CONTENT_PROPERTY, SortType.DESCENDING);
 681     			break;
 682     		}
 683     }
 684 
 685     private class refreshListTask extends AsyncTask&lt;Boolean, Void, ObjectCursor&lt;Note&gt;&gt; {
 686         boolean mIsFromNavSelect;
 687 
 688         @Override
 689         protected ObjectCursor&lt;Note&gt; doInBackground(Boolean ... args) {
 690             mIsFromNavSelect = args[0];
 691             return queryNotes();
 692         }
 693 
 694         @Override
 695         protected void onPostExecute(ObjectCursor&lt;Note&gt; cursor) {
 696             if ((getActivity() == null) || getActivity().isFinishing()) {
 697                 return;
 698             }
<abbr title=" 699             // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error and clear the cursor"> 699             // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error anðŸ”µ</abbr>
 700             int count;
 701             try {
 702                 mNotesAdapter.changeCursor(cursor);
 703                 count = mNotesAdapter.getCount();
 704             } catch (SQLiteException e) {
 705                 count = 0;
 706                 android.util.Log.e(Simplenote.TAG, &quot;Invalid SQL statement&quot;, e);
 707                 mNotesAdapter.changeCursor(null);
 708             }
 709             NotesActivity notesActivity = ((NotesActivity) (getActivity()));
 710             if (notesActivity != null) {
 711                 if (mIsFromNavSelect &amp;&amp; DisplayUtils.isLargeLandscape(notesActivity)) {
 712                     if (count == 0) {
 713                         notesActivity.showDetailPlaceholder();
 714                     } else {
 715                         // Select the first note
 716                         selectFirstNote();
 717                     }
 718                 }
 719                 notesActivity.updateTrashMenuItem();
 720             }
 721             if (mSelectedNoteId != null) {
 722                 setNoteSelected(mSelectedNoteId);
 723                 mSelectedNoteId = null;
 724             }
 725         }
 726     }
 727 
 728     private class trashNotesTask extends AsyncTask&lt;Void, Void, Void&gt; {
 729         List&lt;String&gt; deletedNotesIds = new ArrayList&lt;String&gt;();
 730 
 731         @Override
 732         protected Void doInBackground(Void... args) {
 733             SparseBooleanArray selectedRows = getListView().getCheckedItemPositions();
 734             // Get the checked notes and add them to the deletedNotesList
 735             // We can&#x27;t modify the note in this loop because the adapter could change
 736             List&lt;Note&gt; deletedNotesList = new ArrayList&lt;&gt;();
 737             for (int i = 0; i &lt; selectedRows.size(); i++) {
 738                 if (selectedRows.valueAt(i)) {
 739                     deletedNotesList.add(mNotesAdapter.getItem(selectedRows.keyAt(i)));
 740                 }
 741             }
 742             // Now loop through the notes list and mark them as deleted
 743             for (Note deletedNote : deletedNotesList) {
 744                 deletedNotesIds.add(deletedNote.getSimperiumKey());
 745                 deletedNote.setDeleted(!deletedNote.isDeleted());
 746                 deletedNote.setModificationDate(Calendar.getInstance());
 747                 deletedNote.save();
 748             }
 749             return null;
 750         }
 751 
 752         @Override
 753         protected void onPostExecute(Void aVoid) {
 754             NotesActivity notesActivity = ((NotesActivity) getActivity());
 755             if (notesActivity != null)
 756                 notesActivity.showUndoBarWithNoteIds(deletedNotesIds);
 757 
 758             refreshList();
 759         }
 760     }
 761 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.ListFragment;
   5  import android.content.Context;

   6  import android.content.SharedPreferences;
   7  import android.database.Cursor;
   8  import android.database.sqlite.SQLiteException;
   9  import android.os.AsyncTask;
  10  import android.os.Bundle;
  11  import android.os.Handler;
  12  import android.preference.PreferenceManager;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 +import android.support.annotation.NonNull;</span>


  14  import android.text.Html;
  15  import android.text.SpannableString;
  16  import android.text.style.TextAppearanceSpan;
  17  import android.util.SparseBooleanArray;
  18  import android.util.TypedValue;
  19  import android.view.ActionMode;
  20  import android.view.LayoutInflater;
  21  import android.view.Menu;
  22  import android.view.MenuInflater;
  23  import android.view.MenuItem;
  24  import android.view.View;
  25  import android.view.ViewGroup;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  26 +import android.webkit.WebSettings;</span>
  27  import android.widget.AbsListView;
  28  import android.widget.AdapterView;
  29  import android.widget.Button;
  30  import android.widget.CursorAdapter;
  31  import android.widget.ImageView;
  32  import android.widget.LinearLayout;
  33  import android.widget.ListView;
  34  import android.widget.TextView;
  35  import android.widget.ViewSwitcher;
  36  
  37  import com.automattic.simplenote.models.Note;

  38  import com.automattic.simplenote.utils.PrefUtils;
  39  import com.automattic.simplenote.utils.SearchSnippetFormatter;
  40  import com.automattic.simplenote.utils.SearchTokenizer;
  41  import com.automattic.simplenote.utils.StrUtils;
  42  import com.automattic.simplenote.utils.TextHighlighter;


  43  import com.simperium.client.Bucket;
  44  import com.simperium.client.Bucket.ObjectCursor;
  45  import com.simperium.client.Query;
  46  import com.simperium.client.Query.SortType;
  47  
  48  import java.util.ArrayList;
  49  import java.util.Calendar;
  50  import java.util.List;
  51  
  52  /**
  53   * A list fragment representing a list of Notes. This fragment also supports
  54   * tablet devices by allowing list items to be given an &#x27;activated&#x27; state upon
  55   * selection. This helps indicate which item is currently being viewed in a
  56   * {@link NoteEditorFragment}.
  57   * &lt;p&gt;
  58   * Activities containing this fragment MUST implement the {@link Callbacks}
  59   * interface.
  60   */
<abbr title="  61  public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsListView.MultiChoiceModeListener, ActionMode.Callback {">  61  public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsListView.MulðŸ”µ</abbr>

  62  
  63      private ActionMode mActionMode;
  64  
  65  	protected NotesCursorAdapter mNotesAdapter;
  66      private TextView mEmptyListTextView;
  67      private LinearLayout mDividerShadow;
  68  	private int mNumPreviewLines;
  69      protected String mSearchString;
  70      private ViewSwitcher mWelcomeViewSwitcher;
  71      private String mSelectedNoteId;
  72      private refreshListTask mRefreshListTask;
  73  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +    private int mTitleFontSize;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  75 +    private int mPreviewFontSize;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  76 +</span>
  77  	/**
  78  	 * The preferences key representing the activated item position. Only used on tablets.
  79  	 */
  80  	private static final String STATE_ACTIVATED_POSITION = &quot;activated_position&quot;;
  81      private static final String TAG_BUTTON_SIGNIN = &quot;sign_in&quot;;
  82      private static final String TAG_BUTTON_SIGNUP = &quot;sign_up&quot;;
  83  
  84  	/**
  85  	 * The fragment&#x27;s current callback object, which is notified of list item
  86  	 * clicks.
  87  	 */
  88  	private Callbacks mCallbacks = sCallbacks;
  89  
  90  	/**
  91  	 * The current activated item position. Only used on tablets.
  92  	 */
  93  	private int mActivatedPosition = ListView.INVALID_POSITION;
  94  
  95      public void setEmptyListViewClickable(boolean isClickable) {
  96          if (mEmptyListTextView != null) {
  97              mEmptyListTextView.setClickable(isClickable);
  98          }
  99      }
 100  
 101      @Override
 102      public boolean onItemLongClick(AdapterView&lt;?&gt; adapterView, View view, int position, long l) {
 103          getListView().setChoiceMode(ListView.CHOICE_MODE_MULTIPLE_MODAL);
 104          getListView().setItemChecked(position, true);
 105          if (mActionMode == null)
 106              getActivity().startActionMode(this);
 107          return true;
 108      }
 109  
 110      @Override
 111      public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 112          MenuInflater inflater = actionMode.getMenuInflater();
 113          inflater.inflate(R.menu.bulk_edit_tags, menu);

 114          mActionMode = actionMode;
 115          return true;
 116      }
 117  
 118      @Override
 119      public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 120          return false;
 121      }
 122  
 123      @Override
 124      public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 125          if (getListView().getCheckedItemIds().length &gt; 0 &amp;&amp; item.getItemId() == R.id.menu_delete)
 126              new trashNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 127          return false;
 128      }
 129  
 130      @Override
 131      public void onDestroyActionMode(ActionMode mode) {
 132          mActionMode = null;
 133          new Handler().post(new Runnable() {
 134              @Override
 135              public void run() {
 136                  if (getActivity() != null) {
 137                      NotesActivity notesActivity = (NotesActivity) getActivity();
 138                      setActivateOnItemClick(notesActivity.isLargeScreenLandscape());

 139                      notesActivity.showDetailPlaceholder();
 140                  }
 141              }
 142          });
 143      }
 144  
 145      @Override
 146      public void onItemCheckedStateChanged(ActionMode actionMode, int position, long id, boolean checked) {
 147          int checkedCount = getListView().getCheckedItemCount();
 148          if (checkedCount == 0)
 149              actionMode.setTitle(&quot;&quot;);
 150          else
<abbr title=" 151              actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, checkedCount));"> 151              actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, checkedCoðŸ”µ</abbr>
 152      }
 153  
 154      /**
 155  	 * A callback interface that all activities containing this fragment must
 156  	 * implement. This mechanism allows activities to be notified of item
 157  	 * selections.
 158  	 */
 159  	public interface Callbacks {
 160  		/**
 161  		 * Callback for when a note has been selected.
 162  		 */
 163  		public void onNoteSelected(String noteID, boolean isNew, String matchOffsets);

 164  	}
 165  
 166  	/**
 167  	 * A dummy implementation of the {@link Callbacks} interface that does
 168  	 * nothing. Used only when this fragment is not attached to an activity.
 169  	 */
 170  	private static Callbacks sCallbacks = new Callbacks() {
 171  		@Override
 172  		public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {

 173  		}
 174  	};
 175  
 176  	/**
 177  	 * Mandatory empty constructor for the fragment manager to instantiate the
 178  	 * fragment (e.g. upon screen orientation changes).
 179  	 */
 180  	public NoteListFragment() {
 181  	}
 182  
 183  	@Override
 184  	public void onCreate(Bundle savedInstanceState) {
 185  		super.onCreate(savedInstanceState);
 186  
 187  		mNotesAdapter = new NotesCursorAdapter(getActivity().getBaseContext(), null, 0);
 188  		setListAdapter(mNotesAdapter);
 189  	}
 190  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 191 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 192 -    public void onActivityCreated(Bundle savedInstanceState) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 193 -        super.onActivityCreated(savedInstanceState);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 195 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 196 -</span>
 197      // nbradbury - load values from preferences
 198  	protected void getPrefs() {
 199          boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, false);
 200  		mNumPreviewLines = (condensedList) ? 0 : 2;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 201 -	}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 202 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 203 -    @Override</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 204 -    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +        mPreviewFontSize = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_FONT_SIZE, 18);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 206 +        mTitleFontSize = Math.round(mPreviewFontSize + mPreviewFontSize * 0.222f);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 207 +	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 208 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 209 +    @Override</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 210 +    public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span>
 211      {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 212 -        View view = inflater.inflate(R.layout.notes_list, container, false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 213 -        return view;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 214 +        return inflater.inflate(R.layout.notes_list, container, false);</span>

 215      }
 216  
 217  	@Override
 218  	public void onViewCreated(View view, Bundle savedInstanceState) {
 219  		super.onViewCreated(view, savedInstanceState);
 220  
 221          NotesActivity notesActivity = (NotesActivity)getActivity();
 222  
 223          LinearLayout emptyView = (LinearLayout)view.findViewById(android.R.id.empty);
 224          emptyView.setVisibility(View.GONE);
 225          mEmptyListTextView = (TextView)view.findViewById(R.id.empty_message);
 226          mEmptyListTextView.setOnClickListener(new View.OnClickListener() {
 227              @Override
 228              public void onClick(View v) {
 229                  addNote();
 230              }
 231          });
<abbr title=" 232          setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 232          setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getðŸ”µ</abbr>
 233          mDividerShadow = (LinearLayout)view.findViewById(R.id.divider_shadow);
 234          mWelcomeViewSwitcher = (ViewSwitcher)view.findViewById(R.id.welcome_view_switcher);
 235  
 236          TextView welcomeTextView = (TextView)view.findViewById(R.id.welcome_textview);
<abbr title=" 237          welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.use_simplenote_account) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 237          welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.ðŸ”µ</abbr>
 238          TextView laterTextView = (TextView)view.findViewById(R.id.welcome_later_textview);
<abbr title=" 239          laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_try_app) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 239          laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_trðŸ”µ</abbr>
 240  
 241          TextView signInButton = (TextView)view.findViewById(R.id.welcome_sign_in);
 242          signInButton.setTag(TAG_BUTTON_SIGNIN);
 243          signInButton.setOnClickListener(signInClickListener);
 244          TextView signUpButton = (TextView)view.findViewById(R.id.welcome_sign_up);
 245          signUpButton.setTag(TAG_BUTTON_SIGNUP);
 246          signUpButton.setOnClickListener(signInClickListener);
 247  
 248          if (notesActivity.isLargeScreenLandscape()) {

 249              setActivateOnItemClick(true);
 250              mDividerShadow.setVisibility(View.VISIBLE);
 251          }
 252  
 253          welcomeTextView.setOnClickListener(new View.OnClickListener() {
 254              @Override
 255              public void onClick(View v) {
 256                  mWelcomeViewSwitcher.showNext();
 257              }
 258          });
 259          laterTextView.setOnClickListener(new View.OnClickListener() {
 260              @Override
 261              public void onClick(View v) {
 262                  mWelcomeViewSwitcher.showNext();
 263                  SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivity());
 264                  SharedPreferences.Editor editor = preferences.edit();
 265                  editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
 266                  editor.commit();

 267              }
 268          });
 269  
 270          getListView().setOnItemLongClickListener(this);
 271          getListView().setMultiChoiceModeListener(this);
 272  	}
 273  
 274  	@Override
 275  	public void onAttach(Activity activity) {
 276  		super.onAttach(activity);
 277  
 278  		// Activities containing this fragment must implement its callbacks.
 279  		if (!(activity instanceof Callbacks)) {
 280  			throw new IllegalStateException(&quot;Activity must implement fragment&#x27;s callbacks.&quot;);
 281  		}
 282  
 283  		mCallbacks = (Callbacks) activity;
 284  	}
 285  
 286  	@Override
 287  	public void onResume() {
 288  		super.onResume();
 289          getPrefs();
 290  
 291          setWelcomeViewVisibility();
 292  
 293          refreshList();
 294  
 295          if (!PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_APP_TRIAL, false)) {
 296              new Handler().postDelayed(new Runnable() {
 297                  @Override
 298                  public void run() {
 299                      mWelcomeViewSwitcher.showNext();
 300                  }
 301              }, 100);
 302          }
 303  	}
 304  
 305      public void setWelcomeViewVisibility() {
 306          if (mWelcomeViewSwitcher != null &amp;&amp; getActivity() != null) {
 307              Simplenote currentApp = (Simplenote) getActivity().getApplication();
 308              if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 309                  int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().getDisplayMetrics());"> 309                  int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().ðŸ”µ</abbr>
 310                  ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();
 311                  mlp.setMargins(0, 0, 0, bottomMargin);
 312                  getListView().getEmptyView().setLayoutParams(mlp);
 313                  mWelcomeViewSwitcher.setVisibility(View.VISIBLE);
 314              } else {
 315                  mWelcomeViewSwitcher.setVisibility(View.GONE);
 316                  ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();
 317                  mlp.setMargins(0, 0, 0, 0);
 318                  getListView().getEmptyView().setLayoutParams(mlp);
 319              }
 320          }
 321      }
 322  
 323      public void hideWelcomeView() {
 324          if (mWelcomeViewSwitcher != null)
 325              mWelcomeViewSwitcher.setVisibility(View.GONE);
 326      }
 327  
 328      private Button.OnClickListener signInClickListener = new Button.OnClickListener() {
 329          @Override
 330          public void onClick(View v) {
<abbr title=" 331              ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? true : false);"> 331              ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? true : false)ðŸ”µ</abbr>

 332          }
 333      };
 334  
 335  	@Override
 336  	public void onDetach() {
 337  		super.onDetach();
 338  
 339  		// Reset the active callbacks interface to the dummy implementation.
 340  		mCallbacks = sCallbacks;
 341  	}
 342  
 343      @Override
 344      public void onDestroy(){
 345          super.onDestroy();
 346      }
 347  
 348      public void setEmptyListMessage(String message) {
 349          if (mEmptyListTextView != null &amp;&amp; message != null)
 350              mEmptyListTextView.setText(Html.fromHtml(message));
 351      }
 352  
 353  	@Override
 354  	public void onListItemClick(ListView listView, View view, int position, long id) {

 355  		super.onListItemClick(listView, view, position, id);
 356  
 357          NoteViewHolder holder = (NoteViewHolder)view.getTag();
 358          String noteID = holder.getNoteId();
 359          if (noteID != null)
 360              mCallbacks.onNoteSelected(noteID, false, holder.matchOffsets);















 361  
 362          mActivatedPosition = position;
 363  	}









 364  
 365      /**
 366       * Selects first row in the list if available
 367       */
 368      public void selectFirstNote() {
 369          if (mNotesAdapter.getCount() &gt; 0) {
 370              Note selectedNote = mNotesAdapter.getItem(0);
 371              mCallbacks.onNoteSelected(selectedNote.getSimperiumKey(), false, null);

 372          }
 373      }
 374  
 375      @Override
 376      public void onSaveInstanceState(Bundle outState) {
 377          super.onSaveInstanceState(outState);
 378          if (mActivatedPosition != ListView.INVALID_POSITION) {
 379              // Serialize and persist the activated item position.
 380              outState.putInt(STATE_ACTIVATED_POSITION, mActivatedPosition);
 381          }
 382      }
 383  
 384  	/**
 385  	 * Turns on activate-on-click mode. When this mode is on, list items will be
 386  	 * given the &#x27;activated&#x27; state when touched.
 387  	 */
 388  	public void setActivateOnItemClick(boolean activateOnItemClick) {
 389  		// When setting CHOICE_MODE_SINGLE, ListView will automatically
 390  		// give items the &#x27;activated&#x27; state when touched.
 391  		getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NONE);
 392  	}
 393  
 394  	public void setActivatedPosition(int position) {
 395          if (getListView() != null) {
 396              if (position == ListView.INVALID_POSITION) {
 397                  getListView().setItemChecked(mActivatedPosition, false);
 398              } else {
 399                  getListView().setItemChecked(position, true);
 400              }
 401  
 402              mActivatedPosition = position;
 403          }
 404  	}
 405  
 406      public void setDividerVisible(boolean visible) {
 407          if (visible)
 408              mDividerShadow.setVisibility(View.VISIBLE);
 409          else
 410              mDividerShadow.setVisibility(View.GONE);
 411      }
 412  
 413  	public void refreshList() {
 414          refreshList(false);
 415  	}
 416  
 417      public void refreshList(boolean fromNav) {
 418          if (mRefreshListTask != null &amp;&amp; mRefreshListTask.getStatus() != AsyncTask.Status.FINISHED)
 419              mRefreshListTask.cancel(true);
 420  
 421          mRefreshListTask = new refreshListTask();
 422          mRefreshListTask.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, fromNav);
 423      }
 424  
 425      public void refreshListFromNavSelect() {
 426          refreshList(true);
 427      }
 428  
 429      public ObjectCursor&lt;Note&gt; queryNotes(){
 430          NotesActivity notesActivity = (NotesActivity)getActivity();
 431          Query&lt;Note&gt; query = notesActivity.getSelectedTag().query();
 432  
 433          if (hasSearchQuery()) {
 434              query.where(new Query.FullTextMatch(new SearchTokenizer(mSearchString)));
 435              query.include(new Query.FullTextOffsets(&quot;match_offsets&quot;));
 436              query.include(new Query.FullTextSnippet(Note.MATCHED_TITLE_INDEX_NAME, Note.TITLE_INDEX_NAME));
 437              query.include(new Query.FullTextSnippet(Note.MATCHED_CONTENT_INDEX_NAME, Note.CONTENT_PROPERTY));
 438              query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 439          } else {
 440              query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 441          }
 442  
 443          query.include(Note.PINNED_INDEX_NAME);
 444  
 445          sortNoteQuery(query);
 446  
 447          return query.execute();
 448      }
 449  
 450  	public void addNote() {
 451  
 452          // Prevents jarring &#x27;New note...&#x27; from showing in the list view when creating a new note
 453          NotesActivity notesActivity = (NotesActivity)getActivity();
 454          if (!notesActivity.isLargeScreenLandscape())

 455              notesActivity.stopListeningToNotesBucket();
 456  
 457  		// Create &amp; save new note
 458  		Simplenote simplenote = (Simplenote) getActivity().getApplication();
 459  		Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 460  		Note note = notesBucket.newObject();
 461          note.setCreationDate(Calendar.getInstance());
 462          note.setModificationDate(note.getCreationDate());
 463  
 464          if (notesActivity.getSelectedTag() != null &amp;&amp; notesActivity.getSelectedTag().name != null) {
 465              String tagName = notesActivity.getSelectedTag().name;
 466              if (!tagName.equals(getString(R.string.notes)) &amp;&amp; !tagName.equals(getString(R.string.trash)))
 467                  note.setTagString(tagName);
 468          }
 469  
 470  		note.save();
 471  
<abbr title=" 472  		// nbradbury - call onNoteSelected() directly rather than using code below, since code below may not always select the correct note depending on user&#x27;s sort preference"> 472  		// nbradbury - call onNoteSelected() directly rather than using code below, since code below may not always seleðŸ”µ</abbr>
 473  		mCallbacks.onNoteSelected(note.getSimperiumKey(), true, null);











 474  	}
 475  
 476      public void setNoteSelected(String selectedNoteID) {
 477          // Loop through notes and set note selected if found
 478          ObjectCursor&lt;Note&gt; cursor = (ObjectCursor&lt;Note&gt;) mNotesAdapter.getCursor();
 479          if (cursor != null) {
 480              for (int i = 0; i &lt; cursor.getCount(); i++) {
 481                  cursor.moveToPosition(i);
 482                  String noteKey = cursor.getSimperiumKey();
 483                  if (noteKey != null &amp;&amp; noteKey.equals(selectedNoteID)) {
 484                      setActivatedPosition(i);
 485                      return;
 486                  }
 487              }
 488          }
 489  
 490          // Didn&#x27;t find the note, let&#x27;s try again after the cursor updates (see refreshListTask)
 491          mSelectedNoteId = selectedNoteID;
 492      }
 493  
 494  	public class NotesCursorAdapter extends CursorAdapter {
 495          private ObjectCursor&lt;Note&gt; mCursor;
 496  
 497          private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(),
 498              R.attr.listSearchHighlightForegroundColor, R.attr.listSearchHighlightBackgroundColor);
 499  
 500          public NotesCursorAdapter(Context context, ObjectCursor&lt;Note&gt; c, int flags) {
 501              super(context, c, flags);
 502              mCursor = c;
 503          }
 504  
 505          public void changeCursor(ObjectCursor&lt;Note&gt; cursor){
 506              mCursor = cursor;
 507              super.changeCursor(cursor);
 508          }
 509  
 510          @Override
 511          public Note getItem(int position) {
 512              mCursor.moveToPosition(position);
 513              return mCursor.getObject();
 514          }
 515  
 516          /*
 517          *  nbradbury - implemented &quot;holder pattern&quot; to boost performance with large note lists
 518          */
 519  		@Override
 520  		public View getView(int position, View view, ViewGroup parent) {
 521  
 522  			NoteViewHolder holder;
 523  			if (view == null) {
 524  				view = View.inflate(getActivity().getBaseContext(), R.layout.note_list_row, null);
 525  				holder = new NoteViewHolder();
 526  				holder.titleTextView = (TextView) view.findViewById(R.id.note_title);
 527  				holder.contentTextView = (TextView) view.findViewById(R.id.note_content);
 528  				holder.pinImageView = (ImageView) view.findViewById(R.id.note_pin);
 529  				view.setTag(holder);
 530  			} else {
 531  				holder = (NoteViewHolder) view.getTag();
 532  			}
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 533 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 534 +            if (holder.titleTextView.getTextSize() != mTitleFontSize) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 535 +                holder.titleTextView.setTextSize(TypedValue.COMPLEX_UNIT_SP, mTitleFontSize);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 536 +                holder.contentTextView.setTextSize(TypedValue.COMPLEX_UNIT_SP, mPreviewFontSize);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 537 +            }</span>
 538  
 539              if (position == getListView().getCheckedItemPosition())
 540                  view.setActivated(true);
 541              else
 542                  view.setActivated(false);
 543  
 544              // for performance reasons we are going to get indexed values
 545              // from the cursor instead of instantiating the entire bucket object
 546              holder.contentTextView.setVisibility(View.VISIBLE);
 547              holder.contentTextView.setMaxLines(mNumPreviewLines);
 548              mCursor.moveToPosition(position);
 549              holder.setNoteId(mCursor.getSimperiumKey());
 550              int pinned = mCursor.getInt(mCursor.getColumnIndex(Note.PINNED_INDEX_NAME));
 551              holder.pinImageView.setVisibility(pinned == 1 ? View.VISIBLE : View.GONE);
 552  
 553              String title = mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME));
 554  
 555              if (title == null || title.equals(&quot;&quot;)) {
 556                  SpannableString untitled = new SpannableString(getString(R.string.new_note_list));
<abbr title=" 557                  untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0, untitled.length(), 0x0);"> 557                  untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0, untitleðŸ”µ</abbr>
 558                  holder.titleTextView.setText(untitled);
 559              } else {
 560                  holder.titleTextView.setText(title);
 561              }
 562  
 563              holder.matchOffsets = null;
 564  
 565              int matchOffsetsIndex = mCursor.getColumnIndex(&quot;match_offsets&quot;);
 566              if (hasSearchQuery() &amp;&amp; matchOffsetsIndex != -1) {
 567                  title = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_TITLE_INDEX_NAME));
 568                  String snippet = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_CONTENT_INDEX_NAME));
 569  
 570                  holder.matchOffsets = mCursor.getString(matchOffsetsIndex);
 571  
 572                  try {
<abbr title=" 573                      holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlighter));"> 573                      holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlighteðŸ”µ</abbr>
 574                      holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlighter));
 575                  } catch (NullPointerException e) {
 576                      title = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME)));
 577                      holder.titleTextView.setText(title);
<abbr title=" 578                      String matchedContentPreview = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME)));"> 578                      String matchedContentPreview = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(NoðŸ”µ</abbr>
 579                      holder.contentTextView.setText(matchedContentPreview);
 580                  }
 581              } else if (mNumPreviewLines &gt; 0) {
<abbr title=" 582                  String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));"> 582                  String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME))ðŸ”µ</abbr>
<abbr title=" 583                  if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_note_list)))"> 583                  if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_note_listðŸ”µ</abbr>
 584                      holder.contentTextView.setVisibility(View.GONE);
 585                  else
 586                      holder.contentTextView.setText(contentPreview);
 587              }
 588  
 589  			return view;
 590  		}
 591  
 592          @Override
 593          public View newView(Context context, Cursor cursor, ViewGroup viewGroup) {
 594              return null;
 595          }
 596  
 597          @Override
 598          public void bindView(View view, Context context, Cursor cursor) {
 599  
 600          }
 601  
 602  	}
 603  
 604  	// view holder for NotesCursorAdapter
 605  	private static class NoteViewHolder {
 606  		TextView titleTextView;
 607  		TextView contentTextView;
 608  		ImageView pinImageView;
 609          public String matchOffsets;
 610          private String mNoteId;
 611  
 612          public void setNoteId(String noteId) {
 613              mNoteId = noteId;
 614          }
 615  
 616          public String getNoteId() {
 617              return mNoteId;
 618          }
 619  	}
 620  
 621  	public void searchNotes(String searchString) {
 622          if (!searchString.equals(mSearchString)){
 623              mSearchString = searchString;
 624              refreshList();
 625          }
 626  	}
 627  
 628      /**
 629       * Clear search and load all notes
 630       */
 631      public void clearSearch() {
 632          if (mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;)){
 633              mSearchString = null;
 634              refreshList();
 635          }
 636      }
 637  
 638      public boolean hasSearchQuery(){
 639          return mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;);
 640      }
 641  
 642      public void sortNoteQuery(Query&lt;Note&gt; noteQuery){
 643          noteQuery.order(&quot;pinned&quot;, SortType.DESCENDING);
 644  		int sortPref = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_SORT_ORDER);
 645  		switch (sortPref) {
 646          case 0:
 647              noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.DESCENDING);
 648              break;
 649  		case 1:
 650              noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.ASCENDING);
 651  			break;
 652  		case 2:
 653              noteQuery.order(Note.CREATED_INDEX_NAME, SortType.DESCENDING);
 654  			break;
 655  		case 3:
 656              noteQuery.order(Note.CREATED_INDEX_NAME, SortType.ASCENDING);
 657  			break;
 658  		case 4:
 659              noteQuery.order(Note.CONTENT_PROPERTY, SortType.ASCENDING);
 660  			break;
 661  		case 5:
 662              noteQuery.order(Note.CONTENT_PROPERTY, SortType.DESCENDING);
 663  			break;
 664  		}
 665      }
 666  
 667      private class refreshListTask extends AsyncTask&lt;Boolean, Void, ObjectCursor&lt;Note&gt;&gt; {
 668          boolean mIsFromNavSelect;
 669  
 670          @Override
 671          protected ObjectCursor&lt;Note&gt; doInBackground(Boolean ... args) {
 672              mIsFromNavSelect = args[0];
 673              return queryNotes();
 674          }
 675  
 676          @Override
 677          protected void onPostExecute(ObjectCursor&lt;Note&gt; cursor) {
 678              if (getActivity() == null || getActivity().isFinishing())
 679                  return;
 680  
<abbr title=" 681              // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error and clear the cursor"> 681              // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error and clear tðŸ”µ</abbr>
 682              int count = 0;

 683              try {
 684                  mNotesAdapter.changeCursor(cursor);
 685                  count = mNotesAdapter.getCount();
 686              } catch (SQLiteException e) {
 687                  count = 0;
 688                  android.util.Log.e(Simplenote.TAG, &quot;Invalid SQL statement&quot;, e);
 689                  mNotesAdapter.changeCursor(null);
 690              }
 691  
 692              NotesActivity notesActivity = (NotesActivity)getActivity();
 693              if (notesActivity != null) {
 694                  if (mIsFromNavSelect &amp;&amp; notesActivity.isLargeScreenLandscape()) {

 695                          if (count == 0) {
 696                              notesActivity.showDetailPlaceholder();
 697                          } else {
 698                              // Select the first note
 699                              selectFirstNote();
 700                          }
 701                  }
 702                  notesActivity.updateTrashMenuItem();
 703              }
 704  
 705              if (mSelectedNoteId != null) {
 706                  setNoteSelected(mSelectedNoteId);
 707                  mSelectedNoteId = null;
 708              }
 709          }
 710      }
 711  
 712      private class trashNotesTask extends AsyncTask&lt;Void, Void, Void&gt; {
 713  
 714          List&lt;String&gt; deletedNotesIds = new ArrayList&lt;String&gt;();
 715  
 716          @Override
 717          protected Void doInBackground(Void... args) {
 718              SparseBooleanArray selectedRows = getListView().getCheckedItemPositions();
 719  
 720              // Get the checked notes and add them to the deletedNotesList
 721              // We can&#x27;t modify the note in this loop because the adapter could change
 722              List&lt;Note&gt; deletedNotesList = new ArrayList&lt;Note&gt;();

 723              for (int i = 0; i &lt; selectedRows.size(); i++) {
 724                  if (selectedRows.valueAt(i)) {
 725                      deletedNotesList.add(mNotesAdapter.getItem(selectedRows.keyAt(i)));
 726                  }
 727              }
 728  
 729              // Now loop through the notes list and mark them as deleted
 730              for (Note deletedNote : deletedNotesList) {
 731                  deletedNotesIds.add(deletedNote.getSimperiumKey());
 732                  deletedNote.setDeleted(!deletedNote.isDeleted());
 733                  deletedNote.setModificationDate(Calendar.getInstance());
 734                  deletedNote.save();
 735              }
 736  
 737              return null;
 738          }
 739  
 740          @Override
 741          protected void onPostExecute(Void aVoid) {
 742              NotesActivity notesActivity = ((NotesActivity) getActivity());
 743              if (notesActivity != null)
 744                  notesActivity.showUndoBarWithNoteIds(deletedNotesIds);
 745  
 746              refreshList();
 747          }
 748      }
 749  }</pre></td>
                            <td><pre>   1  package com.automattic.simplenote;
   2  
   3  import android.app.Activity;
   4  import android.app.ListFragment;
   5  import android.content.Context;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">   6 +import android.content.Intent;</span>
   7  import android.content.SharedPreferences;
   8  import android.database.Cursor;
   9  import android.database.sqlite.SQLiteException;
  10  import android.os.AsyncTask;
  11  import android.os.Bundle;
  12  import android.os.Handler;
  13  import android.preference.PreferenceManager;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  14 +import android.support.annotation.NonNull;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  15 +import android.support.v4.app.ActivityCompat;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  16 +import android.support.v4.app.ActivityOptionsCompat;</span>
  17  import android.text.Html;
  18  import android.text.SpannableString;
  19  import android.text.style.TextAppearanceSpan;
  20  import android.util.SparseBooleanArray;
  21  import android.util.TypedValue;
  22  import android.view.ActionMode;
  23  import android.view.LayoutInflater;
  24  import android.view.Menu;
  25  import android.view.MenuInflater;
  26  import android.view.MenuItem;
  27  import android.view.View;
  28  import android.view.ViewGroup;

  29  import android.widget.AbsListView;
  30  import android.widget.AdapterView;
  31  import android.widget.Button;
  32  import android.widget.CursorAdapter;
  33  import android.widget.ImageView;
  34  import android.widget.LinearLayout;
  35  import android.widget.ListView;
  36  import android.widget.TextView;
  37  import android.widget.ViewSwitcher;
  38  
  39  import com.automattic.simplenote.models.Note;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  40 +import com.automattic.simplenote.utils.DisplayUtils;</span>
  41  import com.automattic.simplenote.utils.PrefUtils;
  42  import com.automattic.simplenote.utils.SearchSnippetFormatter;
  43  import com.automattic.simplenote.utils.SearchTokenizer;
  44  import com.automattic.simplenote.utils.StrUtils;
  45  import com.automattic.simplenote.utils.TextHighlighter;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  46 +import com.google.android.gms.analytics.HitBuilders;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  47 +import com.google.android.gms.analytics.Tracker;</span>
  48  import com.simperium.client.Bucket;
  49  import com.simperium.client.Bucket.ObjectCursor;
  50  import com.simperium.client.Query;
  51  import com.simperium.client.Query.SortType;
  52  
  53  import java.util.ArrayList;
  54  import java.util.Calendar;
  55  import java.util.List;
  56  
  57  /**
  58   * A list fragment representing a list of Notes. This fragment also supports
  59   * tablet devices by allowing list items to be given an &#x27;activated&#x27; state upon
  60   * selection. This helps indicate which item is currently being viewed in a
  61   * {@link NoteEditorFragment}.
  62   * &lt;p&gt;
  63   * Activities containing this fragment MUST implement the {@link Callbacks}
  64   * interface.
  65   */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  66 -public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsListView.MultiChoiceModeListener, ActionMode.Callback {">  66 -public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsListView.MulðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="  67 +public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsListView.MultiChoiceModeListener {">  67 +public class NoteListFragment extends ListFragment implements AdapterView.OnItemLongClickListener, AbsListView.MulðŸ”µ</abbr></span>
  68  
  69      private ActionMode mActionMode;
  70  
  71  	protected NotesCursorAdapter mNotesAdapter;
  72      private TextView mEmptyListTextView;
  73      private LinearLayout mDividerShadow;
  74  	private int mNumPreviewLines;
  75      protected String mSearchString;
  76      private ViewSwitcher mWelcomeViewSwitcher;
  77      private String mSelectedNoteId;
  78      private refreshListTask mRefreshListTask;
  79  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  80 +    private Tracker mTracker;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  81 +</span>

  82  	/**
  83  	 * The preferences key representing the activated item position. Only used on tablets.
  84  	 */
  85  	private static final String STATE_ACTIVATED_POSITION = &quot;activated_position&quot;;
  86      private static final String TAG_BUTTON_SIGNIN = &quot;sign_in&quot;;
  87      private static final String TAG_BUTTON_SIGNUP = &quot;sign_up&quot;;
  88  
  89  	/**
  90  	 * The fragment&#x27;s current callback object, which is notified of list item
  91  	 * clicks.
  92  	 */
  93  	private Callbacks mCallbacks = sCallbacks;
  94  
  95  	/**
  96  	 * The current activated item position. Only used on tablets.
  97  	 */
  98  	private int mActivatedPosition = ListView.INVALID_POSITION;
  99  
 100      public void setEmptyListViewClickable(boolean isClickable) {
 101          if (mEmptyListTextView != null) {
 102              mEmptyListTextView.setClickable(isClickable);
 103          }
 104      }
 105  
 106      @Override
 107      public boolean onItemLongClick(AdapterView&lt;?&gt; adapterView, View view, int position, long l) {
 108          getListView().setChoiceMode(ListView.CHOICE_MODE_MULTIPLE_MODAL);
 109          getListView().setItemChecked(position, true);
 110          if (mActionMode == null)
 111              getActivity().startActionMode(this);
 112          return true;
 113      }
 114  
 115      @Override
 116      public boolean onCreateActionMode(ActionMode actionMode, Menu menu) {
 117          MenuInflater inflater = actionMode.getMenuInflater();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -        inflater.inflate(R.menu.bulk_edit_tags, menu);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 119 +        inflater.inflate(R.menu.bulk_edit, menu);</span>
 120          mActionMode = actionMode;
 121          return true;
 122      }
 123  
 124      @Override
 125      public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
 126          return false;
 127      }
 128  
 129      @Override
 130      public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
 131          if (getListView().getCheckedItemIds().length &gt; 0 &amp;&amp; item.getItemId() == R.id.menu_delete)
 132              new trashNotesTask().executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
 133          return false;
 134      }
 135  
 136      @Override
 137      public void onDestroyActionMode(ActionMode mode) {
 138          mActionMode = null;
 139          new Handler().post(new Runnable() {
 140              @Override
 141              public void run() {
 142                  if (getActivity() != null) {
 143                      NotesActivity notesActivity = (NotesActivity) getActivity();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                    setActivateOnItemClick(notesActivity.isLargeScreenLandscape());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +                    setActivateOnItemClick(DisplayUtils.isLargeLandscape(notesActivity));</span>
 146                      notesActivity.showDetailPlaceholder();
 147                  }
 148              }
 149          });
 150      }
 151  
 152      @Override
 153      public void onItemCheckedStateChanged(ActionMode actionMode, int position, long id, boolean checked) {
 154          int checkedCount = getListView().getCheckedItemCount();
 155          if (checkedCount == 0)
 156              actionMode.setTitle(&quot;&quot;);
 157          else
<abbr title=" 158              actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, checkedCount));"> 158              actionMode.setTitle(getResources().getQuantityString(R.plurals.selected_notes, checkedCount, checkedCoðŸ”µ</abbr>
 159      }
 160  
 161      /**
 162  	 * A callback interface that all activities containing this fragment must
 163  	 * implement. This mechanism allows activities to be notified of item
 164  	 * selections.
 165  	 */
 166  	public interface Callbacks {
 167  		/**
 168  		 * Callback for when a note has been selected.
 169  		 */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -		public void onNoteSelected(String noteID, boolean isNew, String matchOffsets);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 171 +		public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets);</span>
 172  	}
 173  
 174  	/**
 175  	 * A dummy implementation of the {@link Callbacks} interface that does
 176  	 * nothing. Used only when this fragment is not attached to an activity.
 177  	 */
 178  	private static Callbacks sCallbacks = new Callbacks() {
 179  		@Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -		public void onNoteSelected(String noteID, boolean isNew, String matchOffsets) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 181 +		public void onNoteSelected(String noteID, int position, boolean isNew, String matchOffsets) {</span>
 182  		}
 183  	};
 184  
 185  	/**
 186  	 * Mandatory empty constructor for the fragment manager to instantiate the
 187  	 * fragment (e.g. upon screen orientation changes).
 188  	 */
 189  	public NoteListFragment() {
 190  	}
 191  
 192  	@Override
 193  	public void onCreate(Bundle savedInstanceState) {
 194  		super.onCreate(savedInstanceState);
 195  
 196  		mNotesAdapter = new NotesCursorAdapter(getActivity().getBaseContext(), null, 0);
 197  		setListAdapter(mNotesAdapter);
 198  	}
 199  
 200      @Override
 201      public void onActivityCreated(Bundle savedInstanceState) {
 202          super.onActivityCreated(savedInstanceState);
 203  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 204 +        Simplenote application = (Simplenote) getActivity().getApplication();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 205 +        mTracker = application.getTracker();</span>
 206      }
 207  
 208      // nbradbury - load values from preferences
 209  	protected void getPrefs() {
 210          boolean condensedList = PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_CONDENSED_LIST, false);
 211  		mNumPreviewLines = (condensedList) ? 0 : 2;
 212  	}
 213  
 214      @Override
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 215 -    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span>






<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 216 -    {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 217 -        View view = inflater.inflate(R.layout.notes_list, container, false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 218 -        return view;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 219 +    public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 220 +        return inflater.inflate(R.layout.fragment_notes_list, container, false);</span>
 221      }
 222  
 223  	@Override
 224  	public void onViewCreated(View view, Bundle savedInstanceState) {
 225  		super.onViewCreated(view, savedInstanceState);
 226  
 227          NotesActivity notesActivity = (NotesActivity)getActivity();
 228  
 229          LinearLayout emptyView = (LinearLayout)view.findViewById(android.R.id.empty);
 230          emptyView.setVisibility(View.GONE);
 231          mEmptyListTextView = (TextView)view.findViewById(R.id.empty_message);
 232          mEmptyListTextView.setOnClickListener(new View.OnClickListener() {
 233              @Override
 234              public void onClick(View v) {
 235                  addNote();
 236              }
 237          });
<abbr title=" 238          setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getString(R.string.why_not_create_one), &quot;&lt;u&gt;&quot;, &quot;&lt;/u&gt;&quot;));"> 238          setEmptyListMessage(&quot;&lt;strong&gt;&quot; + getString(R.string.no_notes_here) + &quot;&lt;/strong&gt;&lt;br /&gt;&quot; + String.format(getðŸ”µ</abbr>
 239          mDividerShadow = (LinearLayout)view.findViewById(R.id.divider_shadow);
 240          mWelcomeViewSwitcher = (ViewSwitcher)view.findViewById(R.id.welcome_view_switcher);
 241  
 242          TextView welcomeTextView = (TextView)view.findViewById(R.id.welcome_textview);
<abbr title=" 243          welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.use_simplenote_account) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 243          welcomeTextView.setText(Html.fromHtml(getString(R.string.welcome_want_more) + &quot; &lt;u&gt;&quot; + getString(R.string.ðŸ”µ</abbr>
 244          TextView laterTextView = (TextView)view.findViewById(R.id.welcome_later_textview);
<abbr title=" 245          laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_try_app) + &quot;&lt;/u&gt; &amp;raquo;&quot;));"> 245          laterTextView.setText(Html.fromHtml(getString(R.string.maybe_later) + &quot;, &lt;u&gt;&quot; + getString(R.string.just_trðŸ”µ</abbr>
 246  
 247          TextView signInButton = (TextView)view.findViewById(R.id.welcome_sign_in);
 248          signInButton.setTag(TAG_BUTTON_SIGNIN);
 249          signInButton.setOnClickListener(signInClickListener);
 250          TextView signUpButton = (TextView)view.findViewById(R.id.welcome_sign_up);
 251          signUpButton.setTag(TAG_BUTTON_SIGNUP);
 252          signUpButton.setOnClickListener(signInClickListener);
 253  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 254 -        if (notesActivity.isLargeScreenLandscape()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 255 +        if (DisplayUtils.isLargeLandscape(notesActivity)) {</span>
 256              setActivateOnItemClick(true);
 257              mDividerShadow.setVisibility(View.VISIBLE);
 258          }
 259  
 260          welcomeTextView.setOnClickListener(new View.OnClickListener() {
 261              @Override
 262              public void onClick(View v) {
 263                  mWelcomeViewSwitcher.showNext();
 264              }
 265          });
 266          laterTextView.setOnClickListener(new View.OnClickListener() {
 267              @Override
 268              public void onClick(View v) {
 269                  mWelcomeViewSwitcher.showNext();
 270                  SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(getActivity());
 271                  SharedPreferences.Editor editor = preferences.edit();
 272                  editor.putBoolean(PrefUtils.PREF_APP_TRIAL, true);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 273 -                editor.commit();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 274 +                editor.apply();</span>
 275              }
 276          });
 277  
 278          getListView().setOnItemLongClickListener(this);
 279          getListView().setMultiChoiceModeListener(this);
 280  	}
 281  
 282  	@Override
 283  	public void onAttach(Activity activity) {
 284  		super.onAttach(activity);
 285  
 286  		// Activities containing this fragment must implement its callbacks.
 287  		if (!(activity instanceof Callbacks)) {
 288  			throw new IllegalStateException(&quot;Activity must implement fragment&#x27;s callbacks.&quot;);
 289  		}
 290  
 291  		mCallbacks = (Callbacks) activity;
 292  	}
 293  
 294  	@Override
 295  	public void onResume() {
 296  		super.onResume();
 297          getPrefs();
 298  
 299          setWelcomeViewVisibility();
 300  
 301          refreshList();
 302  
 303          if (!PrefUtils.getBoolPref(getActivity(), PrefUtils.PREF_APP_TRIAL, false)) {
 304              new Handler().postDelayed(new Runnable() {
 305                  @Override
 306                  public void run() {
 307                      mWelcomeViewSwitcher.showNext();
 308                  }
 309              }, 100);
 310          }
 311  	}
 312  
 313      public void setWelcomeViewVisibility() {
 314          if (mWelcomeViewSwitcher != null &amp;&amp; getActivity() != null) {
 315              Simplenote currentApp = (Simplenote) getActivity().getApplication();
 316              if (currentApp.getSimperium().needsAuthorization()) {
<abbr title=" 317                  int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().getDisplayMetrics());"> 317                  int bottomMargin = (int)TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 48, getResources().ðŸ”µ</abbr>
 318                  ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();
 319                  mlp.setMargins(0, 0, 0, bottomMargin);
 320                  getListView().getEmptyView().setLayoutParams(mlp);
 321                  mWelcomeViewSwitcher.setVisibility(View.VISIBLE);
 322              } else {
 323                  mWelcomeViewSwitcher.setVisibility(View.GONE);
 324                  ViewGroup.MarginLayoutParams mlp = (ViewGroup.MarginLayoutParams) getListView().getLayoutParams();
 325                  mlp.setMargins(0, 0, 0, 0);
 326                  getListView().getEmptyView().setLayoutParams(mlp);
 327              }
 328          }
 329      }
 330  
 331      public void hideWelcomeView() {
 332          if (mWelcomeViewSwitcher != null)
 333              mWelcomeViewSwitcher.setVisibility(View.GONE);
 334      }
 335  
 336      private Button.OnClickListener signInClickListener = new Button.OnClickListener() {
 337          @Override
 338          public void onClick(View v) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 339 -            ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? true : false);"> 339 -            ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN) ? true : false)ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 340 +            ((NotesActivity)getActivity()).startLoginActivity(v.getTag().equals(TAG_BUTTON_SIGNIN));</span>
 341          }
 342      };
 343  
 344  	@Override
 345  	public void onDetach() {
 346  		super.onDetach();
 347  
 348  		// Reset the active callbacks interface to the dummy implementation.
 349  		mCallbacks = sCallbacks;
 350  	}
 351  
 352      @Override
 353      public void onDestroy(){
 354          super.onDestroy();
 355      }
 356  
 357      public void setEmptyListMessage(String message) {
 358          if (mEmptyListTextView != null &amp;&amp; message != null)
 359              mEmptyListTextView.setText(Html.fromHtml(message));
 360      }
 361  
 362  	@Override
 363  	public void onListItemClick(ListView listView, View view, int position, long id) {
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +        if (!isAdded()) return;</span>
 365  		super.onListItemClick(listView, view, position, id);
 366  
 367          NoteViewHolder holder = (NoteViewHolder)view.getTag();
 368          String noteID = holder.getNoteId();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 369 -        if (noteID != null)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 370 -            mCallbacks.onNoteSelected(noteID, false, holder.matchOffsets);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 371 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 372 +        if (DisplayUtils.isLargeLandscape(getActivity())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 373 +            if (noteID != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 374 +                mCallbacks.onNoteSelected(noteID, position, false, holder.matchOffsets);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 376 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +            Bundle arguments = new Bundle();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +            arguments.putString(NoteEditorFragment.ARG_ITEM_ID, noteID);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +            Intent editNoteIntent = new Intent(getActivity(), NoteEditorActivity.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +            editNoteIntent.putExtras(arguments);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 383 +            ActivityOptionsCompat options = ActivityOptionsCompat.makeSceneTransitionAnimation(getActivity(), view, &quot;transition_editor&quot;);"> 383 +            ActivityOptionsCompat options = ActivityOptionsCompat.makeSceneTransitionAnimation(getActivity(), viewðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title=" 384 +            ActivityCompat.startActivityForResult(getActivity(), editNoteIntent, Simplenote.INTENT_EDIT_NOTE, options.toBundle());"> 384 +            ActivityCompat.startActivityForResult(getActivity(), editNoteIntent, Simplenote.INTENT_EDIT_NOTE, optiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 385 +        }</span>
 386  
 387          mActivatedPosition = position;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 388 -	}</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 389 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 390 +        mTracker.send(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 391 +                new HitBuilders.EventBuilder()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 392 +                        .setCategory(&quot;note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 393 +                        .setAction(&quot;viewed_note&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 394 +                        .setLabel(&quot;note_list_row_tap&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 395 +                        .build()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 396 +        );</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 397 +    }</span>
 398  
 399      /**
 400       * Selects first row in the list if available
 401       */
 402      public void selectFirstNote() {
 403          if (mNotesAdapter.getCount() &gt; 0) {
 404              Note selectedNote = mNotesAdapter.getItem(0);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -            mCallbacks.onNoteSelected(selectedNote.getSimperiumKey(), false, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 406 +            mCallbacks.onNoteSelected(selectedNote.getSimperiumKey(), 0, false, null);</span>
 407          }
 408      }
 409  
 410      @Override
 411      public void onSaveInstanceState(Bundle outState) {
 412          super.onSaveInstanceState(outState);
 413          if (mActivatedPosition != ListView.INVALID_POSITION) {
 414              // Serialize and persist the activated item position.
 415              outState.putInt(STATE_ACTIVATED_POSITION, mActivatedPosition);
 416          }
 417      }
 418  
 419  	/**
 420  	 * Turns on activate-on-click mode. When this mode is on, list items will be
 421  	 * given the &#x27;activated&#x27; state when touched.
 422  	 */
 423  	public void setActivateOnItemClick(boolean activateOnItemClick) {
 424  		// When setting CHOICE_MODE_SINGLE, ListView will automatically
 425  		// give items the &#x27;activated&#x27; state when touched.
 426  		getListView().setChoiceMode(activateOnItemClick ? ListView.CHOICE_MODE_SINGLE : ListView.CHOICE_MODE_NONE);
 427  	}
 428  
 429  	public void setActivatedPosition(int position) {
 430          if (getListView() != null) {
 431              if (position == ListView.INVALID_POSITION) {
 432                  getListView().setItemChecked(mActivatedPosition, false);
 433              } else {
 434                  getListView().setItemChecked(position, true);
 435              }
 436  
 437              mActivatedPosition = position;
 438          }
 439  	}
 440  
 441      public void setDividerVisible(boolean visible) {
 442          if (visible)
 443              mDividerShadow.setVisibility(View.VISIBLE);
 444          else
 445              mDividerShadow.setVisibility(View.GONE);
 446      }
 447  
 448  	public void refreshList() {
 449          refreshList(false);
 450  	}
 451  
 452      public void refreshList(boolean fromNav) {
 453          if (mRefreshListTask != null &amp;&amp; mRefreshListTask.getStatus() != AsyncTask.Status.FINISHED)
 454              mRefreshListTask.cancel(true);
 455  
 456          mRefreshListTask = new refreshListTask();
 457          mRefreshListTask.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, fromNav);
 458      }
 459  
 460      public void refreshListFromNavSelect() {
 461          refreshList(true);
 462      }
 463  
 464      public ObjectCursor&lt;Note&gt; queryNotes(){
 465          NotesActivity notesActivity = (NotesActivity)getActivity();
 466          Query&lt;Note&gt; query = notesActivity.getSelectedTag().query();
 467  
 468          if (hasSearchQuery()) {
 469              query.where(new Query.FullTextMatch(new SearchTokenizer(mSearchString)));
 470              query.include(new Query.FullTextOffsets(&quot;match_offsets&quot;));
 471              query.include(new Query.FullTextSnippet(Note.MATCHED_TITLE_INDEX_NAME, Note.TITLE_INDEX_NAME));
 472              query.include(new Query.FullTextSnippet(Note.MATCHED_CONTENT_INDEX_NAME, Note.CONTENT_PROPERTY));
 473              query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 474          } else {
 475              query.include(Note.TITLE_INDEX_NAME, Note.CONTENT_PREVIEW_INDEX_NAME);
 476          }
 477  
 478          query.include(Note.PINNED_INDEX_NAME);
 479  
 480          sortNoteQuery(query);
 481  
 482          return query.execute();
 483      }
 484  
 485  	public void addNote() {
 486  
 487          // Prevents jarring &#x27;New note...&#x27; from showing in the list view when creating a new note
 488          NotesActivity notesActivity = (NotesActivity)getActivity();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 489 -        if (!notesActivity.isLargeScreenLandscape())</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 490 +        if (!DisplayUtils.isLargeLandscape(notesActivity))</span>
 491              notesActivity.stopListeningToNotesBucket();
 492  
 493  		// Create &amp; save new note
 494  		Simplenote simplenote = (Simplenote) getActivity().getApplication();
 495  		Bucket&lt;Note&gt; notesBucket = simplenote.getNotesBucket();
 496  		Note note = notesBucket.newObject();
 497          note.setCreationDate(Calendar.getInstance());
 498          note.setModificationDate(note.getCreationDate());
 499  
 500          if (notesActivity.getSelectedTag() != null &amp;&amp; notesActivity.getSelectedTag().name != null) {
 501              String tagName = notesActivity.getSelectedTag().name;
 502              if (!tagName.equals(getString(R.string.notes)) &amp;&amp; !tagName.equals(getString(R.string.trash)))
 503                  note.setTagString(tagName);
 504          }
 505  
 506  		note.save();
 507  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 508 -		// nbradbury - call onNoteSelected() directly rather than using code below, since code below may not always select the correct note depending on user&#x27;s sort preference"> 508 -		// nbradbury - call onNoteSelected() directly rather than using code below, since code below may not always seleðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 509 -		mCallbacks.onNoteSelected(note.getSimperiumKey(), true, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 510 +        if (DisplayUtils.isLargeLandscape(getActivity())) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 511 +            mCallbacks.onNoteSelected(note.getSimperiumKey(), 0, true, null);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 512 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 513 +            Bundle arguments = new Bundle();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 514 +            arguments.putString(NoteEditorFragment.ARG_ITEM_ID, note.getSimperiumKey());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 515 +            arguments.putBoolean(NoteEditorFragment.ARG_NEW_NOTE, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 516 +            Intent editNoteIntent = new Intent(getActivity(), NoteEditorActivity.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 517 +            editNoteIntent.putExtras(arguments);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 518 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 519 +            getActivity().startActivityForResult(editNoteIntent, Simplenote.INTENT_EDIT_NOTE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 520 +        }</span>
 521  	}
 522  
 523      public void setNoteSelected(String selectedNoteID) {
 524          // Loop through notes and set note selected if found
 525          ObjectCursor&lt;Note&gt; cursor = (ObjectCursor&lt;Note&gt;) mNotesAdapter.getCursor();
 526          if (cursor != null) {
 527              for (int i = 0; i &lt; cursor.getCount(); i++) {
 528                  cursor.moveToPosition(i);
 529                  String noteKey = cursor.getSimperiumKey();
 530                  if (noteKey != null &amp;&amp; noteKey.equals(selectedNoteID)) {
 531                      setActivatedPosition(i);
 532                      return;
 533                  }
 534              }
 535          }
 536  
 537          // Didn&#x27;t find the note, let&#x27;s try again after the cursor updates (see refreshListTask)
 538          mSelectedNoteId = selectedNoteID;
 539      }
 540  
 541  	public class NotesCursorAdapter extends CursorAdapter {
 542          private ObjectCursor&lt;Note&gt; mCursor;
 543  
 544          private SearchSnippetFormatter.SpanFactory mSnippetHighlighter = new TextHighlighter(getActivity(),
 545              R.attr.listSearchHighlightForegroundColor, R.attr.listSearchHighlightBackgroundColor);
 546  
 547          public NotesCursorAdapter(Context context, ObjectCursor&lt;Note&gt; c, int flags) {
 548              super(context, c, flags);
 549              mCursor = c;
 550          }
 551  
 552          public void changeCursor(ObjectCursor&lt;Note&gt; cursor){
 553              mCursor = cursor;
 554              super.changeCursor(cursor);
 555          }
 556  
 557          @Override
 558          public Note getItem(int position) {
 559              mCursor.moveToPosition(position);
 560              return mCursor.getObject();
 561          }
 562  
 563          /*
 564          *  nbradbury - implemented &quot;holder pattern&quot; to boost performance with large note lists
 565          */
 566  		@Override
 567  		public View getView(int position, View view, ViewGroup parent) {
 568  
 569  			NoteViewHolder holder;
 570  			if (view == null) {
 571  				view = View.inflate(getActivity().getBaseContext(), R.layout.note_list_row, null);
 572  				holder = new NoteViewHolder();
 573  				holder.titleTextView = (TextView) view.findViewById(R.id.note_title);
 574  				holder.contentTextView = (TextView) view.findViewById(R.id.note_content);
 575  				holder.pinImageView = (ImageView) view.findViewById(R.id.note_pin);
 576  				view.setTag(holder);
 577  			} else {
 578  				holder = (NoteViewHolder) view.getTag();
 579  			}





 580  
 581              if (position == getListView().getCheckedItemPosition())
 582                  view.setActivated(true);
 583              else
 584                  view.setActivated(false);
 585  
 586              // for performance reasons we are going to get indexed values
 587              // from the cursor instead of instantiating the entire bucket object
 588              holder.contentTextView.setVisibility(View.VISIBLE);
 589              holder.contentTextView.setMaxLines(mNumPreviewLines);
 590              mCursor.moveToPosition(position);
 591              holder.setNoteId(mCursor.getSimperiumKey());
 592              int pinned = mCursor.getInt(mCursor.getColumnIndex(Note.PINNED_INDEX_NAME));
 593              holder.pinImageView.setVisibility(pinned == 1 ? View.VISIBLE : View.GONE);
 594  
 595              String title = mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME));
 596  
 597              if (title == null || title.equals(&quot;&quot;)) {
 598                  SpannableString untitled = new SpannableString(getString(R.string.new_note_list));
<abbr title=" 599                  untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0, untitled.length(), 0x0);"> 599                  untitled.setSpan(new TextAppearanceSpan(getActivity(), R.style.UntitledNoteAppearance), 0, untitleðŸ”µ</abbr>
 600                  holder.titleTextView.setText(untitled);
 601              } else {
 602                  holder.titleTextView.setText(title);
 603              }
 604  
 605              holder.matchOffsets = null;
 606  
 607              int matchOffsetsIndex = mCursor.getColumnIndex(&quot;match_offsets&quot;);
 608              if (hasSearchQuery() &amp;&amp; matchOffsetsIndex != -1) {
 609                  title = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_TITLE_INDEX_NAME));
 610                  String snippet = mCursor.getString(mCursor.getColumnIndex(Note.MATCHED_CONTENT_INDEX_NAME));
 611  
 612                  holder.matchOffsets = mCursor.getString(matchOffsetsIndex);
 613  
 614                  try {
<abbr title=" 615                      holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlighter));"> 615                      holder.contentTextView.setText(SearchSnippetFormatter.formatString(snippet, mSnippetHighlighteðŸ”µ</abbr>
 616                      holder.titleTextView.setText(SearchSnippetFormatter.formatString(title, mSnippetHighlighter));
 617                  } catch (NullPointerException e) {
 618                      title = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.TITLE_INDEX_NAME)));
 619                      holder.titleTextView.setText(title);
<abbr title=" 620                      String matchedContentPreview = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME)));"> 620                      String matchedContentPreview = StrUtils.notNullStr(mCursor.getString(mCursor.getColumnIndex(NoðŸ”µ</abbr>
 621                      holder.contentTextView.setText(matchedContentPreview);
 622                  }
 623              } else if (mNumPreviewLines &gt; 0) {
<abbr title=" 624                  String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME));"> 624                  String contentPreview = mCursor.getString(mCursor.getColumnIndex(Note.CONTENT_PREVIEW_INDEX_NAME))ðŸ”µ</abbr>
<abbr title=" 625                  if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_note_list)))"> 625                  if (title == null || title.equals(contentPreview) || title.equals(getString(R.string.new_note_listðŸ”µ</abbr>
 626                      holder.contentTextView.setVisibility(View.GONE);
 627                  else
 628                      holder.contentTextView.setText(contentPreview);
 629              }
 630  
 631  			return view;
 632  		}
 633  
 634          @Override
 635          public View newView(Context context, Cursor cursor, ViewGroup viewGroup) {
 636              return null;
 637          }
 638  
 639          @Override
 640          public void bindView(View view, Context context, Cursor cursor) {
 641  
 642          }
 643  
 644  	}
 645  
 646  	// view holder for NotesCursorAdapter
 647  	private static class NoteViewHolder {
 648  		TextView titleTextView;
 649  		TextView contentTextView;
 650  		ImageView pinImageView;
 651          public String matchOffsets;
 652          private String mNoteId;
 653  
 654          public void setNoteId(String noteId) {
 655              mNoteId = noteId;
 656          }
 657  
 658          public String getNoteId() {
 659              return mNoteId;
 660          }
 661  	}
 662  
 663  	public void searchNotes(String searchString) {
 664          if (!searchString.equals(mSearchString)){
 665              mSearchString = searchString;
 666              refreshList();
 667          }
 668  	}
 669  
 670      /**
 671       * Clear search and load all notes
 672       */
 673      public void clearSearch() {
 674          if (mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;)){
 675              mSearchString = null;
 676              refreshList();
 677          }
 678      }
 679  
 680      public boolean hasSearchQuery(){
 681          return mSearchString != null &amp;&amp; !mSearchString.equals(&quot;&quot;);
 682      }
 683  
 684      public void sortNoteQuery(Query&lt;Note&gt; noteQuery){
 685          noteQuery.order(&quot;pinned&quot;, SortType.DESCENDING);
 686  		int sortPref = PrefUtils.getIntPref(getActivity(), PrefUtils.PREF_SORT_ORDER);
 687  		switch (sortPref) {
 688          case 0:
 689              noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.DESCENDING);
 690              break;
 691  		case 1:
 692              noteQuery.order(Note.MODIFIED_INDEX_NAME, SortType.ASCENDING);
 693  			break;
 694  		case 2:
 695              noteQuery.order(Note.CREATED_INDEX_NAME, SortType.DESCENDING);
 696  			break;
 697  		case 3:
 698              noteQuery.order(Note.CREATED_INDEX_NAME, SortType.ASCENDING);
 699  			break;
 700  		case 4:
 701              noteQuery.order(Note.CONTENT_PROPERTY, SortType.ASCENDING);
 702  			break;
 703  		case 5:
 704              noteQuery.order(Note.CONTENT_PROPERTY, SortType.DESCENDING);
 705  			break;
 706  		}
 707      }
 708  
 709      private class refreshListTask extends AsyncTask&lt;Boolean, Void, ObjectCursor&lt;Note&gt;&gt; {
 710          boolean mIsFromNavSelect;
 711  
 712          @Override
 713          protected ObjectCursor&lt;Note&gt; doInBackground(Boolean ... args) {
 714              mIsFromNavSelect = args[0];
 715              return queryNotes();
 716          }
 717  
 718          @Override
 719          protected void onPostExecute(ObjectCursor&lt;Note&gt; cursor) {
 720              if (getActivity() == null || getActivity().isFinishing())
 721                  return;
 722  
<abbr title=" 723              // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error and clear the cursor"> 723              // While using a Query.FullTextMatch it&#x27;s easy to enter an invalid term so catch the error and clear tðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 724 -            int count = 0;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 725 +            int count;</span>
 726              try {
 727                  mNotesAdapter.changeCursor(cursor);
 728                  count = mNotesAdapter.getCount();
 729              } catch (SQLiteException e) {
 730                  count = 0;
 731                  android.util.Log.e(Simplenote.TAG, &quot;Invalid SQL statement&quot;, e);
 732                  mNotesAdapter.changeCursor(null);
 733              }
 734  
 735              NotesActivity notesActivity = (NotesActivity)getActivity();
 736              if (notesActivity != null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 737 -                if (mIsFromNavSelect &amp;&amp; notesActivity.isLargeScreenLandscape()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 738 +                if (mIsFromNavSelect &amp;&amp; DisplayUtils.isLargeLandscape(notesActivity)) {</span>
 739                          if (count == 0) {
 740                              notesActivity.showDetailPlaceholder();
 741                          } else {
 742                              // Select the first note
 743                              selectFirstNote();
 744                          }
 745                  }
 746                  notesActivity.updateTrashMenuItem();
 747              }
 748  
 749              if (mSelectedNoteId != null) {
 750                  setNoteSelected(mSelectedNoteId);
 751                  mSelectedNoteId = null;
 752              }
 753          }
 754      }
 755  
 756      private class trashNotesTask extends AsyncTask&lt;Void, Void, Void&gt; {
 757  
 758          List&lt;String&gt; deletedNotesIds = new ArrayList&lt;String&gt;();
 759  
 760          @Override
 761          protected Void doInBackground(Void... args) {
 762              SparseBooleanArray selectedRows = getListView().getCheckedItemPositions();
 763  
 764              // Get the checked notes and add them to the deletedNotesList
 765              // We can&#x27;t modify the note in this loop because the adapter could change
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 766 -            List&lt;Note&gt; deletedNotesList = new ArrayList&lt;Note&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 767 +            List&lt;Note&gt; deletedNotesList = new ArrayList&lt;&gt;();</span>
 768              for (int i = 0; i &lt; selectedRows.size(); i++) {
 769                  if (selectedRows.valueAt(i)) {
 770                      deletedNotesList.add(mNotesAdapter.getItem(selectedRows.keyAt(i)));
 771                  }
 772              }
 773  
 774              // Now loop through the notes list and mark them as deleted
 775              for (Note deletedNote : deletedNotesList) {
 776                  deletedNotesIds.add(deletedNote.getSimperiumKey());
 777                  deletedNote.setDeleted(!deletedNote.isDeleted());
 778                  deletedNote.setModificationDate(Calendar.getInstance());
 779                  deletedNote.save();
 780              }
 781  
 782              return null;
 783          }
 784  
 785          @Override
 786          protected void onPostExecute(Void aVoid) {
 787              NotesActivity notesActivity = ((NotesActivity) getActivity());
 788              if (notesActivity != null)
 789                  notesActivity.showUndoBarWithNoteIds(deletedNotesIds);
 790  
 791              refreshList();
 792          }
 793      }
 794  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            