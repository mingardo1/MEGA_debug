<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>299</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    299
                    <a href="298.html">prev</a>
                    <a href="300.html">next</a>
                    <a href="299_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_cd7cff12a798c3a68943ad44552e25fb0f98f8d1_admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1^1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;cd7cff12a798c3a68943ad44552e25fb0f98f8d1^2:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;556ac57d12139326e76b29db4638956d93283fb1:admin/broadleaf-open-admin-platform/src/main/java/org/broadleafcommerce/openadmin/web/controller/entity/AdminBasicEntityController.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.controller.entity;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.MapUtils;
  22 import org.apache.commons.lang3.StringUtils;
  23 import org.apache.commons.logging.Log;
  24 import org.apache.commons.logging.LogFactory;
  25 import org.broadleafcommerce.common.exception.SecurityServiceException;
  26 import org.broadleafcommerce.common.exception.ServiceException;
  27 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  28 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  29 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  30 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  31 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  32 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  33 import org.broadleafcommerce.common.service.GenericEntityService;
  34 import org.broadleafcommerce.common.util.BLCArrayUtils;
  35 import org.broadleafcommerce.common.util.BLCMessageUtils;
  36 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  37 import org.broadleafcommerce.common.web.JsonResponse;
  38 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  39 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  40 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  41 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  42 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  43 import org.broadleafcommerce.openadmin.dto.ClassTree;
  44 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  45 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  46 import org.broadleafcommerce.openadmin.dto.Entity;
  47 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  48 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  49 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  50 import org.broadleafcommerce.openadmin.dto.Property;
  51 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  52 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  53 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  54 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  55 import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  56 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  57 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  58 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  59 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  60 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  61 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  61 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExteðŸ”µ</abbr>
  62 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  63 import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  64 import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  65 import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  66 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  67 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  68 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  69 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  70 import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  71 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  72 import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  73 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  74 import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  75 import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  76 import org.springframework.stereotype.Controller;
  77 import org.springframework.ui.Model;
  78 import org.springframework.util.MultiValueMap;
  79 import org.springframework.validation.BindingResult;
  80 import org.springframework.web.bind.WebDataBinder;
  81 import org.springframework.web.bind.annotation.InitBinder;
  82 import org.springframework.web.bind.annotation.ModelAttribute;
  83 import org.springframework.web.bind.annotation.PathVariable;
  84 import org.springframework.web.bind.annotation.RequestMapping;
  85 import org.springframework.web.bind.annotation.RequestMethod;
  86 import org.springframework.web.bind.annotation.RequestParam;
  87 import org.springframework.web.bind.annotation.ResponseBody;
  88 import org.springframework.web.servlet.DispatcherServlet;
  89 import org.springframework.web.servlet.FlashMap;
  90 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  91 import org.springframework.web.util.UrlPathHelper;
  92 
  93 import com.fasterxml.jackson.databind.ObjectMapper;
  94 
  95 import java.io.Serializable;
  96 import java.io.UnsupportedEncodingException;
  97 import java.net.URLDecoder;
  98 import java.util.ArrayList;
  99 import java.util.Arrays;
 100 import java.util.HashMap;
 101 import java.util.List;
 102 import java.util.Map;
 103 import java.util.Map.Entry;
 104 import java.util.Set;
 105 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0"> 106 import java.util.stream.Stream;</span>
 107 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108 import javax.servlet.http.HttpServletRequest;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 import javax.servlet.http.HttpServletResponse;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111 /**</span>
 112 =======
 113 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
 114 
 115 import javax.annotation.Resource;
 116 import javax.servlet.http.HttpServletRequest;
 117 import javax.servlet.http.HttpServletResponse;
 118 
 119 /**
 120  * The default implementation of the {@link AdminAbstractController}. This delegates every call to 
 121  * super and does not provide any custom-tailored functionality. It is responsible for rendering the
 122  * admin for every entity that is not explicitly customized by its own controller.
 123  *
 124  * @author Andre Azzolini (apazzolini)
 125  * @author Jeff Fischer
 126  */
 127 @Controller(&quot;blAdminBasicEntityController&quot;)
 128 @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 129 public class AdminBasicEntityController extends AdminAbstractController {
 130 
 131     protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 132 
 133     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 134     public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 135     public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 136 
 137     @Resource(name=&quot;blSandBoxHelper&quot;)
 138     protected SandBoxHelper sandBoxHelper;
 139 
 140     @Resource(name = &quot;blAdminUserDao&quot;)
 141     protected AdminUserDao adminUserDao;
 142 
 143     @Resource(name=&quot;blDynamicEntityDao&quot;)
 144     protected DynamicEntityDao dynamicEntityDao;
 145 
 146     @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 147     protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 148 
 149     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 150     protected RowLevelSecurityService rowLevelSecurityService;
 151     
 152     @Resource(name = &quot;blEntityDuplicator&quot;)
 153     protected EntityDuplicator duplicator;
 154     
 155     @Resource(name = &quot;blGenericEntityService&quot;)
 156     protected GenericEntityService genericEntityService;
 157 
 158     // ******************************************
 159     // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 160     // ******************************************
 161 
 162     /**
<abbr title=" 163      * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 163      * Renders the main entity listing for the specified class, which is based on the current sectionKey ðŸ”µ</abbr>
 164      * criteria.
 165      *
 166      * @param request
 167      * @param response
 168      * @param model
 169      * @param pathVars
 170      * @param requestParams a Map of property name -&gt; list critiera values
 171      * @return the return view path
 172      * @throws Exception
 173      */
 174     @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 175     public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 176             @PathVariable Map&lt;String, String&gt; pathVars,
 177             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 178         String sectionKey = getSectionKey(pathVars);
 179         String sectionClassName = getClassNameForSection(sectionKey);
 180         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 181         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 181         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 182         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 183         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 184 
 185         ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 186         listGrid.setSelectType(ListGrid.SelectType.NONE);
 187 
 188         Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 189         if (CollectionUtils.isNotEmpty(headerFields)) {
 190             Field firstField = headerFields.iterator().next();
 191             if (requestParams.containsKey(firstField.getName())) {
 192                 model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 193             }
 194         }
 195 
 196         model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 197 
 198         setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 199         model.addAttribute(&quot;listGrid&quot;, listGrid);
 200 
 201         return DEFAULT_CONTAINER_VIEW;
 202     }
 203 
<abbr title=" 204     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,"> 204     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String seðŸ”µ</abbr>
 205             String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 206         List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 207         addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 208         extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 209         extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 210 
 211         // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 212         if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 213             model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 214         }
 215 
 216         List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 217         String requestUri = request.getRequestURI();
 218         if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
<abbr title=" 219             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 219             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length())ðŸ”µ</abbr>
 220         }
 221 
 222         model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 223         model.addAttribute(&quot;currentUri&quot;, requestUri);
 224         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 225         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 226         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 227         model.addAttribute(&quot;mainActions&quot;, mainActions);
 228         setModelAttributes(model, sectionKey);
 229         setTypedEntityModelAttributes(request, model);
 230     }
 231 
 232     @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 233     public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 234              HttpServletResponse response, Model model,
 235              @PathVariable Map&lt;String, String&gt; pathVars,
 236              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 237         String sectionKey = getSectionKey(pathVars);
 238         String sectionClassName = getClassNameForSection(sectionKey);
 239         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 240         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 240         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 241                 .withCustomCriteria(getCustomCriteria(requestParams));
 242 
 243         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 244 
 245         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 246         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 247 
 248         return formService.constructSelectizeOptionMap(drs, cmd);
 249     }
 250 
 251     /**
 252      * Obtains the requested criteria parameter
 253      *
 254      * @param requestParams
 255      * @return
 256      */
 257     protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 258         if (requestParams == null || requestParams.isEmpty()) {
 259             return null;
 260         }
 261 
 262         List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 263         String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 264         return new String[] {response};
 265     }
 266 
 267     /**
<abbr title=" 268      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances"> 268      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new inðŸ”µ</abbr>
 269      * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 270      *
 271      * @param sectionClassName
 272      * @param cmd
 273      * @param mainActions
 274      */
<abbr title=" 275     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 275     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormActioðŸ”µ</abbr>
 276         if (isAddActionAllowed(sectionClassName, cmd)) {
 277             mainActions.add(DefaultMainActions.ADD);
 278         }
 279     }
 280 
 281     protected boolean isAddActionAllowed(final String sectionClassName, final ClassMetadata cmd) {
 282         // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
 283         try {
 284             adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 285         } catch (ServiceException e) {
 286             if (e instanceof SecurityServiceException) {
 287                 return false;
 288             }
 289         }
 290 
 291         final boolean canAdd = rowLevelSecurityService
 292                 .canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);
 293         return isNotReadOnly(cmd) &amp;&amp; canAdd;
 294     }
 295     
 296     protected boolean isNotReadOnly(final ClassMetadata cmd) {
 297         //check if all the metadata is read only
 298         for (Property property : cmd.getProperties()) {
 299             if (property.getMetadata() instanceof BasicFieldMetadata) {
 300                 if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||
 301                         !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {
 302                     return true;
 303                 }
 304             }
 305         }
 306         
 307         return false;
 308     }
 309 
 310     /**
<abbr title=" 311      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any"> 311      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot rðŸ”µ</abbr>
<abbr title=" 312      * subcollections as operations on those collections require the parent level entity to first be saved and have"> 312      * subcollections as operations on those collections require the parent level entity to first be saveðŸ”µ</abbr>
<abbr title=" 313      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 313      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity ðŸ”µ</abbr>
 314      * they can then perform operations on sub collections.
 315      *
 316      * @param request
 317      * @param response
 318      * @param model
 319      * @param pathVars
 320      * @param entityType
 321      * @return the return view path
 322      * @throws Exception
 323      */
 324     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
<abbr title=" 325     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,"> 325     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
 326             @PathVariable  Map&lt;String, String&gt; pathVars,
 327             @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 328         String sectionKey = getSectionKey(pathVars);
 329         String sectionClassName = getClassNameForSection(sectionKey);
 330         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 331         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 331         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 332         ppr.setAddOperationInspect(true);
 333         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 334         
 335         entityType = determineEntityType(entityType, cmd);
 336 
 337         EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);
 338 
<abbr title=" 339         // We need to make sure that the ceiling entity is set to the interface and the specific entity type"> 339         // We need to make sure that the ceiling entity is set to the interface and the specific entity tðŸ”µ</abbr>
 340         // is set to the type we&#x27;re going to be creating.
 341         entityForm.setCeilingEntityClassname(cmd.getCeilingType());
 342         entityForm.setEntityType(entityType);
 343 
<abbr title=" 344         // When we initially build the class metadata (and thus, the entity form), we had all of the possible"> 344         // When we initially build the class metadata (and thus, the entity form), we had all of the possðŸ”µ</abbr>
<abbr title=" 345         // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the"> 345         // polymorphic fields built out. Now that we have a concrete entity type to render, we can removeðŸ”µ</abbr>
 346         // fields that are not applicable for this given entity type.
 347         formService.removeNonApplicableFields(cmd, entityForm, entityType);
 348 
 349         modifyAddEntityForm(entityForm, pathVars);
 350 
 351         model.addAttribute(&quot;entityForm&quot;, entityForm);
 352         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 353 
 354         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 355         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 356         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 357         setModelAttributes(model, sectionKey);
 358         return MODAL_CONTAINER_VIEW;
 359     }
 360 
 361     // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic 
 362     // types for this entity.
 363     protected String determineEntityType(String entityType, final ClassMetadata cmd) 
 364             throws UnsupportedEncodingException {
 365         if (StringUtils.isBlank(entityType)) {
 366             if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 367                 entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 368             } else {
 369                 entityType = getDefaultEntityType();
 370             }
 371         } else {
 372             entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 373         }
 374         return entityType;
 375     }
 376 
 377     /**
<abbr title=" 378      * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity."> 378      * Processes the request to add a new entity. If successful, returns a redirect to the newly created ðŸ”µ</abbr>
 379      *
 380      * @param request
 381      * @param response
 382      * @param model
 383      * @param pathVars
 384      * @param entityForm
 385      * @param result
 386      * @return the return view path
 387      * @throws Exception
 388      */
 389     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 390     public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 391             @PathVariable  Map&lt;String, String&gt; pathVars,
<abbr title=" 392             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {"> 392             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
 393         String sectionKey = getSectionKey(pathVars);
 394         String sectionClassName = getClassNameForSection(sectionKey);
 395         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 396         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 396         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassNameðŸ”µ</abbr>
 397 
 398         extractDynamicFormFields(cmd, entityForm);
<abbr title=" 399         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 399         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 400         Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 401         entityFormValidator.validate(entityForm, entity, result);
 402 
 403         if (result.hasErrors()) {
 404             entityForm.clearFieldsMap();
 405             formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 406 
 407             formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 408 
 409             modifyAddEntityForm(entityForm, pathVars);
 410 
 411             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 412             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 413             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 414             model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 415             setModelAttributes(model, sectionKey);
 416             return MODAL_CONTAINER_VIEW;
 417         }
 418 
 419         // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 420         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 420         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).ðŸ”µ</abbr>
 421     }
 422 
 423     @RequestMapping(value = &quot;/{id}/duplicate&quot;, method = RequestMethod.POST)
 424     public String duplicateEntity(final HttpServletRequest request,
 425             final HttpServletResponse response, 
 426             final Model model,
 427             @PathVariable final Map&lt;String, String&gt; pathVars,
 428             @PathVariable(value = &quot;id&quot;) final String id,
 429             @ModelAttribute(value = &quot;entityForm&quot;) final EntityForm entityForm,
 430             final BindingResult result) throws Exception {
 431         final String sectionKey = getSectionKey(pathVars);
 432         final String sectionClassName = getClassNameForSection(sectionKey);
 433         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(sectionClassName);
 434         final long identifier = Long.parseLong(id);
 435         
 436         if (duplicator.validate(entityClass, identifier)) {
 437             final Object duplicate;
 438             
 439             try {
 440                 duplicate = duplicator.copy(entityClass, identifier);
 441             } catch (Exception e) {
 442                 LOG.error(&quot;Could not duplicate entity&quot;, e);
 443                 return getErrorDuplicatingResponse(response, &quot;Duplication_Failure&quot;);
 444             }
 445 
 446             final Serializable dupId = genericEntityService.getIdentifier(duplicate);
 447             
 448             // Note that AJAX Redirects need the context path prepended to them
 449             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + dupId;
 450         } else {
 451             return getErrorDuplicatingResponse(response, &quot;Validation_Failure&quot;);
 452         }
 453     }
 454 
 455     protected String getErrorDuplicatingResponse(HttpServletResponse response, String code) {
 456         List&lt;Map&lt;String, Object&gt;&gt; errors = new ArrayList&lt;&gt;();
 457         String message;
 458         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 459         if (context != null &amp;&amp; context.getMessageSource() != null) {
 460             message = context.getMessageSource()
 461                     .getMessage(code, null, code, context.getJavaLocale());
 462         } else {
 463             LOG.warn(
 464                     &quot;Could not find the MessageSource on the current request, &quot; 
 465                             + &quot;not translating the message key&quot;);
 466             message = &quot;Duplication_Failure&quot;;
 467         }
 468 
 469         Map&lt;String, Object&gt; errorMap = new HashMap&lt;&gt;();
 470         errorMap.put(&quot;errorType&quot;, &quot;global&quot;);
 471         errorMap.put(&quot;code&quot;, code);
 472         errorMap.put(&quot;message&quot;, message);
 473         errors.add(errorMap);
 474         return new JsonResponse(response).with(&quot;errors&quot;, errors).done();
 475     }
 476 
 477     /**
 478      * Renders the main entity form for the specified entity
 479      *
 480      * @param request
 481      * @param response
 482      * @param model
 483      * @param pathVars
 484      * @param id
 485      * @return the return view path
 486      * @throws Exception
 487      */
 488     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 489     public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 490             @PathVariable  Map&lt;String, String&gt; pathVars,
 491             @PathVariable(&quot;id&quot;) String id) throws Exception {
 492         String sectionKey = getSectionKey(pathVars);
 493         String sectionClassName = getClassNameForSection(sectionKey);
 494         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 495         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 495         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 496 
 497         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 498         Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 499 
<abbr title=" 500         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 500         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 501 
 502         EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 503 
 504         modifyEntityForm(entity, entityForm, pathVars);
 505 
 506         if (request.getParameter(&quot;headerFlash&quot;) != null) {
 507             model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 508         }
 509 
 510         // Set the sectionKey again incase this is a typed entity
 511         entityForm.setSectionKey(sectionKey);
 512 
 513         // Build the current url in the cast that this is a typed entity
 514         String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 515         int startIndex = request.getContextPath().length();
 516 
 517         // Remove the context path from servlet path
 518         String currentUrl = originatingUri.substring(startIndex);
 519 
 520         model.addAttribute(&quot;entity&quot;, entity);
 521         model.addAttribute(&quot;entityForm&quot;, entityForm);
 522         model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 523 
 524         setModelAttributes(model, sectionKey);
 525 
 526         // We want to replace author ids with their names
 527         addAuditableDisplayFields(entityForm);
 528 
 529         return resolveAppropriateEntityView(request, model, entityForm);
 530     }
 531 
<abbr title=" 532     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 532     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, StrðŸ”µ</abbr>
 533                                                               ClassMetadata cmd, Entity entity,
<abbr title=" 534                                                               List&lt;SectionCrumb&gt; crumbs) throws Exception {"> 534                                                               List&lt;SectionCrumb&gt; crumbs) throws ExceptionðŸ”µ</abbr>
 535         String tabName = pathVars.get(&quot;tabName&quot;);
 536         if (StringUtils.isEmpty(tabName)) {
 537             tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 538         }
 539         return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 540     }
 541 
 542     private boolean isAddRequest(Entity entity) {
 543         ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 544         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);"> 544         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder)ðŸ”µ</abbr>
 545         if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 546             return false;
 547         }
 548 
 549         return resultHolder.getResult();
 550     }
 551 
 552     /**
 553      * Attempts to get the List Grid for the selected tab.
 554      *
 555      * @param request
 556      * @param response
 557      * @param model
 558      * @param pathVars
 559      * @param id
 560      * @param tabName
 561      * @param entityForm
 562      * @param entity
 563      * @return the return view path
 564      * @throws Exception
 565      */
 566     @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 567     public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 568             @PathVariable Map&lt;String, String&gt; pathVars,
 569             @PathVariable(value = &quot;id&quot;) String id,
 570             @PathVariable(value = &quot;tabName&quot;) String tabName,
 571             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 572             @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 573         String sectionKey = getSectionKey(pathVars);
 574         String sectionClassName = getClassNameForSection(sectionKey);
 575         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 576         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 576         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 577         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 578         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 579         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 579         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 580         entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 581 
 582         modifyEntityForm(entity, entityForm, pathVars);
 583 
 584         model.addAttribute(&quot;entity&quot;, entity);
 585         model.addAttribute(&quot;entityForm&quot;, entityForm);
 586         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 587 
 588         setModelAttributes(model, sectionKey);
 589 
 590         model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 591         model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 592         
 593         return DEFAULT_CONTAINER_VIEW;
 594     }
 595 
 596     /**
 597      * Builds JSON that looks like this:
 598      *
 599      * {&quot;errors&quot;:
 600      *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 601      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 602      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 603      *        &quot;errorType&quot;, &quot;field&quot;,
 604      *        &quot;tab&quot;: &quot;General&quot;
 605      *        },
 606      *        {&quot;message&quot;:&quot;This field is Required&quot;,
 607      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 608      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 609      *        &quot;errorType&quot;, &quot;field&quot;,
 610      *        &quot;tab&quot;: &quot;General&quot;
 611      *        }]
 612      * }
 613      *
 614      */
 615     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 616     public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 617             @PathVariable Map&lt;String, String&gt; pathVars,
 618             @PathVariable(value = &quot;id&quot;) String id,
 619             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 620             RedirectAttributes ra) throws Exception {
 621 
 622         saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 623 
 624         JsonResponse json = new JsonResponse(response);
 625         if (result.hasErrors()) {
 626             populateJsonValidationErrors(entityForm, result, json);
 627         }
 628         List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 629         if (CollectionUtils.isNotEmpty(dirtyList)) {
 630             json.with(&quot;dirty&quot;, dirtyList);
 631         }
 632 
 633         ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 634         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 634         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonReðŸ”µ</abbr>
 635         if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 636             return resultHolder.getResult();
 637         }
 638 
 639         return json.done();
 640     }
 641 
<abbr title=" 642     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 642     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String iðŸ”µ</abbr>
 643         List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 644         String sectionKey = getSectionKey(pathVars);
 645         String sectionClassName = getClassNameForSection(sectionKey);
 646         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 647         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 647         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 648         ClassMetadata cmd = null;
 649         Entity entity = null;
 650         cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 651         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 652 
 653         for (Property p: entity.getProperties()) {
 654             if (p.getIsDirty()) {
 655                 dirtyList.add(p.getName());
 656             }
 657         }
 658         return dirtyList;
 659     }
 660 
 661     /**
<abbr title=" 662      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with"> 662      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity forðŸ”µ</abbr>
 663      * error fields highlighted. On a successful save, it will refresh the entity page.
 664      *
 665      * @param request
 666      * @param response
 667      * @param model
 668      * @param pathVars
 669      * @param id
 670      * @param entityForm
 671      * @param result
 672      * @return the return view path
 673      * @throws Exception
 674      */
 675     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 676     public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 677             @PathVariable  Map&lt;String, String&gt; pathVars,
 678             @PathVariable(value=&quot;id&quot;) String id,
 679             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 680             RedirectAttributes ra) throws Exception {
 681         String sectionKey = getSectionKey(pathVars);
 682         String sectionClassName = getClassNameForSection(sectionKey);
 683         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 684         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 684         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 685         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 686 
 687         extractDynamicFormFields(cmd, entityForm);
 688 
<abbr title=" 689         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 689         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 690         Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 691 
 692         entityFormValidator.validate(entityForm, entity, result);
 693         
 694         if (result.hasErrors()) {
 695             model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 696             model.addAttribute(&quot;headerFlashAlert&quot;, true);
 697 
<abbr title=" 698             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 698             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entðŸ”µ</abbr>
 699             entityForm.clearFieldsMap();
 700             formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 701 
 702             modifyEntityForm(entity, entityForm, pathVars);
 703 
 704             model.addAttribute(&quot;entity&quot;, entity);
 705             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 706 
 707             setModelAttributes(model, sectionKey);
 708 
 709             return resolveAppropriateEntityView(request, model, entityForm);
 710         }
 711 
 712         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 713 
 714         return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
 715     }
 716     
 717     protected void modifyEntityForm(final Entity entity, final EntityForm entityForm, 
 718             final Map&lt;String, String&gt; pathVars) throws Exception {
 719         if (isAddRequest(entity)) {
 720             modifyAddEntityForm(entityForm, pathVars);
 721         } else {
 722             modifyEntityForm(entityForm, pathVars);
 723         }
 724     }
 725 
 726     protected String resolveAppropriateEntityView(final HttpServletRequest request,
 727             final Model model,
 728             final @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) {
 729         if (isAjaxRequest(request)) {
 730             entityForm.setReadOnly();
 731             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 732             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 733             return MODAL_CONTAINER_VIEW;
 734         } else {
 735             model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 736             model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 737             return DEFAULT_CONTAINER_VIEW;
 738         }
 739     }
 740 
 741     /**
 742      * Attempts to remove the given entity.
 743      *
 744      * @param request
 745      * @param response
 746      * @param model
 747      * @param pathVars
 748      * @param id
 749      * @return the return view path
 750      * @throws Exception
 751      */
 752     @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 753     public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 754             @PathVariable  Map&lt;String, String&gt; pathVars,
 755             @PathVariable(value=&quot;id&quot;) String id,
 756             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 757             RedirectAttributes ra) throws Exception {
 758         String sectionKey = getSectionKey(pathVars);
 759         String sectionClassName = getClassNameForSection(sectionKey);
 760         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 761 
<abbr title=" 762         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 762         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 763         Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 764         // Removal does not normally return an Entity unless there is some validation error
 765         if (entity != null) {
 766             entityFormValidator.validate(entityForm, entity, result);
 767             if (result.hasErrors()) {
 768                 // Create a flash attribute for the unsuccessful delete
 769                 FlashMap fm = new FlashMap();
 770                 fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 771                 fm.put(&quot;headerFlashAlert&quot;, true);
 772                 request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 773 
 774                 // Re-look back up the entity so that we can return something populated
<abbr title=" 775                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 775                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, secðŸ”µ</abbr>
<abbr title=" 776                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 776                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
 777                 entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 778                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 778                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr,ðŸ”µ</abbr>
 779                 entityForm.clearFieldsMap();
 780                 formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 781                 modifyEntityForm(entityForm, pathVars);
 782 
 783                 return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 784                         .done();
 785             }
 786         }
 787 
 788         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 789         ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 790 
 791         if (isAjaxRequest(request)) {
 792             // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
<abbr title=" 793             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;"> 793             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successfðŸ”µ</abbr>
 794         } else {
 795             return &quot;redirect:/&quot; + sectionKey;
 796         }
 797     }
 798 
 799     @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 800     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 800     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpSeðŸ”µ</abbr>
 801             @PathVariable  Map&lt;String, String&gt; pathVars,
 802             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 803             @RequestParam String ids,
 804             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 805         String sectionKey = getSectionKey(pathVars);
 806         String sectionClassName = getClassNameForSection(sectionKey);
 807         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 808         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 808         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
<abbr title=" 809         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 809         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 810         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 811         FieldMetadata md = collectionProperty.getMetadata();
 812 
 813         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 814         ppr.setStartIndex(getStartIndex(requestParams));
 815         ppr.setMaxIndex(getMaxIndex(requestParams));
 816 
 817         if (md instanceof BasicFieldMetadata) {
 818             String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 819             String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 820 
 821             List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 822             ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 823 
 824             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 825             Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 826 
 827             for (Entity e : drs.getRecords()) {
 828                 String id = e.getPMap().get(idProp).getValue();
 829                 String disp = e.getPMap().get(displayProp).getDisplayValue();
 830 
 831                 if (StringUtils.isBlank(disp)) {
 832                     disp = e.getPMap().get(displayProp).getValue();
 833                 }
 834 
 835                 returnMap.put(id,  disp);
 836             }
 837 
 838             return returnMap;
 839         }
 840 
 841         return null;
 842     }
 843 
 844     /**
<abbr title=" 845      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 845      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a ðŸ”µ</abbr>
 846      * then this method is invoked when a user clicks on the name of the default category field.
 847      *
 848      * @param request
 849      * @param response
 850      * @param model
 851      * @param pathVars
 852      * @param collectionField
 853      * @param id
 854      * @return
 855      * @throws Exception
 856      */
 857     @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
<abbr title=" 858     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 858     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 859             @PathVariable  Map&lt;String, String&gt; pathVars,
 860             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 861             @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 862         String sectionKey = getSectionKey(pathVars);
 863         String mainClassName = getClassNameForSection(sectionKey);
 864         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 865         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 865         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 866         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 867         BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 868 
<abbr title=" 869         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 869         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeðŸ”µ</abbr>
<abbr title=" 870         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 870         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : sectiðŸ”µ</abbr>
 871         Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 872         varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 873         return viewEntityForm(request, response, model, varsForField, id);
 874     }
 875 
 876     @RequestMapping(
 877             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 878             method = RequestMethod.POST
 879     )
<abbr title=" 880     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 880     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 881                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 882                                         @PathVariable(value=&quot;id&quot;) String id,
 883                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 884                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 885                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 886                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 886                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 887 
<abbr title=" 888         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 888         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 889     }
 890 
 891 
 892     /**
 893      * Returns the records for a given collectionField filtered by a particular criteria
 894      *
 895      * @param request
 896      * @param response
 897      * @param model
 898      * @param pathVars
 899      * @param collectionField
 900      * @param requestParams
 901      * @return the return view path
 902      * @throws Exception
 903      */
 904     @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
<abbr title=" 905     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,"> 905     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 906             @PathVariable  Map&lt;String, String&gt; pathVars,
 907             @PathVariable(value=&quot;id&quot;) String id,
 908             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 909             @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 910         String sectionKey = getSectionKey(pathVars);
 911         String mainClassName = getClassNameForSection(sectionKey);
 912         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 913         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);"> 913         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams,ðŸ”µ</abbr>
<abbr title=" 914         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 914         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 915         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 916 
 917         ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
<abbr title=" 918         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];"> 918         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
 919 
 920         // Next, we must get the new list grid that represents this collection
<abbr title=" 921         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);"> 921         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParamsðŸ”µ</abbr>
 922         model.addAttribute(&quot;listGrid&quot;, listGrid);
 923 
 924         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 925 
 926         // We return the new list grid so that it can replace the currently visible one
 927         setModelAttributes(model, sectionKey);
 928         return &quot;views/standaloneListGrid&quot;;
 929     }
 930 
 931     /**
<abbr title=" 932      * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes"> 932      * Shows the modal dialog that is used to add an item to a given collection. There are several possibðŸ”µ</abbr>
 933      * of this call depending on the type of the specified collection field.
 934      *
 935      * &lt;ul&gt;
 936      *  &lt;li&gt;
<abbr title=" 937      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may"> 937      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so thaðŸ”µ</abbr>
<abbr title=" 938      *    enter information and associate the record with this collection. Used by fields such as ProductAttribute."> 938      *    enter information and associate the record with this collection. Used by fields such as ProductðŸ”µ</abbr>
 939      *  &lt;/li&gt;
 940      *  &lt;li&gt;
<abbr title=" 941      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it."> 941      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entiðŸ”µ</abbr>
 942      *    Used by fields such as &quot;allParentCategories&quot;.
 943      *  &lt;/li&gt;
 944      *  &lt;li&gt;
<abbr title=" 945      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 945      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click onðŸ”µ</abbr>
<abbr title=" 946      *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation"> 946      *    select it. The view rendered by this is identical to basic collection (lookup), but will perforðŸ”µ</abbr>
<abbr title=" 947      *    on an adorned field, which may carry extra meta-information about the created relationship, such as order."> 947      *    on an adorned field, which may carry extra meta-information about the created relationship, sucðŸ”µ</abbr>
 948      *  &lt;/li&gt;
 949      *  &lt;li&gt;
<abbr title=" 950      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 950      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on anðŸ”µ</abbr>
<abbr title=" 951      *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified"> 951      *    select it. Once the user selects the entity, he will be presented with an empty form based on tðŸ”µ</abbr>
<abbr title=" 952      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition"> 952      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, whiðŸ”µ</abbr>
 953      *    to linking an entity, provide extra fields, such as a promotional message.
 954      *  &lt;/li&gt;
 955      *  &lt;li&gt;
<abbr title=" 956      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is"> 956      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. ðŸ”µ</abbr>
<abbr title=" 957      *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another"> 957      *    populated either from the configured map keys, or as a result of a lookup in the case of a key ðŸ”µ</abbr>
 958      *    entity. Used by fields such as the mediaMap on a Sku.
 959      *  &lt;/li&gt;
 960      *
 961      * @param request
 962      * @param response
 963      * @param model
 964      * @param pathVars
 965      * @param id
 966      * @param collectionField
 967      * @param requestParams
 968      * @return the return view path
 969      * @throws Exception
 970      */
 971     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
<abbr title=" 972     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 972     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 973             @PathVariable Map&lt;String, String&gt; pathVars,
 974             @PathVariable(value = &quot;id&quot;) String id,
 975             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
 976             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 977         String sectionKey = getSectionKey(pathVars);
 978         String mainClassName = getClassNameForSection(sectionKey);
 979         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 980         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,"> 980         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 981                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
 982         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 983         FieldMetadata md = collectionProperty.getMetadata();
 984 
 985         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 986                 .withFilterAndSortCriteria(getCriteria(requestParams))
 987                 .withStartIndex(getStartIndex(requestParams))
 988                 .withMaxIndex(getMaxIndex(requestParams))
 989                 .withLastId(getLastId(requestParams))
 990                 .withFirstId(getFirstId(requestParams))
 991                 .withUpperCount(getUpperCount(requestParams))
 992                 .withLowerCount(getLowerCount(requestParams))
 993                 .withPageSize(getPageSize(requestParams))
 994                 .withPresentationFetch(true);
 995 
 996         if (md instanceof BasicCollectionMetadata) {
 997             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 998             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title=" 999                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 999                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
<abbr title="1000                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types">1000                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorpðŸ”µ</abbr>
1001                 // for this entity.
1002                 String entityType = null;
1003                 
1004                 if (requestParams.containsKey(&quot;entityType&quot;)) {
1005                     entityType = requestParams.get(&quot;entityType&quot;).get(0);
1006                 }
1007                 
1008                 entityType = determineEntityType(entityType, cmd);
1009 
1010                 if (StringUtils.isBlank(entityType)) {
1011                     return getModalForBlankEntityType(request, model, sectionKey, cmd);
1012                 } 
1013                 
1014                 ppr = ppr.withCeilingEntityClassname(entityType);
1015             }
1016         } else if (md instanceof MapMetadata) {
<abbr title="1017             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);">1017             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionTypðŸ”µ</abbr>
1018             if (result.equals(ExtensionResultStatusType.HANDLED)) {
1019                 model.addAttribute(&quot;entityId&quot;, id);
1020                 model.addAttribute(&quot;sectionKey&quot;, sectionKey);
1021                 model.addAttribute(&quot;collectionField&quot;, collectionField);
1022                 return MODAL_CONTAINER_VIEW;
1023             }
1024         }
1025 
1026         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
1027 
<abbr title="1028         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);">1028         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, colðŸ”µ</abbr>
1029     }
1030     
1031     protected String getModalForBlankEntityType(final HttpServletRequest request, 
1032             final Model model, final String sectionKey, final ClassMetadata cmd) {
1033         final List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
1034         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
1035         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
1036         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
1037         
1038         String requestUri = request.getRequestURI();
1039         final String contextPath = request.getContextPath();
1040         
1041         if (!contextPath.equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(contextPath)) {
1042             requestUri = requestUri.substring(contextPath.length() + 1, requestUri.length());
1043         }
1044 
1045         model.addAttribute(&quot;currentUri&quot;, requestUri);
1046         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
1047         setModelAttributes(model, sectionKey);
1048         
1049         return MODAL_CONTAINER_VIEW;
1050     }
1051 
<abbr title="1052     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)">1052     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMðŸ”µ</abbr>
<abbr title="1053     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1053     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
1054             @PathVariable Map&lt;String, String&gt; pathVars,
1055             @PathVariable(value=&quot;id&quot;) String id,
1056             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1057             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1058         String sectionKey = getSectionKey(pathVars);
1059         String mainClassName = getClassNameForSection(sectionKey);
1060         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1061         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1061         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1062         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1063         FieldMetadata md = collectionProperty.getMetadata();
1064         Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
1065         if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title="1066             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1066             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1067                     collectionField,
1068                     collectionItemId, responseMap);
1069         }
1070         return responseMap;
1071     }
1072 
1073     /**
1074      *
1075      * @param request
1076      * @param response
1077      * @param model
1078      * @param pathVars
1079      * @param id
1080      * @param collectionField
1081      * @param requestParams
1082      * @return Json collection data
1083      * @throws Exception
1084      */
1085     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1086     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1086     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HtðŸ”µ</abbr>
1087             @PathVariable Map&lt;String, String&gt; pathVars,
1088             @PathVariable(value = &quot;id&quot;) String id,
1089             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1090             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1091         String sectionKey = getSectionKey(pathVars);
1092         String mainClassName = getClassNameForSection(sectionKey);
1093         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1094         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,">1094         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1095                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1096         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1097         FieldMetadata md = collectionProperty.getMetadata();
1098 
1099         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1100                 .withFilterAndSortCriteria(getCriteria(requestParams))
1101                 .withStartIndex(getStartIndex(requestParams))
1102                 .withMaxIndex(getMaxIndex(requestParams));
<abbr title="1103         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria()))">1103         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizðŸ”µ</abbr>
1104                 .toArray(String[]::new);
1105         ppr = ppr.withCustomCriteria( both);
1106 
1107         if (md instanceof AdornedTargetCollectionMetadata) {
1108             ppr.setOperationTypesOverride(null);
1109             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1110             ppr.setSectionEntityField(collectionField);
1111         }
1112 
1113         DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1114 
<abbr title="1115         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1115         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCðŸ”µ</abbr>
1116     }
1117 
1118     protected String[] buildSelectizeCustomCriteria() {
1119         return new String[]{ IS_SELECTIZE_REQUEST };
1120     }
1121 
1122     /**
1123      * Adds the requested collection item via Selectize
1124      *
1125      * @param request
1126      * @param response
1127      * @param model
1128      * @param pathVars
1129      * @param id
1130      * @param collectionField
1131      * @param entityForm
1132      * @return the return view path
1133      * @throws Exception
1134      */
1135     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1136     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1136     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpSðŸ”µ</abbr>
1137             @PathVariable Map&lt;String, String&gt; pathVars,
1138             @PathVariable(value=&quot;id&quot;) String id,
1139             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1140             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1140             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1141         Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1142         String sectionKey = getSectionKey(pathVars);
1143         String mainClassName = getClassNameForSection(sectionKey);
1144         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1145         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1145         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1146         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1147 
1148         if (StringUtils.isBlank(entityForm.getEntityType())) {
1149             FieldMetadata fmd = collectionProperty.getMetadata();
1150             if (fmd instanceof BasicCollectionMetadata) {
1151                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1152             }
1153         }
1154 
<abbr title="1155         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1155         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1156         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1157         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1158         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1158         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1159 
1160         // First, we must save the collection entity
<abbr title="1161         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1161         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1162         Entity savedEntity = persistenceResponse.getEntity();
1163         entityFormValidator.validate(entityForm, savedEntity, result);
1164 
1165         if (result.hasErrors()) {
1166             returnVal.put(&quot;error&quot;, result.getFieldError());
1167             return returnVal;
1168         }
1169 
1170         if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1171             returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1172         }
1173         return returnVal;
1174     }
1175 
1176     protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1177         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1177         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().gðŸ”µ</abbr>
1178         additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1179     }
1180 
1181     /**
1182      * Adds the requested collection item
1183      *
1184      * @param request
1185      * @param response
1186      * @param model
1187      * @param pathVars
1188      * @param id
1189      * @param collectionField
1190      * @param entityForm
1191      * @return the return view path
1192      * @throws Exception
1193      */
1194     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
<abbr title="1195     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1195     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
1196             @PathVariable Map&lt;String, String&gt; pathVars,
1197             @PathVariable(value=&quot;id&quot;) String id,
1198             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1199             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1199             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1200         String sectionKey = getSectionKey(pathVars);
1201         String mainClassName = getClassNameForSection(sectionKey);
1202         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1203         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1203         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1204         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1205 
1206         if (StringUtils.isBlank(entityForm.getEntityType())) {
1207             FieldMetadata fmd = collectionProperty.getMetadata();
1208             if (fmd instanceof BasicCollectionMetadata) {
1209                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1210             }
1211         }
1212 
<abbr title="1213         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1213         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1214         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1215         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1215         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1216 
1217         // First, we must save the collection entity
<abbr title="1218         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1218         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1219         Entity savedEntity = persistenceResponse.getEntity();
1220         entityFormValidator.validate(entityForm, savedEntity, result);
1221 
1222         if (result.hasErrors()) {
1223             FieldMetadata md = collectionProperty.getMetadata();
1224             ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1225             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1225             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey,ðŸ”µ</abbr>
1226                     md, ppr, entityForm, savedEntity);
1227         }
1228 
1229         // Next, we must get the new list grid that represents this collection
<abbr title="1230         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1230         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1231         model.addAttribute(&quot;listGrid&quot;, listGrid);
1232 
1233         // We return the new list grid so that it can replace the currently visible one
1234         model.addAttribute(&quot;actualEntityId&quot;, id);
1235         setModelAttributes(model, sectionKey);
1236         return &quot;views/standaloneListGrid&quot;;
1237     }
1238 
1239     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1240     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1240     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse reðŸ”µ</abbr>
1241             @PathVariable Map&lt;String, String&gt; pathVars,
1242             @PathVariable(value=&quot;id&quot;) String id,
1243             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1244             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1244             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1245         String sectionKey = getSectionKey(pathVars);
1246         String mainClassName = getClassNameForSection(sectionKey);
1247         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1248         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1248         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1249         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1250 
1251         if (StringUtils.isBlank(entityForm.getEntityType())) {
1252             FieldMetadata fmd = collectionProperty.getMetadata();
1253             if (fmd instanceof BasicCollectionMetadata) {
1254                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1255             }
1256         }
1257 
<abbr title="1258         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1258         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1259         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1259         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1260         entity.setIsPreAdd(true);
1261         // First, we must save the collection entity
<abbr title="1262         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1262         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1263         Entity savedEntity = persistenceResponse.getEntity();
1264 
1265         return new JsonResponse(response)
1266                 .with(&quot;status&quot;, &quot;complete&quot;)
1267                 .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1268                 .done();
1269     }
1270 
1271     /**
<abbr title="1272      * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1272      * Builds out all of the model information needed for showing the add modal for collection items on bðŸ”µ</abbr>
1273      * as well as after a POST with validation errors
1274      *
1275      * @param request
1276      * @param model
1277      * @param id
1278      * @param collectionField
1279      * @param sectionKey
1280      * @param collectionProperty
1281      * @param md
1282      * @param ppr
1283      * @return the appropriate view to display for the modal
<abbr title="1284      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1284      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StringðŸ”µ</abbr>
<abbr title="1285      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1285      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StðŸ”µ</abbr>
1286      * @throws ServiceException
1287      */
<abbr title="1288     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,">1288     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse responseðŸ”µ</abbr>
<abbr title="1289             Model model, String id, String collectionField, String sectionKey, Property collectionProperty,">1289             Model model, String id, String collectionField, String sectionKey, Property collectionPropertðŸ”µ</abbr>
<abbr title="1290             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1290             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throwsðŸ”µ</abbr>
1291 
<abbr title="1292         // For requests to add a new collection item include the main class that the subsequent request comes from.">1292         // For requests to add a new collection item include the main class that the subsequent request cðŸ”µ</abbr>
<abbr title="1293         // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1293         // For instance, with basic collections we know the main associated class for a fetch through theðŸ”µ</abbr>
<abbr title="1294         // persistence item but map and adorned target lookups make a standard persistence request. This solution">1294         // persistence item but map and adorned target lookups make a standard persistence request. This ðŸ”µ</abbr>
1295         // fixes all cases.
1296         String mainClassName = getClassNameForSection(sectionKey);
1297         ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1298         ppr.setAddOperationInspect(true);
1299 
1300         if (entityForm != null) {
1301             entityForm.clearFieldsMap();
1302         }
1303         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1304         if (md instanceof BasicCollectionMetadata) {
1305             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1306 
<abbr title="1307             // When adding items to basic collections, we will sometimes show a form to persist a new record">1307             // When adding items to basic collections, we will sometimes show a form to persist a new recðŸ”µ</abbr>
1308             // and sometimes show a list grid to allow the user to associate an existing record.
1309             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1310                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1310                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().geðŸ”µ</abbr>
1311                 if (entityForm == null) {
1312                     entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1313                     entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1314                     entityForm.setEntityType(ppr.getCeilingEntityClassname());
1315                 } else {
1316                     formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1317                     formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1318                 }
<abbr title="1319                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1319                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntitðŸ”µ</abbr>
1320                 entityForm.getTabs().iterator().next().getIsVisible();
1321 
1322                 model.addAttribute(&quot;entityForm&quot;, entityForm);
1323                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1324             } else {
1325                 DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1326                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1326                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectðŸ”µ</abbr>
1327                 listGrid.setPathOverride(request.getRequestURL().toString());
1328 
<abbr title="1329                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1329                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUPðŸ”µ</abbr>
1330                     listGrid.removeAllRowActions();
1331                 }
1332 
1333                 model.addAttribute(&quot;listGrid&quot;, listGrid);
1334                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1335             }
1336         } else if (md instanceof AdornedTargetCollectionMetadata) {
1337             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1338 
<abbr title="1339             // Even though this field represents an adorned target collection, the list we want to show in the modal">1339             // Even though this field represents an adorned target collection, the list we want to show iðŸ”µ</abbr>
1340             // is the standard list grid for the target entity of this field
1341             ppr.setOperationTypesOverride(null);
1342             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1343             ppr.setSectionEntityField(collectionField);
1344 
<abbr title="1345             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1345             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1346 
1347             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1348             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1348             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKðŸ”µ</abbr>
1349             listGrid.setSubCollectionFieldName(collectionField);
1350             listGrid.setPathOverride(request.getRequestURL().toString());
1351             listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1352             if (entityForm == null) {
<abbr title="1353                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1353                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectiðŸ”µ</abbr>
<abbr title="1354                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());">1354                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassnameðŸ”µ</abbr>
1355             } else {
<abbr title="1356                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1356                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectioðŸ”µ</abbr>
1357                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1358             }
1359 
1360             listGrid.setListGridType(ListGrid.Type.ADORNED);
1361             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1362                 if (entry.getValue().getIsVisible()) {
1363                     listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1364                     break;
1365                 }
1366             }
1367 
1368             // This is part of an add, so we want to be able to filter/sort the listgrid
1369             listGrid.setIsSortable(false);
1370             listGrid.setCanFilterAndSort(true);
1371             listGrid.removeAllRowActions();
1372 
1373             model.addAttribute(&quot;listGrid&quot;, listGrid);
1374             model.addAttribute(&quot;entityForm&quot;, entityForm);
1375             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1376         } else if (md instanceof MapMetadata) {
1377             MapMetadata fmd = (MapMetadata) md;
<abbr title="1378             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1378             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1379 
1380             if (entityForm == null) {
<abbr title="1381                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1381                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1382             } else {
1383                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1384                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1385             }
1386             model.addAttribute(&quot;entityForm&quot;, entityForm);
1387             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1388         }
1389 
1390         // Set the parent id on the entity form
1391         if (entityForm != null) {
1392             entityForm.setParentId(id);
1393         }
1394 
1395         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1396         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1397         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1398         setModelAttributes(model, sectionKey);
1399         return MODAL_CONTAINER_VIEW;
1400     }
1401 
1402     /**
1403      * Shows the appropriate modal dialog to edit the selected collection item
1404      *
1405      * @param request
1406      * @param response
1407      * @param model
1408      * @param pathVars
1409      * @param id
1410      * @param collectionField
1411      * @param collectionItemId
1412      * @return the return view path
1413      * @throws Exception
1414      */
<abbr title="1415     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1415     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1416     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1416     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1417             @PathVariable  Map&lt;String, String&gt; pathVars,
1418             @PathVariable(value=&quot;id&quot;) String id,
1419             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1420             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1421             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1422         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1422         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1423                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1424     }
1425 
1426     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
<abbr title="1427     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1427     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1428             @PathVariable  Map&lt;String, String&gt; pathVars,
1429             @PathVariable(value=&quot;id&quot;) String id,
1430             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1431             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1432         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1432         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1433                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1434     }
1435 
1436     /**
<abbr title="1437      * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1437      * Shows the appropriate modal dialog to view the selected collection item. This will display the modðŸ”µ</abbr>
1438      *
1439      * @param request
1440      * @param response
1441      * @param model
1442      * @param pathVars
1443      * @param id
1444      * @param collectionField
1445      * @param collectionItemId
1446      * @return the return view path
1447      * @throws Exception
1448      */
<abbr title="1449     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1449     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = ðŸ”µ</abbr>
<abbr title="1450     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1450     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1451             @PathVariable  Map&lt;String, String&gt; pathVars,
1452             @PathVariable(value=&quot;id&quot;) String id,
1453             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1454             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1455             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1456         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1456         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1457                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1458 
1459         // Since this is a read-only view, actions don&#x27;t make sense in this context
1460         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1461         addAuditableDisplayFields(ef);
1462         ef.removeAllActions();
1463         ef.setReadOnly();
1464 
1465         return returnPath;
1466     }
1467 
<abbr title="1468     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)">1468     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.ðŸ”µ</abbr>
<abbr title="1469     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1469     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1470             @PathVariable  Map&lt;String, String&gt; pathVars,
1471             @PathVariable(value=&quot;id&quot;) String id,
1472             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1473             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1474         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1474         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1475                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1476 
1477         // Since this is a read-only view, actions don&#x27;t make sense in this context
1478         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1479         ef.removeAllActions();
1480         ef.setReadOnly();
1481 
1482         return returnPath;
1483     }
1484 
<abbr title="1485     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1485     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1486             String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1486             String id, String collectionField, String collectionItemId, String alternateId, String modalHðŸ”µ</abbr>
<abbr title="1487         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1487         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1488     }
1489 
<abbr title="1490     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1490     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1491             String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1491             String id, String collectionField, String collectionItemId, String modalHeaderType) throws SeðŸ”µ</abbr>
<abbr title="1492         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1492         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1493     }
1494 
<abbr title="1495     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1495     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1496                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1496                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntitðŸ”µ</abbr>
<abbr title="1497         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1497         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1498     }
1499 
1500     /**
<abbr title="1501      * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1501      * Shows the view and populates the model for updating a collection item. You can also pass in an entðŸ”µ</abbr>
1502      * which are optional. If they are not passed in then they are automatically looked up
1503      *
1504      * @param request
1505      * @param model
1506      * @param pathVars
1507      * @param id
1508      * @param collectionField
1509      * @param collectionItemId
1510      * @param modalHeaderType
1511      * @param entityForm
1512      * @param entity
1513      * @return
1514      * @throws ServiceException
1515      */
1516     protected String showViewUpdateCollection(HttpServletRequest request, 
1517             Model model, 
1518             Map&lt;String, String&gt; pathVars,
1519             String id, 
1520             String collectionField, 
1521             String collectionItemId, 
1522             String alternateId, 
1523             String modalHeaderType, 
1524             EntityForm entityForm, 
1525             Entity entity) throws ServiceException {
1526         String sectionKey = getSectionKey(pathVars);
1527         String mainClassName = getClassNameForSection(sectionKey);
1528         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1529         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1529         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1530         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1531         FieldMetadata md = collectionProperty.getMetadata();
1532         SectionCrumb nextCrumb = new SectionCrumb();
1533         if (md instanceof MapMetadata) {
1534             nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1535         } else {
1536             nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1537         }
1538         nextCrumb.setSectionId(collectionItemId);
1539         if (!sectionCrumbs.contains(nextCrumb)) {
1540             sectionCrumbs.add(nextCrumb);
1541         }
1542 
<abbr title="1543         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1543         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1544         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1544         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1545 
1546         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1547 
1548         if (md instanceof BasicCollectionMetadata &amp;&amp;
1549                 (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
<abbr title="1550                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {">1550                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMðŸ”µ</abbr>
1551             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1552 
<abbr title="1553             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1553             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1554             if (entity == null) {
<abbr title="1555                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1555                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResðŸ”µ</abbr>
1556             }
1557 
1558             String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1559             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1559             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetaðŸ”µ</abbr>
1560             
1561             entityForm = reinitializeEntityForm(entityForm, collectionMetadata, entity, 
1562                     subRecordsMap, sectionCrumbs);
1563             
1564             entityForm.removeAction(DefaultEntityFormActions.DELETE);
1565             entityForm.removeAction(DefaultEntityFormActions.DUPLICATE);
1566             
1567             addAuditableDisplayFields(entityForm);
1568             model.addAttribute(&quot;entityForm&quot;, entityForm);
1569             model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1570         } else if (md instanceof AdornedTargetCollectionMetadata) {
1571             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1572 
1573             if (entity == null) {
<abbr title="1574                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1574                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1575                     collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1576             }
1577 
1578             boolean populateTypeAndId = true;
<abbr title="1579             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);">1579             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaðŸ”µ</abbr>
1580             if (entityForm == null) {
<abbr title="1581                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1581                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollecðŸ”µ</abbr>
1582                 entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1583                 entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1584             } else {
1585                 entityForm.clearFieldsMap();
1586                 String entityType = entityForm.getEntityType();
<abbr title="1587                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1587                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entðŸ”µ</abbr>
1588                 entityForm.setEntityType(entityType);
1589                 populateTypeAndId = false;
1590             }
1591 
1592             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1593             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1593             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1594                     collectionField,
1595                     collectionItemId, responseMap);
1596 
<abbr title="1597             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1597             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and ðŸ”µ</abbr>
<abbr title="1598             //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).">1598             //It should be the entity and referenced Id of the adorned entity (not the target entity and ðŸ”µ</abbr>
1599             entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1600             entityForm.setTranslationId(alternateId);
1601 
1602             ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1603             for (String field : fmd.getMaintainedAdornedTargetFields()) {
1604                 if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1605                     continue;
1606                 }
1607                 Property p = cmd.getPMap().get(field);
1608                 if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1609                     // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1609                     // Because we&#x27;re dealing with a nested adorned target collection, this particular reqðŸ”µ</abbr>
<abbr title="1610                     // directly on the first adorned target collection. Because of this, we need the actual id property">1610                     // directly on the first adorned target collection. Because of this, we need the actuðŸ”µ</abbr>
<abbr title="1611                     // from the entity that models the adorned target relationship, and not the id of the target object.">1611                     // from the entity that models the adorned target relationship, and not the id of theðŸ”µ</abbr>
<abbr title="1612                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1612                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1613                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1613                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1614                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1615 
<abbr title="1616                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1616                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1617                             ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1618                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1619 
1620                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1621                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1621                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1622                     } else {
<abbr title="1623                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1623                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1624                     }
1625                 } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1626                     // See above comment for AdornedTargetCollectionMetadata
1627                     MapMetadata mmd = (MapMetadata) p.getMetadata();
1628 
<abbr title="1629                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1629                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1630                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1630                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1631                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1632 
<abbr title="1633                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1633                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1634                             mmd.getTargetClass(), sectionCrumbs);
1635                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1636 
1637                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1638                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1638                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1639                     } else {
<abbr title="1640                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1640                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1641                     }
1642                 }
1643             }
1644 
<abbr title="1645             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1645             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1646             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1647 
1648             boolean atLeastOneBasicField = false;
1649             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1650                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">1650                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName(ðŸ”µ</abbr>
1651                     atLeastOneBasicField = true;
1652                     break;
1653                 }
1654             }
1655             if (!atLeastOneBasicField) {
1656                 entityForm.removeAction(DefaultEntityFormActions.SAVE);
1657             }
1658             addAuditableDisplayFields(entityForm);
1659             model.addAttribute(&quot;entityForm&quot;, entityForm);
1660             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1661         } else if (md instanceof MapMetadata) {
1662             MapMetadata fmd = (MapMetadata) md;
1663 
<abbr title="1664             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1664             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1665             if (entity == null) {
<abbr title="1666                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1666                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1667                     collectionItemId, sectionCrumbs, null).getEntity();
1668             }
1669 
1670             boolean populateTypeAndId = true;
1671             if (entityForm == null) {
<abbr title="1672                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1672                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1673             } else {
1674                 //save off the prior key before clearing out the fields map as it will not appear
1675                 //back on the saved entity
1676                 String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1677                 entityForm.clearFieldsMap();
1678                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1679                 entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1680                 populateTypeAndId = false;
1681             }
1682 
<abbr title="1683             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1683             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1684             formService.populateMapEntityFormFields(entityForm, entity);
1685             addAuditableDisplayFields(entityForm);
1686             model.addAttribute(&quot;entityForm&quot;, entityForm);
1687             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1688         }
1689 
1690         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1691         model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1692         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1693         setModelAttributes(model, sectionKey);
1694         return MODAL_CONTAINER_VIEW;
1695     }
1696     
1697     protected EntityForm reinitializeEntityForm(final EntityForm entityForm, 
1698             final ClassMetadata collectionMetadata,
1699             final Entity entity,
1700             final Map&lt;String, DynamicResultSet&gt; subRecordsMap,
1701             final List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
1702         if (entityForm == null) {
1703             return formService
1704                     .createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);
1705         }
1706         
1707         entityForm.clearFieldsMap();
1708         formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm,
1709                 sectionCrumbs);
1710         //remove all the actions since we&#x27;re not trying to redisplay them on the form
1711         entityForm.removeAllActions();
1712     
1713         return entityForm;
1714     }
1715 
1716     /**
1717      * Updates the specified collection item
1718      *
1719      * @param request
1720      * @param response
1721      * @param model
1722      * @param pathVars
1723      * @param id
1724      * @param collectionField
<abbr title="1725      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1725      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1726      * @param entityForm
1727      * @param result
1728      * @return the return view path
1729      * @throws Exception
1730      */
1731     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
<abbr title="1732     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1732     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1733             @PathVariable  Map&lt;String, String&gt; pathVars,
1734             @PathVariable(value=&quot;id&quot;) String id,
1735             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1736             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1737             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1738             BindingResult result) throws Exception {
<abbr title="1739         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1739         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1740     }
1741 
1742     /**
1743      * Updates the specified collection item
1744      *
1745      * @param request
1746      * @param response
1747      * @param model
1748      * @param pathVars
1749      * @param id
1750      * @param collectionField
<abbr title="1751      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1751      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1752      * @param entityForm
<abbr title="1753      * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1753      * @param alternateId in the case of adorned target collections, this is the primary key value of theðŸ”µ</abbr>
1754      * @param result
1755      * @return the return view path
1756      * @throws Exception
1757      */
<abbr title="1758     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1758     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1759     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1759     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1760             @PathVariable  Map&lt;String, String&gt; pathVars,
1761             @PathVariable(value=&quot;id&quot;) String id,
1762             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1763             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1764             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1765             @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1766             BindingResult result) throws Exception {
1767         String sectionKey = getSectionKey(pathVars);
1768         String mainClassName = getClassNameForSection(sectionKey);
1769         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1770         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1770         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1771         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1772 
<abbr title="1773         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1773         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1774         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1774         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1775 
1776         // First, we must save the collection entity
<abbr title="1777         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1777         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadðŸ”µ</abbr>
1778         Entity savedEntity = persistenceResponse.getEntity();
1779         entityFormValidator.validate(entityForm, savedEntity, result);
1780 
1781         if (result.hasErrors()) {
<abbr title="1782             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1782             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1783                     ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1784         }
1785 
1786         // Next, we must get the new list grid that represents this collection
1787         // We return the new list grid so that it can replace the currently visible one
<abbr title="1788         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1788         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1789 
1790         model.addAttribute(&quot;listGrid&quot;, listGrid);
1791         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1792         setModelAttributes(model, sectionKey);
1793         return &quot;views/standaloneListGrid&quot;;
1794     }
1795 
<abbr title="1796     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)">1796     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMetðŸ”µ</abbr>
1797     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1798             HttpServletResponse response, Model model,
1799             @PathVariable  Map&lt;String, String&gt; pathVars,
1800             @PathVariable(value=&quot;id&quot;) String id,
1801             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1802             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1803             @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1804         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1804         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collðŸ”µ</abbr>
1805     }
1806 
1807     /**
<abbr title="1808      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections">1808      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target colðŸ”µ</abbr>
<abbr title="1809      * where a sort field is specified -- any other invocation is incorrect and will result in an exception.">1809      * where a sort field is specified -- any other invocation is incorrect and will result in an exceptiðŸ”µ</abbr>
1810      *
1811      * @param request
1812      * @param response
1813      * @param model
1814      * @param pathVars
1815      * @param id
1816      * @param collectionField
1817      * @param collectionItemId
1818      * @return an object explaining the state of the operation
1819      * @throws Exception
1820      */
<abbr title="1821     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1821     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, methoðŸ”µ</abbr>
1822     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1823             HttpServletResponse response, Model model,
1824             @PathVariable  Map&lt;String, String&gt; pathVars,
1825             @PathVariable(value=&quot;id&quot;) String id,
1826             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1827             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1828             @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1829             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1830         String sectionKey = getSectionKey(pathVars);
1831         String mainClassName = getClassNameForSection(sectionKey);
1832         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1833         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1833         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1834         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1835         FieldMetadata md = collectionProperty.getMetadata();
1836 
<abbr title="1837         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1837         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1838         ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1839 
<abbr title="1840         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1840         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1841 
1842         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1843 
1844         if (md instanceof AdornedTargetCollectionMetadata) {
1845             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1846             AdornedTargetList atl = ppr.getAdornedList();
1847 
1848             // Get an entity form for the entity
<abbr title="1849             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1849             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, falseðŸ”µ</abbr>
<abbr title="1850             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1850             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProðŸ”µ</abbr>
<abbr title="1851                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})">1851                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;}ðŸ”µ</abbr>
1852                     .getDynamicResultSet().getRecords()[0];
1853             formService.populateEntityFormFields(entityForm, entity);
1854             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1855 
<abbr title="1856             // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">1856             // Set the new sequence (note that it will come in 0-indexed but the persistence module expecðŸ”µ</abbr>
1857             int sequenceValue = Integer.parseInt(newSequence) + 1;
1858             Field field = entityForm.findField(atl.getSortField());
1859             field.setValue(String.valueOf(sequenceValue));
1860 
1861             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1862             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">1862             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1863             Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
1864 
1865             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1866             responseMap.put(&quot;field&quot;, collectionField);
1867             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1868             return responseMap;
1869         } else if (md instanceof BasicCollectionMetadata) {
1870             BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
1871             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1872             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1872             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResulðŸ”µ</abbr>
1873 
<abbr title="1874             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1874             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1875             EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
1876             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1877                 Field f = new Field()
1878                         .withName(cd.getSortProperty())
1879                         .withFieldType(SupportedFieldType.HIDDEN.toString());
1880                 entityForm.addHiddenField(mainMetadata, f);
1881             }
1882             formService.populateEntityFormFields(entityForm, entity);
1883 
1884             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1885                 int sequenceValue = Integer.parseInt(newSequence) + 1;
1886                 Field field = entityForm.findField(cd.getSortProperty());
1887                 field.setValue(String.valueOf(sequenceValue));
1888             }
1889 
<abbr title="1890             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">1890             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1891             Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
1892 
1893             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1894             responseMap.put(&quot;field&quot;, collectionField);
1895             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1896             return responseMap;
1897         } else {
<abbr title="1898             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">1898             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collðŸ”µ</abbr>
1899         }
1900     }
1901 
1902     /**
1903      * Removes the requested collection item
1904      *
<abbr title="1905      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1905      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1906      * map collection.
1907      *
1908      * @param request
1909      * @param response
1910      * @param model
1911      * @param pathVars
1912      * @param id
1913      * @param collectionField
1914      * @param collectionItemId
1915      * @return the return view path
1916      * @throws Exception
1917      */
<abbr title="1918     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)">1918     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethoðŸ”µ</abbr>
<abbr title="1919     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1919     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1920             @PathVariable  Map&lt;String, String&gt; pathVars,
1921             @PathVariable(value=&quot;id&quot;) String id,
1922             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1923             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1924         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">1924         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1925     }
1926 
1927     /**
1928      * Removes the requested collection item
1929      *
<abbr title="1930      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1930      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1931      * map collection.
1932      *
1933      * @param request
1934      * @param response
1935      * @param model
1936      * @param pathVars
1937      * @param id
1938      * @param collectionField
1939      * @param collectionItemId
1940      * @return the return view path
1941      * @throws Exception
1942      */
<abbr title="1943     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">1943     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method ðŸ”µ</abbr>
<abbr title="1944     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1944     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1945             @PathVariable  Map&lt;String, String&gt; pathVars,
1946             @PathVariable(value=&quot;id&quot;) String id,
1947             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1948             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1949             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1950         String sectionKey = getSectionKey(pathVars);
1951         String mainClassName = getClassNameForSection(sectionKey);
1952         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1953         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1953         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1954         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1955 
1956         String priorKey = request.getParameter(&quot;key&quot;);
1957 
<abbr title="1958         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1958         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1959         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1960         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1960         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1961 
1962         // First, we must remove the collection entity
<abbr title="1963         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">1963         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectðŸ”µ</abbr>
<abbr title="1964         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {">1964         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailurðŸ”µ</abbr>
1965             String error = &quot;There was an error removing the whatever&quot;;
1966             if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
1967                 // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="1968                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">1968                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator()ðŸ”µ</abbr>
<abbr title="1969             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {">1969             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErroðŸ”µ</abbr>
1970                 error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
1971             }
1972             return new JsonResponse(response)
1973                 .with(&quot;status&quot;, &quot;error&quot;)
1974                 .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
1975                 .done();
1976         }
1977 
1978         // Next, we must get the new list grid that represents this collection
1979         // We return the new list grid so that it can replace the currently visible one
<abbr title="1980         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1980         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1981 
1982         model.addAttribute(&quot;listGrid&quot;, listGrid);
1983         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1984         setModelAttributes(model, sectionKey);
1985         return &quot;views/standaloneListGrid&quot;;
1986     }
1987 
1988     public void addAuditableDisplayFields(EntityForm entityForm) {
1989         Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
1990         if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
1991             addAuditableDisplayField(entityForm, createdBy);
1992 
1993             createdBy.setIsVisible(false);
1994         }
1995         Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
1996         if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
1997             addAuditableDisplayField(entityForm, updatedBy);
1998 
1999             updatedBy.setIsVisible(false);
2000         }
2001     }
2002 
2003     private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
2004         Field displayField = buildAuditableDisplayField(userField);
2005 
2006         AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
2007         String userName = user == null ? null : user.getName();
2008         displayField.setValue(userName);
2009 
2010         FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
2011         if (auditGroup != null) {
2012             auditGroup.addField(displayField);
2013         }
2014     }
2015 
2016     private Field buildAuditableDisplayField(Field auditableField) {
2017         return new Field().withFieldType(SupportedFieldType.STRING.toString())
2018                 .withName(auditableField.getName() + &quot;Display&quot;)
2019                 .withFriendlyName(auditableField.getFriendlyName())
2020                 .withOrder(auditableField.getOrder())
2021                 .withOwningEntityClass(auditableField.getOwningEntityClass())
2022                 .withReadOnly(true);
2023     }
2024 
2025     protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
2026         String tabName = pathVars.get(&quot;tabName&quot;);
2027         if (StringUtils.isBlank(tabName)) {
2028             TabMetadata firstTab = cmd.getFirstTab();
2029             return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
2030         }
2031         return tabName;
2032     }
2033 
2034     // *****************************************
2035     // Typed Entity Helper Methods
2036     // *****************************************
2037 
2038     protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
2039         // Check if this is a typed entity
2040         AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
2041         if (typedEntitySection != null) {
2042             // Update the friendly name for this Entity Type
2043             model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
2044         }
2045     }
2046 
2047     // *********************************
2048     // ADDITIONAL SPRING-BOUND METHODS *
2049     // *********************************
2050 
2051     /**
<abbr title="2052      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.">2052      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding ðŸ”µ</abbr>
<abbr title="2053      * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">2053      * By default, we register a binder that treats empty Strings as null and a Boolean editor that suppoðŸ”µ</abbr>
2054      * or false. If the value is passed in as null, it will treat it as false.
2055      *
2056      * @param binder
2057      */
2058     @InitBinder
2059     public void initBinder(WebDataBinder binder) {
2060         binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
2061         binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
2062     }
2063 
2064 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.controller.entity;
  19 
  20 import org.apache.commons.collections.CollectionUtils;
  21 import org.apache.commons.collections.MapUtils;
  22 import org.apache.commons.lang3.StringUtils;
  23 import org.apache.commons.logging.Log;
  24 import org.apache.commons.logging.LogFactory;
  25 import org.broadleafcommerce.common.exception.SecurityServiceException;
  26 import org.broadleafcommerce.common.exception.ServiceException;
  27 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  28 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  29 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  30 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  31 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  32 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  33 import org.broadleafcommerce.common.service.GenericEntityService;
  34 import org.broadleafcommerce.common.util.BLCArrayUtils;
  35 import org.broadleafcommerce.common.util.BLCMessageUtils;
  36 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  37 import org.broadleafcommerce.common.web.JsonResponse;
  38 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  39 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  40 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  41 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  42 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  43 import org.broadleafcommerce.openadmin.dto.ClassTree;
  44 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  45 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  46 import org.broadleafcommerce.openadmin.dto.Entity;
  47 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  48 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  49 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  50 import org.broadleafcommerce.openadmin.dto.Property;
  51 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  52 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  53 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  54 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  55 import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  56 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  57 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  58 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  59 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  60 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  61 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  61 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExteðŸ”µ</abbr>
  62 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  63 import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  64 import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  65 import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  66 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  67 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  68 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  69 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  70 import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  71 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  72 import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  73 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  74 import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  75 import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  76 import org.springframework.stereotype.Controller;
  77 import org.springframework.ui.Model;
  78 import org.springframework.util.MultiValueMap;
  79 import org.springframework.validation.BindingResult;
  80 import org.springframework.web.bind.WebDataBinder;
  81 import org.springframework.web.bind.annotation.InitBinder;
  82 import org.springframework.web.bind.annotation.ModelAttribute;
  83 import org.springframework.web.bind.annotation.PathVariable;
  84 import org.springframework.web.bind.annotation.RequestMapping;
  85 import org.springframework.web.bind.annotation.RequestMethod;
  86 import org.springframework.web.bind.annotation.RequestParam;
  87 import org.springframework.web.bind.annotation.ResponseBody;
  88 import org.springframework.web.servlet.DispatcherServlet;
  89 import org.springframework.web.servlet.FlashMap;
  90 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  91 import org.springframework.web.util.UrlPathHelper;
  92 
  93 import com.fasterxml.jackson.databind.ObjectMapper;
  94 
  95 import java.io.Serializable;
  96 import java.io.UnsupportedEncodingException;
  97 import java.net.URLDecoder;
  98 import java.util.ArrayList;
  99 import java.util.Arrays;
 100 import java.util.HashMap;
 101 import java.util.List;
 102 import java.util.Map;
 103 import java.util.Map.Entry;
 104 import java.util.Set;
 105 import java.util.stream.Stream;
 106 
 107 import javax.annotation.Resource;
 108 import javax.servlet.http.HttpServletRequest;
 109 import javax.servlet.http.HttpServletResponse;
 110 
 111 /**
 112  * The default implementation of the {@link AdminAbstractController}. This delegates every call to
 113  * super and does not provide any custom-tailored functionality. It is responsible for rendering the
 114  * admin for every entity that is not explicitly customized by its own controller.
 115  *
 116  * @author Andre Azzolini (apazzolini)
 117  * @author Jeff Fischer
 118  */
 119 @Controller(&quot;blAdminBasicEntityController&quot;)
 120 @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 121 public class AdminBasicEntityController extends AdminAbstractController {
 122 
 123     protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 124 
 125     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 126     public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 127     public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 128 
 129     @Resource(name=&quot;blSandBoxHelper&quot;)
 130     protected SandBoxHelper sandBoxHelper;
 131 
 132     @Resource(name = &quot;blAdminUserDao&quot;)
 133     protected AdminUserDao adminUserDao;
 134 
 135     @Resource(name=&quot;blDynamicEntityDao&quot;)
 136     protected DynamicEntityDao dynamicEntityDao;
 137 
 138     @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 139     protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 140 
 141     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 142     protected RowLevelSecurityService rowLevelSecurityService;
 143 
 144     @Resource(name = &quot;blEntityDuplicator&quot;)
 145     protected EntityDuplicator duplicator;
 146 
 147     @Resource(name = &quot;blGenericEntityService&quot;)
 148     protected GenericEntityService genericEntityService;
 149 
 150     // ******************************************
 151     // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 152     // ******************************************
 153 
 154     /**
<abbr title=" 155      * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 155      * Renders the main entity listing for the specified class, which is based on the current sectionKey ðŸ”µ</abbr>
 156      * criteria.
 157      *
 158      * @param request
 159      * @param response
 160      * @param model
 161      * @param pathVars
 162      * @param requestParams a Map of property name -&gt; list critiera values
 163      * @return the return view path
 164      * @throws Exception
 165      */
 166     @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 167     public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 168             @PathVariable Map&lt;String, String&gt; pathVars,
 169             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 170         String sectionKey = getSectionKey(pathVars);
 171         String sectionClassName = getClassNameForSection(sectionKey);
 172         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 173         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 173         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 174         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 175         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 176 
 177         ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 178         listGrid.setSelectType(ListGrid.SelectType.NONE);
 179 
 180         Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 181         if (CollectionUtils.isNotEmpty(headerFields)) {
 182             Field firstField = headerFields.iterator().next();
 183             if (requestParams.containsKey(firstField.getName())) {
 184                 model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 185             }
 186         }
 187 
 188         model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 189 
 190         setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 191         model.addAttribute(&quot;listGrid&quot;, listGrid);
 192 
 193         return DEFAULT_CONTAINER_VIEW;
 194     }
 195 
<abbr title=" 196     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,"> 196     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String seðŸ”µ</abbr>
 197             String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 198         List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 199         addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 200         extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 201         extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 202 
 203         // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 204         if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 205             model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 206         }
 207 
 208         List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 209         String requestUri = request.getRequestURI();
 210         if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
<abbr title=" 211             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 211             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length())ðŸ”µ</abbr>
 212         }
 213 
 214         model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 215         model.addAttribute(&quot;currentUri&quot;, requestUri);
 216         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 217         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 218         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 219         model.addAttribute(&quot;mainActions&quot;, mainActions);
 220         setModelAttributes(model, sectionKey);
 221         setTypedEntityModelAttributes(request, model);
 222     }
 223 
 224     @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 225     public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 226              HttpServletResponse response, Model model,
 227              @PathVariable Map&lt;String, String&gt; pathVars,
 228              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 229         String sectionKey = getSectionKey(pathVars);
 230         String sectionClassName = getClassNameForSection(sectionKey);
 231         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 232         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 232         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 233                 .withCustomCriteria(getCustomCriteria(requestParams));
 234 
 235         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 236 
 237         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 238         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 239 
 240         return formService.constructSelectizeOptionMap(drs, cmd);
 241     }
 242 
 243     /**
 244      * Obtains the requested criteria parameter
 245      *
 246      * @param requestParams
 247      * @return
 248      */
 249     protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 250         if (requestParams == null || requestParams.isEmpty()) {
 251             return null;
 252         }
 253 
 254         List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 255         String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 256         return new String[] {response};
 257     }
 258 
 259     /**
<abbr title=" 260      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances"> 260      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new inðŸ”µ</abbr>
 261      * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 262      *
 263      * @param sectionClassName
 264      * @param cmd
 265      * @param mainActions
 266      */
<abbr title=" 267     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 267     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormActioðŸ”µ</abbr>
 268         if (isAddActionAllowed(sectionClassName, cmd)) {
 269             mainActions.add(DefaultMainActions.ADD);
 270         }
 271     }
 272 
 273     protected boolean isAddActionAllowed(final String sectionClassName, final ClassMetadata cmd) {
 274         // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
 275         try {
 276             adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 277         } catch (ServiceException e) {
 278             if (e instanceof SecurityServiceException) {
 279                 return false;
 280             }
 281         }
 282 
 283         final boolean canAdd = rowLevelSecurityService
 284                 .canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);
 285         return isNotReadOnly(cmd) &amp;&amp; canAdd;
 286     }
 287 
 288     protected boolean isNotReadOnly(final ClassMetadata cmd) {
 289         //check if all the metadata is read only
 290         for (Property property : cmd.getProperties()) {
 291             if (property.getMetadata() instanceof BasicFieldMetadata) {
 292                 if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||
 293                         !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {
 294                     return true;
 295                 }
 296             }
 297         }
 298 
 299         return false;
 300     }
 301 
 302     /**
<abbr title=" 303      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any"> 303      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot rðŸ”µ</abbr>
<abbr title=" 304      * subcollections as operations on those collections require the parent level entity to first be saved and have"> 304      * subcollections as operations on those collections require the parent level entity to first be saveðŸ”µ</abbr>
<abbr title=" 305      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 305      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity ðŸ”µ</abbr>
 306      * they can then perform operations on sub collections.
 307      *
 308      * @param request
 309      * @param response
 310      * @param model
 311      * @param pathVars
 312      * @param entityType
 313      * @return the return view path
 314      * @throws Exception
 315      */
 316     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
<abbr title=" 317     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,"> 317     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
 318             @PathVariable  Map&lt;String, String&gt; pathVars,
 319             @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 320         String sectionKey = getSectionKey(pathVars);
 321         String sectionClassName = getClassNameForSection(sectionKey);
 322         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 323         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 323         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 324         ppr.setAddOperationInspect(true);
 325         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 326 
 327         entityType = determineEntityType(entityType, cmd);
 328 
 329         EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);
 330 
<abbr title=" 331         // We need to make sure that the ceiling entity is set to the interface and the specific entity type"> 331         // We need to make sure that the ceiling entity is set to the interface and the specific entity tðŸ”µ</abbr>
 332         // is set to the type we&#x27;re going to be creating.
 333         entityForm.setCeilingEntityClassname(cmd.getCeilingType());
 334         entityForm.setEntityType(entityType);
 335 
<abbr title=" 336         // When we initially build the class metadata (and thus, the entity form), we had all of the possible"> 336         // When we initially build the class metadata (and thus, the entity form), we had all of the possðŸ”µ</abbr>
<abbr title=" 337         // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the"> 337         // polymorphic fields built out. Now that we have a concrete entity type to render, we can removeðŸ”µ</abbr>
 338         // fields that are not applicable for this given entity type.
 339         formService.removeNonApplicableFields(cmd, entityForm, entityType);
 340 
 341         modifyAddEntityForm(entityForm, pathVars);
 342 
 343         model.addAttribute(&quot;entityForm&quot;, entityForm);
 344         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 345 
 346         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 347         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 348         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 349         setModelAttributes(model, sectionKey);
 350         return MODAL_CONTAINER_VIEW;
 351     }
 352 
 353     // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic
 354     // types for this entity.
 355     protected String determineEntityType(String entityType, final ClassMetadata cmd)
 356             throws UnsupportedEncodingException {
 357         if (StringUtils.isBlank(entityType)) {
 358             if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 359                 entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 360             } else {
 361                 entityType = getDefaultEntityType();
 362             }
 363         } else {
 364             entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 365         }
 366         return entityType;
 367     }
 368 
 369     /**
<abbr title=" 370      * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity."> 370      * Processes the request to add a new entity. If successful, returns a redirect to the newly created ðŸ”µ</abbr>
 371      *
 372      * @param request
 373      * @param response
 374      * @param model
 375      * @param pathVars
 376      * @param entityForm
 377      * @param result
 378      * @return the return view path
 379      * @throws Exception
 380      */
 381     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 382     public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 383             @PathVariable  Map&lt;String, String&gt; pathVars,
<abbr title=" 384             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {"> 384             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
 385         String sectionKey = getSectionKey(pathVars);
 386         String sectionClassName = getClassNameForSection(sectionKey);
 387         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 388         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 388         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassNameðŸ”µ</abbr>
 389 
 390         extractDynamicFormFields(cmd, entityForm);
<abbr title=" 391         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 391         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 392         Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 393         entityFormValidator.validate(entityForm, entity, result);
 394 
 395         if (result.hasErrors()) {
 396             entityForm.clearFieldsMap();
 397             formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 398 
 399             formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 400 
 401             modifyAddEntityForm(entityForm, pathVars);
 402 
 403             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 404             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 405             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 406             model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 407             setModelAttributes(model, sectionKey);
 408             return MODAL_CONTAINER_VIEW;
 409         }
 410 
 411         // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 412         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 412         return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).ðŸ”µ</abbr>
 413     }
 414 
 415     @RequestMapping(value = &quot;/{id}/duplicate&quot;, method = RequestMethod.POST)
 416     public String duplicateEntity(final HttpServletRequest request,
 417             final HttpServletResponse response,
 418             final Model model,
 419             @PathVariable final Map&lt;String, String&gt; pathVars,
 420             @PathVariable(value = &quot;id&quot;) final String id,
 421             @ModelAttribute(value = &quot;entityForm&quot;) final EntityForm entityForm,
 422             final BindingResult result) throws Exception {
 423         final String sectionKey = getSectionKey(pathVars);
 424         final String sectionClassName = getClassNameForSection(sectionKey);
 425         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(sectionClassName);
 426         final long identifier = Long.parseLong(id);
 427 
 428         if (duplicator.validate(entityClass, identifier)) {
 429             final Object duplicate;
 430 
 431             try {
 432                 duplicate = duplicator.copy(entityClass, identifier);
 433             } catch (Exception e) {
 434                 LOG.error(&quot;Could not duplicate entity&quot;, e);
 435                 return getErrorDuplicatingResponse(response, &quot;Duplication_Failure&quot;);
 436             }
 437 
 438             final Serializable dupId = genericEntityService.getIdentifier(duplicate);
 439 
 440             // Note that AJAX Redirects need the context path prepended to them
 441             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + dupId;
 442         } else {
 443             return getErrorDuplicatingResponse(response, &quot;Validation_Failure&quot;);
 444         }
 445     }
 446 
 447     protected String getErrorDuplicatingResponse(HttpServletResponse response, String code) {
 448         List&lt;Map&lt;String, Object&gt;&gt; errors = new ArrayList&lt;&gt;();
 449         String message;
 450         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 451         if (context != null &amp;&amp; context.getMessageSource() != null) {
 452             message = context.getMessageSource()
 453                     .getMessage(code, null, code, context.getJavaLocale());
 454         } else {
 455             LOG.warn(
 456                     &quot;Could not find the MessageSource on the current request, &quot;
 457                             + &quot;not translating the message key&quot;);
 458             message = &quot;Duplication_Failure&quot;;
 459         }
 460 
 461         Map&lt;String, Object&gt; errorMap = new HashMap&lt;&gt;();
 462         errorMap.put(&quot;errorType&quot;, &quot;global&quot;);
 463         errorMap.put(&quot;code&quot;, code);
 464         errorMap.put(&quot;message&quot;, message);
 465         errors.add(errorMap);
 466         return new JsonResponse(response).with(&quot;errors&quot;, errors).done();
 467     }
 468 
 469     /**
 470      * Renders the main entity form for the specified entity
 471      *
 472      * @param request
 473      * @param response
 474      * @param model
 475      * @param pathVars
 476      * @param id
 477      * @return the return view path
 478      * @throws Exception
 479      */
 480     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 481     public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 482             @PathVariable  Map&lt;String, String&gt; pathVars,
 483             @PathVariable(&quot;id&quot;) String id) throws Exception {
 484         String sectionKey = getSectionKey(pathVars);
 485         String sectionClassName = getClassNameForSection(sectionKey);
 486         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 487         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 487         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 488 
 489         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 490         Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 491 
<abbr title=" 492         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 492         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 493 
 494         EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 495 
 496         modifyEntityForm(entity, entityForm, pathVars);
 497 
 498         if (request.getParameter(&quot;headerFlash&quot;) != null) {
 499             model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 500         }
 501 
 502         // Set the sectionKey again incase this is a typed entity
 503         entityForm.setSectionKey(sectionKey);
 504 
 505         // Build the current url in the cast that this is a typed entity
 506         String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 507         int startIndex = request.getContextPath().length();
 508 
 509         // Remove the context path from servlet path
 510         String currentUrl = originatingUri.substring(startIndex);
 511 
 512         model.addAttribute(&quot;entity&quot;, entity);
 513         model.addAttribute(&quot;entityForm&quot;, entityForm);
 514         model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 515 
 516         setModelAttributes(model, sectionKey);
 517 
 518         // We want to replace author ids with their names
 519         addAuditableDisplayFields(entityForm);
 520 
 521         return resolveAppropriateEntityView(request, model, entityForm);
 522     }
 523 
<abbr title=" 524     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 524     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, StrðŸ”µ</abbr>
 525                                                               ClassMetadata cmd, Entity entity,
<abbr title=" 526                                                               List&lt;SectionCrumb&gt; crumbs) throws Exception {"> 526                                                               List&lt;SectionCrumb&gt; crumbs) throws ExceptionðŸ”µ</abbr>
 527         String tabName = pathVars.get(&quot;tabName&quot;);
 528         if (StringUtils.isEmpty(tabName)) {
 529             tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 530         }
 531         return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 532     }
 533 
 534     private boolean isAddRequest(Entity entity) {
 535         ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 536         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);"> 536         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder)ðŸ”µ</abbr>
 537         if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 538             return false;
 539         }
 540 
 541         return resultHolder.getResult();
 542     }
 543 
 544     /**
 545      * Attempts to get the List Grid for the selected tab.
 546      *
 547      * @param request
 548      * @param response
 549      * @param model
 550      * @param pathVars
 551      * @param id
 552      * @param tabName
 553      * @param entityForm
 554      * @param entity
 555      * @return the return view path
 556      * @throws Exception
 557      */
 558     @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 559     public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 560             @PathVariable Map&lt;String, String&gt; pathVars,
 561             @PathVariable(value = &quot;id&quot;) String id,
 562             @PathVariable(value = &quot;tabName&quot;) String tabName,
 563             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 564             @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 565         String sectionKey = getSectionKey(pathVars);
 566         String sectionClassName = getClassNameForSection(sectionKey);
 567         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 568         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 568         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 569         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 570         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 571         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 571         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 572         entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 573 
 574         modifyEntityForm(entity, entityForm, pathVars);
 575 
 576         model.addAttribute(&quot;entity&quot;, entity);
 577         model.addAttribute(&quot;entityForm&quot;, entityForm);
 578         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 579 
 580         setModelAttributes(model, sectionKey);
 581 
 582         model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 583         model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 584 
 585         return DEFAULT_CONTAINER_VIEW;
 586     }
 587 
 588     /**
 589      * Builds JSON that looks like this:
 590      *
 591      * {&quot;errors&quot;:
 592      *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 593      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 594      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 595      *        &quot;errorType&quot;, &quot;field&quot;,
 596      *        &quot;tab&quot;: &quot;General&quot;
 597      *        },
 598      *        {&quot;message&quot;:&quot;This field is Required&quot;,
 599      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 600      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 601      *        &quot;errorType&quot;, &quot;field&quot;,
 602      *        &quot;tab&quot;: &quot;General&quot;
 603      *        }]
 604      * }
 605      *
 606      */
 607     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 608     public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 609             @PathVariable Map&lt;String, String&gt; pathVars,
 610             @PathVariable(value = &quot;id&quot;) String id,
 611             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 612             RedirectAttributes ra) throws Exception {
 613 
 614         saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 615 
 616         JsonResponse json = new JsonResponse(response);
 617         if (result.hasErrors()) {
 618             populateJsonValidationErrors(entityForm, result, json);
 619         }
 620         List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 621         if (CollectionUtils.isNotEmpty(dirtyList)) {
 622             json.with(&quot;dirty&quot;, dirtyList);
 623         }
 624 
 625         ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 626         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 626         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonReðŸ”µ</abbr>
 627         if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 628             return resultHolder.getResult();
 629         }
 630 
 631         return json.done();
 632     }
 633 
<abbr title=" 634     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 634     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String iðŸ”µ</abbr>
 635         List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 636         String sectionKey = getSectionKey(pathVars);
 637         String sectionClassName = getClassNameForSection(sectionKey);
 638         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 639         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 639         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 640         ClassMetadata cmd = null;
 641         Entity entity = null;
 642         cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 643         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 644 
 645         for (Property p: entity.getProperties()) {
 646             if (p.getIsDirty()) {
 647                 dirtyList.add(p.getName());
 648             }
 649         }
 650         return dirtyList;
 651     }
 652 
 653     /**
<abbr title=" 654      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with"> 654      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity forðŸ”µ</abbr>
 655      * error fields highlighted. On a successful save, it will refresh the entity page.
 656      *
 657      * @param request
 658      * @param response
 659      * @param model
 660      * @param pathVars
 661      * @param id
 662      * @param entityForm
 663      * @param result
 664      * @return the return view path
 665      * @throws Exception
 666      */
 667     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 668     public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 669             @PathVariable  Map&lt;String, String&gt; pathVars,
 670             @PathVariable(value=&quot;id&quot;) String id,
 671             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 672             RedirectAttributes ra) throws Exception {
 673         String sectionKey = getSectionKey(pathVars);
 674         String sectionClassName = getClassNameForSection(sectionKey);
 675         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 676         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 676         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 677         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 678 
 679         extractDynamicFormFields(cmd, entityForm);
 680 
<abbr title=" 681         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 681         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 682         Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 683 
 684         entityFormValidator.validate(entityForm, entity, result);
 685 
 686         if (result.hasErrors()) {
 687             model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 688             model.addAttribute(&quot;headerFlashAlert&quot;, true);
 689 
<abbr title=" 690             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 690             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entðŸ”µ</abbr>
 691             entityForm.clearFieldsMap();
 692             formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 693 
 694             modifyEntityForm(entity, entityForm, pathVars);
 695 
 696             model.addAttribute(&quot;entity&quot;, entity);
 697             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 698 
 699             setModelAttributes(model, sectionKey);
 700 
 701             return resolveAppropriateEntityView(request, model, entityForm);
 702         }
 703 
 704         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 705 
 706         return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
 707     }
 708 
 709     protected void modifyEntityForm(final Entity entity, final EntityForm entityForm,
 710             final Map&lt;String, String&gt; pathVars) throws Exception {
 711         if (isAddRequest(entity)) {
 712             modifyAddEntityForm(entityForm, pathVars);
 713         } else {
 714             modifyEntityForm(entityForm, pathVars);
 715         }
 716     }
 717 
 718     protected String resolveAppropriateEntityView(final HttpServletRequest request,
 719             final Model model,
 720             final @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) {
 721         if (isAjaxRequest(request)) {
 722             entityForm.setReadOnly();
 723             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 724             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 725             return MODAL_CONTAINER_VIEW;
 726         } else {
 727             model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 728             model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 729             return DEFAULT_CONTAINER_VIEW;
 730         }
 731     }
 732 
 733     /**
 734      * Attempts to remove the given entity.
 735      *
 736      * @param request
 737      * @param response
 738      * @param model
 739      * @param pathVars
 740      * @param id
 741      * @return the return view path
 742      * @throws Exception
 743      */
 744     @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 745     public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 746             @PathVariable  Map&lt;String, String&gt; pathVars,
 747             @PathVariable(value=&quot;id&quot;) String id,
 748             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 749             RedirectAttributes ra) throws Exception {
 750         String sectionKey = getSectionKey(pathVars);
 751         String sectionClassName = getClassNameForSection(sectionKey);
 752         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 753 
<abbr title=" 754         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 754         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 755         Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 756         // Removal does not normally return an Entity unless there is some validation error
 757         if (entity != null) {
 758             entityFormValidator.validate(entityForm, entity, result);
 759             if (result.hasErrors()) {
 760                 // Create a flash attribute for the unsuccessful delete
 761                 FlashMap fm = new FlashMap();
 762                 fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 763                 fm.put(&quot;headerFlashAlert&quot;, true);
 764                 request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 765 
 766                 // Re-look back up the entity so that we can return something populated
<abbr title=" 767                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 767                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, secðŸ”µ</abbr>
<abbr title=" 768                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 768                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
 769                 entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 770                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 770                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr,ðŸ”µ</abbr>
 771                 entityForm.clearFieldsMap();
 772                 formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 773                 modifyEntityForm(entityForm, pathVars);
 774 
 775                 return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 776                         .done();
 777             }
 778         }
 779 
 780         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 781         ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 782 
 783         if (isAjaxRequest(request)) {
 784             // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
<abbr title=" 785             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;"> 785             return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successfðŸ”µ</abbr>
 786         } else {
 787             return &quot;redirect:/&quot; + sectionKey;
 788         }
 789     }
 790 
 791     @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 792     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 792     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpSeðŸ”µ</abbr>
 793             @PathVariable  Map&lt;String, String&gt; pathVars,
 794             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 795             @RequestParam String ids,
 796             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 797         String sectionKey = getSectionKey(pathVars);
 798         String sectionClassName = getClassNameForSection(sectionKey);
 799         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 800         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 800         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
<abbr title=" 801         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 801         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 802         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 803         FieldMetadata md = collectionProperty.getMetadata();
 804 
 805         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 806         ppr.setStartIndex(getStartIndex(requestParams));
 807         ppr.setMaxIndex(getMaxIndex(requestParams));
 808 
 809         if (md instanceof BasicFieldMetadata) {
 810             String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 811             String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 812 
 813             List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 814             ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 815 
 816             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 817             Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 818 
 819             for (Entity e : drs.getRecords()) {
 820                 String id = e.getPMap().get(idProp).getValue();
 821                 String disp = e.getPMap().get(displayProp).getDisplayValue();
 822 
 823                 if (StringUtils.isBlank(disp)) {
 824                     disp = e.getPMap().get(displayProp).getValue();
 825                 }
 826 
 827                 returnMap.put(id,  disp);
 828             }
 829 
 830             return returnMap;
 831         }
 832 
 833         return null;
 834     }
 835 
 836     /**
<abbr title=" 837      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 837      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a ðŸ”µ</abbr>
 838      * then this method is invoked when a user clicks on the name of the default category field.
 839      *
 840      * @param request
 841      * @param response
 842      * @param model
 843      * @param pathVars
 844      * @param collectionField
 845      * @param id
 846      * @return
 847      * @throws Exception
 848      */
 849     @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
<abbr title=" 850     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 850     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 851             @PathVariable  Map&lt;String, String&gt; pathVars,
 852             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 853             @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 854         String sectionKey = getSectionKey(pathVars);
 855         String mainClassName = getClassNameForSection(sectionKey);
 856         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 857         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 857         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 858         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 859         BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 860 
<abbr title=" 861         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 861         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeðŸ”µ</abbr>
<abbr title=" 862         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 862         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : sectiðŸ”µ</abbr>
 863         Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 864         varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 865         return viewEntityForm(request, response, model, varsForField, id);
 866     }
 867 
 868     @RequestMapping(
 869             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 870             method = RequestMethod.POST
 871     )
<abbr title=" 872     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 872     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 873                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 874                                         @PathVariable(value=&quot;id&quot;) String id,
 875                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 876                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 877                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 878                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 878                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 879 
<abbr title=" 880         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 880         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 881     }
 882 
 883 
 884     /**
 885      * Returns the records for a given collectionField filtered by a particular criteria
 886      *
 887      * @param request
 888      * @param response
 889      * @param model
 890      * @param pathVars
 891      * @param collectionField
 892      * @param requestParams
 893      * @return the return view path
 894      * @throws Exception
 895      */
 896     @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
<abbr title=" 897     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,"> 897     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 898             @PathVariable  Map&lt;String, String&gt; pathVars,
 899             @PathVariable(value=&quot;id&quot;) String id,
 900             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 901             @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 902         String sectionKey = getSectionKey(pathVars);
 903         String mainClassName = getClassNameForSection(sectionKey);
 904         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 905         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);"> 905         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams,ðŸ”µ</abbr>
<abbr title=" 906         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 906         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 907         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 908 
 909         ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
<abbr title=" 910         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];"> 910         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
 911 
 912         // Next, we must get the new list grid that represents this collection
<abbr title=" 913         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);"> 913         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParamsðŸ”µ</abbr>
 914         model.addAttribute(&quot;listGrid&quot;, listGrid);
 915 
 916         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 917 
 918         // We return the new list grid so that it can replace the currently visible one
 919         setModelAttributes(model, sectionKey);
 920         return &quot;views/standaloneListGrid&quot;;
 921     }
 922 
 923     /**
<abbr title=" 924      * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes"> 924      * Shows the modal dialog that is used to add an item to a given collection. There are several possibðŸ”µ</abbr>
 925      * of this call depending on the type of the specified collection field.
 926      *
 927      * &lt;ul&gt;
 928      *  &lt;li&gt;
<abbr title=" 929      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may"> 929      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so thaðŸ”µ</abbr>
<abbr title=" 930      *    enter information and associate the record with this collection. Used by fields such as ProductAttribute."> 930      *    enter information and associate the record with this collection. Used by fields such as ProductðŸ”µ</abbr>
 931      *  &lt;/li&gt;
 932      *  &lt;li&gt;
<abbr title=" 933      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it."> 933      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entiðŸ”µ</abbr>
 934      *    Used by fields such as &quot;allParentCategories&quot;.
 935      *  &lt;/li&gt;
 936      *  &lt;li&gt;
<abbr title=" 937      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 937      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click onðŸ”µ</abbr>
<abbr title=" 938      *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation"> 938      *    select it. The view rendered by this is identical to basic collection (lookup), but will perforðŸ”µ</abbr>
<abbr title=" 939      *    on an adorned field, which may carry extra meta-information about the created relationship, such as order."> 939      *    on an adorned field, which may carry extra meta-information about the created relationship, sucðŸ”µ</abbr>
 940      *  &lt;/li&gt;
 941      *  &lt;li&gt;
<abbr title=" 942      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 942      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on anðŸ”µ</abbr>
<abbr title=" 943      *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified"> 943      *    select it. Once the user selects the entity, he will be presented with an empty form based on tðŸ”µ</abbr>
<abbr title=" 944      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition"> 944      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, whiðŸ”µ</abbr>
 945      *    to linking an entity, provide extra fields, such as a promotional message.
 946      *  &lt;/li&gt;
 947      *  &lt;li&gt;
<abbr title=" 948      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is"> 948      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. ðŸ”µ</abbr>
<abbr title=" 949      *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another"> 949      *    populated either from the configured map keys, or as a result of a lookup in the case of a key ðŸ”µ</abbr>
 950      *    entity. Used by fields such as the mediaMap on a Sku.
 951      *  &lt;/li&gt;
 952      *
 953      * @param request
 954      * @param response
 955      * @param model
 956      * @param pathVars
 957      * @param id
 958      * @param collectionField
 959      * @param requestParams
 960      * @return the return view path
 961      * @throws Exception
 962      */
 963     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
<abbr title=" 964     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 964     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 965             @PathVariable Map&lt;String, String&gt; pathVars,
 966             @PathVariable(value = &quot;id&quot;) String id,
 967             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
 968             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 969         String sectionKey = getSectionKey(pathVars);
 970         String mainClassName = getClassNameForSection(sectionKey);
 971         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 972         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,"> 972         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 973                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
 974         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 975         FieldMetadata md = collectionProperty.getMetadata();
 976 
 977         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 978                 .withFilterAndSortCriteria(getCriteria(requestParams))
 979                 .withStartIndex(getStartIndex(requestParams))
 980                 .withMaxIndex(getMaxIndex(requestParams))
 981                 .withLastId(getLastId(requestParams))
 982                 .withFirstId(getFirstId(requestParams))
 983                 .withUpperCount(getUpperCount(requestParams))
 984                 .withLowerCount(getLowerCount(requestParams))
 985                 .withPageSize(getPageSize(requestParams))
 986                 .withPresentationFetch(true);
 987 
 988         if (md instanceof BasicCollectionMetadata) {
 989             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 990             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title=" 991                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 991                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
<abbr title=" 992                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types"> 992                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorpðŸ”µ</abbr>
 993                 // for this entity.
 994                 String entityType = null;
 995 
 996                 if (requestParams.containsKey(&quot;entityType&quot;)) {
 997                     entityType = requestParams.get(&quot;entityType&quot;).get(0);
 998                 }
 999 
1000                 entityType = determineEntityType(entityType, cmd);
1001 
1002                 if (StringUtils.isBlank(entityType)) {
1003                     return getModalForBlankEntityType(request, model, sectionKey, cmd);
1004                     }
1005 
1006                     ppr = ppr.withCeilingEntityClassname(entityType);
1007                 }
1008         } else if (md instanceof MapMetadata) {
<abbr title="1009             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);">1009             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionTypðŸ”µ</abbr>
1010             if (result.equals(ExtensionResultStatusType.HANDLED)) {
1011                 model.addAttribute(&quot;entityId&quot;, id);
1012                 model.addAttribute(&quot;sectionKey&quot;, sectionKey);
1013                 model.addAttribute(&quot;collectionField&quot;, collectionField);
1014                 return MODAL_CONTAINER_VIEW;
1015             }
1016         }
1017 
1018         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
1019 
<abbr title="1020         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);">1020         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, colðŸ”µ</abbr>
1021     }
1022 
1023     protected String getModalForBlankEntityType(final HttpServletRequest request,
1024             final Model model, final String sectionKey, final ClassMetadata cmd) {
1025         final List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
1026         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
1027         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
1028         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
1029 
1030         String requestUri = request.getRequestURI();
1031         final String contextPath = request.getContextPath();
1032 
1033         if (!contextPath.equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(contextPath)) {
1034             requestUri = requestUri.substring(contextPath.length() + 1, requestUri.length());
1035         }
1036 
1037         model.addAttribute(&quot;currentUri&quot;, requestUri);
1038         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
1039         setModelAttributes(model, sectionKey);
1040 
1041         return MODAL_CONTAINER_VIEW;
1042     }
1043 
<abbr title="1044     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)">1044     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMðŸ”µ</abbr>
<abbr title="1045     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1045     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
1046             @PathVariable Map&lt;String, String&gt; pathVars,
1047             @PathVariable(value=&quot;id&quot;) String id,
1048             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1049             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1050         String sectionKey = getSectionKey(pathVars);
1051         String mainClassName = getClassNameForSection(sectionKey);
1052         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1053         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1053         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1054         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1055         FieldMetadata md = collectionProperty.getMetadata();
1056         Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
1057         if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title="1058             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1058             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1059                     collectionField,
1060                     collectionItemId, responseMap);
1061         }
1062         return responseMap;
1063     }
1064 
1065     /**
1066      *
1067      * @param request
1068      * @param response
1069      * @param model
1070      * @param pathVars
1071      * @param id
1072      * @param collectionField
1073      * @param requestParams
1074      * @return Json collection data
1075      * @throws Exception
1076      */
1077     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1078     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1078     public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HtðŸ”µ</abbr>
1079             @PathVariable Map&lt;String, String&gt; pathVars,
1080             @PathVariable(value = &quot;id&quot;) String id,
1081             @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1082             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1083         String sectionKey = getSectionKey(pathVars);
1084         String mainClassName = getClassNameForSection(sectionKey);
1085         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1086         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,">1086         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1087                 sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1088         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1089         FieldMetadata md = collectionProperty.getMetadata();
1090 
1091         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1092                 .withFilterAndSortCriteria(getCriteria(requestParams))
1093                 .withStartIndex(getStartIndex(requestParams))
1094                 .withMaxIndex(getMaxIndex(requestParams));
<abbr title="1095         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria()))">1095         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizðŸ”µ</abbr>
1096                 .toArray(String[]::new);
1097         ppr = ppr.withCustomCriteria( both);
1098 
1099         if (md instanceof AdornedTargetCollectionMetadata) {
1100             ppr.setOperationTypesOverride(null);
1101             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1102             ppr.setSectionEntityField(collectionField);
1103         }
1104 
1105         DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1106 
<abbr title="1107         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1107         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCðŸ”µ</abbr>
1108     }
1109 
1110     protected String[] buildSelectizeCustomCriteria() {
1111         return new String[]{ IS_SELECTIZE_REQUEST };
1112     }
1113 
1114     /**
1115      * Adds the requested collection item via Selectize
1116      *
1117      * @param request
1118      * @param response
1119      * @param model
1120      * @param pathVars
1121      * @param id
1122      * @param collectionField
1123      * @param entityForm
1124      * @return the return view path
1125      * @throws Exception
1126      */
1127     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1128     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1128     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpSðŸ”µ</abbr>
1129             @PathVariable Map&lt;String, String&gt; pathVars,
1130             @PathVariable(value=&quot;id&quot;) String id,
1131             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1132             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1132             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1133         Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1134         String sectionKey = getSectionKey(pathVars);
1135         String mainClassName = getClassNameForSection(sectionKey);
1136         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1137         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1137         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1138         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1139 
1140         if (StringUtils.isBlank(entityForm.getEntityType())) {
1141             FieldMetadata fmd = collectionProperty.getMetadata();
1142             if (fmd instanceof BasicCollectionMetadata) {
1143                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1144             }
1145         }
1146 
<abbr title="1147         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1147         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1148         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1149         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1150         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1150         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1151 
1152         // First, we must save the collection entity
<abbr title="1153         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1153         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1154         Entity savedEntity = persistenceResponse.getEntity();
1155         entityFormValidator.validate(entityForm, savedEntity, result);
1156 
1157         if (result.hasErrors()) {
1158             returnVal.put(&quot;error&quot;, result.getFieldError());
1159             return returnVal;
1160         }
1161 
1162         if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1163             returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1164         }
1165         return returnVal;
1166     }
1167 
1168     protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1169         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1169         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().gðŸ”µ</abbr>
1170         additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1171     }
1172 
1173     /**
1174      * Adds the requested collection item
1175      *
1176      * @param request
1177      * @param response
1178      * @param model
1179      * @param pathVars
1180      * @param id
1181      * @param collectionField
1182      * @param entityForm
1183      * @return the return view path
1184      * @throws Exception
1185      */
1186     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
<abbr title="1187     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1187     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
1188             @PathVariable Map&lt;String, String&gt; pathVars,
1189             @PathVariable(value=&quot;id&quot;) String id,
1190             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1191             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1191             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1192         String sectionKey = getSectionKey(pathVars);
1193         String mainClassName = getClassNameForSection(sectionKey);
1194         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1195         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1195         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1196         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1197 
1198         if (StringUtils.isBlank(entityForm.getEntityType())) {
1199             FieldMetadata fmd = collectionProperty.getMetadata();
1200             if (fmd instanceof BasicCollectionMetadata) {
1201                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1202             }
1203         }
1204 
<abbr title="1205         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1205         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1206         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1207         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1207         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1208 
1209         // First, we must save the collection entity
<abbr title="1210         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1210         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1211         Entity savedEntity = persistenceResponse.getEntity();
1212         entityFormValidator.validate(entityForm, savedEntity, result);
1213 
1214         if (result.hasErrors()) {
1215             FieldMetadata md = collectionProperty.getMetadata();
1216             ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1217             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1217             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey,ðŸ”µ</abbr>
1218                     md, ppr, entityForm, savedEntity);
1219         }
1220 
1221         // Next, we must get the new list grid that represents this collection
<abbr title="1222         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1222         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1223         model.addAttribute(&quot;listGrid&quot;, listGrid);
1224 
1225         // We return the new list grid so that it can replace the currently visible one
1226         model.addAttribute(&quot;actualEntityId&quot;, id);
1227         setModelAttributes(model, sectionKey);
1228         return &quot;views/standaloneListGrid&quot;;
1229     }
1230 
1231     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1232     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1232     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse reðŸ”µ</abbr>
1233             @PathVariable Map&lt;String, String&gt; pathVars,
1234             @PathVariable(value=&quot;id&quot;) String id,
1235             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1236             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1236             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1237         String sectionKey = getSectionKey(pathVars);
1238         String mainClassName = getClassNameForSection(sectionKey);
1239         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1240         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1240         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1241         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1242 
1243         if (StringUtils.isBlank(entityForm.getEntityType())) {
1244             FieldMetadata fmd = collectionProperty.getMetadata();
1245             if (fmd instanceof BasicCollectionMetadata) {
1246                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1247             }
1248         }
1249 
<abbr title="1250         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1250         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1251         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1251         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1252         entity.setIsPreAdd(true);
1253         // First, we must save the collection entity
<abbr title="1254         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1254         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1255         Entity savedEntity = persistenceResponse.getEntity();
1256 
1257         return new JsonResponse(response)
1258                 .with(&quot;status&quot;, &quot;complete&quot;)
1259                 .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1260                 .done();
1261     }
1262 
1263     /**
<abbr title="1264      * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1264      * Builds out all of the model information needed for showing the add modal for collection items on bðŸ”µ</abbr>
1265      * as well as after a POST with validation errors
1266      *
1267      * @param request
1268      * @param model
1269      * @param id
1270      * @param collectionField
1271      * @param sectionKey
1272      * @param collectionProperty
1273      * @param md
1274      * @param ppr
1275      * @return the appropriate view to display for the modal
<abbr title="1276      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1276      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StringðŸ”µ</abbr>
<abbr title="1277      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1277      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StðŸ”µ</abbr>
1278      * @throws ServiceException
1279      */
<abbr title="1280     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,">1280     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse responseðŸ”µ</abbr>
<abbr title="1281             Model model, String id, String collectionField, String sectionKey, Property collectionProperty,">1281             Model model, String id, String collectionField, String sectionKey, Property collectionPropertðŸ”µ</abbr>
<abbr title="1282             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1282             FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throwsðŸ”µ</abbr>
1283 
<abbr title="1284         // For requests to add a new collection item include the main class that the subsequent request comes from.">1284         // For requests to add a new collection item include the main class that the subsequent request cðŸ”µ</abbr>
<abbr title="1285         // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1285         // For instance, with basic collections we know the main associated class for a fetch through theðŸ”µ</abbr>
<abbr title="1286         // persistence item but map and adorned target lookups make a standard persistence request. This solution">1286         // persistence item but map and adorned target lookups make a standard persistence request. This ðŸ”µ</abbr>
1287         // fixes all cases.
1288         String mainClassName = getClassNameForSection(sectionKey);
1289         ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1290         ppr.setAddOperationInspect(true);
1291 
1292         if (entityForm != null) {
1293             entityForm.clearFieldsMap();
1294         }
1295         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1296         if (md instanceof BasicCollectionMetadata) {
1297             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1298 
<abbr title="1299             // When adding items to basic collections, we will sometimes show a form to persist a new record">1299             // When adding items to basic collections, we will sometimes show a form to persist a new recðŸ”µ</abbr>
1300             // and sometimes show a list grid to allow the user to associate an existing record.
1301             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1302                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1302                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().geðŸ”µ</abbr>
1303                 if (entityForm == null) {
1304                     entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1305                     entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1306                     entityForm.setEntityType(ppr.getCeilingEntityClassname());
1307                 } else {
1308                     formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1309                     formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1310                 }
<abbr title="1311                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1311                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntitðŸ”µ</abbr>
1312                 entityForm.getTabs().iterator().next().getIsVisible();
1313 
1314                 model.addAttribute(&quot;entityForm&quot;, entityForm);
1315                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1316             } else {
1317                 DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1318                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1318                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectðŸ”µ</abbr>
1319                 listGrid.setPathOverride(request.getRequestURL().toString());
1320 
<abbr title="1321                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1321                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUPðŸ”µ</abbr>
1322                     listGrid.removeAllRowActions();
1323                 }
1324 
1325                 model.addAttribute(&quot;listGrid&quot;, listGrid);
1326                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1327             }
1328         } else if (md instanceof AdornedTargetCollectionMetadata) {
1329             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1330 
<abbr title="1331             // Even though this field represents an adorned target collection, the list we want to show in the modal">1331             // Even though this field represents an adorned target collection, the list we want to show iðŸ”µ</abbr>
1332             // is the standard list grid for the target entity of this field
1333             ppr.setOperationTypesOverride(null);
1334             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1335             ppr.setSectionEntityField(collectionField);
1336 
<abbr title="1337             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1337             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1338 
1339             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1340             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1340             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKðŸ”µ</abbr>
1341             listGrid.setSubCollectionFieldName(collectionField);
1342             listGrid.setPathOverride(request.getRequestURL().toString());
1343             listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1344             if (entityForm == null) {
<abbr title="1345                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1345                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectiðŸ”µ</abbr>
<abbr title="1346                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());">1346                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassnameðŸ”µ</abbr>
1347             } else {
<abbr title="1348                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1348                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectioðŸ”µ</abbr>
1349                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1350             }
1351 
1352             listGrid.setListGridType(ListGrid.Type.ADORNED);
1353             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1354                 if (entry.getValue().getIsVisible()) {
1355                     listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1356                     break;
1357                 }
1358             }
1359 
1360             // This is part of an add, so we want to be able to filter/sort the listgrid
1361             listGrid.setIsSortable(false);
1362             listGrid.setCanFilterAndSort(true);
1363             listGrid.removeAllRowActions();
1364 
1365             model.addAttribute(&quot;listGrid&quot;, listGrid);
1366             model.addAttribute(&quot;entityForm&quot;, entityForm);
1367             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1368         } else if (md instanceof MapMetadata) {
1369             MapMetadata fmd = (MapMetadata) md;
<abbr title="1370             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1370             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1371 
1372             if (entityForm == null) {
<abbr title="1373                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1373                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1374             } else {
1375                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1376                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1377             }
1378             model.addAttribute(&quot;entityForm&quot;, entityForm);
1379             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1380         }
1381 
1382         // Set the parent id on the entity form
1383         if (entityForm != null) {
1384             entityForm.setParentId(id);
1385         }
1386 
1387         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1388         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1389         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1390         setModelAttributes(model, sectionKey);
1391         return MODAL_CONTAINER_VIEW;
1392     }
1393 
1394     /**
1395      * Shows the appropriate modal dialog to edit the selected collection item
1396      *
1397      * @param request
1398      * @param response
1399      * @param model
1400      * @param pathVars
1401      * @param id
1402      * @param collectionField
1403      * @param collectionItemId
1404      * @return the return view path
1405      * @throws Exception
1406      */
<abbr title="1407     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1407     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1408     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1408     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1409             @PathVariable  Map&lt;String, String&gt; pathVars,
1410             @PathVariable(value=&quot;id&quot;) String id,
1411             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1412             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1413             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1414         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1414         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1415                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1416     }
1417 
1418     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
<abbr title="1419     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1419     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1420             @PathVariable  Map&lt;String, String&gt; pathVars,
1421             @PathVariable(value=&quot;id&quot;) String id,
1422             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1423             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1424         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1424         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1425                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1426     }
1427 
1428     /**
<abbr title="1429      * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1429      * Shows the appropriate modal dialog to view the selected collection item. This will display the modðŸ”µ</abbr>
1430      *
1431      * @param request
1432      * @param response
1433      * @param model
1434      * @param pathVars
1435      * @param id
1436      * @param collectionField
1437      * @param collectionItemId
1438      * @return the return view path
1439      * @throws Exception
1440      */
<abbr title="1441     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1441     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = ðŸ”µ</abbr>
<abbr title="1442     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1442     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1443             @PathVariable  Map&lt;String, String&gt; pathVars,
1444             @PathVariable(value=&quot;id&quot;) String id,
1445             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1446             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1447             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1448         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1448         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1449                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1450 
1451         // Since this is a read-only view, actions don&#x27;t make sense in this context
1452         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1453         addAuditableDisplayFields(ef);
1454         ef.removeAllActions();
1455         ef.setReadOnly();
1456 
1457         return returnPath;
1458     }
1459 
<abbr title="1460     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)">1460     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.ðŸ”µ</abbr>
<abbr title="1461     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1461     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1462             @PathVariable  Map&lt;String, String&gt; pathVars,
1463             @PathVariable(value=&quot;id&quot;) String id,
1464             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1465             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1466         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1466         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1467                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1468 
1469         // Since this is a read-only view, actions don&#x27;t make sense in this context
1470         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1471         ef.removeAllActions();
1472         ef.setReadOnly();
1473 
1474         return returnPath;
1475     }
1476 
<abbr title="1477     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1477     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1478             String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1478             String id, String collectionField, String collectionItemId, String alternateId, String modalHðŸ”µ</abbr>
<abbr title="1479         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1479         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1480     }
1481 
<abbr title="1482     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1482     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1483             String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1483             String id, String collectionField, String collectionItemId, String modalHeaderType) throws SeðŸ”µ</abbr>
<abbr title="1484         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1484         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1485     }
1486 
<abbr title="1487     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1487     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1488                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1488                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntitðŸ”µ</abbr>
<abbr title="1489         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1489         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1490     }
1491 
1492     /**
<abbr title="1493      * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1493      * Shows the view and populates the model for updating a collection item. You can also pass in an entðŸ”µ</abbr>
1494      * which are optional. If they are not passed in then they are automatically looked up
1495      *
1496      * @param request
1497      * @param model
1498      * @param pathVars
1499      * @param id
1500      * @param collectionField
1501      * @param collectionItemId
1502      * @param modalHeaderType
1503      * @param entityForm
1504      * @param entity
1505      * @return
1506      * @throws ServiceException
1507      */
1508     protected String showViewUpdateCollection(HttpServletRequest request,
1509             Model model,
1510             Map&lt;String, String&gt; pathVars,
1511             String id,
1512             String collectionField,
1513             String collectionItemId,
1514             String alternateId,
1515             String modalHeaderType,
1516             EntityForm entityForm,
1517             Entity entity) throws ServiceException {
1518         String sectionKey = getSectionKey(pathVars);
1519         String mainClassName = getClassNameForSection(sectionKey);
1520         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1521         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1521         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1522         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1523         FieldMetadata md = collectionProperty.getMetadata();
1524         SectionCrumb nextCrumb = new SectionCrumb();
1525         if (md instanceof MapMetadata) {
1526             nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1527         } else {
1528             nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1529         }
1530         nextCrumb.setSectionId(collectionItemId);
1531         if (!sectionCrumbs.contains(nextCrumb)) {
1532             sectionCrumbs.add(nextCrumb);
1533         }
1534 
<abbr title="1535         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1535         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1536         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1536         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1537 
1538         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1539 
1540         if (md instanceof BasicCollectionMetadata &amp;&amp;
1541                 (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
<abbr title="1542                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {">1542                         ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMðŸ”µ</abbr>
1543             BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1544 
<abbr title="1545             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1545             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1546             if (entity == null) {
<abbr title="1547                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1547                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResðŸ”µ</abbr>
1548             }
1549 
1550             String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1551             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1551             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetaðŸ”µ</abbr>
1552 
1553             entityForm = reinitializeEntityForm(entityForm, collectionMetadata, entity,
1554                     subRecordsMap, sectionCrumbs);
1555 
1556             entityForm.removeAction(DefaultEntityFormActions.DELETE);
1557             entityForm.removeAction(DefaultEntityFormActions.DUPLICATE);
1558 
1559             addAuditableDisplayFields(entityForm);
1560             model.addAttribute(&quot;entityForm&quot;, entityForm);
1561             model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1562         } else if (md instanceof AdornedTargetCollectionMetadata) {
1563             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1564 
1565             if (entity == null) {
<abbr title="1566                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1566                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1567                     collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1568             }
1569 
1570             boolean populateTypeAndId = true;
<abbr title="1571             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);">1571             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaðŸ”µ</abbr>
1572             if (entityForm == null) {
<abbr title="1573                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1573                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollecðŸ”µ</abbr>
1574                 entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1575                 entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1576             } else {
1577                 entityForm.clearFieldsMap();
1578                 String entityType = entityForm.getEntityType();
<abbr title="1579                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1579                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entðŸ”µ</abbr>
1580                 entityForm.setEntityType(entityType);
1581                 populateTypeAndId = false;
1582             }
1583 
1584             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1585             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1585             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
1586                     collectionField,
1587                     collectionItemId, responseMap);
1588 
<abbr title="1589             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1589             //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and ðŸ”µ</abbr>
<abbr title="1590             //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).">1590             //It should be the entity and referenced Id of the adorned entity (not the target entity and ðŸ”µ</abbr>
1591             entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1592             entityForm.setTranslationId(alternateId);
1593 
1594             ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1595             for (String field : fmd.getMaintainedAdornedTargetFields()) {
1596                 if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1597                     continue;
1598                 }
1599                 Property p = cmd.getPMap().get(field);
1600                 if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1601                     // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1601                     // Because we&#x27;re dealing with a nested adorned target collection, this particular reqðŸ”µ</abbr>
<abbr title="1602                     // directly on the first adorned target collection. Because of this, we need the actual id property">1602                     // directly on the first adorned target collection. Because of this, we need the actuðŸ”µ</abbr>
<abbr title="1603                     // from the entity that models the adorned target relationship, and not the id of the target object.">1603                     // from the entity that models the adorned target relationship, and not the id of theðŸ”µ</abbr>
<abbr title="1604                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1604                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1605                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1605                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1606                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1607 
<abbr title="1608                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1608                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1609                             ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1610                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1611 
1612                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1613                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1613                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1614                     } else {
<abbr title="1615                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1615                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1616                     }
1617                 } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1618                     // See above comment for AdornedTargetCollectionMetadata
1619                     MapMetadata mmd = (MapMetadata) p.getMetadata();
1620 
<abbr title="1621                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1621                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1622                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,">1622                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
1623                             alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1624 
<abbr title="1625                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1625                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1626                             mmd.getTargetClass(), sectionCrumbs);
1627                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1628 
1629                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1630                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1630                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1631                     } else {
<abbr title="1632                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1632                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1633                     }
1634                 }
1635             }
1636 
<abbr title="1637             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1637             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1638             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1639 
1640             boolean atLeastOneBasicField = false;
1641             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1642                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">1642                 if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName(ðŸ”µ</abbr>
1643                     atLeastOneBasicField = true;
1644                     break;
1645                 }
1646             }
1647             if (!atLeastOneBasicField) {
1648                 entityForm.removeAction(DefaultEntityFormActions.SAVE);
1649             }
1650             addAuditableDisplayFields(entityForm);
1651             model.addAttribute(&quot;entityForm&quot;, entityForm);
1652             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1653         } else if (md instanceof MapMetadata) {
1654             MapMetadata fmd = (MapMetadata) md;
1655 
<abbr title="1656             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1656             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1657             if (entity == null) {
<abbr title="1658                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1658                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1659                     collectionItemId, sectionCrumbs, null).getEntity();
1660             }
1661 
1662             boolean populateTypeAndId = true;
1663             if (entityForm == null) {
<abbr title="1664                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1664                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1665             } else {
1666                 //save off the prior key before clearing out the fields map as it will not appear
1667                 //back on the saved entity
1668                 String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1669                 entityForm.clearFieldsMap();
1670                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1671                 entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1672                 populateTypeAndId = false;
1673             }
1674 
<abbr title="1675             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1675             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1676             formService.populateMapEntityFormFields(entityForm, entity);
1677             addAuditableDisplayFields(entityForm);
1678             model.addAttribute(&quot;entityForm&quot;, entityForm);
1679             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1680         }
1681 
1682         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1683         model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1684         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1685         setModelAttributes(model, sectionKey);
1686         return MODAL_CONTAINER_VIEW;
1687     }
1688 
1689     protected EntityForm reinitializeEntityForm(final EntityForm entityForm,
1690             final ClassMetadata collectionMetadata,
1691             final Entity entity,
1692             final Map&lt;String, DynamicResultSet&gt; subRecordsMap,
1693             final List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {
1694         if (entityForm == null) {
1695             return formService
1696                     .createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);
1697         }
1698 
1699         entityForm.clearFieldsMap();
1700         formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm,
1701                 sectionCrumbs);
1702         //remove all the actions since we&#x27;re not trying to redisplay them on the form
1703         entityForm.removeAllActions();
1704 
1705         return entityForm;
1706     }
1707 
1708     /**
1709      * Updates the specified collection item
1710      *
1711      * @param request
1712      * @param response
1713      * @param model
1714      * @param pathVars
1715      * @param id
1716      * @param collectionField
<abbr title="1717      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1717      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1718      * @param entityForm
1719      * @param result
1720      * @return the return view path
1721      * @throws Exception
1722      */
1723     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
<abbr title="1724     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1724     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1725             @PathVariable  Map&lt;String, String&gt; pathVars,
1726             @PathVariable(value=&quot;id&quot;) String id,
1727             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1728             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1729             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1730             BindingResult result) throws Exception {
<abbr title="1731         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1731         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1732     }
1733 
1734     /**
1735      * Updates the specified collection item
1736      *
1737      * @param request
1738      * @param response
1739      * @param model
1740      * @param pathVars
1741      * @param id
1742      * @param collectionField
<abbr title="1743      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1743      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1744      * @param entityForm
<abbr title="1745      * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1745      * @param alternateId in the case of adorned target collections, this is the primary key value of theðŸ”µ</abbr>
1746      * @param result
1747      * @return the return view path
1748      * @throws Exception
1749      */
<abbr title="1750     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1750     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1751     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1751     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1752             @PathVariable  Map&lt;String, String&gt; pathVars,
1753             @PathVariable(value=&quot;id&quot;) String id,
1754             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1755             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1756             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1757             @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1758             BindingResult result) throws Exception {
1759         String sectionKey = getSectionKey(pathVars);
1760         String mainClassName = getClassNameForSection(sectionKey);
1761         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1762         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1762         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1763         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1764 
<abbr title="1765         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1765         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1766         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1766         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1767 
1768         // First, we must save the collection entity
<abbr title="1769         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1769         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadðŸ”µ</abbr>
1770         Entity savedEntity = persistenceResponse.getEntity();
1771         entityFormValidator.validate(entityForm, savedEntity, result);
1772 
1773         if (result.hasErrors()) {
<abbr title="1774             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1774             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1775                     ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1776         }
1777 
1778         // Next, we must get the new list grid that represents this collection
1779         // We return the new list grid so that it can replace the currently visible one
<abbr title="1780         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1780         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1781 
1782         model.addAttribute(&quot;listGrid&quot;, listGrid);
1783         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1784         setModelAttributes(model, sectionKey);
1785         return &quot;views/standaloneListGrid&quot;;
1786     }
1787 
<abbr title="1788     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)">1788     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMetðŸ”µ</abbr>
1789     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1790             HttpServletResponse response, Model model,
1791             @PathVariable  Map&lt;String, String&gt; pathVars,
1792             @PathVariable(value=&quot;id&quot;) String id,
1793             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1794             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1795             @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1796         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1796         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collðŸ”µ</abbr>
1797     }
1798 
1799     /**
<abbr title="1800      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections">1800      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target colðŸ”µ</abbr>
<abbr title="1801      * where a sort field is specified -- any other invocation is incorrect and will result in an exception.">1801      * where a sort field is specified -- any other invocation is incorrect and will result in an exceptiðŸ”µ</abbr>
1802      *
1803      * @param request
1804      * @param response
1805      * @param model
1806      * @param pathVars
1807      * @param id
1808      * @param collectionField
1809      * @param collectionItemId
1810      * @return an object explaining the state of the operation
1811      * @throws Exception
1812      */
<abbr title="1813     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1813     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, methoðŸ”µ</abbr>
1814     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1815             HttpServletResponse response, Model model,
1816             @PathVariable  Map&lt;String, String&gt; pathVars,
1817             @PathVariable(value=&quot;id&quot;) String id,
1818             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1819             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1820             @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1821             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1822         String sectionKey = getSectionKey(pathVars);
1823         String mainClassName = getClassNameForSection(sectionKey);
1824         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1825         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1825         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1826         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1827         FieldMetadata md = collectionProperty.getMetadata();
1828 
<abbr title="1829         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1829         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1830         ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1831 
<abbr title="1832         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1832         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1833 
1834         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1835 
1836         if (md instanceof AdornedTargetCollectionMetadata) {
1837             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1838             AdornedTargetList atl = ppr.getAdornedList();
1839 
1840             // Get an entity form for the entity
<abbr title="1841             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1841             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, falseðŸ”µ</abbr>
<abbr title="1842             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1842             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProðŸ”µ</abbr>
<abbr title="1843                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})">1843                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;}ðŸ”µ</abbr>
1844                     .getDynamicResultSet().getRecords()[0];
1845             formService.populateEntityFormFields(entityForm, entity);
1846             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1847 
<abbr title="1848             // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">1848             // Set the new sequence (note that it will come in 0-indexed but the persistence module expecðŸ”µ</abbr>
1849             int sequenceValue = Integer.parseInt(newSequence) + 1;
1850             Field field = entityForm.findField(atl.getSortField());
1851             field.setValue(String.valueOf(sequenceValue));
1852 
1853             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1854             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">1854             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1855             Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
1856 
1857             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1858             responseMap.put(&quot;field&quot;, collectionField);
1859             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1860             return responseMap;
1861         } else if (md instanceof BasicCollectionMetadata) {
1862             BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
1863             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1864             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1864             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResulðŸ”µ</abbr>
1865 
<abbr title="1866             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1866             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1867             EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
1868             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1869                 Field f = new Field()
1870                         .withName(cd.getSortProperty())
1871                         .withFieldType(SupportedFieldType.HIDDEN.toString());
1872                 entityForm.addHiddenField(mainMetadata, f);
1873             }
1874             formService.populateEntityFormFields(entityForm, entity);
1875 
1876             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1877                 int sequenceValue = Integer.parseInt(newSequence) + 1;
1878                 Field field = entityForm.findField(cd.getSortProperty());
1879                 field.setValue(String.valueOf(sequenceValue));
1880             }
1881 
<abbr title="1882             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">1882             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1883             Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
1884 
1885             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1886             responseMap.put(&quot;field&quot;, collectionField);
1887             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1888             return responseMap;
1889         } else {
<abbr title="1890             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">1890             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collðŸ”µ</abbr>
1891         }
1892     }
1893 
1894     /**
1895      * Removes the requested collection item
1896      *
<abbr title="1897      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1897      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1898      * map collection.
1899      *
1900      * @param request
1901      * @param response
1902      * @param model
1903      * @param pathVars
1904      * @param id
1905      * @param collectionField
1906      * @param collectionItemId
1907      * @return the return view path
1908      * @throws Exception
1909      */
<abbr title="1910     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)">1910     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethoðŸ”µ</abbr>
<abbr title="1911     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1911     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1912             @PathVariable  Map&lt;String, String&gt; pathVars,
1913             @PathVariable(value=&quot;id&quot;) String id,
1914             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1915             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1916         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">1916         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1917     }
1918 
1919     /**
1920      * Removes the requested collection item
1921      *
<abbr title="1922      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1922      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1923      * map collection.
1924      *
1925      * @param request
1926      * @param response
1927      * @param model
1928      * @param pathVars
1929      * @param id
1930      * @param collectionField
1931      * @param collectionItemId
1932      * @return the return view path
1933      * @throws Exception
1934      */
<abbr title="1935     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">1935     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method ðŸ”µ</abbr>
<abbr title="1936     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1936     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1937             @PathVariable  Map&lt;String, String&gt; pathVars,
1938             @PathVariable(value=&quot;id&quot;) String id,
1939             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1940             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1941             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1942         String sectionKey = getSectionKey(pathVars);
1943         String mainClassName = getClassNameForSection(sectionKey);
1944         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1945         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1945         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1946         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1947 
1948         String priorKey = request.getParameter(&quot;key&quot;);
1949 
<abbr title="1950         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1950         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1951         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1952         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1952         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1953 
1954         // First, we must remove the collection entity
<abbr title="1955         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">1955         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectðŸ”µ</abbr>
<abbr title="1956         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {">1956         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailurðŸ”µ</abbr>
1957             String error = &quot;There was an error removing the whatever&quot;;
1958             if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
1959                 // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="1960                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">1960                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator()ðŸ”µ</abbr>
<abbr title="1961             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {">1961             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErroðŸ”µ</abbr>
1962                 error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
1963             }
1964             return new JsonResponse(response)
1965                 .with(&quot;status&quot;, &quot;error&quot;)
1966                 .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
1967                 .done();
1968         }
1969 
1970         // Next, we must get the new list grid that represents this collection
1971         // We return the new list grid so that it can replace the currently visible one
<abbr title="1972         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1972         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1973 
1974         model.addAttribute(&quot;listGrid&quot;, listGrid);
1975         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1976         setModelAttributes(model, sectionKey);
1977         return &quot;views/standaloneListGrid&quot;;
1978     }
1979 
1980     public void addAuditableDisplayFields(EntityForm entityForm) {
1981         Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
1982         if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
1983             addAuditableDisplayField(entityForm, createdBy);
1984 
1985             createdBy.setIsVisible(false);
1986         }
1987         Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
1988         if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
1989             addAuditableDisplayField(entityForm, updatedBy);
1990 
1991             updatedBy.setIsVisible(false);
1992         }
1993     }
1994 
1995     private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
1996         Field displayField = buildAuditableDisplayField(userField);
1997 
1998         AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
1999         String userName = user == null ? null : user.getName();
2000         displayField.setValue(userName);
2001 
2002         FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
2003         if (auditGroup != null) {
2004             auditGroup.addField(displayField);
2005         }
2006     }
2007 
2008     private Field buildAuditableDisplayField(Field auditableField) {
2009         return new Field().withFieldType(SupportedFieldType.STRING.toString())
2010                 .withName(auditableField.getName() + &quot;Display&quot;)
2011                 .withFriendlyName(auditableField.getFriendlyName())
2012                 .withOrder(auditableField.getOrder())
2013                 .withOwningEntityClass(auditableField.getOwningEntityClass())
2014                 .withReadOnly(true);
2015     }
2016 
2017     protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
2018         String tabName = pathVars.get(&quot;tabName&quot;);
2019         if (StringUtils.isBlank(tabName)) {
2020             TabMetadata firstTab = cmd.getFirstTab();
2021             return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
2022         }
2023         return tabName;
2024     }
2025 
2026     // *****************************************
2027     // Typed Entity Helper Methods
2028     // *****************************************
2029 
2030     protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
2031         // Check if this is a typed entity
2032         AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
2033         if (typedEntitySection != null) {
2034             // Update the friendly name for this Entity Type
2035             model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
2036         }
2037     }
2038 
2039     // *********************************
2040     // ADDITIONAL SPRING-BOUND METHODS *
2041     // *********************************
2042 
2043     /**
<abbr title="2044      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.">2044      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding ðŸ”µ</abbr>
<abbr title="2045      * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">2045      * By default, we register a binder that treats empty Strings as null and a Boolean editor that suppoðŸ”µ</abbr>
2046      * or false. If the value is passed in as null, it will treat it as false.
2047      *
2048      * @param binder
2049      */
2050     @InitBinder
2051     public void initBinder(WebDataBinder binder) {
2052         binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
2053         binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
2054     }
2055 
2056 }
 
 
 
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Open Admin Platform
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.openadmin.web.controller.entity;
  19 
  20 import com.fasterxml.jackson.databind.ObjectMapper;
  21 import java.io.Serializable;
  22 import java.io.UnsupportedEncodingException;
  23 import java.net.URLDecoder;
  24 import java.util.ArrayList;
  25 import java.util.Arrays;
  26 import java.util.HashMap;
  27 import java.util.List;
  28 import java.util.Map.Entry;
  29 import java.util.Map;
  30 import java.util.Set;
  31 import java.util.stream.Stream;
  32 import javax.annotation.Resource;
  33 import javax.servlet.http.HttpServletRequest;
  34 import javax.servlet.http.HttpServletResponse;
  35 import org.apache.commons.collections.CollectionUtils;
  36 import org.apache.commons.collections.MapUtils;
  37 import org.apache.commons.lang3.StringUtils;
  38 import org.apache.commons.logging.Log;
  39 import org.apache.commons.logging.LogFactory;
  40 import org.broadleafcommerce.common.exception.SecurityServiceException;
  41 import org.broadleafcommerce.common.exception.ServiceException;
  42 import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  43 import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
  44 import org.broadleafcommerce.common.persistence.EntityDuplicator;
  45 import org.broadleafcommerce.common.presentation.client.AddMethodType;
  46 import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  47 import org.broadleafcommerce.common.sandbox.SandBoxHelper;
  48 import org.broadleafcommerce.common.service.GenericEntityService;
  49 import org.broadleafcommerce.common.util.BLCArrayUtils;
  50 import org.broadleafcommerce.common.util.BLCMessageUtils;
  51 import org.broadleafcommerce.common.web.BroadleafRequestContext;
  52 import org.broadleafcommerce.common.web.JsonResponse;
  53 import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  54 import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  55 import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  56 import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  57 import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  58 import org.broadleafcommerce.openadmin.dto.ClassTree;
  59 import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  60 import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  61 import org.broadleafcommerce.openadmin.dto.Entity;
  62 import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  63 import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  64 import org.broadleafcommerce.openadmin.dto.MapMetadata;
  65 import org.broadleafcommerce.openadmin.dto.Property;
  66 import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  67 import org.broadleafcommerce.openadmin.dto.TabMetadata;
  68 import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  69 import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  70 import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  71 import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  72 import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  73 import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  74 import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  75 import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  76 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  76 import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExteðŸ”µ</abbr>
  77 import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  78 import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  79 import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  80 import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  81 import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  82 import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  83 import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  84 import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  85 import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  86 import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  87 import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  88 import org.broadleafcommerce.openadmin.web.form.entity.Field;
  89 import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  90 import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  91 import org.springframework.stereotype.Controller;
  92 import org.springframework.ui.Model;
  93 import org.springframework.util.MultiValueMap;
  94 import org.springframework.validation.BindingResult;
  95 import org.springframework.web.bind.WebDataBinder;
  96 import org.springframework.web.bind.annotation.InitBinder;
  97 import org.springframework.web.bind.annotation.ModelAttribute;
  98 import org.springframework.web.bind.annotation.PathVariable;
  99 import org.springframework.web.bind.annotation.RequestMapping;
 100 import org.springframework.web.bind.annotation.RequestMethod;
 101 import org.springframework.web.bind.annotation.RequestParam;
 102 import org.springframework.web.bind.annotation.ResponseBody;
 103 import org.springframework.web.servlet.DispatcherServlet;
 104 import org.springframework.web.servlet.FlashMap;
 105 import org.springframework.web.servlet.mvc.support.RedirectAttributes;
 106 import org.springframework.web.util.UrlPathHelper;
 107 
 108 
 109 /**
 110  * The default implementation of the {@link AdminAbstractController}. This delegates every call to
 111  * super and does not provide any custom-tailored functionality. It is responsible for rendering the
 112  * admin for every entity that is not explicitly customized by its own controller.
 113  *
 114  * @author Andre Azzolini (apazzolini)
 115  * @author Jeff Fischer
 116  */
 117 @Controller(&quot;blAdminBasicEntityController&quot;)
 118 @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 119 public class AdminBasicEntityController extends AdminAbstractController {
 120     protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 121 
 122     public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 123 
 124     public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 125 
 126     public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 127 
 128     @Resource(name=&quot;blSandBoxHelper&quot;)
 129     protected SandBoxHelper sandBoxHelper;
 130 
 131     @Resource(name = &quot;blAdminUserDao&quot;)
 132     protected AdminUserDao adminUserDao;
 133 
 134     @Resource(name=&quot;blDynamicEntityDao&quot;)
 135     protected DynamicEntityDao dynamicEntityDao;
 136 
 137     @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 138     protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 139 
 140     @Resource(name = &quot;blRowLevelSecurityService&quot;)
 141     protected RowLevelSecurityService rowLevelSecurityService;
 142 
 143     @Resource(name = &quot;blEntityDuplicator&quot;)
 144     protected EntityDuplicator duplicator;
 145 
 146     @Resource(name = &quot;blGenericEntityService&quot;)
 147     protected GenericEntityService genericEntityService;
 148 
 149     // ******************************************
 150     // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 151     // ******************************************
 152     /**
<abbr title=" 153      * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 153      * Renders the main entity listing for the specified class, which is based on the current sectionKey ðŸ”µ</abbr>
 154      * criteria.
 155      *
 156      * @param request
 157      * @param response
 158      * @param model
 159      * @param pathVars
 160      * @param requestParams a Map of property name -&gt; list critiera values
 161      * @return the return view path
 162      * @throws Exception
 163      */
 164     @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
<abbr title=" 165     public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model, @PathVariable"> 165     public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model, @ðŸ”µ</abbr>
 166     Map&lt;String, String&gt; pathVars, @RequestParam
 167     MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 168         String sectionKey = getSectionKey(pathVars);
 169         String sectionClassName = getClassNameForSection(sectionKey);
 170         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 171         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 171         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 172         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 173         DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 174         ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 175         listGrid.setSelectType(ListGrid.SelectType.NONE);
 176         Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 177         if (CollectionUtils.isNotEmpty(headerFields)) {
 178             Field firstField = headerFields.iterator().next();
 179             if (requestParams.containsKey(firstField.getName())) {
 180                 model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 181             }
 182         }
 183         model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 184         setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 185         model.addAttribute(&quot;listGrid&quot;, listGrid);
 186         return DEFAULT_CONTAINER_VIEW;
 187     }
 188 
<abbr title=" 189     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,"> 189     protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String seðŸ”µ</abbr>
 190             String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 191         List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 192         addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 193         extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 194         extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 195 
 196         // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 197         if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 198             model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 199         }
 200 
 201         List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 202         String requestUri = request.getRequestURI();
 203         if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
<abbr title=" 204             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 204             requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length())ðŸ”µ</abbr>
 205         }
 206 
 207         model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 208         model.addAttribute(&quot;currentUri&quot;, requestUri);
 209         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 210         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 211         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 212         model.addAttribute(&quot;mainActions&quot;, mainActions);
 213         setModelAttributes(model, sectionKey);
 214         setTypedEntityModelAttributes(request, model);
 215     }
 216 
 217     @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 218     public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 219              HttpServletResponse response, Model model,
 220              @PathVariable Map&lt;String, String&gt; pathVars,
 221              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 222         String sectionKey = getSectionKey(pathVars);
 223         String sectionClassName = getClassNameForSection(sectionKey);
 224         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 225         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 225         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
 226                 .withCustomCriteria(getCustomCriteria(requestParams));
 227 
 228         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 229 
 230         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 231         DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 232 
 233         return formService.constructSelectizeOptionMap(drs, cmd);
 234     }
 235 
 236     /**
 237      * Obtains the requested criteria parameter
 238      *
 239      * @param requestParams
 240      * @return
 241      */
 242     protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 243         if (requestParams == null || requestParams.isEmpty()) {
 244             return null;
 245         }
 246 
 247         List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 248         String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 249         return new String[] {response};
 250     }
 251 
 252     /**
<abbr title=" 253      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances"> 253      * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new inðŸ”µ</abbr>
 254      * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 255      *
 256      * @param sectionClassName
 257      * @param cmd
 258      * @param mainActions
 259      */
<abbr title=" 260     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 260     protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormActioðŸ”µ</abbr>
 261         if (isAddActionAllowed(sectionClassName, cmd)) {
 262             mainActions.add(DefaultMainActions.ADD);
 263         }
 264     }
 265 
 266     protected boolean isAddActionAllowed(final String sectionClassName, final ClassMetadata cmd) {
 267         // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
 268         try {
 269             adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 270         } catch (ServiceException e) {
 271             if (e instanceof SecurityServiceException) {
 272                 return false;
 273             }
 274         }
<abbr title=" 275         final boolean canAdd = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);"> 275         final boolean canAdd = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdmðŸ”µ</abbr>
 276         return isNotReadOnly(cmd) &amp;&amp; canAdd;
 277     }
 278 
 279     protected boolean isNotReadOnly(final ClassMetadata cmd) {
 280                 //check if all the metadata is read only
 281         for (Property property : cmd.getProperties()) {
 282             if (property.getMetadata() instanceof BasicFieldMetadata) {
<abbr title=" 283                 if ((((BasicFieldMetadata) (property.getMetadata())).getReadOnly() == null) || (!((BasicFieldMetadata) (property.getMetadata())).getReadOnly())) {"> 283                 if ((((BasicFieldMetadata) (property.getMetadata())).getReadOnly() == null) || (!((BasicFðŸ”µ</abbr>
 284                     return true;
 285                 }
 286             }
 287         }
 288         return false;
 289     }
 290 
 291     /**
<abbr title=" 292      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any"> 292      * Renders the modal form that is used to add a new parent level entity. Note that this form cannot rðŸ”µ</abbr>
<abbr title=" 293      * subcollections as operations on those collections require the parent level entity to first be saved and have"> 293      * subcollections as operations on those collections require the parent level entity to first be saveðŸ”µ</abbr>
<abbr title=" 294      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 294      * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity ðŸ”µ</abbr>
 295      * they can then perform operations on sub collections.
 296      *
 297      * @param request
 298      * @param response
 299      * @param model
 300      * @param pathVars
 301      * @param entityType
 302      * @return the return view path
 303      * @throws Exception
 304      */
 305     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
<abbr title=" 306     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model, @PathVariable"> 306     public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
 307     Map&lt;String, String&gt; pathVars, @RequestParam(defaultValue = &quot;&quot;)
 308     String entityType) throws Exception {
 309         String sectionKey = getSectionKey(pathVars);
 310         String sectionClassName = getClassNameForSection(sectionKey);
 311         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 312         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 312         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 313         ppr.setAddOperationInspect(true);
 314         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 315         entityType = determineEntityType(entityType, cmd);
 316         EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);
<abbr title=" 317         // We need to make sure that the ceiling entity is set to the interface and the specific entity type"> 317         // We need to make sure that the ceiling entity is set to the interface and the specific entity tðŸ”µ</abbr>
 318         // is set to the type we&#x27;re going to be creating.
 319         entityForm.setCeilingEntityClassname(cmd.getCeilingType());
 320         entityForm.setEntityType(entityType);
<abbr title=" 321         // When we initially build the class metadata (and thus, the entity form), we had all of the possible"> 321         // When we initially build the class metadata (and thus, the entity form), we had all of the possðŸ”µ</abbr>
<abbr title=" 322         // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the"> 322         // polymorphic fields built out. Now that we have a concrete entity type to render, we can removeðŸ”µ</abbr>
 323         // fields that are not applicable for this given entity type.
 324         formService.removeNonApplicableFields(cmd, entityForm, entityType);
 325         modifyAddEntityForm(entityForm, pathVars);
 326         model.addAttribute(&quot;entityForm&quot;, entityForm);
 327         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 328         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 329         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 330         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 331         setModelAttributes(model, sectionKey);
 332         return MODAL_CONTAINER_VIEW;
 333     }
 334 
 335     // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic
 336     // types for this entity.
<abbr title=" 337     protected String determineEntityType(String entityType, final ClassMetadata cmd) throws UnsupportedEncodingException {"> 337     protected String determineEntityType(String entityType, final ClassMetadata cmd) throws UnsupportedEnðŸ”µ</abbr>
 338         if (StringUtils.isBlank(entityType)) {
 339             if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 340                 entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 341             } else {
 342                 entityType = getDefaultEntityType();
 343             }
 344         } else {
 345             entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 346         }
 347         return entityType;
 348     }
 349 
 350     /**
<abbr title=" 351      * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity."> 351      * Processes the request to add a new entity. If successful, returns a redirect to the newly created ðŸ”µ</abbr>
 352      *
 353      * @param request
 354      * @param response
 355      * @param model
 356      * @param pathVars
 357      * @param entityForm
 358      * @param result
 359      * @return the return view path
 360      * @throws Exception
 361      */
 362     @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
<abbr title=" 363     public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model, @PathVariable"> 363     public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model, @PathVðŸ”µ</abbr>
 364     Map&lt;String, String&gt; pathVars, @ModelAttribute(&quot;entityForm&quot;)
 365     EntityForm entityForm, BindingResult result) throws Exception {
 366         String sectionKey = getSectionKey(pathVars);
 367         String sectionClassName = getClassNameForSection(sectionKey);
 368         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 369         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 369         ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassNameðŸ”µ</abbr>
 370         extractDynamicFormFields(cmd, entityForm);
<abbr title=" 371         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 371         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 372         Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 373         entityFormValidator.validate(entityForm, entity, result);
 374         if (result.hasErrors()) {
 375             entityForm.clearFieldsMap();
 376             formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 377             formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 378             modifyAddEntityForm(entityForm, pathVars);
 379             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 380             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 381             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 382             model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 383             setModelAttributes(model, sectionKey);
 384             return MODAL_CONTAINER_VIEW;
 385         }
 386         // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 387         return (((&quot;ajaxredirect:&quot; + getContextPath(request)) + sectionKey) + &quot;/&quot;) + entity.getPMap().get(&quot;id&quot;).getValue();"> 387         return (((&quot;ajaxredirect:&quot; + getContextPath(request)) + sectionKey) + &quot;/&quot;) + entity.getPMap().get(ðŸ”µ</abbr>
 388     }
 389 
 390     @RequestMapping(value = &quot;/{id}/duplicate&quot;, method = RequestMethod.POST)
<abbr title=" 391     public String duplicateEntity(final HttpServletRequest request, final HttpServletResponse response, final Model model, @PathVariable"> 391     public String duplicateEntity(final HttpServletRequest request, final HttpServletResponse response, fðŸ”µ</abbr>
 392     final Map&lt;String, String&gt; pathVars, @PathVariable(&quot;id&quot;)
 393     final String id, @ModelAttribute(&quot;entityForm&quot;)
 394     final EntityForm entityForm, final BindingResult result) throws Exception {
 395         final String sectionKey = getSectionKey(pathVars);
 396         final String sectionClassName = getClassNameForSection(sectionKey);
 397         final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(sectionClassName);
 398         final long identifier = Long.parseLong(id);
 399         if (duplicator.validate(entityClass, identifier)) {
 400             final Object duplicate;
 401             try {
 402                 duplicate = duplicator.copy(entityClass, identifier);
 403             } catch (java.lang.Exception e) {
 404                 LOG.error(&quot;Could not duplicate entity&quot;, e);
 405                 return getErrorDuplicatingResponse(response, &quot;Duplication_Failure&quot;);
 406             }
 407             final Serializable dupId = genericEntityService.getIdentifier(duplicate);
 408             // Note that AJAX Redirects need the context path prepended to them
 409             return (((&quot;ajaxredirect:&quot; + getContextPath(request)) + sectionKey) + &quot;/&quot;) + dupId;
 410         } else {
 411             return getErrorDuplicatingResponse(response, &quot;Validation_Failure&quot;);
 412         }
 413     }
 414 
 415     protected String getErrorDuplicatingResponse(HttpServletResponse response, String code) {
 416         List&lt;Map&lt;String, Object&gt;&gt; errors = new ArrayList&lt;&gt;();
 417         String message;
 418         BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();
 419         if ((context != null) &amp;&amp; (context.getMessageSource() != null)) {
 420             message = context.getMessageSource().getMessage(code, null, code, context.getJavaLocale());
 421         } else {
<abbr title=" 422             LOG.warn(&quot;Could not find the MessageSource on the current request, &quot; + &quot;not translating the message key&quot;);"> 422             LOG.warn(&quot;Could not find the MessageSource on the current request, &quot; + &quot;not translating the mðŸ”µ</abbr>
 423             message = &quot;Duplication_Failure&quot;;
 424         }
 425         Map&lt;String, Object&gt; errorMap = new HashMap&lt;&gt;();
 426         errorMap.put(&quot;errorType&quot;, &quot;global&quot;);
 427         errorMap.put(&quot;code&quot;, code);
 428         errorMap.put(&quot;message&quot;, message);
 429         errors.add(errorMap);
 430         return new JsonResponse(response).with(&quot;errors&quot;, errors).done();
 431     }
 432 
 433     /**
 434      * Renders the main entity form for the specified entity
 435      *
 436      * @param request
 437      * @param response
 438      * @param model
 439      * @param pathVars
 440      * @param id
 441      * @return the return view path
 442      * @throws Exception
 443      */
 444     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
<abbr title=" 445     public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model, @PathVariable"> 445     public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model, @ðŸ”µ</abbr>
 446     Map&lt;String, String&gt; pathVars, @PathVariable(&quot;id&quot;)
 447     String id) throws Exception {
 448         String sectionKey = getSectionKey(pathVars);
 449         String sectionClassName = getClassNameForSection(sectionKey);
 450         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 451         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 451         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 452         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 453         Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 454         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 454         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 455         EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 456         modifyEntityForm(entity, entityForm, pathVars);
 457         if (request.getParameter(&quot;headerFlash&quot;) != null) {
 458             model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 459         }
 460         // Set the sectionKey again incase this is a typed entity
 461         entityForm.setSectionKey(sectionKey);
 462         // Build the current url in the cast that this is a typed entity
 463         String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 464         int startIndex = request.getContextPath().length();
 465         // Remove the context path from servlet path
 466         String currentUrl = originatingUri.substring(startIndex);
 467         model.addAttribute(&quot;entity&quot;, entity);
 468         model.addAttribute(&quot;entityForm&quot;, entityForm);
 469         model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 470         setModelAttributes(model, sectionKey);
 471         // We want to replace author ids with their names
 472         addAuditableDisplayFields(entityForm);
 473         return resolveAppropriateEntityView(request, model, entityForm);
 474     }
 475 
<abbr title=" 476     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 476     protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, StrðŸ”µ</abbr>
 477                                                               ClassMetadata cmd, Entity entity,
<abbr title=" 478                                                               List&lt;SectionCrumb&gt; crumbs) throws Exception {"> 478                                                               List&lt;SectionCrumb&gt; crumbs) throws ExceptionðŸ”µ</abbr>
 479         String tabName = pathVars.get(&quot;tabName&quot;);
 480         if (StringUtils.isEmpty(tabName)) {
 481             tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 482         }
 483         return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 484     }
 485 
 486     private boolean isAddRequest(Entity entity) {
 487         ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 488         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);"> 488         ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder)ðŸ”µ</abbr>
 489         if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 490             return false;
 491         }
 492 
 493         return resultHolder.getResult();
 494     }
 495 
 496     /**
 497      * Attempts to get the List Grid for the selected tab.
 498      *
 499      * @param request
 500      * @param response
 501      * @param model
 502      * @param pathVars
 503      * @param id
 504      * @param tabName
 505      * @param entityForm
 506      * @param entity
 507      * @return the return view path
 508      * @throws Exception
 509      */
 510     @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
<abbr title=" 511     public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model, @PathVariable"> 511     public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model, @PðŸ”µ</abbr>
 512     Map&lt;String, String&gt; pathVars, @PathVariable(&quot;id&quot;)
 513     String id, @PathVariable(&quot;tabName&quot;)
 514     String tabName, @ModelAttribute(&quot;entityForm&quot;)
 515     EntityForm entityForm, @ModelAttribute(&quot;entity&quot;)
 516     Entity entity) throws Exception {
 517         String sectionKey = getSectionKey(pathVars);
 518         String sectionClassName = getClassNameForSection(sectionKey);
 519         List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 520         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);"> 520         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, patðŸ”µ</abbr>
 521         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 522         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 523         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);"> 523         Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, cðŸ”µ</abbr>
 524         entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 525         modifyEntityForm(entity, entityForm, pathVars);
 526         model.addAttribute(&quot;entity&quot;, entity);
 527         model.addAttribute(&quot;entityForm&quot;, entityForm);
 528         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 529         setModelAttributes(model, sectionKey);
 530         model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 531         model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 532         return DEFAULT_CONTAINER_VIEW;
 533     }
 534 
 535     /**
 536      * Builds JSON that looks like this:
 537      *
 538      * {&quot;errors&quot;:
 539      *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 540      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 541      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 542      *        &quot;errorType&quot;, &quot;field&quot;,
 543      *        &quot;tab&quot;: &quot;General&quot;
 544      *        },
 545      *        {&quot;message&quot;:&quot;This field is Required&quot;,
 546      *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 547      *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 548      *        &quot;errorType&quot;, &quot;field&quot;,
 549      *        &quot;tab&quot;: &quot;General&quot;
 550      *        }]
 551      * }
 552      *
 553      */
 554     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 555     public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 556             @PathVariable Map&lt;String, String&gt; pathVars,
 557             @PathVariable(value = &quot;id&quot;) String id,
 558             @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 559             RedirectAttributes ra) throws Exception {
 560 
 561         saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 562 
 563         JsonResponse json = new JsonResponse(response);
 564         if (result.hasErrors()) {
 565             populateJsonValidationErrors(entityForm, result, json);
 566         }
 567         List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 568         if (CollectionUtils.isNotEmpty(dirtyList)) {
 569             json.with(&quot;dirty&quot;, dirtyList);
 570         }
 571 
 572         ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 573         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 573         ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonReðŸ”µ</abbr>
 574         if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 575             return resultHolder.getResult();
 576         }
 577 
 578         return json.done();
 579     }
 580 
<abbr title=" 581     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 581     public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String iðŸ”µ</abbr>
 582         List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 583         String sectionKey = getSectionKey(pathVars);
 584         String sectionClassName = getClassNameForSection(sectionKey);
 585         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 586         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 586         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 587         ClassMetadata cmd = null;
 588         Entity entity = null;
 589         cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 590         entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 591 
 592         for (Property p: entity.getProperties()) {
 593             if (p.getIsDirty()) {
 594                 dirtyList.add(p.getName());
 595             }
 596         }
 597         return dirtyList;
 598     }
 599 
 600     /**
<abbr title=" 601      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with"> 601      * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity forðŸ”µ</abbr>
 602      * error fields highlighted. On a successful save, it will refresh the entity page.
 603      *
 604      * @param request
 605      * @param response
 606      * @param model
 607      * @param pathVars
 608      * @param id
 609      * @param entityForm
 610      * @param result
 611      * @return the return view path
 612      * @throws Exception
 613      */
 614     @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
<abbr title=" 615     public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model, @PathVariable"> 615     public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model, @PathðŸ”µ</abbr>
 616     Map&lt;String, String&gt; pathVars, @PathVariable(&quot;id&quot;)
 617     String id, @ModelAttribute(&quot;entityForm&quot;)
 618     EntityForm entityForm, BindingResult result, RedirectAttributes ra) throws Exception {
 619         String sectionKey = getSectionKey(pathVars);
 620         String sectionClassName = getClassNameForSection(sectionKey);
 621         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 622         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 622         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumðŸ”µ</abbr>
 623         ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 624         extractDynamicFormFields(cmd, entityForm);
<abbr title=" 625         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 625         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 626         Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 627         entityFormValidator.validate(entityForm, entity, result);
 628         if (result.hasErrors()) {
 629             model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 630             model.addAttribute(&quot;headerFlashAlert&quot;, true);
<abbr title=" 631             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 631             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entðŸ”µ</abbr>
 632             entityForm.clearFieldsMap();
 633             formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 634             modifyEntityForm(entity, entityForm, pathVars);
 635             model.addAttribute(&quot;entity&quot;, entity);
 636             model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 637             setModelAttributes(model, sectionKey);
 638             return resolveAppropriateEntityView(request, model, entityForm);
 639         }
 640         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 641         return ((&quot;redirect:/&quot; + sectionKey) + &quot;/&quot;) + id;
 642     }
 643 
<abbr title=" 644     protected void modifyEntityForm(final Entity entity, final EntityForm entityForm, final Map&lt;String, String&gt; pathVars) throws Exception {"> 644     protected void modifyEntityForm(final Entity entity, final EntityForm entityForm, final Map&lt;String, SðŸ”µ</abbr>
 645         if (isAddRequest(entity)) {
 646             modifyAddEntityForm(entityForm, pathVars);
 647         } else {
 648             modifyEntityForm(entityForm, pathVars);
 649         }
 650     }
 651 
<abbr title=" 652     protected String resolveAppropriateEntityView(final HttpServletRequest request, final Model model, @ModelAttribute(&quot;entityForm&quot;)"> 652     protected String resolveAppropriateEntityView(final HttpServletRequest request, final Model model, @MðŸ”µ</abbr>
 653     final EntityForm entityForm) {
 654         if (isAjaxRequest(request)) {
 655             entityForm.setReadOnly();
 656             model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 657             model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 658             return MODAL_CONTAINER_VIEW;
 659         } else {
 660             model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 661             model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 662             return DEFAULT_CONTAINER_VIEW;
 663         }
 664     }
 665 
 666     /**
 667      * Attempts to remove the given entity.
 668      *
 669      * @param request
 670      * @param response
 671      * @param model
 672      * @param pathVars
 673      * @param id
 674      * @return the return view path
 675      * @throws Exception
 676      */
 677     @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
<abbr title=" 678     public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model, @PathVariable"> 678     public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model, @PaðŸ”µ</abbr>
 679     Map&lt;String, String&gt; pathVars, @PathVariable(&quot;id&quot;)
 680     String id, @ModelAttribute(&quot;entityForm&quot;)
 681     EntityForm entityForm, BindingResult result, RedirectAttributes ra) throws Exception {
 682         String sectionKey = getSectionKey(pathVars);
 683         String sectionClassName = getClassNameForSection(sectionKey);
 684         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 685         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 685         String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getðŸ”µ</abbr>
 686         Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 687         // Removal does not normally return an Entity unless there is some validation error
 688         if (entity != null) {
 689             entityFormValidator.validate(entityForm, entity, result);
 690             if (result.hasErrors()) {
 691                 // Create a flash attribute for the unsuccessful delete
 692                 FlashMap fm = new FlashMap();
 693                 fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 694                 fm.put(&quot;headerFlashAlert&quot;, true);
 695                 request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 696                 // Re-look back up the entity so that we can return something populated
<abbr title=" 697                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 697                 PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, secðŸ”µ</abbr>
<abbr title=" 698                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 698                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
 699                 entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 700                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 700                 Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr,ðŸ”µ</abbr>
 701                 entityForm.clearFieldsMap();
 702                 formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 703                 modifyEntityForm(entityForm, pathVars);
<abbr title=" 704                 return populateJsonValidationErrors(entityForm, result, new JsonResponse(response)).done();"> 704                 return populateJsonValidationErrors(entityForm, result, new JsonResponse(response)).done(ðŸ”µ</abbr>
 705             }
 706         }
 707         ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 708         ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 709         if (isAjaxRequest(request)) {
 710             // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
<abbr title=" 711             return ((&quot;ajaxredirect:&quot; + getContextPath(request)) + sectionKey) + &quot;?headerFlash=delete.successful&quot;;"> 711             return ((&quot;ajaxredirect:&quot; + getContextPath(request)) + sectionKey) + &quot;?headerFlash=delete.succðŸ”µ</abbr>
 712         } else {
 713             return &quot;redirect:/&quot; + sectionKey;
 714         }
 715     }
 716 
 717     @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 718     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 718     public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpSeðŸ”µ</abbr>
 719             @PathVariable  Map&lt;String, String&gt; pathVars,
 720             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 721             @RequestParam String ids,
 722             @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 723         String sectionKey = getSectionKey(pathVars);
 724         String sectionClassName = getClassNameForSection(sectionKey);
 725         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 726         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 726         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParaðŸ”µ</abbr>
<abbr title=" 727         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 727         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 728         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 729         FieldMetadata md = collectionProperty.getMetadata();
 730 
 731         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 732         ppr.setStartIndex(getStartIndex(requestParams));
 733         ppr.setMaxIndex(getMaxIndex(requestParams));
 734 
 735         if (md instanceof BasicFieldMetadata) {
 736             String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 737             String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 738 
 739             List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 740             ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 741 
 742             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 743             Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 744 
 745             for (Entity e : drs.getRecords()) {
 746                 String id = e.getPMap().get(idProp).getValue();
 747                 String disp = e.getPMap().get(displayProp).getDisplayValue();
 748 
 749                 if (StringUtils.isBlank(disp)) {
 750                     disp = e.getPMap().get(displayProp).getValue();
 751                 }
 752 
 753                 returnMap.put(id,  disp);
 754             }
 755 
 756             return returnMap;
 757         }
 758 
 759         return null;
 760     }
 761 
 762     /**
<abbr title=" 763      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 763      * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a ðŸ”µ</abbr>
 764      * then this method is invoked when a user clicks on the name of the default category field.
 765      *
 766      * @param request
 767      * @param response
 768      * @param model
 769      * @param pathVars
 770      * @param collectionField
 771      * @param id
 772      * @return
 773      * @throws Exception
 774      */
 775     @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
<abbr title=" 776     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 776     public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 777             @PathVariable  Map&lt;String, String&gt; pathVars,
 778             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 779             @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 780         String sectionKey = getSectionKey(pathVars);
 781         String mainClassName = getClassNameForSection(sectionKey);
 782         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 783         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 783         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 784         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 785         BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 786 
<abbr title=" 787         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 787         AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeðŸ”µ</abbr>
<abbr title=" 788         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 788         String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : sectiðŸ”µ</abbr>
 789         Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 790         varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 791         return viewEntityForm(request, response, model, varsForField, id);
 792     }
 793 
 794     @RequestMapping(
 795             value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 796             method = RequestMethod.POST
 797     )
<abbr title=" 798     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,"> 798     public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 799                                         @PathVariable  Map&lt;String, String&gt; pathVars,
 800                                         @PathVariable(value=&quot;id&quot;) String id,
 801                                         @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 802                                         @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 803                                         @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 804                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 804                                         @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throðŸ”µ</abbr>
 805 
<abbr title=" 806         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 806         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
 807     }
 808 
 809     /**
 810      * Returns the records for a given collectionField filtered by a particular criteria
 811      *
 812      * @param request
 813      * @param response
 814      * @param model
 815      * @param pathVars
 816      * @param collectionField
 817      * @param requestParams
 818      * @return the return view path
 819      * @throws Exception
 820      */
 821     @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
<abbr title=" 822     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,"> 822     public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, ModðŸ”µ</abbr>
 823             @PathVariable  Map&lt;String, String&gt; pathVars,
 824             @PathVariable(value=&quot;id&quot;) String id,
 825             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 826             @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 827         String sectionKey = getSectionKey(pathVars);
 828         String mainClassName = getClassNameForSection(sectionKey);
 829         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 830         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);"> 830         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams,ðŸ”µ</abbr>
<abbr title=" 831         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 831         ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDataðŸ”µ</abbr>
 832         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 833 
 834         ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
<abbr title=" 835         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];"> 835         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
 836 
 837         // Next, we must get the new list grid that represents this collection
<abbr title=" 838         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);"> 838         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParamsðŸ”µ</abbr>
 839         model.addAttribute(&quot;listGrid&quot;, listGrid);
 840 
 841         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 842 
 843         // We return the new list grid so that it can replace the currently visible one
 844         setModelAttributes(model, sectionKey);
 845         return &quot;views/standaloneListGrid&quot;;
 846     }
 847 
 848     /**
<abbr title=" 849      * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes"> 849      * Shows the modal dialog that is used to add an item to a given collection. There are several possibðŸ”µ</abbr>
 850      * of this call depending on the type of the specified collection field.
 851      *
 852      * &lt;ul&gt;
 853      *  &lt;li&gt;
<abbr title=" 854      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may"> 854      *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so thaðŸ”µ</abbr>
<abbr title=" 855      *    enter information and associate the record with this collection. Used by fields such as ProductAttribute."> 855      *    enter information and associate the record with this collection. Used by fields such as ProductðŸ”µ</abbr>
 856      *  &lt;/li&gt;
 857      *  &lt;li&gt;
<abbr title=" 858      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it."> 858      *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entiðŸ”µ</abbr>
 859      *    Used by fields such as &quot;allParentCategories&quot;.
 860      *  &lt;/li&gt;
 861      *  &lt;li&gt;
<abbr title=" 862      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 862      *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click onðŸ”µ</abbr>
<abbr title=" 863      *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation"> 863      *    select it. The view rendered by this is identical to basic collection (lookup), but will perforðŸ”µ</abbr>
<abbr title=" 864      *    on an adorned field, which may carry extra meta-information about the created relationship, such as order."> 864      *    on an adorned field, which may carry extra meta-information about the created relationship, sucðŸ”µ</abbr>
 865      *  &lt;/li&gt;
 866      *  &lt;li&gt;
<abbr title=" 867      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 867      *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on anðŸ”µ</abbr>
<abbr title=" 868      *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified"> 868      *    select it. Once the user selects the entity, he will be presented with an empty form based on tðŸ”µ</abbr>
<abbr title=" 869      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition"> 869      *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, whiðŸ”µ</abbr>
 870      *    to linking an entity, provide extra fields, such as a promotional message.
 871      *  &lt;/li&gt;
 872      *  &lt;li&gt;
<abbr title=" 873      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is"> 873      *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. ðŸ”µ</abbr>
<abbr title=" 874      *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another"> 874      *    populated either from the configured map keys, or as a result of a lookup in the case of a key ðŸ”µ</abbr>
 875      *    entity. Used by fields such as the mediaMap on a Sku.
 876      *  &lt;/li&gt;
 877      *
 878      * @param request
 879      * @param response
 880      * @param model
 881      * @param pathVars
 882      * @param id
 883      * @param collectionField
 884      * @param requestParams
 885      * @return the return view path
 886      * @throws Exception
 887      */
 888     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
<abbr title=" 889     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model, @PathVariable"> 889     public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model mðŸ”µ</abbr>
 890     Map&lt;String, String&gt; pathVars, @PathVariable(&quot;id&quot;)
 891     String id, @PathVariable(&quot;collectionField&quot;)
 892     String collectionField, @RequestParam
 893     MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 894         String sectionKey = getSectionKey(pathVars);
 895         String mainClassName = getClassNameForSection(sectionKey);
 896         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 897         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 897         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 898         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 899         FieldMetadata md = collectionProperty.getMetadata();
<abbr title=" 900         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs).withFilterAndSortCriteria(getCriteria(requestParams)).withStartIndex(getStartIndex(requestParams)).withMaxIndex(getMaxIndex(requestParams)).withLastId(getLastId(requestParams)).withFirstId(getFirstId(requestParams)).withUpperCount(getUpperCount(requestParams)).withLowerCount(getLowerCount(requestParams)).withPageSize(getPageSize(requestParams)).withPresentationFetch(true);"> 900         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs).withFilðŸ”µ</abbr>
 901         if (md instanceof BasicCollectionMetadata) {
 902             BasicCollectionMetadata fmd = ((BasicCollectionMetadata) (md));
 903             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title=" 904                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();"> 904                 ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData(ðŸ”µ</abbr>
<abbr title=" 905                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types"> 905                 // If the entity type isn&#x27;t specified, we need to determine if there are various polymorpðŸ”µ</abbr>
 906                 // for this entity.
 907                 String entityType = null;
 908                 if (requestParams.containsKey(&quot;entityType&quot;)) {
 909                     entityType = requestParams.get(&quot;entityType&quot;).get(0);
 910                 }
 911                 entityType = determineEntityType(entityType, cmd);
 912                 if (StringUtils.isBlank(entityType)) {
 913                     return getModalForBlankEntityType(request, model, sectionKey, cmd);
 914                 }
 915                 ppr = ppr.withCeilingEntityClassname(entityType);
 916             }
 917         } else if (md instanceof MapMetadata) {
<abbr title=" 918             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request, response, model, sectionKey, id, requestParams, ((MapMetadata) (md)));"> 918             ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionTypðŸ”µ</abbr>
 919             if (result.equals(ExtensionResultStatusType.HANDLED)) {
 920                 model.addAttribute(&quot;entityId&quot;, id);
 921                 model.addAttribute(&quot;sectionKey&quot;, sectionKey);
 922                 model.addAttribute(&quot;collectionField&quot;, collectionField);
 923                 return MODAL_CONTAINER_VIEW;
 924             }
 925         }
 926         model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
<abbr title=" 927         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);"> 927         return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, colðŸ”µ</abbr>
 928     }
 929 
<abbr title=" 930     protected String getModalForBlankEntityType(final HttpServletRequest request, final Model model, final String sectionKey, final ClassMetadata cmd) {"> 930     protected String getModalForBlankEntityType(final HttpServletRequest request, final Model model, finaðŸ”µ</abbr>
 931         final List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 932         model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 933         model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
 934         model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 935         String requestUri = request.getRequestURI();
 936         final String contextPath = request.getContextPath();
 937         if ((!contextPath.equals(&quot;/&quot;)) &amp;&amp; requestUri.startsWith(contextPath)) {
 938             requestUri = requestUri.substring(contextPath.length() + 1, requestUri.length());
 939         }
 940         model.addAttribute(&quot;currentUri&quot;, requestUri);
 941         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 942         setModelAttributes(model, sectionKey);
 943         return MODAL_CONTAINER_VIEW;
 944     }
 945 
<abbr title=" 946     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)"> 946     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMðŸ”µ</abbr>
<abbr title=" 947     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 947     public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
 948             @PathVariable Map&lt;String, String&gt; pathVars,
 949             @PathVariable(value=&quot;id&quot;) String id,
 950             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 951             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
 952         String sectionKey = getSectionKey(pathVars);
 953         String mainClassName = getClassNameForSection(sectionKey);
 954         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 955         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 955         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 956         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 957         FieldMetadata md = collectionProperty.getMetadata();
 958         Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
 959         if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title=" 960             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,"> 960             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
 961                     collectionField,
 962                     collectionItemId, responseMap);
 963         }
 964         return responseMap;
 965     }
 966 
 967     /**
 968      *
 969      * @param request
 970      * @param response
 971      * @param model
 972      * @param pathVars
 973      * @param id
 974      * @param collectionField
 975      * @param requestParams
 976      * @return Json collection data
 977      * @throws Exception
 978      */
 979     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
 980     @ResponseBody
<abbr title=" 981     public Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model, @PathVariable"> 981     public Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletRespoðŸ”µ</abbr>
 982     Map&lt;String, String&gt; pathVars, @PathVariable(&quot;id&quot;)
 983     String id, @PathVariable(&quot;collectionField&quot;)
 984     String collectionField, @RequestParam
 985     MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 986         String sectionKey = getSectionKey(pathVars);
 987         String mainClassName = getClassNameForSection(sectionKey);
 988         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 989         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 989         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
 990         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 991         FieldMetadata md = collectionProperty.getMetadata();
<abbr title=" 992         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs).withFilterAndSortCriteria(getCriteria(requestParams)).withStartIndex(getStartIndex(requestParams)).withMaxIndex(getMaxIndex(requestParams));"> 992         PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs).withFilðŸ”µ</abbr>
<abbr title=" 993         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria())).toArray(String[]::new);"> 993         String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizðŸ”µ</abbr>
 994         ppr = ppr.withCustomCriteria(both);
 995         if (md instanceof AdornedTargetCollectionMetadata) {
 996             ppr.setOperationTypesOverride(null);
 997             ppr.setType(PersistencePackageRequest.Type.STANDARD);
 998             ppr.setSectionEntityField(collectionField);
 999         }
1000         DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1001         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1001         return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCðŸ”µ</abbr>
1002     }
1003 
1004     protected String[] buildSelectizeCustomCriteria() {
1005         return new String[]{ IS_SELECTIZE_REQUEST };
1006     }
1007 
1008     /**
1009      * Adds the requested collection item via Selectize
1010      *
1011      * @param request
1012      * @param response
1013      * @param model
1014      * @param pathVars
1015      * @param id
1016      * @param collectionField
1017      * @param entityForm
1018      * @return the return view path
1019      * @throws Exception
1020      */
1021     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1022     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1022     public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpSðŸ”µ</abbr>
1023             @PathVariable Map&lt;String, String&gt; pathVars,
1024             @PathVariable(value=&quot;id&quot;) String id,
1025             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1026             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1026             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1027         Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1028         String sectionKey = getSectionKey(pathVars);
1029         String mainClassName = getClassNameForSection(sectionKey);
1030         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1031         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1031         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1032         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1033 
1034         if (StringUtils.isBlank(entityForm.getEntityType())) {
1035             FieldMetadata fmd = collectionProperty.getMetadata();
1036             if (fmd instanceof BasicCollectionMetadata) {
1037                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1038             }
1039         }
1040 
<abbr title="1041         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1041         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1042         ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1043         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1044         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1044         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1045 
1046         // First, we must save the collection entity
<abbr title="1047         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1047         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1048         Entity savedEntity = persistenceResponse.getEntity();
1049         entityFormValidator.validate(entityForm, savedEntity, result);
1050 
1051         if (result.hasErrors()) {
1052             returnVal.put(&quot;error&quot;, result.getFieldError());
1053             return returnVal;
1054         }
1055 
1056         if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1057             returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1058         }
1059         return returnVal;
1060     }
1061 
1062     protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1063         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1063         Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().gðŸ”µ</abbr>
1064         additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1065     }
1066 
1067     /**
1068      * Adds the requested collection item
1069      *
1070      * @param request
1071      * @param response
1072      * @param model
1073      * @param pathVars
1074      * @param id
1075      * @param collectionField
1076      * @param entityForm
1077      * @return the return view path
1078      * @throws Exception
1079      */
1080     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
<abbr title="1081     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1081     public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model modelðŸ”µ</abbr>
1082             @PathVariable Map&lt;String, String&gt; pathVars,
1083             @PathVariable(value=&quot;id&quot;) String id,
1084             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1085             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1085             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1086         String sectionKey = getSectionKey(pathVars);
1087         String mainClassName = getClassNameForSection(sectionKey);
1088         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1089         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1089         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1090         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1091 
1092         if (StringUtils.isBlank(entityForm.getEntityType())) {
1093             FieldMetadata fmd = collectionProperty.getMetadata();
1094             if (fmd instanceof BasicCollectionMetadata) {
1095                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1096             }
1097         }
1098 
<abbr title="1099         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1099         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1100         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1101         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1101         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1102 
1103         // First, we must save the collection entity
<abbr title="1104         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1104         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1105         Entity savedEntity = persistenceResponse.getEntity();
1106         entityFormValidator.validate(entityForm, savedEntity, result);
1107 
1108         if (result.hasErrors()) {
1109             FieldMetadata md = collectionProperty.getMetadata();
1110             ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1111             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1111             return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey,ðŸ”µ</abbr>
1112                     md, ppr, entityForm, savedEntity);
1113         }
1114 
1115         // Next, we must get the new list grid that represents this collection
<abbr title="1116         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1116         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1117         model.addAttribute(&quot;listGrid&quot;, listGrid);
1118 
1119         // We return the new list grid so that it can replace the currently visible one
1120         model.addAttribute(&quot;actualEntityId&quot;, id);
1121         setModelAttributes(model, sectionKey);
1122         return &quot;views/standaloneListGrid&quot;;
1123     }
1124 
1125     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1126     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1126     public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse reðŸ”µ</abbr>
1127             @PathVariable Map&lt;String, String&gt; pathVars,
1128             @PathVariable(value=&quot;id&quot;) String id,
1129             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
<abbr title="1130             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {">1130             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws ExcepðŸ”µ</abbr>
1131         String sectionKey = getSectionKey(pathVars);
1132         String mainClassName = getClassNameForSection(sectionKey);
1133         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1134         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1134         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1135         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1136 
1137         if (StringUtils.isBlank(entityForm.getEntityType())) {
1138             FieldMetadata fmd = collectionProperty.getMetadata();
1139             if (fmd instanceof BasicCollectionMetadata) {
1140                 entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1141             }
1142         }
1143 
<abbr title="1144         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1144         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1145         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1145         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1146         entity.setIsPreAdd(true);
1147         // First, we must save the collection entity
<abbr title="1148         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1148         PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadataðŸ”µ</abbr>
1149         Entity savedEntity = persistenceResponse.getEntity();
1150 
1151         return new JsonResponse(response)
1152                 .with(&quot;status&quot;, &quot;complete&quot;)
1153                 .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1154                 .done();
1155     }
1156 
1157     /**
<abbr title="1158      * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1158      * Builds out all of the model information needed for showing the add modal for collection items on bðŸ”µ</abbr>
1159      * as well as after a POST with validation errors
1160      *
1161      * @param request
1162      * @param model
1163      * @param id
1164      * @param collectionField
1165      * @param sectionKey
1166      * @param collectionProperty
1167      * @param md
1168      * @param ppr
1169      * @return the appropriate view to display for the modal
<abbr title="1170      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1170      * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StringðŸ”µ</abbr>
<abbr title="1171      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1171      * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, StðŸ”µ</abbr>
1172      * @throws ServiceException
1173      */
<abbr title="1174     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response, Model model, String id, String collectionField, String sectionKey, Property collectionProperty, FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1174     protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse responseðŸ”µ</abbr>
<abbr title="1175         // For requests to add a new collection item include the main class that the subsequent request comes from.">1175         // For requests to add a new collection item include the main class that the subsequent request cðŸ”µ</abbr>
<abbr title="1176         // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1176         // For instance, with basic collections we know the main associated class for a fetch through theðŸ”µ</abbr>
<abbr title="1177         // persistence item but map and adorned target lookups make a standard persistence request. This solution">1177         // persistence item but map and adorned target lookups make a standard persistence request. This ðŸ”µ</abbr>
1178         // fixes all cases.
1179         String mainClassName = getClassNameForSection(sectionKey);
1180         ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1181         ppr.setAddOperationInspect(true);
1182         if (entityForm != null) {
1183             entityForm.clearFieldsMap();
1184         }
1185         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1186         if (md instanceof BasicCollectionMetadata) {
1187             BasicCollectionMetadata fmd = ((BasicCollectionMetadata) (md));
<abbr title="1188             // When adding items to basic collections, we will sometimes show a form to persist a new record">1188             // When adding items to basic collections, we will sometimes show a form to persist a new recðŸ”µ</abbr>
1189             // and sometimes show a list grid to allow the user to associate an existing record.
1190             if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1191                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1191                 ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().geðŸ”µ</abbr>
1192                 if (entityForm == null) {
1193                     entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
1194                     entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1195                     entityForm.setEntityType(ppr.getCeilingEntityClassname());
1196                 } else {
1197                     formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1198                     formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1199                 }
<abbr title="1200                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1200                 formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntitðŸ”µ</abbr>
1201                 entityForm.getTabs().iterator().next().getIsVisible();
1202                 model.addAttribute(&quot;entityForm&quot;, entityForm);
1203                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1204             } else {
1205                 DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1206                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1206                 ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectðŸ”µ</abbr>
1207                 listGrid.setPathOverride(request.getRequestURL().toString());
<abbr title="1208                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1208                 if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUPðŸ”µ</abbr>
1209                     listGrid.removeAllRowActions();
1210                 }
1211                 model.addAttribute(&quot;listGrid&quot;, listGrid);
1212                 model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1213             }
1214         } else if (md instanceof AdornedTargetCollectionMetadata) {
1215             AdornedTargetCollectionMetadata fmd = ((AdornedTargetCollectionMetadata) (md));
<abbr title="1216             // Even though this field represents an adorned target collection, the list we want to show in the modal">1216             // Even though this field represents an adorned target collection, the list we want to show iðŸ”µ</abbr>
1217             // is the standard list grid for the target entity of this field
1218             ppr.setOperationTypesOverride(null);
1219             ppr.setType(PersistencePackageRequest.Type.STANDARD);
1220             ppr.setSectionEntityField(collectionField);
<abbr title="1221             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1221             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1222             DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1223             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1223             ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKðŸ”µ</abbr>
1224             listGrid.setSubCollectionFieldName(collectionField);
1225             listGrid.setPathOverride(request.getRequestURL().toString());
1226             listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1227             if (entityForm == null) {
<abbr title="1228                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1228                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectiðŸ”µ</abbr>
<abbr title="1229                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());">1229                 entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassnameðŸ”µ</abbr>
1230             } else {
<abbr title="1231                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1231                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectioðŸ”µ</abbr>
1232                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1233             }
1234             listGrid.setListGridType(ListGrid.Type.ADORNED);
1235             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1236                 if (entry.getValue().getIsVisible()) {
1237                     listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1238                     break;
1239                 }
1240             }
1241             // This is part of an add, so we want to be able to filter/sort the listgrid
1242             listGrid.setIsSortable(false);
1243             listGrid.setCanFilterAndSort(true);
1244             listGrid.removeAllRowActions();
1245             model.addAttribute(&quot;listGrid&quot;, listGrid);
1246             model.addAttribute(&quot;entityForm&quot;, entityForm);
1247             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1248         } else if (md instanceof MapMetadata) {
1249             MapMetadata fmd = ((MapMetadata) (md));
<abbr title="1250             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1250             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1251             if (entityForm == null) {
<abbr title="1252                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1252                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1253             } else {
1254                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1255                 formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1256             }
1257             model.addAttribute(&quot;entityForm&quot;, entityForm);
1258             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1259         }
1260         // Set the parent id on the entity form
1261         if (entityForm != null) {
1262             entityForm.setParentId(id);
1263         }
1264         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1265         model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1266         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1267         setModelAttributes(model, sectionKey);
1268         return MODAL_CONTAINER_VIEW;
1269     }
1270 
1271     /**
1272      * Shows the appropriate modal dialog to edit the selected collection item
1273      *
1274      * @param request
1275      * @param response
1276      * @param model
1277      * @param pathVars
1278      * @param id
1279      * @param collectionField
1280      * @param collectionItemId
1281      * @return the return view path
1282      * @throws Exception
1283      */
<abbr title="1284     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1284     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1285     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1285     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1286             @PathVariable  Map&lt;String, String&gt; pathVars,
1287             @PathVariable(value=&quot;id&quot;) String id,
1288             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1289             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1290             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1291         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1291         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1292                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1293     }
1294 
1295     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
<abbr title="1296     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1296     public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, ModeðŸ”µ</abbr>
1297             @PathVariable  Map&lt;String, String&gt; pathVars,
1298             @PathVariable(value=&quot;id&quot;) String id,
1299             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1300             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1301         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1301         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1302                 ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1303     }
1304 
1305     /**
<abbr title="1306      * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1306      * Shows the appropriate modal dialog to view the selected collection item. This will display the modðŸ”µ</abbr>
1307      *
1308      * @param request
1309      * @param response
1310      * @param model
1311      * @param pathVars
1312      * @param id
1313      * @param collectionField
1314      * @param collectionItemId
1315      * @return the return view path
1316      * @throws Exception
1317      */
<abbr title="1318     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1318     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = ðŸ”µ</abbr>
<abbr title="1319     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1319     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1320             @PathVariable  Map&lt;String, String&gt; pathVars,
1321             @PathVariable(value=&quot;id&quot;) String id,
1322             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1323             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1324             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1325         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1325         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1326                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1327 
1328         // Since this is a read-only view, actions don&#x27;t make sense in this context
1329         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1330         addAuditableDisplayFields(ef);
1331         ef.removeAllActions();
1332         ef.setReadOnly();
1333 
1334         return returnPath;
1335     }
1336 
<abbr title="1337     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)">1337     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.ðŸ”µ</abbr>
<abbr title="1338     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1338     public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model ðŸ”µ</abbr>
1339             @PathVariable  Map&lt;String, String&gt; pathVars,
1340             @PathVariable(value=&quot;id&quot;) String id,
1341             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1342             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1343         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1343         String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, colleðŸ”µ</abbr>
1344                 ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1345 
1346         // Since this is a read-only view, actions don&#x27;t make sense in this context
1347         EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1348         ef.removeAllActions();
1349         ef.setReadOnly();
1350 
1351         return returnPath;
1352     }
1353 
<abbr title="1354     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1354     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1355             String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1355             String id, String collectionField, String collectionItemId, String alternateId, String modalHðŸ”µ</abbr>
<abbr title="1356         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1356         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1357     }
1358 
<abbr title="1359     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1359     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1360             String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1360             String id, String collectionField, String collectionItemId, String modalHeaderType) throws SeðŸ”µ</abbr>
<abbr title="1361         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1361         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1362     }
1363 
<abbr title="1364     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1364     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
<abbr title="1365                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1365                 String id, String collectionField, String collectionItemId, String modalHeaderType, EntitðŸ”µ</abbr>
<abbr title="1366         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1366         return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ðŸ”µ</abbr>
1367     }
1368 
1369     /**
<abbr title="1370      * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1370      * Shows the view and populates the model for updating a collection item. You can also pass in an entðŸ”µ</abbr>
1371      * which are optional. If they are not passed in then they are automatically looked up
1372      *
1373      * @param request
1374      * @param model
1375      * @param pathVars
1376      * @param id
1377      * @param collectionField
1378      * @param collectionItemId
1379      * @param modalHeaderType
1380      * @param entityForm
1381      * @param entity
1382      * @return
1383      * @throws ServiceException
1384      */
<abbr title="1385     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars, String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1385     protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, StringðŸ”µ</abbr>
1386         String sectionKey = getSectionKey(pathVars);
1387         String mainClassName = getClassNameForSection(sectionKey);
1388         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1389         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1389         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1390         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1391         FieldMetadata md = collectionProperty.getMetadata();
1392         SectionCrumb nextCrumb = new SectionCrumb();
1393         if (md instanceof MapMetadata) {
1394             nextCrumb.setSectionIdentifier(((MapMetadata) (md)).getValueClassName());
1395         } else {
1396             nextCrumb.setSectionIdentifier(((CollectionMetadata) (md)).getCollectionCeilingEntity());
1397         }
1398         nextCrumb.setSectionId(collectionItemId);
1399         if (!sectionCrumbs.contains(nextCrumb)) {
1400             sectionCrumbs.add(nextCrumb);
1401         }
<abbr title="1402         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1402         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1403         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1403         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1404         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1405         if ((md instanceof BasicCollectionMetadata) &amp;&amp; (((BasicCollectionMetadata) (md)).getAddMethodType().equals(AddMethodType.PERSIST) || ((BasicCollectionMetadata) (md)).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {">1405         if ((md instanceof BasicCollectionMetadata) &amp;&amp; (((BasicCollectionMetadata) (md)).getAddMethodTypeðŸ”µ</abbr>
1406             BasicCollectionMetadata fmd = ((BasicCollectionMetadata) (md));
<abbr title="1407             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1407             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1408             if (entity == null) {
<abbr title="1409                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1409                 entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResðŸ”µ</abbr>
1410             }
1411             String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1412             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1412             Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetaðŸ”µ</abbr>
<abbr title="1413             entityForm = reinitializeEntityForm(entityForm, collectionMetadata, entity, subRecordsMap, sectionCrumbs);">1413             entityForm = reinitializeEntityForm(entityForm, collectionMetadata, entity, subRecordsMap, seðŸ”µ</abbr>
1414             entityForm.removeAction(DefaultEntityFormActions.DELETE);
1415             entityForm.removeAction(DefaultEntityFormActions.DUPLICATE);
1416             addAuditableDisplayFields(entityForm);
1417             model.addAttribute(&quot;entityForm&quot;, entityForm);
1418             model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1419         } else if (md instanceof AdornedTargetCollectionMetadata) {
1420             AdornedTargetCollectionMetadata fmd = ((AdornedTargetCollectionMetadata) (md));
1421             if (entity == null) {
<abbr title="1422                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty, collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];">1422                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1423             }
1424             boolean populateTypeAndId = true;
<abbr title="1425             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);">1425             boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaðŸ”µ</abbr>
1426             if (entityForm == null) {
<abbr title="1427                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1427                 entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollecðŸ”µ</abbr>
1428                 entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1429                 entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1430             } else {
1431                 entityForm.clearFieldsMap();
1432                 String entityType = entityForm.getEntityType();
<abbr title="1433                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1433                 formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entðŸ”µ</abbr>
1434                 entityForm.setEntityType(entityType);
1435                 populateTypeAndId = false;
1436             }
1437             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1438             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id, collectionField, collectionItemId, responseMap);">1438             adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, maðŸ”µ</abbr>
<abbr title="1439             // For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1439             // For AdornedTargetCollections, we need to be specific on what translation ceilingEntity andðŸ”µ</abbr>
<abbr title="1440             // It should be the entity and referenced Id of the adorned entity (not the target entity and Id).">1440             // It should be the entity and referenced Id of the adorned entity (not the target entity andðŸ”µ</abbr>
1441             entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1442             entityForm.setTranslationId(alternateId);
1443             ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1444             for (String field : fmd.getMaintainedAdornedTargetFields()) {
1445                 if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1446                     continue;
1447                 }
1448                 Property p = cmd.getPMap().get(field);
1449                 if ((p != null) &amp;&amp; (p.getMetadata() instanceof AdornedTargetCollectionMetadata)) {
<abbr title="1450                     // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1450                     // Because we&#x27;re dealing with a nested adorned target collection, this particular reqðŸ”µ</abbr>
<abbr title="1451                     // directly on the first adorned target collection. Because of this, we need the actual id property">1451                     // directly on the first adorned target collection. Because of this, we need the actuðŸ”µ</abbr>
<abbr title="1452                     // from the entity that models the adorned target relationship, and not the id of the target object.">1452                     // from the entity that models the adorned target relationship, and not the id of theðŸ”µ</abbr>
<abbr title="1453                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1453                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1454                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null, alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();">1454                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
<abbr title="1455                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p, ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);">1455                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1456                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1457                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1458                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1458                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1459                     } else {
<abbr title="1460                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1460                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1461                     }
1462                 } else if ((p != null) &amp;&amp; (p.getMetadata() instanceof MapMetadata)) {
1463                     // See above comment for AdornedTargetCollectionMetadata
1464                     MapMetadata mmd = ((MapMetadata) (p.getMetadata()));
<abbr title="1465                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1465                     Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ðŸ”µ</abbr>
<abbr title="1466                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null, alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();">1466                     DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, nuðŸ”µ</abbr>
<abbr title="1467                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p, mmd.getTargetClass(), sectionCrumbs);">1467                     ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(ðŸ”µ</abbr>
1468                     listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1469                     if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1470                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1470                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1471                     } else {
<abbr title="1472                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1472                         entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFðŸ”µ</abbr>
1473                     }
1474                 }
1475             }
<abbr title="1476             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1476             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1477             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1478             boolean atLeastOneBasicField = false;
1479             for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1480                 if ((entry.getValue().getIsVisible() &amp;&amp; (!responseMap.containsKey(entry.getValue().getName()))) &amp;&amp; (!responseMap.containsKey(&quot;autoSubmit&quot;))) {">1480                 if ((entry.getValue().getIsVisible() &amp;&amp; (!responseMap.containsKey(entry.getValue().getNamðŸ”µ</abbr>
1481                     atLeastOneBasicField = true;
1482                     break;
1483                 }
1484             }
1485             if (!atLeastOneBasicField) {
1486                 entityForm.removeAction(DefaultEntityFormActions.SAVE);
1487             }
1488             addAuditableDisplayFields(entityForm);
1489             model.addAttribute(&quot;entityForm&quot;, entityForm);
1490             model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1491         } else if (md instanceof MapMetadata) {
1492             MapMetadata fmd = ((MapMetadata) (md));
<abbr title="1493             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1493             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1494             if (entity == null) {
<abbr title="1495                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty, collectionItemId, sectionCrumbs, null).getEntity();">1495                 entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperðŸ”µ</abbr>
1496             }
1497             boolean populateTypeAndId = true;
1498             if (entityForm == null) {
<abbr title="1499                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);">1499                 entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id)ðŸ”µ</abbr>
1500             } else {
1501                 // save off the prior key before clearing out the fields map as it will not appear
1502                 // back on the saved entity
1503                 String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1504                 entityForm.clearFieldsMap();
1505                 formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1506                 entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1507                 populateTypeAndId = false;
1508             }
<abbr title="1509             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);">1509             formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndIdðŸ”µ</abbr>
1510             formService.populateMapEntityFormFields(entityForm, entity);
1511             addAuditableDisplayFields(entityForm);
1512             model.addAttribute(&quot;entityForm&quot;, entityForm);
1513             model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1514         }
1515         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1516         model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1517         model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1518         setModelAttributes(model, sectionKey);
1519         return MODAL_CONTAINER_VIEW;
1520     }
1521 
<abbr title="1522     protected EntityForm reinitializeEntityForm(final EntityForm entityForm, final ClassMetadata collectionMetadata, final Entity entity, final Map&lt;String, DynamicResultSet&gt; subRecordsMap, final List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {">1522     protected EntityForm reinitializeEntityForm(final EntityForm entityForm, final ClassMetadata collectiðŸ”µ</abbr>
1523         if (entityForm == null) {
<abbr title="1524             return formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);">1524             return formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs)ðŸ”µ</abbr>
1525         }
1526         entityForm.clearFieldsMap();
<abbr title="1527         formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbs);">1527         formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumðŸ”µ</abbr>
1528         // remove all the actions since we&#x27;re not trying to redisplay them on the form
1529         entityForm.removeAllActions();
1530         return entityForm;
1531     }
1532 
1533     /**
1534      * Updates the specified collection item
1535      *
1536      * @param request
1537      * @param response
1538      * @param model
1539      * @param pathVars
1540      * @param id
1541      * @param collectionField
<abbr title="1542      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1542      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1543      * @param entityForm
1544      * @param result
1545      * @return the return view path
1546      * @throws Exception
1547      */
1548     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
<abbr title="1549     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1549     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1550             @PathVariable  Map&lt;String, String&gt; pathVars,
1551             @PathVariable(value=&quot;id&quot;) String id,
1552             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1553             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1554             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1555             BindingResult result) throws Exception {
<abbr title="1556         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1556         return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1557     }
1558 
1559     /**
1560      * Updates the specified collection item
1561      *
1562      * @param request
1563      * @param response
1564      * @param model
1565      * @param pathVars
1566      * @param id
1567      * @param collectionField
<abbr title="1568      * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1568      * @param collectionItemId the collection primary key value (in the case of adorned target collectionðŸ”µ</abbr>
1569      * @param entityForm
<abbr title="1570      * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1570      * @param alternateId in the case of adorned target collections, this is the primary key value of theðŸ”µ</abbr>
1571      * @param result
1572      * @return the return view path
1573      * @throws Exception
1574      */
<abbr title="1575     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1575     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequeðŸ”µ</abbr>
<abbr title="1576     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1576     public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1577             @PathVariable  Map&lt;String, String&gt; pathVars,
1578             @PathVariable(value=&quot;id&quot;) String id,
1579             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1580             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1581             @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1582             @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1583             BindingResult result) throws Exception {
1584         String sectionKey = getSectionKey(pathVars);
1585         String mainClassName = getClassNameForSection(sectionKey);
1586         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1587         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1587         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1588         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1589 
<abbr title="1590         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1590         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
<abbr title="1591         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1591         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1592 
1593         // First, we must save the collection entity
<abbr title="1594         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1594         PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadðŸ”µ</abbr>
1595         Entity savedEntity = persistenceResponse.getEntity();
1596         entityFormValidator.validate(entityForm, savedEntity, result);
1597 
1598         if (result.hasErrors()) {
<abbr title="1599             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1599             return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1600                     ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1601         }
1602 
1603         // Next, we must get the new list grid that represents this collection
1604         // We return the new list grid so that it can replace the currently visible one
<abbr title="1605         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1605         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1606 
1607         model.addAttribute(&quot;listGrid&quot;, listGrid);
1608         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1609         setModelAttributes(model, sectionKey);
1610         return &quot;views/standaloneListGrid&quot;;
1611     }
1612 
<abbr title="1613     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)">1613     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMetðŸ”µ</abbr>
1614     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1615             HttpServletResponse response, Model model,
1616             @PathVariable  Map&lt;String, String&gt; pathVars,
1617             @PathVariable(value=&quot;id&quot;) String id,
1618             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1619             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1620             @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1621         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1621         return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collðŸ”µ</abbr>
1622     }
1623 
1624     /**
<abbr title="1625      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections">1625      * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target colðŸ”µ</abbr>
<abbr title="1626      * where a sort field is specified -- any other invocation is incorrect and will result in an exception.">1626      * where a sort field is specified -- any other invocation is incorrect and will result in an exceptiðŸ”µ</abbr>
1627      *
1628      * @param request
1629      * @param response
1630      * @param model
1631      * @param pathVars
1632      * @param id
1633      * @param collectionField
1634      * @param collectionItemId
1635      * @return an object explaining the state of the operation
1636      * @throws Exception
1637      */
<abbr title="1638     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1638     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, methoðŸ”µ</abbr>
1639     public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1640             HttpServletResponse response, Model model,
1641             @PathVariable  Map&lt;String, String&gt; pathVars,
1642             @PathVariable(value=&quot;id&quot;) String id,
1643             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1644             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1645             @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1646             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1647         String sectionKey = getSectionKey(pathVars);
1648         String mainClassName = getClassNameForSection(sectionKey);
1649         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1650         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1650         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1651         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1652         FieldMetadata md = collectionProperty.getMetadata();
1653 
<abbr title="1654         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1654         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1655         ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1656 
<abbr title="1657         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1657         Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getReðŸ”µ</abbr>
1658 
1659         ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1660 
1661         if (md instanceof AdornedTargetCollectionMetadata) {
1662             AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1663             AdornedTargetList atl = ppr.getAdornedList();
1664 
1665             // Get an entity form for the entity
<abbr title="1666             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1666             EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, falseðŸ”µ</abbr>
<abbr title="1667             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,">1667             Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProðŸ”µ</abbr>
<abbr title="1668                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})">1668                     collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;}ðŸ”µ</abbr>
1669                     .getDynamicResultSet().getRecords()[0];
1670             formService.populateEntityFormFields(entityForm, entity);
1671             formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1672 
<abbr title="1673             // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">1673             // Set the new sequence (note that it will come in 0-indexed but the persistence module expecðŸ”µ</abbr>
1674             int sequenceValue = Integer.parseInt(newSequence) + 1;
1675             Field field = entityForm.findField(atl.getSortField());
1676             field.setValue(String.valueOf(sequenceValue));
1677 
1678             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1679             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">1679             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1680             Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
1681 
1682             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1683             responseMap.put(&quot;field&quot;, collectionField);
1684             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1685             return responseMap;
1686         } else if (md instanceof BasicCollectionMetadata) {
1687             BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
1688             Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1689             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1689             Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResulðŸ”µ</abbr>
1690 
<abbr title="1691             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1691             ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClaðŸ”µ</abbr>
1692             EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
1693             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1694                 Field f = new Field()
1695                         .withName(cd.getSortProperty())
1696                         .withFieldType(SupportedFieldType.HIDDEN.toString());
1697                 entityForm.addHiddenField(mainMetadata, f);
1698             }
1699             formService.populateEntityFormFields(entityForm, entity);
1700 
1701             if (!StringUtils.isEmpty(cd.getSortProperty())) {
1702                 int sequenceValue = Integer.parseInt(newSequence) + 1;
1703                 Field field = entityForm.findField(cd.getSortProperty());
1704                 field.setValue(String.valueOf(sequenceValue));
1705             }
1706 
<abbr title="1707             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">1707             PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMðŸ”µ</abbr>
1708             Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
1709 
1710             responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1711             responseMap.put(&quot;field&quot;, collectionField);
1712             responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1713             return responseMap;
1714         } else {
<abbr title="1715             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">1715             throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collðŸ”µ</abbr>
1716         }
1717     }
1718 
1719     /**
1720      * Removes the requested collection item
1721      *
<abbr title="1722      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1722      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1723      * map collection.
1724      *
1725      * @param request
1726      * @param response
1727      * @param model
1728      * @param pathVars
1729      * @param id
1730      * @param collectionField
1731      * @param collectionItemId
1732      * @return the return view path
1733      * @throws Exception
1734      */
<abbr title="1735     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)">1735     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethoðŸ”µ</abbr>
<abbr title="1736     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1736     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1737             @PathVariable  Map&lt;String, String&gt; pathVars,
1738             @PathVariable(value=&quot;id&quot;) String id,
1739             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1740             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1741         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">1741         return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItðŸ”µ</abbr>
1742     }
1743 
1744     /**
1745      * Removes the requested collection item
1746      *
<abbr title="1747      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1747      * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collectionðŸ”µ</abbr>
1748      * map collection.
1749      *
1750      * @param request
1751      * @param response
1752      * @param model
1753      * @param pathVars
1754      * @param id
1755      * @param collectionField
1756      * @param collectionItemId
1757      * @return the return view path
1758      * @throws Exception
1759      */
<abbr title="1760     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">1760     @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method ðŸ”µ</abbr>
<abbr title="1761     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1761     public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model moðŸ”µ</abbr>
1762             @PathVariable  Map&lt;String, String&gt; pathVars,
1763             @PathVariable(value=&quot;id&quot;) String id,
1764             @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1765             @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1766             @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1767         String sectionKey = getSectionKey(pathVars);
1768         String mainClassName = getClassNameForSection(sectionKey);
1769         List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1770         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1770         ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClaðŸ”µ</abbr>
1771         Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1772 
1773         String priorKey = request.getParameter(&quot;key&quot;);
1774 
<abbr title="1775         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1775         PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs,ðŸ”µ</abbr>
1776         declareShouldIgnoreAdditionStatusFilter();
<abbr title="1777         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1777         Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords(ðŸ”µ</abbr>
1778 
1779         // First, we must remove the collection entity
<abbr title="1780         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">1780         PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectðŸ”µ</abbr>
<abbr title="1781         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {">1781         if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailurðŸ”µ</abbr>
1782             String error = &quot;There was an error removing the whatever&quot;;
1783             if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
1784                 // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="1785                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">1785                 error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator()ðŸ”µ</abbr>
<abbr title="1786             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {">1786             } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErroðŸ”µ</abbr>
1787                 error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
1788             }
1789             return new JsonResponse(response)
1790                 .with(&quot;status&quot;, &quot;error&quot;)
1791                 .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
1792                 .done();
1793         }
1794 
1795         // Next, we must get the new list grid that represents this collection
1796         // We return the new list grid so that it can replace the currently visible one
<abbr title="1797         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1797         ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionðŸ”µ</abbr>
1798 
1799         model.addAttribute(&quot;listGrid&quot;, listGrid);
1800         model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1801         setModelAttributes(model, sectionKey);
1802         return &quot;views/standaloneListGrid&quot;;
1803     }
1804 
1805     public void addAuditableDisplayFields(EntityForm entityForm) {
1806         Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
1807         if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
1808             addAuditableDisplayField(entityForm, createdBy);
1809 
1810             createdBy.setIsVisible(false);
1811         }
1812         Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
1813         if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
1814             addAuditableDisplayField(entityForm, updatedBy);
1815 
1816             updatedBy.setIsVisible(false);
1817         }
1818     }
1819 
1820     private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
1821         Field displayField = buildAuditableDisplayField(userField);
1822 
1823         AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
1824         String userName = user == null ? null : user.getName();
1825         displayField.setValue(userName);
1826 
1827         FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
1828         if (auditGroup != null) {
1829             auditGroup.addField(displayField);
1830         }
1831     }
1832 
1833     private Field buildAuditableDisplayField(Field auditableField) {
1834         return new Field().withFieldType(SupportedFieldType.STRING.toString())
1835                 .withName(auditableField.getName() + &quot;Display&quot;)
1836                 .withFriendlyName(auditableField.getFriendlyName())
1837                 .withOrder(auditableField.getOrder())
1838                 .withOwningEntityClass(auditableField.getOwningEntityClass())
1839                 .withReadOnly(true);
1840     }
1841 
1842     protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
1843         String tabName = pathVars.get(&quot;tabName&quot;);
1844         if (StringUtils.isBlank(tabName)) {
1845             TabMetadata firstTab = cmd.getFirstTab();
1846             return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
1847         }
1848         return tabName;
1849     }
1850 
1851     // *****************************************
1852     // Typed Entity Helper Methods
1853     // *****************************************
1854 
1855     protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
1856         // Check if this is a typed entity
1857         AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
1858         if (typedEntitySection != null) {
1859             // Update the friendly name for this Entity Type
1860             model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
1861         }
1862     }
1863 
1864     // *********************************
1865     // ADDITIONAL SPRING-BOUND METHODS *
1866     // *********************************
1867 
1868     /**
<abbr title="1869      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.">1869      * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding ðŸ”µ</abbr>
<abbr title="1870      * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">1870      * By default, we register a binder that treats empty Strings as null and a Boolean editor that suppoðŸ”µ</abbr>
1871      * or false. If the value is passed in as null, it will treat it as false.
1872      *
1873      * @param binder
1874      */
1875     @InitBinder
1876     public void initBinder(WebDataBinder binder) {
1877         binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
1878         binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
1879     }
1880 }
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.web.controller.entity;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.MapUtils;
  22  import org.apache.commons.lang3.StringUtils;
  23  import org.apache.commons.logging.Log;
  24  import org.apache.commons.logging.LogFactory;
  25  import org.broadleafcommerce.common.exception.SecurityServiceException;
  26  import org.broadleafcommerce.common.exception.ServiceException;
  27  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  28  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;

  29  import org.broadleafcommerce.common.presentation.client.AddMethodType;
  30  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  31  import org.broadleafcommerce.common.sandbox.SandBoxHelper;

  32  import org.broadleafcommerce.common.util.BLCArrayUtils;
  33  import org.broadleafcommerce.common.util.BLCMessageUtils;
  34  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  35  import org.broadleafcommerce.common.web.JsonResponse;
  36  import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  37  import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  38  import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  39  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  40  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  41  import org.broadleafcommerce.openadmin.dto.ClassTree;
  42  import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  43  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  44  import org.broadleafcommerce.openadmin.dto.Entity;
  45  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  46  import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  47  import org.broadleafcommerce.openadmin.dto.MapMetadata;
  48  import org.broadleafcommerce.openadmin.dto.Property;
  49  import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  50  import org.broadleafcommerce.openadmin.dto.TabMetadata;
  51  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  52  import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  53  import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  54  import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  55  import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  56  import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  57  import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  58  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  59  import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  59  import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManaðŸ”µ</abbr>
  60  import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  61  import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  62  import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  63  import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  64  import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  65  import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  66  import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  67  import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  68  import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  69  import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  70  import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  71  import org.broadleafcommerce.openadmin.web.form.entity.Field;
  72  import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  73  import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  74  import org.springframework.stereotype.Controller;
  75  import org.springframework.ui.Model;
  76  import org.springframework.util.MultiValueMap;
  77  import org.springframework.validation.BindingResult;
  78  import org.springframework.web.bind.WebDataBinder;
  79  import org.springframework.web.bind.annotation.InitBinder;
  80  import org.springframework.web.bind.annotation.ModelAttribute;
  81  import org.springframework.web.bind.annotation.PathVariable;
  82  import org.springframework.web.bind.annotation.RequestMapping;
  83  import org.springframework.web.bind.annotation.RequestMethod;
  84  import org.springframework.web.bind.annotation.RequestParam;
  85  import org.springframework.web.bind.annotation.ResponseBody;
  86  import org.springframework.web.servlet.DispatcherServlet;
  87  import org.springframework.web.servlet.FlashMap;
  88  import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  89  import org.springframework.web.util.UrlPathHelper;

  90  import com.fasterxml.jackson.databind.ObjectMapper;
  91  


  92  import java.net.URLDecoder;
  93  import java.util.ArrayList;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  94 +import java.util.Arrays;</span>
  95  import java.util.HashMap;
  96  import java.util.List;
  97  import java.util.Map;
  98  import java.util.Map.Entry;
  99  import java.util.Set;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +import java.util.stream.Stream;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +</span>
 102  import javax.annotation.Resource;
 103  import javax.servlet.http.HttpServletRequest;
 104  import javax.servlet.http.HttpServletResponse;
 105  
 106  /**
<abbr title=" 107   * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call to super"> 107   * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call toðŸ”µ</abbr>
<abbr title=" 108   * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entity"> 108   * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entðŸ”µ</abbr>
 109   * that is not explicitly customized by its own controller.



 110   *
 111   * @author Andre Azzolini (apazzolini)
 112   * @author Jeff Fischer
 113   */
 114  @Controller(&quot;blAdminBasicEntityController&quot;)
 115  @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 116  public class AdminBasicEntityController extends AdminAbstractController {
 117  
 118      protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 119  
 120      public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 121      public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 122      public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 123  
 124      @Resource(name=&quot;blSandBoxHelper&quot;)
 125      protected SandBoxHelper sandBoxHelper;
 126  
 127      @Resource(name = &quot;blAdminUserDao&quot;)
 128      protected AdminUserDao adminUserDao;
 129  
 130      @Resource(name=&quot;blDynamicEntityDao&quot;)
 131      protected DynamicEntityDao dynamicEntityDao;
 132  
 133      @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 134      protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 135  
 136      @Resource(name = &quot;blRowLevelSecurityService&quot;)
 137      protected RowLevelSecurityService rowLevelSecurityService;
 138  






 139      // ******************************************
 140      // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 141      // ******************************************
 142  
 143      /**
<abbr title=" 144       * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 144       * Renders the main entity listing for the specified class, which is based on the current sectionKey with someðŸ”µ</abbr>
 145       * criteria.
 146       *
 147       * @param request
 148       * @param response
 149       * @param model
 150       * @param pathVars
 151       * @param requestParams a Map of property name -&gt; list critiera values
 152       * @return the return view path
 153       * @throws Exception
 154       */
 155      @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 156      public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 157              @PathVariable Map&lt;String, String&gt; pathVars,
 158              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 159          String sectionKey = getSectionKey(pathVars);
 160          String sectionClassName = getClassNameForSection(sectionKey);
 161          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 162          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 162          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbðŸ”µ</abbr>
 163          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 164          DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 165  
 166          ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 167          listGrid.setSelectType(ListGrid.SelectType.NONE);
 168  
 169          Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 170          if (CollectionUtils.isNotEmpty(headerFields)) {
 171              Field firstField = headerFields.iterator().next();
 172              if (requestParams.containsKey(firstField.getName())) {
 173                  model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 174              }
 175          }
 176  
 177          model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 178  
 179          setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 180          model.addAttribute(&quot;listGrid&quot;, listGrid);
 181  
 182          return &quot;modules/defaultContainer&quot;;

 183      }
 184  
 185      protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,
 186              String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 187          List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 188          addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 189          extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 190          extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 191  
 192          // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 193          if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 194              model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 195          }
 196  
 197          List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 198          String requestUri = request.getRequestURI();
 199          if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
 200              requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());
 201          }
 202  
 203          model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 204          model.addAttribute(&quot;currentUri&quot;, requestUri);
 205          model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 206          model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 207          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 208          model.addAttribute(&quot;mainActions&quot;, mainActions);
 209          setModelAttributes(model, sectionKey);
 210          setTypedEntityModelAttributes(request, model);
 211      }
 212  
 213      @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 214      public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 215               HttpServletResponse response, Model model,
 216               @PathVariable Map&lt;String, String&gt; pathVars,
 217               @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 218          String sectionKey = getSectionKey(pathVars);
 219          String sectionClassName = getClassNameForSection(sectionKey);
 220          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 221          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 221          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbðŸ”µ</abbr>
 222                  .withCustomCriteria(getCustomCriteria(requestParams));
 223  
 224          ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 225  
 226          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 227          DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 228  
 229          return formService.constructSelectizeOptionMap(drs, cmd);
 230      }
 231  
 232      /**
 233       * Obtains the requested criteria parameter
 234       *
 235       * @param requestParams
 236       * @return
 237       */
 238      protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 239          if (requestParams == null || requestParams.isEmpty()) {
 240              return null;
 241          }
 242  
 243          List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 244          String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 245          return new String[] {response};
 246      }
 247  
 248      /**
 249       * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances
 250       * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 251       *
 252       * @param sectionClassName
 253       * @param cmd
 254       * @param mainActions
 255       */
<abbr title=" 256      protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 256      protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainAcðŸ”µ</abbr>
 257          if (isAddActionAllowed(sectionClassName, cmd)) {
 258              mainActions.add(DefaultMainActions.ADD);
 259          }
 260      }
 261  
 262      protected boolean isAddActionAllowed(String sectionClassName, ClassMetadata cmd) {

 263          // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
 264          boolean canCreate = true;
 265          try {
 266              adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 267          } catch (ServiceException e) {
 268              if (e instanceof SecurityServiceException) {
 269                  canCreate = false;
 270              }
 271          }
 272  
 273          if (canCreate) {
 274              checkReadOnly: {
 275                  //check if all the metadata is read only
 276                  for (Property property : cmd.getProperties()) {
 277                      if (property.getMetadata() instanceof BasicFieldMetadata) {
 278                          if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||
 279                                  !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {
 280                              break checkReadOnly;
 281                          }
 282                      }
















 283                  }
 284                  canCreate = false;
 285              }
 286          }
 287  
 288          if (canCreate) {
<abbr title=" 289              canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);"> 289              canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectioðŸ”µ</abbr>
 290          }
 291  
 292          return canCreate;




 293      }
 294  
 295      /**
 296       * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any
<abbr title=" 297       * subcollections as operations on those collections require the parent level entity to first be saved and have"> 297       * subcollections as operations on those collections require the parent level entity to first be saved and havðŸ”µ</abbr>
<abbr title=" 298       * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 298       * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen whðŸ”µ</abbr>
 299       * they can then perform operations on sub collections.
 300       *
 301       * @param request
 302       * @param response
 303       * @param model
 304       * @param pathVars
 305       * @param entityType
 306       * @return the return view path
 307       * @throws Exception
 308       */
 309      @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
 310      public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 311              @PathVariable  Map&lt;String, String&gt; pathVars,
 312              @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 313          String sectionKey = getSectionKey(pathVars);
 314          String sectionClassName = getClassNameForSection(sectionKey);
 315          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 316          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 316          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 317          ppr.setAddOperationInspect(true);
 318          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 319  
<abbr title=" 320          // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for this entity."> 320          // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for thiðŸ”µ</abbr>






























 321          if (StringUtils.isBlank(entityType)) {
 322              if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 323                  entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 324              } else {
 325                  entityType = getDefaultEntityType();
 326              }
 327          } else {
 328              entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 329          }
 330  
 331          EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);
 332  
 333          // We need to make sure that the ceiling entity is set to the interface and the specific entity type
 334          // is set to the type we&#x27;re going to be creating.
 335          entityForm.setCeilingEntityClassname(cmd.getCeilingType());
 336          entityForm.setEntityType(entityType);
 337  
 338          // When we initially build the class metadata (and thus, the entity form), we had all of the possible
 339          // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the
 340          // fields that are not applicable for this given entity type.
 341          formService.removeNonApplicableFields(cmd, entityForm, entityType);
 342  
 343          modifyAddEntityForm(entityForm, pathVars);
 344  
 345          model.addAttribute(&quot;entityForm&quot;, entityForm);
 346          model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 347  
 348          model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 349          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 350          model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 351          setModelAttributes(model, sectionKey);
 352          return &quot;modules/modalContainer&quot;;

 353      }
 354  
 355      /**
 356       * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity.
 357       *
 358       * @param request
 359       * @param response
 360       * @param model
 361       * @param pathVars
 362       * @param entityForm
 363       * @param result
 364       * @return the return view path
 365       * @throws Exception
 366       */
 367      @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 368      public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 369              @PathVariable  Map&lt;String, String&gt; pathVars,
 370              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
 371          String sectionKey = getSectionKey(pathVars);
 372          String sectionClassName = getClassNameForSection(sectionKey);
 373          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 374          ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 374          ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionðŸ”µ</abbr>
 375  
 376          extractDynamicFormFields(cmd, entityForm);
<abbr title=" 377          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 377          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 378          Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 379          entityFormValidator.validate(entityForm, entity, result);
 380  
 381          if (result.hasErrors()) {
 382              entityForm.clearFieldsMap();
 383              formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 384  
 385              formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 386  
 387              modifyAddEntityForm(entityForm, pathVars);
 388  
 389              model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 390              model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 391              model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 392              model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 393              setModelAttributes(model, sectionKey);
 394              return &quot;modules/modalContainer&quot;;

 395          }
 396  
 397          // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 398          return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 398          return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue(ðŸ”µ</abbr>






















































 399      }
 400  
 401      /**
 402       * Renders the main entity form for the specified entity
 403       *
 404       * @param request
 405       * @param response
 406       * @param model
 407       * @param pathVars
 408       * @param id
 409       * @return the return view path
 410       * @throws Exception
 411       */
 412      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 413      public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 414              @PathVariable  Map&lt;String, String&gt; pathVars,
 415              @PathVariable(&quot;id&quot;) String id) throws Exception {
 416          String sectionKey = getSectionKey(pathVars);
 417          String sectionClassName = getClassNameForSection(sectionKey);
 418          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
 419          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);
 420  
 421          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 422          Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 423  
 424          Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);
 425  
 426          EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 427  
 428          if (isAddRequest(entity)) {
 429              modifyAddEntityForm(entityForm, pathVars);
 430          } else {
 431              modifyEntityForm(entityForm, pathVars);
 432          }

 433  
 434          if (request.getParameter(&quot;headerFlash&quot;) != null) {
 435              model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 436          }
 437  
 438          // Set the sectionKey again incase this is a typed entity
 439          entityForm.setSectionKey(sectionKey);
 440  
 441          // Build the current url in the cast that this is a typed entity
 442          String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 443          int startIndex = request.getContextPath().length();
 444  
 445          // Remove the context path from servlet path
 446          String currentUrl = originatingUri.substring(startIndex);
 447  
 448          model.addAttribute(&quot;entity&quot;, entity);
 449          model.addAttribute(&quot;entityForm&quot;, entityForm);
 450          model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 451  
 452          setModelAttributes(model, sectionKey);
 453  
 454          // We want to replace author ids with their names
 455          addAuditableDisplayFields(entityForm);
 456  
 457          if (isAjaxRequest(request)) {
 458              entityForm.setReadOnly();
 459              model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 460              model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 461              return &quot;modules/modalContainer&quot;;
 462          } else {
 463              model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 464              model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 465              return &quot;modules/defaultContainer&quot;;
 466          }

 467      }
 468  
<abbr title=" 469      protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 469      protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathðŸ”µ</abbr>
 470                                                                ClassMetadata cmd, Entity entity,
 471                                                                List&lt;SectionCrumb&gt; crumbs) throws Exception {
 472          String tabName = pathVars.get(&quot;tabName&quot;);
 473          if (StringUtils.isEmpty(tabName)) {
 474              tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 475          }
 476          return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 477      }
 478  
 479      private boolean isAddRequest(Entity entity) {
 480          ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
 481          ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);
 482          if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 483              return false;
 484          }
 485  
 486          return resultHolder.getResult();
 487      }
 488  
 489      /**
 490       * Attempts to get the List Grid for the selected tab.
 491       *
 492       * @param request
 493       * @param response
 494       * @param model
 495       * @param pathVars
 496       * @param id
 497       * @param tabName
 498       * @param entityForm
 499       * @param entity
 500       * @return the return view path
 501       * @throws Exception
 502       */
 503      @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 504      public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 505              @PathVariable Map&lt;String, String&gt; pathVars,
 506              @PathVariable(value = &quot;id&quot;) String id,
 507              @PathVariable(value = &quot;tabName&quot;) String tabName,
 508              @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 509              @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 510          String sectionKey = getSectionKey(pathVars);
 511          String sectionClassName = getClassNameForSection(sectionKey);
 512          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
 513          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);
 514          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 515          entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 516          Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);
 517          entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 518  
 519          if (isAddRequest(entity)) {
 520              modifyAddEntityForm(entityForm, pathVars);
 521          } else {
 522              modifyEntityForm(entityForm, pathVars);
 523          }

 524  
 525          model.addAttribute(&quot;entity&quot;, entity);
 526          model.addAttribute(&quot;entityForm&quot;, entityForm);
 527          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 528  
 529          setModelAttributes(model, sectionKey);
 530  
 531          model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 532          model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 533          return &quot;modules/defaultContainer&quot;;


 534      }
 535  
 536      /**
 537       * Builds JSON that looks like this:
 538       *
 539       * {&quot;errors&quot;:
 540       *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 541       *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 542       *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 543       *        &quot;errorType&quot;, &quot;field&quot;,
 544       *        &quot;tab&quot;: &quot;General&quot;
 545       *        },
 546       *        {&quot;message&quot;:&quot;This field is Required&quot;,
 547       *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 548       *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 549       *        &quot;errorType&quot;, &quot;field&quot;,
 550       *        &quot;tab&quot;: &quot;General&quot;
 551       *        }]
 552       * }
 553       *
 554       */
 555      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 556      public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 557              @PathVariable Map&lt;String, String&gt; pathVars,
 558              @PathVariable(value = &quot;id&quot;) String id,
 559              @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 560              RedirectAttributes ra) throws Exception {
 561  
 562          saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 563  
 564          JsonResponse json = new JsonResponse(response);
 565          if (result.hasErrors()) {
 566              populateJsonValidationErrors(entityForm, result, json);
 567          }
 568          List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 569          if (CollectionUtils.isNotEmpty(dirtyList)) {
 570              json.with(&quot;dirty&quot;, dirtyList);
 571          }
 572  
 573          ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 574          ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 574          ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(reðŸ”µ</abbr>
 575          if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 576              return resultHolder.getResult();
 577          }
 578  
 579          return json.done();
 580      }
 581  
<abbr title=" 582      public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 582      public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throwsðŸ”µ</abbr>
 583          List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 584          String sectionKey = getSectionKey(pathVars);
 585          String sectionClassName = getClassNameForSection(sectionKey);
 586          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 587          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 587          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 588          ClassMetadata cmd = null;
 589          Entity entity = null;
 590          cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 591          entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 592  
 593          for (Property p: entity.getProperties()) {
 594              if (p.getIsDirty()) {
 595                  dirtyList.add(p.getName());
 596              }
 597          }
 598          return dirtyList;
 599      }
 600  
 601      /**
 602       * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with
 603       * error fields highlighted. On a successful save, it will refresh the entity page.
 604       *
 605       * @param request
 606       * @param response
 607       * @param model
 608       * @param pathVars
 609       * @param id
 610       * @param entityForm
 611       * @param result
 612       * @return the return view path
 613       * @throws Exception
 614       */
 615      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 616      public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 617              @PathVariable  Map&lt;String, String&gt; pathVars,
 618              @PathVariable(value=&quot;id&quot;) String id,
 619              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 620              RedirectAttributes ra) throws Exception {
 621          String sectionKey = getSectionKey(pathVars);
 622          String sectionClassName = getClassNameForSection(sectionKey);
 623          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 624          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 624          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 625          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 626  
 627          extractDynamicFormFields(cmd, entityForm);
 628  
<abbr title=" 629          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 629          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 630          Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 631  
 632          entityFormValidator.validate(entityForm, entity, result);

 633          if (result.hasErrors()) {
 634              model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 635              model.addAttribute(&quot;headerFlashAlert&quot;, true);
 636  
<abbr title=" 637              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 637              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectðŸ”µ</abbr>
 638              entityForm.clearFieldsMap();
 639              formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 640  
 641              if (isAddRequest(entity)) {
 642                  modifyAddEntityForm(entityForm, pathVars);
 643              } else {
 644                  modifyEntityForm(entityForm, pathVars);
 645              }

 646  
 647              model.addAttribute(&quot;entity&quot;, entity);
 648              model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 649  
 650              setModelAttributes(model, sectionKey);
 651  
 652              if (isAjaxRequest(request)) {
 653                  entityForm.setReadOnly();
 654                  model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);
 655                  model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());
 656                  return &quot;modules/modalContainer&quot;;
 657              } else {
 658                  model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 659                  model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
 660                  return &quot;modules/defaultContainer&quot;;
 661              }

 662          }
 663  
 664          ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 665  
 666          return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
























 667      }
 668  
 669      /**
 670       * Attempts to remove the given entity.
 671       *
 672       * @param request
 673       * @param response
 674       * @param model
 675       * @param pathVars
 676       * @param id
 677       * @return the return view path
 678       * @throws Exception
 679       */
 680      @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 681      public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 682              @PathVariable  Map&lt;String, String&gt; pathVars,
 683              @PathVariable(value=&quot;id&quot;) String id,
 684              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 685              RedirectAttributes ra) throws Exception {
 686          String sectionKey = getSectionKey(pathVars);
 687          String sectionClassName = getClassNameForSection(sectionKey);
 688          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 689  
<abbr title=" 690          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 690          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 691          Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 692          // Removal does not normally return an Entity unless there is some validation error
 693          if (entity != null) {
 694              entityFormValidator.validate(entityForm, entity, result);
 695              if (result.hasErrors()) {
 696                  // Create a flash attribute for the unsuccessful delete
 697                  FlashMap fm = new FlashMap();
 698                  fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 699                  fm.put(&quot;headerFlashAlert&quot;, true);
 700                  request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 701  
 702                  // Re-look back up the entity so that we can return something populated
<abbr title=" 703                  PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 703                  PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbðŸ”µ</abbr>
 704                  ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 705                  entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 706                  Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 706                  Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, ðŸ”µ</abbr>
 707                  entityForm.clearFieldsMap();
 708                  formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 709                  modifyEntityForm(entityForm, pathVars);
 710  
 711                  return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 712                          .done();
 713              }
 714          }
 715  
 716          ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 717          ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 718  
 719          if (isAjaxRequest(request)) {
 720              // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
 721              return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;
 722          } else {
 723              return &quot;redirect:/&quot; + sectionKey;
 724          }
 725      }
 726  
 727      @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 728      public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 728      public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletRespðŸ”µ</abbr>
 729              @PathVariable  Map&lt;String, String&gt; pathVars,
 730              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 731              @RequestParam String ids,
 732              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 733          String sectionKey = getSectionKey(pathVars);
 734          String sectionClassName = getClassNameForSection(sectionKey);
 735          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 736          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 736          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectiðŸ”µ</abbr>
 737          ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 738          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 739          FieldMetadata md = collectionProperty.getMetadata();
 740  
 741          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 742          ppr.setStartIndex(getStartIndex(requestParams));
 743          ppr.setMaxIndex(getMaxIndex(requestParams));
 744  
 745          if (md instanceof BasicFieldMetadata) {
 746              String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 747              String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 748  
 749              List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 750              ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 751  
 752              DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 753              Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 754  
 755              for (Entity e : drs.getRecords()) {
 756                  String id = e.getPMap().get(idProp).getValue();
 757                  String disp = e.getPMap().get(displayProp).getDisplayValue();
 758  
 759                  if (StringUtils.isBlank(disp)) {
 760                      disp = e.getPMap().get(displayProp).getValue();
 761                  }
 762  
 763                  returnMap.put(id,  disp);
 764              }
 765  
 766              return returnMap;
 767          }
 768  
 769          return null;
 770      }
 771  
 772      /**
<abbr title=" 773       * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 773       * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of pðŸ”µ</abbr>
 774       * then this method is invoked when a user clicks on the name of the default category field.
 775       *
 776       * @param request
 777       * @param response
 778       * @param model
 779       * @param pathVars
 780       * @param collectionField
 781       * @param id
 782       * @return
 783       * @throws Exception
 784       */
 785      @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
 786      public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,
 787              @PathVariable  Map&lt;String, String&gt; pathVars,
 788              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 789              @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 790          String sectionKey = getSectionKey(pathVars);
 791          String mainClassName = getClassNameForSection(sectionKey);
 792          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 793          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 793          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
 794          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 795          BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 796  
<abbr title=" 797          AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 797          AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(),ðŸ”µ</abbr>
<abbr title=" 798          String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 798          String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrlðŸ”µ</abbr>
 799          Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 800          varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 801          return viewEntityForm(request, response, model, varsForField, id);
 802      }
 803  
 804      @RequestMapping(
 805              value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 806              method = RequestMethod.POST
 807      )
 808      public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,
 809                                          @PathVariable  Map&lt;String, String&gt; pathVars,
 810                                          @PathVariable(value=&quot;id&quot;) String id,
 811                                          @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 812                                          @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 813                                          @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 814                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 814                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws ExceptðŸ”µ</abbr>
 815  
<abbr title=" 816          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 816          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeadðŸ”µ</abbr>
 817      }
 818  
 819  
 820      /**
 821       * Returns the records for a given collectionField filtered by a particular criteria
 822       *
 823       * @param request
 824       * @param response
 825       * @param model
 826       * @param pathVars
 827       * @param collectionField
 828       * @param requestParams
 829       * @return the return view path
 830       * @throws Exception
 831       */
 832      @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
 833      public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,
 834              @PathVariable  Map&lt;String, String&gt; pathVars,
 835              @PathVariable(value=&quot;id&quot;) String id,
 836              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 837              @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 838          String sectionKey = getSectionKey(pathVars);
 839          String mainClassName = getClassNameForSection(sectionKey);
 840          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 841          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);"> 841          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCðŸ”µ</abbr>
 842          ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 843          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 844  
 845          ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
 846          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
 847  
 848          // Next, we must get the new list grid that represents this collection
<abbr title=" 849          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);"> 849          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionðŸ”µ</abbr>
 850          model.addAttribute(&quot;listGrid&quot;, listGrid);
 851  
 852          model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 853  
 854          // We return the new list grid so that it can replace the currently visible one
 855          setModelAttributes(model, sectionKey);
 856          return &quot;views/standaloneListGrid&quot;;
 857      }
 858  
 859      /**
<abbr title=" 860       * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes"> 860       * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomðŸ”µ</abbr>
 861       * of this call depending on the type of the specified collection field.
 862       *
 863       * &lt;ul&gt;
 864       *  &lt;li&gt;
<abbr title=" 865       *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may"> 865       *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the useðŸ”µ</abbr>
<abbr title=" 866       *    enter information and associate the record with this collection. Used by fields such as ProductAttribute."> 866       *    enter information and associate the record with this collection. Used by fields such as ProductAttributeðŸ”µ</abbr>
 867       *  &lt;/li&gt;
 868       *  &lt;li&gt;
<abbr title=" 869       *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it."> 869       *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and seðŸ”µ</abbr>
 870       *    Used by fields such as &quot;allParentCategories&quot;.
 871       *  &lt;/li&gt;
 872       *  &lt;li&gt;
<abbr title=" 873       *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 873       *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entitðŸ”µ</abbr>
<abbr title=" 874       *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation"> 874       *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the opeðŸ”µ</abbr>
<abbr title=" 875       *    on an adorned field, which may carry extra meta-information about the created relationship, such as order."> 875       *    on an adorned field, which may carry extra meta-information about the created relationship, such as ordeðŸ”µ</abbr>
 876       *  &lt;/li&gt;
 877       *  &lt;li&gt;
<abbr title=" 878       *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and"> 878       *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity aðŸ”µ</abbr>
<abbr title=" 879       *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified"> 879       *    select it. Once the user selects the entity, he will be presented with an empty form based on the specifðŸ”µ</abbr>
<abbr title=" 880       *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition"> 880       *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addðŸ”µ</abbr>
 881       *    to linking an entity, provide extra fields, such as a promotional message.
 882       *  &lt;/li&gt;
 883       *  &lt;li&gt;
<abbr title=" 884       *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is"> 884       *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This fielðŸ”µ</abbr>
<abbr title=" 885       *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another"> 885       *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on ðŸ”µ</abbr>
 886       *    entity. Used by fields such as the mediaMap on a Sku.
 887       *  &lt;/li&gt;
 888       *
 889       * @param request
 890       * @param response
 891       * @param model
 892       * @param pathVars
 893       * @param id
 894       * @param collectionField
 895       * @param requestParams
 896       * @return the return view path
 897       * @throws Exception
 898       */
 899      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
 900      public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
 901              @PathVariable Map&lt;String, String&gt; pathVars,
 902              @PathVariable(value = &quot;id&quot;) String id,
 903              @PathVariable(value = &quot;collectionField&quot;) String collectionField,
 904              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 905          String sectionKey = getSectionKey(pathVars);
 906          String mainClassName = getClassNameForSection(sectionKey);
 907          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 908          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,
 909                  sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
 910          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 911          FieldMetadata md = collectionProperty.getMetadata();
 912  
 913          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
 914                  .withFilterAndSortCriteria(getCriteria(requestParams))
 915                  .withStartIndex(getStartIndex(requestParams))
 916                  .withMaxIndex(getMaxIndex(requestParams))
 917                  .withLastId(getLastId(requestParams))
 918                  .withFirstId(getFirstId(requestParams))
 919                  .withUpperCount(getUpperCount(requestParams))
 920                  .withLowerCount(getLowerCount(requestParams))
 921                  .withPageSize(getPageSize(requestParams))
 922                  .withPresentationFetch(true);
 923  
 924          if (md instanceof BasicCollectionMetadata) {
 925              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
 926              if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
 927                  ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 928                  // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types
 929                  // for this entity.
 930                  String entityType = null;

 931                  if (requestParams.containsKey(&quot;entityType&quot;)) {
 932                      entityType = requestParams.get(&quot;entityType&quot;).get(0);
 933                  }



 934                  if (StringUtils.isBlank(entityType)) {
 935                      if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 936                          entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 937                      } else {
 938                          entityType = getDefaultEntityType();
 939                      }
 940                  } else {
 941                      entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);

 942                  }
 943  
 944                  if (StringUtils.isBlank(entityType)) {
 945                      List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 946                      model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 947                      model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);
 948                      model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 949                      String requestUri = request.getRequestURI();
<abbr title=" 950                      if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {"> 950                      if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) ðŸ”µ</abbr>
<abbr title=" 951                          requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());"> 951                          requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.lengthðŸ”µ</abbr>
 952                      }
 953                      model.addAttribute(&quot;currentUri&quot;, requestUri);
 954                      model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 955                      setModelAttributes(model, sectionKey);
 956                      return &quot;modules/modalContainer&quot;;
 957                  } else {
 958                      ppr = ppr.withCeilingEntityClassname(entityType);
 959                  }

 960              }
 961          } else if (md instanceof MapMetadata) {
<abbr title=" 962              ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);"> 962              ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(requestðŸ”µ</abbr>
 963              if (result.equals(ExtensionResultStatusType.HANDLED)) {
 964                  model.addAttribute(&quot;entityId&quot;, id);
 965                  model.addAttribute(&quot;sectionKey&quot;, sectionKey);
 966                  model.addAttribute(&quot;collectionField&quot;, collectionField);
 967                  return &quot;modules/modalContainer&quot;;
 968              }
 969          }
 970  
 971          //service.getContextSpecificRelationshipId(mainMetadata, entity, prefix);



 972  
 973          model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
 974  
<abbr title=" 975          return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);"> 975          return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionPrðŸ”µ</abbr>





















 976      }
 977  
<abbr title=" 978      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)"> 978      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POSðŸ”µ</abbr>
<abbr title=" 979      public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,"> 979      public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse resðŸ”µ</abbr>
 980              @PathVariable Map&lt;String, String&gt; pathVars,
 981              @PathVariable(value=&quot;id&quot;) String id,
 982              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 983              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
 984          String sectionKey = getSectionKey(pathVars);
 985          String mainClassName = getClassNameForSection(sectionKey);
 986          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 987          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 987          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
 988          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 989          FieldMetadata md = collectionProperty.getMetadata();
 990          Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
 991          if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title=" 992              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,"> 992              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassNaðŸ”µ</abbr>
 993                      collectionField,
 994                      collectionItemId, responseMap);
 995          }
 996          return responseMap;
 997      }
 998  
 999      /**
1000       *
1001       * @param request
1002       * @param response
1003       * @param model
1004       * @param pathVars
1005       * @param id
1006       * @param collectionField
1007       * @param requestParams
1008       * @return Json collection data
1009       * @throws Exception
1010       */
1011      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1012      public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1012      public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletðŸ”µ</abbr>
1013              @PathVariable Map&lt;String, String&gt; pathVars,
1014              @PathVariable(value = &quot;id&quot;) String id,
1015              @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1016              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1017          String sectionKey = getSectionKey(pathVars);
1018          String mainClassName = getClassNameForSection(sectionKey);
1019          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1020          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,
1021                  sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1022          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1023          FieldMetadata md = collectionProperty.getMetadata();
1024  
1025          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1026                  .withFilterAndSortCriteria(getCriteria(requestParams))
1027                  .withStartIndex(getStartIndex(requestParams))
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1028 -                .withMaxIndex(getMaxIndex(requestParams))</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1029 -                .withCustomCriteria(buildSelectizeCustomCriteria());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1030 +                .withMaxIndex(getMaxIndex(requestParams));</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"><abbr title="1031 +        String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCriteria()))">1031 +        String[] both = Stream.concat(Arrays.stream(ppr.getCustomCriteria()), Arrays.stream(buildSelectizeCustomCrðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1032 +                .toArray(String[]::new);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1033 +        ppr = ppr.withCustomCriteria( both);</span>
1034  
1035          if (md instanceof AdornedTargetCollectionMetadata) {
1036              ppr.setOperationTypesOverride(null);
1037              ppr.setType(PersistencePackageRequest.Type.STANDARD);
1038              ppr.setSectionEntityField(collectionField);
1039          }
1040  
1041          DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1042  
1043          return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);
1044      }
1045  
1046      protected String[] buildSelectizeCustomCriteria() {
1047          return new String[]{ IS_SELECTIZE_REQUEST };
1048      }
1049  
1050      /**
1051       * Adds the requested collection item via Selectize
1052       *
1053       * @param request
1054       * @param response
1055       * @param model
1056       * @param pathVars
1057       * @param id
1058       * @param collectionField
1059       * @param entityForm
1060       * @return the return view path
1061       * @throws Exception
1062       */
1063      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1064      public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1064      public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
1065              @PathVariable Map&lt;String, String&gt; pathVars,
1066              @PathVariable(value=&quot;id&quot;) String id,
1067              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1068              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1069          Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1070          String sectionKey = getSectionKey(pathVars);
1071          String mainClassName = getClassNameForSection(sectionKey);
1072          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1073          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1073          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1074          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1075  
1076          if (StringUtils.isBlank(entityForm.getEntityType())) {
1077              FieldMetadata fmd = collectionProperty.getMetadata();
1078              if (fmd instanceof BasicCollectionMetadata) {
1079                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1080              }
1081          }
1082  
<abbr title="1083          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1083          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1084          ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1085          declareShouldIgnoreAdditionStatusFilter();
1086          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1087  
1088          // First, we must save the collection entity
<abbr title="1089          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1089          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1090          Entity savedEntity = persistenceResponse.getEntity();
1091          entityFormValidator.validate(entityForm, savedEntity, result);
1092  
1093          if (result.hasErrors()) {
1094              returnVal.put(&quot;error&quot;, result.getFieldError());
1095              return returnVal;
1096          }
1097  
1098          if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1099              returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1100          }
1101          return returnVal;
1102      }
1103  
1104      protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1105          Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1105          Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditioðŸ”µ</abbr>
1106          additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1107      }
1108  
1109      /**
1110       * Adds the requested collection item
1111       *
1112       * @param request
1113       * @param response
1114       * @param model
1115       * @param pathVars
1116       * @param id
1117       * @param collectionField
1118       * @param entityForm
1119       * @return the return view path
1120       * @throws Exception
1121       */
1122      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
1123      public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1124              @PathVariable Map&lt;String, String&gt; pathVars,
1125              @PathVariable(value=&quot;id&quot;) String id,
1126              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1127              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1128          String sectionKey = getSectionKey(pathVars);
1129          String mainClassName = getClassNameForSection(sectionKey);
1130          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1131          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1131          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1132          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1133  
1134          if (StringUtils.isBlank(entityForm.getEntityType())) {
1135              FieldMetadata fmd = collectionProperty.getMetadata();
1136              if (fmd instanceof BasicCollectionMetadata) {
1137                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1138              }
1139          }
1140  
<abbr title="1141          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1141          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1142          declareShouldIgnoreAdditionStatusFilter();
1143          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1144  
1145          // First, we must save the collection entity
<abbr title="1146          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1146          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1147          Entity savedEntity = persistenceResponse.getEntity();
1148          entityFormValidator.validate(entityForm, savedEntity, result);
1149  
1150          if (result.hasErrors()) {
1151              FieldMetadata md = collectionProperty.getMetadata();
1152              ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1153              return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1153              return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectiðŸ”µ</abbr>
1154                      md, ppr, entityForm, savedEntity);
1155          }
1156  
1157          // Next, we must get the new list grid that represents this collection
<abbr title="1158          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1158          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1159          model.addAttribute(&quot;listGrid&quot;, listGrid);
1160  
1161          // We return the new list grid so that it can replace the currently visible one
1162          model.addAttribute(&quot;actualEntityId&quot;, id);
1163          setModelAttributes(model, sectionKey);
1164          return &quot;views/standaloneListGrid&quot;;
1165      }
1166  
1167      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1168      public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1168      public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, MðŸ”µ</abbr>
1169              @PathVariable Map&lt;String, String&gt; pathVars,
1170              @PathVariable(value=&quot;id&quot;) String id,
1171              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1172              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1173          String sectionKey = getSectionKey(pathVars);
1174          String mainClassName = getClassNameForSection(sectionKey);
1175          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1176          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1176          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1177          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1178  
1179          if (StringUtils.isBlank(entityForm.getEntityType())) {
1180              FieldMetadata fmd = collectionProperty.getMetadata();
1181              if (fmd instanceof BasicCollectionMetadata) {
1182                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1183              }
1184          }
1185  
<abbr title="1186          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1186          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1187          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1188          entity.setIsPreAdd(true);
1189          // First, we must save the collection entity
<abbr title="1190          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1190          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1191          Entity savedEntity = persistenceResponse.getEntity();
1192  
1193          return new JsonResponse(response)
1194                  .with(&quot;status&quot;, &quot;complete&quot;)
1195                  .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1196                  .done();
1197      }
1198  
1199      /**
<abbr title="1200       * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1200       * Builds out all of the model information needed for showing the add modal for collection items on both the iðŸ”µ</abbr>
1201       * as well as after a POST with validation errors
1202       *
1203       * @param request
1204       * @param model
1205       * @param id
1206       * @param collectionField
1207       * @param sectionKey
1208       * @param collectionProperty
1209       * @param md
1210       * @param ppr
1211       * @return the appropriate view to display for the modal
<abbr title="1212       * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1212       * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityFðŸ”µ</abbr>
<abbr title="1213       * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1213       * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MulðŸ”µ</abbr>
1214       * @throws ServiceException
1215       */
1216      protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,
1217              Model model, String id, String collectionField, String sectionKey, Property collectionProperty,
<abbr title="1218              FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1218              FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceEðŸ”µ</abbr>
1219  
<abbr title="1220          // For requests to add a new collection item include the main class that the subsequent request comes from.">1220          // For requests to add a new collection item include the main class that the subsequent request comes fromðŸ”µ</abbr>
<abbr title="1221          // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1221          // For instance, with basic collections we know the main associated class for a fetch through the ForeignKðŸ”µ</abbr>
1222          // persistence item but map and adorned target lookups make a standard persistence request. This solution
1223          // fixes all cases.
1224          String mainClassName = getClassNameForSection(sectionKey);
1225          ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1226          ppr.setAddOperationInspect(true);
1227  
1228          if (entityForm != null) {
1229              entityForm.clearFieldsMap();
1230          }
1231          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1232          if (md instanceof BasicCollectionMetadata) {
1233              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1234  
1235              // When adding items to basic collections, we will sometimes show a form to persist a new record
1236              // and sometimes show a list grid to allow the user to associate an existing record.
1237              if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1238                  ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1238                  ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetðŸ”µ</abbr>
1239                  if (entityForm == null) {
1240                      entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1241                      entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1242                      entityForm.setEntityType(ppr.getCeilingEntityClassname());
1243                  } else {
1244                      formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1245                      formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1246                  }
<abbr title="1247                  formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1247                  formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassnamðŸ”µ</abbr>
1248                  entityForm.getTabs().iterator().next().getIsVisible();
1249  
1250                  model.addAttribute(&quot;entityForm&quot;, entityForm);
1251                  model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1252              } else {
1253                  DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1254                  ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1254                  ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sðŸ”µ</abbr>
1255                  listGrid.setPathOverride(request.getRequestURL().toString());
1256  
<abbr title="1257                  if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1257                  if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fðŸ”µ</abbr>
1258                      listGrid.removeAllRowActions();
1259                  }
1260  
1261                  model.addAttribute(&quot;listGrid&quot;, listGrid);
1262                  model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1263              }
1264          } else if (md instanceof AdornedTargetCollectionMetadata) {
1265              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1266  
<abbr title="1267              // Even though this field represents an adorned target collection, the list we want to show in the modal">1267              // Even though this field represents an adorned target collection, the list we want to show in the modðŸ”µ</abbr>
1268              // is the standard list grid for the target entity of this field
1269              ppr.setOperationTypesOverride(null);
1270              ppr.setType(PersistencePackageRequest.Type.STANDARD);
1271              ppr.setSectionEntityField(collectionField);
1272  
<abbr title="1273              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1273              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1274  
1275              DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1276              ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1276              ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectiðŸ”µ</abbr>
1277              listGrid.setSubCollectionFieldName(collectionField);
1278              listGrid.setPathOverride(request.getRequestURL().toString());
1279              listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1280              if (entityForm == null) {
<abbr title="1281                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1281                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs,ðŸ”µ</abbr>
1282                  entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());
1283              } else {
<abbr title="1284                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1284                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, ðŸ”µ</abbr>
1285                  formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1286              }
1287  
1288              listGrid.setListGridType(ListGrid.Type.ADORNED);
1289              for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1290                  if (entry.getValue().getIsVisible()) {
1291                      listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1292                      break;
1293                  }
1294              }
1295  
1296              // This is part of an add, so we want to be able to filter/sort the listgrid
1297              listGrid.setIsSortable(false);
1298              listGrid.setCanFilterAndSort(true);
1299              listGrid.removeAllRowActions();
1300  
1301              model.addAttribute(&quot;listGrid&quot;, listGrid);
1302              model.addAttribute(&quot;entityForm&quot;, entityForm);
1303              model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1304          } else if (md instanceof MapMetadata) {
1305              MapMetadata fmd = (MapMetadata) md;
<abbr title="1306              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1306              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1307  
1308              if (entityForm == null) {
1309                  entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);
1310              } else {
1311                  formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1312                  formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1313              }
1314              model.addAttribute(&quot;entityForm&quot;, entityForm);
1315              model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1316          }
1317  
1318          // Set the parent id on the entity form
1319          if (entityForm != null) {
1320              entityForm.setParentId(id);
1321          }
1322  
1323          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1324          model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1325          model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1326          setModelAttributes(model, sectionKey);
1327          return &quot;modules/modalContainer&quot;;

1328      }
1329  
1330      /**
1331       * Shows the appropriate modal dialog to edit the selected collection item
1332       *
1333       * @param request
1334       * @param response
1335       * @param model
1336       * @param pathVars
1337       * @param id
1338       * @param collectionField
1339       * @param collectionItemId
1340       * @return the return view path
1341       * @throws Exception
1342       */
<abbr title="1343      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1343      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.ðŸ”µ</abbr>
1344      public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1345              @PathVariable  Map&lt;String, String&gt; pathVars,
1346              @PathVariable(value=&quot;id&quot;) String id,
1347              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1348              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1349              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1350          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1350          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateðŸ”µ</abbr>
1351                  ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1352      }
1353  
1354      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
1355      public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1356              @PathVariable  Map&lt;String, String&gt; pathVars,
1357              @PathVariable(value=&quot;id&quot;) String id,
1358              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1359              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1360          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,
1361                  ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1362      }
1363  
1364      /**
<abbr title="1365       * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1365       * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as reaðŸ”µ</abbr>
1366       *
1367       * @param request
1368       * @param response
1369       * @param model
1370       * @param pathVars
1371       * @param id
1372       * @param collectionField
1373       * @param collectionItemId
1374       * @return the return view path
1375       * @throws Exception
1376       */
<abbr title="1377      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1377      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMeðŸ”µ</abbr>
1378      public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1379              @PathVariable  Map&lt;String, String&gt; pathVars,
1380              @PathVariable(value=&quot;id&quot;) String id,
1381              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1382              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1383              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1384          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1384          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1385                  ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1386  
1387          // Since this is a read-only view, actions don&#x27;t make sense in this context
1388          EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1389          addAuditableDisplayFields(ef);
1390          ef.removeAllActions();
1391          ef.setReadOnly();
1392  
1393          return returnPath;
1394      }
1395  
1396      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)
1397      public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1398              @PathVariable  Map&lt;String, String&gt; pathVars,
1399              @PathVariable(value=&quot;id&quot;) String id,
1400              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1401              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1402          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1402          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1403                  ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1404  
1405          // Since this is a read-only view, actions don&#x27;t make sense in this context
1406          EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1407          ef.removeAllActions();
1408          ef.setReadOnly();
1409  
1410          return returnPath;
1411      }
1412  
<abbr title="1413      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1413      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1414              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1414              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderTypeðŸ”µ</abbr>
<abbr title="1415          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1415          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateðŸ”µ</abbr>
1416      }
1417  
<abbr title="1418      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1418      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1419              String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1419              String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceExceðŸ”µ</abbr>
<abbr title="1420          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1420          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modðŸ”µ</abbr>
1421      }
1422  
<abbr title="1423      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1423      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1424                  String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1424                  String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entðŸ”µ</abbr>
<abbr title="1425          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1425          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modðŸ”µ</abbr>
1426      }
1427  
1428      /**
<abbr title="1429       * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1429       * Shows the view and populates the model for updating a collection item. You can also pass in an entityform aðŸ”µ</abbr>
1430       * which are optional. If they are not passed in then they are automatically looked up
1431       *
1432       * @param request
1433       * @param model
1434       * @param pathVars
1435       * @param id
1436       * @param collectionField
1437       * @param collectionItemId
1438       * @param modalHeaderType
1439       * @param entityForm
1440       * @param entity
1441       * @return
1442       * @throws ServiceException
1443       */
<abbr title="1444      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1444      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1445              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1445              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderTypeðŸ”µ</abbr>










1446          String sectionKey = getSectionKey(pathVars);
1447          String mainClassName = getClassNameForSection(sectionKey);
1448          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1449          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1449          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1450          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1451          FieldMetadata md = collectionProperty.getMetadata();
1452          SectionCrumb nextCrumb = new SectionCrumb();
1453          if (md instanceof MapMetadata) {
1454              nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1455          } else {
1456              nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1457          }
1458          nextCrumb.setSectionId(collectionItemId);
1459          if (!sectionCrumbs.contains(nextCrumb)) {
1460              sectionCrumbs.add(nextCrumb);
1461          }
1462  
<abbr title="1463          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1463          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
<abbr title="1464          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1464          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0ðŸ”µ</abbr>
1465  
1466          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1467  
1468          if (md instanceof BasicCollectionMetadata &amp;&amp;
1469                  (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
1470                          ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {
1471              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1472  
<abbr title="1473              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1473              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1474              if (entity == null) {
<abbr title="1475                  entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1475                  entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().ðŸ”µ</abbr>
1476              }
1477  
1478              String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1479              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1479              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entðŸ”µ</abbr>
1480              if (entityForm == null) {
<abbr title="1481                  entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);">1481                  entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbsðŸ”µ</abbr>
1482              } else {
1483                  entityForm.clearFieldsMap();
<abbr title="1484                  formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbs);">1484                  formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbðŸ”µ</abbr>
1485                  //remove all the actions since we&#x27;re not trying to redisplay them on the form
1486                  entityForm.removeAllActions();
1487              }




1488              entityForm.removeAction(DefaultEntityFormActions.DELETE);


1489              addAuditableDisplayFields(entityForm);
1490              model.addAttribute(&quot;entityForm&quot;, entityForm);
1491              model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1492          } else if (md instanceof AdornedTargetCollectionMetadata) {
1493              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1494  
1495              if (entity == null) {
1496                  entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1497                      collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1498              }
1499  
1500              boolean populateTypeAndId = true;
1501              boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);
1502              if (entityForm == null) {
<abbr title="1503                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1503                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem,ðŸ”µ</abbr>
1504                  entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1505                  entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1506              } else {
1507                  entityForm.clearFieldsMap();
1508                  String entityType = entityForm.getEntityType();
<abbr title="1509                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1509                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, ðŸ”µ</abbr>
1510                  entityForm.setEntityType(entityType);
1511                  populateTypeAndId = false;
1512              }
1513  
1514              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1515              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1515              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassNaðŸ”µ</abbr>
1516                      collectionField,
1517                      collectionItemId, responseMap);
1518  
<abbr title="1519              //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1519              //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is useðŸ”µ</abbr>
1520              //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).
1521              entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1522              entityForm.setTranslationId(alternateId);
1523  
1524              ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1525              for (String field : fmd.getMaintainedAdornedTargetFields()) {
1526                  if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1527                      continue;
1528                  }
1529                  Property p = cmd.getPMap().get(field);
1530                  if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1531                      // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1531                      // Because we&#x27;re dealing with a nested adorned target collection, this particular request mustðŸ”µ</abbr>
<abbr title="1532                      // directly on the first adorned target collection. Because of this, we need the actual id property">1532                      // directly on the first adorned target collection. Because of this, we need the actual id proðŸ”µ</abbr>
<abbr title="1533                      // from the entity that models the adorned target relationship, and not the id of the target object.">1533                      // from the entity that models the adorned target relationship, and not the id of the target oðŸ”µ</abbr>
<abbr title="1534                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1534                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERðŸ”µ</abbr>
1535                      DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,
1536                              alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1537  
<abbr title="1538                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1538                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, pðŸ”µ</abbr>
1539                              ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1540                      listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1541  
1542                      if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1543                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1543                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1544                      } else {
<abbr title="1545                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1545                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1546                      }
1547                  } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1548                      // See above comment for AdornedTargetCollectionMetadata
1549                      MapMetadata mmd = (MapMetadata) p.getMetadata();
1550  
<abbr title="1551                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1551                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERðŸ”µ</abbr>
1552                      DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,
1553                              alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1554  
<abbr title="1555                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1555                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, pðŸ”µ</abbr>
1556                              mmd.getTargetClass(), sectionCrumbs);
1557                      listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1558  
1559                      if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1560                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1560                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1561                      } else {
<abbr title="1562                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1562                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1563                      }
1564                  }
1565              }
1566  
1567              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1568              formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1569  
1570              boolean atLeastOneBasicField = false;
1571              for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1572                  if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">1572                  if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !reðŸ”µ</abbr>
1573                      atLeastOneBasicField = true;
1574                      break;
1575                  }
1576              }
1577              if (!atLeastOneBasicField) {
1578                  entityForm.removeAction(DefaultEntityFormActions.SAVE);
1579              }
1580              addAuditableDisplayFields(entityForm);
1581              model.addAttribute(&quot;entityForm&quot;, entityForm);
1582              model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1583          } else if (md instanceof MapMetadata) {
1584              MapMetadata fmd = (MapMetadata) md;
1585  
<abbr title="1586              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1586              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1587              if (entity == null) {
1588                  entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1589                      collectionItemId, sectionCrumbs, null).getEntity();
1590              }
1591  
1592              boolean populateTypeAndId = true;
1593              if (entityForm == null) {
1594                  entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);
1595              } else {
1596                  //save off the prior key before clearing out the fields map as it will not appear
1597                  //back on the saved entity
1598                  String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1599                  entityForm.clearFieldsMap();
1600                  formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1601                  entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1602                  populateTypeAndId = false;
1603              }
1604  
1605              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1606              formService.populateMapEntityFormFields(entityForm, entity);
1607              addAuditableDisplayFields(entityForm);
1608              model.addAttribute(&quot;entityForm&quot;, entityForm);
1609              model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1610          }
1611  
1612          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1613          model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1614          model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1615          setModelAttributes(model, sectionKey);
1616          return &quot;modules/modalContainer&quot;;




















1617      }
1618  
1619      /**
1620       * Updates the specified collection item
1621       *
1622       * @param request
1623       * @param response
1624       * @param model
1625       * @param pathVars
1626       * @param id
1627       * @param collectionField
<abbr title="1628       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1628       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this isðŸ”µ</abbr>
1629       * @param entityForm
1630       * @param result
1631       * @return the return view path
1632       * @throws Exception
1633       */
1634      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
1635      public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1636              @PathVariable  Map&lt;String, String&gt; pathVars,
1637              @PathVariable(value=&quot;id&quot;) String id,
1638              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1639              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1640              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1641              BindingResult result) throws Exception {
<abbr title="1642          return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1642          return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entðŸ”µ</abbr>
1643      }
1644  
1645      /**
1646       * Updates the specified collection item
1647       *
1648       * @param request
1649       * @param response
1650       * @param model
1651       * @param pathVars
1652       * @param id
1653       * @param collectionField
<abbr title="1654       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1654       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this isðŸ”µ</abbr>
1655       * @param entityForm
<abbr title="1656       * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1656       * @param alternateId in the case of adorned target collections, this is the primary key value of the collectiðŸ”µ</abbr>
1657       * @param result
1658       * @return the return view path
1659       * @throws Exception
1660       */
<abbr title="1661      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1661      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.ðŸ”µ</abbr>
1662      public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1663              @PathVariable  Map&lt;String, String&gt; pathVars,
1664              @PathVariable(value=&quot;id&quot;) String id,
1665              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1666              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1667              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1668              @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1669              BindingResult result) throws Exception {
1670          String sectionKey = getSectionKey(pathVars);
1671          String mainClassName = getClassNameForSection(sectionKey);
1672          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1673          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1673          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1674          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1675  
<abbr title="1676          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1676          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1677          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1678  
1679          // First, we must save the collection entity
<abbr title="1680          PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1680          PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collðŸ”µ</abbr>
1681          Entity savedEntity = persistenceResponse.getEntity();
1682          entityFormValidator.validate(entityForm, savedEntity, result);
1683  
1684          if (result.hasErrors()) {
<abbr title="1685              return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1685              return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alterðŸ”µ</abbr>
1686                      ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1687          }
1688  
1689          // Next, we must get the new list grid that represents this collection
1690          // We return the new list grid so that it can replace the currently visible one
<abbr title="1691          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1691          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1692  
1693          model.addAttribute(&quot;listGrid&quot;, listGrid);
1694          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1695          setModelAttributes(model, sectionKey);
1696          return &quot;views/standaloneListGrid&quot;;
1697      }
1698  
1699      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)
1700      public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1701              HttpServletResponse response, Model model,
1702              @PathVariable  Map&lt;String, String&gt; pathVars,
1703              @PathVariable(value=&quot;id&quot;) String id,
1704              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1705              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1706              @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1707          return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1707          return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionIteðŸ”µ</abbr>
1708      }
1709  
1710      /**
1711       * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections
1712       * where a sort field is specified -- any other invocation is incorrect and will result in an exception.
1713       *
1714       * @param request
1715       * @param response
1716       * @param model
1717       * @param pathVars
1718       * @param id
1719       * @param collectionField
1720       * @param collectionItemId
1721       * @return an object explaining the state of the operation
1722       * @throws Exception
1723       */
<abbr title="1724      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1724      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequeðŸ”µ</abbr>
1725      public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1726              HttpServletResponse response, Model model,
1727              @PathVariable  Map&lt;String, String&gt; pathVars,
1728              @PathVariable(value=&quot;id&quot;) String id,
1729              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1730              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1731              @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1732              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1733          String sectionKey = getSectionKey(pathVars);
1734          String mainClassName = getClassNameForSection(sectionKey);
1735          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1736          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1736          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1737          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1738          FieldMetadata md = collectionProperty.getMetadata();
1739  
<abbr title="1740          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1740          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1741          ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1742  
<abbr title="1743          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1743          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0ðŸ”µ</abbr>
1744  
1745          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1746  
1747          if (md instanceof AdornedTargetCollectionMetadata) {
1748              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1749              AdornedTargetList atl = ppr.getAdornedList();
1750  
1751              // Get an entity form for the entity
<abbr title="1752              EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1752              EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionðŸ”µ</abbr>
1753              Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1754                      collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})
1755                      .getDynamicResultSet().getRecords()[0];
1756              formService.populateEntityFormFields(entityForm, entity);
1757              formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1758  
<abbr title="1759              // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">1759              // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indeðŸ”µ</abbr>
1760              int sequenceValue = Integer.parseInt(newSequence) + 1;
1761              Field field = entityForm.findField(atl.getSortField());
1762              field.setValue(String.valueOf(sequenceValue));
1763  
1764              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1765              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">1765              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, ðŸ”µ</abbr>
1766              Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
1767  
1768              responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1769              responseMap.put(&quot;field&quot;, collectionField);
1770              responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1771              return responseMap;
1772          } else if (md instanceof BasicCollectionMetadata) {
1773              BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
1774              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1775              Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1775              Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().geðŸ”µ</abbr>
1776  
<abbr title="1777              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1777              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1778              EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
1779              if (!StringUtils.isEmpty(cd.getSortProperty())) {
1780                  Field f = new Field()
1781                          .withName(cd.getSortProperty())
1782                          .withFieldType(SupportedFieldType.HIDDEN.toString());
1783                  entityForm.addHiddenField(mainMetadata, f);
1784              }
1785              formService.populateEntityFormFields(entityForm, entity);
1786  
1787              if (!StringUtils.isEmpty(cd.getSortProperty())) {
1788                  int sequenceValue = Integer.parseInt(newSequence) + 1;
1789                  Field field = entityForm.findField(cd.getSortProperty());
1790                  field.setValue(String.valueOf(sequenceValue));
1791              }
1792  
<abbr title="1793              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">1793              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, ðŸ”µ</abbr>
1794              Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
1795  
1796              responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1797              responseMap.put(&quot;field&quot;, collectionField);
1798              responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1799              return responseMap;
1800          } else {
<abbr title="1801              throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">1801              throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fiðŸ”µ</abbr>
1802          }
1803      }
1804  
1805      /**
1806       * Removes the requested collection item
1807       *
<abbr title="1808       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1808       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item froðŸ”µ</abbr>
1809       * map collection.
1810       *
1811       * @param request
1812       * @param response
1813       * @param model
1814       * @param pathVars
1815       * @param id
1816       * @param collectionField
1817       * @param collectionItemId
1818       * @return the return view path
1819       * @throws Exception
1820       */
1821      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)
1822      public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1823              @PathVariable  Map&lt;String, String&gt; pathVars,
1824              @PathVariable(value=&quot;id&quot;) String id,
1825              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1826              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1827          return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">1827          return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, nulðŸ”µ</abbr>
1828      }
1829  
1830      /**
1831       * Removes the requested collection item
1832       *
<abbr title="1833       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">1833       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item froðŸ”µ</abbr>
1834       * map collection.
1835       *
1836       * @param request
1837       * @param response
1838       * @param model
1839       * @param pathVars
1840       * @param id
1841       * @param collectionField
1842       * @param collectionItemId
1843       * @return the return view path
1844       * @throws Exception
1845       */
<abbr title="1846      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">1846      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestðŸ”µ</abbr>
1847      public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1848              @PathVariable  Map&lt;String, String&gt; pathVars,
1849              @PathVariable(value=&quot;id&quot;) String id,
1850              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1851              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1852              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1853          String sectionKey = getSectionKey(pathVars);
1854          String mainClassName = getClassNameForSection(sectionKey);
1855          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1856          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1856          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1857          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1858  
1859          String priorKey = request.getParameter(&quot;key&quot;);
1860  
<abbr title="1861          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1861          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1862          declareShouldIgnoreAdditionStatusFilter();
1863          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1864  
1865          // First, we must remove the collection entity
<abbr title="1866          PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">1866          PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperðŸ”µ</abbr>
1867          if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {
1868              String error = &quot;There was an error removing the whatever&quot;;
1869              if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
1870                  // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="1871                  error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">1871                  error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().gðŸ”µ</abbr>
1872              } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {
1873                  error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
1874              }
1875              return new JsonResponse(response)
1876                  .with(&quot;status&quot;, &quot;error&quot;)
1877                  .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
1878                  .done();
1879          }
1880  
1881          // Next, we must get the new list grid that represents this collection
1882          // We return the new list grid so that it can replace the currently visible one
<abbr title="1883          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1883          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1884  
1885          model.addAttribute(&quot;listGrid&quot;, listGrid);
1886          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1887          setModelAttributes(model, sectionKey);
1888          return &quot;views/standaloneListGrid&quot;;
1889      }
1890  
1891      public void addAuditableDisplayFields(EntityForm entityForm) {
1892          Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
1893          if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
1894              addAuditableDisplayField(entityForm, createdBy);
1895  
1896              createdBy.setIsVisible(false);
1897          }
1898          Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
1899          if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
1900              addAuditableDisplayField(entityForm, updatedBy);
1901  
1902              updatedBy.setIsVisible(false);
1903          }
1904      }
1905  
1906      private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
1907          Field displayField = buildAuditableDisplayField(userField);
1908  
1909          AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
1910          String userName = user == null ? null : user.getName();
1911          displayField.setValue(userName);
1912  
1913          FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
1914          if (auditGroup != null) {
1915              auditGroup.addField(displayField);
1916          }
1917      }
1918  
1919      private Field buildAuditableDisplayField(Field auditableField) {
1920          return new Field().withFieldType(SupportedFieldType.STRING.toString())
1921                  .withName(auditableField.getName() + &quot;Display&quot;)
1922                  .withFriendlyName(auditableField.getFriendlyName())
1923                  .withOrder(auditableField.getOrder())
1924                  .withOwningEntityClass(auditableField.getOwningEntityClass())
1925                  .withReadOnly(true);
1926      }
1927  
1928      protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
1929          String tabName = pathVars.get(&quot;tabName&quot;);
1930          if (StringUtils.isBlank(tabName)) {
1931              TabMetadata firstTab = cmd.getFirstTab();
1932              return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
1933          }
1934          return tabName;
1935      }
1936  
1937      // *****************************************
1938      // Typed Entity Helper Methods
1939      // *****************************************
1940  
1941      protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
1942          // Check if this is a typed entity
1943          AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
1944          if (typedEntitySection != null) {
1945              // Update the friendly name for this Entity Type
1946              model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
1947          }
1948      }
1949  
1950      // *********************************
1951      // ADDITIONAL SPRING-BOUND METHODS *
1952      // *********************************
1953  
1954      /**
1955       * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.
<abbr title="1956       * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">1956       * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports eitheðŸ”µ</abbr>
1957       * or false. If the value is passed in as null, it will treat it as false.
1958       *
1959       * @param binder
1960       */
1961      @InitBinder
1962      public void initBinder(WebDataBinder binder) {
1963          binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
1964          binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
1965      }
1966  
1967  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Open Admin Platform
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.openadmin.web.controller.entity;
  19  
  20  import org.apache.commons.collections.CollectionUtils;
  21  import org.apache.commons.collections.MapUtils;
  22  import org.apache.commons.lang3.StringUtils;
  23  import org.apache.commons.logging.Log;
  24  import org.apache.commons.logging.LogFactory;
  25  import org.broadleafcommerce.common.exception.SecurityServiceException;
  26  import org.broadleafcommerce.common.exception.ServiceException;
  27  import org.broadleafcommerce.common.extension.ExtensionResultHolder;
  28  import org.broadleafcommerce.common.extension.ExtensionResultStatusType;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import org.broadleafcommerce.common.persistence.EntityDuplicator;</span>
  30  import org.broadleafcommerce.common.presentation.client.AddMethodType;
  31  import org.broadleafcommerce.common.presentation.client.SupportedFieldType;
  32  import org.broadleafcommerce.common.sandbox.SandBoxHelper;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  33 +import org.broadleafcommerce.common.service.GenericEntityService;</span>
  34  import org.broadleafcommerce.common.util.BLCArrayUtils;
  35  import org.broadleafcommerce.common.util.BLCMessageUtils;
  36  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  37  import org.broadleafcommerce.common.web.JsonResponse;
  38  import org.broadleafcommerce.openadmin.dto.AdornedTargetCollectionMetadata;
  39  import org.broadleafcommerce.openadmin.dto.AdornedTargetList;
  40  import org.broadleafcommerce.openadmin.dto.BasicCollectionMetadata;
  41  import org.broadleafcommerce.openadmin.dto.BasicFieldMetadata;
  42  import org.broadleafcommerce.openadmin.dto.ClassMetadata;
  43  import org.broadleafcommerce.openadmin.dto.ClassTree;
  44  import org.broadleafcommerce.openadmin.dto.CollectionMetadata;
  45  import org.broadleafcommerce.openadmin.dto.DynamicResultSet;
  46  import org.broadleafcommerce.openadmin.dto.Entity;
  47  import org.broadleafcommerce.openadmin.dto.FieldMetadata;
  48  import org.broadleafcommerce.openadmin.dto.FilterAndSortCriteria;
  49  import org.broadleafcommerce.openadmin.dto.MapMetadata;
  50  import org.broadleafcommerce.openadmin.dto.Property;
  51  import org.broadleafcommerce.openadmin.dto.SectionCrumb;
  52  import org.broadleafcommerce.openadmin.dto.TabMetadata;
  53  import org.broadleafcommerce.openadmin.server.dao.DynamicEntityDao;
  54  import org.broadleafcommerce.openadmin.server.domain.PersistencePackageRequest;
  55  import org.broadleafcommerce.openadmin.server.security.dao.AdminUserDao;
  56  import org.broadleafcommerce.openadmin.server.security.domain.AdminSection;
  57  import org.broadleafcommerce.openadmin.server.security.domain.AdminUser;
  58  import org.broadleafcommerce.openadmin.server.security.remote.EntityOperationType;
  59  import org.broadleafcommerce.openadmin.server.security.service.RowLevelSecurityService;
  60  import org.broadleafcommerce.openadmin.server.service.persistence.PersistenceResponse;
<abbr title="  61  import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManager;">  61  import org.broadleafcommerce.openadmin.server.service.persistence.extension.AdornedTargetAutoPopulateExtensionManaðŸ”µ</abbr>
  62  import org.broadleafcommerce.openadmin.server.service.persistence.module.BasicPersistenceModule;
  63  import org.broadleafcommerce.openadmin.web.controller.AdminAbstractController;
  64  import org.broadleafcommerce.openadmin.web.controller.modal.ModalHeaderType;
  65  import org.broadleafcommerce.openadmin.web.editor.NonNullBooleanEditor;
  66  import org.broadleafcommerce.openadmin.web.form.component.DefaultListGridActions;
  67  import org.broadleafcommerce.openadmin.web.form.component.ListGrid;
  68  import org.broadleafcommerce.openadmin.web.form.entity.DefaultAdornedEntityFormActions;
  69  import org.broadleafcommerce.openadmin.web.form.entity.DefaultEntityFormActions;
  70  import org.broadleafcommerce.openadmin.web.form.entity.DefaultMainActions;
  71  import org.broadleafcommerce.openadmin.web.form.entity.EntityForm;
  72  import org.broadleafcommerce.openadmin.web.form.entity.EntityFormAction;
  73  import org.broadleafcommerce.openadmin.web.form.entity.Field;
  74  import org.broadleafcommerce.openadmin.web.form.entity.FieldGroup;
  75  import org.springframework.beans.propertyeditors.StringTrimmerEditor;
  76  import org.springframework.stereotype.Controller;
  77  import org.springframework.ui.Model;
  78  import org.springframework.util.MultiValueMap;
  79  import org.springframework.validation.BindingResult;
  80  import org.springframework.web.bind.WebDataBinder;
  81  import org.springframework.web.bind.annotation.InitBinder;
  82  import org.springframework.web.bind.annotation.ModelAttribute;
  83  import org.springframework.web.bind.annotation.PathVariable;
  84  import org.springframework.web.bind.annotation.RequestMapping;
  85  import org.springframework.web.bind.annotation.RequestMethod;
  86  import org.springframework.web.bind.annotation.RequestParam;
  87  import org.springframework.web.bind.annotation.ResponseBody;
  88  import org.springframework.web.servlet.DispatcherServlet;
  89  import org.springframework.web.servlet.FlashMap;
  90  import org.springframework.web.servlet.mvc.support.RedirectAttributes;
  91  import org.springframework.web.util.UrlPathHelper;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  92 +</span>
  93  import com.fasterxml.jackson.databind.ObjectMapper;
  94  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  95 +import java.io.Serializable;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +import java.io.UnsupportedEncodingException;</span>
  97  import java.net.URLDecoder;
  98  import java.util.ArrayList;

  99  import java.util.HashMap;
 100  import java.util.List;
 101  import java.util.Map;
 102  import java.util.Map.Entry;
 103  import java.util.Set;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 104 +</span>

 105  import javax.annotation.Resource;
 106  import javax.servlet.http.HttpServletRequest;
 107  import javax.servlet.http.HttpServletResponse;
 108  
 109  /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 110 - * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call to super"> 110 - * The default implementation of the {@link #BroadleafAdminAbstractEntityController}. This delegates every call toðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 111 - * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entity"> 111 - * and does not provide any custom-tailored functionality. It is responsible for rendering the admin for every entðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 - * that is not explicitly customized by its own controller.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 113 + * The default implementation of the {@link AdminAbstractController}. This delegates every call to</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 114 + * super and does not provide any custom-tailored functionality. It is responsible for rendering the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 115 + * admin for every entity that is not explicitly customized by its own controller.</span>
 116   *
 117   * @author Andre Azzolini (apazzolini)
 118   * @author Jeff Fischer
 119   */
 120  @Controller(&quot;blAdminBasicEntityController&quot;)
 121  @RequestMapping(&quot;/{sectionKey:.+}&quot;)
 122  public class AdminBasicEntityController extends AdminAbstractController {
 123  
 124      protected static final Log LOG = LogFactory.getLog(AdminBasicEntityController.class);
 125  
 126      public static final String ALTERNATE_ID_PROPERTY = &quot;ALTERNATE_ID&quot;;
 127      public static final String CUSTOM_CRITERIA = &quot;criteria&quot;;
 128      public static final String IS_SELECTIZE_REQUEST = &quot;isSelectizeRequest&quot;;
 129  
 130      @Resource(name=&quot;blSandBoxHelper&quot;)
 131      protected SandBoxHelper sandBoxHelper;
 132  
 133      @Resource(name = &quot;blAdminUserDao&quot;)
 134      protected AdminUserDao adminUserDao;
 135  
 136      @Resource(name=&quot;blDynamicEntityDao&quot;)
 137      protected DynamicEntityDao dynamicEntityDao;
 138  
 139      @Resource(name = &quot;blAdornedTargetAutoPopulateExtensionManager&quot;)
 140      protected AdornedTargetAutoPopulateExtensionManager adornedTargetAutoPopulateExtensionManager;
 141  
 142      @Resource(name = &quot;blRowLevelSecurityService&quot;)
 143      protected RowLevelSecurityService rowLevelSecurityService;
 144  
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +    @Resource(name = &quot;blEntityDuplicator&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +    protected EntityDuplicator duplicator;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +    @Resource(name = &quot;blGenericEntityService&quot;)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +    protected GenericEntityService genericEntityService;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +</span>
 151      // ******************************************
 152      // REQUEST-MAPPING BOUND CONTROLLER METHODS *
 153      // ******************************************
 154  
 155      /**
<abbr title=" 156       * Renders the main entity listing for the specified class, which is based on the current sectionKey with some optional"> 156       * Renders the main entity listing for the specified class, which is based on the current sectionKey with someðŸ”µ</abbr>
 157       * criteria.
 158       *
 159       * @param request
 160       * @param response
 161       * @param model
 162       * @param pathVars
 163       * @param requestParams a Map of property name -&gt; list critiera values
 164       * @return the return view path
 165       * @throws Exception
 166       */
 167      @RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
 168      public String viewEntityList(HttpServletRequest request, HttpServletResponse response, Model model,
 169              @PathVariable Map&lt;String, String&gt; pathVars,
 170              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 171          String sectionKey = getSectionKey(pathVars);
 172          String sectionClassName = getClassNameForSection(sectionKey);
 173          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 174          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars);"> 174          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbðŸ”µ</abbr>
 175          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 176          DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 177  
 178          ListGrid listGrid = formService.buildMainListGrid(drs, cmd, sectionKey, crumbs);
 179          listGrid.setSelectType(ListGrid.SelectType.NONE);
 180  
 181          Set&lt;Field&gt; headerFields = listGrid.getHeaderFields();
 182          if (CollectionUtils.isNotEmpty(headerFields)) {
 183              Field firstField = headerFields.iterator().next();
 184              if (requestParams.containsKey(firstField.getName())) {
 185                  model.addAttribute(&quot;mainSearchTerm&quot;, requestParams.get(firstField.getName()).get(0));
 186              }
 187          }
 188  
 189          model.addAttribute(&quot;viewType&quot;, &quot;entityList&quot;);
 190  
 191          setupViewEntityListBasicModel(request, cmd, sectionKey, sectionClassName, model, requestParams);
 192          model.addAttribute(&quot;listGrid&quot;, listGrid);
 193  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 194 -        return &quot;modules/defaultContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 195 +        return DEFAULT_CONTAINER_VIEW;</span>
 196      }
 197  
 198      protected void setupViewEntityListBasicModel(HttpServletRequest request, ClassMetadata cmd, String sectionKey,
 199              String sectionClassName, Model model, MultiValueMap&lt;String, String&gt; requestParams) {
 200          List&lt;EntityFormAction&gt; mainActions = new ArrayList&lt;&gt;();
 201          addAddActionIfAllowed(sectionClassName, cmd, mainActions);
 202          extensionManager.getProxy().addAdditionalMainActions(sectionClassName, mainActions);
 203          extensionManager.getProxy().modifyMainActions(cmd, mainActions);
 204  
 205          // If this came from a delete save, we&#x27;ll have a headerFlash request parameter to take care of
 206          if (requestParams.containsKey(&quot;headerFlash&quot;)) {
 207              model.addAttribute(&quot;headerFlash&quot;, requestParams.get(&quot;headerFlash&quot;).get(0));
 208          }
 209  
 210          List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());
 211          String requestUri = request.getRequestURI();
 212          if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {
 213              requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());
 214          }
 215  
 216          model.addAttribute(&quot;isFilter&quot;, (requestParams.size() &gt; 0));
 217          model.addAttribute(&quot;currentUri&quot;, requestUri);
 218          model.addAttribute(&quot;entityTypes&quot;, entityTypes);
 219          model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 220          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 221          model.addAttribute(&quot;mainActions&quot;, mainActions);
 222          setModelAttributes(model, sectionKey);
 223          setTypedEntityModelAttributes(request, model);
 224      }
 225  
 226      @RequestMapping(value = &quot;/selectize&quot;, method = RequestMethod.GET)
 227      public @ResponseBody Map&lt;String, Object&gt; viewEntityListSelectize(HttpServletRequest request,
 228               HttpServletResponse response, Model model,
 229               @PathVariable Map&lt;String, String&gt; pathVars,
 230               @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 231          String sectionKey = getSectionKey(pathVars);
 232          String sectionClassName = getClassNameForSection(sectionKey);
 233          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, null, null);
<abbr title=" 234          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbs, pathVars)"> 234          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, crumbðŸ”µ</abbr>
 235                  .withCustomCriteria(getCustomCriteria(requestParams));
 236  
 237          ppr.addCustomCriteria(buildSelectizeCustomCriteria());
 238  
 239          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 240          DynamicResultSet drs =  service.getRecords(ppr).getDynamicResultSet();
 241  
 242          return formService.constructSelectizeOptionMap(drs, cmd);
 243      }
 244  
 245      /**
 246       * Obtains the requested criteria parameter
 247       *
 248       * @param requestParams
 249       * @return
 250       */
 251      protected String[] getCustomCriteria(Map&lt;String, List&lt;String&gt;&gt; requestParams) {
 252          if (requestParams == null || requestParams.isEmpty()) {
 253              return null;
 254          }
 255  
 256          List&lt;String&gt; criteria = requestParams.get(CUSTOM_CRITERIA);
 257          String response = CollectionUtils.isEmpty(criteria) ? null : criteria.get(0);
 258          return new String[] {response};
 259      }
 260  
 261      /**
 262       * Adds the &quot;Add&quot; button to the main entity form if the current user has permissions to create new instances
 263       * of the entity and all of the fields in the entity aren&#x27;t marked as read only.
 264       *
 265       * @param sectionClassName
 266       * @param cmd
 267       * @param mainActions
 268       */
<abbr title=" 269      protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainActions) {"> 269      protected void addAddActionIfAllowed(String sectionClassName, ClassMetadata cmd, List&lt;EntityFormAction&gt; mainAcðŸ”µ</abbr>
 270          if (isAddActionAllowed(sectionClassName, cmd)) {
 271              mainActions.add(DefaultMainActions.ADD);
 272          }
 273      }
 274  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 275 -    protected boolean isAddActionAllowed(String sectionClassName, ClassMetadata cmd) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 276 +    protected boolean isAddActionAllowed(final String sectionClassName, final ClassMetadata cmd) {</span>
 277          // If the user does not have create permissions, we will not add the &quot;Add New&quot; button
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 278 -        boolean canCreate = true;</span>
 279          try {
 280              adminRemoteSecurityService.securityCheck(sectionClassName, EntityOperationType.ADD);
 281          } catch (ServiceException e) {
 282              if (e instanceof SecurityServiceException) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 283 -                canCreate = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 284 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 285 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 286 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 287 -        if (canCreate) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 288 -            checkReadOnly: {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 289 -                //check if all the metadata is read only</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 290 -                for (Property property : cmd.getProperties()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 291 -                    if (property.getMetadata() instanceof BasicFieldMetadata) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 292 -                        if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 293 -                                !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 294 -                            break checkReadOnly;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 295 -                        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 296 -                    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 297 +                return false;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 298 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 299 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 300 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 301 +        final boolean canAdd = rowLevelSecurityService</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 302 +                .canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 303 +        return isNotReadOnly(cmd) &amp;&amp; canAdd;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 304 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 305 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 306 +    protected boolean isNotReadOnly(final ClassMetadata cmd) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 307 +        //check if all the metadata is read only</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 308 +        for (Property property : cmd.getProperties()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 309 +            if (property.getMetadata() instanceof BasicFieldMetadata) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 310 +                if (((BasicFieldMetadata) property.getMetadata()).getReadOnly() == null ||</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 311 +                        !((BasicFieldMetadata) property.getMetadata()).getReadOnly()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 312 +                    return true;</span>
 313                  }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 314 -                canCreate = false;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 315 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 316 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 317 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 318 -        if (canCreate) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 319 -            canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectionClassName, cmd);"> 319 -            canCreate = rowLevelSecurityService.canAdd(adminRemoteSecurityService.getPersistentAdminUser(), sectioðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 320 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 321 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 322 -        return canCreate;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 323 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 324 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 325 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 326 +        return false;</span>
 327      }
 328  
 329      /**
 330       * Renders the modal form that is used to add a new parent level entity. Note that this form cannot render any
<abbr title=" 331       * subcollections as operations on those collections require the parent level entity to first be saved and have"> 331       * subcollections as operations on those collections require the parent level entity to first be saved and havðŸ”µ</abbr>
<abbr title=" 332       * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen where"> 332       * and id. Once the entity is initially saved, we will redirect the user to the normal manage entity screen whðŸ”µ</abbr>
 333       * they can then perform operations on sub collections.
 334       *
 335       * @param request
 336       * @param response
 337       * @param model
 338       * @param pathVars
 339       * @param entityType
 340       * @return the return view path
 341       * @throws Exception
 342       */
 343      @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.GET)
 344      public String viewAddEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 345              @PathVariable  Map&lt;String, String&gt; pathVars,
 346              @RequestParam(defaultValue = &quot;&quot;) String entityType) throws Exception {
 347          String sectionKey = getSectionKey(pathVars);
 348          String sectionClassName = getClassNameForSection(sectionKey);
 349          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 350          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 350          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 351          ppr.setAddOperationInspect(true);
 352          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 353  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 354 -        // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for this entity."> 354 -        // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types for thiðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 355 +        entityType = determineEntityType(entityType, cmd);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 356 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 357 +        EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 358 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 359 +        // We need to make sure that the ceiling entity is set to the interface and the specific entity type</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 360 +        // is set to the type we&#x27;re going to be creating.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 361 +        entityForm.setCeilingEntityClassname(cmd.getCeilingType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 362 +        entityForm.setEntityType(entityType);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 363 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 364 +        // When we initially build the class metadata (and thus, the entity form), we had all of the possible</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 365 +        // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 366 +        // fields that are not applicable for this given entity type.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 367 +        formService.removeNonApplicableFields(cmd, entityForm, entityType);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 368 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 369 +        modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 370 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 371 +        model.addAttribute(&quot;entityForm&quot;, entityForm);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 372 +        model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 373 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 374 +        model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 375 +        model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 376 +        model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 377 +        setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 378 +        return MODAL_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 379 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 380 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 381 +    // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 382 +    // types for this entity.</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 383 +    protected String determineEntityType(String entityType, final ClassMetadata cmd)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 384 +            throws UnsupportedEncodingException {</span>
 385          if (StringUtils.isBlank(entityType)) {
 386              if (cmd.getPolymorphicEntities().getChildren().length == 0) {
 387                  entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();
 388              } else {
 389                  entityType = getDefaultEntityType();
 390              }
 391          } else {
 392              entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);
 393          }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 394 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 395 -        EntityForm entityForm = formService.createEntityForm(cmd, sectionCrumbs);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 396 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 397 -        // We need to make sure that the ceiling entity is set to the interface and the specific entity type</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 398 -        // is set to the type we&#x27;re going to be creating.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 399 -        entityForm.setCeilingEntityClassname(cmd.getCeilingType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 400 -        entityForm.setEntityType(entityType);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 401 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 402 -        // When we initially build the class metadata (and thus, the entity form), we had all of the possible</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 403 -        // polymorphic fields built out. Now that we have a concrete entity type to render, we can remove the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 404 -        // fields that are not applicable for this given entity type.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 405 -        formService.removeNonApplicableFields(cmd, entityForm, entityType);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 406 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 407 -        modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 408 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 409 -        model.addAttribute(&quot;entityForm&quot;, entityForm);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 410 -        model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 411 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 412 -        model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 413 -        model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 414 -        model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 415 -        setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 416 -        return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 417 +        return entityType;</span>
 418      }
 419  
 420      /**
 421       * Processes the request to add a new entity. If successful, returns a redirect to the newly created entity.
 422       *
 423       * @param request
 424       * @param response
 425       * @param model
 426       * @param pathVars
 427       * @param entityForm
 428       * @param result
 429       * @return the return view path
 430       * @throws Exception
 431       */
 432      @RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)
 433      public String addEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 434              @PathVariable  Map&lt;String, String&gt; pathVars,
 435              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
 436          String sectionKey = getSectionKey(pathVars);
 437          String sectionClassName = getClassNameForSection(sectionKey);
 438          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 439          ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 439          ClassMetadata cmd = service.getClassMetadata(getSectionPersistencePackageRequest(sectionClassName, sectionðŸ”µ</abbr>
 440  
 441          extractDynamicFormFields(cmd, entityForm);
<abbr title=" 442          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 442          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 443          Entity entity = service.addEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 444          entityFormValidator.validate(entityForm, entity, result);
 445  
 446          if (result.hasErrors()) {
 447              entityForm.clearFieldsMap();
 448              formService.populateEntityForm(cmd, entity, entityForm, sectionCrumbs);
 449  
 450              formService.removeNonApplicableFields(cmd, entityForm, entityForm.getEntityType());
 451  
 452              modifyAddEntityForm(entityForm, pathVars);
 453  
 454              model.addAttribute(&quot;viewType&quot;, &quot;modal/entityAdd&quot;);
 455              model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 456              model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());
 457              model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());
 458              setModelAttributes(model, sectionKey);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 459 -            return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 460 +            return MODAL_CONTAINER_VIEW;</span>
 461          }
 462  
 463          // Note that AJAX Redirects need the context path prepended to them
<abbr title=" 464          return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue();"> 464          return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + entity.getPMap().get(&quot;id&quot;).getValue(ðŸ”µ</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 465 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 466 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 467 +    @RequestMapping(value = &quot;/{id}/duplicate&quot;, method = RequestMethod.POST)</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 468 +    public String duplicateEntity(final HttpServletRequest request,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 469 +            final HttpServletResponse response,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 470 +            final Model model,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 471 +            @PathVariable final Map&lt;String, String&gt; pathVars,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 472 +            @PathVariable(value = &quot;id&quot;) final String id,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 473 +            @ModelAttribute(value = &quot;entityForm&quot;) final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 474 +            final BindingResult result) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 475 +        final String sectionKey = getSectionKey(pathVars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 476 +        final String sectionClassName = getClassNameForSection(sectionKey);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 477 +        final Class&lt;?&gt; entityClass = dynamicEntityDao.getImplClass(sectionClassName);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 478 +        final long identifier = Long.parseLong(id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 479 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 480 +        if (duplicator.validate(entityClass, identifier)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 481 +            final Object duplicate;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 482 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 483 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 484 +                duplicate = duplicator.copy(entityClass, identifier);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 485 +            } catch (Exception e) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 486 +                LOG.error(&quot;Could not duplicate entity&quot;, e);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 487 +                return getErrorDuplicatingResponse(response, &quot;Duplication_Failure&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 488 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 489 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 490 +            final Serializable dupId = genericEntityService.getIdentifier(duplicate);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 491 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 492 +            // Note that AJAX Redirects need the context path prepended to them</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 493 +            return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;/&quot; + dupId;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 494 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 495 +            return getErrorDuplicatingResponse(response, &quot;Validation_Failure&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 496 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 497 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 498 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 499 +    protected String getErrorDuplicatingResponse(HttpServletResponse response, String code) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 500 +        List&lt;Map&lt;String, Object&gt;&gt; errors = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 501 +        String message;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 502 +        BroadleafRequestContext context = BroadleafRequestContext.getBroadleafRequestContext();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 503 +        if (context != null &amp;&amp; context.getMessageSource() != null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 504 +            message = context.getMessageSource()</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 505 +                    .getMessage(code, null, code, context.getJavaLocale());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 506 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 507 +            LOG.warn(</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 508 +                    &quot;Could not find the MessageSource on the current request, &quot;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 509 +                            + &quot;not translating the message key&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 510 +            message = &quot;Duplication_Failure&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 511 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 512 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 513 +        Map&lt;String, Object&gt; errorMap = new HashMap&lt;&gt;();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 514 +        errorMap.put(&quot;errorType&quot;, &quot;global&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 515 +        errorMap.put(&quot;code&quot;, code);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 516 +        errorMap.put(&quot;message&quot;, message);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 517 +        errors.add(errorMap);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 518 +        return new JsonResponse(response).with(&quot;errors&quot;, errors).done();</span>
 519      }
 520  
 521      /**
 522       * Renders the main entity form for the specified entity
 523       *
 524       * @param request
 525       * @param response
 526       * @param model
 527       * @param pathVars
 528       * @param id
 529       * @return the return view path
 530       * @throws Exception
 531       */
 532      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.GET)
 533      public String viewEntityForm(HttpServletRequest request, HttpServletResponse response, Model model,
 534              @PathVariable  Map&lt;String, String&gt; pathVars,
 535              @PathVariable(&quot;id&quot;) String id) throws Exception {
 536          String sectionKey = getSectionKey(pathVars);
 537          String sectionClassName = getClassNameForSection(sectionKey);
 538          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
 539          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);
 540  
 541          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 542          Entity entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 543  
 544          Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);
 545  
 546          EntityForm entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 547  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 548 -        if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 549 -            modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 550 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 551 -            modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 552 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 553 +        modifyEntityForm(entity, entityForm, pathVars);</span>
 554  
 555          if (request.getParameter(&quot;headerFlash&quot;) != null) {
 556              model.addAttribute(&quot;headerFlash&quot;, request.getParameter(&quot;headerFlash&quot;));
 557          }
 558  
 559          // Set the sectionKey again incase this is a typed entity
 560          entityForm.setSectionKey(sectionKey);
 561  
 562          // Build the current url in the cast that this is a typed entity
 563          String originatingUri = new UrlPathHelper().getOriginatingRequestUri(request);
 564          int startIndex = request.getContextPath().length();
 565  
 566          // Remove the context path from servlet path
 567          String currentUrl = originatingUri.substring(startIndex);
 568  
 569          model.addAttribute(&quot;entity&quot;, entity);
 570          model.addAttribute(&quot;entityForm&quot;, entityForm);
 571          model.addAttribute(&quot;currentUrl&quot;, currentUrl);
 572  
 573          setModelAttributes(model, sectionKey);
 574  
 575          // We want to replace author ids with their names
 576          addAuditableDisplayFields(entityForm);
 577  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 578 -        if (isAjaxRequest(request)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 579 -            entityForm.setReadOnly();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 580 -            model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 581 -            model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 582 -            return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 583 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 584 -            model.addAttribute(&quot;useAjaxUpdate&quot;, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 585 -            model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 586 -            return &quot;modules/defaultContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 587 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 588 +        return resolveAppropriateEntityView(request, model, entityForm);</span>
 589      }
 590  
<abbr title=" 591      protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathVars,"> 591      protected Map&lt;String, DynamicResultSet&gt; getViewSubRecords(HttpServletRequest request, Map&lt;String, String&gt; pathðŸ”µ</abbr>
 592                                                                ClassMetadata cmd, Entity entity,
 593                                                                List&lt;SectionCrumb&gt; crumbs) throws Exception {
 594          String tabName = pathVars.get(&quot;tabName&quot;);
 595          if (StringUtils.isEmpty(tabName)) {
 596              tabName = cmd.getFirstTab() == null ? &quot;General&quot; : cmd.getFirstTab().getTabName();
 597          }
 598          return service.getRecordsForSelectedTab(cmd, entity, crumbs, tabName);
 599      }
 600  
 601      private boolean isAddRequest(Entity entity) {
 602          ExtensionResultHolder&lt;Boolean&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
 603          ExtensionResultStatusType result = extensionManager.getProxy().isAddRequest(entity, resultHolder);
 604          if (result.equals(ExtensionResultStatusType.NOT_HANDLED)) {
 605              return false;
 606          }
 607  
 608          return resultHolder.getResult();
 609      }
 610  
 611      /**
 612       * Attempts to get the List Grid for the selected tab.
 613       *
 614       * @param request
 615       * @param response
 616       * @param model
 617       * @param pathVars
 618       * @param id
 619       * @param tabName
 620       * @param entityForm
 621       * @param entity
 622       * @return the return view path
 623       * @throws Exception
 624       */
 625      @RequestMapping(value = &quot;/{id}/{tab:[0-9]+}/{tabName}&quot;, method = RequestMethod.POST)
 626      public String viewEntityTab(HttpServletRequest request, HttpServletResponse response, Model model,
 627              @PathVariable Map&lt;String, String&gt; pathVars,
 628              @PathVariable(value = &quot;id&quot;) String id,
 629              @PathVariable(value = &quot;tabName&quot;) String tabName,
 630              @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm,
 631              @ModelAttribute(value = &quot;entity&quot;) Entity entity) throws Exception {
 632          String sectionKey = getSectionKey(pathVars);
 633          String sectionClassName = getClassNameForSection(sectionKey);
 634          List&lt;SectionCrumb&gt; crumbs = getSectionCrumbs(request, sectionKey, id);
 635          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, crumbs, pathVars);
 636          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 637          entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 638          Map&lt;String, DynamicResultSet&gt; subRecordsMap = getViewSubRecords(request, pathVars, cmd, entity, crumbs);
 639          entityForm = formService.createEntityForm(cmd, entity, subRecordsMap, crumbs);
 640  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 641 -        if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 642 -            modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 643 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 644 -            modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 645 -        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 646 +        modifyEntityForm(entity, entityForm, pathVars);</span>
 647  
 648          model.addAttribute(&quot;entity&quot;, entity);
 649          model.addAttribute(&quot;entityForm&quot;, entityForm);
 650          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 651  
 652          setModelAttributes(model, sectionKey);
 653  
 654          model.addAttribute(&quot;useAjaxUpdate&quot;, true);
 655          model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 656 -        return &quot;modules/defaultContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 657 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 658 +        return DEFAULT_CONTAINER_VIEW;</span>
 659      }
 660  
 661      /**
 662       * Builds JSON that looks like this:
 663       *
 664       * {&quot;errors&quot;:
 665       *      [{&quot;message&quot;:&quot;This field is Required&quot;,
 666       *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 667       *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 668       *        &quot;errorType&quot;, &quot;field&quot;,
 669       *        &quot;tab&quot;: &quot;General&quot;
 670       *        },
 671       *        {&quot;message&quot;:&quot;This field is Required&quot;,
 672       *        &quot;code&quot;: &quot;requiredValidationFailure&quot;
 673       *        &quot;field&quot;:&quot;defaultSku--name&quot;,
 674       *        &quot;errorType&quot;, &quot;field&quot;,
 675       *        &quot;tab&quot;: &quot;General&quot;
 676       *        }]
 677       * }
 678       *
 679       */
 680      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
 681      public String saveEntityJson(HttpServletRequest request, HttpServletResponse response, Model model,
 682              @PathVariable Map&lt;String, String&gt; pathVars,
 683              @PathVariable(value = &quot;id&quot;) String id,
 684              @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 685              RedirectAttributes ra) throws Exception {
 686  
 687          saveEntity(request, response, model, pathVars, id, entityForm, result, ra);
 688  
 689          JsonResponse json = new JsonResponse(response);
 690          if (result.hasErrors()) {
 691              populateJsonValidationErrors(entityForm, result, json);
 692          }
 693          List&lt;String&gt; dirtyList = buildDirtyList(pathVars, request, id);
 694          if (CollectionUtils.isNotEmpty(dirtyList)) {
 695              json.with(&quot;dirty&quot;, dirtyList);
 696          }
 697  
 698          ExtensionResultHolder&lt;String&gt; resultHolder = new ExtensionResultHolder&lt;&gt;();
<abbr title=" 699          ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(response, result.hasErrors(), getSectionKey(pathVars), id, resultHolder);"> 699          ExtensionResultStatusType resultStatusType = extensionManager.getProxy().overrideSaveEntityJsonResponse(reðŸ”µ</abbr>
 700          if (resultStatusType.equals(ExtensionResultStatusType.HANDLED)) {
 701              return resultHolder.getResult();
 702          }
 703  
 704          return json.done();
 705      }
 706  
<abbr title=" 707      public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throws ServiceException {"> 707      public List&lt;String&gt; buildDirtyList(Map&lt;String, String&gt; pathVars, HttpServletRequest request, String id) throwsðŸ”µ</abbr>
 708          List&lt;String&gt; dirtyList = new ArrayList&lt;&gt;();
 709          String sectionKey = getSectionKey(pathVars);
 710          String sectionClassName = getClassNameForSection(sectionKey);
 711          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 712          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 712          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 713          ClassMetadata cmd = null;
 714          Entity entity = null;
 715          cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 716          entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
 717  
 718          for (Property p: entity.getProperties()) {
 719              if (p.getIsDirty()) {
 720                  dirtyList.add(p.getName());
 721              }
 722          }
 723          return dirtyList;
 724      }
 725  
 726      /**
 727       * Attempts to save the given entity. If validation is unsuccessful, it will re-render the entity form with
 728       * error fields highlighted. On a successful save, it will refresh the entity page.
 729       *
 730       * @param request
 731       * @param response
 732       * @param model
 733       * @param pathVars
 734       * @param id
 735       * @param entityForm
 736       * @param result
 737       * @return the return view path
 738       * @throws Exception
 739       */
 740      @RequestMapping(value = &quot;/{id}&quot;, method = RequestMethod.POST)
 741      public String saveEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 742              @PathVariable  Map&lt;String, String&gt; pathVars,
 743              @PathVariable(value=&quot;id&quot;) String id,
 744              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 745              RedirectAttributes ra) throws Exception {
 746          String sectionKey = getSectionKey(pathVars);
 747          String sectionClassName = getClassNameForSection(sectionKey);
 748          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 749          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 749          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVðŸ”µ</abbr>
 750          ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 751  
 752          extractDynamicFormFields(cmd, entityForm);
 753  
<abbr title=" 754          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 754          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 755          Entity entity = service.updateEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 756  
 757          entityFormValidator.validate(entityForm, entity, result);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 758 +</span>
 759          if (result.hasErrors()) {
 760              model.addAttribute(&quot;headerFlash&quot;, &quot;save.unsuccessful&quot;);
 761              model.addAttribute(&quot;headerFlashAlert&quot;, true);
 762  
<abbr title=" 763              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 763              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectðŸ”µ</abbr>
 764              entityForm.clearFieldsMap();
 765              formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 766  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 767 -            if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 768 -                modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 769 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 770 -                modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 771 -            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 772 +            modifyEntityForm(entity, entityForm, pathVars);</span>
 773  
 774              model.addAttribute(&quot;entity&quot;, entity);
 775              model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
 776  
 777              setModelAttributes(model, sectionKey);
 778  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 779 -            if (isAjaxRequest(request)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 780 -                entityForm.setReadOnly();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 781 -                model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 782 -                model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 783 -                return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 784 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 785 -                model.addAttribute(&quot;useAjaxUpdate&quot;, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 786 -                model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 787 -                return &quot;modules/defaultContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 788 -            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 789 +            return resolveAppropriateEntityView(request, model, entityForm);</span>
 790          }
 791  
 792          ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;save.successful&quot;);
 793  
 794          return &quot;redirect:/&quot; + sectionKey + &quot;/&quot; + id;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 795 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 796 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 797 +    protected void modifyEntityForm(final Entity entity, final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 798 +            final Map&lt;String, String&gt; pathVars) throws Exception {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 799 +        if (isAddRequest(entity)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 800 +            modifyAddEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 801 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 802 +            modifyEntityForm(entityForm, pathVars);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 803 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 804 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 805 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 806 +    protected String resolveAppropriateEntityView(final HttpServletRequest request,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 807 +            final Model model,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 808 +            final @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 809 +        if (isAjaxRequest(request)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 810 +            entityForm.setReadOnly();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 811 +            model.addAttribute(&quot;viewType&quot;, &quot;modal/entityView&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 812 +            model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.VIEW_ENTITY.getType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 813 +            return MODAL_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 814 +        } else {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 815 +            model.addAttribute(&quot;useAjaxUpdate&quot;, true);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 816 +            model.addAttribute(&quot;viewType&quot;, &quot;entityEdit&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 817 +            return DEFAULT_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 818 +        }</span>
 819      }
 820  
 821      /**
 822       * Attempts to remove the given entity.
 823       *
 824       * @param request
 825       * @param response
 826       * @param model
 827       * @param pathVars
 828       * @param id
 829       * @return the return view path
 830       * @throws Exception
 831       */
 832      @RequestMapping(value = &quot;/{id}/delete&quot;, method = RequestMethod.POST)
 833      public String removeEntity(HttpServletRequest request, HttpServletResponse response, Model model,
 834              @PathVariable  Map&lt;String, String&gt; pathVars,
 835              @PathVariable(value=&quot;id&quot;) String id,
 836              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result,
 837              RedirectAttributes ra) throws Exception {
 838          String sectionKey = getSectionKey(pathVars);
 839          String sectionClassName = getClassNameForSection(sectionKey);
 840          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
 841  
<abbr title=" 842          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCustomCriteria());"> 842          String[] sectionCriteria = customCriteriaService.mergeSectionCustomCriteria(sectionClassName, getSectionCuðŸ”µ</abbr>
 843          Entity entity = service.removeEntity(entityForm, sectionCriteria, sectionCrumbs).getEntity();
 844          // Removal does not normally return an Entity unless there is some validation error
 845          if (entity != null) {
 846              entityFormValidator.validate(entityForm, entity, result);
 847              if (result.hasErrors()) {
 848                  // Create a flash attribute for the unsuccessful delete
 849                  FlashMap fm = new FlashMap();
 850                  fm.put(&quot;headerFlash&quot;, &quot;delete.unsuccessful&quot;);
 851                  fm.put(&quot;headerFlashAlert&quot;, true);
 852                  request.setAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE, fm);
 853  
 854                  // Re-look back up the entity so that we can return something populated
<abbr title=" 855                  PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbs, pathVars);"> 855                  PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, sectionCrumbðŸ”µ</abbr>
 856                  ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 857                  entity = service.getRecord(ppr, id, cmd, false).getDynamicResultSet().getRecords()[0];
<abbr title=" 858                  Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, sectionCrumbs);"> 858                  Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForAllSubCollections(ppr, entity, ðŸ”µ</abbr>
 859                  entityForm.clearFieldsMap();
 860                  formService.populateEntityForm(cmd, entity, subRecordsMap, entityForm, sectionCrumbs);
 861                  modifyEntityForm(entityForm, pathVars);
 862  
 863                  return populateJsonValidationErrors(entityForm, result, new JsonResponse(response))
 864                          .done();
 865              }
 866          }
 867  
 868          ra.addFlashAttribute(&quot;headerFlash&quot;, &quot;delete.successful&quot;);
 869          ra.addFlashAttribute(&quot;headerFlashAlert&quot;, true);
 870  
 871          if (isAjaxRequest(request)) {
 872              // redirect attributes won&#x27;t work here since ajaxredirect actually makes a new request
 873              return &quot;ajaxredirect:&quot; + getContextPath(request) + sectionKey + &quot;?headerFlash=delete.successful&quot;;
 874          } else {
 875              return &quot;redirect:/&quot; + sectionKey;
 876          }
 877      }
 878  
 879      @RequestMapping(value = &quot;/{collectionField:.*}/details&quot;, method = RequestMethod.GET)
<abbr title=" 880      public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletResponse response, Model model,"> 880      public @ResponseBody Map&lt;String, String&gt; getCollectionValueDetails(HttpServletRequest request, HttpServletRespðŸ”µ</abbr>
 881              @PathVariable  Map&lt;String, String&gt; pathVars,
 882              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 883              @RequestParam String ids,
 884              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 885          String sectionKey = getSectionKey(pathVars);
 886          String sectionClassName = getClassNameForSection(sectionKey);
 887          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, null, null);
<abbr title=" 888          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectionCrumbs, pathVars);"> 888          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(sectionClassName, requestParams, sectiðŸ”µ</abbr>
 889          ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 890          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 891          FieldMetadata md = collectionProperty.getMetadata();
 892  
 893          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
 894          ppr.setStartIndex(getStartIndex(requestParams));
 895          ppr.setMaxIndex(getMaxIndex(requestParams));
 896  
 897          if (md instanceof BasicFieldMetadata) {
 898              String idProp = ((BasicFieldMetadata) md).getForeignKeyProperty();
 899              String displayProp = ((BasicFieldMetadata) md).getForeignKeyDisplayValueProperty();
 900  
 901              List&lt;String&gt; filterValues = BLCArrayUtils.asList(ids.split(FILTER_VALUE_SEPARATOR_REGEX));
 902              ppr.addFilterAndSortCriteria(new FilterAndSortCriteria(idProp, filterValues));
 903  
 904              DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
 905              Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();
 906  
 907              for (Entity e : drs.getRecords()) {
 908                  String id = e.getPMap().get(idProp).getValue();
 909                  String disp = e.getPMap().get(displayProp).getDisplayValue();
 910  
 911                  if (StringUtils.isBlank(disp)) {
 912                      disp = e.getPMap().get(displayProp).getValue();
 913                  }
 914  
 915                  returnMap.put(id,  disp);
 916              }
 917  
 918              return returnMap;
 919          }
 920  
 921          return null;
 922      }
 923  
 924      /**
<abbr title=" 925       * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of products"> 925       * Shows the modal popup for the current selected &quot;to-one&quot; field. For instance, if you are viewing a list of pðŸ”µ</abbr>
 926       * then this method is invoked when a user clicks on the name of the default category field.
 927       *
 928       * @param request
 929       * @param response
 930       * @param model
 931       * @param pathVars
 932       * @param collectionField
 933       * @param id
 934       * @return
 935       * @throws Exception
 936       */
 937      @RequestMapping(value = &quot;/{collectionField:.*}/{id}/view&quot;, method = RequestMethod.GET)
 938      public String viewCollectionItemDetails(HttpServletRequest request, HttpServletResponse response, Model model,
 939              @PathVariable  Map&lt;String, String&gt; pathVars,
 940              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 941              @PathVariable(value=&quot;id&quot;) String id) throws Exception {
 942          String sectionKey = getSectionKey(pathVars);
 943          String mainClassName = getClassNameForSection(sectionKey);
 944          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 945          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();"> 945          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
 946          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 947          BasicFieldMetadata md = (BasicFieldMetadata) collectionProperty.getMetadata();
 948  
<abbr title=" 949          AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(), sectionKey);"> 949          AdminSection section = adminNavigationService.findAdminSectionByClassAndSectionId(md.getForeignKeyClass(),ðŸ”µ</abbr>
<abbr title=" 950          String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrl();"> 950          String sectionUrlKey = (section.getUrl().startsWith(&quot;/&quot;)) ? section.getUrl().substring(1) : section.getUrlðŸ”µ</abbr>
 951          Map&lt;String, String&gt; varsForField = new HashMap&lt;&gt;();
 952          varsForField.put(&quot;sectionKey&quot;, sectionUrlKey);
 953          return viewEntityForm(request, response, model, varsForField, id);
 954      }
 955  
 956      @RequestMapping(
 957              value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{tab:[0-9]+}/{tabName}&quot;,
 958              method = RequestMethod.POST
 959      )
 960      public String viewCollectionItemTab(HttpServletRequest request, HttpServletResponse response, Model model,
 961                                          @PathVariable  Map&lt;String, String&gt; pathVars,
 962                                          @PathVariable(value=&quot;id&quot;) String id,
 963                                          @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 964                                          @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
 965                                          @PathVariable(value=&quot;tabName&quot;) String tabName,
<abbr title=" 966                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws Exception {"> 966                                          @ModelAttribute(value = &quot;entityForm&quot;) EntityForm entityForm) throws ExceptðŸ”µ</abbr>
 967  
<abbr title=" 968          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeaderType.VIEW_COLLECTION_ITEM.getType(), entityForm, null);"> 968          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, ModalHeadðŸ”µ</abbr>
 969      }
 970  
 971  
 972      /**
 973       * Returns the records for a given collectionField filtered by a particular criteria
 974       *
 975       * @param request
 976       * @param response
 977       * @param model
 978       * @param pathVars
 979       * @param collectionField
 980       * @param requestParams
 981       * @return the return view path
 982       * @throws Exception
 983       */
 984      @RequestMapping(value = &quot;/{id}/{collectionField:.*}&quot;, method = RequestMethod.GET)
 985      public String getCollectionFieldRecords(HttpServletRequest request, HttpServletResponse response, Model model,
 986              @PathVariable  Map&lt;String, String&gt; pathVars,
 987              @PathVariable(value=&quot;id&quot;) String id,
 988              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
 989              @RequestParam  MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
 990          String sectionKey = getSectionKey(pathVars);
 991          String mainClassName = getClassNameForSection(sectionKey);
 992          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title=" 993          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCrumbs, pathVars);"> 993          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, requestParams, sectionCðŸ”µ</abbr>
 994          ClassMetadata mainMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
 995          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
 996  
 997          ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);
 998          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
 999  
1000          // Next, we must get the new list grid that represents this collection
<abbr title="1001          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionKey, sectionCrumbs);">1001          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, requestParams, sectionðŸ”µ</abbr>
1002          model.addAttribute(&quot;listGrid&quot;, listGrid);
1003  
1004          model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
1005  
1006          // We return the new list grid so that it can replace the currently visible one
1007          setModelAttributes(model, sectionKey);
1008          return &quot;views/standaloneListGrid&quot;;
1009      }
1010  
1011      /**
<abbr title="1012       * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomes">1012       * Shows the modal dialog that is used to add an item to a given collection. There are several possible outcomðŸ”µ</abbr>
1013       * of this call depending on the type of the specified collection field.
1014       *
1015       * &lt;ul&gt;
1016       *  &lt;li&gt;
<abbr title="1017       *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the user may">1017       *    &lt;b&gt;Basic Collection (Persist)&lt;/b&gt; - Renders a blank form for the specified target entity so that the useðŸ”µ</abbr>
<abbr title="1018       *    enter information and associate the record with this collection. Used by fields such as ProductAttribute.">1018       *    enter information and associate the record with this collection. Used by fields such as ProductAttributeðŸ”µ</abbr>
1019       *  &lt;/li&gt;
1020       *  &lt;li&gt;
<abbr title="1021       *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and select it.">1021       *    &lt;b&gt;Basic Collection (Lookup)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and seðŸ”µ</abbr>
1022       *    Used by fields such as &quot;allParentCategories&quot;.
1023       *  &lt;/li&gt;
1024       *  &lt;li&gt;
<abbr title="1025       *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and">1025       *    &lt;b&gt;Adorned Collection (without form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entitðŸ”µ</abbr>
<abbr title="1026       *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the operation">1026       *    select it. The view rendered by this is identical to basic collection (lookup), but will perform the opeðŸ”µ</abbr>
<abbr title="1027       *    on an adorned field, which may carry extra meta-information about the created relationship, such as order.">1027       *    on an adorned field, which may carry extra meta-information about the created relationship, such as ordeðŸ”µ</abbr>
1028       *  &lt;/li&gt;
1029       *  &lt;li&gt;
<abbr title="1030       *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity and">1030       *    &lt;b&gt;Adorned Collection (with form)&lt;/b&gt; - Renders a list grid that allows the user to click on an entity aðŸ”µ</abbr>
<abbr title="1031       *    select it. Once the user selects the entity, he will be presented with an empty form based on the specified">1031       *    select it. Once the user selects the entity, he will be presented with an empty form based on the specifðŸ”µ</abbr>
<abbr title="1032       *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addition">1032       *    &quot;maintainedAdornedTargetFields&quot; for this field. Used by fields such as &quot;crossSellProducts&quot;, which in addðŸ”µ</abbr>
1033       *    to linking an entity, provide extra fields, such as a promotional message.
1034       *  &lt;/li&gt;
1035       *  &lt;li&gt;
<abbr title="1036       *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This field is">1036       *    &lt;b&gt;Map Collection&lt;/b&gt; - Renders a form for the target entity that has an additional key field. This fielðŸ”µ</abbr>
<abbr title="1037       *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on another">1037       *    populated either from the configured map keys, or as a result of a lookup in the case of a key based on ðŸ”µ</abbr>
1038       *    entity. Used by fields such as the mediaMap on a Sku.
1039       *  &lt;/li&gt;
1040       *
1041       * @param request
1042       * @param response
1043       * @param model
1044       * @param pathVars
1045       * @param id
1046       * @param collectionField
1047       * @param requestParams
1048       * @return the return view path
1049       * @throws Exception
1050       */
1051      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.GET)
1052      public String showAddCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1053              @PathVariable Map&lt;String, String&gt; pathVars,
1054              @PathVariable(value = &quot;id&quot;) String id,
1055              @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1056              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1057          String sectionKey = getSectionKey(pathVars);
1058          String mainClassName = getClassNameForSection(sectionKey);
1059          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1060          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,
1061                  sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1062          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1063          FieldMetadata md = collectionProperty.getMetadata();
1064  
1065          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1066                  .withFilterAndSortCriteria(getCriteria(requestParams))
1067                  .withStartIndex(getStartIndex(requestParams))
1068                  .withMaxIndex(getMaxIndex(requestParams))
1069                  .withLastId(getLastId(requestParams))
1070                  .withFirstId(getFirstId(requestParams))
1071                  .withUpperCount(getUpperCount(requestParams))
1072                  .withLowerCount(getLowerCount(requestParams))
1073                  .withPageSize(getPageSize(requestParams))
1074                  .withPresentationFetch(true);
1075  
1076          if (md instanceof BasicCollectionMetadata) {
1077              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1078              if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
1079                  ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1080                  // If the entity type isn&#x27;t specified, we need to determine if there are various polymorphic types
1081                  // for this entity.
1082                  String entityType = null;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1083 +</span>
1084                  if (requestParams.containsKey(&quot;entityType&quot;)) {
1085                      entityType = requestParams.get(&quot;entityType&quot;).get(0);
1086                  }
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1087 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1088 +                entityType = determineEntityType(entityType, cmd);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1089 +</span>
1090                  if (StringUtils.isBlank(entityType)) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1091 -                    if (cmd.getPolymorphicEntities().getChildren().length == 0) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1092 -                        entityType = cmd.getPolymorphicEntities().getFullyQualifiedClassname();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1093 -                    } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1094 -                        entityType = getDefaultEntityType();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1095 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1096 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1097 -                    entityType = URLDecoder.decode(entityType, &quot;UTF-8&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1098 +                    return getModalForBlankEntityType(request, model, sectionKey, cmd);</span>
1099                  }
1100  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1101 -                if (StringUtils.isBlank(entityType)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1102 -                    List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1103 -                    model.addAttribute(&quot;entityTypes&quot;, entityTypes);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1104 -                    model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1105 -                    model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1106 -                    String requestUri = request.getRequestURI();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1107 -                    if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) {">1107 -                    if (!request.getContextPath().equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(request.getContextPath())) ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1108 -                        requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.length());">1108 -                        requestUri = requestUri.substring(request.getContextPath().length() + 1, requestUri.lengthðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1109 -                    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1110 -                    model.addAttribute(&quot;currentUri&quot;, requestUri);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1111 -                    model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1112 -                    setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1113 -                    return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1114 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1115 -                    ppr = ppr.withCeilingEntityClassname(entityType);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1116 -                }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1117 +                ppr = ppr.withCeilingEntityClassname(entityType);</span>
1118              }
1119          } else if (md instanceof MapMetadata) {
<abbr title="1120              ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(request,response,model,sectionKey,id,requestParams,(MapMetadata) md);">1120              ExtensionResultStatusType result = extensionManager.getProxy().modifyModelForAddCollectionType(requestðŸ”µ</abbr>
1121              if (result.equals(ExtensionResultStatusType.HANDLED)) {
1122                  model.addAttribute(&quot;entityId&quot;, id);
1123                  model.addAttribute(&quot;sectionKey&quot;, sectionKey);
1124                  model.addAttribute(&quot;collectionField&quot;, collectionField);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1125 -                return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1126 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1127 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1128 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1129 -        //service.getContextSpecificRelationshipId(mainMetadata, entity, prefix);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1130 +                return MODAL_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1131 +            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1132 +        }</span>
1133  
1134          model.addAttribute(&quot;currentParams&quot;, new ObjectMapper().writeValueAsString(requestParams));
1135  
<abbr title="1136          return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty, md, ppr, null, null);">1136          return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionPrðŸ”µ</abbr>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1137 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1138 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1139 +    protected String getModalForBlankEntityType(final HttpServletRequest request,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1140 +            final Model model, final String sectionKey, final ClassMetadata cmd) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1141 +        final List&lt;ClassTree&gt; entityTypes = getAddEntityTypes(cmd.getPolymorphicEntities());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1142 +        model.addAttribute(&quot;entityTypes&quot;, entityTypes);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1143 +        model.addAttribute(&quot;viewType&quot;, &quot;modal/entityTypeSelection&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1144 +        model.addAttribute(&quot;entityFriendlyName&quot;, cmd.getPolymorphicEntities().getFriendlyName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1145 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1146 +        String requestUri = request.getRequestURI();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1147 +        final String contextPath = request.getContextPath();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1148 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1149 +        if (!contextPath.equals(&quot;/&quot;) &amp;&amp; requestUri.startsWith(contextPath)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1150 +            requestUri = requestUri.substring(contextPath.length() + 1, requestUri.length());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1151 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1152 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1153 +        model.addAttribute(&quot;currentUri&quot;, requestUri);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1154 +        model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_ENTITY.getType());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1155 +        setModelAttributes(model, sectionKey);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1156 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1157 +        return MODAL_CONTAINER_VIEW;</span>
1158      }
1159  
<abbr title="1160      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POST)">1160      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add/{collectionItemId}/verify&quot;, method = RequestMethod.POSðŸ”µ</abbr>
<abbr title="1161      public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1161      public @ResponseBody Map&lt;String, Object&gt; addCollectionItem(HttpServletRequest request, HttpServletResponse resðŸ”µ</abbr>
1162              @PathVariable Map&lt;String, String&gt; pathVars,
1163              @PathVariable(value=&quot;id&quot;) String id,
1164              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1165              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1166          String sectionKey = getSectionKey(pathVars);
1167          String mainClassName = getClassNameForSection(sectionKey);
1168          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1169          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1169          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1170          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1171          FieldMetadata md = collectionProperty.getMetadata();
1172          Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
1173          if (md instanceof AdornedTargetCollectionMetadata) {
<abbr title="1174              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1174              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassNaðŸ”µ</abbr>
1175                      collectionField,
1176                      collectionItemId, responseMap);
1177          }
1178          return responseMap;
1179      }
1180  
1181      /**
1182       *
1183       * @param request
1184       * @param response
1185       * @param model
1186       * @param pathVars
1187       * @param id
1188       * @param collectionField
1189       * @param requestParams
1190       * @return Json collection data
1191       * @throws Exception
1192       */
1193      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize&quot;, method = RequestMethod.GET)
<abbr title="1194      public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletResponse response, Model model,">1194      public @ResponseBody Map&lt;String, Object&gt; getSelectizeCollectionOptions(HttpServletRequest request, HttpServletðŸ”µ</abbr>
1195              @PathVariable Map&lt;String, String&gt; pathVars,
1196              @PathVariable(value = &quot;id&quot;) String id,
1197              @PathVariable(value = &quot;collectionField&quot;) String collectionField,
1198              @RequestParam MultiValueMap&lt;String, String&gt; requestParams) throws Exception {
1199          String sectionKey = getSectionKey(pathVars);
1200          String mainClassName = getClassNameForSection(sectionKey);
1201          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1202          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName,
1203                  sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();
1204          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1205          FieldMetadata md = collectionProperty.getMetadata();
1206  
1207          PersistencePackageRequest ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs)
1208                  .withFilterAndSortCriteria(getCriteria(requestParams))
1209                  .withStartIndex(getStartIndex(requestParams))
1210                  .withMaxIndex(getMaxIndex(requestParams))
1211                  .withCustomCriteria(buildSelectizeCustomCriteria());




1212  
1213          if (md instanceof AdornedTargetCollectionMetadata) {
1214              ppr.setOperationTypesOverride(null);
1215              ppr.setType(PersistencePackageRequest.Type.STANDARD);
1216              ppr.setSectionEntityField(collectionField);
1217          }
1218  
1219          DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
1220  
1221          return formService.buildSelectizeCollectionInfo(id, drs, collectionProperty, sectionKey, sectionCrumbs);
1222      }
1223  
1224      protected String[] buildSelectizeCustomCriteria() {
1225          return new String[]{ IS_SELECTIZE_REQUEST };
1226      }
1227  
1228      /**
1229       * Adds the requested collection item via Selectize
1230       *
1231       * @param request
1232       * @param response
1233       * @param model
1234       * @param pathVars
1235       * @param id
1236       * @param collectionField
1237       * @param entityForm
1238       * @return the return view path
1239       * @throws Exception
1240       */
1241      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/selectize-add&quot;, method = RequestMethod.POST)
<abbr title="1242      public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1242      public @ResponseBody Map&lt;String, Object&gt; addSelectizeCollectionItem(HttpServletRequest request, HttpServletResðŸ”µ</abbr>
1243              @PathVariable Map&lt;String, String&gt; pathVars,
1244              @PathVariable(value=&quot;id&quot;) String id,
1245              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1246              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1247          Map&lt;String, Object&gt; returnVal = new HashMap&lt;&gt;();
1248          String sectionKey = getSectionKey(pathVars);
1249          String mainClassName = getClassNameForSection(sectionKey);
1250          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1251          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1251          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1252          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1253  
1254          if (StringUtils.isBlank(entityForm.getEntityType())) {
1255              FieldMetadata fmd = collectionProperty.getMetadata();
1256              if (fmd instanceof BasicCollectionMetadata) {
1257                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1258              }
1259          }
1260  
<abbr title="1261          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1261          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1262          ppr.addCustomCriteria(buildSelectizeCustomCriteria());
1263          declareShouldIgnoreAdditionStatusFilter();
1264          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1265  
1266          // First, we must save the collection entity
<abbr title="1267          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1267          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1268          Entity savedEntity = persistenceResponse.getEntity();
1269          entityFormValidator.validate(entityForm, savedEntity, result);
1270  
1271          if (result.hasErrors()) {
1272              returnVal.put(&quot;error&quot;, result.getFieldError());
1273              return returnVal;
1274          }
1275  
1276          if (savedEntity.findProperty(ALTERNATE_ID_PROPERTY) != null) {
1277              returnVal.put(&quot;alternateId&quot;, savedEntity.findProperty(ALTERNATE_ID_PROPERTY).getValue());
1278          }
1279          return returnVal;
1280      }
1281  
1282      protected void declareShouldIgnoreAdditionStatusFilter() {
<abbr title="1283          Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditionalProperties();">1283          Map&lt;String, Object&gt; additionalProperties = BroadleafRequestContext.getBroadleafRequestContext().getAdditioðŸ”µ</abbr>
1284          additionalProperties.put(&quot;shouldIgnoreAdditionStatusFilter&quot;, true);
1285      }
1286  
1287      /**
1288       * Adds the requested collection item
1289       *
1290       * @param request
1291       * @param response
1292       * @param model
1293       * @param pathVars
1294       * @param id
1295       * @param collectionField
1296       * @param entityForm
1297       * @return the return view path
1298       * @throws Exception
1299       */
1300      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/add&quot;, method = RequestMethod.POST)
1301      public String addCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1302              @PathVariable Map&lt;String, String&gt; pathVars,
1303              @PathVariable(value=&quot;id&quot;) String id,
1304              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1305              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1306          String sectionKey = getSectionKey(pathVars);
1307          String mainClassName = getClassNameForSection(sectionKey);
1308          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1309          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1309          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1310          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1311  
1312          if (StringUtils.isBlank(entityForm.getEntityType())) {
1313              FieldMetadata fmd = collectionProperty.getMetadata();
1314              if (fmd instanceof BasicCollectionMetadata) {
1315                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1316              }
1317          }
1318  
<abbr title="1319          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1319          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1320          declareShouldIgnoreAdditionStatusFilter();
1321          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1322  
1323          // First, we must save the collection entity
<abbr title="1324          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1324          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1325          Entity savedEntity = persistenceResponse.getEntity();
1326          entityFormValidator.validate(entityForm, savedEntity, result);
1327  
1328          if (result.hasErrors()) {
1329              FieldMetadata md = collectionProperty.getMetadata();
1330              ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
<abbr title="1331              return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectionProperty,">1331              return buildAddCollectionItemModel(request, response, model, id, collectionField, sectionKey, collectiðŸ”µ</abbr>
1332                      md, ppr, entityForm, savedEntity);
1333          }
1334  
1335          // Next, we must get the new list grid that represents this collection
<abbr title="1336          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1336          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1337          model.addAttribute(&quot;listGrid&quot;, listGrid);
1338  
1339          // We return the new list grid so that it can replace the currently visible one
1340          model.addAttribute(&quot;actualEntityId&quot;, id);
1341          setModelAttributes(model, sectionKey);
1342          return &quot;views/standaloneListGrid&quot;;
1343      }
1344  
1345      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/addEmpty&quot;, method = RequestMethod.POST)
<abbr title="1346      public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,">1346      public @ResponseBody String addEmptyCollectionItem(HttpServletRequest request, HttpServletResponse response, MðŸ”µ</abbr>
1347              @PathVariable Map&lt;String, String&gt; pathVars,
1348              @PathVariable(value=&quot;id&quot;) String id,
1349              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1350              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm, BindingResult result) throws Exception {
1351          String sectionKey = getSectionKey(pathVars);
1352          String mainClassName = getClassNameForSection(sectionKey);
1353          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1354          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1354          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1355          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1356  
1357          if (StringUtils.isBlank(entityForm.getEntityType())) {
1358              FieldMetadata fmd = collectionProperty.getMetadata();
1359              if (fmd instanceof BasicCollectionMetadata) {
1360                  entityForm.setEntityType(((BasicCollectionMetadata) fmd).getCollectionCeilingEntity());
1361              }
1362          }
1363  
<abbr title="1364          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1364          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1365          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1366          entity.setIsPreAdd(true);
1367          // First, we must save the collection entity
<abbr title="1368          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, sectionCrumbs);">1368          PersistenceResponse persistenceResponse = service.addSubCollectionEntity(entityForm, mainMetadata, collectðŸ”µ</abbr>
1369          Entity savedEntity = persistenceResponse.getEntity();
1370  
1371          return new JsonResponse(response)
1372                  .with(&quot;status&quot;, &quot;complete&quot;)
1373                  .with(&quot;id&quot;, savedEntity.findProperty(entityForm.getIdProperty()).getValue())
1374                  .done();
1375      }
1376  
1377      /**
<abbr title="1378       * Builds out all of the model information needed for showing the add modal for collection items on both the initial GET">1378       * Builds out all of the model information needed for showing the add modal for collection items on both the iðŸ”µ</abbr>
1379       * as well as after a POST with validation errors
1380       *
1381       * @param request
1382       * @param model
1383       * @param id
1384       * @param collectionField
1385       * @param sectionKey
1386       * @param collectionProperty
1387       * @param md
1388       * @param ppr
1389       * @return the appropriate view to display for the modal
<abbr title="1390       * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityForm, BindingResult)}">1390       * @see {@link #addCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, EntityFðŸ”µ</abbr>
<abbr title="1391       * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MultiValueMap)}">1391       * @see {@link #showAddCollectionItem(HttpServletRequest, HttpServletResponse, Model, Map, String, String, MulðŸ”µ</abbr>
1392       * @throws ServiceException
1393       */
1394      protected String buildAddCollectionItemModel(HttpServletRequest request, HttpServletResponse response,
1395              Model model, String id, String collectionField, String sectionKey, Property collectionProperty,
<abbr title="1396              FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceException {">1396              FieldMetadata md, PersistencePackageRequest ppr, EntityForm entityForm, Entity entity) throws ServiceEðŸ”µ</abbr>
1397  
<abbr title="1398          // For requests to add a new collection item include the main class that the subsequent request comes from.">1398          // For requests to add a new collection item include the main class that the subsequent request comes fromðŸ”µ</abbr>
<abbr title="1399          // For instance, with basic collections we know the main associated class for a fetch through the ForeignKey">1399          // For instance, with basic collections we know the main associated class for a fetch through the ForeignKðŸ”µ</abbr>
1400          // persistence item but map and adorned target lookups make a standard persistence request. This solution
1401          // fixes all cases.
1402          String mainClassName = getClassNameForSection(sectionKey);
1403          ppr.addCustomCriteria(&quot;owningClass=&quot; + mainClassName);
1404          ppr.setAddOperationInspect(true);
1405  
1406          if (entityForm != null) {
1407              entityForm.clearFieldsMap();
1408          }
1409          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
1410          if (md instanceof BasicCollectionMetadata) {
1411              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1412  
1413              // When adding items to basic collections, we will sometimes show a form to persist a new record
1414              // and sometimes show a list grid to allow the user to associate an existing record.
1415              if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
<abbr title="1416                  ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1416                  ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetðŸ”µ</abbr>
1417                  if (entityForm == null) {
1418                      entityForm = formService.createEntityForm(collectionMetadata,sectionCrumbs);
1419                      entityForm.setCeilingEntityClassname(ppr.getCeilingEntityClassname());
1420                      entityForm.setEntityType(ppr.getCeilingEntityClassname());
1421                  } else {
1422                      formService.populateEntityForm(collectionMetadata, entityForm, sectionCrumbs);
1423                      formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1424                  }
<abbr title="1425                  formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassname());">1425                  formService.removeNonApplicableFields(collectionMetadata, entityForm, ppr.getCeilingEntityClassnamðŸ”µ</abbr>
1426                  entityForm.getTabs().iterator().next().getIsVisible();
1427  
1428                  model.addAttribute(&quot;entityForm&quot;, entityForm);
1429                  model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleAddEntity&quot;);
1430              } else {
1431                  DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1432                  ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1432                  ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sðŸ”µ</abbr>
1433                  listGrid.setPathOverride(request.getRequestURL().toString());
1434  
<abbr title="1435                  if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fmd.getAddMethodType())) {">1435                  if (AddMethodType.LOOKUP.equals(fmd.getAddMethodType()) || AddMethodType.SELECTIZE_LOOKUP.equals(fðŸ”µ</abbr>
1436                      listGrid.removeAllRowActions();
1437                  }
1438  
1439                  model.addAttribute(&quot;listGrid&quot;, listGrid);
1440                  model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleSelectEntity&quot;);
1441              }
1442          } else if (md instanceof AdornedTargetCollectionMetadata) {
1443              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1444  
<abbr title="1445              // Even though this field represents an adorned target collection, the list we want to show in the modal">1445              // Even though this field represents an adorned target collection, the list we want to show in the modðŸ”µ</abbr>
1446              // is the standard list grid for the target entity of this field
1447              ppr.setOperationTypesOverride(null);
1448              ppr.setType(PersistencePackageRequest.Type.STANDARD);
1449              ppr.setSectionEntityField(collectionField);
1450  
<abbr title="1451              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1451              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1452  
1453              DynamicResultSet drs = service.getRecords(ppr).getDynamicResultSet();
<abbr title="1454              ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectionCrumbs);">1454              ListGrid listGrid = formService.buildCollectionListGrid(id, drs, collectionProperty, sectionKey, sectiðŸ”µ</abbr>
1455              listGrid.setSubCollectionFieldName(collectionField);
1456              listGrid.setPathOverride(request.getRequestURL().toString());
1457              listGrid.setFriendlyName(collectionMetadata.getPolymorphicEntities().getFriendlyName());
1458              if (entityForm == null) {
<abbr title="1459                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, true);">1459                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs,ðŸ”µ</abbr>
1460                  entityForm.setCeilingEntityClassname(ppr.getAdornedList().getAdornedTargetEntityClassname());
1461              } else {
<abbr title="1462                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, true);">1462                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, entityForm, sectionCrumbs, ðŸ”µ</abbr>
1463                  formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1464              }
1465  
1466              listGrid.setListGridType(ListGrid.Type.ADORNED);
1467              for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
1468                  if (entry.getValue().getIsVisible()) {
1469                      listGrid.setListGridType(ListGrid.Type.ADORNED_WITH_FORM);
1470                      break;
1471                  }
1472              }
1473  
1474              // This is part of an add, so we want to be able to filter/sort the listgrid
1475              listGrid.setIsSortable(false);
1476              listGrid.setCanFilterAndSort(true);
1477              listGrid.removeAllRowActions();
1478  
1479              model.addAttribute(&quot;listGrid&quot;, listGrid);
1480              model.addAttribute(&quot;entityForm&quot;, entityForm);
1481              model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedSelectEntity&quot;);
1482          } else if (md instanceof MapMetadata) {
1483              MapMetadata fmd = (MapMetadata) md;
<abbr title="1484              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1484              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1485  
1486              if (entityForm == null) {
1487                  entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);
1488              } else {
1489                  formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1490                  formService.populateEntityFormFieldValues(collectionMetadata, entity, entityForm);
1491              }
1492              model.addAttribute(&quot;entityForm&quot;, entityForm);
1493              model.addAttribute(&quot;viewType&quot;, &quot;modal/mapAddEntity&quot;);
1494          }
1495  
1496          // Set the parent id on the entity form
1497          if (entityForm != null) {
1498              entityForm.setParentId(id);
1499          }
1500  
1501          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1502          model.addAttribute(&quot;modalHeaderType&quot;, ModalHeaderType.ADD_COLLECTION_ITEM.getType());
1503          model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1504          setModelAttributes(model, sectionKey);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1505 -        return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1506 +        return MODAL_CONTAINER_VIEW;</span>
1507      }
1508  
1509      /**
1510       * Shows the appropriate modal dialog to edit the selected collection item
1511       *
1512       * @param request
1513       * @param response
1514       * @param model
1515       * @param pathVars
1516       * @param id
1517       * @param collectionField
1518       * @param collectionItemId
1519       * @return the return view path
1520       * @throws Exception
1521       */
<abbr title="1522      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.GET)">1522      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.ðŸ”µ</abbr>
1523      public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1524              @PathVariable  Map&lt;String, String&gt; pathVars,
1525              @PathVariable(value=&quot;id&quot;) String id,
1526              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1527              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1528              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1529          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1529          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateðŸ”µ</abbr>
1530                  ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1531      }
1532  
1533      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.GET)
1534      public String showUpdateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1535              @PathVariable  Map&lt;String, String&gt; pathVars,
1536              @PathVariable(value=&quot;id&quot;) String id,
1537              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1538              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
1539          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,
1540                  ModalHeaderType.UPDATE_COLLECTION_ITEM.getType());
1541      }
1542  
1543      /**
<abbr title="1544       * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as readonly">1544       * Shows the appropriate modal dialog to view the selected collection item. This will display the modal as reaðŸ”µ</abbr>
1545       *
1546       * @param request
1547       * @param response
1548       * @param model
1549       * @param pathVars
1550       * @param id
1551       * @param collectionField
1552       * @param collectionItemId
1553       * @return the return view path
1554       * @throws Exception
1555       */
<abbr title="1556      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMethod.GET)">1556      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/view&quot;, method = RequestMeðŸ”µ</abbr>
1557      public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1558              @PathVariable  Map&lt;String, String&gt; pathVars,
1559              @PathVariable(value=&quot;id&quot;) String id,
1560              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1561              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1562              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
<abbr title="1563          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1563          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1564                  ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1565  
1566          // Since this is a read-only view, actions don&#x27;t make sense in this context
1567          EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1568          addAuditableDisplayFields(ef);
1569          ef.removeAllActions();
1570          ef.setReadOnly();
1571  
1572          return returnPath;
1573      }
1574  
1575      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/view&quot;, method = RequestMethod.GET)
1576      public String showViewCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1577              @PathVariable  Map&lt;String, String&gt; pathVars,
1578              @PathVariable(value=&quot;id&quot;) String id,
1579              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1580              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="1581          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null,">1581          String returnPath = showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemðŸ”µ</abbr>
1582                  ModalHeaderType.VIEW_COLLECTION_ITEM.getType());
1583  
1584          // Since this is a read-only view, actions don&#x27;t make sense in this context
1585          EntityForm ef = (EntityForm) model.asMap().get(&quot;entityForm&quot;);
1586          ef.removeAllActions();
1587          ef.setReadOnly();
1588  
1589          return returnPath;
1590      }
1591  
<abbr title="1592      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1592      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1593              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType) throws ServiceException {">1593              String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderTypeðŸ”µ</abbr>
<abbr title="1594          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId, modalHeaderType, null, null);">1594          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateðŸ”µ</abbr>
1595      }
1596  
<abbr title="1597      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1597      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1598              String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceException {">1598              String id, String collectionField, String collectionItemId, String modalHeaderType) throws ServiceExceðŸ”µ</abbr>
<abbr title="1599          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, null, null);">1599          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modðŸ”µ</abbr>
1600      }
1601  
<abbr title="1602      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1602      protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr>
<abbr title="1603                  String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1603                  String id, String collectionField, String collectionItemId, String modalHeaderType, EntityForm entðŸ”µ</abbr>
<abbr title="1604          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modalHeaderType, entityForm, entity);">1604          return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, null, modðŸ”µ</abbr>
1605      }
1606  
1607      /**
<abbr title="1608       * Shows the view and populates the model for updating a collection item. You can also pass in an entityform and entity">1608       * Shows the view and populates the model for updating a collection item. You can also pass in an entityform aðŸ”µ</abbr>
1609       * which are optional. If they are not passed in then they are automatically looked up
1610       *
1611       * @param request
1612       * @param model
1613       * @param pathVars
1614       * @param id
1615       * @param collectionField
1616       * @param collectionItemId
1617       * @param modalHeaderType
1618       * @param entityForm
1619       * @param entity
1620       * @return
1621       * @throws ServiceException
1622       */
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1623 -    protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVars,">1623 -    protected String showViewUpdateCollection(HttpServletRequest request, Model model, Map&lt;String, String&gt; pathVarðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1624 -            String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderType, EntityForm entityForm, Entity entity) throws ServiceException {">1624 -            String id, String collectionField, String collectionItemId, String alternateId, String modalHeaderTypeðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1625 +    protected String showViewUpdateCollection(HttpServletRequest request,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1626 +            Model model,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1627 +            Map&lt;String, String&gt; pathVars,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1628 +            String id,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1629 +            String collectionField,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1630 +            String collectionItemId,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1631 +            String alternateId,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1632 +            String modalHeaderType,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1633 +            EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1634 +            Entity entity) throws ServiceException {</span>
1635          String sectionKey = getSectionKey(pathVars);
1636          String mainClassName = getClassNameForSection(sectionKey);
1637          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1638          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1638          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1639          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1640          FieldMetadata md = collectionProperty.getMetadata();
1641          SectionCrumb nextCrumb = new SectionCrumb();
1642          if (md instanceof MapMetadata) {
1643              nextCrumb.setSectionIdentifier(((MapMetadata) md).getValueClassName());
1644          } else {
1645              nextCrumb.setSectionIdentifier(((CollectionMetadata) md).getCollectionCeilingEntity());
1646          }
1647          nextCrumb.setSectionId(collectionItemId);
1648          if (!sectionCrumbs.contains(nextCrumb)) {
1649              sectionCrumbs.add(nextCrumb);
1650          }
1651  
<abbr title="1652          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1652          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
<abbr title="1653          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1653          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0ðŸ”µ</abbr>
1654  
1655          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1656  
1657          if (md instanceof BasicCollectionMetadata &amp;&amp;
1658                  (((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST) ||
1659                          ((BasicCollectionMetadata) md).getAddMethodType().equals(AddMethodType.PERSIST_EMPTY))) {
1660              BasicCollectionMetadata fmd = (BasicCollectionMetadata) md;
1661  
<abbr title="1662              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1662              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1663              if (entity == null) {
<abbr title="1664                  entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().getRecords()[0];">1664                  entity = service.getRecord(ppr, collectionItemId, collectionMetadata, true).getDynamicResultSet().ðŸ”µ</abbr>
1665              }
1666  
1667              String currentTabName = getCurrentTabName(pathVars, collectionMetadata);
<abbr title="1668              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entity, sectionCrumbs, currentTabName);">1668              Map&lt;String, DynamicResultSet&gt; subRecordsMap = service.getRecordsForSelectedTab(collectionMetadata, entðŸ”µ</abbr>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1669 -            if (entityForm == null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1670 -                entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);">1670 -                entityForm = formService.createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbsðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1671 -            } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1672 -                entityForm.clearFieldsMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="1673 -                formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbs);">1673 -                formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm, sectionCrumbðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1674 -                //remove all the actions since we&#x27;re not trying to redisplay them on the form</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1675 -                entityForm.removeAllActions();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1676 -            }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1677 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1678 +            entityForm = reinitializeEntityForm(entityForm, collectionMetadata, entity,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1679 +                    subRecordsMap, sectionCrumbs);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1680 +</span>
1681              entityForm.removeAction(DefaultEntityFormActions.DELETE);
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1682 +            entityForm.removeAction(DefaultEntityFormActions.DUPLICATE);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1683 +</span>
1684              addAuditableDisplayFields(entityForm);
1685              model.addAttribute(&quot;entityForm&quot;, entityForm);
1686              model.addAttribute(&quot;viewType&quot;, &quot;modal/simpleEditEntity&quot;);
1687          } else if (md instanceof AdornedTargetCollectionMetadata) {
1688              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1689  
1690              if (entity == null) {
1691                  entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1692                      collectionItemId, sectionCrumbs, alternateId).getDynamicResultSet().getRecords()[0];
1693              }
1694  
1695              boolean populateTypeAndId = true;
1696              boolean isViewCollectionItem = ModalHeaderType.VIEW_COLLECTION_ITEM.getType().equals(modalHeaderType);
1697              if (entityForm == null) {
<abbr title="1698                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, sectionCrumbs, false);">1698                  entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem,ðŸ”µ</abbr>
1699                  entityForm.removeAction(DefaultAdornedEntityFormActions.Add);
1700                  entityForm.addAction(DefaultAdornedEntityFormActions.Save);
1701              } else {
1702                  entityForm.clearFieldsMap();
1703                  String entityType = entityForm.getEntityType();
<abbr title="1704                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, sectionCrumbs, false);">1704                  formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, isViewCollectionItem, entityForm, ðŸ”µ</abbr>
1705                  entityForm.setEntityType(entityType);
1706                  populateTypeAndId = false;
1707              }
1708  
1709              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1710              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassName, id,">1710              adornedTargetAutoPopulateExtensionManager.getProxy().autoSetAdornedTargetManagedFields(md, mainClassNaðŸ”µ</abbr>
1711                      collectionField,
1712                      collectionItemId, responseMap);
1713  
<abbr title="1714              //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is used.">1714              //For AdornedTargetCollections, we need to be specific on what translation ceilingEntity and Id is useðŸ”µ</abbr>
1715              //It should be the entity and referenced Id of the adorned entity (not the target entity and Id).
1716              entityForm.setTranslationCeilingEntity(entityForm.getEntityType());
1717              entityForm.setTranslationId(alternateId);
1718  
1719              ClassMetadata cmd = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();
1720              for (String field : fmd.getMaintainedAdornedTargetFields()) {
1721                  if (responseMap.containsKey(field) &amp;&amp; responseMap.containsKey(&quot;autoSubmit&quot;)) {
1722                      continue;
1723                  }
1724                  Property p = cmd.getPMap().get(field);
1725                  if (p != null &amp;&amp; p.getMetadata() instanceof AdornedTargetCollectionMetadata) {
<abbr title="1726                      // Because we&#x27;re dealing with a nested adorned target collection, this particular request must act">1726                      // Because we&#x27;re dealing with a nested adorned target collection, this particular request mustðŸ”µ</abbr>
<abbr title="1727                      // directly on the first adorned target collection. Because of this, we need the actual id property">1727                      // directly on the first adorned target collection. Because of this, we need the actual id proðŸ”µ</abbr>
<abbr title="1728                      // from the entity that models the adorned target relationship, and not the id of the target object.">1728                      // from the entity that models the adorned target relationship, and not the id of the target oðŸ”µ</abbr>
<abbr title="1729                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1729                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERðŸ”µ</abbr>
1730                      DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,
1731                              alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1732  
<abbr title="1733                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1733                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, pðŸ”µ</abbr>
1734                              ppr.getAdornedList().getAdornedTargetEntityClassname(), sectionCrumbs);
1735                      listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1736  
1737                      if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1738                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1738                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1739                      } else {
<abbr title="1740                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1740                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1741                      }
1742                  } else if (p != null &amp;&amp; p.getMetadata() instanceof MapMetadata) {
1743                      // See above comment for AdornedTargetCollectionMetadata
1744                      MapMetadata mmd = (MapMetadata) p.getMetadata();
1745  
<abbr title="1746                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERTY);">1746                      Property alternateIdProperty = entity.getPMap().get(BasicPersistenceModule.ALTERNATE_ID_PROPERðŸ”µ</abbr>
1747                      DynamicResultSet drs = service.getRecordsForCollection(cmd, entity, p, null, null, null,
1748                              alternateIdProperty.getValue(), sectionCrumbs).getDynamicResultSet();
1749  
<abbr title="1750                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, p,">1750                      ListGrid listGrid = formService.buildCollectionListGrid(alternateIdProperty.getValue(), drs, pðŸ”µ</abbr>
1751                              mmd.getTargetClass(), sectionCrumbs);
1752                      listGrid.getToolbarActions().add(DefaultListGridActions.ADD);
1753  
1754                      if (drs.getUnselectedTabMetadata().get(EntityForm.DEFAULT_TAB_NAME) != null) {
<abbr title="1755                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), true);">1755                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1756                      } else {
<abbr title="1757                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ORDER, fmd.getGroup(), false);">1757                          entityForm.addListGrid(cmd, listGrid, EntityForm.DEFAULT_TAB_NAME, EntityForm.DEFAULT_TAB_ðŸ”µ</abbr>
1758                      }
1759                  }
1760              }
1761  
1762              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1763              formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1764  
1765              boolean atLeastOneBasicField = false;
1766              for (Entry&lt;String, Field&gt; entry : entityForm.getFields().entrySet()) {
<abbr title="1767                  if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !responseMap.containsKey(&quot;autoSubmit&quot;)) {">1767                  if (entry.getValue().getIsVisible() &amp;&amp; !responseMap.containsKey(entry.getValue().getName()) &amp;&amp; !reðŸ”µ</abbr>
1768                      atLeastOneBasicField = true;
1769                      break;
1770                  }
1771              }
1772              if (!atLeastOneBasicField) {
1773                  entityForm.removeAction(DefaultEntityFormActions.SAVE);
1774              }
1775              addAuditableDisplayFields(entityForm);
1776              model.addAttribute(&quot;entityForm&quot;, entityForm);
1777              model.addAttribute(&quot;viewType&quot;, &quot;modal/adornedEditEntity&quot;);
1778          } else if (md instanceof MapMetadata) {
1779              MapMetadata fmd = (MapMetadata) md;
1780  
<abbr title="1781              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1781              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1782              if (entity == null) {
1783                  entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1784                      collectionItemId, sectionCrumbs, null).getEntity();
1785              }
1786  
1787              boolean populateTypeAndId = true;
1788              if (entityForm == null) {
1789                  entityForm = formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id);
1790              } else {
1791                  //save off the prior key before clearing out the fields map as it will not appear
1792                  //back on the saved entity
1793                  String priorKey = entityForm.findField(&quot;priorKey&quot;).getValue();
1794                  entityForm.clearFieldsMap();
1795                  formService.buildMapForm(fmd, ppr.getMapStructure(), collectionMetadata, id, entityForm);
1796                  entityForm.findField(&quot;priorKey&quot;).setValue(priorKey);
1797                  populateTypeAndId = false;
1798              }
1799  
1800              formService.populateEntityFormFields(entityForm, entity, populateTypeAndId, populateTypeAndId);
1801              formService.populateMapEntityFormFields(entityForm, entity);
1802              addAuditableDisplayFields(entityForm);
1803              model.addAttribute(&quot;entityForm&quot;, entityForm);
1804              model.addAttribute(&quot;viewType&quot;, &quot;modal/mapEditEntity&quot;);
1805          }
1806  
1807          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1808          model.addAttribute(&quot;modalHeaderType&quot;, modalHeaderType);
1809          model.addAttribute(&quot;collectionProperty&quot;, collectionProperty);
1810          setModelAttributes(model, sectionKey);
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">1811 -        return &quot;modules/modalContainer&quot;;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1812 +        return MODAL_CONTAINER_VIEW;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1813 +    }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1814 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1815 +    protected EntityForm reinitializeEntityForm(final EntityForm entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1816 +            final ClassMetadata collectionMetadata,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1817 +            final Entity entity,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1818 +            final Map&lt;String, DynamicResultSet&gt; subRecordsMap,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1819 +            final List&lt;SectionCrumb&gt; sectionCrumbs) throws ServiceException {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1820 +        if (entityForm == null) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1821 +            return formService</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1822 +                    .createEntityForm(collectionMetadata, entity, subRecordsMap, sectionCrumbs);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1823 +        }</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1824 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1825 +        entityForm.clearFieldsMap();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1826 +        formService.populateEntityForm(collectionMetadata, entity, subRecordsMap, entityForm,</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1827 +                sectionCrumbs);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1828 +        //remove all the actions since we&#x27;re not trying to redisplay them on the form</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1829 +        entityForm.removeAllActions();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1830 +</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">1831 +        return entityForm;</span>
1832      }
1833  
1834      /**
1835       * Updates the specified collection item
1836       *
1837       * @param request
1838       * @param response
1839       * @param model
1840       * @param pathVars
1841       * @param id
1842       * @param collectionField
<abbr title="1843       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1843       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this isðŸ”µ</abbr>
1844       * @param entityForm
1845       * @param result
1846       * @return the return view path
1847       * @throws Exception
1848       */
1849      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}&quot;, method = RequestMethod.POST)
1850      public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1851              @PathVariable  Map&lt;String, String&gt; pathVars,
1852              @PathVariable(value=&quot;id&quot;) String id,
1853              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1854              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1855              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1856              BindingResult result) throws Exception {
<abbr title="1857          return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entityForm, null, result);">1857          return updateCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, entðŸ”µ</abbr>
1858      }
1859  
1860      /**
1861       * Updates the specified collection item
1862       *
1863       * @param request
1864       * @param response
1865       * @param model
1866       * @param pathVars
1867       * @param id
1868       * @param collectionField
<abbr title="1869       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this is the primary key value of the target entity)">1869       * @param collectionItemId the collection primary key value (in the case of adorned target collection, this isðŸ”µ</abbr>
1870       * @param entityForm
<abbr title="1871       * @param alternateId in the case of adorned target collections, this is the primary key value of the collection member">1871       * @param alternateId in the case of adorned target collections, this is the primary key value of the collectiðŸ”µ</abbr>
1872       * @param result
1873       * @return the return view path
1874       * @throws Exception
1875       */
<abbr title="1876      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.POST)">1876      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}&quot;, method = RequestMethod.ðŸ”µ</abbr>
1877      public String updateCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
1878              @PathVariable  Map&lt;String, String&gt; pathVars,
1879              @PathVariable(value=&quot;id&quot;) String id,
1880              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1881              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1882              @ModelAttribute(value=&quot;entityForm&quot;) EntityForm entityForm,
1883              @PathVariable(value=&quot;alternateId&quot;) String alternateId,
1884              BindingResult result) throws Exception {
1885          String sectionKey = getSectionKey(pathVars);
1886          String mainClassName = getClassNameForSection(sectionKey);
1887          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1888          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1888          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1889          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1890  
<abbr title="1891          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1891          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1892          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
1893  
1894          // First, we must save the collection entity
<abbr title="1895          PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, entity, collectionItemId, alternateId, sectionCrumbs);">1895          PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collðŸ”µ</abbr>
1896          Entity savedEntity = persistenceResponse.getEntity();
1897          entityFormValidator.validate(entityForm, savedEntity, result);
1898  
1899          if (result.hasErrors()) {
<abbr title="1900              return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alternateId,">1900              return showViewUpdateCollection(request, model, pathVars, id, collectionField, collectionItemId, alterðŸ”µ</abbr>
1901                      ModalHeaderType.UPDATE_COLLECTION_ITEM.getType(), entityForm, savedEntity);
1902          }
1903  
1904          // Next, we must get the new list grid that represents this collection
1905          // We return the new list grid so that it can replace the currently visible one
<abbr title="1906          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">1906          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
1907  
1908          model.addAttribute(&quot;listGrid&quot;, listGrid);
1909          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
1910          setModelAttributes(model, sectionKey);
1911          return &quot;views/standaloneListGrid&quot;;
1912      }
1913  
1914      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/sequence&quot;, method = RequestMethod.POST)
1915      public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1916              HttpServletResponse response, Model model,
1917              @PathVariable  Map&lt;String, String&gt; pathVars,
1918              @PathVariable(value=&quot;id&quot;) String id,
1919              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1920              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1921              @RequestParam(value=&quot;newSequence&quot;) String newSequence) throws Exception {
<abbr title="1922          return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionItemId, newSequence, null);">1922          return updateCollectionItemSequence(request, response, model, pathVars, id, collectionField, collectionIteðŸ”µ</abbr>
1923      }
1924  
1925      /**
1926       * Updates the given collection item&#x27;s sequence. This should only be triggered for adorned target collections
1927       * where a sort field is specified -- any other invocation is incorrect and will result in an exception.
1928       *
1929       * @param request
1930       * @param response
1931       * @param model
1932       * @param pathVars
1933       * @param id
1934       * @param collectionField
1935       * @param collectionItemId
1936       * @return an object explaining the state of the operation
1937       * @throws Exception
1938       */
<abbr title="1939      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequestMethod.POST)">1939      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/sequence&quot;, method = RequeðŸ”µ</abbr>
1940      public @ResponseBody Map&lt;String, Object&gt; updateCollectionItemSequence(HttpServletRequest request,
1941              HttpServletResponse response, Model model,
1942              @PathVariable  Map&lt;String, String&gt; pathVars,
1943              @PathVariable(value=&quot;id&quot;) String id,
1944              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
1945              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
1946              @RequestParam(value=&quot;newSequence&quot;) String newSequence,
1947              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
1948          String sectionKey = getSectionKey(pathVars);
1949          String mainClassName = getClassNameForSection(sectionKey);
1950          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="1951          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">1951          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
1952          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
1953          FieldMetadata md = collectionProperty.getMetadata();
1954  
<abbr title="1955          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">1955          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
1956          ppr.addCustomCriteria(&quot;reorderParentEntityFetch&quot;);
1957  
<abbr title="1958          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1958          Entity parentEntity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0ðŸ”µ</abbr>
1959  
1960          ppr = PersistencePackageRequest.fromMetadata(md, sectionCrumbs);
1961  
1962          if (md instanceof AdornedTargetCollectionMetadata) {
1963              AdornedTargetCollectionMetadata fmd = (AdornedTargetCollectionMetadata) md;
1964              AdornedTargetList atl = ppr.getAdornedList();
1965  
1966              // Get an entity form for the entity
<abbr title="1967              EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionCrumbs, false);">1967              EntityForm entityForm = formService.buildAdornedListForm(fmd, ppr.getAdornedList(), id, false, sectionðŸ”µ</abbr>
1968              Entity entity = service.getAdvancedCollectionRecord(mainMetadata, parentEntity, collectionProperty,
1969                      collectionItemId, sectionCrumbs, alternateId, new String[]{&quot;reorderChildEntityFetch&quot;})
1970                      .getDynamicResultSet().getRecords()[0];
1971              formService.populateEntityFormFields(entityForm, entity);
1972              formService.populateAdornedEntityFormFields(entityForm, entity, ppr.getAdornedList());
1973  
<abbr title="1974              // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indexed)">1974              // Set the new sequence (note that it will come in 0-indexed but the persistence module expects 1-indeðŸ”µ</abbr>
1975              int sequenceValue = Integer.parseInt(newSequence) + 1;
1976              Field field = entityForm.findField(atl.getSortField());
1977              field.setValue(String.valueOf(sequenceValue));
1978  
1979              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1980              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, alternateId, sectionCrumbs);">1980              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, ðŸ”µ</abbr>
1981              Property displayOrder = persistenceResponse.getEntity().findProperty(atl.getSortField());
1982  
1983              responseMap.put(&quot;status&quot;, &quot;ok&quot;);
1984              responseMap.put(&quot;field&quot;, collectionField);
1985              responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
1986              return responseMap;
1987          } else if (md instanceof BasicCollectionMetadata) {
1988              BasicCollectionMetadata cd = (BasicCollectionMetadata) md;
1989              Map&lt;String, Object&gt; responseMap = new HashMap&lt;&gt;();
<abbr title="1990              Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().getRecords()[0];">1990              Entity entity = service.getRecord(ppr, collectionItemId, mainMetadata, false).getDynamicResultSet().geðŸ”µ</abbr>
1991  
<abbr title="1992              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaData();">1992              ClassMetadata collectionMetadata = service.getClassMetadata(ppr).getDynamicResultSet().getClassMetaDatðŸ”µ</abbr>
1993              EntityForm entityForm = formService.createEntityForm(collectionMetadata, sectionCrumbs);
1994              if (!StringUtils.isEmpty(cd.getSortProperty())) {
1995                  Field f = new Field()
1996                          .withName(cd.getSortProperty())
1997                          .withFieldType(SupportedFieldType.HIDDEN.toString());
1998                  entityForm.addHiddenField(mainMetadata, f);
1999              }
2000              formService.populateEntityFormFields(entityForm, entity);
2001  
2002              if (!StringUtils.isEmpty(cd.getSortProperty())) {
2003                  int sequenceValue = Integer.parseInt(newSequence) + 1;
2004                  Field field = entityForm.findField(cd.getSortProperty());
2005                  field.setValue(String.valueOf(sequenceValue));
2006              }
2007  
<abbr title="2008              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, collectionProperty, parentEntity, collectionItemId, sectionCrumbs);">2008              PersistenceResponse persistenceResponse = service.updateSubCollectionEntity(entityForm, mainMetadata, ðŸ”µ</abbr>
2009              Property displayOrder = persistenceResponse.getEntity().findProperty(cd.getSortProperty());
2010  
2011              responseMap.put(&quot;status&quot;, &quot;ok&quot;);
2012              responseMap.put(&quot;field&quot;, collectionField);
2013              responseMap.put(&quot;newDisplayOrder&quot;, displayOrder == null ? null : displayOrder.getValue());
2014              return responseMap;
2015          } else {
<abbr title="2016              throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fields.&quot;);">2016              throw new UnsupportedOperationException(&quot;Cannot handle sequencing for non adorned target collection fiðŸ”µ</abbr>
2017          }
2018      }
2019  
2020      /**
2021       * Removes the requested collection item
2022       *
<abbr title="2023       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">2023       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item froðŸ”µ</abbr>
2024       * map collection.
2025       *
2026       * @param request
2027       * @param response
2028       * @param model
2029       * @param pathVars
2030       * @param id
2031       * @param collectionField
2032       * @param collectionItemId
2033       * @return the return view path
2034       * @throws Exception
2035       */
2036      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/delete&quot;, method = RequestMethod.POST)
2037      public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
2038              @PathVariable  Map&lt;String, String&gt; pathVars,
2039              @PathVariable(value=&quot;id&quot;) String id,
2040              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2041              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId) throws Exception {
<abbr title="2042          return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, null);">2042          return removeCollectionItem(request, response, model, pathVars, id, collectionField, collectionItemId, nulðŸ”µ</abbr>
2043      }
2044  
2045      /**
2046       * Removes the requested collection item
2047       *
<abbr title="2048       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item from a">2048       * Note that the request must contain a parameter called &quot;key&quot; when attempting to remove a collection item froðŸ”µ</abbr>
2049       * map collection.
2050       *
2051       * @param request
2052       * @param response
2053       * @param model
2054       * @param pathVars
2055       * @param id
2056       * @param collectionField
2057       * @param collectionItemId
2058       * @return the return view path
2059       * @throws Exception
2060       */
<abbr title="2061      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestMethod.POST)">2061      @RequestMapping(value = &quot;/{id}/{collectionField:.*}/{collectionItemId}/{alternateId}/delete&quot;, method = RequestðŸ”µ</abbr>
2062      public String removeCollectionItem(HttpServletRequest request, HttpServletResponse response, Model model,
2063              @PathVariable  Map&lt;String, String&gt; pathVars,
2064              @PathVariable(value=&quot;id&quot;) String id,
2065              @PathVariable(value=&quot;collectionField&quot;) String collectionField,
2066              @PathVariable(value=&quot;collectionItemId&quot;) String collectionItemId,
2067              @PathVariable(value=&quot;alternateId&quot;) String alternateId) throws Exception {
2068          String sectionKey = getSectionKey(pathVars);
2069          String mainClassName = getClassNameForSection(sectionKey);
2070          List&lt;SectionCrumb&gt; sectionCrumbs = getSectionCrumbs(request, sectionKey, id);
<abbr title="2071          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars)).getDynamicResultSet().getClassMetaData();">2071          ClassMetadata mainMetadata = service.getClassMetadata(getSectionPersistencePackageRequest(mainClassName, sðŸ”µ</abbr>
2072          Property collectionProperty = mainMetadata.getPMap().get(collectionField);
2073  
2074          String priorKey = request.getParameter(&quot;key&quot;);
2075  
<abbr title="2076          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVars);">2076          PersistencePackageRequest ppr = getSectionPersistencePackageRequest(mainClassName, sectionCrumbs, pathVarsðŸ”µ</abbr>
2077          declareShouldIgnoreAdditionStatusFilter();
2078          Entity entity = service.getRecord(ppr, id, mainMetadata, false).getDynamicResultSet().getRecords()[0];
2079  
2080          // First, we must remove the collection entity
<abbr title="2081          PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperty, entity, collectionItemId, alternateId, priorKey, sectionCrumbs);">2081          PersistenceResponse persistenceResponse = service.removeSubCollectionEntity(mainMetadata, collectionProperðŸ”µ</abbr>
2082          if (persistenceResponse.getEntity() != null &amp;&amp; persistenceResponse.getEntity().isValidationFailure()) {
2083              String error = &quot;There was an error removing the whatever&quot;;
2084              if (MapUtils.isNotEmpty(persistenceResponse.getEntity().getPropertyValidationErrors())) {
2085                  // If we failed, we&#x27;ll return some JSON with the first error
<abbr title="2086                  error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().get(0);">2086                  error = persistenceResponse.getEntity().getPropertyValidationErrors().values().iterator().next().gðŸ”µ</abbr>
2087              } else if (CollectionUtils.isNotEmpty(persistenceResponse.getEntity().getGlobalValidationErrors())) {
2088                  error = persistenceResponse.getEntity().getGlobalValidationErrors().get(0);
2089              }
2090              return new JsonResponse(response)
2091                  .with(&quot;status&quot;, &quot;error&quot;)
2092                  .with(&quot;message&quot;, BLCMessageUtils.getMessage(error))
2093                  .done();
2094          }
2095  
2096          // Next, we must get the new list grid that represents this collection
2097          // We return the new list grid so that it can replace the currently visible one
<abbr title="2098          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persistenceResponse, sectionCrumbs);">2098          ListGrid listGrid = getCollectionListGrid(mainMetadata, entity, collectionProperty, null, sectionKey, persðŸ”µ</abbr>
2099  
2100          model.addAttribute(&quot;listGrid&quot;, listGrid);
2101          model.addAttribute(&quot;currentUrl&quot;, request.getRequestURL().toString());
2102          setModelAttributes(model, sectionKey);
2103          return &quot;views/standaloneListGrid&quot;;
2104      }
2105  
2106      public void addAuditableDisplayFields(EntityForm entityForm) {
2107          Field createdBy = entityForm.findField(&quot;auditable.createdBy&quot;);
2108          if (createdBy != null &amp;&amp; createdBy.getValue() != null) {
2109              addAuditableDisplayField(entityForm, createdBy);
2110  
2111              createdBy.setIsVisible(false);
2112          }
2113          Field updatedBy = entityForm.findField(&quot;auditable.updatedBy&quot;);
2114          if (updatedBy != null &amp;&amp; updatedBy.getValue() != null) {
2115              addAuditableDisplayField(entityForm, updatedBy);
2116  
2117              updatedBy.setIsVisible(false);
2118          }
2119      }
2120  
2121      private void addAuditableDisplayField(EntityForm entityForm, Field userField) {
2122          Field displayField = buildAuditableDisplayField(userField);
2123  
2124          AdminUser user = adminUserDao.readAdminUserById(Long.parseLong(userField.getValue()));
2125          String userName = user == null ? null : user.getName();
2126          displayField.setValue(userName);
2127  
2128          FieldGroup auditGroup = entityForm.findGroup(&quot;AdminAuditable_Audit&quot;);
2129          if (auditGroup != null) {
2130              auditGroup.addField(displayField);
2131          }
2132      }
2133  
2134      private Field buildAuditableDisplayField(Field auditableField) {
2135          return new Field().withFieldType(SupportedFieldType.STRING.toString())
2136                  .withName(auditableField.getName() + &quot;Display&quot;)
2137                  .withFriendlyName(auditableField.getFriendlyName())
2138                  .withOrder(auditableField.getOrder())
2139                  .withOwningEntityClass(auditableField.getOwningEntityClass())
2140                  .withReadOnly(true);
2141      }
2142  
2143      protected String getCurrentTabName(Map&lt;String, String&gt; pathVars, ClassMetadata cmd) {
2144          String tabName = pathVars.get(&quot;tabName&quot;);
2145          if (StringUtils.isBlank(tabName)) {
2146              TabMetadata firstTab = cmd.getFirstTab();
2147              return firstTab != null ? firstTab.getTabName() : &quot;General&quot;;
2148          }
2149          return tabName;
2150      }
2151  
2152      // *****************************************
2153      // Typed Entity Helper Methods
2154      // *****************************************
2155  
2156      protected void setTypedEntityModelAttributes(HttpServletRequest request, Model model) {
2157          // Check if this is a typed entity
2158          AdminSection typedEntitySection = (AdminSection) request.getAttribute(&quot;typedEntitySection&quot;);
2159          if (typedEntitySection != null) {
2160              // Update the friendly name for this Entity Type
2161              model.addAttribute(&quot;entityFriendlyName&quot;, typedEntitySection.getName());
2162          }
2163      }
2164  
2165      // *********************************
2166      // ADDITIONAL SPRING-BOUND METHODS *
2167      // *********************************
2168  
2169      /**
2170       * Invoked on every request to provide the ability to register specific binders for Spring&#x27;s binding process.
<abbr title="2171       * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports either true">2171       * By default, we register a binder that treats empty Strings as null and a Boolean editor that supports eitheðŸ”µ</abbr>
2172       * or false. If the value is passed in as null, it will treat it as false.
2173       *
2174       * @param binder
2175       */
2176      @InitBinder
2177      public void initBinder(WebDataBinder binder) {
2178          binder.registerCustomEditor(String.class, new StringTrimmerEditor(true));
2179          binder.registerCustomEditor(Boolean.class, new NonNullBooleanEditor());
2180      }
2181  
2182  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            