<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>521</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    521
                    <a href="520.html">prev</a>
                    <a href="522.html">next</a>
                    <a href="521_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    DTStack/flinkStreamSQL_08eab84481ddc54518a8d0a2edc0fe5de5815a24_launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;08eab84481ddc54518a8d0a2edc0fe5de5815a24:launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;08eab84481ddc54518a8d0a2edc0fe5de5815a24^1:launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;08eab84481ddc54518a8d0a2edc0fe5de5815a24^2:launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\DTStack\flinkStreamSQL show &quot;37844f41df13ae43fdf96bea35193ae6991feb67:launcher/src/main/java/com/dtstack/flink/sql/launcher/perjob/PerJobClusterClientBuilder.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   2 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import com.esotericsoftware.minlog.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.hadoop.security.UserGroupInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53  * Reason:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  71     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {">  71     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73         if(Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85         Log.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  88     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  88     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89             throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  91         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  91         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  92         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);">  92         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 135         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 135         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 136         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 136         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 145         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 145         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 146         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 146         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159                 configuration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163                 false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 }</span>
 167 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215  * Reason:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 233     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {"> 233     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235         if (Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247         LOG.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 250     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)"> 250     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251             throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 253         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();"> 253         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 254         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);"> 254         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 297         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 297         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 298         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 298         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 307         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 307         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 308         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 308         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321                 configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325                 false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328 }</span>
 329 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  17  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import com.esotericsoftware.minlog.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import org.apache.hadoop.security.UserGroupInformation;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53  * Reason:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  71     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {">  71     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73         if(Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85         Log.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  88     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  88     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89             throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  91         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  91         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  92         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);">  92         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106                 } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108                 }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 114         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120         } else {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 121             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 122                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 123         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 129             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 130         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 131         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 132     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 134     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 135         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 135         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 136         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 136         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 145         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 145         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 146         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){"> 146         for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 155             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159                 configuration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163                 false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166 }</span>
 167 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 168 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 169  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 170  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 171  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 172  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 173  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 174  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 175  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 176  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 177  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 178  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 179  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 180  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 181  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 182  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 183  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 184  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 185 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 199 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 200 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215  * Reason:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 233     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {"> 233     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235         if (Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247         LOG.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 250     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)"> 250     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251             throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 253         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();"> 253         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 254         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);"> 254         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 297         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 297         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 298         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 298         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 307         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 307         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 308         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 308         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 315 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321                 configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325                 false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328 }</span>
 329 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kw🔵</abbr></span>
   4 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7  * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8  * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9  * distributed with this work for additional information</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12  * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13  * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15  * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16  * &lt;p&gt;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17  * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  19  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  20  * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21  * limitations under the License.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import com.google.common.base.Strings;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 import org.slf4j.Logger;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 import java.io.File;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 import java.net.MalformedURLException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46 import java.net.URL;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 import java.util.ArrayList;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48 import java.util.List;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50 import java.util.Properties;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52 /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53  * Reason:</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54  * Date: 2018/11/16</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55  * Company: www.dtstack.com</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56  * @author xuchao</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59 public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61     private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63     private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65     private YarnClient yarnClient;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67     private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69     private Configuration flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  71     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {">  71     public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73         if (Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74             throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76         userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77         this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78         SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80         yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81         yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82         yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83         yarnClient.start();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85         LOG.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  88     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  88     public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89             throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  91         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  91         String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launc🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  92         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);">  92         AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, fli🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94         if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95             if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96                 throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101         if (flinkJarPath != null) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102             File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103             for (File file : jars) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104                 if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105                     clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106                 } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107                     shipFiles.add(file);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108                 }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111             throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113         // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114         String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115         if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116             fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 117         } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118             List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119             shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120         } else {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121             throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122                     + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125         clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126         clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127         String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128         if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129             clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131         return clusterDescriptor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134     private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 135         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 135         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 136         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 136         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138                 jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143     private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144         List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 145         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();"> 145         Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifact🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 146         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {"> 146         for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet(🔵</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147             if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148                 shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149             }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151         return shipFiles;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 152     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 153 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 154     private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 155             Configuration configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 156             YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 157             String configurationDirectory) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 158         return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 159                 configuration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 160                 yarnConfiguration,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 161                 configurationDirectory,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 162                 yarnClient,</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 163                 false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 164     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 165 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 166 }</span>
 167 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * Licensed to the Apache Software Foundation (ASF) under one</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - * or more contributor license agreements.  See the NOTICE file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * distributed with this work for additional information</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * regarding copyright ownership.  The ASF licenses this file</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * to you under the Apache License, Version 2.0 (the</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - * &quot;License&quot;); you may not use this file except in compliance</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - * with the License.  You may obtain a copy of the License at</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - * http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - *</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * Unless required by applicable law or agreed to in writing, software</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  14 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - * See the License for the specific language governing permissions and</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 - * limitations under the License.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -package com.dtstack.flink.sql.launcher.perjob;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import com.dtstack.flink.sql.enums.EPluginLoadMode;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import com.dtstack.flink.sql.launcher.YarnConfLoader;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import com.dtstack.flink.sql.option.Options;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import com.esotericsoftware.minlog.Log;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.apache.commons.lang3.StringUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.apache.flink.api.common.cache.DistributedCache;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.apache.flink.configuration.Configuration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import com.google.common.base.Strings;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.apache.flink.runtime.jobgraph.JobGraph;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.apache.flink.runtime.security.SecurityConfiguration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -import org.apache.flink.runtime.security.SecurityUtils;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import org.apache.flink.yarn.AbstractYarnClusterDescriptor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import org.apache.flink.yarn.YarnClusterDescriptor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import org.apache.hadoop.fs.Path;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import org.apache.hadoop.security.UserGroupInformation;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -import org.apache.hadoop.yarn.client.api.YarnClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.apache.hadoop.yarn.conf.YarnConfiguration;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -import org.slf4j.Logger;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -import org.slf4j.LoggerFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -import java.io.File;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -import java.io.IOException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -import java.net.MalformedURLException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import java.net.URL;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -import java.util.ArrayList;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -import java.util.List;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -import java.util.Properties;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -/**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 - * Reason:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 - * Date: 2018/11/16</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 - * Company: www.dtstack.com</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 - * @author xuchao</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -public class PerJobClusterClientBuilder {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -    private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -    private static final String DEFAULT_CONF_DIR = &quot;./&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -    private YarnClient yarnClient;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -    private YarnConfiguration yarnConf;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -    private Configuration flinkConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -    public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -        if(Strings.isNullOrEmpty(yarnConfDir)) {</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -            throw new RuntimeException(&quot;parameters of yarn is required&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -        userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -        this.flinkConfig = flinkConfig;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -        SecurityUtils.install(new SecurityConfiguration(flinkConfig));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -        yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -        yarnClient = YarnClient.createYarnClient();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -        yarnClient.init(yarnConf);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -        yarnClient.start();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -        Log.info(&quot;----init yarn success ----&quot;);</span>

<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  86 -    public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  86 -    public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOption🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -            throws MalformedURLException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  89 -        String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  89 -        String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOption🔵</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -        AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        if (StringUtils.isNotBlank(flinkJarPath)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -            if (!new File(flinkJarPath).exists()) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -                throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -        List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -        if (flinkJarPath != null) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -            File[] jars = new File(flinkJarPath).listFiles();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -            for (File file : jars) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -                if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -                    clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -                } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -                    shipFiles.add(file);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -                }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -            throw new RuntimeException(&quot;The Flink jar path is null&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        // classpath , all node need contain plugin jar</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -        String pluginLoadMode = launcherOptions.getPluginLoadMode();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -        if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -            fillJobGraphClassPath(jobGraph);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -        } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -            List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -            shipFiles.addAll(pluginPaths);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -        } else {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 119 -            throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 120 -                    + &quot; Currently only classpath and shipfile are supported.&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 121 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -        clusterDescriptor.addShipFiles(shipFiles);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -        clusterDescriptor.setName(launcherOptions.getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -        String queue = launcherOptions.getQueue();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -        if (!Strings.isNullOrEmpty(queue)) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 127 -            clusterDescriptor.setQueue(queue);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 128 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 129 -        return clusterDescriptor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 130 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 131 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 132 -    private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 133 -        Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -        for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -            if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -                jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -    private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -        List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -        Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -        for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -            if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>


<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -                shipFiles.add(new File(tmp.getValue().filePath));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -        return shipFiles;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -    private AbstractYarnClusterDescriptor getClusterDescriptor(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -            Configuration configuration,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -            YarnConfiguration yarnConfiguration,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -            String configurationDirectory) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -        return new YarnClusterDescriptor(</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -                configuration,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -                yarnConfiguration,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -                configurationDirectory,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -                yarnClient,</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -                false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -}</span></pre></td>
                            <td><pre>   1  /**
   2   * Licensed to the Apache Software Foundation (ASF) under one
   3   * or more contributor license agreements.  See the NOTICE file
   4   * distributed with this work for additional information
   5   * regarding copyright ownership.  The ASF licenses this file
   6   * to you under the Apache License, Version 2.0 (the
   7   * &quot;License&quot;); you may not use this file except in compliance
   8   * with the License.  You may obtain a copy of the License at
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  10 + * &lt;p&gt;</span>
  11   * http://www.apache.org/licenses/LICENSE-2.0
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - *</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  13 + * &lt;p&gt;</span>
  14   * Unless required by applicable law or agreed to in writing, software
  15   * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  16   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  17   * See the License for the specific language governing permissions and
  18   * limitations under the License.
  19   */
  20  
  21  package com.dtstack.flink.sql.launcher.perjob;
  22  
  23  import com.dtstack.flink.sql.enums.EPluginLoadMode;
  24  import com.dtstack.flink.sql.launcher.YarnConfLoader;
  25  import com.dtstack.flink.sql.option.Options;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import com.esotericsoftware.minlog.Log;</span>
  27  import org.apache.commons.lang3.StringUtils;
  28  import org.apache.flink.api.common.cache.DistributedCache;
  29  import org.apache.flink.configuration.Configuration;
  30  import com.google.common.base.Strings;
  31  import org.apache.flink.runtime.jobgraph.JobGraph;
  32  import org.apache.flink.runtime.security.SecurityConfiguration;
  33  import org.apache.flink.runtime.security.SecurityUtils;
  34  import org.apache.flink.yarn.AbstractYarnClusterDescriptor;
  35  import org.apache.flink.yarn.YarnClusterDescriptor;
  36  import org.apache.hadoop.fs.Path;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import org.apache.hadoop.security.UserGroupInformation;</span>
  38  import org.apache.hadoop.yarn.client.api.YarnClient;
  39  import org.apache.hadoop.yarn.conf.YarnConfiguration;
  40  import org.slf4j.Logger;
  41  import org.slf4j.LoggerFactory;
  42  
  43  import java.io.File;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -import java.io.IOException;</span>
  45  import java.net.MalformedURLException;
  46  import java.net.URL;
  47  import java.util.ArrayList;
  48  import java.util.List;
  49  import java.util.Map;
  50  import java.util.Properties;
  51  
  52  /**
  53   * Reason:
  54   * Date: 2018/11/16
  55   * Company: www.dtstack.com
  56   * @author xuchao
  57   */
  58  
  59  public class PerJobClusterClientBuilder {
  60  
  61      private static final Logger LOG = LoggerFactory.getLogger(PerJobClusterClientBuilder.class);
  62  
  63      private static final String DEFAULT_CONF_DIR = &quot;./&quot;;
  64  
  65      private YarnClient yarnClient;
  66  
  67      private YarnConfiguration yarnConf;
  68  
  69      private Configuration flinkConfig;
  70  
  71      public void init(String yarnConfDir, Configuration flinkConfig, Properties userConf) throws Exception {
  72  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -        if(Strings.isNullOrEmpty(yarnConfDir)) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  74 +        if (Strings.isNullOrEmpty(yarnConfDir)) {</span>
  75              throw new RuntimeException(&quot;parameters of yarn is required&quot;);
  76          }
  77          userConf.forEach((key, val) -&gt; flinkConfig.setString(key.toString(), val.toString()));
  78          this.flinkConfig = flinkConfig;
  79          SecurityUtils.install(new SecurityConfiguration(flinkConfig));
  80  
  81          yarnConf = YarnConfLoader.getYarnConf(yarnConfDir);
  82          yarnClient = YarnClient.createYarnClient();
  83          yarnClient.init(yarnConf);
  84          yarnClient.start();
  85  
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -        Log.info(&quot;----init yarn success ----&quot;);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  87 +        LOG.info(&quot;----init yarn success ----&quot;);</span>
  88      }
  89  
<abbr title="  90      public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOptions, JobGraph jobGraph)">  90      public AbstractYarnClusterDescriptor createPerJobClusterDescriptor(String flinkJarPath, Options launcherOption🔵</abbr>
  91              throws MalformedURLException {
  92  
<abbr title="  93          String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOptions.getFlinkconf();">  93          String flinkConf = StringUtils.isEmpty(launcherOptions.getFlinkconf()) ? DEFAULT_CONF_DIR : launcherOption🔵</abbr>
  94          AbstractYarnClusterDescriptor clusterDescriptor = getClusterDescriptor(flinkConfig, yarnConf, flinkConf);
  95  
  96          if (StringUtils.isNotBlank(flinkJarPath)) {
  97              if (!new File(flinkJarPath).exists()) {
  98                  throw new RuntimeException(&quot;The param &#x27;-flinkJarPath&#x27; ref dir is not exist&quot;);
  99              }
 100          }
 101  
 102          List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();
 103          if (flinkJarPath != null) {
 104              File[] jars = new File(flinkJarPath).listFiles();
 105              for (File file : jars) {
 106                  if (file.toURI().toURL().toString().contains(&quot;flink-dist&quot;)) {
 107                      clusterDescriptor.setLocalJarPath(new Path(file.toURI().toURL().toString()));
 108                  } else {
 109                      shipFiles.add(file);
 110                  }
 111              }
 112          } else {
 113              throw new RuntimeException(&quot;The Flink jar path is null&quot;);
 114          }
 115          // classpath , all node need contain plugin jar
 116          String pluginLoadMode = launcherOptions.getPluginLoadMode();
 117          if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.CLASSPATH.name())) {
 118              fillJobGraphClassPath(jobGraph);
 119          } else if (StringUtils.equalsIgnoreCase(pluginLoadMode, EPluginLoadMode.SHIPFILE.name())) {
 120              List&lt;File&gt; pluginPaths = getPluginPathToShipFiles(jobGraph);
 121              shipFiles.addAll(pluginPaths);
 122          } else {
 123              throw new IllegalArgumentException(&quot;Unsupported plugin loading mode &quot; + pluginLoadMode
 124                      + &quot; Currently only classpath and shipfile are supported.&quot;);
 125          }
 126  
 127          clusterDescriptor.addShipFiles(shipFiles);
 128          clusterDescriptor.setName(launcherOptions.getName());
 129          String queue = launcherOptions.getQueue();
 130          if (!Strings.isNullOrEmpty(queue)) {
 131              clusterDescriptor.setQueue(queue);
 132          }
 133          return clusterDescriptor;
 134      }
 135  
 136      private static void fillJobGraphClassPath(JobGraph jobGraph) throws MalformedURLException {
 137          Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -            if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 140 +        for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 141 +            if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
 142                  jobGraph.getClasspaths().add(new URL(&quot;file:&quot; + tmp.getValue().filePath));
 143              }
 144          }
 145      }
 146  
 147      private List&lt;File&gt; getPluginPathToShipFiles(JobGraph jobGraph) {
 148          List&lt;File&gt; shipFiles = new ArrayList&lt;&gt;();
 149          Map&lt;String, DistributedCache.DistributedCacheEntry&gt; jobCacheFileConfig = jobGraph.getUserArtifacts();
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -        for(Map.Entry&lt;String,  DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()){</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -            if(tmp.getKey().startsWith(&quot;class_path&quot;)){</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +        for (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; tmp : jobCacheFileConfig.entrySet()) {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +            if (tmp.getKey().startsWith(&quot;class_path&quot;)) {</span>
 154                  shipFiles.add(new File(tmp.getValue().filePath));
 155              }
 156          }
 157          return shipFiles;
 158      }
 159  
 160      private AbstractYarnClusterDescriptor getClusterDescriptor(
 161              Configuration configuration,
 162              YarnConfiguration yarnConfiguration,
 163              String configurationDirectory) {
 164          return new YarnClusterDescriptor(
 165                  configuration,
 166                  yarnConfiguration,
 167                  configurationDirectory,
 168                  yarnClient,
 169                  false);
 170      }
 171  
 172  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            