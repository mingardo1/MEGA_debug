<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>261</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    261
                    <a href="260.html">prev</a>
                    <a href="262.html">next</a>
                    <a href="261_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_c4f68102688a41a40ca1a6acc67b091c49f8d5e4_common/src/test/java/org/broadleafcommerce/common/rule/MvelHelperTest.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c4f68102688a41a40ca1a6acc67b091c49f8d5e4:common/src/test/java/org/broadleafcommerce/common/rule/MvelHelperTest.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c4f68102688a41a40ca1a6acc67b091c49f8d5e4^1:common/src/test/java/org/broadleafcommerce/common/rule/MvelHelperTest.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c4f68102688a41a40ca1a6acc67b091c49f8d5e4^2:common/src/test/java/org/broadleafcommerce/common/rule/MvelHelperTest.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;d25c77b589e6b1d10bdce4e5d4941f0f5b1585d1:common/src/test/java/org/broadleafcommerce/common/rule/MvelHelperTest.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[sbj]], subset: [[sbj]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
   2 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * #%L</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * %%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * %%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * shall apply.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  * </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  16  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  16  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  17  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  17  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * #L%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 package org.broadleafcommerce.common.rule;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 import org.apache.commons.exec.CommandLine;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import org.apache.commons.exec.DefaultExecutor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import org.apache.commons.exec.Executor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.apache.commons.exec.PumpStreamHandler;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.broadleafcommerce.common.RequestDTO;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.broadleafcommerce.common.RequestDTOImpl;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.broadleafcommerce.common.locale.domain.Locale;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.broadleafcommerce.common.locale.domain.LocaleImpl;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.broadleafcommerce.common.web.BroadleafRequestContext;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import java.util.HashMap;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import junit.framework.TestCase;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 public class MvelHelperTest extends TestCase {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43     private static final Log LOG = LogFactory.getLog(MvelHelperTest.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46      * Test that a blank rule is true.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48     public void testBlankRule() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49         boolean result = MvelHelper.evaluateRule(&quot;&quot;, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54      * Test that a null rule is true.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56     public void testNullRule() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57         boolean result = MvelHelper.evaluateRule(null, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62      * Test rule with parse errors</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64     public void testRuleWithParseErrors() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65         MvelHelper.setTestMode(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66         boolean result = MvelHelper.evaluateRule(&quot;BadFunction(xyz)&quot;, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67         MvelHelper.setTestMode(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68         assertFalse(result);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72      * Test rule that evaluates to true</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74     public void testRuleThatEvaluatesToTrue() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         // Locale used as an illustrative domain class only.  Any object could have been used.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         Locale testLocale = new LocaleImpl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         testLocale.setLocaleCode(&quot;US&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         parameters.put(&quot;locale&quot;, testLocale);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87      * Test rule that evaluates to true</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89     public void testRuleThatEvaluatesToFalse() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90         // Locale used as an illustrative domain class only.  Any object could have been used.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91         Locale testLocale = new LocaleImpl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92         testLocale.setLocaleCode(&quot;GB&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95         parameters.put(&quot;locale&quot;, testLocale);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98         assertFalse(result);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102      * Tests MVEL syntax for accessing request property map values.   </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104     @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105     public void testRequestMapProperty() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106         BroadleafRequestContext.setBroadleafRequestContext(new BroadleafRequestContext());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107         RequestDTO dto = new RequestDTOImpl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         dto.getProperties().put(&quot;blcSearchTerm&quot;, &quot;hot&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         parameters.put(&quot;request&quot;, dto);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         // If the &quot;key&quot; property doesn&#x27;t contain an underscore, the expression returns true</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 114         boolean result = MvelHelper.evaluateRule(&quot;request.properties[&#x27;blcSearchTerm&#x27;] == &#x27;hot&#x27;&quot;, parameters);"> 114         boolean result = MvelHelper.evaluateRule(&quot;request.properties[&#x27;blcSearchTerm&#x27;] == &#x27;hot&#x27;&quot;, parameteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119      * Confirms MVEL failure for special overloaded method case.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 121      * During compilation, if an mvel expression contains a method calls with params, mvel will attempt to identify a perfect"> 121      * During compilation, if an mvel expression contains a method calls with params, mvel will attempt tðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 122      * method signature match based on the types of the params. However, if the method is overloaded and one or more of"> 122      * method signature match based on the types of the params. However, if the method is overloaded and ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 123      * the params are null, mvel will not be able to 100% identify the right method version if the overloaded methods"> 123      * the params are null, mvel will not be able to 100% identify the right method version if the overloðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124      * have the same quantity of params and have type overlap. Take this example:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126      * {@code SelectizeCollectionUtils#intersection(String param, Iterable param2);}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127      * {@code SelectizeCollectionUtils#intersection(Iterable param, Iterable param2);}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 129      * If a rule is executed calling the intersection method and a null is passed in for the first parameter, mvel will"> 129      * If a rule is executed calling the intersection method and a null is passed in for the first parameðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 130      * not know which method to pick, so it will end up picking one of them. This has proven to be undetermined at runtime,"> 130      * not know which method to pick, so it will end up picking one of them. This has proven to be undeteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 131      * which has made the problem even harder to identify. Furthermore, once the choice is made during compilation,"> 131      * which has made the problem even harder to identify. Furthermore, once the choice is made during coðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 132      * that compiled expression will utilize the &quot;incorrect&quot; choice going forward, which will cause the expression to"> 132      * that compiled expression will utilize the &quot;incorrect&quot; choice going forward, which will cause the eðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 133      * fail, even when neither param is null. In fact, in the case above, mvel will &quot;coerce&quot; the first param Iterable"> 133      * fail, even when neither param is null. In fact, in the case above, mvel will &quot;coerce&quot; the first paðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 134      * instance into a String (i.e. flatten the list representation into a comma delimited String) in order to continue"> 134      * instance into a String (i.e. flatten the list representation into a comma delimited String) in ordðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 135      * calling the method identified during compilation. This causes the expression to permanently be in an incorrect"> 135      * calling the method identified during compilation. This causes the expression to permanently be in ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136      * state from which it will never recover.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     public void testMvelMethodOverloadFailureCase() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         //Test multiple iterations to make sure we hit the undetermined ordering case we need to confirm</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         String output = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         for (int j=0; j&lt;100; j++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142             output = executeExternalJavaProcess(MvelOverloadFailureReproduction.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143             boolean result = Boolean.valueOf(output.trim());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144             if (result) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145                 //We found the case. Exit the loop, since we don&#x27;t need to try anymore.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149         assertEquals(&quot;true&quot;, output);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153      * Confirms repeated success for method overload workaround in SelectizeCollectionUtils</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 155      * See {@link #testMvelMethodOverloadFailureCase()} for a more complete description of the problem case."> 155      * See {@link #testMvelMethodOverloadFailureCase()} for a more complete description of the problem caðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157     public void testMvelMethodOverloadWorkaroundCase() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158         //Test multiple iterations to make sure we no longer fail at all</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159         for (int j=0; j&lt;20; j++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160             String output = executeExternalJavaProcess(MvelOverloadWorkaroundReproduction.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161             assertEquals(&quot;true&quot;, output);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164     </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165     protected String executeExternalJavaProcess(Class&lt;?&gt; mainClass) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         String classpath = MvelTestUtils.getClassPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167         </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 168         //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the test in a new JVM"> 168         //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the teðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         CommandLine cmdLine = new CommandLine(&quot;java&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         cmdLine.addArgument(&quot;-cp&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         cmdLine.addArgument(classpath, true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172         cmdLine.addArgument(mainClass.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174         ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175         Executor executor = new DefaultExecutor();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176         executor.setStreamHandler(new PumpStreamHandler(baos));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             executor.execute(cmdLine, new HashMap&lt;String, String&gt;());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             throw new IOException(new String(baos.toByteArray()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         return new String(baos.toByteArray());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 }</span>
 185 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187  * #%L</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190  * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197  * shall apply.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198  * </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 199  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)"> 199  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 200  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license."> 200  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201  * #L%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 package org.broadleafcommerce.common.rule;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 import org.apache.commons.exec.CommandLine;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 import org.apache.commons.exec.DefaultExecutor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 import org.apache.commons.exec.Executor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 import org.apache.commons.exec.PumpStreamHandler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 import org.broadleafcommerce.common.RequestDTO;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 import org.broadleafcommerce.common.RequestDTOImpl;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 import org.broadleafcommerce.common.locale.domain.Locale;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 import org.broadleafcommerce.common.locale.domain.LocaleImpl;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215 import org.broadleafcommerce.common.web.BroadleafRequestContext;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217 import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219 import java.util.HashMap;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 import junit.framework.TestCase;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 public class MvelHelperTest extends TestCase {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226     private static final Log LOG = LogFactory.getLog(MvelHelperTest.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229      * Test that a blank rule is true.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231     public void testBlankRule() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232         boolean result = MvelHelper.evaluateRule(&quot;&quot;, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237      * Test that a null rule is true.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239     public void testNullRule() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240         boolean result = MvelHelper.evaluateRule(null, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245      * Test rule with parse errors</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247     public void testRuleWithParseErrors() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248         MvelHelper.setTestMode(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249         boolean result = MvelHelper.evaluateRule(&quot;BadFunction(xyz)&quot;, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250         MvelHelper.setTestMode(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251         assertFalse(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255      * Test rule that evaluates to true</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257     public void testRuleThatEvaluatesToTrue() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258         // Locale used as an illustrative domain class only.  Any object could have been used.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259         Locale testLocale = new LocaleImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         testLocale.setLocaleCode(&quot;US&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263         parameters.put(&quot;locale&quot;, testLocale);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265         boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270      * Test rule that evaluates to true</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272     public void testRuleThatEvaluatesToFalse() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273         // Locale used as an illustrative domain class only.  Any object could have been used.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         Locale testLocale = new LocaleImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275         testLocale.setLocaleCode(&quot;GB&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278         parameters.put(&quot;locale&quot;, testLocale);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280         boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281         assertFalse(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285      * Tests MVEL syntax for accessing request property map values.   </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287     @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288     public void testRequestMapProperty() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289         BroadleafRequestContext.setBroadleafRequestContext(new BroadleafRequestContext());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290         RequestDTO dto = new RequestDTOImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291         dto.getProperties().put(&quot;blcSearchTerm&quot;, &quot;hot&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294         parameters.put(&quot;request&quot;, dto);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296         // If the &quot;key&quot; property doesn&#x27;t contain an underscore, the expression returns true</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 297         boolean result = MvelHelper.evaluateRule(&quot;request.properties[&#x27;blcSearchTerm&#x27;] == &#x27;hot&#x27;&quot;, parameters);"> 297         boolean result = MvelHelper.evaluateRule(&quot;request.properties[&#x27;blcSearchTerm&#x27;] == &#x27;hot&#x27;&quot;, parameteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302      * Confirms repeated success for method overload workaround in SelectizeCollectionUtils</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304     public void testMvelMethodOverloadWorkaroundCase() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305         //Test multiple iterations to make sure we no longer fail at all</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306         for (int j=0; j&lt;20; j++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307             String output = executeExternalJavaProcess(MvelOverloadWorkaroundReproduction.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308             assertEquals(&quot;true&quot;, output);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311     </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312     protected String executeExternalJavaProcess(Class&lt;?&gt; mainClass) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313         String classpath = MvelTestUtils.getClassPath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314         </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 315         //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the test in a new JVM"> 315         //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the teðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316         CommandLine cmdLine = new CommandLine(&quot;java&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317         cmdLine.addArgument(&quot;-cp&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318         cmdLine.addArgument(classpath, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319         cmdLine.addArgument(mainClass.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321         ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322         Executor executor = new DefaultExecutor();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323         executor.setStreamHandler(new PumpStreamHandler(baos));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325             executor.execute(cmdLine, new HashMap&lt;String, String&gt;());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326         } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327             throw new IOException(new String(baos.toByteArray()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329         return new String(baos.toByteArray());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331 }</span>
 332 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; MINE
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   3 /*</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   4  * #%L</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   5  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   6  * %%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   7  * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   8  * %%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">   9  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  10  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  11  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  12  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  13  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  14  * shall apply.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  15  *</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  16  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  16  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="  17  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  17  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  18  * #L%</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  19  */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  20 package org.broadleafcommerce.common.rule;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  21 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  22 import org.apache.commons.exec.CommandLine;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  23 import org.apache.commons.exec.DefaultExecutor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  24 import org.apache.commons.exec.Executor;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.apache.commons.exec.PumpStreamHandler;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  26 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  27 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  28 import org.broadleafcommerce.common.RequestDTO;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  29 import org.broadleafcommerce.common.RequestDTOImpl;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  30 import org.broadleafcommerce.common.locale.domain.Locale;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  31 import org.broadleafcommerce.common.locale.domain.LocaleImpl;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  32 import org.broadleafcommerce.common.web.BroadleafRequestContext;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  33 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  34 import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  35 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  36 import java.util.HashMap;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  37 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  38 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  39 import junit.framework.TestCase;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  40 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  41 public class MvelHelperTest extends TestCase {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  42 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  43     private static final Log LOG = LogFactory.getLog(MvelHelperTest.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  44 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  45     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  46      * Test that a blank rule is true.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  47      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  48     public void testBlankRule() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  49         boolean result = MvelHelper.evaluateRule(&quot;&quot;, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  50         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  51     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  52 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  53     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  54      * Test that a null rule is true.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  55      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  56     public void testNullRule() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  57         boolean result = MvelHelper.evaluateRule(null, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  58         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  59     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  60 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  61     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  62      * Test rule with parse errors</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  63      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  64     public void testRuleWithParseErrors() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  65         MvelHelper.setTestMode(true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  66         boolean result = MvelHelper.evaluateRule(&quot;BadFunction(xyz)&quot;, null);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  67         MvelHelper.setTestMode(false);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  68         assertFalse(result);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  69     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  70 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  71     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  72      * Test rule that evaluates to true</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  73      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  74     public void testRuleThatEvaluatesToTrue() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  75         // Locale used as an illustrative domain class only.  Any object could have been used.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  76         Locale testLocale = new LocaleImpl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  77         testLocale.setLocaleCode(&quot;US&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  78 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  79         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  80         parameters.put(&quot;locale&quot;, testLocale);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  82         boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  83         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  84     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  85 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  86     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  87      * Test rule that evaluates to true</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  88      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  89     public void testRuleThatEvaluatesToFalse() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  90         // Locale used as an illustrative domain class only.  Any object could have been used.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  91         Locale testLocale = new LocaleImpl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  92         testLocale.setLocaleCode(&quot;GB&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  93 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  94         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  95         parameters.put(&quot;locale&quot;, testLocale);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  97         boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  98         assertFalse(result);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  99     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 100 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 101     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 102      * Tests MVEL syntax for accessing request property map values.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 103      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 104     @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 105     public void testRequestMapProperty() {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 106         BroadleafRequestContext.setBroadleafRequestContext(new BroadleafRequestContext());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 107         RequestDTO dto = new RequestDTOImpl();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 108         dto.getProperties().put(&quot;blcSearchTerm&quot;, &quot;hot&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 109 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 110         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 111         parameters.put(&quot;request&quot;, dto);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 112 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 113         // If the &quot;key&quot; property doesn&#x27;t contain an underscore, the expression returns true</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 114         boolean result = MvelHelper.evaluateRule(&quot;request.properties[&#x27;blcSearchTerm&#x27;] == &#x27;hot&#x27;&quot;, parameters);"> 114         boolean result = MvelHelper.evaluateRule(&quot;request.properties[&#x27;blcSearchTerm&#x27;] == &#x27;hot&#x27;&quot;, parameteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 115         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 116     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 117 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 118     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 119      * Confirms MVEL failure for special overloaded method case.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 120      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 121      * During compilation, if an mvel expression contains a method calls with params, mvel will attempt to identify a perfect"> 121      * During compilation, if an mvel expression contains a method calls with params, mvel will attempt tðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 122      * method signature match based on the types of the params. However, if the method is overloaded and one or more of"> 122      * method signature match based on the types of the params. However, if the method is overloaded and ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 123      * the params are null, mvel will not be able to 100% identify the right method version if the overloaded methods"> 123      * the params are null, mvel will not be able to 100% identify the right method version if the overloðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 124      * have the same quantity of params and have type overlap. Take this example:</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 125      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 126      * {@code SelectizeCollectionUtils#intersection(String param, Iterable param2);}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 127      * {@code SelectizeCollectionUtils#intersection(Iterable param, Iterable param2);}</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 128      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 129      * If a rule is executed calling the intersection method and a null is passed in for the first parameter, mvel will"> 129      * If a rule is executed calling the intersection method and a null is passed in for the first parameðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 130      * not know which method to pick, so it will end up picking one of them. This has proven to be undetermined at runtime,"> 130      * not know which method to pick, so it will end up picking one of them. This has proven to be undeteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 131      * which has made the problem even harder to identify. Furthermore, once the choice is made during compilation,"> 131      * which has made the problem even harder to identify. Furthermore, once the choice is made during coðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 132      * that compiled expression will utilize the &quot;incorrect&quot; choice going forward, which will cause the expression to"> 132      * that compiled expression will utilize the &quot;incorrect&quot; choice going forward, which will cause the eðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 133      * fail, even when neither param is null. In fact, in the case above, mvel will &quot;coerce&quot; the first param Iterable"> 133      * fail, even when neither param is null. In fact, in the case above, mvel will &quot;coerce&quot; the first paðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 134      * instance into a String (i.e. flatten the list representation into a comma delimited String) in order to continue"> 134      * instance into a String (i.e. flatten the list representation into a comma delimited String) in ordðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 135      * calling the method identified during compilation. This causes the expression to permanently be in an incorrect"> 135      * calling the method identified during compilation. This causes the expression to permanently be in ðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 136      * state from which it will never recover.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 137      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 138     public void testMvelMethodOverloadFailureCase() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 139         //Test multiple iterations to make sure we hit the undetermined ordering case we need to confirm</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 140         String output = &quot;&quot;;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 141         for (int j=0; j&lt;100; j++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 142             output = executeExternalJavaProcess(MvelOverloadFailureReproduction.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 143             boolean result = Boolean.valueOf(output.trim());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 144             if (result) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 145                 //We found the case. Exit the loop, since we don&#x27;t need to try anymore.</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 146                 break;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 147             }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 148         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 149         assertEquals(&quot;true&quot;, output);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 150     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 151 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 152     /**</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 153      * Confirms repeated success for method overload workaround in SelectizeCollectionUtils</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 154      * &lt;/p&gt;</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 155      * See {@link #testMvelMethodOverloadFailureCase()} for a more complete description of the problem case."> 155      * See {@link #testMvelMethodOverloadFailureCase()} for a more complete description of the problem caðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 156      */</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 157     public void testMvelMethodOverloadWorkaroundCase() throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 158         //Test multiple iterations to make sure we no longer fail at all</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 159         for (int j=0; j&lt;20; j++) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 160             String output = executeExternalJavaProcess(MvelOverloadWorkaroundReproduction.class);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 161             assertEquals(&quot;true&quot;, output);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 162         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 163     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 164 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 165     protected String executeExternalJavaProcess(Class&lt;?&gt; mainClass) throws IOException {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 166         String classpath = MvelTestUtils.getClassPath();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 167 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title=" 168         //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the test in a new JVM"> 168         //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the teðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 169         CommandLine cmdLine = new CommandLine(&quot;java&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 170         cmdLine.addArgument(&quot;-cp&quot;);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 171         cmdLine.addArgument(classpath, true);</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 172         cmdLine.addArgument(mainClass.getName());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 173 </span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 174         ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 175         Executor executor = new DefaultExecutor();</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 176         executor.setStreamHandler(new PumpStreamHandler(baos));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 177         try {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 178             executor.execute(cmdLine, new HashMap&lt;String, String&gt;());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 179         } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 180             throw new IOException(new String(baos.toByteArray()));</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 181         }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 182         return new String(baos.toByteArray());</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 183     }</span>
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"> 184 }</span>
 185 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 186 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 187  * #%L</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 188  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 189  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 190  * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 191  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 192  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 193  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 194  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 195  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 196  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 197  * shall apply.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 198  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 199  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)"> 199  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 200  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license."> 200  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 201  * #L%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 202  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 203 package org.broadleafcommerce.common.rule;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 204 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 205 import org.apache.commons.exec.CommandLine;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 206 import org.apache.commons.exec.DefaultExecutor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 207 import org.apache.commons.exec.Executor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 208 import org.apache.commons.exec.PumpStreamHandler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 209 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 210 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 211 import org.broadleafcommerce.common.RequestDTO;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 212 import org.broadleafcommerce.common.RequestDTOImpl;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 213 import org.broadleafcommerce.common.locale.domain.Locale;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 214 import org.broadleafcommerce.common.locale.domain.LocaleImpl;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 215 import org.broadleafcommerce.common.web.BroadleafRequestContext;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 216 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 217 import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 218 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 219 import java.util.HashMap;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 220 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 221 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 222 import junit.framework.TestCase;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 223 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 224 public class MvelHelperTest extends TestCase {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 225 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 226     private static final Log LOG = LogFactory.getLog(MvelHelperTest.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 227 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 228     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 229      * Test that a blank rule is true.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 230      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 231     public void testBlankRule() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 232         boolean result = MvelHelper.evaluateRule(&quot;&quot;, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 233         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 234     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 235 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 236     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 237      * Test that a null rule is true.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 238      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 239     public void testNullRule() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 240         boolean result = MvelHelper.evaluateRule(null, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 241         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 242     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 243 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 244     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 245      * Test rule with parse errors</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 246      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 247     public void testRuleWithParseErrors() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 248         MvelHelper.setTestMode(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 249         boolean result = MvelHelper.evaluateRule(&quot;BadFunction(xyz)&quot;, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 250         MvelHelper.setTestMode(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 251         assertFalse(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 252     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 253 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 254     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 255      * Test rule that evaluates to true</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 256      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 257     public void testRuleThatEvaluatesToTrue() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 258         // Locale used as an illustrative domain class only.  Any object could have been used.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 259         Locale testLocale = new LocaleImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 260         testLocale.setLocaleCode(&quot;US&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 261 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 262         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 263         parameters.put(&quot;locale&quot;, testLocale);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 264 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 265         boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 266         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 267     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 268 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 269     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 270      * Test rule that evaluates to true</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 271      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 272     public void testRuleThatEvaluatesToFalse() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 273         // Locale used as an illustrative domain class only.  Any object could have been used.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 274         Locale testLocale = new LocaleImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 275         testLocale.setLocaleCode(&quot;GB&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 276 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 277         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 278         parameters.put(&quot;locale&quot;, testLocale);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 279 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 280         boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 281         assertFalse(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 282     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 283 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 284     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 285      * Tests MVEL syntax for accessing request property map values.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 286      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 287     @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 288     public void testRequestMapProperty() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 289         BroadleafRequestContext.setBroadleafRequestContext(new BroadleafRequestContext());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 290         RequestDTO dto = new RequestDTOImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 291         dto.getProperties().put(&quot;blcSearchTerm&quot;, &quot;hot&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 292 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 293         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 294         parameters.put(&quot;request&quot;, dto);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 295 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 296         // If the &quot;key&quot; property doesn&#x27;t contain an underscore, the expression returns true</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 297         boolean result = MvelHelper.evaluateRule(&quot;request.properties[&#x27;blcSearchTerm&#x27;] == &#x27;hot&#x27;&quot;, parameters);"> 297         boolean result = MvelHelper.evaluateRule(&quot;request.properties[&#x27;blcSearchTerm&#x27;] == &#x27;hot&#x27;&quot;, parameteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 298         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 299     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 300 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 301     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 302      * Confirms repeated success for method overload workaround in SelectizeCollectionUtils</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 303      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 304     public void testMvelMethodOverloadWorkaroundCase() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 305         //Test multiple iterations to make sure we no longer fail at all</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 306         for (int j=0; j&lt;20; j++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 307             String output = executeExternalJavaProcess(MvelOverloadWorkaroundReproduction.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 308             assertEquals(&quot;true&quot;, output);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 309         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 310     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 311 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 312     protected String executeExternalJavaProcess(Class&lt;?&gt; mainClass) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 313         String classpath = MvelTestUtils.getClassPath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 314 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 315         //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the test in a new JVM"> 315         //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the teðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 316         CommandLine cmdLine = new CommandLine(&quot;java&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 317         cmdLine.addArgument(&quot;-cp&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 318         cmdLine.addArgument(classpath, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 319         cmdLine.addArgument(mainClass.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 320 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 321         ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 322         Executor executor = new DefaultExecutor();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 323         executor.setStreamHandler(new PumpStreamHandler(baos));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 324         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 325             executor.execute(cmdLine, new HashMap&lt;String, String&gt;());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 326         } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 327             throw new IOException(new String(baos.toByteArray()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 328         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 329         return new String(baos.toByteArray());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 330     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 331 }</span>
 332 &gt;&gt;&gt;&gt;&gt;&gt;&gt; YOURS</pre></td>
                            <td><pre>   1 &lt;&lt;&lt;&lt;&lt;&lt;&lt; LEFT
   2 ||||||| BASE
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0"><abbr title="   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwohrp23k5b6vdk93d3r*/">   3 /*d94z9sk0k4hf9j3ijd - note the base isn&#x27;t actually empty, spork simply doesn&#x27;t generate a base - gd930kwðŸ”µ</abbr></span>
   4 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   5 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   6 /*</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   7  * #%L</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   8  * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">   9  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  10  * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  11  * %%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  12  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  13  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  14  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  15  * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  16  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  17  * shall apply.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  18  *</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  19  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  19  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title="  20  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  20  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  21  * #L%</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  22  */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  23 package org.broadleafcommerce.common.rule;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  24 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  25 import org.apache.commons.exec.CommandLine;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  26 import org.apache.commons.exec.DefaultExecutor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import org.apache.commons.exec.Executor;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  28 import org.apache.commons.exec.PumpStreamHandler;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  29 import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  30 import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  31 import org.broadleafcommerce.common.RequestDTO;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  32 import org.broadleafcommerce.common.RequestDTOImpl;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  33 import org.broadleafcommerce.common.locale.domain.Locale;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  34 import org.broadleafcommerce.common.locale.domain.LocaleImpl;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  35 import org.broadleafcommerce.common.web.BroadleafRequestContext;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  36 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  37 import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  38 import java.io.IOException;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  39 import java.util.HashMap;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  40 import java.util.Map;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  41 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  42 import junit.framework.TestCase;</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  43 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  44 public class MvelHelperTest extends TestCase {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  45 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  46     private static final Log LOG = LogFactory.getLog(MvelHelperTest.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  47 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  48     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  49      * Test that a blank rule is true.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  50      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  51     public void testBlankRule() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  52         boolean result = MvelHelper.evaluateRule(&quot;&quot;, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  53         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  54     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  55 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  56     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  57      * Test that a null rule is true.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  58      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  59     public void testNullRule() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  60         boolean result = MvelHelper.evaluateRule(null, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  61         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  62     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  63 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  64     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  65      * Test rule with parse errors</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  66      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  67     public void testRuleWithParseErrors() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  68         MvelHelper.setTestMode(true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  69         boolean result = MvelHelper.evaluateRule(&quot;BadFunction(xyz)&quot;, null);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  70         MvelHelper.setTestMode(false);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  71         assertFalse(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  72     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  73 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  74     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  75      * Test rule that evaluates to true</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  76      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  77     public void testRuleThatEvaluatesToTrue() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  78         // Locale used as an illustrative domain class only.  Any object could have been used.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  79         Locale testLocale = new LocaleImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  80         testLocale.setLocaleCode(&quot;US&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  81 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  82         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  83         parameters.put(&quot;locale&quot;, testLocale);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  84 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  85         boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  86         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  87     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  88 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  89     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  90      * Test rule that evaluates to true</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  91      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  92     public void testRuleThatEvaluatesToFalse() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  93         // Locale used as an illustrative domain class only.  Any object could have been used.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  94         Locale testLocale = new LocaleImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  95         testLocale.setLocaleCode(&quot;GB&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  96 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  97         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  98         parameters.put(&quot;locale&quot;, testLocale);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  99 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 100         boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 101         assertFalse(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 102     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 103 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 104     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 105      * Tests MVEL syntax for accessing request property map values.</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 106      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 107     @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 108     public void testRequestMapProperty() {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 109         BroadleafRequestContext.setBroadleafRequestContext(new BroadleafRequestContext());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 110         RequestDTO dto = new RequestDTOImpl();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 111         dto.getProperties().put(&quot;blcSearchTerm&quot;, &quot;hot&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 112 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 113         Map parameters = new HashMap();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 114         parameters.put(&quot;request&quot;, dto);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 115 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 116         // If the &quot;key&quot; property doesn&#x27;t contain an underscore, the expression returns true</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 117         boolean result = MvelHelper.evaluateRule(&quot;request.properties[&#x27;blcSearchTerm&#x27;] == &#x27;hot&#x27;&quot;, parameters);"> 117         boolean result = MvelHelper.evaluateRule(&quot;request.properties[&#x27;blcSearchTerm&#x27;] == &#x27;hot&#x27;&quot;, parameteðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 118         assertTrue(result);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 119     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 120 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 121     /**</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 122      * Confirms repeated success for method overload workaround in SelectizeCollectionUtils</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 123      */</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 124     public void testMvelMethodOverloadWorkaroundCase() throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 125         //Test multiple iterations to make sure we no longer fail at all</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 126         for (int j=0; j&lt;20; j++) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 127             String output = executeExternalJavaProcess(MvelOverloadWorkaroundReproduction.class);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 128             assertEquals(&quot;true&quot;, output);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 129         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 130     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 131 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 132     protected String executeExternalJavaProcess(Class&lt;?&gt; mainClass) throws IOException {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 133         String classpath = MvelTestUtils.getClassPath();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 134 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"><abbr title=" 135         //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the test in a new JVM"> 135         //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the teðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 136         CommandLine cmdLine = new CommandLine(&quot;java&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 137         cmdLine.addArgument(&quot;-cp&quot;);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 138         cmdLine.addArgument(classpath, true);</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 139         cmdLine.addArgument(mainClass.getName());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 140 </span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 141         ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 142         Executor executor = new DefaultExecutor();</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 143         executor.setStreamHandler(new PumpStreamHandler(baos));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 144         try {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 145             executor.execute(cmdLine, new HashMap&lt;String, String&gt;());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 146         } catch (IOException e) {</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 147             throw new IOException(new String(baos.toByteArray()));</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 148         }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 149         return new String(baos.toByteArray());</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 150     }</span>
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0"> 151 }</span>
 152 &gt;&gt;&gt;&gt;&gt;&gt;&gt; RIGHT
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre><span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   1 -/*</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   2 - * #%L</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   3 - * BroadleafCommerce Common Libraries</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   4 - * %%</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   5 - * Copyright (C) 2009 - 2016 Broadleaf Commerce</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   6 - * %%</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   7 - * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   8 - * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">   9 - * unless the restrictions on use therein are violated and require payment to Broadleaf in which case</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  10 - * the Broadleaf End User License Agreement (EULA), Version 1.1</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  11 - * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  12 - * shall apply.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  13 - *</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title="  14 - * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14 - * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  15 - * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  16 - * #L%</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  17 - */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  18 -package org.broadleafcommerce.common.rule;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  19 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  20 -import org.apache.commons.exec.CommandLine;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  21 -import org.apache.commons.exec.DefaultExecutor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  22 -import org.apache.commons.exec.Executor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  23 -import org.apache.commons.exec.PumpStreamHandler;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  24 -import org.apache.commons.logging.Log;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  25 -import org.apache.commons.logging.LogFactory;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.broadleafcommerce.common.RequestDTO;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.broadleafcommerce.common.RequestDTOImpl;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import org.broadleafcommerce.common.locale.domain.Locale;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  29 -import org.broadleafcommerce.common.locale.domain.LocaleImpl;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  30 -import org.broadleafcommerce.common.web.BroadleafRequestContext;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  31 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  32 -import java.io.ByteArrayOutputStream;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  33 -import java.io.IOException;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  34 -import java.util.HashMap;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  35 -import java.util.Map;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  36 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  37 -import junit.framework.TestCase;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  38 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  39 -public class MvelHelperTest extends TestCase {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  40 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  41 -    private static final Log LOG = LogFactory.getLog(MvelHelperTest.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  42 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  43 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  44 -     * Test that a blank rule is true.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  45 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  46 -    public void testBlankRule() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  47 -        boolean result = MvelHelper.evaluateRule(&quot;&quot;, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  48 -        assertTrue(result);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  49 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  50 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  51 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  52 -     * Test that a null rule is true.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  53 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  54 -    public void testNullRule() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  55 -        boolean result = MvelHelper.evaluateRule(null, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  56 -        assertTrue(result);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  57 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  58 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  59 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  60 -     * Test rule with parse errors</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  61 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  62 -    public void testRuleWithParseErrors() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  63 -        MvelHelper.setTestMode(true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  64 -        boolean result = MvelHelper.evaluateRule(&quot;BadFunction(xyz)&quot;, null);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  65 -        MvelHelper.setTestMode(false);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  66 -        assertFalse(result);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  67 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  68 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  69 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  70 -     * Test rule that evaluates to true</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  71 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  72 -    public void testRuleThatEvaluatesToTrue() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  73 -        // Locale used as an illustrative domain class only.  Any object could have been used.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  74 -        Locale testLocale = new LocaleImpl();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  75 -        testLocale.setLocaleCode(&quot;US&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  76 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  77 -        Map parameters = new HashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  78 -        parameters.put(&quot;locale&quot;, testLocale);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  79 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  80 -        boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  81 -        assertTrue(result);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  82 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  83 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  84 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  85 -     * Test rule that evaluates to true</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  86 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  87 -    public void testRuleThatEvaluatesToFalse() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  88 -        // Locale used as an illustrative domain class only.  Any object could have been used.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  89 -        Locale testLocale = new LocaleImpl();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  90 -        testLocale.setLocaleCode(&quot;GB&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  91 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  92 -        Map parameters = new HashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  93 -        parameters.put(&quot;locale&quot;, testLocale);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  94 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -        boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  96 -        assertFalse(result);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  97 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  98 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  99 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 100 -     * Tests MVEL syntax for accessing request property map values.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 101 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 102 -    @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 103 -    public void testRequestMapProperty() {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 104 -        BroadleafRequestContext.setBroadleafRequestContext(new BroadleafRequestContext());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 105 -        RequestDTO dto = new RequestDTOImpl();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 106 -        dto.getProperties().put(&quot;blcSearchTerm&quot;, &quot;hot&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 107 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 108 -        Map parameters = new HashMap();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 109 -        parameters.put(&quot;request&quot;, dto);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 110 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 111 -        // If the &quot;key&quot; property doesn&#x27;t contain an underscore, the expression returns true</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 112 -        boolean result = MvelHelper.evaluateRule(&quot;request.properties[&#x27;blcSearchTerm&#x27;] == &#x27;hot&#x27;&quot;, parameters);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 113 -        assertTrue(result);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 114 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 115 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 116 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -     * Confirms MVEL failure for special overloaded method case.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -     * &lt;/p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 119 -     * During compilation, if an mvel expression contains a method calls with params, mvel will attempt to identify a perfect"> 119 -     * During compilation, if an mvel expression contains a method calls with params, mvel will attempt to identifðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 120 -     * method signature match based on the types of the params. However, if the method is overloaded and one or more of"> 120 -     * method signature match based on the types of the params. However, if the method is overloaded and one or moðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 121 -     * the params are null, mvel will not be able to 100% identify the right method version if the overloaded methods"> 121 -     * the params are null, mvel will not be able to 100% identify the right method version if the overloaded methðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -     * have the same quantity of params and have type overlap. Take this example:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -     * &lt;/p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -     * {@code SelectizeCollectionUtils#intersection(String param, Iterable param2);}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -     * {@code SelectizeCollectionUtils#intersection(Iterable param, Iterable param2);}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -     * &lt;/p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 127 -     * If a rule is executed calling the intersection method and a null is passed in for the first parameter, mvel will"> 127 -     * If a rule is executed calling the intersection method and a null is passed in for the first parameter, mvelðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 128 -     * not know which method to pick, so it will end up picking one of them. This has proven to be undetermined at runtime,"> 128 -     * not know which method to pick, so it will end up picking one of them. This has proven to be undetermined atðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 129 -     * which has made the problem even harder to identify. Furthermore, once the choice is made during compilation,"> 129 -     * which has made the problem even harder to identify. Furthermore, once the choice is made during compilationðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 130 -     * that compiled expression will utilize the &quot;incorrect&quot; choice going forward, which will cause the expression to"> 130 -     * that compiled expression will utilize the &quot;incorrect&quot; choice going forward, which will cause the expressionðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 131 -     * fail, even when neither param is null. In fact, in the case above, mvel will &quot;coerce&quot; the first param Iterable"> 131 -     * fail, even when neither param is null. In fact, in the case above, mvel will &quot;coerce&quot; the first param IteraðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 132 -     * instance into a String (i.e. flatten the list representation into a comma delimited String) in order to continue"> 132 -     * instance into a String (i.e. flatten the list representation into a comma delimited String) in order to conðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 133 -     * calling the method identified during compilation. This causes the expression to permanently be in an incorrect"> 133 -     * calling the method identified during compilation. This causes the expression to permanently be in an incorrðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -     * state from which it will never recover.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -    public void testMvelMethodOverloadFailureCase() throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -        //Test multiple iterations to make sure we hit the undetermined ordering case we need to confirm</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        String output = &quot;&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -        for (int j=0; j&lt;100; j++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -            output = executeExternalJavaProcess(MvelOverloadFailureReproduction.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -            boolean result = Boolean.valueOf(output.trim());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -            if (result) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -                //We found the case. Exit the loop, since we don&#x27;t need to try anymore.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -        assertEquals(&quot;true&quot;, output);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -    /**</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -     * Confirms repeated success for method overload workaround in SelectizeCollectionUtils</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -     * &lt;/p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -     * See {@link #testMvelMethodOverloadFailureCase()} for a more complete description of the problem case.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 154 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -    public void testMvelMethodOverloadWorkaroundCase() throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 156 -        //Test multiple iterations to make sure we no longer fail at all</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 157 -        for (int j=0; j&lt;20; j++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 158 -            String output = executeExternalJavaProcess(MvelOverloadWorkaroundReproduction.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -            assertEquals(&quot;true&quot;, output);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 161 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 162 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 163 -    protected String executeExternalJavaProcess(Class&lt;?&gt; mainClass) throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 164 -        String classpath = MvelTestUtils.getClassPath();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 165 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 166 -        //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the test in a new JVM"> 166 -        //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the test in a nðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 167 -        CommandLine cmdLine = new CommandLine(&quot;java&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 168 -        cmdLine.addArgument(&quot;-cp&quot;);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 169 -        cmdLine.addArgument(classpath, true);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 170 -        cmdLine.addArgument(mainClass.getName());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 171 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 172 -        ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 173 -        Executor executor = new DefaultExecutor();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 174 -        executor.setStreamHandler(new PumpStreamHandler(baos));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 175 -        try {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 176 -            executor.execute(cmdLine, new HashMap&lt;String, String&gt;());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 177 -        } catch (IOException e) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 178 -            throw new IOException(new String(baos.toByteArray()));</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 179 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 180 -        return new String(baos.toByteArray());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 181 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 182 -}</span></pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.rule;
  19  
  20  import org.apache.commons.exec.CommandLine;
  21  import org.apache.commons.exec.DefaultExecutor;
  22  import org.apache.commons.exec.Executor;
  23  import org.apache.commons.exec.PumpStreamHandler;
  24  import org.apache.commons.logging.Log;
  25  import org.apache.commons.logging.LogFactory;
  26  import org.broadleafcommerce.common.RequestDTO;
  27  import org.broadleafcommerce.common.RequestDTOImpl;
  28  import org.broadleafcommerce.common.locale.domain.Locale;
  29  import org.broadleafcommerce.common.locale.domain.LocaleImpl;
  30  import org.broadleafcommerce.common.web.BroadleafRequestContext;
  31  
  32  import java.io.ByteArrayOutputStream;
  33  import java.io.IOException;
  34  import java.util.HashMap;
  35  import java.util.Map;
  36  
  37  import junit.framework.TestCase;
  38  
  39  public class MvelHelperTest extends TestCase {
  40  
  41      private static final Log LOG = LogFactory.getLog(MvelHelperTest.class);
  42  
  43      /**
  44       * Test that a blank rule is true.
  45       */
  46      public void testBlankRule() {
  47          boolean result = MvelHelper.evaluateRule(&quot;&quot;, null);
  48          assertTrue(result);
  49      }
  50  
  51      /**
  52       * Test that a null rule is true.
  53       */
  54      public void testNullRule() {
  55          boolean result = MvelHelper.evaluateRule(null, null);
  56          assertTrue(result);
  57      }
  58  
  59      /**
  60       * Test rule with parse errors
  61       */
  62      public void testRuleWithParseErrors() {
  63          MvelHelper.setTestMode(true);
  64          boolean result = MvelHelper.evaluateRule(&quot;BadFunction(xyz)&quot;, null);
  65          MvelHelper.setTestMode(false);
  66          assertFalse(result);
  67      }
  68  
  69      /**
  70       * Test rule that evaluates to true
  71       */
  72      public void testRuleThatEvaluatesToTrue() {
  73          // Locale used as an illustrative domain class only.  Any object could have been used.
  74          Locale testLocale = new LocaleImpl();
  75          testLocale.setLocaleCode(&quot;US&quot;);
  76  
  77          Map parameters = new HashMap();
  78          parameters.put(&quot;locale&quot;, testLocale);
  79  
  80          boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);
  81          assertTrue(result);
  82      }
  83  
  84      /**
  85       * Test rule that evaluates to true
  86       */
  87      public void testRuleThatEvaluatesToFalse() {
  88          // Locale used as an illustrative domain class only.  Any object could have been used.
  89          Locale testLocale = new LocaleImpl();
  90          testLocale.setLocaleCode(&quot;GB&quot;);
  91  
  92          Map parameters = new HashMap();
  93          parameters.put(&quot;locale&quot;, testLocale);
  94  
  95          boolean result = MvelHelper.evaluateRule(&quot;locale.localeCode == &#x27;US&#x27;&quot;, parameters);
  96          assertFalse(result);
  97      }
  98  
  99      /**
 100       * Tests MVEL syntax for accessing request property map values.
 101       */
 102      @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
 103      public void testRequestMapProperty() {
 104          BroadleafRequestContext.setBroadleafRequestContext(new BroadleafRequestContext());
 105          RequestDTO dto = new RequestDTOImpl();
 106          dto.getProperties().put(&quot;blcSearchTerm&quot;, &quot;hot&quot;);
 107  
 108          Map parameters = new HashMap();
 109          parameters.put(&quot;request&quot;, dto);
 110  
 111          // If the &quot;key&quot; property doesn&#x27;t contain an underscore, the expression returns true
 112          boolean result = MvelHelper.evaluateRule(&quot;request.properties[&#x27;blcSearchTerm&#x27;] == &#x27;hot&#x27;&quot;, parameters);
 113          assertTrue(result);
 114      }
 115  
 116      /**
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 117 -     * Confirms MVEL failure for special overloaded method case.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 118 -     * &lt;/p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 119 -     * During compilation, if an mvel expression contains a method calls with params, mvel will attempt to identify a perfect"> 119 -     * During compilation, if an mvel expression contains a method calls with params, mvel will attempt to identifðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 120 -     * method signature match based on the types of the params. However, if the method is overloaded and one or more of"> 120 -     * method signature match based on the types of the params. However, if the method is overloaded and one or moðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 121 -     * the params are null, mvel will not be able to 100% identify the right method version if the overloaded methods"> 121 -     * the params are null, mvel will not be able to 100% identify the right method version if the overloaded methðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 122 -     * have the same quantity of params and have type overlap. Take this example:</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 123 -     * &lt;/p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 124 -     * {@code SelectizeCollectionUtils#intersection(String param, Iterable param2);}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 125 -     * {@code SelectizeCollectionUtils#intersection(Iterable param, Iterable param2);}</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 126 -     * &lt;/p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 127 -     * If a rule is executed calling the intersection method and a null is passed in for the first parameter, mvel will"> 127 -     * If a rule is executed calling the intersection method and a null is passed in for the first parameter, mvelðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 128 -     * not know which method to pick, so it will end up picking one of them. This has proven to be undetermined at runtime,"> 128 -     * not know which method to pick, so it will end up picking one of them. This has proven to be undetermined atðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 129 -     * which has made the problem even harder to identify. Furthermore, once the choice is made during compilation,"> 129 -     * which has made the problem even harder to identify. Furthermore, once the choice is made during compilationðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 130 -     * that compiled expression will utilize the &quot;incorrect&quot; choice going forward, which will cause the expression to"> 130 -     * that compiled expression will utilize the &quot;incorrect&quot; choice going forward, which will cause the expressionðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 131 -     * fail, even when neither param is null. In fact, in the case above, mvel will &quot;coerce&quot; the first param Iterable"> 131 -     * fail, even when neither param is null. In fact, in the case above, mvel will &quot;coerce&quot; the first param IteraðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 132 -     * instance into a String (i.e. flatten the list representation into a comma delimited String) in order to continue"> 132 -     * instance into a String (i.e. flatten the list representation into a comma delimited String) in order to conðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 133 -     * calling the method identified during compilation. This causes the expression to permanently be in an incorrect"> 133 -     * calling the method identified during compilation. This causes the expression to permanently be in an incorrðŸ”µ</abbr></span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 134 -     * state from which it will never recover.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 135 -     */</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 136 -    public void testMvelMethodOverloadFailureCase() throws IOException {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 137 -        //Test multiple iterations to make sure we hit the undetermined ordering case we need to confirm</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 138 -        String output = &quot;&quot;;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 139 -        for (int j=0; j&lt;100; j++) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 140 -            output = executeExternalJavaProcess(MvelOverloadFailureReproduction.class);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 141 -            boolean result = Boolean.valueOf(output.trim());</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 142 -            if (result) {</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -                //We found the case. Exit the loop, since we don&#x27;t need to try anymore.</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 144 -                break;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 145 -            }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 146 -        }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 147 -        assertEquals(&quot;true&quot;, output);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 148 -    }</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 149 -</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 150 -    /**</span>
 151       * Confirms repeated success for method overload workaround in SelectizeCollectionUtils
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 152 -     * &lt;/p&gt;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 153 -     * See {@link #testMvelMethodOverloadFailureCase()} for a more complete description of the problem case.</span>
 154       */
 155      public void testMvelMethodOverloadWorkaroundCase() throws IOException {
 156          //Test multiple iterations to make sure we no longer fail at all
 157          for (int j=0; j&lt;20; j++) {
 158              String output = executeExternalJavaProcess(MvelOverloadWorkaroundReproduction.class);
 159              assertEquals(&quot;true&quot;, output);
 160          }
 161      }
 162  
 163      protected String executeExternalJavaProcess(Class&lt;?&gt; mainClass) throws IOException {
 164          String classpath = MvelTestUtils.getClassPath();
 165  
<abbr title=" 166          //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the test in a new JVM"> 166          //See javadoc on MvelOverloadFailureReproduction for description of why we need to execute the test in a nðŸ”µ</abbr>
 167          CommandLine cmdLine = new CommandLine(&quot;java&quot;);
 168          cmdLine.addArgument(&quot;-cp&quot;);
 169          cmdLine.addArgument(classpath, true);
 170          cmdLine.addArgument(mainClass.getName());
 171  
 172          ByteArrayOutputStream baos = new ByteArrayOutputStream();
 173          Executor executor = new DefaultExecutor();
 174          executor.setStreamHandler(new PumpStreamHandler(baos));
 175          try {
 176              executor.execute(cmdLine, new HashMap&lt;String, String&gt;());
 177          } catch (IOException e) {
 178              throw new IOException(new String(baos.toByteArray()));
 179          }
 180          return new String(baos.toByteArray());
 181      }
 182  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            