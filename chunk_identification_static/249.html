<!DOCTYPE html>
    <html lang="en">
              <head>
                <meta charset="utf-8">
                <title>249</title>
                    <style>
                        #top {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        #bottom {
                            height: 48vh;
                            overflow-y: auto;
                        }
                        abbr {
                          /* Here is the delay */
                          transition-delay:0s;
                        }
                    </style>
              </head>
              <body>
                <span style="height: 4vh">
                    249
                    <a href="248.html">prev</a>
                    <a href="250.html">next</a>
                    <a href="249_chunks.html">chunks</a>
                    <a href="index.html">index</a>
                    BroadleafCommerce/BroadleafCommerce_554ea5b4035b96dd4dac516fdadc9500e4b92fe9_common/src/main/java/org/broadleafcommerce/common/util/UpdateExecutor.java
                    <textarea rows=1 onclick='navigator.clipboard.writeText(this.value)'>cd C:\studies\se\mega\git-analyzer-plus\notebooks\debug
del /Q *
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;554ea5b4035b96dd4dac516fdadc9500e4b92fe9:common/src/main/java/org/broadleafcommerce/common/util/UpdateExecutor.java&quot; &gt; committed.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;554ea5b4035b96dd4dac516fdadc9500e4b92fe9^1:common/src/main/java/org/broadleafcommerce/common/util/UpdateExecutor.java&quot; &gt; ours.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;554ea5b4035b96dd4dac516fdadc9500e4b92fe9^2:common/src/main/java/org/broadleafcommerce/common/util/UpdateExecutor.java&quot; &gt; theirs.java
git -C C:\studies\se\mega\project-dirs\projects_Java_desc-stars-1000\BroadleafCommerce\BroadleafCommerce show &quot;c4f68102688a41a40ca1a6acc67b091c49f8d5e4:common/src/main/java/org/broadleafcommerce/common/util/UpdateExecutor.java&quot; &gt; base.java
copy ours.java 1ours.java
copy ours.java 2ours.java
copy theirs.java 1theirs.java
copy theirs.java 2theirs.java
copy base.java 1base.java
copy base.java 2base.java
&quot;C:\Program Files\Java\jdk1.8.0_241\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\jFSTMerge\build\libs\jFSTMerge-all.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\1theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\jfstmerge.java --show-base
&quot;C:\Program Files\Eclipse Adoptium\jdk-17.0.11.9-hotspot\bin\java.exe&quot; -Dfile.encoding=UTF-8 -jar &quot;C:\studies\se\spork\target\spork-0.5.0-SNAPSHOT.jar&quot; C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2ours.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2base.java C:\studies\se\mega\git-analyzer-plus\notebooks\debug\2theirs.java -o C:\studies\se\mega\git-analyzer-plus\notebooks\debug\spork.java
del /Q 1*.java
del /Q 2*.java
del /Q jfstmerge.java.merge
</textarea>
                    {strict: [[b]], subset: [[b]]}
                </span>
                <div id="top">

                    <table>
                        <tr>
                            <th>line based (standard git)</th>
                            <th>jfstmerge</th>
                            <th>spork</th>
                        </tr>
                        <tr>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  * 
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.util;
  19 
  20 import org.apache.commons.lang.ArrayUtils;
  21 import org.apache.commons.lang3.StringUtils;
  22 &lt;&lt;&lt;&lt;&lt;&lt;&lt; GitAnalyzerPlus_ours
<span style="background-color: rgba(255, 167, 0, 0.24); margin: 0">  23 import org.broadleafcommerce.common.util.dao.HibernateMappingProvider;</span>
  24 ||||||| GitAnalyzerPlus_base
<span style="background-color: rgba(0, 0, 0, 0.15); margin: 0">  25 import org.hibernate.SQLQuery;</span>
  26 =======
<span style="background-color: rgba(0, 0, 255, 0.24); margin: 0">  27 import org.hibernate.FlushMode;</span>
  28 &gt;&gt;&gt;&gt;&gt;&gt;&gt; GitAnalyzerPlus_theirs
  29 import org.hibernate.SQLQuery;
  30 import org.hibernate.Session;
  31 import org.hibernate.cache.spi.UpdateTimestampsCache;
  32 import org.hibernate.engine.spi.CacheImplementor;
  33 import org.hibernate.engine.spi.SharedSessionContractImplementor;
  34 import org.hibernate.mapping.PersistentClass;
  35 import org.hibernate.type.Type;
  36 
  37 import java.io.Serializable;
  38 import java.util.ArrayList;
  39 import java.util.Arrays;
  40 import java.util.List;
  41 
  42 import javax.persistence.EntityManager;
  43 
  44 /**
<abbr title="  45  * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on Hibernate filtered">  45  * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updateðŸ”µ</abbr>
  46  * entities (such as sandboxable and multi-tenant entities).
  47  * &lt;/p&gt;
<abbr title="  48  * This class takes an interesting approach to the use of update queries. To explain, a bit of background is required.">  48  * This class takes an interesting approach to the use of update queries. To explain, a bit of backgroundðŸ”µ</abbr>
<abbr title="  49  * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs an HQL UPDATE">  49  * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it eðŸ”µ</abbr>
<abbr title="  50  * query. However, it will only create this temporary table when the target entity has Hibernate filters applied">  50  * query. However, it will only create this temporary table when the target entity has Hibernate filters ðŸ”µ</abbr>
<abbr title="  51  * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is used to">  51  * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectðŸ”µ</abbr>
<abbr title="  52  * populate the values. It is my understanding that this ends up creating some locks on the original table. Because of">  52  * populate the values. It is my understanding that this ends up creating some locks on the original tablðŸ”µ</abbr>
<abbr title="  53  * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to avoid">  53  * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to ðŸ”µ</abbr>
<abbr title="  54  * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) and then">  54  * the temporary table creation. We did this by first selecting for ids (so that the filters were still hðŸ”µ</abbr>
<abbr title="  55  * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needs to be basic">  55  * using a simple, native sql statement to execute the update on entities matching those ids. The native ðŸ”µ</abbr>
  56  * enough that itâ€™s portable across platforms.
  57  * &lt;/p&gt;
<abbr title="  58  * This class is responsible for building the native sql based on a template String. It does it in a way using a standard">  58  * This class is responsible for building the native sql based on a template String. It does it in a way ðŸ”µ</abbr>
<abbr title="  59  * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection exploit.">  59  * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection eðŸ”µ</abbr>
  60  * &lt;/p&gt;
<abbr title="  61  * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoid maximum">  61  * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoidðŸ”µ</abbr>
  62  * IN clause lengths enforced by some database platforms.
  63  *
  64  * @author Jeff Fischer
  65  */
  66 public class UpdateExecutor {
  67 
  68     /**
<abbr title="  69      * Perform an update query using a String template and params. Note, this is only intended for special">  69      * Perform an update query using a String template and params. Note, this is only intended for speciaðŸ”µ</abbr>
<abbr title="  70      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session">  70      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate SeðŸ”µ</abbr>
  71      * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
  72      * &lt;/p&gt;
<abbr title="  73      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;">  73      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEðŸ”µ</abbr>
  74      *
<abbr title="  75      * @deprecated Highly recommended not to use this method. This method results in global L2 cache region clearing. Use {@link #executeUpdateQuery(EntityManager, String, String, Object[], Type[], List)} instead.">  75      * @deprecated Highly recommended not to use this method. This method results in global L2 cache regiðŸ”µ</abbr>
  76      * @param em The entity manager to use for the persistence operation
<abbr title="  77      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.">  77      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;ðŸ”µ</abbr>
<abbr title="  78      * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null.">  78      * @param params any other params that are present in the sql template, other than the IN clause. ShoðŸ”µ</abbr>
<abbr title="  79      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null.">  79      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params.ðŸ”µ</abbr>
  80      * @param ids the ids to include in the IN clause.
  81      * @return the total number of records updated in the database
  82      */
  83     @Deprecated
<abbr title="  84     public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;Long&gt; ids) {">  84     public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] typesðŸ”µ</abbr>
  85         int response = 0;
  86         List&lt;Long[]&gt; runs = buildRuns(ids);
  87         for (Long[] run : runs) {
  88             String queryString = String.format(template, buildInClauseTemplate(run.length));
  89             SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);
  90             int counter = 0;
  91             if (!ArrayUtils.isEmpty(params)) {
  92                 for (Object param : params) {
  93                     query.setParameter(counter, param, types[counter]);
  94                     counter++;
  95                 }
  96             }
  97             for (Long id : run) {
  98                 query.setLong(counter, id);
  99                 counter++;
 100             }
 101             FlushMode mode = em.unwrap(Session.class).getFlushMode();
 102             em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);
 103             try {
 104                 response += query.executeUpdate();
 105             } finally {
 106                 em.unwrap(Session.class).setFlushMode(mode);
 107             }
 108         }
 109         return response;
 110     }
 111 
 112     /**
<abbr title=" 113      * Perform an update query using a String template and params. Note, this is only intended for special"> 113      * Perform an update query using a String template and params. Note, this is only intended for speciaðŸ”µ</abbr>
<abbr title=" 114      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session"> 114      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate SeðŸ”µ</abbr>
 115      * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
 116      * &lt;/p&gt;
<abbr title=" 117      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;"> 117      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEðŸ”µ</abbr>
 118      *
 119      * @param em The entity manager to use for the persistence operation
<abbr title=" 120      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;."> 120      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;ðŸ”µ</abbr>
<abbr title=" 121      * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate to limit the scope of cache region invalidation. Otherwise, if left null, Hibernate will invalidate every cache region, which is generally not desirable. An empty String can be used to signify that no region should be invalidated."> 121      * @param tableSpace optionally provide the table being impacted by this query. This value allows HibðŸ”µ</abbr>
<abbr title=" 122      * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null."> 122      * @param params any other params that are present in the sql template, other than the IN clause. ShoðŸ”µ</abbr>
<abbr title=" 123      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null."> 123      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params.ðŸ”µ</abbr>
 124      * @param ids the ids to include in the IN clause.
 125      * @return the total number of records updated in the database
 126      */
<abbr title=" 127     public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, Type[] types, List&lt;Long&gt; ids) {"> 127     public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] pðŸ”µ</abbr>
 128         int response = 0;
 129         List&lt;Long[]&gt; runs = buildRuns(ids);
 130         for (Long[] run : runs) {
 131             String queryString = String.format(template, buildInClauseTemplate(run.length));
 132             SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);
 133             //only check for null - an empty string is a valid value for tableSpace
 134             if (tableSpace != null) {
 135                 query.addSynchronizedQuerySpace(tableSpace);
 136             }
 137             int counter = 0;
 138             if (!ArrayUtils.isEmpty(params)) {
 139                 for (Object param : params) {
 140                     query.setParameter(counter, param, types[counter]);
 141                     counter++;
 142                 }
 143             }
 144             for (Long id : run) {
 145                 query.setLong(counter, id);
 146                 counter++;
 147             }
 148             FlushMode mode = em.unwrap(Session.class).getFlushMode();
 149             em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);
 150             try {
 151                 response += query.executeUpdate();
 152             } finally {
 153                 em.unwrap(Session.class).setFlushMode(mode);
 154             }
 155         }
 156         return response;
 157     }
 158 
 159     /**
 160      *
 161      * @param em
 162      * @param entityType
 163      * @param ids
 164      */
<abbr title=" 165     public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt; ids) {"> 165     public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt;ðŸ”µ</abbr>
 166         SharedSessionContractImplementor session = em.unwrap(SharedSessionContractImplementor.class);
 167         CacheImplementor hibernateCache = session.getFactory().getCache();
 168         for (Long id : ids) {
 169             hibernateCache.evictEntity(entityType, id);
 170         }
 171         //update the timestamp cache for the table so that queries will be refreshed
 172         PersistentClass metadata = HibernateMappingProvider.getMapping(entityType.getName());
 173         String tableName = metadata.getTable().getName();
 174         UpdateTimestampsCache timestampsCache = hibernateCache.getUpdateTimestampsCache();
 175         if (timestampsCache != null) {
 176             timestampsCache.invalidate(new Serializable[]{tableName}, session);
 177         }
 178     }
 179 
 180     /**
 181      * Quickly build up the sql IN clause template
 182      *
 183      * @param length
 184      * @return
 185      */
 186     private static String buildInClauseTemplate(int length) {
 187         String[] temp = new String[length];
 188         Arrays.fill(temp, &quot;?&quot;);
 189         return StringUtils.join(temp, &quot;,&quot;);
 190     }
 191 
 192     /**
 193      * This breaks up our IN clause into multiple runs of 800 or less in order
<abbr title=" 194      * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there are more"> 194      * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there arðŸ”µ</abbr>
 195      * than a 1000 entries in an sql IN clause).
 196      *
 197      * @param ids
 198      * @return
 199      */
 200     private static List&lt;Long[]&gt; buildRuns(List&lt;Long&gt; ids) {
 201         List&lt;Long[]&gt; runs = new ArrayList&lt;Long[]&gt;();
 202         Long[] all = ids.toArray(new Long[ids.size()]);
 203         int test = all.length;
 204         int pos = 0;
 205         boolean eof = false;
 206         while (!eof) {
 207             int arraySize;
 208             if (test &lt; 800) {
 209                 arraySize = test;
 210                 eof = true;
 211             } else {
 212                 arraySize = 800;
 213                 test -= arraySize;
 214                 if (test == 0) {
 215                     eof = true;
 216                 }
 217             }
 218             Long[] temp = new Long[arraySize];
 219             System.arraycopy(all, pos, temp, 0, arraySize);
 220             pos += arraySize;
 221             runs.add(temp);
 222         }
 223         return runs;
 224     }
 225 }</pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.util;
  19 
  20 import org.apache.commons.lang.ArrayUtils;
  21 import org.apache.commons.lang3.StringUtils;
  22 import org.broadleafcommerce.common.util.dao.HibernateMappingProvider;
  23 import org.hibernate.FlushMode;
  24 import org.hibernate.SQLQuery;
  25 import org.hibernate.Session;
  26 import org.hibernate.cache.spi.UpdateTimestampsCache;
  27 import org.hibernate.engine.spi.CacheImplementor;
  28 import org.hibernate.engine.spi.SharedSessionContractImplementor;
  29 import org.hibernate.mapping.PersistentClass;
  30 import org.hibernate.type.Type;
  31 
  32 import java.io.Serializable;
  33 import java.util.ArrayList;
  34 import java.util.Arrays;
  35 import java.util.List;
  36 
  37 import javax.persistence.EntityManager;
  38 
  39 /**
<abbr title="  40  * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on Hibernate filtered">  40  * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updateðŸ”µ</abbr>
  41  * entities (such as sandboxable and multi-tenant entities).
  42  * &lt;/p&gt;
<abbr title="  43  * This class takes an interesting approach to the use of update queries. To explain, a bit of background is required.">  43  * This class takes an interesting approach to the use of update queries. To explain, a bit of backgroundðŸ”µ</abbr>
<abbr title="  44  * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs an HQL UPDATE">  44  * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it eðŸ”µ</abbr>
<abbr title="  45  * query. However, it will only create this temporary table when the target entity has Hibernate filters applied">  45  * query. However, it will only create this temporary table when the target entity has Hibernate filters ðŸ”µ</abbr>
<abbr title="  46  * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is used to">  46  * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectðŸ”µ</abbr>
<abbr title="  47  * populate the values. It is my understanding that this ends up creating some locks on the original table. Because of">  47  * populate the values. It is my understanding that this ends up creating some locks on the original tablðŸ”µ</abbr>
<abbr title="  48  * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to avoid">  48  * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to ðŸ”µ</abbr>
<abbr title="  49  * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) and then">  49  * the temporary table creation. We did this by first selecting for ids (so that the filters were still hðŸ”µ</abbr>
<abbr title="  50  * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needs to be basic">  50  * using a simple, native sql statement to execute the update on entities matching those ids. The native ðŸ”µ</abbr>
  51  * enough that itâ€™s portable across platforms.
  52  * &lt;/p&gt;
<abbr title="  53  * This class is responsible for building the native sql based on a template String. It does it in a way using a standard">  53  * This class is responsible for building the native sql based on a template String. It does it in a way ðŸ”µ</abbr>
<abbr title="  54  * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection exploit.">  54  * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection eðŸ”µ</abbr>
  55  * &lt;/p&gt;
<abbr title="  56  * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoid maximum">  56  * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoidðŸ”µ</abbr>
  57  * IN clause lengths enforced by some database platforms.
  58  *
  59  * @author Jeff Fischer
  60  */
  61 public class UpdateExecutor {
  62 
  63     /**
<abbr title="  64      * Perform an update query using a String template and params. Note, this is only intended for special">  64      * Perform an update query using a String template and params. Note, this is only intended for speciaðŸ”µ</abbr>
<abbr title="  65      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session">  65      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate SeðŸ”µ</abbr>
  66      * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
  67      * &lt;/p&gt;
<abbr title="  68      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;">  68      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEðŸ”µ</abbr>
  69      *
<abbr title="  70      * @deprecated Highly recommended not to use this method. This method results in global L2 cache region clearing. Use {@link #executeUpdateQuery(EntityManager, String, String, Object[], Type[], List)} instead.">  70      * @deprecated Highly recommended not to use this method. This method results in global L2 cache regiðŸ”µ</abbr>
  71      * @param em The entity manager to use for the persistence operation
<abbr title="  72      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.">  72      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;ðŸ”µ</abbr>
<abbr title="  73      * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null.">  73      * @param params any other params that are present in the sql template, other than the IN clause. ShoðŸ”µ</abbr>
<abbr title="  74      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null.">  74      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params.ðŸ”µ</abbr>
  75      * @param ids the ids to include in the IN clause.
  76      * @return the total number of records updated in the database
  77      */
  78     @Deprecated
<abbr title="  79     public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;Long&gt; ids) {">  79     public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] typesðŸ”µ</abbr>
  80         int response = 0;
  81         List&lt;Long[]&gt; runs = buildRuns(ids);
  82         for (Long[] run : runs) {
  83             String queryString = String.format(template, buildInClauseTemplate(run.length));
  84             SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);
  85             int counter = 0;
  86             if (!ArrayUtils.isEmpty(params)) {
  87                 for (Object param : params) {
  88                     query.setParameter(counter, param, types[counter]);
  89                     counter++;
  90                 }
  91             }
  92             for (Long id : run) {
  93                 query.setLong(counter, id);
  94                 counter++;
  95             }
  96             FlushMode mode = em.unwrap(Session.class).getFlushMode();
  97             em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);
  98             try {
  99             response += query.executeUpdate();
 100             } finally {
 101                 em.unwrap(Session.class).setFlushMode(mode);
 102             }
 103         }
 104         return response;
 105     }
 106 
 107     /**
<abbr title=" 108      * Perform an update query using a String template and params. Note, this is only intended for special"> 108      * Perform an update query using a String template and params. Note, this is only intended for speciaðŸ”µ</abbr>
<abbr title=" 109      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session"> 109      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate SeðŸ”µ</abbr>
 110      * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
 111      * &lt;/p&gt;
<abbr title=" 112      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;"> 112      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEðŸ”µ</abbr>
 113      *
 114      * @param em The entity manager to use for the persistence operation
<abbr title=" 115      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;."> 115      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;ðŸ”µ</abbr>
<abbr title=" 116      * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate to limit the scope of cache region invalidation. Otherwise, if left null, Hibernate will invalidate every cache region, which is generally not desirable. An empty String can be used to signify that no region should be invalidated."> 116      * @param tableSpace optionally provide the table being impacted by this query. This value allows HibðŸ”µ</abbr>
<abbr title=" 117      * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null."> 117      * @param params any other params that are present in the sql template, other than the IN clause. ShoðŸ”µ</abbr>
<abbr title=" 118      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null."> 118      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params.ðŸ”µ</abbr>
 119      * @param ids the ids to include in the IN clause.
 120      * @return the total number of records updated in the database
 121      */
<abbr title=" 122     public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, Type[] types, List&lt;Long&gt; ids) {"> 122     public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] pðŸ”µ</abbr>
 123         int response = 0;
 124         List&lt;Long[]&gt; runs = buildRuns(ids);
 125         for (Long[] run : runs) {
 126             String queryString = String.format(template, buildInClauseTemplate(run.length));
 127             SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);
 128             //only check for null - an empty string is a valid value for tableSpace
 129             if (tableSpace != null) {
 130                 query.addSynchronizedQuerySpace(tableSpace);
 131             }
 132             int counter = 0;
 133             if (!ArrayUtils.isEmpty(params)) {
 134                 for (Object param : params) {
 135                     query.setParameter(counter, param, types[counter]);
 136                     counter++;
 137                 }
 138             }
 139             for (Long id : run) {
 140                 query.setLong(counter, id);
 141                 counter++;
 142             }
 143             FlushMode mode = em.unwrap(Session.class).getFlushMode();
 144             em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);
 145             try {
 146             response += query.executeUpdate();
 147             } finally {
 148                 em.unwrap(Session.class).setFlushMode(mode);
 149             }
 150         }
 151         return response;
 152     }
 153 
 154     /**
 155      *
 156      * @param em
 157      * @param entityType
 158      * @param ids
 159      */
<abbr title=" 160     public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt; ids) {"> 160     public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt;ðŸ”µ</abbr>
 161         SharedSessionContractImplementor session = em.unwrap(SharedSessionContractImplementor.class);
 162         CacheImplementor hibernateCache = session.getFactory().getCache();
 163         for (Long id : ids) {
 164             hibernateCache.evictEntity(entityType, id);
 165         }
 166         //update the timestamp cache for the table so that queries will be refreshed
 167         PersistentClass metadata = HibernateMappingProvider.getMapping(entityType.getName());
 168         String tableName = metadata.getTable().getName();
 169         UpdateTimestampsCache timestampsCache = hibernateCache.getUpdateTimestampsCache();
 170         if (timestampsCache != null) {
 171             timestampsCache.invalidate(new Serializable[]{tableName}, session);
 172         }
 173     }
 174 
 175     /**
 176      * Quickly build up the sql IN clause template
 177      *
 178      * @param length
 179      * @return
 180      */
 181     private static String buildInClauseTemplate(int length) {
 182         String[] temp = new String[length];
 183         Arrays.fill(temp, &quot;?&quot;);
 184         return StringUtils.join(temp, &quot;,&quot;);
 185     }
 186 
 187     /**
 188      * This breaks up our IN clause into multiple runs of 800 or less in order
<abbr title=" 189      * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there are more"> 189      * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there arðŸ”µ</abbr>
 190      * than a 1000 entries in an sql IN clause).
 191      *
 192      * @param ids
 193      * @return
 194      */
 195     private static List&lt;Long[]&gt; buildRuns(List&lt;Long&gt; ids) {
 196         List&lt;Long[]&gt; runs = new ArrayList&lt;Long[]&gt;();
 197         Long[] all = ids.toArray(new Long[ids.size()]);
 198         int test = all.length;
 199         int pos = 0;
 200         boolean eof = false;
 201         while (!eof) {
 202             int arraySize;
 203             if (test &lt; 800) {
 204                 arraySize = test;
 205                 eof = true;
 206             } else {
 207                 arraySize = 800;
 208                 test -= arraySize;
 209                 if (test == 0) {
 210                     eof = true;
 211                 }
 212             }
 213             Long[] temp = new Long[arraySize];
 214             System.arraycopy(all, pos, temp, 0, arraySize);
 215             pos += arraySize;
 216             runs.add(temp);
 217         }
 218         return runs;
 219     }
 220 }
 
 
 
 </pre></td>
                            <td><pre>   1 /*
   2  * #%L
   3  * BroadleafCommerce Common Libraries
   4  * %%
   5  * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6  * %%
   7  * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8  * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9  * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10  * the Broadleaf End User License Agreement (EULA), Version 1.1
  11  * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12  * shall apply.
  13  *
<abbr title="  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14  * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;CustomðŸ”µ</abbr>
<abbr title="  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.">  15  * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicableðŸ”µ</abbr>
  16  * #L%
  17  */
  18 package org.broadleafcommerce.common.util;
  19 
  20 import java.io.Serializable;
  21 import java.util.ArrayList;
  22 import java.util.Arrays;
  23 import java.util.List;
  24 import javax.persistence.EntityManager;
  25 import org.apache.commons.lang.ArrayUtils;
  26 import org.apache.commons.lang3.StringUtils;
  27 import org.broadleafcommerce.common.util.dao.HibernateMappingProvider;
  28 import org.hibernate.FlushMode;
  29 import org.hibernate.SQLQuery;
  30 import org.hibernate.Session;
  31 import org.hibernate.cache.spi.UpdateTimestampsCache;
  32 import org.hibernate.engine.spi.CacheImplementor;
  33 import org.hibernate.engine.spi.SharedSessionContractImplementor;
  34 import org.hibernate.mapping.PersistentClass;
  35 import org.hibernate.type.Type;
  36 
  37 
  38 /**
<abbr title="  39  * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on Hibernate filtered">  39  * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updateðŸ”µ</abbr>
  40  * entities (such as sandboxable and multi-tenant entities).
  41  * &lt;/p&gt;
<abbr title="  42  * This class takes an interesting approach to the use of update queries. To explain, a bit of background is required.">  42  * This class takes an interesting approach to the use of update queries. To explain, a bit of backgroundðŸ”µ</abbr>
<abbr title="  43  * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs an HQL UPDATE">  43  * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it eðŸ”µ</abbr>
<abbr title="  44  * query. However, it will only create this temporary table when the target entity has Hibernate filters applied">  44  * query. However, it will only create this temporary table when the target entity has Hibernate filters ðŸ”µ</abbr>
<abbr title="  45  * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is used to">  45  * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectðŸ”µ</abbr>
<abbr title="  46  * populate the values. It is my understanding that this ends up creating some locks on the original table. Because of">  46  * populate the values. It is my understanding that this ends up creating some locks on the original tablðŸ”µ</abbr>
<abbr title="  47  * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to avoid">  47  * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to ðŸ”µ</abbr>
<abbr title="  48  * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) and then">  48  * the temporary table creation. We did this by first selecting for ids (so that the filters were still hðŸ”µ</abbr>
<abbr title="  49  * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needs to be basic">  49  * using a simple, native sql statement to execute the update on entities matching those ids. The native ðŸ”µ</abbr>
  50  * enough that itâ€™s portable across platforms.
  51  * &lt;/p&gt;
<abbr title="  52  * This class is responsible for building the native sql based on a template String. It does it in a way using a standard">  52  * This class is responsible for building the native sql based on a template String. It does it in a way ðŸ”µ</abbr>
<abbr title="  53  * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection exploit.">  53  * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection eðŸ”µ</abbr>
  54  * &lt;/p&gt;
<abbr title="  55  * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoid maximum">  55  * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoidðŸ”µ</abbr>
  56  * IN clause lengths enforced by some database platforms.
  57  *
  58  * @author Jeff Fischer
  59  */
  60 public class UpdateExecutor {
  61     /**
<abbr title="  62      * Perform an update query using a String template and params. Note, this is only intended for special">  62      * Perform an update query using a String template and params. Note, this is only intended for speciaðŸ”µ</abbr>
<abbr title="  63      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session">  63      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate SeðŸ”µ</abbr>
  64      * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
  65      * &lt;/p&gt;
<abbr title="  66      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;">  66      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEðŸ”µ</abbr>
  67      *
<abbr title="  68      * @deprecated Highly recommended not to use this method. This method results in global L2 cache region clearing. Use {@link #executeUpdateQuery(EntityManager, String, String, Object[], Type[], List)} instead.">  68      * @deprecated Highly recommended not to use this method. This method results in global L2 cache regiðŸ”µ</abbr>
  69      * @param em The entity manager to use for the persistence operation
<abbr title="  70      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.">  70      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;ðŸ”µ</abbr>
<abbr title="  71      * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null.">  71      * @param params any other params that are present in the sql template, other than the IN clause. ShoðŸ”µ</abbr>
<abbr title="  72      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null.">  72      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params.ðŸ”µ</abbr>
  73      * @param ids the ids to include in the IN clause.
  74      * @return the total number of records updated in the database
  75      */
  76     @Deprecated
<abbr title="  77     public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;Long&gt; ids) {">  77     public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] typesðŸ”µ</abbr>
  78         int response = 0;
  79         List&lt;Long[]&gt; runs = buildRuns(ids);
  80         for (Long[] run : runs) {
  81             String queryString = String.format(template, buildInClauseTemplate(run.length));
  82             SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);
  83             int counter = 0;
  84             if (!ArrayUtils.isEmpty(params)) {
  85                 for (Object param : params) {
  86                     query.setParameter(counter, param, types[counter]);
  87                     counter++;
  88                 }
  89             }
  90             for (Long id : run) {
  91                 query.setLong(counter, id);
  92                 counter++;
  93             }
  94             FlushMode mode = em.unwrap(Session.class).getFlushMode();
  95             em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);
  96             try {
  97                 response += query.executeUpdate();
  98             } finally {
  99                 em.unwrap(Session.class).setFlushMode(mode);
 100             }
 101         }
 102         return response;
 103     }
 104 
 105     /**
<abbr title=" 106      * Perform an update query using a String template and params. Note, this is only intended for special"> 106      * Perform an update query using a String template and params. Note, this is only intended for speciaðŸ”µ</abbr>
<abbr title=" 107      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session"> 107      * usage with update queries that have an IN clause at the end. This implementation uses Hibernate SeðŸ”µ</abbr>
 108      * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
 109      * &lt;/p&gt;
<abbr title=" 110      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;"> 110      * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEðŸ”µ</abbr>
 111      *
 112      * @param em The entity manager to use for the persistence operation
<abbr title=" 113      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;."> 113      * @param template the overall update sql template. The IN clause parameter should be written using &#x27;ðŸ”µ</abbr>
<abbr title=" 114      * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate to limit the scope of cache region invalidation. Otherwise, if left null, Hibernate will invalidate every cache region, which is generally not desirable. An empty String can be used to signify that no region should be invalidated."> 114      * @param tableSpace optionally provide the table being impacted by this query. This value allows HibðŸ”µ</abbr>
<abbr title=" 115      * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null."> 115      * @param params any other params that are present in the sql template, other than the IN clause. ShoðŸ”µ</abbr>
<abbr title=" 116      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null."> 116      * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params.ðŸ”µ</abbr>
 117      * @param ids the ids to include in the IN clause.
 118      * @return the total number of records updated in the database
 119      */
<abbr title=" 120     public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, Type[] types, List&lt;Long&gt; ids) {"> 120     public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] pðŸ”µ</abbr>
 121         int response = 0;
 122         List&lt;Long[]&gt; runs = buildRuns(ids);
 123         for (Long[] run : runs) {
 124             String queryString = String.format(template, buildInClauseTemplate(run.length));
 125             SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);
 126             // only check for null - an empty string is a valid value for tableSpace
 127             if (tableSpace != null) {
 128                 query.addSynchronizedQuerySpace(tableSpace);
 129             }
 130             int counter = 0;
 131             if (!ArrayUtils.isEmpty(params)) {
 132                 for (Object param : params) {
 133                     query.setParameter(counter, param, types[counter]);
 134                     counter++;
 135                 }
 136             }
 137             for (Long id : run) {
 138                 query.setLong(counter, id);
 139                 counter++;
 140             }
 141             FlushMode mode = em.unwrap(Session.class).getFlushMode();
 142             em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);
 143             try {
 144                 response += query.executeUpdate();
 145             } finally {
 146                 em.unwrap(Session.class).setFlushMode(mode);
 147             }
 148         }
 149         return response;
 150     }
 151 
 152     /**
 153      *
 154      * @param em
 155      * @param entityType
 156      * @param ids
 157      */
<abbr title=" 158     public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt; ids) {"> 158     public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt;ðŸ”µ</abbr>
 159         SharedSessionContractImplementor session = em.unwrap(SharedSessionContractImplementor.class);
 160         CacheImplementor hibernateCache = session.getFactory().getCache();
 161         for (Long id : ids) {
 162             hibernateCache.evictEntity(entityType, id);
 163         }
 164         //update the timestamp cache for the table so that queries will be refreshed
 165         PersistentClass metadata = HibernateMappingProvider.getMapping(entityType.getName());
 166         String tableName = metadata.getTable().getName();
 167         UpdateTimestampsCache timestampsCache = hibernateCache.getUpdateTimestampsCache();
 168         if (timestampsCache != null) {
 169             timestampsCache.invalidate(new Serializable[]{ tableName }, session);
 170         }
 171     }
 172 
 173     /**
 174      * Quickly build up the sql IN clause template
 175      *
 176      * @param length
 177      * @return
 178      */
 179     private static String buildInClauseTemplate(int length) {
 180         String[] temp = new String[length];
 181         Arrays.fill(temp, &quot;?&quot;);
 182         return StringUtils.join(temp, &quot;,&quot;);
 183     }
 184 
 185     /**
 186      * This breaks up our IN clause into multiple runs of 800 or less in order
<abbr title=" 187      * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there are more"> 187      * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there arðŸ”µ</abbr>
 188      * than a 1000 entries in an sql IN clause).
 189      *
 190      * @param ids
 191      * @return
 192      */
 193     private static List&lt;Long[]&gt; buildRuns(List&lt;Long&gt; ids) {
 194         List&lt;Long[]&gt; runs = new ArrayList&lt;Long[]&gt;();
 195         Long[] all = ids.toArray(new Long[ids.size()]);
 196         int test = all.length;
 197         int pos = 0;
 198         boolean eof = false;
 199         while (!eof) {
 200             int arraySize;
 201             if (test &lt; 800) {
 202                 arraySize = test;
 203                 eof = true;
 204             } else {
 205                 arraySize = 800;
 206                 test -= arraySize;
 207                 if (test == 0) {
 208                     eof = true;
 209                 }
 210             }
 211             Long[] temp = new Long[arraySize];
 212             System.arraycopy(all, pos, temp, 0, arraySize);
 213             pos += arraySize;
 214             runs.add(temp);
 215         }
 216         return runs;
 217     }
 218 }
 
 
 
 
 
 </pre></td>
                        </tr>
                    </table>
                </div>
                <div id="bottom">
                    <table style="margin:auto">
                        <tr>
                            <th>ours vs. base</th>
                            <th>theirs vs. base</th>
                        </tr>
                        <tr>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.util;
  19  
  20  import org.apache.commons.lang.ArrayUtils;
  21  import org.apache.commons.lang3.StringUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.broadleafcommerce.common.util.dao.HibernateMappingProvider;</span>
  23  import org.hibernate.SQLQuery;
  24  import org.hibernate.Session;
  25  import org.hibernate.cache.spi.UpdateTimestampsCache;
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  26 -import org.hibernate.engine.spi.SessionImplementor;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  27 -import org.hibernate.metadata.ClassMetadata;</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  28 -import org.hibernate.persister.entity.AbstractEntityPersister;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  29 +import org.hibernate.engine.spi.CacheImplementor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  30 +import org.hibernate.engine.spi.SharedSessionContractImplementor;</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  31 +import org.hibernate.mapping.PersistentClass;</span>
  32  import org.hibernate.type.Type;
  33  
  34  import java.io.Serializable;
  35  import java.util.ArrayList;
  36  import java.util.Arrays;
  37  import java.util.List;
  38  
  39  import javax.persistence.EntityManager;
  40  
  41  /**
<abbr title="  42   * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on Hibernate filtered">  42   * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on HibeðŸ”µ</abbr>
  43   * entities (such as sandboxable and multi-tenant entities).
  44   * &lt;/p&gt;
<abbr title="  45   * This class takes an interesting approach to the use of update queries. To explain, a bit of background is required.">  45   * This class takes an interesting approach to the use of update queries. To explain, a bit of background is requiðŸ”µ</abbr>
<abbr title="  46   * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs an HQL UPDATE">  46   * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs anðŸ”µ</abbr>
  47   * query. However, it will only create this temporary table when the target entity has Hibernate filters applied
<abbr title="  48   * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is used to">  48   * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is usedðŸ”µ</abbr>
<abbr title="  49   * populate the values. It is my understanding that this ends up creating some locks on the original table. Because of">  49   * populate the values. It is my understanding that this ends up creating some locks on the original table. BecausðŸ”µ</abbr>
  50   * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to avoid
<abbr title="  51   * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) and then">  51   * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) aðŸ”µ</abbr>
<abbr title="  52   * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needs to be basic">  52   * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needsðŸ”µ</abbr>
  53   * enough that itâ€™s portable across platforms.
  54   * &lt;/p&gt;
<abbr title="  55   * This class is responsible for building the native sql based on a template String. It does it in a way using a standard">  55   * This class is responsible for building the native sql based on a template String. It does it in a way using a sðŸ”µ</abbr>
  56   * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection exploit.
  57   * &lt;/p&gt;
  58   * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoid maximum
  59   * IN clause lengths enforced by some database platforms.
  60   *
  61   * @author Jeff Fischer
  62   */
  63  public class UpdateExecutor {
  64  
  65      /**
  66       * Perform an update query using a String template and params. Note, this is only intended for special
  67       * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session
  68       * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
  69       * &lt;/p&gt;
<abbr title="  70       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;">  70       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (ðŸ”µ</abbr>
  71       *
<abbr title="  72       * @deprecated Highly recommended not to use this method. This method results in global L2 cache region clearing. Use {@link #executeUpdateQuery(EntityManager, String, String, Object[], Type[], List)} instead.">  72       * @deprecated Highly recommended not to use this method. This method results in global L2 cache region cleariðŸ”µ</abbr>
  73       * @param em The entity manager to use for the persistence operation
  74       * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.
<abbr title="  75       * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null.">  75       * @param params any other params that are present in the sql template, other than the IN clause. Should be wrðŸ”µ</abbr>
<abbr title="  76       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null.">  76       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should bðŸ”µ</abbr>
  77       * @param ids the ids to include in the IN clause.
  78       * @return the total number of records updated in the database
  79       */
  80      @Deprecated
<abbr title="  81      public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;Long&gt; ids) {">  81      public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;LoðŸ”µ</abbr>
  82          int response = 0;
  83          List&lt;Long[]&gt; runs = buildRuns(ids);
  84          for (Long[] run : runs) {
  85              String queryString = String.format(template, buildInClauseTemplate(run.length));
  86              SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);
  87              int counter = 0;
  88              if (!ArrayUtils.isEmpty(params)) {
  89                  for (Object param : params) {
  90                      query.setParameter(counter, param, types[counter]);
  91                      counter++;
  92                  }
  93              }
  94              for (Long id : run) {
  95                  query.setLong(counter, id);
  96                  counter++;
  97              }
  98              response += query.executeUpdate();







  99          }
 100          return response;
 101      }
 102  
 103      /**
 104       * Perform an update query using a String template and params. Note, this is only intended for special
 105       * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session
 106       * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
 107       * &lt;/p&gt;
<abbr title=" 108       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;"> 108       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (ðŸ”µ</abbr>
 109       *
 110       * @param em The entity manager to use for the persistence operation
 111       * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.
<abbr title=" 112       * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate to limit the scope of cache region invalidation. Otherwise, if left null, Hibernate will invalidate every cache region, which is generally not desirable. An empty String can be used to signify that no region should be invalidated."> 112       * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate toðŸ”µ</abbr>
<abbr title=" 113       * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null."> 113       * @param params any other params that are present in the sql template, other than the IN clause. Should be wrðŸ”µ</abbr>
<abbr title=" 114       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null."> 114       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should bðŸ”µ</abbr>
 115       * @param ids the ids to include in the IN clause.
 116       * @return the total number of records updated in the database
 117       */
<abbr title=" 118      public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, Type[] types, List&lt;Long&gt; ids) {"> 118      public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, TyðŸ”µ</abbr>
 119          int response = 0;
 120          List&lt;Long[]&gt; runs = buildRuns(ids);
 121          for (Long[] run : runs) {
 122              String queryString = String.format(template, buildInClauseTemplate(run.length));
 123              SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);
 124              //only check for null - an empty string is a valid value for tableSpace
 125              if (tableSpace != null) {
 126                  query.addSynchronizedQuerySpace(tableSpace);
 127              }
 128              int counter = 0;
 129              if (!ArrayUtils.isEmpty(params)) {
 130                  for (Object param : params) {
 131                      query.setParameter(counter, param, types[counter]);
 132                      counter++;
 133                  }
 134              }
 135              for (Long id : run) {
 136                  query.setLong(counter, id);
 137                  counter++;
 138              }
 139              response += query.executeUpdate();







 140          }
 141          return response;
 142      }
 143  
 144      /**
 145       *
 146       * @param em
 147       * @param entityType
 148       * @param ids
 149       */
 150      public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt; ids) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 151 -        Session session = em.unwrap(Session.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 152 +        SharedSessionContractImplementor session = em.unwrap(SharedSessionContractImplementor.class);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 153 +        CacheImplementor hibernateCache = session.getFactory().getCache();</span>
 154          for (Long id : ids) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 155 -            session.getSessionFactory().getCache().evictEntity(entityType, id);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 156 +            hibernateCache.evictEntity(entityType, id);</span>
 157          }
 158          //update the timestamp cache for the table so that queries will be refreshed
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 159 -        ClassMetadata metadata = session.getSessionFactory().getClassMetadata(entityType);</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 160 -        String tableName = ((AbstractEntityPersister) metadata).getTableName();</span>
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"><abbr title=" 161 -        UpdateTimestampsCache timestampsCache = em.unwrap(SessionImplementor.class).getFactory().getUpdateTimestampsCache();"> 161 -        UpdateTimestampsCache timestampsCache = em.unwrap(SessionImplementor.class).getFactory().getUpdateTimestamðŸ”µ</abbr></span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 162 +        PersistentClass metadata = HibernateMappingProvider.getMapping(entityType.getName());</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 163 +        String tableName = metadata.getTable().getName();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 164 +        UpdateTimestampsCache timestampsCache = hibernateCache.getUpdateTimestampsCache();</span>
 165          if (timestampsCache != null) {
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 166 -            timestampsCache.invalidate(new Serializable[]{tableName});</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 167 +            timestampsCache.invalidate(new Serializable[]{tableName}, session);</span>
 168          }
 169      }
 170  
 171      /**
 172       * Quickly build up the sql IN clause template
 173       *
 174       * @param length
 175       * @return
 176       */
 177      private static String buildInClauseTemplate(int length) {
 178          String[] temp = new String[length];
 179          Arrays.fill(temp, &quot;?&quot;);
 180          return StringUtils.join(temp, &quot;,&quot;);
 181      }
 182  
 183      /**
 184       * This breaks up our IN clause into multiple runs of 800 or less in order
 185       * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there are more
 186       * than a 1000 entries in an sql IN clause).
 187       *
 188       * @param ids
 189       * @return
 190       */
 191      private static List&lt;Long[]&gt; buildRuns(List&lt;Long&gt; ids) {
 192          List&lt;Long[]&gt; runs = new ArrayList&lt;Long[]&gt;();
 193          Long[] all = ids.toArray(new Long[ids.size()]);
 194          int test = all.length;
 195          int pos = 0;
 196          boolean eof = false;
 197          while (!eof) {
 198              int arraySize;
 199              if (test &lt; 800) {
 200                  arraySize = test;
 201                  eof = true;
 202              } else {
 203                  arraySize = 800;
 204                  test -= arraySize;
 205                  if (test == 0) {
 206                      eof = true;
 207                  }
 208              }
 209              Long[] temp = new Long[arraySize];
 210              System.arraycopy(all, pos, temp, 0, arraySize);
 211              pos += arraySize;
 212              runs.add(temp);
 213          }
 214          return runs;
 215      }
 216  }</pre></td>
                            <td><pre>   1  /*
   2   * #%L
   3   * BroadleafCommerce Common Libraries
   4   * %%
   5   * Copyright (C) 2009 - 2016 Broadleaf Commerce
   6   * %%
   7   * Licensed under the Broadleaf Fair Use License Agreement, Version 1.0
   8   * (the &quot;Fair Use License&quot; located  at http://license.broadleafcommerce.org/fair_use_license-1.0.txt)
   9   * unless the restrictions on use therein are violated and require payment to Broadleaf in which case
  10   * the Broadleaf End User License Agreement (EULA), Version 1.1
  11   * (the &quot;Commercial License&quot; located at http://license.broadleafcommerce.org/commercial_license-1.1.txt)
  12   * shall apply.
  13   *
<abbr title="  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;)">  14   * Alternatively, the Commercial License may be replaced with a mutually agreed upon license (the &quot;Custom License&quot;ðŸ”µ</abbr>
  15   * between you and Broadleaf Commerce. You may not use this file except in compliance with the applicable license.
  16   * #L%
  17   */
  18  package org.broadleafcommerce.common.util;
  19  
  20  import org.apache.commons.lang.ArrayUtils;
  21  import org.apache.commons.lang3.StringUtils;
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  22 +import org.hibernate.FlushMode;</span>
  23  import org.hibernate.SQLQuery;
  24  import org.hibernate.Session;
  25  import org.hibernate.cache.spi.UpdateTimestampsCache;
  26  import org.hibernate.engine.spi.SessionImplementor;
  27  import org.hibernate.metadata.ClassMetadata;
  28  import org.hibernate.persister.entity.AbstractEntityPersister;



  29  import org.hibernate.type.Type;
  30  
  31  import java.io.Serializable;
  32  import java.util.ArrayList;
  33  import java.util.Arrays;
  34  import java.util.List;
  35  
  36  import javax.persistence.EntityManager;
  37  
  38  /**
<abbr title="  39   * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on Hibernate filtered">  39   * The purpose for this class is to provide an alternate approach to an HQL UPDATE query for batch updates on HibeðŸ”µ</abbr>
  40   * entities (such as sandboxable and multi-tenant entities).
  41   * &lt;/p&gt;
<abbr title="  42   * This class takes an interesting approach to the use of update queries. To explain, a bit of background is required.">  42   * This class takes an interesting approach to the use of update queries. To explain, a bit of background is requiðŸ”µ</abbr>
<abbr title="  43   * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs an HQL UPDATE">  43   * First, Hibernate will create a temporary table and fill it will ids to use in a where clause when it executs anðŸ”µ</abbr>
  44   * query. However, it will only create this temporary table when the target entity has Hibernate filters applied
<abbr title="  45   * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is used to">  45   * (i.e. sandboxable or multi-tenant entities). When creating this temporary table, a â€˜insert into selectâ€™ is usedðŸ”µ</abbr>
<abbr title="  46   * populate the values. It is my understanding that this ends up creating some locks on the original table. Because of">  46   * populate the values. It is my understanding that this ends up creating some locks on the original table. BecausðŸ”µ</abbr>
  47   * these locks, we were seeing some instances of deadlocks during concurrent admin usage. The key was to avoid
<abbr title="  48   * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) and then">  48   * the temporary table creation. We did this by first selecting for ids (so that the filters were still honored) aðŸ”µ</abbr>
<abbr title="  49   * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needs to be basic">  49   * using a simple, native sql statement to execute the update on entities matching those ids. The native sql needsðŸ”µ</abbr>
  50   * enough that itâ€™s portable across platforms.
  51   * &lt;/p&gt;
<abbr title="  52   * This class is responsible for building the native sql based on a template String. It does it in a way using a standard">  52   * This class is responsible for building the native sql based on a template String. It does it in a way using a sðŸ”µ</abbr>
  53   * parameterized query (rather than string concatenation) to avoid the possibility of any sql injection exploit.
  54   * &lt;/p&gt;
  55   * This implementation has the added benefit of breaking up large IN clauses into smaller chunks to avoid maximum
  56   * IN clause lengths enforced by some database platforms.
  57   *
  58   * @author Jeff Fischer
  59   */
  60  public class UpdateExecutor {
  61  
  62      /**
  63       * Perform an update query using a String template and params. Note, this is only intended for special
  64       * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session
  65       * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
  66       * &lt;/p&gt;
<abbr title="  67       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;">  67       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (ðŸ”µ</abbr>
  68       *
<abbr title="  69       * @deprecated Highly recommended not to use this method. This method results in global L2 cache region clearing. Use {@link #executeUpdateQuery(EntityManager, String, String, Object[], Type[], List)} instead.">  69       * @deprecated Highly recommended not to use this method. This method results in global L2 cache region cleariðŸ”µ</abbr>
  70       * @param em The entity manager to use for the persistence operation
  71       * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.
<abbr title="  72       * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null.">  72       * @param params any other params that are present in the sql template, other than the IN clause. Should be wrðŸ”µ</abbr>
<abbr title="  73       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null.">  73       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should bðŸ”µ</abbr>
  74       * @param ids the ids to include in the IN clause.
  75       * @return the total number of records updated in the database
  76       */
  77      @Deprecated
<abbr title="  78      public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;Long&gt; ids) {">  78      public static int executeUpdateQuery(EntityManager em, String template, Object[] params, Type[] types, List&lt;LoðŸ”µ</abbr>
  79          int response = 0;
  80          List&lt;Long[]&gt; runs = buildRuns(ids);
  81          for (Long[] run : runs) {
  82              String queryString = String.format(template, buildInClauseTemplate(run.length));
  83              SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);
  84              int counter = 0;
  85              if (!ArrayUtils.isEmpty(params)) {
  86                  for (Object param : params) {
  87                      query.setParameter(counter, param, types[counter]);
  88                      counter++;
  89                  }
  90              }
  91              for (Long id : run) {
  92                  query.setLong(counter, id);
  93                  counter++;
  94              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0">  95 -            response += query.executeUpdate();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  96 +            FlushMode mode = em.unwrap(Session.class).getFlushMode();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  97 +            em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  98 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0">  99 +                response += query.executeUpdate();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 100 +            } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 101 +                em.unwrap(Session.class).setFlushMode(mode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 102 +            }</span>
 103          }
 104          return response;
 105      }
 106  
 107      /**
 108       * Perform an update query using a String template and params. Note, this is only intended for special
 109       * usage with update queries that have an IN clause at the end. This implementation uses Hibernate Session
 110       * directly to avoid a problem with assigning NULL values. The query should be written in native SQL.
 111       * &lt;/p&gt;
<abbr title=" 112       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (%s)&#x27;"> 112       * An example looks like: &#x27;UPDATE BLC_SNDBX_WRKFLW_ITEM SET SCHEDULED_DATE = ? WHERE WRKFLW_SNDBX_ITEM_ID IN (ðŸ”µ</abbr>
 113       *
 114       * @param em The entity manager to use for the persistence operation
 115       * @param template the overall update sql template. The IN clause parameter should be written using &#x27;IN (%s)&#x27;.
<abbr title=" 116       * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate to limit the scope of cache region invalidation. Otherwise, if left null, Hibernate will invalidate every cache region, which is generally not desirable. An empty String can be used to signify that no region should be invalidated."> 116       * @param tableSpace optionally provide the table being impacted by this query. This value allows Hibernate toðŸ”µ</abbr>
<abbr title=" 117       * @param params any other params that are present in the sql template, other than the IN clause. Should be written using &#x27;?&#x27;. Should be in order. Can be null."> 117       * @param params any other params that are present in the sql template, other than the IN clause. Should be wrðŸ”µ</abbr>
<abbr title=" 118       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should be in order and match the length of params. Can be null."> 118       * @param types the {@link org.hibernate.type.Type} instances that identify the types for the params. Should bðŸ”µ</abbr>
 119       * @param ids the ids to include in the IN clause.
 120       * @return the total number of records updated in the database
 121       */
<abbr title=" 122      public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, Type[] types, List&lt;Long&gt; ids) {"> 122      public static int executeUpdateQuery(EntityManager em, String template, String tableSpace, Object[] params, TyðŸ”µ</abbr>
 123          int response = 0;
 124          List&lt;Long[]&gt; runs = buildRuns(ids);
 125          for (Long[] run : runs) {
 126              String queryString = String.format(template, buildInClauseTemplate(run.length));
 127              SQLQuery query = em.unwrap(Session.class).createSQLQuery(queryString);
 128              //only check for null - an empty string is a valid value for tableSpace
 129              if (tableSpace != null) {
 130                  query.addSynchronizedQuerySpace(tableSpace);
 131              }
 132              int counter = 0;
 133              if (!ArrayUtils.isEmpty(params)) {
 134                  for (Object param : params) {
 135                      query.setParameter(counter, param, types[counter]);
 136                      counter++;
 137                  }
 138              }
 139              for (Long id : run) {
 140                  query.setLong(counter, id);
 141                  counter++;
 142              }
<span style="background-color: rgba(255, 0, 0, 0.2);; margin: 0"> 143 -            response += query.executeUpdate();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 144 +            FlushMode mode = em.unwrap(Session.class).getFlushMode();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 145 +            em.unwrap(Session.class).setFlushMode(FlushMode.MANUAL);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 146 +            try {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 147 +                response += query.executeUpdate();</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 148 +            } finally {</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 149 +                em.unwrap(Session.class).setFlushMode(mode);</span>
<span style="background-color: rgba(0, 255, 0, 0.2); margin: 0"> 150 +            }</span>
 151          }
 152          return response;
 153      }
 154  
 155      /**
 156       *
 157       * @param em
 158       * @param entityType
 159       * @param ids
 160       */
 161      public static void executeTargetedCacheInvalidation(EntityManager em, Class&lt;?&gt; entityType, List&lt;Long&gt; ids) {
 162          Session session = em.unwrap(Session.class);


 163          for (Long id : ids) {
 164              session.getSessionFactory().getCache().evictEntity(entityType, id);

 165          }
 166          //update the timestamp cache for the table so that queries will be refreshed
 167          ClassMetadata metadata = session.getSessionFactory().getClassMetadata(entityType);
 168          String tableName = ((AbstractEntityPersister) metadata).getTableName();
<abbr title=" 169          UpdateTimestampsCache timestampsCache = em.unwrap(SessionImplementor.class).getFactory().getUpdateTimestampsCache();"> 169          UpdateTimestampsCache timestampsCache = em.unwrap(SessionImplementor.class).getFactory().getUpdateTimestamðŸ”µ</abbr>



 170          if (timestampsCache != null) {
 171              timestampsCache.invalidate(new Serializable[]{tableName});

 172          }
 173      }
 174  
 175      /**
 176       * Quickly build up the sql IN clause template
 177       *
 178       * @param length
 179       * @return
 180       */
 181      private static String buildInClauseTemplate(int length) {
 182          String[] temp = new String[length];
 183          Arrays.fill(temp, &quot;?&quot;);
 184          return StringUtils.join(temp, &quot;,&quot;);
 185      }
 186  
 187      /**
 188       * This breaks up our IN clause into multiple runs of 800 or less in order
 189       * to guarantee compatibility across platforms (i.e. some db platforms will throw a error if there are more
 190       * than a 1000 entries in an sql IN clause).
 191       *
 192       * @param ids
 193       * @return
 194       */
 195      private static List&lt;Long[]&gt; buildRuns(List&lt;Long&gt; ids) {
 196          List&lt;Long[]&gt; runs = new ArrayList&lt;Long[]&gt;();
 197          Long[] all = ids.toArray(new Long[ids.size()]);
 198          int test = all.length;
 199          int pos = 0;
 200          boolean eof = false;
 201          while (!eof) {
 202              int arraySize;
 203              if (test &lt; 800) {
 204                  arraySize = test;
 205                  eof = true;
 206              } else {
 207                  arraySize = 800;
 208                  test -= arraySize;
 209                  if (test == 0) {
 210                      eof = true;
 211                  }
 212              }
 213              Long[] temp = new Long[arraySize];
 214              System.arraycopy(all, pos, temp, 0, arraySize);
 215              pos += arraySize;
 216              runs.add(temp);
 217          }
 218          return runs;
 219      }
 220  }</pre></td>
                        </tr>
                    </table>
                </div>
              </body>
            </html>
            